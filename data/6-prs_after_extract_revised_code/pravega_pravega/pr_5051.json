{"pr_number": 5051, "pr_title": "Issue 5035: New Resource String Format for Authorization", "pr_createdAt": "2020-08-10T09:00:02Z", "pr_url": "https://github.com/pravega/pravega/pull/5051", "timeline": [{"oid": "df74633b134444482a4db2cbbd52153918fa2453", "url": "https://github.com/pravega/pravega/commit/df74633b134444482a4db2cbbd52153918fa2453", "message": "Refactor PasswordAuthHandler for unit testing\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-07-27T10:37:08Z", "type": "commit"}, {"oid": "e9036ad8f7d3d5a5d695306096317355b66eea3a", "url": "https://github.com/pravega/pravega/commit/e9036ad8f7d3d5a5d695306096317355b66eea3a", "message": "Add unit tests for PasswordAuthHandler\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-07-27T10:37:37Z", "type": "commit"}, {"oid": "854d652dc4c73de8d11d1290d53d5916bd044711", "url": "https://github.com/pravega/pravega/commit/854d652dc4c73de8d11d1290d53d5916bd044711", "message": "Add initial set of authorization-related tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-07-27T11:24:42Z", "type": "commit"}, {"oid": "7afb4ac3b243eb0b6c6c031e279d54ac80f4f058", "url": "https://github.com/pravega/pravega/commit/7afb4ac3b243eb0b6c6c031e279d54ac80f4f058", "message": "Refactoring and reorganization of Handler code\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-04T05:56:38Z", "type": "commit"}, {"oid": "77f0f0fbb45612e5c4a0c12be3a99df1f3e9ada2", "url": "https://github.com/pravega/pravega/commit/77f0f0fbb45612e5c4a0c12be3a99df1f3e9ada2", "message": "Refactoring and reorganization\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-05T03:00:43Z", "type": "commit"}, {"oid": "ee4d55a3632383bd0e8db92d2b876271e0815e75", "url": "https://github.com/pravega/pravega/commit/ee4d55a3632383bd0e8db92d2b876271e0815e75", "message": "Save partial work\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-05T10:18:04Z", "type": "commit"}, {"oid": "195becc1608d80b07ae2aabf7b926bf574194a33", "url": "https://github.com/pravega/pravega/commit/195becc1608d80b07ae2aabf7b926bf574194a33", "message": "Remove support for old format in Auth Handler\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-06T10:49:55Z", "type": "commit"}, {"oid": "4c32f1c94ea4259526cbae0b859caba520cda83c", "url": "https://github.com/pravega/pravega/commit/4c32f1c94ea4259526cbae0b859caba520cda83c", "message": "Finish up new ACL implmenetation and tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-07T08:34:11Z", "type": "commit"}, {"oid": "82284afff3044a9ed791891213cef0b34de8e83a", "url": "https://github.com/pravega/pravega/commit/82284afff3044a9ed791891213cef0b34de8e83a", "message": "Update Controller API tests to use new ACL format\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-07T09:10:48Z", "type": "commit"}, {"oid": "2a74dc5050a3cd3569214a6aaa622c89fccefd3b", "url": "https://github.com/pravega/pravega/commit/2a74dc5050a3cd3569214a6aaa622c89fccefd3b", "message": "Fix for tests and a bug in TestAuthhandler service config\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-10T04:08:29Z", "type": "commit"}, {"oid": "dfba3a80baeb2df930e05d34f5a0bdfd3d4eb581", "url": "https://github.com/pravega/pravega/commit/dfba3a80baeb2df930e05d34f5a0bdfd3d4eb581", "message": "Fix Auth manager tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-10T08:43:09Z", "type": "commit"}, {"oid": "3fd4e727cf05edf44d3877c7a16c2282f96e2223", "url": "https://github.com/pravega/pravega/commit/3fd4e727cf05edf44d3877c7a16c2282f96e2223", "message": "Use structured utility method to compose an auth file entry\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-10T08:53:42Z", "type": "commit"}, {"oid": "bcd6c4a25f8070bd9406765bf93f00d5b37c0698", "url": "https://github.com/pravega/pravega/commit/bcd6c4a25f8070bd9406765bf93f00d5b37c0698", "message": "Merge branch 'master' into auth-resources-permissions\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-10T10:48:04Z", "type": "commit"}, {"oid": "8d1a69534502e32b62778b39ed2961cc558e076c", "url": "https://github.com/pravega/pravega/commit/8d1a69534502e32b62778b39ed2961cc558e076c", "message": "Fix compilation issues after merge\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-11T04:33:25Z", "type": "commit"}, {"oid": "7217a5d504041f7d3e4d5d5657983cefef06eb33", "url": "https://github.com/pravega/pravega/commit/7217a5d504041f7d3e4d5d5657983cefef06eb33", "message": "Modify claimKey to match Segment Store format\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-12T01:26:55Z", "type": "commit"}, {"oid": "ab1b9e67d62d420ca7fbf3ba368dd68217c4b9a5", "url": "https://github.com/pravega/pravega/commit/ab1b9e67d62d420ca7fbf3ba368dd68217c4b9a5", "message": "Revert standalone mode config\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-12T01:27:27Z", "type": "commit"}, {"oid": "e64317b94f2b9c90d7fb6d4fdede50d06522bc2f", "url": "https://github.com/pravega/pravega/commit/e64317b94f2b9c90d7fb6d4fdede50d06522bc2f", "message": "Modify remaining test classes to use new resource format\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-12T03:23:27Z", "type": "commit"}, {"oid": "b8dbfc683ed78b4c1104a06078a04402a159f8dd", "url": "https://github.com/pravega/pravega/commit/b8dbfc683ed78b4c1104a06078a04402a159f8dd", "message": "Modify remaining test classes to use new resource format\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-12T04:43:44Z", "type": "commit"}, {"oid": "ee2ff0ef331b55d718f8378f135328ad5ac942b4", "url": "https://github.com/pravega/pravega/commit/ee2ff0ef331b55d718f8378f135328ad5ac942b4", "message": "Cleanup and add tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-12T09:57:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NTE5Ng==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470165196", "bodyText": "Just curious, is prn::* equivalent to prn::/*", "author": "sarlaccpit", "createdAt": "2020-08-13T18:36:16Z", "path": "controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java", "diffHunk": "@@ -11,40 +11,50 @@\n \n import io.grpc.ServerBuilder;\n import io.pravega.test.common.SecurityConfigDefaults;\n-import io.pravega.controller.server.rpc.auth.AuthHandlerManager;\n-import io.pravega.controller.server.rpc.auth.StrongPasswordProcessor;\n+import io.pravega.controller.server.security.auth.handler.AuthHandlerManager;\n+import io.pravega.controller.server.security.auth.StrongPasswordProcessor;\n import io.pravega.controller.server.rpc.grpc.impl.GRPCServerConfigImpl;\n import io.pravega.test.common.TestUtils;\n import javax.ws.rs.client.Invocation;\n import javax.ws.rs.core.HttpHeaders;\n import javax.ws.rs.core.MultivaluedHashMap;\n import javax.ws.rs.core.MultivaluedMap;\n-import org.junit.Before;\n-\n import java.io.File;\n import java.io.FileWriter;\n+import java.util.Arrays;\n+import org.junit.Before;\n+\n+import static io.pravega.controller.auth.AuthFileUtils.addAuthFileEntry;\n \n public class SecureStreamMetaDataTests extends  StreamMetaDataTests {\n+\n     @Override\n     @Before\n     public void setup() throws Exception {\n-        File file = File.createTempFile(\"passwd\", \".txt\");\n-\n+        File file = File.createTempFile(\"SecureStreamMetaDataTests\", \".txt\");\n         StrongPasswordProcessor passwordEncryptor = StrongPasswordProcessor.builder().build();\n \n         try (FileWriter writer = new FileWriter(file.getAbsolutePath())) {\n             String passwd = passwordEncryptor.encryptPassword(\"1111_aaaa\");\n \n             // Admin has READ_WRITE permission to everything\n-            writer.write(\"admin:\" + passwd + \":*,READ_UPDATE\\n\");\n+            addAuthFileEntry(writer, \"admin\", passwd, Arrays.asList(\"prn::*,READ_UPDATE\"));", "originalCommit": "ee2ff0ef331b55d718f8378f135328ad5ac942b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMDA4NQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470500085", "bodyText": "No, they are different.\n\nprn::* gives the user access to all resources.\nprn::/* gives the user access to all scopes and resources underneath it. It doesn't provide the user access to the root resource /, the user cannot create a scope for instance.", "author": "ravisharda", "createdAt": "2020-08-14T08:57:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NTE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2NDU0OA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470664548", "bodyText": "Got it.  So in order to create a scope, I'd need to either have:  READ_UPDATE on prn::* or READ_UPDATE on prn::/, right?", "author": "sarlaccpit", "createdAt": "2020-08-14T14:40:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NTE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMzY4OQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471203689", "bodyText": "Yes, that is right.", "author": "ravisharda", "createdAt": "2020-08-17T02:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2NTE5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java b/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\nindex 19909b8a0..ddbd81fa7 100644\n--- a/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\n+++ b/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\n\n@@ -22,6 +22,8 @@ import javax.ws.rs.core.MultivaluedMap;\n import java.io.File;\n import java.io.FileWriter;\n import java.util.Arrays;\n+import java.util.Collections;\n+\n import org.junit.Before;\n \n import static io.pravega.controller.auth.AuthFileUtils.addAuthFileEntry;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4MjYwNw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470182607", "bodyText": "This is just to confirm my understanding:   the fact that the delegation token deals with resource strings that are in the same format as what goes on in the controller side authorization is just a coincidence, correct?\nMeaning, in theory what goes on in the delegation token could have been completely different (though why re-invent the wheel basically).  is that correct?", "author": "sarlaccpit", "createdAt": "2020-08-13T19:04:08Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java", "diffHunk": "@@ -75,6 +75,14 @@ public JsonWebToken verifyToken(@NonNull String resource, String token, @NonNull\n      * @return\n      */\n     private boolean resourceMatchesClaimKey(String claimKey, String resource) {\n+        log.trace(\"claimKey = {}, resourceKey = {}\", claimKey, resource);\n+        if (claimKey.startsWith(\"prn::\")) {\n+            claimKey = claimKey.replace(\"prn::/\", \"\")\n+                    .replace(\"prn::\", \"\")", "originalCommit": "ee2ff0ef331b55d718f8378f135328ad5ac942b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwMzQ4MQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470503481", "bodyText": "To provide a bit more context: For Segment store operations like reading from stream and appending to a stream, the user must have corresponding read/write access. The delegation token generated by the Controller has a \"claim\" of the form <resource string>=<READ | READ_WRITE>  that tells the segment store that the bearer of the token is allowed to perform the specified action.\nTo answer your question, yes the delegation token could use a completed different format for the authorization key, but why re-invent the wheel.", "author": "ravisharda", "createdAt": "2020-08-14T09:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4MjYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2OTY1NA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470669654", "bodyText": "Got it. Thanks for confirming.", "author": "sarlaccpit", "createdAt": "2020-08-14T14:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4MjYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "095cfed037b8bef930c5d8dc939bc495de4623c5", "chunk": "diff --git a/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java b/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\nindex ed6bf228d..29a5c2c93 100644\n--- a/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\n+++ b/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\n\n@@ -76,12 +79,9 @@ public class TokenVerifierImpl implements DelegationTokenVerifier {\n      */\n     private boolean resourceMatchesClaimKey(String claimKey, String resource) {\n         log.trace(\"claimKey = {}, resourceKey = {}\", claimKey, resource);\n-        if (claimKey.startsWith(\"prn::\")) {\n-            claimKey = claimKey.replace(\"prn::/\", \"\")\n-                    .replace(\"prn::\", \"\")\n-                    .replace(\"scope:\", \"\")\n-                    .replace(\"stream:\", \"\");\n-        }\n+\n+        // Replace `prn::`, `/scope:` and `stream:` with an empty string.\n+        claimKey = RESOURCE_PARTS_TO_REPLACE.matcher(claimKey).replaceAll(\"\");\n \n         /*\n          * Examples of the conditions when the claimKey (key of the key-value pair claim) matches the resource are:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4ODE4Mw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470188183", "bodyText": "Just curious where the toggle is to use the LegacyAuthorizationImpl() ?\nMight be useful to implementors of the auth handler interface could take the new Pravega code and have a way to stick to the old format while they're updating their implementation to handle the new format ( else they'll break right away once Pravega starts asking about \"prn://scope:scope1\" and they really only understand  \"/scope1\" right ?).\nI saw there IS a purposely implemented LegacyAuthorizationResourceImpl class but other than in tests, I didn't see it getting used (there are a lot of files in this PR though so I might have missed a subtlety somewhere :))", "author": "sarlaccpit", "createdAt": "2020-08-13T19:14:41Z", "path": "controller/src/main/java/io/pravega/controller/server/rest/resources/StreamMetadataResourceImpl.java", "diffHunk": "@@ -75,6 +76,7 @@\n     private final RESTAuthHelper restAuthHelper;\n     private final LocalController localController;\n     private final ConnectionFactory connectionFactory;\n+    private final AuthorizationResource authorizationResource = new AuthorizationResourceImpl();", "originalCommit": "ee2ff0ef331b55d718f8378f135328ad5ac942b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUwNzc0Ng==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470507746", "bodyText": "No, you are right - there is no toggle built for the LegacyAuthorizationImpl. I've kept the code for ease of comparison between the new and old formats, as we transition from the old to the new format.\nWith this code, the resource strings passed to the Auth Handler implementation will all be in the new format. Also, the built-in Password Auth Handler has been modified to take in ACLs containing patterns that match the new format. IMO, supporting both old and new formats would make the code a bit too complex (I had attempted it already) and cause problems in upgrade scenarios, without adding enough value to justify it.\nWhat do you say?", "author": "ravisharda", "createdAt": "2020-08-14T09:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4ODE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MjMwMg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470682302", "bodyText": "I understand.  Cost vs reward.  It just means that implementors of the AuthHandler interface can't upgrade to Pravega 0.9 until they've updated their plugin code.  That said the changes imposed by the new format are not a big deal.  Also the auth handler implementation doesn't have to change the way IT stores its version of acls.  It simply has to adapt to the new way Pravega will \"ask about\" the resources being authorized and adjust its mapping. ie. \"/scope1\" is now \"prn::/scope:scope1\"\nThere are probably not many of those implementations out there at this time so that's probably ok.\nI can see though that in the password file impl, you've revamped also the format of the acls themselves since they follow closely the resource format that Pravega itself uses.\nOne thing I saw is that you have a LegacyAclAuthorizer; that is so somehow one can still use their old password file, correct?    The new PasswodFileHandler will still deal with new resources name being queried on, but it'll be able to map those to old and new ACLs.    Is there a setting/path in the code on the controller side that specifically allows setting that \"oldFormat\" flag? \n  \n    \n      pravega/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/PasswordAuthHandler.java\n    \n    \n         Line 52\n      in\n      a000a66\n    \n    \n    \n    \n\n        \n          \n           isOldAclFormatEnabled = useAclsInOldFormat; \n        \n    \n  \n\n\nThe documentation for the format of the acls in the password file will need to be updated (I'm thinking in particular the pravega cli in the tools repo that produces that password file)", "author": "sarlaccpit", "createdAt": "2020-08-14T15:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4ODE4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "url": "https://github.com/pravega/pravega/commit/a000a66776c32c3e475cfd7671eca45a1fbb5b69", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-14T09:13:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MjYyOA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470682628", "bodyText": "Why do you have this copyright in here?", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:06:39Z", "path": "controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java", "diffHunk": "@@ -101,9 +102,19 @@\n     private final boolean replyWithStackTraceOnError;\n \n     private final Supplier<Long> requestIdGenerator = RandomFactory.create()::nextLong;\n-\n+    /**", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNTg0Mw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471315843", "bodyText": "That happened by mistake. I've removed it now.", "author": "ravisharda", "createdAt": "2020-08-17T08:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MjYyOA=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java b/controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java\nindex 83a33804e..b6d9c5033 100644\n--- a/controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java\n\n@@ -102,15 +102,7 @@ public class ControllerServiceImpl extends ControllerServiceGrpc.ControllerServi\n     private final boolean replyWithStackTraceOnError;\n \n     private final Supplier<Long> requestIdGenerator = RandomFactory.create()::nextLong;\n-    /**\n-     * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n-     *\n-     * Licensed under the Apache License, Version 2.0 (the \"License\");\n-     * you may not use this file except in compliance with the License.\n-     * You may obtain a copy of the License at\n-     *\n-     *     http://www.apache.org/licenses/LICENSE-2.0\n-     */\n+\n     private final int pageLimit;\n \n     private final AuthorizationResource authorizationResource = new AuthorizationResourceImpl();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MzkwOA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470683908", "bodyText": "You're doing a double-lookup here. Get the index of \"::\" and check for negative values, then reuse it in your substring call.", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:09:00Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {\n+\n+    @Override\n+    public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n+        AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n+\n+        String resourceDomain;\n+        if (resource.indexOf(\"::\") > 0) {", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM0MDUwOA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471340508", "bodyText": "Yeah. I've now modified the code to ensure that is done once.", "author": "ravisharda", "createdAt": "2020-08-17T09:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4MzkwOA=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex cf2a60b9d..032c4d7c5 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -12,15 +12,20 @@ package io.pravega.controller.server.security.auth.handler.impl;\n import io.pravega.auth.AuthHandler;\n import lombok.NonNull;\n \n+import java.util.regex.Pattern;\n+\n class AclAuthorizerImpl extends AclAuthorizer {\n \n+    private static final Pattern PATTERN_STAR_NOT_PRECEDED_BY_DOT = Pattern.compile(\"(?!=.)\\\\*\");\n+\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n \n         String resourceDomain;\n-        if (resource.indexOf(\"::\") > 0) {\n-            resourceDomain = resource.substring(0, resource.indexOf(\"::\"));\n+        int indexOfPartsSeparator = resource.indexOf(\"::\");\n+        if (indexOfPartsSeparator > 0) {\n+            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n         } else {\n             resourceDomain = \"prn\"; // default\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NDg2OA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470684868", "bodyText": "The code inside the for loop does a lot of regex pattern compilation and matching, which is relatively expensive to process. Anyway we can simplify this? Can we precompute something (here or in AccessControlEntry)?", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:10:40Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {\n+\n+    @Override\n+    public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n+        AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n+\n+        String resourceDomain;\n+        if (resource.indexOf(\"::\") > 0) {\n+            resourceDomain = resource.substring(0, resource.indexOf(\"::\"));\n+        } else {\n+            resourceDomain = \"prn\"; // default\n+        }\n+\n+        for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n+            // Replaces any `*` with `.*`, if it's not already preceded by `.`, for regex processing.\n+            // So, `pravega:://*` becomes `pravega:://.*` and `pravega:://scope:*` becomes `pravega:://scope:.*`\n+            String aclResourcePattern = accessControlEntry.getResourcePattern().replaceAll(\"(?!=.)\\\\*\", \".*\");", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4MDg5Mw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471880893", "bodyText": "Sure, that's a very good idea. I've pushed this logic up to when the built-in Auth handler's accounts DB file is loaded during ACE construction time, which happens just once.", "author": "ravisharda", "createdAt": "2020-08-18T02:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NDg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex cf2a60b9d..032c4d7c5 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -12,15 +12,20 @@ package io.pravega.controller.server.security.auth.handler.impl;\n import io.pravega.auth.AuthHandler;\n import lombok.NonNull;\n \n+import java.util.regex.Pattern;\n+\n class AclAuthorizerImpl extends AclAuthorizer {\n \n+    private static final Pattern PATTERN_STAR_NOT_PRECEDED_BY_DOT = Pattern.compile(\"(?!=.)\\\\*\");\n+\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n \n         String resourceDomain;\n-        if (resource.indexOf(\"::\") > 0) {\n-            resourceDomain = resource.substring(0, resource.indexOf(\"::\"));\n+        int indexOfPartsSeparator = resource.indexOf(\"::\");\n+        if (indexOfPartsSeparator > 0) {\n+            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n         } else {\n             resourceDomain = \"prn\"; // default\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NjI4NQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470686285", "bodyText": "String.join?\nor aceStrings.stream().collect(Collectors.joining(...))?", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:13:04Z", "path": "controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java", "diffHunk": "@@ -23,4 +28,26 @@ public static String credentialsAndAclAsString(String username, String password,\n         // This will return a string that looks like this:\"<username>:<pasword>:acl\\n\"\n         return String.format(\"%s:%s:%s%n\", username, password, acl);\n     }\n+\n+    public static String createAclString(@NonNull List<String> aceStrings) {\n+        StringBuilder builder = new StringBuilder();", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4MTE5Ng==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471881196", "bodyText": "Done.", "author": "ravisharda", "createdAt": "2020-08-18T02:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NjI4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\nindex 0cff8775b..0ecee3cda 100644\n--- a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n+++ b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n\n@@ -30,24 +31,18 @@ public class AuthFileUtils {\n     }\n \n     public static String createAclString(@NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        for (String aceString: aceStrings) {\n-            builder.append(aceString).append(\";\");\n-        }\n-        return builder.toString();\n+        return aceStrings.stream().collect(Collectors.joining(\";\"));\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String entryAsString) {\n-        StringBuilder builder = new StringBuilder(entryAsString);\n-        writer.write(builder.append(\"\\n\").toString());\n+        writer.write(entryAsString + \"\\n\");\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String username,\n                                            @NonNull String hashedPwd, @NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(username).append(\":\").append(hashedPwd).append(\":\").append(createAclString(aceStrings));\n-        addAuthFileEntry(writer, builder.toString());\n+        String fileEntry = String.format(\"%s:%s:%s\", username, hashedPwd, createAclString(aceStrings));\n+        addAuthFileEntry(writer, fileEntry);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NjczMw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470686733", "bodyText": "For this simple case it's probably easier to do a direct string concatenation. StringBuilder won't help much.", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:13:50Z", "path": "controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java", "diffHunk": "@@ -23,4 +28,26 @@ public static String credentialsAndAclAsString(String username, String password,\n         // This will return a string that looks like this:\"<username>:<pasword>:acl\\n\"\n         return String.format(\"%s:%s:%s%n\", username, password, acl);\n     }\n+\n+    public static String createAclString(@NonNull List<String> aceStrings) {\n+        StringBuilder builder = new StringBuilder();\n+        for (String aceString: aceStrings) {\n+            builder.append(aceString).append(\";\");\n+        }\n+        return builder.toString();\n+    }\n+\n+    @SneakyThrows\n+    public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String entryAsString) {\n+        StringBuilder builder = new StringBuilder(entryAsString);", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4MTI2MA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471881260", "bodyText": "Done.", "author": "ravisharda", "createdAt": "2020-08-18T02:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NjczMw=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\nindex 0cff8775b..0ecee3cda 100644\n--- a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n+++ b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n\n@@ -30,24 +31,18 @@ public class AuthFileUtils {\n     }\n \n     public static String createAclString(@NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        for (String aceString: aceStrings) {\n-            builder.append(aceString).append(\";\");\n-        }\n-        return builder.toString();\n+        return aceStrings.stream().collect(Collectors.joining(\";\"));\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String entryAsString) {\n-        StringBuilder builder = new StringBuilder(entryAsString);\n-        writer.write(builder.append(\"\\n\").toString());\n+        writer.write(entryAsString + \"\\n\");\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String username,\n                                            @NonNull String hashedPwd, @NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(username).append(\":\").append(hashedPwd).append(\":\").append(createAclString(aceStrings));\n-        addAuthFileEntry(writer, builder.toString());\n+        String fileEntry = String.format(\"%s:%s:%s\", username, hashedPwd, createAclString(aceStrings));\n+        addAuthFileEntry(writer, fileEntry);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzAyOA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470687028", "bodyText": "Recommend using String.format. Easier to read.", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:14:21Z", "path": "controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java", "diffHunk": "@@ -23,4 +28,26 @@ public static String credentialsAndAclAsString(String username, String password,\n         // This will return a string that looks like this:\"<username>:<pasword>:acl\\n\"\n         return String.format(\"%s:%s:%s%n\", username, password, acl);\n     }\n+\n+    public static String createAclString(@NonNull List<String> aceStrings) {\n+        StringBuilder builder = new StringBuilder();\n+        for (String aceString: aceStrings) {\n+            builder.append(aceString).append(\";\");\n+        }\n+        return builder.toString();\n+    }\n+\n+    @SneakyThrows\n+    public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String entryAsString) {\n+        StringBuilder builder = new StringBuilder(entryAsString);\n+        writer.write(builder.append(\"\\n\").toString());\n+    }\n+\n+    @SneakyThrows\n+    public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String username,\n+                                           @NonNull String hashedPwd, @NonNull List<String> aceStrings) {\n+        StringBuilder builder = new StringBuilder();", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4MTM2OQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471881369", "bodyText": "Sure, I've modified it and it looks better.", "author": "ravisharda", "createdAt": "2020-08-18T02:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzAyOA=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\nindex 0cff8775b..0ecee3cda 100644\n--- a/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n+++ b/controller/src/test/java/io/pravega/controller/auth/AuthFileUtils.java\n\n@@ -30,24 +31,18 @@ public class AuthFileUtils {\n     }\n \n     public static String createAclString(@NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        for (String aceString: aceStrings) {\n-            builder.append(aceString).append(\";\");\n-        }\n-        return builder.toString();\n+        return aceStrings.stream().collect(Collectors.joining(\";\"));\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String entryAsString) {\n-        StringBuilder builder = new StringBuilder(entryAsString);\n-        writer.write(builder.append(\"\\n\").toString());\n+        writer.write(entryAsString + \"\\n\");\n     }\n \n     @SneakyThrows\n     public static void addAuthFileEntry(@NonNull FileWriter writer, @NonNull String username,\n                                            @NonNull String hashedPwd, @NonNull List<String> aceStrings) {\n-        StringBuilder builder = new StringBuilder();\n-        builder.append(username).append(\":\").append(hashedPwd).append(\":\").append(createAclString(aceStrings));\n-        addAuthFileEntry(writer, builder.toString());\n+        String fileEntry = String.format(\"%s:%s:%s\", username, hashedPwd, createAclString(aceStrings));\n+        addAuthFileEntry(writer, fileEntry);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzY3OA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470687678", "bodyText": "Arrays.asList -> Collections.singletonList", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:15:32Z", "path": "controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java", "diffHunk": "@@ -11,40 +11,50 @@\n \n import io.grpc.ServerBuilder;\n import io.pravega.test.common.SecurityConfigDefaults;\n-import io.pravega.controller.server.rpc.auth.AuthHandlerManager;\n-import io.pravega.controller.server.rpc.auth.StrongPasswordProcessor;\n+import io.pravega.controller.server.security.auth.handler.AuthHandlerManager;\n+import io.pravega.controller.server.security.auth.StrongPasswordProcessor;\n import io.pravega.controller.server.rpc.grpc.impl.GRPCServerConfigImpl;\n import io.pravega.test.common.TestUtils;\n import javax.ws.rs.client.Invocation;\n import javax.ws.rs.core.HttpHeaders;\n import javax.ws.rs.core.MultivaluedHashMap;\n import javax.ws.rs.core.MultivaluedMap;\n-import org.junit.Before;\n-\n import java.io.File;\n import java.io.FileWriter;\n+import java.util.Arrays;\n+import org.junit.Before;\n+\n+import static io.pravega.controller.auth.AuthFileUtils.addAuthFileEntry;\n \n public class SecureStreamMetaDataTests extends  StreamMetaDataTests {\n+\n     @Override\n     @Before\n     public void setup() throws Exception {\n-        File file = File.createTempFile(\"passwd\", \".txt\");\n-\n+        File file = File.createTempFile(\"SecureStreamMetaDataTests\", \".txt\");\n         StrongPasswordProcessor passwordEncryptor = StrongPasswordProcessor.builder().build();\n \n         try (FileWriter writer = new FileWriter(file.getAbsolutePath())) {\n             String passwd = passwordEncryptor.encryptPassword(\"1111_aaaa\");\n \n             // Admin has READ_WRITE permission to everything\n-            writer.write(\"admin:\" + passwd + \":*,READ_UPDATE\\n\");\n+            addAuthFileEntry(writer, \"admin\", passwd, Arrays.asList(\"prn::*,READ_UPDATE\"));", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4MTQyMg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471881422", "bodyText": "Modified.", "author": "ravisharda", "createdAt": "2020-08-18T02:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4NzY3OA=="}], "type": "inlineReview", "revised_code": {"commit": "a459ca0275089b845832c1aac7460f9241ed1462", "chunk": "diff --git a/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java b/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\nindex 19909b8a0..ddbd81fa7 100644\n--- a/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\n+++ b/controller/src/test/java/io/pravega/controller/rest/v1/SecureStreamMetaDataTests.java\n\n@@ -22,6 +22,8 @@ import javax.ws.rs.core.MultivaluedMap;\n import java.io.File;\n import java.io.FileWriter;\n import java.util.Arrays;\n+import java.util.Collections;\n+\n import org.junit.Before;\n \n import static io.pravega.controller.auth.AuthFileUtils.addAuthFileEntry;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4OTI2Mg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r470689262", "bodyText": "Since you know your replaced string is at the beginning, use substring. Much faster to process.", "author": "andreipaduroiu", "createdAt": "2020-08-14T15:18:27Z", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java", "diffHunk": "@@ -75,6 +75,14 @@ public JsonWebToken verifyToken(@NonNull String resource, String token, @NonNull\n      * @return\n      */\n     private boolean resourceMatchesClaimKey(String claimKey, String resource) {\n+        log.trace(\"claimKey = {}, resourceKey = {}\", claimKey, resource);\n+        if (claimKey.startsWith(\"prn::\")) {\n+            claimKey = claimKey.replace(\"prn::/\", \"\")", "originalCommit": "a000a66776c32c3e475cfd7671eca45a1fbb5b69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg4Mjk0OQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r471882949", "bodyText": "IMO, the code looks simpler with the replace call and reveals its intention better. So, I feel we should leave it as is.\nBesides, resources can be both of the form prn::/... and prn::*, which is why I'm replacing the former first and then attempting to replace prn::.", "author": "ravisharda", "createdAt": "2020-08-18T02:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4OTI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0OTkxMA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r473549910", "bodyText": "I have modified the code with a much more efficient logic. Please check out the new logic.", "author": "ravisharda", "createdAt": "2020-08-20T02:29:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY4OTI2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "095cfed037b8bef930c5d8dc939bc495de4623c5", "chunk": "diff --git a/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java b/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\nindex ed6bf228d..29a5c2c93 100644\n--- a/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\n+++ b/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/delegationtoken/TokenVerifierImpl.java\n\n@@ -76,12 +79,9 @@ public class TokenVerifierImpl implements DelegationTokenVerifier {\n      */\n     private boolean resourceMatchesClaimKey(String claimKey, String resource) {\n         log.trace(\"claimKey = {}, resourceKey = {}\", claimKey, resource);\n-        if (claimKey.startsWith(\"prn::\")) {\n-            claimKey = claimKey.replace(\"prn::/\", \"\")\n-                    .replace(\"prn::\", \"\")\n-                    .replace(\"scope:\", \"\")\n-                    .replace(\"stream:\", \"\");\n-        }\n+\n+        // Replace `prn::`, `/scope:` and `stream:` with an empty string.\n+        claimKey = RESOURCE_PARTS_TO_REPLACE.matcher(claimKey).replaceAll(\"\");\n \n         /*\n          * Examples of the conditions when the claimKey (key of the key-value pair claim) matches the resource are:\n"}}, {"oid": "4e2196ae352b37497b658da5cc725918172aa82f", "url": "https://github.com/pravega/pravega/commit/4e2196ae352b37497b658da5cc725918172aa82f", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-17T02:11:14Z", "type": "commit"}, {"oid": "a459ca0275089b845832c1aac7460f9241ed1462", "url": "https://github.com/pravega/pravega/commit/a459ca0275089b845832c1aac7460f9241ed1462", "message": "Address review comments\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-17T08:13:55Z", "type": "commit"}, {"oid": "63b6c65df46adc77db50e1d6da80799adb8a503a", "url": "https://github.com/pravega/pravega/commit/63b6c65df46adc77db50e1d6da80799adb8a503a", "message": "Merge remote-tracking branch 'origin/auth-resources-permissions' into auth-resources-permissions", "committedDate": "2020-08-17T08:15:12Z", "type": "commit"}, {"oid": "060e8d6546291991fc7b6d66970687de9f25cfd3", "url": "https://github.com/pravega/pravega/commit/060e8d6546291991fc7b6d66970687de9f25cfd3", "message": "Push replacement of `*` with `.*` in resource patterns from authorization time to ACE construction time\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-18T02:40:58Z", "type": "commit"}, {"oid": "97d507b9b025950730d0fd61a05d25e793b65207", "url": "https://github.com/pravega/pravega/commit/97d507b9b025950730d0fd61a05d25e793b65207", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-19T03:34:49Z", "type": "commit"}, {"oid": "095cfed037b8bef930c5d8dc939bc495de4623c5", "url": "https://github.com/pravega/pravega/commit/095cfed037b8bef930c5d8dc939bc495de4623c5", "message": "Optimize resource parts replacement\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-19T06:06:50Z", "type": "commit"}, {"oid": "1a12909f647b3af7c6759d4560211165b38a3c8b", "url": "https://github.com/pravega/pravega/commit/1a12909f647b3af7c6759d4560211165b38a3c8b", "message": "Merge remote-tracking branch 'origin/auth-resources-permissions' into auth-resources-permissions", "committedDate": "2020-08-19T06:27:03Z", "type": "commit"}, {"oid": "436cfc6991f01911098c1f2860b620734d5f65af", "url": "https://github.com/pravega/pravega/commit/436cfc6991f01911098c1f2860b620734d5f65af", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-21T04:50:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQwNjc5NQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r474406795", "bodyText": "should we make the format a constant?", "author": "shiveshr", "createdAt": "2020-08-21T04:50:17Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResourceImpl.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth;\n+\n+import io.pravega.common.Exceptions;\n+\n+/**\n+ * The main implementation of the {@link AuthorizationResource} class.\n+ */\n+public class AuthorizationResourceImpl implements AuthorizationResource {\n+    public static final String DOMAIN_PART_SUFFIX = \"prn::\";\n+    private static final String TAG_SCOPE = \"scope\";\n+    private static final String TAG_STREAM = \"stream\";\n+    private static final String TAG_READERGROUP = \"reader-group\";\n+    private static final String TAG_KEYVALUETABLE = \"key-value-table\";\n+\n+    private static final String ROOT_RESOURCE = String.format(\"%s/\", DOMAIN_PART_SUFFIX);\n+\n+    @Override\n+    public String ofScopes() {\n+        return ROOT_RESOURCE;\n+    }\n+\n+    @Override\n+    public String ofScope(String scopeName) {\n+        Exceptions.checkNotNullOrEmpty(scopeName, \"scopeName\");\n+        return String.format(\"%s/%s:%s\", DOMAIN_PART_SUFFIX, TAG_SCOPE, scopeName);\n+    }\n+\n+    @Override\n+    public String ofStreamsInScope(String scopeName) {\n+        return ofScope(scopeName);\n+    }\n+\n+    @Override\n+    public String ofStreamInScope(String scopeName, String streamName) {\n+        Exceptions.checkNotNullOrEmpty(scopeName, \"scopeName\");\n+        Exceptions.checkNotNullOrEmpty(streamName, \"streamName\");\n+        return String.format(\"%s/%s:%s\", ofScope(scopeName), TAG_STREAM, streamName);", "originalCommit": "1a12909f647b3af7c6759d4560211165b38a3c8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1OTE5MQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478259191", "bodyText": "IMO specifying the format directly here makes it easier to understand the output returned by this line of code.", "author": "ravisharda", "createdAt": "2020-08-27T08:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQwNjc5NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMTQxNw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475521417", "bodyText": "same here and elsewhere", "author": "shiveshr", "createdAt": "2020-08-24T11:02:54Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth;\n+\n+import io.pravega.common.Exceptions;\n+\n+/**\n+ * A legacy implementation that constructs resource strings in the old format.\n+ */\n+public final class LegacyAuthorizationResourceImpl implements AuthorizationResource {\n+\n+    public String ofScopes() {\n+        return \"/\";\n+    }\n+\n+    public String ofScope(String scopeName) {\n+        Exceptions.checkNotNullOrEmpty(scopeName, \"scopeName\");\n+        return scopeName;\n+    }\n+\n+    public String ofStreamsInScope(String scopeName) {\n+        return Exceptions.checkNotNullOrEmpty(scopeName, \"scopeName\");\n+    }\n+\n+    public String ofStreamInScope(String scopeName, String streamName) {\n+        Exceptions.checkNotNullOrEmpty(streamName, \"streamName\");\n+        return String.format(\"%s/%s\", ofStreamsInScope(scopeName), streamName);", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODA1OTkxOA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478059918", "bodyText": "Specifying the format directly makes it easier to understand what's happening here, IMO.", "author": "ravisharda", "createdAt": "2020-08-27T03:48:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMTQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "a195a3244b8ad8a0f5bbe8ec57439ad610b19145", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\nindex 603510423..8c7938895 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\n\n@@ -12,6 +12,8 @@ package io.pravega.controller.server.security.auth;\n import io.pravega.common.Exceptions;\n \n /**\n+ * Deprecated: Use {@link AuthorizationResourceImpl} instead.\n+ *\n  * A legacy implementation that constructs resource strings in the old format.\n  */\n public final class LegacyAuthorizationResourceImpl implements AuthorizationResource {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMjA2MQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475522061", "bodyText": "Should this class be in controller or be moved to \"auth\" module.\nThis has nothing specific to controller's auth.", "author": "shiveshr", "createdAt": "2020-08-24T11:04:17Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/StrongPasswordProcessor.java", "diffHunk": "@@ -7,7 +7,7 @@\n  *\n  *     http://www.apache.org/licenses/LICENSE-2.0\n  */\n-package io.pravega.controller.server.rpc.auth;\n+package io.pravega.controller.server.security.auth;", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1OTkzNQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478259935", "bodyText": "I've created a separate issue #5118 that should include these changes plus other organizational changes required in the security-related code.", "author": "ravisharda", "createdAt": "2020-08-27T08:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMjA2MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMzA4OQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475523089", "bodyText": "same comment here - should we take the opportunity to move this to auth module as this is generic User Principal which is serializable.", "author": "shiveshr", "createdAt": "2020-08-24T11:06:23Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/UserPrincipal.java", "diffHunk": "@@ -7,7 +7,7 @@\n  *\n  *     http://www.apache.org/licenses/LICENSE-2.0\n  */\n-package io.pravega.controller.server.rpc.auth;\n+package io.pravega.controller.server.security.auth;", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI2MDE4MA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478260180", "bodyText": "I've created a separate issue #5118 that should include these changes plus other organizational changes required in the security-related code.", "author": "ravisharda", "createdAt": "2020-08-27T08:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMzA4OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDMxNw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475524317", "bodyText": "so legacy pattern here does not have the \"domain\". and we do not have .* there. right?\nso in the new pattern, why do we allow for pravega:://scope:* at all if this is the new pattern and we want \".*\"", "author": "shiveshr", "createdAt": "2020-08-24T11:09:12Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Strings;\n+import io.pravega.auth.AuthHandler;\n+import lombok.AccessLevel;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+import java.util.regex.Pattern;\n+\n+/**\n+ * An entry of an {@link AccessControlList}.\n+ */\n+class AccessControlEntry {\n+    private static final Pattern PATTERN_STAR_NOT_PRECEDED_BY_DOT = Pattern.compile(\"(?!=.)\\\\*\");\n+\n+    @Getter(AccessLevel.PACKAGE)\n+    private final String resourcePattern;\n+\n+    @Getter(AccessLevel.PACKAGE)\n+    private final AuthHandler.Permissions permissions;\n+\n+    @VisibleForTesting\n+    AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions) {\n+        this(aceResource, permissions, false);\n+    }\n+\n+    @VisibleForTesting\n+    AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions, boolean isLegacyFormat) {\n+        // Replaces any `*` with `.*`, if it's not already preceded by `.`, for regex processing.\n+        // So, `pravega:://*` becomes `pravega:://.*` and `pravega:://scope:*` becomes `pravega:://scope:.*`\n+        this.resourcePattern = isLegacyFormat ?  aceResource :", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI1MzE1Mg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478253152", "bodyText": "I added support for * in lieu of the regex .* for usability. Admins/operators may find it easier to remember to use wildcards without the preceding dot. Both'd work exactly the same way as we replace * with .*  if it is not preceded by the dot.", "author": "ravisharda", "createdAt": "2020-08-27T08:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\nindex e52f51af7..54cbbcfd7 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\n\n@@ -38,7 +38,7 @@ class AccessControlEntry {\n     @VisibleForTesting\n     AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions, boolean isLegacyFormat) {\n         // Replaces any `*` with `.*`, if it's not already preceded by `.`, for regex processing.\n-        // So, `pravega:://*` becomes `pravega:://.*` and `pravega:://scope:*` becomes `pravega:://scope:.*`\n+        // So, `prn::/*` becomes `prn::/.*` and `prn::/scope:*` becomes `prn::/scope:.*`\n         this.resourcePattern = isLegacyFormat ?  aceResource :\n                 PATTERN_STAR_NOT_PRECEDED_BY_DOT.matcher(aceResource).replaceAll(\".*\");\n         this.permissions = permissions;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDg4Ng==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475524886", "bodyText": "in which situations can \"ace\" split not be of length 2? and is that an illegal argument or is ace = null legit if the number of tokens in it are 3 or 1?", "author": "shiveshr", "createdAt": "2020-08-24T11:10:27Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Strings;\n+import io.pravega.auth.AuthHandler;\n+import lombok.AccessLevel;\n+import lombok.Getter;\n+import lombok.NonNull;\n+\n+import java.util.regex.Pattern;\n+\n+/**\n+ * An entry of an {@link AccessControlList}.\n+ */\n+class AccessControlEntry {\n+    private static final Pattern PATTERN_STAR_NOT_PRECEDED_BY_DOT = Pattern.compile(\"(?!=.)\\\\*\");\n+\n+    @Getter(AccessLevel.PACKAGE)\n+    private final String resourcePattern;\n+\n+    @Getter(AccessLevel.PACKAGE)\n+    private final AuthHandler.Permissions permissions;\n+\n+    @VisibleForTesting\n+    AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions) {\n+        this(aceResource, permissions, false);\n+    }\n+\n+    @VisibleForTesting\n+    AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions, boolean isLegacyFormat) {\n+        // Replaces any `*` with `.*`, if it's not already preceded by `.`, for regex processing.\n+        // So, `pravega:://*` becomes `pravega:://.*` and `pravega:://scope:*` becomes `pravega:://scope:.*`\n+        this.resourcePattern = isLegacyFormat ?  aceResource :\n+                PATTERN_STAR_NOT_PRECEDED_BY_DOT.matcher(aceResource).replaceAll(\".*\");\n+        this.permissions = permissions;\n+    }\n+\n+    static AccessControlEntry fromString(String ace) {\n+        String[] splits = null;\n+        if (Strings.isNullOrEmpty(ace) || (splits = ace.split(\",\")).length != 2) {", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODE3MzI5Nw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478173297", "bodyText": "Since ACEs are specified manually via the Password Auth Handler input file, they could be ill-formed.\nA couple of examples of the split being of a length != 2 are as follows:\n\nprn::/ (No comma - permission missing, splits = 1)\n,,READ  (3 splits)", "author": "ravisharda", "createdAt": "2020-08-27T06:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg5ODAxOQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r481898019", "bodyText": "A minor point, but shouldn't it be an exception rather returning null? We expect a valid string, and if the string is not valid, then I'd say it is an exception.", "author": "fpj", "createdAt": "2020-09-02T08:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDg4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk1ODA0NA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r481958044", "bodyText": "@fpj Returning null here makes the calling code in the PasswordAuthhandler much simpler, which is why I took this approach here. This contract of this method is that it returns a non-null AccessControlEntry object for valid strings and null for invalid strings.", "author": "ravisharda", "createdAt": "2020-09-02T10:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNDg4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\nindex e52f51af7..54cbbcfd7 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AccessControlEntry.java\n\n@@ -38,7 +38,7 @@ class AccessControlEntry {\n     @VisibleForTesting\n     AccessControlEntry(@NonNull String aceResource, @NonNull AuthHandler.Permissions permissions, boolean isLegacyFormat) {\n         // Replaces any `*` with `.*`, if it's not already preceded by `.`, for regex processing.\n-        // So, `pravega:://*` becomes `pravega:://.*` and `pravega:://scope:*` becomes `pravega:://scope:.*`\n+        // So, `prn::/*` becomes `prn::/.*` and `prn::/scope:*` becomes `prn::/scope:.*`\n         this.resourcePattern = isLegacyFormat ?  aceResource :\n                 PATTERN_STAR_NOT_PRECEDED_BY_DOT.matcher(aceResource).replaceAll(\".*\");\n         this.permissions = permissions;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNTkzMA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475525930", "bodyText": "is it possible that some ACLs are defined in legacy format while others are in new format? or is it expected to be consistent for all ACLs?", "author": "shiveshr", "createdAt": "2020-08-24T11:12:39Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+\n+/**\n+ * Authorizes resources based on supplied ACLs.\n+ */\n+abstract class AclAuthorizer {", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0OTgzNQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478249835", "bodyText": "As per current implementation, all ACLs must be specified in the new format. Any ACLs specified in legacy format won't work. There is another discussion on this, fyi.", "author": "ravisharda", "createdAt": "2020-08-27T08:33:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxMDc3Mg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r482710772", "bodyText": "So while upgrading from 0.8 to 0.9 admins will need to rewrite their acls in the new format before doing the upgrade.. right?", "author": "shiveshr", "createdAt": "2020-09-03T05:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNTkzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAzODkxMA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r486038910", "bodyText": "Yes, that is right.", "author": "ravisharda", "createdAt": "2020-09-10T03:20:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNTkzMA=="}], "type": "inlineReview", "revised_code": {"commit": "68ee7ac189d6d86bc9613fa61ea016d061043257", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\nindex 82fd1ba90..e941681cc 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\n\n@@ -16,17 +16,7 @@ import io.pravega.auth.AuthHandler;\n  */\n abstract class AclAuthorizer {\n \n-    private final static AclAuthorizerImpl AUTHORIZER_FOR_NEW_FORMAT = new AclAuthorizerImpl();\n-    private final static LegacyAclAuthorizerImpl AUTHORIZER_FOR_LEGACY_FORMAT = new LegacyAclAuthorizerImpl();\n-\n-    /**\n-     * Returns a cached instance of the legacy implementation.\n-     *\n-     * @return an instance\n-     */\n-    static AclAuthorizer legacyAuthorizerInstance() {\n-        return AUTHORIZER_FOR_LEGACY_FORMAT;\n-    }\n+    private final static AclAuthorizerImpl AUTHORIZER_IMPL = new AclAuthorizerImpl();\n \n     /**\n      * Returns a cached instance of the implementation.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDQ0NQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475540445", "bodyText": "what is the reason to use ::// instead of :// ?", "author": "shiveshr", "createdAt": "2020-08-24T11:42:47Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {\n+\n+    @Override\n+    public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n+        AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n+\n+        String resourceDomain;\n+        int indexOfPartsSeparator = resource.indexOf(\"::\");", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDc1OA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475540758", "bodyText": "and should you simply split it by \":://\" ?", "author": "shiveshr", "createdAt": "2020-08-24T11:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDQ0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3Mzg3NA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478273874", "bodyText": "Actually, the resource looks like this: prn::/scope:MarketData/stream:Prices. There was an inaccurate comment elsewhere that might have misled you about the format.\nMore examples can be found here.", "author": "ravisharda", "createdAt": "2020-08-27T09:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDQ0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex b86f397cb..820c2ec82 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -17,15 +17,7 @@ class AclAuthorizerImpl extends AclAuthorizer {\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n-\n-        String resourceDomain;\n-        int indexOfPartsSeparator = resource.indexOf(\"::\");\n-        if (indexOfPartsSeparator > 0) {\n-            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n-        } else {\n-            resourceDomain = \"prn\"; // default\n-        }\n-\n+        String resourceDomain = resource.split(\"::\")[0];\n         for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n             // You could have a null ACE in the ACL if you had a malformed entry such as `prn::/scope:readresource`\n             // having no permissions set.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTEyNQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475541125", "bodyText": "when we are using the new authorization scheme, then should we even allow for resource domain to be unspecified?", "author": "shiveshr", "createdAt": "2020-08-24T11:44:22Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {\n+\n+    @Override\n+    public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n+        AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n+\n+        String resourceDomain;\n+        int indexOfPartsSeparator = resource.indexOf(\"::\");\n+        if (indexOfPartsSeparator > 0) {\n+            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n+        } else {\n+            resourceDomain = \"prn\"; // default", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI2NTcyMw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478265723", "bodyText": "Yes, the code above assumes the default prn domain. When this code is used as-is in other domains like prn.schema-registry, the domain part will automatically be mandatory.\nI have two opposite opinions about this.\n\nOn one hand, allowing for this flexibility could make life a tad easier for the admins, improving usability.\nOn the other hand, it's slightly simpler if admins always had to specify it and they didn't have to make an explicit choice (to specify the domain or not).\n\nIn this case, I've favored the former. What do you think?", "author": "ravisharda", "createdAt": "2020-08-27T08:59:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI3NTEzNg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478275136", "bodyText": "On second thought, we don't actually need to add a default resource domain. This is not the ACE, where domain might be missing. This is really the resource string which is in our control and should always have the domain. I will fix it.", "author": "ravisharda", "createdAt": "2020-08-27T09:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTEyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMwNzk2NA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478307964", "bodyText": "I've now pushed the modified code that assumes domain is always present in the resource string used for authorization.", "author": "ravisharda", "createdAt": "2020-08-27T10:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTEyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex b86f397cb..820c2ec82 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -17,15 +17,7 @@ class AclAuthorizerImpl extends AclAuthorizer {\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n-\n-        String resourceDomain;\n-        int indexOfPartsSeparator = resource.indexOf(\"::\");\n-        if (indexOfPartsSeparator > 0) {\n-            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n-        } else {\n-            resourceDomain = \"prn\"; // default\n-        }\n-\n+        String resourceDomain = resource.split(\"::\")[0];\n         for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n             // You could have a null ACE in the ACL if you had a malformed entry such as `prn::/scope:readresource`\n             // having no permissions set.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTM2MQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475541361", "bodyText": "nit: two nested if conditions. can it be simplified?", "author": "shiveshr", "createdAt": "2020-08-24T11:44:51Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {\n+\n+    @Override\n+    public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n+        AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n+\n+        String resourceDomain;\n+        int indexOfPartsSeparator = resource.indexOf(\"::\");\n+        if (indexOfPartsSeparator > 0) {\n+            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n+        } else {\n+            resourceDomain = \"prn\"; // default\n+        }\n+\n+        for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n+            // You could have a null ACE in the ACL if you had a malformed entry such as `prn::/scope:readresource`\n+            // having no permissions set.\n+            if (accessControlEntry != null && accessControlEntry.resourceStartsWith(resourceDomain)) {", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMwOTAzMw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478309033", "bodyText": "Hmm... can't think of a simpler means right now. Do you have an idea?", "author": "ravisharda", "createdAt": "2020-08-27T10:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MTM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex b86f397cb..820c2ec82 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -17,15 +17,7 @@ class AclAuthorizerImpl extends AclAuthorizer {\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n-\n-        String resourceDomain;\n-        int indexOfPartsSeparator = resource.indexOf(\"::\");\n-        if (indexOfPartsSeparator > 0) {\n-            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n-        } else {\n-            resourceDomain = \"prn\"; // default\n-        }\n-\n+        String resourceDomain = resource.split(\"::\")[0];\n         for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n             // You could have a null ACE in the ACL if you had a malformed entry such as `prn::/scope:readresource`\n             // having no permissions set.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MjA4Ng==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r475542086", "bodyText": "Should we move this class to a common module like \"auth\" such that schema registry and other services can leverage the auth module", "author": "shiveshr", "createdAt": "2020-08-24T11:46:29Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+import lombok.NonNull;\n+\n+class AclAuthorizerImpl extends AclAuthorizer {", "originalCommit": "436cfc6991f01911098c1f2860b620734d5f65af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODI0NjgwMA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r478246800", "bodyText": "As discussed, I've created a separate issue #5118 for the reorganization of the security-related code in general.", "author": "ravisharda", "createdAt": "2020-08-27T08:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MjA4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\nindex b86f397cb..820c2ec82 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizerImpl.java\n\n@@ -17,15 +17,7 @@ class AclAuthorizerImpl extends AclAuthorizer {\n     @Override\n     public AuthHandler.Permissions authorize(@NonNull AccessControlList accessControlList, @NonNull String resource) {\n         AuthHandler.Permissions result = AuthHandler.Permissions.NONE;\n-\n-        String resourceDomain;\n-        int indexOfPartsSeparator = resource.indexOf(\"::\");\n-        if (indexOfPartsSeparator > 0) {\n-            resourceDomain = resource.substring(0, indexOfPartsSeparator);\n-        } else {\n-            resourceDomain = \"prn\"; // default\n-        }\n-\n+        String resourceDomain = resource.split(\"::\")[0];\n         for (AccessControlEntry accessControlEntry : accessControlList.getEntries()) {\n             // You could have a null ACE in the ACL if you had a malformed entry such as `prn::/scope:readresource`\n             // having no permissions set.\n"}}, {"oid": "d6f00e86ff45a164bac6615c23c5091ddc43bde9", "url": "https://github.com/pravega/pravega/commit/d6f00e86ff45a164bac6615c23c5091ddc43bde9", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-26T15:28:04Z", "type": "commit"}, {"oid": "a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "url": "https://github.com/pravega/pravega/commit/a1051184bd9337e3f27d10f3a4a551a4c1fa0cb8", "message": "Address review comments\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-08-27T10:09:10Z", "type": "commit"}, {"oid": "f432d3f5b2890a47bfd4ac57c58a39583639f839", "url": "https://github.com/pravega/pravega/commit/f432d3f5b2890a47bfd4ac57c58a39583639f839", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-08-31T03:42:26Z", "type": "commit"}, {"oid": "fcc6f35ff16b9fb62e3ecaa4c7cf7b00b6bf7353", "url": "https://github.com/pravega/pravega/commit/fcc6f35ff16b9fb62e3ecaa4c7cf7b00b6bf7353", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-02T05:46:27Z", "type": "commit"}, {"oid": "9f868b5acf8b7c5462ac5092c9fe3ef32a36f1b5", "url": "https://github.com/pravega/pravega/commit/9f868b5acf8b7c5462ac5092c9fe3ef32a36f1b5", "message": "Changes to fix compilation issues after merge from master\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-09-02T08:15:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r481885702", "bodyText": "I suppose we are deprecating the previous format, how are we going to indicate that it is deprecated? Via documentation? We can certainly annotate this class, but that's not visible to users.", "author": "fpj", "createdAt": "2020-09-02T08:31:13Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth;\n+\n+import io.pravega.common.Exceptions;\n+\n+/**\n+ * A legacy implementation that constructs resource strings in the old format.\n+ */\n+public final class LegacyAuthorizationResourceImpl implements AuthorizationResource {", "originalCommit": "9f868b5acf8b7c5462ac5092c9fe3ef32a36f1b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkyNjg0Nw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r481926847", "bodyText": "Actually, we are removing support for the old format altogether. This class is there only so that it is easy to see what was the old format and compare it with the new format.", "author": "ravisharda", "createdAt": "2020-09-02T09:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwODMyMg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r482708322", "bodyText": "in that case, if this class is not being used at all, should this even be included in the code? or should we simply remove it entirely and cover the differences in the PR description (and its already present in PDP)", "author": "shiveshr", "createdAt": "2020-09-03T05:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3MjM5MQ==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r486772391", "bodyText": "I wanted to keep it at least for some time so that its easier to inspect the differences and compare the two at development time. I shall remove them once this change has been well tested through the normal course of testing.", "author": "ravisharda", "createdAt": "2020-09-11T04:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NDQwMg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r486774402", "bodyText": "In the latest comment that I have just pushed, I've added a deprecation note in the class JavaDoc. (I couldn't use the deprecation annotation, as the current build configuration fails build if classes decorated with that annotation are used.)\nAlso, these classes are used internally for representing resources and authorization and aren't meant to be used by external parties.", "author": "ravisharda", "createdAt": "2020-09-11T05:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI5NjQzNw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r489296437", "bodyText": "I'm not sure this makes sense. If we need to revert or anything, the we can go back to a previous version, that's a reason for using version control. If this code is only being kept for reference, then let's please remove it. If it is being used anywhere, then keep it.", "author": "fpj", "createdAt": "2020-09-16T09:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxNjgzNg==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r489316836", "bodyText": "Ok. I have removed the two classes that show legacy logic in the latest commit that I just pushed.", "author": "ravisharda", "createdAt": "2020-09-16T10:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg4NTcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "a195a3244b8ad8a0f5bbe8ec57439ad610b19145", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java b/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\nindex 603510423..8c7938895 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/LegacyAuthorizationResourceImpl.java\n\n@@ -12,6 +12,8 @@ package io.pravega.controller.server.security.auth;\n import io.pravega.common.Exceptions;\n \n /**\n+ * Deprecated: Use {@link AuthorizationResourceImpl} instead.\n+ *\n  * A legacy implementation that constructs resource strings in the old format.\n  */\n public final class LegacyAuthorizationResourceImpl implements AuthorizationResource {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNzEwNA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r482707104", "bodyText": "nit: the comment \"Returns\" for an interface seems odd. unless its a functional interface, which it is not.", "author": "shiveshr", "createdAt": "2020-09-03T05:08:08Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResource.java", "diffHunk": "@@ -7,12 +7,10 @@\n  *\n  *     http://www.apache.org/licenses/LICENSE-2.0\n  */\n-package io.pravega.controller.server;\n-\n-import io.pravega.common.Exceptions;\n+package io.pravega.controller.server.security.auth;\n \n /**\n- * A utility class with methods for preparing string representations of auth-protected resources.\n+ * Returns string representations of auth-protected resources.", "originalCommit": "9f868b5acf8b7c5462ac5092c9fe3ef32a36f1b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1OTc0NA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r486959744", "bodyText": "I've modified the comment as suggested.", "author": "ravisharda", "createdAt": "2020-09-11T10:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwNzEwNA=="}], "type": "inlineReview", "revised_code": {"commit": "a195a3244b8ad8a0f5bbe8ec57439ad610b19145", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResource.java b/controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResource.java\nindex 9bee33eb0..97ac04bfa 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResource.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/AuthorizationResource.java\n\n@@ -10,7 +10,7 @@\n package io.pravega.controller.server.security.auth;\n \n /**\n- * Returns string representations of auth-protected resources.\n+ * This interface provides string representations of auth-protected resources.\n  * <p>\n  * Background:\n  * <p>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxMTMyMA==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r482711320", "bodyText": "so if the code for legacy auth instance is only for comparison sake, should we even have a method to instantiate it?", "author": "shiveshr", "createdAt": "2020-09-03T05:24:00Z", "path": "controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.controller.server.security.auth.handler.impl;\n+\n+import io.pravega.auth.AuthHandler;\n+\n+/**\n+ * Authorizes resources based on supplied ACLs.\n+ */\n+abstract class AclAuthorizer {\n+\n+    private final static AclAuthorizerImpl AUTHORIZER_FOR_NEW_FORMAT = new AclAuthorizerImpl();\n+    private final static LegacyAclAuthorizerImpl AUTHORIZER_FOR_LEGACY_FORMAT = new LegacyAclAuthorizerImpl();\n+\n+    /**\n+     * Returns a cached instance of the legacy implementation.\n+     *\n+     * @return an instance\n+     */\n+    static AclAuthorizer legacyAuthorizerInstance() {", "originalCommit": "9f868b5acf8b7c5462ac5092c9fe3ef32a36f1b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1OTk5Nw==", "url": "https://github.com/pravega/pravega/pull/5051#discussion_r486959997", "bodyText": "I've kept it so that the tests can instantiate it.", "author": "ravisharda", "createdAt": "2020-09-11T10:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcxMTMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "68ee7ac189d6d86bc9613fa61ea016d061043257", "chunk": "diff --git a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\nindex 82fd1ba90..e941681cc 100644\n--- a/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\n+++ b/controller/src/main/java/io/pravega/controller/server/security/auth/handler/impl/AclAuthorizer.java\n\n@@ -16,17 +16,7 @@ import io.pravega.auth.AuthHandler;\n  */\n abstract class AclAuthorizer {\n \n-    private final static AclAuthorizerImpl AUTHORIZER_FOR_NEW_FORMAT = new AclAuthorizerImpl();\n-    private final static LegacyAclAuthorizerImpl AUTHORIZER_FOR_LEGACY_FORMAT = new LegacyAclAuthorizerImpl();\n-\n-    /**\n-     * Returns a cached instance of the legacy implementation.\n-     *\n-     * @return an instance\n-     */\n-    static AclAuthorizer legacyAuthorizerInstance() {\n-        return AUTHORIZER_FOR_LEGACY_FORMAT;\n-    }\n+    private final static AclAuthorizerImpl AUTHORIZER_IMPL = new AclAuthorizerImpl();\n \n     /**\n      * Returns a cached instance of the implementation.\n"}}, {"oid": "f053512c0254879d25e866a2917344c7f3c995cc", "url": "https://github.com/pravega/pravega/commit/f053512c0254879d25e866a2917344c7f3c995cc", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-04T03:34:56Z", "type": "commit"}, {"oid": "22d0368582a8a1af06280f78aae24c4b8ff63498", "url": "https://github.com/pravega/pravega/commit/22d0368582a8a1af06280f78aae24c4b8ff63498", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-08T09:46:28Z", "type": "commit"}, {"oid": "cc25cd9f06ce657f73e40bb535395cdeff55ce1c", "url": "https://github.com/pravega/pravega/commit/cc25cd9f06ce657f73e40bb535395cdeff55ce1c", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-09T07:18:04Z", "type": "commit"}, {"oid": "88be4769834ebaedd19446d31cfee7764f26afeb", "url": "https://github.com/pravega/pravega/commit/88be4769834ebaedd19446d31cfee7764f26afeb", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-09T07:58:24Z", "type": "commit"}, {"oid": "c0086b5173f6b624e9a3d55d98d7bd23440c3d93", "url": "https://github.com/pravega/pravega/commit/c0086b5173f6b624e9a3d55d98d7bd23440c3d93", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-10T03:54:33Z", "type": "commit"}, {"oid": "a195a3244b8ad8a0f5bbe8ec57439ad610b19145", "url": "https://github.com/pravega/pravega/commit/a195a3244b8ad8a0f5bbe8ec57439ad610b19145", "message": "Address review comments\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-09-11T04:49:52Z", "type": "commit"}, {"oid": "0942c4ba4e056b81136c4cecda07d3dcd4c5307f", "url": "https://github.com/pravega/pravega/commit/0942c4ba4e056b81136c4cecda07d3dcd4c5307f", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-11T04:50:13Z", "type": "commit"}, {"oid": "72b8f820f8e15f542949055eeb0c67cc14cd3236", "url": "https://github.com/pravega/pravega/commit/72b8f820f8e15f542949055eeb0c67cc14cd3236", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-11T10:35:59Z", "type": "commit"}, {"oid": "224f3629bff24dcb9533c3d9295dda149139282f", "url": "https://github.com/pravega/pravega/commit/224f3629bff24dcb9533c3d9295dda149139282f", "message": "Merge branch 'master' into auth-resources-permissions", "committedDate": "2020-09-16T03:14:53Z", "type": "commit"}, {"oid": "68ee7ac189d6d86bc9613fa61ea016d061043257", "url": "https://github.com/pravega/pravega/commit/68ee7ac189d6d86bc9613fa61ea016d061043257", "message": "Address review comments\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>", "committedDate": "2020-09-16T09:59:11Z", "type": "commit"}]}