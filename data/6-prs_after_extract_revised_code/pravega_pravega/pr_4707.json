{"pr_number": 4707, "pr_title": "Issue 4720: Reduce cpu use on client", "pr_createdAt": "2020-04-18T00:48:48Z", "pr_url": "https://github.com/pravega/pravega/pull/4707", "timeline": [{"oid": "df2584072d41526117dedfa3390a22dc9cc86984", "url": "https://github.com/pravega/pravega/commit/df2584072d41526117dedfa3390a22dc9cc86984", "message": "Avoid string concatenation\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-17T23:25:10Z", "type": "commit"}, {"oid": "1c1c7cd60ea59b98a4c58afba49d25f41e0466b6", "url": "https://github.com/pravega/pravega/commit/1c1c7cd60ea59b98a4c58afba49d25f41e0466b6", "message": "Reorder if to make fast path first.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-17T23:26:37Z", "type": "commit"}, {"oid": "d13ba079f5e08c5ea2112e3b47593b1b2d29df35", "url": "https://github.com/pravega/pravega/commit/d13ba079f5e08c5ea2112e3b47593b1b2d29df35", "message": "Remove dependency on ConcurrentSkipListMap\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-17T23:54:38Z", "type": "commit"}, {"oid": "245a18ba18b29135d23650ecd7ab731687868d79", "url": "https://github.com/pravega/pravega/commit/245a18ba18b29135d23650ecd7ab731687868d79", "message": "Minor test perf issues.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-17T23:56:07Z", "type": "commit"}, {"oid": "a868a3fadc093b85948a01bb1eae8701d99933ff", "url": "https://github.com/pravega/pravega/commit/a868a3fadc093b85948a01bb1eae8701d99933ff", "message": "Change to sqrt weighting\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-17T23:59:03Z", "type": "commit"}, {"oid": "21e4be6b0bd5770fe0b6cac73179ba9c53cce38a", "url": "https://github.com/pravega/pravega/commit/21e4be6b0bd5770fe0b6cac73179ba9c53cce38a", "message": "Avoid making multiple copys when constructing the position object\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-18T00:22:01Z", "type": "commit"}, {"oid": "b6d4ba1f695a5e77336c821d6b65b93ce62cec18", "url": "https://github.com/pravega/pravega/commit/b6d4ba1f695a5e77336c821d6b65b93ce62cec18", "message": "Pre-compute checkpoints for a reader.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-18T00:44:01Z", "type": "commit"}, {"oid": "9ec8d81742410ace62616a09c0f4834371277dd2", "url": "https://github.com/pravega/pravega/commit/9ec8d81742410ace62616a09c0f4834371277dd2", "message": "Fix compilation error\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-20T22:53:10Z", "type": "commit"}, {"oid": "9ec8d81742410ace62616a09c0f4834371277dd2", "url": "https://github.com/pravega/pravega/commit/9ec8d81742410ace62616a09c0f4834371277dd2", "message": "Fix compilation error\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-20T22:53:10Z", "type": "forcePushed"}, {"oid": "5b3f43e261d36ab46bcef468292d8c859dc6b1b7", "url": "https://github.com/pravega/pravega/commit/5b3f43e261d36ab46bcef468292d8c859dc6b1b7", "message": "Fix typo causing checkpoints to not work\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-21T00:00:10Z", "type": "commit"}, {"oid": "4fc10373df4fc88c827aa08f41e467e7beac1d57", "url": "https://github.com/pravega/pravega/commit/4fc10373df4fc88c827aa08f41e467e7beac1d57", "message": "Fix bug introduced in checkpoint logic\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-21T17:43:02Z", "type": "commit"}, {"oid": "9cabc18940e73d3a4b339333e1da0ac81594f011", "url": "https://github.com/pravega/pravega/commit/9cabc18940e73d3a4b339333e1da0ac81594f011", "message": "Fix ack level verification bug.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-21T17:50:13Z", "type": "commit"}, {"oid": "9cabc18940e73d3a4b339333e1da0ac81594f011", "url": "https://github.com/pravega/pravega/commit/9cabc18940e73d3a4b339333e1da0ac81594f011", "message": "Fix ack level verification bug.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-21T17:50:13Z", "type": "forcePushed"}, {"oid": "276a0e47e0bc7ce9bfaa207abe1a841a1e4c687d", "url": "https://github.com/pravega/pravega/commit/276a0e47e0bc7ce9bfaa207abe1a841a1e4c687d", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-21T17:58:08Z", "type": "commit"}, {"oid": "9ad0a5231a91621e0f8fd17ebd8e86ccc3596690", "url": "https://github.com/pravega/pravega/commit/9ad0a5231a91621e0f8fd17ebd8e86ccc3596690", "message": "Fix cleanup logic for host removal.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-22T03:53:21Z", "type": "commit"}, {"oid": "79f396735d3de9b3f4d36f937dae48ec7adaf6b6", "url": "https://github.com/pravega/pravega/commit/79f396735d3de9b3f4d36f937dae48ec7adaf6b6", "message": "Merge branch 'lower-cpu' of git@github.com:tkaitchuck/pravega-1.git into lower-cpu", "committedDate": "2020-04-22T03:53:44Z", "type": "commit"}, {"oid": "8948fbfd07bd44dcb2c93058f1e10bec45a2baaf", "url": "https://github.com/pravega/pravega/commit/8948fbfd07bd44dcb2c93058f1e10bec45a2baaf", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-22T04:47:09Z", "type": "commit"}, {"oid": "af9ef2b5f2b20c929250bc2940578227f2aaa935", "url": "https://github.com/pravega/pravega/commit/af9ef2b5f2b20c929250bc2940578227f2aaa935", "message": "Add test coverage.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-22T21:07:53Z", "type": "commit"}, {"oid": "c0adea978924906291d119e6c8493c6216d40ef9", "url": "https://github.com/pravega/pravega/commit/c0adea978924906291d119e6c8493c6216d40ef9", "message": "Merge branch 'lower-cpu' of git@github.com:tkaitchuck/pravega-1.git into lower-cpu", "committedDate": "2020-04-22T21:08:04Z", "type": "commit"}, {"oid": "95dfd11080dba2167a342159db4dbed3047cb216", "url": "https://github.com/pravega/pravega/commit/95dfd11080dba2167a342159db4dbed3047cb216", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-22T22:13:14Z", "type": "commit"}, {"oid": "1dd34e0f95825bd45470c22fa57ffd2947261742", "url": "https://github.com/pravega/pravega/commit/1dd34e0f95825bd45470c22fa57ffd2947261742", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-23T22:35:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzM3Mw==", "url": "https://github.com/pravega/pravega/pull/4707#discussion_r414197373", "bodyText": "Can this be rewritten as?\nEntry<Long, PendingEvent> entry;\nwhile(!inflight.isEmpty() && (entry = inflight.peekFirst()) != null) {\n    result.add(entry.getValue);\n    inflight.pollFirst();\n}\n\nThe goal here is to reduce the number of times peekFirst appears in the code.", "author": "andreipaduroiu", "createdAt": "2020-04-23T23:46:52Z", "path": "client/src/main/java/io/pravega/client/segment/impl/SegmentOutputStreamImpl.java", "diffHunk": "@@ -248,17 +249,22 @@ private long addToInflight(PendingEvent event) {\n          */\n         private List<PendingEvent> removeInflightBelow(long ackLevel) {\n             synchronized (lock) {\n-                ConcurrentNavigableMap<Long, PendingEvent> acked = inflight.headMap(ackLevel, true);\n-                List<PendingEvent> result = new ArrayList<>(acked.values());\n-                acked.clear();\n+                List<PendingEvent> result = new ArrayList<>();\n+                Entry<Long, PendingEvent> entry = inflight.peekFirst();\n+                while (entry != null && entry.getKey() <= ackLevel) {", "originalCommit": "1dd34e0f95825bd45470c22fa57ffd2947261742", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwMzk0MQ==", "url": "https://github.com/pravega/pravega/pull/4707#discussion_r414803941", "bodyText": "This ignores the loop conditional: entry.getKey() <= ackLevel", "author": "tkaitchuck", "createdAt": "2020-04-24T19:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzM3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5OTYzNQ==", "url": "https://github.com/pravega/pravega/pull/4707#discussion_r414199635", "bodyText": "This is not really thread safe. unmodifiableList returns a wrapper for readers, but readers can still be modified by this object, thus causing issues for anyone who might be iterating over it at the same time.", "author": "andreipaduroiu", "createdAt": "2020-04-23T23:53:10Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -370,10 +371,18 @@ public Type fetchEvent(EventPointer pointer) throws NoSuchEventException {\n         }\n     }\n \n-    @Synchronized\n     @VisibleForTesting\n     List<EventSegmentReader> getReaders() {\n-        return Collections.unmodifiableList(readers);\n+        synchronized (readers) {            \n+            return Collections.unmodifiableList(readers);", "originalCommit": "1dd34e0f95825bd45470c22fa57ffd2947261742", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e80865c1ad1c555f77a43eb6410baa728667f5c2", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\nindex a49e258f1..41461b292 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n\n@@ -374,14 +374,14 @@ public class EventStreamReaderImpl<Type> implements EventStreamReader<Type> {\n     @VisibleForTesting\n     List<EventSegmentReader> getReaders() {\n         synchronized (readers) {            \n-            return Collections.unmodifiableList(readers);\n+            return ImmutableList.copyOf(readers);\n         }\n     }\n     \n     @VisibleForTesting\n     Map<Segment, Range> getRanges() {\n         synchronized (readers) {\n-            return Collections.unmodifiableMap(ranges);\n+            return ImmutableMap.copyOf(ranges);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5OTY5MQ==", "url": "https://github.com/pravega/pravega/pull/4707#discussion_r414199691", "bodyText": "same here", "author": "andreipaduroiu", "createdAt": "2020-04-23T23:53:16Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -370,10 +371,18 @@ public Type fetchEvent(EventPointer pointer) throws NoSuchEventException {\n         }\n     }\n \n-    @Synchronized\n     @VisibleForTesting\n     List<EventSegmentReader> getReaders() {\n-        return Collections.unmodifiableList(readers);\n+        synchronized (readers) {            \n+            return Collections.unmodifiableList(readers);\n+        }\n+    }\n+    \n+    @VisibleForTesting\n+    Map<Segment, Range> getRanges() {\n+        synchronized (readers) {\n+            return Collections.unmodifiableMap(ranges);", "originalCommit": "1dd34e0f95825bd45470c22fa57ffd2947261742", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e80865c1ad1c555f77a43eb6410baa728667f5c2", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\nindex a49e258f1..41461b292 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n\n@@ -374,14 +374,14 @@ public class EventStreamReaderImpl<Type> implements EventStreamReader<Type> {\n     @VisibleForTesting\n     List<EventSegmentReader> getReaders() {\n         synchronized (readers) {            \n-            return Collections.unmodifiableList(readers);\n+            return ImmutableList.copyOf(readers);\n         }\n     }\n     \n     @VisibleForTesting\n     Map<Segment, Range> getRanges() {\n         synchronized (readers) {\n-            return Collections.unmodifiableMap(ranges);\n+            return ImmutableMap.copyOf(ranges);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5OTgzMw==", "url": "https://github.com/pravega/pravega/pull/4707#discussion_r414199833", "bodyText": "Revert this?", "author": "andreipaduroiu", "createdAt": "2020-04-23T23:53:38Z", "path": "client/src/test/java/io/pravega/client/stream/impl/EventStreamReaderTest.java", "diffHunk": "@@ -85,7 +85,7 @@\n     private final Consumer<Segment> segmentSealedCallback = segment -> { };\n     private final EventWriterConfig writerConfig = EventWriterConfig.builder().build();\n \n-    @Test(timeout = 10000)\n+    @Test//(timeout = 10000)", "originalCommit": "1dd34e0f95825bd45470c22fa57ffd2947261742", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e80865c1ad1c555f77a43eb6410baa728667f5c2", "chunk": "diff --git a/client/src/test/java/io/pravega/client/stream/impl/EventStreamReaderTest.java b/client/src/test/java/io/pravega/client/stream/impl/EventStreamReaderTest.java\nindex cff427c4a..403088f6e 100644\n--- a/client/src/test/java/io/pravega/client/stream/impl/EventStreamReaderTest.java\n+++ b/client/src/test/java/io/pravega/client/stream/impl/EventStreamReaderTest.java\n\n@@ -85,7 +85,7 @@ public class EventStreamReaderTest {\n     private final Consumer<Segment> segmentSealedCallback = segment -> { };\n     private final EventWriterConfig writerConfig = EventWriterConfig.builder().build();\n \n-    @Test//(timeout = 10000)\n+    @Test(timeout = 10000)\n     public void testEndOfSegmentWithoutSuccessors() throws SegmentSealedException, ReaderNotInReaderGroupException {\n         AtomicLong clock = new AtomicLong();\n         MockSegmentStreamFactory segmentStreamFactory = new MockSegmentStreamFactory();\n"}}, {"oid": "e80865c1ad1c555f77a43eb6410baa728667f5c2", "url": "https://github.com/pravega/pravega/commit/e80865c1ad1c555f77a43eb6410baa728667f5c2", "message": "PR feedback\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-04-24T19:14:50Z", "type": "commit"}, {"oid": "1f1b0f27b73ba0ae1d693b6acc3d6bb70a8d3538", "url": "https://github.com/pravega/pravega/commit/1f1b0f27b73ba0ae1d693b6acc3d6bb70a8d3538", "message": "Merge branch 'lower-cpu' of git@github.com:tkaitchuck/pravega-1.git into lower-cpu", "committedDate": "2020-04-24T19:15:02Z", "type": "commit"}, {"oid": "f794463f7bebc76599b6b2f2f4c06e1a09afdd0f", "url": "https://github.com/pravega/pravega/commit/f794463f7bebc76599b6b2f2f4c06e1a09afdd0f", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-24T19:15:24Z", "type": "commit"}, {"oid": "7d265f6bbf30292478adf8c32d7264e249860d42", "url": "https://github.com/pravega/pravega/commit/7d265f6bbf30292478adf8c32d7264e249860d42", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-25T17:17:14Z", "type": "commit"}, {"oid": "5cad80a31e17b185924142fff1248e1b9877888b", "url": "https://github.com/pravega/pravega/commit/5cad80a31e17b185924142fff1248e1b9877888b", "message": "Merge branch 'master' into lower-cpu", "committedDate": "2020-04-27T10:06:09Z", "type": "commit"}]}