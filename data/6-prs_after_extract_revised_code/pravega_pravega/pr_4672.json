{"pr_number": 4672, "pr_title": "Issue 4669: (Bugfix) Fix serialization in PositionImpl.", "pr_createdAt": "2020-04-07T07:34:48Z", "pr_url": "https://github.com/pravega/pravega/pull/4672", "timeline": [{"oid": "3dd3443ca6e445ac315b9a3bd65b73c78508e231", "url": "https://github.com/pravega/pravega/commit/3dd3443ca6e445ac315b9a3bd65b73c78508e231", "message": "Fix by using compactSignedLong.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-04-07T07:32:59Z", "type": "commit"}, {"oid": "3b6ef25359c60698811bc00c985c319c15d29b64", "url": "https://github.com/pravega/pravega/commit/3b6ef25359c60698811bc00c985c319c15d29b64", "message": "Merge branch 'master' into bugfix-4669", "committedDate": "2020-04-07T07:38:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQ1MA==", "url": "https://github.com/pravega/pravega/pull/4672#discussion_r404970450", "bodyText": "This will break backward compatibility. Old code does not know how to deal with version 1.\nDo this using a revision.", "author": "andreipaduroiu", "createdAt": "2020-04-07T17:04:01Z", "path": "client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java", "diffHunk": "@@ -118,13 +118,14 @@ protected PositionBuilder newBuilder() {\n \n         @Override\n         protected byte getWriteVersion() {\n-            return 0;\n+            return 1;", "originalCommit": "3b6ef25359c60698811bc00c985c319c15d29b64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI0Nzk5Ng==", "url": "https://github.com/pravega/pravega/pull/4672#discussion_r405247996", "bodyText": "This bug prevents serialization with the older version of the client for -1L.\nI used a new version number since the serializing via RevisionDataOutput#writeCompactSignedLong (new change) cannot be deserialized via RevisionedDataOutput#readCompactLong (old change).\nI have also added a test to verify if serialization via version 0 can be deserialized via version 1.", "author": "shrids", "createdAt": "2020-04-08T04:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQ1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM5NjQ3Mg==", "url": "https://github.com/pravega/pravega/pull/4672#discussion_r405396472", "bodyText": "Done, I have updated the PR to ensure it is compatible either ways by using revision.", "author": "shrids", "createdAt": "2020-04-08T09:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MDQ1MA=="}], "type": "inlineReview", "revised_code": {"commit": "5496cf015ef07d98096cc110ea7cd30de8468316", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java b/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\nindex cc4fc598e..57db22459 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\n\n@@ -118,25 +118,34 @@ public class PositionImpl extends PositionInternal {\n \n         @Override\n         protected byte getWriteVersion() {\n-            return 1;\n+            return 0;\n         }\n \n         @Override\n         protected void declareVersions() {\n             version(0).revision(0, this::write00, this::read00)\n-                      .revision(1, this::write01, this::read01);\n-            version(1).revision(0, this::write10, this::read10);\n+                      .revision(1, this::write01, this::read01)\n+                      .revision(2, this::write02, this::read02);\n         }\n \n         private void read00(RevisionDataInput revisionDataInput, PositionBuilder builder) throws IOException {\n-            Map<Segment, Long> map = revisionDataInput.readMap(in -> Segment.fromScopedName(in.readUTF()), RevisionDataInput::readCompactLong);\n+            // RevisionDataInput::readCompactSignedLong can read data written using RevisionDataOutput.writeCompactLong\n+            Map<Segment, Long> map = revisionDataInput.readMap(in -> Segment.fromScopedName(in.readUTF()), RevisionDataInput::readCompactSignedLong);\n             builder.ownedSegments(map);\n         }\n \n         private void write00(PositionImpl position, RevisionDataOutput revisionDataOutput) throws IOException {\n+            // This is used to ensure serialized data can be read by the older client.\n+            // Note: the older client does not serialize if the offset has -1L as value.\n             Map<Segment, Long> map = position.getOwnedSegmentsWithOffsets();\n             revisionDataOutput.writeMap(map, (out, s) -> out.writeUTF(s.getScopedName()),\n-                                        (out, offset) -> out.writeCompactLong(offset));\n+                                        (out, offset) -> {\n+                                            if ( offset < 0) {\n+                                                out.writeCompactSignedLong(offset);\n+                                            } else {\n+                                                out.writeCompactLong(offset);\n+                                            }\n+                                        });\n         }\n         \n         private void read01(RevisionDataInput revisionDataInput, PositionBuilder builder) throws IOException {\n"}}, {"oid": "5496cf015ef07d98096cc110ea7cd30de8468316", "url": "https://github.com/pravega/pravega/commit/5496cf015ef07d98096cc110ea7cd30de8468316", "message": "CR Changes: Fix the issue with a revision change.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-04-08T09:32:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyOTMwOQ==", "url": "https://github.com/pravega/pravega/pull/4672#discussion_r405529309", "bodyText": "TIP: you can use a syntactic shortcut like RevisionDataOutput::writeCompactSignedLong", "author": "andreipaduroiu", "createdAt": "2020-04-08T13:35:10Z", "path": "client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java", "diffHunk": "@@ -147,7 +157,20 @@ private void write01(PositionImpl position, RevisionDataOutput revisionDataOutpu\n             Map<Segment, Range> map = position.segmentRanges;\n             revisionDataOutput.writeMap(map, (out, s) -> out.writeUTF(s.getScopedName()), PositionSerializer::writeRange);\n         }\n-        \n+\n+        private void write02(PositionImpl position, RevisionDataOutput revisionDataOutput) throws IOException {\n+            // serialize offset segment again as CompactSignedLong ensure serialization\n+            Map<Segment, Long> map = position.getOwnedSegmentsWithOffsets();\n+            revisionDataOutput.writeMap(map, (out, s) -> out.writeUTF(s.getScopedName()),\n+                    (out, offset) -> out.writeCompactSignedLong(offset));", "originalCommit": "5496cf015ef07d98096cc110ea7cd30de8468316", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a070f5261303d5ee93f7e11b498a8f5cb8246753", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java b/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\nindex 57db22459..9b4c56bf6 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/PositionImpl.java\n\n@@ -162,7 +162,7 @@ public class PositionImpl extends PositionInternal {\n             // serialize offset segment again as CompactSignedLong ensure serialization\n             Map<Segment, Long> map = position.getOwnedSegmentsWithOffsets();\n             revisionDataOutput.writeMap(map, (out, s) -> out.writeUTF(s.getScopedName()),\n-                    (out, offset) -> out.writeCompactSignedLong(offset));\n+                    RevisionDataOutput::writeCompactSignedLong);\n         }\n \n         // This method is invoked only if the data is serialized with revision as 2.\n"}}, {"oid": "a070f5261303d5ee93f7e11b498a8f5cb8246753", "url": "https://github.com/pravega/pravega/commit/a070f5261303d5ee93f7e11b498a8f5cb8246753", "message": "CR Changes: Improve usage pattern.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-04-08T14:28:38Z", "type": "commit"}, {"oid": "daff597019dfc438ffde713df2ba92635c1e2e25", "url": "https://github.com/pravega/pravega/commit/daff597019dfc438ffde713df2ba92635c1e2e25", "message": "Merge branch 'master' into bugfix-4669", "committedDate": "2020-04-08T15:19:51Z", "type": "commit"}, {"oid": "ad53b6aa9a9c050833e399a7ac2939436f71fdf3", "url": "https://github.com/pravega/pravega/commit/ad53b6aa9a9c050833e399a7ac2939436f71fdf3", "message": "Merge branch 'master' into bugfix-4669", "committedDate": "2020-04-14T03:49:19Z", "type": "commit"}, {"oid": "99212fbedf1899fa237a8df152f9e3668ccd5a25", "url": "https://github.com/pravega/pravega/commit/99212fbedf1899fa237a8df152f9e3668ccd5a25", "message": "CR Changes: Remove additional revision and reduce the size of serialization.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-04-15T04:15:19Z", "type": "commit"}, {"oid": "bfe9a8f93f29ea6f3a650d1b70b907c96f233be3", "url": "https://github.com/pravega/pravega/commit/bfe9a8f93f29ea6f3a650d1b70b907c96f233be3", "message": "Test refactoring.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-04-15T04:24:11Z", "type": "commit"}, {"oid": "6c3f506fdf21dc9413e3a3129ac7bde04c8edbda", "url": "https://github.com/pravega/pravega/commit/6c3f506fdf21dc9413e3a3129ac7bde04c8edbda", "message": "Merge branch 'master' into bugfix-4669", "committedDate": "2020-04-15T16:51:08Z", "type": "commit"}]}