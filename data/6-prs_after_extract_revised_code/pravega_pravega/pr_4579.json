{"pr_number": 4579, "pr_title": "Issue 4578: Early wake reader in response to server reply.", "pr_createdAt": "2020-02-27T05:58:23Z", "pr_url": "https://github.com/pravega/pravega/pull/4579", "timeline": [{"oid": "8e3e633492b1c43072d5c6443c61bb00858ab541", "url": "https://github.com/pravega/pravega/commit/8e3e633492b1c43072d5c6443c61bb00858ab541", "message": "Initial implementation of semephore based early wake\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-22T01:40:44Z", "type": "commit"}, {"oid": "69a25119f1586096a73514235928f2ca01353a83", "url": "https://github.com/pravega/pravega/commit/69a25119f1586096a73514235928f2ca01353a83", "message": "Merge branch 'master' into early-wake", "committedDate": "2020-02-22T01:42:03Z", "type": "commit"}, {"oid": "8bd1ea8973e1286ae7486fad1af5fdbb7f8ffc94", "url": "https://github.com/pravega/pravega/commit/8bd1ea8973e1286ae7486fad1af5fdbb7f8ffc94", "message": "Fix unit tests.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-26T06:52:31Z", "type": "commit"}, {"oid": "ff282e17153ace4a85e235e9780c1d220b24361e", "url": "https://github.com/pravega/pravega/commit/ff282e17153ace4a85e235e9780c1d220b24361e", "message": "Fix unit test\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T05:34:21Z", "type": "commit"}, {"oid": "3f3cf67b11cdc99d67bc947f639b245d740a8910", "url": "https://github.com/pravega/pravega/commit/3f3cf67b11cdc99d67bc947f639b245d740a8910", "message": "Add timeout to fetch updates to the reader group.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T05:40:54Z", "type": "commit"}, {"oid": "31b71c6cee5b9aabb828e41f1f8c92f2119a9c54", "url": "https://github.com/pravega/pravega/commit/31b71c6cee5b9aabb828e41f1f8c92f2119a9c54", "message": "Remove file meant for another branch.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T06:00:08Z", "type": "commit"}, {"oid": "973a7ed28e0cb6541b0176cffc7fc1a14ccc675e", "url": "https://github.com/pravega/pravega/commit/973a7ed28e0cb6541b0176cffc7fc1a14ccc675e", "message": "Merge branch 'master' into early-wake", "committedDate": "2020-02-27T06:01:14Z", "type": "commit"}, {"oid": "b11764f46b5865058e3e589ab840cfa5a0793ef4", "url": "https://github.com/pravega/pravega/commit/b11764f46b5865058e3e589ab840cfa5a0793ef4", "message": "Remove commented out timeouts.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T06:11:09Z", "type": "commit"}, {"oid": "b11764f46b5865058e3e589ab840cfa5a0793ef4", "url": "https://github.com/pravega/pravega/commit/b11764f46b5865058e3e589ab840cfa5a0793ef4", "message": "Remove commented out timeouts.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T06:11:09Z", "type": "forcePushed"}, {"oid": "797960bc23b99c1859a69751db6b37aefb3a7c33", "url": "https://github.com/pravega/pravega/commit/797960bc23b99c1859a69751db6b37aefb3a7c33", "message": "Suppress spotbugs error\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T06:22:33Z", "type": "commit"}, {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "url": "https://github.com/pravega/pravega/commit/7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "message": "naming\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T06:23:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxMjc5MQ==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385012791", "bodyText": "My understanding of this change is as follows.\n\" The segment Reader is null in case all the EventSegmentReaders for the streams are not ready. In such a scenario, EventStreamReader waits for 1000ms until any one of the EventSegmentReader receives data semaphore.release() on receiving data. \"", "author": "shrids", "createdAt": "2020-02-27T09:43:03Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -127,7 +131,8 @@\n             }\n             EventSegmentReader segmentReader = orderer.nextSegment(readers);\n             if (segmentReader == null) {\n-                Exceptions.handleInterrupted(() -> Thread.sleep(firstByteTimeoutMillis));\n+                blockFor(firstByteTimeoutMillis);", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNTQyMQ==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385305421", "bodyText": "yes", "author": "tkaitchuck", "createdAt": "2020-02-27T18:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxMjc5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxNTE5NA==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385015194", "bodyText": "It can so happen that segmentWithData.release() is invoked post invocation of segmentsWithData.drainPermits(). This would cause the permit counter to increment. Wouldn't this prevent the blocking next time around ?", "author": "shrids", "createdAt": "2020-02-27T09:47:09Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -127,7 +131,8 @@\n             }\n             EventSegmentReader segmentReader = orderer.nextSegment(readers);\n             if (segmentReader == null) {\n-                Exceptions.handleInterrupted(() -> Thread.sleep(firstByteTimeoutMillis));\n+                blockFor(firstByteTimeoutMillis);\n+                segmentsWithData.drainPermits();", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNTc4MA==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385305780", "bodyText": "yes (and that's a good thing)", "author": "tkaitchuck", "createdAt": "2020-02-27T18:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxNTE5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyNjk0NA==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385026944", "bodyText": "This change would cause to complete checkpointing of all the pending silent checkpoints for this reader. In the older code the application would have to invoke readNextEvent() again to clear this, right ?", "author": "shrids", "createdAt": "2020-02-27T10:06:54Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -201,20 +213,19 @@ private String updateGroupStateIfNeeded() throws ReaderNotInReaderGroupException\n                     releaseSegmentsIfNeeded(position);\n                     atCheckpoint = null;\n                 }\n-                return null;\n+                checkpoint = groupState.getCheckpoint();", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNjM2Mg==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385306362", "bodyText": "yes", "author": "tkaitchuck", "createdAt": "2020-02-27T18:55:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyNjk0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyODkyMQ==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385028921", "bodyText": "The waiting time is now increased from 10ms to 1000ms .Any specific reason for this ?", "author": "shrids", "createdAt": "2020-02-27T10:10:38Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -59,7 +61,7 @@\n public class EventStreamReaderImpl<Type> implements EventStreamReader<Type> {\n \n     // Base waiting time for a reader on an idle segment waiting for new data to be read.\n-    private static final long BASE_READER_WAITING_TIME_MS = 10;\n+    private static final long BASE_READER_WAITING_TIME_MS = ReaderGroupStateManager.TIME_UNIT.toMillis();", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwODE0OQ==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385308149", "bodyText": "Originally it was 1000ms and we used futures to wake up the blocked thread. However futures created the issue linked above, so we changed it to 10ms so that while it would not wakeup in response to data being available, it least it would check every 10ms. Now that we have a wakeup again I am restoring it to 1000ms. This is fine because it will awake in response to data. We still need to wake up eventually though, the source of the timeout shows why, even if there is no data, there might be an update to the group state, which we pull in updates for every 1000ms.", "author": "tkaitchuck", "createdAt": "2020-02-27T18:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyODkyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxNjk5NA==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385216994", "bodyText": "semaphore", "author": "andreipaduroiu", "createdAt": "2020-02-27T16:21:23Z", "path": "client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java", "diffHunk": "@@ -48,10 +49,11 @@\n      * does not exist.\n      *\n      * @param segment The segment to create an input for.\n+     * @param hasData A semephore that will have `release` called when data is available.", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9679414633d483b2ddf51249e1759fd9f0703560", "chunk": "diff --git a/client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java b/client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java\nindex ef1ea24a8c..d7cdaa5c04 100644\n--- a/client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java\n+++ b/client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java\n\n@@ -49,7 +49,7 @@ public interface SegmentInputStreamFactory {\n      * does not exist.\n      *\n      * @param segment The segment to create an input for.\n-     * @param hasData A semephore that will have `release` called when data is available.\n+     * @param hasData A Semaphore that will have `release` called when data is available.\n      * @param endOffset The offset up to which the segment can be read.\n      * @return New instance of the EventSegmentReader for reading.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMDg5MA==", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385230890", "bodyText": "Typo", "author": "shrids", "createdAt": "2020-02-27T16:42:12Z", "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -155,6 +160,13 @@\n                                    new EventPointerImpl(segment, offset, length), null);\n     }\n \n+    private void blockFor(long timeoutMs) {\n+        Exceptions.handleInterrupted(() -> {\n+            @SuppressWarnings(\"unused\")\n+            boolean aquired = segmentsWithData.tryAcquire(timeoutMs, TimeUnit.MILLISECONDS);", "originalCommit": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9679414633d483b2ddf51249e1759fd9f0703560", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\nindex 9ae4f2e186..80876defa9 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java\n\n@@ -163,7 +163,7 @@ public class EventStreamReaderImpl<Type> implements EventStreamReader<Type> {\n     private void blockFor(long timeoutMs) {\n         Exceptions.handleInterrupted(() -> {\n             @SuppressWarnings(\"unused\")\n-            boolean aquired = segmentsWithData.tryAcquire(timeoutMs, TimeUnit.MILLISECONDS);\n+            boolean acquired = segmentsWithData.tryAcquire(timeoutMs, TimeUnit.MILLISECONDS);\n         });\n     }\n     \n"}}, {"oid": "9679414633d483b2ddf51249e1759fd9f0703560", "url": "https://github.com/pravega/pravega/commit/9679414633d483b2ddf51249e1759fd9f0703560", "message": "Typos\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-02-27T19:00:24Z", "type": "commit"}, {"oid": "3b4e8c768dfb508741a6b24dee35b5351630819f", "url": "https://github.com/pravega/pravega/commit/3b4e8c768dfb508741a6b24dee35b5351630819f", "message": "Merge branch 'master' into early-wake", "committedDate": "2020-02-27T22:03:38Z", "type": "commit"}]}