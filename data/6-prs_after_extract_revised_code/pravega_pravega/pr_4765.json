{"pr_number": 4765, "pr_title": "Issue 4764: Optimized AppendDecoder to make fewer buffer copies", "pr_createdAt": "2020-05-01T18:17:02Z", "pr_url": "https://github.com/pravega/pravega/pull/4765", "timeline": [{"oid": "0eee1f3d82e93d70471d7dd31b688a98af353210", "url": "https://github.com/pravega/pravega/commit/0eee1f3d82e93d70471d7dd31b688a98af353210", "message": "Optimized AppendDecoder.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T18:14:06Z", "type": "commit"}, {"oid": "b2b2ce97b0a554724b655f01fd92e58c94f0295b", "url": "https://github.com/pravega/pravega/commit/b2b2ce97b0a554724b655f01fd92e58c94f0295b", "message": "Checkstyle\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T18:16:29Z", "type": "commit"}, {"oid": "7693e5c6d0a09da8f2cb3860b5f33eb5c9ffdda9", "url": "https://github.com/pravega/pravega/commit/7693e5c6d0a09da8f2cb3860b5f33eb5c9ffdda9", "message": "Unit tests.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T19:59:49Z", "type": "commit"}, {"oid": "4e5dc31dcf21d384d334bc26fc3d02ecc2809829", "url": "https://github.com/pravega/pravega/commit/4e5dc31dcf21d384d334bc26fc3d02ecc2809829", "message": "Javadoc.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T20:16:48Z", "type": "commit"}, {"oid": "6890bca2cab1806aae3e9e858d0eb02383bf4b3c", "url": "https://github.com/pravega/pravega/commit/6890bca2cab1806aae3e9e858d0eb02383bf4b3c", "message": "Code cov.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T20:58:32Z", "type": "commit"}, {"oid": "a767004d1b7be46cc0b9eea4e38b62a378a6717c", "url": "https://github.com/pravega/pravega/commit/a767004d1b7be46cc0b9eea4e38b62a378a6717c", "message": "Code cov.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-01T22:37:12Z", "type": "commit"}, {"oid": "d6adf3d8e2f163a7d25502725b66648d14b6fe90", "url": "https://github.com/pravega/pravega/commit/d6adf3d8e2f163a7d25502725b66648d14b6fe90", "message": "Merge branch 'master' into issue-4764-append-decoder", "committedDate": "2020-05-04T14:33:25Z", "type": "commit"}, {"oid": "081258e578be3b35eb64de775d4c780c4f0581db", "url": "https://github.com/pravega/pravega/commit/081258e578be3b35eb64de775d4c780c4f0581db", "message": "Refactored code.\nRemoved extra copy from ConditionalAppend.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-04T15:09:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNjM1Ng==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420416356", "bodyText": "See this comment for why this copy was added. We need to test to confirm this will not cause problemms.", "author": "tkaitchuck", "createdAt": "2020-05-05T21:26:22Z", "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/AppendDecoder.java", "diffHunk": "@@ -163,22 +205,15 @@ private ByteBuf getAppendDataBuf(WireCommands.AppendBlockEnd blockEnd, int sizeO\n                 // Work around a bug in netty:\n                 // See https://github.com/netty/netty/issues/5597\n                 if (appendDataBuf.readableBytes() == 0) {\n-                    appendDataBuf.release();\n+                    currentBlock.release();\n                     appendDataBuf = wrappedBuffer(((WireCommands.PartialEvent) cmd).getData(), blockEnd.getData());\n                 } else {\n                     appendDataBuf = wrappedBuffer(appendDataBuf, ((WireCommands.PartialEvent) cmd).getData(), blockEnd.getData());\n                 }\n             }\n         }\n \n-        // Make a copy of the ByteBuf as the readable bytes of the result may be significantly less than the total allocated", "originalCommit": "081258e578be3b35eb64de775d4c780c4f0581db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MzI5Ng==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420463296", "bodyText": "@RaulGracia is testing this with unthrottled loads. If we don't get any memory problems we should be OK.\nSince we've added that extra copy we have made numerous improvements in the Segment Stores' throttler and it is now a lot more aggressive in keeping incoming data flow under control. My expectation is that this should no longer be an issue and I want to see if it actually serves any purpose.\nIn addition, there is no longer a heap issue, as none of the source buffers are stored in the heap (the changes I made in WireCommands eliminated the heap buffer allocations). This will now point to sliced direct mem buffers from Netty.", "author": "andreipaduroiu", "createdAt": "2020-05-05T23:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNjM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MDgxNw==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r421560817", "bodyText": "We executed several perf tests and had no issues.", "author": "andreipaduroiu", "createdAt": "2020-05-07T14:43:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNjM1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNzI5Mw==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420417293", "bodyText": "I don't see a corresponding retain", "author": "tkaitchuck", "createdAt": "2020-05-05T21:28:17Z", "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -582,26 +591,32 @@ public void writeFields(DataOutput out) throws IOException {\n             out.writeLong(requestId);\n         }\n \n-        public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOException {\n+        public static WireCommand readFrom(EnhancedByteBufInputStream in, int length) throws IOException {\n             UUID writerId = new UUID(in.readLong(), in.readLong());\n             int sizeOfHeaderlessAppends = in.readInt();\n             int dataLength = in.readInt();\n-            byte[] data;\n+            ByteBuf data;\n             if (dataLength > 0) {\n-                data = new byte[dataLength];\n-                in.readFully(data);\n+                data = in.readFully(dataLength);\n             } else {\n-                data = new byte[0];\n+                data = EMPTY_BUFFER;\n             }\n             int numEvents = in.readInt();\n             long lastEventNumber = in.readLong();\n             long requestId = in.available() >= Long.BYTES ? in.readLong() : -1L;\n-            return new AppendBlockEnd(writerId, sizeOfHeaderlessAppends, wrappedBuffer(data), numEvents, lastEventNumber, requestId);\n+            return new AppendBlockEnd(writerId, sizeOfHeaderlessAppends, data.retain(), numEvents, lastEventNumber, requestId)\n+                    .requireRelease();\n+        }\n+\n+        @Override\n+        void releaseInternal() {\n+            this.data.release();", "originalCommit": "081258e578be3b35eb64de775d4c780c4f0581db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MjE3MQ==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420462171", "bodyText": "6 lines above.", "author": "andreipaduroiu", "createdAt": "2020-05-05T23:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxNzI5Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxODcwNg==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420418706", "bodyText": "Does this number have to be 1 for the test to pass? If so there should be a comment explaining it.", "author": "tkaitchuck", "createdAt": "2020-05-05T21:31:02Z", "path": "shared/protocol/src/test/java/io/pravega/shared/protocol/netty/AppendEncodeDecodeTest.java", "diffHunk": "@@ -219,23 +219,37 @@ public void execute(Runnable runnable) {\n \n         }\n     };\n-\n     @Mock\n     private ChannelHandlerContext ctx;\n     @Mock\n     private Channel ch;\n+    private ByteBuf fakeNetwork;\n+    private BufferReleaseVerifier releaseVerifier;\n+\n+    protected int getThreadPoolSize() {\n+        return 1;", "originalCommit": "081258e578be3b35eb64de775d4c780c4f0581db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2MTkzNg==", "url": "https://github.com/pravega/pravega/pull/4765#discussion_r420461936", "bodyText": "If it's 0, it uses the InlineExecutor. If it's 1, it uses an executor with 1 thread. This is exactly as it was before, if you look at the modifications in this class, except that now I am using the services from the inherited class as opposed from doing it again.", "author": "andreipaduroiu", "createdAt": "2020-05-05T23:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQxODcwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "db00a97dfae811d1e975cea0dcbbf2bd7bbf1d8d", "url": "https://github.com/pravega/pravega/commit/db00a97dfae811d1e975cea0dcbbf2bd7bbf1d8d", "message": "Merge branch 'master' into issue-4764-append-decoder", "committedDate": "2020-05-05T22:02:15Z", "type": "commit"}, {"oid": "4c79e7d6168d1156b4e5ae87f40ba222da6a9aa5", "url": "https://github.com/pravega/pravega/commit/4c79e7d6168d1156b4e5ae87f40ba222da6a9aa5", "message": "Optimized the ingestion path by using the most efficient method of copying data based on the source of data being ingested.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-06T23:45:03Z", "type": "commit"}, {"oid": "f73489476c92fa878ea6fac2bf537823eb668886", "url": "https://github.com/pravega/pravega/commit/f73489476c92fa878ea6fac2bf537823eb668886", "message": "Checkstyle\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>", "committedDate": "2020-05-07T14:42:41Z", "type": "commit"}]}