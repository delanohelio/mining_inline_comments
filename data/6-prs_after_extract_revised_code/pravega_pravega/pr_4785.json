{"pr_number": 4785, "pr_title": "Issue 4784: Release throttle in the event an unhandled exception comes from netty.", "pr_createdAt": "2020-05-12T18:46:49Z", "pr_url": "https://github.com/pravega/pravega/pull/4785", "timeline": [{"oid": "df3c8b1ef01597200b664ecaf9147a79cf3ea0c7", "url": "https://github.com/pravega/pravega/commit/df3c8b1ef01597200b664ecaf9147a79cf3ea0c7", "message": "Release throttle upon unhandled exception.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T18:08:37Z", "type": "commit"}, {"oid": "fb3b0e8ef8f9c648ed9ca80844133a7213a8bbda", "url": "https://github.com/pravega/pravega/commit/fb3b0e8ef8f9c648ed9ca80844133a7213a8bbda", "message": "Also release on close.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T18:11:46Z", "type": "commit"}, {"oid": "a9f3f8d8465beb1166614c384de71279a234f15d", "url": "https://github.com/pravega/pravega/commit/a9f3f8d8465beb1166614c384de71279a234f15d", "message": "Add coverage for the normal write as well.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T18:18:48Z", "type": "commit"}, {"oid": "d7f46faebb026d89b328fcca1ea9573d6ee59a79", "url": "https://github.com/pravega/pravega/commit/d7f46faebb026d89b328fcca1ea9573d6ee59a79", "message": "Add test\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T18:34:34Z", "type": "commit"}, {"oid": "b860482e6d0d19fae03053dff6acb6f8475bac14", "url": "https://github.com/pravega/pravega/commit/b860482e6d0d19fae03053dff6acb6f8475bac14", "message": "Use max int instead of max batch\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T18:46:06Z", "type": "commit"}, {"oid": "c4fddeec0f4601169118d721909a8ee5cb6c21a9", "url": "https://github.com/pravega/pravega/commit/c4fddeec0f4601169118d721909a8ee5cb6c21a9", "message": "Merge branch 'master' into OOM", "committedDate": "2020-05-12T18:46:58Z", "type": "commit"}, {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "url": "https://github.com/pravega/pravega/commit/5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "message": "Use local variable for data length.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-12T22:42:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM0MDExNQ==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424340115", "bodyText": "We can directly invoke io.pravega.client.netty.impl.ClientConnectionImpl#close here.", "author": "shrids", "createdAt": "2020-05-13T10:37:51Z", "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -89,9 +90,17 @@ public void operationComplete(ChannelFuture future) {\n         });\n         // Work around for https://github.com/netty/netty/issues/3246\n         eventLoop.execute(() -> {\n-            channel.write(cmd, promise);\n+            try {\n+                if (!closed.get()) {\n+                    channel.write(cmd, promise);\n+                }\n+            } catch (Exception e) {\n+                throttle.release(dataLength);\n+                channel.pipeline().fireExceptionCaught(e);\n+                channel.close();", "originalCommit": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e7ab01e8925820f7f6d5393156b78a2efcadefc", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\nindex 229f6072fc..5052c15cb9 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n\n@@ -97,10 +98,15 @@ public class ClientConnectionImpl implements ClientConnection {\n             } catch (Exception e) {\n                 throttle.release(dataLength);\n                 channel.pipeline().fireExceptionCaught(e);\n-                channel.close();\n+                close();\n+            }\n+        });\n+        Exceptions.handleInterrupted(() -> {\n+            if(!throttle.tryAcquire(dataLength, 30, TimeUnit.SECONDS)) {\n+                channel.pipeline().fireExceptionCaught(new ConnectionFailedException(\"Connection throttled for over 30 seconds\"));\n+                close();\n             }\n         });\n-        Exceptions.handleInterrupted(() -> throttle.acquire(dataLength));\n     }\n     \n     private void write(WireCommand cmd) throws ConnectionFailedException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM0MjgwMw==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424342803", "bodyText": "same as above.", "author": "shrids", "createdAt": "2020-05-13T10:43:13Z", "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -109,7 +118,14 @@ public void operationComplete(ChannelFuture future) {\n         });\n         // Work around for https://github.com/netty/netty/issues/3246\n         eventLoop.execute(() -> {\n-            channel.write(cmd, promise);\n+            try {\n+                if (!closed.get()) {\n+                    channel.write(cmd, promise);\n+                }\n+            } catch (Exception e) {\n+                channel.pipeline().fireExceptionCaught(e);\n+                channel.close();", "originalCommit": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e7ab01e8925820f7f6d5393156b78a2efcadefc", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\nindex 229f6072fc..5052c15cb9 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n\n@@ -124,7 +130,7 @@ public class ClientConnectionImpl implements ClientConnection {\n                 }\n             } catch (Exception e) {\n                 channel.pipeline().fireExceptionCaught(e);\n-                channel.close();\n+                close();\n             }\n         });\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwMTA4Mw==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424501083", "bodyText": "unblocked", "author": "andreipaduroiu", "createdAt": "2020-05-13T14:52:15Z", "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -167,6 +183,7 @@ public void sendAsync(List<Append> appends, CompletedCallback callback) {\n     public void close() {\n         if (!closed.getAndSet(true)) {\n             nettyHandler.closeFlow(this);\n+            throttle.release(Integer.MAX_VALUE >> 1); //Makes sure that any blocked threads are unbloced.", "originalCommit": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e7ab01e8925820f7f6d5393156b78a2efcadefc", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\nindex 229f6072fc..5052c15cb9 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n\n@@ -183,7 +189,7 @@ public class ClientConnectionImpl implements ClientConnection {\n     public void close() {\n         if (!closed.getAndSet(true)) {\n             nettyHandler.closeFlow(this);\n-            throttle.release(Integer.MAX_VALUE >> 1); //Makes sure that any blocked threads are unbloced.\n+            throttle.release(Integer.MAX_VALUE >> 1); //Makes sure that any blocked threads are unblocked.\n         }\n     }\n \n"}}, {"oid": "8e7ab01e8925820f7f6d5393156b78a2efcadefc", "url": "https://github.com/pravega/pravega/commit/8e7ab01e8925820f7f6d5393156b78a2efcadefc", "message": "PR comments\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-13T18:34:08Z", "type": "commit"}, {"oid": "edc44cf6a0f3316e7af88373b6d97aa05e3420de", "url": "https://github.com/pravega/pravega/commit/edc44cf6a0f3316e7af88373b6d97aa05e3420de", "message": "Call close directly\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-13T18:59:19Z", "type": "commit"}, {"oid": "9a84fc484e46bd43d8e38f344c9321da4e190fe2", "url": "https://github.com/pravega/pravega/commit/9a84fc484e46bd43d8e38f344c9321da4e190fe2", "message": "Remove call to close because exceptionCaught should handle it.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-13T19:38:24Z", "type": "commit"}, {"oid": "82b63db1ed491575e25af58f871e09a0a7420100", "url": "https://github.com/pravega/pravega/commit/82b63db1ed491575e25af58f871e09a0a7420100", "message": "Whitespace\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-13T23:31:07Z", "type": "commit"}, {"oid": "487a72237ce6c49ad1409c02bac00145782eb52f", "url": "https://github.com/pravega/pravega/commit/487a72237ce6c49ad1409c02bac00145782eb52f", "message": "Switch throttling to be done by FlowHandler once per connection rather than per flow.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-14T03:32:18Z", "type": "commit"}, {"oid": "adda753962087b2c2cac86748df6d8e94ff25ba7", "url": "https://github.com/pravega/pravega/commit/adda753962087b2c2cac86748df6d8e94ff25ba7", "message": "Checkstyle\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-14T03:42:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2NzIyNA==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r425267224", "bodyText": "If an Append/event is greater than MAX_BATCH_SIZE then the CommandEncoder is the one which will split it. But since the number of permits in the throttle is bounded by MAX_BATCH_SIZE the thread would indefinitely wait when the append size > MAX_BATCH_SIZE, causing the CommandEncoder in the subsequent pipeline stage to be never invoked.\nThis caused an issue with io.pravega.test.integration.ByteStreamTest#readLargeWrite", "author": "shrids", "createdAt": "2020-05-14T16:23:38Z", "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -57,6 +59,8 @@\n     private final ConcurrentHashMap<Integer, AppendBatchSizeTracker> flowIDBatchSizeTrackerMap = new ConcurrentHashMap<>();\n \n     private final AtomicBoolean disableFlow = new AtomicBoolean(false);\n+    \n+    private final Semaphore throttle = new Semaphore(AppendBatchSizeTracker.MAX_BATCH_SIZE);", "originalCommit": "adda753962087b2c2cac86748df6d8e94ff25ba7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0d3c61874f86f20931731b256957fff13e3a5b2d", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\nindex 7d762cb1d4..82f8b5c1d3 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n\n@@ -59,8 +57,6 @@ public class FlowHandler extends ChannelInboundHandlerAdapter implements Flushin\n     private final ConcurrentHashMap<Integer, AppendBatchSizeTracker> flowIDBatchSizeTrackerMap = new ConcurrentHashMap<>();\n \n     private final AtomicBoolean disableFlow = new AtomicBoolean(false);\n-    \n-    private final Semaphore throttle = new Semaphore(AppendBatchSizeTracker.MAX_BATCH_SIZE);\n \n     public FlowHandler(String connectionName) {\n         this(connectionName, MetricNotifier.NO_OP_METRIC_NOTIFIER);\n"}}, {"oid": "0d3c61874f86f20931731b256957fff13e3a5b2d", "url": "https://github.com/pravega/pravega/commit/0d3c61874f86f20931731b256957fff13e3a5b2d", "message": "Switch to having a fixed capacity outstanding against the broker.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-14T18:50:59Z", "type": "commit"}, {"oid": "7a615844ed5752a90f01a1617af11977b858f20c", "url": "https://github.com/pravega/pravega/commit/7a615844ed5752a90f01a1617af11977b858f20c", "message": "Checkstyle\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-14T18:53:11Z", "type": "commit"}, {"oid": "1574a577b9677173d71a728c2760281330030f80", "url": "https://github.com/pravega/pravega/commit/1574a577b9677173d71a728c2760281330030f80", "message": "Added some logging\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-14T23:04:00Z", "type": "commit"}, {"oid": "b539d3753c10ebc9264d88a92d9a8b78da5f9b13", "url": "https://github.com/pravega/pravega/commit/b539d3753c10ebc9264d88a92d9a8b78da5f9b13", "message": "Move update of append size throttle engagment to the writing thread.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-15T00:06:14Z", "type": "commit"}, {"oid": "6805fe9c1a695caa582cff34295c8459632885e0", "url": "https://github.com/pravega/pravega/commit/6805fe9c1a695caa582cff34295c8459632885e0", "message": "Revert to earlier logic.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-15T18:43:22Z", "type": "commit"}, {"oid": "ccfbd559428f32eac4b84d25ef3917f4a6680bfc", "url": "https://github.com/pravega/pravega/commit/ccfbd559428f32eac4b84d25ef3917f4a6680bfc", "message": "Close connection if keepalive does not go through before next keepalive call.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-15T19:03:31Z", "type": "commit"}, {"oid": "d90c83d47868f6ff95d0805e6eb317a85d848c9d", "url": "https://github.com/pravega/pravega/commit/d90c83d47868f6ff95d0805e6eb317a85d848c9d", "message": "Merge branch 'master' into OOM", "committedDate": "2020-05-18T21:51:27Z", "type": "commit"}, {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "url": "https://github.com/pravega/pravega/commit/d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "message": "Checkstyle fixes\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-18T21:57:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMzE4Mg==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427023182", "bodyText": "nettyHandler.setRecentMessage(); should be set here.", "author": "shrids", "createdAt": "2020-05-19T04:28:57Z", "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -103,13 +107,18 @@ private void write(WireCommand cmd) throws ConnectionFailedException {\n             public void operationComplete(ChannelFuture future) {\n                 if (!future.isSuccess()) {", "originalCommit": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3ODE1OQ==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427578159", "bodyText": "Done", "author": "tkaitchuck", "createdAt": "2020-05-19T20:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMzE4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\nindex e48f8dedc9..873045444a 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java\n\n@@ -105,6 +105,7 @@ public class ClientConnectionImpl implements ClientConnection {\n         promise.addListener(new ChannelFutureListener() {\n             @Override\n             public void operationComplete(ChannelFuture future) {\n+                nettyHandler.setRecentMessage();\n                 if (!future.isSuccess()) {\n                     future.channel().pipeline().fireExceptionCaught(future.cause());\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyNDM1Mg==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427024352", "bodyText": "callback.complete() below should invoke nettyHandler.setRecentMessage() right ?", "author": "shrids", "createdAt": "2020-05-19T04:34:05Z", "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -144,7 +152,6 @@ public void sendAsync(List<Append> appends, CompletedCallback callback) {\n         Channel ch;\n         try {\n             checkClientConnectionClosed();\n-            nettyHandler.setRecentMessage();", "originalCommit": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3ODAzNw==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427578037", "bodyText": "Done", "author": "tkaitchuck", "createdAt": "2020-05-19T20:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyNDM1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTI5Nw==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427031297", "bodyText": "These are the two changes in client behavior, right?\n\nThis change implies keep-alive is sent every 20 seconds even if the connection is healthy.\nIf there is a connection stall for more than 20 seconds then the connection is closed.", "author": "shrids", "createdAt": "2020-05-19T05:01:37Z", "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -313,14 +318,28 @@ public void close() {\n     }\n \n     private final class KeepAliveTask implements Runnable {\n+        \n+        private final ChannelFutureListener listener = new ChannelFutureListener() {\n+            @Override\n+            public void operationComplete(ChannelFuture future) throws Exception {\n+                recentMessage.set(true);\n+                if (!future.isSuccess()) {\n+                    future.channel().pipeline().fireExceptionCaught(future.cause());\n+                }\n+            }\n+        };\n+        \n         @Override\n         public void run() {\n-            try {\n-                if (!recentMessage.getAndSet(false)) {\n-                    getChannel().writeAndFlush(new WireCommands.KeepAlive()).addListener(ChannelFutureListener.FIRE_EXCEPTION_ON_FAILURE);\n+            if (recentMessage.getAndSet(false)) {", "originalCommit": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU2ODEzMA==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427568130", "bodyText": "Yes", "author": "tkaitchuck", "createdAt": "2020-05-19T20:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTI5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\nindex ed2bd519c3..2734037781 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n\n@@ -324,6 +324,7 @@ public class FlowHandler extends ChannelInboundHandlerAdapter implements AutoClo\n             public void operationComplete(ChannelFuture future) throws Exception {\n                 recentMessage.set(true);\n                 if (!future.isSuccess()) {\n+                    log.warn(\"Keepalive failed for connection {}\", connectionName);\n                     future.channel().pipeline().fireExceptionCaught(future.cause());\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTY0MA==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427031640", "bodyText": "Can we log indicating that sending a keep-alive failed here?", "author": "shrids", "createdAt": "2020-05-19T05:02:52Z", "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -313,14 +318,28 @@ public void close() {\n     }\n \n     private final class KeepAliveTask implements Runnable {\n+        \n+        private final ChannelFutureListener listener = new ChannelFutureListener() {\n+            @Override\n+            public void operationComplete(ChannelFuture future) throws Exception {\n+                recentMessage.set(true);\n+                if (!future.isSuccess()) {\n+                    future.channel().pipeline().fireExceptionCaught(future.cause());", "originalCommit": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzkxMA==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427577910", "bodyText": "Done", "author": "tkaitchuck", "createdAt": "2020-05-19T20:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTY0MA=="}], "type": "inlineReview", "revised_code": {"commit": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "chunk": "diff --git a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\nindex ed2bd519c3..2734037781 100644\n--- a/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n+++ b/client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java\n\n@@ -324,6 +324,7 @@ public class FlowHandler extends ChannelInboundHandlerAdapter implements AutoClo\n             public void operationComplete(ChannelFuture future) throws Exception {\n                 recentMessage.set(true);\n                 if (!future.isSuccess()) {\n+                    log.warn(\"Keepalive failed for connection {}\", connectionName);\n                     future.channel().pipeline().fireExceptionCaught(future.cause());\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4OTc5Nw==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427089797", "bodyText": "this test causes the InMemoryDurableDataLog to go OOM on my dev box...", "author": "shrids", "createdAt": "2020-05-19T07:35:14Z", "path": "test/integration/src/test/java/io/pravega/test/integration/AppendTest.java", "diffHunk": "@@ -303,6 +308,35 @@ public void appendThroughStreamingClient() throws InterruptedException, Executio\n         ack.get(5, TimeUnit.SECONDS);\n     }\n     \n+    \n+    @Test(timeout = 100000)\n+    public void appendALotOfData() {", "originalCommit": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxOTIwMg==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427419202", "bodyText": "Looks like you're sending in 1000 x 1MB buffers for a total of 1GB. That is a bit too extreme.\nIf you do want to keep this test as it is, may I recommend truncating the segment after every few writes you're sending? That should help clear memory pressure.", "author": "andreipaduroiu", "createdAt": "2020-05-19T16:03:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4OTc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NzgzOA==", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427577838", "bodyText": "Done", "author": "tkaitchuck", "createdAt": "2020-05-19T20:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4OTc5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "chunk": "diff --git a/test/integration/src/test/java/io/pravega/test/integration/AppendTest.java b/test/integration/src/test/java/io/pravega/test/integration/AppendTest.java\nindex 737a888f19..7c99391966 100644\n--- a/test/integration/src/test/java/io/pravega/test/integration/AppendTest.java\n+++ b/test/integration/src/test/java/io/pravega/test/integration/AppendTest.java\n\n@@ -312,6 +316,7 @@ public class AppendTest extends LeakDetectorTestSuite {\n     @Test(timeout = 100000)\n     public void appendALotOfData() {\n         String endpoint = \"localhost\";\n+        String scope = \"Scope\";\n         String streamName = \"abc\";\n         int port = TestUtils.getAvailableListenPort();\n         ByteBuffer payload = ByteBuffer.allocate(1024 * 1024);\n"}}, {"oid": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "url": "https://github.com/pravega/pravega/commit/7b2f20adb572f4dcf418ac82d65e089c7241be7b", "message": "PR feedback\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-19T20:24:07Z", "type": "commit"}, {"oid": "218634f465b425bfee8df78e1097e3fb89fe4e52", "url": "https://github.com/pravega/pravega/commit/218634f465b425bfee8df78e1097e3fb89fe4e52", "message": "Truncate data more frequently to avoid memory preasure.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-19T23:38:54Z", "type": "commit"}, {"oid": "801142b8d545446e2ec644e1d33d94454cc36989", "url": "https://github.com/pravega/pravega/commit/801142b8d545446e2ec644e1d33d94454cc36989", "message": "Merge branch 'master' into OOM", "committedDate": "2020-05-19T23:40:22Z", "type": "commit"}, {"oid": "d5c03c69023b32bbd2bdd2688de4cedf3ab5cdba", "url": "https://github.com/pravega/pravega/commit/d5c03c69023b32bbd2bdd2688de4cedf3ab5cdba", "message": "Fix compile issue caused my master merge.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-20T15:13:12Z", "type": "commit"}, {"oid": "4a5c788f1449f719555904b3b021fa5320f96076", "url": "https://github.com/pravega/pravega/commit/4a5c788f1449f719555904b3b021fa5320f96076", "message": "Merge branch 'master' into OOM", "committedDate": "2020-05-21T16:26:01Z", "type": "commit"}, {"oid": "289169c410a67e0b409df19283809af046440361", "url": "https://github.com/pravega/pravega/commit/289169c410a67e0b409df19283809af046440361", "message": "Limit message size based on heap size.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-21T18:07:17Z", "type": "commit"}, {"oid": "6aa87c7deb913122d3dfb4af0c9cb152f981dc4a", "url": "https://github.com/pravega/pravega/commit/6aa87c7deb913122d3dfb4af0c9cb152f981dc4a", "message": "Merge branch 'OOM' of git@github.com:tkaitchuck/pravega-1.git into OOM", "committedDate": "2020-05-21T18:08:20Z", "type": "commit"}, {"oid": "22abe1fe80e9cf6afa808e1008e0158c51414bf5", "url": "https://github.com/pravega/pravega/commit/22abe1fe80e9cf6afa808e1008e0158c51414bf5", "message": "Reduce size of data\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-22T01:07:06Z", "type": "commit"}, {"oid": "7bdfdf9f6b6aeb7335d8012186994994caf7c8b9", "url": "https://github.com/pravega/pravega/commit/7bdfdf9f6b6aeb7335d8012186994994caf7c8b9", "message": "Ensure keepAlive tests covers failed listener.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-22T20:20:42Z", "type": "commit"}, {"oid": "28dc51214b70d19f4b86b01b1d18755d53fb9d1c", "url": "https://github.com/pravega/pravega/commit/28dc51214b70d19f4b86b01b1d18755d53fb9d1c", "message": "Add test for failed write.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-22T21:17:14Z", "type": "commit"}, {"oid": "70515a36d71cc848617c732abb1b32f24c7f3f7b", "url": "https://github.com/pravega/pravega/commit/70515a36d71cc848617c732abb1b32f24c7f3f7b", "message": "Add keep alive timeout test.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>", "committedDate": "2020-05-22T21:28:33Z", "type": "commit"}]}