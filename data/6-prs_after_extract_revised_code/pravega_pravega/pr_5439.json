{"pr_number": 5439, "pr_title": "Issue 5112: Client API to Create Subscriber reader groups", "pr_createdAt": "2020-12-17T13:30:14Z", "pr_url": "https://github.com/pravega/pravega/pull/5439", "timeline": [{"oid": "3b3c1e213406ae62f8b57795dc73b91e04dfe5da", "url": "https://github.com/pravega/pravega/commit/3b3c1e213406ae62f8b57795dc73b91e04dfe5da", "message": "Added client changes for subscriber RG crud\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-17T13:13:52Z", "type": "commit"}, {"oid": "3497a1129e78ecbea223ed579f631d116036eabd", "url": "https://github.com/pravega/pravega/commit/3497a1129e78ecbea223ed579f631d116036eabd", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2020-12-17T13:17:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMTkyMg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545411922", "bodyText": "This is a public interface. If possible either add these to the impl and omit them here, or find an alternative way to obtain the information.\nIf they must be added here and made public:\n\nMake sure the names match our other public analogous apis. (IE I'm fairly sure the word \"synchronizer\" shouldn't be in there)\nThey will also need javadocs and tests.\nAdd fpj and sandeep as reviewers on the PR and tag it as an API change.", "author": "tkaitchuck", "createdAt": "2020-12-17T21:22:34Z", "path": "client/src/main/java/io/pravega/client/state/StateSynchronizer.java", "diffHunk": "@@ -45,6 +45,10 @@\n      */\n     StateT getState();\n \n+    String getSynchronizerScopeName();\n+\n+    String getSynchronizerStreamName();", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYwNjQ0NQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545606445", "bodyText": "These API's have been removed. They are not needed anymore.", "author": "anirudhkovuru", "createdAt": "2020-12-18T06:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQxMTkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/state/StateSynchronizer.java b/client/src/main/java/io/pravega/client/state/StateSynchronizer.java\nindex 042b86d485..cf39ce6280 100644\n--- a/client/src/main/java/io/pravega/client/state/StateSynchronizer.java\n+++ b/client/src/main/java/io/pravega/client/state/StateSynchronizer.java\n\n@@ -45,10 +45,6 @@ public interface StateSynchronizer<StateT extends Revisioned> extends AutoClosea\n      */\n     StateT getState();\n \n-    String getSynchronizerScopeName();\n-\n-    String getSynchronizerStreamName();\n-\n     /**\n      * Fetch and apply all updates needed to the state object held locally up to date.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0NzY5OA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545447698", "bodyText": "This needs to be conditional.\nWe don't want to perform this update if:\na) It's already been completed.\nb) Another even newer config update has been completed.", "author": "tkaitchuck", "createdAt": "2020-12-17T22:34:34Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +201,12 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {\n+            updates.add(new UpdatingConfig(true));\n+        });\n+        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc4MDE1NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545780154", "bodyText": "Its been made conditional.", "author": "anirudhkovuru", "createdAt": "2020-12-18T11:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0NzY5OA=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 77720e870e..a458d8152f 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -206,7 +206,9 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n         });\n         getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+        synchronizer.updateState((state, updates) -> {\n+            new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+        });\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545447751", "bodyText": "What if updatingConfig is already set to true?\nWhat happens in the following race:\nresetReadeGroup(a) - start\nresetReadeGroup(b) - start\nresetReadeGroup(b) - complete\nresetReadeGroup(a) - ???\nThere is no lock between here and the controller. So an order needs to be defined.", "author": "tkaitchuck", "createdAt": "2020-12-17T22:34:40Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +201,12 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDA3Nw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545610077", "bodyText": "that should not be a problem because the call to controller should include the generation and hence idempotent. So if RG(b) has already completed the call, RG(a) will simply repeat it with the generation that has already been included in controller.", "author": "shiveshr", "createdAt": "2020-12-18T07:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExNTI2MQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546115261", "bodyText": "Initial config is version 0\nresetReadeGroup(a) - Sets flag to 'true'\na is assigned version 1 by the controller.\nresetReadeGroup(b)\nb is assigned version 2 by the controller.\na unsets the flag and updates the readergroupstate.\nb crashes.\nNow the controller thinks the version is 2 and the config is b. But the group says A and nobody considers the update ongoing.", "author": "tkaitchuck", "createdAt": "2020-12-18T22:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIyNjkwNQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546226905", "bodyText": "pravega/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n    \n    \n         Line 207\n      in\n      3497a11\n    \n    \n    \n    \n\n        \n          \n           getThrowingException(controller.updateReaderGroup(scope, groupName, config)); \n        \n    \n  \n\n\ncontroller.updateReadergroup is conditional. it will reject the request from (b) if (a) has already incremented the generation to 1.\nand if rg finds the generation on controller ahead of generation in its local state, it should first complete the previously attempted reset and only then should it even attempt the new reset which is to call the controller again to increment the generation.", "author": "shiveshr", "createdAt": "2020-12-19T11:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzMTQ5OQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546231499", "bodyText": "Here is how resetReaderGroup() API on Client would look:\n\t1. ss.fetchUpdates();\n\t2. if (ss.updatingConfig==false) {\n\t  // this is a conditional update and so for 2 processes trying to do this update in parallel, only 1 will succeed.\n\t   2.1 val updateFlagResult = ss.updateState(ss.updatingConfig = true)\n\t   2.2 if (updateFlagResult == SUCCESS) {\n\t\t    set config.generation = ss.getConfig().generation;\n\t\t    set config.readerGroupId = ss.getConfig().readerGroupId;\n\t\t    val controllerUpdateResult = controller.updateRG(scope, rgName, config)\n\t\t    if (controllerUpdateResult == SUCCESS) {\n\t\t\t   ss.updateUnconditionally(config)\n\t\t    } \n\t\t    // we set ss.updatingConfig = false in the following cases:\n\t\t    // (i) If both update to controller and SS have succeeded\n\t\t    // (ii) update to Controller has failed, & we never tried updating SS and directly landed here\n\t\t    // (iii) in the catch block for `controller.updateRg()` call, so if it throws an exception, we again set back \"ss.updatingConfig = false\"\n\t\t    ss.updateState(ss.updatingConfig = false)\n\t     } \n\t     else {\n\t\t      // we're here because updateFlagResult==FAILED\n\t\t      // goto 1 \n\t         }\n\t} \n\telse {\n\t   // here updatingConfig==true \n\t  // goto 1 and keep retrying this reset in a while loop waiting for (updatingConfig == false) or bail out\n\t}\n}", "author": "pbelgundi", "createdAt": "2020-12-19T12:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIzMzEyOA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546233128", "bodyText": "Additionally, there would be a separate timer thread that would periodically check if config in SS matches with config on Controller and if it does not update SS with config copy from Controller.", "author": "pbelgundi", "createdAt": "2020-12-19T12:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1NDU5OQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554454599", "bodyText": "Implementing the pseudocode as described above.", "author": "anirudhkovuru", "createdAt": "2021-01-09T18:00:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ0Nzc1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 77720e870e..a458d8152f 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -206,7 +206,9 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n         });\n         getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+        synchronizer.updateState((state, updates) -> {\n+            new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+        });\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MDMwNw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545450307", "bodyText": "Shouldn't this be fetchUpdatesIfNeeded()?", "author": "tkaitchuck", "createdAt": "2020-12-17T22:40:16Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +337,21 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        sync.fetchUpdates();", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NjM1Nw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545946357", "bodyText": "Changed to use fetchUpdatesIfNeeded().", "author": "anirudhkovuru", "createdAt": "2020-12-18T16:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MDMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 3d52bbc9c6..8078eaec3c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -339,15 +344,16 @@ public class ReaderGroupStateManager {\n     }\n \n     void updateConfigIfNeeded() {\n-        sync.fetchUpdates();\n+        fetchUpdatesIfNeeded();\n         ReaderGroupState state = sync.getState();\n-        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n-            log.debug(\"Update the group config\");\n-            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n-                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n-                sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+        if (!updateConfigTimer.hasRemaining()) {\n+            if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n+                    sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+                }\n             }\n             updateConfigTimer.reset(UPDATE_CONFIG_WINDOW);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MTcwMw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545451703", "bodyText": "Be more specific this won't actually help anyone debug a problem if there is one.\nWhich reader group? What config? Is an update actually being performed?", "author": "tkaitchuck", "createdAt": "2020-12-17T22:43:13Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +337,21 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        sync.fetchUpdates();\n+        ReaderGroupState state = sync.getState();\n+        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n+            log.debug(\"Update the group config\");", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYwMjg0NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545602844", "bodyText": "Made the debug statement more informative.", "author": "anirudhkovuru", "createdAt": "2020-12-18T06:41:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MTcwMw=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 3d52bbc9c6..8078eaec3c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -339,15 +344,16 @@ public class ReaderGroupStateManager {\n     }\n \n     void updateConfigIfNeeded() {\n-        sync.fetchUpdates();\n+        fetchUpdatesIfNeeded();\n         ReaderGroupState state = sync.getState();\n-        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n-            log.debug(\"Update the group config\");\n-            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n-                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n-                sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+        if (!updateConfigTimer.hasRemaining()) {\n+            if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n+                    sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+                }\n             }\n             updateConfigTimer.reset(UPDATE_CONFIG_WINDOW);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MjU3Ng==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545452576", "bodyText": "This precludes cross scope reading, which is an important feature.\nDon't make assumptions about the scope and stream name here. Explicitly obtain them from the state. (Or add them as member variables to this class)", "author": "tkaitchuck", "createdAt": "2020-12-17T22:45:03Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +337,21 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        sync.fetchUpdates();\n+        ReaderGroupState state = sync.getState();\n+        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n+            log.debug(\"Update the group config\");\n+            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n+                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYwMjQ4NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545602484", "bodyText": "The scope name and readergroup name are required to make the controller call. Instead of obtaining it from the sync these are now part of the ReaderGroupStateManager. This means we wouldn't need those StateSynchronizer API's too.", "author": "anirudhkovuru", "createdAt": "2020-12-18T06:40:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1MjU3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 3d52bbc9c6..8078eaec3c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -339,15 +344,16 @@ public class ReaderGroupStateManager {\n     }\n \n     void updateConfigIfNeeded() {\n-        sync.fetchUpdates();\n+        fetchUpdatesIfNeeded();\n         ReaderGroupState state = sync.getState();\n-        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n-            log.debug(\"Update the group config\");\n-            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n-                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n-                sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+        if (!updateConfigTimer.hasRemaining()) {\n+            if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n+                    sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+                }\n             }\n             updateConfigTimer.reset(UPDATE_CONFIG_WINDOW);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1Mzk3NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545453974", "bodyText": "This only resets the timer if a config update was actually performed. However the goal of the timer was to minimise work on a per-event bais. This prevents that because the timer will almost never be not expired if the config updates rarely.", "author": "tkaitchuck", "createdAt": "2020-12-17T22:48:17Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +337,21 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        sync.fetchUpdates();\n+        ReaderGroupState state = sync.getState();\n+        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n+            log.debug(\"Update the group config\");\n+            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n+                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));\n+            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n+                sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+            }\n+            updateConfigTimer.reset(UPDATE_CONFIG_WINDOW);", "originalCommit": "3497a1129e78ecbea223ed579f631d116036eabd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYwMDYxNA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545600614", "bodyText": "As you mentioned it would only reset if an update was done. I've separated the timer check and the updatingConfig check. So irrespective of whether the update happens or not the timer will reset itself when there is no time remaining.", "author": "anirudhkovuru", "createdAt": "2020-12-18T06:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTQ1Mzk3NA=="}], "type": "inlineReview", "revised_code": {"commit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 3d52bbc9c6..8078eaec3c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -339,15 +344,16 @@ public class ReaderGroupStateManager {\n     }\n \n     void updateConfigIfNeeded() {\n-        sync.fetchUpdates();\n+        fetchUpdatesIfNeeded();\n         ReaderGroupState state = sync.getState();\n-        if (!updateConfigTimer.hasRemaining() && state.isUpdatingConfig()) {\n-            log.debug(\"Update the group config\");\n-            ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(sync.getSynchronizerScopeName(),\n-                    sync.getSynchronizerStreamName().replace(READER_GROUP_STREAM_PREFIX, \"\")));\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n-                sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+        if (!updateConfigTimer.hasRemaining()) {\n+            if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n+                    sync.updateStateUnconditionally(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n+                }\n             }\n             updateConfigTimer.reset(UPDATE_CONFIG_WINDOW);\n         }\n"}}, {"oid": "c8898826ccf48f61eaa560c266e262d0a659f233", "url": "https://github.com/pravega/pravega/commit/c8898826ccf48f61eaa560c266e262d0a659f233", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2020-12-18T06:26:31Z", "type": "commit"}, {"oid": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "url": "https://github.com/pravega/pravega/commit/0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "message": "Addressing review comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-18T06:28:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDcyOQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545610729", "bodyText": "the problem really is \"after\" the call to controller when this code is calling synchronizer.updateState(RGStateInit).\nif RG(b) has already successfully reset, then (a) should not be repeating it, rather exit.\nso instead of blindly resetting here, we should actually check if a reset with our desired generation has already completed or not.. and if not, then we should reset, else exit.", "author": "shiveshr", "createdAt": "2020-12-18T07:04:51Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +201,14 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {\n+            updates.add(new UpdatingConfig(true));\n+        });\n+        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        synchronizer.updateState((state, updates) -> {", "originalCommit": "0b6fb5ec8d2550e19b451f920f48116eea80a1a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc0NjU2MQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r545746561", "bodyText": "Implementing the logic as described here.", "author": "anirudhkovuru", "createdAt": "2020-12-18T10:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTYxMDcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "22a0e9f2f4938f303bcdb3e5fb1d922b72689ce8", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex a458d8152f..c7ec216c8d 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -205,9 +212,12 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n             updates.add(new UpdatingConfig(true));\n         });\n         getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n         synchronizer.updateState((state, updates) -> {\n-            new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+            }\n         });\n     }\n \n"}}, {"oid": "ffc367c371844236fd7758f1a017180c57c8d4e9", "url": "https://github.com/pravega/pravega/commit/ffc367c371844236fd7758f1a017180c57c8d4e9", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2020-12-18T10:36:03Z", "type": "commit"}, {"oid": "22a0e9f2f4938f303bcdb3e5fb1d922b72689ce8", "url": "https://github.com/pravega/pravega/commit/22a0e9f2f4938f303bcdb3e5fb1d922b72689ce8", "message": "Changes to ReaderGroupImpl\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-18T10:37:39Z", "type": "commit"}, {"oid": "dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "url": "https://github.com/pravega/pravega/commit/dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "message": "Changed tests according to new deleteRG api\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-18T13:19:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwOTk5Mw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546109993", "bodyText": "This is a new public facing API and more importantly a whole new concept. How is this different from the group name? Why would a user need to call this method?\nIf it only exists because we need it, it shouldn't go here, but instead on the impl or an internal interface.", "author": "tkaitchuck", "createdAt": "2020-12-18T21:57:35Z", "path": "client/src/main/java/io/pravega/client/stream/ReaderGroup.java", "diffHunk": "@@ -47,7 +48,14 @@\n      * @return Reader group name\n      */\n     String getGroupName();\n-    \n+\n+    /**\n+     * Returns the UUID of the group.\n+     *\n+     * @return Reader group UUID.\n+     */\n+    UUID getGroupId();", "originalCommit": "dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIxMzE5Mg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546213192", "bodyText": "There is no reason for us to expose this on the interface. also why should we use a UUID for differentiating between different iterations of RGs with the same name.\nSecondly, i am wondering if we should even have a UUID. couldnt we just use the StartingSegmentNumber on the RG stream which effectively uniquely identifies the iteration of the group.", "author": "shiveshr", "createdAt": "2020-12-19T08:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwOTk5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1NTYwMw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546655603", "bodyText": "This method has been moved to the impl instead. It wouldn't make sense to a user so removed it from the API.", "author": "anirudhkovuru", "createdAt": "2020-12-21T11:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwOTk5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/ReaderGroup.java b/client/src/main/java/io/pravega/client/stream/ReaderGroup.java\nindex c38e5074a8..00516437a9 100644\n--- a/client/src/main/java/io/pravega/client/stream/ReaderGroup.java\n+++ b/client/src/main/java/io/pravega/client/stream/ReaderGroup.java\n\n@@ -49,13 +48,6 @@ public interface ReaderGroup extends ReaderGroupNotificationListener, AutoClosea\n      */\n     String getGroupName();\n \n-    /**\n-     * Returns the UUID of the group.\n-     *\n-     * @return Reader group UUID.\n-     */\n-    UUID getGroupId();\n-\n     /**\n      * Initiate a checkpoint. This causes all readers in the group to receive a special\n      * {@link EventRead} that contains the provided checkpoint name. This can be used to provide an\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMTE5Nw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546111197", "bodyText": "Why is this call needed? Can it be combined with the previous one? (IE have it return this value)", "author": "tkaitchuck", "createdAt": "2020-12-18T22:01:02Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +208,17 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {\n+            updates.add(new UpdatingConfig(true));\n+        });\n+        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));", "originalCommit": "dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIxNjUxNg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546216516", "bodyText": "yes, i think there is a github issue to address this.\nideally updateRG should return the generation number itself but it presently returns a boolean.", "author": "shiveshr", "createdAt": "2020-12-19T09:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMTE5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1NDA5Ng==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554454096", "bodyText": "The updateRG now returns the generation number which is used to update the state too.", "author": "anirudhkovuru", "createdAt": "2021-01-09T17:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMTE5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex c7ec216c8d..3d3f5b0fc3 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -208,17 +212,40 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        synchronizer.updateState((state, updates) -> {\n-            updates.add(new UpdatingConfig(true));\n-        });\n-        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n-        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateState((state, updates) -> {\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                config.setGeneration(state.getConfig().getGeneration());\n+                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    @VisibleForTesting\n+    protected boolean stateTransition(ReaderGroupState state, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(false);\n+        synchronizer.updateState((s, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            successfullyUpdated.set(s.getConfig().equals(state.getConfig()));\n+            if (successfullyUpdated.get()) {\n+                updates.add(update);\n             }\n         });\n+        return successfullyUpdated.get();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMzQzNQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546113435", "bodyText": "shouldn't it be using controllerConfig here?\nAlso, if so, then a unit test is missing.", "author": "tkaitchuck", "createdAt": "2020-12-18T22:06:45Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +208,17 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {\n+            updates.add(new UpdatingConfig(true));\n+        });\n+        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        synchronizer.updateState((state, updates) -> {\n+            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);", "originalCommit": "dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTExNTY4MA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551115680", "bodyText": "This logic has been changed to make sure to account for the case you mentioned below", "author": "anirudhkovuru", "createdAt": "2021-01-04T04:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExMzQzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex c7ec216c8d..3d3f5b0fc3 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -208,17 +212,40 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        synchronizer.updateState((state, updates) -> {\n-            updates.add(new UpdatingConfig(true));\n-        });\n-        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n-        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateState((state, updates) -> {\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                config.setGeneration(state.getConfig().getGeneration());\n+                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    @VisibleForTesting\n+    protected boolean stateTransition(ReaderGroupState state, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(false);\n+        synchronizer.updateState((s, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            successfullyUpdated.set(s.getConfig().equals(state.getConfig()));\n+            if (successfullyUpdated.get()) {\n+                updates.add(update);\n             }\n         });\n+        return successfullyUpdated.get();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExNTQ2NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r546115464", "bodyText": "If the config generation is older it should still disable the flag.", "author": "tkaitchuck", "createdAt": "2020-12-18T22:13:05Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -200,8 +208,17 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.updateState((state, updates) -> {\n+            updates.add(new UpdatingConfig(true));\n+        });\n+        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n         Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        synchronizer.updateState((state, updates) -> {\n+            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {", "originalCommit": "dfd9c48a16fead4eb76daa1f402908fc8e13e5bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex c7ec216c8d..3d3f5b0fc3 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -208,17 +212,40 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        synchronizer.updateState((state, updates) -> {\n-            updates.add(new UpdatingConfig(true));\n-        });\n-        getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n-        ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateState((state, updates) -> {\n-            if (state.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false);\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                config.setGeneration(state.getConfig().getGeneration());\n+                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    @VisibleForTesting\n+    protected boolean stateTransition(ReaderGroupState state, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(false);\n+        synchronizer.updateState((s, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            successfullyUpdated.set(s.getConfig().equals(state.getConfig()));\n+            if (successfullyUpdated.get()) {\n+                updates.add(update);\n             }\n         });\n+        return successfullyUpdated.get();\n     }\n \n     @Override\n"}}, {"oid": "5f7b01ed99dab341df4d8b193cd8234b6637bd04", "url": "https://github.com/pravega/pravega/commit/5f7b01ed99dab341df4d8b193cd8234b6637bd04", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2020-12-21T11:26:41Z", "type": "commit"}, {"oid": "532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "url": "https://github.com/pravega/pravega/commit/532d8adb23030f1cfbeebdfa344d6ceded12cdd4", "message": "Changed resetRG logic, updated tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-21T11:28:35Z", "type": "commit"}, {"oid": "e2616bb70ada068ed51162b4179e404080b274a0", "url": "https://github.com/pravega/pravega/commit/e2616bb70ada068ed51162b4179e404080b274a0", "message": "Tweaks to ReaderGroupImplTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-21T12:55:34Z", "type": "commit"}, {"oid": "1220ea8cf59f6d3077711ba4c0f658d8e9b07393", "url": "https://github.com/pravega/pravega/commit/1220ea8cf59f6d3077711ba4c0f658d8e9b07393", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2020-12-22T07:34:28Z", "type": "commit"}, {"oid": "50cc856212b3aebed41879a344ec861ce949ace5", "url": "https://github.com/pravega/pravega/commit/50cc856212b3aebed41879a344ec861ce949ace5", "message": "Tweaks to ReaderGroupStateManager\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-22T07:36:42Z", "type": "commit"}, {"oid": "50cc856212b3aebed41879a344ec861ce949ace5", "url": "https://github.com/pravega/pravega/commit/50cc856212b3aebed41879a344ec861ce949ace5", "message": "Tweaks to ReaderGroupStateManager\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2020-12-22T07:36:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzMTcyMw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551631723", "bodyText": "This is a public facing object and is immutable. I see no reason to change that.\nhttps://github.com/pravega/pravega/wiki/Contributing#threading", "author": "tkaitchuck", "createdAt": "2021-01-04T23:36:24Z", "path": "client/src/main/java/io/pravega/client/stream/ReaderGroupConfig.java", "diffHunk": "@@ -53,9 +54,11 @@\n \n     private final StreamDataRetention retentionType;\n \n-    private final long generation;\n+    @Setter\n+    private long generation;\n \n-    private final UUID readerGroupId;\n+    @Setter\n+    private UUID readerGroupId;", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgzNjM0Mw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551836343", "bodyText": "Removed the Setters", "author": "anirudhkovuru", "createdAt": "2021-01-05T10:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzMTcyMw=="}], "type": "inlineReview", "revised_code": {"commit": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/ReaderGroupConfig.java b/client/src/main/java/io/pravega/client/stream/ReaderGroupConfig.java\nindex 721c104e67..a5f094b723 100644\n--- a/client/src/main/java/io/pravega/client/stream/ReaderGroupConfig.java\n+++ b/client/src/main/java/io/pravega/client/stream/ReaderGroupConfig.java\n\n@@ -54,11 +53,9 @@ public class ReaderGroupConfig implements Serializable {\n \n     private final StreamDataRetention retentionType;\n \n-    @Setter\n-    private long generation;\n+    private final long generation;\n \n-    @Setter\n-    private UUID readerGroupId;\n+    private final UUID readerGroupId;\n \n     /**\n      * If a Reader Group wants unconsumed data to be retained in a Stream,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDAxNQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551634015", "bodyText": "It's strange that this calls fetchUpdates. This is a blocking remote call. This is a getter so it's confusing. It is also not clear when the readerGroupId would change and what consistency is attempting to be enforced by updating first.", "author": "tkaitchuck", "createdAt": "2021-01-04T23:39:51Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -117,6 +119,16 @@ public void updateRetentionStreamCut(Map<Stream, StreamCut> streamCuts) {\n                synchronizer.getState().getConfig().getRetentionType().toString());\n     }\n \n+    public UUID getGroupId() {\n+        synchronizer.fetchUpdates();", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ2OTYwOA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r552469608", "bodyText": "Here we do not need to call fetchUpdates for consistency as the groupId never changes.", "author": "anirudhkovuru", "createdAt": "2021-01-06T09:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDAxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 089009bfec..e6b98efa4d 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -120,7 +120,6 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     }\n \n     public UUID getGroupId() {\n-        synchronizer.fetchUpdates();\n         return synchronizer.getState().getConfig().getReaderGroupId();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDA3NQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551634075", "bodyText": "Same here.", "author": "tkaitchuck", "createdAt": "2021-01-04T23:39:59Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -117,6 +119,16 @@ public void updateRetentionStreamCut(Map<Stream, StreamCut> streamCuts) {\n                synchronizer.getState().getConfig().getRetentionType().toString());\n     }\n \n+    public UUID getGroupId() {\n+        synchronizer.fetchUpdates();\n+        return synchronizer.getState().getConfig().getReaderGroupId();\n+    }\n+\n+    public long getGeneration() {\n+        synchronizer.fetchUpdates();", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMyMjY4Mw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553322683", "bodyText": "Removed fetchUpdates from here.", "author": "anirudhkovuru", "createdAt": "2021-01-07T13:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDIxMjYxNQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554212615", "bodyText": "I don't see a change. Was it pushed?", "author": "tkaitchuck", "createdAt": "2021-01-08T21:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDU3ODU3MA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554578570", "bodyText": "When calling deleteReaderGroup on the controller end we need to pass the generation and readergroupID for which we need their latest versions, hence the fetchUpdates. I had initially thought to get the ReaderGroup and then use Impl methods to get these values as I have done above. However, since these getters for the generation and groupID are only being called at one place (in deleteReaderGroup) instead of getting the ReaderGroupImpl I make the StateSynchronizer, call fetchUpdates once and then access the latest versions of generation and groupID.\nLike so: https://github.com/anirudhkovuru/pravega/blob/00a655d3dab31bd219c2e117c7f0e36b5b11f0b5/client/src/main/java/io/pravega/client/admin/impl/ReaderGroupManagerImpl.java#L103-L112", "author": "anirudhkovuru", "createdAt": "2021-01-10T14:53:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNDA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 089009bfec..e6b98efa4d 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -120,7 +120,6 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     }\n \n     public UUID getGroupId() {\n-        synchronizer.fetchUpdates();\n         return synchronizer.getState().getConfig().getReaderGroupId();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNTM1MA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551635350", "bodyText": "You can use a local", "author": "tkaitchuck", "createdAt": "2021-01-04T23:44:15Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +215,39 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                config.setGeneration(state.getConfig().getGeneration());\n+                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    private boolean stateTransition(ReaderGroupState state, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(true);\n+        synchronizer.updateState((s, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            successfullyUpdated.set(s.getConfig().equals(state.getConfig()));\n+            if (successfullyUpdated.get()) {", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM3MzUwMw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r552373503", "bodyText": "Using local as suggested.", "author": "anirudhkovuru", "createdAt": "2021-01-06T05:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNTM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 089009bfec..0944d1176c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -221,13 +221,14 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n             // We only move into the block if the state transition has happened successfully.\n             if (stateTransition(state, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n-                config.setGeneration(state.getConfig().getGeneration());\n-                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n-                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(state.getConfig().getReaderGroupId())\n+                        .generation(state.getConfig().getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNTYyNw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551635627", "bodyText": "I think what you want here is a way to create a builder from an existing config.", "author": "tkaitchuck", "createdAt": "2021-01-04T23:45:14Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +215,39 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                config.setGeneration(state.getConfig().getGeneration());\n+                config.setReaderGroupId(state.getConfig().getReaderGroupId());", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTgzNjE0NQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551836145", "bodyText": "Using toBuilder in the Builder annotation instead of setters.", "author": "anirudhkovuru", "createdAt": "2021-01-05T10:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNTYyNw=="}], "type": "inlineReview", "revised_code": {"commit": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 089009bfec..0944d1176c 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -221,13 +221,14 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n             // We only move into the block if the state transition has happened successfully.\n             if (stateTransition(state, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n-                config.setGeneration(state.getConfig().getGeneration());\n-                config.setReaderGroupId(state.getConfig().getReaderGroupId());\n-                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, config));\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(state.getConfig().getReaderGroupId())\n+                        .generation(state.getConfig().getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config), false));\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNzAzMA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551637030", "bodyText": "This is making multiple calls to the controller inside of the updateState function. This doesn't work well for optimistic concurrency. Perhaps most this outside of the update state, and just rely on the if to make the update conditional on the config not having changed.", "author": "tkaitchuck", "createdAt": "2021-01-04T23:49:39Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +342,24 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        if (!updateConfigTimer.hasRemaining()) {\n+            fetchUpdatesIfNeeded();\n+            ReaderGroupState state = sync.getState();\n+            if (state.isUpdatingConfig()) {\n+                sync.updateState((s, updates) -> {\n+                    ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                    if (s.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg0NzkyMQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551847921", "bodyText": "Moved the controller calls outside the update state.", "author": "anirudhkovuru", "createdAt": "2021-01-05T10:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNzAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 4bdd8a9145..70c74c5110 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -348,11 +348,11 @@ public class ReaderGroupStateManager {\n             fetchUpdatesIfNeeded();\n             ReaderGroupState state = sync.getState();\n             if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n                 sync.updateState((s, updates) -> {\n-                    ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n-                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n                     if (s.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n                         updates.add(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n                     }\n                 });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNzA5Mg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551637092", "bodyText": "Same here. (see below)", "author": "tkaitchuck", "createdAt": "2021-01-04T23:49:52Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java", "diffHunk": "@@ -330,6 +342,24 @@ private void fetchUpdatesIfNeeded() {\n             compactIfNeeded();\n         }\n     }\n+\n+    void updateConfigIfNeeded() {\n+        if (!updateConfigTimer.hasRemaining()) {\n+            fetchUpdatesIfNeeded();\n+            ReaderGroupState state = sync.getState();\n+            if (state.isUpdatingConfig()) {\n+                sync.updateState((s, updates) -> {\n+                    ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));", "originalCommit": "50cc856212b3aebed41879a344ec861ce949ace5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTg0ODA1OA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r551848058", "bodyText": "Moved them outside", "author": "anirudhkovuru", "createdAt": "2021-01-05T10:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTYzNzA5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\nindex 4bdd8a9145..70c74c5110 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java\n\n@@ -348,11 +348,11 @@ public class ReaderGroupStateManager {\n             fetchUpdatesIfNeeded();\n             ReaderGroupState state = sync.getState();\n             if (state.isUpdatingConfig()) {\n+                ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n+                log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n                 sync.updateState((s, updates) -> {\n-                    ReaderGroupConfig controllerConfig = getThrowingException(controller.getReaderGroupConfig(scope, groupName));\n-                    log.debug(\"Updating the readergroup {} with the new config {} obtained from the controller\", groupName, controllerConfig);\n                     if (s.getConfig().getGeneration() < controllerConfig.getGeneration()) {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, controllerConfig);\n                         updates.add(new ReaderGroupState.ReaderGroupStateInit(controllerConfig, segments, getEndSegmentsForStreams(controllerConfig), false));\n                     }\n                 });\n"}}, {"oid": "7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "url": "https://github.com/pravega/pravega/commit/7648619ce03d0e5c23c56aca77514f3ec7bf7c25", "message": "Added MockController calls, addressed a few comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-05T09:41:30Z", "type": "commit"}, {"oid": "46349ae822822ec180c3994a8d30ba6efba04836", "url": "https://github.com/pravega/pravega/commit/46349ae822822ec180c3994a8d30ba6efba04836", "message": "Addressing comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-06T05:14:21Z", "type": "commit"}, {"oid": "e6f26b4c15f0a47482ae815222734bc06f5cf0ff", "url": "https://github.com/pravega/pravega/commit/e6f26b4c15f0a47482ae815222734bc06f5cf0ff", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-06T05:56:45Z", "type": "commit"}, {"oid": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "url": "https://github.com/pravega/pravega/commit/c4c85c732154321d1e598018f6ba4c5de1ee727b", "message": "Tweaked getGroupId\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-06T09:42:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDA4Nw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553000087", "bodyText": "State is only used for config. So make the parameter 'config' instead. This would also minorly simplify the caller.", "author": "tkaitchuck", "createdAt": "2021-01-06T22:38:40Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(state.getConfig().getReaderGroupId())\n+                        .generation(state.getConfig().getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    private boolean stateTransition(ReaderGroupState state, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(true);\n+        synchronizer.updateState((s, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            boolean updated = s.getConfig().equals(state.getConfig());", "originalCommit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE0MTY5OA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553141698", "bodyText": "Using config instead.", "author": "anirudhkovuru", "createdAt": "2021-01-07T06:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDA4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex e6b98efa4d..687097ade6 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -216,17 +216,17 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     public void resetReaderGroup(ReaderGroupConfig config) {\n         while (true) {\n             synchronizer.fetchUpdates();\n-            val state = synchronizer.getState();\n+            val currentConfig = synchronizer.getState().getConfig();\n             // We only move into the block if the state transition has happened successfully.\n-            if (stateTransition(state, new UpdatingConfig(true))) {\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n                 ReaderGroupConfig newConfig = config.toBuilder()\n-                        .readerGroupId(state.getConfig().getReaderGroupId())\n-                        .generation(state.getConfig().getGeneration()).build();\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDc0Nw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553000747", "bodyText": "The update function in stateTransition will do this.", "author": "tkaitchuck", "createdAt": "2021-01-06T22:40:41Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();", "originalCommit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEwODUwMw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553108503", "bodyText": "The while loop in resetReaderGroup is so that we can retry in case the stateTransition fails.", "author": "anirudhkovuru", "createdAt": "2021-01-07T04:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU1MjA0OA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553552048", "bodyText": "I think you misunderstand:\nCalling update on a state synchronizer will be retried can cause the update function to be re-run if it is not up to date. So it is not necessary to call fetchUpdates between calls to update in a loop because by definition the state will be up to date. That is the contract of the update function. So you can simply remove the fetchUpdates call.", "author": "tkaitchuck", "createdAt": "2021-01-07T19:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1Mzg1Mw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554453853", "bodyText": "I've moved the synchronizer.fetchUpdates to outside the while loop so its called once before the while loop. Then within the while loop update will allow for the state to be up to date.", "author": "anirudhkovuru", "createdAt": "2021-01-09T17:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMDc0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex e6b98efa4d..687097ade6 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -216,17 +216,17 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     public void resetReaderGroup(ReaderGroupConfig config) {\n         while (true) {\n             synchronizer.fetchUpdates();\n-            val state = synchronizer.getState();\n+            val currentConfig = synchronizer.getState().getConfig();\n             // We only move into the block if the state transition has happened successfully.\n-            if (stateTransition(state, new UpdatingConfig(true))) {\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n                 ReaderGroupConfig newConfig = config.toBuilder()\n-                        .readerGroupId(state.getConfig().getReaderGroupId())\n-                        .generation(state.getConfig().getGeneration()).build();\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTc1OQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553001759", "bodyText": "getSegmentsForStreams is making an RPC to the controller. Please move this out of the updateState block.", "author": "tkaitchuck", "createdAt": "2021-01-06T22:43:44Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(state.getConfig().getReaderGroupId())\n+                        .generation(state.getConfig().getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);", "originalCommit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE0MTc2OQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553141769", "bodyText": "Moved out.", "author": "anirudhkovuru", "createdAt": "2021-01-07T06:57:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTc1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex e6b98efa4d..687097ade6 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -216,17 +216,17 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     public void resetReaderGroup(ReaderGroupConfig config) {\n         while (true) {\n             synchronizer.fetchUpdates();\n-            val state = synchronizer.getState();\n+            val currentConfig = synchronizer.getState().getConfig();\n             // We only move into the block if the state transition has happened successfully.\n-            if (stateTransition(state, new UpdatingConfig(true))) {\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n                 ReaderGroupConfig newConfig = config.toBuilder()\n-                        .readerGroupId(state.getConfig().getReaderGroupId())\n-                        .generation(state.getConfig().getGeneration()).build();\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTkxMQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553001911", "bodyText": "Doesn't the generation need to change somewhere?", "author": "tkaitchuck", "createdAt": "2021-01-06T22:44:09Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val state = synchronizer.getState();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(state, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(state.getConfig().getReaderGroupId())\n+                        .generation(state.getConfig().getGeneration()).build();", "originalCommit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzExODA3MA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553118070", "bodyText": "The generation is updated on the controller. We update the config's generation on to the controller using the periodic update that we have on the ReaderGroupStateManager.\nhttps://github.com/anirudhkovuru/pravega/blob/c4c85c732154321d1e598018f6ba4c5de1ee727b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupStateManager.java#L346-L362", "author": "anirudhkovuru", "createdAt": "2021-01-07T05:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1MjUxNg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554452516", "bodyText": "The generation that is written into the StateSynchronizer is the one returned after controller.updateReaderGroup has been called.", "author": "anirudhkovuru", "createdAt": "2021-01-09T17:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMTkxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex e6b98efa4d..687097ade6 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -216,17 +216,17 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n     public void resetReaderGroup(ReaderGroupConfig config) {\n         while (true) {\n             synchronizer.fetchUpdates();\n-            val state = synchronizer.getState();\n+            val currentConfig = synchronizer.getState().getConfig();\n             // We only move into the block if the state transition has happened successfully.\n-            if (stateTransition(state, new UpdatingConfig(true))) {\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n                 // Use the latest generation and reader group Id.\n                 ReaderGroupConfig newConfig = config.toBuilder()\n-                        .readerGroupId(state.getConfig().getReaderGroupId())\n-                        .generation(state.getConfig().getGeneration()).build();\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n                     synchronizer.updateState((s, updates) -> {\n-                        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n                     return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwNDEwOA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553004108", "bodyText": "For these tests, can we also add an assertion that advancing the reader group will correctly result in data being truncated?", "author": "tkaitchuck", "createdAt": "2021-01-06T22:50:46Z", "path": "test/integration/src/test/java/io/pravega/test/integration/endtoendtest/EndToEndReaderGroupTest.java", "diffHunk": "@@ -153,6 +156,92 @@ public void testDeleteReaderGroup() throws Exception {\n         assertEquals(\"data1\", eventRead.getEvent());\n     }\n \n+    @Test", "originalCommit": "c4c85c732154321d1e598018f6ba4c5de1ee727b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjYzODkzNg==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r556638936", "bodyText": "Added tests for the case.", "author": "anirudhkovuru", "createdAt": "2021-01-13T16:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwNDEwOA=="}], "type": "inlineReview", "revised_code": {"commit": "7a24e92e8b366483cb24051ab7a3514e15278b21", "chunk": "diff --git a/test/integration/src/test/java/io/pravega/test/integration/endtoendtest/EndToEndReaderGroupTest.java b/test/integration/src/test/java/io/pravega/test/integration/endtoendtest/EndToEndReaderGroupTest.java\nindex 38dfb14547..d8af261132 100644\n--- a/test/integration/src/test/java/io/pravega/test/integration/endtoendtest/EndToEndReaderGroupTest.java\n+++ b/test/integration/src/test/java/io/pravega/test/integration/endtoendtest/EndToEndReaderGroupTest.java\n\n@@ -178,7 +178,7 @@ public class EndToEndReaderGroupTest extends AbstractEndToEndTest {\n                                                                 .retentionType(ReaderGroupConfig.StreamDataRetention.MANUAL_RELEASE_AT_USER_STREAMCUT).build());\n \n         List<String> subs = controller.listSubscribers(\"test\", \"test\").get();\n-        assertTrue(\"Subscriber list does not contain required reader group\", subs.contains(\"group\"));\n+        assertTrue(\"Subscriber list does not contain required reader group\", subs.contains(\"test/group\"));\n     }\n \n     @Test\n"}}, {"oid": "6d1df2d67b294499e21d6ad2090b985bc0418034", "url": "https://github.com/pravega/pravega/commit/6d1df2d67b294499e21d6ad2090b985bc0418034", "message": "Addressing more comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-07T06:55:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI2MjAxNw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553262017", "bodyText": "getSegmentsForStreams  should be inside the if (success) block since it is not needed if controller.updateReaderGroup() has failed.", "author": "pbelgundi", "createdAt": "2021-01-07T11:08:32Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val currentConfig = synchronizer.getState().getConfig();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);", "originalCommit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzMxOTE2Ng==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553319166", "bodyText": "It is inside the if block", "author": "anirudhkovuru", "createdAt": "2021-01-07T13:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI2MjAxNw=="}], "type": "inlineReview", "revised_code": {"commit": "3bfb7b5c09a4bc8db223b4df481350235e493218", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 687097ade6..da34074670 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -224,8 +227,8 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n                         .readerGroupId(currentConfig.getReaderGroupId())\n                         .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                     synchronizer.updateState((s, updates) -> {\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI2NTk0NA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553265944", "bodyText": "I don't see equals() and hashcode() overridden in ReaderGroupConfig, so this would do a reference comparison. That does not look right to me.", "author": "pbelgundi", "createdAt": "2021-01-07T11:17:00Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +214,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val currentConfig = synchronizer.getState().getConfig();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n+                if (success) {\n+                    synchronizer.updateState((s, updates) -> {\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n+                    });\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    private boolean stateTransition(ReaderGroupConfig config, ReaderGroupState.ReaderGroupStateUpdate update) {\n+        // This boolean will help know if the update actually succeeds or not.\n+        AtomicBoolean successfullyUpdated = new AtomicBoolean(true);\n+        synchronizer.updateState((state, updates) -> {\n+            // If successfullyUpdated is false then that means the current state where this update should\n+            // take place (i.e. state with updatingConfig as false) is not the state we are in so we do not\n+            // make the update.\n+            boolean updated = state.getConfig().equals(config);", "originalCommit": "6d1df2d67b294499e21d6ad2090b985bc0418034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA0MjM3NQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554042375", "bodyText": "Since ReaderGroupConfig has Lombok annotation @DaTa that takes care of implementing equals and hashcode", "author": "pbelgundi", "createdAt": "2021-01-08T16:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI2NTk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "3bfb7b5c09a4bc8db223b4df481350235e493218", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex 687097ade6..da34074670 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -224,8 +227,8 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n                         .readerGroupId(currentConfig.getReaderGroupId())\n                         .generation(currentConfig.getGeneration()).build();\n                 boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n-                Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                 if (success) {\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n                     synchronizer.updateState((s, updates) -> {\n                         updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));\n                     });\n"}}, {"oid": "3bfb7b5c09a4bc8db223b4df481350235e493218", "url": "https://github.com/pravega/pravega/commit/3bfb7b5c09a4bc8db223b4df481350235e493218", "message": "Tweaked getters in ReaderGroup, addressing comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-07T13:13:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU3ODkwOA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553578908", "bodyText": "This should not be public. The fact that there is a state synchronizer internal to this class should not be known to the caller. Otherwise it violates encapsulation.", "author": "tkaitchuck", "createdAt": "2021-01-07T20:47:10Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -117,6 +119,18 @@ public void updateRetentionStreamCut(Map<Stream, StreamCut> streamCuts) {\n                synchronizer.getState().getConfig().getRetentionType().toString());\n     }\n \n+    public void fetchUpdates() {", "originalCommit": "3bfb7b5c09a4bc8db223b4df481350235e493218", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ccd92d91779ffa2c8f3c688ba3e3048bdf19000f", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex da34074670..cd11ef6403 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -119,15 +119,12 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n                synchronizer.getState().getConfig().getRetentionType().toString());\n     }\n \n-    public void fetchUpdates() {\n-        synchronizer.fetchUpdates();\n-    }\n-\n     public UUID getGroupId() {\n         return synchronizer.getState().getConfig().getReaderGroupId();\n     }\n \n     public long getGeneration() {\n+        synchronizer.fetchUpdates();\n         return synchronizer.getState().getConfig().getGeneration();\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3MjA2MA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r553672060", "bodyText": "This is storing config which was passed as a parameter. It does not appear to have a generation set on it.\nWhat I see happening now is that resetReaderGroup is called with a config provided by the user. Presumably they don't set the generation. (Should that method be private?) So the default value of -1 is passed. The call ends up here and it passes the config into the state init. But in updateConfigIfNeeded it pulls from the controller which updates the generation id every time. So it will always return a new config. Thus we end up reinitializing the group state twice.", "author": "tkaitchuck", "createdAt": "2021-01-08T00:33:19Z", "path": "client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java", "diffHunk": "@@ -203,8 +217,41 @@ private Checkpoint completeCheckpoint(String checkpointName) {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n-        Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, config);\n-        synchronizer.updateStateUnconditionally(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(config)));\n+        while (true) {\n+            synchronizer.fetchUpdates();\n+            val currentConfig = synchronizer.getState().getConfig();\n+            // We only move into the block if the state transition has happened successfully.\n+            if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n+                // Use the latest generation and reader group Id.\n+                ReaderGroupConfig newConfig = config.toBuilder()\n+                        .readerGroupId(currentConfig.getReaderGroupId())\n+                        .generation(currentConfig.getGeneration()).build();\n+                boolean success = Futures.getThrowingException(controller.updateReaderGroup(scope, groupName, newConfig));\n+                if (success) {\n+                    Map<SegmentWithRange, Long> segments = getSegmentsForStreams(controller, newConfig);\n+                    synchronizer.updateState((s, updates) -> {\n+                        updates.add(new ReaderGroupStateInit(config, segments, getEndSegmentsForStreams(newConfig), false));", "originalCommit": "3bfb7b5c09a4bc8db223b4df481350235e493218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDI4OTAyOA==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554289028", "bodyText": "controller.updateReaderGroup now returns the updated generation( See PR: #5462), which should be written to StateSynchronizer, but I don't see that happening here.", "author": "pbelgundi", "createdAt": "2021-01-09T04:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3MjA2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1MjA0NQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r554452045", "bodyText": "I have made it such that the updated generation is returned. That generation is what is written into the StateSynchronizer.", "author": "anirudhkovuru", "createdAt": "2021-01-09T17:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY3MjA2MA=="}], "type": "inlineReview", "revised_code": {"commit": "7a24e92e8b366483cb24051ab7a3514e15278b21", "chunk": "diff --git a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\nindex da34074670..7ceee68a2f 100644\n--- a/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n+++ b/client/src/main/java/io/pravega/client/stream/impl/ReaderGroupImpl.java\n\n@@ -217,8 +215,8 @@ public class ReaderGroupImpl implements ReaderGroup, ReaderGroupMetrics {\n \n     @Override\n     public void resetReaderGroup(ReaderGroupConfig config) {\n+        synchronizer.fetchUpdates();\n         while (true) {\n-            synchronizer.fetchUpdates();\n             val currentConfig = synchronizer.getState().getConfig();\n             // We only move into the block if the state transition has happened successfully.\n             if (stateTransition(currentConfig, new UpdatingConfig(true))) {\n"}}, {"oid": "ccd92d91779ffa2c8f3c688ba3e3048bdf19000f", "url": "https://github.com/pravega/pravega/commit/ccd92d91779ffa2c8f3c688ba3e3048bdf19000f", "message": "Merging master, addressing comments\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-08T06:57:49Z", "type": "commit"}, {"oid": "7a24e92e8b366483cb24051ab7a3514e15278b21", "url": "https://github.com/pravega/pravega/commit/7a24e92e8b366483cb24051ab7a3514e15278b21", "message": "Tweaked a few tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-09T07:18:52Z", "type": "commit"}, {"oid": "e17d2bc6cc404b0e05e16270d6e3cd8ebb060392", "url": "https://github.com/pravega/pravega/commit/e17d2bc6cc404b0e05e16270d6e3cd8ebb060392", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-09T07:19:43Z", "type": "commit"}, {"oid": "cc8fdd75dd68b8cb7894df1fbb2f707c9d6e8788", "url": "https://github.com/pravega/pravega/commit/cc8fdd75dd68b8cb7894df1fbb2f707c9d6e8788", "message": "made updateReaderGroup return generation\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-09T17:33:33Z", "type": "commit"}, {"oid": "483bb69aa7b4712b742539d95cb81eeade423e41", "url": "https://github.com/pravega/pravega/commit/483bb69aa7b4712b742539d95cb81eeade423e41", "message": "Fixed ControllerServiceTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-09T17:53:55Z", "type": "commit"}, {"oid": "9101165429b062d8d8fbaf6bf8ab121ed2a3eb24", "url": "https://github.com/pravega/pravega/commit/9101165429b062d8d8fbaf6bf8ab121ed2a3eb24", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-09T17:54:47Z", "type": "commit"}, {"oid": "b080e116e66b2cc5c5a6e01802af0f7e56457ff8", "url": "https://github.com/pravega/pravega/commit/b080e116e66b2cc5c5a6e01802af0f7e56457ff8", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-10T07:23:10Z", "type": "commit"}, {"oid": "00a655d3dab31bd219c2e117c7f0e36b5b11f0b5", "url": "https://github.com/pravega/pravega/commit/00a655d3dab31bd219c2e117c7f0e36b5b11f0b5", "message": "Tweaked deleteReaderGroup\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-10T14:45:26Z", "type": "commit"}, {"oid": "7cf326a15e459236d5c0db0313c0b84e757cf640", "url": "https://github.com/pravega/pravega/commit/7cf326a15e459236d5c0db0313c0b84e757cf640", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-11T13:00:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIzNzk1OQ==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r555237959", "bodyText": "Javadoc needs to be updated.", "author": "tkaitchuck", "createdAt": "2021-01-11T18:00:36Z", "path": "client/src/main/java/io/pravega/client/control/impl/Controller.java", "diffHunk": "@@ -141,7 +141,7 @@\n      * @return A future which will throw if the operation fails, otherwise returning a boolean to\n      *         indicate that the subscriber was updated in Stream Metadata.", "originalCommit": "7cf326a15e459236d5c0db0313c0b84e757cf640", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjYzODQ5Mw==", "url": "https://github.com/pravega/pravega/pull/5439#discussion_r556638493", "bodyText": "Javadoc is updated accordingly.", "author": "anirudhkovuru", "createdAt": "2021-01-13T16:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIzNzk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "50df6c1e6972ced87a909a341c8a08d3eae9da83", "chunk": "diff --git a/client/src/main/java/io/pravega/client/control/impl/Controller.java b/client/src/main/java/io/pravega/client/control/impl/Controller.java\nindex 90ca2c6826..eafd22db2b 100644\n--- a/client/src/main/java/io/pravega/client/control/impl/Controller.java\n+++ b/client/src/main/java/io/pravega/client/control/impl/Controller.java\n\n@@ -136,10 +136,11 @@ public interface Controller extends AutoCloseable {\n      * API to update a ReaderGroup config.\n      * @param scopeName Scope name for Reader Group.\n      * @param rgName Stream name.\n-     * @param config ReaderGroup confguration.\n+     * @param config ReaderGroup configuration.\n      * @throws IllegalArgumentException if Stream does not exist.\n-     * @return A future which will throw if the operation fails, otherwise returning a boolean to\n-     *         indicate that the subscriber was updated in Stream Metadata.\n+     * @return A future which will throw if the operation fails, otherwise\n+     *         the subscriber was updated in Stream Metadata and a long indicating\n+     *         the updated config generation is returned.\n      */\n     CompletableFuture<Long> updateReaderGroup(final String scopeName, final String rgName, ReaderGroupConfig config);\n \n"}}, {"oid": "50df6c1e6972ced87a909a341c8a08d3eae9da83", "url": "https://github.com/pravega/pravega/commit/50df6c1e6972ced87a909a341c8a08d3eae9da83", "message": "Added javadoc\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T04:22:29Z", "type": "commit"}, {"oid": "14832702c639564181476ed855ebb8817078667a", "url": "https://github.com/pravega/pravega/commit/14832702c639564181476ed855ebb8817078667a", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-13T04:23:50Z", "type": "commit"}, {"oid": "14832702c639564181476ed855ebb8817078667a", "url": "https://github.com/pravega/pravega/commit/14832702c639564181476ed855ebb8817078667a", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-13T04:23:50Z", "type": "forcePushed"}, {"oid": "ea1e2d5f5074f62d593023b6637b4affd5ef3e9b", "url": "https://github.com/pravega/pravega/commit/ea1e2d5f5074f62d593023b6637b4affd5ef3e9b", "message": "Adding tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T11:58:31Z", "type": "commit"}, {"oid": "b0e650fe0d64472252bb2151adf0220477352c34", "url": "https://github.com/pravega/pravega/commit/b0e650fe0d64472252bb2151adf0220477352c34", "message": "Cleaned up tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T14:40:52Z", "type": "commit"}, {"oid": "3129127dce69ea15abeed06aba015dd3fe3088cb", "url": "https://github.com/pravega/pravega/commit/3129127dce69ea15abeed06aba015dd3fe3088cb", "message": "Added tests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T16:26:11Z", "type": "commit"}, {"oid": "2a27b131b71db24f898bc259493e4f486a94e859", "url": "https://github.com/pravega/pravega/commit/2a27b131b71db24f898bc259493e4f486a94e859", "message": "checkstyle\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T16:27:11Z", "type": "commit"}, {"oid": "1790322900289a75fff3adf7529e60a8ffee225f", "url": "https://github.com/pravega/pravega/commit/1790322900289a75fff3adf7529e60a8ffee225f", "message": "cleaning up test\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T16:29:13Z", "type": "commit"}, {"oid": "d91ce38561b7094189e0d6a01af4847d4caf7874", "url": "https://github.com/pravega/pravega/commit/d91ce38561b7094189e0d6a01af4847d4caf7874", "message": "Fixed client test\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-13T17:12:43Z", "type": "commit"}, {"oid": "ff8455ada61bc59a26f3a49d0117719318b5a84d", "url": "https://github.com/pravega/pravega/commit/ff8455ada61bc59a26f3a49d0117719318b5a84d", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-14T09:57:20Z", "type": "commit"}, {"oid": "ad89a80056a09d3a01e4d56c322603137dc5dbd8", "url": "https://github.com/pravega/pravega/commit/ad89a80056a09d3a01e4d56c322603137dc5dbd8", "message": "Fixing unreliable test\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-14T10:44:40Z", "type": "commit"}, {"oid": "ad89a80056a09d3a01e4d56c322603137dc5dbd8", "url": "https://github.com/pravega/pravega/commit/ad89a80056a09d3a01e4d56c322603137dc5dbd8", "message": "Fixing unreliable test\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-14T10:44:40Z", "type": "forcePushed"}, {"oid": "51ea8824e360b655d88d72712754ce26d2b4b409", "url": "https://github.com/pravega/pravega/commit/51ea8824e360b655d88d72712754ce26d2b4b409", "message": "Finding test coverage\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-14T13:13:56Z", "type": "commit"}, {"oid": "805152550379059c62b1a10cac7a4ece794f867e", "url": "https://github.com/pravega/pravega/commit/805152550379059c62b1a10cac7a4ece794f867e", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-14T13:14:47Z", "type": "commit"}, {"oid": "589dab7676bd351eaf647d603a8e7013bce39e3e", "url": "https://github.com/pravega/pravega/commit/589dab7676bd351eaf647d603a8e7013bce39e3e", "message": "Green build for coverage info\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-14T15:05:27Z", "type": "commit"}, {"oid": "1b23651515fe85dd0294ec7c90122713b56d2cb8", "url": "https://github.com/pravega/pravega/commit/1b23651515fe85dd0294ec7c90122713b56d2cb8", "message": "Adding tests for coverage\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-15T06:32:59Z", "type": "commit"}, {"oid": "6837766cbaacd64b648c4540b28db101715ea6eb", "url": "https://github.com/pravega/pravega/commit/6837766cbaacd64b648c4540b28db101715ea6eb", "message": "Resolving merge conflict\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-15T06:37:10Z", "type": "commit"}, {"oid": "fb2a28ec45e5519cc4fbf1d440103b3465482ad5", "url": "https://github.com/pravega/pravega/commit/fb2a28ec45e5519cc4fbf1d440103b3465482ad5", "message": "Fixed checkstyle\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-15T06:55:27Z", "type": "commit"}, {"oid": "7c5f153b31b495fd529cb4d61b5d567de30d2993", "url": "https://github.com/pravega/pravega/commit/7c5f153b31b495fd529cb4d61b5d567de30d2993", "message": "Removing ignore annotation\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-15T12:28:31Z", "type": "commit"}, {"oid": "e580bf5a66386532be0bb5a6baeb0bd4c09b31f2", "url": "https://github.com/pravega/pravega/commit/e580bf5a66386532be0bb5a6baeb0bd4c09b31f2", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-15T12:28:39Z", "type": "commit"}, {"oid": "ea227f4011d4ae41e079529e872f2d553f3fb517", "url": "https://github.com/pravega/pravega/commit/ea227f4011d4ae41e079529e872f2d553f3fb517", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-15T13:39:52Z", "type": "commit"}, {"oid": "d317a8695f8275e7fed5a268169bdea6f0bd1d88", "url": "https://github.com/pravega/pravega/commit/d317a8695f8275e7fed5a268169bdea6f0bd1d88", "message": "Fix checkstyle\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-15T13:54:05Z", "type": "commit"}, {"oid": "e3c2303c55eb96d75a36af00f47e8272c621cb9f", "url": "https://github.com/pravega/pravega/commit/e3c2303c55eb96d75a36af00f47e8272c621cb9f", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-17T14:34:14Z", "type": "commit"}, {"oid": "319cb19ed2280f68f1bc4c161d7245f70a59c3c0", "url": "https://github.com/pravega/pravega/commit/319cb19ed2280f68f1bc4c161d7245f70a59c3c0", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5112-client-changes", "committedDate": "2021-01-18T12:21:44Z", "type": "commit"}, {"oid": "4ecd6d4805c500bce435d1d03caf15249a585e20", "url": "https://github.com/pravega/pravega/commit/4ecd6d4805c500bce435d1d03caf15249a585e20", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-18T16:43:15Z", "type": "commit"}, {"oid": "85371e290c3a8341f4298de6ad366f494256d260", "url": "https://github.com/pravega/pravega/commit/85371e290c3a8341f4298de6ad366f494256d260", "message": "fix for issue\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-19T04:36:49Z", "type": "commit"}, {"oid": "56f0f97dc31e8ce95758042e4f62aab648c9f508", "url": "https://github.com/pravega/pravega/commit/56f0f97dc31e8ce95758042e4f62aab648c9f508", "message": "Merge remote-tracking branch 'upstream/master' into issue-5543-flaky-metrics", "committedDate": "2021-01-19T04:37:22Z", "type": "commit"}, {"oid": "05d7751d45fab6780d8cf45fb813f9f8b176def4", "url": "https://github.com/pravega/pravega/commit/05d7751d45fab6780d8cf45fb813f9f8b176def4", "message": "fixed issue with updateSubscriberStreamCut metrics\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-19T05:04:54Z", "type": "commit"}, {"oid": "b92cec394a51a556d5fa2f04673db53c1f341481", "url": "https://github.com/pravega/pravega/commit/b92cec394a51a556d5fa2f04673db53c1f341481", "message": "fixed code comments\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-19T05:19:18Z", "type": "commit"}, {"oid": "c081b2b257ac106bf14aaa241d5341e5d815e86a", "url": "https://github.com/pravega/pravega/commit/c081b2b257ac106bf14aaa241d5341e5d815e86a", "message": "checkstyle fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>", "committedDate": "2021-01-19T05:28:03Z", "type": "commit"}, {"oid": "40a340ced4f55ca3b84e52551c9a95a01a6c69a3", "url": "https://github.com/pravega/pravega/commit/40a340ced4f55ca3b84e52551c9a95a01a6c69a3", "message": "Merge branch 'issue-5543-flaky-metrics' of https://github.com/pbelgundi/pravega into issue-5112-client-changes", "committedDate": "2021-01-19T07:12:09Z", "type": "commit"}, {"oid": "40a340ced4f55ca3b84e52551c9a95a01a6c69a3", "url": "https://github.com/pravega/pravega/commit/40a340ced4f55ca3b84e52551c9a95a01a6c69a3", "message": "Merge branch 'issue-5543-flaky-metrics' of https://github.com/pbelgundi/pravega into issue-5112-client-changes", "committedDate": "2021-01-19T07:12:09Z", "type": "forcePushed"}, {"oid": "dcf512eee31209e8a294f412aec083b09be77051", "url": "https://github.com/pravega/pravega/commit/dcf512eee31209e8a294f412aec083b09be77051", "message": "Adding metrics coverage\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>", "committedDate": "2021-01-19T07:19:54Z", "type": "commit"}, {"oid": "2240ae5ce354bcbbd82f111e12799f67267109c5", "url": "https://github.com/pravega/pravega/commit/2240ae5ce354bcbbd82f111e12799f67267109c5", "message": "Merge branch 'master' into issue-5112-client-changes", "committedDate": "2021-01-19T10:27:37Z", "type": "commit"}, {"oid": "2c4844f1ed5ddcb6ef6987b7dae1ef4519405218", "url": "https://github.com/pravega/pravega/commit/2c4844f1ed5ddcb6ef6987b7dae1ef4519405218", "message": "Merge branch 'master' into issue-5112-client-changes", "committedDate": "2021-01-19T12:08:51Z", "type": "commit"}]}