{"pr_number": 5179, "pr_title": "Issue 5122: Improving Windows Compatibility", "pr_createdAt": "2020-09-13T19:34:33Z", "pr_url": "https://github.com/pravega/pravega/pull/5179", "timeline": [{"oid": "08601afd11463bf700a6d0af3f33dcb53f935e09", "url": "https://github.com/pravega/pravega/commit/08601afd11463bf700a6d0af3f33dcb53f935e09", "message": "Update K8 client APIs to use their 5.0.0 counterparts.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-02-21T00:13:24Z", "type": "commit"}, {"oid": "25a165d0293c34ee8703fff764e55cf8fda413dd", "url": "https://github.com/pravega/pravega/commit/25a165d0293c34ee8703fff764e55cf8fda413dd", "message": "Merge pull request #1 from co-jo/issue-4464-update-kubernetes-client-version\n\nIssue 4464 update kubernetes client version", "committedDate": "2020-02-21T18:42:03Z", "type": "commit"}, {"oid": "8cc2dd2be26feed2953258ff055c1657aeb57019", "url": "https://github.com/pravega/pravega/commit/8cc2dd2be26feed2953258ff055c1657aeb57019", "message": "Run system tests using alternative flag value.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-02-23T04:43:09Z", "type": "commit"}, {"oid": "c3fcbd2e627f9fc0a0f6bad7e42667db4439e092", "url": "https://github.com/pravega/pravega/commit/c3fcbd2e627f9fc0a0f6bad7e42667db4439e092", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-10T22:21:32Z", "type": "commit"}, {"oid": "f5f808cc42831892aeb8e7824c22d499a1f9fa03", "url": "https://github.com/pravega/pravega/commit/f5f808cc42831892aeb8e7824c22d499a1f9fa03", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-03-18T18:44:10Z", "type": "commit"}, {"oid": "7901435dc1127bed1c46845bbaf8024477e2078f", "url": "https://github.com/pravega/pravega/commit/7901435dc1127bed1c46845bbaf8024477e2078f", "message": "Merge branch 'master' of https://github.com/pravega/pravega\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-04-02T18:49:59Z", "type": "commit"}, {"oid": "d59b3e33f6d5bd90264753caadcea7ed7bbfe06c", "url": "https://github.com/pravega/pravega/commit/d59b3e33f6d5bd90264753caadcea7ed7bbfe06c", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-04-16T20:22:05Z", "type": "commit"}, {"oid": "aa090cad1d88812f2a88e9debacdb04df585adbf", "url": "https://github.com/pravega/pravega/commit/aa090cad1d88812f2a88e9debacdb04df585adbf", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-04-18T20:15:50Z", "type": "commit"}, {"oid": "e328bcb38239fdc32f866980ee1103c93dff522d", "url": "https://github.com/pravega/pravega/commit/e328bcb38239fdc32f866980ee1103c93dff522d", "message": "Merge branch 'master' of https://github.com/co-jo/pravega", "committedDate": "2020-05-11T22:25:21Z", "type": "commit"}, {"oid": "cd02180986f49a42002c7fd2ef28885d1f701af9", "url": "https://github.com/pravega/pravega/commit/cd02180986f49a42002c7fd2ef28885d1f701af9", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-05-11T22:25:27Z", "type": "commit"}, {"oid": "1408d7527ec73f1645418df04aea4aa1120b39e7", "url": "https://github.com/pravega/pravega/commit/1408d7527ec73f1645418df04aea4aa1120b39e7", "message": "Merge branch 'master' of https://github.com/co-jo/pravega", "committedDate": "2020-05-18T20:48:16Z", "type": "commit"}, {"oid": "e2719517850f39bce3e5f2c92f04c8c24122a520", "url": "https://github.com/pravega/pravega/commit/e2719517850f39bce3e5f2c92f04c8c24122a520", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-05-20T18:59:36Z", "type": "commit"}, {"oid": "b1d3648dd2c28a161dab520a48bf4bf657f9d14d", "url": "https://github.com/pravega/pravega/commit/b1d3648dd2c28a161dab520a48bf4bf657f9d14d", "message": "Merge branch 'master' of https://github.com/pravega/pravega", "committedDate": "2020-06-15T18:43:02Z", "type": "commit"}, {"oid": "cac51c3b946704734eeab4684a5bc2f6ffefe08c", "url": "https://github.com/pravega/pravega/commit/cac51c3b946704734eeab4684a5bc2f6ffefe08c", "message": "First round of Windows compatibility enhancements.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-08-29T19:44:24Z", "type": "commit"}, {"oid": "864b41b2007e27c823be2fb7c5b90f1c8fef1430", "url": "https://github.com/pravega/pravega/commit/864b41b2007e27c823be2fb7c5b90f1c8fef1430", "message": "* Feedback.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-08-29T19:49:37Z", "type": "commit"}, {"oid": "7ce43a6377c04b2471212debb3b1a2144ce2f6df", "url": "https://github.com/pravega/pravega/commit/7ce43a6377c04b2471212debb3b1a2144ce2f6df", "message": "* Remove unnecessary token.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-08-29T20:01:25Z", "type": "commit"}, {"oid": "565c5a8a9955078925bdba7b6b421c08affae793", "url": "https://github.com/pravega/pravega/commit/565c5a8a9955078925bdba7b6b421c08affae793", "message": "Replace other '/tmp' references with platform aware paths.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-03T20:48:58Z", "type": "commit"}, {"oid": "e1df0d16fc26c958f7e1c11f7a758d23c0661916", "url": "https://github.com/pravega/pravega/commit/e1df0d16fc26c958f7e1c11f7a758d23c0661916", "message": "Add back blank line.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-03T20:51:27Z", "type": "commit"}, {"oid": "32e3a5c66c79bccccce54a52fcda4b6793299334", "url": "https://github.com/pravega/pravega/commit/32e3a5c66c79bccccce54a52fcda4b6793299334", "message": "Merge branch 'master' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-04T10:20:26Z", "type": "commit"}, {"oid": "9b1faf39f4878c9e4febf5614d8084ec54d17ed4", "url": "https://github.com/pravega/pravega/commit/9b1faf39f4878c9e4febf5614d8084ec54d17ed4", "message": "Fix typo.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-08T16:59:09Z", "type": "commit"}, {"oid": "50706c5430f8f14814a2ef78f727abd5474d6f31", "url": "https://github.com/pravega/pravega/commit/50706c5430f8f14814a2ef78f727abd5474d6f31", "message": "Merge remote-tracking branch 'origin/issue-5122-improving-windows-compatibility' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-08T16:59:19Z", "type": "commit"}, {"oid": "e0abcb2cfb3885ec54dbd12d6354e26307716f52", "url": "https://github.com/pravega/pravega/commit/e0abcb2cfb3885ec54dbd12d6354e26307716f52", "message": "Merge remote-tracking branch 'origin' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-13T19:27:27Z", "type": "commit"}, {"oid": "efc1d4de1683a7b66e0f0e69e7485f6728db7c28", "url": "https://github.com/pravega/pravega/commit/efc1d4de1683a7b66e0f0e69e7485f6728db7c28", "message": "Refactor another /tmp directory.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-13T19:30:21Z", "type": "commit"}, {"oid": "6f67e510aa9e0ce2a9476bf006c33798f9bfb28b", "url": "https://github.com/pravega/pravega/commit/6f67e510aa9e0ce2a9476bf006c33798f9bfb28b", "message": "Merge branch 'master' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-13T19:34:40Z", "type": "commit"}, {"oid": "cdda34c235e1a1ad965ff965a8f69a94c222b377", "url": "https://github.com/pravega/pravega/commit/cdda34c235e1a1ad965ff965a8f69a94c222b377", "message": "Merge branch 'master' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-14T18:21:46Z", "type": "commit"}, {"oid": "7e4ef7d9c928ba6f991905e3023e0e3108cb3971", "url": "https://github.com/pravega/pravega/commit/7e4ef7d9c928ba6f991905e3023e0e3108cb3971", "message": "Quietly delete directories.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-16T21:02:19Z", "type": "commit"}, {"oid": "12b7a1f1c503f9d7c0b382f51e29ab84155f8a30", "url": "https://github.com/pravega/pravega/commit/12b7a1f1c503f9d7c0b382f51e29ab84155f8a30", "message": "Merge branch 'master' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-16T21:03:23Z", "type": "commit"}, {"oid": "473968ce1cb5d8d4a15ca524f3e11a4fdbf723ea", "url": "https://github.com/pravega/pravega/commit/473968ce1cb5d8d4a15ca524f3e11a4fdbf723ea", "message": "Refactor generic filesystem operation out of BookKeeperServiceRunner.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-17T21:09:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMDcwNg==", "url": "https://github.com/pravega/pravega/pull/5179#discussion_r490600706", "bodyText": "This change is due to the unfortunate reality of pleasing code coverage. A way was required to (platform independently) test for a failure scenario. The previous solution had several problems which made this difficult:\n\nThe visibility of cleanupDirectories and other BookKeeperServiceRunner fields made it hard to unit test cleanupDirectories at all in the first place (without affecting the state of the service, and therefore other tests).\nUnit testing cleanupDirectories within any other the BookKeeper* tests seems very forced and unnatural.\nForcing an IOException to be thrown (across platforms) is also quite difficult -- it is much easier to force an IllegalArgumentException.\nWe still need some way to determine whether or not an exception was thrown. Previously the exception was only caught and logged.\n\nAt the expensive of creating two small classes, this avoids the above problems.", "author": "co-jo", "createdAt": "2020-09-17T22:39:04Z", "path": "common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.common.io.filesystem;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.io.FileUtils;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+\n+@Slf4j\n+public class FileOperations {\n+\n+    public static boolean cleanupDirectories(HashMap<?, File> toDelete) {\n+        for (File dir : toDelete.values()) {", "originalCommit": "473968ce1cb5d8d4a15ca524f3e11a4fdbf723ea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1fb7c47e326b41a5d7827bccc7f4ea1acca2b569", "chunk": "diff --git a/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java b/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\nindex df011ea0e5..62ae518ad1 100644\n--- a/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\n+++ b/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\n\n@@ -26,7 +26,6 @@ public class FileOperations {\n                 return false;\n             }\n         }\n-        toDelete.clear();\n         return true;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEyNTUxMQ==", "url": "https://github.com/pravega/pravega/pull/5179#discussion_r492125511", "bodyText": "Why do you do this? This will modify the HashMap that you are being given, so you caller may have a nasty surprise after invoking this method?\nI don't think this is needed. If the caller wants to clear, they can do it after invoking this method.", "author": "andreipaduroiu", "createdAt": "2020-09-21T15:05:23Z", "path": "common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.common.io.filesystem;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.io.FileUtils;\n+\n+import java.io.File;\n+import java.util.HashMap;\n+\n+@Slf4j\n+public class FileOperations {\n+\n+    public static boolean cleanupDirectories(HashMap<?, File> toDelete) {\n+        for (File dir : toDelete.values()) {\n+            log.info(\"Cleaning up \" + dir);\n+            if (!FileUtils.deleteQuietly(dir)) {\n+                log.info(\"Failed deleting directory: {}\", dir);\n+                return false;\n+            }\n+        }\n+        toDelete.clear();", "originalCommit": "473968ce1cb5d8d4a15ca524f3e11a4fdbf723ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0NDM4Mg==", "url": "https://github.com/pravega/pravega/pull/5179#discussion_r492244382", "bodyText": "Why do you do this? This will modify the HashMap that you are being given, so you caller may have a nasty surprise after invoking this method?\nI don't think this is needed. If the caller wants to clear, they can do it after invoking this method.\n\nThis was part of the original method so I just kept it. Will remove.", "author": "co-jo", "createdAt": "2020-09-21T17:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEyNTUxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1fb7c47e326b41a5d7827bccc7f4ea1acca2b569", "chunk": "diff --git a/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java b/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\nindex df011ea0e5..62ae518ad1 100644\n--- a/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\n+++ b/common/src/main/java/io/pravega/common/io/filesystem/FileOperations.java\n\n@@ -26,7 +26,6 @@ public class FileOperations {\n                 return false;\n             }\n         }\n-        toDelete.clear();\n         return true;\n     }\n \n"}}, {"oid": "1fb7c47e326b41a5d7827bccc7f4ea1acca2b569", "url": "https://github.com/pravega/pravega/commit/1fb7c47e326b41a5d7827bccc7f4ea1acca2b569", "message": "Remove clearing of HashMap.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-21T17:57:40Z", "type": "commit"}, {"oid": "8f2cbbb6a721d9417983a97a0ce895b2727470b9", "url": "https://github.com/pravega/pravega/commit/8f2cbbb6a721d9417983a97a0ce895b2727470b9", "message": "Update test to account for removal of HashMap clearing.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-21T17:58:36Z", "type": "commit"}, {"oid": "822a2f6b9c391d0486561f994bc314ada9c5986c", "url": "https://github.com/pravega/pravega/commit/822a2f6b9c391d0486561f994bc314ada9c5986c", "message": "Revert unexpectedly committed changes.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-21T18:04:15Z", "type": "commit"}, {"oid": "f65cc6c6e24bbbae5bc7038cf34366d756f4f2b0", "url": "https://github.com/pravega/pravega/commit/f65cc6c6e24bbbae5bc7038cf34366d756f4f2b0", "message": "Revert to previous indentation.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>", "committedDate": "2020-09-21T18:07:32Z", "type": "commit"}, {"oid": "13a75f39d1218ddb561b3b6c8756adda2065cb25", "url": "https://github.com/pravega/pravega/commit/13a75f39d1218ddb561b3b6c8756adda2065cb25", "message": "Merge branch 'master' into issue-5122-improving-windows-compatibility", "committedDate": "2020-09-21T21:05:46Z", "type": "commit"}]}