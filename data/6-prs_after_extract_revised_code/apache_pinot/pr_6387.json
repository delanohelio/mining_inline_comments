{"pr_number": 6387, "pr_title": "Allow multiple H3 index resolutions", "pr_createdAt": "2020-12-26T17:24:19Z", "pr_url": "https://github.com/apache/pinot/pull/6387", "timeline": [{"oid": "62dc8902b0d8848a960b9d3c01fc4f7eb8438638", "url": "https://github.com/apache/pinot/commit/62dc8902b0d8848a960b9d3c01fc4f7eb8438638", "message": "local change", "committedDate": "2020-12-24T06:43:29Z", "type": "commit"}, {"oid": "6a2b8f5d42e8de612d1226ea824ab01e713ac8cd", "url": "https://github.com/apache/pinot/commit/6a2b8f5d42e8de612d1226ea824ab01e713ac8cd", "message": "Update the h3 index creation to write the resolution(s)", "committedDate": "2020-12-26T17:19:09Z", "type": "commit"}, {"oid": "af8fa078d7f99b561ec21cc284a21a463cdf47a8", "url": "https://github.com/apache/pinot/commit/af8fa078d7f99b561ec21cc284a21a463cdf47a8", "message": "temp change", "committedDate": "2020-12-26T17:24:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzI3OQ==", "url": "https://github.com/apache/pinot/pull/6387#discussion_r549013279", "bodyText": "make it int", "author": "kishoreg", "createdAt": "2020-12-26T17:28:02Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexResolution.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apache.pinot.core.segment.creator.impl.geospatial;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+\n+/**\n+ * Stores the resolutions for an index. There are in total of H3 resolutions https://h3geo.org/#/documentation/core-library/resolution-table\n+ * To efficiently serialize the resolutions, we use two bytes for encoding th enabled resolutions. The resolution level\n+ * maps to the corresponding bit.\n+ */\n+public class H3IndexResolution {\n+  private short _resolutions;\n+\n+  public H3IndexResolution(List<Integer> resolutions) {\n+    for (int resolution : resolutions) {\n+      _resolutions |= 1 << resolution;\n+    }\n+  }\n+\n+  /**\n+   * Creates the resolutions with the serialized short value\n+   * @param resolutions\n+   */\n+  public H3IndexResolution(short resolutions) {\n+    _resolutions = resolutions;\n+  }\n+\n+  /**\n+   * @return the encoding of the resolutions into a short value (two bytes)\n+   */\n+  public short serialize() {", "originalCommit": "af8fa078d7f99b561ec21cc284a21a463cdf47a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzMyMw==", "url": "https://github.com/apache/pinot/pull/6387#discussion_r549013323", "bodyText": "use INT", "author": "kishoreg", "createdAt": "2020-12-26T17:28:26Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexResolution.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package org.apache.pinot.core.segment.creator.impl.geospatial;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+\n+/**\n+ * Stores the resolutions for an index. There are in total of H3 resolutions https://h3geo.org/#/documentation/core-library/resolution-table\n+ * To efficiently serialize the resolutions, we use two bytes for encoding th enabled resolutions. The resolution level\n+ * maps to the corresponding bit.\n+ */\n+public class H3IndexResolution {\n+  private short _resolutions;", "originalCommit": "af8fa078d7f99b561ec21cc284a21a463cdf47a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzc1NQ==", "url": "https://github.com/apache/pinot/pull/6387#discussion_r549013755", "bodyText": "I feel short is easier since all resolutions can be represented in two bytes, so I don't have to reason about the first leftmost two bytes.", "author": "yupeng9", "createdAt": "2020-12-26T17:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzMyMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzM3Mg==", "url": "https://github.com/apache/pinot/pull/6387#discussion_r549013372", "bodyText": "why size, we should write the serialized INT right?", "author": "kishoreg", "createdAt": "2020-12-26T17:29:09Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexCreator.java", "diffHunk": "@@ -172,6 +175,7 @@ public void seal()\n     //write header file\n     headerStream.writeInt(VERSION);\n     headerStream.writeInt(writer.getNumUniqueIds());\n+    headerStream.writeShort(_resolution.size());", "originalCommit": "af8fa078d7f99b561ec21cc284a21a463cdf47a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzgyMA==", "url": "https://github.com/apache/pinot/pull/6387#discussion_r549013820", "bodyText": "Good catch", "author": "yupeng9", "createdAt": "2020-12-26T17:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTAxMzM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "099da9e1289257095af8cb70989717d80ba10776", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexCreator.java b/pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexCreator.java\nindex b1994c5fd3..46f1eb000b 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexCreator.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/geospatial/H3IndexCreator.java\n\n@@ -175,7 +175,7 @@ public class H3IndexCreator implements GeoSpatialIndexCreator {\n     //write header file\n     headerStream.writeInt(VERSION);\n     headerStream.writeInt(writer.getNumUniqueIds());\n-    headerStream.writeShort(_resolution.size());\n+    headerStream.writeShort(_resolution.serialize());\n     headerStream.close();\n     dictionaryStream.close();\n     offsetStream.close();\n"}}, {"oid": "099da9e1289257095af8cb70989717d80ba10776", "url": "https://github.com/apache/pinot/commit/099da9e1289257095af8cb70989717d80ba10776", "message": "bug fix", "committedDate": "2020-12-26T17:33:31Z", "type": "commit"}]}