{"pr_number": 5503, "pr_title": "Config for raw index writer version", "pr_createdAt": "2020-06-05T21:10:22Z", "pr_url": "https://github.com/apache/pinot/pull/5503", "timeline": [{"oid": "e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "url": "https://github.com/apache/pinot/commit/e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "message": "In PR https://github.com/apache/incubator-pinot/pull/5285,\nthe raw index writer format was changed to use 8 byte offset\nfor each chunk in the file header. The writer version\nwas bumped to 3. This was done to support > 2GB indexes.\nThe change was backward compatible to continue the support\nfor reading existing/old segments using 4-byte offsets\n\nWhile there is no problem with the change, it prevents rollback.\nSo if there is any orthogonal issue while rolling out a release,\nwe can't rollback to older Pinot release since segments already\ngenerated with 8-byte offsets can't be read by old code.\n\nThis config option is temporary to help with internal roll-out\nby keeping the 8-byte format disabled by default thus allowing\nrollback due to any issues. In the next couple of weeks after\ninternal rollout, we plan to remove this option.", "committedDate": "2020-06-05T20:38:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MTk3OA==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436181978", "bodyText": "Why are we changing this? This is backward-incompatible change right?", "author": "Jackie-Jiang", "createdAt": "2020-06-05T21:57:32Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/FieldConfig.java", "diffHunk": "@@ -33,15 +33,16 @@\n   private final IndexType _indexType;\n   private final Map<String, String> _properties;\n \n-  public static String BLOOM_FILTER_COLUMN_KEY = \"bloom.filter\";", "originalCommit": "e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5NzYwMQ==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436197601", "bodyText": "I haven't yet done the migration from IndexingConfig to FieldConfig. It is only being used for text. So this change doesn't affect anyone. Just wanted to clean up names and remove the dotted notation. Going to migrate to FieldConfig soon", "author": "siddharthteotia", "createdAt": "2020-06-05T22:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE4MTk3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2Njc3MA==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436166770", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final int DEFAULT_VERSION = 2;\n          \n          \n            \n              public static final int DEFAULT_WRITER_VERSION = 2;", "author": "mcvsubbu", "createdAt": "2020-06-05T21:13:11Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java", "diffHunk": "@@ -36,6 +37,9 @@\n  * Base class for fixed and variable byte writer implementations.\n  */\n public abstract class BaseChunkSingleValueWriter implements SingleColumnSingleValueWriter {\n+  public static final int DEFAULT_VERSION = 2;", "originalCommit": "e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MjkzNA==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436192934", "bodyText": "Maybe add a TODO or create an issue to remove this before 0.5.0 and put a pointer here to the issue?", "author": "mcvsubbu", "createdAt": "2020-06-05T22:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2Njc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDc2Mg==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436200762", "bodyText": "done", "author": "siddharthteotia", "createdAt": "2020-06-05T23:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2Njc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "45402fd75b84fc4a9017805fdc435cef634d9804", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\nindex 5b64696b2..c51a46586 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\n\n@@ -37,6 +37,7 @@ import org.slf4j.LoggerFactory;\n  * Base class for fixed and variable byte writer implementations.\n  */\n public abstract class BaseChunkSingleValueWriter implements SingleColumnSingleValueWriter {\n+  // TODO: Remove this before release 0.5.0\n   public static final int DEFAULT_VERSION = 2;\n   public static final int CURRENT_VERSION = 3;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MzA1NA==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436193054", "bodyText": "this comment may not hold in the long term, so just leave it as is", "author": "mcvsubbu", "createdAt": "2020-06-05T22:32:28Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java", "diffHunk": "@@ -60,12 +64,13 @@\n    * @param numDocsPerChunk Number of docs per data chunk\n    * @param chunkSize Size of chunk\n    * @param sizeOfEntry Size of entry (in bytes), max size for variable byte implementation.\n-   * @param version Version of file\n+   * @param version format version used to determine whether to use 8 or 4 byte chunk offsets", "originalCommit": "e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDcxOQ==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436200719", "bodyText": "done", "author": "siddharthteotia", "createdAt": "2020-06-05T23:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MzA1NA=="}], "type": "inlineReview", "revised_code": {"commit": "45402fd75b84fc4a9017805fdc435cef634d9804", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\nindex 5b64696b2..c51a46586 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/BaseChunkSingleValueWriter.java\n\n@@ -64,7 +65,7 @@ public abstract class BaseChunkSingleValueWriter implements SingleColumnSingleVa\n    * @param numDocsPerChunk Number of docs per data chunk\n    * @param chunkSize Size of chunk\n    * @param sizeOfEntry Size of entry (in bytes), max size for variable byte implementation.\n-   * @param version format version used to determine whether to use 8 or 4 byte chunk offsets\n+   * @param version version of File\n    * @throws FileNotFoundException\n    */\n   protected BaseChunkSingleValueWriter(File file, ChunkCompressorFactory.CompressionType compressionType, int totalDocs,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MzA5NQ==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436193095", "bodyText": "same", "author": "mcvsubbu", "createdAt": "2020-06-05T22:32:39Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/FixedByteChunkSingleValueWriter.java", "diffHunk": "@@ -64,15 +62,15 @@\n    * @param compressionType Type of compression to use.\n    * @param totalDocs Total number of docs to write.\n    * @param numDocsPerChunk Number of documents per chunk.\n-   * @param sizeOfEntry Size of entry (in bytes).\n+   * @param sizeOfEntry Size of entry (in bytes)\n+   * @param writerVersion writer version used to determine whether to use 8 or 4 byte chunk offsets", "originalCommit": "e51d7e3e74b7cabd0b0c27df9692e3ee75554843", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMDcyNQ==", "url": "https://github.com/apache/pinot/pull/5503#discussion_r436200725", "bodyText": "done", "author": "siddharthteotia", "createdAt": "2020-06-05T23:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE5MzA5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "45402fd75b84fc4a9017805fdc435cef634d9804", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/FixedByteChunkSingleValueWriter.java b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/FixedByteChunkSingleValueWriter.java\nindex 9ea9f0d28..7c83af85d 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/FixedByteChunkSingleValueWriter.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/io/writer/impl/v1/FixedByteChunkSingleValueWriter.java\n\n@@ -63,7 +63,7 @@ public class FixedByteChunkSingleValueWriter extends BaseChunkSingleValueWriter\n    * @param totalDocs Total number of docs to write.\n    * @param numDocsPerChunk Number of documents per chunk.\n    * @param sizeOfEntry Size of entry (in bytes)\n-   * @param writerVersion writer version used to determine whether to use 8 or 4 byte chunk offsets\n+   * @param writerVersion writer format version\n    * @throws FileNotFoundException Throws {@link FileNotFoundException} if the specified file is not found.\n    */\n   public FixedByteChunkSingleValueWriter(File file, ChunkCompressorFactory.CompressionType compressionType,\n"}}, {"oid": "45402fd75b84fc4a9017805fdc435cef634d9804", "url": "https://github.com/apache/pinot/commit/45402fd75b84fc4a9017805fdc435cef634d9804", "message": "address review comments", "committedDate": "2020-06-06T07:22:05Z", "type": "commit"}]}