{"pr_number": 5092, "pr_title": "Minor improvement for RoutingManager", "pr_createdAt": "2020-02-24T23:33:39Z", "pr_url": "https://github.com/apache/pinot/pull/5092", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NDE4NA==", "url": "https://github.com/apache/pinot/pull/5092#discussion_r383584184", "bodyText": "It is not intuitive from this message as to how many tables the routing table was updated for? Is tablesToUpdate.size() this number?\nMay be we should make \"update N routing entries\" to \"update N routing table entries for M tables\".", "author": "siddharthteotia", "createdAt": "2020-02-24T23:55:50Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java", "diffHunk": "@@ -131,44 +131,42 @@ private void processExternalViewChange() {\n     Stat[] stats = _zkDataAccessor.getStats(externalViewPaths, AccessOption.PERSISTENT);\n     long fetchStatsEndTimeMs = System.currentTimeMillis();\n \n-    int numRoutingEntriesToUpdate = 0;\n+    List<String> tablesToUpdate = new ArrayList<>();\n     for (int i = 0; i < numTables; i++) {\n       Stat stat = stats[i];\n       if (stat != null) {\n         RoutingEntry routingEntry = routingEntries.get(i);\n         if (stat.getVersion() != routingEntry.getLastUpdateExternalViewVersion()) {\n-          numRoutingEntriesToUpdate++;\n+          String tableNameWithType = routingEntry.getTableNameWithType();\n+          tablesToUpdate.add(tableNameWithType);\n           try {\n-            updateRoutingEntryOnExternalViewChange(routingEntry);\n+            ExternalView externalView = getExternalView(tableNameWithType);\n+            if (externalView == null) {\n+              LOGGER.warn(\"Failed to find external view for table: {}, skipping updating routing entry\",\n+                  tableNameWithType);\n+              continue;\n+            }\n+            Set<String> onlineSegments = getOnlineSegments(tableNameWithType);\n+            if (onlineSegments == null) {\n+              LOGGER\n+                  .warn(\"Failed to find ideal state for table: {}, skipping updating routing entry\", tableNameWithType);\n+              continue;\n+            }\n+            routingEntry.onExternalViewChange(externalView, onlineSegments);\n           } catch (Exception e) {\n             LOGGER\n                 .error(\"Caught unexpected exception while updating routing entry on external view change for table: {}\",\n-                    routingEntry.getTableNameWithType(), e);\n+                    tableNameWithType, e);\n           }\n         }\n       }\n     }\n     long updateRoutingEntriesEndTimeMs = System.currentTimeMillis();\n \n     LOGGER.info(\n-        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries: {}ms)\",\n+        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries ({}): {}ms)\",", "originalCommit": "01f755eecfcfe82db01e6d8d41972ac475660bc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NzEzNw==", "url": "https://github.com/apache/pinot/pull/5092#discussion_r383587137", "bodyText": "Changed it to ..., update routing entry for 2 tables ([foo_OFFLINE, bar_REALTIME]): 5ms", "author": "Jackie-Jiang", "createdAt": "2020-02-25T00:05:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU4NDE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "chunk": "diff --git a/pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java b/pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java\nindex cbcc73f577..af1a349a00 100644\n--- a/pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java\n+++ b/pinot-broker/src/main/java/org/apache/pinot/broker/routing/v2/RoutingManager.java\n\n@@ -164,7 +164,7 @@ public class RoutingManager implements ClusterChangeHandler {\n     long updateRoutingEntriesEndTimeMs = System.currentTimeMillis();\n \n     LOGGER.info(\n-        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update {} routing entries ({}): {}ms)\",\n+        \"Processed external view change in {}ms (fetch {} external view stats: {}ms, update routing entry for {} tables ({}): {}ms)\",\n         updateRoutingEntriesEndTimeMs - startTimeMs, numTables, fetchStatsEndTimeMs - startTimeMs,\n         tablesToUpdate.size(), tablesToUpdate, updateRoutingEntriesEndTimeMs - fetchStatsEndTimeMs);\n   }\n"}}, {"oid": "c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "url": "https://github.com/apache/pinot/commit/c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "message": "Minor improvement for RoutingManager\n\n- For external view change, log the changed tables\n- For instance config change, skip the routing update when no instance is changed", "committedDate": "2020-02-25T00:05:41Z", "type": "commit"}, {"oid": "c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "url": "https://github.com/apache/pinot/commit/c79e6d1e12f195dfa83961ba566ece8bfb9d19cf", "message": "Minor improvement for RoutingManager\n\n- For external view change, log the changed tables\n- For instance config change, skip the routing update when no instance is changed", "committedDate": "2020-02-25T00:05:41Z", "type": "forcePushed"}]}