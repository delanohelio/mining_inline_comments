{"pr_number": 5858, "pr_title": "Change group key delimiter from '\\t' to '\\0'", "pr_createdAt": "2020-08-13T07:24:07Z", "pr_url": "https://github.com/apache/pinot/pull/5858", "timeline": [{"oid": "4525626eaeb131b022ce52e9b2d3d4042e6a62aa", "url": "https://github.com/apache/pinot/commit/4525626eaeb131b022ce52e9b2d3d4042e6a62aa", "message": "Change group key delimiter from '\\t' to '\\0'", "committedDate": "2020-08-14T00:20:09Z", "type": "forcePushed"}, {"oid": "4d0cee95c979022838471b82b4d28d3da17b2f1e", "url": "https://github.com/apache/pinot/commit/4d0cee95c979022838471b82b4d28d3da17b2f1e", "message": "Change group key delimiter from '\\t' to '\\0'", "committedDate": "2020-08-14T00:24:57Z", "type": "forcePushed"}, {"oid": "1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "url": "https://github.com/apache/pinot/commit/1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "message": "Change group key delimiter from '\\t' to '\\0'", "committedDate": "2020-08-17T19:47:13Z", "type": "commit"}, {"oid": "1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "url": "https://github.com/apache/pinot/commit/1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "message": "Change group key delimiter from '\\t' to '\\0'", "committedDate": "2020-08-17T19:47:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMTY2Ng==", "url": "https://github.com/apache/pinot/pull/5858#discussion_r471831666", "bodyText": "why we separate single groupby ? for performance ?", "author": "xiangfu0", "createdAt": "2020-08-17T23:37:37Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/combine/GroupByOrderByCombineOperator.java", "diffHunk": "@@ -155,33 +155,53 @@ public void runJob() {\n             // Merge aggregation group-by result.\n             AggregationGroupByResult aggregationGroupByResult = intermediateResultsBlock.getAggregationGroupByResult();\n             if (aggregationGroupByResult != null) {\n-              // Get converter functions\n-              Function[] converterFunctions = new Function[numGroupByExpressions];\n-              for (int i = 0; i < numGroupByExpressions; i++) {\n-                converterFunctions[i] = getConverterFunction(_dataSchema.getColumnDataType(i));\n-              }\n+              if (numGroupByExpressions == 1) {", "originalCommit": "1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzNTYwNw==", "url": "https://github.com/apache/pinot/pull/5858#discussion_r471835607", "bodyText": "Yes. For single group-by, we don't need to split the string for each group key", "author": "Jackie-Jiang", "createdAt": "2020-08-17T23:51:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMTY2Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMTk3Mw==", "url": "https://github.com/apache/pinot/pull/5858#discussion_r471831973", "bodyText": "shall we stick to Preconditions.checkArgument?", "author": "xiangfu0", "createdAt": "2020-08-17T23:38:46Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/groupby/AggregationGroupByTrimmingService.java", "diffHunk": "@@ -29,34 +28,39 @@\n import java.util.Map;\n import java.util.PriorityQueue;\n import java.util.TreeMap;\n-import javax.annotation.Nonnull;\n import org.apache.commons.collections.comparators.ComparableComparator;\n+import org.apache.commons.lang3.StringUtils;\n import org.apache.commons.lang3.tuple.ImmutablePair;\n import org.apache.pinot.common.response.broker.GroupByResult;\n import org.apache.pinot.core.query.aggregation.function.AggregationFunction;\n import org.apache.pinot.core.query.aggregation.function.AggregationFunctionUtils;\n import org.apache.pinot.core.query.aggregation.function.MinAggregationFunction;\n+import org.apache.pinot.core.query.request.context.ExpressionContext;\n+import org.apache.pinot.core.query.request.context.QueryContext;\n import org.apache.pinot.core.util.GroupByUtils;\n \n \n /**\n  * The <code>AggregationGroupByTrimmingService</code> class provides trimming service for aggregation group-by queries.\n  */\n+@SuppressWarnings({\"rawtypes\", \"unchecked\"})\n public class AggregationGroupByTrimmingService {\n-\n   private final AggregationFunction[] _aggregationFunctions;\n-  private final int _groupByTopN;\n+  private final int _numGroupByExpressions;\n+  private final int _limit;\n   private final int _trimSize;\n   private final int _trimThreshold;\n \n-  public AggregationGroupByTrimmingService(@Nonnull AggregationFunction[] aggregationFunctions, int groupByTopN) {\n-    Preconditions.checkArgument(groupByTopN > 0);\n-\n-    _aggregationFunctions = aggregationFunctions;\n-    _groupByTopN = groupByTopN;\n+  public AggregationGroupByTrimmingService(QueryContext queryContext) {\n+    _aggregationFunctions = queryContext.getAggregationFunctions();\n+    List<ExpressionContext> groupByExpressions = queryContext.getGroupByExpressions();\n+    assert groupByExpressions != null;", "originalCommit": "1d6266c6d6d3f36c8d4da287404e6a13c41164a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzODQ4OA==", "url": "https://github.com/apache/pinot/pull/5858#discussion_r471838488", "bodyText": "I usually use assert to indicate that it is not possible to be null for readability, which will be ignored in production environment.\nPreconditions are used for catching the illegal user input and throw exceptions", "author": "Jackie-Jiang", "createdAt": "2020-08-18T00:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgzMTk3Mw=="}], "type": "inlineReview", "revised_code": null}]}