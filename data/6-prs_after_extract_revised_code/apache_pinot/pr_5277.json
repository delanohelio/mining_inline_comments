{"pr_number": 5277, "pr_title": "[Part 2] Deepstore by-pass in LLC: introduce segment uploader for segment split commit.", "pr_createdAt": "2020-04-20T16:44:34Z", "pr_url": "https://github.com/apache/pinot/pull/5277", "timeline": [{"oid": "e160ffa1b5f6b906d854555dddffb286eddbf04d", "url": "https://github.com/apache/pinot/commit/e160ffa1b5f6b906d854555dddffb286eddbf04d", "message": "Introduce the concept of segment uploader and refactor the server LLC logic to use a configurable segment uploader in SegmentCommitter.", "committedDate": "2020-04-17T22:15:37Z", "type": "commit"}, {"oid": "d8de830493ea1d75200fdcc15e069be40fea270c", "url": "https://github.com/apache/pinot/commit/d8de830493ea1d75200fdcc15e069be40fea270c", "message": "Add a new segment uploader.", "committedDate": "2020-04-17T22:16:53Z", "type": "commit"}, {"oid": "17db52c4e4141dfbac5be891edaa1552cd8ab54f", "url": "https://github.com/apache/pinot/commit/17db52c4e4141dfbac5be891edaa1552cd8ab54f", "message": "Revert merge errors.", "committedDate": "2020-04-18T00:08:44Z", "type": "commit"}, {"oid": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "url": "https://github.com/apache/pinot/commit/6d8352ffb71157000c02bf9098167a95d3bcc5b3", "message": "Delete the BestEffortSegmentUploader for now.", "committedDate": "2020-04-20T16:38:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NTk4MA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411585980", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              SegmentUploadStatus segmentUpload(File segmentFile);\n          \n          \n            \n              SegmentUploadStatus uploadSegment(File segmentFile);", "author": "mcvsubbu", "createdAt": "2020-04-20T18:09:33Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+\n+\n+public interface SegmentUploader {\n+  SegmentUploadStatus segmentUpload(File segmentFile);", "originalCommit": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NjkzMA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411586930", "bodyText": "why not just return the URL here?", "author": "mcvsubbu", "createdAt": "2020-04-20T18:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NTk4MA=="}], "type": "inlineReview", "revised_code": {"commit": "703120214919ffb03614d5aaf0a13c7eb9436f79", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\nindex b1db4c4b04..d294272056 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\n\n@@ -22,5 +22,5 @@ import java.io.File;\n \n \n public interface SegmentUploader {\n-  SegmentUploadStatus segmentUpload(File segmentFile);\n+  SegmentUploadStatus uploadSegment(File segmentFile);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NjMzMQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411586331", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean uploadSuccessful;\n          \n          \n            \n              private boolean _uploadSuccessful;", "author": "mcvsubbu", "createdAt": "2020-04-20T18:10:10Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+public class SegmentUploadStatus {\n+  // True if and only if the upload is successful.\n+  private boolean uploadSuccessful;", "originalCommit": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "30830a9dd802775145629e754d8156621161d5a1", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\ndeleted file mode 100644\nindex 799ab2248e..0000000000\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\n+++ /dev/null\n\n@@ -1,47 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pinot.core.data.manager.realtime;\n-\n-public class SegmentUploadStatus {\n-  // True if and only if the upload is successful.\n-  private boolean uploadSuccessful;\n-  // Segment location uri string when the upload is successful.\n-  private String segmentLocation;\n-\n-  public SegmentUploadStatus(boolean uploadSuccessful, String segmentLocation) {\n-    this.uploadSuccessful = uploadSuccessful;\n-    this.segmentLocation = segmentLocation;\n-  }\n-\n-  public boolean isUploadSuccessful() {\n-    return uploadSuccessful;\n-  }\n-\n-  public void setUploadSuccessful(boolean uploadSuccessful) {\n-    this.uploadSuccessful = uploadSuccessful;\n-  }\n-\n-  public String getSegmentLocation() {\n-    return segmentLocation;\n-  }\n-\n-  public void setSegmentLocation(String segmentLocation) {\n-    this.segmentLocation = segmentLocation;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU4NjQ5OQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411586499", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String segmentLocation;\n          \n          \n            \n              private String _segmentLocation;", "author": "mcvsubbu", "createdAt": "2020-04-20T18:10:26Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+public class SegmentUploadStatus {\n+  // True if and only if the upload is successful.\n+  private boolean uploadSuccessful;\n+  // Segment location uri string when the upload is successful.\n+  private String segmentLocation;", "originalCommit": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "30830a9dd802775145629e754d8156621161d5a1", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\ndeleted file mode 100644\nindex 799ab2248e..0000000000\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\n+++ /dev/null\n\n@@ -1,47 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pinot.core.data.manager.realtime;\n-\n-public class SegmentUploadStatus {\n-  // True if and only if the upload is successful.\n-  private boolean uploadSuccessful;\n-  // Segment location uri string when the upload is successful.\n-  private String segmentLocation;\n-\n-  public SegmentUploadStatus(boolean uploadSuccessful, String segmentLocation) {\n-    this.uploadSuccessful = uploadSuccessful;\n-    this.segmentLocation = segmentLocation;\n-  }\n-\n-  public boolean isUploadSuccessful() {\n-    return uploadSuccessful;\n-  }\n-\n-  public void setUploadSuccessful(boolean uploadSuccessful) {\n-    this.uploadSuccessful = uploadSuccessful;\n-  }\n-\n-  public String getSegmentLocation() {\n-    return segmentLocation;\n-  }\n-\n-  public void setSegmentLocation(String segmentLocation) {\n-    this.segmentLocation = segmentLocation;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTc3OQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411591779", "bodyText": "you should not be using the protocol handler here. Instead, you need to introduce a method to upload the segment to contrller vip. Copy/paste protocolHandler.uploadSegment. Refactor the protocol handler to use this method.", "author": "mcvsubbu", "createdAt": "2020-04-20T18:19:04Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.server.realtime.ServerSegmentCompletionProtocolHandler;\n+import org.slf4j.Logger;\n+\n+\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n+// point.\n+public class ControllerVipBasedSegmentUploader implements SegmentUploader {\n+  private final SegmentCompletionProtocol.Request.Params _params;\n+  private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n+  private final Logger _segmentLogger;\n+  private final String _controllerVipUrl;\n+\n+  public ControllerVipBasedSegmentUploader(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n+      SegmentCompletionProtocol.Request.Params params, String controllerVipUrl) {\n+    _segmentLogger = segmentLogger;\n+    _protocolHandler = protocolHandler;\n+    _params = params;\n+    _controllerVipUrl = controllerVipUrl;\n+  }\n+\n+  @Override\n+  public SegmentUploadStatus segmentUpload(File segmentFile) {\n+    SegmentCompletionProtocol.Response segmentCommitUploadResponse =\n+        _protocolHandler.segmentCommitUpload(_params, segmentFile, _controllerVipUrl);", "originalCommit": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU5MjI2MQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r412592261", "bodyText": "Done the refactoring. Please take a look.", "author": "chenboat", "createdAt": "2020-04-22T00:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MTc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "30830a9dd802775145629e754d8156621161d5a1", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\nindex 9e7dfaee84..fd21d820af 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\n\n@@ -19,36 +19,47 @@\n package org.apache.pinot.core.data.manager.realtime;\n \n import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.server.realtime.ServerSegmentCompletionProtocolHandler;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n import org.slf4j.Logger;\n \n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n+\n \n // A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n // point.\n public class ControllerVipBasedSegmentUploader implements SegmentUploader {\n-  private final SegmentCompletionProtocol.Request.Params _params;\n-  private final ServerSegmentCompletionProtocolHandler _protocolHandler;\n   private final Logger _segmentLogger;\n   private final String _controllerVipUrl;\n+  private final FileUploadDownloadClient _fileUploadDownloadClient;\n+  private final String _segmentName;\n+  private final int _segmentUploadRequestTimeoutMs;\n+  private final ServerMetrics _serverMetrics;\n \n-  public ControllerVipBasedSegmentUploader(Logger segmentLogger, ServerSegmentCompletionProtocolHandler protocolHandler,\n-      SegmentCompletionProtocol.Request.Params params, String controllerVipUrl) {\n+  public ControllerVipBasedSegmentUploader(Logger segmentLogger, FileUploadDownloadClient fileUploadDownloadClient,\n+      String controllerVipUrl, String segmentName, int segmentUploadRequestTimeoutMs, ServerMetrics serverMetrics) {\n     _segmentLogger = segmentLogger;\n-    _protocolHandler = protocolHandler;\n-    _params = params;\n+    _fileUploadDownloadClient = fileUploadDownloadClient;\n     _controllerVipUrl = controllerVipUrl;\n+    _segmentName = segmentName;\n+    _segmentUploadRequestTimeoutMs = segmentUploadRequestTimeoutMs;\n+    _serverMetrics = serverMetrics;\n   }\n \n   @Override\n-  public SegmentUploadStatus segmentUpload(File segmentFile) {\n-    SegmentCompletionProtocol.Response segmentCommitUploadResponse =\n-        _protocolHandler.segmentCommitUpload(_params, segmentFile, _controllerVipUrl);\n-    if (!segmentCommitUploadResponse.getStatus()\n-        .equals(SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS)) {\n-      _segmentLogger.warn(\"Segment upload failed with response {}\", segmentCommitUploadResponse.toJsonString());\n-      return new SegmentUploadStatus(false, null);\n+  public URI uploadSegment(File segmentFile)\n+      throws URISyntaxException {\n+    SegmentCompletionProtocol.Response response = SegmentCompletionProtocolUtils\n+        .uploadSegmentWithFileUploadDownloadClient(_fileUploadDownloadClient, segmentFile, _controllerVipUrl,\n+            _segmentName, _segmentUploadRequestTimeoutMs, _segmentLogger);\n+    SegmentCompletionProtocolUtils.raiseSegmentCompletionProtocolResponseMetric(_serverMetrics, response);\n+    if (response.getStatus() == UPLOAD_SUCCESS) {\n+      return new URI(response.getSegmentLocation());\n     }\n-    return new SegmentUploadStatus(true, segmentCommitUploadResponse.getSegmentLocation());\n+    return null;\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MzA1MA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r411593050", "bodyText": "You dont need this class. If return values turn out to be more complex, we can introduce a status class then", "author": "mcvsubbu", "createdAt": "2020-04-20T18:21:16Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+public class SegmentUploadStatus {", "originalCommit": "6d8352ffb71157000c02bf9098167a95d3bcc5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU5MjI5OQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r412592299", "bodyText": "Done.", "author": "chenboat", "createdAt": "2020-04-22T00:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU5MzA1MA=="}], "type": "inlineReview", "revised_code": {"commit": "30830a9dd802775145629e754d8156621161d5a1", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\ndeleted file mode 100644\nindex 799ab2248e..0000000000\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploadStatus.java\n+++ /dev/null\n\n@@ -1,47 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pinot.core.data.manager.realtime;\n-\n-public class SegmentUploadStatus {\n-  // True if and only if the upload is successful.\n-  private boolean uploadSuccessful;\n-  // Segment location uri string when the upload is successful.\n-  private String segmentLocation;\n-\n-  public SegmentUploadStatus(boolean uploadSuccessful, String segmentLocation) {\n-    this.uploadSuccessful = uploadSuccessful;\n-    this.segmentLocation = segmentLocation;\n-  }\n-\n-  public boolean isUploadSuccessful() {\n-    return uploadSuccessful;\n-  }\n-\n-  public void setUploadSuccessful(boolean uploadSuccessful) {\n-    this.uploadSuccessful = uploadSuccessful;\n-  }\n-\n-  public String getSegmentLocation() {\n-    return segmentLocation;\n-  }\n-\n-  public void setSegmentLocation(String segmentLocation) {\n-    this.segmentLocation = segmentLocation;\n-  }\n-}\n"}}, {"oid": "703120214919ffb03614d5aaf0a13c7eb9436f79", "url": "https://github.com/apache/pinot/commit/703120214919ffb03614d5aaf0a13c7eb9436f79", "message": "Update pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\n\nCo-Authored-By: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-04-21T04:52:07Z", "type": "commit"}, {"oid": "30830a9dd802775145629e754d8156621161d5a1", "url": "https://github.com/apache/pinot/commit/30830a9dd802775145629e754d8156621161d5a1", "message": "Refactoring the classes based on Subbu's suggestion.", "committedDate": "2020-04-22T00:57:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTAzNQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413185035", "bodyText": "Why does this throw URISyntax exception? We are providing a File handle, it does not seem correct to let the upper layer handle the URI syntax failure. The uploader, when constructed, should verify the URIs right?", "author": "mcvsubbu", "createdAt": "2020-04-22T17:40:46Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+\n+public interface SegmentUploader {\n+  // Returns the URI of the uploaded segment. null if the upload fails.\n+  URI uploadSegment(File segmentFile)\n+      throws URISyntaxException;", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNTYxMg==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414125612", "bodyText": "Removed the exception.", "author": "chenboat", "createdAt": "2020-04-23T21:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NTAzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\nindex 81c0ad2eb4..7cefdee130 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/SegmentUploader.java\n\n@@ -20,11 +20,9 @@ package org.apache.pinot.core.data.manager.realtime;\n \n import java.io.File;\n import java.net.URI;\n-import java.net.URISyntaxException;\n \n \n public interface SegmentUploader {\n   // Returns the URI of the uploaded segment. null if the upload fails.\n-  URI uploadSegment(File segmentFile)\n-      throws URISyntaxException;\n+  URI uploadSegment(File segmentFile);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NjYyOQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413186629", "bodyText": "can we just call this method uploadSegment? The file part is implied since the first argument is the FileUploadDownloadClient", "author": "mcvsubbu", "createdAt": "2020-04-22T17:42:57Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.util;\n+\n+import java.io.File;\n+import java.net.URI;\n+import org.apache.pinot.common.metrics.ServerMeter;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+\n+/**\n+ * Util methods related to low level consumers' segment completion protocols. \n+ */\n+public class SegmentCompletionProtocolUtils {\n+  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5NDMzNA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413194334", "bodyText": "Or, maybe just inline the logic of this method inside the uploader. The logic for  a different uploader is going to be different anyway.", "author": "mcvsubbu", "createdAt": "2020-04-22T17:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NjYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNTk2OQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414125969", "bodyText": "Moved the method inside uploader.", "author": "chenboat", "createdAt": "2020-04-23T21:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4NjYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\nindex c376b00ced..d8db29a086 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n\n@@ -18,48 +18,19 @@\n  */\n package org.apache.pinot.core.util;\n \n-import java.io.File;\n-import java.net.URI;\n import org.apache.pinot.common.metrics.ServerMeter;\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.common.utils.FileUploadDownloadClient;\n-import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n-import org.slf4j.Logger;\n \n \n /**\n  * Util methods related to low level consumers' segment completion protocols. \n  */\n public class SegmentCompletionProtocolUtils {\n-  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(\n-      FileUploadDownloadClient fileUploadDownloadClient, File segmentFile, String controllerVipUrl, String segmentName,\n-      int segmentUploadRequestTimeoutMs, Logger logger) {\n-    SegmentCompletionProtocol.Response response;\n-    try {\n-      String responseStr = fileUploadDownloadClient\n-          .uploadSegment(new URI(controllerVipUrl), segmentName, segmentFile, null, null, segmentUploadRequestTimeoutMs)\n-          .getResponse();\n-      response = SegmentCompletionProtocol.Response.fromJsonString(responseStr);\n-      logger.info(\"Controller response {} for {}\", response.toJsonString(), controllerVipUrl);\n-      if (response.getStatus().equals(SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER)) {\n-        ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-      }\n-    } catch (Exception e) {\n-      // Catch all exceptions, we want the protocol to handle the case assuming the request was never sent.\n-      response = SegmentCompletionProtocol.RESP_NOT_SENT;\n-      logger.error(\"Could not send request {}\", controllerVipUrl, e);\n-      // Invalidate controller leader cache, as exception could be because of leader being down (deployment/failure) and hence unable to send {@link SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER}\n-      // If cache is not invalidated, we will not recover from exceptions until the controller comes back up\n-      ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-    }\n-    return response;\n-  }\n-\n   /**\n    * raise a metric indicating the response we received from the controller\n    */\n-  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics, \n+  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics,\n       SegmentCompletionProtocol.Response response) {\n     switch (response.getStatus()) {\n       case NOT_SENT:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4ODI4Ng==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413188286", "bodyText": "Can this logic be moved into ControllerVipBasedSegmentUploader?", "author": "mcvsubbu", "createdAt": "2020-04-22T17:45:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.util;\n+\n+import java.io.File;\n+import java.net.URI;\n+import org.apache.pinot.common.metrics.ServerMeter;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+\n+/**\n+ * Util methods related to low level consumers' segment completion protocols. \n+ */\n+public class SegmentCompletionProtocolUtils {\n+  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(\n+      FileUploadDownloadClient fileUploadDownloadClient, File segmentFile, String controllerVipUrl, String segmentName,\n+      int segmentUploadRequestTimeoutMs, Logger logger) {\n+    SegmentCompletionProtocol.Response response;\n+    try {\n+      String responseStr = fileUploadDownloadClient\n+          .uploadSegment(new URI(controllerVipUrl), segmentName, segmentFile, null, null, segmentUploadRequestTimeoutMs)\n+          .getResponse();\n+      response = SegmentCompletionProtocol.Response.fromJsonString(responseStr);\n+      logger.info(\"Controller response {} for {}\", response.toJsonString(), controllerVipUrl);\n+      if (response.getStatus().equals(SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER)) {\n+        ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n+      }\n+    } catch (Exception e) {\n+      // Catch all exceptions, we want the protocol to handle the case assuming the request was never sent.\n+      response = SegmentCompletionProtocol.RESP_NOT_SENT;\n+      logger.error(\"Could not send request {}\", controllerVipUrl, e);\n+      // Invalidate controller leader cache, as exception could be because of leader being down (deployment/failure) and hence unable to send {@link SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER}\n+      // If cache is not invalidated, we will not recover from exceptions until the controller comes back up\n+      ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNjA1NA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414126054", "bodyText": "Done.", "author": "chenboat", "createdAt": "2020-04-23T21:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE4ODI4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\nindex c376b00ced..d8db29a086 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n\n@@ -18,48 +18,19 @@\n  */\n package org.apache.pinot.core.util;\n \n-import java.io.File;\n-import java.net.URI;\n import org.apache.pinot.common.metrics.ServerMeter;\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.common.utils.FileUploadDownloadClient;\n-import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n-import org.slf4j.Logger;\n \n \n /**\n  * Util methods related to low level consumers' segment completion protocols. \n  */\n public class SegmentCompletionProtocolUtils {\n-  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(\n-      FileUploadDownloadClient fileUploadDownloadClient, File segmentFile, String controllerVipUrl, String segmentName,\n-      int segmentUploadRequestTimeoutMs, Logger logger) {\n-    SegmentCompletionProtocol.Response response;\n-    try {\n-      String responseStr = fileUploadDownloadClient\n-          .uploadSegment(new URI(controllerVipUrl), segmentName, segmentFile, null, null, segmentUploadRequestTimeoutMs)\n-          .getResponse();\n-      response = SegmentCompletionProtocol.Response.fromJsonString(responseStr);\n-      logger.info(\"Controller response {} for {}\", response.toJsonString(), controllerVipUrl);\n-      if (response.getStatus().equals(SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER)) {\n-        ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-      }\n-    } catch (Exception e) {\n-      // Catch all exceptions, we want the protocol to handle the case assuming the request was never sent.\n-      response = SegmentCompletionProtocol.RESP_NOT_SENT;\n-      logger.error(\"Could not send request {}\", controllerVipUrl, e);\n-      // Invalidate controller leader cache, as exception could be because of leader being down (deployment/failure) and hence unable to send {@link SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER}\n-      // If cache is not invalidated, we will not recover from exceptions until the controller comes back up\n-      ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-    }\n-    return response;\n-  }\n-\n   /**\n    * raise a metric indicating the response we received from the controller\n    */\n-  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics, \n+  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics,\n       SegmentCompletionProtocol.Response response) {\n     switch (response.getStatus()) {\n       case NOT_SENT:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDU4Mg==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413190582", "bodyText": "can this logic be moved to the ControllerVip Uploader?", "author": "mcvsubbu", "createdAt": "2020-04-22T17:48:23Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.util;\n+\n+import java.io.File;\n+import java.net.URI;\n+import org.apache.pinot.common.metrics.ServerMeter;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+\n+/**\n+ * Util methods related to low level consumers' segment completion protocols. \n+ */\n+public class SegmentCompletionProtocolUtils {\n+  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(\n+      FileUploadDownloadClient fileUploadDownloadClient, File segmentFile, String controllerVipUrl, String segmentName,\n+      int segmentUploadRequestTimeoutMs, Logger logger) {\n+    SegmentCompletionProtocol.Response response;\n+    try {\n+      String responseStr = fileUploadDownloadClient\n+          .uploadSegment(new URI(controllerVipUrl), segmentName, segmentFile, null, null, segmentUploadRequestTimeoutMs)\n+          .getResponse();\n+      response = SegmentCompletionProtocol.Response.fromJsonString(responseStr);\n+      logger.info(\"Controller response {} for {}\", response.toJsonString(), controllerVipUrl);\n+      if (response.getStatus().equals(SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER)) {\n+        ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNjExOA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414126118", "bodyText": "Done.", "author": "chenboat", "createdAt": "2020-04-23T21:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MDU4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\nindex c376b00ced..d8db29a086 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/util/SegmentCompletionProtocolUtils.java\n\n@@ -18,48 +18,19 @@\n  */\n package org.apache.pinot.core.util;\n \n-import java.io.File;\n-import java.net.URI;\n import org.apache.pinot.common.metrics.ServerMeter;\n import org.apache.pinot.common.metrics.ServerMetrics;\n import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.common.utils.FileUploadDownloadClient;\n-import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n-import org.slf4j.Logger;\n \n \n /**\n  * Util methods related to low level consumers' segment completion protocols. \n  */\n public class SegmentCompletionProtocolUtils {\n-  public static SegmentCompletionProtocol.Response uploadSegmentWithFileUploadDownloadClient(\n-      FileUploadDownloadClient fileUploadDownloadClient, File segmentFile, String controllerVipUrl, String segmentName,\n-      int segmentUploadRequestTimeoutMs, Logger logger) {\n-    SegmentCompletionProtocol.Response response;\n-    try {\n-      String responseStr = fileUploadDownloadClient\n-          .uploadSegment(new URI(controllerVipUrl), segmentName, segmentFile, null, null, segmentUploadRequestTimeoutMs)\n-          .getResponse();\n-      response = SegmentCompletionProtocol.Response.fromJsonString(responseStr);\n-      logger.info(\"Controller response {} for {}\", response.toJsonString(), controllerVipUrl);\n-      if (response.getStatus().equals(SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER)) {\n-        ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-      }\n-    } catch (Exception e) {\n-      // Catch all exceptions, we want the protocol to handle the case assuming the request was never sent.\n-      response = SegmentCompletionProtocol.RESP_NOT_SENT;\n-      logger.error(\"Could not send request {}\", controllerVipUrl, e);\n-      // Invalidate controller leader cache, as exception could be because of leader being down (deployment/failure) and hence unable to send {@link SegmentCompletionProtocol.ControllerResponseStatus.NOT_LEADER}\n-      // If cache is not invalidated, we will not recover from exceptions until the controller comes back up\n-      ControllerLeaderLocator.getInstance().invalidateCachedControllerLeader();\n-    }\n-    return response;\n-  }\n-\n   /**\n    * raise a metric indicating the response we received from the controller\n    */\n-  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics, \n+  public static void raiseSegmentCompletionProtocolResponseMetric(ServerMetrics serverMetrics,\n       SegmentCompletionProtocol.Response response) {\n     switch (response.getStatus()) {\n       case NOT_SENT:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MTc3Nw==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413191777", "bodyText": "Maybe call it Server2ControllerSegmentUploader? I think we should omit Vip in the name, there is nothing in here that says we should go through vip", "author": "mcvsubbu", "createdAt": "2020-04-22T17:50:09Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n+import org.slf4j.Logger;\n+\n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n+\n+\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n+// point.\n+public class ControllerVipBasedSegmentUploader implements SegmentUploader {", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNjI0MQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414126241", "bodyText": "Renamed.", "author": "chenboat", "createdAt": "2020-04-23T21:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MTc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\ndeleted file mode 100644\nindex fd21d820af..0000000000\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\n+++ /dev/null\n\n@@ -1,65 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pinot.core.data.manager.realtime;\n-\n-import java.io.File;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import org.apache.pinot.common.metrics.ServerMetrics;\n-import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.common.utils.FileUploadDownloadClient;\n-import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n-import org.slf4j.Logger;\n-\n-import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n-\n-\n-// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n-// point.\n-public class ControllerVipBasedSegmentUploader implements SegmentUploader {\n-  private final Logger _segmentLogger;\n-  private final String _controllerVipUrl;\n-  private final FileUploadDownloadClient _fileUploadDownloadClient;\n-  private final String _segmentName;\n-  private final int _segmentUploadRequestTimeoutMs;\n-  private final ServerMetrics _serverMetrics;\n-\n-  public ControllerVipBasedSegmentUploader(Logger segmentLogger, FileUploadDownloadClient fileUploadDownloadClient,\n-      String controllerVipUrl, String segmentName, int segmentUploadRequestTimeoutMs, ServerMetrics serverMetrics) {\n-    _segmentLogger = segmentLogger;\n-    _fileUploadDownloadClient = fileUploadDownloadClient;\n-    _controllerVipUrl = controllerVipUrl;\n-    _segmentName = segmentName;\n-    _segmentUploadRequestTimeoutMs = segmentUploadRequestTimeoutMs;\n-    _serverMetrics = serverMetrics;\n-  }\n-\n-  @Override\n-  public URI uploadSegment(File segmentFile)\n-      throws URISyntaxException {\n-    SegmentCompletionProtocol.Response response = SegmentCompletionProtocolUtils\n-        .uploadSegmentWithFileUploadDownloadClient(_fileUploadDownloadClient, segmentFile, _controllerVipUrl,\n-            _segmentName, _segmentUploadRequestTimeoutMs, _segmentLogger);\n-    SegmentCompletionProtocolUtils.raiseSegmentCompletionProtocolResponseMetric(_serverMetrics, response);\n-    if (response.getStatus() == UPLOAD_SUCCESS) {\n-      return new URI(response.getSegmentLocation());\n-    }\n-    return null;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjAyNA==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r413192024", "bodyText": "Can construct URI here and throw exception if it fails", "author": "mcvsubbu", "createdAt": "2020-04-22T17:50:29Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n+import org.slf4j.Logger;\n+\n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n+\n+\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n+// point.\n+public class ControllerVipBasedSegmentUploader implements SegmentUploader {\n+  private final Logger _segmentLogger;\n+  private final String _controllerVipUrl;\n+  private final FileUploadDownloadClient _fileUploadDownloadClient;\n+  private final String _segmentName;\n+  private final int _segmentUploadRequestTimeoutMs;\n+  private final ServerMetrics _serverMetrics;\n+\n+  public ControllerVipBasedSegmentUploader(Logger segmentLogger, FileUploadDownloadClient fileUploadDownloadClient,\n+      String controllerVipUrl, String segmentName, int segmentUploadRequestTimeoutMs, ServerMetrics serverMetrics) {\n+    _segmentLogger = segmentLogger;\n+    _fileUploadDownloadClient = fileUploadDownloadClient;\n+    _controllerVipUrl = controllerVipUrl;\n+    _segmentName = segmentName;", "originalCommit": "30830a9dd802775145629e754d8156621161d5a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEyNjQxNQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414126415", "bodyText": "Done. Good point.", "author": "chenboat", "createdAt": "2020-04-23T21:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE5MjAyNA=="}], "type": "inlineReview", "revised_code": {"commit": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\ndeleted file mode 100644\nindex fd21d820af..0000000000\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/ControllerVipBasedSegmentUploader.java\n+++ /dev/null\n\n@@ -1,65 +0,0 @@\n-/**\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-package org.apache.pinot.core.data.manager.realtime;\n-\n-import java.io.File;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import org.apache.pinot.common.metrics.ServerMetrics;\n-import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n-import org.apache.pinot.common.utils.FileUploadDownloadClient;\n-import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n-import org.slf4j.Logger;\n-\n-import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n-\n-\n-// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n-// point.\n-public class ControllerVipBasedSegmentUploader implements SegmentUploader {\n-  private final Logger _segmentLogger;\n-  private final String _controllerVipUrl;\n-  private final FileUploadDownloadClient _fileUploadDownloadClient;\n-  private final String _segmentName;\n-  private final int _segmentUploadRequestTimeoutMs;\n-  private final ServerMetrics _serverMetrics;\n-\n-  public ControllerVipBasedSegmentUploader(Logger segmentLogger, FileUploadDownloadClient fileUploadDownloadClient,\n-      String controllerVipUrl, String segmentName, int segmentUploadRequestTimeoutMs, ServerMetrics serverMetrics) {\n-    _segmentLogger = segmentLogger;\n-    _fileUploadDownloadClient = fileUploadDownloadClient;\n-    _controllerVipUrl = controllerVipUrl;\n-    _segmentName = segmentName;\n-    _segmentUploadRequestTimeoutMs = segmentUploadRequestTimeoutMs;\n-    _serverMetrics = serverMetrics;\n-  }\n-\n-  @Override\n-  public URI uploadSegment(File segmentFile)\n-      throws URISyntaxException {\n-    SegmentCompletionProtocol.Response response = SegmentCompletionProtocolUtils\n-        .uploadSegmentWithFileUploadDownloadClient(_fileUploadDownloadClient, segmentFile, _controllerVipUrl,\n-            _segmentName, _segmentUploadRequestTimeoutMs, _segmentLogger);\n-    SegmentCompletionProtocolUtils.raiseSegmentCompletionProtocolResponseMetric(_serverMetrics, response);\n-    if (response.getStatus() == UPLOAD_SUCCESS) {\n-      return new URI(response.getSegmentLocation());\n-    }\n-    return null;\n-  }\n-}\n"}}, {"oid": "fea5273b117fff6e5001ab83aeddb1794c78f9d2", "url": "https://github.com/apache/pinot/commit/fea5273b117fff6e5001ab83aeddb1794c78f9d2", "message": "Revise based on comments.", "committedDate": "2020-04-23T01:09:14Z", "type": "commit"}, {"oid": "346bf2e2370ea66c5ed33a05db6f583f8e8e8140", "url": "https://github.com/apache/pinot/commit/346bf2e2370ea66c5ed33a05db6f583f8e8e8140", "message": "Fix broken integration tests.", "committedDate": "2020-04-23T21:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMDUwMQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414200501", "bodyText": "remove this line", "author": "mcvsubbu", "createdAt": "2020-04-23T23:55:32Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n+\n+\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n+// point.", "originalCommit": "346bf2e2370ea66c5ed33a05db6f583f8e8e8140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxNjI4NQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414216285", "bodyText": "Done.", "author": "chenboat", "createdAt": "2020-04-24T00:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMDUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "45cf75d956999de671dce89eed593a7f796290fd", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\nindex 8c00eb13ce..91b177d9e6 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n\n@@ -28,15 +28,12 @@ import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n import org.slf4j.Logger;\n \n-import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n \n-\n-// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n-// point.\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point.\n public class Server2ControllerSegmentUploader implements SegmentUploader {\n   private final Logger _segmentLogger;\n   // The controller segment upload url.\n-  private final String _controllerSegmentUploadCommitUrl;\n+  private final URI _controllerSegmentUploadCommitUrl;\n   private final FileUploadDownloadClient _fileUploadDownloadClient;\n   private final String _segmentName;\n   private final int _segmentUploadRequestTimeoutMs;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMjI2Nw==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414202267", "bodyText": "can we avoid the static import please", "author": "mcvsubbu", "createdAt": "2020-04-24T00:00:27Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;", "originalCommit": "346bf2e2370ea66c5ed33a05db6f583f8e8e8140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIxNjgyNw==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414216827", "bodyText": "done.", "author": "chenboat", "createdAt": "2020-04-24T00:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMjI2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "45cf75d956999de671dce89eed593a7f796290fd", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\nindex 8c00eb13ce..91b177d9e6 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n\n@@ -28,15 +28,12 @@ import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n import org.slf4j.Logger;\n \n-import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n \n-\n-// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n-// point.\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point.\n public class Server2ControllerSegmentUploader implements SegmentUploader {\n   private final Logger _segmentLogger;\n   // The controller segment upload url.\n-  private final String _controllerSegmentUploadCommitUrl;\n+  private final URI _controllerSegmentUploadCommitUrl;\n   private final FileUploadDownloadClient _fileUploadDownloadClient;\n   private final String _segmentName;\n   private final int _segmentUploadRequestTimeoutMs;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMjU5OQ==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414202599", "bodyText": "Please parse the URI here and save it as a member, throw exception if URI does not parse.", "author": "mcvsubbu", "createdAt": "2020-04-24T00:01:21Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.core.data.manager.realtime;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import org.apache.pinot.common.metrics.ServerMetrics;\n+import org.apache.pinot.common.protocols.SegmentCompletionProtocol;\n+import org.apache.pinot.common.utils.FileUploadDownloadClient;\n+import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n+import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n+import org.slf4j.Logger;\n+\n+import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n+\n+\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n+// point.\n+public class Server2ControllerSegmentUploader implements SegmentUploader {\n+  private final Logger _segmentLogger;\n+  // The controller segment upload url.\n+  private final String _controllerSegmentUploadCommitUrl;\n+  private final FileUploadDownloadClient _fileUploadDownloadClient;\n+  private final String _segmentName;\n+  private final int _segmentUploadRequestTimeoutMs;\n+  private final ServerMetrics _serverMetrics;\n+\n+  public Server2ControllerSegmentUploader(Logger segmentLogger, FileUploadDownloadClient fileUploadDownloadClient,\n+      String controllerSegmentUploadCommitUrl, String segmentName, int segmentUploadRequestTimeoutMs,\n+      ServerMetrics serverMetrics) {\n+    _segmentLogger = segmentLogger;\n+    _fileUploadDownloadClient = fileUploadDownloadClient;\n+    _controllerSegmentUploadCommitUrl = controllerSegmentUploadCommitUrl;", "originalCommit": "346bf2e2370ea66c5ed33a05db6f583f8e8e8140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyMTgwMw==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414221803", "bodyText": "Done.", "author": "chenboat", "createdAt": "2020-04-24T01:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMjU5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "45cf75d956999de671dce89eed593a7f796290fd", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\nindex 8c00eb13ce..91b177d9e6 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/data/manager/realtime/Server2ControllerSegmentUploader.java\n\n@@ -28,15 +28,12 @@ import org.apache.pinot.core.util.SegmentCompletionProtocolUtils;\n import org.apache.pinot.server.realtime.ControllerLeaderLocator;\n import org.slf4j.Logger;\n \n-import static org.apache.pinot.common.protocols.SegmentCompletionProtocol.ControllerResponseStatus.UPLOAD_SUCCESS;\n \n-\n-// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point\n-// point.\n+// A segment uploader which uploads segments to the controller via the controller's segmentCommitUpload end point.\n public class Server2ControllerSegmentUploader implements SegmentUploader {\n   private final Logger _segmentLogger;\n   // The controller segment upload url.\n-  private final String _controllerSegmentUploadCommitUrl;\n+  private final URI _controllerSegmentUploadCommitUrl;\n   private final FileUploadDownloadClient _fileUploadDownloadClient;\n   private final String _segmentName;\n   private final int _segmentUploadRequestTimeoutMs;\n"}}, {"oid": "45cf75d956999de671dce89eed593a7f796290fd", "url": "https://github.com/apache/pinot/commit/45cf75d956999de671dce89eed593a7f796290fd", "message": "Revise based on feedback.", "committedDate": "2020-04-24T00:59:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY5ODIxNg==", "url": "https://github.com/apache/pinot/pull/5277#discussion_r414698216", "bodyText": "I looked up the code, and it seems that we sanitize the url returned by the controller, but then we pass strings around. We need to clean this up, but it can be in a later PR.", "author": "mcvsubbu", "createdAt": "2020-04-24T16:16:41Z", "path": "pinot-core/src/main/java/org/apache/pinot/server/realtime/ServerSegmentCompletionProtocolHandler.java", "diffHunk": "@@ -131,7 +140,15 @@ public ServerSegmentCompletionProtocolHandler(ServerMetrics serverMetrics, Strin\n       return SegmentCompletionProtocol.RESP_NOT_SENT;\n     }\n \n-    return uploadSegment(url, params.getSegmentName(), segmentTarFile);\n+    Server2ControllerSegmentUploader segmentUploader= null;\n+    try {\n+      segmentUploader = new Server2ControllerSegmentUploader(LOGGER,", "originalCommit": "45cf75d956999de671dce89eed593a7f796290fd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}