{"pr_number": 6096, "pr_title": "add upsert related configs", "pr_createdAt": "2020-10-02T20:24:20Z", "pr_url": "https://github.com/apache/pinot/pull/6096", "timeline": [{"oid": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "url": "https://github.com/apache/pinot/commit/62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "message": "add upsert related configs", "committedDate": "2020-10-02T20:19:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTA2NA==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499105064", "bodyText": "This should not be part of the schema, but the upsert config", "author": "Jackie-Jiang", "createdAt": "2020-10-03T01:49:44Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -66,6 +66,9 @@\n   private TimeFieldSpec _timeFieldSpec;\n   private final List<DateTimeFieldSpec> _dateTimeFieldSpecs = new ArrayList<>();\n   private final List<ComplexFieldSpec> _complexFieldSpecs = new ArrayList<>();\n+  // names of the columns that used as primary keys\n+  // TODO: add validation checks like duplicate columns and use of time column\n+  private List<String> _primaryKeyColumns;", "originalCommit": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNzcyNQ==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499107725", "bodyText": "Primary key is an inherent attribute of the schema. And its usage is beyond the upsert. For example, it's also used in the join feature which is happening in parallel.", "author": "yupeng9", "createdAt": "2020-10-03T02:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTA2NA=="}], "type": "inlineReview", "revised_code": {"commit": "d47729b2af95266be52f96baf1c6256ac8aa15e7", "chunk": "diff --git a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\nindex b9deb64c49..3ee82d5fae 100644\n--- a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n+++ b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n\n@@ -67,7 +67,7 @@ public final class Schema {\n   private final List<DateTimeFieldSpec> _dateTimeFieldSpecs = new ArrayList<>();\n   private final List<ComplexFieldSpec> _complexFieldSpecs = new ArrayList<>();\n   // names of the columns that used as primary keys\n-  // TODO: add validation checks like duplicate columns and use of time column\n+  // TODO(yupeng): add validation checks like duplicate columns and use of time column\n   private List<String> _primaryKeyColumns;\n \n   // Json ignored fields\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTIxMg==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499105212", "bodyText": "Recommend not putting NONE as a mode. Upsert is disabled when the UpsertConfig is null in the table config (more intuitive IMO)", "author": "Jackie-Jiang", "createdAt": "2020-10-03T01:51:41Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/UpsertConfig.java", "diffHunk": "@@ -27,44 +27,22 @@\n \n \n public class UpsertConfig extends BaseJsonConfig {\n-  // names of the columns that used as primary keys of an upsert table\n-  private final List<String> _primaryKeyColumns;\n-  // name of the column that we are going to store the offset value to\n-  private final String _offsetColumn;\n-  // name of the virtual column that we are going to store the validFrom value to\n-  private final String _validFromColumn;\n-  // name of the virtual column that we are going to store the validUntil value to\n-  private final String _validUntilColumn;\n+  public static final String MODE_KEY = \"mode\";\n \n-  @JsonCreator\n-  public UpsertConfig(@JsonProperty(value = \"primaryKeyColumns\") List<String> primaryKeyColumns,\n-      @JsonProperty(value = \"offsetColumn\") String offsetColumn,\n-      @JsonProperty(value = \"validFromColumn\") String validFromColumn,\n-      @JsonProperty(value = \"validUntilColumn\") String validUntilColumn) {\n-    Preconditions.checkArgument(primaryKeyColumns != null && primaryKeyColumns.size() == 1,\n-        \"'primaryKeyColumns' must be configured with exact one column\");\n-    Preconditions.checkArgument(StringUtils.isNotEmpty(offsetColumn), \"'offsetColumn' must be configured\");\n-    Preconditions.checkArgument(StringUtils.isNotEmpty(validFromColumn), \"'validFromColumn' must be configured\");\n-    Preconditions.checkArgument(StringUtils.isNotEmpty(validUntilColumn), \"'validUntilColumn' must be configured\");\n-    _primaryKeyColumns = primaryKeyColumns;\n-    _offsetColumn = offsetColumn;\n-    _validFromColumn = validFromColumn;\n-    _validUntilColumn = validUntilColumn;\n+  public enum Mode {\n+    FULL, PARTIAL, NONE", "originalCommit": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNzgwNQ==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499107805", "bodyText": "In the implementation, it's more clearer (and easier) to have a value to represent that upsert is disabled. Also, when UpsertConfig is null, it implies the mode is NONE", "author": "yupeng9", "createdAt": "2020-10-03T02:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTIxMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTI0Mg==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499105242", "bodyText": "Not sure if this method is needed", "author": "Jackie-Jiang", "createdAt": "2020-10-03T01:51:57Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/TableConfig.java", "diffHunk": "@@ -265,4 +266,9 @@ public void setIngestionConfig(IngestionConfig ingestionConfig) {\n   public void setTierConfigsList(List<TierConfig> tierConfigsList) {\n     _tierConfigsList = tierConfigsList;\n   }\n+\n+  @JsonIgnore\n+  public UpsertConfig.Mode getUpsertMode() {", "originalCommit": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNzgzMA==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499107830", "bodyText": "yes, in the upcoming PRs", "author": "yupeng9", "createdAt": "2020-10-03T02:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTEwNTI0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE3MzM2NQ==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499173365", "bodyText": "(nit) put getter before setter for consistency", "author": "Jackie-Jiang", "createdAt": "2020-10-03T19:02:12Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -99,6 +102,14 @@ public void setSchemaName(String schemaName) {\n     _schemaName = schemaName;\n   }\n \n+  public void setPrimaryKeyColumns(List<String> primaryKeyColumns) {\n+    _primaryKeyColumns = primaryKeyColumns;\n+  }\n+\n+  public List<String> getPrimaryKeyColumns() {", "originalCommit": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d47729b2af95266be52f96baf1c6256ac8aa15e7", "chunk": "diff --git a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\nindex b9deb64c49..3ee82d5fae 100644\n--- a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n+++ b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n\n@@ -102,14 +102,14 @@ public final class Schema {\n     _schemaName = schemaName;\n   }\n \n-  public void setPrimaryKeyColumns(List<String> primaryKeyColumns) {\n-    _primaryKeyColumns = primaryKeyColumns;\n-  }\n-\n   public List<String> getPrimaryKeyColumns() {\n     return _primaryKeyColumns;\n   }\n \n+  public void setPrimaryKeyColumns(List<String> primaryKeyColumns) {\n+    _primaryKeyColumns = primaryKeyColumns;\n+  }\n+\n   public List<DimensionFieldSpec> getDimensionFieldSpecs() {\n     return _dimensionFieldSpecs;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE3MzUwMA==", "url": "https://github.com/apache/pinot/pull/6096#discussion_r499173500", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public SchemaBuilder addPrimaryKeyColumns(List<String> primaryKeyColumns) {\n          \n          \n            \n                public SchemaBuilder setPrimaryKeyColumns(List<String> primaryKeyColumns) {", "author": "Jackie-Jiang", "createdAt": "2020-10-03T19:04:02Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java", "diffHunk": "@@ -558,6 +576,11 @@ public SchemaBuilder addComplex(String name, DataType dataType) {\n       return this;\n     }\n \n+    public SchemaBuilder addPrimaryKeyColumns(List<String> primaryKeyColumns) {", "originalCommit": "62a411fbca49f0aa0d22f12cfac145313a9fa1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d47729b2af95266be52f96baf1c6256ac8aa15e7", "chunk": "diff --git a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\nindex b9deb64c49..3ee82d5fae 100644\n--- a/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n+++ b/pinot-spi/src/main/java/org/apache/pinot/spi/data/Schema.java\n\n@@ -576,7 +576,7 @@ public final class Schema {\n       return this;\n     }\n \n-    public SchemaBuilder addPrimaryKeyColumns(List<String> primaryKeyColumns) {\n+    public SchemaBuilder setPrimaryKeyColumns(List<String> primaryKeyColumns) {\n       _schema.setPrimaryKeyColumns(primaryKeyColumns);\n       return this;\n     }\n"}}, {"oid": "d47729b2af95266be52f96baf1c6256ac8aa15e7", "url": "https://github.com/apache/pinot/commit/d47729b2af95266be52f96baf1c6256ac8aa15e7", "message": "address comments", "committedDate": "2020-10-04T03:22:10Z", "type": "commit"}]}