{"pr_number": 5218, "pr_title": "Fix HDFS copy logic", "pr_createdAt": "2020-04-07T11:01:38Z", "pr_url": "https://github.com/apache/pinot/pull/5218", "timeline": [{"oid": "bc07031433dfa50449d4d9ea2cb03c7a7f9d0cac", "url": "https://github.com/apache/pinot/commit/bc07031433dfa50449d4d9ea2cb03c7a7f9d0cac", "message": "Make Quickstart to log error to consoles", "committedDate": "2020-04-14T20:38:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3MTg0NA==", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409771844", "bodyText": "Why do we need to set it to false?", "author": "jackjlli", "createdAt": "2020-04-16T18:41:58Z", "path": "pinot-plugins/pinot-file-system/pinot-hdfs/src/main/java/org/apache/pinot/plugin/filesystem/HadoopPinotFS.java", "diffHunk": "@@ -60,6 +62,7 @@ public void init(Configuration config) {\n       _hadoopConf = getConf(config.getString(HADOOP_CONF_PATH));\n       authenticate(_hadoopConf, config);\n       _hadoopFS = org.apache.hadoop.fs.FileSystem.get(_hadoopConf);\n+      _hadoopFS.setWriteChecksum((config.getBoolean(WRITE_CHECKSUM, false)));", "originalCommit": "c82e14b085ffb65d4eac4794361157c54ef8e8b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc4NDI0NA==", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409784244", "bodyText": "This will still do checksum but not write the .crc file to directory.", "author": "xiangfu0", "createdAt": "2020-04-16T19:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3MTg0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0NjExMA==", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409846110", "bodyText": "Here the distURI is constructed by target + sourceFilePath. Can you make sure sourceFilePath is relative path instead of absolute path?\nAnd if possible, it'd be good to add some tests for this method. Thanks!", "author": "jackjlli", "createdAt": "2020-04-16T21:02:07Z", "path": "pinot-plugins/pinot-file-system/pinot-hdfs/src/main/java/org/apache/pinot/plugin/filesystem/HadoopPinotFS.java", "diffHunk": "@@ -97,13 +100,24 @@ public boolean copy(URI srcUri, URI dstUri)\n       throws IOException {\n     Path source = new Path(srcUri);\n     Path target = new Path(dstUri);\n-    RemoteIterator<LocatedFileStatus> sourceFiles = _hadoopFS.listFiles(source, true);\n+    RemoteIterator<FileStatus> sourceFiles = _hadoopFS.listStatusIterator(source);\n     if (sourceFiles != null) {\n       while (sourceFiles.hasNext()) {\n-        boolean succeeded =\n-            FileUtil.copy(_hadoopFS, sourceFiles.next().getPath(), _hadoopFS, target, true, _hadoopConf);\n-        if (!succeeded) {\n-          return false;\n+        FileStatus sourceFile = sourceFiles.next();\n+        Path sourceFilePath = sourceFile.getPath();\n+        if (sourceFile.isFile()) {\n+          try {\n+            FileUtil.copy(_hadoopFS, sourceFilePath, _hadoopFS, new Path(target, sourceFilePath.getName()), false,\n+                _hadoopConf);\n+          } catch (FileNotFoundException e) {\n+            LOGGER.warn(\"Not found file {}, skipping copying it...\", sourceFilePath, e);\n+          }\n+        } else if (sourceFile.isDirectory()) {\n+          try {\n+            copy(sourceFilePath.toUri(), new Path(target, sourceFilePath.getName()).toUri());", "originalCommit": "c82e14b085ffb65d4eac4794361157c54ef8e8b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxODM3Ng==", "url": "https://github.com/apache/pinot/pull/5218#discussion_r409918376", "bodyText": "added a test .", "author": "xiangfu0", "createdAt": "2020-04-17T00:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0NjExMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6d4edc680d1791e7bd3f84b3fc88b9a2469554e5", "url": "https://github.com/apache/pinot/commit/6d4edc680d1791e7bd3f84b3fc88b9a2469554e5", "message": "Update HDFS copy logic", "committedDate": "2020-04-17T00:03:35Z", "type": "commit"}, {"oid": "71584a969002ec82407e0119c9dd39e3751b5fb3", "url": "https://github.com/apache/pinot/commit/71584a969002ec82407e0119c9dd39e3751b5fb3", "message": "Adding test", "committedDate": "2020-04-17T00:03:35Z", "type": "forcePushed"}, {"oid": "a208fb0ba42b1a2c50591c4125a79e1d968228bc", "url": "https://github.com/apache/pinot/commit/a208fb0ba42b1a2c50591c4125a79e1d968228bc", "message": "Adding test", "committedDate": "2020-04-17T00:08:04Z", "type": "commit"}, {"oid": "a208fb0ba42b1a2c50591c4125a79e1d968228bc", "url": "https://github.com/apache/pinot/commit/a208fb0ba42b1a2c50591c4125a79e1d968228bc", "message": "Adding test", "committedDate": "2020-04-17T00:08:04Z", "type": "forcePushed"}]}