{"pr_number": 5641, "pr_title": "Allow star-tree creation during segment load", "pr_createdAt": "2020-07-01T01:00:24Z", "pr_url": "https://github.com/apache/pinot/pull/5641", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzNTU5Mg==", "url": "https://github.com/apache/pinot/pull/5641#discussion_r450335592", "bodyText": "why should add null for default star tree?", "author": "kishoreg", "createdAt": "2020-07-06T16:20:58Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/IndexLoadingConfig.java", "diffHunk": "@@ -126,6 +128,18 @@ private void extractFromTableConfig(@Nonnull TableConfig tableConfig) {\n       _onHeapDictionaryColumns.addAll(onHeapDictionaryColumns);\n     }\n \n+    if (indexingConfig.isAllowStarTreeCreationDuringSegmentLoad()) {\n+      List<StarTreeIndexConfig> starTreeIndexConfigs = indexingConfig.getStarTreeIndexConfigs();\n+      if (starTreeIndexConfigs != null) {\n+        for (StarTreeIndexConfig starTreeIndexConfig : starTreeIndexConfigs) {\n+          _starTreeV2BuilderConfigs.add(StarTreeV2BuilderConfig.fromIndexConfig(starTreeIndexConfig));\n+        }\n+      }\n+      if (indexingConfig.isEnableDefaultStarTree()) {\n+        _starTreeV2BuilderConfigs.add(null);", "originalCommit": "0605dcf82e16673b4b31bba819eb97fdc028be0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExNDQ4Mw==", "url": "https://github.com/apache/pinot/pull/5641#discussion_r451114483", "bodyText": "We used to use null as a placeholder for the default star-tree. Updated the PR to pass the boolean field into the star-tree builder for readability.", "author": "Jackie-Jiang", "createdAt": "2020-07-07T20:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzNTU5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e96bc956c945c10fb9cda78d845824774f1bba4c", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/IndexLoadingConfig.java b/pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/IndexLoadingConfig.java\nindex 322baae391..4dd61e3c8b 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/IndexLoadingConfig.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/segment/index/loader/IndexLoadingConfig.java\n\n@@ -128,16 +127,9 @@ public class IndexLoadingConfig {\n       _onHeapDictionaryColumns.addAll(onHeapDictionaryColumns);\n     }\n \n-    if (indexingConfig.isAllowStarTreeCreationDuringSegmentLoad()) {\n-      List<StarTreeIndexConfig> starTreeIndexConfigs = indexingConfig.getStarTreeIndexConfigs();\n-      if (starTreeIndexConfigs != null) {\n-        for (StarTreeIndexConfig starTreeIndexConfig : starTreeIndexConfigs) {\n-          _starTreeV2BuilderConfigs.add(StarTreeV2BuilderConfig.fromIndexConfig(starTreeIndexConfig));\n-        }\n-      }\n-      if (indexingConfig.isEnableDefaultStarTree()) {\n-        _starTreeV2BuilderConfigs.add(null);\n-      }\n+    if (indexingConfig.isEnableDynamicStarTreeCreation()) {\n+      _starTreeIndexConfigs = indexingConfig.getStarTreeIndexConfigs();\n+      _enableDefaultStarTree = indexingConfig.isEnableDefaultStarTree();\n     }\n \n     String tableSegmentVersion = indexingConfig.getSegmentFormatVersion();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzM4Mw==", "url": "https://github.com/apache/pinot/pull/5641#discussion_r450587383", "bodyText": "why do we need this config. can we put this at the cluster level or something?\nalso, if we really need this, rename the variable to enableDynamicStarTreeCreation", "author": "kishoreg", "createdAt": "2020-07-07T03:10:13Z", "path": "pinot-spi/src/main/java/org/apache/pinot/spi/config/table/IndexingConfig.java", "diffHunk": "@@ -191,6 +192,14 @@ public void setStarTreeIndexConfigs(List<StarTreeIndexConfig> starTreeIndexConfi\n     _starTreeIndexConfigs = starTreeIndexConfigs;\n   }\n \n+  public boolean isAllowStarTreeCreationDuringSegmentLoad() {", "originalCommit": "0605dcf82e16673b4b31bba819eb97fdc028be0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NTE1NA==", "url": "https://github.com/apache/pinot/pull/5641#discussion_r451045154", "bodyText": "We need this config on the table level so that when user adds star-tree indexes for a table, they can choose to create star-trees on server side or Hadoop/Spark side for backfill (or minion side in the future) based on the server load.\nRenamed the config", "author": "Jackie-Jiang", "createdAt": "2020-07-07T17:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4NzM4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e96bc956c945c10fb9cda78d845824774f1bba4c", "chunk": "diff --git a/pinot-spi/src/main/java/org/apache/pinot/spi/config/table/IndexingConfig.java b/pinot-spi/src/main/java/org/apache/pinot/spi/config/table/IndexingConfig.java\nindex 2a58e8aa93..71832de3f9 100644\n--- a/pinot-spi/src/main/java/org/apache/pinot/spi/config/table/IndexingConfig.java\n+++ b/pinot-spi/src/main/java/org/apache/pinot/spi/config/table/IndexingConfig.java\n\n@@ -192,12 +193,12 @@ public class IndexingConfig extends BaseJsonConfig {\n     _starTreeIndexConfigs = starTreeIndexConfigs;\n   }\n \n-  public boolean isAllowStarTreeCreationDuringSegmentLoad() {\n-    return _allowStarTreeCreationDuringSegmentLoad;\n+  public boolean isEnableDynamicStarTreeCreation() {\n+    return _enableDynamicStarTreeCreation;\n   }\n \n-  public void setAllowStarTreeCreationDuringSegmentLoad(boolean allowStarTreeCreationDuringSegmentLoad) {\n-    _allowStarTreeCreationDuringSegmentLoad = allowStarTreeCreationDuringSegmentLoad;\n+  public void setEnableDynamicStarTreeCreation(boolean enableDynamicStarTreeCreation) {\n+    _enableDynamicStarTreeCreation = enableDynamicStarTreeCreation;\n   }\n \n   @Nullable\n"}}, {"oid": "e96bc956c945c10fb9cda78d845824774f1bba4c", "url": "https://github.com/apache/pinot/commit/e96bc956c945c10fb9cda78d845824774f1bba4c", "message": "Allow star-tree creation during segment load\n\nAllow star-tree creation during segment load (and reload).\nWith this, star-tree can be created for COMPLETED realtime segments.\n\nBecause the star-tree creation could consume a lot of system resources, added a boolean config 'enableDynamicStarTreeeCreation' in IndexingConfig to enable/disable this feature.\n\nOther changes:\n- Pass in `enableDefaultStarTree` into MultipleTreesBuilder instead of using null as a placeholder for default star-tree to enhance the readability\n- Make MultipleTreesBuilder closeable to close the segment properly", "committedDate": "2020-07-07T20:13:59Z", "type": "forcePushed"}, {"oid": "3c2e73e16d6cdb5b5154af7addb88d699e32851d", "url": "https://github.com/apache/pinot/commit/3c2e73e16d6cdb5b5154af7addb88d699e32851d", "message": "Allow star-tree creation during segment load\n\nAllow star-tree creation during segment load (and reload).\nWith this, star-tree can be created for COMPLETED realtime segments.\n\nBecause the star-tree creation could consume a lot of system resources, added a boolean config 'enableDynamicStarTreeeCreation' in IndexingConfig to enable/disable this feature.\n\nOther changes:\n- Pass in `enableDefaultStarTree` into MultipleTreesBuilder instead of using null as a placeholder for default star-tree to enhance the readability\n- Make MultipleTreesBuilder closeable to close the segment properly", "committedDate": "2020-07-07T21:19:32Z", "type": "forcePushed"}, {"oid": "6172078ac67bf972d26f14b4b5709f8d6f0a4e7a", "url": "https://github.com/apache/pinot/commit/6172078ac67bf972d26f14b4b5709f8d6f0a4e7a", "message": "Allow star-tree creation during segment load\n\nAllow star-tree creation during segment load (and reload).\nWith this, star-tree can be created for COMPLETED realtime segments.\n\nBecause the star-tree creation could consume a lot of system resources, added a boolean config 'enableDynamicStarTreeeCreation' in IndexingConfig to enable/disable this feature.\n\nOther changes:\n- Pass in `enableDefaultStarTree` into MultipleTreesBuilder instead of using null as a placeholder for default star-tree to enhance the readability\n- Make MultipleTreesBuilder closeable to close the segment properly", "committedDate": "2020-07-07T22:42:53Z", "type": "commit"}, {"oid": "6172078ac67bf972d26f14b4b5709f8d6f0a4e7a", "url": "https://github.com/apache/pinot/commit/6172078ac67bf972d26f14b4b5709f8d6f0a4e7a", "message": "Allow star-tree creation during segment load\n\nAllow star-tree creation during segment load (and reload).\nWith this, star-tree can be created for COMPLETED realtime segments.\n\nBecause the star-tree creation could consume a lot of system resources, added a boolean config 'enableDynamicStarTreeeCreation' in IndexingConfig to enable/disable this feature.\n\nOther changes:\n- Pass in `enableDefaultStarTree` into MultipleTreesBuilder instead of using null as a placeholder for default star-tree to enhance the readability\n- Make MultipleTreesBuilder closeable to close the segment properly", "committedDate": "2020-07-07T22:42:53Z", "type": "forcePushed"}]}