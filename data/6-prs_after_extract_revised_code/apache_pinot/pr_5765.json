{"pr_number": 5765, "pr_title": "Optimize DistinctCount to store dictIds within segment", "pr_createdAt": "2020-07-28T22:41:45Z", "pr_url": "https://github.com/apache/pinot/pull/5765", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjU1Mw==", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002553", "bodyText": "probably not relevant to this PR but we should try to move towards using Block instead of DataSource", "author": "kishoreg", "createdAt": "2020-07-29T02:35:06Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java", "diffHunk": "@@ -25,22 +25,22 @@\n import org.apache.pinot.core.common.BlockMetadata;\n import org.apache.pinot.core.common.BlockValSet;\n import org.apache.pinot.core.common.DataBlockCache;\n-import org.apache.pinot.core.common.DataSourceMetadata;\n+import org.apache.pinot.core.common.DataSource;\n import org.apache.pinot.core.operator.docvalsets.ProjectionBlockValSet;\n-import org.apache.pinot.spi.data.FieldSpec;\n \n \n /**\n  * ProjectionBlock holds a column name to Block Map.\n  * It provides DocIdSetBlock for a given column.\n  */\n public class ProjectionBlock implements Block {\n-  private final Map<String, DataSourceMetadata> _dataSourceMetadataMap;\n+  private final Map<String, DataSource> _dataSourceMap;", "originalCommit": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8dbbeb332b072e97ff02a08a289372dbddb42801", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java b/pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java\nindex 2768e9d7fd..989a870c3b 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/operator/blocks/ProjectionBlock.java\n\n@@ -35,24 +35,19 @@ import org.apache.pinot.core.operator.docvalsets.ProjectionBlockValSet;\n  */\n public class ProjectionBlock implements Block {\n   private final Map<String, DataSource> _dataSourceMap;\n-  private final DocIdSetBlock _docIdSetBlock;\n   private final DataBlockCache _dataBlockCache;\n \n-  public ProjectionBlock(Map<String, DataSource> dataSourceMap, DataBlockCache dataBlockCache,\n-      DocIdSetBlock docIdSetBlock) {\n+  public ProjectionBlock(Map<String, DataSource> dataSourceMap, DataBlockCache dataBlockCache) {\n     _dataSourceMap = dataSourceMap;\n-    _docIdSetBlock = docIdSetBlock;\n     _dataBlockCache = dataBlockCache;\n   }\n \n-  @Override\n-  public BlockValSet getBlockValueSet() {\n-    throw new UnsupportedOperationException();\n+  public int getNumDocs() {\n+    return _dataBlockCache.getNumDocs();\n   }\n \n-  @Override\n-  public BlockDocIdValueSet getBlockDocIdValueSet() {\n-    throw new UnsupportedOperationException();\n+  public BlockValSet getBlockValueSet(String column) {\n+    return new ProjectionBlockValSet(_dataBlockCache, column, _dataSourceMap.get(column));\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjgzNQ==", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462002835", "bodyText": "how come we never needed this? For group by, we already have the optimization to work on dictionary ids right?", "author": "kishoreg", "createdAt": "2020-07-29T02:36:18Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/docvalsets/ProjectionBlockValSet.java", "diffHunk": "@@ -32,32 +35,33 @@\n public class ProjectionBlockValSet implements BlockValSet {\n   private final DataBlockCache _dataBlockCache;\n   private final String _column;\n-  private final DataType _dataType;\n-  private final boolean _singleValue;\n+  private final DataSource _dataSource;\n \n   /**\n    * Constructor for the class.\n-   * The dataBlockCache argument is initialized in {@link ProjectionOperator},\n-   * so that it can be reused across multiple calls to {@link ProjectionOperator#nextBlock()}.\n-   *\n-   * @param dataBlockCache data block cache\n-   * @param column Projection column.\n+   * The dataBlockCache is initialized in {@link ProjectionOperator} so that it can be reused across multiple calls to\n+   * {@link ProjectionOperator#nextBlock()}.\n    */\n-  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataType dataType, boolean singleValue) {\n+  public ProjectionBlockValSet(DataBlockCache dataBlockCache, String column, DataSource dataSource) {\n     _dataBlockCache = dataBlockCache;\n     _column = column;\n-    _dataType = dataType;\n-    _singleValue = singleValue;\n+    _dataSource = dataSource;\n   }\n \n   @Override\n   public DataType getValueType() {\n-    return _dataType;\n+    return _dataSource.getDataSourceMetadata().getDataType();\n   }\n \n   @Override\n   public boolean isSingleValue() {\n-    return _singleValue;\n+    return _dataSource.getDataSourceMetadata().isSingleValue();\n+  }\n+\n+  @Nullable\n+  @Override\n+  public Dictionary getDictionary() {", "originalCommit": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1NTUxMw==", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462055513", "bodyText": "For group-by, the dictionary is fetched from the TransformFunction", "author": "Jackie-Jiang", "createdAt": "2020-07-29T05:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjgzNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzA4Mw==", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462003083", "bodyText": "java doc for this?", "author": "kishoreg", "createdAt": "2020-07-29T02:37:22Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -212,11 +259,57 @@ public IntOpenHashSet extractGroupByResult(GroupByResultHolder groupByResultHold\n     IntOpenHashSet valueSet = groupByResultHolder.getResult(groupKey);\n     if (valueSet == null) {\n       return new IntOpenHashSet();\n+    }\n+\n+    if (_dictionary != null) {\n+      // For dictionary-encoded expression, convert dictionary ids to values\n+      return convertToValueSet(valueSet);\n     } else {\n       return valueSet;\n     }\n   }\n \n+  private IntOpenHashSet convertToValueSet(IntOpenHashSet dictIdSet) {", "originalCommit": "ce53fd0f2ced9b85f4504ad753c3268f1840bfe5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1ODk1Ng==", "url": "https://github.com/apache/pinot/pull/5765#discussion_r462058956", "bodyText": "Added", "author": "Jackie-Jiang", "createdAt": "2020-07-29T06:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzA4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8dbbeb332b072e97ff02a08a289372dbddb42801", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java\nindex 09110d8ed9..06f8a7dbf3 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java\n\n@@ -263,53 +263,12 @@ public class DistinctCountAggregationFunction extends BaseSingleInputAggregation\n \n     if (_dictionary != null) {\n       // For dictionary-encoded expression, convert dictionary ids to values\n-      return convertToValueSet(valueSet);\n+      return convertToValueSet(valueSet, _dictionary);\n     } else {\n       return valueSet;\n     }\n   }\n \n-  private IntOpenHashSet convertToValueSet(IntOpenHashSet dictIdSet) {\n-    IntOpenHashSet valueSet = new IntOpenHashSet(dictIdSet.size());\n-    IntIterator iterator = dictIdSet.iterator();\n-    DataType valueType = _dictionary.getValueType();\n-    switch (valueType) {\n-      case INT:\n-        while (iterator.hasNext()) {\n-          valueSet.add(_dictionary.getIntValue(iterator.nextInt()));\n-        }\n-        break;\n-      case LONG:\n-        while (iterator.hasNext()) {\n-          valueSet.add(Long.hashCode(_dictionary.getLongValue(iterator.nextInt())));\n-        }\n-        break;\n-      case FLOAT:\n-        while (iterator.hasNext()) {\n-          valueSet.add(Float.hashCode(_dictionary.getFloatValue(iterator.nextInt())));\n-        }\n-        break;\n-      case DOUBLE:\n-        while (iterator.hasNext()) {\n-          valueSet.add(Double.hashCode(_dictionary.getDoubleValue(iterator.nextInt())));\n-        }\n-        break;\n-      case STRING:\n-        while (iterator.hasNext()) {\n-          valueSet.add(_dictionary.getStringValue(iterator.nextInt()).hashCode());\n-        }\n-        break;\n-      case BYTES:\n-        while (iterator.hasNext()) {\n-          valueSet.add(Arrays.hashCode(_dictionary.getBytesValue(iterator.nextInt())));\n-        }\n-        break;\n-      default:\n-        throw new IllegalStateException(\"Illegal data type for DISTINCT_COUNT aggregation function: \" + valueType);\n-    }\n-    return valueSet;\n-  }\n-\n   @Override\n   public IntOpenHashSet merge(IntOpenHashSet intermediateResult1, IntOpenHashSet intermediateResult2) {\n     intermediateResult1.addAll(intermediateResult2);\n"}}, {"oid": "8dbbeb332b072e97ff02a08a289372dbddb42801", "url": "https://github.com/apache/pinot/commit/8dbbeb332b072e97ff02a08a289372dbddb42801", "message": "Optimize DistinctCount to store dictIds within segment", "committedDate": "2020-07-29T06:07:02Z", "type": "forcePushed"}, {"oid": "65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "url": "https://github.com/apache/pinot/commit/65bcf75bc98ee30ee0f7881dda0dcd94249da69d", "message": "Optimize DistinctCount to store dictIds within segment", "committedDate": "2020-07-29T06:40:55Z", "type": "forcePushed"}, {"oid": "503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "url": "https://github.com/apache/pinot/commit/503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "message": "Optimize DistinctCount to store dictIds within segment", "committedDate": "2020-07-29T06:46:24Z", "type": "commit"}, {"oid": "503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "url": "https://github.com/apache/pinot/commit/503829c3d75a15eeae25e3b8f8e2650bfbc252a1", "message": "Optimize DistinctCount to store dictIds within segment", "committedDate": "2020-07-29T06:46:24Z", "type": "forcePushed"}]}