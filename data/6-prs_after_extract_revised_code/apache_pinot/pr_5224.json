{"pr_number": 5224, "pr_title": "Support bootstrap mode for table rebalance", "pr_createdAt": "2020-04-08T00:12:40Z", "pr_url": "https://github.com/apache/pinot/pull/5224", "timeline": [{"oid": "94b79fb4818f32c3978d23dc4ec16233641e533f", "url": "https://github.com/apache/pinot/commit/94b79fb4818f32c3978d23dc4ec16233641e533f", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature", "committedDate": "2020-04-08T17:17:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4OTA2NQ==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405789065", "bodyText": "Can you adjust the comment here?", "author": "jackjlli", "createdAt": "2020-04-08T20:18:46Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -189,45 +163,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n     InstancePartitions instancePartitions = instancePartitionsMap.get(InstancePartitionsType.OFFLINE);\n     Preconditions.checkState(instancePartitions != null, \"Failed to find OFFLINE instance partitions for table: %s\",\n         _offlineTableName);\n-    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}\", _offlineTableName, instancePartitions);\n+    boolean bootstrap =\n+        config.getBoolean(RebalanceConfigConstants.BOOTSTRAP, RebalanceConfigConstants.DEFAULT_BOOTSTRAP);\n+    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}, bootstrap: {}\", _offlineTableName,\n+        instancePartitions, bootstrap);\n+    checkReplication(instancePartitions);\n \n     Map<String, Map<String, String>> newAssignment;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n-      // Non-replica-group based assignment\n+    if (bootstrap) {\n+      LOGGER.info(\"Bootstrapping the table: {}\", _offlineTableName);\n \n-      List<String> instances =\n-          SegmentAssignmentUtils.getInstancesForNonReplicaGroupBasedAssignment(instancePartitions, _replication);\n-      newAssignment = SegmentAssignmentUtils\n-          .rebalanceTableWithHelixAutoRebalanceStrategy(currentAssignment, instances, _replication);\n+      // When bootstrap is enabled, start with an empty table add reassign all segments", "originalCommit": "94b79fb4818f32c3978d23dc4ec16233641e533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNjE5Nw==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405806197", "bodyText": "What's the suggestion? I feel this comment is clear?", "author": "Jackie-Jiang", "createdAt": "2020-04-08T20:49:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc4OTA2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "da2bb76b6df802772df93e549accdfd5b3be14d3", "chunk": "diff --git a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java b/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java\nindex 3a35712d95..b11c8937ca 100644\n--- a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java\n+++ b/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java\n\n@@ -173,7 +173,7 @@ public class OfflineSegmentAssignment implements SegmentAssignment {\n     if (bootstrap) {\n       LOGGER.info(\"Bootstrapping the table: {}\", _offlineTableName);\n \n-      // When bootstrap is enabled, start with an empty table add reassign all segments\n+      // When bootstrap is enabled, start with an empty assignment and reassign all segments\n       newAssignment = new TreeMap<>();\n       for (String segment : currentAssignment.keySet()) {\n         List<String> assignedInstances = assignSegment(segment, newAssignment, instancePartitions);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NTYwNw==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405795607", "bodyText": "Will it print too many messages if there are many segments in a table?", "author": "jackjlli", "createdAt": "2020-04-08T20:30:41Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -99,49 +99,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n         _offlineTableName);\n     LOGGER.info(\"Assigning segment: {} with instance partitions: {} for table: {}\", segmentName, instancePartitions,\n         _offlineTableName);\n+    checkReplication(instancePartitions);\n \n-    List<String> instancesAssigned;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n+    List<String> instancesAssigned = assignSegment(segmentName, currentAssignment, instancePartitions);\n+\n+    LOGGER", "originalCommit": "94b79fb4818f32c3978d23dc4ec16233641e533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNTgyMQ==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405805821", "bodyText": "That is exactly the reason why the assignSegment is extracted into a helper method (line 128)", "author": "Jackie-Jiang", "createdAt": "2020-04-08T20:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5NTYwNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzUyOQ==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405843529", "bodyText": "empty table -> empty assignment?", "author": "snleee", "createdAt": "2020-04-08T22:08:45Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -184,41 +199,45 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n       LOGGER\n           .info(\"Reassigning COMPLETED segments with COMPLETED instance partitions for table: {}\", _realtimeTableName);\n \n-      if (completedInstancePartitions.getNumReplicaGroups() == 1) {\n-        // Non-replica-group based assignment\n+      if (bootstrap) {\n+        LOGGER.info(\"Bootstrapping the COMPLETED segments for table: {}\", _realtimeTableName);\n \n-        List<String> instances = SegmentAssignmentUtils\n-            .getInstancesForNonReplicaGroupBasedAssignment(completedInstancePartitions, _replication);\n-        newAssignment = SegmentAssignmentUtils\n-            .rebalanceTableWithHelixAutoRebalanceStrategy(completedSegmentAssignment, instances, _replication);\n+        // When bootstrap is enabled, start with an empty table add reassign all segments", "originalCommit": "94b79fb4818f32c3978d23dc4ec16233641e533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDc0MQ==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405880741", "bodyText": "Added more comments", "author": "Jackie-Jiang", "createdAt": "2020-04-08T23:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MzUyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "da2bb76b6df802772df93e549accdfd5b3be14d3", "chunk": "diff --git a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java b/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java\nindex 0005e344fd..36795263e1 100644\n--- a/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java\n+++ b/pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java\n\n@@ -202,7 +202,7 @@ public class RealtimeSegmentAssignment implements SegmentAssignment {\n       if (bootstrap) {\n         LOGGER.info(\"Bootstrapping the COMPLETED segments for table: {}\", _realtimeTableName);\n \n-        // When bootstrap is enabled, start with an empty table add reassign all segments\n+        // When bootstrap is enabled, start with an empty assignment and reassign all segments\n         newAssignment = new TreeMap<>();\n         for (String segment : completedSegmentAssignment.keySet()) {\n           List<String> assignedInstances = assignCompletedSegment(segment, newAssignment, completedInstancePartitions);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDIzNA==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405844234", "bodyText": "I assume that Pairs.intPairComparator will be an ascending order?", "author": "snleee", "createdAt": "2020-04-08T22:10:26Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/SegmentAssignmentUtils.java", "diffHunk": "@@ -86,6 +86,55 @@ private SegmentAssignmentUtils() {\n     return instances;\n   }\n \n+  /**\n+   * Assigns the segment for the non-replica-group based segment assignment strategy and returns the assigned instances.\n+   */\n+  static List<String> assignSegmentWithoutReplicaGroup(Map<String, Map<String, String>> currentAssignment,\n+      InstancePartitions instancePartitions, int replication) {\n+    List<String> instances =\n+        SegmentAssignmentUtils.getInstancesForNonReplicaGroupBasedAssignment(instancePartitions, replication);\n+    int[] numSegmentsAssignedPerInstance = getNumSegmentsAssignedPerInstance(currentAssignment, instances);\n+    int numInstances = numSegmentsAssignedPerInstance.length;\n+    PriorityQueue<Pairs.IntPair> heap = new PriorityQueue<>(numInstances, Pairs.intPairComparator());", "originalCommit": "94b79fb4818f32c3978d23dc4ec16233641e533f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4MDU5Mw==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405880593", "bodyText": "Yes, it is sorted on the left value firstly, then right value secondly.", "author": "Jackie-Jiang", "createdAt": "2020-04-08T23:56:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0NDIzNA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9a0878e1d7517412abd0f9d21a02039d5ee8bbec", "url": "https://github.com/apache/pinot/commit/9a0878e1d7517412abd0f9d21a02039d5ee8bbec", "message": "Support bootstrap mode for table rebalance\n\nAdd bootstrap mode where the rebalancer starts with an empty table and reassign all segments.\nThis mode can be used to rebalance table with hotspot servers.\nAll segments will be sorted alphabetically and assigned in a round-robin fashion, no minimum movement is guaranteed.\n\nOther related changes:\n- Extract some pieces of code for sharing between offline and real-time assignment\n- Extract assign segment logic without logging to reduce the log for bootstrapping\n- Add tests to cover the new feature", "committedDate": "2020-04-08T23:52:55Z", "type": "commit"}, {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3", "url": "https://github.com/apache/pinot/commit/da2bb76b6df802772df93e549accdfd5b3be14d3", "message": "Address comments", "committedDate": "2020-04-09T00:14:29Z", "type": "commit"}, {"oid": "da2bb76b6df802772df93e549accdfd5b3be14d3", "url": "https://github.com/apache/pinot/commit/da2bb76b6df802772df93e549accdfd5b3be14d3", "message": "Address comments", "committedDate": "2020-04-09T00:14:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc1NjY4NA==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405756684", "bodyText": "When will this be the case? Can you also add that in the comments?", "author": "mcvsubbu", "createdAt": "2020-04-08T19:18:35Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -99,49 +99,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n         _offlineTableName);\n     LOGGER.info(\"Assigning segment: {} with instance partitions: {} for table: {}\", segmentName, instancePartitions,\n         _offlineTableName);\n+    checkReplication(instancePartitions);\n \n-    List<String> instancesAssigned;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n+    List<String> instancesAssigned = assignSegment(segmentName, currentAssignment, instancePartitions);\n+\n+    LOGGER\n+        .info(\"Assigned segment: {} to instances: {} for table: {}\", segmentName, instancesAssigned, _offlineTableName);\n+    return instancesAssigned;\n+  }\n+\n+  /**\n+   * Helper method to check whether the number of replica-groups matches the table replication for replica-group based", "originalCommit": "94b79fb4818f32c3978d23dc4ec16233641e533f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5NzgzOQ==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405897839", "bodyText": "Suggest wording : \"Bootstrapping segment assignment for table ...\" Otherwise it may throw an admin off", "author": "mcvsubbu", "createdAt": "2020-04-09T00:57:39Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/OfflineSegmentAssignment.java", "diffHunk": "@@ -189,45 +163,48 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n     InstancePartitions instancePartitions = instancePartitionsMap.get(InstancePartitionsType.OFFLINE);\n     Preconditions.checkState(instancePartitions != null, \"Failed to find OFFLINE instance partitions for table: %s\",\n         _offlineTableName);\n-    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}\", _offlineTableName, instancePartitions);\n+    boolean bootstrap =\n+        config.getBoolean(RebalanceConfigConstants.BOOTSTRAP, RebalanceConfigConstants.DEFAULT_BOOTSTRAP);\n+    LOGGER.info(\"Rebalancing table: {} with instance partitions: {}, bootstrap: {}\", _offlineTableName,\n+        instancePartitions, bootstrap);\n+    checkReplication(instancePartitions);\n \n     Map<String, Map<String, String>> newAssignment;\n-    if (instancePartitions.getNumReplicaGroups() == 1) {\n-      // Non-replica-group based assignment\n+    if (bootstrap) {\n+      LOGGER.info(\"Bootstrapping the table: {}\", _offlineTableName);", "originalCommit": "da2bb76b6df802772df93e549accdfd5b3be14d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTM5NA==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405899394", "bodyText": "\"Bootstrapping segment assignment for COMPLETED segments...\"", "author": "mcvsubbu", "createdAt": "2020-04-09T01:03:42Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -184,41 +199,45 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n       LOGGER\n           .info(\"Reassigning COMPLETED segments with COMPLETED instance partitions for table: {}\", _realtimeTableName);\n \n-      if (completedInstancePartitions.getNumReplicaGroups() == 1) {\n-        // Non-replica-group based assignment\n+      if (bootstrap) {\n+        LOGGER.info(\"Bootstrapping the COMPLETED segments for table: {}\", _realtimeTableName);", "originalCommit": "da2bb76b6df802772df93e549accdfd5b3be14d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTczMA==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405899730", "bodyText": "Is this a typo? Or are you intentionally calling assignConsumingSegment() method?", "author": "mcvsubbu", "createdAt": "2020-04-09T01:04:56Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/assignment/segment/RealtimeSegmentAssignment.java", "diffHunk": "@@ -230,7 +249,7 @@ public void init(HelixManager helixManager, TableConfig tableConfig) {\n \n       newAssignment = new TreeMap<>();\n       for (String segmentName : completedSegmentAssignment.keySet()) {\n-        List<String> instancesAssigned = assignSegment(segmentName, consumingInstancePartitions);\n+        List<String> instancesAssigned = assignConsumingSegment(segmentName, consumingInstancePartitions);", "originalCommit": "da2bb76b6df802772df93e549accdfd5b3be14d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwMjY5OA==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405902698", "bodyText": "This is intentional. This code path is for scenarios when completed instance partitions are not provided (no segment relocation), we want to keep the consuming partition on the correct server. This is useful when adding/removing servers for real-time tables.", "author": "Jackie-Jiang", "createdAt": "2020-04-09T01:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTczMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkwMjkzNw==", "url": "https://github.com/apache/pinot/pull/5224#discussion_r405902937", "bodyText": "ah got it", "author": "mcvsubbu", "createdAt": "2020-04-09T01:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg5OTczMA=="}], "type": "inlineReview", "revised_code": null}]}