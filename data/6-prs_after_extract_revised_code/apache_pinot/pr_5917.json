{"pr_number": 5917, "pr_title": "Starts Broker and Server in parallel when using ServiceManager", "pr_createdAt": "2020-08-25T13:12:08Z", "pr_url": "https://github.com/apache/pinot/pull/5917", "timeline": [{"oid": "137180f55441295fa8032a0abc2dcf9f79dcac3a", "url": "https://github.com/apache/pinot/commit/137180f55441295fa8032a0abc2dcf9f79dcac3a", "message": "Starts Broker and Server in parallel when using ServiceManager\n\nFixes #5876", "committedDate": "2020-08-25T13:09:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476441553", "bodyText": "intentionally left controller out of here as it seemed there was some reason to. Otherwise, I'd like to put it in :D", "author": "codefromthecrypt", "createdAt": "2020-08-25T13:19:16Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java", "diffHunk": "@@ -192,7 +192,20 @@ public boolean execute()\n   }\n \n   private void startPinotService(Map<String, Object> properties) {\n-    startPinotService(ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString()), properties);\n+    ServiceRole role = ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString());\n+    switch (role) {\n+      // Broker and Server can be started in parallel always\n+      case BROKER:\n+      case SERVER:", "originalCommit": "137180f55441295fa8032a0abc2dcf9f79dcac3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyNzU2MA==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476827560", "bodyText": "I dont think there is any reason to not add controller. @fx19880617", "author": "kishoreg", "createdAt": "2020-08-25T23:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkwNDE0OA==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476904148", "bodyText": "If it's a new cluster, then controller has to be started first, otherwise broker and server will fail.\nProbably we can add a check to decide if the cluster is already there then start controller in parallel as well.", "author": "xiangfu0", "createdAt": "2020-08-26T00:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyODIzNw==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476928237", "bodyText": "hmm so in this case, if you have multiple CLI args, you can be in the wrong order subtly.. maybe they need to be sorted?", "author": "codefromthecrypt", "createdAt": "2020-08-26T00:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyOTEzMQ==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476929131", "bodyText": "also I don't know how we check if \"cluster is already\" so if you feed me a command I can...", "author": "codefromthecrypt", "createdAt": "2020-08-26T00:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk0MjI4NQ==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476942285", "bodyText": "If user starts broker/server first for a new cluster, then it will fail in-relevant to your changes.", "author": "xiangfu0", "createdAt": "2020-08-26T01:14:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk0NDk3OA==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476944978", "bodyText": "to check if a cluster is already there, you can create a spectator HelixManager by:\nHelixManager spectatorHelixManager = HelixManagerFactory.getZKHelixManager(_clusterName, instance_id, InstanceType.SPECTATOR, _zkServers);\nspectatorHelixManager.connect();\nspectatorHelixManager.disconnect();\n\nIf it throws exception, then it means the cluster is not there.", "author": "xiangfu0", "createdAt": "2020-08-26T01:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAzMzQxNw==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r477033417", "bodyText": "In the context of SM I don't know what to use as instance_id", "author": "codefromthecrypt", "createdAt": "2020-08-26T04:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAzMzc3NA==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r477033774", "bodyText": "nm", "author": "codefromthecrypt", "createdAt": "2020-08-26T04:56:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTU1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4460cd7909e6e93b841fbf14c69a8488ebb6cc81", "chunk": "diff --git a/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java b/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\nindex 2dbf26bce1..e14ddc8c59 100644\n--- a/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\n+++ b/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\n\n@@ -191,39 +203,66 @@ public class StartServiceManagerCommand extends AbstractBaseAdminCommand impleme\n     }\n   }\n \n-  private void startPinotService(Map<String, Object> properties) {\n-    ServiceRole role = ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString());\n-    switch (role) {\n-      // Broker and Server can be started in parallel always\n-      case BROKER:\n-      case SERVER:\n-        new Thread(\"Starting \" + role) {\n-          @Override public void run() {\n-            startPinotService(role, properties);\n-          }\n-        }.start();\n-        break;\n-      default:\n-        startPinotService(role, properties);\n+  public StartServiceManagerCommand addBootstrapService(ServiceRole role, Map<String, Object> config) {\n+    config.put(PINOT_SERVICE_ROLE, role.toString());\n+\n+    _bootstrapConfigurations.put(role, config);\n+\n+    return this;\n+  }\n+\n+  /**\n+   * Starts a controller synchronously unless the cluster already exists. Other services start in parallel.\n+   */\n+  private void startBootstrapServices() {\n+    boolean clusterExists = clusterExists(_pinotServiceManager.getInstanceId());\n+\n+    if (!clusterExists) {\n+      // start controller(s) synchronously so that other services don't fail\n+      for (Map<String, Object> config : _bootstrapConfigurations.get(CONTROLLER)) {\n+        startPinotService(CONTROLLER, config);\n+      }\n+    }\n+\n+    for (Map.Entry<ServiceRole, Map<String, Object>> roleToConfig : _bootstrapConfigurations.entries()) {\n+      ServiceRole role = roleToConfig.getKey();\n+      if (!clusterExists && role == CONTROLLER) continue; // already started\n+\n+      Map<String, Object> config = roleToConfig.getValue();\n+      new Thread(\"Starting \" + role) {\n+        @Override public void run() {\n+          startPinotService(role, config);\n+        }\n+      }.start();\n+    }\n+  }\n+\n+  private boolean clusterExists(String instanceId) {\n+    HelixManager spectatorHelixManager =\n+        HelixManagerFactory.getZKHelixManager(_clusterName, instanceId, InstanceType.SPECTATOR, _zkAddress);\n+    try {\n+      spectatorHelixManager.connect();\n+      spectatorHelixManager.disconnect();\n+      return true;\n+    } catch (Exception ignored) {\n+      return false;\n     }\n   }\n \n-  public boolean startPinotService(ServiceRole role, Map<String, Object> properties) {\n+  private boolean startPinotService(ServiceRole role, Map<String, Object> properties) {\n     try {\n+      LOGGER.info(\"Starting a Pinot [{}] at {}s since launch\", role, startOffsetSeconds());\n       String instanceId = _pinotServiceManager.startRole(role, properties);\n-      LOGGER.info(\"Started Pinot [{}] Instance [{}].\", role, instanceId);\n+      LOGGER.info(\"Started Pinot [{}] instance [{}] at {}s since launch\", role, instanceId, startOffsetSeconds());\n     } catch (Exception e) {\n-      LOGGER.error(String.format(\"Failed to start a [ %s ] Service\", role), e);\n+      LOGGER.error(String.format(\"Failed to start a Pinot [%s] at %s since launch\", role, startOffsetSeconds()), e);\n       return false;\n     }\n     return true;\n   }\n \n-  public StartServiceManagerCommand addBootstrapService(ServiceRole role, Map<String, Object> properties) {\n-    properties.put(PINOT_SERVICE_ROLE, role.toString());\n-    \n-    _bootstrapConfigurations.add(properties);\n-    \n-    return this;\n+  /** Creates millis precision unit of seconds. ex 1.002 */\n+  private static float startOffsetSeconds() {\n+    return TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTick) / 1000f;\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476828802", "bodyText": "Add a log before starting the service and another one after the service is started and measure log the time it took to start", "author": "kishoreg", "createdAt": "2020-08-25T23:02:59Z", "path": "pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java", "diffHunk": "@@ -192,7 +192,20 @@ public boolean execute()\n   }\n \n   private void startPinotService(Map<String, Object> properties) {\n-    startPinotService(ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString()), properties);\n+    ServiceRole role = ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString());\n+    switch (role) {\n+      // Broker and Server can be started in parallel always\n+      case BROKER:\n+      case SERVER:\n+        new Thread(\"Starting \" + role) {\n+          @Override public void run() {\n+            startPinotService(role, properties);\n+          }\n+        }.start();\n+        break;\n+      default:\n+        startPinotService(role, properties);", "originalCommit": "137180f55441295fa8032a0abc2dcf9f79dcac3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjkyODkyNw==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476928927", "bodyText": "I presume you mean inside startPinotService as it is a blocking command (then useful for both the parallel and sync paths)", "author": "codefromthecrypt", "createdAt": "2020-08-26T00:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk0NjQ3MQ==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476946471", "bodyText": "Agreed, it's good to add logs to measure the startup time.", "author": "xiangfu0", "createdAt": "2020-08-26T01:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk3NzI0Ng==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476977246", "bodyText": "you want to just time each service command here right? this would be different than composite startup time", "author": "codefromthecrypt", "createdAt": "2020-08-26T02:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk4NDM5MQ==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476984391", "bodyText": "Yes, each service. Also log the wall clock time, that will help us understand what\u2019s debug slow starts", "author": "kishoreg", "createdAt": "2020-08-26T02:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5NTQwMg==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476995402", "bodyText": "ok FWIW what I used before was -verbose:gc for similar :P you can see time since startup for each GC event, which are often enough to figure out time like this.\n[0.012s][info][gc] Using G1\n[0.066s][info][gc] Periodic GC disabled\n[0.753s][info][gc] GC(0) Pause Young (Normal) (G1 Evacuation Pause) 12M->2M(256M) 7.433ms\n[1.108s][info][gc] GC(1) Pause Young (Normal) (G1 Evacuation Pause) 12M->3M(256M) 9.164ms\n[1.511s][info][gc] GC(2) Pause Young (Concurrent Start) (Metadata GC Threshold) 15M->4M(256M) 6.252ms\n[1.511s][info][gc] GC(3) Concurrent Cycle\n[1.520s][info][gc] GC(3) Pause Remark 4M->4M(256M) 1.834ms\n[1.523s][info][gc] GC(3) Pause Cleanup 4M->4M(256M) 0.172ms\n[1.525s][info][gc] GC(3) Concurrent Cycle 13.819ms\n\nEx.\n\"starting $role at N.NNNs since launch\"\n\"started/error starting $role at N.NNNs since launch\"", "author": "codefromthecrypt", "createdAt": "2020-08-26T02:33:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5OTQwNw==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476999407", "bodyText": "Ah nice idea. Go for it!", "author": "kishoreg", "createdAt": "2020-08-26T02:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njk5OTQyMA==", "url": "https://github.com/apache/pinot/pull/5917#discussion_r476999420", "bodyText": "Ah nice idea. Go for it!", "author": "kishoreg", "createdAt": "2020-08-26T02:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjgyODgwMg=="}], "type": "inlineReview", "revised_code": {"commit": "4460cd7909e6e93b841fbf14c69a8488ebb6cc81", "chunk": "diff --git a/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java b/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\nindex 2dbf26bce1..e14ddc8c59 100644\n--- a/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\n+++ b/pinot-tools/src/main/java/org/apache/pinot/tools/admin/command/StartServiceManagerCommand.java\n\n@@ -191,39 +203,66 @@ public class StartServiceManagerCommand extends AbstractBaseAdminCommand impleme\n     }\n   }\n \n-  private void startPinotService(Map<String, Object> properties) {\n-    ServiceRole role = ServiceRole.valueOf(properties.get(PINOT_SERVICE_ROLE).toString());\n-    switch (role) {\n-      // Broker and Server can be started in parallel always\n-      case BROKER:\n-      case SERVER:\n-        new Thread(\"Starting \" + role) {\n-          @Override public void run() {\n-            startPinotService(role, properties);\n-          }\n-        }.start();\n-        break;\n-      default:\n-        startPinotService(role, properties);\n+  public StartServiceManagerCommand addBootstrapService(ServiceRole role, Map<String, Object> config) {\n+    config.put(PINOT_SERVICE_ROLE, role.toString());\n+\n+    _bootstrapConfigurations.put(role, config);\n+\n+    return this;\n+  }\n+\n+  /**\n+   * Starts a controller synchronously unless the cluster already exists. Other services start in parallel.\n+   */\n+  private void startBootstrapServices() {\n+    boolean clusterExists = clusterExists(_pinotServiceManager.getInstanceId());\n+\n+    if (!clusterExists) {\n+      // start controller(s) synchronously so that other services don't fail\n+      for (Map<String, Object> config : _bootstrapConfigurations.get(CONTROLLER)) {\n+        startPinotService(CONTROLLER, config);\n+      }\n+    }\n+\n+    for (Map.Entry<ServiceRole, Map<String, Object>> roleToConfig : _bootstrapConfigurations.entries()) {\n+      ServiceRole role = roleToConfig.getKey();\n+      if (!clusterExists && role == CONTROLLER) continue; // already started\n+\n+      Map<String, Object> config = roleToConfig.getValue();\n+      new Thread(\"Starting \" + role) {\n+        @Override public void run() {\n+          startPinotService(role, config);\n+        }\n+      }.start();\n+    }\n+  }\n+\n+  private boolean clusterExists(String instanceId) {\n+    HelixManager spectatorHelixManager =\n+        HelixManagerFactory.getZKHelixManager(_clusterName, instanceId, InstanceType.SPECTATOR, _zkAddress);\n+    try {\n+      spectatorHelixManager.connect();\n+      spectatorHelixManager.disconnect();\n+      return true;\n+    } catch (Exception ignored) {\n+      return false;\n     }\n   }\n \n-  public boolean startPinotService(ServiceRole role, Map<String, Object> properties) {\n+  private boolean startPinotService(ServiceRole role, Map<String, Object> properties) {\n     try {\n+      LOGGER.info(\"Starting a Pinot [{}] at {}s since launch\", role, startOffsetSeconds());\n       String instanceId = _pinotServiceManager.startRole(role, properties);\n-      LOGGER.info(\"Started Pinot [{}] Instance [{}].\", role, instanceId);\n+      LOGGER.info(\"Started Pinot [{}] instance [{}] at {}s since launch\", role, instanceId, startOffsetSeconds());\n     } catch (Exception e) {\n-      LOGGER.error(String.format(\"Failed to start a [ %s ] Service\", role), e);\n+      LOGGER.error(String.format(\"Failed to start a Pinot [%s] at %s since launch\", role, startOffsetSeconds()), e);\n       return false;\n     }\n     return true;\n   }\n \n-  public StartServiceManagerCommand addBootstrapService(ServiceRole role, Map<String, Object> properties) {\n-    properties.put(PINOT_SERVICE_ROLE, role.toString());\n-    \n-    _bootstrapConfigurations.add(properties);\n-    \n-    return this;\n+  /** Creates millis precision unit of seconds. ex 1.002 */\n+  private static float startOffsetSeconds() {\n+    return TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - startTick) / 1000f;\n   }\n }\n"}}, {"oid": "4460cd7909e6e93b841fbf14c69a8488ebb6cc81", "url": "https://github.com/apache/pinot/commit/4460cd7909e6e93b841fbf14c69a8488ebb6cc81", "message": "rejig", "committedDate": "2020-08-26T06:14:20Z", "type": "commit"}, {"oid": "7c3850c7aa433d5c5f94ec46d821c4d252cd0ac9", "url": "https://github.com/apache/pinot/commit/7c3850c7aa433d5c5f94ec46d821c4d252cd0ac9", "message": "also time SM", "committedDate": "2020-08-26T07:43:57Z", "type": "commit"}, {"oid": "ab7306fc9f4453536aa2d84e2c2c42200a1d32b9", "url": "https://github.com/apache/pinot/commit/ab7306fc9f4453536aa2d84e2c2c42200a1d32b9", "message": "block until services complete", "committedDate": "2020-08-26T09:24:59Z", "type": "commit"}, {"oid": "3508311f31a79d45a279d3a2fe1437bdfd2358be", "url": "https://github.com/apache/pinot/commit/3508311f31a79d45a279d3a2fe1437bdfd2358be", "message": "getZKHelixManager can throw", "committedDate": "2020-08-26T09:30:17Z", "type": "commit"}, {"oid": "42ea513a77800ac853ece200c9e92b2a5cfca711", "url": "https://github.com/apache/pinot/commit/42ea513a77800ac853ece200c9e92b2a5cfca711", "message": "Don't check helix as it spams logs", "committedDate": "2020-08-26T09:46:49Z", "type": "commit"}, {"oid": "33ce4636bf0aaf95d5d48fab392b0e11a4366587", "url": "https://github.com/apache/pinot/commit/33ce4636bf0aaf95d5d48fab392b0e11a4366587", "message": "matches case format", "committedDate": "2020-08-26T09:53:08Z", "type": "commit"}, {"oid": "b6a7fb624c88b8f881973004ccb45e1602aac4fb", "url": "https://github.com/apache/pinot/commit/b6a7fb624c88b8f881973004ccb45e1602aac4fb", "message": "Ensures any failure results in exit code 1", "committedDate": "2020-08-27T00:58:43Z", "type": "commit"}]}