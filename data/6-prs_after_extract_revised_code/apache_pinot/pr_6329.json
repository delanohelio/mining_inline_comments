{"pr_number": 6329, "pr_title": "Fix table cache logic in pinot-broker", "pr_createdAt": "2020-12-07T19:25:43Z", "pr_url": "https://github.com/apache/pinot/pull/6329", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMDMzMw==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537810333", "bodyText": "You can directly use assertTrue(), same for other places", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:29:05Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java", "diffHunk": "@@ -1307,7 +1308,8 @@ public void testCaseInsensitivity() {\n \n     for (String query : queries) {\n       try {\n-        postQuery(query);\n+        JsonNode response = postSqlQuery(query);\n+        Assert.assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, query + \" failed\");", "originalCommit": "32659d9d9f2b8a07478b66062ca61a337e6617d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg1OTA0NQ==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537859045", "bodyText": "Updated", "author": "jackjlli", "createdAt": "2020-12-07T21:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMDMzMw=="}], "type": "inlineReview", "revised_code": {"commit": "e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "chunk": "diff --git a/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java b/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\nindex 8421ad6d13..10ad5ea64e 100644\n--- a/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\n+++ b/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\n\n@@ -1308,8 +1308,11 @@ public class OfflineClusterIntegrationTest extends BaseClusterIntegrationTestSet\n \n     for (String query : queries) {\n       try {\n-        JsonNode response = postSqlQuery(query);\n-        Assert.assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, query + \" failed\");\n+        JsonNode response = postQuery(query);\n+        assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, \"PQL: \" + query + \" failed\");\n+\n+        response = postSqlQuery(query);\n+        assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, \"SQL: \" + query + \" failed\");\n       } catch (Exception e) {\n         // Fail the test when exception caught\n         throw new RuntimeException(\"Got Exceptions from query - \" + query);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMTkzOA==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537811938", "bodyText": "Can you please check why it does not apply to pql? It should apply to both pql and sql", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:31:51Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java", "diffHunk": "@@ -1307,7 +1308,8 @@ public void testCaseInsensitivity() {\n \n     for (String query : queries) {\n       try {\n-        postQuery(query);\n+        JsonNode response = postSqlQuery(query);", "originalCommit": "32659d9d9f2b8a07478b66062ca61a337e6617d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg1OTY5Ng==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537859696", "bodyText": "It seems the table name is set from the resource name, which made the table cache failed to get the correct schema to compare. I've included the fix in this PR.", "author": "jackjlli", "createdAt": "2020-12-07T21:52:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMTkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "chunk": "diff --git a/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java b/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\nindex 8421ad6d13..10ad5ea64e 100644\n--- a/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\n+++ b/pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/OfflineClusterIntegrationTest.java\n\n@@ -1308,8 +1308,11 @@ public class OfflineClusterIntegrationTest extends BaseClusterIntegrationTestSet\n \n     for (String query : queries) {\n       try {\n-        JsonNode response = postSqlQuery(query);\n-        Assert.assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, query + \" failed\");\n+        JsonNode response = postQuery(query);\n+        assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, \"PQL: \" + query + \" failed\");\n+\n+        response = postSqlQuery(query);\n+        assertTrue(response.get(\"numSegmentsProcessed\").asLong() >= 1L, \"SQL: \" + query + \" failed\");\n       } catch (Exception e) {\n         // Fail the test when exception caught\n         throw new RuntimeException(\"Got Exceptions from query - \" + query);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMzU3NA==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537813574", "bodyText": "Good catch, but how the the test pass before?", "author": "Jackie-Jiang", "createdAt": "2020-12-07T20:34:27Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -1002,7 +1002,7 @@ private String getActualColumnName(String rawTableName, String columnName,\n         columnName = splits[1];\n       }\n       if (columnNameMap != null) {\n-        return columnNameMap.getOrDefault(columnName, columnName);\n+        return columnNameMap.getOrDefault(columnName.toLowerCase(), columnName);", "originalCommit": "32659d9d9f2b8a07478b66062ca61a337e6617d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg0MjMyMA==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r537842320", "bodyText": "We skipped validating the response content in OfflineClusterIntegrationTest.", "author": "jackjlli", "createdAt": "2020-12-07T21:22:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgxMzU3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "url": "https://github.com/apache/pinot/commit/e8c24395777fc6088bfdd60974c7bb7ffb9f3556", "message": "Fix table cache in pinot-broker", "committedDate": "2020-12-07T21:50:38Z", "type": "forcePushed"}, {"oid": "121c149e92ea9511c7ec5a0db45357f002eb1966", "url": "https://github.com/apache/pinot/commit/121c149e92ea9511c7ec5a0db45357f002eb1966", "message": "Fix table cache in pinot-broker", "committedDate": "2020-12-07T21:52:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r538844562", "bodyText": "I think we don't differentiate table name and resource name right now, so maybe a better fix should be in TableNameAstNode to remove the resourceName and only keep the tableName?", "author": "Jackie-Jiang", "createdAt": "2020-12-08T22:09:08Z", "path": "pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java", "diffHunk": "@@ -106,7 +106,7 @@ public String toString() {\n   public void updateBrokerRequest(BrokerRequest brokerRequest) {\n     // Set the query source\n     QuerySource querySource = new QuerySource();\n-    querySource.setTableName(_resourceName);\n+    querySource.setTableName(_tableName);", "originalCommit": "121c149e92ea9511c7ec5a0db45357f002eb1966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NjAwNg==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r538846006", "bodyText": "Also curious about how it causes the failure for PQL. I don't see any table name with dot embedded", "author": "Jackie-Jiang", "createdAt": "2020-12-08T22:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg2NDM0Mg==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r538864342", "bodyText": "So before this PR, if the query is like SELECT myDB.myTable FROM ..., the table name would be parsed as myDB instead of myTable. In this case,\n\nFor getting table name from table cache in broker, since there is no table called myDB, the table name won't be adjusted in updateTableName method of BaseBrokerRequestHandler class.\nIn server, since there is no table called myDB, an empty response would be returned.\n\nTable name with dot embedded is actually supported right now. You can refer to the calcite parser logic and the testCaseInsensitivity of OfflineClusterIntegrationTest.", "author": "jackjlli", "createdAt": "2020-12-08T22:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1NTkzOA==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r539555938", "bodyText": "I see. You might also want to use _tableName on line 172 for updating the pinot query", "author": "Jackie-Jiang", "createdAt": "2020-12-09T18:43:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcyNDgxNg==", "url": "https://github.com/apache/pinot/pull/6329#discussion_r539724816", "bodyText": "Thanks. Addressed.", "author": "jackjlli", "createdAt": "2020-12-09T23:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NDU2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "110af3283fa4d69c5d4c81d44deadc036a08c8e4", "url": "https://github.com/apache/pinot/commit/110af3283fa4d69c5d4c81d44deadc036a08c8e4", "message": "Fix table cache in pinot-broker", "committedDate": "2020-12-09T23:26:30Z", "type": "commit"}, {"oid": "110af3283fa4d69c5d4c81d44deadc036a08c8e4", "url": "https://github.com/apache/pinot/commit/110af3283fa4d69c5d4c81d44deadc036a08c8e4", "message": "Fix table cache in pinot-broker", "committedDate": "2020-12-09T23:26:30Z", "type": "forcePushed"}]}