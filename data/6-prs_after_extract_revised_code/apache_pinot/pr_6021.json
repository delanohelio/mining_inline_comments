{"pr_number": 6021, "pr_title": "List of partitioners in SegmentProcessorFramework", "pr_createdAt": "2020-09-15T22:04:55Z", "pr_url": "https://github.com/apache/pinot/pull/6021", "timeline": [{"oid": "639c4c8b6f7e147365e7a18a088e26338f4d0e5f", "url": "https://github.com/apache/pinot/commit/639c4c8b6f7e147365e7a18a088e26338f4d0e5f", "message": "List of partitioners in SegmentProcessorFramework", "committedDate": "2020-09-15T21:56:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489089813", "bodyText": "The \"_\" here is very significant, right? It cannot be changed, and has to be used the same way across multiple components. Could you please declare it as. a final string in some Constants class as a partition separator or something?\nAnd then re-use in tests\nthanks", "author": "mcvsubbu", "createdAt": "2020-09-16T00:22:59Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/processing/framework/SegmentMapper.java", "diffHunk": "@@ -100,8 +110,11 @@ public void map()\n       }\n \n       // Partitioning\n-      // TODO: 2 step partitioner. 1) Apply custom partitioner 2) Apply table config partitioner. Combine both to get final partition.\n-      String partition = _partitioner.getPartition(reusableRow);\n+      int p = 0;\n+      for (Partitioner partitioner : _partitioners) {\n+        partitions[p++] = partitioner.getPartition(reusableRow);\n+      }\n+      String partition = StringUtil.join(\"_\", partitions);", "originalCommit": "639c4c8b6f7e147365e7a18a088e26338f4d0e5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA5MDk1Mw==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489090953", "bodyText": "I don't think the framework relies on this to extract the partition info. But agree on introducing a constant for it", "author": "Jackie-Jiang", "createdAt": "2020-09-16T00:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEwMjMxOA==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489102318", "bodyText": "Actually, it is not significant at all. It can be changed, and is not used by any other components. It won't even matter beyond the scope of that joiner line. And hence I don't think it needs to be scoped out of this class, or even out of this method.", "author": "npawar", "createdAt": "2020-09-16T01:09:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTEzODAxMw==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489138013", "bodyText": "We are partitioning the data, and the brokers have to construct the same partition id in the same order of columns and  with the same partition function right?\nAlso, what is the use case for partitioning on more than one column?", "author": "mcvsubbu", "createdAt": "2020-09-16T03:22:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE4Mjc2Mw==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489182763", "bodyText": "Use case: say data in input segments is spread across 3 days. In the resulting segments, we want to create a segment for each day. Additionally, we want partitioning on some id column for query purposes.\nPartitioning by time column is first step. This doesn't affect segment metadata or broker routing. This is simply used by the framework, and it's scope ends with the framework. It's merely helping create date aligned input files for Segment generation stage.\nPartitioning by id column is second step. This is for queries. This will be whatever is in the table config. Only this partition will get set in the segment metadata. And even that will happen during segment creation.\nSee this comment and discussion:#5934 (comment)", "author": "npawar", "createdAt": "2020-09-16T06:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTY0Ng==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489551646", "bodyText": "Maybe I am missing something, I will try to find it in the design document.\n\nIt seems to me that there may be at most 2 partitioners, so is making that a Pair better? Or, there should be a comment and an assert some place that the size is two.\nThe word partition confused me into thinking that we are somehow respecting partitioning of data using a partition key with underscores (with brokers constructing some partition keys). That is clearly not the case here. Maybe rename this as a splitKey instead of partition?", "author": "mcvsubbu", "createdAt": "2020-09-16T16:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY3MjE3Nw==", "url": "https://github.com/apache/pinot/pull/6021#discussion_r489672177", "bodyText": "Practically, for the use case I described, it will be 2. But it need not be (there could be more custom logic). Also the json config spec has List of partitions, so I just continued it as List.\nAll these things are not set in stone as of now. We will be continuosly re-evaluating, optimizing and editing this framework, as we begin using it (for minion, and merge). It is difficult to predict right now and I prefer to not introduce restrictions on number of partitioners.", "author": "npawar", "createdAt": "2020-09-16T18:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA4OTgxMw=="}], "type": "inlineReview", "revised_code": null}]}