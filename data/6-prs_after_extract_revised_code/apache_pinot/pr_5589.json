{"pr_number": 5589, "pr_title": "Fix server log for execution stats", "pr_createdAt": "2020-06-18T15:58:56Z", "pr_url": "https://github.com/apache/pinot/pull/5589", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzY1MQ==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442337651", "bodyText": "There may be (are) scripts that use this log line to parse. Unless absolutely needed, let us not change the case for requestId?", "author": "mcvsubbu", "createdAt": "2020-06-18T16:03:56Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -199,11 +199,13 @@ public void stop() {\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n       LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"", "originalCommit": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1NDU2Mw==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442354563", "bodyText": "done", "author": "siddharthteotia", "createdAt": "2020-06-18T16:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNzY1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "866dcb7a1bdf519600f562139443d409dfe368ac", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\nindex 5bc9291757..dc2e8b9af3 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n\n@@ -197,11 +197,12 @@ public abstract class QueryScheduler {\n     int numSegmentsQueried = queryRequest.getSegmentsToQuery().size();\n     long schedulerWaitMs = timerContext.getPhaseDurationMs(ServerQueryPhase.SCHEDULER_WAIT);\n \n+    // Please keep the format as name=value comma-separated with no spaces\n+    // Please add new entries at the end\n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n-      LOGGER.info(\n-          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"\n-              + \"numDocsScanned:{},scanInFilter:{},scanPostFilter:{},sched:{}\", requestId, tableNameWithType,\n+      LOGGER.info(\"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs={},reqDeserMs={},totalExecMs={},resSerMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n+              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\", requestId, tableNameWithType,\n           numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched, numSegmentsConsuming, schedulerWaitMs,\n           timerContext.getPhaseDurationMs(ServerQueryPhase.REQUEST_DESERIALIZATION),\n           timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442338555", "bodyText": "Can you add the new items at the end and not change the names of the variables? Is the changing of var names absolutely needed?\nIf we are trying to minimize the line length, another way of doing this will be to create a separate logger that outputs in binary, and provide a utility to read it?", "author": "mcvsubbu", "createdAt": "2020-06-18T16:05:19Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -199,11 +199,13 @@ public void stop() {\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n       LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"", "originalCommit": "cdd443ab4df72e5f3d83de1a70525d3d75e4c71c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1MTU4NQ==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442351585", "bodyText": "@mcvsubbu, I didn't change any variable names. Have just added request deserialization (reqDeserMs) and response serialization (resSerMs) times. Nothing else has changed", "author": "siddharthteotia", "createdAt": "2020-06-18T16:26:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM1NTE3Ng==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442355176", "bodyText": "Also new items were not added at the end because I think it is better to keep the timing info together", "author": "siddharthteotia", "createdAt": "2020-06-18T16:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4MjEyNQ==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442382125", "bodyText": "let us stick to \"name1=value1,name2=value2,....\". (IOW comma-separtated name=value, no other spaces).\nMy bad when I wrote \"variables\". I meant item names. For some reason, I thought \"schedulerWaitMs\" was changed to \"sched\" May be I was mistaken.\nSorry to harp on this, but when we look through gazillion log lines scripts help if the format is uniform.", "author": "mcvsubbu", "createdAt": "2020-06-18T17:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzODU1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "866dcb7a1bdf519600f562139443d409dfe368ac", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\nindex 5bc9291757..dc2e8b9af3 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n\n@@ -197,11 +197,12 @@ public abstract class QueryScheduler {\n     int numSegmentsQueried = queryRequest.getSegmentsToQuery().size();\n     long schedulerWaitMs = timerContext.getPhaseDurationMs(ServerQueryPhase.SCHEDULER_WAIT);\n \n+    // Please keep the format as name=value comma-separated with no spaces\n+    // Please add new entries at the end\n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n-      LOGGER.info(\n-          \"Processed RequestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"\n-              + \"numDocsScanned:{},scanInFilter:{},scanPostFilter:{},sched:{}\", requestId, tableNameWithType,\n+      LOGGER.info(\"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs={},reqDeserMs={},totalExecMs={},resSerMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n+              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\", requestId, tableNameWithType,\n           numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched, numSegmentsConsuming, schedulerWaitMs,\n           timerContext.getPhaseDurationMs(ServerQueryPhase.REQUEST_DESERIALIZATION),\n           timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyMzE5OA==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442423198", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n          \n          \n            \n                  LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming):{}/{}/{}/{},\"", "author": "Jackie-Jiang", "createdAt": "2020-06-18T18:31:21Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java", "diffHunk": "@@ -198,12 +198,13 @@ public void stop() {\n     long schedulerWaitMs = timerContext.getPhaseDurationMs(ServerQueryPhase.SCHEDULER_WAIT);\n \n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n-      LOGGER.info(\n-          \"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs={},totalExecMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n-              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\",\n-          requestId, tableNameWithType, numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched,\n-          numSegmentsConsuming, schedulerWaitMs, timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n+      LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"", "originalCommit": "e0236ebe210fe80a648f6a0ba0140babd75a43fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjE1OQ==", "url": "https://github.com/apache/pinot/pull/5589#discussion_r442522159", "bodyText": "\"=\" is better for parsing out since \":\" is also present in timestamps. Made this consistent with log in BaseBrokerRequestHandler", "author": "siddharthteotia", "createdAt": "2020-06-18T21:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQyMzE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "866dcb7a1bdf519600f562139443d409dfe368ac", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\nindex e49b854cc5..dc2e8b9af3 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/scheduler/QueryScheduler.java\n\n@@ -197,10 +197,12 @@ public abstract class QueryScheduler {\n     int numSegmentsQueried = queryRequest.getSegmentsToQuery().size();\n     long schedulerWaitMs = timerContext.getPhaseDurationMs(ServerQueryPhase.SCHEDULER_WAIT);\n \n+    // Please keep the format as name=value comma-separated with no spaces\n+    // Please add new entries at the end\n     if (queryLogRateLimiter.tryAcquire() || forceLog(schedulerWaitMs, numDocsScanned)) {\n-      LOGGER.info(\"Processed requestId:{},table:{},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n-              + \"schedulerWaitMs:{},reqDeserMs:{},totalExecMs:{},resSerMs:{},totalTimeMs:{},minConsumingFreshnessMs:{},broker:{},\"\n-              + \"numDocsScanned:{},scanInFilter:{},scanPostFilter:{},sched:{}\", requestId, tableNameWithType,\n+      LOGGER.info(\"Processed requestId={},table={},segments(queried/processed/matched/consuming)={}/{}/{}/{},\"\n+              + \"schedulerWaitMs={},reqDeserMs={},totalExecMs={},resSerMs={},totalTimeMs={},minConsumingFreshnessMs={},broker={},\"\n+              + \"numDocsScanned={},scanInFilter={},scanPostFilter={},sched={}\", requestId, tableNameWithType,\n           numSegmentsQueried, numSegmentsProcessed, numSegmentsMatched, numSegmentsConsuming, schedulerWaitMs,\n           timerContext.getPhaseDurationMs(ServerQueryPhase.REQUEST_DESERIALIZATION),\n           timerContext.getPhaseDurationMs(ServerQueryPhase.QUERY_PROCESSING),\n"}}, {"oid": "866dcb7a1bdf519600f562139443d409dfe368ac", "url": "https://github.com/apache/pinot/commit/866dcb7a1bdf519600f562139443d409dfe368ac", "message": "Fix server and broker log for execution stats", "committedDate": "2020-06-18T22:05:31Z", "type": "commit"}, {"oid": "866dcb7a1bdf519600f562139443d409dfe368ac", "url": "https://github.com/apache/pinot/commit/866dcb7a1bdf519600f562139443d409dfe368ac", "message": "Fix server and broker log for execution stats", "committedDate": "2020-06-18T22:05:31Z", "type": "forcePushed"}]}