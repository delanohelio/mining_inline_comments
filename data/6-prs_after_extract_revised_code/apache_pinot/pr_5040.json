{"pr_number": 5040, "pr_title": "Update Selection Query Limit with pre-configured value", "pr_createdAt": "2020-02-01T22:30:37Z", "pr_url": "https://github.com/apache/pinot/pull/5040", "timeline": [{"oid": "929a5256c74a2470b70982978f99dc1c5209099b", "url": "https://github.com/apache/pinot/commit/929a5256c74a2470b70982978f99dc1c5209099b", "message": "update max selectionquery limit behavior", "committedDate": "2020-02-01T17:31:06Z", "type": "commit"}, {"oid": "632df82c559eda48755ffc9bf2e112c00c0c575b", "url": "https://github.com/apache/pinot/commit/632df82c559eda48755ffc9bf2e112c00c0c575b", "message": "Merge pull request #1 from harshinielath/update_max_select_behavior\n\nupdate max selection query limit behavior", "committedDate": "2020-02-01T17:37:54Z", "type": "commit"}, {"oid": "59ba2007219b0cd2698399ace33834c0eba9fabc", "url": "https://github.com/apache/pinot/commit/59ba2007219b0cd2698399ace33834c0eba9fabc", "message": "changed limit config setup", "committedDate": "2020-02-02T22:02:56Z", "type": "commit"}, {"oid": "02d15ab4ec7fa5a86c40dbe57e7eb354fc782940", "url": "https://github.com/apache/pinot/commit/02d15ab4ec7fa5a86c40dbe57e7eb354fc782940", "message": "Merge pull request #2 from harshinielath/update_max_select_behavior\n\nchanged limit config setup to helix cluster level.", "committedDate": "2020-02-02T22:07:13Z", "type": "commit"}, {"oid": "ffd2163e2db4589f3157a2e47ced728505bbbc80", "url": "https://github.com/apache/pinot/commit/ffd2163e2db4589f3157a2e47ced728505bbbc80", "message": "fixed compilation error", "committedDate": "2020-02-03T00:46:57Z", "type": "commit"}, {"oid": "365eede5b75d8882d39f926b29d2ec8ccba0f191", "url": "https://github.com/apache/pinot/commit/365eede5b75d8882d39f926b29d2ec8ccba0f191", "message": "Merge pull request #3 from harshinielath/update_max_select_behavior\n\nMoved PinotQueryParserFactory to pinot-common", "committedDate": "2020-02-03T00:51:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNzM1NA==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r375507354", "bodyText": "we dont need to set the variable in PinotQueryParserFactory. Just change the brokerrequest using the config", "author": "kishoreg", "createdAt": "2020-02-05T21:05:52Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -122,6 +123,9 @@ public BaseBrokerRequestHandler(Configuration config, RoutingTable routingTable,\n     } else {\n       _tableCache = null;\n     }\n+\n+    PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT = _config.getInt(CommonConstants.Helix.MAX_QUERY_SELECTION_LIMIT_KEY, CommonConstants.Helix.DEFAULT_MAX_QUERY_SELECTION_LIMIT);", "originalCommit": "365eede5b75d8882d39f926b29d2ec8ccba0f191", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "chunk": "diff --git a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\nindex 0860bf07e1..8c20adf12a 100644\n--- a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n+++ b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n\n@@ -124,7 +125,7 @@ public abstract class BaseBrokerRequestHandler implements BrokerRequestHandler {\n       _tableCache = null;\n     }\n \n-    PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT = _config.getInt(CommonConstants.Helix.MAX_QUERY_SELECTION_LIMIT_KEY, CommonConstants.Helix.DEFAULT_MAX_QUERY_SELECTION_LIMIT);\n+    _maxQuerySelectionLimit = _config.getInt(CommonConstants.Helix.MAX_QUERY_SELECTION_LIMIT_KEY, CommonConstants.Helix.DEFAULT_MAX_QUERY_SELECTION_LIMIT);\n \n     _brokerId = config.getString(Broker.CONFIG_OF_BROKER_ID, getDefaultBrokerId());\n     _brokerTimeoutMs = config.getLong(Broker.CONFIG_OF_BROKER_TIMEOUT_MS, Broker.DEFAULT_BROKER_TIMEOUT_MS);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwNzc3MQ==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r375507771", "bodyText": "this code can be moved to basebrokerrequesthandler", "author": "kishoreg", "createdAt": "2020-02-05T21:06:42Z", "path": "pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java", "diffHunk": "@@ -166,6 +167,11 @@ public void updateBrokerRequest(BrokerRequest brokerRequest) {\n     } else {\n       brokerRequest.setLimit(DEFAULT_RECORD_LIMIT);\n     }\n+    // Update Selection query limit if MAX_QUERY_SELECTION_LIMIT is set.\n+    int limit = brokerRequest.getLimit();\n+    if ((PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT > 0) && (limit > PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT)) {", "originalCommit": "365eede5b75d8882d39f926b29d2ec8ccba0f191", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java b/pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java\nindex 26f81c8799..faaabea795 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/pql/parsers/pql2/ast/SelectAstNode.java\n\n@@ -167,11 +167,6 @@ public class SelectAstNode extends BaseAstNode {\n     } else {\n       brokerRequest.setLimit(DEFAULT_RECORD_LIMIT);\n     }\n-    // Update Selection query limit if MAX_QUERY_SELECTION_LIMIT is set.\n-    int limit = brokerRequest.getLimit();\n-    if ((PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT > 0) && (limit > PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT)) {\n-      brokerRequest.setLimit(PinotQueryParserFactory.MAX_QUERY_SELECTION_LIMIT);\n-    }\n \n     // Pinot quirk: if there is both a selection and an aggregation, remove the selection\n     if (brokerRequest.getAggregationsInfoSize() != 0 && brokerRequest.isSetSelections()) {\n"}}, {"oid": "c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "url": "https://github.com/apache/pinot/commit/c3a34bbfd4329a65b8d1ab3254169f91de3aa02d", "message": "Changed logic to broker", "committedDate": "2020-02-06T19:26:22Z", "type": "commit"}, {"oid": "33b9c56905ee0cc3e09acd257f73bb3003b67cd9", "url": "https://github.com/apache/pinot/commit/33b9c56905ee0cc3e09acd257f73bb3003b67cd9", "message": "Merge pull request #4 from harshinielath/update_max_select_behavior\n\nChanged logic to BaseBrokerRequestHandler", "committedDate": "2020-02-06T19:32:44Z", "type": "commit"}, {"oid": "9481cc05697d0dcbcdf33706beefcaaf29101261", "url": "https://github.com/apache/pinot/commit/9481cc05697d0dcbcdf33706beefcaaf29101261", "message": "Added Broker Query Limit Override key", "committedDate": "2020-02-07T02:52:55Z", "type": "commit"}, {"oid": "9eeeab6d14b943539604e488af8d082c208da29f", "url": "https://github.com/apache/pinot/commit/9eeeab6d14b943539604e488af8d082c208da29f", "message": "Merge pull request #5 from harshinielath/update_max_select_behavior\n\nAdded ENABLE_BROKER_QUERY_LIMIT_OVERRIDE_KEY", "committedDate": "2020-02-07T02:58:46Z", "type": "commit"}, {"oid": "b05eecf9871c343e80e24084e33944dad4460d7f", "url": "https://github.com/apache/pinot/commit/b05eecf9871c343e80e24084e33944dad4460d7f", "message": "moved Pinot Query Parser back to broker requesthandler", "committedDate": "2020-02-08T03:11:44Z", "type": "commit"}, {"oid": "1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d", "url": "https://github.com/apache/pinot/commit/1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d", "message": "Merge pull request #6 from harshinielath/update_max_select_behavior\n\nmoved PinotQueryParserFactory back to pinot-broker", "committedDate": "2020-02-08T03:13:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg4ODQ0NQ==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r376888445", "bodyText": "Can you please move this under class Broker instead of Helix? Also, I would recommend changing it to CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE to be consistent with other configs.", "author": "Jackie-Jiang", "createdAt": "2020-02-10T06:42:57Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -42,7 +42,7 @@\n \n     public static final String LEAD_CONTROLLER_RESOURCE_ENABLED_KEY = \"RESOURCE_ENABLED\";\n     public static final String ENABLE_CASE_INSENSITIVE_PQL_KEY = \"enable.case.insensitive.pql\";\n-\n+    public static final String ENABLE_BROKER_QUERY_LIMIT_OVERRIDE_KEY = \"enable.broker.query.limit.override\";", "originalCommit": "1c6bc6c22da9f5e813e5d7db0dd8c4625b46cc0d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "eb6ed21e0aa14f9348b32d1448c27f6466ef607b", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java b/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\nindex 5e32fa44ea..95c50700cf 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\n\n@@ -42,7 +42,6 @@ public class CommonConstants {\n \n     public static final String LEAD_CONTROLLER_RESOURCE_ENABLED_KEY = \"RESOURCE_ENABLED\";\n     public static final String ENABLE_CASE_INSENSITIVE_PQL_KEY = \"enable.case.insensitive.pql\";\n-    public static final String ENABLE_BROKER_QUERY_LIMIT_OVERRIDE_KEY = \"enable.broker.query.limit.override\";\n \n \n     // More information on why these numbers are set can be found in the following doc:\n"}}, {"oid": "eb6ed21e0aa14f9348b32d1448c27f6466ef607b", "url": "https://github.com/apache/pinot/commit/eb6ed21e0aa14f9348b32d1448c27f6466ef607b", "message": "Changed config var name", "committedDate": "2020-02-10T23:27:20Z", "type": "commit"}, {"oid": "e90639832128926e5194c78bd9f19fdd94e295df", "url": "https://github.com/apache/pinot/commit/e90639832128926e5194c78bd9f19fdd94e295df", "message": "Merge pull request #7 from harshinielath/update_max_select_behavior\n\nChanged config var name", "committedDate": "2020-02-11T00:04:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzUyMg==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377433522", "bodyText": "pinot.broker.enable.query.limit.override for consistency", "author": "Jackie-Jiang", "createdAt": "2020-02-11T03:30:56Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java", "diffHunk": "@@ -166,6 +165,7 @@ public ServerType getServerType() {\n     public static final String CONFIG_OF_BROKER_MIN_RESOURCE_PERCENT_FOR_START =\n         \"pinot.broker.startup.minResourcePercent\";\n     public static final double DEFAULT_BROKER_MIN_RESOURCE_PERCENT_FOR_START = 100.0;\n+    public static final String CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE = \"enable.broker.query.limit.override\";", "originalCommit": "e90639832128926e5194c78bd9f19fdd94e295df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java b/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\nindex 95c50700cf..e8938cfe3f 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/common/utils/CommonConstants.java\n\n@@ -165,7 +165,7 @@ public class CommonConstants {\n     public static final String CONFIG_OF_BROKER_MIN_RESOURCE_PERCENT_FOR_START =\n         \"pinot.broker.startup.minResourcePercent\";\n     public static final double DEFAULT_BROKER_MIN_RESOURCE_PERCENT_FOR_START = 100.0;\n-    public static final String CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE = \"enable.broker.query.limit.override\";\n+    public static final String CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE = \"pinot.broker.enable.query.limit.override\";\n \n     public static class Request {\n       public static final String PQL = \"pql\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzMzcwMA==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377433700", "bodyText": "(nit) CommonConstants.Broker is already imported so you can directly use Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE", "author": "Jackie-Jiang", "createdAt": "2020-02-11T03:32:04Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -122,6 +122,9 @@ public BaseBrokerRequestHandler(Configuration config, RoutingTable routingTable,\n     } else {\n       _tableCache = null;\n     }\n+\n+    _enableBrokerQueryLimitOverride = _config.getBoolean(CommonConstants.Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, false);", "originalCommit": "e90639832128926e5194c78bd9f19fdd94e295df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "chunk": "diff --git a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\nindex 21696405a8..7667e61658 100644\n--- a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n+++ b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n\n@@ -123,7 +123,7 @@ public abstract class BaseBrokerRequestHandler implements BrokerRequestHandler {\n       _tableCache = null;\n     }\n \n-    _enableBrokerQueryLimitOverride = _config.getBoolean(CommonConstants.Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, false);\n+    _enableQueryLimitOverride = _config.getBoolean(Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, false);\n \n     _brokerId = config.getString(Broker.CONFIG_OF_BROKER_ID, getDefaultBrokerId());\n     _brokerTimeoutMs = config.getLong(Broker.CONFIG_OF_BROKER_TIMEOUT_MS, Broker.DEFAULT_BROKER_TIMEOUT_MS);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNDAzMg==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377434032", "bodyText": "(nit) enableQueryLimitOverride", "author": "Jackie-Jiang", "createdAt": "2020-02-11T03:34:07Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java", "diffHunk": "@@ -182,7 +181,8 @@ public void start()\n         new HelixConfigScopeBuilder(HelixConfigScope.ConfigScopeProperty.CLUSTER).forCluster(_clusterName).build();\n     String enableCaseInsensitivePql = configAccessor.get(helixConfigScope, Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY);\n     _brokerConf.setProperty(Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY, Boolean.valueOf(enableCaseInsensitivePql));\n-\n+    String enableBrokerQueryLimitOverride = configAccessor.get(helixConfigScope, Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE);", "originalCommit": "e90639832128926e5194c78bd9f19fdd94e295df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "chunk": "diff --git a/pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java b/pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java\nindex 178d37944e..698618283a 100644\n--- a/pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java\n+++ b/pinot-broker/src/main/java/org/apache/pinot/broker/broker/helix/HelixBrokerStarter.java\n\n@@ -181,8 +181,8 @@ public class HelixBrokerStarter {\n         new HelixConfigScopeBuilder(HelixConfigScope.ConfigScopeProperty.CLUSTER).forCluster(_clusterName).build();\n     String enableCaseInsensitivePql = configAccessor.get(helixConfigScope, Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY);\n     _brokerConf.setProperty(Helix.ENABLE_CASE_INSENSITIVE_PQL_KEY, Boolean.valueOf(enableCaseInsensitivePql));\n-    String enableBrokerQueryLimitOverride = configAccessor.get(helixConfigScope, Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE);\n-    _brokerConf.setProperty(Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, Boolean.valueOf(enableBrokerQueryLimitOverride));\n+    String enableQueryLimitOverride = configAccessor.get(helixConfigScope, Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE);\n+    _brokerConf.setProperty(Broker.CONFIG_OF_ENABLE_QUERY_LIMIT_OVERRIDE, Boolean.valueOf(enableQueryLimitOverride));\n     _brokerServerBuilder = new BrokerServerBuilder(_brokerConf, _helixExternalViewBasedRouting,\n         _helixExternalViewBasedRouting.getTimeBoundaryService(), _helixExternalViewBasedQueryQuotaManager, _propertyStore);\n     BrokerRequestHandler brokerRequestHandler = _brokerServerBuilder.getBrokerRequestHandler();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNDA3Ng==", "url": "https://github.com/apache/pinot/pull/5040#discussion_r377434076", "bodyText": "(nit) _enableQueryLimitOverride?", "author": "Jackie-Jiang", "createdAt": "2020-02-11T03:34:27Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java", "diffHunk": "@@ -104,6 +103,7 @@\n   private final AtomicInteger _numDroppedLog;\n \n   private final boolean _enableCaseInsensitivePql;\n+  private final boolean _enableBrokerQueryLimitOverride;", "originalCommit": "e90639832128926e5194c78bd9f19fdd94e295df", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "chunk": "diff --git a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\nindex 21696405a8..7667e61658 100644\n--- a/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n+++ b/pinot-broker/src/main/java/org/apache/pinot/broker/requesthandler/BaseBrokerRequestHandler.java\n\n@@ -103,7 +103,7 @@ public abstract class BaseBrokerRequestHandler implements BrokerRequestHandler {\n   private final AtomicInteger _numDroppedLog;\n \n   private final boolean _enableCaseInsensitivePql;\n-  private final boolean _enableBrokerQueryLimitOverride;\n+  private final boolean _enableQueryLimitOverride;\n   private final TableCache _tableCache;\n \n   public BaseBrokerRequestHandler(Configuration config, RoutingTable routingTable,\n"}}, {"oid": "c6664fc4c7430fb8c196c431d9dd7091fd403f86", "url": "https://github.com/apache/pinot/commit/c6664fc4c7430fb8c196c431d9dd7091fd403f86", "message": "Few nit changes", "committedDate": "2020-02-11T13:45:38Z", "type": "commit"}, {"oid": "52e2b818e79d81b2b589f9b5886263ad0aa4870d", "url": "https://github.com/apache/pinot/commit/52e2b818e79d81b2b589f9b5886263ad0aa4870d", "message": "Merge pull request #8 from harshinielath/update_max_select_behavior\n\nFew nit changes", "committedDate": "2020-02-11T13:48:48Z", "type": "commit"}]}