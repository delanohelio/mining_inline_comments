{"pr_number": 5009, "pr_title": "[TE] auto enable data-availaibity trigger for PINOT detections withou\u2026", "pr_createdAt": "2020-01-23T19:40:33Z", "pr_url": "https://github.com/apache/pinot/pull/5009", "timeline": [{"oid": "05c002dda9a7a678a34293bbffae9be4c7c2b36e", "url": "https://github.com/apache/pinot/commit/05c002dda9a7a678a34293bbffae9be4c7c2b36e", "message": "[TE] auto enable data-availaibity trigger for PINOT detections without cron", "committedDate": "2020-01-23T19:37:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMyOTkxNg==", "url": "https://github.com/apache/pinot/pull/5009#discussion_r370329916", "bodyText": "Why this is a TODO?", "author": "xiaohui-sun", "createdAt": "2020-01-23T20:09:27Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java", "diffHunk": "@@ -530,6 +535,11 @@ private DetectionConfigDTO generateDetectionConfig(Map<String, Object> yamlConfi\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n \n+    //TODO: data-availability trigger is only enabled for detections running on PINOT only", "originalCommit": "05c002dda9a7a678a34293bbffae9be4c7c2b36e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM4MTE2OQ==", "url": "https://github.com/apache/pinot/pull/5009#discussion_r370381169", "bodyText": "Ideally, data availability trigger should be enabled if the cron is specified. However, due to the current prod setup, we only get events for Pinot dataset. We should remove the check for Pinot dataset when we get update events for other data source.", "author": "vincentchenjl", "createdAt": "2020-01-23T22:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMyOTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MDMzMA==", "url": "https://github.com/apache/pinot/pull/5009#discussion_r371470330", "bodyText": "Let's not add TODO here since this is a new feature request not a code refactor or tech debt. :)\nWe don't have ETA for getting event data for other datasets.", "author": "xiaohui-sun", "createdAt": "2020-01-27T20:39:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMyOTkxNg=="}], "type": "inlineReview", "revised_code": {"commit": "8daba6f32402ac2fb12a071e7c5b3de58dab711b", "chunk": "diff --git a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\nindex d590eb791c..91d2fd91df 100644\n--- a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n+++ b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n\n@@ -535,8 +535,9 @@ public class DetectionConfigTranslator extends ConfigTranslator<DetectionConfigD\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n \n-    //TODO: data-availability trigger is only enabled for detections running on PINOT only\n+    //TODO: data-availability trigger is only enabled for detections running on PINOT daily dataset only\n     if (MapUtils.getString(yamlConfigMap, PROP_CRON) == null\n+        && datasetConfigs.stream().allMatch(c -> c.bucketTimeGranularity().getUnit().equals(TimeUnit.DAYS))\n         && datasetConfigs.stream().allMatch(c -> c.getDataSource().equals(PinotThirdEyeDataSource.DATA_SOURCE_NAME))) {\n       config.setDataAvailabilitySchedule(true);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MDYyOQ==", "url": "https://github.com/apache/pinot/pull/5009#discussion_r371470629", "bodyText": "Need to check if this is daily/weekly detection.", "author": "xiaohui-sun", "createdAt": "2020-01-27T20:40:38Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java", "diffHunk": "@@ -530,6 +535,11 @@ private DetectionConfigDTO generateDetectionConfig(Map<String, Object> yamlConfi\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n \n+    //TODO: data-availability trigger is only enabled for detections running on PINOT only\n+    if (MapUtils.getString(yamlConfigMap, PROP_CRON) == null\n+        && datasetConfigs.stream().allMatch(c -> c.getDataSource().equals(PinotThirdEyeDataSource.DATA_SOURCE_NAME))) {", "originalCommit": "05c002dda9a7a678a34293bbffae9be4c7c2b36e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMTM4MA==", "url": "https://github.com/apache/pinot/pull/5009#discussion_r371521380", "bodyText": "Added the check for the granularity of dataset. Even if the detection is a weekly detection, it can be data-availability triggered as long as it is daily Pinot dataset.", "author": "vincentchenjl", "createdAt": "2020-01-27T22:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MDYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8daba6f32402ac2fb12a071e7c5b3de58dab711b", "chunk": "diff --git a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\nindex d590eb791c..91d2fd91df 100644\n--- a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n+++ b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n\n@@ -535,8 +535,9 @@ public class DetectionConfigTranslator extends ConfigTranslator<DetectionConfigD\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n \n-    //TODO: data-availability trigger is only enabled for detections running on PINOT only\n+    //TODO: data-availability trigger is only enabled for detections running on PINOT daily dataset only\n     if (MapUtils.getString(yamlConfigMap, PROP_CRON) == null\n+        && datasetConfigs.stream().allMatch(c -> c.bucketTimeGranularity().getUnit().equals(TimeUnit.DAYS))\n         && datasetConfigs.stream().allMatch(c -> c.getDataSource().equals(PinotThirdEyeDataSource.DATA_SOURCE_NAME))) {\n       config.setDataAvailabilitySchedule(true);\n     }\n"}}, {"oid": "8daba6f32402ac2fb12a071e7c5b3de58dab711b", "url": "https://github.com/apache/pinot/commit/8daba6f32402ac2fb12a071e7c5b3de58dab711b", "message": "add check for dataset granularity", "committedDate": "2020-01-27T22:23:26Z", "type": "commit"}]}