{"pr_number": 5740, "pr_title": "[TE] Added a backfill start date for Anomaly Detection", "pr_createdAt": "2020-07-23T03:44:26Z", "pr_url": "https://github.com/apache/pinot/pull/5740", "timeline": [{"oid": "7605d031307b833f70003076d0affe5cb6f0a3be", "url": "https://github.com/apache/pinot/commit/7605d031307b833f70003076d0affe5cb6f0a3be", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nWhen an alert is created, it automatically triggers a YAML Onboarding Task\nwhich detects all anomalies in the past 30 days. This change makes the\nsetting configurable by providing a backfill start timestamp.\n\nNot providing the value or simply providing a dubious entry would result\nin the system defaulting to the 30 day lookback.\n\nThis change also updates the alert template UI to make it easy for a new\nuser to try this config", "committedDate": "2020-07-23T03:40:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2OTIxOA==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459669218", "bodyText": "I think we already have a utility for this. Can you try MapUtils or ConfigUtils?", "author": "akshayrai", "createdAt": "2020-07-23T19:10:47Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java", "diffHunk": "@@ -189,6 +190,7 @@ private DetectionConfigDTO generateDetectionConfig(Map<String, Object> yamlConfi\n     config.setCron(cron);\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n+    config.setBackfillStart(parseTimeStampLong(yamlConfigMap.get(PROP_BACKFILL_START)));", "originalCommit": "7605d031307b833f70003076d0affe5cb6f0a3be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY4NDI4Mw==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r459684283", "bodyText": "I found org.apache.pinot.thirdeye.detection.ConfigUtils#getLongs(java.util.Collection<java.lang.Number>) but that takes a list and has a slightly different behavior which would require me to have a separate method anyway.\nAre you aware of any other utility? Please do share if you find something.", "author": "suvodeep-pyne", "createdAt": "2020-07-23T19:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY2OTIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "chunk": "diff --git a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\nindex 68fce4192b..726ac126a9 100644\n--- a/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n+++ b/thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/translator/DetectionConfigTranslator.java\n\n@@ -181,16 +181,21 @@ public class DetectionConfigTranslator extends ConfigTranslator<DetectionConfigD\n     config.setName(MapUtils.getString(yamlConfigMap, PROP_DETECTION_NAME));\n     config.setDescription(MapUtils.getString(yamlConfigMap, PROP_DESC_NAME));\n     config.setDescription(MapUtils.getString(yamlConfigMap, PROP_DESC_NAME));\n-    config.setLastTimestamp(System.currentTimeMillis());\n     config.setOwners(filterOwners(ConfigUtils.getList(yamlConfigMap.get(PROP_OWNERS))));\n \n+    /*\n+     * The lastTimestamp value is used as a checkpoint/high watermark for onboarding data.\n+     * This implies that data entries post this timestamp will be processed for\n+     * anomalies.\n+     */\n+    config.setLastTimestamp(longValue(yamlConfigMap.get(PROP_LAST_TIMESTAMP)));\n+\n     config.setProperties(detectionProperties);\n     config.setDataQualityProperties(qualityProperties);\n     config.setComponentSpecs(this.metricAttributesMap.getAllComponenets());\n     config.setCron(cron);\n     config.setActive(MapUtils.getBooleanValue(yamlConfigMap, PROP_ACTIVE, true));\n     config.setYaml(yamlConfig);\n-    config.setBackfillStart(parseTimeStampLong(yamlConfigMap.get(PROP_BACKFILL_START)));\n \n     //TODO: data-availability trigger is only enabled for detections running on PINOT daily dataset only\n     List<DatasetConfigDTO> datasetConfigs = this.metricAttributesMap.getAllDatasets();\n"}}, {"oid": "3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "url": "https://github.com/apache/pinot/commit/3de9f1a0f435bd8deaf0fe6dcb2b77c8d05b212a", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUpdates. Replaced backfillStart with the already existing lastTimestamp\nThis value is used as a checkpoint and is already being persisted in the db", "committedDate": "2020-07-24T03:38:16Z", "type": "commit"}, {"oid": "aab60e7196ec13a3c755f7a35c514beced82ad7b", "url": "https://github.com/apache/pinot/commit/aab60e7196ec13a3c755f7a35c514beced82ad7b", "message": "[TE] Added a backfill start date for Anomaly Detection\n\nUndoing changes in create alert yaml template", "committedDate": "2020-07-28T22:45:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MzMxOQ==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r461953319", "bodyText": "Since the default value of lastTimestamp will be 0 (when not set), we should probably change this condition here to not trigger detection on the entire dataset.", "author": "akshayrai", "createdAt": "2020-07-28T23:36:34Z", "path": "thirdeye/thirdeye-pinot/src/main/java/org/apache/pinot/thirdeye/detection/yaml/YamlResource.java", "diffHunk": "@@ -236,10 +236,17 @@ private void createYamlOnboardingTask(long configId, long tuningWindowStart, lon\n     info.setTuningWindowStart(tuningWindowStart);\n     info.setTuningWindowEnd(tuningWindowEnd);\n     info.setEnd(System.currentTimeMillis());\n-    info.setStart(info.getEnd() - ONBOARDING_REPLAY_LOOKBACK);\n+\n+    long lastTimestamp = detectionConfig.getLastTimestamp();\n+    // If no value is present, set the default lookback\n+    if (lastTimestamp < 0) {", "originalCommit": "aab60e7196ec13a3c755f7a35c514beced82ad7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTIwNw==", "url": "https://github.com/apache/pinot/pull/5740#discussion_r462001207", "bodyText": "Hey @akshayrai\nDuring org.apache.pinot.thirdeye.detection.yaml.translator.DetectionConfigTranslator#generateDetectionConfig, the default is always set to -1 in which case, it is set to 30 days before current time. ref: org/apache/pinot/thirdeye/detection/yaml/YamlResource.java:242\nI can simplify that a bit but then the YamlResource default needs to accessed from the translator which I found to be a bit confusing.", "author": "suvodeep-pyne", "createdAt": "2020-07-29T02:30:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk1MzMxOQ=="}], "type": "inlineReview", "revised_code": null}]}