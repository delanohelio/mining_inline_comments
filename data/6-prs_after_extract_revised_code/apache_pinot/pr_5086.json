{"pr_number": 5086, "pr_title": "Remove the support of the old Star-Tree", "pr_createdAt": "2020-02-21T03:09:43Z", "pr_url": "https://github.com/apache/pinot/pull/5086", "timeline": [{"oid": "51abe2e425822471c7121a98009bc55a8bcc7749", "url": "https://github.com/apache/pinot/commit/51abe2e425822471c7121a98009bc55a8bcc7749", "message": "Remove the support of the old Star-Tree\n\nRemove the support of the old Star-Tree generated with the StarTreeIndexSpec (already deprecated)\nRemove the related metadata (rawDoc and aggregatedDoc)\nRemove the field size and derived metric type from MetricFieldSpec\nSimplify the segment generation logic\n\nBackward-incompatible: (checked with the community to make sure there is no use case with the old Star-Tree)\nExisting segments with old Star-Tree won't work properly", "committedDate": "2020-02-21T03:47:47Z", "type": "forcePushed"}, {"oid": "feeaccc3a76e1c750bca2bf6885d385ed1743497", "url": "https://github.com/apache/pinot/commit/feeaccc3a76e1c750bca2bf6885d385ed1743497", "message": "Remove the support of the old Star-Tree\n\nRemove the support of the old Star-Tree generated with the StarTreeIndexSpec (already deprecated)\nRemove the related metadata (rawDoc and aggregatedDoc)\nRemove the field size and derived metric type from MetricFieldSpec\nSimplify the segment generation logic\n\nBackward-incompatible: (checked with the community to make sure there is no use case with the old Star-Tree)\nExisting segments with old Star-Tree won't work properly", "committedDate": "2020-02-24T21:13:07Z", "type": "commit"}, {"oid": "feeaccc3a76e1c750bca2bf6885d385ed1743497", "url": "https://github.com/apache/pinot/commit/feeaccc3a76e1c750bca2bf6885d385ed1743497", "message": "Remove the support of the old Star-Tree\n\nRemove the support of the old Star-Tree generated with the StarTreeIndexSpec (already deprecated)\nRemove the related metadata (rawDoc and aggregatedDoc)\nRemove the field size and derived metric type from MetricFieldSpec\nSimplify the segment generation logic\n\nBackward-incompatible: (checked with the community to make sure there is no use case with the old Star-Tree)\nExisting segments with old Star-Tree won't work properly", "committedDate": "2020-02-24T21:13:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzNjg0Ng==", "url": "https://github.com/apache/pinot/pull/5086#discussion_r384836846", "bodyText": "Why this change of not using getDefaultNullValue()?", "author": "siddharthteotia", "createdAt": "2020-02-26T23:50:32Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/segment/creator/impl/stats/StringColumnPreIndexStatsCollector.java", "diffHunk": "@@ -26,124 +26,82 @@\n \n \n public class StringColumnPreIndexStatsCollector extends AbstractColumnStatisticsCollector {\n-  private String min;\n-  private String max;\n+  private final ObjectSet<String> _values = new ObjectOpenHashSet<>(INITIAL_HASH_SET_SIZE);\n \n-  private int smallestStringLength = Integer.MAX_VALUE;\n-  private int longestStringLength = 0;\n-  private final ObjectSet<String> rawStringSet;\n-  private final ObjectSet<String> aggregatedStringSet;\n-  private String[] sortedStringList;\n-  private boolean sealed = false;\n+  private int _minLength = Integer.MAX_VALUE;\n+  private int _maxLength = 0;\n+  private String[] _sortedValues;\n+  private boolean _sealed = false;\n \n   public StringColumnPreIndexStatsCollector(String column, StatsCollectorConfig statsCollectorConfig) {\n     super(column, statsCollectorConfig);\n-    rawStringSet = new ObjectOpenHashSet<>(INITIAL_HASH_SET_SIZE);\n-    aggregatedStringSet = new ObjectOpenHashSet<>(INITIAL_HASH_SET_SIZE);\n   }\n \n-  /**\n-   * Collect statistics for the given entry.\n-   * - Add it to the passed in set (which could be raw or aggregated)\n-   * - Update maximum number of values for Multi-valued entries\n-   * - Update Total number of entries\n-   * - Check if entry is sorted.\n-   * @param entry\n-   * @param set\n-   */\n-  private void collectEntry(Object entry, ObjectSet<String> set) {\n-\n+  @Override\n+  public void collect(Object entry) {\n     if (entry instanceof Object[]) {\n-      for (final Object e : (Object[]) entry) {\n-        String value = e.toString();\n-        set.add(value);\n-\n-        int valueLength = StringUtil.encodeUtf8(value).length;\n-        smallestStringLength = Math.min(smallestStringLength, valueLength);\n-        longestStringLength = Math.max(longestStringLength, valueLength);\n-      }\n-      if (maxNumberOfMultiValues < ((Object[]) entry).length) {\n-        maxNumberOfMultiValues = ((Object[]) entry).length;\n+      Object[] values = (Object[]) entry;\n+      for (Object obj : values) {\n+        String value = (String) obj;\n+        _values.add(value);\n+\n+        int length = StringUtil.encodeUtf8(value).length;\n+        _minLength = Math.min(_minLength, length);\n+        _maxLength = Math.max(_maxLength, length);\n       }\n-      updateTotalNumberOfEntries((Object[]) entry);\n-    } else {\n \n-      String value;\n-      if (entry != null) {\n-        value = entry.toString();\n-      } else {\n-        value = fieldSpec.getDefaultNullValue().toString();", "originalCommit": "feeaccc3a76e1c750bca2bf6885d385ed1743497", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzNzUzNw==", "url": "https://github.com/apache/pinot/pull/5086#discussion_r384837537", "bodyText": "Null values are handled by NullValueTransformer. Here we will never get null entries.", "author": "Jackie-Jiang", "createdAt": "2020-02-26T23:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzNjg0Ng=="}], "type": "inlineReview", "revised_code": null}]}