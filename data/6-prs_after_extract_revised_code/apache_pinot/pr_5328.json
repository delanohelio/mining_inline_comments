{"pr_number": 5328, "pr_title": "Fix the bug introduced in #5132 where ScanBasedDocIdIterator.isMatch() is still required", "pr_createdAt": "2020-05-04T20:11:19Z", "pr_url": "https://github.com/apache/pinot/pull/5328", "timeline": [{"oid": "6cdf280e4a28adc9db762c4196b0cb0fb9f8b8b9", "url": "https://github.com/apache/pinot/commit/6cdf280e4a28adc9db762c4196b0cb0fb9f8b8b9", "message": "Fix the bug introduced in #5132 where ScanBasedDocIdIterator.isMatch() is still required\n\nScanBasedDocIdIterator.isMatch() is still required when the query is in the following format:\nSELECT ... WHERE (filterA OR filterB) AND filterC\nAnd filterC is working on a scan-based column (column without inverted index)\n\nEnhance the HybridClusterIntegrationTest to catch this issue", "committedDate": "2020-05-04T20:10:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0NzIwNA==", "url": "https://github.com/apache/pinot/pull/5328#discussion_r419747204", "bodyText": "Can you restructure the (outer) loop so that it is a while with some condition rather than a for(i = ..) in which we change the loop counter? I understand it was already that way.", "author": "mcvsubbu", "createdAt": "2020-05-04T21:43:49Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/dociditerators/AndDocIdIterator.java", "diffHunk": "@@ -102,6 +102,17 @@ public int next() {\n           i = -1;\n         }\n       }\n+      if (hasScanBasedIterators && i == docIdIterators.length - 1) {\n+        // this means we found the docId common to all nonScanBased iterators, now we need to ensure\n+        // that its also found in scanBasedIterator, if not matched, we restart the intersection\n+        for (ScanBasedDocIdIterator iterator : scanBasedDocIdIterators) {\n+          if (!iterator.isMatch(currentMax)) {\n+            i = -1;", "originalCommit": "6cdf280e4a28adc9db762c4196b0cb0fb9f8b8b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1ODU2NQ==", "url": "https://github.com/apache/pinot/pull/5328#discussion_r419758565", "bodyText": "@mcvsubbu Planning to do some clean-up in the following pr. Wanted to keep this pr small and focus on the bug fix.", "author": "Jackie-Jiang", "createdAt": "2020-05-04T22:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc0NzIwNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg2MjI3MA==", "url": "https://github.com/apache/pinot/pull/5328#discussion_r419862270", "bodyText": "Is it the test case mentioned in the description section? It doesn't seem matched with SELECT ... WHERE (filterA OR filterB) AND filterC though.", "author": "jackjlli", "createdAt": "2020-05-05T04:52:29Z", "path": "pinot-integration-tests/src/test/java/org/apache/pinot/integration/tests/BaseClusterIntegrationTestSet.java", "diffHunk": "@@ -137,6 +137,9 @@ public void testHardcodedQueries()\n     query = \"SELECT MAX(ArrTime), MIN(ArrTime) FROM mytable WHERE DaysSinceEpoch >= 16312\";\n     testQuery(query, Arrays.asList(\"SELECT MAX(ArrTime) FROM mytable WHERE DaysSinceEpoch >= 15312\",\n         \"SELECT MIN(ArrTime) FROM mytable WHERE DaysSinceEpoch >= 15312\"));\n+    query =\n+        \"SELECT SUM(TotalAddGTime) FROM mytable WHERE DivArrDelay NOT IN (67, 260) AND Carrier IN ('F9', 'B6') OR DepTime BETWEEN 2144 AND 1926\";", "originalCommit": "6cdf280e4a28adc9db762c4196b0cb0fb9f8b8b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwMDE4Ng==", "url": "https://github.com/apache/pinot/pull/5328#discussion_r419900186", "bodyText": "@jackjlli Yes, for hybrid use case, there will be an implicit time filter appended. This is the query that failed before.\nDo we have an issue opened for this?", "author": "Jackie-Jiang", "createdAt": "2020-05-05T06:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg2MjI3MA=="}], "type": "inlineReview", "revised_code": null}]}