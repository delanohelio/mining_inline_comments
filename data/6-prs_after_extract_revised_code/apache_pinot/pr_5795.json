{"pr_number": 5795, "pr_title": "Support aggregation function name with underscore inside", "pr_createdAt": "2020-08-03T20:24:24Z", "pr_url": "https://github.com/apache/pinot/pull/5795", "timeline": [{"oid": "c04e537e44af257739aff439f0ea009261b47dd4", "url": "https://github.com/apache/pinot/commit/c04e537e44af257739aff439f0ea009261b47dd4", "message": "Support aggregation function name with underscore inside", "committedDate": "2020-08-03T20:55:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5MjA5OA==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r464692098", "bodyText": "This will break ST_Union. Can we first look up with original function name, and if not found, replace _ then?", "author": "Jackie-Jiang", "createdAt": "2020-08-03T22:20:07Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -79,7 +79,7 @@ public boolean isOfType(AggregationFunctionType... aggregationFunctionTypes) {\n    * Returns the corresponding aggregation function type for the given function name.\n    */\n   public static AggregationFunctionType getAggregationFunctionType(String functionName) {\n-    String upperCaseFunctionName = functionName.toUpperCase();\n+    String upperCaseFunctionName = functionName.toUpperCase().replace(\"_\", \"\");", "originalCommit": "c04e537e44af257739aff439f0ea009261b47dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5OTYxOQ==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r464699619", "bodyText": "will do that", "author": "xiangfu0", "createdAt": "2020-08-03T22:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5MjA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "51a27b7f666df05c1a84f94bab0aeec6c51b2b6f", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\nindex 6f3865482a..6ab8fa34d9 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n\n@@ -79,7 +79,7 @@ public enum AggregationFunctionType {\n    * Returns the corresponding aggregation function type for the given function name.\n    */\n   public static AggregationFunctionType getAggregationFunctionType(String functionName) {\n-    String upperCaseFunctionName = functionName.toUpperCase().replace(\"_\", \"\");\n+    String upperCaseFunctionName = functionName.toUpperCase();\n     if (upperCaseFunctionName.startsWith(\"PERCENTILE\")) {\n       String remainingFunctionName = upperCaseFunctionName.substring(10);\n       if (remainingFunctionName.isEmpty() || remainingFunctionName.matches(\"\\\\d+\")) {\n"}}, {"oid": "51a27b7f666df05c1a84f94bab0aeec6c51b2b6f", "url": "https://github.com/apache/pinot/commit/51a27b7f666df05c1a84f94bab0aeec6c51b2b6f", "message": "Support aggregation function name with underscore inside", "committedDate": "2020-08-03T22:53:44Z", "type": "forcePushed"}, {"oid": "c1f5ec772e71675f92b2b477cc93185b8242498a", "url": "https://github.com/apache/pinot/commit/c1f5ec772e71675f92b2b477cc93185b8242498a", "message": "update codecov version to v1.0.12", "committedDate": "2020-08-04T06:09:12Z", "type": "forcePushed"}, {"oid": "085a95c26ad5c684b66f1c3706518011105a7cb9", "url": "https://github.com/apache/pinot/commit/085a95c26ad5c684b66f1c3706518011105a7cb9", "message": "update codecov version to v1.0.12", "committedDate": "2020-08-04T08:20:51Z", "type": "forcePushed"}, {"oid": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "url": "https://github.com/apache/pinot/commit/a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "message": "update codecov version to v1.0.12", "committedDate": "2020-08-04T08:22:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NTAwNA==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465385004", "bodyText": "This won't cover functions such as percentile_tdigest.\nWe can make the current one a private helper method, and add a new getAggregationFunctionType to look up for both functionName with/without underscore", "author": "Jackie-Jiang", "createdAt": "2020-08-04T23:26:44Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -101,6 +101,13 @@ public static AggregationFunctionType getAggregationFunctionType(String function\n       try {\n         return AggregationFunctionType.valueOf(upperCaseFunctionName);\n       } catch (Exception e) {\n+        if (upperCaseFunctionName.contains(\"_\")) {", "originalCommit": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89120991952a9e86086ef465a9a567b81879f7ad", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\nindex 6ab8fa34d9..027b6d904c 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n\n@@ -94,22 +95,19 @@ public enum AggregationFunctionType {\n         return PERCENTILEESTMV;\n       } else if (remainingFunctionName.equals(\"TDIGESTMV\") || remainingFunctionName.matches(\"TDIGEST\\\\d+MV\")) {\n         return PERCENTILETDIGESTMV;\n-      } else {\n-        throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n       }\n-    } else {\n-      try {\n-        return AggregationFunctionType.valueOf(upperCaseFunctionName);\n-      } catch (Exception e) {\n-        if (upperCaseFunctionName.contains(\"_\")) {\n-          try {\n-            return AggregationFunctionType.valueOf(upperCaseFunctionName.replace(\"_\", \"\"));\n-          } catch (Exception e2) {\n-            // throw IllegalArgumentException\n-          }\n+    }\n+    try {\n+      return AggregationFunctionType.valueOf(upperCaseFunctionName);\n+    } catch (Exception e) {\n+      if (upperCaseFunctionName.contains(\"_\")) {\n+        try {\n+          return getAggregationFunctionType(upperCaseFunctionName.replace(\"_\", \"\"));\n+        } catch (Exception e2) {\n+          // throw IllegalArgumentException\n         }\n-        throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n       }\n     }\n+    throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NTMyOQ==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465385329", "bodyText": "Same here", "author": "Jackie-Jiang", "createdAt": "2020-08-04T23:27:47Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -106,7 +106,7 @@ public static AggregationFunction getAggregationFunction(FunctionContext functio\n         }\n         throw new IllegalArgumentException(\"Invalid percentile function: \" + function);\n       } else {\n-        switch (AggregationFunctionType.valueOf(upperCaseFunctionName)) {\n+        switch (AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName)) {", "originalCommit": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89120991952a9e86086ef465a9a567b81879f7ad", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\nindex 3b4b708490..f5a6e01ab4 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\n\n@@ -106,7 +108,7 @@ public class AggregationFunctionFactory {\n         }\n         throw new IllegalArgumentException(\"Invalid percentile function: \" + function);\n       } else {\n-        switch (AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName)) {\n+        switch (aggregationFunctionType) {\n           case COUNT:\n             return new CountAggregationFunction();\n           case MIN:\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4NjE0Mw==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r465386143", "bodyText": "Check if it contains underscore before the second lookup for performance", "author": "Jackie-Jiang", "createdAt": "2020-08-04T23:30:20Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -101,6 +101,13 @@ public static AggregationFunctionType getAggregationFunctionType(String function\n       try {\n         return AggregationFunctionType.valueOf(upperCaseFunctionName);\n       } catch (Exception e) {\n+        if (upperCaseFunctionName.contains(\"_\")) {\n+          try {\n+            return AggregationFunctionType.valueOf(upperCaseFunctionName.replace(\"_\", \"\"));", "originalCommit": "a8b1912cf23a6b2351b6874dab1577d5ac5609ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "89120991952a9e86086ef465a9a567b81879f7ad", "chunk": "diff --git a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\nindex 6ab8fa34d9..027b6d904c 100644\n--- a/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n+++ b/pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java\n\n@@ -94,22 +95,19 @@ public enum AggregationFunctionType {\n         return PERCENTILEESTMV;\n       } else if (remainingFunctionName.equals(\"TDIGESTMV\") || remainingFunctionName.matches(\"TDIGEST\\\\d+MV\")) {\n         return PERCENTILETDIGESTMV;\n-      } else {\n-        throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n       }\n-    } else {\n-      try {\n-        return AggregationFunctionType.valueOf(upperCaseFunctionName);\n-      } catch (Exception e) {\n-        if (upperCaseFunctionName.contains(\"_\")) {\n-          try {\n-            return AggregationFunctionType.valueOf(upperCaseFunctionName.replace(\"_\", \"\"));\n-          } catch (Exception e2) {\n-            // throw IllegalArgumentException\n-          }\n+    }\n+    try {\n+      return AggregationFunctionType.valueOf(upperCaseFunctionName);\n+    } catch (Exception e) {\n+      if (upperCaseFunctionName.contains(\"_\")) {\n+        try {\n+          return getAggregationFunctionType(upperCaseFunctionName.replace(\"_\", \"\"));\n+        } catch (Exception e2) {\n+          // throw IllegalArgumentException\n         }\n-        throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n       }\n     }\n+    throw new IllegalArgumentException(\"Invalid aggregation function name: \" + functionName);\n   }\n }\n"}}, {"oid": "89120991952a9e86086ef465a9a567b81879f7ad", "url": "https://github.com/apache/pinot/commit/89120991952a9e86086ef465a9a567b81879f7ad", "message": "Support aggregation function name with underscore inside", "committedDate": "2020-08-05T00:42:09Z", "type": "commit"}, {"oid": "89120991952a9e86086ef465a9a567b81879f7ad", "url": "https://github.com/apache/pinot/commit/89120991952a9e86086ef465a9a567b81879f7ad", "message": "Support aggregation function name with underscore inside", "committedDate": "2020-08-05T00:42:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MjE4OQ==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r466062189", "bodyText": "Why do we have to do upperCase again?\nAggregationFunctionType is an enum so getName() should return upper case right?", "author": "siddharthteotia", "createdAt": "2020-08-05T23:38:04Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java", "diffHunk": "@@ -45,10 +45,12 @@ private AggregationFunctionFactory() {\n   public static AggregationFunction getAggregationFunction(FunctionContext function, QueryContext queryContext) {\n     try {\n       String upperCaseFunctionName = function.getFunctionName().toUpperCase();\n+      AggregationFunctionType aggregationFunctionType =\n+          AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName);\n       List<ExpressionContext> arguments = function.getArguments();\n       ExpressionContext firstArgument = arguments.get(0);\n-      if (upperCaseFunctionName.startsWith(\"PERCENTILE\")) {\n-        String remainingFunctionName = upperCaseFunctionName.substring(10);\n+      if (aggregationFunctionType.getName().toUpperCase().startsWith(\"PERCENTILE\")) {", "originalCommit": "89120991952a9e86086ef465a9a567b81879f7ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA3MTM2Ng==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r466071366", "bodyText": "We defined enums as:\n  PERCENTILEMV(\"percentileMV\"),\n  PERCENTILEESTMV(\"percentileEstMV\"),\n  PERCENTILETDIGESTMV(\"percentileTDigestMV\"),", "author": "xiangfu0", "createdAt": "2020-08-06T00:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MjE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4MjQ1MA==", "url": "https://github.com/apache/pinot/pull/5795#discussion_r466082450", "bodyText": ".name() will return upper case though :-P", "author": "Jackie-Jiang", "createdAt": "2020-08-06T00:50:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2MjE4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3e4fdc02bc28f82c7bfd3697895bb1efec043f5b", "chunk": "diff --git a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\nindex f5a6e01ab4..ad4959729b 100644\n--- a/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\n+++ b/pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/AggregationFunctionFactory.java\n\n@@ -49,7 +49,7 @@ public class AggregationFunctionFactory {\n           AggregationFunctionType.getAggregationFunctionType(upperCaseFunctionName);\n       List<ExpressionContext> arguments = function.getArguments();\n       ExpressionContext firstArgument = arguments.get(0);\n-      if (aggregationFunctionType.getName().toUpperCase().startsWith(\"PERCENTILE\")) {\n+      if (aggregationFunctionType.name().startsWith(\"PERCENTILE\")) {\n         String remainingFunctionName = upperCaseFunctionName.replace(\"_\", \"\").substring(10);\n         int numArguments = arguments.size();\n         if (numArguments == 1) {\n"}}, {"oid": "3e4fdc02bc28f82c7bfd3697895bb1efec043f5b", "url": "https://github.com/apache/pinot/commit/3e4fdc02bc28f82c7bfd3697895bb1efec043f5b", "message": "Change ST_Union AggregationType enum to STUnion", "committedDate": "2020-08-06T07:30:47Z", "type": "commit"}, {"oid": "fe1f80a3ab7191238228308671fb968835c5baea", "url": "https://github.com/apache/pinot/commit/fe1f80a3ab7191238228308671fb968835c5baea", "message": "Simplify the handling", "committedDate": "2020-08-06T18:01:16Z", "type": "commit"}, {"oid": "fe1f80a3ab7191238228308671fb968835c5baea", "url": "https://github.com/apache/pinot/commit/fe1f80a3ab7191238228308671fb968835c5baea", "message": "Simplify the handling", "committedDate": "2020-08-06T18:01:16Z", "type": "forcePushed"}]}