{"pr_number": 6385, "pr_title": "cleanup tar.gz segment files on job exit", "pr_createdAt": "2020-12-25T08:48:29Z", "pr_url": "https://github.com/apache/pinot/pull/6385", "timeline": [{"oid": "940328dd79b122777379e4d4713c589370dec6ec", "url": "https://github.com/apache/pinot/commit/940328dd79b122777379e4d4713c589370dec6ec", "message": "cleanup tar.gz post upload complete.", "committedDate": "2020-12-25T08:43:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU2NA==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912564", "bodyText": "this one assumes the tar file is on local disk, which may not be true always. E.g. the tar file could be on S3.\nThe path is s3://<my-bucket>/<my-tar>.tar.gz\nIn this case, you need to use PinotFs to delete the tar file.", "author": "xiangfu0", "createdAt": "2020-12-25T21:16:47Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "originalCommit": "940328dd79b122777379e4d4713c589370dec6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzAxNg==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963016", "bodyText": "Thanks for the review and pointing out to use PinotFS. Fixed.", "author": "amarnathkarthik", "createdAt": "2020-12-26T09:19:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU2NA=="}], "type": "inlineReview", "revised_code": {"commit": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "chunk": "diff --git a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\nindex 7f5f90b782..4c3b41b14b 100644\n--- a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n+++ b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n\n@@ -136,7 +138,9 @@ public class SegmentPushUtils implements Serializable {\n               throw e;\n             }\n           } finally {\n-            FileUtils.deleteQuietly(tarFile);\n+            if (cleanUpOutputDir) {\n+              fileSystem.delete(tarFileURI, true);\n+            }\n           }\n         });\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU4Nw==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912587", "bodyText": "Same above.", "author": "xiangfu0", "createdAt": "2020-12-25T21:16:58Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -183,6 +187,8 @@ public static void sendSegmentUris(SegmentGenerationJobSpec spec, List<String> s\n                   tableName, segmentUri, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(segmentPath);", "originalCommit": "940328dd79b122777379e4d4713c589370dec6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzAyMA==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963020", "bodyText": "Fixed", "author": "amarnathkarthik", "createdAt": "2020-12-26T09:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjU4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "chunk": "diff --git a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\nindex 7f5f90b782..4c3b41b14b 100644\n--- a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n+++ b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n\n@@ -188,7 +193,9 @@ public class SegmentPushUtils implements Serializable {\n               throw e;\n             }\n           } finally {\n-            FileUtils.deleteQuietly(segmentPath);\n+            if (spec.isCleanUpOutputDir()) {\n+              outputDirFS.delete(segmentURI, true);\n+            }\n           }\n         });\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjgyNQ==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548912825", "bodyText": "Please use flag to turn on/off this deletion.", "author": "xiangfu0", "createdAt": "2020-12-25T21:21:05Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -134,6 +135,8 @@ public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSyste\n                       segmentName, controllerURI, e);\n               throw e;\n             }\n+          } finally {\n+            FileUtils.deleteQuietly(tarFile);", "originalCommit": "940328dd79b122777379e4d4713c589370dec6ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk2MzExMQ==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r548963111", "bodyText": "Added _cleanUpOutputDir in jobSpec and defaults to false. Have tested for jobType SegmentCreationAndTarPush and SegmentCreationAndUriPush with _cleanUpOutputDir=true/false", "author": "amarnathkarthik", "createdAt": "2020-12-26T09:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxMjgyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "chunk": "diff --git a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\nindex 7f5f90b782..4c3b41b14b 100644\n--- a/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n+++ b/pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java\n\n@@ -136,7 +138,9 @@ public class SegmentPushUtils implements Serializable {\n               throw e;\n             }\n           } finally {\n-            FileUtils.deleteQuietly(tarFile);\n+            if (cleanUpOutputDir) {\n+              fileSystem.delete(tarFileURI, true);\n+            }\n           }\n         });\n       }\n"}}, {"oid": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "url": "https://github.com/apache/pinot/commit/e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "message": "cleanup tar.gz segment files on job exit.", "committedDate": "2020-12-26T09:15:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE0NzQ4Ng==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r549147486", "bodyText": "Any specific reason to create this variable, as opposed to using spec.isCleanupOutputDir() inline, given that it is just used in one place?", "author": "mayankshriv", "createdAt": "2020-12-27T18:09:47Z", "path": "pinot-plugins/pinot-batch-ingestion/pinot-batch-ingestion-common/src/main/java/org/apache/pinot/plugin/ingestion/batch/common/SegmentPushUtils.java", "diffHunk": "@@ -87,6 +89,7 @@ public static URI generateSegmentTarURI(URI dirURI, URI fileURI, String prefix,\n   public static void pushSegments(SegmentGenerationJobSpec spec, PinotFS fileSystem, List<String> tarFilePaths)\n       throws RetriableOperationException, AttemptsExceededException {\n     String tableName = spec.getTableSpec().getTableName();\n+    boolean cleanUpOutputDir = spec.isCleanUpOutputDir();", "originalCommit": "e8cbe1b9cd3be11e4a618e95ac5884a8ac1690af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE1MzQ0OA==", "url": "https://github.com/apache/pinot/pull/6385#discussion_r549153448", "bodyText": "For readability and spec.isCleanUpOutputDir() is a kind of constant within the method which does not change in the nested for-loop thought defining a variable in outer scope will be helpful. Let me know if you would want to just go with  spec.isCleanUpOutputDir().", "author": "amarnathkarthik", "createdAt": "2020-12-27T19:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTE0NzQ4Ng=="}], "type": "inlineReview", "revised_code": null}]}