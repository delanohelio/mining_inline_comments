{"pr_number": 8521, "pr_title": "Duplicate headers in controller creates a crash. #8404", "pr_createdAt": "2020-12-02T14:59:06Z", "pr_url": "https://github.com/enonic/xp/pull/8521", "timeline": [{"oid": "450a375669104f1cb7fd4fc3d10fade791eed218", "url": "https://github.com/enonic/xp/commit/450a375669104f1cb7fd4fc3d10fade791eed218", "message": "Duplicate headers in controller creates a crash. #8404", "committedDate": "2020-12-02T15:44:29Z", "type": "forcePushed"}, {"oid": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "url": "https://github.com/enonic/xp/commit/d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "message": "Duplicate headers in controller creates a crash. #8404", "committedDate": "2020-12-02T16:26:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMjQ3OQ==", "url": "https://github.com/enonic/xp/pull/8521#discussion_r534322479", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ;", "author": "rymsha", "createdAt": "2020-12-02T16:50:40Z", "path": "modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java", "diffHunk": "@@ -106,7 +109,9 @@ public WebSocketConfig getWebSocket()\n     {\n         private Object body;\n \n-        private ImmutableMap.Builder<String, String> headers;\n+        private Map<String, String> headers = new HashMap<>();\n+\n+        ;", "originalCommit": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "25e57d46745e588ae9e3b06debf89c710a434f5e", "chunk": "diff --git a/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java b/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\nindex c8b2e464a5..bbf8499b8a 100644\n--- a/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\n+++ b/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\n\n@@ -105,35 +105,31 @@ public class WebResponse\n         return this.webSocket;\n     }\n \n-    public static class Builder<T extends Builder>\n+    public static class Builder<T extends Builder<T>>\n     {\n         private Object body;\n \n         private Map<String, String> headers = new HashMap<>();\n \n-        ;\n-\n         private MediaType contentType = MediaType.PLAIN_TEXT_UTF_8;\n \n         private HttpStatus status = HttpStatus.OK;\n \n-        private ImmutableList.Builder<Cookie> cookies;\n+        private ImmutableList.Builder<Cookie> cookies = ImmutableList.builder();\n \n         private WebSocketConfig webSocket;\n \n         protected Builder()\n         {\n-            clearHeaders();\n-            clearCookies();\n         }\n \n         protected Builder( final WebResponse source )\n         {\n             this.body = source.body;\n-            headers( source.headers );\n+            putAllHeaders( source.headers );\n             this.contentType = source.contentType;\n             this.status = source.status;\n-            cookies( source.cookies );\n+            addAllCookies( source.cookies );\n             this.webSocket = source.webSocket;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMzEzNA==", "url": "https://github.com/enonic/xp/pull/8521#discussion_r534323134", "bodyText": "Don't use in constructor", "author": "rymsha", "createdAt": "2020-12-02T16:51:34Z", "path": "modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java", "diffHunk": "@@ -140,27 +145,19 @@ public T body( final Object body )\n \n         public T headers( final Map<String, String> headers )\n         {\n-            if ( this.headers == null )\n-            {\n-                clearHeaders();\n-            }\n-            this.headers.putAll( headers );\n+            headers.forEach( ( key, value ) -> this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) ) );\n             return (T) this;\n         }\n \n         public T header( final String key, final String value )\n         {\n-            if ( this.headers == null )\n-            {\n-                clearHeaders();\n-            }\n-            this.headers.put( key, value );\n+            this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) );\n             return (T) this;\n         }\n \n         public T clearHeaders()", "originalCommit": "d22c8b8d4cd04eccf5600540d3e2c4dbb3168dce", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "25e57d46745e588ae9e3b06debf89c710a434f5e", "chunk": "diff --git a/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java b/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\nindex c8b2e464a5..bbf8499b8a 100644\n--- a/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\n+++ b/modules/web/web-api/src/main/java/com/enonic/xp/web/WebResponse.java\n\n@@ -145,13 +141,13 @@ public class WebResponse\n \n         public T headers( final Map<String, String> headers )\n         {\n-            headers.forEach( ( key, value ) -> this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) ) );\n+            putAllHeaders( headers );\n             return (T) this;\n         }\n \n         public T header( final String key, final String value )\n         {\n-            this.headers.put( key.toLowerCase( Locale.ROOT ), Objects.requireNonNull( value ) );\n+            putHeader( key, value );\n             return (T) this;\n         }\n \n"}}, {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e", "url": "https://github.com/enonic/xp/commit/25e57d46745e588ae9e3b06debf89c710a434f5e", "message": "Duplicate headers in controller creates a crash. #8404", "committedDate": "2020-12-02T21:08:00Z", "type": "commit"}, {"oid": "25e57d46745e588ae9e3b06debf89c710a434f5e", "url": "https://github.com/enonic/xp/commit/25e57d46745e588ae9e3b06debf89c710a434f5e", "message": "Duplicate headers in controller creates a crash. #8404", "committedDate": "2020-12-02T21:08:00Z", "type": "forcePushed"}]}