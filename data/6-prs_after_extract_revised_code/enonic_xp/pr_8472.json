{"pr_number": 8472, "pr_title": "Distributed tasks", "pr_createdAt": "2020-11-11T08:52:51Z", "pr_url": "https://github.com/enonic/xp/pull/8472", "timeline": [{"oid": "0a4050437e534b3b165b1c386fcbf18ea11f4e39", "url": "https://github.com/enonic/xp/commit/0a4050437e534b3b165b1c386fcbf18ea11f4e39", "message": "save", "committedDate": "2020-11-11T13:07:09Z", "type": "forcePushed"}, {"oid": "c9f42518c7985313f027577f48b7efc0a99f38ab", "url": "https://github.com/enonic/xp/commit/c9f42518c7985313f027577f48b7efc0a99f38ab", "message": "save", "committedDate": "2020-11-11T18:03:43Z", "type": "forcePushed"}, {"oid": "a2f5539fd9017f15cb5fa8b87895d3dd33c9e033", "url": "https://github.com/enonic/xp/commit/a2f5539fd9017f15cb5fa8b87895d3dd33c9e033", "message": "save", "committedDate": "2020-11-11T18:53:16Z", "type": "forcePushed"}, {"oid": "4ae5590165ddfeff50a400bba3033b5d553aba1d", "url": "https://github.com/enonic/xp/commit/4ae5590165ddfeff50a400bba3033b5d553aba1d", "message": "save", "committedDate": "2020-11-11T18:58:16Z", "type": "forcePushed"}, {"oid": "6577adc95aa94fe63b6e96023351a2b903435f84", "url": "https://github.com/enonic/xp/commit/6577adc95aa94fe63b6e96023351a2b903435f84", "message": "save", "committedDate": "2020-11-12T10:36:26Z", "type": "forcePushed"}, {"oid": "c9d2e6c51c4dd27ec42ddbccf17c5dd806210748", "url": "https://github.com/enonic/xp/commit/c9d2e6c51c4dd27ec42ddbccf17c5dd806210748", "message": "save", "committedDate": "2020-11-12T11:14:09Z", "type": "forcePushed"}, {"oid": "ab9969b89ea3e544f22b1829f2910da7fa2d2c80", "url": "https://github.com/enonic/xp/commit/ab9969b89ea3e544f22b1829f2910da7fa2d2c80", "message": "Distributed tasks #8436", "committedDate": "2020-11-12T16:10:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NjY3OQ==", "url": "https://github.com/enonic/xp/pull/8472#discussion_r522266679", "bodyText": "Check that all attributes removed", "author": "rymsha", "createdAt": "2020-11-12T17:03:46Z", "path": "modules/core/core-task/src/main/java/com/enonic/xp/impl/task/MemberAttributesApplier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package com.enonic.xp.impl.task;\n+\n+import org.osgi.framework.Bundle;\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.BundleEvent;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Deactivate;\n+import org.osgi.service.component.annotations.Modified;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.util.tracker.BundleTracker;\n+\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.core.Member;\n+\n+import com.enonic.xp.app.ApplicationBundleUtils;\n+\n+@Component\n+public class MemberAttributesApplier\n+    extends BundleTracker<Boolean>\n+{\n+    static final String TASKS_ENABLED_ATTRIBUTE_KEY = \"tasks-enabled\";\n+\n+    static final String TASKS_ENABLED_ATTRIBUTE_PREFIX = TASKS_ENABLED_ATTRIBUTE_KEY + \"-\";\n+\n+    private final Member localMember;\n+\n+    @Activate\n+    public MemberAttributesApplier( final BundleContext context, @Reference final HazelcastInstance hazelcastInstance )\n+    {\n+        super( context, Bundle.ACTIVE, null );\n+        this.localMember = hazelcastInstance.getCluster().getLocalMember();\n+    }\n+\n+    @Activate\n+    public void activate( final TaskConfig config )\n+    {\n+        localMember.setBooleanAttribute( TASKS_ENABLED_ATTRIBUTE_KEY, config.offload_acceptInbound() );\n+        super.open();\n+    }\n+\n+    @Deactivate\n+    public void deactivate()\n+    {\n+        super.close();", "originalCommit": "ab9969b89ea3e544f22b1829f2910da7fa2d2c80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc0NDMzOQ==", "url": "https://github.com/enonic/xp/pull/8472#discussion_r522744339", "bodyText": "yes, removedBundle called on close", "author": "rymsha", "createdAt": "2020-11-13T07:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI2NjY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9d150b8e6efaa06757cb1128992dfb0eb1738850", "chunk": "diff --git a/modules/core/core-task/src/main/java/com/enonic/xp/impl/task/MemberAttributesApplier.java b/modules/core/core-task/src/main/java/com/enonic/xp/impl/task/MemberAttributesApplier.java\nindex 28ffa71e4c..a64cd855a5 100644\n--- a/modules/core/core-task/src/main/java/com/enonic/xp/impl/task/MemberAttributesApplier.java\n+++ b/modules/core/core-task/src/main/java/com/enonic/xp/impl/task/MemberAttributesApplier.java\n\n@@ -3,11 +3,6 @@ package com.enonic.xp.impl.task;\n import org.osgi.framework.Bundle;\n import org.osgi.framework.BundleContext;\n import org.osgi.framework.BundleEvent;\n-import org.osgi.service.component.annotations.Activate;\n-import org.osgi.service.component.annotations.Component;\n-import org.osgi.service.component.annotations.Deactivate;\n-import org.osgi.service.component.annotations.Modified;\n-import org.osgi.service.component.annotations.Reference;\n import org.osgi.util.tracker.BundleTracker;\n \n import com.hazelcast.core.HazelcastInstance;\n"}}, {"oid": "4cbd1a43fcf73cb9bbf9dae1baf431b75640b18e", "url": "https://github.com/enonic/xp/commit/4cbd1a43fcf73cb9bbf9dae1baf431b75640b18e", "message": "Distributed tasks #8436", "committedDate": "2020-11-13T07:45:52Z", "type": "commit"}, {"oid": "4cbd1a43fcf73cb9bbf9dae1baf431b75640b18e", "url": "https://github.com/enonic/xp/commit/4cbd1a43fcf73cb9bbf9dae1baf431b75640b18e", "message": "Distributed tasks #8436", "committedDate": "2020-11-13T07:45:52Z", "type": "forcePushed"}, {"oid": "9d150b8e6efaa06757cb1128992dfb0eb1738850", "url": "https://github.com/enonic/xp/commit/9d150b8e6efaa06757cb1128992dfb0eb1738850", "message": "Distributed tasks #8436", "committedDate": "2020-11-13T10:26:16Z", "type": "commit"}]}