{"pr_number": 8015, "pr_title": "GIF images should not be scaled #8004", "pr_createdAt": "2020-04-09T13:40:47Z", "pr_url": "https://github.com/enonic/xp/pull/8015", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc5MjgxMw==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406792813", "bodyText": "I am not sure that A needs here, I think renderAsSource will be better", "author": "anatol-sialitski", "createdAt": "2020-04-10T14:52:15Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n+\n+        if ( renderAsASource( format ) )", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "chunk": "diff --git a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\nindex b6012add02..3e1e26fed1 100644\n--- a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n+++ b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n\n@@ -51,36 +51,34 @@ public class ImageServiceImpl\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n-\n-        if ( renderAsASource( format ) )\n+        if ( renderAsSource( readImageParams ) )\n         {\n             return contentService.getBinary( readImageParams.getContentId(), readImageParams.getBinaryReference() );\n         }\n \n-        final Path cachedImagePath = getCachedImagePath( readImageParams, format );\n-        return ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams, format ) );\n+        final Path cachedImagePath = getCachedImagePath( readImageParams );\n+        return ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n     }\n \n-    private ByteSource createImage( final ReadImageParams readImageParams, final String format )\n+    private ByteSource createImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n         final ByteSource blob = contentService.getBinary( readImageParams.getContentId(), readImageParams.getBinaryReference() );\n \n         if ( blob != null )\n         {\n-            final BufferedImage bufferedImage = readBufferedImage( blob, readImageParams, format );\n+            final BufferedImage bufferedImage = readBufferedImage( blob, readImageParams );\n             if ( bufferedImage != null )\n             {\n-                return serializeImage( readImageParams, bufferedImage, format );\n+                return serializeImage( readImageParams, bufferedImage );\n             }\n         }\n         return null;\n     }\n \n-    private boolean renderAsASource( final String format )\n+    private boolean renderAsSource( final ReadImageParams params )\n     {\n-        return \"gif\".equalsIgnoreCase( format );\n+        return \"image/gif\".equalsIgnoreCase( params.getMimeType() );\n     }\n \n     @Deprecated\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTIyNA==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406839224", "bodyText": "It seems unnecessary to extract format from MIME type here as we only ignore processing very well defined image/gif MIME. So we can remove renderAsASource altogether and replace it with plain \"image/gif\".equals(readImageParams.getMimeType())", "author": "rymsha", "createdAt": "2020-04-10T16:39:47Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -53,67 +51,47 @@\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final Path cachedImagePath = getCachedImagePath( readImageParams );\n-        ByteSource imageByteSource = ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n-        return imageByteSource;\n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "chunk": "diff --git a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\nindex b6012add02..3e1e26fed1 100644\n--- a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n+++ b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n\n@@ -51,36 +51,34 @@ public class ImageServiceImpl\n     public ByteSource readImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n-        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n-\n-        if ( renderAsASource( format ) )\n+        if ( renderAsSource( readImageParams ) )\n         {\n             return contentService.getBinary( readImageParams.getContentId(), readImageParams.getBinaryReference() );\n         }\n \n-        final Path cachedImagePath = getCachedImagePath( readImageParams, format );\n-        return ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams, format ) );\n+        final Path cachedImagePath = getCachedImagePath( readImageParams );\n+        return ImmutableFilesHelper.computeIfAbsent( cachedImagePath, () -> createImage( readImageParams ) );\n     }\n \n-    private ByteSource createImage( final ReadImageParams readImageParams, final String format )\n+    private ByteSource createImage( final ReadImageParams readImageParams )\n         throws IOException\n     {\n         final ByteSource blob = contentService.getBinary( readImageParams.getContentId(), readImageParams.getBinaryReference() );\n \n         if ( blob != null )\n         {\n-            final BufferedImage bufferedImage = readBufferedImage( blob, readImageParams, format );\n+            final BufferedImage bufferedImage = readBufferedImage( blob, readImageParams );\n             if ( bufferedImage != null )\n             {\n-                return serializeImage( readImageParams, bufferedImage, format );\n+                return serializeImage( readImageParams, bufferedImage );\n             }\n         }\n         return null;\n     }\n \n-    private boolean renderAsASource( final String format )\n+    private boolean renderAsSource( final ReadImageParams params )\n     {\n-        return \"gif\".equalsIgnoreCase( format );\n+        return \"image/gif\".equalsIgnoreCase( params.getMimeType() );\n     }\n \n     @Deprecated\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjA1Mg==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842052", "bodyText": "Move calculation of \"format\" here, so it is also guarded by cache.", "author": "rymsha", "createdAt": "2020-04-10T16:46:25Z", "path": "modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java", "diffHunk": "@@ -157,9 +135,6 @@ else if ( readImageParams.isScaleWidth() )\n         //Filter string value\n         final String filter = readImageParams.getFilterParam() != null ? readImageParams.getFilterParam() : \"no-filter\";\n \n-        //Format string value\n-        final String format = readImageParams.getFormat();", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "chunk": "diff --git a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\nindex b6012add02..3e1e26fed1 100644\n--- a/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n+++ b/modules/core/core-image/src/main/java/com/enonic/xp/core/impl/image/ImageServiceImpl.java\n\n@@ -135,6 +134,7 @@ public class ImageServiceImpl\n         //Filter string value\n         final String filter = readImageParams.getFilterParam() != null ? readImageParams.getFilterParam() : \"no-filter\";\n \n+        final String format = doGetFormatByMimeType( readImageParams.getMimeType() );\n         //Background string value\n         final String background = \"background-\" + readImageParams.getBackgroundColor();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0MjM3Ng==", "url": "https://github.com/enonic/xp/pull/8015#discussion_r406842376", "bodyText": "dead code. remove", "author": "rymsha", "createdAt": "2020-04-10T16:47:11Z", "path": "modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java", "diffHunk": "@@ -62,7 +60,7 @@ public void setUp()\n         imageService.setImageFilterBuilder( imageFilterBuilder );\n     }\n \n-    @Test\n+    /*@Test", "originalCommit": "d364caa89c75d47f4239e3e54ecbbcdbd62e7159", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "chunk": "diff --git a/modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java b/modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java\nindex 04aac98f1d..8d56d90e45 100644\n--- a/modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java\n+++ b/modules/core/core-image/src/test/java/com/enonic/xp/core/impl/image/ImageServiceImplTest.java\n\n@@ -60,25 +60,6 @@ public class ImageServiceImplTest\n         imageService.setImageFilterBuilder( imageFilterBuilder );\n     }\n \n-    /*@Test\n-    public void testGetFormatByMineType()\n-        throws IOException\n-    {\n-        final String format = imageService.getFormatByMimeType( \"image/jpeg\" );\n-        assertEquals( \"JPEG\", format );\n-\n-        boolean ioExceptionCaught = false;\n-        try\n-        {\n-            imageService.getFormatByMimeType( \"image/unknown\" );\n-        }\n-        catch ( IOException e )\n-        {\n-            ioExceptionCaught = true;\n-        }\n-        assertTrue( ioExceptionCaught );\n-    }*/\n-\n     @Test\n     public void testReadImageMinimal()\n         throws IOException\n"}}, {"oid": "668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "url": "https://github.com/enonic/xp/commit/668a11c9a17006f1ec605c37ecc9459bd0ee26e1", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T13:17:57Z", "type": "forcePushed"}, {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T14:13:57Z", "type": "commit"}, {"oid": "18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "url": "https://github.com/enonic/xp/commit/18ed6e2c6b65b68ba5ee9be7424a3f08785c0f12", "message": "GIF images should not be scaled #8004", "committedDate": "2020-04-14T14:13:57Z", "type": "forcePushed"}]}