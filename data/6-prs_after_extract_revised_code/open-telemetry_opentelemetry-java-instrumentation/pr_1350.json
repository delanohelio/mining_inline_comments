{"pr_number": 1350, "pr_title": "Propagate full context", "pr_createdAt": "2020-10-09T03:28:47Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1350", "timeline": [{"oid": "b6d6ccc972deb6c31ea0c2a9a354ec6d1bc274ac", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/b6d6ccc972deb6c31ea0c2a9a354ec6d1bc274ac", "message": "Propagate full context", "committedDate": "2020-10-09T03:19:14Z", "type": "commit"}, {"oid": "335c6353b747c69630fdb6ef406210577f6f6359", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/335c6353b747c69630fdb6ef406210577f6f6359", "message": "spotless", "committedDate": "2020-10-09T03:38:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI0MjUxMw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1350#discussion_r502242513", "bodyText": "Reviewing this made me realize how nervous our propagation patterns make me. Sometimes we propagate the invocation context to remount for an async callback, sometimes the context of the span itself. Makes my head spin \ud83e\udd2f  Don't have a good answer but just food for thought.", "author": "anuraaga", "createdAt": "2020-10-09T07:36:35Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/instrumentation/auto/netty/v3_8/NettyChannelInstrumentation.java", "diffHunk": "@@ -76,16 +77,17 @@ public NettyChannelInstrumentation() {\n   public static class ChannelConnectAdvice extends AbstractNettyAdvice {\n     @Advice.OnMethodEnter\n     public static void addConnectContinuation(@Advice.This Channel channel) {\n-      Span span = NettyHttpServerTracer.TRACER.getCurrentSpan();\n+      Context context = Context.current();\n+      Span span = getSpan(context);\n       if (span.getContext().isValid()) {\n         ContextStore<Channel, ChannelTraceContext> contextStore =\n             InstrumentationContext.get(Channel.class, ChannelTraceContext.class);\n \n         if (contextStore\n                 .putIfAbsent(channel, ChannelTraceContext.Factory.INSTANCE)\n-                .getConnectionContinuation()\n+                .getConnectionContext()\n             == null) {\n-          contextStore.get(channel).setConnectionContinuation(span);\n+          contextStore.get(channel).setConnectionContext(context);", "originalCommit": "335c6353b747c69630fdb6ef406210577f6f6359", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxOTcwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1350#discussion_r502319709", "bodyText": "Care to make an issue?", "author": "iNikem", "createdAt": "2020-10-09T09:56:34Z", "path": "instrumentation/netty/netty-3.8/src/main/java/io/opentelemetry/instrumentation/auto/netty/v3_8/client/HttpClientRequestTracingHandler.java", "diffHunk": "@@ -38,13 +39,14 @@ public void writeRequested(ChannelHandlerContext ctx, MessageEvent msg) {\n     ChannelTraceContext channelTraceContext =\n         contextStore.putIfAbsent(ctx.getChannel(), ChannelTraceContext.Factory.INSTANCE);\n \n+    // TODO pass Context into Tracer.startSpan() and then don't need this scoping", "originalCommit": "335c6353b747c69630fdb6ef406210577f6f6359", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU2OTQ5NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1350#discussion_r502569494", "bodyText": "\ud83d\udc4d #1360", "author": "trask", "createdAt": "2020-10-09T17:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMxOTcwOQ=="}], "type": "inlineReview", "revised_code": null}]}