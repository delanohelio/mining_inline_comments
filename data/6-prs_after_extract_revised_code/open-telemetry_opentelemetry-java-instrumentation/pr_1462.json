{"pr_number": 1462, "pr_title": "Couchbase instrumentation should store normalized queries as db.statement", "pr_createdAt": "2020-10-23T07:22:24Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462", "timeline": [{"oid": "15d131e32ecf8943ae477aeabcf4effe1690c2de", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/15d131e32ecf8943ae477aeabcf4effe1690c2de", "message": "Couchbase instrumentation should store normalized queries as db.statement", "committedDate": "2020-10-23T18:26:55Z", "type": "commit"}, {"oid": "15d131e32ecf8943ae477aeabcf4effe1690c2de", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/15d131e32ecf8943ae477aeabcf4effe1690c2de", "message": "Couchbase instrumentation should store normalized queries as db.statement", "committedDate": "2020-10-23T18:26:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r511074574", "bodyText": "does it make sense to use muzzle and split out separate instrumentation module for couchbase 2.5?", "author": "trask", "createdAt": "2020-10-23T18:40:08Z", "path": "instrumentation/couchbase/couchbase-2.0/src/main/java/io/opentelemetry/javaagent/instrumentation/couchbase/v2_0/CouchbaseQueryNormalizer.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.javaagent.instrumentation.couchbase.v2_0;\n+\n+import io.opentelemetry.javaagent.instrumentation.api.db.normalizer.ParseException;\n+import io.opentelemetry.javaagent.instrumentation.api.db.normalizer.SqlNormalizer;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class CouchbaseQueryNormalizer {\n+  private static final Logger log = LoggerFactory.getLogger(CouchbaseQueryNormalizer.class);\n+\n+  private static final Class<?> QUERY_CLASS;\n+  private static final Class<?> STATEMENT_CLASS;\n+  private static final Class<?> N1QL_QUERY_CLASS;\n+  private static final MethodHandle N1QL_GET_STATEMENT;\n+  private static final Class<?> ANALYTICS_QUERY_CLASS;\n+  private static final MethodHandle ANALYTICS_GET_STATEMENT;\n+\n+  static {\n+    Class<?> queryClass;\n+    try {\n+      queryClass = Class.forName(\"com.couchbase.client.java.query.Query\");\n+    } catch (Exception e) {\n+      queryClass = null;\n+    }\n+    QUERY_CLASS = queryClass;\n+\n+    Class<?> statementClass;\n+    try {\n+      statementClass = Class.forName(\"com.couchbase.client.java.query.Statement\");\n+    } catch (Exception e) {\n+      statementClass = null;\n+    }\n+    STATEMENT_CLASS = statementClass;\n+\n+    Class<?> n1qlQueryClass;\n+    MethodHandle n1qlGetStatement;\n+    try {\n+      n1qlQueryClass = Class.forName(\"com.couchbase.client.java.query.N1qlQuery\");\n+      n1qlGetStatement =\n+          MethodHandles.publicLookup()\n+              .findVirtual(\n+                  n1qlQueryClass,\n+                  \"statement\",\n+                  MethodType.methodType(\n+                      Class.forName(\"com.couchbase.client.java.query.Statement\")));\n+    } catch (Exception e) {\n+      n1qlQueryClass = null;\n+      n1qlGetStatement = null;\n+    }\n+    N1QL_QUERY_CLASS = n1qlQueryClass;\n+    N1QL_GET_STATEMENT = n1qlGetStatement;\n+\n+    Class<?> analyticsQueryClass;\n+    MethodHandle analyticsGetStatement;\n+    try {\n+      analyticsQueryClass = Class.forName(\"com.couchbase.client.java.analytics.AnalyticsQuery\");\n+      analyticsGetStatement =\n+          MethodHandles.publicLookup()\n+              .findVirtual(analyticsQueryClass, \"statement\", MethodType.methodType(String.class));\n+    } catch (Exception e) {\n+      analyticsQueryClass = null;\n+      analyticsGetStatement = null;\n+    }\n+    ANALYTICS_QUERY_CLASS = analyticsQueryClass;\n+    ANALYTICS_GET_STATEMENT = analyticsGetStatement;\n+  }\n+\n+  public static String normalize(Object query) {\n+    if (query instanceof String) {\n+      return normalizeString((String) query);\n+    }\n+    // Couchbase 2.0 uses Query, Couchbase 2.5+ uses Statement", "originalCommit": "15d131e32ecf8943ae477aeabcf4effe1690c2de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM4NzMwNw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r511387307", "bodyText": "Just a general remark: I think the fewer modules we have, the better :)", "author": "iNikem", "createdAt": "2020-10-24T10:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5ODkyNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r511498926", "bodyText": "I think it's a trade-off of how much complexity we need to add in order to handle multiple incompatible versions in a single module\nspring-webflux is the only other module that uses MethodHandle, and in that case adds much less complexity compared to this\nall other modules currently use muzzle to handle incompatible versions", "author": "trask", "createdAt": "2020-10-24T18:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg2MDQwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r511860400", "bodyText": "It turns out the situation is much more complicated: I was kinda lazy last time (\ud83d\ude05 ) and did not check in which version which class appears, but I did it right now and it looks like we'd need 4 different instrumentations if we wanted to avoid using MethodHandles at all: 2.0.0 - 2.1.0, 2.1.0 - 2.2.0, 2.2.0 - 2.4.3, 2.4.3 - latest.", "author": "mateuszrzeszutek", "createdAt": "2020-10-26T10:32:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5NDg3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r512194879", "bodyText": "yikes that's a lot of version dependency!\nif we keep it in a single module, how do we get test coverage of these different versions? maybe we need a way to specify multiple versions for testLatestDeps?", "author": "trask", "createdAt": "2020-10-26T18:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDQ1OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r512570459", "bodyText": "Right now all tests use Couchbase 2.5.0 (common test code in couchbase-testing for both 2.0.0 and 2.6.0 instrumentations) and every query type except the 2.0.0-2.2.0 Query interface is covered. If we wanted to test that we'd probably need to refactor the testing module.", "author": "mateuszrzeszutek", "createdAt": "2020-10-27T10:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgyMzk3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/1462#discussion_r512823973", "bodyText": "thx for explanations, approach / testing coverage seems reasonable to me", "author": "trask", "createdAt": "2020-10-27T16:05:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTA3NDU3NA=="}], "type": "inlineReview", "revised_code": {"commit": "06ac6f17702fa0b55f5eb4eed76d473b7163dd08", "chunk": "diff --git a/instrumentation/couchbase/couchbase-2.0/src/main/java/io/opentelemetry/javaagent/instrumentation/couchbase/v2_0/CouchbaseQueryNormalizer.java b/instrumentation/couchbase/couchbase-2.0/src/main/java/io/opentelemetry/javaagent/instrumentation/couchbase/v2_0/CouchbaseQueryNormalizer.java\nindex 65f8e15cb8..7700db79eb 100644\n--- a/instrumentation/couchbase/couchbase-2.0/src/main/java/io/opentelemetry/javaagent/instrumentation/couchbase/v2_0/CouchbaseQueryNormalizer.java\n+++ b/instrumentation/couchbase/couchbase-2.0/src/main/java/io/opentelemetry/javaagent/instrumentation/couchbase/v2_0/CouchbaseQueryNormalizer.java\n\n@@ -77,24 +77,26 @@ public final class CouchbaseQueryNormalizer {\n     if (query instanceof String) {\n       return normalizeString((String) query);\n     }\n-    // Couchbase 2.0 uses Query, Couchbase 2.5+ uses Statement\n+    // Query is present in Couchbase [2.0.0, 2.2.0)\n+    // Statement is present starting from Couchbase 2.1.0\n     if (QUERY_CLASS != null && QUERY_CLASS.isAssignableFrom(query.getClass())\n         || STATEMENT_CLASS != null && STATEMENT_CLASS.isAssignableFrom(query.getClass())) {\n       return normalizeString(query.toString());\n     }\n+    // SpatialViewQuery is present starting from Couchbase 2.1.0\n     String queryClassName = query.getClass().getName();\n     if (queryClassName.equals(\"com.couchbase.client.java.view.ViewQuery\")\n         || queryClassName.equals(\"com.couchbase.client.java.view.SpatialViewQuery\")) {\n       return query.toString();\n     }\n-    // available from Couchbase 2.5+\n+    // N1qlQuery is present starting from Couchbase 2.2.0\n     if (N1QL_QUERY_CLASS != null && N1QL_QUERY_CLASS.isAssignableFrom(query.getClass())) {\n       String statement = getStatementString(N1QL_GET_STATEMENT, query);\n       if (statement != null) {\n         return normalizeString(statement);\n       }\n     }\n-    // available from Couchbase 2.5+\n+    // AnalyticsQuery is present starting from Couchbase 2.4.3\n     if (ANALYTICS_QUERY_CLASS != null && ANALYTICS_QUERY_CLASS.isAssignableFrom(query.getClass())) {\n       String statement = getStatementString(ANALYTICS_GET_STATEMENT, query);\n       if (statement != null) {\n"}}, {"oid": "06ac6f17702fa0b55f5eb4eed76d473b7163dd08", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/06ac6f17702fa0b55f5eb4eed76d473b7163dd08", "message": "Fix inaccurate version comments", "committedDate": "2020-10-26T10:28:54Z", "type": "commit"}]}