{"pr_number": 379, "pr_title": "Add support for new @WithSpan annotation", "pr_createdAt": "2020-05-05T07:32:19Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379", "timeline": [{"oid": "9d7716614053f58eb5a33f238796def9aa2fcaa4", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/9d7716614053f58eb5a33f238796def9aa2fcaa4", "message": "Add support for new @WithSpan annotation", "committedDate": "2020-05-05T07:30:39Z", "type": "commit"}, {"oid": "99fa73e96b92b748e60e0d4a4d1ad631d2d09260", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/99fa73e96b92b748e60e0d4a4d1ad631d2d09260", "message": "Add api contrib into shaded parts of the agent", "committedDate": "2020-05-05T10:39:00Z", "type": "commit"}, {"oid": "ee415edcf00ce82d589beca6023ff85b104066dd", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ee415edcf00ce82d589beca6023ff85b104066dd", "message": "Try to separate methods dealing with different annotations", "committedDate": "2020-05-05T11:47:09Z", "type": "commit"}, {"oid": "ee415edcf00ce82d589beca6023ff85b104066dd", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/ee415edcf00ce82d589beca6023ff85b104066dd", "message": "Try to separate methods dealing with different annotations", "committedDate": "2020-05-05T11:47:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMzI4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420523282", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @WithSpan()\n          \n          \n            \n              @WithSpan", "author": "trask", "createdAt": "2020-05-06T03:14:04Z", "path": "instrumentation/trace-annotation/src/test/java/io/opentelemetry/test/annotation/TracedWithSpan.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.test.annotation;\n+\n+import io.opentelemetry.OpenTelemetry;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n+import io.opentelemetry.trace.Tracer;\n+\n+public class TracedWithSpan {\n+\n+  private static final Tracer TRACER =\n+      OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto\");\n+\n+  @WithSpan()", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/instrumentation/trace-annotation/src/test/java/io/opentelemetry/test/annotation/TracedWithSpan.java b/instrumentation/trace-annotation/src/test/java/io/opentelemetry/test/annotation/TracedWithSpan.java\nindex b0bd789aed..fbc7e6bbfc 100644\n--- a/instrumentation/trace-annotation/src/test/java/io/opentelemetry/test/annotation/TracedWithSpan.java\n+++ b/instrumentation/trace-annotation/src/test/java/io/opentelemetry/test/annotation/TracedWithSpan.java\n\n@@ -24,7 +24,7 @@ public class TracedWithSpan {\n   private static final Tracer TRACER =\n       OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto\");\n \n-  @WithSpan()\n+  @WithSpan\n   public String otel() {\n     TRACER.getCurrentSpan().setAttribute(\"providerAttr\", \"Otel\");\n     return \"hello!\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDEzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420524131", "bodyText": "unused\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @Slf4j", "author": "trask", "createdAt": "2020-05-06T03:18:10Z", "path": "instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.auto.instrumentation.traceannotation;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.auto.tooling.Instrumenter;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import net.bytebuddy.description.annotation.AnnotationSource;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * Instrumentation for methods annotated with {@link\n+ * io.opentelemetry.contrib.auto.annotations.WithSpan} annotation. As that is Otel annotation, we\n+ * provide full support for all its attributes, as opposed to bare minimum functionality of {@link\n+ * TraceAnnotationsInstrumentation} for third party annotations.\n+ */\n+@Slf4j", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\nindex 9091f7331f..be1a948246 100644\n--- a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n+++ b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n\n@@ -15,15 +15,16 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n+import static io.opentelemetry.auto.instrumentation.traceannotation.TraceDecorator.configureExcludedMethods;\n import static java.util.Collections.singletonMap;\n import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n \n import com.google.auto.service.AutoService;\n import io.opentelemetry.auto.tooling.Instrumenter;\n import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import java.util.Map;\n-import lombok.extern.slf4j.Slf4j;\n import net.bytebuddy.description.annotation.AnnotationSource;\n import net.bytebuddy.description.method.MethodDescription;\n import net.bytebuddy.description.type.TypeDescription;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNDgzMg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420524832", "bodyText": "\ud83d\udc4d this helped me understand why you didn't wedge this into the existing TraceAnnotationsInstrumentation. makes sense.", "author": "trask", "createdAt": "2020-05-06T03:21:42Z", "path": "instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.auto.instrumentation.traceannotation;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.auto.tooling.Instrumenter;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import net.bytebuddy.description.annotation.AnnotationSource;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * Instrumentation for methods annotated with {@link\n+ * io.opentelemetry.contrib.auto.annotations.WithSpan} annotation. As that is Otel annotation, we\n+ * provide full support for all its attributes, as opposed to bare minimum functionality of {@link\n+ * TraceAnnotationsInstrumentation} for third party annotations.\n+ */", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\nindex 9091f7331f..be1a948246 100644\n--- a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n+++ b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n\n@@ -15,15 +15,16 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n+import static io.opentelemetry.auto.instrumentation.traceannotation.TraceDecorator.configureExcludedMethods;\n import static java.util.Collections.singletonMap;\n import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n \n import com.google.auto.service.AutoService;\n import io.opentelemetry.auto.tooling.Instrumenter;\n import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import java.util.Map;\n-import lombok.extern.slf4j.Slf4j;\n import net.bytebuddy.description.annotation.AnnotationSource;\n import net.bytebuddy.description.method.MethodDescription;\n import net.bytebuddy.description.type.TypeDescription;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNzAwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420527001", "bodyText": "I don't think we need this in BaseDecorator, maybe just (static) method in TraceDecorator?", "author": "trask", "createdAt": "2020-05-06T03:32:07Z", "path": "agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java", "diffHunk": "@@ -95,6 +96,21 @@ public String spanNameForMethod(final Method method) {\n     return spanNameForClass(method.getDeclaringClass()) + \".\" + method.getName();\n   }\n \n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. It first checks for existence of {@link WithSpan} annotation. If it is present, then\n+   * tries to derive name from its {@code value} attribute. Otherwise delegates to {@link\n+   * #spanNameForMethod(Method)}.\n+   */\n+  public String spanNameForMethodWithAnnotation(final Method method) {\n+    WithSpan annotation = method.getAnnotation(WithSpan.class);\n+    if (annotation != null && !annotation.value().isEmpty()) {\n+      return annotation.value();\n+    }\n+\n+    return spanNameForMethod(method);\n+  }\n+", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java b/agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java\nindex 0265dc6e15..5633b09e43 100644\n--- a/agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java\n+++ b/agent-bootstrap/src/main/java/io/opentelemetry/auto/bootstrap/instrumentation/decorator/BaseDecorator.java\n\n@@ -88,35 +87,14 @@ public abstract class BaseDecorator {\n   /**\n    * This method is used to generate an acceptable span (operation) name based on a given method\n    * reference. Anonymous classes are named based on their parent.\n-   *\n-   * @param method\n-   * @return\n    */\n   public String spanNameForMethod(final Method method) {\n     return spanNameForClass(method.getDeclaringClass()) + \".\" + method.getName();\n   }\n \n-  /**\n-   * This method is used to generate an acceptable span (operation) name based on a given method\n-   * reference. It first checks for existence of {@link WithSpan} annotation. If it is present, then\n-   * tries to derive name from its {@code value} attribute. Otherwise delegates to {@link\n-   * #spanNameForMethod(Method)}.\n-   */\n-  public String spanNameForMethodWithAnnotation(final Method method) {\n-    WithSpan annotation = method.getAnnotation(WithSpan.class);\n-    if (annotation != null && !annotation.value().isEmpty()) {\n-      return annotation.value();\n-    }\n-\n-    return spanNameForMethod(method);\n-  }\n-\n   /**\n    * This method is used to generate an acceptable span (operation) name based on a given class\n    * reference. Anonymous classes are named based on their parent.\n-   *\n-   * @param clazz\n-   * @return\n    */\n   public String spanNameForClass(final Class clazz) {\n     if (!clazz.isAnonymousClass()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyOTQxNA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420529414", "bodyText": "for consistency with other instrumentation in this module (though probably worth revisit the convention in this module, and even the module name, but doesn't need to be in this PR)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                super(\"api-contrib\");\n          \n          \n            \n                super(\"trace\", \"with-span-annotation\");", "author": "trask", "createdAt": "2020-05-06T03:43:40Z", "path": "instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.auto.instrumentation.traceannotation;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.auto.tooling.Instrumenter;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import net.bytebuddy.description.annotation.AnnotationSource;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * Instrumentation for methods annotated with {@link\n+ * io.opentelemetry.contrib.auto.annotations.WithSpan} annotation. As that is Otel annotation, we\n+ * provide full support for all its attributes, as opposed to bare minimum functionality of {@link\n+ * TraceAnnotationsInstrumentation} for third party annotations.\n+ */\n+@Slf4j\n+@AutoService(Instrumenter.class)\n+public final class WithSpanAnnotationInstrumentation extends Instrumenter.Default {\n+\n+  private final ElementMatcher.Junction<AnnotationSource> annotatedMethodMatcher;\n+\n+  public WithSpanAnnotationInstrumentation() {\n+    super(\"api-contrib\");", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\nindex 9091f7331f..be1a948246 100644\n--- a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n+++ b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n\n@@ -15,15 +15,16 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n+import static io.opentelemetry.auto.instrumentation.traceannotation.TraceDecorator.configureExcludedMethods;\n import static java.util.Collections.singletonMap;\n import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n \n import com.google.auto.service.AutoService;\n import io.opentelemetry.auto.tooling.Instrumenter;\n import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import java.util.Map;\n-import lombok.extern.slf4j.Slf4j;\n import net.bytebuddy.description.annotation.AnnotationSource;\n import net.bytebuddy.description.method.MethodDescription;\n import net.bytebuddy.description.type.TypeDescription;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyOTc3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420529779", "bodyText": "do we want to apply trace.methods.exclude here?", "author": "trask", "createdAt": "2020-05-06T03:45:31Z", "path": "instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.opentelemetry.auto.instrumentation.traceannotation;\n+\n+import static java.util.Collections.singletonMap;\n+import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n+import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+\n+import com.google.auto.service.AutoService;\n+import io.opentelemetry.auto.tooling.Instrumenter;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n+import java.util.Map;\n+import lombok.extern.slf4j.Slf4j;\n+import net.bytebuddy.description.annotation.AnnotationSource;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+/**\n+ * Instrumentation for methods annotated with {@link\n+ * io.opentelemetry.contrib.auto.annotations.WithSpan} annotation. As that is Otel annotation, we\n+ * provide full support for all its attributes, as opposed to bare minimum functionality of {@link\n+ * TraceAnnotationsInstrumentation} for third party annotations.\n+ */\n+@Slf4j\n+@AutoService(Instrumenter.class)\n+public final class WithSpanAnnotationInstrumentation extends Instrumenter.Default {\n+\n+  private final ElementMatcher.Junction<AnnotationSource> annotatedMethodMatcher;\n+\n+  public WithSpanAnnotationInstrumentation() {\n+    super(\"api-contrib\");\n+    annotatedMethodMatcher = isAnnotatedWith(WithSpan.class);\n+  }\n+\n+  @Override\n+  public ElementMatcher<TypeDescription> typeMatcher() {\n+    return declaresMethod(annotatedMethodMatcher);\n+  }\n+\n+  @Override\n+  public String[] helperClassNames() {\n+    return new String[] {\n+      packageName + \".TraceDecorator\",\n+    };\n+  }\n+\n+  @Override\n+  public Map<? extends ElementMatcher<? super MethodDescription>, String> transformers() {\n+    return singletonMap(annotatedMethodMatcher, packageName + \".WithSpanAdvice\");", "originalCommit": "ee415edcf00ce82d589beca6023ff85b104066dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDcxMTA2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420711066", "bodyText": "Good catch, thank you! Will do", "author": "iNikem", "createdAt": "2020-05-06T11:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyOTc3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "chunk": "diff --git a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\nindex 9091f7331f..be1a948246 100644\n--- a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n+++ b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/WithSpanAnnotationInstrumentation.java\n\n@@ -15,15 +15,16 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n+import static io.opentelemetry.auto.instrumentation.traceannotation.TraceDecorator.configureExcludedMethods;\n import static java.util.Collections.singletonMap;\n import static net.bytebuddy.matcher.ElementMatchers.declaresMethod;\n import static net.bytebuddy.matcher.ElementMatchers.isAnnotatedWith;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n \n import com.google.auto.service.AutoService;\n import io.opentelemetry.auto.tooling.Instrumenter;\n import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import java.util.Map;\n-import lombok.extern.slf4j.Slf4j;\n import net.bytebuddy.description.annotation.AnnotationSource;\n import net.bytebuddy.description.method.MethodDescription;\n import net.bytebuddy.description.type.TypeDescription;\n"}}, {"oid": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/98b29a6ddb0095821cd975d1afec5bdc744ca34a", "message": "Code review suggestions done", "committedDate": "2020-05-06T11:15:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1OTE1NA==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420859154", "bodyText": "I think the cause of the muzzle failures is this method. I don't think the classloader that the advice classes are applied to has bytebuddy in it's classpath", "author": "devinsba", "createdAt": "2020-05-06T14:57:32Z", "path": "instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/TraceDecorator.java", "diffHunk": "@@ -15,13 +15,66 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n+import static net.bytebuddy.matcher.ElementMatchers.isDeclaredBy;\n+import static net.bytebuddy.matcher.ElementMatchers.none;\n+\n import io.opentelemetry.OpenTelemetry;\n import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n+import io.opentelemetry.auto.config.Config;\n+import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import io.opentelemetry.trace.Tracer;\n+import java.lang.reflect.Method;\n+import java.util.Map;\n+import java.util.Set;\n+import net.bytebuddy.description.ByteCodeElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import net.bytebuddy.matcher.ElementMatchers;\n \n public class TraceDecorator extends BaseDecorator {\n   public static final TraceDecorator DECORATE = new TraceDecorator();\n \n   public static final Tracer TRACER =\n       OpenTelemetry.getTracerProvider().get(\"io.opentelemetry.auto.trace-annotation\");\n+\n+  /**\n+   * This method is used to generate an acceptable span (operation) name based on a given method\n+   * reference. It first checks for existence of {@link WithSpan} annotation. If it is present, then\n+   * tries to derive name from its {@code value} attribute. Otherwise delegates to {@link\n+   * #spanNameForMethod(Method)}.\n+   */\n+  public String spanNameForMethodWithAnnotation(final Method method) {\n+    WithSpan annotation = method.getAnnotation(WithSpan.class);\n+    if (annotation != null && !annotation.value().isEmpty()) {\n+      return annotation.value();\n+    }\n+\n+    return spanNameForMethod(method);\n+  }\n+\n+  /*\n+  Returns a matcher for all methods that should be excluded from auto-instrumentation by\n+  annotation-based advices.\n+   */\n+  static ElementMatcher.Junction<MethodDescription> configureExcludedMethods() {", "originalCommit": "98b29a6ddb0095821cd975d1afec5bdc744ca34a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1OTg0OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420859849", "bodyText": "Looks like you moved it here from one of the Instrumenter classes, might want to make an abstract parent class if this is needed multiple places", "author": "devinsba", "createdAt": "2020-05-06T14:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1OTE1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5NzczNg==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/379#discussion_r420897736", "bodyText": "Thanks!", "author": "iNikem", "createdAt": "2020-05-06T15:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1OTE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "0dd9ea83a57736226f5b79b4aecec01b83cf13b7", "chunk": "diff --git a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/TraceDecorator.java b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/TraceDecorator.java\nindex 774687d863..bc01947316 100644\n--- a/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/TraceDecorator.java\n+++ b/instrumentation/trace-annotation/src/main/java/io/opentelemetry/auto/instrumentation/traceannotation/TraceDecorator.java\n\n@@ -15,22 +15,11 @@\n  */\n package io.opentelemetry.auto.instrumentation.traceannotation;\n \n-import static net.bytebuddy.matcher.ElementMatchers.isDeclaredBy;\n-import static net.bytebuddy.matcher.ElementMatchers.none;\n-\n import io.opentelemetry.OpenTelemetry;\n import io.opentelemetry.auto.bootstrap.instrumentation.decorator.BaseDecorator;\n-import io.opentelemetry.auto.config.Config;\n import io.opentelemetry.contrib.auto.annotations.WithSpan;\n import io.opentelemetry.trace.Tracer;\n import java.lang.reflect.Method;\n-import java.util.Map;\n-import java.util.Set;\n-import net.bytebuddy.description.ByteCodeElement;\n-import net.bytebuddy.description.method.MethodDescription;\n-import net.bytebuddy.description.type.TypeDescription;\n-import net.bytebuddy.matcher.ElementMatcher;\n-import net.bytebuddy.matcher.ElementMatchers;\n \n public class TraceDecorator extends BaseDecorator {\n   public static final TraceDecorator DECORATE = new TraceDecorator();\n"}}, {"oid": "0dd9ea83a57736226f5b79b4aecec01b83cf13b7", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0dd9ea83a57736226f5b79b4aecec01b83cf13b7", "message": "Fix muzzle failure", "committedDate": "2020-05-06T15:21:30Z", "type": "commit"}, {"oid": "3e4ef1d6fb90d93d0c844b573c1f9f3be5bfd868", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/3e4ef1d6fb90d93d0c844b573c1f9f3be5bfd868", "message": "Merge branch 'master' into gh-359", "committedDate": "2020-05-06T18:49:04Z", "type": "commit"}]}