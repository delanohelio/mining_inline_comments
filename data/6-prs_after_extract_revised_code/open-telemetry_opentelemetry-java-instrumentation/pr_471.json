{"pr_number": 471, "pr_title": "Fixed Mongo client double tracing bug", "pr_createdAt": "2020-06-03T08:12:21Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471", "timeline": [{"oid": "254de93321b296e5ff269f3210d70f01e03bb9c2", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/254de93321b296e5ff269f3210d70f01e03bb9c2", "message": "Fixes #457", "committedDate": "2020-06-03T08:08:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0MzU5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/pull/471#discussion_r434443591", "bodyText": "Inline this variable", "author": "iNikem", "createdAt": "2020-06-03T09:45:07Z", "path": "instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java", "diffHunk": "@@ -75,8 +77,16 @@ public MongoClientInstrumentation() {\n   public static class MongoClientAdvice {\n \n     @Advice.OnMethodEnter(suppress = Throwable.class)\n-    public static void injectTraceListener(@Advice.This final MongoClientOptions.Builder builder) {\n-      builder.addCommandListener(new TracingCommandListener());\n+    public static void injectTraceListener(\n+        @Advice.This final MongoClientOptions.Builder builder,\n+        @Advice.FieldValue(\"commandListeners\") final List<CommandListener> commandListeners) {\n+      for (final CommandListener commandListener : commandListeners) {\n+        if (commandListener instanceof TracingCommandListener) {\n+          return;\n+        }\n+      }\n+      final TracingCommandListener listener = new TracingCommandListener();", "originalCommit": "254de93321b296e5ff269f3210d70f01e03bb9c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c573f1df84b2ca8eb1f8e68867871d46495cc3df", "chunk": "diff --git a/instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java b/instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java\nindex 273bfd21ec..650bd695e3 100644\n--- a/instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java\n+++ b/instrumentation/mongo/mongo-3.1/src/main/java/io/opentelemetry/auto/instrumentation/mongo/v3_1/MongoClientInstrumentation.java\n\n@@ -85,8 +85,7 @@ public final class MongoClientInstrumentation extends Instrumenter.Default {\n           return;\n         }\n       }\n-      final TracingCommandListener listener = new TracingCommandListener();\n-      builder.addCommandListener(listener);\n+      builder.addCommandListener(new TracingCommandListener());\n     }\n   }\n }\n"}}, {"oid": "c573f1df84b2ca8eb1f8e68867871d46495cc3df", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/c573f1df84b2ca8eb1f8e68867871d46495cc3df", "message": "Addressing review comments\n1. Added comments in test\n2. Fixed latestDepTest failures in MongoAsyncClient by adding `declaresField`\n3. Made TracingCommandListener inline in MongoClientAdvice", "committedDate": "2020-06-04T08:31:21Z", "type": "commit"}, {"oid": "0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "url": "https://github.com/open-telemetry/opentelemetry-java-instrumentation/commit/0b9f17c10655f70f6f81e9359e6b22c3eddfda8c", "message": "Merge branch 'master' into master", "committedDate": "2020-06-04T14:40:31Z", "type": "commit"}]}