{"pr_number": 309, "pr_title": "Fix for upgrading mapping", "pr_createdAt": "2020-11-09T22:42:11Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309", "timeline": [{"oid": "a42ee95f27de230fbe360fa4ab394b865fc13cb6", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/a42ee95f27de230fbe360fa4ab394b865fc13cb6", "message": "Fix for upgrading mapping\n\nThis PR fixes two bugs of upgrading mapping:\nFirst, previously we only tried once when upgrading mapping.\u00a0 It is possible we need to try a few more times.\u00a0 The drawback is that if the code has a bug, we retry endlessly.\u00a0 I should fix it in the future.\nSecond, we enclose the upgrade mapping function call under a user context in a recent commit.\u00a0 Upgrade mapping will fail when security plugin is enabled since a regular user cannot upgrade mappings of system indices.\n\nThe PR also adds upper bounds to our dynamic settings if reasonable.\nTesting done:\n1. Tested that upgrade mapping succeeds with new changes.\n2. Tested the upper bounds of the changed settings are in effect.", "committedDate": "2020-11-09T22:38:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MjAzNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520172034", "bodyText": "If remove this line, will not update index mapping if any exception happens?", "author": "ylwu-amzn", "createdAt": "2020-11-09T22:51:38Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java", "diffHunk": "@@ -578,7 +578,11 @@ public void updateMappingIfNecessary() {\n         }\n \n         final GroupedActionListener<Void> conglomerateListeneer = new GroupedActionListener<>(\n-            ActionListener.wrap(r -> updateRunning.set(false), exception -> logger.error(\"Fail to updatea all mappings\")),\n+            ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n+                // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n+                updateRunning.set(false);", "originalCommit": "a42ee95f27de230fbe360fa4ab394b865fc13cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MDE5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520180192", "bodyText": "if removing this line, we will only try to update mapping once per node.", "author": "kaituo", "createdAt": "2020-11-09T23:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MjAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "ed6c3516a5bc1408e1fb5c509205afae323fc837", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\nindex 0fbe2e6..a398fcf 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\n\n@@ -581,7 +581,7 @@ public class AnomalyDetectionIndices implements LocalNodeMasterListener {\n             ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n                 // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n                 updateRunning.set(false);\n-                logger.error(\"Fail to updatea all mappings\");\n+                logger.error(\"Fail to update AD indices' mappings\");\n             }),\n             updates.size()\n         );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3NDQ0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520174445", "bodyText": "Add ad to the error message.", "author": "ylwu-amzn", "createdAt": "2020-11-09T22:57:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java", "diffHunk": "@@ -578,7 +578,11 @@ public void updateMappingIfNecessary() {\n         }\n \n         final GroupedActionListener<Void> conglomerateListeneer = new GroupedActionListener<>(\n-            ActionListener.wrap(r -> updateRunning.set(false), exception -> logger.error(\"Fail to updatea all mappings\")),\n+            ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n+                // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n+                updateRunning.set(false);\n+                logger.error(\"Fail to updatea all mappings\");", "originalCommit": "a42ee95f27de230fbe360fa4ab394b865fc13cb6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MDA1OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/309#discussion_r520180058", "bodyText": "added", "author": "kaituo", "createdAt": "2020-11-09T23:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3NDQ0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ed6c3516a5bc1408e1fb5c509205afae323fc837", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\nindex 0fbe2e6..a398fcf 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/indices/AnomalyDetectionIndices.java\n\n@@ -581,7 +581,7 @@ public class AnomalyDetectionIndices implements LocalNodeMasterListener {\n             ActionListener.wrap(r -> updateRunning.set(false), exception -> {\n                 // TODO: don't retry endlessly. Can be annoying if there are too many exception logs.\n                 updateRunning.set(false);\n-                logger.error(\"Fail to updatea all mappings\");\n+                logger.error(\"Fail to update AD indices' mappings\");\n             }),\n             updates.size()\n         );\n"}}, {"oid": "ed6c3516a5bc1408e1fb5c509205afae323fc837", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/ed6c3516a5bc1408e1fb5c509205afae323fc837", "message": "Update log message", "committedDate": "2020-11-09T23:16:09Z", "type": "commit"}]}