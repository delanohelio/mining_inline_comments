{"pr_number": 154, "pr_title": "Fix retrying saving anomaly results", "pr_createdAt": "2020-06-15T19:02:15Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154", "timeline": [{"oid": "9517858a752607ae199ab6456e018e47def78dae", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/9517858a752607ae199ab6456e018e47def78dae", "message": "Fix retrying saving anomaly results\n\nPreviously, AD throws an exception when retrying saving an anomaly result, indicating autoGeneratedTimestamp should not be set. We can see the exception because we reuse the same IndexRequest, where autoGeneratedTimestamp is already set. This PR creates a new IndexRequest by copying the original request without autoGeneratedTimestamp.\n\nThis PR also adds detector id to AnomalyDetectionException\u2019s toString method so that we can see the id in the log. This PR also adds more logging to SearchFeatureDao.", "committedDate": "2020-06-15T18:54:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDMxNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440420314", "bodyText": "Minor. Should the index name be from the original index request?", "author": "wnbts", "createdAt": "2020-06-15T20:13:10Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/transport/handler/AnomalyResultHandler.java", "diffHunk": "@@ -192,7 +192,12 @@ void saveDetectorResult(IndexRequest indexRequest, String context, Iterator<Time\n             } else {\n                 TimeValue nextDelay = backoff.next();\n                 LOG.warn(RETRY_SAVING_ERR_MSG + context, cause);\n-                threadPool.schedule(() -> saveDetectorResult(indexRequest, context, backoff), nextDelay, ThreadPool.Names.SAME);\n+                // copy original request's source without other information like autoGeneratedTimestamp\n+                // otherwise, an exception will be thrown indicating autoGeneratedTimestamp should not be set\n+                // while request id is already set (id is set because we have already sent the request before).\n+                IndexRequest newReuqest = new IndexRequest(AnomalyResult.ANOMALY_RESULT_INDEX);", "originalCommit": "9517858a752607ae199ab6456e018e47def78dae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMjI5Nw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440422297", "bodyText": "This is AnomalyResultHandler, so its index should be AnomalyResult.ANOMALY_RESULT_INDEX.", "author": "kaituo", "createdAt": "2020-06-15T20:16:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDMxNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNjY5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440426695", "bodyText": "starting %d -> ending at %d?", "author": "yizheliu-amazon", "createdAt": "2020-06-15T20:26:00Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java", "diffHunk": "@@ -367,6 +380,7 @@ public void getFeaturesForSampledPeriods(\n         ActionListener<Optional<Entry<double[][], Integer>>> listener\n     ) {\n         Map<Long, double[]> cache = new HashMap<>();\n+        logger.info(String.format(\"Getting features for detector %s starting %d\", detector.getDetectorId(), endTime));", "originalCommit": "9517858a752607ae199ab6456e018e47def78dae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyODM4OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/154#discussion_r440428388", "bodyText": "Good catch.  we don't know the start time at this point.  Changed to \"logger.info(String.format(\"Getting features for detector %s ending at %d\", detector.getDetectorId(), endTime));\"", "author": "kaituo", "createdAt": "2020-06-15T20:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNjY5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8112edbcc369a2ab7e37a695dbd6391374dd78ae", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java\nindex 22820f2..5e9bb9d 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/feature/SearchFeatureDao.java\n\n@@ -380,7 +380,7 @@ public class SearchFeatureDao {\n         ActionListener<Optional<Entry<double[][], Integer>>> listener\n     ) {\n         Map<Long, double[]> cache = new HashMap<>();\n-        logger.info(String.format(\"Getting features for detector %s starting %d\", detector.getDetectorId(), endTime));\n+        logger.info(String.format(\"Getting features for detector %s ending at %d\", detector.getDetectorId(), endTime));\n         getFeatureSamplesWithCache(detector, maxSamples, maxStride, endTime, cache, maxStride, listener);\n     }\n \n"}}, {"oid": "8112edbcc369a2ab7e37a695dbd6391374dd78ae", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/8112edbcc369a2ab7e37a695dbd6391374dd78ae", "message": "Change from \"starting\" to \"ending at\"", "committedDate": "2020-06-15T20:30:43Z", "type": "commit"}]}