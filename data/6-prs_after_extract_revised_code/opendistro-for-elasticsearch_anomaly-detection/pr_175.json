{"pr_number": 175, "pr_title": "Add dyanmic setting for memory threshold", "pr_createdAt": "2020-06-24T17:44:48Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/175", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NDk4NA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/175#discussion_r445164984", "bodyText": "minor. why not add maxvalue?", "author": "wnbts", "createdAt": "2020-06-24T20:52:35Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java", "diffHunk": "@@ -163,7 +163,8 @@ private AnomalyDetectorSettings() {}\n \n     public static final double DESIRED_MODEL_SIZE_PERCENTAGE = 0.0002;\n \n-    public static final double MODEL_MAX_SIZE_PERCENTAGE = 0.1;\n+    public static final Setting<Double> MODEL_MAX_SIZE_PERCENTAGE = Setting\n+        .doubleSetting(\"opendistro.anomaly_detection.model_max_size_percent\", 0.1, 0, Setting.Property.NodeScope, Setting.Property.Dynamic);", "originalCommit": "dffdf3207668778f21f86916ae9d87247cedf26a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMzYyMg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/175#discussion_r447103622", "bodyText": "added 0.7 as max", "author": "kaituo", "createdAt": "2020-06-29T16:35:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NDk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "b02ca222bea716c4745f6da14408a8bc03c9815a", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java\nindex 03ea472..fd84fe5 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/settings/AnomalyDetectorSettings.java\n\n@@ -164,7 +163,14 @@ public final class AnomalyDetectorSettings {\n     public static final double DESIRED_MODEL_SIZE_PERCENTAGE = 0.0002;\n \n     public static final Setting<Double> MODEL_MAX_SIZE_PERCENTAGE = Setting\n-        .doubleSetting(\"opendistro.anomaly_detection.model_max_size_percent\", 0.1, 0, Setting.Property.NodeScope, Setting.Property.Dynamic);\n+        .doubleSetting(\n+            \"opendistro.anomaly_detection.model_max_size_percent\",\n+            0.1,\n+            0,\n+            0.7,\n+            Setting.Property.NodeScope,\n+            Setting.Property.Dynamic\n+        );\n \n     // Thresholding\n     public static final double THRESHOLD_MIN_PVALUE = 0.995;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NjY0OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/175#discussion_r445166648", "bodyText": "why not do this at plugin configuration to reduce unnecessary dependencies only used once?", "author": "wnbts", "createdAt": "2020-06-24T20:55:50Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java", "diffHunk": "@@ -197,6 +200,9 @@ public ModelManager(\n         this.forests = new ConcurrentHashMap<>();\n         this.thresholds = new ConcurrentHashMap<>();\n         this.shingleSize = shingleSize;\n+\n+        this.modelMaxSizePercentage = MODEL_MAX_SIZE_PERCENTAGE.get(settings);", "originalCommit": "dffdf3207668778f21f86916ae9d87247cedf26a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzOTYwNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/175#discussion_r447139604", "bodyText": "good idea.  Changed.", "author": "kaituo", "createdAt": "2020-06-29T17:36:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NjY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "b02ca222bea716c4745f6da14408a8bc03c9815a", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java\nindex 13e6006..cfe6ce0 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/ml/ModelManager.java\n\n@@ -201,8 +202,7 @@ public class ModelManager {\n         this.thresholds = new ConcurrentHashMap<>();\n         this.shingleSize = shingleSize;\n \n-        this.modelMaxSizePercentage = MODEL_MAX_SIZE_PERCENTAGE.get(settings);\n-        clusterService.getClusterSettings().addSettingsUpdateConsumer(MODEL_MAX_SIZE_PERCENTAGE, it -> modelMaxSizePercentage = it);\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(MODEL_MAX_SIZE_PERCENTAGE, it -> this.modelMaxSizePercentage = it);\n     }\n \n     /**\n"}}, {"oid": "337779b3c5e391d76e6da2e280ddf44a0d4313ac", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/337779b3c5e391d76e6da2e280ddf44a0d4313ac", "message": "Add dyanmic setting for memory threshold\n\nWe have the following two memory threshold:\n* a detector's model size per node cannot exceed 10% of heap memory\n* the total model size per node cannot exceed 10% of heap memory.\nIf users use the ES cluster mainly for anomaly detection, they should be able to increase the memory for AD.This PR makes the threshold dynamically adjustable via the setting opendistro.anomaly_detection.model_max_size_percent.\n\nTesting done:\n* Manually verified I can dynamically adjust the memory threshold setting. \u00a0", "committedDate": "2020-06-29T17:59:16Z", "type": "commit"}, {"oid": "b02ca222bea716c4745f6da14408a8bc03c9815a", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b02ca222bea716c4745f6da14408a8bc03c9815a", "message": "Move modelMaxSizePercentage's value source to plugin configuration", "committedDate": "2020-06-29T17:59:16Z", "type": "commit"}, {"oid": "b02ca222bea716c4745f6da14408a8bc03c9815a", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b02ca222bea716c4745f6da14408a8bc03c9815a", "message": "Move modelMaxSizePercentage's value source to plugin configuration", "committedDate": "2020-06-29T17:59:16Z", "type": "forcePushed"}]}