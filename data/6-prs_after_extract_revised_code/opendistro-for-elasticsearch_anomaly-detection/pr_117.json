{"pr_number": 117, "pr_title": "Improve profile API's error fetching efficiency", "pr_createdAt": "2020-05-08T20:42:20Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117", "timeline": [{"oid": "0c0230b9cc2946b6454cda06a0b76c9c830977fa", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/0c0230b9cc2946b6454cda06a0b76c9c830977fa", "message": "Improve profile API's error fetching efficiency\n\nPreviously, profile API scans all anomaly result indices to get a detector's most recent error, which can cause performance bottleneck with large anomaly result indices. This PR improves this aspect via various efforts.\n\nFirst, when a detector is running, we only need to scan the current index, not all of the rolled over ones since we are interested in the latest error.\nSecond, when a detector is disabled, we only need to scan the latest anomaly result indices created before the detector's enable time.\nThird, setting track total hits false makes ES terminate search early. ES will not try to count the number of documents and will be able to end the query as soon as N document have been collected per segment.\n\nTesting done:\n1. patched a cluster with 1,000 detectors and 2GB anomaly result indices. Without the PR, scanning anomaly result indices 1000 times would timeout after 30 seconds. After the PR, we would not see the timeout.\n2. A detector's error message can be on a rotated index. Adds a test case to makes sure we get error info from .opendistro-anomaly-results index that has been rolled over.", "committedDate": "2020-05-08T20:35:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5Nzk5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117#discussion_r422397992", "bodyText": "will Jan. cause any issue? I guess in case of Jan., month is 1, not sure if this can cause any issue", "author": "yizheliu-amazon", "createdAt": "2020-05-08T22:07:57Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java", "diffHunk": "@@ -234,20 +260,81 @@ private void profileState(\n     }\n \n     /**\n+     * Precondition:\n+     * 1. Index are rotated with name pattern \".opendistro-anomaly-results-history-{now/d}-1\" and now is using UTC.\n+     * 2. Latest entry with error is recorded within enabled and disabled time.  Note disabled time can be null.\n+     *\n      * Error is populated if error of the latest anomaly result is not empty.\n      * @param detectorId detector id\n-     * @param enabledTime the time when AD job is enabled in milliseconds\n+     * @param enabledTimeMillis the time when AD job is enabled in milliseconds\n      * @param listener listener to process the returned error or exception\n      */\n-    private void profileError(String detectorId, long enabledTime, MultiResponsesDelegateActionListener<DetectorProfile> listener) {\n-        SearchRequest searchLatestResult = createLatestAnomalyResultRequest(detectorId, enabledTime);\n+    private void profileError(\n+        String detectorId,\n+        long enabledTimeMillis,\n+        Instant disabledTime,\n+        MultiResponsesDelegateActionListener<DetectorProfile> listener\n+    ) {\n+        String[] latestIndex = null;\n+\n+        long disabledTimeMillis = 0;\n+        if (disabledTime != null) {\n+            disabledTimeMillis = disabledTime.toEpochMilli();\n+        }\n+        if (enabledTimeMillis > disabledTimeMillis) {\n+            // detector is still running\n+            latestIndex = new String[1];\n+            latestIndex[0] = AnomalyResult.ANOMALY_RESULT_INDEX;\n+        } else {\n+            String[] concreteIndices = indexNameExpressionResolver\n+                .concreteIndexNames(\n+                    clusterService.state(),\n+                    IndicesOptions.lenientExpandOpen(),\n+                    AnomalyDetectionIndices.ALL_AD_RESULTS_INDEX_PATTERN\n+                );\n+\n+            // find the latest from result indices such as .opendistro-anomaly-results-history-2020.04.06-1 and\n+            // /.opendistro-anomaly-results-history-2020.04.07-000002\n+            long maxTimestamp = -1;\n+            Map<Long, List<String>> candidateIndices = new HashMap<>();\n+            for (String indexName : concreteIndices) {\n+                Matcher m = Pattern.compile(\"\\\\.opendistro-anomaly-results-history-(\\\\d{4})\\\\.(\\\\d{2})\\\\.(\\\\d{2})-\\\\d+\").matcher(indexName);\n+                if (m.matches()) {\n+                    int year = Integer.parseInt(m.group(1));\n+                    int month = Integer.parseInt(m.group(2));\n+                    int date = Integer.parseInt(m.group(3));\n+                    // month starts with 0\n+                    calendar.clear();\n+                    calendar.set(year, month - 1, date);", "originalCommit": "0c0230b9cc2946b6454cda06a0b76c9c830977fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwMDI1OA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117#discussion_r422400258", "bodyText": "I would suggest you use current year/month/date to initialize calendar, and do calendar.add(Calendar.MONTH, -1) instead.", "author": "yizheliu-amazon", "createdAt": "2020-05-08T22:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5Nzk5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwMzYyMw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117#discussion_r422403623", "bodyText": "will Jan. cause any issue? I guess in case of Jan., month is 1, not sure if this can cause any issue\n\njust checked java doc. month for Jan is 0 here.", "author": "yizheliu-amazon", "createdAt": "2020-05-08T22:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM5Nzk5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b1f597bfbc31dbe1231acda002ae75aaa886fe2c", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\nindex cdc9f61..943a1a4 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\n\n@@ -265,6 +265,14 @@ public class AnomalyDetectorProfileRunner {\n      * 2. Latest entry with error is recorded within enabled and disabled time.  Note disabled time can be null.\n      *\n      * Error is populated if error of the latest anomaly result is not empty.\n+     *\n+     * Two optimization to avoid scanning all anomaly result indices to get a detector's most recent error\n+     *\n+     * First, when a detector is running, we only need to scan the current index, not all of the rolled over ones\n+     *  since we are interested in the latest error.\n+     * Second, when a detector is disabled, we only need to scan the latest anomaly result indices created before the\n+     *  detector's enable time.\n+     *\n      * @param detectorId detector id\n      * @param enabledTimeMillis the time when AD job is enabled in milliseconds\n      * @param listener listener to process the returned error or exception\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwNjI5Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117#discussion_r422406292", "bodyText": "One edge case: suppose detector interval is 1 minute\n1.Detector last run is at 2020-05-07, 11:59:50 PM, then AD result indices rolled over as .opendistro-anomaly-results-history-2020.05.07-001\n2.Detector next run will be 2020-05-08, 00:00:50 AM. If user stop the detector at  2020-05-08 00:00:10 AM, detector will not have AD result on 2020-05-08.\nSo this code change will check latest AD result index on 2020-05-08, as  2020-05-08 <= 2020-05-08 00:00:10 AM(disabledTime). But we can't find any AD result for this detector on 2020-05-08. How about we check last two days' AD result indices to make sure we can always get AD result? Similar to set monitor interval as 2*detector_interval", "author": "ylwu-amzn", "createdAt": "2020-05-08T22:36:11Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java", "diffHunk": "@@ -234,20 +260,81 @@ private void profileState(\n     }\n \n     /**\n+     * Precondition:\n+     * 1. Index are rotated with name pattern \".opendistro-anomaly-results-history-{now/d}-1\" and now is using UTC.\n+     * 2. Latest entry with error is recorded within enabled and disabled time.  Note disabled time can be null.\n+     *\n      * Error is populated if error of the latest anomaly result is not empty.\n      * @param detectorId detector id\n-     * @param enabledTime the time when AD job is enabled in milliseconds\n+     * @param enabledTimeMillis the time when AD job is enabled in milliseconds\n      * @param listener listener to process the returned error or exception\n      */\n-    private void profileError(String detectorId, long enabledTime, MultiResponsesDelegateActionListener<DetectorProfile> listener) {\n-        SearchRequest searchLatestResult = createLatestAnomalyResultRequest(detectorId, enabledTime);\n+    private void profileError(\n+        String detectorId,\n+        long enabledTimeMillis,\n+        Instant disabledTime,\n+        MultiResponsesDelegateActionListener<DetectorProfile> listener\n+    ) {\n+        String[] latestIndex = null;\n+\n+        long disabledTimeMillis = 0;\n+        if (disabledTime != null) {\n+            disabledTimeMillis = disabledTime.toEpochMilli();\n+        }\n+        if (enabledTimeMillis > disabledTimeMillis) {\n+            // detector is still running\n+            latestIndex = new String[1];\n+            latestIndex[0] = AnomalyResult.ANOMALY_RESULT_INDEX;\n+        } else {\n+            String[] concreteIndices = indexNameExpressionResolver\n+                .concreteIndexNames(\n+                    clusterService.state(),\n+                    IndicesOptions.lenientExpandOpen(),\n+                    AnomalyDetectionIndices.ALL_AD_RESULTS_INDEX_PATTERN\n+                );\n+\n+            // find the latest from result indices such as .opendistro-anomaly-results-history-2020.04.06-1 and\n+            // /.opendistro-anomaly-results-history-2020.04.07-000002\n+            long maxTimestamp = -1;\n+            Map<Long, List<String>> candidateIndices = new HashMap<>();\n+            for (String indexName : concreteIndices) {\n+                Matcher m = Pattern.compile(\"\\\\.opendistro-anomaly-results-history-(\\\\d{4})\\\\.(\\\\d{2})\\\\.(\\\\d{2})-\\\\d+\").matcher(indexName);\n+                if (m.matches()) {\n+                    int year = Integer.parseInt(m.group(1));\n+                    int month = Integer.parseInt(m.group(2));\n+                    int date = Integer.parseInt(m.group(3));\n+                    // month starts with 0\n+                    calendar.clear();\n+                    calendar.set(year, month - 1, date);\n+                    // 2020.05.08 is translated to 1588896000000\n+                    long timestamp = calendar.getTimeInMillis();\n+\n+                    // a candidate index can be created before or after enabled time, but the index is definitely created before disabled\n+                    // time\n+                    if (timestamp <= disabledTimeMillis && maxTimestamp <= timestamp) {\n+                        maxTimestamp = timestamp;\n+                        // we can have two rotations on the same day and we don't know which one has our data, so we keep all", "originalCommit": "0c0230b9cc2946b6454cda06a0b76c9c830977fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0NTUyOA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/117#discussion_r422445528", "bodyText": "Good point.  Changed.", "author": "kaituo", "createdAt": "2020-05-09T02:58:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQwNjI5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b1f597bfbc31dbe1231acda002ae75aaa886fe2c", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\nindex cdc9f61..943a1a4 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/AnomalyDetectorProfileRunner.java\n\n@@ -265,6 +265,14 @@ public class AnomalyDetectorProfileRunner {\n      * 2. Latest entry with error is recorded within enabled and disabled time.  Note disabled time can be null.\n      *\n      * Error is populated if error of the latest anomaly result is not empty.\n+     *\n+     * Two optimization to avoid scanning all anomaly result indices to get a detector's most recent error\n+     *\n+     * First, when a detector is running, we only need to scan the current index, not all of the rolled over ones\n+     *  since we are interested in the latest error.\n+     * Second, when a detector is disabled, we only need to scan the latest anomaly result indices created before the\n+     *  detector's enable time.\n+     *\n      * @param detectorId detector id\n      * @param enabledTimeMillis the time when AD job is enabled in milliseconds\n      * @param listener listener to process the returned error or exception\n"}}, {"oid": "b1f597bfbc31dbe1231acda002ae75aaa886fe2c", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b1f597bfbc31dbe1231acda002ae75aaa886fe2c", "message": "Scan one more index to address edge case", "committedDate": "2020-05-09T02:28:46Z", "type": "commit"}]}