{"pr_number": 133, "pr_title": "Add CI/CD workflows", "pr_createdAt": "2020-05-21T21:57:08Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133", "timeline": [{"oid": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/b530acfafd75a5b10c72ed98e3fb88029c78a30f", "message": "Added CI/CD workflows\n\nThis PR adds CI/CD workflows. CI workflow builds a zip file, installs that on the official odfe docker image, and runs rest test case.  CI workflow is triggered via branch pushing.  CD workflow builds zip, rpm, deb files and uploads those files to s3.  CD workflow is triggered via tag creation.\n\nThis PR also increases model initialization waiting time as needed on an rest test case as that time can be can be longer on a remote cluster.\n\nTesting done:\n1. run the scripts on CI/CD workflow on Mac and tested it works.\n2. make sure local gradle build time does not increase.", "committedDate": "2020-05-21T21:44:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzI3Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363276", "bodyText": "if it is timed out, is it better to fail fast?", "author": "wnbts", "createdAt": "2020-05-22T17:13:22Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);\n-        getDetectionResult(detectorId, begin, end, client);\n+        // It takes more time to wait for model initialization on a remote cluster\n+        long startTime = System.currentTimeMillis();\n+        while (true) {\n+            try {\n+                getDetectionResult(detectorId, begin, end, client);\n+                break;\n+            } catch (Exception e) {\n+                long duration = System.currentTimeMillis() - startTime;\n+                // we wait at most 60 secs\n+                if (duration < 60_000) {\n+                    Thread.sleep(2_000);\n+                } else {", "originalCommit": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUwMjgxNg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429502816", "bodyText": "yeah, changed to throw exception.", "author": "kaituo", "createdAt": "2020-05-23T01:39:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "02b38770c3b9b078b1d03758c6e5d555e1e363d2", "chunk": "diff --git a/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java b/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\nindex a619e34..5c2ad6a 100644\n--- a/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\n+++ b/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\n\n@@ -171,23 +171,21 @@ public class DetectionResultEvalutationIT extends ESRestTestCase {\n                 getDetectionResult(detectorId, begin, end, client);\n             } catch (Exception e) {}\n         }\n-        Thread.sleep(5_000);\n-        // It takes more time to wait for model initialization on a remote cluster\n+        // It takes time to wait for model initialization\n         long startTime = System.currentTimeMillis();\n-        while (true) {\n+        do {\n             try {\n+                Thread.sleep(5_000);\n                 getDetectionResult(detectorId, begin, end, client);\n                 break;\n             } catch (Exception e) {\n                 long duration = System.currentTimeMillis() - startTime;\n                 // we wait at most 60 secs\n-                if (duration < 60_000) {\n-                    Thread.sleep(2_000);\n-                } else {\n-                    break;\n+                if (duration > 60_000) {\n+                    throw new RuntimeException(e);\n                 }\n             }\n-        }\n+        } while (true);\n     }\n \n     private String createDetector(String datasetName, int intervalMinutes, RestClient client) throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzU5Ng==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429363596", "bodyText": "this wait can be merged to the wait below now", "author": "wnbts", "createdAt": "2020-05-22T17:14:06Z", "path": "src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java", "diffHunk": "@@ -172,7 +172,22 @@ private void startDetector(\n             } catch (Exception e) {}\n         }\n         Thread.sleep(5_000);", "originalCommit": "b530acfafd75a5b10c72ed98e3fb88029c78a30f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUwMjgyNw==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/133#discussion_r429502827", "bodyText": "merged", "author": "kaituo", "createdAt": "2020-05-23T01:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM2MzU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "02b38770c3b9b078b1d03758c6e5d555e1e363d2", "chunk": "diff --git a/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java b/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\nindex a619e34..5c2ad6a 100644\n--- a/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\n+++ b/src/test/java/com/amazon/opendistroforelasticsearch/ad/e2e/DetectionResultEvalutationIT.java\n\n@@ -171,23 +171,21 @@ public class DetectionResultEvalutationIT extends ESRestTestCase {\n                 getDetectionResult(detectorId, begin, end, client);\n             } catch (Exception e) {}\n         }\n-        Thread.sleep(5_000);\n-        // It takes more time to wait for model initialization on a remote cluster\n+        // It takes time to wait for model initialization\n         long startTime = System.currentTimeMillis();\n-        while (true) {\n+        do {\n             try {\n+                Thread.sleep(5_000);\n                 getDetectionResult(detectorId, begin, end, client);\n                 break;\n             } catch (Exception e) {\n                 long duration = System.currentTimeMillis() - startTime;\n                 // we wait at most 60 secs\n-                if (duration < 60_000) {\n-                    Thread.sleep(2_000);\n-                } else {\n-                    break;\n+                if (duration > 60_000) {\n+                    throw new RuntimeException(e);\n                 }\n             }\n-        }\n+        } while (true);\n     }\n \n     private String createDetector(String datasetName, int intervalMinutes, RestClient client) throws Exception {\n"}}, {"oid": "02b38770c3b9b078b1d03758c6e5d555e1e363d2", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/02b38770c3b9b078b1d03758c6e5d555e1e363d2", "message": "Merge multiple test commands into one and refactor test case", "committedDate": "2020-05-23T02:39:28Z", "type": "commit"}]}