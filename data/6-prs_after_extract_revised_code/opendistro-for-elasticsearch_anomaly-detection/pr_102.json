{"pr_number": 102, "pr_title": "Fix that AD job cannot be terminated due to missing training data", "pr_createdAt": "2020-05-04T15:53:37Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY1MjAxNA==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#discussion_r419652014", "bodyText": "Can you log the matching exception as well?\nnit: my personal preference is to log as ERROR, since it is in the scope of 1 particular exception log, same as below.", "author": "yizheliu-amazon", "createdAt": "2020-05-04T18:49:36Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java", "diffHunk": "@@ -80,8 +83,10 @@ public void shutDown() {\n         checkResult();\n \n         if (currentExceptions.containsKey(adID)) {\n-            LOG.error(\"Found matching exception for {}\", adID);\n+            LOG.info(\"Found a matching exception for {}\", adID);", "originalCommit": "f3bd9fa59973d61e8f241c00c0c181d39f4b466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc1MDU0Mg==", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/pull/102#discussion_r419750542", "bodyText": "logged\nchanges this to error.  For the else case, it is not an error since we don't expect an exception to happen during cold start.", "author": "kaituo", "createdAt": "2020-05-04T21:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY1MjAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "cf4889211d1af15459f187c7ce0d9dfc1700b545", "chunk": "diff --git a/src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java b/src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java\nindex 267f5d1..00dc757 100644\n--- a/src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java\n+++ b/src/main/java/com/amazon/opendistroforelasticsearch/ad/util/ColdStartRunner.java\n\n@@ -82,8 +82,9 @@ public class ColdStartRunner {\n     public Optional<AnomalyDetectionException> fetchException(String adID) {\n         checkResult();\n \n-        if (currentExceptions.containsKey(adID)) {\n-            LOG.info(\"Found a matching exception for {}\", adID);\n+        AnomalyDetectionException ex = currentExceptions.get(adID);\n+        if (ex != null) {\n+            LOG.error(\"Found a matching exception for \" + adID, ex);\n             return Optional.of(currentExceptions.remove(adID));\n         } else {\n             LOG.info(\"Cannot find a matching exception for {}\", adID);\n"}}, {"oid": "cf4889211d1af15459f187c7ce0d9dfc1700b545", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/cf4889211d1af15459f187c7ce0d9dfc1700b545", "message": "Fix that AD job cannot be terminated due to missing training data\n\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\n\nTesting done:\n1. Manually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\n2. Added unit tests to expose the bug.", "committedDate": "2020-05-04T21:55:36Z", "type": "commit"}, {"oid": "cf4889211d1af15459f187c7ce0d9dfc1700b545", "url": "https://github.com/opendistro-for-elasticsearch/anomaly-detection/commit/cf4889211d1af15459f187c7ce0d9dfc1700b545", "message": "Fix that AD job cannot be terminated due to missing training data\n\nWe expect an EndRunException to be thrown due to missing training data.  But the exception is not appropriately propagated back to AD job and results in InternalFailure instead.  This PR fixes the bug.\n\nTesting done:\n1. Manually reproduced all  possible EndRunExceptions, check AD job is terminated, and check profile API status is correct.\n2. Added unit tests to expose the bug.", "committedDate": "2020-05-04T21:55:36Z", "type": "forcePushed"}]}