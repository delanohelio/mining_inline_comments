{"pr_number": 732, "pr_title": "hierarchical clustering arrayindexoutofbounds fix", "pr_createdAt": "2020-07-20T23:21:13Z", "pr_url": "https://github.com/constellation-app/constellation/pull/732", "timeline": [{"oid": "7a8d45aa96d50d54bd6bac062f4ca3e1f152eb1c", "url": "https://github.com/constellation-app/constellation/commit/7a8d45aa96d50d54bd6bac062f4ca3e1f152eb1c", "message": ":bug: defensive loop iterator value", "committedDate": "2020-07-20T23:17:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r457825131", "bodyText": "The vertexCount is being used to retrieve vertex ids, so setting it to the number of clusters feels wrong, and like it could be error prone. What was you reasoning behind this?", "author": "cygnus-x-1", "createdAt": "2020-07-21T04:12:48Z", "path": "CoreAlgorithmPlugins/src/au/gov/asd/tac/constellation/plugins/algorithms/clustering/hierarchical/HierarchicalControllerTopComponent.java", "diffHunk": "@@ -719,8 +719,10 @@ public void edit(final GraphWriteMethods graph, final PluginInteraction interact\n             final int transactionVisibilityAttribute = VisualConcept.TransactionAttribute.VISIBILITY.ensure(graph);\n \n             int nextCluster = 0;\n+            // Use the smaller of ints as to avoid going out of bounds.\n+            // usually caused when cluster has not run with new elements added.\n+            final int vertexCount = Math.min(graph.getVertexCount(), state.getCurrentNumOfClusters());", "originalCommit": "7a8d45aa96d50d54bd6bac062f4ca3e1f152eb1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgzMDIxMg==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r457830212", "bodyText": "@cygnus-x-1  So it grabs the group based on the current vertex position it iterates on. My thoughts based on this is that you never want it to grab a group by an iterator that is larger than the total number of groups. This happens when you cluster it once, then add elements to the graph. When you switch off interactive mode it iterates all nodes which were effected in the last cluster so it can revert the changes. Just writing this now it seems like there may be a possibility that it iterates the vertices, but does so under the assumption that the first x elements are the same as the ones which were clustered. I did not notice any issues with testing under normal circumstances.\nMaking it the minimum of both makes it avoid checking the groups that does not exist, but still effectively returns the state to normal in the vertices that were effected under \"interactive mode\"\nDoes this sound logical, or do you suggest revisiting it. I didn't want to just re-cluster the graph in case it messed with the behaviour a user would want to target.", "author": "aldebaran30701", "createdAt": "2020-07-21T04:33:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgxNDUzNw==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r459814537", "bodyText": "If I understand correctly, the underlying issue is that a graph could be updated (nodes added, removed, etc) which renders the clustering result invalid. If this is the case I feel like the clustering result should either be removed (forcing the user to re-cluster) or automatically updated (could have an impact on performance). @arcturus2, @sirius-1 what do you think?", "author": "cygnus-x-1", "createdAt": "2020-07-24T01:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgyMDY5Nw==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r459820697", "bodyText": "You do understand correctly. Keen to hear their thoughts. \ud83d\udc4d", "author": "aldebaran30701", "createdAt": "2020-07-24T02:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1OTE4MQ==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r460059181", "bodyText": "If the cluster is considered invalid then I would prefer we force the user to re-cluster by updating the GUI to look like it wasn't clustered. Perhaps a label somewhere in red which says something like \"You need to re-cluster because the graph has changed\" would be a nice UX touch.\n@cygnus-x-1 given our view of Constellation is to not do \"black magic\" (i.e. doing things behind the scenes without the user knowing), automatically updating the cluster I think would be going down this path. Would you agree?\nAlso if automatically updating clusters as the graph changes could be a performance hit then that's a turn off for me personally.", "author": "arcturus2", "createdAt": "2020-07-24T13:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMxMTUzNA==", "url": "https://github.com/constellation-app/constellation/pull/732#discussion_r461311534", "bodyText": "While I agree with the \"no black magic\" principle, in this case the user had asked for the clustering to be done so i wouldn't have an issue with the view keeping that in sync with the graph.", "author": "cygnus-x-1", "createdAt": "2020-07-28T04:32:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNTEzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4127cc30ab3abda2052dfbc06f6b9295ff25e4e9", "chunk": "diff --git a/CoreAlgorithmPlugins/src/au/gov/asd/tac/constellation/plugins/algorithms/clustering/hierarchical/HierarchicalControllerTopComponent.java b/CoreAlgorithmPlugins/src/au/gov/asd/tac/constellation/plugins/algorithms/clustering/hierarchical/HierarchicalControllerTopComponent.java\nindex 3109abe4e..0b1d6ac45 100644\n--- a/CoreAlgorithmPlugins/src/au/gov/asd/tac/constellation/plugins/algorithms/clustering/hierarchical/HierarchicalControllerTopComponent.java\n+++ b/CoreAlgorithmPlugins/src/au/gov/asd/tac/constellation/plugins/algorithms/clustering/hierarchical/HierarchicalControllerTopComponent.java\n\n@@ -719,10 +729,7 @@ public final class HierarchicalControllerTopComponent extends TopComponent imple\n             final int transactionVisibilityAttribute = VisualConcept.TransactionAttribute.VISIBILITY.ensure(graph);\n \n             int nextCluster = 0;\n-            // Use the smaller of ints as to avoid going out of bounds.\n-            // usually caused when cluster has not run with new elements added.\n-            final int vertexCount = Math.min(graph.getVertexCount(), state.getCurrentNumOfClusters());\n-\n+            final int vertexCount = graph.getVertexCount();\n             for (int pos = 0; pos < vertexCount; pos++) {\n                 final int vertex = graph.getVertex(pos);\n                 Group group = state.groups[pos];\n"}}, {"oid": "4127cc30ab3abda2052dfbc06f6b9295ff25e4e9", "url": "https://github.com/constellation-app/constellation/commit/4127cc30ab3abda2052dfbc06f6b9295ff25e4e9", "message": ":bug: disable interactive button on graph update", "committedDate": "2020-07-28T23:40:29Z", "type": "commit"}, {"oid": "cef42b4211c1aa4b5e0b1c87eff12ab7335c2953", "url": "https://github.com/constellation-app/constellation/commit/cef42b4211c1aa4b5e0b1c87eff12ab7335c2953", "message": "Merge branch 'master' into bugfix/hierarchical-clustering", "committedDate": "2020-07-28T23:40:55Z", "type": "commit"}, {"oid": "f416d3141b7dc40dd0edb48ed1348a02fced7e38", "url": "https://github.com/constellation-app/constellation/commit/f416d3141b7dc40dd0edb48ed1348a02fced7e38", "message": "add descriptive label for clustering", "committedDate": "2020-07-29T01:04:55Z", "type": "commit"}]}