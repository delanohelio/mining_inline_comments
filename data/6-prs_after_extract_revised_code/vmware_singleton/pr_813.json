{"pr_number": 813, "pr_title": "Fix for bug 812 G11n-java-client New workflow's Translation.getMessage must be able to use latest source messages from VIP service", "pr_createdAt": "2020-10-02T22:35:37Z", "pr_url": "https://github.com/vmware/singleton/pull/813", "timeline": [{"oid": "daa6b13b09cfe7747e3fbdf89760cc83e17b61cd", "url": "https://github.com/vmware/singleton/commit/daa6b13b09cfe7747e3fbdf89760cc83e17b61cd", "message": "Fix for bug 812 G11n-java-client New workflow's Translation.getMessage must be able to fallback to \"latest\" messages from VIP service if messages_source.json is not present locally(offline) in the client", "committedDate": "2020-10-02T22:34:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0NzI5Mw==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r499147293", "bodyText": "If getting latest feom service successfully, is it still necessary to get from local?", "author": "Xiaochao8", "createdAt": "2020-10-03T13:18:44Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -54,18 +54,24 @@ private void refreshCacheItem(final MessageCacheItem cacheItem, Iterator<DataSou\n \n \t\tlong timestampOld = cacheItem.getTimestamp();\n \t\tDataSourceEnum dataSource = msgSourceQueueIter.next();\n+\t\tString localeOrig = dto.getLocale();\n+\t\tif (dataSource.equals(DataSourceEnum.VIP) && dto.getLocale().equals(\"source\")) {\n+\t\t\tdto.setLocale(\"latest\");\n+\t\t}\n \t\tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n \t\tlong timestamp = cacheItem.getTimestamp();\n \t\tif (timestampOld == timestamp) {\n \t\t\tlogger.debug(FormatUtils.format(ConstantsMsg.GET_MESSAGES_FAILED, dto.getComponent(), dto.getLocale(), dataSource.toString()));\n \t\t}\n+\t\tdto.setLocale(localeOrig);\n \n-\t\t// If timestamp is not 0, it means that cacheItem is in the cache already.\n-\t\t// Otherwise, try the next dataSource in the queue.\n-\t\tif (timestamp == 0) {\n+\t\t// If timestamp is 0, it means that cacheItem not yet in cache. So try the next data source.\n+\t\t// If locale is \"source\", use messages from DatasourceEnum.Bundle data store if it exists.\n+\t\tif (timestamp == 0 || dto.getLocale().equals(\"source\")) {", "originalCommit": "daa6b13b09cfe7747e3fbdf89760cc83e17b61cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE4NDgyOA==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r499184828", "bodyText": "I am not so sure, actually. Is there a use case where a string has been updated only in local and not yet in remote? If yes, should the client use the local message or wait until message in service is updated?", "author": "jessiejuachon", "createdAt": "2020-10-03T21:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0NzI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE5NzUzNw==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r499197537", "bodyText": "If you think locale take priority over remote, then you should get from local first, then remote. Don't need to get from service first then get from local.", "author": "Xiaochao8", "createdAt": "2020-10-04T02:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0NzI5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg0NTk4Mg==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r499845982", "bodyText": "I have studied existing use cases and official g11n testing happens with remote (VIP service) messages. As a conclusion, we will keep the behavior consistent with the behavior for all locales: Pull from remote(priority) when remote is available, from local only if remote is not available/not supported. I'll remove the change from line 70.", "author": "jessiejuachon", "createdAt": "2020-10-05T20:14:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTE0NzI5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "bc6c88ad9ebd8040e0cc892fb3265187dd0ae292", "chunk": "diff --git a/src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java b/src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java\nindex 7c3256f7..6e3287d8 100644\n--- a/src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java\n+++ b/src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java\n\n@@ -55,8 +55,8 @@ public class ComponentService {\n \t\tlong timestampOld = cacheItem.getTimestamp();\n \t\tDataSourceEnum dataSource = msgSourceQueueIter.next();\n \t\tString localeOrig = dto.getLocale();\n-\t\tif (dataSource.equals(DataSourceEnum.VIP) && dto.getLocale().equals(\"source\")) {\n-\t\t\tdto.setLocale(\"latest\");\n+\t\tif (dataSource.equals(DataSourceEnum.VIP) && dto.getLocale().equals(ConstantsKeys.SOURCE)) {\n+\t\t\tdto.setLocale(ConstantsKeys.LATEST);\n \t\t}\n \t\tdataSource.createMessageOpt(dto).getComponentMessages(cacheItem);\n \t\tlong timestamp = cacheItem.getTimestamp();\n"}}, {"oid": "bc6c88ad9ebd8040e0cc892fb3265187dd0ae292", "url": "https://github.com/vmware/singleton/commit/bc6c88ad9ebd8040e0cc892fb3265187dd0ae292", "message": "code clean up", "committedDate": "2020-10-03T21:50:52Z", "type": "commit"}, {"oid": "9dc086d0c923729f53c4d91bc75062ee5908cebf", "url": "https://github.com/vmware/singleton/commit/9dc086d0c923729f53c4d91bc75062ee5908cebf", "message": "Making the fallback behavior for \"source\" consistent with all locales (i.e. service first then local)", "committedDate": "2020-10-05T20:15:50Z", "type": "commit"}, {"oid": "2bf3d5367b6619935963275eddadd5dd2c8931ae", "url": "https://github.com/vmware/singleton/commit/2bf3d5367b6619935963275eddadd5dd2c8931ae", "message": "Fixing a typo error", "committedDate": "2020-10-05T21:07:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyMzQ2Ng==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r503623466", "bodyText": "Is it better unify the message file suffix in Singleton service and local bundle either to 'latest' or to 'source', then add the unified suffix to the fallback queue, in this case you needn't judge the data source and the requested locale here.", "author": "huihuiw01", "createdAt": "2020-10-13T01:57:40Z", "path": "src/main/java/com/vmware/vipclient/i18n/messages/service/ComponentService.java", "diffHunk": "@@ -54,18 +54,23 @@ private void refreshCacheItem(final MessageCacheItem cacheItem, Iterator<DataSou\n \n \t\tlong timestampOld = cacheItem.getTimestamp();\n \t\tDataSourceEnum dataSource = msgSourceQueueIter.next();\n+\t\tString localeOrig = dto.getLocale();\n+\t\tif (dataSource.equals(DataSourceEnum.VIP) && dto.getLocale().equals(ConstantsKeys.SOURCE)) {", "originalCommit": "2bf3d5367b6619935963275eddadd5dd2c8931ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEyNzQ1Nw==", "url": "https://github.com/vmware/singleton/pull/813#discussion_r504127457", "bodyText": "Yes, we will do that later on. We shall officially use \"source\" in the service (new version). Then in the client libraries, we have to support both versions of VIP service (old version with \"latest\" for backwards compatibility, and new version with \"source\").\nIn the meantime, for compatibility with current VIP service, we have to add this line.", "author": "jessiejuachon", "createdAt": "2020-10-13T17:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYyMzQ2Ng=="}], "type": "inlineReview", "revised_code": null}]}