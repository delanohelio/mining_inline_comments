{"pr_number": 2158, "pr_title": "EBP: Updates to legacy.scss do not show up properly until theme changes happen", "pr_createdAt": "2020-08-10T05:45:30Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2158", "timeline": [{"oid": "649ddf61eefb0cd3c5990bbcce0b7fbdd481ba2f", "url": "https://github.com/openequella/openEQUELLA/commit/649ddf61eefb0cd3c5990bbcce0b7fbdd481ba2f", "message": "Use an URLConnection to get the last modified date\n\nAs opposed to creating a new File() directly with a .getResource\ncall - as this fails when legacy.scss is in a jar.", "committedDate": "2020-08-10T05:39:57Z", "type": "commit"}, {"oid": "6f87bfa24d6e325ddf1771ff14e87d93ce422fe3", "url": "https://github.com/openequella/openEQUELLA/commit/6f87bfa24d6e325ddf1771ff14e87d93ce422fe3", "message": "Run Java formatter", "committedDate": "2020-08-10T06:15:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNzkzNQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2158#discussion_r467707935", "bodyText": "The logic for this used to be:\n\n!legacyCssExists OR baseSassUpdated\n\nNow it's:\n\nlegacyCssExists AND baseSassUpdated\n\nI believe that means on the first run of a fresh system, this will not get generated.", "author": "edalex-ian", "createdAt": "2020-08-10T06:27:52Z", "path": "Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java", "diffHunk": "@@ -165,16 +166,22 @@ private String themeToJSONString(NewUITheme theme) throws JsonProcessingExceptio\n   }\n \n   public InputStream getLegacyCss() throws IOException {\n-    File baseLegacySass =\n-        new File(getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).getFile());\n     CustomisationFile customisationFile = new CustomisationFile();\n-    boolean legacyCssExists = fileSystemService.fileExists(customisationFile, LEGACY_CSS_FILENAME);\n-    boolean baseSassUpdated =\n-        baseLegacySass.lastModified()\n-            > fileSystemService.lastModified(customisationFile, LEGACY_CSS_FILENAME);\n \n-    if (!legacyCssExists || baseSassUpdated) {\n-      compileSass();\n+    // get last modified date of the scss file\n+    URLConnection conn =\n+        getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).openConnection();\n+    long lastMod = conn.getLastModified();\n+    conn.getInputStream().close();\n+\n+    // compare against the modified date of the css file if it exists\n+    boolean legacyCssExists = fileSystemService.fileExists(customisationFile, LEGACY_CSS_FILENAME);\n+    if (legacyCssExists) {\n+      long cssLastMod = fileSystemService.lastModified(customisationFile, LEGACY_CSS_FILENAME);\n+      boolean baseSassUpdated = lastMod > cssLastMod;\n+      if (baseSassUpdated) {\n+        compileSass();", "originalCommit": "6f87bfa24d6e325ddf1771ff14e87d93ce422fe3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcxNzk0NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2158#discussion_r467717944", "bodyText": "Gah! Yup, I forgot the else for the initial legacyCssExists check. Sorry about that.", "author": "SammyIsConfused", "createdAt": "2020-08-10T06:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcwNzkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "52990a3584c5ee8a391e230c4bdbe643187007f6", "chunk": "diff --git a/Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java b/Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java\nindex df7db37aa..40b1f62e7 100644\n--- a/Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java\n+++ b/Source/Plugins/Core/com.equella.core/src/com/tle/core/settings/service/impl/ThemeSettingsServiceImpl.java\n\n@@ -167,22 +167,30 @@ public class ThemeSettingsServiceImpl implements ThemeSettingsService {\n \n   public InputStream getLegacyCss() throws IOException {\n     CustomisationFile customisationFile = new CustomisationFile();\n-\n-    // get last modified date of the scss file\n-    URLConnection conn =\n-        getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).openConnection();\n-    long lastMod = conn.getLastModified();\n-    conn.getInputStream().close();\n+    boolean needsUpdate = false;\n \n     // compare against the modified date of the css file if it exists\n     boolean legacyCssExists = fileSystemService.fileExists(customisationFile, LEGACY_CSS_FILENAME);\n     if (legacyCssExists) {\n+      // get last modified date of the scss file\n+      URLConnection conn =\n+          getClass().getResource(\"/web/sass/\" + SASS_LEGACY_CSS_FILENAME).openConnection();\n+      long lastMod = conn.getLastModified();\n+      conn.getInputStream().close();\n+\n+      // get last modified of the compiled css file\n       long cssLastMod = fileSystemService.lastModified(customisationFile, LEGACY_CSS_FILENAME);\n-      boolean baseSassUpdated = lastMod > cssLastMod;\n-      if (baseSassUpdated) {\n-        compileSass();\n+      if (lastMod > cssLastMod) {\n+        needsUpdate = true;\n       }\n+    } else {\n+      needsUpdate = true;\n     }\n+\n+    if (needsUpdate) {\n+      compileSass();\n+    }\n+\n     return fileSystemService.read(customisationFile, LEGACY_CSS_FILENAME);\n   }\n \n"}}, {"oid": "52990a3584c5ee8a391e230c4bdbe643187007f6", "url": "https://github.com/openequella/openEQUELLA/commit/52990a3584c5ee8a391e230c4bdbe643187007f6", "message": "Fix logic to handle case in which compiled css file does not exist", "committedDate": "2020-08-10T06:52:16Z", "type": "commit"}]}