{"pr_number": 1416, "pr_title": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values", "pr_createdAt": "2020-08-14T00:05:49Z", "pr_url": "https://github.com/apache/samza/pull/1416", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDMzMjIwMw==", "url": "https://github.com/apache/samza/pull/1416#discussion_r470332203", "bodyText": "Looks like this line is unnecessary? The \"values\" variable is never being used.", "author": "xiefan46", "createdAt": "2020-08-14T00:33:19Z", "path": "samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java", "diffHunk": "@@ -53,6 +53,8 @@ public SamzaHistogram(MetricsRegistry registry, String group, String name, List<\n \n   public void update(long value) {\n     histogram.update(value);\n+    Snapshot values = histogram.getSnapshot();", "originalCommit": "4de45c65896ea44c567163399a43a7032feda8e5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f4d5d982e84108e611949fa8df910952ac6c3304", "chunk": "diff --git a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\nindex 53dae891..e1e664f8 100644\n--- a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n+++ b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n\n@@ -53,7 +53,6 @@ public class SamzaHistogram {\n \n   public void update(long value) {\n     histogram.update(value);\n-    Snapshot values = histogram.getSnapshot();\n     percentiles.forEach(x -> updateGaugeValues(x));\n   }\n \n"}}, {"oid": "f4d5d982e84108e611949fa8df910952ac6c3304", "url": "https://github.com/apache/samza/commit/f4d5d982e84108e611949fa8df910952ac6c3304", "message": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values\n\nSymptom: Missing metrics. EventSystemConsumer consumer lag latency\nmetrics are missing.\n\nCause: Histogram update and percentile gauges are updated in two\ndifferent functions. Percentiles are internal to Samza histogram and\nhence should be updated internally as part of update.\n\nChanges: Histogram update also updates internal gauges.", "committedDate": "2020-08-14T00:42:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0NjM1Ng==", "url": "https://github.com/apache/samza/pull/1416#discussion_r470346356", "bodyText": "Looks like the gauge value is already updated when it is reported (line 76 Gauge#visit). Why do we need to update them on every new datapoint?", "author": "prateekm", "createdAt": "2020-08-14T00:55:07Z", "path": "samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java", "diffHunk": "@@ -53,6 +53,7 @@ public SamzaHistogram(MetricsRegistry registry, String group, String name, List<\n \n   public void update(long value) {\n     histogram.update(value);\n+    percentiles.forEach(x -> updateGaugeValues(x));", "originalCommit": "f4d5d982e84108e611949fa8df910952ac6c3304", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0OTc1Nw==", "url": "https://github.com/apache/samza/pull/1416#discussion_r470349757", "bodyText": "good point. @prateekm is it possible that this is never called? We are seeing the values a 0, so I assumed this could be the issue.", "author": "vishwajith-s", "createdAt": "2020-08-14T01:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0NjM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1NTI2NQ==", "url": "https://github.com/apache/samza/pull/1416#discussion_r470355265", "bodyText": "Also by the way this code is being called from Brooklin code in Brooklin cluster. Not sure if the visit is called", "author": "vishwajith-s", "createdAt": "2020-08-14T01:08:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0NjM1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MjA5OQ==", "url": "https://github.com/apache/samza/pull/1416#discussion_r471562099", "bodyText": "@prateekm as discussed doing it in the getValue of the Histogram.", "author": "vishwajith-s", "createdAt": "2020-08-17T15:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0NjM1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5fa559e01db7c116f73ee2e428e2a8aaf6d61756", "chunk": "diff --git a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\nindex e1e664f8..da53a488 100644\n--- a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n+++ b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n\n@@ -53,7 +53,6 @@ public class SamzaHistogram {\n \n   public void update(long value) {\n     histogram.update(value);\n-    percentiles.forEach(x -> updateGaugeValues(x));\n   }\n \n   public void updateGaugeValues(double percentile) {\n"}}, {"oid": "5fa559e01db7c116f73ee2e428e2a8aaf6d61756", "url": "https://github.com/apache/samza/commit/5fa559e01db7c116f73ee2e428e2a8aaf6d61756", "message": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values\n\nSymptom: Missing metrics. EventSystemConsumer consumer lag latency\nmetrics are missing.\n\nCause: Histogram update and percentile gauges are updated in two\ndifferent functions. Percentiles are internal to Samza histogram and\nhence should be updated internally as part of update.\n\nChanges: Histogram update also updates internal gauges.", "committedDate": "2020-08-17T15:30:07Z", "type": "forcePushed"}, {"oid": "012e404226baf5c6099ff109e9cef886dc7cc019", "url": "https://github.com/apache/samza/commit/012e404226baf5c6099ff109e9cef886dc7cc019", "message": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values\n\nSymptom: Missing metrics. EventSystemConsumer consumer lag latency\nmetrics are missing.\n\nCause: Histogram update and percentile gauges are updated in two\ndifferent functions. Percentiles are internal to Samza histogram and\nhence should be updated internally as part of update.\n\nChanges: Histogram update also updates internal gauges.", "committedDate": "2020-08-17T18:15:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcwMTc4MA==", "url": "https://github.com/apache/samza/pull/1416#discussion_r471701780", "bodyText": "Should this be removed from here if this is already being updated in getValue?", "author": "prateekm", "createdAt": "2020-08-17T18:41:21Z", "path": "samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java", "diffHunk": "@@ -75,5 +75,15 @@ public void visit(MetricsVisitor visitor) {\n       updateGaugeValues(percentile);", "originalCommit": "012e404226baf5c6099ff109e9cef886dc7cc019", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f735773e681933f9ee657eccf4db3fdb2f77b084", "chunk": "diff --git a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\nindex 06ed4894..38cf0fb0 100644\n--- a/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n+++ b/samza-api/src/main/java/org/apache/samza/metrics/SamzaHistogram.java\n\n@@ -72,7 +72,6 @@ public class SamzaHistogram {\n     }\n \n     public void visit(MetricsVisitor visitor) {\n-      updateGaugeValues(percentile);\n       visitor.gauge(this);\n     }\n \n"}}, {"oid": "f735773e681933f9ee657eccf4db3fdb2f77b084", "url": "https://github.com/apache/samza/commit/f735773e681933f9ee657eccf4db3fdb2f77b084", "message": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values\n\nSymptom: Missing metrics. EventSystemConsumer consumer lag latency\nmetrics are missing.\n\nCause: Histogram update and percentile gauges are updated in two\ndifferent functions. Percentiles are internal to Samza histogram and\nhence should be updated internally as part of update.\n\nChanges: Histogram update also updates internal gauges.", "committedDate": "2020-08-17T19:08:18Z", "type": "commit"}, {"oid": "f735773e681933f9ee657eccf4db3fdb2f77b084", "url": "https://github.com/apache/samza/commit/f735773e681933f9ee657eccf4db3fdb2f77b084", "message": "SAMZA-2581: Fix Samza Histogram update to update percentile Gauge values\n\nSymptom: Missing metrics. EventSystemConsumer consumer lag latency\nmetrics are missing.\n\nCause: Histogram update and percentile gauges are updated in two\ndifferent functions. Percentiles are internal to Samza histogram and\nhence should be updated internally as part of update.\n\nChanges: Histogram update also updates internal gauges.", "committedDate": "2020-08-17T19:08:18Z", "type": "forcePushed"}]}