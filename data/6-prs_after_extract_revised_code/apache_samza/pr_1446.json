{"pr_number": 1446, "pr_title": "SAMZA-2605: Make Standby Container Requests Rack Aware ", "pr_createdAt": "2020-11-20T20:58:32Z", "pr_url": "https://github.com/apache/samza/pull/1446", "timeline": [{"oid": "2ca8446cc4b96b4e793aa15b0351b991c5938136", "url": "https://github.com/apache/samza/commit/2ca8446cc4b96b4e793aa15b0351b991c5938136", "message": "First draft", "committedDate": "2020-11-20T05:56:56Z", "type": "commit"}, {"oid": "b11e5bed02f1f1f9949d58d4cc243bdc18330562", "url": "https://github.com/apache/samza/commit/b11e5bed02f1f1f9949d58d4cc243bdc18330562", "message": "First draft", "committedDate": "2020-11-20T20:50:43Z", "type": "commit"}, {"oid": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "url": "https://github.com/apache/samza/commit/addaf742fda1c27ece5efbf23ccda5d68fc376f9", "message": "Restructuring code", "committedDate": "2020-12-04T04:07:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA3ODk2Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r530078966", "bodyText": "minor: prefer \"host\" to \"node\" as rest of samza (non-yarn specific) code uses host", "author": "lakshmi-manasa-g", "createdAt": "2020-11-25T03:07:30Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java", "diffHunk": "@@ -87,6 +88,12 @@ public ClusterResourceManager(Callback callback) {\n    */\n   public abstract void requestResources(SamzaResourceRequest resourceRequest);\n \n+  /**\n+   * Get the node to fault domain map from the cluster resource manager.\n+   * @return A map of the nodes to the fault domain they reside in.\n+   */\n+  public abstract Map<String, String> getNodeToFaultDomainMap();", "originalCommit": "b11e5bed02f1f1f9949d58d4cc243bdc18330562", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java\nindex 5b4b7ad5a..43b3d36ef 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterResourceManager.java\n\n@@ -88,12 +87,6 @@ public abstract class ClusterResourceManager {\n    */\n   public abstract void requestResources(SamzaResourceRequest resourceRequest);\n \n-  /**\n-   * Get the node to fault domain map from the cluster resource manager.\n-   * @return A map of the nodes to the fault domain they reside in.\n-   */\n-  public abstract Map<String, String> getNodeToFaultDomainMap();\n-\n   /***\n    * Remove a previously submitted resource request. The previous resource request may\n    * have been submitted to the cluster manager. Even after the remove request, a ContainerProcessManagerCallback\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMTExNg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536411116", "bodyText": "can faultDomainManager be null?\nif not, maybe a check for notNull?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:05:54Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java", "diffHunk": "@@ -88,7 +88,7 @@\n \n   public ContainerManager(ContainerPlacementMetadataStore containerPlacementMetadataStore,\n       SamzaApplicationState samzaApplicationState, ClusterResourceManager clusterResourceManager,\n-      boolean hostAffinityEnabled, boolean standByEnabled, LocalityManager localityManager) {\n+      FaultDomainManager faultDomainManager, boolean hostAffinityEnabled, boolean standByEnabled, LocalityManager localityManager) {", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java\nindex e9f7ef555..751ee4fd7 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerManager.java\n\n@@ -90,6 +90,7 @@ public class ContainerManager {\n       SamzaApplicationState samzaApplicationState, ClusterResourceManager clusterResourceManager,\n       FaultDomainManager faultDomainManager, boolean hostAffinityEnabled, boolean standByEnabled, LocalityManager localityManager) {\n     Preconditions.checkNotNull(localityManager, \"Locality manager cannot be null\");\n+    Preconditions.checkNotNull(faultDomainManager, \"Fault domain manager cannot be null\");\n     this.samzaApplicationState = samzaApplicationState;\n     this.clusterResourceManager = clusterResourceManager;\n     this.actions = new ConcurrentHashMap<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNDA0NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536414044", "bodyText": "minor: interface here is a bit confusing.. no strong objection if you prefer to keep it", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:12:15Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java", "diffHunk": "@@ -114,6 +114,11 @@\n    */\n   private final ClusterResourceManager clusterResourceManager;\n \n+  /**\n+   * An interface to get information about nodes and the fault domains they reside on.", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\nindex 2fd55746b..305e72093 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n\n@@ -114,11 +114,6 @@ public class ContainerProcessManager implements ClusterResourceManager.Callback\n    */\n   private final ClusterResourceManager clusterResourceManager;\n \n-  /**\n-   * An interface to get information about nodes and the fault domains they reside on.\n-   */\n-  private final FaultDomainManager faultDomainManager;\n-\n   /**\n    * If there are more than job.container.retry.count failures of a container within a job.container.retry.window period,\n    * then the ContainerProcessManager will indicate to the ClusterBasedJobCoordinator that the job should shutdown.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNjQ5MA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536416490", "bodyText": "these seem to be final.. if they are not expected to change, maybe mark them so", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:17:44Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+public class FaultDomain {\n+\n+  FaultDomainType type;\n+  String id;", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\nindex 701b0d97a..dbfece8c8 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n\n@@ -18,12 +18,24 @@\n  */\n package org.apache.samza.clustermanager;\n \n+import org.apache.samza.SamzaException;\n+\n+/**\n+ * A fault domain is a set of hardware components that share a single point of failure.\n+ * This class identifies the type (ex: rack) and ID (ex: rack ID) of the fault domain in question.\n+ * A host can belong to multiple fault domains.\n+ * A fault domain may have greater than or equal to 1 hosts.\n+ * A cluster can comprise of hosts on multiple fault domains.\n+ */\n public class FaultDomain {\n \n-  FaultDomainType type;\n-  String id;\n+  private final FaultDomainType type;\n+  private final String id;\n \n   public FaultDomain(FaultDomainType type, String id) {\n+    if (type == null || id == null) {\n+      throw new SamzaException(\"Fault domain type and ID cannot be null.\");\n+    }\n     this.type = type;\n     this.id = id;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNjY2Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536416663", "bodyText": "can they be null?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:18:07Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+public class FaultDomain {\n+\n+  FaultDomainType type;\n+  String id;\n+\n+  public FaultDomain(FaultDomainType type, String id) {\n+    this.type = type;\n+    this.id = id;", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1NDgyMw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538854823", "bodyText": "No. I've added a check for the same. Thanks!", "author": "PawasChhokra", "createdAt": "2020-12-08T22:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNjY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\nindex 701b0d97a..dbfece8c8 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n\n@@ -18,12 +18,24 @@\n  */\n package org.apache.samza.clustermanager;\n \n+import org.apache.samza.SamzaException;\n+\n+/**\n+ * A fault domain is a set of hardware components that share a single point of failure.\n+ * This class identifies the type (ex: rack) and ID (ex: rack ID) of the fault domain in question.\n+ * A host can belong to multiple fault domains.\n+ * A fault domain may have greater than or equal to 1 hosts.\n+ * A cluster can comprise of hosts on multiple fault domains.\n+ */\n public class FaultDomain {\n \n-  FaultDomainType type;\n-  String id;\n+  private final FaultDomainType type;\n+  private final String id;\n \n   public FaultDomain(FaultDomainType type, String id) {\n+    if (type == null || id == null) {\n+      throw new SamzaException(\"Fault domain type and ID cannot be null.\");\n+    }\n     this.type = type;\n     this.id = id;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzg1Mg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536417852", "bodyText": "since its a new interface, should we mark it evolving?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:20:54Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxODQzOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539518439", "bodyText": "I've marked it as unstable as of now. Will change it to evolving after more thorough testing.", "author": "PawasChhokra", "createdAt": "2020-12-09T17:48:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNzg1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTEzNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536421137", "bodyText": "can you add a few lines about thread-safety, what an implementor of this interface should guarantee/adhere to, what a user should expect and how to use?\nlooks like all supported functions are read-only kind.. as in the they are all getter/check and no writes (setter) so maybe thread-safety might not be a big concern. But still worth checking it and calling it out.\nI am wondering, cluster is a dynamic system - hosts/domains might change and then this manager's internal state is somehow updated by the implementor (?). In such as case, what is the guarantee provided by this manager - will it always show the state of the cluster right now or the last read from cluster manager or maybe some other guarantees like if a host/domain is down in the cluster then it will definitely not be part of the get-method-return-value.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:28:29Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxNDg3NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539514875", "bodyText": "I've explicitly called out that this is not thread safe, however it does not need to be. I have also added in the interface documentation that the host to fault domain map is cached and explained under what scenarios it will be updated. Therefore, to answer your question, the manager will not show the current state of the cluster. It will just show the cached state on the basis of the last time it retrieved that information. I have also added information stating that it will store information of only the nodes that are running in the cluster at that point in time.", "author": "PawasChhokra", "createdAt": "2020-12-09T17:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTEzNw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTQ3Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536421477", "bodyText": "using it for standby container is one of the uses -- i feel we should not put this in the interface doc.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:29:16Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUxNzUyOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539517529", "bodyText": "Makes sense.  Added the standby part as a possible example instead.", "author": "PawasChhokra", "createdAt": "2020-12-09T17:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMTQ3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMjk0MA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536422940", "bodyText": "how do we define RUNNING nodes? nodes where containers of  this job are running or Nodes that are healthy in the cluster or nodes with available resources to run container..\n\n\ndoes it get all domains of the cluster or only those that a job can access?\n\n\nnit: hosts instead of nodes.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:32:44Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTUyNTM3OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539525379", "bodyText": "Yarn defines running nodes as the nodes that are healthy and up and running in the cluster. I've clarified that bit here.\nIt gets all the fault domain values in the cluster that were last cached by the FaultDomainManager.\nChanged everything to hosts. :)", "author": "PawasChhokra", "createdAt": "2020-12-09T17:58:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMjk0MA=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMzIwNA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536423204", "bodyText": "would be nice to stick to one of the two - host or node - just to keep it consistent :)", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:33:28Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4MjY3MA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538882670", "bodyText": "+1 use consistent terminologies.", "author": "mynameborat", "createdAt": "2020-12-08T23:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyMzIwNA=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyOTY5NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536429694", "bodyText": "fault domain is a concept that maybe worth spending a couple of lines over -- like a host can only belong to one domain, domain has >=1 hosts, cluster has all its hosts in one domain or another", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:49:31Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same fault domain.", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2MjM2OA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539862368", "bodyText": "Added this info in the FaultDomain class.", "author": "PawasChhokra", "createdAt": "2020-12-10T05:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQyOTY5NA=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzMjYyMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536432621", "bodyText": "hmm, i think this manager is designed specifically for standby containers only. I feel this interface has potential beyond standbys and hence we should strive to keep it generic - usable for scheduling actives also maybe?\nwhat is the guarantee manager provides to the user of this method - like for rack upgrades we would want it to be any domain not about to undergo maintenance or currently under maintenance, there are others like this too\nactually, adding to #2 above: maybe we should be able to define a \"rule set\" the domain manager follows to fetch allowed domains. rules could include stuff like not on a particular host/domain (then this method becomes  extensible beyond standby)...wdyt?\nnit: if sticking to standby-only use case, indicate in the name as getAllowedFaultDomainsForSchedulingStandbyContainer", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T22:56:48Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same fault domain.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same fault domain\n+   */\n+  boolean checkHostsOnSameFaultDomain(String host1, String host2);\n+\n+  /**\n+   * This method gets the set of fault domains that the given active container's corresponding standby can be placed on.\n+   * @param host The hostname of the active container\n+   * @return the set of fault domains on which this active container's standby can be scheduled", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2NjUwNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539866505", "bodyText": "The purpose of this method is to find a list of fault domains that the host's (which is meant to be the active container) standby can be placed on. What are you suggesting to change it to in this case, since the function is active and standby container specific?\nAny rack about to undergo maintenance will be marked unhealthy. Hence, even if we have that rack in our local cache, Yarn will not return a host to us on an unhealthy rack.\nCaught up with Manasa and leaving this aside for now.\nDone.", "author": "PawasChhokra", "createdAt": "2020-12-10T05:59:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzMjYyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNjI3Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536436273", "bodyText": "it may not be cached also right.. depending on the implementation.\nthis is where the guarantee of view of the cluster comes into play.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:06:50Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same fault domain.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same fault domain\n+   */\n+  boolean checkHostsOnSameFaultDomain(String host1, String host2);\n+\n+  /**\n+   * This method gets the set of fault domains that the given active container's corresponding standby can be placed on.\n+   * @param host The hostname of the active container\n+   * @return the set of fault domains on which this active container's standby can be scheduled\n+   */\n+  Set<FaultDomain> getAllowedFaultDomainsForSchedulingContainer(String host);\n+\n+  /**\n+   * This method returns the cached map of nodes to fault domains.\n+   * @return stored map of node to the fault domain it resides on", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2NzQ1OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539867459", "bodyText": "If this value is null or empty, we will retrieve the actual map by calling the compute function written below this.", "author": "PawasChhokra", "createdAt": "2020-12-10T06:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNjI3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNjgwMA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536436800", "bodyText": "ah, i realized now -- this is the is the method to update the manager's fault domain map right.\nso this is in some sense a setter? in which case we should think about thread-safety between this setter and other getters.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:08:24Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same fault domain.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same fault domain\n+   */\n+  boolean checkHostsOnSameFaultDomain(String host1, String host2);\n+\n+  /**\n+   * This method gets the set of fault domains that the given active container's corresponding standby can be placed on.\n+   * @param host The hostname of the active container\n+   * @return the set of fault domains on which this active container's standby can be scheduled\n+   */\n+  Set<FaultDomain> getAllowedFaultDomainsForSchedulingContainer(String host);\n+\n+  /**\n+   * This method returns the cached map of nodes to fault domains.\n+   * @return stored map of node to the fault domain it resides on\n+   */\n+  Map<String, FaultDomain> getNodeToFaultDomainMap();\n+\n+  /**\n+   * This method computes the node to fault domain map from the cluster resource manager.\n+   * @return map of node to the fault domain it resides on", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg2Nzk3NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539867974", "bodyText": "AFAIK, since this will run on the main thread, it should be thread safe.", "author": "PawasChhokra", "createdAt": "2020-12-10T06:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNjgwMA=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzNjkzNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536436937", "bodyText": "same with stability of interface", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:08:51Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+/**\n+ * A factory to build a {@link FaultDomainManager}.\n+ */", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\nindex 15273dede..d2b2ce286 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\n\n@@ -18,11 +18,16 @@\n  */\n package org.apache.samza.clustermanager;\n \n+import org.apache.samza.annotation.InterfaceStability;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.metrics.MetricsRegistry;\n+\n /**\n  * A factory to build a {@link FaultDomainManager}.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManagerFactory {\n \n-  public FaultDomainManager getFaultDomainManager();\n+  public FaultDomainManager getFaultDomainManager(Config config, MetricsRegistry metricsRegistry);\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODM3NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536438375", "bodyText": "emptyset instead of null?\nhowever, what does empty set/null mean?\nwill the request ignore fault domain notions if its null but somehow break the behavior if its an empty set?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:12:50Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java", "diffHunk": "@@ -63,7 +69,11 @@\n   private final Instant requestTimestamp;\n \n   public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId) {\n-    this(numCores, memoryMB, preferredHost, processorId, Instant.now());\n+    this(numCores, memoryMB, preferredHost, processorId, Instant.now(), null);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg3MjQ2MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539872461", "bodyText": "When we make the actual container request to Yarn, the null value says that the rack requirement for that request is ignored, similar to how it currently is without rack awareness. However, I have changed it to an empty set now. Thanks!", "author": "PawasChhokra", "createdAt": "2020-12-10T06:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM1NjA2NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r540356064", "bodyText": "just for my clarification: what is the behavior on yarn side for empty set in the request?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-10T17:24:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMDM2MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543310361", "bodyText": "Pass ImmutableSet.of or any variant of empty set instead of null and get rid of the null check within the other constructor.", "author": "mynameborat", "createdAt": "2020-12-15T12:43:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkxMzY1Mg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r544913652", "bodyText": "@lakshmi-manasa-g it should still work as is.", "author": "PawasChhokra", "createdAt": "2020-12-17T08:51:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\nindex 57f2ef8a0..be804c94f 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n\n@@ -69,7 +71,7 @@ public class SamzaResourceRequest implements Comparable<SamzaResourceRequest> {\n   private final Instant requestTimestamp;\n \n   public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId) {\n-    this(numCores, memoryMB, preferredHost, processorId, Instant.now(), null);\n+    this(numCores, memoryMB, preferredHost, processorId, Instant.now(), ImmutableSet.of());\n   }\n \n   public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId, Set<FaultDomain> faultDomains) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODU3NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536438575", "bodyText": "nit: adding fault domains to the log might be useful for debugging", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:13:26Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java", "diffHunk": "@@ -73,6 +83,18 @@ public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, St\n     this.requestId = UUID.randomUUID().toString();\n     this.processorId = processorId;\n     this.requestTimestamp = requestTimestamp;\n+    this.faultDomains = new HashSet<>();\n+    log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {}\", this.processorId, this.preferredHost, this.requestTimestamp, this.requestId);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\nindex 57f2ef8a0..2e54ddfe6 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n\n@@ -84,7 +84,8 @@ public class SamzaResourceRequest implements Comparable<SamzaResourceRequest> {\n     this.processorId = processorId;\n     this.requestTimestamp = requestTimestamp;\n     this.faultDomains = new HashSet<>();\n-    log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {}\", this.processorId, this.preferredHost, this.requestTimestamp, this.requestId);\n+    log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {}, and the following list of fault domains: {}\",\n+            this.processorId, this.preferredHost, this.requestTimestamp, this.requestId, this.faultDomains);\n   }\n \n   public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId, Instant requestTimestamp, Set<FaultDomain> faultDomains) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODk5Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536438997", "bodyText": "just curious, wont it work without this -esp since you already defined the \"toString\" for FaultDomain?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:14:49Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java", "diffHunk": "@@ -109,15 +135,24 @@ public String toString() {\n             \", requestId='\" + requestId + '\\'' +\n             \", processorId=\" + processorId +\n             \", requestTimestampMs=\" + requestTimestamp +\n+            \", faultDomains=\" + convertFaultDomainSetToString() +\n             '}';\n   }\n \n-  /**\n-   * Requests are ordered by the processor type and the time at which they were created.\n-   * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n-   * Otherwise, active processors take precedence over standby processors, regardless of timestamp.\n-   * @param o the other\n-   */\n+  private String convertFaultDomainSetToString() {\n+    StringBuilder faultDomainSb = new StringBuilder();", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg4ODc1MA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539888750", "bodyText": "Yes it should. I had added the FaultDomain toString method later on hence forgot to remove this. Thanks for observing :)", "author": "PawasChhokra", "createdAt": "2020-12-10T06:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQzODk5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\nindex 57f2ef8a0..2e54ddfe6 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n\n@@ -135,18 +141,10 @@ public class SamzaResourceRequest implements Comparable<SamzaResourceRequest> {\n             \", requestId='\" + requestId + '\\'' +\n             \", processorId=\" + processorId +\n             \", requestTimestampMs=\" + requestTimestamp +\n-            \", faultDomains=\" + convertFaultDomainSetToString() +\n+            \", faultDomains=\" + faultDomains.toString() +\n             '}';\n   }\n \n-  private String convertFaultDomainSetToString() {\n-    StringBuilder faultDomainSb = new StringBuilder();\n-    faultDomains.forEach(faultDomain -> {\n-      faultDomainSb.append(faultDomain.toString());\n-    });\n-    return faultDomainSb.toString();\n-  }\n-\n     /**\n      * Requests are ordered by the processor type and the time at which they were created.\n      * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0NTM0MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536445341", "bodyText": "hmm, wondering if we should place all these changes behind a config?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:35:12Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -125,7 +129,8 @@ public void handleContainerLaunchFail(String containerID, String resourceID,\n \n     if (StandbyTaskUtil.isStandbyContainer(containerID)) {\n       log.info(\"Handling launch fail for standby-container {}, requesting resource on any host {}\", containerID);\n-      containerAllocator.requestResource(containerID, ResourceRequestState.ANY_HOST);\n+      containerAllocator.requestResource(containerID, ResourceRequestState.ANY_HOST,\n+              faultDomainManager.getAllowedFaultDomainsForSchedulingContainer(getActiveContainerHost(containerID)));", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex b700bdf99..ae17194f2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -130,7 +130,7 @@ public class StandbyContainerManager {\n     if (StandbyTaskUtil.isStandbyContainer(containerID)) {\n       log.info(\"Handling launch fail for standby-container {}, requesting resource on any host {}\", containerID);\n       containerAllocator.requestResource(containerID, ResourceRequestState.ANY_HOST,\n-              faultDomainManager.getAllowedFaultDomainsForSchedulingContainer(getActiveContainerHost(containerID)));\n+              getAllowedFaultDomainsForSchedulingStandbyContainer(getActiveContainerHost(containerID)));\n     } else {\n       initiateStandbyAwareAllocation(containerID, resourceID, containerAllocator);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0NTU0NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r536445545", "bodyText": "nit - some new extra spaces sneaked in :)", "author": "lakshmi-manasa-g", "createdAt": "2020-12-04T23:35:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -181,13 +186,14 @@ private void handleStandbyContainerStop(String standbyContainerID, String resour\n \n       // request standbycontainer's host for active-container\n       SamzaResourceRequest resourceRequestForActive =\n-          containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);\n+              containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex b700bdf99..ae17194f2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -186,14 +200,14 @@ public class StandbyContainerManager {\n \n       // request standbycontainer's host for active-container\n       SamzaResourceRequest resourceRequestForActive =\n-              containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);\n+        containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);\n       // record the resource request, before issuing it to avoid race with allocation-thread\n       failoverMetadata.get().recordResourceRequest(resourceRequestForActive);\n       containerAllocator.issueResourceRequest(resourceRequestForActive);\n \n       // request any-host for standby container\n       containerAllocator.requestResource(standbyContainerID, ResourceRequestState.ANY_HOST,\n-              faultDomainManager.getAllowedFaultDomainsForSchedulingContainer(standbyContainerHostname));\n+              getAllowedFaultDomainsForSchedulingStandbyContainer(standbyContainerHostname));\n     } else {\n       log.info(\"Issuing request for standby container {} on host {}, since this is not for a failover\",\n           standbyContainerID, preferredHost);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MzgxOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537863819", "bodyText": "What if host = ANY_HOST but resource.getHost is not ANY_HOST Or vice versa?\n\n\nearlier in StandbyContainerManager - there is a request issue made with ANY_HOST and fault domain set.\nwould it be possible that there is a pending processor with ANY_HOST as well but same fault domain?\nActually since a resource request a set of allowed fault domains and not a specific fault domain - is it possible that a pending processor gets started on the same fault domain as this standby?\nOr do we hope to catch it when that pending processor runs and invokes this same checkStandbyConstraints and find the current standby in runningProcessors and catch it in the check below? If this is the case, then what was the original logic behind checking pendingProcessors at all?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T21:58:24Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,18 +403,32 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n-        return false;\n+      if (resource != null) {\n+        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk0ODY4NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539948685", "bodyText": "Sorry for this confusion, but the hosts passed here will never be ANY_HOST and will have a hostname. Hence, I have removed the existing checks that I had for ANY_HOST.\nThe pending processor list will have the actual hostname instead of ANY_HOST. Hence, the check will always suffice so as to not bring up a standby on the same fault domain as the actives are spun up first. This check is to ensure that a standby container should not come up on the same host or rack as an active container whose launch is pending.", "author": "PawasChhokra", "createdAt": "2020-12-10T07:53:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2MzgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex b700bdf99..ae17194f2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -403,38 +417,35 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(SamzaResource resource, String containerIdToStart, String host, String existingContainerID) {\n+    if (resource != null) {\n+      if (faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      } else if (resource.getHost().equals(host)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n+\n   /**\n    *  Attempt to the run a container on the given candidate resource, if doing so meets the standby container constraints.\n    * @param request The Samza container request\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg2NDA4NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537864084", "bodyText": "looks the same as above check. good to make a helper?? wdyt?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T21:58:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,18 +403,32 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n-        return false;\n+      if (resource != null) {\n+        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n+                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                  containerIdToStart, host, containerID);\n+          return false;\n+        } else if (resource.getHost().equals(host)) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                  containerIdToStart, host, containerID);\n+          return false;\n+        }\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n-        return false;\n+      if (resource != null) {\n+        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n+                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already running on this rack\",\n+                  containerIdToStart, host, containerID);\n+          return false;\n+        } else if (resource.getHost().equals(host)) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n+                  containerIdToStart, host, containerID);\n+          return false;", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex b700bdf99..ae17194f2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -403,38 +417,35 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(SamzaResource resource, String containerIdToStart, String host, String existingContainerID) {\n+    if (resource != null) {\n+      if (faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      } else if (resource.getHost().equals(host)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n+\n   /**\n    *  Attempt to the run a container on the given candidate resource, if doing so meets the standby container constraints.\n    * @param request The Samza container request\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3ODYyMw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537878623", "bodyText": "What if host = ANY_HOST but resource.getHost is not ANY_HOST?\n\n\nwhen alternative resources are being used - checkStandbyAndRunStreamProc is called with ANY_HOST and alternativeResource.get (which is a resource with a proper host name and not ANY_HOST).. are we handling this scenario? looks like it might be handled (checkStandbyConstraints in this case is called with ctrId and proper host name) but wanted a double check on that.\n\n\niiuc, a resource is added to SamzaApplicationState.runningProcessors in YarnClusterResourceManager.onContainerStarted which actually creates a new SamzaResource with values taken from Yarn Container -- and hence will not have ANY_HOST. right? hence maybe we can simplify this check? or was there another reason (like guarding against ANY_HOST in resource)?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T22:23:52Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,18 +403,32 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n-        return false;\n+      if (resource != null) {\n+        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n+                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                  containerIdToStart, host, containerID);\n+          return false;\n+        } else if (resource.getHost().equals(host)) {\n+          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                  containerIdToStart, host, containerID);\n+          return false;\n+        }\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n-        return false;\n+      if (resource != null) {\n+        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk1MTMwMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539951301", "bodyText": "Addressed in the previous comment. The hosts passed here will never be ANY_HOST and will have a hostname.\nThis should be handled here.\nSimplified the check and removed the ANY_HOST checks.", "author": "PawasChhokra", "createdAt": "2020-12-10T07:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3ODYyMw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex b700bdf99..ae17194f2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -403,38 +417,35 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null) {\n-        if (!resource.getHost().equals(ResourceRequestState.ANY_HOST) && !host.equals(ResourceRequestState.ANY_HOST)\n-                && faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this rack\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        } else if (resource.getHost().equals(host)) {\n-          log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-                  containerIdToStart, host, containerID);\n-          return false;\n-        }\n+      if (!checkStandbyConstraintsHelper(resource, containerIdToStart, host, containerID)) {\n+        return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(SamzaResource resource, String containerIdToStart, String host, String existingContainerID) {\n+    if (resource != null) {\n+      if (faultDomainManager.checkHostsOnSameFaultDomain(host, resource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      } else if (resource.getHost().equals(host)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, host, existingContainerID);\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n+\n   /**\n    *  Attempt to the run a container on the given candidate resource, if doing so meets the standby container constraints.\n    * @param request The Samza container request\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5MDMzOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537890339", "bodyText": "might be good to have at least 2 hosts in same rack to be able to test", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T22:44:38Z", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/MockFaultDomainManager.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n+public class MockFaultDomainManager implements FaultDomainManager {\n+\n+  private final Map<String, FaultDomain> nodeToFaultDomainMap;\n+\n+  public MockFaultDomainManager() {\n+    FaultDomain faultDomain1 = new FaultDomain(FaultDomainType.RACK, \"rack-1\");\n+    FaultDomain faultDomain2 = new FaultDomain(FaultDomainType.RACK, \"rack-2\");\n+    FaultDomain faultDomain3 = new FaultDomain(FaultDomainType.RACK, \"rack-1\");\n+    FaultDomain faultDomain4 = new FaultDomain(FaultDomainType.RACK, \"rack-3\");\n+    FaultDomain faultDomain5 = new FaultDomain(FaultDomainType.RACK, \"rack-4\");\n+    nodeToFaultDomainMap = ImmutableMap.of(\"host-1\", faultDomain1, \"host-2\", faultDomain2,", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/test/java/org/apache/samza/clustermanager/MockFaultDomainManager.java b/samza-core/src/test/java/org/apache/samza/clustermanager/MockFaultDomainManager.java\nindex cdb49bf6b..751f47aa6 100644\n--- a/samza-core/src/test/java/org/apache/samza/clustermanager/MockFaultDomainManager.java\n+++ b/samza-core/src/test/java/org/apache/samza/clustermanager/MockFaultDomainManager.java\n\n@@ -18,55 +18,42 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n import java.util.HashSet;\n-import java.util.Map;\n import java.util.Set;\n \n public class MockFaultDomainManager implements FaultDomainManager {\n \n-  private final Map<String, FaultDomain> nodeToFaultDomainMap;\n+  private final Multimap<String, FaultDomain> hostToFaultDomainMap;\n \n   public MockFaultDomainManager() {\n     FaultDomain faultDomain1 = new FaultDomain(FaultDomainType.RACK, \"rack-1\");\n     FaultDomain faultDomain2 = new FaultDomain(FaultDomainType.RACK, \"rack-2\");\n     FaultDomain faultDomain3 = new FaultDomain(FaultDomainType.RACK, \"rack-1\");\n-    FaultDomain faultDomain4 = new FaultDomain(FaultDomainType.RACK, \"rack-3\");\n-    FaultDomain faultDomain5 = new FaultDomain(FaultDomainType.RACK, \"rack-4\");\n-    nodeToFaultDomainMap = ImmutableMap.of(\"host-1\", faultDomain1, \"host-2\", faultDomain2,\n-            \"host-3\", faultDomain3, \"host-4\", faultDomain4, \"host-5\", faultDomain5);\n+    FaultDomain faultDomain4 = new FaultDomain(FaultDomainType.RACK, \"rack-2\");\n+    FaultDomain faultDomain5 = new FaultDomain(FaultDomainType.RACK, \"rack-3\");\n+    hostToFaultDomainMap = HashMultimap.create();\n+    hostToFaultDomainMap.put(\"host-1\", faultDomain1);\n+    hostToFaultDomainMap.put(\"host-2\", faultDomain2);\n+    hostToFaultDomainMap.put(\"host-3\", faultDomain3);\n+    hostToFaultDomainMap.put(\"host-4\", faultDomain4);\n+    hostToFaultDomainMap.put(\"host-5\", faultDomain5);\n   }\n \n   @Override\n   public Set<FaultDomain> getAllFaultDomains() {\n-    return new HashSet<>(nodeToFaultDomainMap.values());\n+    return new HashSet<>(hostToFaultDomainMap.values());\n   }\n \n   @Override\n-  public FaultDomain getFaultDomainOfNode(String host) {\n-    return nodeToFaultDomainMap.get(host);\n+  public Set<FaultDomain> getFaultDomainOfHost(String host) {\n+    return new HashSet<>(hostToFaultDomainMap.get(host));\n   }\n \n   @Override\n   public boolean checkHostsOnSameFaultDomain(String host1, String host2) {\n-    return nodeToFaultDomainMap.get(host1).equals(nodeToFaultDomainMap.get(host2));\n+    return hostToFaultDomainMap.get(host1).equals(hostToFaultDomainMap.get(host2));\n   }\n \n-  @Override\n-  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingContainer(String host) {\n-    FaultDomain activeContainerRack = nodeToFaultDomainMap.get(host);\n-    Set<FaultDomain> standbyRacks = new HashSet<>(nodeToFaultDomainMap.values());\n-    standbyRacks.remove(activeContainerRack);\n-    return standbyRacks;\n-  }\n-\n-  @Override\n-  public Map<String, FaultDomain> getNodeToFaultDomainMap() {\n-    return nodeToFaultDomainMap;\n-  }\n-\n-  @Override\n-  public Map<String, FaultDomain> computeNodeToFaultDomainMap() {\n-    return nodeToFaultDomainMap;\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5MzIyNg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537893226", "bodyText": "works for standby replication factor = 2 (aka one active + one standby). this pr guarantees that the standby is not on the same rack as active. If >2 replication, then the standbys themselves might be on the same rack. need to call out that works for 2 and what to expect for >2. just in the pr desc is enough.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T22:50:21Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+\n+public class RackManager implements FaultDomainManager {\n+\n+  private final Map<String, FaultDomain> nodeToRackMap;\n+\n+  public RackManager() {\n+        this.nodeToRackMap = computeNodeToFaultDomainMap();\n+    }\n+\n+  /**\n+   * This method returns all the rack values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllFaultDomains() {\n+    return new HashSet<>(nodeToRackMap.values());\n+  }\n+\n+  /**\n+   * This method returns the rack a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  @Override\n+  public FaultDomain getFaultDomainOfNode(String host) {\n+    return nodeToRackMap.get(host);\n+  }\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same rack.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same rack\n+   */\n+  @Override\n+  public boolean checkHostsOnSameFaultDomain(String host1, String host2) {\n+    return nodeToRackMap.get(host1).equals(nodeToRackMap.get(host2));\n+  }\n+\n+  /**\n+   * This method gets the set of racks that the given active container's corresponding standby can be placed on.\n+   * @param host The hostname of the active container\n+   * @return the set of racks on which this active container's standby can be scheduled\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingContainer(String host) {\n+    FaultDomain activeContainerRack = nodeToRackMap.get(host);\n+    Set<FaultDomain> standbyRacks = new HashSet<>(nodeToRackMap.values());\n+    standbyRacks.remove(activeContainerRack);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nsimilarity index 53%\nrename from samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\nrename to samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 539bd1688..1357f5f85 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -18,11 +18,11 @@\n  */\n package org.apache.samza.job.yarn;\n \n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n import java.io.IOException;\n-import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n import java.util.Set;\n import org.apache.hadoop.yarn.api.records.NodeReport;\n import org.apache.hadoop.yarn.api.records.NodeState;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NDU0OA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r537894548", "bodyText": "this exception is swallowed no.. what happens to the rack manager in this case? will it still give a correct view of the cluster's host->rack mapping? how do we ensure the feature still works?\nit possibly returns an empty map. then, nodeToRackMap.get(host) in getAllowedFaultDomainsForSchedulingContainer above will return null --> and removing a null from Set could throw NPE (HashSet doesnt throw i think).\nEven if NPE doesnt happen, getAllowedFaultDomainsForSchedulingContainer returns an empty set. What is the behavior of this feature when a resource request is made with an empty set of racks? will Yarn just pick any rack or fail the request?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-07T22:53:00Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+\n+public class RackManager implements FaultDomainManager {\n+\n+  private final Map<String, FaultDomain> nodeToRackMap;\n+\n+  public RackManager() {\n+        this.nodeToRackMap = computeNodeToFaultDomainMap();\n+    }\n+\n+  /**\n+   * This method returns all the rack values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllFaultDomains() {\n+    return new HashSet<>(nodeToRackMap.values());\n+  }\n+\n+  /**\n+   * This method returns the rack a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  @Override\n+  public FaultDomain getFaultDomainOfNode(String host) {\n+    return nodeToRackMap.get(host);\n+  }\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same rack.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same rack\n+   */\n+  @Override\n+  public boolean checkHostsOnSameFaultDomain(String host1, String host2) {\n+    return nodeToRackMap.get(host1).equals(nodeToRackMap.get(host2));\n+  }\n+\n+  /**\n+   * This method gets the set of racks that the given active container's corresponding standby can be placed on.\n+   * @param host The hostname of the active container\n+   * @return the set of racks on which this active container's standby can be scheduled\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingContainer(String host) {\n+    FaultDomain activeContainerRack = nodeToRackMap.get(host);\n+    Set<FaultDomain> standbyRacks = new HashSet<>(nodeToRackMap.values());\n+    standbyRacks.remove(activeContainerRack);\n+    return standbyRacks;\n+  }\n+\n+  /**\n+   * This method returns the cached map of nodes to racks.\n+   * @return stored map of node to the rack it resides on\n+   */\n+  @Override\n+  public Map<String, FaultDomain> getNodeToFaultDomainMap() {\n+    return nodeToRackMap;\n+  }\n+\n+  /**\n+   * This method gets the node to rack (fault domain for Yarn) mapping from Yarn for all running nodes.\n+   * @return A map of hostname to rack name.\n+   */\n+  @Override\n+  public Map<String, FaultDomain> computeNodeToFaultDomainMap() {\n+    YarnClientImpl yarnClient = new YarnClientImpl();\n+    Map<String, FaultDomain> nodeToRackMap = new HashMap<>();\n+    try {\n+      List<NodeReport> nodeReport = yarnClient.getNodeReports(NodeState.RUNNING);\n+      nodeReport.forEach(report -> {\n+        FaultDomain rack = new FaultDomain(FaultDomainType.RACK, report.getRackName());\n+        nodeToRackMap.put(report.getNodeId().getHost(), rack);\n+      });\n+    } catch (YarnException e) {\n+      e.printStackTrace();", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE0MDU4MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547140581", "bodyText": "Thanks for pointing this out. I've instead thrown a SamzaException if we are unable to get node reports from Yarn, since we need that for rack awareness to work. This will take care of the other concerns that you raised.", "author": "PawasChhokra", "createdAt": "2020-12-22T08:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg5NDU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nsimilarity index 53%\nrename from samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\nrename to samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 539bd1688..1357f5f85 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -18,11 +18,11 @@\n  */\n package org.apache.samza.job.yarn;\n \n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n import java.io.IOException;\n-import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n import java.util.Set;\n import org.apache.hadoop.yarn.api.records.NodeReport;\n import org.apache.hadoop.yarn.api.records.NodeState;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg3NzU0Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538877546", "bodyText": "nit: add new parameters to the end of the signature", "author": "mynameborat", "createdAt": "2020-12-08T23:10:05Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java", "diffHunk": "@@ -183,6 +191,7 @@ public ContainerProcessManager(Config config, SamzaApplicationState state, Metri\n       SamzaApplicationState state,\n       MetricsRegistryMap registry,\n       ClusterResourceManager resourceManager,\n+      FaultDomainManager faultDomainManager,", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\nindex 2fd55746b..305e72093 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n\n@@ -191,7 +186,6 @@ public class ContainerProcessManager implements ClusterResourceManager.Callback\n       SamzaApplicationState state,\n       MetricsRegistryMap registry,\n       ClusterResourceManager resourceManager,\n-      FaultDomainManager faultDomainManager,\n       Optional<ContainerAllocator> allocator,\n       ContainerManager containerManager,\n       LocalityManager localityManager) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg3NzU4NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538877585", "bodyText": "can be removed since its only used to wire the ContainerManager.", "author": "mynameborat", "createdAt": "2020-12-08T23:10:10Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java", "diffHunk": "@@ -114,6 +114,11 @@\n    */\n   private final ClusterResourceManager clusterResourceManager;\n \n+  /**\n+   * An interface to get information about nodes and the fault domains they reside on.\n+   */\n+  private final FaultDomainManager faultDomainManager;", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\nindex 2fd55746b..305e72093 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java\n\n@@ -114,11 +114,6 @@ public class ContainerProcessManager implements ClusterResourceManager.Callback\n    */\n   private final ClusterResourceManager clusterResourceManager;\n \n-  /**\n-   * An interface to get information about nodes and the fault domains they reside on.\n-   */\n-  private final FaultDomainManager faultDomainManager;\n-\n   /**\n    * If there are more than job.container.retry.count failures of a container within a job.container.retry.window period,\n    * then the ContainerProcessManager will indicate to the ClusterBasedJobCoordinator that the job should shutdown.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4MTExNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538881117", "bodyText": "The interface exposes too many functionalities that are either not necessary upstream or conflating.\n\ncomputeNodeToFaultDomainMap\ngetAllowedFaultDomainsForSchedulingContainer\ngetNodeToFaultDomainMap\n\nThe notion of allowed fault domain for the container is not determined by the cluster manager's fault domain manager rather StandbyContainerManager. Hence [2] shouldn't be exposed as a functionality.\n[3] seems redundant given you have getFaultDomainOfNode\n[1] is completely internal to the manager and shouldn't be exposed.", "author": "mynameborat", "createdAt": "2020-12-08T23:17:35Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3NTU4NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r539975584", "bodyText": "This makes sense. Made the changes. Thanks for the suggestions :)", "author": "PawasChhokra", "createdAt": "2020-12-10T08:39:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4MTExNw=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4MjA4MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538882081", "bodyText": "Should be Set<FaultDomain> given a node can belong to multiple fault domain", "author": "mynameborat", "createdAt": "2020-12-08T23:18:36Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4NDI4Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538884286", "bodyText": "Given nodes can belong to multiple fault domain, what does this functionality offer? Overlapping fault domain = true or absolute 1:1 mapping as true.\nWhy do you need this functionality in the first place? I thought we were using the set difference approach to get the fault domain of active and then find the set difference between available fault domain and active fault domain and use that for requesting resources.", "author": "mynameborat", "createdAt": "2020-12-08T23:21:59Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ */\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular node resides on.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  FaultDomain getFaultDomainOfNode(String host);\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same fault domain.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same fault domain\n+   */\n+  boolean checkHostsOnSameFaultDomain(String host1, String host2);", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU1NzYzNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r542557637", "bodyText": "Discussed more about this offline. We've decided to keep this method since it has closed responsibility, hides the details about figuring out the fault domains for hosts and performing the equals check, and defines a clear contract with the FaultDomainManager. I've updated the documentation to denote this.", "author": "PawasChhokra", "createdAt": "2020-12-14T17:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4NDI4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex 0e53ba880..ee23c3170 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -18,28 +18,33 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import java.util.Map;\n import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n \n /**\n- * This interface gets fault domain information of different nodes from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n  *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n- *  the same fault domain, and getting the valid fault domains that a standby container can be placed on.\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManager {\n \n   /**\n-   * This method returns all the fault domain values in a cluster for RUNNING nodes.\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n \n   /**\n-   * This method returns the fault domain a particular node resides on.\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n    * @param host the host\n    * @return the {@link FaultDomain}\n    */\n-  FaultDomain getFaultDomainOfNode(String host);\n+  Set<FaultDomain> getFaultDomainOfHost(String host);\n \n   /**\n    * This method checks if the two hostnames provided reside on the same fault domain.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4NDkwOA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538884908", "bodyText": "Should we take Config and MetricsRegistry as bare minimum parameters to enable us add metrics or use cut off switch within or configure the potential behavior as it evolves.", "author": "mynameborat", "createdAt": "2020-12-08T23:23:16Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+/**\n+ * A factory to build a {@link FaultDomainManager}.\n+ */\n+public interface FaultDomainManagerFactory {\n+\n+  public FaultDomainManager getFaultDomainManager();", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\nindex 15273dede..d2b2ce286 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManagerFactory.java\n\n@@ -18,11 +18,16 @@\n  */\n package org.apache.samza.clustermanager;\n \n+import org.apache.samza.annotation.InterfaceStability;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.metrics.MetricsRegistry;\n+\n /**\n  * A factory to build a {@link FaultDomainManager}.\n  */\n+@InterfaceStability.Unstable\n public interface FaultDomainManagerFactory {\n \n-  public FaultDomainManager getFaultDomainManager();\n+  public FaultDomainManager getFaultDomainManager(Config config, MetricsRegistry metricsRegistry);\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4NjgxNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538886815", "bodyText": "I suppose this needs to be YarnFaultDomainManager.\nFaultDomainManager by itself is capable of handling all types of fault domain for a given cluster type. Hence  RackManager by itself doesn\u2019t seem suitable abstraction rather there should be one for YARN which is capable of reporting all sort of fault domains supported by YARN", "author": "mynameborat", "createdAt": "2020-12-08T23:26:24Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+\n+public class RackManager implements FaultDomainManager {", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nsimilarity index 53%\nrename from samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\nrename to samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 539bd1688..1357f5f85 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -18,11 +18,11 @@\n  */\n package org.apache.samza.job.yarn;\n \n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n import java.io.IOException;\n-import java.util.HashMap;\n import java.util.HashSet;\n import java.util.List;\n-import java.util.Map;\n import java.util.Set;\n import org.apache.hadoop.yarn.api.records.NodeReport;\n import org.apache.hadoop.yarn.api.records.NodeState;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg4NzE0OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r538887149", "bodyText": "Refer to comment above on this being YarnFaultDomainManager. Guess that will change this as well.", "author": "mynameborat", "createdAt": "2020-12-08T23:27:04Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManagerFactory.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainManagerFactory;\n+\n+/**\n+ * A factory to build a {@link RackManager}.\n+ */\n+public class RackManagerFactory implements FaultDomainManagerFactory {", "originalCommit": "addaf742fda1c27ece5efbf23ccda5d68fc376f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facf17994fea70fed9153663cab4075b588fd309", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManagerFactory.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManagerFactory.java\nsimilarity index 73%\nrename from samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManagerFactory.java\nrename to samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManagerFactory.java\nindex a18ab8b85..4bab68071 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/RackManagerFactory.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManagerFactory.java\n\n@@ -20,13 +20,15 @@ package org.apache.samza.job.yarn;\n \n import org.apache.samza.clustermanager.FaultDomainManager;\n import org.apache.samza.clustermanager.FaultDomainManagerFactory;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.metrics.MetricsRegistry;\n \n /**\n- * A factory to build a {@link RackManager}.\n+ * A factory to build a {@link YarnFaultDomainManager}.\n  */\n-public class RackManagerFactory implements FaultDomainManagerFactory {\n+public class YarnFaultDomainManagerFactory implements FaultDomainManagerFactory {\n   @Override\n-  public FaultDomainManager getFaultDomainManager() {\n-    return new RackManager();\n+  public FaultDomainManager getFaultDomainManager(Config config, MetricsRegistry metricsRegistry) {\n+    return new YarnFaultDomainManager();\n   }\n }\n"}}, {"oid": "facf17994fea70fed9153663cab4075b588fd309", "url": "https://github.com/apache/samza/commit/facf17994fea70fed9153663cab4075b588fd309", "message": "Address first round of review", "committedDate": "2020-12-10T10:12:20Z", "type": "commit"}, {"oid": "51970921b94ab7972b4380520204fc9af7b62dd4", "url": "https://github.com/apache/samza/commit/51970921b94ab7972b4380520204fc9af7b62dd4", "message": "Address comments", "committedDate": "2020-12-14T15:46:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNTQyMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543305421", "bodyText": "can we be consistent and use Preconditions or Objects.nonNull?", "author": "mynameborat", "createdAt": "2020-12-15T12:36:20Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import org.apache.samza.SamzaException;\n+\n+/**\n+ * A fault domain is a set of hardware components that share a single point of failure.\n+ * This class identifies the type (ex: rack) and ID (ex: rack ID) of the fault domain in question.\n+ * A host can belong to multiple fault domains.\n+ * A fault domain may have greater than or equal to 1 hosts.\n+ * A cluster can comprise of hosts on multiple fault domains.\n+ */\n+public class FaultDomain {\n+\n+  private final FaultDomainType type;\n+  private final String id;\n+\n+  public FaultDomain(FaultDomainType type, String id) {\n+    if (type == null || id == null) {\n+      throw new SamzaException(\"Fault domain type and ID cannot be null.\");", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\nindex dbfece8c8..a5ebdd4cd 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n\n@@ -18,7 +18,8 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import org.apache.samza.SamzaException;\n+import com.google.common.base.Objects;\n+import com.google.common.base.Preconditions;\n \n /**\n  * A fault domain is a set of hardware components that share a single point of failure.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNjA5NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543306095", "bodyText": "Doesn't it require equals & hashcode to be overridden as well for fault domain check?", "author": "mynameborat", "createdAt": "2020-12-15T12:37:20Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import org.apache.samza.SamzaException;\n+\n+/**\n+ * A fault domain is a set of hardware components that share a single point of failure.\n+ * This class identifies the type (ex: rack) and ID (ex: rack ID) of the fault domain in question.\n+ * A host can belong to multiple fault domains.\n+ * A fault domain may have greater than or equal to 1 hosts.\n+ * A cluster can comprise of hosts on multiple fault domains.\n+ */\n+public class FaultDomain {", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4Mzg0NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545283845", "bodyText": "Done.", "author": "PawasChhokra", "createdAt": "2020-12-17T17:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNjA5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\nindex dbfece8c8..a5ebdd4cd 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomain.java\n\n@@ -18,7 +18,8 @@\n  */\n package org.apache.samza.clustermanager;\n \n-import org.apache.samza.SamzaException;\n+import com.google.common.base.Objects;\n+import com.google.common.base.Preconditions;\n \n /**\n  * A fault domain is a set of hardware components that share a single point of failure.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNzM4NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543307385", "bodyText": "cached, seems an implementation detail and no API detail.\nDo we require strong freshness? If so, the API should mandate that.\nIf not, you should callout that the freshness is an implementation detail and API doesn't mandate anything.", "author": "mynameborat", "createdAt": "2020-12-15T12:39:22Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n+\n+/**\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n+ */\n+@InterfaceStability.Unstable\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NDgzOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545284839", "bodyText": "I've added to the documentation that the cache update is an implementation detail.", "author": "PawasChhokra", "createdAt": "2020-12-17T17:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNzM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM5NjkzMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545396931", "bodyText": "Sync'd up offline. Please update the document to reflect.", "author": "mynameborat", "createdAt": "2020-12-17T20:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNzM4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE2NDcyMg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546164722", "bodyText": "Done.", "author": "PawasChhokra", "createdAt": "2020-12-19T00:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNzM4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex a4ae0fc2a..2a50eab63 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -35,6 +35,7 @@ public interface FaultDomainManager {\n \n   /**\n    * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n+   * This cache might not be up to date with the state of the cluster, since the cache update is an implementation detail.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwNzYzMA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543307630", "bodyText": "nit: java docs", "author": "mynameborat", "createdAt": "2020-12-15T12:39:42Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+public enum FaultDomainType {", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainType.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainType.java\nindex 809d40226..ca2fdd110 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainType.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainType.java\n\n@@ -18,6 +18,9 @@\n  */\n package org.apache.samza.clustermanager;\n \n+/**\n+ * This enum defines the type of fault domain used depending on the environment they are in.\n+ */\n public enum FaultDomainType {\n     RACK\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwODk0Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543308947", "bodyText": "why is this metric part of SamzaApplicationState? Refer to the above comment on FaultDomainManager. Caching or not is an implementation detail and seems very specific metric to track by the implementation of FaultDomainManager. Hence, its resting place is not within SamzaApplicationState.", "author": "mynameborat", "createdAt": "2020-12-15T12:41:50Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -170,6 +170,31 @@\n    */\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n+  /**\n+   * Number of fault domain aware container requests made for a container.\n+   */\n+  public final AtomicInteger hostToFaultDomainCacheUpdates = new AtomicInteger(0);", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NjgyNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545286825", "bodyText": "Removed this from SamzaApplicationState and added it as part of YarnFaultDomainManager instead.", "author": "PawasChhokra", "createdAt": "2020-12-17T17:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMwODk0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\nindex 9bc0f57ac..3fcb2b567 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n\n@@ -170,11 +170,6 @@ public class SamzaApplicationState {\n    */\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n-  /**\n-   * Number of fault domain aware container requests made for a container.\n-   */\n-  public final AtomicInteger hostToFaultDomainCacheUpdates = new AtomicInteger(0);\n-\n   /**\n    * Number of fault domain aware container requests made for a container.\n    */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMTIwOA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543311208", "bodyText": "The null check seems redundant since we already ensure the faultDomains are empty or present.", "author": "mynameborat", "createdAt": "2020-12-15T12:45:10Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -381,6 +428,9 @@ public final void issueResourceRequest(SamzaResourceRequest request) {\n     } else {\n       state.preferredHostRequests.incrementAndGet();\n     }\n+    if (request.getFaultDomains() != null && !request.getFaultDomains().isEmpty()) {", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\nindex 41feb0e5e..b1cddac95 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\n\n@@ -428,7 +428,7 @@ public class ContainerAllocator implements Runnable {\n     } else {\n       state.preferredHostRequests.incrementAndGet();\n     }\n-    if (request.getFaultDomains() != null && !request.getFaultDomains().isEmpty()) {\n+    if (!request.getFaultDomains().isEmpty()) {\n       state.faultDomainAwareContainerRequests.incrementAndGet();\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMjg4Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543312883", "bodyText": "can we add null pre conditions check for faultDomains?", "author": "mynameborat", "createdAt": "2020-12-15T12:47:38Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java", "diffHunk": "@@ -73,7 +83,25 @@ public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, St\n     this.requestId = UUID.randomUUID().toString();\n     this.processorId = processorId;\n     this.requestTimestamp = requestTimestamp;\n-    log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {}\", this.processorId, this.preferredHost, this.requestTimestamp, this.requestId);\n+    this.faultDomains = new HashSet<>();\n+    log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {}, and the following list of fault domains: {}\",\n+            this.processorId, this.preferredHost, this.requestTimestamp, this.requestId, this.faultDomains);\n+  }\n+\n+  public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId, Instant requestTimestamp, Set<FaultDomain> faultDomains) {\n+    this.numCores = numCores;", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\nindex 2e54ddfe6..be804c94f 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n\n@@ -89,17 +91,14 @@ public class SamzaResourceRequest implements Comparable<SamzaResourceRequest> {\n   }\n \n   public SamzaResourceRequest(int numCores, int memoryMB, String preferredHost, String processorId, Instant requestTimestamp, Set<FaultDomain> faultDomains) {\n+    Preconditions.checkNotNull(faultDomains, \"Set of fault domains should not be null.\");\n     this.numCores = numCores;\n     this.memoryMB = memoryMB;\n     this.preferredHost = preferredHost;\n     this.requestId = UUID.randomUUID().toString();\n     this.processorId = processorId;\n     this.requestTimestamp = requestTimestamp;\n-    if (faultDomains == null) {\n-      this.faultDomains = new HashSet<>();\n-    } else {\n-      this.faultDomains = faultDomains;\n-    }\n+    this.faultDomains = faultDomains;\n     log.info(\"SamzaResourceRequest created for Processor ID: {} on host: {} at time: {} with Request ID: {} and the following list of fault domains: {}\",\n             this.processorId, this.preferredHost, this.requestTimestamp, this.requestId, this.faultDomains.toString());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxMzExOA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543313118", "bodyText": "nit: fix indentation", "author": "mynameborat", "createdAt": "2020-12-15T12:48:04Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java", "diffHunk": "@@ -109,15 +141,16 @@ public String toString() {\n             \", requestId='\" + requestId + '\\'' +\n             \", processorId=\" + processorId +\n             \", requestTimestampMs=\" + requestTimestamp +\n+            \", faultDomains=\" + faultDomains.toString() +\n             '}';\n   }\n \n-  /**\n-   * Requests are ordered by the processor type and the time at which they were created.\n-   * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n-   * Otherwise, active processors take precedence over standby processors, regardless of timestamp.\n-   * @param o the other\n-   */\n+    /**\n+     * Requests are ordered by the processor type and the time at which they were created.\n+     * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n+     * Otherwise, active processors take precedence over standby processors, regardless of timestamp.\n+     * @param o the other\n+     */", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\nindex 2e54ddfe6..be804c94f 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaResourceRequest.java\n\n@@ -145,12 +144,12 @@ public class SamzaResourceRequest implements Comparable<SamzaResourceRequest> {\n             '}';\n   }\n \n-    /**\n-     * Requests are ordered by the processor type and the time at which they were created.\n-     * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n-     * Otherwise, active processors take precedence over standby processors, regardless of timestamp.\n-     * @param o the other\n-     */\n+  /**\n+   * Requests are ordered by the processor type and the time at which they were created.\n+   * Requests with timestamps in the future for retries take less precedence than timestamps in the past or current.\n+   * Otherwise, active processors take precedence over standby processors, regardless of timestamp.\n+   * @param o the other\n+   */\n   @Override\n   public int compareTo(SamzaResourceRequest o) {\n     if (!StandbyTaskUtil.isStandbyContainer(processorId) && StandbyTaskUtil.isStandbyContainer(o.processorId)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNTA0OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543315049", "bodyText": "can we rename the variables to generic fault domain instead of racks as that is the case?", "author": "mynameborat", "createdAt": "2020-12-15T12:51:04Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -156,6 +161,20 @@ public void handleContainerStopFail(String containerID, String resourceID,\n     }\n   }\n \n+  /**\n+   * This method gets the set of racks that the given active container's corresponding standby can be placed on.\n+   * The set of racks returned is based on the set difference between the active container's racks,\n+   * and all the available racks in the cluster based on the host to fault domain cache.\n+   * @param host The hostname of the active container\n+   * @return the set of racks on which this active container's standby can be scheduled\n+   */\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(String host) {\n+    Set<FaultDomain> activeContainerRack = faultDomainManager.getFaultDomainOfHost(host);\n+    Set<FaultDomain> standbyRacks = faultDomainManager.getAllFaultDomains();\n+    standbyRacks.removeAll(activeContainerRack);\n+    return standbyRacks;", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex c6e796c2e..a91193ba2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -168,11 +173,13 @@ public class StandbyContainerManager {\n    * @param host The hostname of the active container\n    * @return the set of racks on which this active container's standby can be scheduled\n    */\n-  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(String host) {\n-    Set<FaultDomain> activeContainerRack = faultDomainManager.getFaultDomainOfHost(host);\n-    Set<FaultDomain> standbyRacks = faultDomainManager.getAllFaultDomains();\n-    standbyRacks.removeAll(activeContainerRack);\n-    return standbyRacks;\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(Optional<String> host) {\n+    Set<FaultDomain> standbyFaultDomain = faultDomainManager.getAllFaultDomains();\n+    if (host.isPresent()) {\n+      Set<FaultDomain> activeContainerFaultDomain = faultDomainManager.getFaultDomainsForHost(host.get());\n+      standbyFaultDomain.removeAll(activeContainerFaultDomain);\n+    }\n+    return standbyFaultDomain;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNzQzNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543317437", "bodyText": "Potentially passing in a nullable host into getFaultDomainOfHost. Can we add a check to this method  or ensure only non-nullable can be passed into the method with annotation?", "author": "mynameborat", "createdAt": "2020-12-15T12:54:35Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -156,6 +161,20 @@ public void handleContainerStopFail(String containerID, String resourceID,\n     }\n   }\n \n+  /**\n+   * This method gets the set of racks that the given active container's corresponding standby can be placed on.\n+   * The set of racks returned is based on the set difference between the active container's racks,\n+   * and all the available racks in the cluster based on the host to fault domain cache.\n+   * @param host The hostname of the active container\n+   * @return the set of racks on which this active container's standby can be scheduled\n+   */\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(String host) {\n+    Set<FaultDomain> activeContainerRack = faultDomainManager.getFaultDomainOfHost(host);", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex c6e796c2e..a91193ba2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -168,11 +173,13 @@ public class StandbyContainerManager {\n    * @param host The hostname of the active container\n    * @return the set of racks on which this active container's standby can be scheduled\n    */\n-  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(String host) {\n-    Set<FaultDomain> activeContainerRack = faultDomainManager.getFaultDomainOfHost(host);\n-    Set<FaultDomain> standbyRacks = faultDomainManager.getAllFaultDomains();\n-    standbyRacks.removeAll(activeContainerRack);\n-    return standbyRacks;\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(Optional<String> host) {\n+    Set<FaultDomain> standbyFaultDomain = faultDomainManager.getAllFaultDomains();\n+    if (host.isPresent()) {\n+      Set<FaultDomain> activeContainerFaultDomain = faultDomainManager.getFaultDomainsForHost(host.get());\n+      standbyFaultDomain.removeAll(activeContainerFaultDomain);\n+    }\n+    return standbyFaultDomain;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNzg1NA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543317854", "bodyText": "Can we return optional instead of null? It would force callers to handle the non-existent case of a host for a given container id.", "author": "mynameborat", "createdAt": "2020-12-15T12:55:13Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -361,8 +382,29 @@ private FailoverMetadata registerActiveContainerFailure(String activeContainerID\n   }\n \n   /**\n-   * Check if matching this SamzaResourceRequest to the given resource, meets all standby-container container constraints.\n+   * This method returns the active container host given a standby or active container ID.\n    *\n+   * @param containerID Standby or active container container ID\n+   * @return The active container host\n+   */\n+  String getActiveContainerHost(String containerID) {\n+    String activeContainerId = containerID;\n+    if (StandbyTaskUtil.isStandbyContainer(containerID)) {\n+      activeContainerId = StandbyTaskUtil.getActiveContainerId(containerID);\n+    }\n+    SamzaResource resource = samzaApplicationState.pendingProcessors.get(activeContainerId);\n+    if (resource == null) {\n+      resource = samzaApplicationState.runningProcessors.get(activeContainerId);\n+    }\n+    if (resource != null) {\n+      return resource.getHost();\n+    }\n+    return null;", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex c6e796c2e..a91193ba2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -387,7 +394,7 @@ public class StandbyContainerManager {\n    * @param containerID Standby or active container container ID\n    * @return The active container host\n    */\n-  String getActiveContainerHost(String containerID) {\n+  Optional<String> getActiveContainerHost(String containerID) {\n     String activeContainerId = containerID;\n     if (StandbyTaskUtil.isStandbyContainer(containerID)) {\n       activeContainerId = StandbyTaskUtil.getActiveContainerId(containerID);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMDIwOA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543320208", "bodyText": "should it be YarnFaultDomainManagerFactory?\nAlso, I feel the configuration should be cluster-manager.fault-domain-manager.factory since we have an association of the fault domain manager to the cluster manager.\nwhat do you think?", "author": "mynameborat", "createdAt": "2020-12-15T12:58:39Z", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -38,6 +38,9 @@\n   private static final String CLUSTER_MANAGER_FACTORY = \"samza.cluster-manager.factory\";\n   private static final String CLUSTER_MANAGER_FACTORY_DEFAULT = \"org.apache.samza.job.yarn.YarnResourceManagerFactory\";\n \n+  private static final String FAULT_DOMAIN_MANAGER_FACTORY = \"samza.fault-domain-manager.factory\";\n+  private static final String FAULT_DOMAIN_MANAGER_FACTORY_DEFAULT = \"org.apache.samza.job.yarn.RackManagerFactory\";", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NzQxNg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545287416", "bodyText": "Changed. Thanks :)", "author": "PawasChhokra", "createdAt": "2020-12-17T17:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMDIwOA=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java b/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\nindex 6f7bc5950..8fd6ea508 100644\n--- a/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\n+++ b/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\n\n@@ -38,8 +38,13 @@ public class ClusterManagerConfig extends MapConfig {\n   private static final String CLUSTER_MANAGER_FACTORY = \"samza.cluster-manager.factory\";\n   private static final String CLUSTER_MANAGER_FACTORY_DEFAULT = \"org.apache.samza.job.yarn.YarnResourceManagerFactory\";\n \n-  private static final String FAULT_DOMAIN_MANAGER_FACTORY = \"samza.fault-domain-manager.factory\";\n-  private static final String FAULT_DOMAIN_MANAGER_FACTORY_DEFAULT = \"org.apache.samza.job.yarn.RackManagerFactory\";\n+  private static final String FAULT_DOMAIN_MANAGER_FACTORY = \"cluster-manager.fault-domain-manager.factory\";\n+  private static final String FAULT_DOMAIN_MANAGER_FACTORY_DEFAULT = \"org.apache.samza.job.yarn.YarnFaultDomainManagerFactory\";\n+\n+  /**\n+   * Determines whether standby allocation is fault domain aware or not.\n+   */\n+  public static final String FAULT_DOMAIN_AWARE_STANDBY_ENABLED = \"cluster-manager.fault-domain-aware.standby.enabled\";\n \n   /**\n    * Sleep interval for the allocator thread in milliseconds\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMTM2NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543321365", "bodyText": "should go away with the equals & hashcode implemented for FaultDomain", "author": "mynameborat", "createdAt": "2020-12-15T13:00:26Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.SamzaException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+import org.apache.samza.clustermanager.SamzaApplicationState;\n+\n+/**\n+ * This class functionality works with the assumption that the job.standbytasks.replication.factor is 2.\n+ * For values greater than 2, it is possible that the standby containers could be on the same rack as the active, or the already existing standby racks.\n+ */\n+public class YarnFaultDomainManager implements FaultDomainManager {\n+\n+  private Multimap<String, FaultDomain> hostToRackMap;\n+  private final SamzaApplicationState state;\n+  private final YarnClientImpl yarnClient;\n+\n+  public YarnFaultDomainManager(SamzaApplicationState state) {\n+    this.state = state;\n+    this.yarnClient = new YarnClientImpl();\n+    this.hostToRackMap = computeHostToFaultDomainMap();\n+  }\n+\n+  @VisibleForTesting\n+  YarnFaultDomainManager(SamzaApplicationState state, YarnClientImpl yarnClient, Multimap<String, FaultDomain> hostToRackMap) {\n+    this.state = state;\n+    this.yarnClient = yarnClient;\n+    this.hostToRackMap = hostToRackMap;\n+  }\n+\n+  /**\n+   * This method returns all the last cached rack values in a cluster, for all hosts that are healthy, up and running.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllFaultDomains() {\n+    return new HashSet<>(hostToRackMap.values());\n+  }\n+\n+  /**\n+   * This method returns the rack a particular host resides on based on the internal cache.\n+   * In case the rack of a host does not exist in this cache, we update the cache by computing the host to rack map again using Yarn.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  @Override\n+  public Set<FaultDomain> getFaultDomainOfHost(String host) {\n+    if (!hostToRackMap.containsKey(host)) {\n+      hostToRackMap = computeHostToFaultDomainMap();\n+      state.hostToFaultDomainCacheUpdates.incrementAndGet();\n+    }\n+    return new HashSet<>(hostToRackMap.get(host));\n+  }\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same rack.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same rack\n+   */\n+  @Override\n+  public boolean hasSameFaultDomains(String host1, String host2) {\n+    if (!hostToRackMap.keySet().contains(host1) || !hostToRackMap.keySet().contains(host2)) {\n+      hostToRackMap = computeHostToFaultDomainMap();\n+      state.hostToFaultDomainCacheUpdates.incrementAndGet();\n+    }\n+    return hostToRackMap.get(host1).toString().equals(hostToRackMap.get(host2).toString());", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 57cacf04f..ebc998716 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -22,7 +22,6 @@ import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.HashMultimap;\n import com.google.common.collect.Multimap;\n import java.io.IOException;\n-import java.util.Collection;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMjkwMg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543322902", "bodyText": "refer to the comments on the metrics. Addressing that should get rid of this dependency for YarnFaultDomainManager. Do we see other needs for this dependency?\nI'd assume this takes a MetricsRegistry instead\ncontext: SamzaApplicationState", "author": "mynameborat", "createdAt": "2020-12-15T13:02:45Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.SamzaException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+import org.apache.samza.clustermanager.SamzaApplicationState;\n+\n+/**\n+ * This class functionality works with the assumption that the job.standbytasks.replication.factor is 2.\n+ * For values greater than 2, it is possible that the standby containers could be on the same rack as the active, or the already existing standby racks.\n+ */\n+public class YarnFaultDomainManager implements FaultDomainManager {\n+\n+  private Multimap<String, FaultDomain> hostToRackMap;\n+  private final SamzaApplicationState state;\n+  private final YarnClientImpl yarnClient;\n+\n+  public YarnFaultDomainManager(SamzaApplicationState state) {\n+    this.state = state;", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4Nzg1Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545287853", "bodyText": "Removed SamzaApplicationState as mentioned above.", "author": "PawasChhokra", "createdAt": "2020-12-17T17:56:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMjkwMg=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 57cacf04f..ebc998716 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -22,7 +22,6 @@ import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.HashMultimap;\n import com.google.common.collect.Multimap;\n import java.io.IOException;\n-import java.util.Collection;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyMzYyMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543323621", "bodyText": "nit: s/getFaultDomainOfHost/getFaultDomainsForHost", "author": "mynameborat", "createdAt": "2020-12-15T13:03:59Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.Set;\n+import org.apache.samza.annotation.InterfaceStability;\n+\n+/**\n+ *  This interface gets fault domain information of all hosts that are running in the cluster,\n+ *  from the cluster manager (Yarn/Kubernetes/etc.).\n+ *  It also provides other functionality like exposing all the available fault domains, checking if two hosts belong to\n+ *  the same fault domain, and getting the valid fault domains that a container can be placed on (for ex: based on standby constraints).\n+ *  The host to fault domain map used here will always be cached and only updated in case the AM dies or an active\n+ *  container is assigned to a host which is not in the map.\n+ *  This is not thread-safe.\n+ */\n+@InterfaceStability.Unstable\n+public interface FaultDomainManager {\n+\n+  /**\n+   * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  Set<FaultDomain> getAllFaultDomains();\n+\n+  /**\n+   * This method returns the fault domain a particular host resides on based on the internal cache.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  Set<FaultDomain> getFaultDomainOfHost(String host);", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\nindex a4ae0fc2a..2a50eab63 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/FaultDomainManager.java\n\n@@ -35,6 +35,7 @@ public interface FaultDomainManager {\n \n   /**\n    * This method returns all the last cached fault domain values in a cluster, for all hosts that are healthy, up and running.\n+   * This cache might not be up to date with the state of the cluster, since the cache update is an implementation detail.\n    * @return a set of {@link FaultDomain}s\n    */\n   Set<FaultDomain> getAllFaultDomains();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQwNTcxNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543405715", "bodyText": "Should we guard this with the configuration as well?", "author": "mynameborat", "createdAt": "2020-12-15T14:43:08Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,24 +417,38 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(String containerIdToStart, String hostToStartContainerOn, SamzaResource existingResource, String existingContainerID) {", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex c6e796c2e..a91193ba2 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -433,7 +437,8 @@ public class StandbyContainerManager {\n \n   boolean checkStandbyConstraintsHelper(String containerIdToStart, String hostToStartContainerOn, SamzaResource existingResource, String existingContainerID) {\n     if (existingResource != null) {\n-      if (faultDomainManager.hasSameFaultDomains(hostToStartContainerOn, existingResource.getHost())) {\n+      ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n+      if (clusterManagerConfig.getFaultDomainAwareStandbyEnabled() && faultDomainManager.hasSameFaultDomains(hostToStartContainerOn, existingResource.getHost())) {\n         log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n                 containerIdToStart, hostToStartContainerOn, existingContainerID);\n         if (StandbyTaskUtil.isStandbyContainer(containerIdToStart)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQxNDkzMg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r543414932", "bodyText": "What are your thoughts on repurposing this configuration under ClusterManagerConfig something like cluster-manager.fault-domain-aware.standby.enabled?\nHere are some of the reasons why i think it will be useful\n\nWe will need a kill switch in samza core to ensure we can turn off the usage of FaultDomainManager.\nCurrent implementation forces FaultDomainManager is present regardless of its usage in the code path and does work even if this flag is turned off resulting in half-baked experience and unnecessary work.\nWhile specific implementation can have cut off switches, implementations can make consistent assumptions that the information necessary for rack-aware a.k.a fault domain aware requests will be provided by the samza core as part of SamzaResourceRequest if its enabled in the core.\nProvides room for optimizations where the request constraints aren't used for the scenarios where its disabled at the core but still turned on at the cluster level.", "author": "mynameborat", "createdAt": "2020-12-15T14:53:41Z", "path": "samza-yarn/src/main/java/org/apache/samza/config/YarnConfig.java", "diffHunk": "@@ -49,6 +49,11 @@\n    */\n   public static final String CONTAINER_LABEL = \"yarn.container.label\";\n \n+  /**\n+   * Determines whether standby allocation is rack aware or not.\n+   */\n+  public static final String RACK_AWARE_STANDBY_ENABLED = \"yarn.rack-aware.standby.enabled\";\n+", "originalCommit": "51970921b94ab7972b4380520204fc9af7b62dd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4OTE5MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545289191", "bodyText": "Thanks for the suggestion. I agree with you. 2 is especially important and I was trying to look for a way around that.", "author": "PawasChhokra", "createdAt": "2020-12-17T17:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQxNDkzMg=="}], "type": "inlineReview", "revised_code": {"commit": "2932ede88f3f9790e664244deb6caf6a8207305f", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/config/YarnConfig.java b/samza-yarn/src/main/java/org/apache/samza/config/YarnConfig.java\nindex 1146c46f1..4b37a8114 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/config/YarnConfig.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/config/YarnConfig.java\n\n@@ -49,11 +49,6 @@ public class YarnConfig extends MapConfig {\n    */\n   public static final String CONTAINER_LABEL = \"yarn.container.label\";\n \n-  /**\n-   * Determines whether standby allocation is rack aware or not.\n-   */\n-  public static final String RACK_AWARE_STANDBY_ENABLED = \"yarn.rack-aware.standby.enabled\";\n-\n   // Configs related to the Samza Application Master (AM)\n   /**\n    * (Optional) JVM options to include in the command line when executing the AM\n"}}, {"oid": "2932ede88f3f9790e664244deb6caf6a8207305f", "url": "https://github.com/apache/samza/commit/2932ede88f3f9790e664244deb6caf6a8207305f", "message": "Address comments", "committedDate": "2020-12-17T16:26:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4MzYzNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545283635", "bodyText": "Sounds like this method is overloaded and has implicit contracts.\ne.g., when the incoming host is not present it returns all the fault domains of the cluster which isn't clear and should be the case.\nEither we should rename the method and call out the implication of having an empty input parameter or just simplify the contract of the method and not overload it.\nI'd prefer latter since\n\nGetting the allowed fault domain vs resorting to something may differ at the caller's end.\nGetting all the fault domains seems straight forward call to faultDomainManager\nAdditionally, optionals are suitable for returns but taking optional parameter is highly discouraged where possible. Ideally, you want callers to determine on how they want to handle downstream call in the absence of input data and not the downstream method themself.", "author": "mynameborat", "createdAt": "2020-12-17T17:49:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -168,11 +173,13 @@ public void handleContainerStopFail(String containerID, String resourceID,\n    * @param host The hostname of the active container\n    * @return the set of racks on which this active container's standby can be scheduled\n    */\n-  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(String host) {\n-    Set<FaultDomain> activeContainerRack = faultDomainManager.getFaultDomainOfHost(host);\n-    Set<FaultDomain> standbyRacks = faultDomainManager.getAllFaultDomains();\n-    standbyRacks.removeAll(activeContainerRack);\n-    return standbyRacks;\n+  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(Optional<String> host) {\n+    Set<FaultDomain> standbyFaultDomain = faultDomainManager.getAllFaultDomains();\n+    if (host.isPresent()) {\n+      Set<FaultDomain> activeContainerFaultDomain = faultDomainManager.getFaultDomainsForHost(host.get());\n+      standbyFaultDomain.removeAll(activeContainerFaultDomain);\n+    }\n+    return standbyFaultDomain;", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEzODE0NQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547138145", "bodyText": "I've extracted out the simplified part of the method in a separate method (getAllowedFaultDomainsForStandbyContainerGivenActiveContainerHost), and am doing extra overloaded functionalities in the parent method (getAllowedFaultDomainsForStandbyContainerGivenHostToExclude). This way, the caller can decide which method to invoke. Also, I've removed Optional from the argument.  Let me know if this makes sense to you.", "author": "PawasChhokra", "createdAt": "2020-12-22T08:30:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4MzYzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex a91193ba2..2c64cec48 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -167,18 +166,35 @@ public class StandbyContainerManager {\n   }\n \n   /**\n-   * This method gets the set of racks that the given active container's corresponding standby can be placed on.\n-   * The set of racks returned is based on the set difference between the active container's racks,\n-   * and all the available racks in the cluster based on the host to fault domain cache.\n+   * Given the active/standby container's container ID, this method returns the allowed fault domains that the given\n+   * active container's corresponding standby can be placed on.\n+   *\n+   * @param containerID Standby or active container container ID\n+   * @return The set of fault domains allowed for the given active container's corresponding standby\n+   */\n+  public Set<FaultDomain> getAllowedFaultDomainsForStandbyContainerGivenContainerId(String containerID) {\n+    Optional<String> activeContainerHost = getActiveContainerHost(containerID);\n+    Set<FaultDomain> faultDomains;\n+    if (activeContainerHost.isPresent()) {\n+      faultDomains = getAllowedFaultDomainsForStandbyContainerGivenActiveContainerHost(activeContainerHost.get());\n+    } else {\n+      faultDomains = faultDomainManager.getAllFaultDomains();\n+    }\n+    return faultDomains;\n+  }\n+\n+  /**\n+   * Given the active container's hostname, this method gets the set of fault domains that the given active container's\n+   * corresponding standby can be placed on.\n+   * The set of fault domains returned is based on the set difference between the active container's fault domain,\n+   * and all the available fault domains in the cluster based on the host to fault domain cache.\n    * @param host The hostname of the active container\n-   * @return the set of racks on which this active container's standby can be scheduled\n+   * @return the set of fault domains on which this active container's standby can be scheduled\n    */\n-  public Set<FaultDomain> getAllowedFaultDomainsForSchedulingStandbyContainer(Optional<String> host) {\n+  public Set<FaultDomain> getAllowedFaultDomainsForStandbyContainerGivenActiveContainerHost(String host) {\n     Set<FaultDomain> standbyFaultDomain = faultDomainManager.getAllFaultDomains();\n-    if (host.isPresent()) {\n-      Set<FaultDomain> activeContainerFaultDomain = faultDomainManager.getFaultDomainsForHost(host.get());\n-      standbyFaultDomain.removeAll(activeContainerFaultDomain);\n-    }\n+    Set<FaultDomain> activeContainerFaultDomain = faultDomainManager.getFaultDomainsForHost(host);\n+    standbyFaultDomain.removeAll(activeContainerFaultDomain);\n     return standbyFaultDomain;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NTExOQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545285119", "bodyText": "nit: make it static", "author": "mynameborat", "createdAt": "2020-12-17T17:51:57Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java", "diffHunk": "@@ -43,20 +42,24 @@\n public class YarnFaultDomainManager implements FaultDomainManager {\n \n   private Multimap<String, FaultDomain> hostToRackMap;\n-  private final SamzaApplicationState state;\n   private final YarnClientImpl yarnClient;\n+  private final MetricsRegistry metricsRegistry;\n+  private final String groupName = \"yarn-fault-domain-manager\";", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex ebc998716..2abdc3f4c 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -41,25 +42,27 @@ import org.apache.samza.metrics.MetricsRegistry;\n  */\n public class YarnFaultDomainManager implements FaultDomainManager {\n \n+  private static final String FAULT_DOMAIN_MANAGER_GROUP = \"yarn-fault-domain-manager\";\n+  private static final String HOST_TO_FAULT_DOMAIN_CACHE_UPDATES = \"host-to-fault-domain-cache-updates\";\n   private Multimap<String, FaultDomain> hostToRackMap;\n   private final YarnClientImpl yarnClient;\n-  private final MetricsRegistry metricsRegistry;\n-  private final String groupName = \"yarn-fault-domain-manager\";\n   private Counter hostToFaultDomainCacheUpdates;\n \n   public YarnFaultDomainManager(MetricsRegistry metricsRegistry) {\n     this.yarnClient = new YarnClientImpl();\n+    yarnClient.init(new YarnConfiguration());\n+    yarnClient.start();\n     this.hostToRackMap = computeHostToFaultDomainMap();\n-    this.metricsRegistry = metricsRegistry;\n-    initMetrics();\n+    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(FAULT_DOMAIN_MANAGER_GROUP, HOST_TO_FAULT_DOMAIN_CACHE_UPDATES);\n   }\n \n   @VisibleForTesting\n   YarnFaultDomainManager(MetricsRegistry metricsRegistry, YarnClientImpl yarnClient, Multimap<String, FaultDomain> hostToRackMap) {\n     this.yarnClient = yarnClient;\n+    yarnClient.init(new YarnConfiguration());\n+    yarnClient.start();\n     this.hostToRackMap = hostToRackMap;\n-    this.metricsRegistry = metricsRegistry;\n-    initMetrics();\n+    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(FAULT_DOMAIN_MANAGER_GROUP, HOST_TO_FAULT_DOMAIN_CACHE_UPDATES);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NTY1OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545285659", "bodyText": "why not inline? what are we getting by extracting it to a method?", "author": "mynameborat", "createdAt": "2020-12-17T17:52:40Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java", "diffHunk": "@@ -117,4 +120,8 @@ public boolean hasSameFaultDomains(String host1, String host2) {\n     }\n     return hostToRackMap;\n   }\n+\n+  private void initMetrics() {\n+    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(groupName, \"host-to-fault-domain-cache-updates\");\n+  }", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTU0OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546189549", "bodyText": "I extracted it just in case we add other metrics in the future. Having said that, I don't see any other metrics being needed as of now, so have inlined.", "author": "PawasChhokra", "createdAt": "2020-12-19T04:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI4NTY1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex ebc998716..2abdc3f4c 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -121,7 +124,4 @@ public class YarnFaultDomainManager implements FaultDomainManager {\n     return hostToRackMap;\n   }\n \n-  private void initMetrics() {\n-    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(groupName, \"host-to-fault-domain-cache-updates\");\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxNzAyNg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545317026", "bodyText": "seems like the logging is now impacted and different from the previous flow in the absence of rack aware standby.\ni.e. this method gets invoked with pendingResource and runningResource and seems both will end up printing as scheduled on this host", "author": "mynameborat", "createdAt": "2020-12-17T18:40:49Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,24 +421,39 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(String containerIdToStart, String hostToStartContainerOn, SamzaResource existingResource, String existingContainerID) {\n+    if (existingResource != null) {\n+      ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n+      if (clusterManagerConfig.getFaultDomainAwareStandbyEnabled() && faultDomainManager.hasSameFaultDomains(hostToStartContainerOn, existingResource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                containerIdToStart, hostToStartContainerOn, existingContainerID);\n+        if (StandbyTaskUtil.isStandbyContainer(containerIdToStart)) {\n+          samzaApplicationState.failedFaultDomainAwareContainerAllocations.incrementAndGet();\n+        }\n+        return false;\n+      } else if (existingResource.getHost().equals(hostToStartContainerOn)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, hostToStartContainerOn, existingContainerID);", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MTMyNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545351327", "bodyText": "im a little confused how the logging is impacted.\nEarlier it was\nif (resource != null && resource.getHost().equals(host)) { log.info(\"..running on this host\",\nNow it is\nif (existingResource != null) { // if rack aware enabled } else if (existingResource.getHost().equals(hostToStartContainerOn)) { log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\"\nDid you mean to say the exact log message is changed?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxNzAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM4MDI0Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545380246", "bodyText": "that is correct. the logging message is changed and it also means semantic difference during debugging to differentiate  if its pending code path that triggered this vs running code path that triggered this", "author": "mynameborat", "createdAt": "2020-12-17T20:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxNzAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4ODgzOA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546188838", "bodyText": "Thanks for noticing the logging difference. I've added a parameter to the helper method to log differently in each case.", "author": "PawasChhokra", "createdAt": "2020-12-19T04:19:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxNzAyNg=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex a91193ba2..2c64cec48 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -421,13 +454,13 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"pending\")) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"running\")) {\n         return false;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxOTI2Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545319267", "bodyText": "can we not inline this within checkStandbyConstraints? doesn't seem much to be extracted plus you don't need to recreate ClusterManagerConfig for every invocation and plus addresses the problem I raised above about logging being different.", "author": "mynameborat", "createdAt": "2020-12-17T18:44:26Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,24 +421,39 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n         return false;\n       }\n     }\n \n     return true;\n   }\n \n+  boolean checkStandbyConstraintsHelper(String containerIdToStart, String hostToStartContainerOn, SamzaResource existingResource, String existingContainerID) {\n+    if (existingResource != null) {\n+      ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n+      if (clusterManagerConfig.getFaultDomainAwareStandbyEnabled() && faultDomainManager.hasSameFaultDomains(hostToStartContainerOn, existingResource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this rack\",\n+                containerIdToStart, hostToStartContainerOn, existingContainerID);\n+        if (StandbyTaskUtil.isStandbyContainer(containerIdToStart)) {\n+          samzaApplicationState.failedFaultDomainAwareContainerAllocations.incrementAndGet();\n+        }\n+        return false;\n+      } else if (existingResource.getHost().equals(hostToStartContainerOn)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, hostToStartContainerOn, existingContainerID);", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4ODg5Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546188896", "bodyText": "Instead of making this inline, I added a parameter for the log to avoid code duplication and also made ClusterManagerConfig as a parameter. Let me know if that makes sense to you.", "author": "PawasChhokra", "createdAt": "2020-12-19T04:20:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxOTI2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex a91193ba2..2c64cec48 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -421,13 +454,13 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"pending\")) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID)) {\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"running\")) {\n         return false;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNTY3OA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545335678", "bodyText": "is it possible getFaultDomains returns null? because the expired metric increment checks for it.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:09:17Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -381,6 +428,9 @@ public final void issueResourceRequest(SamzaResourceRequest request) {\n     } else {\n       state.preferredHostRequests.incrementAndGet();\n     }\n+    if (!request.getFaultDomains().isEmpty()) {", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE1MzQxNQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546153415", "bodyText": "No, I double checked and this should never be null. I will remove the null check for the expiredFaultDomainAwareContainerRequests metric. Thanks!", "author": "PawasChhokra", "createdAt": "2020-12-18T23:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNTY3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzNzQ0Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545337446", "bodyText": "nit: java doc is a copy of above :P", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:12:21Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -170,6 +170,26 @@\n    */\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n+  /**\n+   * Number of fault domain aware container requests made for a container.\n+   */\n+  public final AtomicInteger faultDomainAwareContainerRequests = new AtomicInteger(0);\n+\n+  /**\n+   * Number of fault domain aware container requests made for a container.", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\nindex 3fcb2b567..f13bff396 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n\n@@ -171,22 +171,22 @@ public class SamzaApplicationState {\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n   /**\n-   * Number of fault domain aware container requests made for a container.\n+   * Number of fault domain aware container requests made for a job.\n    */\n   public final AtomicInteger faultDomainAwareContainerRequests = new AtomicInteger(0);\n \n   /**\n-   * Number of fault domain aware container requests made for a container.\n+   * Number of fault domain aware containers started for a job.\n    */\n   public final AtomicInteger faultDomainAwareContainersStarted = new AtomicInteger(0);\n \n   /**\n-   * Number of expired fault domain aware container requests made for a container.\n+   * Number of expired fault domain aware container requests made for a job.\n    */\n   public final AtomicInteger expiredFaultDomainAwareContainerRequests = new AtomicInteger(0);\n \n   /**\n-   * Number of failed fault domain aware container allocations made for a container.\n+   * Number of failed fault domain aware container allocations for a job.\n    */\n   public final AtomicInteger failedFaultDomainAwareContainerAllocations = new AtomicInteger(0);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzODE3Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545338176", "bodyText": "nit: wondering if this reads as though \"# of requests per container\" -- whereas we want to communicate \"# of requests by job\" right? not too strong about this. okay to drop. if changing, pl do for rest of the things below", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:13:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java", "diffHunk": "@@ -170,6 +170,26 @@\n    */\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n+  /**\n+   * Number of fault domain aware container requests made for a container.", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE2NjQyNw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546166427", "bodyText": "Yes it should be a for a job. Changed that in the documentation everywhere. Thanks :)", "author": "PawasChhokra", "createdAt": "2020-12-19T01:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMzODE3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\nindex 3fcb2b567..f13bff396 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/SamzaApplicationState.java\n\n@@ -171,22 +171,22 @@ public class SamzaApplicationState {\n   public final AtomicInteger failedContainerPlacementActions = new AtomicInteger(0);\n \n   /**\n-   * Number of fault domain aware container requests made for a container.\n+   * Number of fault domain aware container requests made for a job.\n    */\n   public final AtomicInteger faultDomainAwareContainerRequests = new AtomicInteger(0);\n \n   /**\n-   * Number of fault domain aware container requests made for a container.\n+   * Number of fault domain aware containers started for a job.\n    */\n   public final AtomicInteger faultDomainAwareContainersStarted = new AtomicInteger(0);\n \n   /**\n-   * Number of expired fault domain aware container requests made for a container.\n+   * Number of expired fault domain aware container requests made for a job.\n    */\n   public final AtomicInteger expiredFaultDomainAwareContainerRequests = new AtomicInteger(0);\n \n   /**\n-   * Number of failed fault domain aware container allocations made for a container.\n+   * Number of failed fault domain aware container allocations for a job.\n    */\n   public final AtomicInteger failedFaultDomainAwareContainerAllocations = new AtomicInteger(0);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTE0Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545345143", "bodyText": "i feel this should also be guarded the config -- we would want the flow to be exactly same as earlier when config is off right.\nSame for other requests made.\nsince yarnclusterResourceManager honors the fault domains only when config = on, im okay with dropping it since though the code is changing when config=off, the flow does not change.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:25:14Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -181,13 +207,14 @@ private void handleStandbyContainerStop(String standbyContainerID, String resour\n \n       // request standbycontainer's host for active-container\n       SamzaResourceRequest resourceRequestForActive =\n-          containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);\n+        containerAllocator.getResourceRequestWithDelay(activeContainerID, standbyContainerHostname, preferredHostRetryDelay);\n       // record the resource request, before issuing it to avoid race with allocation-thread\n       failoverMetadata.get().recordResourceRequest(resourceRequestForActive);\n       containerAllocator.issueResourceRequest(resourceRequestForActive);\n \n       // request any-host for standby container\n-      containerAllocator.requestResource(standbyContainerID, ResourceRequestState.ANY_HOST);\n+      containerAllocator.requestResource(standbyContainerID, ResourceRequestState.ANY_HOST,", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTAwNA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546189004", "bodyText": "I thought about this a lot and I think it makes sense to not alter the current flow at all in case the config is turned on. Hence I have now added that check for every requestResource.", "author": "PawasChhokra", "createdAt": "2020-12-19T04:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0NTE0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex a91193ba2..2c64cec48 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -213,8 +229,7 @@ public class StandbyContainerManager {\n       containerAllocator.issueResourceRequest(resourceRequestForActive);\n \n       // request any-host for standby container\n-      containerAllocator.requestResource(standbyContainerID, ResourceRequestState.ANY_HOST,\n-              getAllowedFaultDomainsForSchedulingStandbyContainer(Optional.of(standbyContainerHostname)));\n+      checkFaultDomainAwarenessEnabledAndRequestResource(containerAllocator, standbyContainerID, ResourceRequestState.ANY_HOST);\n     } else {\n       log.info(\"Issuing request for standby container {} on host {}, since this is not for a failover\",\n           standbyContainerID, preferredHost);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NDIxNg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545354216", "bodyText": "this will increment and emit metrics even when config=off right?\nare we okay with that?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:40:04Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -409,16 +470,18 @@ public void checkStandbyConstraintsAndRunStreamProcessor(SamzaResourceRequest re\n       log.info(\"Running container {} on {} meets standby constraints, preferredHost = {}\", containerID,\n           samzaResource.getHost(), preferredHost);\n       containerAllocator.runStreamProcessor(request, preferredHost);\n+      samzaApplicationState.faultDomainAwareContainersStarted.incrementAndGet();", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE5MjY4Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546192683", "bodyText": "I've added a check that will ensure that this metric is updated only when that config is on.", "author": "PawasChhokra", "createdAt": "2020-12-19T05:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NDIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex a91193ba2..2c64cec48 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -470,15 +503,16 @@ public class StandbyContainerManager {\n       log.info(\"Running container {} on {} meets standby constraints, preferredHost = {}\", containerID,\n           samzaResource.getHost(), preferredHost);\n       containerAllocator.runStreamProcessor(request, preferredHost);\n-      samzaApplicationState.faultDomainAwareContainersStarted.incrementAndGet();\n+      if (isFaultDomainAwareStandbyEnabled()) {\n+        samzaApplicationState.faultDomainAwareContainersStarted.incrementAndGet();\n+      }\n     } else if (StandbyTaskUtil.isStandbyContainer(containerID)) {\n       // This resource cannot be used to launch this standby container, so we make a new anyhost request\n       log.info(\n           \"Running standby container {} on host {} does not meet standby constraints, cancelling resource request, releasing resource, and making a new ANY_HOST request\",\n           containerID, samzaResource.getHost());\n       releaseUnstartableContainer(request, samzaResource, preferredHost, resourceRequestState);\n-      containerAllocator.requestResource(containerID, ResourceRequestState.ANY_HOST,\n-              getAllowedFaultDomainsForSchedulingStandbyContainer(getActiveContainerHost(containerID)));\n+      checkFaultDomainAwarenessEnabledAndRequestResource(containerAllocator, containerID, ResourceRequestState.ANY_HOST);\n       samzaApplicationState.failedStandbyAllocations.incrementAndGet();\n     } else {\n       // This resource cannot be used to launch this active container, so we initiate a failover\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1NTYzMw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r545355633", "bodyText": "nit: might be nice to just keep default value=\"false\" in FAULT_DOMAIN_AWARE_STANDBY_ENABLED_DEFUALT=false.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-17T19:42:29Z", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -250,6 +258,14 @@ public String getContainerManagerClass() {\n     return get(CLUSTER_MANAGER_FACTORY, CLUSTER_MANAGER_FACTORY_DEFAULT);\n   }\n \n+  public String getFaultDomainManagerClass() {\n+    return get(FAULT_DOMAIN_MANAGER_FACTORY, FAULT_DOMAIN_MANAGER_FACTORY_DEFAULT);\n+  }\n+\n+  public boolean getFaultDomainAwareStandbyEnabled() {\n+    return getBoolean(FAULT_DOMAIN_AWARE_STANDBY_ENABLED, false);", "originalCommit": "2932ede88f3f9790e664244deb6caf6a8207305f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java b/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\nindex 8fd6ea508..3f279911b 100644\n--- a/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\n+++ b/samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java\n\n@@ -263,7 +264,7 @@ public class ClusterManagerConfig extends MapConfig {\n   }\n \n   public boolean getFaultDomainAwareStandbyEnabled() {\n-    return getBoolean(FAULT_DOMAIN_AWARE_STANDBY_ENABLED, false);\n+    return getBoolean(FAULT_DOMAIN_AWARE_STANDBY_ENABLED, FAULT_DOMAIN_AWARE_STANDBY_ENABLED_DEFAULT);\n   }\n \n   public boolean getJmxEnabledOnJobCoordinator() {\n"}}, {"oid": "48aff32e97e1322331d74d22e4fb005e8c60de82", "url": "https://github.com/apache/samza/commit/48aff32e97e1322331d74d22e4fb005e8c60de82", "message": "Address comments", "committedDate": "2020-12-19T06:08:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyNzQzMg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546927432", "bodyText": "Can be more efficient and determine if it is enabled in constructor and use an instance variable to infer if its enabled?\nStoring config seems unnecessary and creating ClusterManagerConfig on the fly for invocation seems sub-optimal.", "author": "mynameborat", "createdAt": "2020-12-21T21:01:27Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -469,6 +566,10 @@ void releaseUnstartableContainer(SamzaResourceRequest request, SamzaResource res\n     resourceRequestState.cancelResourceRequest(request);\n   }\n \n+  private boolean isFaultDomainAwareStandbyEnabled() {\n+    ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n+    return clusterManagerConfig.getFaultDomainAwareStandbyEnabled();\n+  }", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex 2c64cec48..fd8a4ffb1 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -566,11 +589,6 @@ public class StandbyContainerManager {\n     resourceRequestState.cancelResourceRequest(request);\n   }\n \n-  private boolean isFaultDomainAwareStandbyEnabled() {\n-    ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n-    return clusterManagerConfig.getFaultDomainAwareStandbyEnabled();\n-  }\n-\n   // Handle an expired resource request that was made for placing a standby container\n   private void handleExpiredRequestForStandbyContainer(String containerID, SamzaResourceRequest request,\n       Optional<SamzaResource> alternativeResource, ContainerAllocator containerAllocator,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyNzU2Mg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546927562", "bodyText": "Consistency: keep the new parameters at the end.", "author": "mynameborat", "createdAt": "2020-12-21T21:01:46Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -56,8 +58,13 @@\n   // Resource-manager, used to stop containers\n   private ClusterResourceManager clusterResourceManager;\n \n-  public StandbyContainerManager(SamzaApplicationState samzaApplicationState,\n-      ClusterResourceManager clusterResourceManager, LocalityManager localityManager) {\n+  // FaultDomainManager, used to get fault domain information of different hosts from the cluster manager.\n+  private final FaultDomainManager faultDomainManager;\n+\n+  private final Config config;\n+\n+  public StandbyContainerManager(SamzaApplicationState samzaApplicationState, ClusterResourceManager clusterResourceManager,\n+                                 FaultDomainManager faultDomainManager, LocalityManager localityManager, Config config) {", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex 2c64cec48..fd8a4ffb1 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -63,8 +63,10 @@ public class StandbyContainerManager {\n \n   private final Config config;\n \n+  private final boolean isFaultDomainAwareStandbyEnabled;\n+\n   public StandbyContainerManager(SamzaApplicationState samzaApplicationState, ClusterResourceManager clusterResourceManager,\n-                                 FaultDomainManager faultDomainManager, LocalityManager localityManager, Config config) {\n+                                 LocalityManager localityManager, Config config, FaultDomainManager faultDomainManager) {\n     this.failovers = new ConcurrentHashMap<>();\n     this.localityManager = localityManager;\n     this.standbyContainerConstraints = new HashMap<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyODM2OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546928369", "bodyText": "boiler plate since the function introduced below in this PR already does this.\ncontext: checkFaultDomainAwarenessEnabledAndRequestResource", "author": "mynameborat", "createdAt": "2020-12-21T21:03:51Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -233,9 +275,13 @@ private void initiateStandbyAwareAllocation(String activeContainerID, String res\n             standbyHost, activeContainerID, standbyHost, resourceID);\n         FailoverMetadata failoverMetadata = this.registerActiveContainerFailure(activeContainerID, resourceID);\n \n+        Set<FaultDomain> allowedFaultDomains = new HashSet<>();\n+        if (isFaultDomainAwareStandbyEnabled()) {\n+          allowedFaultDomains = getAllowedFaultDomainsForStandbyContainerGivenContainerId(activeContainerID);\n+        }\n         // record the resource request, before issuing it to avoid race with allocation-thread\n         SamzaResourceRequest resourceRequestForActive =\n-            containerAllocator.getResourceRequest(activeContainerID, standbyHost);\n+                containerAllocator.getResourceRequest(activeContainerID, standbyHost, allowedFaultDomains);", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEyMDA2Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547120067", "bodyText": "I've simplified this now as explained in the next comment.", "author": "PawasChhokra", "createdAt": "2020-12-22T07:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyODM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex 2c64cec48..fd8a4ffb1 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -275,13 +291,8 @@ public class StandbyContainerManager {\n             standbyHost, activeContainerID, standbyHost, resourceID);\n         FailoverMetadata failoverMetadata = this.registerActiveContainerFailure(activeContainerID, resourceID);\n \n-        Set<FaultDomain> allowedFaultDomains = new HashSet<>();\n-        if (isFaultDomainAwareStandbyEnabled()) {\n-          allowedFaultDomains = getAllowedFaultDomainsForStandbyContainerGivenContainerId(activeContainerID);\n-        }\n         // record the resource request, before issuing it to avoid race with allocation-thread\n-        SamzaResourceRequest resourceRequestForActive =\n-                containerAllocator.getResourceRequest(activeContainerID, standbyHost, allowedFaultDomains);\n+        SamzaResourceRequest resourceRequestForActive = getResourceRequest(containerAllocator, activeContainerID, standbyHost, activeContainerHost);\n         failoverMetadata.recordResourceRequest(resourceRequestForActive);\n         containerAllocator.issueResourceRequest(resourceRequestForActive);\n         samzaApplicationState.failoversToStandby.incrementAndGet();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyOTYwMg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546929602", "bodyText": "nit: I'd prefer to rename the method to requestResource since the intent of the method that way is clear. i.e. only request resource and potentially return the SamzaResourceRequest.\nWhat and how it does to request resource is kept within and can be inferred by reading the method implementation. The name seems too long and the fact that this returns void makes it unusable in some places which has the exact boiler plate code.", "author": "mynameborat", "createdAt": "2020-12-21T21:06:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -361,8 +407,41 @@ private FailoverMetadata registerActiveContainerFailure(String activeContainerID\n   }\n \n   /**\n-   * Check if matching this SamzaResourceRequest to the given resource, meets all standby-container container constraints.\n+   * This method checks from the config if standby allocation is fault domain aware or not, and requests resources accordingly.\n+   *\n+   * @param containerAllocator ContainerAllocator object that requests for resources from the resource manager\n+   * @param containerID Samza container ID that will be run when a resource is allocated for this request\n+   * @param preferredHost name of the host that you prefer to run the processor on\n+   */\n+  void checkFaultDomainAwarenessEnabledAndRequestResource(ContainerAllocator containerAllocator, String containerID, String preferredHost) {", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzExOTc2Nw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547119767", "bodyText": "Makes sense. However, I've renamed the method to getResourceRequest and extracted the issueResourceRequest part out of it since the place mentioned in the above comment inside initiateStandbyAwareAllocation also records the resource request separately before issuing to avoid race conditions.", "author": "PawasChhokra", "createdAt": "2020-12-22T07:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjkyOTYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex 2c64cec48..fd8a4ffb1 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -412,12 +423,13 @@ public class StandbyContainerManager {\n    * @param containerAllocator ContainerAllocator object that requests for resources from the resource manager\n    * @param containerID Samza container ID that will be run when a resource is allocated for this request\n    * @param preferredHost name of the host that you prefer to run the processor on\n+   * @param hostToAvoid The hostname to avoid requesting this resource on if fault domain aware standby allocation is enabled\n    */\n-  void checkFaultDomainAwarenessEnabledAndRequestResource(ContainerAllocator containerAllocator, String containerID, String preferredHost) {\n-    if (isFaultDomainAwareStandbyEnabled()) {\n-      containerAllocator.requestResource(containerID, preferredHost, getAllowedFaultDomainsForStandbyContainerGivenContainerId(containerID));\n+  SamzaResourceRequest getResourceRequest(ContainerAllocator containerAllocator, String containerID, String preferredHost, String hostToAvoid) {\n+    if (isFaultDomainAwareStandbyEnabled) {\n+      return containerAllocator.getResourceRequest(containerID, preferredHost, getAllowedFaultDomainsForStandbyContainerGivenHostToExclude(hostToAvoid));\n     } else {\n-      containerAllocator.requestResource(containerID, preferredHost, new HashSet<>());\n+      return containerAllocator.getResourceRequest(containerID, preferredHost, new HashSet<>());\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk2Nzg4OA==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546967888", "bodyText": "I still feel this is unclean to me especially passing in parameters that are not necessarily relevant to the core of what the method is responsible for. e.g., \"pending\" vs \"running\" which is purely for logging and isn't state per say and one realizes until reading through the code underneath.\nIf you don't want to inline and still feel refactor would help and make it clear, i'd suggest extracting the existing logic into checkActiveAndStandbyOnSameHost and then add your logic into checkActiveAndStandbyOnSameFaultDomain and within checkStandbyConstraints you can fire off both of these checks or one of them based on the fault domain enabled or not.", "author": "mynameborat", "createdAt": "2020-12-21T22:48:36Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -375,24 +454,39 @@ boolean checkStandbyConstraints(String containerIdToStart, String host) {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"pending\")) {\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (resource != null && resource.getHost().equals(host)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n-            containerIdToStart, host, containerID);\n+      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"running\")) {", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzEwMTI2Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547101266", "bodyText": "Got it. I've inlined the method as you suggested.", "author": "PawasChhokra", "createdAt": "2020-12-22T06:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk2Nzg4OA=="}], "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex 2c64cec48..fd8a4ffb1 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -454,36 +470,37 @@ public class StandbyContainerManager {\n       SamzaResource resource = samzaApplicationState.pendingProcessors.get(containerID);\n \n       // return false if a conflicting container is pending for launch on the host\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"pending\")) {\n+      if (resource != null && isFaultDomainAwareStandbyEnabled\n+              && faultDomainManager.hasSameFaultDomains(host, resource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this fault domain\",\n+                containerIdToStart, host, containerID);\n+        if (StandbyTaskUtil.isStandbyContainer(containerIdToStart)) {\n+          samzaApplicationState.failedFaultDomainAwareContainerAllocations.incrementAndGet();\n+        }\n+        return false;\n+      } else if (resource != null && resource.getHost().equals(host)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already scheduled on this host\",\n+                containerIdToStart, host, containerID);\n         return false;\n       }\n \n       // return false if a conflicting container is running on the host\n       resource = samzaApplicationState.runningProcessors.get(containerID);\n-      if (!checkStandbyConstraintsHelper(containerIdToStart, host, resource, containerID, \"running\")) {\n-        return false;\n-      }\n-    }\n-\n-    return true;\n-  }\n-\n-  boolean checkStandbyConstraintsHelper(String containerIdToStart, String hostToStartContainerOn,\n-                                        SamzaResource existingResource, String existingContainerID, String containerState) {\n-    if (existingResource != null) {\n-      if (isFaultDomainAwareStandbyEnabled() && faultDomainManager.hasSameFaultDomains(hostToStartContainerOn, existingResource.getHost())) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already {} on this fault domain\",\n-                containerIdToStart, hostToStartContainerOn, existingContainerID, containerState);\n+      if (resource != null && isFaultDomainAwareStandbyEnabled\n+              && faultDomainManager.hasSameFaultDomains(host, resource.getHost())) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already running on this fault domain\",\n+                containerIdToStart, host, containerID);\n         if (StandbyTaskUtil.isStandbyContainer(containerIdToStart)) {\n           samzaApplicationState.failedFaultDomainAwareContainerAllocations.incrementAndGet();\n         }\n         return false;\n-      } else if (existingResource.getHost().equals(hostToStartContainerOn)) {\n-        log.info(\"Container {} cannot be started on host {} because container {} is already {} on this host\",\n-                containerIdToStart, hostToStartContainerOn, existingContainerID, containerState);\n+      } else if (resource != null && resource.getHost().equals(host)) {\n+        log.info(\"Container {} cannot be started on host {} because container {} is already running on this host\",\n+                containerIdToStart, host, containerID);\n         return false;\n       }\n     }\n+\n     return true;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njk2ODI4Ng==", "url": "https://github.com/apache/samza/pull/1446#discussion_r546968286", "bodyText": "nit: package private instead if it is only used for testing.", "author": "mynameborat", "createdAt": "2020-12-21T22:49:46Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.job.yarn;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.HashMultimap;\n+import com.google.common.collect.Multimap;\n+import java.io.IOException;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import org.apache.hadoop.yarn.api.records.NodeReport;\n+import org.apache.hadoop.yarn.api.records.NodeState;\n+import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n+import org.apache.hadoop.yarn.conf.YarnConfiguration;\n+import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.clustermanager.FaultDomain;\n+import org.apache.samza.clustermanager.FaultDomainManager;\n+import org.apache.samza.clustermanager.FaultDomainType;\n+import org.apache.samza.metrics.Counter;\n+import org.apache.samza.metrics.MetricsRegistry;\n+\n+/**\n+ * This class functionality works with the assumption that the job.standbytasks.replication.factor is 2.\n+ * For values greater than 2, it is possible that the standby containers could be on the same rack as the active, or the already existing standby racks.\n+ */\n+public class YarnFaultDomainManager implements FaultDomainManager {\n+\n+  private static final String FAULT_DOMAIN_MANAGER_GROUP = \"yarn-fault-domain-manager\";\n+  private static final String HOST_TO_FAULT_DOMAIN_CACHE_UPDATES = \"host-to-fault-domain-cache-updates\";\n+  private Multimap<String, FaultDomain> hostToRackMap;\n+  private final YarnClientImpl yarnClient;\n+  private Counter hostToFaultDomainCacheUpdates;\n+\n+  public YarnFaultDomainManager(MetricsRegistry metricsRegistry) {\n+    this.yarnClient = new YarnClientImpl();\n+    yarnClient.init(new YarnConfiguration());\n+    yarnClient.start();\n+    this.hostToRackMap = computeHostToFaultDomainMap();\n+    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(FAULT_DOMAIN_MANAGER_GROUP, HOST_TO_FAULT_DOMAIN_CACHE_UPDATES);\n+  }\n+\n+  @VisibleForTesting\n+  YarnFaultDomainManager(MetricsRegistry metricsRegistry, YarnClientImpl yarnClient, Multimap<String, FaultDomain> hostToRackMap) {\n+    this.yarnClient = yarnClient;\n+    yarnClient.init(new YarnConfiguration());\n+    yarnClient.start();\n+    this.hostToRackMap = hostToRackMap;\n+    hostToFaultDomainCacheUpdates = metricsRegistry.newCounter(FAULT_DOMAIN_MANAGER_GROUP, HOST_TO_FAULT_DOMAIN_CACHE_UPDATES);\n+  }\n+\n+  /**\n+   * This method returns all the last cached rack values in a cluster, for all hosts that are healthy, up and running.\n+   * @return a set of {@link FaultDomain}s\n+   */\n+  @Override\n+  public Set<FaultDomain> getAllFaultDomains() {\n+    return new HashSet<>(hostToRackMap.values());\n+  }\n+\n+  /**\n+   * This method returns the rack a particular host resides on based on the internal cache.\n+   * In case the rack of a host does not exist in this cache, we update the cache by computing the host to rack map again using Yarn.\n+   * @param host the host\n+   * @return the {@link FaultDomain}\n+   */\n+  @Override\n+  public Set<FaultDomain> getFaultDomainsForHost(String host) {\n+    if (!hostToRackMap.containsKey(host)) {\n+      hostToRackMap = computeHostToFaultDomainMap();\n+      hostToFaultDomainCacheUpdates.inc();\n+    }\n+    return new HashSet<>(hostToRackMap.get(host));\n+  }\n+\n+  /**\n+   * This method checks if the two hostnames provided reside on the same rack.\n+   * @param host1 hostname\n+   * @param host2 hostname\n+   * @return true if the hosts exist on the same rack\n+   */\n+  @Override\n+  public boolean hasSameFaultDomains(String host1, String host2) {\n+    if (!hostToRackMap.keySet().contains(host1) || !hostToRackMap.keySet().contains(host2)) {\n+      hostToRackMap = computeHostToFaultDomainMap();\n+      hostToFaultDomainCacheUpdates.inc();\n+    }\n+    return hostToRackMap.get(host1).equals(hostToRackMap.get(host2));\n+  }\n+\n+  /**\n+   * This method computes the host to rack map from Yarn.\n+   * Only the hosts that are running in the cluster will be a part of this map.\n+   * @return map of the host and the rack it resides on\n+   */\n+  @VisibleForTesting\n+  protected Multimap<String, FaultDomain> computeHostToFaultDomainMap() {", "originalCommit": "48aff32e97e1322331d74d22e4fb005e8c60de82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\nindex 2abdc3f4c..8bcd48c29 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnFaultDomainManager.java\n\n@@ -30,11 +30,14 @@ import org.apache.hadoop.yarn.api.records.NodeState;\n import org.apache.hadoop.yarn.client.api.impl.YarnClientImpl;\n import org.apache.hadoop.yarn.conf.YarnConfiguration;\n import org.apache.hadoop.yarn.exceptions.YarnException;\n+import org.apache.samza.SamzaException;\n import org.apache.samza.clustermanager.FaultDomain;\n import org.apache.samza.clustermanager.FaultDomainManager;\n import org.apache.samza.clustermanager.FaultDomainType;\n import org.apache.samza.metrics.Counter;\n import org.apache.samza.metrics.MetricsRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n /**\n  * This class functionality works with the assumption that the job.standbytasks.replication.factor is 2.\n"}}, {"oid": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "url": "https://github.com/apache/samza/commit/9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "message": "Address review", "committedDate": "2020-12-22T17:07:31Z", "type": "commit"}, {"oid": "b871543bf45434915de9f764e4cc277638f99329", "url": "https://github.com/apache/samza/commit/b871543bf45434915de9f764e4cc277638f99329", "message": "Revert issueResourceRequest changes and few changes", "committedDate": "2020-12-23T02:03:17Z", "type": "commit"}, {"oid": "b871543bf45434915de9f764e4cc277638f99329", "url": "https://github.com/apache/samza/commit/b871543bf45434915de9f764e4cc277638f99329", "message": "Revert issueResourceRequest changes and few changes", "committedDate": "2020-12-23T02:03:17Z", "type": "forcePushed"}, {"oid": "6d85519b54407ac61f15b5cbc24cdda3132d7b34", "url": "https://github.com/apache/samza/commit/6d85519b54407ac61f15b5cbc24cdda3132d7b34", "message": "Merge remote-tracking branch 'origin' into RackAwareContainerRequest", "committedDate": "2020-12-23T04:39:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTg3Mw==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547409873", "bodyText": "can be simplified to\nreturn Optional.of(resource)\n    .map(SamzaResourceRequest::getHost)", "author": "mynameborat", "createdAt": "2020-12-22T17:38:33Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -436,7 +448,11 @@ void checkFaultDomainAwarenessEnabledAndRequestResource(ContainerAllocator conta\n     if (resource == null) {\n       resource = samzaApplicationState.runningProcessors.get(activeContainerId);\n     }\n-    return Optional.ofNullable(resource.getHost());\n+    if (resource != null) {\n+      return Optional.ofNullable(resource.getHost());\n+    } else {\n+      return Optional.empty();\n+    }", "originalCommit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f5df3f2deb14bb3b13619fc196fcd275d23a76e8", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex fd8a4ffb1..bc80730a8 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -448,11 +445,8 @@ public class StandbyContainerManager {\n     if (resource == null) {\n       resource = samzaApplicationState.runningProcessors.get(activeContainerId);\n     }\n-    if (resource != null) {\n-      return Optional.ofNullable(resource.getHost());\n-    } else {\n-      return Optional.empty();\n-    }\n+    return Optional.of(resource)\n+            .map(SamzaResource::getHost);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxMTQ5MQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547411491", "bodyText": "can be simplified to\nactiveContainerHost = getActiveContainerHost(containerID)\n   .orElse(null);", "author": "mynameborat", "createdAt": "2020-12-22T17:42:00Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -512,7 +529,13 @@ public void checkStandbyConstraintsAndRunStreamProcessor(SamzaResourceRequest re\n           \"Running standby container {} on host {} does not meet standby constraints, cancelling resource request, releasing resource, and making a new ANY_HOST request\",\n           containerID, samzaResource.getHost());\n       releaseUnstartableContainer(request, samzaResource, preferredHost, resourceRequestState);\n-      checkFaultDomainAwarenessEnabledAndRequestResource(containerAllocator, containerID, ResourceRequestState.ANY_HOST);\n+      Optional<String> activeContainerHostOpt = getActiveContainerHost(containerID);\n+      String activeContainerHost = null;\n+      if (activeContainerHostOpt.isPresent()) {\n+        activeContainerHost = activeContainerHostOpt.get();\n+      }", "originalCommit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b871543bf45434915de9f764e4cc277638f99329", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex fd8a4ffb1..d2d1579c4 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -534,8 +537,7 @@ public class StandbyContainerManager {\n       if (activeContainerHostOpt.isPresent()) {\n         activeContainerHost = activeContainerHostOpt.get();\n       }\n-      SamzaResourceRequest resourceRequest = getResourceRequest(containerAllocator, containerID, ResourceRequestState.ANY_HOST, activeContainerHost);\n-      containerAllocator.issueResourceRequest(resourceRequest);\n+      requestResource(containerAllocator, containerID, ResourceRequestState.ANY_HOST, Duration.ZERO, activeContainerHost);\n       samzaApplicationState.failedStandbyAllocations.incrementAndGet();\n     } else {\n       // This resource cannot be used to launch this active container, so we initiate a failover\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNDk3Mg==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547414972", "bodyText": "remove config since you have already persisted the switch in the boolean.", "author": "mynameborat", "createdAt": "2020-12-22T17:48:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java", "diffHunk": "@@ -56,8 +58,15 @@\n   // Resource-manager, used to stop containers\n   private ClusterResourceManager clusterResourceManager;\n \n-  public StandbyContainerManager(SamzaApplicationState samzaApplicationState,\n-      ClusterResourceManager clusterResourceManager, LocalityManager localityManager) {\n+  // FaultDomainManager, used to get fault domain information of different hosts from the cluster manager.\n+  private final FaultDomainManager faultDomainManager;\n+\n+  private final Config config;", "originalCommit": "9ea8b94bb0f2944f37d3c0c6fdd530dea129ef89", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f5df3f2deb14bb3b13619fc196fcd275d23a76e8", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\nindex fd8a4ffb1..bc80730a8 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/StandbyContainerManager.java\n\n@@ -61,8 +61,6 @@ public class StandbyContainerManager {\n   // FaultDomainManager, used to get fault domain information of different hosts from the cluster manager.\n   private final FaultDomainManager faultDomainManager;\n \n-  private final Config config;\n-\n   private final boolean isFaultDomainAwareStandbyEnabled;\n \n   public StandbyContainerManager(SamzaApplicationState samzaApplicationState, ClusterResourceManager clusterResourceManager,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNjY5OQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r547636699", "bodyText": "What do you think about not having control flow here and pass empty array instead of null if it doesn't change things semantically in YARN?\nBy doing so, you will just eliminate unnecessary control flow and given faultDomains is guaranteed to be empty or present, null handling is not necessary as well.", "author": "mynameborat", "createdAt": "2020-12-23T04:46:19Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -241,6 +241,11 @@ public void requestResources(SamzaResourceRequest resourceRequest) {\n     String processorId = resourceRequest.getProcessorId();\n     String requestId = resourceRequest.getRequestId();\n     String preferredHost = resourceRequest.getPreferredHost();\n+    String[] racks = null;\n+    ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n+    if (clusterManagerConfig.getFaultDomainAwareStandbyEnabled()) {\n+      racks = resourceRequest.getFaultDomains().stream().map(FaultDomain::getId).toArray(String[]::new);\n+    }", "originalCommit": "6d85519b54407ac61f15b5cbc24cdda3132d7b34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM3MjgwMQ==", "url": "https://github.com/apache/samza/pull/1446#discussion_r548372801", "bodyText": "Sure, that makes sense. I've removed the unnecessary check.", "author": "PawasChhokra", "createdAt": "2020-12-24T04:04:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzYzNjY5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f5df3f2deb14bb3b13619fc196fcd275d23a76e8", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\nindex 1fef1b07f..ccdd00ffa 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n\n@@ -241,11 +241,7 @@ public class YarnClusterResourceManager extends ClusterResourceManager implement\n     String processorId = resourceRequest.getProcessorId();\n     String requestId = resourceRequest.getRequestId();\n     String preferredHost = resourceRequest.getPreferredHost();\n-    String[] racks = null;\n-    ClusterManagerConfig clusterManagerConfig = new ClusterManagerConfig(config);\n-    if (clusterManagerConfig.getFaultDomainAwareStandbyEnabled()) {\n-      racks = resourceRequest.getFaultDomains().stream().map(FaultDomain::getId).toArray(String[]::new);\n-    }\n+    String[] racks = resourceRequest.getFaultDomains().stream().map(FaultDomain::getId).toArray(String[]::new);\n     int memoryMb = resourceRequest.getMemoryMB();\n     int cpuCores = resourceRequest.getNumCores();\n     Resource capability = Resource.newInstance(memoryMb, cpuCores);\n"}}, {"oid": "8ed4575f83cae526d693a442ff8ae522c97607b0", "url": "https://github.com/apache/samza/commit/8ed4575f83cae526d693a442ff8ae522c97607b0", "message": "Fix merge conflict issues", "committedDate": "2020-12-23T23:01:26Z", "type": "commit"}, {"oid": "8ed4575f83cae526d693a442ff8ae522c97607b0", "url": "https://github.com/apache/samza/commit/8ed4575f83cae526d693a442ff8ae522c97607b0", "message": "Fix merge conflict issues", "committedDate": "2020-12-23T23:01:26Z", "type": "forcePushed"}, {"oid": "f5df3f2deb14bb3b13619fc196fcd275d23a76e8", "url": "https://github.com/apache/samza/commit/f5df3f2deb14bb3b13619fc196fcd275d23a76e8", "message": "Address review", "committedDate": "2020-12-24T04:02:32Z", "type": "commit"}, {"oid": "27376302a844186fc0af59184bef63ec934f66a2", "url": "https://github.com/apache/samza/commit/27376302a844186fc0af59184bef63ec934f66a2", "message": "Final fixes", "committedDate": "2020-12-24T09:56:02Z", "type": "commit"}, {"oid": "de3c9910751c9fd0eaa976043f357ab740b032e1", "url": "https://github.com/apache/samza/commit/de3c9910751c9fd0eaa976043f357ab740b032e1", "message": "Final fixes", "committedDate": "2020-12-24T18:08:07Z", "type": "commit"}, {"oid": "633cead096f44a930b004ff7c3019a0d2512e15d", "url": "https://github.com/apache/samza/commit/633cead096f44a930b004ff7c3019a0d2512e15d", "message": "Minor changes to getActiveContainerHost and initiateStandbyAwareAllocation", "committedDate": "2020-12-24T18:34:15Z", "type": "commit"}]}