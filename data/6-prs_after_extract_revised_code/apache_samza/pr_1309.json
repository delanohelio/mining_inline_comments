{"pr_number": 1309, "pr_title": "SAMZA-2453: Update ClusterBasedJobCoordinator to support Beam jobs", "pr_createdAt": "2020-03-10T00:51:13Z", "pr_url": "https://github.com/apache/samza/pull/1309", "timeline": [{"oid": "4b403581e61756a054508d9c67b61adcde559a5c", "url": "https://github.com/apache/samza/commit/4b403581e61756a054508d9c67b61adcde559a5c", "message": "SAMZA-2471: Simplify CommandLine\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n1. Simplify CommandLine by removing unnecessary arguments.\n\nAPI Changes:\n1. config-loader-factory removed in CommandLine\n2. config-loader-properties removed in CommandLine\n\nUpgrade Instruction:\n1. Usage of --config-factory and --config-loader-factory will be switched to --config job.config.loader.factory\n2. Usage of --config-path and --config-loader-properties will be switched to --config job.config.loader.properties\n\nUsage Instruction\n\n--config-factory=org.apache.samza.config.factories.PropertiesConfigFactory --config-path=file:///location/file.txt\nand\n--config-loader-factory=org.apache.samza.config.loaders.PropertiesConfigLoaderFactory --config-loader-properties path=file:///location/file.txt\nwill be updated to\n--config job.config.loader.factory=org.apache.samza.config.loaders.PropertiesConfigLoaderFactory --config job.config.loader.properties.path=file:///location/file.txt\n\nTests\n\n1. Unit tests\n2. Test against Hello Samza example with\ndeploy/samza/bin/run-app.sh --config job.config.loader.factory=org.apache.samza.config.loaders.PropertiesConfigLoaderFactory --config job.loader.properties.path=$PWD/deploy/samza/config/wikipedia-feed.properties", "committedDate": "2020-02-25T21:47:35Z", "type": "commit"}, {"oid": "dd045f19dd8745fb3c6839f3183df4e088ad3676", "url": "https://github.com/apache/samza/commit/dd045f19dd8745fb3c6839f3183df4e088ad3676", "message": "Update", "committedDate": "2020-02-25T22:33:20Z", "type": "commit"}, {"oid": "fb11970ec6ca12c6ee1605a6e9bc91b378bf777f", "url": "https://github.com/apache/samza/commit/fb11970ec6ca12c6ee1605a6e9bc91b378bf777f", "message": "Update", "committedDate": "2020-02-25T22:34:00Z", "type": "commit"}, {"oid": "278b70651e8f53a8dde6eba7f394e5ccc8dc8dae", "url": "https://github.com/apache/samza/commit/278b70651e8f53a8dde6eba7f394e5ccc8dc8dae", "message": "Update", "committedDate": "2020-02-25T22:47:01Z", "type": "commit"}, {"oid": "84d9fd57873adee773ac9e14f887760c5fe2bfee", "url": "https://github.com/apache/samza/commit/84d9fd57873adee773ac9e14f887760c5fe2bfee", "message": "Update", "committedDate": "2020-02-26T00:18:12Z", "type": "commit"}, {"oid": "3d11af1583789b4aa1634ec0ab1725b82ec48430", "url": "https://github.com/apache/samza/commit/3d11af1583789b4aa1634ec0ab1725b82ec48430", "message": "Update", "committedDate": "2020-02-26T17:47:44Z", "type": "commit"}, {"oid": "c304241fc2c07fd8c5686ba597545ee8576e4d1b", "url": "https://github.com/apache/samza/commit/c304241fc2c07fd8c5686ba597545ee8576e4d1b", "message": "Dummy Commit to trigger tests", "committedDate": "2020-02-26T18:41:40Z", "type": "commit"}, {"oid": "be4b6199a738042dfef0eb0953f9a74a39e5d5de", "url": "https://github.com/apache/samza/commit/be4b6199a738042dfef0eb0953f9a74a39e5d5de", "message": "Trigger test", "committedDate": "2020-02-26T19:31:36Z", "type": "commit"}, {"oid": "fa1deb7891dfadbeace40dcb482249c3f4162b4e", "url": "https://github.com/apache/samza/commit/fa1deb7891dfadbeace40dcb482249c3f4162b4e", "message": "Merge branch 'master' of https://github.com/apache/samza", "committedDate": "2020-02-26T21:32:27Z", "type": "commit"}, {"oid": "c95ea9a2e649af4a78d1d7bb65b8738431fab337", "url": "https://github.com/apache/samza/commit/c95ea9a2e649af4a78d1d7bb65b8738431fab337", "message": "Merge branch 'master' of https://github.com/apache/samza", "committedDate": "2020-03-02T18:20:03Z", "type": "commit"}, {"oid": "13e37eded0f77a9d86aab10bf0cb402fc1f73c62", "url": "https://github.com/apache/samza/commit/13e37eded0f77a9d86aab10bf0cb402fc1f73c62", "message": "Merge branch 'master' of https://github.com/apache/samza", "committedDate": "2020-03-02T22:01:08Z", "type": "commit"}, {"oid": "b66905a691963723ba0556c561cb1d06fb5ea55b", "url": "https://github.com/apache/samza/commit/b66905a691963723ba0556c561cb1d06fb5ea55b", "message": "Merge branch 'master' of https://github.com/apache/samza", "committedDate": "2020-03-05T23:43:33Z", "type": "commit"}, {"oid": "34367093eb3438cba445a9c6769fbf2749187282", "url": "https://github.com/apache/samza/commit/34367093eb3438cba445a9c6769fbf2749187282", "message": "SAMZA-2482: Add app.main.class and app.main.args in ApplicationConfig\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n1. Add app.main.class to ApplicationConfig\n2. Add app.main.args to ApplicationConfig\n\nAPI Changes:\n\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\nUpgrade Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\nUsage Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nTests:\nN/A.", "committedDate": "2020-03-09T21:53:25Z", "type": "commit"}, {"oid": "db4ce1115b2151b661e2673b0f3384504fb81bb9", "url": "https://github.com/apache/samza/commit/db4ce1115b2151b661e2673b0f3384504fb81bb9", "message": "Merge branch 'master' of https://github.com/apache/samza", "committedDate": "2020-03-10T00:28:25Z", "type": "commit"}, {"oid": "3b3cb4f1dbc6c158742806878386fdc62a1b8213", "url": "https://github.com/apache/samza/commit/3b3cb4f1dbc6c158742806878386fdc62a1b8213", "message": "SAMZA-2453: Update ClusterBasedJobCoordinator to support Beam jobs\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n\n1. Invoke app.main.class with app.main.args when present instead of invoking ClusterBasedJobCoordinator#run\n\nAPI Changes:\n\nN/A\n\nUpgrade Instructions:\n\nFor beam jobs, beam's main class and pipeline options need to passed with app.main.class and app.main.args configs.\n\nUsage Instructions:\n\nTake https://github.com/apache/samza-beam-examples as an example:\n\n1. run-beam-yarn.sh#line 36 will be updated to\n\nexec $(dirname $0)/run-class.sh $1 --config app.main.class=$1 --config app.main.args=\"--runner=org.apache.beam.runners.samza.SamzaRunner --configOverride=\\\"$override\\\" \\\"${@:2}\\\"\"\n\nTests:\nN/A.", "committedDate": "2020-03-10T00:30:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MTE0OQ==", "url": "https://github.com/apache/samza/pull/1309#discussion_r390451149", "bodyText": "Please add some comments about the use cases here for Beam. what's the expected main/args being passed in and what are we going to do with them.", "author": "xinyuiscool", "createdAt": "2020-03-10T16:36:15Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -551,8 +553,23 @@ private static void runClusterBasedJobCoordinator(String[] args) {\n         throw new SamzaException(e);\n       }\n \n-      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n-      jc.run();\n+      ApplicationConfig appConfig = new ApplicationConfig(submissionConfig);\n+\n+      if (appConfig.getAppMainClass().isPresent()) {", "originalCommit": "3b3cb4f1dbc6c158742806878386fdc62a1b8213", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2Mzc0Nw==", "url": "https://github.com/apache/samza/pull/1309#discussion_r390463747", "bodyText": "Added", "author": "kw2542", "createdAt": "2020-03-10T16:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MTE0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "bd3380abccbbf055c02fd056cb360bff7e9e7b03", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\nindex 69c5f1fa8..ab98b5f59 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n\n@@ -555,6 +555,10 @@ public class ClusterBasedJobCoordinator {\n \n       ApplicationConfig appConfig = new ApplicationConfig(submissionConfig);\n \n+      /*\n+       * Invoke app.main.class with app.main.args when present.\n+       * For Beam jobs, app.main.class will be Beam's main class\n+       */\n       if (appConfig.getAppMainClass().isPresent()) {\n         String className = appConfig.getAppMainClass().get();\n         LOG.info(\"Invoke main {}\", className);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MTUwNQ==", "url": "https://github.com/apache/samza/pull/1309#discussion_r390451505", "bodyText": "is there else part being used right now?", "author": "xinyuiscool", "createdAt": "2020-03-10T16:36:44Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -634,4 +651,20 @@ static ClusterBasedJobCoordinator createFromConfigLoader(Config submissionConfig\n         metadataStore,\n         config);\n   }\n+\n+  @VisibleForTesting\n+  static String[] toArgs(ApplicationConfig config) {\n+    List<String> args = new ArrayList<>(config.size() * 2);\n+\n+    config.forEach((key, value) -> {\n+      if (key.equals(ApplicationConfig.APP_MAIN_ARGS)) {\n+        args.addAll(Arrays.asList(value.split(\"\\\\s\")));\n+      } else {", "originalCommit": "3b3cb4f1dbc6c158742806878386fdc62a1b8213", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MzY2NQ==", "url": "https://github.com/apache/samza/pull/1309#discussion_r390463665", "bodyText": "Yes,\nif block is to pass native Beam pipeline options such as\n--runner=SamzaRunner --maxSourceParallelism=1024\nelse block is to change other native samza configs with --config key=value, such as\n--config job.name=beam-test", "author": "kw2542", "createdAt": "2020-03-10T16:54:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MTUwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "bd3380abccbbf055c02fd056cb360bff7e9e7b03", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\nindex 69c5f1fa8..ab98b5f59 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n\n@@ -652,19 +656,33 @@ public class ClusterBasedJobCoordinator {\n         config);\n   }\n \n+  /**\n+   * Convert Samza config to command line arguments to invoke app.main.class\n+   *\n+   * @param config Samza config to convert.\n+   * @return converted command line arguments.\n+   */\n   @VisibleForTesting\n   static String[] toArgs(ApplicationConfig config) {\n     List<String> args = new ArrayList<>(config.size() * 2);\n \n     config.forEach((key, value) -> {\n-      if (key.equals(ApplicationConfig.APP_MAIN_ARGS)) {\n-        args.addAll(Arrays.asList(value.split(\"\\\\s\")));\n-      } else {\n-        args.add(\"--config\");\n-        args.add(String.format(\"%s=%s\", key, value));\n-      }\n-    });\n+        if (key.equals(ApplicationConfig.APP_MAIN_ARGS)) {\n+          /*\n+           * Converts native beam pipeline options such as\n+           * --runner=SamzaRunner --maxSourceParallelism=1024\n+           */\n+          args.addAll(Arrays.asList(value.split(\"\\\\s\")));\n+        } else {\n+          /*\n+           * Converts native Samza configs to config override format such as\n+           * --config job.name=test\n+           */\n+          args.add(\"--config\");\n+          args.add(String.format(\"%s=%s\", key, value));\n+        }\n+      });\n \n-   return args.toArray(new String[0]);\n+    return args.toArray(new String[0]);\n   }\n }\n"}}, {"oid": "bd3380abccbbf055c02fd056cb360bff7e9e7b03", "url": "https://github.com/apache/samza/commit/bd3380abccbbf055c02fd056cb360bff7e9e7b03", "message": "Add comments to clarify the new flow.", "committedDate": "2020-03-10T17:01:07Z", "type": "commit"}, {"oid": "8c52501c6e73ce8047a5e4e79187f0f072c26e2d", "url": "https://github.com/apache/samza/commit/8c52501c6e73ce8047a5e4e79187f0f072c26e2d", "message": "Add more comments", "committedDate": "2020-03-10T17:02:35Z", "type": "commit"}]}