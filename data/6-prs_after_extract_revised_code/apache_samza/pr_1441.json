{"pr_number": 1441, "pr_title": "SAMZA-2601: avoid infinite loop on container allocation", "pr_createdAt": "2020-11-16T18:19:58Z", "pr_url": "https://github.com/apache/samza/pull/1441", "timeline": [{"oid": "6665098b25bad4061083e549ca57d556eb51788c", "url": "https://github.com/apache/samza/commit/6665098b25bad4061083e549ca57d556eb51788c", "message": "SAMZA-2601: avoid infinite loop when resource not allocated with host affinity disabled", "committedDate": "2020-11-16T18:21:21Z", "type": "commit"}, {"oid": "6665098b25bad4061083e549ca57d556eb51788c", "url": "https://github.com/apache/samza/commit/6665098b25bad4061083e549ca57d556eb51788c", "message": "SAMZA-2601: avoid infinite loop when resource not allocated with host affinity disabled", "committedDate": "2020-11-16T18:21:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAzMjgyMQ==", "url": "https://github.com/apache/samza/pull/1441#discussion_r528032821", "bodyText": "Replace it with something like this:\nLOG.info(\"Waiting for resources to get allocated for request {}, no retries will be issued since host affinity is disabled\", request);", "author": "Sanil15", "createdAt": "2020-11-21T00:06:12Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java", "diffHunk": "@@ -234,6 +234,12 @@ void assignResourceRequests() {\n         if (isRequestExpired(request)) {\n           updateExpiryMetrics(request);\n           containerManager.handleExpiredRequest(processorId, preferredHost, request, this, resourceRequestState);\n+          // SAMZA-2601: to prevent infinite looping and logs filling up the disk, when host affinity is disabled,\n+          // we explicitly break the loop here and the whole process gets retried in run() after allocatorSleepIntervalMs\n+          if (!hostAffinityEnabled) {\n+            LOG.info(\"Host affinity is disabled on expired request.\");", "originalCommit": "6665098b25bad4061083e549ca57d556eb51788c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a58125bb57071996a698370e260419a2a403d0d4", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\nindex 390b4dcf6..fa5f78300 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ContainerAllocator.java\n\n@@ -237,7 +237,8 @@ public class ContainerAllocator implements Runnable {\n           // SAMZA-2601: to prevent infinite looping and logs filling up the disk, when host affinity is disabled,\n           // we explicitly break the loop here and the whole process gets retried in run() after allocatorSleepIntervalMs\n           if (!hostAffinityEnabled) {\n-            LOG.info(\"Host affinity is disabled on expired request.\");\n+            LOG.info(\"Waiting for resources to get allocated for request {},\"\n+                + \" no retries will be issued since host affinity is disabled\", request);\n             break;\n           }\n         } else {\n"}}, {"oid": "a58125bb57071996a698370e260419a2a403d0d4", "url": "https://github.com/apache/samza/commit/a58125bb57071996a698370e260419a2a403d0d4", "message": "update log messages based on feedback", "committedDate": "2020-11-22T00:51:33Z", "type": "commit"}]}