{"pr_number": 1403, "pr_title": "SAMZA-2569: Add features into StreamAppender", "pr_createdAt": "2020-07-25T04:09:02Z", "pr_url": "https://github.com/apache/samza/pull/1403", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjg4Nw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r460992887", "bodyText": "Im just wondering if there is a better way than making all private variables protected?\nMaybe have another constructor which sets all these variables\nand a getter for the variables you intend to use in the extended class?", "author": "lakshmi-manasa-g", "createdAt": "2020-07-27T15:53:40Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -67,48 +69,52 @@\n import org.apache.samza.system.SystemStream;\n import org.apache.samza.util.ExponentialSleepStrategy;\n import org.apache.samza.util.HttpUtil;\n+import org.apache.samza.util.MetricsReporterLoader;\n import org.apache.samza.util.ReflectionUtil;\n \n @Plugin(name = \"Stream\", category = \"Core\", elementType = \"appender\", printObject = true)\n public class StreamAppender extends AbstractAppender {\n \n-  private static final String JAVA_OPTS_CONTAINER_NAME = \"samza.container.name\";\n-  private static final String JOB_COORDINATOR_TAG = \"samza-job-coordinator\";\n-  private static final String SOURCE = \"log4j-log\";\n+  protected static final String JAVA_OPTS_CONTAINER_NAME = \"samza.container.name\";\n+  protected static final String JOB_COORDINATOR_TAG = \"samza-job-coordinator\";\n+  protected static final String SOURCE = \"log4j-log\";", "originalCommit": "0a1392cf23469d6ca634d290c40cdb10f25ecda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3MDE3NA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461270174", "bodyText": "In my use case (extend existing StreamAppender), I do use small pieces of the changed variables. Just in case in the future, we want to expose more objects or just make extend-friendly feature thoroughly, I prefer to modify all necessary variables (seem useful for child classes) to protected instead of only changing the variables that I intend to use.", "author": "byjiang1996", "createdAt": "2020-07-28T01:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczNzc2Mw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461737763", "bodyText": "within Samza i see classes which have only some of their variables exposed as protected and keep the rest private. So i think it is an acceptable pattern to have partial protected. We can expose more as the need arises.\nSo the current need to extend is coming from having a usecase to support another transformation right .. this PR can \"make the parts extendable for different transformation/serde\" and that i believe will be acceptable too.", "author": "lakshmi-manasa-g", "createdAt": "2020-07-28T17:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk3NTA4Nw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461975087", "bodyText": "@bkonold Do you have ideas about this issue?", "author": "byjiang1996", "createdAt": "2020-07-29T00:51:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjg4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY0MjU3MQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r462642571", "bodyText": "Agree I've seen partial protection in several places of Samza so I think it would be fine here. Labeling only what you need to as protected is also better for the reader because it will restrict the set of functionality a subclass can override. IMO, I'd be in favor of labeling only what you need to as protected.", "author": "bkonold", "createdAt": "2020-07-29T23:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk5Mjg4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "80ec86bfb1669ee6716ef609a1371b1a7343789f", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 94ced7826..f95f3b930 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -75,35 +75,35 @@ import org.apache.samza.util.ReflectionUtil;\n @Plugin(name = \"Stream\", category = \"Core\", elementType = \"appender\", printObject = true)\n public class StreamAppender extends AbstractAppender {\n \n-  protected static final String JAVA_OPTS_CONTAINER_NAME = \"samza.container.name\";\n-  protected static final String JOB_COORDINATOR_TAG = \"samza-job-coordinator\";\n-  protected static final String SOURCE = \"log4j-log\";\n+  private static final String JAVA_OPTS_CONTAINER_NAME = \"samza.container.name\";\n+  private static final String JOB_COORDINATOR_TAG = \"samza-job-coordinator\";\n+  private static final String SOURCE = \"log4j-log\";\n \n   // Hidden config for now. Will move to appropriate Config class when ready to.\n   private static final String CREATE_STREAM_ENABLED = \"task.log4j.create.stream.enabled\";\n \n   protected static final int DEFAULT_QUEUE_SIZE = 100;\n-  protected static final long DEFAULT_QUEUE_TIMEOUT_S = 2; // Abitrary choice\n+  private static final long DEFAULT_QUEUE_TIMEOUT_S = 2; // Abitrary choice\n \n   protected static volatile boolean systemInitialized = false;\n \n   protected Config config = null;\n-  protected SystemStream systemStream = null;\n-  protected SystemProducer systemProducer = null;\n-  protected String key = null;\n+  private SystemStream systemStream = null;\n+  private SystemProducer systemProducer = null;\n+  private String key = null;\n   protected String streamName = null;\n   protected String appenderName = null;\n-  protected String containerName = null;\n-  protected int partitionCount = 0;\n-  protected boolean isApplicationMaster;\n-  protected Serde<LogEvent> serde = null;\n+  private String containerName = null;\n+  private int partitionCount = 0;\n+  private boolean isApplicationMaster;\n+  private Serde<LogEvent> serde = null;\n   protected Logger log = LogManager.getLogger(StreamAppender.class);\n   protected StreamAppenderMetrics metrics;\n \n-  protected final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n+  private final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n   protected long queueTimeoutS = DEFAULT_QUEUE_TIMEOUT_S;\n \n-  protected Thread transferThread;\n+  private Thread transferThread;\n \n   protected StreamAppender(String name, Filter filter, Layout<? extends Serializable> layout, boolean ignoreExceptions, String streamName) {\n     super(name, filter, layout, ignoreExceptions);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMjY0Mg==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461022642", "bodyText": "can the appenderName be anything other than the class name - here StreamAppender?\nWould getClass() suffice here instead of another variable?", "author": "lakshmi-manasa-g", "createdAt": "2020-07-27T16:40:28Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -214,7 +220,7 @@ public void append(LogEvent event) {\n           metrics.bufferFillPct.set(Math.round(100f * logQueue.size() / DEFAULT_QUEUE_SIZE));\n         }\n       } catch (Exception e) {\n-        System.err.println(\"[StreamAppender] Error sending log message:\");\n+        System.err.println(String.format(\"[%s] Error sending log message:\", appenderName));", "originalCommit": "0a1392cf23469d6ca634d290c40cdb10f25ecda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzODQ4Ng==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461238486", "bodyText": "Yes. it will be the same as what we write in log4j2.xml\ne.g.\n<Appender type=\"Stream\" name=\"<whatismyname>\">\n      <Layout type=\"PatternLayout\" pattern=\"xxx\"/>\n</Appender>\n\nThen, the appenderName is . This name should be unique in the log4j2.xml.", "author": "byjiang1996", "createdAt": "2020-07-28T00:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczODUyNg==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461738526", "bodyText": "I understand that log4j2.xml should have the Java class name of the appender.\nmy question was if we can drop the variable \"appenderName\" and get it from getClass().getName instead", "author": "lakshmi-manasa-g", "createdAt": "2020-07-28T17:08:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMjY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkzNjAyMw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461936023", "bodyText": "Seems appenderName is better to be used here because theoretically it is possible that multiple instances of StreamAppender (or its child appenders) are used at the same time. But appenderName is really a unique name for different appender instances (it does not need to be the same as \"StreamAppender\"; it can be any name if users want) which is set in log4j2.xml", "author": "byjiang1996", "createdAt": "2020-07-28T22:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAyMjY0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "acaeb22d2f1697064f03de4434327de50696ed59", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 94ced7826..f8dcde81e 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -220,6 +220,9 @@ public class StreamAppender extends AbstractAppender {\n           metrics.bufferFillPct.set(Math.round(100f * logQueue.size() / DEFAULT_QUEUE_SIZE));\n         }\n       } catch (Exception e) {\n+        if (metrics != null) { // setupSystem() may not have been invoked yet so metrics can be null here.\n+          metrics.logMessagesErrors.inc();\n+        }\n         System.err.println(String.format(\"[%s] Error sending log message:\", appenderName));\n         e.printStackTrace();\n       } finally {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNjAzMw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461036033", "bodyText": "just curious why this is being hardcoded..", "author": "lakshmi-manasa-g", "createdAt": "2020-07-27T17:01:29Z", "path": "samza-log4j2/src/test/java/org/apache/samza/logging/log4j2/TestStreamAppender.java", "diffHunk": "@@ -68,13 +68,12 @@ public void testDefaultSerde() {\n   @Test\n   public void testNonDefaultSerde() {\n     System.setProperty(\"samza.container.name\", \"samza-container-1\");\n-    String streamName = StreamAppender.getStreamName(\"log4jTest\", \"1\");\n     Map<String, String> map = new HashMap<String, String>();\n     map.put(\"job.name\", \"log4jTest\");\n     map.put(\"job.id\", \"1\");\n     map.put(\"serializers.registry.log4j-string.class\", LoggingEventStringSerdeFactory.class.getCanonicalName());\n     map.put(\"systems.mock.samza.factory\", MockSystemFactory.class.getCanonicalName());\n-    map.put(\"systems.mock.streams.\" + streamName + \".samza.msg.serde\", \"log4j-string\");\n+    map.put(\"systems.mock.streams.__samza_log4jTest_1_logs.samza.msg.serde\", \"log4j-string\");", "originalCommit": "0a1392cf23469d6ca634d290c40cdb10f25ecda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIzOTE0OA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461239148", "bodyText": "Because getStreamName function is changed from protected static  to protected as static method cannot be overridden.\nBTW, this static use case only exists here in samza's code. Seems good to remove static keyword.", "author": "byjiang1996", "createdAt": "2020-07-28T00:04:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNjAzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNjY1NQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r461036655", "bodyText": "should we add a metric to count the number of logging errors?", "author": "lakshmi-manasa-g", "createdAt": "2020-07-27T17:02:26Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -368,24 +389,24 @@ private void startTransferThread() {\n             // Preserve the interrupted status for the loop condition.\n             Thread.currentThread().interrupt();\n           } catch (Throwable t) {\n-            log.error(\"Error sending StreamAppender event to SystemProducer\", t);\n+            log.error(\"Error sending \" + appenderName +\" event to SystemProducer\", t);", "originalCommit": "0a1392cf23469d6ca634d290c40cdb10f25ecda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUwNDIzNw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r462504237", "bodyText": "make sense to me. Added now.", "author": "byjiang1996", "createdAt": "2020-07-29T18:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNjY1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "e57bcb97648e578e42a7aaff22e984a244593c65", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 94ced7826..de3413fd9 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -389,7 +401,7 @@ public class StreamAppender extends AbstractAppender {\n             // Preserve the interrupted status for the loop condition.\n             Thread.currentThread().interrupt();\n           } catch (Throwable t) {\n-            log.error(\"Error sending \" + appenderName +\" event to SystemProducer\", t);\n+            log.error(\"Error sending \" + appenderName + \" event to SystemProducer\", t);\n           }\n         }\n       };\n"}}, {"oid": "e57bcb97648e578e42a7aaff22e984a244593c65", "url": "https://github.com/apache/samza/commit/e57bcb97648e578e42a7aaff22e984a244593c65", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-07-28T00:34:09Z", "type": "forcePushed"}, {"oid": "acaeb22d2f1697064f03de4434327de50696ed59", "url": "https://github.com/apache/samza/commit/acaeb22d2f1697064f03de4434327de50696ed59", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-07-29T18:32:00Z", "type": "forcePushed"}, {"oid": "80ec86bfb1669ee6716ef609a1371b1a7343789f", "url": "https://github.com/apache/samza/commit/80ec86bfb1669ee6716ef609a1371b1a7343789f", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-07-29T23:56:56Z", "type": "forcePushed"}, {"oid": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "url": "https://github.com/apache/samza/commit/e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-07-30T00:03:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MTUwMg==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463391502", "bodyText": "can we organize by modifier for readability? to see everything in one place that might be modified by a subclass", "author": "bkonold", "createdAt": "2020-07-31T03:52:38Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -84,15 +87,17 @@\n \n   protected static volatile boolean systemInitialized = false;\n \n-  private Config config = null;\n+  protected Config config = null;\n   private SystemStream systemStream = null;\n   private SystemProducer systemProducer = null;\n   private String key = null;\n-  private String streamName = null;\n+  protected String streamName = null;\n+  protected String appenderName = null;\n+  private String containerName = null;\n   private int partitionCount = 0;\n   private boolean isApplicationMaster;\n   private Serde<LogEvent> serde = null;\n-  private Logger log = LogManager.getLogger(StreamAppender.class);\n+  protected Logger log = LogManager.getLogger(StreamAppender.class);\n   protected StreamAppenderMetrics metrics;", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcyNzEyOQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463727129", "bodyText": "Sure.", "author": "byjiang1996", "createdAt": "2020-07-31T17:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM5MTUwMg=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 98e0286db..f1114c30a 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -82,28 +82,31 @@ public class StreamAppender extends AbstractAppender {\n   // Hidden config for now. Will move to appropriate Config class when ready to.\n   private static final String CREATE_STREAM_ENABLED = \"task.log4j.create.stream.enabled\";\n \n-  protected static final int DEFAULT_QUEUE_SIZE = 100;\n   private static final long DEFAULT_QUEUE_TIMEOUT_S = 2; // Abitrary choice\n+  private final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n \n-  protected static volatile boolean systemInitialized = false;\n-\n-  protected Config config = null;\n   private SystemStream systemStream = null;\n   private SystemProducer systemProducer = null;\n   private String key = null;\n-  protected String streamName = null;\n-  protected String appenderName = null;\n   private String containerName = null;\n   private int partitionCount = 0;\n   private boolean isApplicationMaster;\n   private Serde<LogEvent> serde = null;\n-  protected Logger log = LogManager.getLogger(StreamAppender.class);\n-  protected StreamAppenderMetrics metrics;\n+  private Logger log = LogManager.getLogger(StreamAppender.class);\n+  private Thread transferThread;\n \n-  private final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n-  protected long queueTimeoutS = DEFAULT_QUEUE_TIMEOUT_S;\n+  /**\n+   * used to detect if this thread is called recursively\n+   */\n+  private final AtomicBoolean recursiveCall = new AtomicBoolean(false);\n \n-  private Thread transferThread;\n+  protected static final int DEFAULT_QUEUE_SIZE = 100;\n+  protected static volatile boolean systemInitialized = false;\n+  protected Config config = null;\n+  protected String streamName = null;\n+  protected String appenderName = null;\n+  protected StreamAppenderMetrics metrics;\n+  protected long queueTimeoutS = DEFAULT_QUEUE_TIMEOUT_S;\n \n   protected StreamAppender(String name, Filter filter, Layout<? extends Serializable> layout, boolean ignoreExceptions, String streamName) {\n     super(name, filter, layout, ignoreExceptions);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDAzOQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463404039", "bodyText": "We're using the same registry; does the comment from before still apply?", "author": "bkonold", "createdAt": "2020-07-31T04:53:33Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -305,38 +318,58 @@ protected Config getConfig() {\n     return config;\n   }\n \n+  protected Log4jSystemConfig getLog4jSystemConfig(Config config) {\n+    return new Log4jSystemConfig(config);\n+  }\n+\n+  protected StreamAppenderMetrics getMetrics(MetricsRegistryMap metricsRegistry) {\n+    return new StreamAppenderMetrics(appenderName, metricsRegistry);\n+  }\n+\n+  protected void setupStream(SystemFactory systemFactory, String systemName) {\n+    if (config.getBoolean(CREATE_STREAM_ENABLED, false)) {\n+      // Explicitly create stream appender stream with the partition count the same as the number of containers.\n+      System.out.println(String.format(\"[%s] creating stream \", appenderName) + streamName + \" with partition count \" + getPartitionCount());\n+      StreamSpec streamSpec =\n+          StreamSpec.createStreamAppenderStreamSpec(streamName, systemName, getPartitionCount());\n+\n+      // SystemAdmin only needed for stream creation here.\n+      SystemAdmin systemAdmin = systemFactory.getAdmin(systemName, config);\n+      systemAdmin.start();\n+      systemAdmin.createStream(streamSpec);\n+      systemAdmin.stop();\n+    }\n+  }\n+\n   protected void setupSystem() {\n     config = getConfig();\n-    Log4jSystemConfig log4jSystemConfig = new Log4jSystemConfig(config);\n+    Log4jSystemConfig log4jSystemConfig = getLog4jSystemConfig(config);\n \n     if (streamName == null) {\n       streamName = getStreamName(log4jSystemConfig.getJobName(), log4jSystemConfig.getJobId());\n     }\n \n-    // TODO we need the ACTUAL metrics registry, or the metrics won't get reported by the metric reporters!\n-    MetricsRegistry metricsRegistry = new MetricsRegistryMap();\n-    metrics = new StreamAppenderMetrics(\"stream-appender\", metricsRegistry);\n+    // Instantiate metrics\n+    MetricsRegistryMap metricsRegistry = new MetricsRegistryMap();", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcxMzk5OQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463713999", "bodyText": "No. because MetricsReporter.register(String source, ReadableMetricsRegistry registry); requires ReadableMetricsRegistry which is a child class of MetricsRegistry.\nFYI: child to parent: MetricsRegistryMap -> ReadableMetricsRegistry -> MetricsRegistry", "author": "byjiang1996", "createdAt": "2020-07-31T16:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcwMzU5OQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r464703599", "bodyText": "So the comment was already out of date then? I don't see any difference in the register or metrics creation", "author": "bkonold", "createdAt": "2020-08-03T22:54:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTMxNA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r464769314", "bodyText": "Sorry. Now you can see the new updates.", "author": "byjiang1996", "createdAt": "2020-08-04T02:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDAzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 98e0286db..f1114c30a 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -353,7 +351,7 @@ public class StreamAppender extends AbstractAppender {\n     MetricsRegistryMap metricsRegistry = new MetricsRegistryMap();\n     // Take this.getClass().getName() as the name to make it extend-friendly\n     metrics = getMetrics(metricsRegistry);\n-    // Register metrics into metrics reporters so that they are able to be reported to other systems: e.g. inGraphs\n+    // Register metrics into metrics reporters so that they are able to be reported to other systems\n     Map<String, MetricsReporter>\n         metricsReporters = MetricsReporterLoader.getMetricsReporters(new MetricsConfig(config), containerName);\n     metricsReporters.values().forEach(reporter -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDExOA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463404118", "bodyText": "let's keep mention of things like \"inGraphs\" out of OSS", "author": "bkonold", "createdAt": "2020-07-31T04:53:54Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -305,38 +318,58 @@ protected Config getConfig() {\n     return config;\n   }\n \n+  protected Log4jSystemConfig getLog4jSystemConfig(Config config) {\n+    return new Log4jSystemConfig(config);\n+  }\n+\n+  protected StreamAppenderMetrics getMetrics(MetricsRegistryMap metricsRegistry) {\n+    return new StreamAppenderMetrics(appenderName, metricsRegistry);\n+  }\n+\n+  protected void setupStream(SystemFactory systemFactory, String systemName) {\n+    if (config.getBoolean(CREATE_STREAM_ENABLED, false)) {\n+      // Explicitly create stream appender stream with the partition count the same as the number of containers.\n+      System.out.println(String.format(\"[%s] creating stream \", appenderName) + streamName + \" with partition count \" + getPartitionCount());\n+      StreamSpec streamSpec =\n+          StreamSpec.createStreamAppenderStreamSpec(streamName, systemName, getPartitionCount());\n+\n+      // SystemAdmin only needed for stream creation here.\n+      SystemAdmin systemAdmin = systemFactory.getAdmin(systemName, config);\n+      systemAdmin.start();\n+      systemAdmin.createStream(streamSpec);\n+      systemAdmin.stop();\n+    }\n+  }\n+\n   protected void setupSystem() {\n     config = getConfig();\n-    Log4jSystemConfig log4jSystemConfig = new Log4jSystemConfig(config);\n+    Log4jSystemConfig log4jSystemConfig = getLog4jSystemConfig(config);\n \n     if (streamName == null) {\n       streamName = getStreamName(log4jSystemConfig.getJobName(), log4jSystemConfig.getJobId());\n     }\n \n-    // TODO we need the ACTUAL metrics registry, or the metrics won't get reported by the metric reporters!\n-    MetricsRegistry metricsRegistry = new MetricsRegistryMap();\n-    metrics = new StreamAppenderMetrics(\"stream-appender\", metricsRegistry);\n+    // Instantiate metrics\n+    MetricsRegistryMap metricsRegistry = new MetricsRegistryMap();\n+    // Take this.getClass().getName() as the name to make it extend-friendly\n+    metrics = getMetrics(metricsRegistry);\n+    // Register metrics into metrics reporters so that they are able to be reported to other systems: e.g. inGraphs", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcxMjkyOA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463712928", "bodyText": "Sure.", "author": "byjiang1996", "createdAt": "2020-07-31T16:35:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDExOA=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 98e0286db..f1114c30a 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -353,7 +351,7 @@ public class StreamAppender extends AbstractAppender {\n     MetricsRegistryMap metricsRegistry = new MetricsRegistryMap();\n     // Take this.getClass().getName() as the name to make it extend-friendly\n     metrics = getMetrics(metricsRegistry);\n-    // Register metrics into metrics reporters so that they are able to be reported to other systems: e.g. inGraphs\n+    // Register metrics into metrics reporters so that they are able to be reported to other systems\n     Map<String, MetricsReporter>\n         metricsReporters = MetricsReporterLoader.getMetricsReporters(new MetricsConfig(config), containerName);\n     metricsReporters.values().forEach(reporter -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTI2NA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463405264", "bodyText": "log-messages-bytes-sent?", "author": "bkonold", "createdAt": "2020-07-31T04:58:49Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java", "diffHunk": "@@ -34,10 +34,22 @@\n   /** The number of log messages dropped e.g. because of buffer overflow. Does not include recursive calls. */\n   public final Counter logMessagesDropped;\n \n+  /** The size of log messages sent out to SystemProducer. */\n+  public final Counter logMessagesBytes;\n+\n+  /** The number of log messages sent out to SystemProducer. */\n+  public final Counter logMessagesCount;\n+\n+  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n+  public final Counter logMessagesErrors;\n+\n   public StreamAppenderMetrics(String prefix, MetricsRegistry registry) {\n-    super(prefix, registry);\n+    super(prefix + \"-\", registry);\n     bufferFillPct = newGauge(\"buffer-fill-percent\", 0);\n     recursiveCalls = newCounter(\"recursive-calls\");\n     logMessagesDropped = newCounter(\"log-messages-dropped\");\n+    logMessagesBytes = newCounter(\"log-messages-bytes\");", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcxNDcyMg==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463714722", "bodyText": "Sure.", "author": "byjiang1996", "createdAt": "2020-07-31T16:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTI2NA=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\nindex cf0c1af7b..466a520bd 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\n\n@@ -34,22 +34,22 @@ public class StreamAppenderMetrics extends MetricsBase {\n   /** The number of log messages dropped e.g. because of buffer overflow. Does not include recursive calls. */\n   public final Counter logMessagesDropped;\n \n+  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n+  public final Counter logMessagesErrors;\n+\n   /** The size of log messages sent out to SystemProducer. */\n-  public final Counter logMessagesBytes;\n+  public final Counter logMessagesBytesSent;\n \n   /** The number of log messages sent out to SystemProducer. */\n-  public final Counter logMessagesCount;\n-\n-  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n-  public final Counter logMessagesErrors;\n+  public final Counter logMessagesCountSent;\n \n   public StreamAppenderMetrics(String prefix, MetricsRegistry registry) {\n     super(prefix + \"-\", registry);\n     bufferFillPct = newGauge(\"buffer-fill-percent\", 0);\n     recursiveCalls = newCounter(\"recursive-calls\");\n     logMessagesDropped = newCounter(\"log-messages-dropped\");\n-    logMessagesBytes = newCounter(\"log-messages-bytes\");\n-    logMessagesCount = newCounter(\"log-messages-count\");\n     logMessagesErrors = newCounter(\"log-messages-errors\");\n+    logMessagesBytesSent = newCounter(\"log-messages-bytes-sent\");\n+    logMessagesCountSent = newCounter(\"log-messages-count-sent\");\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTI5Nw==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463405297", "bodyText": "log-messages-sent?", "author": "bkonold", "createdAt": "2020-07-31T04:59:01Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java", "diffHunk": "@@ -34,10 +34,22 @@\n   /** The number of log messages dropped e.g. because of buffer overflow. Does not include recursive calls. */\n   public final Counter logMessagesDropped;\n \n+  /** The size of log messages sent out to SystemProducer. */\n+  public final Counter logMessagesBytes;\n+\n+  /** The number of log messages sent out to SystemProducer. */\n+  public final Counter logMessagesCount;\n+\n+  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n+  public final Counter logMessagesErrors;\n+\n   public StreamAppenderMetrics(String prefix, MetricsRegistry registry) {\n-    super(prefix, registry);\n+    super(prefix + \"-\", registry);\n     bufferFillPct = newGauge(\"buffer-fill-percent\", 0);\n     recursiveCalls = newCounter(\"recursive-calls\");\n     logMessagesDropped = newCounter(\"log-messages-dropped\");\n+    logMessagesBytes = newCounter(\"log-messages-bytes\");\n+    logMessagesCount = newCounter(\"log-messages-count\");", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzcxNDczOQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463714739", "bodyText": "Sure.", "author": "byjiang1996", "createdAt": "2020-07-31T16:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTI5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\nindex cf0c1af7b..466a520bd 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppenderMetrics.java\n\n@@ -34,22 +34,22 @@ public class StreamAppenderMetrics extends MetricsBase {\n   /** The number of log messages dropped e.g. because of buffer overflow. Does not include recursive calls. */\n   public final Counter logMessagesDropped;\n \n+  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n+  public final Counter logMessagesErrors;\n+\n   /** The size of log messages sent out to SystemProducer. */\n-  public final Counter logMessagesBytes;\n+  public final Counter logMessagesBytesSent;\n \n   /** The number of log messages sent out to SystemProducer. */\n-  public final Counter logMessagesCount;\n-\n-  /** The number of log messages cannot be sent out due to errors e.g. serialization errors, system producer send errors. */\n-  public final Counter logMessagesErrors;\n+  public final Counter logMessagesCountSent;\n \n   public StreamAppenderMetrics(String prefix, MetricsRegistry registry) {\n     super(prefix + \"-\", registry);\n     bufferFillPct = newGauge(\"buffer-fill-percent\", 0);\n     recursiveCalls = newCounter(\"recursive-calls\");\n     logMessagesDropped = newCounter(\"log-messages-dropped\");\n-    logMessagesBytes = newCounter(\"log-messages-bytes\");\n-    logMessagesCount = newCounter(\"log-messages-count\");\n     logMessagesErrors = newCounter(\"log-messages-errors\");\n+    logMessagesBytesSent = newCounter(\"log-messages-bytes-sent\");\n+    logMessagesCountSent = newCounter(\"log-messages-count-sent\");\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTY4NQ==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463405685", "bodyText": "why does this need to be protected? can't subclasses have their own logger?", "author": "bkonold", "createdAt": "2020-07-31T05:00:26Z", "path": "samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java", "diffHunk": "@@ -84,15 +87,17 @@\n \n   protected static volatile boolean systemInitialized = false;\n \n-  private Config config = null;\n+  protected Config config = null;\n   private SystemStream systemStream = null;\n   private SystemProducer systemProducer = null;\n   private String key = null;\n-  private String streamName = null;\n+  protected String streamName = null;\n+  protected String appenderName = null;\n+  private String containerName = null;\n   private int partitionCount = 0;\n   private boolean isApplicationMaster;\n   private Serde<LogEvent> serde = null;\n-  private Logger log = LogManager.getLogger(StreamAppender.class);\n+  protected Logger log = LogManager.getLogger(StreamAppender.class);", "originalCommit": "e2cbea566521206c9d8bd0c242a5f5fd4c7da2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc1ODY1Ng==", "url": "https://github.com/apache/samza/pull/1403#discussion_r463758656", "bodyText": "See the comments thread in another rb.", "author": "byjiang1996", "createdAt": "2020-07-31T18:12:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcwMDkwOA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r464700908", "bodyText": "Sure we can keep the discussion there then circle back", "author": "bkonold", "createdAt": "2020-08-03T22:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2OTY3NA==", "url": "https://github.com/apache/samza/pull/1403#discussion_r464769674", "bodyText": "Get back from discussion in another rb: will change to each subclass has its own logger.", "author": "byjiang1996", "createdAt": "2020-08-04T02:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTY4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d257eef738d5b79adfb3b82d9296c41df4f783", "chunk": "diff --git a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\nindex 98e0286db..f1114c30a 100644\n--- a/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n+++ b/samza-log4j2/src/main/java/org/apache/samza/logging/log4j2/StreamAppender.java\n\n@@ -82,28 +82,31 @@ public class StreamAppender extends AbstractAppender {\n   // Hidden config for now. Will move to appropriate Config class when ready to.\n   private static final String CREATE_STREAM_ENABLED = \"task.log4j.create.stream.enabled\";\n \n-  protected static final int DEFAULT_QUEUE_SIZE = 100;\n   private static final long DEFAULT_QUEUE_TIMEOUT_S = 2; // Abitrary choice\n+  private final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n \n-  protected static volatile boolean systemInitialized = false;\n-\n-  protected Config config = null;\n   private SystemStream systemStream = null;\n   private SystemProducer systemProducer = null;\n   private String key = null;\n-  protected String streamName = null;\n-  protected String appenderName = null;\n   private String containerName = null;\n   private int partitionCount = 0;\n   private boolean isApplicationMaster;\n   private Serde<LogEvent> serde = null;\n-  protected Logger log = LogManager.getLogger(StreamAppender.class);\n-  protected StreamAppenderMetrics metrics;\n+  private Logger log = LogManager.getLogger(StreamAppender.class);\n+  private Thread transferThread;\n \n-  private final BlockingQueue<byte[]> logQueue = new LinkedBlockingQueue<>(DEFAULT_QUEUE_SIZE);\n-  protected long queueTimeoutS = DEFAULT_QUEUE_TIMEOUT_S;\n+  /**\n+   * used to detect if this thread is called recursively\n+   */\n+  private final AtomicBoolean recursiveCall = new AtomicBoolean(false);\n \n-  private Thread transferThread;\n+  protected static final int DEFAULT_QUEUE_SIZE = 100;\n+  protected static volatile boolean systemInitialized = false;\n+  protected Config config = null;\n+  protected String streamName = null;\n+  protected String appenderName = null;\n+  protected StreamAppenderMetrics metrics;\n+  protected long queueTimeoutS = DEFAULT_QUEUE_TIMEOUT_S;\n \n   protected StreamAppender(String name, Filter filter, Layout<? extends Serializable> layout, boolean ignoreExceptions, String streamName) {\n     super(name, filter, layout, ignoreExceptions);\n"}}, {"oid": "59d257eef738d5b79adfb3b82d9296c41df4f783", "url": "https://github.com/apache/samza/commit/59d257eef738d5b79adfb3b82d9296c41df4f783", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-08-04T02:55:24Z", "type": "forcePushed"}, {"oid": "dd0f540740b97a245c00a730b61bf252080c3d27", "url": "https://github.com/apache/samza/commit/dd0f540740b97a245c00a730b61bf252080c3d27", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-08-05T02:27:38Z", "type": "forcePushed"}, {"oid": "94cda1abc23b85f84ab53b20efdad5ab869be05c", "url": "https://github.com/apache/samza/commit/94cda1abc23b85f84ab53b20efdad5ab869be05c", "message": "Make StreamAppender extend-friendly", "committedDate": "2020-08-05T02:59:57Z", "type": "commit"}, {"oid": "548a8f6f601312bf518bc522b3f8ea983cbaba83", "url": "https://github.com/apache/samza/commit/548a8f6f601312bf518bc522b3f8ea983cbaba83", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-08-05T03:00:01Z", "type": "commit"}, {"oid": "548a8f6f601312bf518bc522b3f8ea983cbaba83", "url": "https://github.com/apache/samza/commit/548a8f6f601312bf518bc522b3f8ea983cbaba83", "message": "Add logBytes and logCount metrics, and metrics reporter into StreamAppender", "committedDate": "2020-08-05T03:00:01Z", "type": "forcePushed"}]}