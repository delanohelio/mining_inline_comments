{"pr_number": 1450, "pr_title": "SAMZA-2610: Handle Metadata changes for AM HA orchestration", "pr_createdAt": "2020-12-03T05:07:21Z", "pr_url": "https://github.com/apache/samza/pull/1450", "timeline": [{"oid": "3c879484e0fdd6b20b389e72b425b9efcddd5db6", "url": "https://github.com/apache/samza/commit/3c879484e0fdd6b20b389e72b425b9efcddd5db6", "message": "SAMZA-2610: Handle Metadata changes for AM HA orchestration", "committedDate": "2020-12-07T23:06:09Z", "type": "forcePushed"}, {"oid": "4ebab84234d63f96707e908ea61b209e72c8eebf", "url": "https://github.com/apache/samza/commit/4ebab84234d63f96707e908ea61b209e72c8eebf", "message": "Pick up the latest data model changes & fix checkstyle", "committedDate": "2020-12-08T02:40:50Z", "type": "forcePushed"}, {"oid": "ce21359be003ee2d7a3e88868d42c9c664604291", "url": "https://github.com/apache/samza/commit/ce21359be003ee2d7a3e88868d42c9c664604291", "message": "SAMZA-2610: Handle Metadata changes for AM HA orchestration\n     - Added tests and minor improvements\n     - Pick up the latest data model changes & fix checkstyle", "committedDate": "2020-12-08T19:28:30Z", "type": "commit"}, {"oid": "ce21359be003ee2d7a3e88868d42c9c664604291", "url": "https://github.com/apache/samza/commit/ce21359be003ee2d7a3e88868d42c9c664604291", "message": "SAMZA-2610: Handle Metadata changes for AM HA orchestration\n     - Added tests and minor improvements\n     - Pick up the latest data model changes & fix checkstyle", "committedDate": "2020-12-08T19:28:30Z", "type": "forcePushed"}, {"oid": "7fdaa2bc8ec40135856d7f3b9211f59707e49473", "url": "https://github.com/apache/samza/commit/7fdaa2bc8ec40135856d7f3b9211f59707e49473", "message": "Add more metrics to JobCoordinatorMetadataManager and unit tests", "committedDate": "2020-12-08T21:04:39Z", "type": "commit"}, {"oid": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "url": "https://github.com/apache/samza/commit/24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "message": "Fix checkstyle", "committedDate": "2020-12-08T21:19:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MDg3MA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538890870", "bodyText": "is this only for tests?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-08T23:35:38Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -456,6 +482,18 @@ StartpointManager createStartpointManager() {\n \n   @VisibleForTesting\n   ContainerProcessManager createContainerProcessManager() {\n-    return new ContainerProcessManager(config, state, metrics, containerPlacementMetadataStore, localityManager);\n+    return new ContainerProcessManager(config, state, metrics, containerPlacementMetadataStore, localityManager,\n+        metadataChangedAcrossAttempts);\n+  }\n+\n+  @VisibleForTesting\n+  JobCoordinatorMetadataManager createJobCoordinatorMetadataManager() {\n+    return new JobCoordinatorMetadataManager(new NamespaceAwareCoordinatorStreamStore(metadataStore,\n+        SetJobCoordinatorMetadataMessage.TYPE), JobCoordinatorMetadataManager.ClusterType.YARN, metrics);\n+  }\n+\n+  @VisibleForTesting\n+  boolean isMetadataChangedAcrossAttempts() {", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkyOTY5Nw==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538929697", "bodyText": "the getter is only for tests.", "author": "mynameborat", "createdAt": "2020-12-09T01:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MDg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "d1f78d37a80f8d39b9e299dcfd14391ba53d9746", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\nindex 35e72c1ab..183a6f580 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n\n@@ -492,8 +495,29 @@ public class ClusterBasedJobCoordinator {\n         SetJobCoordinatorMetadataMessage.TYPE), JobCoordinatorMetadataManager.ClusterType.YARN, metrics);\n   }\n \n+  @VisibleForTesting\n+  boolean isApplicationMasterHighAvailabilityEnabled() {\n+    return new JobConfig(config).getApplicationMasterHighAvailabilityEnabled();\n+  }\n+\n   @VisibleForTesting\n   boolean isMetadataChangedAcrossAttempts() {\n     return metadataChangedAcrossAttempts;\n   }\n+\n+  /**\n+   * We only fanout startpoint if and only if\n+   *  1. Startpoint is enabled\n+   *  2. If AM HA is enabled, fanout only if job coordinator metadata also changed\n+   *\n+   * @return true if it satisfies above conditions, false otherwise\n+   */\n+  @VisibleForTesting\n+  boolean shouldFanoutStartpoint() {\n+    JobConfig jobConfig = new JobConfig(config);\n+    boolean startpointEnabled = jobConfig.getStartpointEnabled();\n+\n+    return isApplicationMasterHighAvailabilityEnabled() ?\n+        startpointEnabled && isMetadataChangedAcrossAttempts() : startpointEnabled;\n+  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MTY5Ng==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538891696", "bodyText": "wait, if we have to restart all containers then why are we asking allocator for resources for only some of the processors.. is it to avoid a scenario where we spin up a processor with Id 0 though there is a processor with same id from previous attempt leading to orphan container issues?\n\n\nwould benefit from a log here too i feel.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-08T23:37:40Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ContainerProcessManager.java", "diffHunk": "@@ -248,16 +253,23 @@ public void start() {\n     // Request initial set of containers\n     LocalityModel localityModel = localityManager.readLocality();\n     Map<String, String> processorToHost = new HashMap<>();\n-    state.jobModelManager.jobModel().getContainers().keySet().forEach((containerId) -> {\n-      String host = Optional.ofNullable(localityModel.getProcessorLocality(containerId))\n+    state.jobModelManager.jobModel().getContainers().keySet().forEach((processorId) -> {\n+      String host = Optional.ofNullable(localityModel.getProcessorLocality(processorId))\n           .map(ProcessorLocality::host)\n           .filter(StringUtils::isNotBlank)\n           .orElse(null);\n-      processorToHost.put(containerId, host);\n+      processorToHost.put(processorId, host);\n     });\n     if (jobConfig.getApplicationMasterHighAvailabilityEnabled()) {\n       // don't request resource for container that is already running\n-      state.runningProcessors.keySet().forEach(processorToHost::remove);\n+      state.runningProcessors.forEach((processorId, samzaResource) -> {\n+        LOG.info(\"Not requesting container for processorId: {} since its already running as containerId: {}\",\n+            processorId, samzaResource.getContainerId());\n+        processorToHost.remove(processorId);\n+        if (restartContainers) {\n+          clusterResourceManager.stopStreamProcessor(samzaResource);", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzMDk3NA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538930974", "bodyText": "We don't need to request these explicitly as they stop callbacks for the running processors will eventually spin up the container again. Additionally, not removing them will end up requesting resources for those running containers & update some state with double counting.\nI initially had logs but then there is log immediately that follows in the stopStreamProcessor(..) and there is nothing in between. Hence, decided against it.", "author": "mynameborat", "createdAt": "2020-12-09T01:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MTY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MTIyMg==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538941222", "bodyText": "thanks for clarifying", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T01:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5MTY5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5NDQ3Mg==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538894472", "bodyText": "should we put this block behind the AM-HA config?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-08T23:44:38Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -331,9 +332,24 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      /*\n+       * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n+       * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n+       *    attempt and managed by the AM due to AM-HA\n+       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       */\n       if (container != null) {\n         log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n+      } else {", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNDMyNA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538934324", "bodyText": "The call site for this method in the AM HA flow is behind the config. Hence dropping that here for brevity and readability.", "author": "mynameborat", "createdAt": "2020-12-09T01:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5NDQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9563951ab05542efa3770a15035859bdbcb34ff3", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\nindex 208f62fdd..fa784e04c 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n\n@@ -332,23 +332,25 @@ public class YarnClusterResourceManager extends ClusterResourceManager implement\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      String containerId = resource.getContainerId();\n+      String containerHost = resource.getHost();\n       /*\n        * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n        * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n        *    attempt and managed by the AM due to AM-HA\n-       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       * 3. Ignore the request if the container associated with the resource isn't present in the book keeping.\n        */\n       if (container != null) {\n-        log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n+        log.info(\"Stopping Container ID: {} on host: {}\", containerId, containerHost);\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n       } else {\n-        YarnContainer yarnContainer = state.runningProcessors.get(resource.getContainerId());\n+        YarnContainer yarnContainer = state.runningProcessors.get(getRunningProcessorId(containerId));\n         if (yarnContainer != null) {\n           log.info(\"Stopping container from previous attempt with Container ID: {} on host: {}\",\n-              resource.getContainerId(), resource.getHost());\n+              containerId, containerHost);\n           amClient.releaseAssignedContainer(yarnContainer.id());\n         } else {\n-          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", resource.getContainerId());\n+          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", containerId);\n         }\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5ODQ1Ng==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538898456", "bodyText": "major: hmm.. some confusion here.. resource.getContainerId() gets the yarn container id right (of the form container_1350670447861_0003_01_000001).  see one ex here \nBut if we see code where the runningProcessors gets populated -- it has key as samza processorId (of the form 0) -- see here \nbut here you are using container id to fetch from runningProcessors.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-08T23:54:14Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -331,9 +332,24 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      /*\n+       * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n+       * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n+       *    attempt and managed by the AM due to AM-HA\n+       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       */\n       if (container != null) {\n         log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n+      } else {\n+        YarnContainer yarnContainer = state.runningProcessors.get(resource.getContainerId());", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNDY3Ng==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538934676", "bodyText": "Sync'd offline on this. It only uses processorId and the prototype was using a buggy version which populated it with containerId. Fixed it.\nThanks for calling this out \ud83d\udc4d", "author": "mynameborat", "createdAt": "2020-12-09T01:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg5ODQ1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9563951ab05542efa3770a15035859bdbcb34ff3", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\nindex 208f62fdd..fa784e04c 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n\n@@ -332,23 +332,25 @@ public class YarnClusterResourceManager extends ClusterResourceManager implement\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      String containerId = resource.getContainerId();\n+      String containerHost = resource.getHost();\n       /*\n        * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n        * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n        *    attempt and managed by the AM due to AM-HA\n-       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       * 3. Ignore the request if the container associated with the resource isn't present in the book keeping.\n        */\n       if (container != null) {\n-        log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n+        log.info(\"Stopping Container ID: {} on host: {}\", containerId, containerHost);\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n       } else {\n-        YarnContainer yarnContainer = state.runningProcessors.get(resource.getContainerId());\n+        YarnContainer yarnContainer = state.runningProcessors.get(getRunningProcessorId(containerId));\n         if (yarnContainer != null) {\n           log.info(\"Stopping container from previous attempt with Container ID: {} on host: {}\",\n-              resource.getContainerId(), resource.getHost());\n+              containerId, containerHost);\n           amClient.releaseAssignedContainer(yarnContainer.id());\n         } else {\n-          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", resource.getContainerId());\n+          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", containerId);\n         }\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwMzk0MQ==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538903941", "bodyText": "nit: add changed \"JC metadata changed should be true\"", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T00:08:05Z", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java", "diffHunk": "@@ -192,4 +196,38 @@ public void testToArgs() {\n     assertEquals(expected.size(), actual.size());\n     assertTrue(actual.containsAll(expected));\n   }\n+\n+  @Test\n+  public void testGenerateAndUpdateJobCoordinatorMetadata() {\n+    Config jobConfig = new MapConfig(configMap);\n+    when(CoordinatorStreamUtil.readConfigFromCoordinatorStream(anyObject())).thenReturn(jobConfig);\n+    ClusterBasedJobCoordinator clusterBasedJobCoordinator =\n+        spy(ClusterBasedJobCoordinatorRunner.createFromMetadataStore(jobConfig));\n+\n+    JobCoordinatorMetadata previousMetadata = mock(JobCoordinatorMetadata.class);\n+    JobCoordinatorMetadata newMetadata = mock(JobCoordinatorMetadata.class);\n+    JobCoordinatorMetadataManager jobCoordinatorMetadataManager = mock(JobCoordinatorMetadataManager.class);\n+    JobModel mockJobModel = mock(JobModel.class);\n+\n+    when(jobCoordinatorMetadataManager.readJobCoordinatorMetadata()).thenReturn(previousMetadata);\n+    when(jobCoordinatorMetadataManager.generateJobCoordinatorMetadata(any(), any())).thenReturn(newMetadata);\n+    when(jobCoordinatorMetadataManager.checkForMetadataChanges(newMetadata, previousMetadata)).thenReturn(false);\n+    when(clusterBasedJobCoordinator.createJobCoordinatorMetadataManager()).thenReturn(jobCoordinatorMetadataManager);\n+\n+    /*\n+     * Verify if there are no changes to metadata, the metadata changed flag remains false and no interactions\n+     * with job coordinator metadata manager\n+     */\n+    clusterBasedJobCoordinator.generateAndUpdateJobCoordinatorMetadata(mockJobModel);\n+    assertFalse(\"JC metadata should remain unchanged\", clusterBasedJobCoordinator.isMetadataChangedAcrossAttempts());\n+    verify(jobCoordinatorMetadataManager, times(0)).writeJobCoordinatorMetadata(any());\n+\n+    /*\n+     * Verify if there are changes to metadata, we persist the new metadata & update the metadata changed flag\n+     */\n+    when(jobCoordinatorMetadataManager.checkForMetadataChanges(newMetadata, previousMetadata)).thenReturn(true);\n+    clusterBasedJobCoordinator.generateAndUpdateJobCoordinatorMetadata(mockJobModel);\n+    assertTrue(\"JC metadata should be true\", clusterBasedJobCoordinator.isMetadataChangedAcrossAttempts());", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9563951ab05542efa3770a15035859bdbcb34ff3", "chunk": "diff --git a/samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java b/samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java\nindex 194e579c5..2be3ca571 100644\n--- a/samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java\n+++ b/samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java\n\n@@ -219,7 +219,8 @@ public class TestClusterBasedJobCoordinator {\n      * with job coordinator metadata manager\n      */\n     clusterBasedJobCoordinator.generateAndUpdateJobCoordinatorMetadata(mockJobModel);\n-    assertFalse(\"JC metadata should remain unchanged\", clusterBasedJobCoordinator.isMetadataChangedAcrossAttempts());\n+    assertFalse(\"JC metadata changed should remain unchanged\",\n+        clusterBasedJobCoordinator.isMetadataChangedAcrossAttempts());\n     verify(jobCoordinatorMetadataManager, times(0)).writeJobCoordinatorMetadata(any());\n \n     /*\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwNTkyMg==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538905922", "bodyText": "should we also check if the ClusterResourceManager.stopStreamProcessor was invoked and with the correct SamzaResource?", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T00:13:11Z", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerProcessManager.java", "diffHunk": "@@ -272,10 +273,60 @@ public void run() {\n \n     // Verify only 1 was requested with allocator\n     assertEquals(1, allocator.requestedContainers);\n+    assertTrue(\"Ensure no processors were forcefully restarted\", callback.resourceStatuses.isEmpty());\n \n     cpm.stop();\n   }\n \n+  @Test\n+  public void testOnInitToForceRestartAMHighAvailability() throws Exception {\n+    Map<String, String> configMap = new HashMap<>(configVals);\n+    configMap.put(JobConfig.YARN_AM_HIGH_AVAILABILITY_ENABLED, \"true\");\n+    Config conf = new MapConfig(configMap);\n+\n+    SamzaApplicationState state = new SamzaApplicationState(getJobModelManager(2));\n+    state.runningProcessors.put(\"0\", new SamzaResource(1, 1024, \"host\", \"0\"));\n+\n+    MockClusterResourceManagerCallback callback = new MockClusterResourceManagerCallback();\n+    ClusterResourceManager clusterResourceManager = new MockClusterResourceManager(callback, state);\n+    ClusterManagerConfig clusterManagerConfig = spy(new ClusterManagerConfig(conf));\n+    ContainerManager containerManager =\n+        buildContainerManager(containerPlacementMetadataStore, state, clusterResourceManager,\n+            clusterManagerConfig.getHostAffinityEnabled(), false);\n+\n+    ContainerProcessManager cpm =\n+        buildContainerProcessManager(clusterManagerConfig, state, clusterResourceManager, Optional.empty(), true);\n+\n+    MockContainerAllocatorWithoutHostAffinity allocator = new MockContainerAllocatorWithoutHostAffinity(\n+        clusterResourceManager,\n+        conf,\n+        state,\n+        containerManager);\n+\n+    getPrivateFieldFromCpm(\"containerAllocator\", cpm).set(cpm, allocator);\n+    CountDownLatch latch = new CountDownLatch(1);\n+    getPrivateFieldFromCpm(\"allocatorThread\", cpm).set(cpm, new Thread() {\n+      public void run() {\n+        isRunning = true;\n+        latch.countDown();\n+      }\n+    });\n+\n+    cpm.start();", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9563951ab05542efa3770a15035859bdbcb34ff3", "chunk": "diff --git a/samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerProcessManager.java b/samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerProcessManager.java\nindex fa226493e..bcbe53f5e 100644\n--- a/samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerProcessManager.java\n+++ b/samza-core/src/test/java/org/apache/samza/clustermanager/TestContainerProcessManager.java\n\n@@ -283,12 +283,13 @@ public class TestContainerProcessManager {\n     Map<String, String> configMap = new HashMap<>(configVals);\n     configMap.put(JobConfig.YARN_AM_HIGH_AVAILABILITY_ENABLED, \"true\");\n     Config conf = new MapConfig(configMap);\n+    SamzaResource samzaResource = new SamzaResource(1, 1024, \"host\", \"0\");\n \n     SamzaApplicationState state = new SamzaApplicationState(getJobModelManager(2));\n-    state.runningProcessors.put(\"0\", new SamzaResource(1, 1024, \"host\", \"0\"));\n+    state.runningProcessors.put(\"0\", samzaResource);\n \n     MockClusterResourceManagerCallback callback = new MockClusterResourceManagerCallback();\n-    ClusterResourceManager clusterResourceManager = new MockClusterResourceManager(callback, state);\n+    ClusterResourceManager clusterResourceManager = spy(new MockClusterResourceManager(callback, state));\n     ClusterManagerConfig clusterManagerConfig = spy(new ClusterManagerConfig(conf));\n     ContainerManager containerManager =\n         buildContainerManager(containerPlacementMetadataStore, state, clusterResourceManager,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODgxMg==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538908812", "bodyText": "after amClient.releaseAssignedContainer(yarnContainer.id()); is done, what do we get the call back as?\nbecause we should use that call back to restart the container right (as earlier we allocated resources only for processors not runnning in prev attempt).", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T00:20:40Z", "path": "samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java", "diffHunk": "@@ -331,9 +332,24 @@ public void launchStreamProcessor(SamzaResource resource, CommandBuilder builder\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      /*\n+       * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n+       * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n+       *    attempt and managed by the AM due to AM-HA\n+       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       */\n       if (container != null) {\n         log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n+      } else {\n+        YarnContainer yarnContainer = state.runningProcessors.get(resource.getContainerId());\n+        if (yarnContainer != null) {\n+          log.info(\"Stopping container from previous attempt with Container ID: {} on host: {}\",\n+              resource.getContainerId(), resource.getHost());\n+          amClient.releaseAssignedContainer(yarnContainer.id());", "originalCommit": "24e7af5ef5f74b4c009b7ca1200e88d1da567d1f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkzNTI3NA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538935274", "bodyText": "It follows the similar workflow as StopStreamProcessor which is notified through the AMRM client callback onContainersCompleted which will treat it as the container was stopped agnostic to which workflow triggered it and hence you get all the niceties of state update and instantiating new container in its place.", "author": "mynameborat", "createdAt": "2020-12-09T01:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MjE0MQ==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538942141", "bodyText": "awesome! thanks for telling me.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T01:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODkwODgxMg=="}], "type": "inlineReview", "revised_code": {"commit": "9563951ab05542efa3770a15035859bdbcb34ff3", "chunk": "diff --git a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\nindex 208f62fdd..fa784e04c 100644\n--- a/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n+++ b/samza-yarn/src/main/java/org/apache/samza/job/yarn/YarnClusterResourceManager.java\n\n@@ -332,23 +332,25 @@ public class YarnClusterResourceManager extends ClusterResourceManager implement\n   public void stopStreamProcessor(SamzaResource resource) {\n     synchronized (lock) {\n       Container container = allocatedResources.get(resource);\n+      String containerId = resource.getContainerId();\n+      String containerHost = resource.getHost();\n       /*\n        * 1. Stop the container through NMClient if the container was instantiated as part of NMClient lifecycle.\n        * 2. Stop the container through AMClient by release the assigned container if the container was from the previous\n        *    attempt and managed by the AM due to AM-HA\n-       * 3. Ignore the request if the container associated with the resource isn't present in the bookeeping.\n+       * 3. Ignore the request if the container associated with the resource isn't present in the book keeping.\n        */\n       if (container != null) {\n-        log.info(\"Stopping Container ID: {} on host: {}\", resource.getContainerId(), resource.getHost());\n+        log.info(\"Stopping Container ID: {} on host: {}\", containerId, containerHost);\n         this.nmClientAsync.stopContainerAsync(container.getId(), container.getNodeId());\n       } else {\n-        YarnContainer yarnContainer = state.runningProcessors.get(resource.getContainerId());\n+        YarnContainer yarnContainer = state.runningProcessors.get(getRunningProcessorId(containerId));\n         if (yarnContainer != null) {\n           log.info(\"Stopping container from previous attempt with Container ID: {} on host: {}\",\n-              resource.getContainerId(), resource.getHost());\n+              containerId, containerHost);\n           amClient.releaseAssignedContainer(yarnContainer.id());\n         } else {\n-          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", resource.getContainerId());\n+          log.info(\"No container with Container ID: {} exists. Ignoring the stop request\", containerId);\n         }\n       }\n     }\n"}}, {"oid": "9563951ab05542efa3770a15035859bdbcb34ff3", "url": "https://github.com/apache/samza/commit/9563951ab05542efa3770a15035859bdbcb34ff3", "message": "Address Manasa's comments", "committedDate": "2020-12-09T01:38:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MDQ3NA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538940474", "bodyText": "what if startpoint is enabled and metadata has changed? we just ignore? as in for AM-HA with metadata changes we dont create startpoint manager? if we are planning another PR for this then lets leave a comment saying tbd.\nsorry missed this in the first pass.", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T01:43:01Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -260,8 +267,9 @@ public void run() {\n       MetadataResourceUtil metadataResourceUtil = new MetadataResourceUtil(jobModel, this.metrics, config);\n       metadataResourceUtil.createResources();\n \n-      // fan out the startpoints if startpoints is enabled\n-      if (new JobConfig(config).getStartpointEnabled()) {\n+      // fan out the startpoints if startpoints is enabled and if the metadata changed across attempts.\n+      // the metadata changed should be false and only get evaluated if job coordinator high availability is enabled.\n+      if (new JobConfig(config).getStartpointEnabled() && !metadataChangedAcrossAttempts) {", "originalCommit": "9563951ab05542efa3770a15035859bdbcb34ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MzIwNw==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538943207", "bodyText": "yeah. We will not fanout startpoint since there may be containers that are already running in which case the newly instantiated containers will act on startpoint but the old ones wont. As a result, we skip fanout and applications will force job restart through new deployment like how they do it today.", "author": "mynameborat", "createdAt": "2020-12-09T01:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MDQ3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk3MjMxNg==", "url": "https://github.com/apache/samza/pull/1450#discussion_r538972316", "bodyText": "Thanks for pointing this out. I intended to handle it as part of this PR.\nFixed it and added unit tests.", "author": "mynameborat", "createdAt": "2020-12-09T03:11:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk0MDQ3NA=="}], "type": "inlineReview", "revised_code": {"commit": "d1f78d37a80f8d39b9e299dcfd14391ba53d9746", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\nindex 35e72c1ab..183a6f580 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n\n@@ -267,9 +267,12 @@ public class ClusterBasedJobCoordinator {\n       MetadataResourceUtil metadataResourceUtil = new MetadataResourceUtil(jobModel, this.metrics, config);\n       metadataResourceUtil.createResources();\n \n-      // fan out the startpoints if startpoints is enabled and if the metadata changed across attempts.\n-      // the metadata changed should be false and only get evaluated if job coordinator high availability is enabled.\n-      if (new JobConfig(config).getStartpointEnabled() && !metadataChangedAcrossAttempts) {\n+      /*\n+       * We fan out startpoint if and only if\n+       *  1. Startpoint is enabled in configuration\n+       *  2. If AM HA is enabled, fan out only if metadata changed\n+       */\n+      if (shouldFanoutStartpoint()) {\n         StartpointManager startpointManager = createStartpointManager();\n         startpointManager.start();\n         try {\n"}}, {"oid": "d1f78d37a80f8d39b9e299dcfd14391ba53d9746", "url": "https://github.com/apache/samza/commit/d1f78d37a80f8d39b9e299dcfd14391ba53d9746", "message": "Fix startpoint fanout condition bug and add unit tests", "committedDate": "2020-12-09T03:10:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0MjA0MA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r539442040", "bodyText": "so if metadata has changed then JC will stop all running processors right. additionally if there are startpoints to fanout then they are assigned to respective tasks. I am inferring that since the fanouts for task are fetched before processor entering runloop, the prev-running-now-restarted processors will pick them up. Am i correct? just trying to ensure we dont lose the fanouts for tasks that are part of already running processors.\nminor: if AM HA is enabled: fanout ONLY if  startpoint enabled && metadata changed", "author": "lakshmi-manasa-g", "createdAt": "2020-12-09T16:13:55Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -267,9 +267,12 @@ public void run() {\n       MetadataResourceUtil metadataResourceUtil = new MetadataResourceUtil(jobModel, this.metrics, config);\n       metadataResourceUtil.createResources();\n \n-      // fan out the startpoints if startpoints is enabled and if the metadata changed across attempts.\n-      // the metadata changed should be false and only get evaluated if job coordinator high availability is enabled.\n-      if (new JobConfig(config).getStartpointEnabled() && !metadataChangedAcrossAttempts) {\n+      /*\n+       * We fan out startpoint if and only if\n+       *  1. Startpoint is enabled in configuration\n+       *  2. If AM HA is enabled, fan out only if metadata changed", "originalCommit": "d1f78d37a80f8d39b9e299dcfd14391ba53d9746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NDM3OA==", "url": "https://github.com/apache/samza/pull/1450#discussion_r539474378", "bodyText": "yeah. fanout messages are read as part of the container initialization within OffsetManager. Container's don't read them  after the it has started. So it is guaranteed that the fanout message for a task will not be seen by an existing container (which has the task assigned to).", "author": "mynameborat", "createdAt": "2020-12-09T16:52:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ0MjA0MA=="}], "type": "inlineReview", "revised_code": {"commit": "f27c6c3d30099def7982ab88479e3852b770ce09", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\nindex 183a6f580..08bcfda8f 100644\n--- a/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n+++ b/samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java\n\n@@ -268,9 +268,9 @@ public class ClusterBasedJobCoordinator {\n       metadataResourceUtil.createResources();\n \n       /*\n-       * We fan out startpoint if and only if\n+       * We fanout startpoint if and only if\n        *  1. Startpoint is enabled in configuration\n-       *  2. If AM HA is enabled, fan out only if metadata changed\n+       *  2. If AM HA is enabled, fanout only if startpoint enabled and job coordinator metadata changed\n        */\n       if (shouldFanoutStartpoint()) {\n         StartpointManager startpointManager = createStartpointManager();\n"}}, {"oid": "f27c6c3d30099def7982ab88479e3852b770ce09", "url": "https://github.com/apache/samza/commit/f27c6c3d30099def7982ab88479e3852b770ce09", "message": "Fix javadocs", "committedDate": "2020-12-09T17:00:00Z", "type": "commit"}]}