{"pr_number": 1327, "pr_title": "SAMZA-2493: Keep checkpoint manager consumer open for repeated polling", "pr_createdAt": "2020-03-25T01:40:25Z", "pr_url": "https://github.com/apache/samza/pull/1327", "timeline": [{"oid": "27c75ad50bc3ce109b1acb6c5a99690758b320ee", "url": "https://github.com/apache/samza/commit/27c75ad50bc3ce109b1acb6c5a99690758b320ee", "message": "keep checkpoint manager consumer open after first read", "committedDate": "2020-03-25T01:27:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ==", "url": "https://github.com/apache/samza/pull/1327#discussion_r401138531", "bodyText": "Why do this as a config instead of a parameter?\nIf internal config, let's use samza.internal prefix.", "author": "prateekm", "createdAt": "2020-03-31T18:50:31Z", "path": "samza-core/src/main/java/org/apache/samza/config/TaskConfig.java", "diffHunk": "@@ -105,6 +105,7 @@\n   private static final String BROADCAST_STREAM_PATTERN = \"^[\\\\d]+$\";\n   private static final String BROADCAST_STREAM_RANGE_PATTERN = \"^\\\\[[\\\\d]+\\\\-[\\\\d]+\\\\]$\";\n   public static final String CHECKPOINT_MANAGER_FACTORY = \"task.checkpoint.factory\";\n+  public static final String CHECKPOINT_MANAGER_CONSUMER_STOP_AFTER_FIRST_READ = \"task.checkpoint.consumer.stop.after.first.read\";", "originalCommit": "27c75ad50bc3ce109b1acb6c5a99690758b320ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MjczNw==", "url": "https://github.com/apache/samza/pull/1327#discussion_r401142737", "bodyText": "@prateekm The rationale between @mynameborat and I is that the internal config was a lighter-weight change.\nPassing this via construction parameter would mean changing the CheckpointManagerFactory API and underlying implementations. If we're ok with that, I'm open to either approach.", "author": "bkonold", "createdAt": "2020-03-31T18:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxNzYxNQ==", "url": "https://github.com/apache/samza/pull/1327#discussion_r401217615", "bodyText": "+1 to internal prefix. We were debating between passing the exposing task mode through parameter vs config. The config route seemed less invasive and also doesn't introduce breaking API changes.\nIIRC, we want to know if the container is standby or not. Given KafkaCheckpointManager is a singleton for the container, is there a way to infer on the fly from the existing configurations if it is standby or active? for e.g. task.inputs is empty?", "author": "mynameborat", "createdAt": "2020-03-31T21:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0NzA4Mg==", "url": "https://github.com/apache/samza/pull/1327#discussion_r401947082", "bodyText": "I spoke with @rmatharu and there is nothing in config we can use to infer standby vs not. If we're all ok with the internal config, I will change the prefix and we can go with that.\nMay also be worth pointing out that this PR doesn't do much to lock us into anything - if we later want to treat this information as more a first class citizen we can go ahead and change the factory API.", "author": "bkonold", "createdAt": "2020-04-01T22:28:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMTAxMQ==", "url": "https://github.com/apache/samza/pull/1327#discussion_r402701011", "bodyText": "Is adding a parameter like JobModel or containermodel, etc to CheckpointManagerFactory  a big deal?", "author": "rmatharu", "createdAt": "2020-04-03T02:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI2MTcxNA==", "url": "https://github.com/apache/samza/pull/1327#discussion_r403261714", "bodyText": "@rmatharu @mynameborat @prateekm\nYou'll need some visibility on the calling-container, so jobModel + containerId or containerModel would work.\nAt least one usage of CheckpointManagerFactory does not have this information available (it is used in StreamManager during execution planning, before the job model is created). I suppose we could make the parameter nullable in this case.\nThere is also usage in our tooling (recovery and checkpoint tools) that expects an instance of CheckpointManager to be shared within the same job. It does however seem like these can be easily refactored.\nIn addition to the two considerations above, changing the API would impact any existing open source customers who have implemented CheckpointManagerFactory for their own use cases. In this case perhaps we mark the existing method as deprecated and remove in a future version.\nIMO those are heavy changes to make just for one implementer of CheckpointManagerFactory to be able to toggle its consumer behavior.\nFor context, stopping the consumer after initial read is an optimization (https://github.com/apache/samza/pull/993/files) because BlockingEnvelopeMap buffers were being filled with messages that would never be read.\nAn alternative to this PR could be tackling that optimization differently. Fetch thresholds in BEM are currently configured per system. We wouldn't want to override this fetch threshold for the whole checkpoint system since it may overlap with other streams and impact job perf. However, if we implemented fetch thresholds at the system-stream / SSP granularity we could avoid this stop in some cases vs others bifurcation and instead limit buffering specifically for the checkpoint stream.\nTL;DR, my opinion:\n\nThis PR is the shortest path forward.\nModifying CheckpointManagerFactory API is unjustified.\nAlternative to this PR would be to approach the original problem of optimization a bit differently.", "author": "bkonold", "createdAt": "2020-04-03T19:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI5MzE2MQ==", "url": "https://github.com/apache/samza/pull/1327#discussion_r403293161", "bodyText": "I agree. For now, the config approach is minimally invasive and backward compatible. We can always reevaluate this if there is a stronger justification to have container model exposed to the checkpoint manager.\nSince it is not a user config, we should be able to deprecate it without much effort.", "author": "mynameborat", "createdAt": "2020-04-03T20:06:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxNTcxNw==", "url": "https://github.com/apache/samza/pull/1327#discussion_r403315717", "bodyText": "makes sense", "author": "rmatharu", "createdAt": "2020-04-03T20:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxNDk3OQ==", "url": "https://github.com/apache/samza/pull/1327#discussion_r404314979", "bodyText": "Closing this thread then. Thanks.", "author": "bkonold", "createdAt": "2020-04-06T18:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "fbf98ab8c9df5de93d88860d822a9994c85a02fd", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java b/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\nindex 1a7d48ad..31a1691b 100644\n--- a/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\n+++ b/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\n\n@@ -105,7 +105,7 @@ public class TaskConfig extends MapConfig {\n   private static final String BROADCAST_STREAM_PATTERN = \"^[\\\\d]+$\";\n   private static final String BROADCAST_STREAM_RANGE_PATTERN = \"^\\\\[[\\\\d]+\\\\-[\\\\d]+\\\\]$\";\n   public static final String CHECKPOINT_MANAGER_FACTORY = \"task.checkpoint.factory\";\n-  public static final String CHECKPOINT_MANAGER_CONSUMER_STOP_AFTER_FIRST_READ = \"task.checkpoint.consumer.stop.after.first.read\";\n+  public static final String INTERNAL_CHECKPOINT_MANAGER_CONSUMER_STOP_AFTER_FIRST_READ = \"samza.internal.task.checkpoint.consumer.stop.after.first.read\";\n \n   public static final String TRANSACTIONAL_STATE_CHECKPOINT_ENABLED = \"task.transactional.state.checkpoint.enabled\";\n   private static final boolean DEFAULT_TRANSACTIONAL_STATE_CHECKPOINT_ENABLED = true;\n"}}, {"oid": "fbf98ab8c9df5de93d88860d822a9994c85a02fd", "url": "https://github.com/apache/samza/commit/fbf98ab8c9df5de93d88860d822a9994c85a02fd", "message": "adding samza.internal prefix", "committedDate": "2020-04-03T01:49:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMDAwMA==", "url": "https://github.com/apache/samza/pull/1327#discussion_r402700000", "bodyText": "Lets maybe add a one-line description of what this config does?\nAlso if it'd be possible to shrink the name somewhat.", "author": "rmatharu", "createdAt": "2020-04-03T02:20:40Z", "path": "samza-core/src/main/java/org/apache/samza/config/TaskConfig.java", "diffHunk": "@@ -105,6 +105,7 @@\n   private static final String BROADCAST_STREAM_PATTERN = \"^[\\\\d]+$\";\n   private static final String BROADCAST_STREAM_RANGE_PATTERN = \"^\\\\[[\\\\d]+\\\\-[\\\\d]+\\\\]$\";\n   public static final String CHECKPOINT_MANAGER_FACTORY = \"task.checkpoint.factory\";\n+  public static final String INTERNAL_CHECKPOINT_MANAGER_CONSUMER_STOP_AFTER_FIRST_READ = \"samza.internal.task.checkpoint.consumer.stop.after.first.read\";", "originalCommit": "fbf98ab8c9df5de93d88860d822a9994c85a02fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2NDM3Mg==", "url": "https://github.com/apache/samza/pull/1327#discussion_r403364372", "bodyText": "I initially thought of something like samza.internal.task.checkpoint.consumer.keep.open but thought that the name in the PR currently is more expressive of behavior.\nThoughts?", "author": "bkonold", "createdAt": "2020-04-03T22:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMDAwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM2NDcwMA==", "url": "https://github.com/apache/samza/pull/1327#discussion_r403364700", "bodyText": "sure lets go with that one then", "author": "rmatharu", "createdAt": "2020-04-03T22:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcwMDAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "67849b69ab048867e90770971444e1993fb9491f", "chunk": "diff --git a/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java b/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\nindex 31a1691b..468d9c9a 100644\n--- a/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\n+++ b/samza-core/src/main/java/org/apache/samza/config/TaskConfig.java\n\n@@ -105,6 +105,7 @@ public class TaskConfig extends MapConfig {\n   private static final String BROADCAST_STREAM_PATTERN = \"^[\\\\d]+$\";\n   private static final String BROADCAST_STREAM_RANGE_PATTERN = \"^\\\\[[\\\\d]+\\\\-[\\\\d]+\\\\]$\";\n   public static final String CHECKPOINT_MANAGER_FACTORY = \"task.checkpoint.factory\";\n+  // standby containers use this flag to indicate that checkpoints will be polled continually, rather than only once at startup like in an active container\n   public static final String INTERNAL_CHECKPOINT_MANAGER_CONSUMER_STOP_AFTER_FIRST_READ = \"samza.internal.task.checkpoint.consumer.stop.after.first.read\";\n \n   public static final String TRANSACTIONAL_STATE_CHECKPOINT_ENABLED = \"task.transactional.state.checkpoint.enabled\";\n"}}, {"oid": "67849b69ab048867e90770971444e1993fb9491f", "url": "https://github.com/apache/samza/commit/67849b69ab048867e90770971444e1993fb9491f", "message": "adding doc strings", "committedDate": "2020-04-03T22:38:17Z", "type": "commit"}, {"oid": "35ec1aa5a57864b6d687942f0216f6016aafe95a", "url": "https://github.com/apache/samza/commit/35ec1aa5a57864b6d687942f0216f6016aafe95a", "message": "unit tests and fixing config initialization in SamzaContainer", "committedDate": "2020-04-06T23:51:37Z", "type": "commit"}, {"oid": "25b0ab2e28a2ed6297d7487b7ce2adff0d670d97", "url": "https://github.com/apache/samza/commit/25b0ab2e28a2ed6297d7487b7ce2adff0d670d97", "message": "verify no interactions after stop() in unit test", "committedDate": "2020-04-07T00:36:20Z", "type": "commit"}]}