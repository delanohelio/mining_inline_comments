{"pr_number": 745, "pr_title": "Support MFA-TOTP Auth", "pr_createdAt": "2020-04-02T10:16:59Z", "pr_url": "https://github.com/halo-dev/halo/pull/745", "timeline": [{"oid": "84ab41770528b8fce49721bd474c12ca58ea0aa6", "url": "https://github.com/halo-dev/halo/commit/84ab41770528b8fce49721bd474c12ca58ea0aa6", "message": "add tfa utils", "committedDate": "2020-03-27T11:46:05Z", "type": "commit"}, {"oid": "abe3b3696be9f24ce839352bf4106e4f4b4eb3dc", "url": "https://github.com/halo-dev/halo/commit/abe3b3696be9f24ce839352bf4106e4f4b4eb3dc", "message": "Merge branch 'master' of github.com:halo-dev/halo", "committedDate": "2020-03-30T02:25:43Z", "type": "commit"}, {"oid": "f4ba9b120774f289c263079f95f07b6c7ff2f907", "url": "https://github.com/halo-dev/halo/commit/f4ba9b120774f289c263079f95f07b6c7ff2f907", "message": "MFA check api completed", "committedDate": "2020-03-30T08:46:50Z", "type": "commit"}, {"oid": "a1a24d06b6eb7295749f0af07aa114b7834078cb", "url": "https://github.com/halo-dev/halo/commit/a1a24d06b6eb7295749f0af07aa114b7834078cb", "message": "adminController add loginPreCheck api", "committedDate": "2020-04-01T06:37:19Z", "type": "commit"}, {"oid": "d3c8802814150449e602593bfe0d6dbe1ecd4a8f", "url": "https://github.com/halo-dev/halo/commit/d3c8802814150449e602593bfe0d6dbe1ecd4a8f", "message": "halo-admin test", "committedDate": "2020-04-02T10:05:06Z", "type": "commit"}, {"oid": "d21d8c93a9fde6aaad47e78377787506d9c10778", "url": "https://github.com/halo-dev/halo/commit/d21d8c93a9fde6aaad47e78377787506d9c10778", "message": "checkstyle", "committedDate": "2020-04-02T10:28:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0ODA4Mw==", "url": "https://github.com/halo-dev/halo/pull/745#discussion_r402348083", "bodyText": "\u8fd9\u4e2a\u63a5\u53e3\u9700\u8981\u5728 https://github.com/halo-dev/halo/blob/master/src/main/java/run/halo/app/security/filter/AdminAuthenticationFilter.java#L59 \u8fd9\u91cc\u5f00\u653e\u3002", "author": "ruibaby", "createdAt": "2020-04-02T14:16:52Z", "path": "src/main/java/run/halo/app/controller/admin/api/AdminController.java", "diffHunk": "@@ -46,11 +49,19 @@ public boolean isInstall() {\n         return optionService.getByPropertyOrDefault(PrimaryProperties.IS_INSTALLED, Boolean.class, false);\n     }\n \n+    @PostMapping(\"login/precheck\")", "originalCommit": "d21d8c93a9fde6aaad47e78377787506d9c10778", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0ODQyNg==", "url": "https://github.com/halo-dev/halo/pull/745#discussion_r402348426", "bodyText": "\u4e2d\u82f1\u6587\u95f4\u7528\u7a7a\u683c\u9694\u5f00\u3002", "author": "ruibaby", "createdAt": "2020-04-02T14:17:19Z", "path": "src/main/java/run/halo/app/controller/admin/api/UserController.java", "diffHunk": "@@ -57,4 +66,42 @@ public UserDTO updateProfile(@RequestBody UserParam userParam, User user) {\n         userService.updatePassword(passwordParam.getOldPassword(), passwordParam.getNewPassword(), user.getId());\n         return BaseResponse.ok(\"\u5bc6\u7801\u4fee\u6539\u6210\u529f\");\n     }\n+\n+    @PutMapping(\"mfa/generate\")\n+    @ApiOperation(\"Generate Multi-Factor Auth qr image\")\n+    @DisableOnCondition\n+    public MultiFactorAuthVO generateMFAQrImage(@RequestBody MultiFactorAuthParam multiFactorAuthParam, User user) {\n+        if (MFAType.NONE == user.getMfaType()) {\n+            if (MFAType.TFA_TOTP == multiFactorAuthParam.getMfaType()) {\n+                String mfaKey = TwoFactorAuthUtils.generateTFAKey();\n+                String optAuthUrl = TwoFactorAuthUtils.generateOtpAuthUrl(user.getNickname(), mfaKey);\n+                String qrImageBase64 = \"data:image/png;base64,\" +\n+                        Base64.encode(QrCodeUtil.generatePng(optAuthUrl, 128, 128));\n+                return new MultiFactorAuthVO(qrImageBase64, optAuthUrl, mfaKey, MFAType.TFA_TOTP);\n+            } else {\n+                throw new BadRequestException(\"\u6682\u4e0d\u652f\u6301\u7684MFA\u8ba4\u8bc1\u7684\u65b9\u5f0f\");", "originalCommit": "d21d8c93a9fde6aaad47e78377787506d9c10778", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0a8a897b75b3050bb0e90c2fb03e96b63b3cc312", "chunk": "diff --git a/src/main/java/run/halo/app/controller/admin/api/UserController.java b/src/main/java/run/halo/app/controller/admin/api/UserController.java\nindex b697f1cc..795e349b 100644\n--- a/src/main/java/run/halo/app/controller/admin/api/UserController.java\n+++ b/src/main/java/run/halo/app/controller/admin/api/UserController.java\n\n@@ -79,10 +79,10 @@ public class UserController {\n                         Base64.encode(QrCodeUtil.generatePng(optAuthUrl, 128, 128));\n                 return new MultiFactorAuthVO(qrImageBase64, optAuthUrl, mfaKey, MFAType.TFA_TOTP);\n             } else {\n-                throw new BadRequestException(\"\u6682\u4e0d\u652f\u6301\u7684MFA\u8ba4\u8bc1\u7684\u65b9\u5f0f\");\n+                throw new BadRequestException(\"\u6682\u4e0d\u652f\u6301\u7684 MFA \u8ba4\u8bc1\u7684\u65b9\u5f0f\");\n             }\n         } else {\n-            throw new BadRequestException(\"MFA\u8ba4\u8bc1\u5df2\u542f\u7528\uff0c\u65e0\u9700\u91cd\u590d\u64cd\u4f5c\");\n+            throw new BadRequestException(\"MFA \u8ba4\u8bc1\u5df2\u542f\u7528\uff0c\u65e0\u9700\u91cd\u590d\u64cd\u4f5c\");\n         }\n     }\n \n"}}, {"oid": "0a8a897b75b3050bb0e90c2fb03e96b63b3cc312", "url": "https://github.com/halo-dev/halo/commit/0a8a897b75b3050bb0e90c2fb03e96b63b3cc312", "message": "add unit test", "committedDate": "2020-04-03T02:24:27Z", "type": "commit"}, {"oid": "0029dc46a11163a89a10c6e6dbca3d07a4d5f121", "url": "https://github.com/halo-dev/halo/commit/0029dc46a11163a89a10c6e6dbca3d07a4d5f121", "message": "reset MFA", "committedDate": "2020-04-03T16:54:25Z", "type": "commit"}]}