{"pr_number": 2998, "pr_title": "Refactor pod dns", "pr_createdAt": "2020-05-12T15:40:50Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998", "timeline": [{"oid": "1a748ec1c18d9252e81d2ff14f1d4ebc76486ca0", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1a748ec1c18d9252e81d2ff14f1d4ebc76486ca0", "message": "refactor: PodDns helper functions\n\nRefactored this code so that the way hostnames\nare constructed is guaranteed to be consistent across\nmodels\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>", "committedDate": "2020-05-12T15:14:42Z", "type": "commit"}, {"oid": "7258c67a3374b3d2464f100451434510c0f47cf3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7258c67a3374b3d2464f100451434510c0f47cf3", "message": "feat: add service DNS name generator\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>", "committedDate": "2020-05-12T15:23:59Z", "type": "commit"}, {"oid": "d93a03b423914a9062baea3e5b9108f96a1fac4a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d93a03b423914a9062baea3e5b9108f96a1fac4a", "message": "feat: Documentation cleanup and tests\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>", "committedDate": "2020-05-12T15:38:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r423851415", "bodyText": "could be not necessarily an STS right?", "author": "ppatierno", "createdAt": "2020-05-12T16:01:23Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java", "diffHunk": "@@ -59,6 +63,74 @@ private ModelUtils() {}\n     public static final String KUBERNETES_SERVICE_DNS_DOMAIN =\n             System.getenv().getOrDefault(\"KUBERNETES_SERVICE_DNS_DOMAIN\", \"cluster.local\");\n \n+    /**\n+     * Generates the DNS name of the pod including the cluster suffix\n+     * (i.e. usually with the cluster.local - but can be different on different clusters)\n+     * Example: my-pod-1.my-service.my-ns.svc.cluster.local\n+     *\n+     * @param namespace     Namespace of the pod\n+     * @param serviceName   Name of the cluster\n+     * @param podName       Name of the pod within the STS", "originalCommit": "d93a03b423914a9062baea3e5b9108f96a1fac4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NTIzOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r423865238", "bodyText": "I don't think you can address a pod from a deployment or job like this, and for another matter I think you probably shouldn't in general.\nWhen contacting a deployment, you would normally resolve the service address and allow that to route you to wherever kube deems best (normally round robin).\nI think that you would only ever contact a pod like this via an STS due to the statefulness and ordinals, but I might be wrong on that.", "author": "samuel-hawker", "createdAt": "2020-05-12T16:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg2NTcxOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r423865718", "bodyText": "Also thanks for the approve!", "author": "samuel-hawker", "createdAt": "2020-05-12T16:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg3NDM2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r423874368", "bodyText": "Though I am in two minds since even if it is only usable by sts, the helper is at the generic pod level...\nI will change it and doc a note in the javadoc", "author": "samuel-hawker", "createdAt": "2020-05-12T16:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1MTM2Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r423951362", "bodyText": "Well I think that you could potentially addressing the pod. The problem is that the pod name from a deployment is built from the deployment name, a random number for the underlying replicaset and another random number related to the pod itself. With StatefulSets of course it is simpler due to the naming convention with ordinals. Anyway I agree, this utils class is at pod level so it's better don't mention St's. Anyway it's really a minor thing. The PR LGTM ;)", "author": "ppatierno", "createdAt": "2020-05-12T18:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA0MDQ4NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2998#discussion_r424040485", "bodyText": "I don't think this has to be STS. But it has to be headless service and it is usually used with STS. The whole idea of stable DNS name for Deploment pods is kinds invalid.", "author": "scholzj", "createdAt": "2020-05-12T21:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg1MTQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f7f06930ead08d28cfea9ac8eb56fd6e484de027", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java\nindex 9e072c4b6..22417a744 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java\n\n@@ -68,9 +68,11 @@ public class ModelUtils {\n      * (i.e. usually with the cluster.local - but can be different on different clusters)\n      * Example: my-pod-1.my-service.my-ns.svc.cluster.local\n      *\n+     * Note: Conventionally this would only be used for pods with deterministic names such as statefulset pods\n+     *\n      * @param namespace     Namespace of the pod\n      * @param serviceName   Name of the cluster\n-     * @param podName       Name of the pod within the STS\n+     * @param podName       Name of the pod\n      *\n      * @return              DNS name of the pod\n      */\n"}}, {"oid": "f7f06930ead08d28cfea9ac8eb56fd6e484de027", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f7f06930ead08d28cfea9ac8eb56fd6e484de027", "message": "fix: Correct helper to not directly reference sts\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>", "committedDate": "2020-05-12T16:36:00Z", "type": "commit"}]}