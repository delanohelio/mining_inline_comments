{"pr_number": 2823, "pr_title": "Allow changes to storage overrides before scale-up or after scale-down", "pr_createdAt": "2020-04-11T21:35:53Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823", "timeline": [{"oid": "9f34177bebe5647902808897c4acd1ff1ee308b5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9f34177bebe5647902808897c4acd1ff1ee308b5", "message": "Allow changes to storage overrides before scale-up or after scale-down\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-04-11T21:09:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NDgyOQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407174829", "bodyText": "any reason for not calling using nodeId directly in the for loop?", "author": "ppatierno", "createdAt": "2020-04-12T09:54:24Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/StorageDiff.java", "diffHunk": "@@ -136,4 +171,55 @@ public boolean changesType() {\n     public boolean shrinkSize() {\n         return shrinkSize;\n     }\n+\n+    /**\n+     * Validates the changes to the storage overrides and decides whether they are allowed or not. Allowed changes are\n+     * those to nodes which will be added, removed or which do nto exist yet.\n+     *\n+     * @param current           Current Storage configuration\n+     * @param desired           New storage configuration\n+     * @param currentReplicas   Current number of replicas\n+     * @param desiredReplicas   Desired number of replicas\n+     * @return                  True if only allowed override changes were done, false othewise\n+     */\n+    private boolean isOverrideChangeAllowed(Storage current, Storage desired,  int currentReplicas, int desiredReplicas)   {\n+        List<PersistentClaimStorageOverride> currentOverrides = ((PersistentClaimStorage) current).getOverrides();\n+        if (currentOverrides == null)   {\n+            currentOverrides = Collections.emptyList();\n+        }\n+\n+        List<PersistentClaimStorageOverride> desiredOverrides = ((PersistentClaimStorage) desired).getOverrides();\n+        if (desiredOverrides == null)   {\n+            desiredOverrides = Collections.emptyList();\n+        }\n+\n+        // We care only about the nodes which existed before this reconciliation and will still exist after it\n+        int existedAndWillExist = Math.min(currentReplicas, desiredReplicas);\n+\n+        for (int i = 0; i < existedAndWillExist; i++)    {\n+            int nodeId = i;", "originalCommit": "9f34177bebe5647902808897c4acd1ff1ee308b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NjE4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407176186", "bodyText": "It is used in the lambdas when filtering the lists. So it needs to be effectively final. That is why I do not use i directly.", "author": "scholzj", "createdAt": "2020-04-12T10:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NDgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NzE2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407177167", "bodyText": "Right.", "author": "ppatierno", "createdAt": "2020-04-12T10:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NDgyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NTUxNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407175514", "bodyText": "Maybe not related to this PR but why the zkCurrentReplicas is declared as Integer and not just a simple int which makes a little bit different the way we pass the old replicas between ZooKeeper and Kafka in the next code? Can the getReplicas() return null on a StatefulSet? The same is used in the KafkaClusterDescription but setting an int so I would say no.", "author": "ppatierno", "createdAt": "2020-04-12T10:00:41Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -1278,14 +1278,14 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n                     .compose(sts -> {\n                         Storage oldStorage = getOldStorage(sts);\n \n-                        this.zkCluster = ZookeeperCluster.fromCrd(kafkaAssembly, versions, oldStorage);\n-                        this.zkService = zkCluster.generateService();\n-                        this.zkHeadlessService = zkCluster.generateHeadlessService();\n-\n                         if (sts != null && sts.getSpec() != null)   {\n                             this.zkCurrentReplicas = sts.getSpec().getReplicas();\n                         }\n \n+                        this.zkCluster = ZookeeperCluster.fromCrd(kafkaAssembly, versions, oldStorage, zkCurrentReplicas != null ? zkCurrentReplicas : 0);", "originalCommit": "9f34177bebe5647902808897c4acd1ff1ee308b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NjQ4Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407176486", "bodyText": "zkCurrentReplicas is used by the Zookeeper scaling where null indicates bascially new cluster. Therefore it exists as Integer and is a class variable. Thsi is there for a long time, I really just reuse the variable instead of creating another local one just for the Storage diff.\nFor Kafka we do not use it anywhere for anything else. So I created a new local variable and since the storage diff has a different requirements it is sufficient this time to use int.", "author": "scholzj", "createdAt": "2020-04-12T10:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NTUxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NzM3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2823#discussion_r407177379", "bodyText": "Ah ok, now I see zkCurrentReplicas stays null when there is no STS yet, so new cluster. Thanks.", "author": "ppatierno", "createdAt": "2020-04-12T10:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE3NTUxNA=="}], "type": "inlineReview", "revised_code": null}]}