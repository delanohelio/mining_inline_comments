{"pr_number": 3348, "pr_title": "Fixed NPEs related to dynamic configuration", "pr_createdAt": "2020-07-21T10:39:28Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348", "timeline": [{"oid": "b3716d65137177d0bba13451a48517d7297b17a8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b3716d65137177d0bba13451a48517d7297b17a8", "message": "Fixes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-21T10:36:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458005248", "bodyText": "Why do we need to move the get on the Kafka cluster description?\nMaybe add a comment for the context why this breaks convention.", "author": "samuel-hawker", "createdAt": "2020-07-21T10:46:18Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -265,6 +265,7 @@ public KafkaAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa,\n         reconcileState.initialStatus()\n                 .compose(state -> state.reconcileCas(this::dateSupplier))\n                 .compose(state -> state.clusterOperatorSecret(this::dateSupplier))\n+                .compose(state -> state.getKafkaClusterDescription())", "originalCommit": "b3716d65137177d0bba13451a48517d7297b17a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNjU4Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458006583", "bodyText": "getKafkaClusterDescription() defines kafkaCluster what is used in rollingUpdateForNewCaKey() for KafkaRoller ctor.", "author": "sknot-rh", "createdAt": "2020-07-21T10:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNzYxMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458007611", "bodyText": "Makes sense, can we add that as a comment to make that intent clear in the reconcile?", "author": "samuel-hawker", "createdAt": "2020-07-21T10:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE0MDcxMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458140710", "bodyText": "I wonder how much dangerous this is since creating the description too early can break other things.", "author": "scholzj", "createdAt": "2020-07-21T14:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1NTY1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458155658", "bodyText": "To be honest, this move kind of smells of improper separation of responsibilities.\nIs there a less heavy handed way of supplying the information needed in rollingUpdateForNewCaKey?", "author": "samuel-hawker", "createdAt": "2020-07-21T14:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE4Mjg4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458182881", "bodyText": "I had a look at the code and I do not think moving the method would cause any issues (should be confirmed by STs as well).\nI agree that this shows deeper issues. I think the problem is that we do Kafka rolling upgrade on multiple places (C renewals, upgrades, regular RUetc.) and not just in one place. That leads to inconsistencies and errors. But I think it is beyond this PR to fix that. We should probably have some issue for it and look at it in the future.", "author": "scholzj", "createdAt": "2020-07-21T15:22:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTI0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAwNTk1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3348#discussion_r458005958", "bodyText": "It might be worth documenting a null desired state does not mean an empty broker state but is indeed a shortcut for saying no changes required.\nThis can not be assumed and should be in the javadoc", "author": "samuel-hawker", "createdAt": "2020-07-21T10:47:50Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerConfigurationDiff.java", "diffHunk": "@@ -139,7 +139,7 @@ private static boolean isIgnorableProperty(String key) {\n     private static Collection<AlterConfigOp> diff(int brokerId, String desired,\n                                                   Config brokerConfigs,\n                                                   Map<String, ConfigModel> configModel) {\n-        if (brokerConfigs == null) {\n+        if (brokerConfigs == null || desired == null) {", "originalCommit": "b3716d65137177d0bba13451a48517d7297b17a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9317511b2c5612bc38eb658327af95b6ca122fb8", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerConfigurationDiff.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerConfigurationDiff.java\nindex 7deb6560f6..28d00c12a4 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerConfigurationDiff.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerConfigurationDiff.java\n\n@@ -131,7 +131,7 @@ public class KafkaBrokerConfigurationDiff extends AbstractResourceDiff {\n     /**\n      * Computes diff between two maps. Entries in IGNORABLE_PROPERTIES are skipped\n      * @param brokerId id of compared broker\n-     * @param desired desired configuration\n+     * @param desired desired configuration, may be null if the related ConfigMap does not exist yet or no changes are required\n      * @param brokerConfigs current configuration\n      * @param configModel default configuration for {@code kafkaVersion} of broker\n      * @return KafkaConfiguration containing all entries which were changed from current in desired configuration\n"}}, {"oid": "9317511b2c5612bc38eb658327af95b6ca122fb8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9317511b2c5612bc38eb658327af95b6ca122fb8", "message": "Sam's comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-07-22T06:26:23Z", "type": "commit"}]}