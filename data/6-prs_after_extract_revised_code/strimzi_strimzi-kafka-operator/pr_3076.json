{"pr_number": 3076, "pr_title": "Fix storage size comparsion", "pr_createdAt": "2020-05-22T08:20:48Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076", "timeline": [{"oid": "69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-22T08:23:12Z", "type": "forcePushed"}, {"oid": "594e243545f92e53ae1f7cac2754ac571339313b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/594e243545f92e53ae1f7cac2754ac571339313b", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-22T09:15:18Z", "type": "forcePushed"}, {"oid": "befa27b4be116074243fb844bc045672d59df6e6", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/befa27b4be116074243fb844bc045672d59df6e6", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-22T09:17:30Z", "type": "forcePushed"}, {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80c1973754686281ed9e9e041f67a60d83224f3", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-22T09:19:01Z", "type": "commit"}, {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80c1973754686281ed9e9e041f67a60d83224f3", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-22T09:19:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4MTU5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#discussion_r429281594", "bodyText": "I think you should try to optimize the code a bit. You should probably first check the path whether it matches the VOLUME_SIZE path. Only then you should do the lookups.\nIf you keep using separate method for it, it migth also make more sense to have a method isVolumeSizeChanged instead of using ``isvolumeSizeEqual`. It will make the code more readable.", "author": "scholzj", "createdAt": "2020-05-22T14:30:28Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java", "diffHunk": "@@ -107,7 +108,7 @@ public StatefulSetDiff(StatefulSet current, StatefulSet desired) {\n             // Any volume claim template changes apart from size change should trigger rolling update\n             // Size changes should not trigger rolling update. Therefore we need to separate these two in the diff.\n             changesVolumeClaimTemplate |= equalsOrPrefix(\"/spec/volumeClaimTemplates\", pathValue) && !VOLUME_SIZE.matcher(pathValue).matches();\n-            changesVolumeSize |= VOLUME_SIZE.matcher(pathValue).matches();\n+            changesVolumeSize |= !isVolumeSizeEqual(pathValue, lookupPath(source, pathValue), lookupPath(target, pathValue));", "originalCommit": "c80c1973754686281ed9e9e041f67a60d83224f3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9d81075959f6b7a7b36f75ddda2b27057f9f8e4b", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java\nindex 7e7249c7f0..419130c5a0 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java\n\n@@ -108,7 +108,7 @@ public class StatefulSetDiff extends AbstractResourceDiff {\n             // Any volume claim template changes apart from size change should trigger rolling update\n             // Size changes should not trigger rolling update. Therefore we need to separate these two in the diff.\n             changesVolumeClaimTemplate |= equalsOrPrefix(\"/spec/volumeClaimTemplates\", pathValue) && !VOLUME_SIZE.matcher(pathValue).matches();\n-            changesVolumeSize |= !isVolumeSizeEqual(pathValue, lookupPath(source, pathValue), lookupPath(target, pathValue));\n+            changesVolumeSize |= isVolumeSizeChanged(pathValue, source, target);\n             // Change changes to /spec/template/spec, except to imagePullPolicy, which gets changed\n             // by k8s\n             changesSpecTemplate |= equalsOrPrefix(\"/spec/template\", pathValue);\n"}}, {"oid": "9d81075959f6b7a7b36f75ddda2b27057f9f8e4b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9d81075959f6b7a7b36f75ddda2b27057f9f8e4b", "message": "optimize\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-05-25T06:05:41Z", "type": "commit"}]}