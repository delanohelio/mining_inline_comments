{"pr_number": 4058, "pr_title": "Add check for inter.broker.protocol.version and warning to status conditions", "pr_createdAt": "2020-12-05T15:49:55Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4058", "timeline": [{"oid": "1f5ce1f32c3a7de929ccd3195c9a79b7091797d8", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1f5ce1f32c3a7de929ccd3195c9a79b7091797d8", "message": "Add check for inter.broker.protocol.version and warning to status conditions\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-05T15:45:00Z", "type": "commit"}, {"oid": "84fe7a3faedf0814330af6e1c9db0de22a8180de", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/84fe7a3faedf0814330af6e1c9db0de22a8180de", "message": "Fix spotbugs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-05T16:06:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzMTE5Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4058#discussion_r537531196", "bodyText": "I know it's not part of this PR, but this regex looks dodgy to me. I would expect it to be \\d+(\\.\\d+)+.* (not quoted for use in a String literal) (see kafka.api.ApiVersion#apply for how they're actually validated).", "author": "tombentley", "createdAt": "2020-12-07T14:05:58Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaSpecChecker.java", "diffHunk": "@@ -25,31 +26,37 @@\n  * lead to problems.\n  */\n public class KafkaSpecChecker {\n-\n-    private KafkaSpec spec;\n-    private KafkaCluster kafkaCluster;\n-    private ZookeeperCluster zkCluster;\n+    private final KafkaCluster kafkaCluster;\n+    private final ZookeeperCluster zkCluster;\n+    private final String kafkaBrokerVersion;\n \n     private final static Pattern VERSION_REGEX = Pattern.compile(\"(\\\\d\\\\.\\\\d+).*\");", "originalCommit": "84fe7a3faedf0814330af6e1c9db0de22a8180de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4NTEwMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4058#discussion_r537685101", "bodyText": "@tombentley kafka.api.ApiVersion#apply seems to take the first and the second segments. But I think it does something different then we do. We do not validate the protocol / format version here. We want to to get the numeric part only and compare it against the version if they match which tells us they are from the same version. The actual version is validated in other place in our case.\nSo I think the original pattern works well apart from not expecting any double-digit major Kafka versions. But the use of the matcher seems to be weird. The group 0 returns the whole pattern. So that seems to be wrong because when you use protocol format as 2.6-IV0 it would never match 2.6.0. So I tried to fix that by using the right group.\nPlease have a look and let me know if I misunderstood what you meant.", "author": "scholzj", "createdAt": "2020-12-07T17:21:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzMTE5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQyNTE1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4058#discussion_r538425157", "bodyText": "Group 0 is always the whole match, and the capturing groups are then 1-based. You're right about the first two numbers thing, so (\\d+\\.\\d+).* should be enough, that way the .* can match patch versions (and the internal version part, which I'd never expect to be present in practice). Probably a good idea to add a comment too.", "author": "tombentley", "createdAt": "2020-12-08T14:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUzMTE5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "80b88588aa98a6c494399af260adcc38cf0a5b7a", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaSpecChecker.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaSpecChecker.java\nindex ae704d8e1f..6ccd1c3dac 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaSpecChecker.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaSpecChecker.java\n\n@@ -30,7 +30,7 @@ public class KafkaSpecChecker {\n     private final ZookeeperCluster zkCluster;\n     private final String kafkaBrokerVersion;\n \n-    private final static Pattern VERSION_REGEX = Pattern.compile(\"(\\\\d\\\\.\\\\d+).*\");\n+    private final static Pattern VERSION_REGEX = Pattern.compile(\"(\\\\d+\\\\.\\\\d+).*\");\n \n     /**\n      * @param spec The spec requested by the user in the CR\n"}}, {"oid": "80b88588aa98a6c494399af260adcc38cf0a5b7a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/80b88588aa98a6c494399af260adcc38cf0a5b7a", "message": "Fix the version matching\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-07T17:21:15Z", "type": "commit"}, {"oid": "4fba946130f91c44702b3dd9816084e10ab9246f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4fba946130f91c44702b3dd9816084e10ab9246f", "message": "Add comment and rename the pattern to make its purpose more clear\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-08T15:46:47Z", "type": "commit"}]}