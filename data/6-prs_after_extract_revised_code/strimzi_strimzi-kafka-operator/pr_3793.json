{"pr_number": 3793, "pr_title": "[Enhancement] ClusterCaCert - Pass labels to secrets", "pr_createdAt": "2020-10-12T15:39:02Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3793", "timeline": [{"oid": "9a995c89e3242a686f2a44be121c9492d4fc926f", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9a995c89e3242a686f2a44be121c9492d4fc926f", "message": "[[Enhancement] ClusterCaCert - Pass labels to secrets]\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-12T15:39:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MDA3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3793#discussion_r504280076", "bodyText": "Could you use individual imports instead of this as it was before?", "author": "scholzj", "createdAt": "2020-10-13T21:52:55Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -142,9 +143,7 @@\n import static io.strimzi.operator.cluster.model.KafkaConfiguration.INTERBROKER_PROTOCOL_VERSION;\n import static io.strimzi.operator.cluster.model.KafkaConfiguration.LOG_MESSAGE_FORMAT_VERSION;\n import static io.strimzi.operator.cluster.model.KafkaVersion.compareDottedVersions;\n-import static java.util.Collections.emptyList;\n-import static java.util.Collections.singletonList;\n-import static java.util.Collections.singletonMap;\n+import static java.util.Collections.*;", "originalCommit": "9a995c89e3242a686f2a44be121c9492d4fc926f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5da90ef5fe54ef45594624308388805fccb9f140", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex fffb6772c1..2a679b0011 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -143,7 +143,10 @@ import static io.strimzi.operator.cluster.model.KafkaCluster.ANNO_STRIMZI_IO_TO_\n import static io.strimzi.operator.cluster.model.KafkaConfiguration.INTERBROKER_PROTOCOL_VERSION;\n import static io.strimzi.operator.cluster.model.KafkaConfiguration.LOG_MESSAGE_FORMAT_VERSION;\n import static io.strimzi.operator.cluster.model.KafkaVersion.compareDottedVersions;\n-import static java.util.Collections.*;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.Collections.singletonMap;\n+import static java.util.Collections.emptyMap;\n \n /**\n  * <p>Assembly operator for a \"Kafka\" assembly, which manages:</p>\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4MTA4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3793#discussion_r504281084", "bodyText": "I'm not sure this works. First, it might run thousand times because of the parametrized test. So it would be better to add this to some of the existing tests and to the parameters. Also, this actually doesn't test the result. You set it up,  but you never compare the annotations and labels on the secrets.\nI will think how to fix the test / or where to run it to make it better.", "author": "scholzj", "createdAt": "2020-10-13T21:55:07Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorTest.java", "diffHunk": "@@ -352,6 +354,33 @@ public void testCreateClusterWithJmxEnabled(Params params, VertxTestContext cont\n                 )); //getInitialCertificates(getKafkaAssembly(\"foo\").getMetadata().getName()));\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"data\")\n+    public void testCreateClusterWithAnnotationsAndLabelsInCaCertSecret(Params params, VertxTestContext context) {\n+        setFields(params);\n+        Kafka kafka = getKafkaAssembly(\"foo\");\n+        kafka.getSpec()\n+                .getKafka()\n+                .setTemplate(new KafkaClusterTemplateBuilder()\n+                        .withClusterCaCert(\n+                                new ResourceTemplateBuilder()\n+                                        .withNewMetadata()\n+                                        .withLabels(Collections.singletonMap(\"foo\", \"bar\"))\n+                                        .withAnnotations(Collections.singletonMap(\"foo\", \"bar\"))\n+                                        .endMetadata()\n+                                        .build())\n+                        .build());\n+\n+        createCluster(context, kafka, Collections.singletonList(new SecretBuilder()\n+                .withNewMetadata()\n+                .withName(KafkaCluster.jmxSecretName(\"foo\"))\n+                .withNamespace(\"test\")\n+                .endMetadata()\n+                .withData(Collections.singletonMap(\"foo\", \"bar\"))\n+                .build()\n+        ));\n+    }", "originalCommit": "9a995c89e3242a686f2a44be121c9492d4fc926f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5da90ef5fe54ef45594624308388805fccb9f140", "chunk": "diff --git a/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorTest.java b/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorTest.java\nindex 3521ee1d5e..4e03390069 100644\n--- a/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorTest.java\n+++ b/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorTest.java\n\n@@ -354,33 +354,6 @@ public class KafkaAssemblyOperatorTest {\n                 )); //getInitialCertificates(getKafkaAssembly(\"foo\").getMetadata().getName()));\n     }\n \n-    @ParameterizedTest\n-    @MethodSource(\"data\")\n-    public void testCreateClusterWithAnnotationsAndLabelsInCaCertSecret(Params params, VertxTestContext context) {\n-        setFields(params);\n-        Kafka kafka = getKafkaAssembly(\"foo\");\n-        kafka.getSpec()\n-                .getKafka()\n-                .setTemplate(new KafkaClusterTemplateBuilder()\n-                        .withClusterCaCert(\n-                                new ResourceTemplateBuilder()\n-                                        .withNewMetadata()\n-                                        .withLabels(Collections.singletonMap(\"foo\", \"bar\"))\n-                                        .withAnnotations(Collections.singletonMap(\"foo\", \"bar\"))\n-                                        .endMetadata()\n-                                        .build())\n-                        .build());\n-\n-        createCluster(context, kafka, Collections.singletonList(new SecretBuilder()\n-                .withNewMetadata()\n-                .withName(KafkaCluster.jmxSecretName(\"foo\"))\n-                .withNamespace(\"test\")\n-                .endMetadata()\n-                .withData(Collections.singletonMap(\"foo\", \"bar\"))\n-                .build()\n-        ));\n-    }\n-\n     @ParameterizedTest\n     @MethodSource(\"data\")\n     public void testCreateClusterWithJmxTrans(Params params, VertxTestContext context) {\n"}}, {"oid": "2b1363526818e25236a4136530e79f5c281d85ce", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2b1363526818e25236a4136530e79f5c281d85ce", "message": "[[Enhancement] ClusterCaCert - Pass labels to secrets]\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-19T21:40:22Z", "type": "commit"}, {"oid": "927ef25e826f4365c7db2c6fbe879bfd20a9b610", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/927ef25e826f4365c7db2c6fbe879bfd20a9b610", "message": "Add a better test\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-19T21:40:22Z", "type": "commit"}, {"oid": "5da90ef5fe54ef45594624308388805fccb9f140", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5da90ef5fe54ef45594624308388805fccb9f140", "message": "Remove test and fix import comments\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-19T21:40:22Z", "type": "commit"}, {"oid": "b52f08456173fd660aa95fcad49f5cfded9d4f5b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b52f08456173fd660aa95fcad49f5cfded9d4f5b", "message": "Remove unused import\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-19T21:40:22Z", "type": "commit"}, {"oid": "b52f08456173fd660aa95fcad49f5cfded9d4f5b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b52f08456173fd660aa95fcad49f5cfded9d4f5b", "message": "Remove unused import\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-19T21:40:22Z", "type": "forcePushed"}, {"oid": "3717239b8eff587712a1f332117bf8c375be6091", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3717239b8eff587712a1f332117bf8c375be6091", "message": "Checktype validate correctly\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-20T09:37:00Z", "type": "commit"}, {"oid": "3717239b8eff587712a1f332117bf8c375be6091", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3717239b8eff587712a1f332117bf8c375be6091", "message": "Checktype validate correctly\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-20T09:37:00Z", "type": "forcePushed"}, {"oid": "501efd05de7e11539396d636d3ae3a747449686d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/501efd05de7e11539396d636d3ae3a747449686d", "message": "FIX kafka assembly null when template is null\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-20T10:38:03Z", "type": "commit"}, {"oid": "501efd05de7e11539396d636d3ae3a747449686d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/501efd05de7e11539396d636d3ae3a747449686d", "message": "FIX kafka assembly null when template is null\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-20T10:38:03Z", "type": "forcePushed"}, {"oid": "ee650e9a88af7a54ceb7aa1a6688d48d985f6e40", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ee650e9a88af7a54ceb7aa1a6688d48d985f6e40", "message": "FIX checkstyle again\n\nSigned-off-by: javiercri <javier.criado@masmovil.com>", "committedDate": "2020-10-20T14:07:27Z", "type": "commit"}, {"oid": "270627abcecb403970a43ede833dd2e783f52629", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/270627abcecb403970a43ede833dd2e783f52629", "message": "Update derived resources\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-10-20T15:32:25Z", "type": "commit"}]}