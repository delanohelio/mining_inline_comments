{"pr_number": 2516, "pr_title": "Fix the kafka rolling when the reconciliation failed", "pr_createdAt": "2020-02-07T14:19:22Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyMTA4OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#discussion_r376921088", "bodyText": "I think kafkaAncillaryCmGeneration is a more natural ordering of these terms. zkAncillaryCmGeneration too.", "author": "tombentley", "createdAt": "2020-02-10T08:33:23Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -387,7 +387,8 @@ ReconciliationState createReconciliationState(Reconciliation reconciliation, Kaf\n         private Set<String> kafkaExternalAdvertisedHostnames = new LinkedHashSet<>();\n         private Set<String> kafkaExternalAdvertisedPorts = new LinkedHashSet<>();\n         private Map<Integer, Set<String>> kafkaExternalDnsNames = new HashMap<>();\n-        private boolean kafkaAncillaryCmChange;\n+        private Long ancillaryZkCmGeneration = 0L;\n+        private Long ancillaryKafkaCmGeneration = 0L;", "originalCommit": "cb42ff926c0322a207015c528686a1f6ab58df8e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dc0f9f71129c5b98136889024d41476aeb24492d", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex 9a7d6ed96f..ff5e63761e 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -387,8 +387,8 @@ public class KafkaAssemblyOperator extends AbstractAssemblyOperator<KubernetesCl\n         private Set<String> kafkaExternalAdvertisedHostnames = new LinkedHashSet<>();\n         private Set<String> kafkaExternalAdvertisedPorts = new LinkedHashSet<>();\n         private Map<Integer, Set<String>> kafkaExternalDnsNames = new HashMap<>();\n-        private Long ancillaryZkCmGeneration = 0L;\n-        private Long ancillaryKafkaCmGeneration = 0L;\n+        private Long zkAncillaryCmGeneration = 0L;\n+        private Long kafkaAncillaryCmGeneration = 0L;\n \n         @SuppressWarnings(\"deprecation\")\n         /* test */ io.strimzi.operator.cluster.model.TopicOperator topicOperator;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyMTY2OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#discussion_r376921669", "bodyText": "In theory a NPE might be possible here if the ancillaryCmGeneration is null. Probably best to do the roll if it's null.", "author": "tombentley", "createdAt": "2020-02-10T08:34:59Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -2920,7 +2926,7 @@ private boolean isPodToRestart(StatefulSet sts, Pod pod, boolean isAncillaryCmCh\n                         reasons.add(\"Pod has old \" + ca + \" certificate generation\");\n                     }\n                 }\n-                if (isAncillaryCmChange) {\n+                if (cmAnno != ancillaryCmGeneration) {", "originalCommit": "cb42ff926c0322a207015c528686a1f6ab58df8e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dc0f9f71129c5b98136889024d41476aeb24492d", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex 9a7d6ed96f..ff5e63761e 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -2926,8 +2930,8 @@ public class KafkaAssemblyOperator extends AbstractAssemblyOperator<KubernetesCl\n                         reasons.add(\"Pod has old \" + ca + \" certificate generation\");\n                     }\n                 }\n-                if (cmAnno != ancillaryCmGeneration) {\n-                    reasons.add(\"ancillary CM change\");\n+                if (ancillaryCmGeneration == null || cmAnno != ancillaryCmGeneration) {\n+                    reasons.add(\"ancillary CM change \" + cmAnno + \" vs \" + ancillaryCmGeneration);\n                 }\n                 if (!isPodUpToDate) {\n                     reasons.add(\"Pod has old generation\");\n"}}, {"oid": "dc0f9f71129c5b98136889024d41476aeb24492d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dc0f9f71129c5b98136889024d41476aeb24492d", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T09:33:13Z", "type": "forcePushed"}, {"oid": "3ad54df0ae5abea72962d73a9d3f0fa40b859866", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3ad54df0ae5abea72962d73a9d3f0fa40b859866", "message": "Fix the kafka rolling when the reconciliation failed\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "9f4ce8eef941c194825933f326599e4c47eebc98", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9f4ce8eef941c194825933f326599e4c47eebc98", "message": "maybefix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "05bc21275e696571851ad1907dc4cc7bde13218d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/05bc21275e696571851ad1907dc4cc7bde13218d", "message": "maybefix2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "d24148fa86c936c3f7dfb646a41898b908dadb6b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d24148fa86c936c3f7dfb646a41898b908dadb6b", "message": "maybefix3\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "755559c5df557c2a09761f33d98cc78b87f6753b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/755559c5df557c2a09761f33d98cc78b87f6753b", "message": "maybefix4\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "b521b58b1b202622603a86929748f036e1fc39fd", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b521b58b1b202622603a86929748f036e1fc39fd", "message": "maybefix5\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "94495cb5241385adb8eec3bcbfacc0ce5bb280e2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/94495cb5241385adb8eec3bcbfacc0ce5bb280e2", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:52:15Z", "type": "commit"}, {"oid": "a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T11:53:03Z", "type": "forcePushed"}, {"oid": "e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T12:17:21Z", "type": "commit"}, {"oid": "e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T12:17:21Z", "type": "forcePushed"}, {"oid": "4be5e1ed9b089344c5b618f00ec8910c395c496d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4be5e1ed9b089344c5b618f00ec8910c395c496d", "message": "redisabling test\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-02-13T15:06:43Z", "type": "commit"}]}