{"pr_number": 2430, "pr_title": "SystemTest: wait for s2i cluster to be rebalanced", "pr_createdAt": "2020-01-20T16:23:04Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2430", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYzMzU1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2430#discussion_r368633557", "bodyText": "This line is the count of a substring in the log string.", "author": "sknot-rh", "createdAt": "2020-01-20T16:24:24Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaConnectS2IUtils.java", "diffHunk": "@@ -29,4 +29,15 @@ public static void waitForConnectS2IStatus(String name, String status) {\n             () -> Crds.kafkaConnectS2iOperation(kubeClient().getClient()).inNamespace(kubeClient().getNamespace()).withName(name).get().getStatus().getConditions().get(0).getType().equals(status));\n         LOGGER.info(\"Kafka Connect S2I {} is in desired state: {}\", name, status);\n     }\n+\n+    public static void waitForRebalancingDone(String name) {\n+        LOGGER.info(\"Waiting for Kafka Connect S2I {} to rebalance\", name);\n+        TestUtils.waitFor(\"Kafka Connect S2I rebalancing\", Constants.POLL_INTERVAL_FOR_RESOURCE_READINESS, Constants.TIMEOUT_FOR_RESOURCE_READINESS,\n+            () -> {\n+                String connect = kubeClient().listPodNames(\"strimzi.io/kind\", \"KafkaConnectS2I\").get(0);\n+                String log = kubeClient().logs(connect);\n+                return (log.length() - log.replace(\"Finished starting connectors and tasks\", \"\").length()) / \"Finished starting connectors and tasks\".length() == 2;", "originalCommit": "180f798c01ad58091452f0282ba80d1e73ffcf86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NzAwMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2430#discussion_r372357003", "bodyText": "You should add a comment in the code to explain that.\nAnd why the magic number 2?", "author": "tombentley", "createdAt": "2020-01-29T12:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYzMzU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAxOTY5Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2430#discussion_r373019693", "bodyText": "I do not remember exactly, but when the cluster is started, this message is in the logs. Then we lose one of the replicas and after rebalancing happened, the message is printed again.", "author": "sknot-rh", "createdAt": "2020-01-30T15:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYzMzU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "930c28eb43a537e1d9651fbebcd4564327f3b8cf", "chunk": "diff --git a/systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaConnectS2IUtils.java b/systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaConnectS2IUtils.java\nindex 2739f8974e..06e58d14b2 100644\n--- a/systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaConnectS2IUtils.java\n+++ b/systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaConnectS2IUtils.java\n\n@@ -36,6 +36,7 @@ public class KafkaConnectS2IUtils {\n             () -> {\n                 String connect = kubeClient().listPodNames(\"strimzi.io/kind\", \"KafkaConnectS2I\").get(0);\n                 String log = kubeClient().logs(connect);\n+                // wait for second occurrence of message about finished rebalancing\n                 return (log.length() - log.replace(\"Finished starting connectors and tasks\", \"\").length()) / \"Finished starting connectors and tasks\".length() == 2;\n             });\n         LOGGER.info(\"Kafka Connect S2I {} rebalanced\", name);\n"}}, {"oid": "725aa28a14eebde16ad23aa0ab1691647c3adb56", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/725aa28a14eebde16ad23aa0ab1691647c3adb56", "message": "SystemTest: wait for s2i cluster to be rebalanced\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-31T09:12:59Z", "type": "commit"}, {"oid": "930c28eb43a537e1d9651fbebcd4564327f3b8cf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/930c28eb43a537e1d9651fbebcd4564327f3b8cf", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-31T09:12:59Z", "type": "commit"}, {"oid": "930c28eb43a537e1d9651fbebcd4564327f3b8cf", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/930c28eb43a537e1d9651fbebcd4564327f3b8cf", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>", "committedDate": "2020-01-31T09:12:59Z", "type": "forcePushed"}]}