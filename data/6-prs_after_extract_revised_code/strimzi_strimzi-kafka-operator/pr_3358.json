{"pr_number": 3358, "pr_title": "Fix tracing in Kafka Mirror Maker 2", "pr_createdAt": "2020-07-21T23:10:48Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358", "timeline": [{"oid": "79fc39034d29daeb817b13616c90715d05445d04", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/79fc39034d29daeb817b13616c90715d05445d04", "message": "Fix tracing in Kafka Mirror Maker 2\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-07-21T23:04:35Z", "type": "commit"}, {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7498b990ae10d2c704bacfe70999a4489d93f657", "message": "Add system tests for MM2 and improve MM1 STs with tracing\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-07-22T16:23:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NjEzMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#discussion_r459286131", "bodyText": "I think that these explicit deletions are not needed it should be deleted by ResourceManager.", "author": "see-quick", "createdAt": "2020-07-23T08:19:02Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java", "diffHunk": "@@ -648,6 +787,14 @@ void testProducerConsumerMirrorMakerConnectStreamsService() {\n         LOGGER.info(\"Deleting topic {} from CR\", TOPIC_TARGET_NAME);\n         cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_TARGET_NAME);\n         KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_TARGET_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");", "originalCommit": "7498b990ae10d2c704bacfe70999a4489d93f657", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java b/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\nindex cce0615a90..fc0c3730ad 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\n\n@@ -775,26 +740,6 @@ public class TracingST extends AbstractST {\n         TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n         TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_TARGET_NAME);\n         TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_TARGET_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TEST_TOPIC_NAME);\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TEST_TOPIC_NAME);\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TEST_TOPIC_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME);\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME);\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_TARGET_NAME);\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_TARGET_NAME);\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_TARGET_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME + \"-target\");\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME + \"-target\");\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_TARGET_NAME + \"-target\");\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_TARGET_NAME + \"-target\");\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_TARGET_NAME + \"-target\");\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NjM3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#discussion_r459286373", "bodyText": "Is this specific configuration really needed?", "author": "see-quick", "createdAt": "2020-07-23T08:19:31Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java", "diffHunk": "@@ -553,17 +608,65 @@ void testProducerConsumerMirrorMakerConnectStreamsService() {\n                 .endSpec()\n                 .done();\n \n+        TracingUtils.verify(JAEGER_PRODUCER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_CONSUMER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME);\n+        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME);\n+        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");\n+        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME + \"-target\");\n+        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME + \"-target\");\n+    }\n+\n+    @Test\n+    @Tag(CONNECT)\n+    @Tag(MIRROR_MAKER)\n+    @Tag(CONNECT_COMPONENTS)\n+    @SuppressWarnings({\"checkstyle:MethodLength\"})\n+    void testProducerConsumerMirrorMakerConnectStreamsService() {\n+        Map<String, Object> configOfKafka = new HashMap<>();\n+        configOfKafka.put(\"offsets.topic.replication.factor\", \"1\");\n+        configOfKafka.put(\"transaction.state.log.replication.factor\", \"1\");\n+        configOfKafka.put(\"transaction.state.log.min.isr\", \"1\");", "originalCommit": "7498b990ae10d2c704bacfe70999a4489d93f657", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4ODc3Ng==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#discussion_r459288776", "bodyText": "The GitHub diff might be confusing, but this is your code :-D. I can remove it and see if it still works.", "author": "scholzj", "createdAt": "2020-07-23T08:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NjM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java b/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\nindex cce0615a90..fc0c3730ad 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java\n\n@@ -612,14 +590,6 @@ public class TracingST extends AbstractST {\n         TracingUtils.verify(JAEGER_CONSUMER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n         TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n         TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME);\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME);\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME);\n-\n-        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");\n-        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME + \"-target\");\n-        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME + \"-target\");\n     }\n \n     @Test\n"}}, {"oid": "c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-07-23T08:33:58Z", "type": "commit"}]}