{"pr_number": 3489, "pr_title": "[systemtest] Add test for dynamic logging change of CO", "pr_createdAt": "2020-08-10T15:02:04Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Mzg3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468173870", "bodyText": "How does this one differ from the original one? I didn't compare it in detail. But it looks similar.", "author": "scholzj", "createdAt": "2020-08-10T20:41:58Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -456,6 +457,61 @@ void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n         assertThat(\"Bridge pod should not roll\", DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME)), equalTo(bridgeSnapshot));\n     }\n \n+    @Test\n+    void testDynamicallySetClusterOperatorLoggingLevels() {\n+        Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n+        String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+\n+        String log4jConfig =\n+            \"name = COConfig\\n\" +\n+            \"monitorInterval = 30\\n\" +\n+            \"\\n\" +\n+            \"    appender.console.type = Console\\n\" +\n+            \"    appender.console.name = STDOUT\\n\" +\n+            \"    appender.console.layout.type = PatternLayout\\n\" +\n+            \"    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n\\n\" +\n+            \"\\n\" +\n+            \"    rootLogger.level = INFO\\n\" +\n+            \"    rootLogger.appenderRefs = stdout\\n\" +\n+            \"    rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+            \"    rootLogger.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Kafka AdminClient logging is a bit noisy at INFO level\\n\" +\n+            \"    logger.kafka.name = org.apache.kafka\\n\" +\n+            \"    logger.kafka.level = WARN\\n\" +\n+            \"    logger.kafka.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Zookeeper is very verbose even on INFO level -> We set it to WARN by default\\n\" +\n+            \"    logger.zookeepertrustmanager.name = org.apache.zookeeper\\n\" +\n+            \"    logger.zookeepertrustmanager.level = WARN\\n\" +\n+            \"    logger.zookeepertrustmanager.additivity = false\";", "originalCommit": "e096e578d8ca3160576cbbc153d0addb76cfe3d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ0OTAxMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468449010", "bodyText": "You are right, I'm gonna change it -> the only difference was in lining and white spaces. Thanks!", "author": "im-konge", "createdAt": "2020-08-11T09:29:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3Mzg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a873af6a3485d638ee6bfcef3bbad2b56cb509c9", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\nindex 2a969e3d08..fc692874ea 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n\n@@ -458,9 +458,10 @@ class LoggingChangeST extends AbstractST {\n     }\n \n     @Test\n-    void testDynamicallySetClusterOperatorLoggingLevels() {\n+    void testDynamicallySetClusterOperatorLoggingLevels() throws InterruptedException {\n         Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n         String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n \n         String log4jConfig =\n             \"name = COConfig\\n\" +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NDE3NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468174175", "bodyText": "This is all good. But I do not see anything to check the actual log level used by CO. This is testing Kubernetes.", "author": "scholzj", "createdAt": "2020-08-10T20:42:39Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -456,6 +457,61 @@ void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n         assertThat(\"Bridge pod should not roll\", DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME)), equalTo(bridgeSnapshot));\n     }\n \n+    @Test\n+    void testDynamicallySetClusterOperatorLoggingLevels() {\n+        Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n+        String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+\n+        String log4jConfig =\n+            \"name = COConfig\\n\" +\n+            \"monitorInterval = 30\\n\" +\n+            \"\\n\" +\n+            \"    appender.console.type = Console\\n\" +\n+            \"    appender.console.name = STDOUT\\n\" +\n+            \"    appender.console.layout.type = PatternLayout\\n\" +\n+            \"    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n\\n\" +\n+            \"\\n\" +\n+            \"    rootLogger.level = INFO\\n\" +\n+            \"    rootLogger.appenderRefs = stdout\\n\" +\n+            \"    rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+            \"    rootLogger.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Kafka AdminClient logging is a bit noisy at INFO level\\n\" +\n+            \"    logger.kafka.name = org.apache.kafka\\n\" +\n+            \"    logger.kafka.level = WARN\\n\" +\n+            \"    logger.kafka.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Zookeeper is very verbose even on INFO level -> We set it to WARN by default\\n\" +\n+            \"    logger.zookeepertrustmanager.name = org.apache.zookeeper\\n\" +\n+            \"    logger.zookeepertrustmanager.level = WARN\\n\" +\n+            \"    logger.zookeepertrustmanager.additivity = false\";\n+\n+        ConfigMap coMap = new ConfigMapBuilder()\n+            .withNewMetadata()\n+                .addToLabels(\"app\", \"strimzi\")\n+                .withName(STRIMZI_DEPLOYMENT_NAME)\n+                .withNamespace(NAMESPACE)\n+            .endMetadata()\n+            .withData(Collections.singletonMap(\"log4j2.properties\", log4jConfig))\n+            .build();\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(log4jConfig)\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));", "originalCommit": "e096e578d8ca3160576cbbc153d0addb76cfe3d2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a873af6a3485d638ee6bfcef3bbad2b56cb509c9", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\nindex 2a969e3d08..fc692874ea 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n\n@@ -458,9 +458,10 @@ class LoggingChangeST extends AbstractST {\n     }\n \n     @Test\n-    void testDynamicallySetClusterOperatorLoggingLevels() {\n+    void testDynamicallySetClusterOperatorLoggingLevels() throws InterruptedException {\n         Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n         String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n \n         String log4jConfig =\n             \"name = COConfig\\n\" +\n"}}, {"oid": "1463b97d989f9a2b945bf9675d6177bb7898d209", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1463b97d989f9a2b945bf9675d6177bb7898d209", "message": "add test for dyn logging change of CO and add 2.6.0 to kafka-versions after build\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T07:11:05Z", "type": "forcePushed"}, {"oid": "36a1044ecb454052d3fed03d70c65aa9a92dd203", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/36a1044ecb454052d3fed03d70c65aa9a92dd203", "message": "add test for dyn logging change of CO and add 2.6.0 to kafka-versions after build\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T07:35:10Z", "type": "commit"}, {"oid": "36a1044ecb454052d3fed03d70c65aa9a92dd203", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/36a1044ecb454052d3fed03d70c65aa9a92dd203", "message": "add test for dyn logging change of CO and add 2.6.0 to kafka-versions after build\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T07:35:10Z", "type": "forcePushed"}, {"oid": "a873af6a3485d638ee6bfcef3bbad2b56cb509c9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a873af6a3485d638ee6bfcef3bbad2b56cb509c9", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T10:55:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODk3OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468518979", "bodyText": "Waiting {} ms log not to be empty\n// wait some time and check whether logs after this time are not empty", "author": "sknot-rh", "createdAt": "2020-08-11T11:45:54Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -456,6 +457,97 @@ void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n         assertThat(\"Bridge pod should not roll\", DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME)), equalTo(bridgeSnapshot));\n     }\n \n+    @Test\n+    void testDynamicallySetClusterOperatorLoggingLevels() throws InterruptedException {\n+        Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n+        String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n+\n+        String log4jConfig =\n+            \"name = COConfig\\n\" +\n+            \"monitorInterval = 30\\n\" +\n+            \"\\n\" +\n+            \"    appender.console.type = Console\\n\" +\n+            \"    appender.console.name = STDOUT\\n\" +\n+            \"    appender.console.layout.type = PatternLayout\\n\" +\n+            \"    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n\\n\" +\n+            \"\\n\" +\n+            \"    rootLogger.level = OFF\\n\" +\n+            \"    rootLogger.appenderRefs = stdout\\n\" +\n+            \"    rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+            \"    rootLogger.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Kafka AdminClient logging is a bit noisy at INFO level\\n\" +\n+            \"    logger.kafka.name = org.apache.kafka\\n\" +\n+            \"    logger.kafka.level = OFF\\n\" +\n+            \"    logger.kafka.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Zookeeper is very verbose even on INFO level -> We set it to WARN by default\\n\" +\n+            \"    logger.zookeepertrustmanager.name = org.apache.zookeeper\\n\" +\n+            \"    logger.zookeepertrustmanager.level = OFF\\n\" +\n+            \"    logger.zookeepertrustmanager.additivity = false\";\n+\n+        ConfigMap coMap = new ConfigMapBuilder()\n+            .withNewMetadata()\n+                .addToLabels(\"app\", \"strimzi\")\n+                .withName(STRIMZI_DEPLOYMENT_NAME)\n+                .withNamespace(NAMESPACE)\n+            .endMetadata()\n+            .withData(Collections.singletonMap(\"log4j2.properties\", log4jConfig))\n+            .build();\n+\n+        LOGGER.info(\"Checking that original logging config is different from the new one\");\n+        assertThat(log4jConfig, not(equalTo(cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim())));\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(\"rootLogger.level = OFF\")\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n+\n+        LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL * 2);\n+        // wait some time and check whether logs after this time are empty\n+        Thread.sleep(LOGGING_RELOADING_INTERVAL * 2);\n+\n+        LOGGER.info(\"Asserting if log will contain no records\");\n+        assertThat(StUtils.getLogFromPodByTime(coPodName, STRIMZI_DEPLOYMENT_NAME, \"30s\"), is(emptyString()));\n+\n+        LOGGER.info(\"Changing all levels from OFF to INFO/WARN\");\n+        log4jConfig = log4jConfig.replaceAll(\"OFF\", \"INFO\");\n+        coMap.setData(Collections.singletonMap(\"log4j2.properties\", log4jConfig));\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(\"rootLogger.level = INFO\")\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n+\n+        LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL * 2);\n+        // wait some time and check whether logs after this time are empty", "originalCommit": "a873af6a3485d638ee6bfcef3bbad2b56cb509c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxOTUxMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468519513", "bodyText": "Yep copy-paste fault :D", "author": "im-konge", "createdAt": "2020-08-11T11:46:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "abcba21c4c99346724db64dfd2bd3ff48ffc4fc1", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\nindex fc692874ea..de584ba5e7 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n\n@@ -514,9 +514,9 @@ class LoggingChangeST extends AbstractST {\n         LOGGER.info(\"Checking if CO rolled it's pod\");\n         assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n \n-        LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL * 2);\n+        LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL);\n         // wait some time and check whether logs after this time are empty\n-        Thread.sleep(LOGGING_RELOADING_INTERVAL * 2);\n+        Thread.sleep(LOGGING_RELOADING_INTERVAL);\n \n         LOGGER.info(\"Asserting if log will contain no records\");\n         assertThat(StUtils.getLogFromPodByTime(coPodName, STRIMZI_DEPLOYMENT_NAME, \"30s\"), is(emptyString()));\n"}}, {"oid": "abcba21c4c99346724db64dfd2bd3ff48ffc4fc1", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/abcba21c4c99346724db64dfd2bd3ff48ffc4fc1", "message": "another comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T12:47:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2OTk4NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468669984", "bodyText": "\"its\"", "author": "ppatierno", "createdAt": "2020-08-11T15:28:37Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -456,6 +457,99 @@ void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n         assertThat(\"Bridge pod should not roll\", DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME)), equalTo(bridgeSnapshot));\n     }\n \n+    @Test\n+    void testDynamicallySetClusterOperatorLoggingLevels() throws InterruptedException {\n+        Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n+        String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n+\n+        String log4jConfig =\n+            \"name = COConfig\\n\" +\n+            \"monitorInterval = 30\\n\" +\n+            \"\\n\" +\n+            \"    appender.console.type = Console\\n\" +\n+            \"    appender.console.name = STDOUT\\n\" +\n+            \"    appender.console.layout.type = PatternLayout\\n\" +\n+            \"    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n\\n\" +\n+            \"\\n\" +\n+            \"    rootLogger.level = OFF\\n\" +\n+            \"    rootLogger.appenderRefs = stdout\\n\" +\n+            \"    rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+            \"    rootLogger.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Kafka AdminClient logging is a bit noisy at INFO level\\n\" +\n+            \"    logger.kafka.name = org.apache.kafka\\n\" +\n+            \"    logger.kafka.level = OFF\\n\" +\n+            \"    logger.kafka.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Zookeeper is very verbose even on INFO level -> We set it to WARN by default\\n\" +\n+            \"    logger.zookeepertrustmanager.name = org.apache.zookeeper\\n\" +\n+            \"    logger.zookeepertrustmanager.level = OFF\\n\" +\n+            \"    logger.zookeepertrustmanager.additivity = false\";\n+\n+        ConfigMap coMap = new ConfigMapBuilder()\n+            .withNewMetadata()\n+                .addToLabels(\"app\", \"strimzi\")\n+                .withName(STRIMZI_DEPLOYMENT_NAME)\n+                .withNamespace(NAMESPACE)\n+            .endMetadata()\n+            .withData(Collections.singletonMap(\"log4j2.properties\", log4jConfig))\n+            .build();\n+\n+        LOGGER.info(\"Checking that original logging config is different from the new one\");\n+        assertThat(log4jConfig, not(equalTo(cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim())));\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(\"rootLogger.level = OFF\")\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");", "originalCommit": "abcba21c4c99346724db64dfd2bd3ff48ffc4fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c22287489af8ccaff45472bfb9492708fb6efb25", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\nindex de584ba5e7..bf206a9ee8 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n\n@@ -511,7 +511,7 @@ class LoggingChangeST extends AbstractST {\n         String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n         assertThat(podLogConfig, equalTo(log4jConfig));\n \n-        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        LOGGER.info(\"Checking if CO rolled its pod\");\n         assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n \n         LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY3MDMyNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3489#discussion_r468670324", "bodyText": "\"its\"", "author": "ppatierno", "createdAt": "2020-08-11T15:29:05Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -456,6 +457,99 @@ void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n         assertThat(\"Bridge pod should not roll\", DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME)), equalTo(bridgeSnapshot));\n     }\n \n+    @Test\n+    void testDynamicallySetClusterOperatorLoggingLevels() throws InterruptedException {\n+        Map<String, String> coPod = DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME);\n+        String coPodName = kubeClient().listPodsByPrefixInName(STRIMZI_DEPLOYMENT_NAME).get(0).getMetadata().getName();\n+        String command = \"cat /opt/strimzi/custom-config/log4j2.properties\";\n+\n+        String log4jConfig =\n+            \"name = COConfig\\n\" +\n+            \"monitorInterval = 30\\n\" +\n+            \"\\n\" +\n+            \"    appender.console.type = Console\\n\" +\n+            \"    appender.console.name = STDOUT\\n\" +\n+            \"    appender.console.layout.type = PatternLayout\\n\" +\n+            \"    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n\\n\" +\n+            \"\\n\" +\n+            \"    rootLogger.level = OFF\\n\" +\n+            \"    rootLogger.appenderRefs = stdout\\n\" +\n+            \"    rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+            \"    rootLogger.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Kafka AdminClient logging is a bit noisy at INFO level\\n\" +\n+            \"    logger.kafka.name = org.apache.kafka\\n\" +\n+            \"    logger.kafka.level = OFF\\n\" +\n+            \"    logger.kafka.additivity = false\\n\" +\n+            \"\\n\" +\n+            \"    # Zookeeper is very verbose even on INFO level -> We set it to WARN by default\\n\" +\n+            \"    logger.zookeepertrustmanager.name = org.apache.zookeeper\\n\" +\n+            \"    logger.zookeepertrustmanager.level = OFF\\n\" +\n+            \"    logger.zookeepertrustmanager.additivity = false\";\n+\n+        ConfigMap coMap = new ConfigMapBuilder()\n+            .withNewMetadata()\n+                .addToLabels(\"app\", \"strimzi\")\n+                .withName(STRIMZI_DEPLOYMENT_NAME)\n+                .withNamespace(NAMESPACE)\n+            .endMetadata()\n+            .withData(Collections.singletonMap(\"log4j2.properties\", log4jConfig))\n+            .build();\n+\n+        LOGGER.info(\"Checking that original logging config is different from the new one\");\n+        assertThat(log4jConfig, not(equalTo(cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim())));\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(\"rootLogger.level = OFF\")\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n+\n+        LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL);\n+        // wait some time and check whether logs after this time are empty\n+        Thread.sleep(LOGGING_RELOADING_INTERVAL);\n+\n+        LOGGER.info(\"Asserting if log will contain no records\");\n+        assertThat(StUtils.getLogFromPodByTime(coPodName, STRIMZI_DEPLOYMENT_NAME, \"30s\"), is(emptyString()));\n+\n+        LOGGER.info(\"Changing all levels from OFF to INFO/WARN\");\n+        log4jConfig = log4jConfig.replaceAll(\"OFF\", \"INFO\");\n+        coMap.setData(Collections.singletonMap(\"log4j2.properties\", log4jConfig));\n+\n+        LOGGER.info(\"Changing logging for cluster-operator\");\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(coMap);\n+\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().contains(\"rootLogger.level = INFO\")\n+        );\n+\n+        LOGGER.info(\"Checking log4j2.properties in CO pod\");\n+        podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n+        assertThat(podLogConfig, equalTo(log4jConfig));\n+\n+        LOGGER.info(\"Checking if CO rolled it's pod\");", "originalCommit": "abcba21c4c99346724db64dfd2bd3ff48ffc4fc1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c22287489af8ccaff45472bfb9492708fb6efb25", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\nindex de584ba5e7..bf206a9ee8 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java\n\n@@ -511,7 +511,7 @@ class LoggingChangeST extends AbstractST {\n         String podLogConfig = cmdKubeClient().execInPod(coPodName, \"/bin/bash\", \"-c\", command).out().trim();\n         assertThat(podLogConfig, equalTo(log4jConfig));\n \n-        LOGGER.info(\"Checking if CO rolled it's pod\");\n+        LOGGER.info(\"Checking if CO rolled its pod\");\n         assertThat(coPod, equalTo(DeploymentUtils.depSnapshot(STRIMZI_DEPLOYMENT_NAME)));\n \n         LOGGER.info(\"Waiting {} ms log to be empty\", LOGGING_RELOADING_INTERVAL);\n"}}, {"oid": "c22287489af8ccaff45472bfb9492708fb6efb25", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c22287489af8ccaff45472bfb9492708fb6efb25", "message": "some typos :)\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-11T15:39:34Z", "type": "commit"}]}