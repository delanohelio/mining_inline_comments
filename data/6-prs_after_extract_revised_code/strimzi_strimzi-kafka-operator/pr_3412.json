{"pr_number": 3412, "pr_title": "Make sure KafkaMirrorMaker can be scaled to zero", "pr_createdAt": "2020-07-29T19:04:55Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412", "timeline": [{"oid": "7179bdabbe58bd956cf8fe10e54cfc0873650ee9", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7179bdabbe58bd956cf8fe10e54cfc0873650ee9", "message": "Make sure KafkaMirrorMaker can be scaled to zero\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T19:13:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjUzMDU0Mg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462530542", "bodyText": "Can we do this like in all the other cases and leave the condition as ready? If user requests 0 replicas and gets 0 replicas it should not be treated as exception.", "author": "scholzj", "createdAt": "2020-07-29T19:18:44Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java", "diffHunk": "@@ -103,9 +105,15 @@ public KafkaMirrorMakerAssemblyOperator(Vertx vertx, PlatformFeaturesAvailabilit\n                 .compose(i -> deploymentOperations.reconcile(namespace, mirror.getName(), mirror.generateDeployment(annotations, pfa.isOpenshift(), imagePullPolicy, imagePullSecrets)))\n                 .compose(i -> deploymentOperations.scaleUp(namespace, mirror.getName(), mirror.getReplicas()))\n                 .compose(i -> deploymentOperations.waitForObserved(namespace, mirror.getName(), 1_000, operationTimeoutMs))\n-                .compose(i -> deploymentOperations.readiness(namespace, mirror.getName(), 1_000, operationTimeoutMs))\n+                .compose(i -> mirrorHasZeroReplicas ? Future.succeededFuture() : deploymentOperations.readiness(namespace, mirror.getName(), 1_000, operationTimeoutMs))\n                 .onComplete(reconciliationResult -> {\n-                        StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, reconciliationResult);\n+\n+                        if (mirrorHasZeroReplicas) {\n+                            StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, new RuntimeException(\n+                                    \"Kafka Mirror Maker cluster '\" + assemblyResource.getMetadata().getName() + \"' in namespace \" + assemblyResource.getMetadata().getNamespace() + \" has 0 replicas.\"));\n+                        } else {\n+                            StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, reconciliationResult);\n+                        }", "originalCommit": "7179bdabbe58bd956cf8fe10e54cfc0873650ee9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c6873672029a5b1dd5548b896b7cb267a901c724", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java\nindex 754001f4f1..b4c39144f8 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperator.java\n\n@@ -107,13 +107,7 @@ public class KafkaMirrorMakerAssemblyOperator extends AbstractAssemblyOperator<K\n                 .compose(i -> deploymentOperations.waitForObserved(namespace, mirror.getName(), 1_000, operationTimeoutMs))\n                 .compose(i -> mirrorHasZeroReplicas ? Future.succeededFuture() : deploymentOperations.readiness(namespace, mirror.getName(), 1_000, operationTimeoutMs))\n                 .onComplete(reconciliationResult -> {\n-\n-                        if (mirrorHasZeroReplicas) {\n-                            StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, new RuntimeException(\n-                                    \"Kafka Mirror Maker cluster '\" + assemblyResource.getMetadata().getName() + \"' in namespace \" + assemblyResource.getMetadata().getNamespace() + \" has 0 replicas.\"));\n-                        } else {\n-                            StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, reconciliationResult);\n-                        }\n+                    StatusUtils.setStatusConditionAndObservedGeneration(assemblyResource, kafkaMirrorMakerStatus, reconciliationResult);\n \n                         kafkaMirrorMakerStatus.setReplicas(mirror.getReplicas());\n                         kafkaMirrorMakerStatus.setPodSelector(new LabelSelectorBuilder().withMatchLabels(mirror.getSelectorLabels().toMap()).build());\n"}}, {"oid": "07aa95584ea60bd88d722075ed01039c4add455c", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/07aa95584ea60bd88d722075ed01039c4add455c", "message": "Make sure KafkaMirrorMaker can be scaled to zero\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T21:39:10Z", "type": "commit"}, {"oid": "c6873672029a5b1dd5548b896b7cb267a901c724", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c6873672029a5b1dd5548b896b7cb267a901c724", "message": "Implement unit test\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T21:39:10Z", "type": "commit"}, {"oid": "5bc6a1c42d95fa41c6c02e7901abde4398c2385e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5bc6a1c42d95fa41c6c02e7901abde4398c2385e", "message": "Fix code style\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T21:39:10Z", "type": "commit"}, {"oid": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "message": "Changing cluster cmName\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T21:39:10Z", "type": "commit"}, {"oid": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "message": "Changing cluster cmName\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-29T21:39:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMDg0Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462610847", "bodyText": "Should I change protected static final int DEFAULT_REPLICAS = 3; into public in KafkaMirrorMakerCluster class, and use it here, just to avoid having the default value defined multiple places ?", "author": "klalafaryan", "createdAt": "2020-07-29T21:51:19Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaMirrorMakerSpec.java", "diffHunk": "@@ -41,7 +41,10 @@\n \n     private static final long serialVersionUID = 1L;\n \n-    private int replicas;\n+    private static final int DEFAULT_REPLICAS = 3;\n+\n+    private int replicas = DEFAULT_REPLICAS;", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyOTE5NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462629195", "bodyText": "Is it still needed for something? I think since it cannot be undefined you should not need it anymore in KafkaMirrorMakerCluster, or?", "author": "scholzj", "createdAt": "2020-07-29T22:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMDg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3NDY5Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462874697", "bodyText": "It is used only here: https://github.com/strimzi/strimzi-kafka-operator/blob/master/cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaMirrorMakerCluster.java#L120\nAnd I think this can be removed.", "author": "klalafaryan", "createdAt": "2020-07-30T09:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMDg0Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMTczNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462611735", "bodyText": "To be honest, I am not sure, if we need this check (spec != null) here ? For example in KafkaConnectCluster and in KafkaBridgeCluster  spec is not checked. (if it is null or not)", "author": "klalafaryan", "createdAt": "2020-07-29T21:53:27Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaMirrorMakerCluster.java", "diffHunk": "@@ -133,8 +133,8 @@ public static KafkaMirrorMakerCluster fromCrd(KafkaMirrorMaker kafkaMirrorMaker,\n         KafkaMirrorMakerCluster kafkaMirrorMakerCluster = new KafkaMirrorMakerCluster(kafkaMirrorMaker);\n \n         KafkaMirrorMakerSpec spec = kafkaMirrorMaker.getSpec();\n-        kafkaMirrorMakerCluster.setReplicas(spec != null && spec.getReplicas() > 0 ? spec.getReplicas() : DEFAULT_REPLICAS);\n         if (spec != null) {", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYyODU2OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462628568", "bodyText": "I guess you can do what the other classes do. But the current code looks good as well.", "author": "scholzj", "createdAt": "2020-07-29T22:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxMTczNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMDA4MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462630081", "bodyText": "I think this would work fine. But maybe it would be easier to read the code if you keep the one big blog with the Builder, build the KafkaMirrorMaker, then change the replicas and return it.", "author": "scholzj", "createdAt": "2020-07-29T22:37:54Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java", "diffHunk": "@@ -505,19 +506,29 @@ public static KafkaMirrorMaker createEmptyKafkaMirrorMakerCluster(String cluster\n     }\n \n     public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n-        return new KafkaMirrorMakerBuilder()\n+        return createKafkaMirrorMakerCluster(clusterCmNamespace, clusterCmName, image, null, producer, consumer, whitelist, metricsCm);\n+    }\n+\n+    public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, Integer replicas, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n+        KafkaMirrorMakerFluent.SpecNested<KafkaMirrorMakerBuilder> kafkaMirrorMakerBuilder = new KafkaMirrorMakerBuilder()", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f8c2b0251175d92b9ee0b23d10a200b940416e4b", "chunk": "diff --git a/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java b/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\nindex f23d7f404e..fe557e488a 100644\n--- a/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\n+++ b/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\n\n@@ -510,7 +510,8 @@ public class ResourceUtils {\n     }\n \n     public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, Integer replicas, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n-        KafkaMirrorMakerFluent.SpecNested<KafkaMirrorMakerBuilder> kafkaMirrorMakerBuilder = new KafkaMirrorMakerBuilder()\n+\n+        KafkaMirrorMakerBuilder builder = new KafkaMirrorMakerBuilder()\n                 .withMetadata(new ObjectMetaBuilder()\n                         .withName(clusterCmName)\n                         .withNamespace(clusterCmNamespace)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMDY3MA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462630670", "bodyText": "When you change something in the api module, it is not enough to just build the images. You have to at the end run make crd_install to make sure the new CRD definitions are copied to all the different places. This is why right now the CI builds are failing.", "author": "scholzj", "createdAt": "2020-07-29T22:39:35Z", "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaMirrorMakerSpec.java", "diffHunk": "@@ -60,7 +63,7 @@\n     private Map<String, Object> additionalProperties = new HashMap<>(0);\n \n     @Description(\"The number of pods in the `Deployment`.\")\n-    @Minimum(1)\n+    @Minimum(0)", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1NTA1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462855051", "bodyText": "I have executed make crd_install, but seems like nothing has been changed. (nothing to commit)\nAnd in the 045-Crd-kafkamirrormaker.yaml I still can see:\n            replicas:\n              type: integer\n              minimum: 1\n              description: The number of pods in the `Deployment`.", "author": "klalafaryan", "createdAt": "2020-07-30T09:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMDY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwMTczOA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r463201738", "bodyText": "So, you will first need to do make all (or you can go to the api module and do mavn -DskipTests install) -> that should generate the changes tot he CRD in install/cluster-operator. And once you have that you can do make crd_install_.", "author": "scholzj", "createdAt": "2020-07-30T18:49:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYzMDY3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMjQ1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462912451", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    KafkaMirrorMakerFluent.SpecNested<KafkaMirrorMakerBuilder> kafkaMirrorMakerBuilder = new KafkaMirrorMakerBuilder()\n          \n          \n            \n                            .withMetadata(new ObjectMetaBuilder()\n          \n          \n            \n                                    .withName(clusterCmName)\n          \n          \n            \n                                    .withNamespace(clusterCmNamespace)\n          \n          \n            \n                                    .withLabels(TestUtils.map(Labels.KUBERNETES_DOMAIN + \"part-of\", \"tests\",\n          \n          \n            \n                                            \"my-user-label\", \"cromulent\"))\n          \n          \n            \n                                    .build())\n          \n          \n            \n                            .withNewSpec()\n          \n          \n            \n                   KafkaMirrorMakerBuilder builder = new KafkaMirrorMakerBuilder()\n          \n          \n            \n                            .withMetadata(new ObjectMetaBuilder()\n          \n          \n            \n                                    .withName(clusterCmName)\n          \n          \n            \n                                    .withNamespace(clusterCmNamespace)\n          \n          \n            \n                                    .withLabels(TestUtils.map(Labels.KUBERNETES_DOMAIN + \"part-of\", \"tests\",\n          \n          \n            \n                                            \"my-user-label\", \"cromulent\"))\n          \n          \n            \n                                    .build())\n          \n          \n            \n                            .withNewSpec()\n          \n          \n            \n                              .withImage(image)\n          \n          \n            \n                              .withProducer(producer)\n          \n          \n            \n                               .withConsumer(consumer)\n          \n          \n            \n                               .withWhitelist(whitelist)\n          \n          \n            \n                               .withMetrics(metricsCm)\n          \n          \n            \n                            .endSpec();\n          \n          \n            \n                            \n          \n          \n            \n                             if (replicas != null) {\n          \n          \n            \n                                builder.editOrNewSpec()\n          \n          \n            \n                                       .withReplicas(replicas)\n          \n          \n            \n                                     .endSpec()\n          \n          \n            \n                             }\n          \n          \n            \n                             \n          \n          \n            \n                             return builder.build();", "author": "samuel-hawker", "createdAt": "2020-07-30T10:48:32Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java", "diffHunk": "@@ -505,19 +506,29 @@ public static KafkaMirrorMaker createEmptyKafkaMirrorMakerCluster(String cluster\n     }\n \n     public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n-        return new KafkaMirrorMakerBuilder()\n+        return createKafkaMirrorMakerCluster(clusterCmNamespace, clusterCmName, image, null, producer, consumer, whitelist, metricsCm);\n+    }\n+\n+    public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, Integer replicas, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n+        KafkaMirrorMakerFluent.SpecNested<KafkaMirrorMakerBuilder> kafkaMirrorMakerBuilder = new KafkaMirrorMakerBuilder()\n                 .withMetadata(new ObjectMetaBuilder()\n                         .withName(clusterCmName)\n                         .withNamespace(clusterCmNamespace)\n                         .withLabels(TestUtils.map(Labels.KUBERNETES_DOMAIN + \"part-of\", \"tests\",\n                                 \"my-user-label\", \"cromulent\"))\n                         .build())\n                 .withNewSpec()", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMzE5NA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462913194", "bodyText": "This is the generally the best way to access builders in my opinion, you walk the whole object everytime you conditionally change a field.", "author": "samuel-hawker", "createdAt": "2020-07-30T10:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMjQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "f8c2b0251175d92b9ee0b23d10a200b940416e4b", "chunk": "diff --git a/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java b/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\nindex f23d7f404e..fe557e488a 100644\n--- a/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\n+++ b/cluster-operator/src/test/java/io/strimzi/operator/cluster/ResourceUtils.java\n\n@@ -510,7 +510,8 @@ public class ResourceUtils {\n     }\n \n     public static KafkaMirrorMaker createKafkaMirrorMakerCluster(String clusterCmNamespace, String clusterCmName, String image, Integer replicas, KafkaMirrorMakerProducerSpec producer, KafkaMirrorMakerConsumerSpec consumer, String whitelist, Map<String, Object> metricsCm) {\n-        KafkaMirrorMakerFluent.SpecNested<KafkaMirrorMakerBuilder> kafkaMirrorMakerBuilder = new KafkaMirrorMakerBuilder()\n+\n+        KafkaMirrorMakerBuilder builder = new KafkaMirrorMakerBuilder()\n                 .withMetadata(new ObjectMetaBuilder()\n                         .withName(clusterCmName)\n                         .withNamespace(clusterCmNamespace)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMzU1OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r462913558", "bodyText": "This is a good check, but do we also want to check that the Custom resource status gets set to ready?", "author": "samuel-hawker", "createdAt": "2020-07-30T10:50:53Z", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperatorTest.java", "diffHunk": "@@ -688,4 +688,55 @@ public void testCreateClusterStatusNotReady(VertxTestContext context) throws Int\n                 async.flag();\n             })));\n     }\n+\n+    @Test\n+    public void testCreateOrUpdateZeroReplica(VertxTestContext context) {\n+        ResourceOperatorSupplier supplier = ResourceUtils.supplierWithMocks(true);\n+        CrdOperator mockMirrorOps = supplier.mirrorMakerOperator;\n+        DeploymentOperator mockDcOps = supplier.deploymentOperations;\n+        PodDisruptionBudgetOperator mockPdbOps = supplier.podDisruptionBudgetOperator;\n+        ConfigMapOperator mockCmOps = supplier.configMapOperations;\n+\n+        String clusterCmName = \"foo\";\n+        String clusterCmNamespace = \"test\";\n+        KafkaMirrorMakerConsumerSpec consumer = new KafkaMirrorMakerConsumerSpecBuilder()\n+                .withBootstrapServers(consumerBootstrapServers)\n+                .withGroupId(groupId)\n+                .withNumStreams(numStreams)\n+                .build();\n+        KafkaMirrorMakerProducerSpec producer = new KafkaMirrorMakerProducerSpecBuilder()\n+                .withBootstrapServers(producerBootstrapServers)\n+                .build();\n+        Map<String, Object> metricsCm = new HashMap<>();\n+        metricsCm.put(\"foo\", \"bar\");\n+\n+        KafkaMirrorMaker clusterCm = ResourceUtils.createKafkaMirrorMakerCluster(clusterCmNamespace, clusterCmName, image, 0, producer, consumer, whitelist, metricsCm);\n+\n+        when(mockMirrorOps.get(clusterCmNamespace, clusterCmName)).thenReturn(clusterCm);\n+        when(mockMirrorOps.getAsync(anyString(), anyString())).thenReturn(Future.succeededFuture(clusterCm));\n+        when(mockDcOps.reconcile(anyString(), anyString(), any())).thenReturn(Future.succeededFuture());\n+        when(mockDcOps.scaleUp(anyString(), anyString(), anyInt())).thenReturn(Future.succeededFuture(42));\n+        when(mockDcOps.scaleDown(anyString(), anyString(), anyInt())).thenReturn(Future.succeededFuture(42));\n+        when(mockDcOps.waitForObserved(anyString(), anyString(), anyLong(), anyLong())).thenReturn(Future.succeededFuture());\n+        when(mockPdbOps.reconcile(anyString(), any(), any())).thenReturn(Future.succeededFuture());\n+        when(mockCmOps.reconcile(anyString(), any(), any())).thenReturn(Future.succeededFuture(ReconcileResult.created(new ConfigMap())));\n+\n+        ArgumentCaptor<KafkaMirrorMaker> mirrorMakerCaptor = ArgumentCaptor.forClass(KafkaMirrorMaker.class);\n+        when(mockMirrorOps.updateStatusAsync(mirrorMakerCaptor.capture())).thenReturn(Future.succeededFuture());\n+\n+        KafkaMirrorMakerAssemblyOperator ops = new KafkaMirrorMakerAssemblyOperator(vertx,\n+                new PlatformFeaturesAvailability(true, kubernetesVersion),\n+                new MockCertManager(), new PasswordGenerator(10, \"a\", \"a\"),\n+                supplier,\n+                ResourceUtils.dummyClusterOperatorConfig(VERSIONS));\n+\n+        Checkpoint async = context.checkpoint();\n+        ops.createOrUpdate(new Reconciliation(\"test-trigger\", KafkaMirrorMaker.RESOURCE_KIND, clusterCmNamespace, clusterCmName), clusterCm)\n+                .onComplete(context.succeeding(v -> context.verify(() -> {\n+                    // 0 Replicas - readiness should never get called.\n+                    verify(mockDcOps, never()).readiness(anyString(), anyString(), anyLong(), anyLong());", "originalCommit": "5b0df3b65f64e4e9aa2776a369684bdaefcf042a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMzMzNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3412#discussion_r463003337", "bodyText": "Sure, good point. I will check the custom resource status.", "author": "klalafaryan", "createdAt": "2020-07-30T13:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMzU1OA=="}], "type": "inlineReview", "revised_code": {"commit": "f8c2b0251175d92b9ee0b23d10a200b940416e4b", "chunk": "diff --git a/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperatorTest.java b/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperatorTest.java\nindex 3f75eceaf2..32d3ade6e3 100644\n--- a/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperatorTest.java\n+++ b/cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaMirrorMakerAssemblyOperatorTest.java\n\n@@ -736,6 +736,7 @@ public class KafkaMirrorMakerAssemblyOperatorTest {\n                     // 0 Replicas - readiness should never get called.\n                     verify(mockDcOps, never()).readiness(anyString(), anyString(), anyLong(), anyLong());\n \n+                    assertThat(mirrorMakerCaptor.getValue().getStatus().getConditions().get(0).getType(), is(\"Ready\"));\n                     async.flag();\n                 })));\n     }\n"}}, {"oid": "f8c2b0251175d92b9ee0b23d10a200b940416e4b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f8c2b0251175d92b9ee0b23d10a200b940416e4b", "message": "Fix code review comments\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-30T21:18:47Z", "type": "commit"}, {"oid": "f8c2b0251175d92b9ee0b23d10a200b940416e4b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f8c2b0251175d92b9ee0b23d10a200b940416e4b", "message": "Fix code review comments\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-30T21:18:47Z", "type": "forcePushed"}, {"oid": "a5dc9ecff1de56993c20edb5c625d4e9637eb91a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a5dc9ecff1de56993c20edb5c625d4e9637eb91a", "message": "Remove unused import\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-30T21:25:58Z", "type": "commit"}, {"oid": "a5dc9ecff1de56993c20edb5c625d4e9637eb91a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a5dc9ecff1de56993c20edb5c625d4e9637eb91a", "message": "Remove unused import\n\nSigned-off-by: klalafaryan <konstantin.lalafaryan@blacklane.com>", "committedDate": "2020-07-30T21:25:58Z", "type": "forcePushed"}]}