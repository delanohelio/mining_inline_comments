{"pr_number": 3528, "pr_title": "[systemtest] Fix tests failing on ocp4.x", "pr_createdAt": "2020-08-19T14:27:48Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3ODQ2MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473078461", "bodyText": "Question: Why do we use kubectl commands over using the fabric8 api?", "author": "samuel-hawker", "createdAt": "2020-08-19T14:35:38Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/AbstractST.java", "diffHunk": "@@ -421,12 +421,10 @@ protected void verifyLabelsOnPods(String clusterName, String podType, String app\n \n     void verifyLabelsForCRDs() {\n         LOGGER.info(\"Verifying labels for CRDs\");\n-        kubeClient().listCustomResourceDefinition().stream()\n-            .filter(crd -> crd.getMetadata().getName().startsWith(\"kafka\"))\n-            .forEach(crd -> {\n-                LOGGER.info(\"Verifying labels for custom resource {}\", crd.getMetadata().getName());\n-                assertThat(crd.getMetadata().getLabels().get(\"app\"), is(\"strimzi\"));\n-            });\n+        String crds = cmdKubeClient().exec(\"get\", \"crds\", \"--selector=app=strimzi\", \"-o\", \"jsonpath='{.items[*].metadata.name}'\").out();", "originalCommit": "8845f70d7a9735ecb8a240faadc9e033142abb0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3OTgwNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473079806", "bodyText": "As I mentioned in description, the only problem here was that f8 returns this exception: https://gist.github.com/im-konge/2c184783f0f3daebb4e5e4e89b6d5b07", "author": "im-konge", "createdAt": "2020-08-19T14:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3ODQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4MDQ3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473080473", "bodyText": "So after @stanlyDoge upgrade the fabric8 to new version, I hope it will be fixed and this will be changed back", "author": "im-konge", "createdAt": "2020-08-19T14:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3ODQ2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA4OTMwMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473089302", "bodyText": "Absolutely, sorry missed the description :P", "author": "samuel-hawker", "createdAt": "2020-08-19T14:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA3ODQ2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "11053ff1263334631d660941888ae85648996cfa", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/AbstractST.java b/systemtest/src/test/java/io/strimzi/systemtest/AbstractST.java\nindex c17d6685d..5e2b27b2e 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/AbstractST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/AbstractST.java\n\n@@ -423,7 +423,7 @@ public abstract class AbstractST implements TestSeparator {\n         LOGGER.info(\"Verifying labels for CRDs\");\n         String crds = cmdKubeClient().exec(\"get\", \"crds\", \"--selector=app=strimzi\", \"-o\", \"jsonpath='{.items[*].metadata.name}'\").out();\n         crds = crds.replace(\" \", \"\\n\").trim();\n-        assertThat(crds.split(\"\\n\").length, is(Crds.getCrdsCount()));\n+        assertThat(crds.split(\"\\n\").length, is(Crds.getNumCrds()));\n \n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzIzNg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473243236", "bodyText": "I have to say that somehow the getCrdsCount seems weird. Wouldn't getCrdCount be more natural? WDYT @samuel-hawker?", "author": "scholzj", "createdAt": "2020-08-19T18:39:45Z", "path": "api/src/main/java/io/strimzi/api/kafka/Crds.java", "diffHunk": "@@ -373,4 +373,8 @@ public static CustomResourceDefinition kafkaRebalance() {\n             throw new RuntimeException(e);\n         }\n     }\n+\n+    public static int getCrdsCount() {", "originalCommit": "8845f70d7a9735ecb8a240faadc9e033142abb0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk1MzEzMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r473953133", "bodyText": "getNumCrds()", "author": "tombentley", "createdAt": "2020-08-20T13:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3MjY3NQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r474172675", "bodyText": "See whilst I was reviewing this, I thought the same, but then went through the class and realized that it has some a large number of functions that being as explicit as getCrdsCount was fine, I do agree though with Tom's suggestion getNumCrds is good too.", "author": "samuel-hawker", "createdAt": "2020-08-20T18:00:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE3NDIwMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3528#discussion_r474174200", "bodyText": "I might add that\ngetKnownNumCrds may be marginally better as it is more accurate, (the crds known to the class), as opposed to say number of Crds total, but a javadoc comment would be fine for clarifying this, I am happy with it as you have changed it..", "author": "samuel-hawker", "createdAt": "2020-08-20T18:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzIzNg=="}], "type": "inlineReview", "revised_code": {"commit": "11053ff1263334631d660941888ae85648996cfa", "chunk": "diff --git a/api/src/main/java/io/strimzi/api/kafka/Crds.java b/api/src/main/java/io/strimzi/api/kafka/Crds.java\nindex 4e43b4f34..df768af31 100644\n--- a/api/src/main/java/io/strimzi/api/kafka/Crds.java\n+++ b/api/src/main/java/io/strimzi/api/kafka/Crds.java\n\n@@ -374,7 +374,7 @@ public class Crds {\n         }\n     }\n \n-    public static int getCrdsCount() {\n+    public static int getNumCrds() {\n         return CRDS.length;\n     }\n }\n"}}, {"oid": "b0c882a3c8e589ec5ba992c051b0ebb580c00510", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b0c882a3c8e589ec5ba992c051b0ebb580c00510", "message": "fixes\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-20T13:17:20Z", "type": "commit"}, {"oid": "11053ff1263334631d660941888ae85648996cfa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/11053ff1263334631d660941888ae85648996cfa", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-20T13:20:57Z", "type": "commit"}, {"oid": "11053ff1263334631d660941888ae85648996cfa", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/11053ff1263334631d660941888ae85648996cfa", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>", "committedDate": "2020-08-20T13:20:57Z", "type": "forcePushed"}]}