{"pr_number": 2706, "pr_title": "[systemtest] KafkaST: fix failed tests", "pr_createdAt": "2020-03-16T16:01:10Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2706", "timeline": [{"oid": "9523baca98d41a75aa7f0b1c7a705e1585b23141", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9523baca98d41a75aa7f0b1c7a705e1585b23141", "message": "KafkaST: fix failed tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-03-18T00:33:26Z", "type": "forcePushed"}, {"oid": "57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "message": "KafkaST: fix failed tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-03-19T00:34:49Z", "type": "commit"}, {"oid": "57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "message": "KafkaST: fix failed tests\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-03-19T00:34:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg0OTI3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2706#discussion_r394849273", "bodyText": "This should be in some utils class.", "author": "Frawless", "createdAt": "2020-03-19T08:08:13Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1388,6 +1401,33 @@ void verifyVolumeNamesAndLabels(int kafkaReplicas, int diskCountPerReplica, int\n         }\n     }\n \n+    void waitForPVCDeletion(int kafkaReplicas, JbodStorage jbodStorage) {", "originalCommit": "57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "baee46d9dfe2929d25c14cdecd5bf3d67ea11a21", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java b/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\nindex 403bf77e6..84aea65d1 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\n\n@@ -1401,33 +1400,6 @@ class KafkaST extends BaseST {\n         }\n     }\n \n-    void waitForPVCDeletion(int kafkaReplicas, JbodStorage jbodStorage) {\n-        TestUtils.waitFor(\"Wait for PVC deletion\", Constants.POLL_INTERVAL_FOR_RESOURCE_DELETION, Constants.TIMEOUT_FOR_RESOURCE_CREATION, () -> {\n-            List<String> pvcs = kubeClient().listPersistentVolumeClaims().stream()\n-                    .map(pvc -> pvc.getMetadata().getName())\n-                    .collect(Collectors.toList());\n-            boolean isCorrect = false;\n-\n-            for (SingleVolumeStorage singleVolumeStorage : jbodStorage.getVolumes()) {\n-                for (int i = 0; i < kafkaReplicas; i++) {\n-                    String jbodPVCName = \"data-\" + singleVolumeStorage.getId() + \"-\" + CLUSTER_NAME + \"-kafka-\" + i;\n-                    boolean deleteClaim = ((PersistentClaimStorage) singleVolumeStorage).isDeleteClaim();\n-\n-                    if ((deleteClaim && !pvcs.contains(jbodPVCName)) || (!deleteClaim && pvcs.contains(jbodPVCName))) {\n-                        isCorrect = true;\n-                    } else {\n-                        isCorrect = false;\n-                        break;\n-                    }\n-                }\n-                if (!isCorrect)\n-                    break;\n-            }\n-\n-            return isCorrect;\n-        });\n-    }\n-\n     @Test\n     void testPersistentStorageSize() {\n         String[] diskSizes = {\"70Gi\", \"20Gi\"};\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDg1MDQzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2706#discussion_r394850435", "bodyText": "Wouldn't be better to create list of storages, which shouldn't be deleted after kafka deletion and compare it with pvcs list?", "author": "Frawless", "createdAt": "2020-03-19T08:10:44Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1388,6 +1401,33 @@ void verifyVolumeNamesAndLabels(int kafkaReplicas, int diskCountPerReplica, int\n         }\n     }\n \n+    void waitForPVCDeletion(int kafkaReplicas, JbodStorage jbodStorage) {\n+        TestUtils.waitFor(\"Wait for PVC deletion\", Constants.POLL_INTERVAL_FOR_RESOURCE_DELETION, Constants.TIMEOUT_FOR_RESOURCE_CREATION, () -> {\n+            List<String> pvcs = kubeClient().listPersistentVolumeClaims().stream()\n+                    .map(pvc -> pvc.getMetadata().getName())\n+                    .collect(Collectors.toList());\n+            boolean isCorrect = false;\n+\n+            for (SingleVolumeStorage singleVolumeStorage : jbodStorage.getVolumes()) {", "originalCommit": "57f2b944f9c6875eb3b6043e752c3c8c8c7e3d6b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "baee46d9dfe2929d25c14cdecd5bf3d67ea11a21", "chunk": "diff --git a/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java b/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\nindex 403bf77e6..84aea65d1 100644\n--- a/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\n+++ b/systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java\n\n@@ -1401,33 +1400,6 @@ class KafkaST extends BaseST {\n         }\n     }\n \n-    void waitForPVCDeletion(int kafkaReplicas, JbodStorage jbodStorage) {\n-        TestUtils.waitFor(\"Wait for PVC deletion\", Constants.POLL_INTERVAL_FOR_RESOURCE_DELETION, Constants.TIMEOUT_FOR_RESOURCE_CREATION, () -> {\n-            List<String> pvcs = kubeClient().listPersistentVolumeClaims().stream()\n-                    .map(pvc -> pvc.getMetadata().getName())\n-                    .collect(Collectors.toList());\n-            boolean isCorrect = false;\n-\n-            for (SingleVolumeStorage singleVolumeStorage : jbodStorage.getVolumes()) {\n-                for (int i = 0; i < kafkaReplicas; i++) {\n-                    String jbodPVCName = \"data-\" + singleVolumeStorage.getId() + \"-\" + CLUSTER_NAME + \"-kafka-\" + i;\n-                    boolean deleteClaim = ((PersistentClaimStorage) singleVolumeStorage).isDeleteClaim();\n-\n-                    if ((deleteClaim && !pvcs.contains(jbodPVCName)) || (!deleteClaim && pvcs.contains(jbodPVCName))) {\n-                        isCorrect = true;\n-                    } else {\n-                        isCorrect = false;\n-                        break;\n-                    }\n-                }\n-                if (!isCorrect)\n-                    break;\n-            }\n-\n-            return isCorrect;\n-        });\n-    }\n-\n     @Test\n     void testPersistentStorageSize() {\n         String[] diskSizes = {\"70Gi\", \"20Gi\"};\n"}}, {"oid": "baee46d9dfe2929d25c14cdecd5bf3d67ea11a21", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/baee46d9dfe2929d25c14cdecd5bf3d67ea11a21", "message": "move waitForPVCDeletion method to PVCUtils\n\nSigned-off-by: Lukas Kral <lkral@redhat.com>", "committedDate": "2020-03-19T13:51:22Z", "type": "commit"}]}