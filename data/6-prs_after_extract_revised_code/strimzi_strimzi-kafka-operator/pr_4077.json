{"pr_number": 4077, "pr_title": "Remove owner referneces from ClusterRoleBindings", "pr_createdAt": "2020-12-09T17:18:27Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjA1MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540286051", "bodyText": "I'm guessing this needs @Override annotation", "author": "tombentley", "createdAt": "2020-12-10T15:58:16Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {", "originalCommit": "43782fd74e23042d05434ebe44c6e3730fad87a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMzNzI2Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540337267", "bodyText": "Fixed here as well as in the other file.", "author": "scholzj", "createdAt": "2020-12-10T16:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjA1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex fc0d34ae37..3c5ef7ca63 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -3712,6 +3712,7 @@ public class KafkaAssemblyOperator extends AbstractAssemblyOperator<KubernetesCl\n         return new KafkaStatus();\n     }\n \n+    @Override\n     protected Future<Boolean> delete(Reconciliation reconciliation) {\n         return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n                 .recover(error -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjYzNQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540286635", "bodyText": "Doesn't the user need to delete in this case? So should it be a info, or even warn?", "author": "tombentley", "createdAt": "2020-12-10T15:59:01Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {\n+        return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n+                .recover(error -> {\n+                    if (error != null\n+                            && error.getMessage() != null\n+                            && error.getMessage().contains(\"Message: Forbidden!\"))  {\n+                        log.debug(\"Ignoring forbidden access to ClusterRoleBindings when attempting to delete resources.\");", "originalCommit": "43782fd74e23042d05434ebe44c6e3730fad87a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI5MjcxMg==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540292712", "bodyText": "We do not know it exists. But since we do not have access to delete it, we assume it does not exist since we did not had access to create it.", "author": "scholzj", "createdAt": "2020-12-10T16:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjYzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex fc0d34ae37..3c5ef7ca63 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -3712,6 +3712,7 @@ public class KafkaAssemblyOperator extends AbstractAssemblyOperator<KubernetesCl\n         return new KafkaStatus();\n     }\n \n+    @Override\n     protected Future<Boolean> delete(Reconciliation reconciliation) {\n         return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n                 .recover(error -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQzNA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540287434", "bodyText": "It it's a KubernetesClientException I think there should be a status code, which might be a little less fragile than contains on the message.", "author": "tombentley", "createdAt": "2020-12-10T16:00:00Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {\n+        return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n+                .recover(error -> {\n+                    if (error != null\n+                            && error.getMessage() != null\n+                            && error.getMessage().contains(\"Message: Forbidden!\"))  {", "originalCommit": "43782fd74e23042d05434ebe44c6e3730fad87a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI5MzEwNw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540293107", "bodyText": "I do not think there is any code which is exposed. This is the logic we use for the creation as well.", "author": "scholzj", "createdAt": "2020-12-10T16:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM0Nzc2OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540347769", "bodyText": "OK, but I think we should factor out a method for these, both here and for the creation.", "author": "tombentley", "createdAt": "2020-12-10T17:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUxMzM3Mw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540513373", "bodyText": "Hmm, good point. I'm not good at this programming thing ... but I excel in the copy-pasting discipline. And you know how it is ... when all you know is a Cmd-C/Cmd-V everything looks like a copy paste problem :-/. Anyway, it should be fixed now.", "author": "scholzj", "createdAt": "2020-12-10T21:34:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQzNA=="}], "type": "inlineReview", "revised_code": {"commit": "556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "chunk": "diff --git a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\nindex fc0d34ae37..3c5ef7ca63 100644\n--- a/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n+++ b/cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java\n\n@@ -3712,6 +3712,7 @@ public class KafkaAssemblyOperator extends AbstractAssemblyOperator<KubernetesCl\n         return new KafkaStatus();\n     }\n \n+    @Override\n     protected Future<Boolean> delete(Reconciliation reconciliation) {\n         return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n                 .recover(error -> {\n"}}, {"oid": "13e60fea924b044788997aebfff8e6fc4b0a6395", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/13e60fea924b044788997aebfff8e6fc4b0a6395", "message": "Remove ownerReferneces from ClusterRoleBindings\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-11T01:47:40Z", "type": "commit"}, {"oid": "556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-11T01:47:40Z", "type": "commit"}, {"oid": "167d1ebf7b09a3c57c7a81c7b7317560024b8062", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/167d1ebf7b09a3c57c7a81c7b7317560024b8062", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-11T01:47:40Z", "type": "commit"}, {"oid": "90328180ae66f0fbce4550b9e72da8526f89b2a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90328180ae66f0fbce4550b9e72da8526f89b2a7", "message": "Fix log message search in STs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-11T01:49:36Z", "type": "commit"}, {"oid": "90328180ae66f0fbce4550b9e72da8526f89b2a7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90328180ae66f0fbce4550b9e72da8526f89b2a7", "message": "Fix log message search in STs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-12-11T01:49:36Z", "type": "forcePushed"}]}