{"pr_number": 3921, "pr_title": "synchronize thread-unsafe MorfologikSpeller queries", "pr_createdAt": "2020-11-24T16:23:11Z", "pr_url": "https://github.com/languagetool-org/languagetool/pull/3921", "timeline": [{"oid": "c66cf8dd5e3c2325c53ae5f91787fc3e0b5310fa", "url": "https://github.com/languagetool-org/languagetool/commit/c66cf8dd5e3c2325c53ae5f91787fc3e0b5310fa", "message": "synchronize thread-unsafe MorfologikSpeller queries", "committedDate": "2020-11-24T16:22:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5NjE5OQ==", "url": "https://github.com/languagetool-org/languagetool/pull/3921#discussion_r530496199", "bodyText": "As this is public, it might be in use somewhere and probably shouldn't be removed?", "author": "danielnaber", "createdAt": "2020-11-25T16:21:41Z", "path": "languagetool-core/src/main/java/org/languagetool/rules/spelling/morfologik/MorfologikSpeller.java", "diffHunk": "@@ -87,14 +87,16 @@ public MorfologikSpeller(String fileInClassPath) throws IOException {\n   }\n \n   public boolean isMisspelled(String word) {\n-    return word.length() > 0 \n-            && !SpellingCheckRule.LANGUAGETOOL.equals(word)\n-            && !SpellingCheckRule.LANGUAGETOOLER.equals(word)\n-            && speller.isMisspelled(word);\n+    if (word.isEmpty() || SpellingCheckRule.LANGUAGETOOL.equals(word) || SpellingCheckRule.LANGUAGETOOLER.equals(word)) {\n+      return false;\n+    }\n+    synchronized (this) {\n+      return speller.isMisspelled(word);\n+    }\n   }\n \n-  public Speller getSpeller() {", "originalCommit": "c66cf8dd5e3c2325c53ae5f91787fc3e0b5310fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUwNTg4NA==", "url": "https://github.com/languagetool-org/languagetool/pull/3921#discussion_r530505884", "bodyText": "Theoretically it can, although I don't think it's likely. This method was introduced relatively recently, and exposes internal stuff that needs synchronization, that's why I've removed it. I also see other possibilities, if you think it's so important:\n\nLeave it but deprecate\nLeave it but return a thread-safe new speller, like in getSuggestions below.\nWDYT?", "author": "donnerpeter", "createdAt": "2020-11-25T16:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5NjE5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUxNTYwOQ==", "url": "https://github.com/languagetool-org/languagetool/pull/3921#discussion_r530515609", "bodyText": "Okay, I suggest deprecating it", "author": "danielnaber", "createdAt": "2020-11-25T16:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5NjE5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fd0b5151d0b2fd168c8303699ca1741c53348ed8", "chunk": "diff --git a/languagetool-core/src/main/java/org/languagetool/rules/spelling/morfologik/MorfologikSpeller.java b/languagetool-core/src/main/java/org/languagetool/rules/spelling/morfologik/MorfologikSpeller.java\nindex 430e01e918..12ec9dd454 100644\n--- a/languagetool-core/src/main/java/org/languagetool/rules/spelling/morfologik/MorfologikSpeller.java\n+++ b/languagetool-core/src/main/java/org/languagetool/rules/spelling/morfologik/MorfologikSpeller.java\n\n@@ -99,6 +99,14 @@ public class MorfologikSpeller {\n     return speller.findReplacements(word);\n   }\n \n+  /**\n+   * @deprecated use (or introduce) other methods to this class which would take care of the necessary synchronization\n+   */\n+  @Deprecated\n+  public Speller getSpeller() {\n+    return speller;\n+  }\n+\n   public List<WeightedSuggestion> getSuggestions(String word) {\n     List<WeightedSuggestion> suggestions = new ArrayList<>();\n     // needs to be reset every time, possible bug: HMatrix for distance computation is not reset;\n"}}, {"oid": "fd0b5151d0b2fd168c8303699ca1741c53348ed8", "url": "https://github.com/languagetool-org/languagetool/commit/fd0b5151d0b2fd168c8303699ca1741c53348ed8", "message": "reinstate MorfologikSpeller.getSpeller, deprecated", "committedDate": "2020-11-25T17:49:36Z", "type": "commit"}]}