{"pr_number": 1272, "pr_title": "HDDS-2660. Create insight point for datanode container protocol", "pr_createdAt": "2020-07-29T10:29:12Z", "pr_url": "https://github.com/apache/ozone/pull/1272", "timeline": [{"oid": "b94ddb26331b83ca47037351683822bc5d16dc92", "url": "https://github.com/apache/ozone/commit/b94ddb26331b83ca47037351683822bc5d16dc92", "message": "datanode-protocol-inside", "committedDate": "2020-07-23T09:42:58Z", "type": "commit"}, {"oid": "04e5ebdef9b84c857803708b9728e760bf2b5461", "url": "https://github.com/apache/ozone/commit/04e5ebdef9b84c857803708b9728e760bf2b5461", "message": "add optional parameter", "committedDate": "2020-07-23T09:42:58Z", "type": "commit"}, {"oid": "d03229aceabf81d685dc0d3fad6cf52d1749e978", "url": "https://github.com/apache/ozone/commit/d03229aceabf81d685dc0d3fad6cf52d1749e978", "message": "fix datanode insight", "committedDate": "2020-07-24T08:27:37Z", "type": "commit"}, {"oid": "3efb135abe27ff0c2d9f76395ce2ef03afaa9bc0", "url": "https://github.com/apache/ozone/commit/3efb135abe27ff0c2d9f76395ce2ef03afaa9bc0", "message": "checkstyle fixes", "committedDate": "2020-07-27T09:55:48Z", "type": "commit"}, {"oid": "7cacbcc6eeac39084e534439ff872ab594cb133c", "url": "https://github.com/apache/ozone/commit/7cacbcc6eeac39084e534439ff872ab594cb133c", "message": "Merge remote-tracking branch 'origin/master' into HDDS-2660", "committedDate": "2020-07-29T10:20:18Z", "type": "commit"}, {"oid": "f3c140e6ac99c3109ce5e2c182042773df4a91d6", "url": "https://github.com/apache/ozone/commit/f3c140e6ac99c3109ce5e2c182042773df4a91d6", "message": "checkstyle and findbug fixes", "committedDate": "2020-07-29T10:26:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg0NTgzNQ==", "url": "https://github.com/apache/ozone/pull/1272#discussion_r467845835", "bodyText": "Seems to be leftover from ScmProtocolBlockLocationInsight.  I think it should be something like Type.DATANODE, ContainerProtos.Type.values() instead.  (BaseInsightPoint needs to be tweaked to allow it.)", "author": "adoroszlai", "createdAt": "2020-08-10T11:38:37Z", "path": "hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.insight.datanode;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n+import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n+import org.apache.hadoop.ozone.insight.Component.Type;\n+import org.apache.hadoop.ozone.insight.InsightPoint;\n+import org.apache.hadoop.ozone.insight.LoggerSource;\n+import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n+\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.getPipelineIdFromFilters;\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.withDatanodesFromPipeline;\n+\n+/**\n+ * Insight definition for datanode/pipline metrics.\n+ */\n+public class DatanodeDispatcherInsight extends BaseInsightPoint\n+    implements InsightPoint {\n+\n+  private OzoneConfiguration conf;\n+\n+  public DatanodeDispatcherInsight(\n+      OzoneConfiguration conf) {\n+    this.conf = conf;\n+  }\n+\n+  @Override\n+  public List<LoggerSource> getRelatedLoggers(boolean verbose,\n+      Map<String, String> filters) {\n+\n+    List<LoggerSource> result = new ArrayList<>();\n+\n+    try (ScmClient scmClient = createScmClient(conf)) {\n+      withDatanodesFromPipeline(scmClient,\n+          getPipelineIdFromFilters(filters),\n+          dn -> {\n+            result\n+                .add(new LoggerSource(dn,\n+                    HddsDispatcher.class.getCanonicalName(),\n+                    defaultLevel(verbose)));\n+            return null;\n+          });\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Can't enumerate required logs\", e);\n+    }\n+    return result;\n+  }\n+\n+  @Override\n+  public List<MetricGroupDisplay> getMetrics() {\n+    List<MetricGroupDisplay> metrics = new ArrayList<>();\n+\n+    addProtocolMessageMetrics(metrics, \"hdds_dispatcher\",\n+        Type.SCM, ScmBlockLocationProtocolProtos.Type.values());", "originalCommit": "f3c140e6ac99c3109ce5e2c182042773df4a91d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI0NDY5Mw==", "url": "https://github.com/apache/ozone/pull/1272#discussion_r477244693", "bodyText": "This is something which couldn't be easily fixed. Type.DATANODE is not supported for metrics. I can throw and UnsupportedOperationException instead of showing the metrics.", "author": "elek", "createdAt": "2020-08-26T11:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg0NTgzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b69d24a9f78652e8017f32470750934f319f2741", "chunk": "diff --git a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\nindex 31af764966..3922d8151e 100644\n--- a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n+++ b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n\n@@ -24,11 +24,9 @@\n import java.util.Map;\n \n import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n-import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n-import org.apache.hadoop.ozone.insight.Component.Type;\n import org.apache.hadoop.ozone.insight.InsightPoint;\n import org.apache.hadoop.ozone.insight.LoggerSource;\n import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MzIwNw==", "url": "https://github.com/apache/ozone/pull/1272#discussion_r467853207", "bodyText": "Can you please explain why this is needed?  I think this may cause logs from other pipelines to be printed.\nFor example, I ran ozone insight logs on a 3-node pipeline, then:\n$ ozone sh key put -r ONE /vol1/bucket1/passwd /etc/passwd\n\nand the logs from the single datanode to which this block was written (part of the 3-node pipeline, too) appeared in the console.", "author": "adoroszlai", "createdAt": "2020-08-10T11:55:43Z", "path": "hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.insight.datanode;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n+import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n+import org.apache.hadoop.ozone.insight.Component.Type;\n+import org.apache.hadoop.ozone.insight.InsightPoint;\n+import org.apache.hadoop.ozone.insight.LoggerSource;\n+import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n+\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.getPipelineIdFromFilters;\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.withDatanodesFromPipeline;\n+\n+/**\n+ * Insight definition for datanode/pipline metrics.\n+ */\n+public class DatanodeDispatcherInsight extends BaseInsightPoint\n+    implements InsightPoint {\n+\n+  private OzoneConfiguration conf;\n+\n+  public DatanodeDispatcherInsight(\n+      OzoneConfiguration conf) {\n+    this.conf = conf;\n+  }\n+\n+  @Override\n+  public List<LoggerSource> getRelatedLoggers(boolean verbose,\n+      Map<String, String> filters) {\n+\n+    List<LoggerSource> result = new ArrayList<>();\n+\n+    try (ScmClient scmClient = createScmClient(conf)) {\n+      withDatanodesFromPipeline(scmClient,\n+          getPipelineIdFromFilters(filters),\n+          dn -> {\n+            result\n+                .add(new LoggerSource(dn,\n+                    HddsDispatcher.class.getCanonicalName(),\n+                    defaultLevel(verbose)));\n+            return null;\n+          });\n+    } catch (IOException e) {\n+      throw new UncheckedIOException(\"Can't enumerate required logs\", e);\n+    }\n+    return result;\n+  }\n+\n+  @Override\n+  public List<MetricGroupDisplay> getMetrics() {\n+    List<MetricGroupDisplay> metrics = new ArrayList<>();\n+\n+    addProtocolMessageMetrics(metrics, \"hdds_dispatcher\",\n+        Type.SCM, ScmBlockLocationProtocolProtos.Type.values());\n+\n+    return metrics;\n+  }\n+\n+  @Override\n+  public String getDescription() {\n+    return \"Datanode client protocol\";\n+  }\n+\n+  @Override\n+  public boolean filterLog(Map<String, String> filters, String logLine) {\n+    return true;", "originalCommit": "f3c140e6ac99c3109ce5e2c182042773df4a91d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3NjA0Nw==", "url": "https://github.com/apache/ozone/pull/1272#discussion_r467976047", "bodyText": "There are two parts of the filtering:\n\nwhere to connect\nwhat to display (based on [...] text from the log\n\nUnfortunately the pipeline id is not available in the  HddsDispatcher, therefore we couldn't filter out the other pipelines (and we need this code segment to show all the lines)", "author": "elek", "createdAt": "2020-08-10T15:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MzIwNw=="}], "type": "inlineReview", "revised_code": {"commit": "b69d24a9f78652e8017f32470750934f319f2741", "chunk": "diff --git a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\nindex 31af764966..3922d8151e 100644\n--- a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n+++ b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n\n@@ -24,11 +24,9 @@\n import java.util.Map;\n \n import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n-import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n-import org.apache.hadoop.ozone.insight.Component.Type;\n import org.apache.hadoop.ozone.insight.InsightPoint;\n import org.apache.hadoop.ozone.insight.LoggerSource;\n import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MzU4NA==", "url": "https://github.com/apache/ozone/pull/1272#discussion_r467853584", "bodyText": "Seems to be leftover from RatisInsight.", "author": "adoroszlai", "createdAt": "2020-08-10T11:56:35Z", "path": "hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.insight.datanode;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n+import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n+import org.apache.hadoop.ozone.insight.Component.Type;\n+import org.apache.hadoop.ozone.insight.InsightPoint;\n+import org.apache.hadoop.ozone.insight.LoggerSource;\n+import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n+\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.getPipelineIdFromFilters;\n+import static org.apache.hadoop.ozone.insight.datanode.PipelineComponentUtil.withDatanodesFromPipeline;\n+\n+/**\n+ * Insight definition for datanode/pipline metrics.", "originalCommit": "f3c140e6ac99c3109ce5e2c182042773df4a91d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b69d24a9f78652e8017f32470750934f319f2741", "chunk": "diff --git a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\nindex 31af764966..3922d8151e 100644\n--- a/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n+++ b/hadoop-ozone/insight/src/main/java/org/apache/hadoop/ozone/insight/datanode/DatanodeDispatcherInsight.java\n\n@@ -24,11 +24,9 @@\n import java.util.Map;\n \n import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n-import org.apache.hadoop.hdds.protocol.proto.ScmBlockLocationProtocolProtos;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import org.apache.hadoop.ozone.container.common.impl.HddsDispatcher;\n import org.apache.hadoop.ozone.insight.BaseInsightPoint;\n-import org.apache.hadoop.ozone.insight.Component.Type;\n import org.apache.hadoop.ozone.insight.InsightPoint;\n import org.apache.hadoop.ozone.insight.LoggerSource;\n import org.apache.hadoop.ozone.insight.MetricGroupDisplay;\n"}}, {"oid": "b69d24a9f78652e8017f32470750934f319f2741", "url": "https://github.com/apache/ozone/commit/b69d24a9f78652e8017f32470750934f319f2741", "message": "address review comments", "committedDate": "2020-08-10T17:05:27Z", "type": "commit"}, {"oid": "bd76a4a89accf869972b98d52a20f17d3552be17", "url": "https://github.com/apache/ozone/commit/bd76a4a89accf869972b98d52a20f17d3552be17", "message": "support filter for metrics", "committedDate": "2020-09-03T12:52:33Z", "type": "commit"}, {"oid": "58ecf10c6c6cb06a7378762e5fb08a0d35dd4e6a", "url": "https://github.com/apache/ozone/commit/58ecf10c6c6cb06a7378762e5fb08a0d35dd4e6a", "message": "fix hdds dispatcher metrics and logger", "committedDate": "2020-09-03T14:10:18Z", "type": "commit"}]}