{"pr_number": 719, "pr_title": "HDDS-3270. Allow safemode listeners to be notified when some precheck rules pass", "pr_createdAt": "2020-03-24T22:10:24Z", "pr_url": "https://github.com/apache/ozone/pull/719", "timeline": [{"oid": "604c19c656429f4a0032a3ae6a52277f9bd678d0", "url": "https://github.com/apache/ozone/commit/604c19c656429f4a0032a3ae6a52277f9bd678d0", "message": "Fixed further unit test failure", "committedDate": "2020-03-25T15:54:23Z", "type": "forcePushed"}, {"oid": "27c628043e12eb7a0b3d1e1c2949d7a75f0193de", "url": "https://github.com/apache/ozone/commit/27c628043e12eb7a0b3d1e1c2949d7a75f0193de", "message": "Exit safemode before running test", "committedDate": "2020-03-26T23:29:44Z", "type": "forcePushed"}, {"oid": "3aaf7a69369ada037fc7dc9b3f22953b10c2650e", "url": "https://github.com/apache/ozone/commit/3aaf7a69369ada037fc7dc9b3f22953b10c2650e", "message": "Add a PreCheck state into safemode, so listening objects can get notified when stage 1 rules pass.\nPipeline Manager can use this to trigger when to kick off pipeline creation.", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "7a689486130e182708c0607cb1640a24b2409345", "url": "https://github.com/apache/ozone/commit/7a689486130e182708c0607cb1640a24b2409345", "message": "Address unit and integration failures", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "65899f2317f5b9001dbf583274575f60d86cdd1b", "url": "https://github.com/apache/ozone/commit/65899f2317f5b9001dbf583274575f60d86cdd1b", "message": "Fixed further unit test failure", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "ea07da832ff10a52f00e213d053ea753a505faf9", "url": "https://github.com/apache/ozone/commit/ea07da832ff10a52f00e213d053ea753a505faf9", "message": "Attempt to fix issues with TestDeadNodeHandler test", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "90b3240e3d416e4bc0b2b2ec9f0dc1bbc2b31076", "url": "https://github.com/apache/ozone/commit/90b3240e3d416e4bc0b2b2ec9f0dc1bbc2b31076", "message": "Revert \"Attempt to fix issues with TestDeadNodeHandler test\"\n\nThis reverts commit c6a8d5e5ecec491f181239515c048d21a01cd49d.", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "89246a0c7d1ffeb3faf20ed12a4291ce498ef1fb", "url": "https://github.com/apache/ozone/commit/89246a0c7d1ffeb3faf20ed12a4291ce498ef1fb", "message": "Trigger pipeline creation after nodes have registered in TestDeadNodeHandler", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "e612f83b174b175fb0e1bcb99eef8bd59fa3b818", "url": "https://github.com/apache/ozone/commit/e612f83b174b175fb0e1bcb99eef8bd59fa3b818", "message": "Move the pipeline trigger into the recheck routine", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "6a21df8eb4795bdf6e733f24baebb9f98a677b53", "url": "https://github.com/apache/ozone/commit/6a21df8eb4795bdf6e733f24baebb9f98a677b53", "message": "Added more debug as the test is STILL failing", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "91c854779b8b3c59e410df66531e01984e607896", "url": "https://github.com/apache/ozone/commit/91c854779b8b3c59e410df66531e01984e607896", "message": "Revert \"Added more debug as the test is STILL failing\"\n\nThis reverts commit 9090ec317d9f5f1e76bcd8eb77b01e5748918825.", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "4abd0e89922999393c941a109e4da99e7d68d860", "url": "https://github.com/apache/ozone/commit/4abd0e89922999393c941a109e4da99e7d68d860", "message": "Exit safemode before running test", "committedDate": "2020-03-30T15:11:11Z", "type": "commit"}, {"oid": "4abd0e89922999393c941a109e4da99e7d68d860", "url": "https://github.com/apache/ozone/commit/4abd0e89922999393c941a109e4da99e7d68d860", "message": "Exit safemode before running test", "committedDate": "2020-03-30T15:11:11Z", "type": "forcePushed"}, {"oid": "88837ef5a9a253eb330e52b9da3362b16038008f", "url": "https://github.com/apache/ozone/commit/88837ef5a9a253eb330e52b9da3362b16038008f", "message": "trigger new CI check", "committedDate": "2020-03-30T16:23:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTg2OA==", "url": "https://github.com/apache/ozone/pull/719#discussion_r400489868", "bodyText": "I would suggest to use pipelineCreationAllowed as the internal state name, it makes the code easier to read out as I I see.\nI know this is a regular getter and and setter pair, but...\nIn the tests, the set method is always called with true as the parameter, so I suggest to call this method simply allowPipelineCreation() without a parameter, the getter part of the pair in this case can be called as isPipelineCreationAllowed().\nThis suggestion is simply about expressions from the usage point of view, and I don't have a strong opinion on this, however if we want to keep this name and want to name it as a regular getter setter as it is suggested by the books then we should use isAllowPipelineCreation as the getter name.", "author": "fapifta", "createdAt": "2020-03-30T20:58:54Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java", "diffHunk": "@@ -146,6 +152,16 @@ public void setPipelineProvider(ReplicationType replicationType,\n     pipelineFactory.setProvider(replicationType, provider);\n   }\n \n+  @VisibleForTesting\n+  public void setAllowPipelineCreation(boolean newState) {\n+    this.allowPipelineCreation.set(newState);\n+  }\n+\n+  @VisibleForTesting\n+  public boolean getAllowPipelineCreation() {\n+    return allowPipelineCreation.get();\n+  }\n+", "originalCommit": "88837ef5a9a253eb330e52b9da3362b16038008f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxOTU2Ng==", "url": "https://github.com/apache/ozone/pull/719#discussion_r400519566", "bodyText": "I think your naming is better. I will push a new commit for that change.", "author": "sodonnel", "createdAt": "2020-03-30T21:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "7841e1d482f13e24c22e0a2c734da7fe26382251", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\nindex 1239730a91..c5192b39c9 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n\n@@ -153,13 +153,13 @@ public void setPipelineProvider(ReplicationType replicationType,\n   }\n \n   @VisibleForTesting\n-  public void setAllowPipelineCreation(boolean newState) {\n-    this.allowPipelineCreation.set(newState);\n+  public void allowPipelineCreation() {\n+    this.pipelineCreationAllowed.set(true);\n   }\n \n   @VisibleForTesting\n-  public boolean getAllowPipelineCreation() {\n-    return allowPipelineCreation.get();\n+  public boolean isPipelineCreationAllowed() {\n+    return pipelineCreationAllowed.get();\n   }\n \n   protected void initializePipelineState() throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTk3MA==", "url": "https://github.com/apache/ozone/pull/719#discussion_r400489970", "bodyText": "Let me understand a bit this part of the code:\nwe trigger pipelines in two cases:\n1: the pipeline creation was not allowed before, but now it is allowed, effectively when precheck is complete\n2: safemode is transitioning to off, and currently we are in safe mode\nLooking at the code of triggerPipelineCreation, it is calling the same method from the BackgroundPipelineCreator, which is doing this only after the creator itself is started.\nNow this means that we are effectively doing the same as the old code, and trigger pipeline creation after leaving safe mode, am I understand this well?", "author": "fapifta", "createdAt": "2020-03-30T20:59:03Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java", "diffHunk": "@@ -641,13 +663,26 @@ public boolean getSafeModeStatus() {\n   }\n \n   @Override\n-  public void handleSafeModeTransition(\n+  public synchronized void handleSafeModeTransition(\n       SCMSafeModeManager.SafeModeStatus status) {\n-    this.isInSafeMode.set(status.getSafeModeStatus());\n-    if (!status.getSafeModeStatus()) {\n-      // TODO: #CLUTIL if we reenter safe mode the fixed interval pipeline\n-      // creation job needs to stop\n+    // TODO: #CLUTIL - handle safemode getting re-enabled\n+    boolean currentAllowPipelines =\n+        allowPipelineCreation.getAndSet(status.isPreCheckComplete());\n+    boolean currentlyInSafeMode =\n+        isInSafeMode.getAndSet(status.isInSafeMode());\n+    boolean triggerPipelines = false;\n+\n+    // Trigger pipeline creation only if the preCheck status has changed to\n+    // complete.\n+    if (allowPipelineCreation.get() && !currentAllowPipelines) {\n+      triggerPipelines = true;\n+    }\n+    // Start the pipeline creation thread only when safemode switches off\n+    if (!getSafeModeStatus() && currentlyInSafeMode) {\n       startPipelineCreator();\n+      triggerPipelines = true;\n+    }\n+    if (triggerPipelines) {", "originalCommit": "88837ef5a9a253eb330e52b9da3362b16038008f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDA1Nw==", "url": "https://github.com/apache/ozone/pull/719#discussion_r400514057", "bodyText": "In the logic prior to this patch, BackgroundPipelineCreator only gets started when safemode exits. However, the creator does not need to be started for pipelines to get created. Infact, in order to exit safemode, there must be a replication factor 3 pipeline created, and that must happen without the creator running.\nThere are actually two ways a pipeline can be created:\n\n\nWhen the backgroundPipelineCreator is running, it starts every 2 minutes and tries to create pipelines.\n\n\nWhen a node registers with SCM, it triggers an event and calls backgroundPipelineCreator.triggerPipelineCreation(); which tries to create pipelines immediately - even if the BackgroundPipelineCreator has already been started.\n\n\nTherefore in safemode, before this patch, pipelines are initially created by (2) above. However now we want to stop that happening. Therefore whenever the precheck completes (enough nodes registered) we trigger the pipeline creation, but hold off on starting the background creator thread. Then it is started when safemode exits.\nNow that you have highlighted this, it is possibly valid to just start the BackgroundPipeLineCreator in both cases. However there is one further detail - in the existing implementation, there is a delay for safemode exiting. Once the rules have passed some services are not started for a delay of 5 minutes and the BackgroundPipelineCreator thread is one of them. I am not sure on the history of that so it probably makes sense to keep that logic for now.", "author": "sodonnel", "createdAt": "2020-03-30T21:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxOTI0NA==", "url": "https://github.com/apache/ozone/pull/719#discussion_r400819244", "bodyText": "Oh, I missed one small detail in the shouldSchedulePipelineCreator method... and misinterpreted it sorry about that... So triggerPipelineCreation will create pipelines if the safemode precheck is finished and allowPipelineCreation is already true in SCMPipelineManager.\nWith that it makes perfect sense, that we want to trigger the pipeline creation once when precheck is complete, and start the scheduled runs after the safe mode is exited.\nBut in this case, it would be enough to call triggerPipelineCreation when we arrived to the end of the precheck stage, and start the background pipeline creator schedule when we left safe mode.\nNow what I understand happens at a startup when this is interesting is the following:\nfor (0..nodecount) {\ntriggerPipelineCreation() // noop as allowPipelineCreation is false\n}\nprecheck finished\ntriggerPipelineCreation // runs and creates pipelines\nsafe mode exit\nstartFixedIntervalPipelineCreator // calls createPipelines right away once at start\ntriggerPipelineCreation // tries to call createPipelines if it is not running from the prev. call\nI think we don't need this last call, which makes the triggerPipelines boolean unnecessary and the code a bit simpler. Is it correct, or I am still missing something? :)", "author": "fapifta", "createdAt": "2020-03-31T10:52:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIyMTA1OA==", "url": "https://github.com/apache/ozone/pull/719#discussion_r401221058", "bodyText": "Good observation - you are correct. I have simplified this as you suggested.", "author": "sodonnel", "createdAt": "2020-03-31T21:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "7841e1d482f13e24c22e0a2c734da7fe26382251", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\nindex 1239730a91..c5192b39c9 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n\n@@ -667,14 +667,14 @@ public synchronized void handleSafeModeTransition(\n       SCMSafeModeManager.SafeModeStatus status) {\n     // TODO: #CLUTIL - handle safemode getting re-enabled\n     boolean currentAllowPipelines =\n-        allowPipelineCreation.getAndSet(status.isPreCheckComplete());\n+        pipelineCreationAllowed.getAndSet(status.isPreCheckComplete());\n     boolean currentlyInSafeMode =\n         isInSafeMode.getAndSet(status.isInSafeMode());\n     boolean triggerPipelines = false;\n \n     // Trigger pipeline creation only if the preCheck status has changed to\n     // complete.\n-    if (allowPipelineCreation.get() && !currentAllowPipelines) {\n+    if (isPipelineCreationAllowed() && !currentAllowPipelines) {\n       triggerPipelines = true;\n     }\n     // Start the pipeline creation thread only when safemode switches off\n"}}, {"oid": "7841e1d482f13e24c22e0a2c734da7fe26382251", "url": "https://github.com/apache/ozone/commit/7841e1d482f13e24c22e0a2c734da7fe26382251", "message": "Rename allow pipeline creation methods in SCMPipeline manager based on review comments", "committedDate": "2020-03-31T08:36:38Z", "type": "commit"}, {"oid": "760d644995e6b3e5a06d54baac50778cad33aab2", "url": "https://github.com/apache/ozone/commit/760d644995e6b3e5a06d54baac50778cad33aab2", "message": "trigger new CI check", "committedDate": "2020-03-31T10:23:38Z", "type": "commit"}, {"oid": "fb200e0227fa5a45ce97e4fe2847ebee1d2c73cf", "url": "https://github.com/apache/ozone/commit/fb200e0227fa5a45ce97e4fe2847ebee1d2c73cf", "message": "Simplify trigger pipeline creation logic in scmPipelineManager safemode hook", "committedDate": "2020-03-31T21:19:58Z", "type": "commit"}]}