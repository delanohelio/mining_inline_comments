{"pr_number": 1723, "pr_title": "HDDS-4588. If volume's quota is enabled then bucket's quota cannot be cleared", "pr_createdAt": "2020-12-18T05:53:46Z", "pr_url": "https://github.com/apache/ozone/pull/1723", "timeline": [{"oid": "415023fae4fa235474afd0c419336aff9e94452f", "url": "https://github.com/apache/ozone/commit/415023fae4fa235474afd0c419336aff9e94452f", "message": "fix clear bucket quota.", "committedDate": "2020-12-18T08:19:22Z", "type": "forcePushed"}, {"oid": "331219c104a833d4d5b7207097789e4d40250c0c", "url": "https://github.com/apache/ozone/commit/331219c104a833d4d5b7207097789e4d40250c0c", "message": "fix ci", "committedDate": "2020-12-18T12:50:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTkyMA==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r546189920", "bodyText": "Nit: will it better to use more descriptive names than variable names. For example, replace quotaInBytes by space quota?", "author": "amaliujia", "createdAt": "2020-12-19T04:32:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -228,6 +228,13 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n       throws IOException {\n     long quotaInBytes = omBucketArgs.getQuotaInBytes();\n \n+    if (quotaInBytes == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInBytes() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket quotaInBytes,\" +", "originalCommit": "331219c104a833d4d5b7207097789e4d40250c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\nindex 822703ea7..892d6cfca 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n\n@@ -231,8 +231,7 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n     if (quotaInBytes == OzoneConsts.QUOTA_RESET &&\n         omVolumeArgs.getQuotaInBytes() != OzoneConsts.QUOTA_RESET) {\n       throw new OMException(\"Before clear bucket quotaInBytes,\" +\n-          \" volume quotaInBytes need to be clear first.\",\n-          OMException.ResultCodes.QUOTA_ERROR);\n+          \" volume quotaInBytes need to be clear first.\", OMException.ResultCodes.QUOTA_ERROR);\n     }\n \n     if (quotaInBytes == 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTk1OQ==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r546189959", "bodyText": "Nit: same, maybe replace quotaInNamespace by namespace quota?", "author": "amaliujia", "createdAt": "2020-12-19T04:32:49Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -259,9 +266,16 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n   }\n \n   public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n-      OmBucketArgs omBucketArgs) {\n+      OmBucketArgs omBucketArgs) throws IOException{\n     long quotaInNamespace = omBucketArgs.getQuotaInNamespace();\n \n+    if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",", "originalCommit": "331219c104a833d4d5b7207097789e4d40250c0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIyNDYzMQ==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r546224631", "bodyText": "Agreed with @amaliujia 's suggestion. I also prefer to do below rename changing for more readable:\nquotaInNamespace -> namespaceQuota\nquotaInNamespace -> spaceQuota", "author": "linyiqun", "createdAt": "2020-12-19T10:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\nindex 822703ea7..892d6cfca 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n\n@@ -272,8 +271,7 @@ public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n     if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n         omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n       throw new OMException(\"Before clear bucket \" +\n-          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n-          OMException.ResultCodes.QUOTA_ERROR);\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\", OMException.ResultCodes.QUOTA_ERROR);\n     }\n \n     if ((quotaInNamespace <= 0\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4MjQ0NA==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547082444", "bodyText": "Can try something like this -\n  LambdaTestUtils.intercept(IOException.class, \"Before clear bucket \"\n            + \"quotaInBytes, volume quotaInBytes need to be clear first.\",\n        () -> ozoneBucket.clearSpaceQuota());\n\nShall save lines and looks better", "author": "ayushtkn", "createdAt": "2020-12-22T05:52:44Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -311,6 +311,23 @@ public void testSetAndClrQuota() throws IOException {\n         ozoneBucket.getQuotaInBytes());\n     Assert.assertEquals(1000L, ozoneBucket.getQuotaInNamespace());\n \n+    try {\n+      ozoneBucket.clearSpaceQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInBytes, volume quotaInBytes need to be clear first.\", ex);\n+    }", "originalCommit": "331219c104a833d4d5b7207097789e4d40250c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\nindex 617f1ffde..4f47a5554 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\n\n@@ -324,19 +327,19 @@ public void testSetAndClrQuota() throws IOException {\n       Assert.fail(\"clear quota should be failed\");\n     } catch (IOException ex) {\n       GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n-          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n+          \"quotaInNameSpace, volume quotaInNameSpace need to be clear first.\",\n           ex);\n     }\n \n     store.getVolume(volumeName).clearSpaceQuota();\n-    store.getVolume(volumeName).clearCountQuota();\n+    store.getVolume(volumeName).clearNamespaceQuota();\n     OzoneVolume clrVolume = store.getVolume(volumeName);\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET, clrVolume.getQuotaInBytes());\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET,\n         clrVolume.getQuotaInNamespace());\n \n     ozoneBucket.clearSpaceQuota();\n-    ozoneBucket.clearCountQuota();\n+    ozoneBucket.clearNamespaceQuota();\n     OzoneBucket clrBucket = store.getVolume(volumeName).getBucket(bucketName);\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET, clrBucket.getQuotaInBytes());\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4MjYzOA==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547082638", "bodyText": "Similarly here -\n    LambdaTestUtils.intercept(IOException.class, \"Before clear bucket \"\n            + \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n        () -> ozoneBucket.clearCountQuota());", "author": "ayushtkn", "createdAt": "2020-12-22T05:53:20Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -311,6 +311,23 @@ public void testSetAndClrQuota() throws IOException {\n         ozoneBucket.getQuotaInBytes());\n     Assert.assertEquals(1000L, ozoneBucket.getQuotaInNamespace());\n \n+    try {\n+      ozoneBucket.clearSpaceQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInBytes, volume quotaInBytes need to be clear first.\", ex);\n+    }\n+\n+    try {\n+      ozoneBucket.clearCountQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n+          ex);\n+    }", "originalCommit": "331219c104a833d4d5b7207097789e4d40250c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\nindex 617f1ffde..4f47a5554 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java\n\n@@ -324,19 +327,19 @@ public void testSetAndClrQuota() throws IOException {\n       Assert.fail(\"clear quota should be failed\");\n     } catch (IOException ex) {\n       GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n-          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n+          \"quotaInNameSpace, volume quotaInNameSpace need to be clear first.\",\n           ex);\n     }\n \n     store.getVolume(volumeName).clearSpaceQuota();\n-    store.getVolume(volumeName).clearCountQuota();\n+    store.getVolume(volumeName).clearNamespaceQuota();\n     OzoneVolume clrVolume = store.getVolume(volumeName);\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET, clrVolume.getQuotaInBytes());\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET,\n         clrVolume.getQuotaInNamespace());\n \n     ozoneBucket.clearSpaceQuota();\n-    ozoneBucket.clearCountQuota();\n+    ozoneBucket.clearNamespaceQuota();\n     OzoneBucket clrBucket = store.getVolume(volumeName).getBucket(bucketName);\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET, clrBucket.getQuotaInBytes());\n     Assert.assertEquals(OzoneConsts.QUOTA_RESET,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4Mzc2MQ==", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547083761", "bodyText": "Seems some grammatical  error in the message, Can you check and reframe if possible,\nMay be something like a warning, Can not clear bucket namespace quota because volume namespace quota is not unset. Or may be something better....", "author": "ayushtkn", "createdAt": "2020-12-22T05:56:52Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -259,9 +266,16 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n   }\n \n   public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n-      OmBucketArgs omBucketArgs) {\n+      OmBucketArgs omBucketArgs) throws IOException{\n     long quotaInNamespace = omBucketArgs.getQuotaInNamespace();\n \n+    if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",", "originalCommit": "331219c104a833d4d5b7207097789e4d40250c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\nindex 822703ea7..892d6cfca 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java\n\n@@ -272,8 +271,7 @@ public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n     if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n         omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n       throw new OMException(\"Before clear bucket \" +\n-          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n-          OMException.ResultCodes.QUOTA_ERROR);\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\", OMException.ResultCodes.QUOTA_ERROR);\n     }\n \n     if ((quotaInNamespace <= 0\n"}}, {"oid": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "url": "https://github.com/apache/ozone/commit/ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "message": "fix clear bucket quota.", "committedDate": "2020-12-28T06:18:23Z", "type": "commit"}, {"oid": "f71cdb471940440053abb791fae74abf9dbfe390", "url": "https://github.com/apache/ozone/commit/f71cdb471940440053abb791fae74abf9dbfe390", "message": "fix style", "committedDate": "2020-12-28T06:18:23Z", "type": "commit"}, {"oid": "4847f7145ad004facd01044a3de8f448dc0ac324", "url": "https://github.com/apache/ozone/commit/4847f7145ad004facd01044a3de8f448dc0ac324", "message": "fix ci", "committedDate": "2020-12-28T06:18:23Z", "type": "commit"}, {"oid": "48c29cf17f1d4eb7f13c901829ff336e26103822", "url": "https://github.com/apache/ozone/commit/48c29cf17f1d4eb7f13c901829ff336e26103822", "message": "fix review issues", "committedDate": "2020-12-28T06:18:23Z", "type": "commit"}, {"oid": "ec5984e677356e0f4866c4565be4ed2c89863126", "url": "https://github.com/apache/ozone/commit/ec5984e677356e0f4866c4565be4ed2c89863126", "message": "rebae and fix namespace.", "committedDate": "2020-12-28T06:22:54Z", "type": "commit"}, {"oid": "ec5984e677356e0f4866c4565be4ed2c89863126", "url": "https://github.com/apache/ozone/commit/ec5984e677356e0f4866c4565be4ed2c89863126", "message": "rebae and fix namespace.", "committedDate": "2020-12-28T06:22:54Z", "type": "forcePushed"}]}