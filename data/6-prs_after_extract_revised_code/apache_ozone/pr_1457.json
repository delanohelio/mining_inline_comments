{"pr_number": 1457, "pr_title": "HDDS-4253. Add LayoutVersion request/response for DN registration.", "pr_createdAt": "2020-09-30T06:02:42Z", "pr_url": "https://github.com/apache/ozone/pull/1457", "timeline": [{"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "url": "https://github.com/apache/ozone/commit/6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "message": "HDDS-4253. Add LayoutVersion request/response for DN registration.", "committedDate": "2020-09-30T05:58:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2Njc5Nw==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497566797", "bodyText": "Can you update javadoc here as we add new param layoutVersionInfo?", "author": "linyiqun", "createdAt": "2020-09-30T14:42:47Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java", "diffHunk": "@@ -58,7 +60,8 @@\n    */\n   RegisteredCommand register(DatanodeDetails datanodeDetails,\n                              NodeReportProto nodeReport,\n-                             PipelineReportsProto pipelineReport);\n+                             PipelineReportsProto pipelineReport,\n+                             LayoutVersionProto layoutVersionInfo);", "originalCommit": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU5OTUzOQ==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r498599539", "bodyText": "@linyiqun  Thanks for the review. yup I will add it.", "author": "prashantpogde", "createdAt": "2020-10-02T02:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2Njc5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "7453413e806993cba4506c0a3a438730417db045", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java\nindex e0552faab4..33757739c6 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java\n\n@@ -56,6 +56,7 @@\n    * @param datanodeDetails DatanodeDetails\n    * @param nodeReport NodeReportProto\n    * @param pipelineReport PipelineReportsProto\n+   * @param layoutVersionInfo LayoutVersionProto\n    * @return  SCMRegisteredResponseProto\n    */\n   RegisteredCommand register(DatanodeDetails datanodeDetails,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MTM4OQ==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497571389", "bodyText": "For another case, if register dn layout version lower than scm version, do we need to print some log here that can be helpful for us know some old version DN be registered?", "author": "linyiqun", "createdAt": "2020-09-30T14:48:40Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -240,8 +247,19 @@ public VersionResponse getVersion(SCMVersionRequestProto versionRequest) {\n   @Override\n   public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n-      PipelineReportsProto pipelineReportsProto) {\n-\n+      PipelineReportsProto pipelineReportsProto,\n+      LayoutVersionProto layoutInfo) {\n+\n+    if (layoutInfo != null) {\n+      if (layoutInfo.getSoftwareLayoutVersion() >\n+          scmLayoutVersionManager.getSoftwareLayoutVersion()) {", "originalCommit": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYwMDA2MA==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r498600060", "bodyText": "SCM can handle multiple DNs and it may make log verbose. This will be thrown back to the DN and it will be logged there for debugging as to why datanode is not able to register with SCM.", "author": "prashantpogde", "createdAt": "2020-10-02T02:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MTM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYzNjI1OA==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r498636258", "bodyText": "Okay, makes sense to me.", "author": "linyiqun", "createdAt": "2020-10-02T06:28:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MTM4OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzNjYzNg==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497836636", "bodyText": "Can we move this check to org.apache.hadoop.hdds.scm.server.SCMDatanodeProtocolServer#register? That way, a lot of test changes in this patch to incorporate the 4th parameter to NodeManager.register() can be avoided.", "author": "avijayanhwx", "createdAt": "2020-09-30T22:29:36Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -240,8 +247,19 @@ public VersionResponse getVersion(SCMVersionRequestProto versionRequest) {\n   @Override\n   public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n-      PipelineReportsProto pipelineReportsProto) {\n-\n+      PipelineReportsProto pipelineReportsProto,\n+      LayoutVersionProto layoutInfo) {\n+\n+    if (layoutInfo != null) {", "originalCommit": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYwMDMyNA==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r498600324", "bodyText": "thanks @avijayanhwx  for the review. I thought about it while I wrote this. I wanted all registration related processing for all the passed parameters to be consolidated in one place and it seems like NodeManager.register is the right place even though we have to add another parameter in bunch of places. Majority of these places are unit tests.", "author": "prashantpogde", "createdAt": "2020-10-02T02:58:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzNjYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODczNA==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r499748734", "bodyText": "Have you considered Optional semantics here? Does it make code more readable?", "author": "swagle", "createdAt": "2020-10-05T17:10:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzNjYzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NTY1Mw==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r500475653", "bodyText": "I would still need to check for condition where the argument is not valid.", "author": "prashantpogde", "createdAt": "2020-10-06T17:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzNjYzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MDk1MA==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497840950", "bodyText": "Nit. I don't see any usages for this yet.", "author": "avijayanhwx", "createdAt": "2020-09-30T22:41:49Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -1149,4 +1155,8 @@ public String getScmId() {\n   public String getClusterId() {\n     return getScmStorageConfig().getClusterID();\n   }\n+\n+  public HDDSLayoutVersionManager getLayoutVersionManager() {", "originalCommit": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MTc4MQ==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497841781", "bodyText": "Can we refactor this test to use last layout feature's version and last layout feature's version + 1 for success and failure cases? That way, the test does not need change every time a Layout feature is added.", "author": "avijayanhwx", "createdAt": "2020-09-30T22:44:22Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java", "diffHunk": "@@ -170,6 +176,33 @@ public void testScmHeartbeat()\n     }\n   }\n \n+  /**\n+   * Tests that Node manager handles Layout versions correctly.\n+   *\n+   * @throws IOException\n+   * @throws InterruptedException\n+   * @throws TimeoutException\n+   */\n+  @Test\n+  public void testScmLayoutOnRegister()\n+      throws IOException, InterruptedException, AuthenticationException {\n+\n+    try (SCMNodeManager nodeManager = createNodeManager(getConf())) {\n+      LayoutVersionProto layoutInfoSuccess = LayoutVersionProto.newBuilder()\n+          .setMetadataLayoutVersion(1).setSoftwareLayoutVersion(1).build();", "originalCommit": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYwMDM2Mg==", "url": "https://github.com/apache/ozone/pull/1457#discussion_r498600362", "bodyText": "Yup, I will do this.", "author": "prashantpogde", "createdAt": "2020-10-02T02:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MTc4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7453413e806993cba4506c0a3a438730417db045", "chunk": "diff --git a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\nindex 38739914ff..62b7ac4fad 100644\n--- a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\n+++ b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\n\n@@ -188,10 +188,15 @@ public void testScmLayoutOnRegister()\n       throws IOException, InterruptedException, AuthenticationException {\n \n     try (SCMNodeManager nodeManager = createNodeManager(getConf())) {\n+      Integer nodeManagerSoftwareLayoutVersion =\n+          nodeManager.getLayoutVersionManager().getSoftwareLayoutVersion();\n       LayoutVersionProto layoutInfoSuccess = LayoutVersionProto.newBuilder()\n-          .setMetadataLayoutVersion(1).setSoftwareLayoutVersion(1).build();\n+          .setMetadataLayoutVersion(1)\n+          .setSoftwareLayoutVersion(nodeManagerSoftwareLayoutVersion).build();\n       LayoutVersionProto layoutInfoFailure = LayoutVersionProto.newBuilder()\n-          .setMetadataLayoutVersion(1).setSoftwareLayoutVersion(2).build();\n+          .setMetadataLayoutVersion(1)\n+          .setSoftwareLayoutVersion(nodeManagerSoftwareLayoutVersion + 1)\n+          .build();\n       RegisteredCommand rcmd = nodeManager.register(\n           MockDatanodeDetails.randomDatanodeDetails(), null,\n           getRandomPipelineReports(), layoutInfoSuccess);\n"}}, {"oid": "7453413e806993cba4506c0a3a438730417db045", "url": "https://github.com/apache/ozone/commit/7453413e806993cba4506c0a3a438730417db045", "message": "HDDS-4253. Addressed review comments and CI failure.", "committedDate": "2020-10-02T03:16:57Z", "type": "commit"}, {"oid": "4e23b74d150a6f534ba8b5f0bced90c3b6174f14", "url": "https://github.com/apache/ozone/commit/4e23b74d150a6f534ba8b5f0bced90c3b6174f14", "message": "HDDS-4253.Addressing CI failure.", "committedDate": "2020-10-06T04:25:22Z", "type": "commit"}]}