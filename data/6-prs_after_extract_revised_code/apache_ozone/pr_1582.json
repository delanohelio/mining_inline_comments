{"pr_number": 1582, "pr_title": "HDDS-4235. Ozone client FS path validation is not present in OFS.", "pr_createdAt": "2020-11-12T16:13:35Z", "pr_url": "https://github.com/apache/ozone/pull/1582", "timeline": [{"oid": "32f8159fadf4ffcae34c4e2471f47cfbb8c636e2", "url": "https://github.com/apache/ozone/commit/32f8159fadf4ffcae34c4e2471f47cfbb8c636e2", "message": "HDDS-4235. Ozone client FS path validation is not present in OFS.", "committedDate": "2020-11-12T16:11:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg5MzU4Mg==", "url": "https://github.com/apache/ozone/pull/1582#discussion_r522893582", "bodyText": "Avoid unnecessary duplicate conversion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!OzoneFSUtils.isValidName(path.toUri().getPath())) {\n          \n          \n            \n                if (!OzoneFSUtils.isValidName(key)) {", "author": "adoroszlai", "createdAt": "2020-11-13T11:30:47Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -840,8 +842,12 @@ public String pathToKey(Path path) {\n     if (!path.isAbsolute()) {\n       path = new Path(workingDir, path);\n     }\n+    String key = path.toUri().getPath();\n+    if (!OzoneFSUtils.isValidName(path.toUri().getPath())) {", "originalCommit": "32f8159fadf4ffcae34c4e2471f47cfbb8c636e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "117ed312bf7cf27b29ffbc04853d2f88c0585d7b", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\nindex f9ef025ef..c035abbb4 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\n\n@@ -843,7 +843,7 @@ public String pathToKey(Path path) {\n       path = new Path(workingDir, path);\n     }\n     String key = path.toUri().getPath();\n-    if (!OzoneFSUtils.isValidName(path.toUri().getPath())) {\n+    if (!OzoneFSUtils.isValidName(key)) {\n       throw new InvalidPathException(\"Invalid path Name \" + key);\n     }\n     // removing leading '/' char\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg5NDg3Nw==", "url": "https://github.com/apache/ozone/pull/1582#discussion_r522894877", "bodyText": "Not introduced in this patch, but would be nice to remove duplicate conversion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (OzoneFSUtils.isValidName(key)) {\n          \n          \n            \n                  key = path.toUri().getPath();\n          \n          \n            \n                } else {\n          \n          \n            \n                if (!OzoneFSUtils.isValidName(key)) {", "author": "adoroszlai", "createdAt": "2020-11-13T11:33:47Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -817,7 +817,7 @@ public String pathToKey(Path path) {\n     if (OzoneFSUtils.isValidName(key)) {\n       key = path.toUri().getPath();\n     } else {", "originalCommit": "32f8159fadf4ffcae34c4e2471f47cfbb8c636e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "117ed312bf7cf27b29ffbc04853d2f88c0585d7b", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\nindex 0d713d0d3..f6d2ef591 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n\n@@ -814,9 +814,7 @@ public String pathToKey(Path path) {\n     // removing leading '/' char\n     String key = path.toUri().getPath();\n \n-    if (OzoneFSUtils.isValidName(key)) {\n-      key = path.toUri().getPath();\n-    } else {\n+    if (!OzoneFSUtils.isValidName(key)) {\n       throw new InvalidPathException(\"Invalid path Name \" + key);\n     }\n     LOG.trace(\"path for key:{} is:{}\", key, path);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjg5NzkzNQ==", "url": "https://github.com/apache/ozone/pull/1582#discussion_r522897935", "bodyText": "Seems like outputStream is never updated to non-null value, hence unnecessary.", "author": "adoroszlai", "createdAt": "2020-11-13T11:40:24Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -1210,4 +1212,33 @@ public void testTrash() throws Exception {\n     ofs.delete(trashRoot, true);\n \n   }\n+\n+  @Test\n+  public void testCreateWithInvalidPaths() throws Exception {\n+    // Test for path with ..\n+    Path parent = new Path(\"../../../../../d1/d2/\");\n+    Path file1 = new Path(parent, \"key1\");\n+    checkInvalidPath(file1);\n+\n+    // Test for path with :\n+    file1 = new Path(\"/:/:\");\n+    checkInvalidPath(file1);\n+\n+    // Test for path with scheme and authority.\n+    file1 = new Path(fs.getUri() + \"/:/:\");\n+    checkInvalidPath(file1);\n+  }\n+\n+  private void checkInvalidPath(Path path) throws Exception {\n+    FSDataOutputStream outputStream = null;\n+    try {\n+      LambdaTestUtils.intercept(InvalidPathException.class, \"Invalid path Name\",\n+          () -> fs.create(path, false));\n+    } finally {\n+      if (outputStream != null) {", "originalCommit": "32f8159fadf4ffcae34c4e2471f47cfbb8c636e2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "117ed312bf7cf27b29ffbc04853d2f88c0585d7b", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java\nindex 4ff4a20cf..46528ff78 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java\n\n@@ -1230,15 +1230,7 @@ public void testCreateWithInvalidPaths() throws Exception {\n   }\n \n   private void checkInvalidPath(Path path) throws Exception {\n-    FSDataOutputStream outputStream = null;\n-    try {\n-      LambdaTestUtils.intercept(InvalidPathException.class, \"Invalid path Name\",\n-          () -> fs.create(path, false));\n-    } finally {\n-      if (outputStream != null) {\n-        outputStream.close();\n-      }\n-    }\n+    LambdaTestUtils.intercept(InvalidPathException.class, \"Invalid path Name\",\n+        () -> fs.create(path, false));\n   }\n-\n }\n"}}, {"oid": "117ed312bf7cf27b29ffbc04853d2f88c0585d7b", "url": "https://github.com/apache/ozone/commit/117ed312bf7cf27b29ffbc04853d2f88c0585d7b", "message": "Handle Review Comments", "committedDate": "2020-11-13T12:18:26Z", "type": "commit"}]}