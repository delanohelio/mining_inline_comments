{"pr_number": 1506, "pr_title": "HDDS-4359. Expose VolumeIOStats in DN JMX", "pr_createdAt": "2020-10-20T10:52:49Z", "pr_url": "https://github.com/apache/ozone/pull/1506", "timeline": [{"oid": "a362947511469fb39884232061e1e5fb4b341e47", "url": "https://github.com/apache/ozone/commit/a362947511469fb39884232061e1e5fb4b341e47", "message": "HDDS-4359. Expose VolumeIOStats in DN JMX\n\nChange-Id: I845824edc4af1c41c17e2f2e8a5ad63a7b9e4579", "committedDate": "2020-10-20T10:51:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NDY4Ng==", "url": "https://github.com/apache/ozone/pull/1506#discussion_r508574686", "bodyText": "We should have the corresponding VolumeIOStats  unregister method to unregister these metric.", "author": "linyiqun", "createdAt": "2020-10-20T14:48:29Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java", "diffHunk": "@@ -18,121 +18,135 @@\n \n package org.apache.hadoop.ozone.container.common.volume;\n \n-import java.util.concurrent.atomic.AtomicLong;\n+import org.apache.hadoop.metrics2.MetricsSystem;\n+import org.apache.hadoop.metrics2.annotation.Metric;\n+import org.apache.hadoop.metrics2.lib.DefaultMetricsSystem;\n+import org.apache.hadoop.metrics2.lib.MetricsRegistry;\n+import org.apache.hadoop.metrics2.lib.MutableCounterLong;\n \n /**\n  * This class is used to track Volume IO stats for each HDDS Volume.\n  */\n public class VolumeIOStats {\n+  private String name = VolumeIOStats.class.getSimpleName();\n \n-  private final AtomicLong readBytes;\n-  private final AtomicLong readOpCount;\n-  private final AtomicLong writeBytes;\n-  private final AtomicLong writeOpCount;\n-  private final AtomicLong readTime;\n-  private final AtomicLong writeTime;\n+  private @Metric MutableCounterLong readBytes;\n+  private @Metric MutableCounterLong readOpCount;\n+  private @Metric MutableCounterLong writeBytes;\n+  private @Metric MutableCounterLong writeOpCount;\n+  private @Metric MutableCounterLong readTime;\n+  private @Metric MutableCounterLong writeTime;\n+  private MetricsRegistry registry;\n \n   public VolumeIOStats() {\n-    readBytes = new AtomicLong(0);\n-    readOpCount = new AtomicLong(0);\n-    writeBytes = new AtomicLong(0);\n-    writeOpCount = new AtomicLong(0);\n-    readTime = new AtomicLong(0);\n-    writeTime = new AtomicLong(0);\n+    init();\n+  }\n+\n+  public VolumeIOStats(String identifier) {\n+    this.name += '-' + identifier;\n+    init();\n+  }\n+\n+  public void init() {\n+    DefaultMetricsSystem.initialize(name);\n+    MetricsSystem ms = DefaultMetricsSystem.instance();\n+    ms.register(name, \"Volume I/O Statistics\", this);", "originalCommit": "a362947511469fb39884232061e1e5fb4b341e47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc0Nzk3Nw==", "url": "https://github.com/apache/ozone/pull/1506#discussion_r508747977", "bodyText": "oops. thanks for the reminder!", "author": "smengcl", "createdAt": "2020-10-20T18:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NDY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "1628e2b6cdea0ba89bd5378ab94f2952759dcc9e", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java\nindex e9ecbf436..9f56556cf 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java\n\n@@ -28,7 +28,7 @@\n  * This class is used to track Volume IO stats for each HDDS Volume.\n  */\n public class VolumeIOStats {\n-  private String name = VolumeIOStats.class.getSimpleName();\n+  private String sourceName = VolumeIOStats.class.getSimpleName();\n \n   private @Metric MutableCounterLong readBytes;\n   private @Metric MutableCounterLong readOpCount;\n"}}, {"oid": "1628e2b6cdea0ba89bd5378ab94f2952759dcc9e", "url": "https://github.com/apache/ozone/commit/1628e2b6cdea0ba89bd5378ab94f2952759dcc9e", "message": "Add unregister()\n\nChange-Id: I66431f9445ade6b7212c87f4f8d8147b4bc73ca2", "committedDate": "2020-10-20T20:34:40Z", "type": "commit"}, {"oid": "a411543875da865d107290a76b4647b292355ea7", "url": "https://github.com/apache/ozone/commit/a411543875da865d107290a76b4647b292355ea7", "message": "Fix TestOzoneContainer#testBuildNodeReport.\n\nNo need to DefaultMetricsSystem.initialize(sourceName).\n`HddsServerUtil.initializeMetrics(conf, \"HddsDatanode\");` call has already initialized the metrics.\nCalling this again results in UT failures.\n\nChange-Id: Iaeb29e153c7394d2b80eb1bd74db0aeb566f8448", "committedDate": "2020-10-20T21:26:27Z", "type": "commit"}, {"oid": "a124b61403a9aa62a93b5342e9fd77e7fa49f2a0", "url": "https://github.com/apache/ozone/commit/a124b61403a9aa62a93b5342e9fd77e7fa49f2a0", "message": "Remove MetricsRegistry.\n\nChange-Id: I86adf4d6ecc6b12687dfb6c2554bb2c7597a6807", "committedDate": "2020-10-20T22:04:26Z", "type": "commit"}, {"oid": "ee3123789e76b12f3324ecdef98a78775215e6b8", "url": "https://github.com/apache/ozone/commit/ee3123789e76b12f3324ecdef98a78775215e6b8", "message": "Checkstyle.\n\nChange-Id: Id7df790d521d639377390cabe75450fc350e234e", "committedDate": "2020-10-21T00:22:25Z", "type": "commit"}, {"oid": "eca96f51d9925ccf57b95853f756cefb70f37d92", "url": "https://github.com/apache/ozone/commit/eca96f51d9925ccf57b95853f756cefb70f37d92", "message": "Add test in TestContainerMetrics.\n\nChange-Id: I8b607e3d23f558931d4529b8cd95817666ca0a99", "committedDate": "2020-10-21T06:19:26Z", "type": "commit"}, {"oid": "ee39eb856deea5cc843093a31f4d73ff93e2a827", "url": "https://github.com/apache/ozone/commit/ee39eb856deea5cc843093a31f4d73ff93e2a827", "message": "Checkstyle.\n\nChange-Id: I2652375e984528d8f38373e52638f6444fdd5273", "committedDate": "2020-10-21T07:31:22Z", "type": "commit"}]}