{"pr_number": 1257, "pr_title": "HDDS-3970. Enabling TestStorageContainerManager with all failures add\u2026", "pr_createdAt": "2020-07-25T02:02:26Z", "pr_url": "https://github.com/apache/ozone/pull/1257", "timeline": [{"oid": "a1e7598d3857c4098807e523165958edeb232169", "url": "https://github.com/apache/ozone/commit/a1e7598d3857c4098807e523165958edeb232169", "message": "HDDS-3970. Enabling TestStorageContainerManager with all failures addressed.", "committedDate": "2020-07-25T01:58:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyNjYzOQ==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460726639", "bodyText": "Sleep lengths in testCloseContainerCommandOnRestart are being increased.  Why do we need to increase timeout on another test method?", "author": "adoroszlai", "createdAt": "2020-07-27T08:26:34Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -525,7 +523,7 @@ public void testScmInfo() throws Exception {\n   /**\n    * Test datanode heartbeat well processed with a 4-layer network topology.\n    */\n-  @Test(timeout = 60000)\n+  @Test(timeout = 180000)\n   public void testScmProcessDatanodeHeartbeat() throws Exception {", "originalCommit": "a1e7598d3857c4098807e523165958edeb232169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMyNjc0OA==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461326748", "bodyText": "I tested it multiple times on my laptop and tests use to timeout occasionally depending on other applications on my laptop. I kept it long enough that there should be no flakiness in the tests.", "author": "prashantpogde", "createdAt": "2020-07-28T05:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyNjYzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460728240", "bodyText": "Repeated check (eg. GenericTestUtils.waitFor) should be preferred over fixed length sleep:\n\nallow quicker test execution if possible\nexplicit condition documents what the test is waiting for", "author": "adoroszlai", "createdAt": "2020-07-27T08:29:15Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -593,7 +591,7 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n           new TestStorageContainerManagerHelper(cluster, conf);\n \n       helper.createKeys(10, 4096);\n-      Thread.sleep(5000);\n+      Thread.sleep(10000);", "originalCommit": "a1e7598d3857c4098807e523165958edeb232169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3MTE0OQ==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461371149", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-07-28T07:22:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYxMDExMg==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461610112", "bodyText": "Thanks.  What about the other sleep?", "author": "adoroszlai", "createdAt": "2020-07-28T14:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3ODc5MA==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461878790", "bodyText": "I spent some time looking around in the code. Not sure how we can do this cleanly for the other sleep.", "author": "prashantpogde", "createdAt": "2020-07-28T21:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5NDc2MQ==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461894761", "bodyText": "Changed this to ->\n\nwaiting till the replication manager comes up using GenericTestUtils.waitFor and then\nwait some more to give it enough time to process containers", "author": "prashantpogde", "createdAt": "2020-07-28T21:37:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\nindex 63284f984..f6eb77e87 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n\n@@ -591,7 +591,10 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n           new TestStorageContainerManagerHelper(cluster, conf);\n \n       helper.createKeys(10, 4096);\n-      Thread.sleep(10000);\n+      GenericTestUtils.waitFor(() -> {\n+        return cluster.getStorageContainerManager().getContainerManager().\n+            getContainers() != null;\n+      }, 1000, 10000);\n \n       StorageContainerManager scm = cluster.getStorageContainerManager();\n       List<ContainerInfo> containers = cluster.getStorageContainerManager()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODg4MQ==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460728881", "bodyText": "Why not LOG.info(?", "author": "adoroszlai", "createdAt": "2020-07-27T08:30:17Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(", "originalCommit": "a1e7598d3857c4098807e523165958edeb232169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzMTU4OA==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461331588", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-07-28T05:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODg4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\nindex 63284f984..f6eb77e87 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n\n@@ -602,11 +605,16 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n-          \"Current Container State is\" + selectedContainer.getState());\n-      if (selectedContainer.getState() == HddsProtos.LifeCycleState.OPEN) {\n+      LOG.info(\n+          \"Current Container State is {}\", selectedContainer.getState());\n+      try {\n         scm.getContainerManager().updateContainerState(selectedContainer\n             .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      } catch (SCMException ex) {\n+        if (selectedContainer.getState() != HddsProtos.LifeCycleState.CLOSING) {\n+          ex.printStackTrace();\n+          throw(ex);\n+        }\n       }\n \n       cluster.restartStorageContainerManager(false);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczMTYyNg==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460731626", "bodyText": "Please use placeholder in log message instead of + to avoid new code warning (sonar).", "author": "adoroszlai", "createdAt": "2020-07-27T08:34:55Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n+          \"Current Container State is\" + selectedContainer.getState());", "originalCommit": "a1e7598d3857c4098807e523165958edeb232169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MjY3Mg==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461382672", "bodyText": "done", "author": "prashantpogde", "createdAt": "2020-07-28T07:43:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczMTYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\nindex 63284f984..f6eb77e87 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n\n@@ -602,11 +605,16 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n-          \"Current Container State is\" + selectedContainer.getState());\n-      if (selectedContainer.getState() == HddsProtos.LifeCycleState.OPEN) {\n+      LOG.info(\n+          \"Current Container State is {}\", selectedContainer.getState());\n+      try {\n         scm.getContainerManager().updateContainerState(selectedContainer\n             .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      } catch (SCMException ex) {\n+        if (selectedContainer.getState() != HddsProtos.LifeCycleState.CLOSING) {\n+          ex.printStackTrace();\n+          throw(ex);\n+        }\n       }\n \n       cluster.restartStorageContainerManager(false);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczNDIyNw==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460734227", "bodyText": "Do you know what other thread changed container state to CLOSING?  Don't we still have a race condition here: in the time window between getState and updateContainerState that other thread could still change state of the container?", "author": "adoroszlai", "createdAt": "2020-07-27T08:39:18Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n+          \"Current Container State is\" + selectedContainer.getState());\n+      if (selectedContainer.getState() == HddsProtos.LifeCycleState.OPEN) {\n+        scm.getContainerManager().updateContainerState(selectedContainer\n+            .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);", "originalCommit": "a1e7598d3857c4098807e523165958edeb232169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTMzNzYzMA==", "url": "https://github.com/apache/ozone/pull/1257#discussion_r461337630", "bodyText": "no, I couldn't find the other thread closing the container. one theory could be, We stopped processing the heartbeat from the datanode and if it assumes data node is dead, it could close the container.\nYes there is a race condition still unless it could be done atomically. I changed it to try/catch to avoid any race condition.", "author": "prashantpogde", "createdAt": "2020-07-28T06:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczNDIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\nindex 63284f984..f6eb77e87 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java\n\n@@ -602,11 +605,16 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n-          \"Current Container State is\" + selectedContainer.getState());\n-      if (selectedContainer.getState() == HddsProtos.LifeCycleState.OPEN) {\n+      LOG.info(\n+          \"Current Container State is {}\", selectedContainer.getState());\n+      try {\n         scm.getContainerManager().updateContainerState(selectedContainer\n             .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      } catch (SCMException ex) {\n+        if (selectedContainer.getState() != HddsProtos.LifeCycleState.CLOSING) {\n+          ex.printStackTrace();\n+          throw(ex);\n+        }\n       }\n \n       cluster.restartStorageContainerManager(false);\n"}}, {"oid": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "url": "https://github.com/apache/ozone/commit/141c89e3ff8af93c246aeed1ed2dd82fce499e32", "message": "HDDS-3970. Changes after addressing code review comments.", "committedDate": "2020-07-28T07:51:49Z", "type": "commit"}, {"oid": "938db9c601cc62c69efcacc564a7e39c5d01ffbb", "url": "https://github.com/apache/ozone/commit/938db9c601cc62c69efcacc564a7e39c5d01ffbb", "message": "HDDS-3970. Part3 : Changes after addressing code review comments.", "committedDate": "2020-07-28T21:35:44Z", "type": "commit"}, {"oid": "938db9c601cc62c69efcacc564a7e39c5d01ffbb", "url": "https://github.com/apache/ozone/commit/938db9c601cc62c69efcacc564a7e39c5d01ffbb", "message": "HDDS-3970. Part3 : Changes after addressing code review comments.", "committedDate": "2020-07-28T21:35:44Z", "type": "forcePushed"}, {"oid": "6f3dea0f716024c2368ea0c1bb3ef49a97c27ca1", "url": "https://github.com/apache/ozone/commit/6f3dea0f716024c2368ea0c1bb3ef49a97c27ca1", "message": "trigger new CI check", "committedDate": "2020-07-29T13:07:48Z", "type": "commit"}]}