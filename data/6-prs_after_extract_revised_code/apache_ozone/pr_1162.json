{"pr_number": 1162, "pr_title": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen\u2026", "pr_createdAt": "2020-07-04T09:24:17Z", "pr_url": "https://github.com/apache/ozone/pull/1162", "timeline": [{"oid": "247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "url": "https://github.com/apache/ozone/commit/247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes", "committedDate": "2020-07-04T09:27:40Z", "type": "forcePushed"}, {"oid": "a05598276e11bf7981b5c142a470e993293f375a", "url": "https://github.com/apache/ozone/commit/a05598276e11bf7981b5c142a470e993293f375a", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes", "committedDate": "2020-07-04T14:14:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450514295", "bodyText": "NIT: this line to move the line to calculate delta from 547->549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication.", "author": "xiaoyuyao", "createdAt": "2020-07-06T22:35:21Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "originalCommit": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzNTIzMg==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452035232", "bodyText": "This delta calculation and check in line 550 is required.  Currenlty placementStatus.isPolicySatisfied() only checks whether topology requirement is satisfied or not. It doesn't check whether it has enough replicas.", "author": "ChenSammi", "createdAt": "2020-07-09T08:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0MTMxNQ==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452541315", "bodyText": "Got it. I agree delta calculation is needed. I mean move delta calculation after placementStatus is not necessary.", "author": "xiaoyuyao", "createdAt": "2020-07-09T23:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\nindex 65f9e24f3f..7a250687c7 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\n\n@@ -547,14 +547,14 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n         int delta = replicationFactor - getReplicaCount(id, replicas);\n-        if (placementStatus.isPolicySatisfied() && delta <= 0) {\n-          LOG.debug(\n-              \"Container {} meets placement policy with inflight replicas\", id);\n-          return;\n-        }\n         final int misRepDelta = placementStatus.misReplicationCount();\n         final int replicasNeeded\n             = delta < misRepDelta ? misRepDelta : delta;\n+        if (replicasNeeded <= 0) {\n+          LOG.debug(\"Container {} meets replication requirement with \" +\n+              \"inflight replicas\", id);\n+          return;\n+        }\n \n         final List<DatanodeDetails> excludeList = replicas.stream()\n             .map(ContainerReplica::getDatanodeDetails)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450820397", "bodyText": "Rather than this new IF block here, would it make sense to simply add:\nif (replicasNeeded <= 0) {\n  LOG.debug(...);\n  return;\n}\n\nAt line 554 / 558, just after the line:\n        final int replicasNeeded\n            = delta < misRepDelta ? misRepDelta : delta;\n\nThat would avoid needing to check call placementStatus.isPolicySatisfied() and then placementStatus.misReplicationCount() afterwards, as misReplicationCount() calls isPolicySatisfied() anyway.", "author": "sodonnel", "createdAt": "2020-07-07T12:17:50Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);\n+        if (placementStatus.isPolicySatisfied() && delta <= 0) {", "originalCommit": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1MjM1Mg==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452052352", "bodyText": "Make sense.", "author": "ChenSammi", "createdAt": "2020-07-09T08:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\nindex 65f9e24f3f..7a250687c7 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java\n\n@@ -547,14 +547,14 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n         int delta = replicationFactor - getReplicaCount(id, replicas);\n-        if (placementStatus.isPolicySatisfied() && delta <= 0) {\n-          LOG.debug(\n-              \"Container {} meets placement policy with inflight replicas\", id);\n-          return;\n-        }\n         final int misRepDelta = placementStatus.misReplicationCount();\n         final int replicasNeeded\n             = delta < misRepDelta ? misRepDelta : delta;\n+        if (replicasNeeded <= 0) {\n+          LOG.debug(\"Container {} meets replication requirement with \" +\n+              \"inflight replicas\", id);\n+          return;\n+        }\n \n         final List<DatanodeDetails> excludeList = replicas.stream()\n             .map(ContainerReplica::getDatanodeDetails)\n"}}, {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "message": "address comments", "committedDate": "2020-07-09T08:26:53Z", "type": "commit"}, {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "message": "address comments", "committedDate": "2020-07-09T08:26:53Z", "type": "forcePushed"}, {"oid": "277b028818ffe992416c2b412805f2a790db0c50", "url": "https://github.com/apache/ozone/commit/277b028818ffe992416c2b412805f2a790db0c50", "message": "trigger new CI check", "committedDate": "2020-07-10T06:15:05Z", "type": "commit"}]}