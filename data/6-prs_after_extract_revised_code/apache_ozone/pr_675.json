{"pr_number": 675, "pr_title": "HDDS-3170. Fix issues in File count by size task.", "pr_createdAt": "2020-03-13T19:41:26Z", "pr_url": "https://github.com/apache/ozone/pull/675", "timeline": [{"oid": "5a42abf182c4a14507195057bb4b65849d02e639", "url": "https://github.com/apache/ozone/commit/5a42abf182c4a14507195057bb4b65849d02e639", "message": "HDDS-3170. Fix issues in File count by size task.", "committedDate": "2020-03-13T19:39:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzODk3OQ==", "url": "https://github.com/apache/ozone/pull/675#discussion_r392438979", "bodyText": "Minor: Can be changed to == enum compare instead.", "author": "swagle", "createdAt": "2020-03-13T19:56:13Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java", "diffHunk": "@@ -88,30 +93,47 @@ private void processEvent(int cfIndex, byte[] keyBytes, byte[]\n       valueBytes, OMDBUpdateEvent.OMDBUpdateAction action)\n       throws IOException {\n     String tableName = tablesNames.get(cfIndex);\n-    Class keyType = getKeyType();\n+    Class<String> keyType = getKeyType();\n     Class valueType = getValueType(tableName);\n     if (valueType != null) {\n       OMDBUpdateEvent.OMUpdateEventBuilder builder =\n           new OMDBUpdateEvent.OMUpdateEventBuilder<>();\n       builder.setTable(tableName);\n+      builder.setAction(action);\n \n-      Object key = codecRegistry.asObject(keyBytes, keyType);\n+      String key = codecRegistry.asObject(keyBytes, keyType);\n       builder.setKey(key);\n \n-      if (!action.equals(OMDBUpdateEvent.OMDBUpdateAction.DELETE)) {\n+      if (action.equals(PUT)) {", "originalCommit": "5a42abf182c4a14507195057bb4b65849d02e639", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "377e736a0b42fec73a44a41123e7d103868067a3", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java\nindex 90b64f083..6a9c55899 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java\n\n@@ -104,7 +104,7 @@ private void processEvent(int cfIndex, byte[] keyBytes, byte[]\n       String key = codecRegistry.asObject(keyBytes, keyType);\n       builder.setKey(key);\n \n-      if (action.equals(PUT)) {\n+      if (action == PUT) {\n         Object value = codecRegistry.asObject(valueBytes, valueType);\n         builder.setValue(value);\n         // If a PUT key operation happens on an existing Key, it is tagged\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzOTEyNg==", "url": "https://github.com/apache/ozone/pull/675#discussion_r392439126", "bodyText": "Minor: bad indent", "author": "swagle", "createdAt": "2020-03-13T19:56:37Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java", "diffHunk": "@@ -229,22 +228,39 @@ void populateFileCountBySizeDB() {\n    * Used by reprocess() and process().\n    *\n    * @param omKeyInfo OmKey being updated for count\n-   * @param operation (PUT, DELETE)\n    */\n-  void updateUpperBoundCount(OmKeyInfo omKeyInfo,\n-      OMDBUpdateEvent.OMDBUpdateAction operation) {\n+  void handlePutKeyEvent(OmKeyInfo omKeyInfo) {\n     int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n-    if (operation == PUT) {\n-      upperBoundCount[binIndex]++;\n-    } else if (operation == DELETE) {\n-      if (upperBoundCount[binIndex] != 0) {\n+    upperBoundCount[binIndex]++;\n+  }\n+\n+  /**\n+   * Calculate and update the count of files being tracked by\n+   * upperBoundCount[].\n+   * Used by reprocess() and process().\n+   *\n+   * @param omKeyInfo OmKey being updated for count\n+   */\n+  void handleDeleteKeyEvent(String key, OmKeyInfo omKeyInfo) {\n+    if (omKeyInfo == null) {\n+      LOG.warn(\"Unexpected error while handling DELETE key event. Key not \" +\n+          \"found in Recon OM DB : {}\", key);\n+    } else {\n+      int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n+      if (upperBoundCount[binIndex] > 0) {\n         //decrement only if it had files before, default DB value is 0\n         upperBoundCount[binIndex]--;\n       } else {\n         LOG.warn(\"Unexpected error while updating bin count. Found 0 count \" +\n-            \"for index : {} while processing DELETE event for {}\", binIndex,\n+                \"for index : {} while processing DELETE event for {}\", binIndex,", "originalCommit": "5a42abf182c4a14507195057bb4b65849d02e639", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "377e736a0b42fec73a44a41123e7d103868067a3", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java\nindex 91a3dfb91..4e6b2e658 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java\n\n@@ -252,7 +252,7 @@ void handleDeleteKeyEvent(String key, OmKeyInfo omKeyInfo) {\n         upperBoundCount[binIndex]--;\n       } else {\n         LOG.warn(\"Unexpected error while updating bin count. Found 0 count \" +\n-                \"for index : {} while processing DELETE event for {}\", binIndex,\n+            \"for index : {} while processing DELETE event for {}\", binIndex,\n             omKeyInfo.getKeyName());\n       }\n     }\n"}}, {"oid": "741bceecdad534626b625112012d8c7ee370a7d3", "url": "https://github.com/apache/ozone/commit/741bceecdad534626b625112012d8c7ee370a7d3", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3170-master", "committedDate": "2020-03-15T00:07:04Z", "type": "commit"}, {"oid": "377e736a0b42fec73a44a41123e7d103868067a3", "url": "https://github.com/apache/ozone/commit/377e736a0b42fec73a44a41123e7d103868067a3", "message": "HDDS-3170. Address review comments.", "committedDate": "2020-03-15T00:11:47Z", "type": "commit"}]}