{"pr_number": 1253, "pr_title": "HDDS-4024. Avoid while loop too soon when exception happen", "pr_createdAt": "2020-07-24T06:46:49Z", "pr_url": "https://github.com/apache/ozone/pull/1253", "timeline": [{"oid": "4db50e38b899418e43d3444095ff10af636c0331", "url": "https://github.com/apache/ozone/commit/4db50e38b899418e43d3444095ff10af636c0331", "message": "HDDS-4024. Avoid while loop too soon when exception happen", "committedDate": "2020-07-24T06:17:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkwMDA3Mg==", "url": "https://github.com/apache/ozone/pull/1253#discussion_r459900072", "bodyText": "Now that sleep is moved outside this try, I think interrupted state needs to be restored here.  Otherwise if execute is interrupted, this catch clears interrupted state and the thread will sleep below.", "author": "adoroszlai", "createdAt": "2020-07-24T07:45:48Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java", "diffHunk": "@@ -224,19 +224,25 @@ private void start() throws IOException {\n         nextHB.set(Time.monotonicNow() + heartbeatFrequency);\n         context.execute(executorService, heartbeatFrequency,\n             TimeUnit.MILLISECONDS);\n-        now = Time.monotonicNow();\n-        if (now < nextHB.get()) {\n-          if(!Thread.interrupted()) {\n-            Thread.sleep(nextHB.get() - now);\n-          }\n-        }\n       } catch (InterruptedException e) {\n         // Some one has sent interrupt signal, this could be because\n         // 1. Trigger heartbeat immediately\n         // 2. Shutdown has be initiated.\n+        LOG.warn(\"Interrupt the execution.\", e);", "originalCommit": "4db50e38b899418e43d3444095ff10af636c0331", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkyMzA0MQ==", "url": "https://github.com/apache/ozone/pull/1253#discussion_r459923041", "bodyText": "@adoroszlai Thanks for review. I have updated the patch.", "author": "runzhiwang", "createdAt": "2020-07-24T08:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkwMDA3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c89bc9d8f8eb9447be55d8fbbe32fb86fd445487", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java\nindex e8e8d4f95..a191bcbdf 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java\n\n@@ -229,6 +229,7 @@ private void start() throws IOException {\n         // 1. Trigger heartbeat immediately\n         // 2. Shutdown has be initiated.\n         LOG.warn(\"Interrupt the execution.\", e);\n+        Thread.currentThread().interrupt();\n       } catch (Exception e) {\n         LOG.error(\"Unable to finish the execution.\", e);\n       }\n"}}, {"oid": "c89bc9d8f8eb9447be55d8fbbe32fb86fd445487", "url": "https://github.com/apache/ozone/commit/c89bc9d8f8eb9447be55d8fbbe32fb86fd445487", "message": "fix code review", "committedDate": "2020-07-24T08:35:04Z", "type": "commit"}, {"oid": "b2b9e81d08bd72a232ba34826962b0ab3a10b10f", "url": "https://github.com/apache/ozone/commit/b2b9e81d08bd72a232ba34826962b0ab3a10b10f", "message": "triger ci", "committedDate": "2020-07-24T10:32:24Z", "type": "commit"}]}