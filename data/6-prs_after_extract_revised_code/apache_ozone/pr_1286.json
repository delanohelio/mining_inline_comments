{"pr_number": 1286, "pr_title": "HDDS-4040. [OFS] BasicRootedOzoneFileSystem to support batchDelete", "pr_createdAt": "2020-08-03T10:44:25Z", "pr_url": "https://github.com/apache/ozone/pull/1286", "timeline": [{"oid": "171717fce8e81e55d6257d145db5d389bbf0c08d", "url": "https://github.com/apache/ozone/commit/171717fce8e81e55d6257d145db5d389bbf0c08d", "message": "HDDS-4040. OFS should use deleteObjects when deleting directory\n\nChange-Id: I263cfbad1f552b3c505f5745975173f120e036e3", "committedDate": "2020-08-03T10:43:06Z", "type": "commit"}, {"oid": "fdbc71cdabcfa846d538878f80bb602a37a63528", "url": "https://github.com/apache/ozone/commit/fdbc71cdabcfa846d538878f80bb602a37a63528", "message": "Added test.\n\nChange-Id: I5213fc1267f8cdd3c40817f5913c565caa202c8e", "committedDate": "2020-08-03T11:14:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc3NTYxOQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r464775619", "bodyText": "Make this test parameterized to test with  \"ozone.om.enable.filesystem.paths\" enabled and disabled similar to TestOzoneFileSystem", "author": "bharatviswa504", "createdAt": "2020-08-04T03:22:02Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -1038,4 +1043,41 @@ public void testRenameToTrashDisabled() throws IOException {\n     ofs.delete(trashRoot, true);\n   }\n \n+  @Test\n+  public void testFileDelete() throws Exception {\n+    Path grandparent = new Path(bucketPath, \"testBatchDelete\");\n+    Path parent = new Path(grandparent, \"parent\");", "originalCommit": "fdbc71cdabcfa846d538878f80bb602a37a63528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0NjkxMg==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r464846912", "bodyText": "done", "author": "smengcl", "createdAt": "2020-08-04T07:14:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc3NTYxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1eb6cde2293d0c66e8a504d782561d70e4900298", "url": "https://github.com/apache/ozone/commit/1eb6cde2293d0c66e8a504d782561d70e4900298", "message": "Parameterize TestRootedOzoneFileSystem for OZONE_OM_ENABLE_FILESYSTEM_PATHS.\n\nChange-Id: I3752de9a7f2167c9b7687971c8426db9368796b2", "committedDate": "2020-08-04T07:14:12Z", "type": "commit"}, {"oid": "fc8ae43c173cad67e97995d5c0bc28fa753b3985", "url": "https://github.com/apache/ozone/commit/fc8ae43c173cad67e97995d5c0bc28fa753b3985", "message": "Try increasing surefire.fork.timeout (forkedProcessTimeoutInSeconds) to 1000s.\nNot sure if this would have side effects. Have a try.", "committedDate": "2020-08-06T06:20:58Z", "type": "commit"}, {"oid": "5865c2faa0fb51adbd48b9f2694b432c16aaaa79", "url": "https://github.com/apache/ozone/commit/5865c2faa0fb51adbd48b9f2694b432c16aaaa79", "message": "Try increasing test class global timeout.\n\nChange-Id: Ic8ed3460d7cee5cc3c732175643123bfc84ae7a9", "committedDate": "2020-08-06T08:36:34Z", "type": "commit"}, {"oid": "244a4be86553ad2deb293c8532f8dbdb5aa2c67f", "url": "https://github.com/apache/ozone/commit/244a4be86553ad2deb293c8532f8dbdb5aa2c67f", "message": "Revert \"Try increasing test class global timeout.\"\n\nThis reverts commit 5865c2faa0fb51adbd48b9f2694b432c16aaaa79.\n\nChange-Id: I96c1777aa753be44bd57564e9af1a660589152d1", "committedDate": "2020-08-06T18:00:25Z", "type": "commit"}, {"oid": "5a130357be16e518f9f56b5b2ead99f2a68e844a", "url": "https://github.com/apache/ozone/commit/5a130357be16e518f9f56b5b2ead99f2a68e844a", "message": "Further increase surefire.fork.timeout to 1200s.\n\nChange-Id: I4eb115689bb9b99d44438b2b79e17a2cc93b4488", "committedDate": "2020-08-06T18:00:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODY5OA==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r466608698", "bodyText": "Is there a reason for return false, because BasicOzoneFileSystem does not return false when key list is empty.\nhttps://github.com/apache/hadoop-ozone/blob/master/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java#L287", "author": "bharatviswa504", "createdAt": "2020-08-06T18:33:42Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -457,38 +458,79 @@ public boolean deleteObject(String path) {\n     }\n   }\n \n+  /**\n+   * Helper function to check if the list of key paths are in the same volume\n+   * and same bucket.\n+   */\n+  private boolean areInSameBucket(List<String> keyNameList) {\n+    if (keyNameList.size() == 0) {\n+      return true;\n+    }\n+    String firstKeyPath = keyNameList.get(0);\n+    final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n+    // If any key path's volume and bucket from the second element and on\n+    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n+    // would be true\n+    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n+        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n+    return !hasDifferentVolAndBucket;\n+  }\n+\n   /**\n    * Helper method to delete an object specified by key name in bucket.\n    *\n-   * @param pathList key name list to be deleted\n+   * Only supports deleting keys in the same bucket in one call.\n+   *\n+   * Each item in the given list should be the String of an OFS path:\n+   * e.g. ofs://om/vol1/buck1/k1\n+   *\n+   * @param keyNameList key name list to be deleted\n    * @return true if the key is deleted, false otherwise\n    */\n   @Override\n-  public boolean deleteObjects(List<String> pathList) {\n-    // TODO: we will support deleteObjects in ofs.\n-    LOG.error(\"ofs currently does not support deleteObjects\");\n-    return false;\n+  public boolean deleteObjects(List<String> keyNameList) {\n+    LOG.trace(\"issuing delete for keys: {}\", keyNameList);\n+    if (keyNameList.size() == 0) {", "originalCommit": "5a130357be16e518f9f56b5b2ead99f2a68e844a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5OTM4Mw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467199383", "bodyText": "Good catch. Yes should return true here. Also changed the javadoc a bit.", "author": "smengcl", "createdAt": "2020-08-07T18:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwODY5OA=="}], "type": "inlineReview", "revised_code": {"commit": "13a01ffd839fef9e68618a67a5c1d4cded2afd08", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 827bfe0b5..105aff5b9 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -485,13 +485,13 @@ private boolean areInSameBucket(List<String> keyNameList) {\n    * e.g. ofs://om/vol1/buck1/k1\n    *\n    * @param keyNameList key name list to be deleted\n-   * @return true if the key is deleted, false otherwise\n+   * @return true if the key deletion is successful, false otherwise\n    */\n   @Override\n   public boolean deleteObjects(List<String> keyNameList) {\n     LOG.trace(\"issuing delete for keys: {}\", keyNameList);\n     if (keyNameList.size() == 0) {\n-      return false;\n+      return true;\n     }\n     // Sanity check. Support only deleting a list of keys in the same bucket\n     if (!areInSameBucket(keyNameList)) {\n"}}, {"oid": "4b0a7d9db47365585c2921e7b667b59648fc552a", "url": "https://github.com/apache/ozone/commit/4b0a7d9db47365585c2921e7b667b59648fc552a", "message": "Init test cluster once. Add cleanups to all tests.\n\nChange-Id: I0c6215ad65973de3ee6099618be830e2e65549c3", "committedDate": "2020-08-06T20:32:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NDM2Nw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467154367", "bodyText": "should incrementCount for deletes by the number of keys in the list instead of 1?\nAlso, should we move the counter update if deleteKeys succeed", "author": "xiaoyuyao", "createdAt": "2020-08-07T16:48:45Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -457,38 +458,79 @@ public boolean deleteObject(String path) {\n     }\n   }\n \n+  /**\n+   * Helper function to check if the list of key paths are in the same volume\n+   * and same bucket.\n+   */\n+  private boolean areInSameBucket(List<String> keyNameList) {\n+    if (keyNameList.size() == 0) {\n+      return true;\n+    }\n+    String firstKeyPath = keyNameList.get(0);\n+    final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n+    // If any key path's volume and bucket from the second element and on\n+    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n+    // would be true\n+    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n+        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n+    return !hasDifferentVolAndBucket;\n+  }\n+\n   /**\n    * Helper method to delete an object specified by key name in bucket.\n    *\n-   * @param pathList key name list to be deleted\n+   * Only supports deleting keys in the same bucket in one call.\n+   *\n+   * Each item in the given list should be the String of an OFS path:\n+   * e.g. ofs://om/vol1/buck1/k1\n+   *\n+   * @param keyNameList key name list to be deleted\n    * @return true if the key is deleted, false otherwise\n    */\n   @Override\n-  public boolean deleteObjects(List<String> pathList) {\n-    // TODO: we will support deleteObjects in ofs.\n-    LOG.error(\"ofs currently does not support deleteObjects\");\n-    return false;\n+  public boolean deleteObjects(List<String> keyNameList) {\n+    LOG.trace(\"issuing delete for keys: {}\", keyNameList);\n+    if (keyNameList.size() == 0) {\n+      return false;\n+    }\n+    // Sanity check. Support only deleting a list of keys in the same bucket\n+    if (!areInSameBucket(keyNameList)) {\n+      LOG.error(\"Deleting keys from different buckets in a single batch \"\n+          + \"is not supported.\");\n+      return false;\n+    }\n+    try {\n+      OFSPath firstKeyPath = new OFSPath(keyNameList.get(0));\n+      OzoneBucket bucket = getBucket(firstKeyPath, false);\n+      return deleteObjects(bucket, keyNameList);\n+    } catch (IOException ioe) {\n+      LOG.error(\"delete key failed: {}\", ioe.getMessage());\n+      return false;\n+    }\n   }\n \n   /**\n    * Package-private helper function to reduce calls to getBucket().\n+   *\n+   * This will be faster than the public variant of the method since this\n+   * doesn't verify the same-bucket condition.\n+   *\n    * @param bucket Bucket to operate in.\n-   * @param path Path to delete.\n-   * @return true if operation succeeded, false upon IOException.\n+   * @param keyNameList key name list to be deleted.\n+   * @return true if operation succeeded, false on IOException.\n    */\n-  boolean deleteObject(OzoneBucket bucket, String path) {\n-    LOG.trace(\"issuing delete for path to key: {}\", path);\n-    incrementCounter(Statistic.OBJECTS_DELETED);\n-    OFSPath ofsPath = new OFSPath(path);\n-    String keyName = ofsPath.getKeyName();\n-    if (keyName.length() == 0) {\n-      return false;\n-    }\n+  boolean deleteObjects(OzoneBucket bucket, List<String> keyNameList) {\n+    LOG.trace(\"issuing delete in volume: {}, bucket: {} for keys: {}\",\n+        bucket.getVolumeName(), bucket.getName(), keyNameList);\n+    List<String> keyList = keyNameList.stream()\n+        .map(p -> new OFSPath(p).getKeyName())\n+        .collect(Collectors.toList());\n     try {\n-      bucket.deleteKey(keyName);\n+      incrementCounter(Statistic.OBJECTS_DELETED);", "originalCommit": "4b0a7d9db47365585c2921e7b667b59648fc552a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NDY4Nw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467194687", "bodyText": "Yes you are right. I do notice this when making the patch. I was just trying to make it consistent with the o3fs code.\nShould I make the change in both o3fs and ofs here in this PR? One point is I may need to add a new method to increment the stat by X rather than only 1 (for a more elegant solution).", "author": "smengcl", "createdAt": "2020-08-07T18:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NDM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIxMTg5Nw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467211897", "bodyText": "I have made the attempt in e65e0d5 + 8a01be1. Pls take a look :)", "author": "smengcl", "createdAt": "2020-08-07T18:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NDM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "13a01ffd839fef9e68618a67a5c1d4cded2afd08", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 827bfe0b5..105aff5b9 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -485,13 +485,13 @@ private boolean areInSameBucket(List<String> keyNameList) {\n    * e.g. ofs://om/vol1/buck1/k1\n    *\n    * @param keyNameList key name list to be deleted\n-   * @return true if the key is deleted, false otherwise\n+   * @return true if the key deletion is successful, false otherwise\n    */\n   @Override\n   public boolean deleteObjects(List<String> keyNameList) {\n     LOG.trace(\"issuing delete for keys: {}\", keyNameList);\n     if (keyNameList.size() == 0) {\n-      return false;\n+      return true;\n     }\n     // Sanity check. Support only deleting a list of keys in the same bucket\n     if (!areInSameBucket(keyNameList)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NjAzNw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467156037", "bodyText": "Do we have a follow up JIRA to fix rename once the batch rename is ready?", "author": "xiaoyuyao", "createdAt": "2020-08-07T16:52:11Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -255,9 +258,11 @@ public FSDataOutputStream append(Path f, int bufferSize,\n     }\n \n     @Override\n-    boolean processKeyPath(String keyPath) throws IOException {\n-      String newPath = dstPath.concat(keyPath.substring(srcPath.length()));\n-      adapterImpl.rename(this.bucket, keyPath, newPath);\n+    boolean processKeyPath(List<String> keyPathList) throws IOException {\n+      for (String keyPath : keyPathList) {\n+        String newPath = dstPath.concat(keyPath.substring(srcPath.length()));\n+        adapterImpl.rename(this.bucket, keyPath, newPath);", "originalCommit": "4b0a7d9db47365585c2921e7b667b59648fc552a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NzI2Ng==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467197266", "bodyText": "Filed HDDS-4090", "author": "smengcl", "createdAt": "2020-08-07T18:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NjAzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NzU2Mg==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467157562", "bodyText": "LOG.trace a keyNameList address does not provide much useful info. I would suggest either remove or expand the list.", "author": "xiaoyuyao", "createdAt": "2020-08-07T16:55:19Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -457,38 +458,79 @@ public boolean deleteObject(String path) {\n     }\n   }\n \n+  /**\n+   * Helper function to check if the list of key paths are in the same volume\n+   * and same bucket.\n+   */\n+  private boolean areInSameBucket(List<String> keyNameList) {\n+    if (keyNameList.size() == 0) {\n+      return true;\n+    }\n+    String firstKeyPath = keyNameList.get(0);\n+    final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n+    // If any key path's volume and bucket from the second element and on\n+    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n+    // would be true\n+    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n+        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n+    return !hasDifferentVolAndBucket;\n+  }\n+\n   /**\n    * Helper method to delete an object specified by key name in bucket.\n    *\n-   * @param pathList key name list to be deleted\n+   * Only supports deleting keys in the same bucket in one call.\n+   *\n+   * Each item in the given list should be the String of an OFS path:\n+   * e.g. ofs://om/vol1/buck1/k1\n+   *\n+   * @param keyNameList key name list to be deleted\n    * @return true if the key is deleted, false otherwise\n    */\n   @Override\n-  public boolean deleteObjects(List<String> pathList) {\n-    // TODO: we will support deleteObjects in ofs.\n-    LOG.error(\"ofs currently does not support deleteObjects\");\n-    return false;\n+  public boolean deleteObjects(List<String> keyNameList) {\n+    LOG.trace(\"issuing delete for keys: {}\", keyNameList);", "originalCommit": "4b0a7d9db47365585c2921e7b667b59648fc552a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwMjg3MQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467202871", "bodyText": "I removed this trace log from both o3fs and ofs. IMO expanding it needs have to have an extra if (LOG.isTraceEnabled()) condition to prevent unnecessary evaluation which I think is not worth it.", "author": "smengcl", "createdAt": "2020-08-07T18:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1NzU2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "13a01ffd839fef9e68618a67a5c1d4cded2afd08", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 827bfe0b5..105aff5b9 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -485,13 +485,13 @@ private boolean areInSameBucket(List<String> keyNameList) {\n    * e.g. ofs://om/vol1/buck1/k1\n    *\n    * @param keyNameList key name list to be deleted\n-   * @return true if the key is deleted, false otherwise\n+   * @return true if the key deletion is successful, false otherwise\n    */\n   @Override\n   public boolean deleteObjects(List<String> keyNameList) {\n     LOG.trace(\"issuing delete for keys: {}\", keyNameList);\n     if (keyNameList.size() == 0) {\n-      return false;\n+      return true;\n     }\n     // Sanity check. Support only deleting a list of keys in the same bucket\n     if (!areInSameBucket(keyNameList)) {\n"}}, {"oid": "13a01ffd839fef9e68618a67a5c1d4cded2afd08", "url": "https://github.com/apache/ozone/commit/13a01ffd839fef9e68618a67a5c1d4cded2afd08", "message": "BROCAI#deleteObjects shall return true when the list is empty, indicating the operation is successful.\n\nChange-Id: I6d9ddc92299776e9f2aa07ab57c37b0f5a6af7a1", "committedDate": "2020-08-07T18:21:36Z", "type": "commit"}, {"oid": "167240be4f8b35dc8fae2bdc09cf8351f0376b51", "url": "https://github.com/apache/ozone/commit/167240be4f8b35dc8fae2bdc09cf8351f0376b51", "message": "Remove LOG.trace keyNameList in BROCAI#deleteObjects.\n\nChange-Id: I3e92d159c664eeea4c54db06a4bb8a8ce7959306", "committedDate": "2020-08-07T18:25:26Z", "type": "commit"}, {"oid": "8d74023607d312cc079f6ccb7172cef8ee6fe929", "url": "https://github.com/apache/ozone/commit/8d74023607d312cc079f6ccb7172cef8ee6fe929", "message": "Also remove LOG.trace keyNameList in BOCAI#deleteObjects.\n\nChange-Id: I9e28debbd9be021b2e4dac46ab9d811ad41376b8", "committedDate": "2020-08-07T18:25:55Z", "type": "commit"}, {"oid": "e65e0d517042ce2056758262b04adc68f989ea8b", "url": "https://github.com/apache/ozone/commit/e65e0d517042ce2056758262b04adc68f989ea8b", "message": "incrementCounter(Stat, Count) is now exposed to FS/Impl.\n\nChange-Id: I94531e4e57f11bd2cf3e8f9c956725f708c14ec4", "committedDate": "2020-08-07T18:48:34Z", "type": "commit"}, {"oid": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "url": "https://github.com/apache/ozone/commit/8a01be17ef294eabba10844ad4c18cb05cd2e240", "message": "Compat fix for previous commit.\n\nChange-Id: I7174e0841c280ea8d9f41e1cdc6b67f76b0e0ad1", "committedDate": "2020-08-07T18:51:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODExNA==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467368114", "bodyText": "Why is this being deprecated?  It could delegate to the new method.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Deprecated\n          \n          \n            \n              protected void incrementCounter(Statistic objectsRead) {\n          \n          \n            \n                //noop: Use OzoneClientAdapterImpl which supports statistics.\n          \n          \n            \n              protected void incrementCounter(Statistic objectsRead) {\n          \n          \n            \n                incrementCounter(objectsRead, 1);", "author": "adoroszlai", "createdAt": "2020-08-08T06:09:27Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java", "diffHunk": "@@ -190,14 +190,19 @@ public InputStream readFile(String key) throws IOException {\n     }\n   }\n \n+  @Deprecated\n   protected void incrementCounter(Statistic objectsRead) {\n     //noop: Use OzoneClientAdapterImpl which supports statistics.", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3MzkxNQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468173915", "bodyText": "My intention is to encourage new code to explicitly specify count since incrementing by 1 is now \"old\" with the introduction of batch delete / batch rename.\nAnd all the existing calls have been migrated to the new one incrementCounter(Statistic objectsRead, long count).\nActually I can just remove the old method since it is protected?", "author": "smengcl", "createdAt": "2020-08-10T20:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NzU0OQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468877549", "bodyText": "Done. Removed deprecated annotation.", "author": "smengcl", "createdAt": "2020-08-11T21:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODExNA=="}], "type": "inlineReview", "revised_code": {"commit": "5145690b3ab5404754554229dea0823dea32d202", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java\nindex e2b604873..492a78069 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java\n\n@@ -190,11 +190,6 @@ public InputStream readFile(String key) throws IOException {\n     }\n   }\n \n-  @Deprecated\n-  protected void incrementCounter(Statistic objectsRead) {\n-    //noop: Use OzoneClientAdapterImpl which supports statistics.\n-  }\n-\n   protected void incrementCounter(Statistic objectsRead, long count) {\n     //noop: Use OzoneClientAdapterImpl which supports statistics.\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODE3MA==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467368170", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Deprecated\n          \n          \n            \n              protected void incrementCounter(Statistic statistic) {\n          \n          \n            \n                //don't do anyting in this default implementation.\n          \n          \n            \n              protected void incrementCounter(Statistic statistic) {\n          \n          \n            \n                incrementCounter(statistic, 1);", "author": "adoroszlai", "createdAt": "2020-08-08T06:10:04Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -220,17 +220,22 @@ protected InputStream createFSInputStream(InputStream inputStream) {\n     return new OzoneFSInputStream(inputStream, statistics);\n   }\n \n+  @Deprecated\n   protected void incrementCounter(Statistic statistic) {\n     //don't do anyting in this default implementation.", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE3NjY4Ng==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468176686", "bodyText": "This method body is intentionally left empty in HDDS-1333 for compatibility fix I believe. Is this no longer the case? should be fine since the change is only calling another empty method. but I don't see the point of doing this as we are overriding this in OzoneFileSystem?", "author": "smengcl", "createdAt": "2020-08-10T20:47:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODE3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NTQ0MA==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468875440", "bodyText": "Updated in 5145690.", "author": "smengcl", "createdAt": "2020-08-11T21:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODE3MA=="}], "type": "inlineReview", "revised_code": {"commit": "5145690b3ab5404754554229dea0823dea32d202", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\nindex 62c81322a..49f12f0ff 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n\n@@ -220,13 +220,12 @@ protected InputStream createFSInputStream(InputStream inputStream) {\n     return new OzoneFSInputStream(inputStream, statistics);\n   }\n \n-  @Deprecated\n   protected void incrementCounter(Statistic statistic) {\n-    //don't do anyting in this default implementation.\n+    incrementCounter(statistic, 1);\n   }\n \n   protected void incrementCounter(Statistic statistic, long count) {\n-    //don't do anyting in this default implementation.\n+    //don't do anything in this default implementation.\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODIxMw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467368213", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Deprecated\n          \n          \n            \n              protected void incrementCounter(Statistic objectsRead) {\n          \n          \n            \n                //noop: Use OzoneClientAdapterImpl which supports statistics.\n          \n          \n            \n              protected void incrementCounter(Statistic objectsRead) {\n          \n          \n            \n                incrementCounter(objectsRead, 1);", "author": "adoroszlai", "createdAt": "2020-08-08T06:10:34Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -301,14 +302,19 @@ public InputStream readFile(String pathStr) throws IOException {\n     }\n   }\n \n+  @Deprecated\n   protected void incrementCounter(Statistic objectsRead) {\n     //noop: Use OzoneClientAdapterImpl which supports statistics.", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg3NjkwNw==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468876907", "bodyText": "I have removed the old method from all Impls. Only kept it in BasicOzoneFileSystem/BasicRootedOzoneFileSystem.", "author": "smengcl", "createdAt": "2020-08-11T21:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "5145690b3ab5404754554229dea0823dea32d202", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 26047a7bc..3cc31bde1 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -302,13 +302,8 @@ public InputStream readFile(String pathStr) throws IOException {\n     }\n   }\n \n-  @Deprecated\n-  protected void incrementCounter(Statistic objectsRead) {\n-    //noop: Use OzoneClientAdapterImpl which supports statistics.\n-  }\n-\n   protected void incrementCounter(Statistic objectsRead, long count) {\n-    //noop: Use OzoneClientAdapterImpl which supports statistics.\n+    //noop: Use RootedOzoneClientAdapterImpl which supports statistics.\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM2ODI2MQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467368261", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              @Deprecated\n          \n          \n            \n              protected void incrementCounter(Statistic statistic) {\n          \n          \n            \n                //don't do anything in this default implementation.\n          \n          \n            \n              protected void incrementCounter(Statistic statistic) {\n          \n          \n            \n                incrementCounter(statistic, 1);", "author": "adoroszlai", "createdAt": "2020-08-08T06:11:10Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -183,25 +186,30 @@ public String getScheme() {\n \n   @Override\n   public FSDataInputStream open(Path path, int bufferSize) throws IOException {\n-    incrementCounter(Statistic.INVOCATION_OPEN);\n+    incrementCounter(Statistic.INVOCATION_OPEN, 1);\n     statistics.incrementReadOps(1);\n     LOG.trace(\"open() path: {}\", path);\n     final String key = pathToKey(path);\n     return new FSDataInputStream(\n         new OzoneFSInputStream(adapter.readFile(key), statistics));\n   }\n \n+  @Deprecated\n   protected void incrementCounter(Statistic statistic) {\n     //don't do anything in this default implementation.", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5145690b3ab5404754554229dea0823dea32d202", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\nindex 1ee7c7c87..9d7dd9f62 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java\n\n@@ -194,9 +194,8 @@ public FSDataInputStream open(Path path, int bufferSize) throws IOException {\n         new OzoneFSInputStream(adapter.readFile(key), statistics));\n   }\n \n-  @Deprecated\n   protected void incrementCounter(Statistic statistic) {\n-    //don't do anything in this default implementation.\n+    incrementCounter(statistic, 1);\n   }\n \n   protected void incrementCounter(Statistic statistic, long count) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3NjAwMQ==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467376001", "bodyText": "Nit: we could save two negations by using allMatch().", "author": "adoroszlai", "createdAt": "2020-08-08T07:50:55Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -457,45 +463,83 @@ public boolean deleteObject(String path) {\n     }\n   }\n \n+  /**\n+   * Helper function to check if the list of key paths are in the same volume\n+   * and same bucket.\n+   */\n+  private boolean areInSameBucket(List<String> keyNameList) {\n+    if (keyNameList.size() == 0) {\n+      return true;\n+    }\n+    String firstKeyPath = keyNameList.get(0);\n+    final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n+    // If any key path's volume and bucket from the second element and on\n+    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n+    // would be true\n+    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n+        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n+    return !hasDifferentVolAndBucket;", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MTc5Ng==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r468181796", "bodyText": "Good catch!", "author": "smengcl", "createdAt": "2020-08-10T20:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3NjAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "73d8223563dd31e41c1aea40cb05d12a0cff945e", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 26047a7bc..829d896a7 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -468,17 +468,15 @@ public boolean deleteObject(String path) {\n    * and same bucket.\n    */\n   private boolean areInSameBucket(List<String> keyNameList) {\n-    if (keyNameList.size() == 0) {\n+    if (keyNameList.isEmpty()) {\n       return true;\n     }\n     String firstKeyPath = keyNameList.get(0);\n     final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n-    // If any key path's volume and bucket from the second element and on\n-    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n-    // would be true\n-    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n-        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n-    return !hasDifferentVolAndBucket;\n+    // return true only if all key paths' volume and bucket in the list match\n+    // the first element's\n+    return keyNameList.stream().skip(1).allMatch(p ->\n+        new OFSPath(p).getNonKeyPath().equals(volAndBucket));\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM3NjA1Ng==", "url": "https://github.com/apache/ozone/pull/1286#discussion_r467376056", "bodyText": "Nit: Sonar prefers isEmpty() over size() == 0.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (keyNameList.size() == 0) {\n          \n          \n            \n                if (keyNameList.isEmpty()) {", "author": "adoroszlai", "createdAt": "2020-08-08T07:51:43Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -457,45 +463,83 @@ public boolean deleteObject(String path) {\n     }\n   }\n \n+  /**\n+   * Helper function to check if the list of key paths are in the same volume\n+   * and same bucket.\n+   */\n+  private boolean areInSameBucket(List<String> keyNameList) {\n+    if (keyNameList.size() == 0) {", "originalCommit": "8a01be17ef294eabba10844ad4c18cb05cd2e240", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "73d8223563dd31e41c1aea40cb05d12a0cff945e", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\nindex 26047a7bc..829d896a7 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java\n\n@@ -468,17 +468,15 @@ public boolean deleteObject(String path) {\n    * and same bucket.\n    */\n   private boolean areInSameBucket(List<String> keyNameList) {\n-    if (keyNameList.size() == 0) {\n+    if (keyNameList.isEmpty()) {\n       return true;\n     }\n     String firstKeyPath = keyNameList.get(0);\n     final String volAndBucket = new OFSPath(firstKeyPath).getNonKeyPath();\n-    // If any key path's volume and bucket from the second element and on\n-    // in the list doesn't match the first element's, hasDifferentVolAndBucket\n-    // would be true\n-    boolean hasDifferentVolAndBucket = keyNameList.stream().skip(1)\n-        .anyMatch(p -> !(new OFSPath(p).getNonKeyPath().equals(volAndBucket)));\n-    return !hasDifferentVolAndBucket;\n+    // return true only if all key paths' volume and bucket in the list match\n+    // the first element's\n+    return keyNameList.stream().skip(1).allMatch(p ->\n+        new OFSPath(p).getNonKeyPath().equals(volAndBucket));\n   }\n \n   /**\n"}}, {"oid": "73d8223563dd31e41c1aea40cb05d12a0cff945e", "url": "https://github.com/apache/ozone/commit/73d8223563dd31e41c1aea40cb05d12a0cff945e", "message": "Clean up `areInSameBucket`.\n\nChange-Id: I3cd47aed4e4c281bbbfddb3a865826d59fdd1449", "committedDate": "2020-08-10T21:00:27Z", "type": "commit"}, {"oid": "5145690b3ab5404754554229dea0823dea32d202", "url": "https://github.com/apache/ozone/commit/5145690b3ab5404754554229dea0823dea32d202", "message": "1. Remove Deprecated annotation from old incrementCounter;\n2. Overload incrementCounter only in BasicOzoneFileSystem / BasicRootedOzoneFileSystem, where the old method calls the new one, minimizing the code change.\n\nChange-Id: I0606951cac16b16118ff775fbda05c36f5f4155b", "committedDate": "2020-08-11T21:27:56Z", "type": "commit"}]}