{"pr_number": 513, "pr_title": "HDDS-2962. Handle replay of OM Prefix ACL requests", "pr_createdAt": "2020-01-31T18:49:56Z", "pr_url": "https://github.com/apache/ozone/pull/513", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2NTIxOQ==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374265219", "bodyText": "Dumb q. - why pass 0 here?", "author": "arp7", "createdAt": "2020-02-03T18:28:20Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java", "diffHunk": "@@ -176,9 +177,10 @@ public boolean setAcl(OzoneObj obj, List<OzoneAcl> acls) throws IOException {\n       OmPrefixInfo prefixInfo =\n           metadataManager.getPrefixTable().get(prefixPath);\n \n-      OMPrefixAclOpResult omPrefixAclOpResult = setAcl(obj, acls, prefixInfo);\n+      OMPrefixAclOpResult omPrefixAclOpResult = setAcl(obj, acls, prefixInfo,\n+          0L);", "originalCommit": "2f848b61662ce5ddd19750bbb1d116d368df6894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MDgxMw==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374270813", "bodyText": "This code path was used for the non-ratis case before the two code paths were merged. This should go away after code cleanup.\n@bharatviswa504 please correct me if I am wrong.", "author": "hanishakoneru", "createdAt": "2020-02-03T18:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2NTIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3Mzc4OQ==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374273789", "bodyText": "You're right.", "author": "arp7", "createdAt": "2020-02-03T18:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI2NTIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5e04dccc804f9e9469192f37a05137e863aa2225", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java\nindex 6461a7e86..ca5d46b50 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java\n\n@@ -177,8 +176,7 @@ public boolean setAcl(OzoneObj obj, List<OzoneAcl> acls) throws IOException {\n       OmPrefixInfo prefixInfo =\n           metadataManager.getPrefixTable().get(prefixPath);\n \n-      OMPrefixAclOpResult omPrefixAclOpResult = setAcl(obj, acls, prefixInfo,\n-          0L);\n+      OMPrefixAclOpResult omPrefixAclOpResult = setAcl(obj, acls, prefixInfo);\n \n       return omPrefixAclOpResult.isSuccess();\n     } catch (IOException ex) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MDU2NQ==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374270565", "bodyText": "Is one unit test case sufficient? Are we covering all the new code paths?", "author": "arp7", "createdAt": "2020-02-03T18:38:47Z", "path": "hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMPrefixAclRequest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.request.key;\n+\n+import java.util.UUID;\n+import org.apache.hadoop.ozone.OzoneAcl;\n+import org.apache.hadoop.ozone.om.PrefixManager;\n+import org.apache.hadoop.ozone.om.PrefixManagerImpl;\n+import org.apache.hadoop.ozone.om.request.TestOMRequestUtils;\n+import org.apache.hadoop.ozone.om.request.key.acl.prefix.OMPrefixAddAclRequest;\n+import org.apache.hadoop.ozone.om.response.OMClientResponse;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.AddAclRequest;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.OMRequest;\n+import org.apache.hadoop.ozone.security.acl.OzoneObj;\n+import org.apache.hadoop.ozone.security.acl.OzoneObjInfo;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests Prefix ACL requests.\n+ */\n+public class TestOMPrefixAclRequest extends TestOMKeyRequest {\n+\n+  @Test\n+  public void testReplayRequest() throws Exception {", "originalCommit": "2f848b61662ce5ddd19750bbb1d116d368df6894", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDg0NA==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374274844", "bodyText": "I think it should be. This test case does not cover the change in logging on completion. But all the PrefixAcl requests go through a common code path for replay check which is covered here.\nDo we want to add a test for proto changes?", "author": "hanishakoneru", "createdAt": "2020-02-03T18:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MDU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3Njk4OA==", "url": "https://github.com/apache/ozone/pull/513#discussion_r374276988", "bodyText": "Yes we must have tests for proto [de]serialization. However I am not sure we have been rigorous about adding them in the past.\nLet's file a separate newbie jira to add missing protobuf [de]serialization unit tests.", "author": "arp7", "createdAt": "2020-02-03T18:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MDU2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5e04dccc804f9e9469192f37a05137e863aa2225", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMPrefixAclRequest.java b/hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMKeyAclRequest.java\nsimilarity index 80%\nrename from hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMPrefixAclRequest.java\nrename to hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMKeyAclRequest.java\nindex c25ee7b5b..5228c5a95 100644\n--- a/hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMPrefixAclRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMKeyAclRequest.java\n\n@@ -19,10 +19,8 @@\n \n import java.util.UUID;\n import org.apache.hadoop.ozone.OzoneAcl;\n-import org.apache.hadoop.ozone.om.PrefixManager;\n-import org.apache.hadoop.ozone.om.PrefixManagerImpl;\n import org.apache.hadoop.ozone.om.request.TestOMRequestUtils;\n-import org.apache.hadoop.ozone.om.request.key.acl.prefix.OMPrefixAddAclRequest;\n+import org.apache.hadoop.ozone.om.request.key.acl.OMKeyAddAclRequest;\n import org.apache.hadoop.ozone.om.response.OMClientResponse;\n import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;\n import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.AddAclRequest;\n"}}, {"oid": "71412ce674a58da808f61a4ce062aba376c881cb", "url": "https://github.com/apache/ozone/commit/71412ce674a58da808f61a4ce062aba376c881cb", "message": "UpdateDB even if applyAcl is false", "committedDate": "2020-02-04T23:54:16Z", "type": "forcePushed"}, {"oid": "ab95cbb22eafa2f55effcbd2b138aaa87b3b076c", "url": "https://github.com/apache/ozone/commit/ab95cbb22eafa2f55effcbd2b138aaa87b3b076c", "message": "rebase", "committedDate": "2020-02-10T21:21:51Z", "type": "forcePushed"}, {"oid": "5e04dccc804f9e9469192f37a05137e863aa2225", "url": "https://github.com/apache/ozone/commit/5e04dccc804f9e9469192f37a05137e863aa2225", "message": "HDDS-2962. Handle replay of OM Prefix ACL requests", "committedDate": "2020-02-10T23:08:34Z", "type": "commit"}, {"oid": "06927839d4fe460128cff33adf0ac0f4030bb2a7", "url": "https://github.com/apache/ozone/commit/06927839d4fe460128cff33adf0ac0f4030bb2a7", "message": "HDDS-2962. Handle replay of OM Prefix ACL requests", "committedDate": "2020-02-10T23:08:34Z", "type": "commit"}, {"oid": "da2ede6c947fd4d4a8777d86b1e4d34d1c0d1be5", "url": "https://github.com/apache/ozone/commit/da2ede6c947fd4d4a8777d86b1e4d34d1c0d1be5", "message": "CI fix", "committedDate": "2020-02-10T23:08:34Z", "type": "commit"}, {"oid": "355ccf5ce1d00bc69abdfd5a68fbf7c0eed7e74b", "url": "https://github.com/apache/ozone/commit/355ccf5ce1d00bc69abdfd5a68fbf7c0eed7e74b", "message": "UpdateDB even if applyAcl is false", "committedDate": "2020-02-10T23:08:35Z", "type": "commit"}, {"oid": "1d337d4c0e9d4c61a18223860c4f0b0bf012a300", "url": "https://github.com/apache/ozone/commit/1d337d4c0e9d4c61a18223860c4f0b0bf012a300", "message": "rebase", "committedDate": "2020-02-10T23:08:35Z", "type": "commit"}, {"oid": "1d337d4c0e9d4c61a18223860c4f0b0bf012a300", "url": "https://github.com/apache/ozone/commit/1d337d4c0e9d4c61a18223860c4f0b0bf012a300", "message": "rebase", "committedDate": "2020-02-10T23:08:35Z", "type": "forcePushed"}]}