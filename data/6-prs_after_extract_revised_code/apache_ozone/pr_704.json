{"pr_number": 704, "pr_title": "HDDS-3248. shutdown defaultMetricsSystem before tests", "pr_createdAt": "2020-03-23T08:54:20Z", "pr_url": "https://github.com/apache/ozone/pull/704", "timeline": [{"oid": "ce593db15dc9d1d5fb8cacd3ce357a0fc309ce4e", "url": "https://github.com/apache/ozone/commit/ce593db15dc9d1d5fb8cacd3ce357a0fc309ce4e", "message": "HDDS-3248: shutdown defaultMetricsSystem before tests", "committedDate": "2020-03-23T08:52:51Z", "type": "commit"}, {"oid": "ecde6a4106986b8d06cc991510baaca8ad5bed55", "url": "https://github.com/apache/ozone/commit/ecde6a4106986b8d06cc991510baaca8ad5bed55", "message": "import DefaultMetricsSystem", "committedDate": "2020-03-23T09:02:50Z", "type": "commit"}, {"oid": "686d0dd25a427743c6385dae2449123af4c21eb4", "url": "https://github.com/apache/ozone/commit/686d0dd25a427743c6385dae2449123af4c21eb4", "message": "clean up DefaultMetricSystem after TestHddsDispatcher and TestHandler", "committedDate": "2020-03-24T10:29:08Z", "type": "commit"}, {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e", "url": "https://github.com/apache/ozone/commit/c58011521bcbf63f25519cbd40b665d4f532e95e", "message": "correct checkstyle", "committedDate": "2020-03-24T11:10:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTI3NQ==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231275", "bodyText": "Should we call shutdownDispatcher() here as well instead of just ContainerMetrics.remove()?", "author": "fapifta", "createdAt": "2020-03-24T15:14:04Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java", "diffHunk": "@@ -132,6 +132,7 @@ public void testContainerCloseActionWhenFull() throws IOException {\n \n     } finally {\n       volumeSet.shutdown();\n+      ContainerMetrics.remove();", "originalCommit": "c58011521bcbf63f25519cbd40b665d4f532e95e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1MTcyMA==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397251720", "bodyText": "I removed that method and unify all the calls to ContainerMetrics.remove()", "author": "esahekmat", "createdAt": "2020-03-24T15:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTI3NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTMyMA==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231320", "bodyText": "I am not convinced whether this step to remove the ContainerMetrics belongs to a method called shutdownDispatcher, at least from the name it is not clear it will do so besides shutting down the dispatcher. Shouldn't we separate this two?", "author": "fapifta", "createdAt": "2020-03-24T15:14:07Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java", "diffHunk": "@@ -276,6 +283,13 @@ private HddsDispatcher createDispatcher(DatanodeDetails dd, UUID scmId,\n     return hddsDispatcher;\n   }\n \n+  private void shutdownDispatcher(HddsDispatcher dispatcher){\n+    if(dispatcher != null) {\n+      dispatcher.shutdown();\n+    }\n+    ContainerMetrics.remove();", "originalCommit": "c58011521bcbf63f25519cbd40b665d4f532e95e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NTc3NQ==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397245775", "bodyText": "actually dispatcher.shutdown() method do nothing, and I put it here to follow the principle of shutdown used objects.\nI will edit this part to just call ContainerMetrics.remove()", "author": "esahekmat", "createdAt": "2020-03-24T15:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "c54ce9ca6e9a689377eca4dda8635b1a0886843f", "chunk": "diff --git a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java\nindex 6d0652bc1..14e91f36b 100644\n--- a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java\n+++ b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java\n\n@@ -283,13 +280,6 @@ private HddsDispatcher createDispatcher(DatanodeDetails dd, UUID scmId,\n     return hddsDispatcher;\n   }\n \n-  private void shutdownDispatcher(HddsDispatcher dispatcher){\n-    if(dispatcher != null) {\n-      dispatcher.shutdown();\n-    }\n-    ContainerMetrics.remove();\n-  }\n-\n   // This method has to be removed once we move scm/TestUtils.java\n   // from server-scm project to container-service or to common project.\n   private static DatanodeDetails randomDatanodeDetails() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM2MA==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231360", "bodyText": "Do we still need this one after the added cleanup in TestHddsDispatcher?", "author": "fapifta", "createdAt": "2020-03-24T15:14:10Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java", "diffHunk": "@@ -58,6 +60,7 @@\n \n   @Before\n   public void setup() throws Exception {\n+    DefaultMetricsSystem.instance().shutdown();", "originalCommit": "c58011521bcbf63f25519cbd40b665d4f532e95e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MDcwNQ==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397240705", "bodyText": "My mistake, I will remove this", "author": "esahekmat", "createdAt": "2020-03-24T15:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM2MA=="}], "type": "inlineReview", "revised_code": {"commit": "4c2c6844d40dbba2a4489708d0481934bde558df", "chunk": "diff --git a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java\nindex 5599b370e..324ab71ed 100644\n--- a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java\n+++ b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java\n\n@@ -60,7 +59,6 @@\n \n   @Before\n   public void setup() throws Exception {\n-    DefaultMetricsSystem.instance().shutdown();\n     this.conf = new Configuration();\n     this.containerSet = Mockito.mock(ContainerSet.class);\n     this.volumeSet = Mockito.mock(MutableVolumeSet.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM4Mw==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231383", "bodyText": "Do we still need this one after the added cleanup in TestHddsDispatcher?", "author": "fapifta", "createdAt": "2020-03-24T15:14:11Z", "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java", "diffHunk": "@@ -91,6 +92,7 @@\n \n   @Before\n   public void setup() throws IOException {\n+    DefaultMetricsSystem.instance().shutdown();", "originalCommit": "c58011521bcbf63f25519cbd40b665d4f532e95e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0MDkzNA==", "url": "https://github.com/apache/ozone/pull/704#discussion_r397240934", "bodyText": "My mistake, I will remove this", "author": "esahekmat", "createdAt": "2020-03-24T15:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4c2c6844d40dbba2a4489708d0481934bde558df", "chunk": "diff --git a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java\nindex 660b7c3ba..fe3f3aac5 100644\n--- a/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java\n+++ b/hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java\n\n@@ -92,7 +91,6 @@\n \n   @Before\n   public void setup() throws IOException {\n-    DefaultMetricsSystem.instance().shutdown();\n     conf = new OzoneConfiguration();\n     conf.set(ScmConfigKeys.HDDS_DATANODE_DIR_KEY, folder.getRoot()\n         .getAbsolutePath());\n"}}, {"oid": "4c2c6844d40dbba2a4489708d0481934bde558df", "url": "https://github.com/apache/ozone/commit/4c2c6844d40dbba2a4489708d0481934bde558df", "message": "remove shutting down the DefaultMetricsSystem before tests", "committedDate": "2020-03-24T15:29:18Z", "type": "commit"}, {"oid": "c54ce9ca6e9a689377eca4dda8635b1a0886843f", "url": "https://github.com/apache/ozone/commit/c54ce9ca6e9a689377eca4dda8635b1a0886843f", "message": "unify the call to ContainerMetrics.remove() in order to clean up", "committedDate": "2020-03-24T15:37:47Z", "type": "commit"}]}