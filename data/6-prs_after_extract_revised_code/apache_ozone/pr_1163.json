{"pr_number": 1163, "pr_title": "HDDS-3920. Too many redudant replications due to fail to get node's a\u2026", "pr_createdAt": "2020-07-04T12:37:08Z", "pr_url": "https://github.com/apache/ozone/pull/1163", "timeline": [{"oid": "ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "url": "https://github.com/apache/ozone/commit/ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "message": "HDDS-3920. Too many redudant replications due to fail to get node's ancestor in ReplicationManager.", "committedDate": "2020-07-04T14:08:44Z", "type": "commit"}, {"oid": "ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "url": "https://github.com/apache/ozone/commit/ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "message": "HDDS-3920. Too many redudant replications due to fail to get node's ancestor in ReplicationManager.", "committedDate": "2020-07-04T14:08:44Z", "type": "forcePushed"}, {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "url": "https://github.com/apache/ozone/commit/cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "message": "Fix failed UT", "committedDate": "2020-07-06T06:49:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyMTgwNg==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450521806", "bodyText": "Can we use nodeStateManager.getNode(datanodeDetails) to avoid the UUID->String->UUID conversion?", "author": "xiaoyuyao", "createdAt": "2020-07-06T23:00:27Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {\n+        clusterMap.add(datanodeDetails);\n+        nodeStateManager.addNode(datanodeDetails);\n+        // Check that datanode in nodeStateManager has topology parent set\n+        DatanodeDetails dn =", "originalCommit": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NjkwNw==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452056907", "bodyText": "Sure.", "author": "ChenSammi", "createdAt": "2020-07-09T08:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyMTgwNg=="}], "type": "inlineReview", "revised_code": {"commit": "6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\nindex 1cce95593f..005881c011 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\n\n@@ -241,43 +241,43 @@ public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n       PipelineReportsProto pipelineReportsProto) {\n \n-    InetAddress dnAddress = Server.getRemoteIp();\n-    if (dnAddress != null) {\n-      // Mostly called inside an RPC, update ip and peer hostname\n-      datanodeDetails.setHostName(dnAddress.getHostName());\n-      datanodeDetails.setIpAddress(dnAddress.getHostAddress());\n-    }\n-    try {\n-      String dnsName;\n-      String networkLocation;\n-      datanodeDetails.setNetworkName(datanodeDetails.getUuidString());\n-      if (useHostname) {\n-        dnsName = datanodeDetails.getHostName();\n-      } else {\n-        dnsName = datanodeDetails.getIpAddress();\n-      }\n-      networkLocation = nodeResolve(dnsName);\n-      if (networkLocation != null) {\n-        datanodeDetails.setNetworkLocation(networkLocation);\n+    if (!isNodeRegistered(datanodeDetails)) {\n+      InetAddress dnAddress = Server.getRemoteIp();\n+      if (dnAddress != null) {\n+        // Mostly called inside an RPC, update ip and peer hostname\n+        datanodeDetails.setHostName(dnAddress.getHostName());\n+        datanodeDetails.setIpAddress(dnAddress.getHostAddress());\n       }\n-      if (!isNodeRegistered(datanodeDetails)) {\n+      try {\n+        String dnsName;\n+        String networkLocation;\n+        datanodeDetails.setNetworkName(datanodeDetails.getUuidString());\n+        if (useHostname) {\n+          dnsName = datanodeDetails.getHostName();\n+        } else {\n+          dnsName = datanodeDetails.getIpAddress();\n+        }\n+        networkLocation = nodeResolve(dnsName);\n+        if (networkLocation != null) {\n+          datanodeDetails.setNetworkLocation(networkLocation);\n+        }\n+\n         clusterMap.add(datanodeDetails);\n         nodeStateManager.addNode(datanodeDetails);\n         // Check that datanode in nodeStateManager has topology parent set\n-        DatanodeDetails dn =\n-            getNodeByUuid(datanodeDetails.getUuid().toString());\n+        DatanodeDetails dn = nodeStateManager.getNode(datanodeDetails);\n         Preconditions.checkState(dn.getParent() != null);\n         addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n         // Updating Node Report, as registration is successful\n         processNodeReport(datanodeDetails, nodeReport);\n         LOG.info(\"Registered Data node : {}\", datanodeDetails);\n-      } else {\n-        LOG.trace(\"Datanode is already registered. Datanode: {}\",\n-            datanodeDetails.toString());\n-      }\n-    } catch (NodeAlreadyExistsException e) {\n-      if (LOG.isTraceEnabled()) {\n-        LOG.trace(\"Datanode is already registered. Datanode: {}\",\n+      } catch (NodeAlreadyExistsException e) {\n+        if (LOG.isTraceEnabled()) {\n+          LOG.trace(\"Datanode is already registered. Datanode: {}\",\n+              datanodeDetails.toString());\n+        }\n+      } catch (NodeNotFoundException e) {\n+        LOG.error(\"Cannot find datanode {} from nodeStateManager\",\n             datanodeDetails.toString());\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNDUyMw==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450524523", "bodyText": "Can we move isNodeRegistered check at the begin of register() to avoid unnecessary dnsname lookup?", "author": "xiaoyuyao", "createdAt": "2020-07-06T23:09:45Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {", "originalCommit": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2MTAzMA==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452061030", "bodyText": "Sure.", "author": "ChenSammi", "createdAt": "2020-07-09T08:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNDUyMw=="}], "type": "inlineReview", "revised_code": {"commit": "6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\nindex 1cce95593f..005881c011 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java\n\n@@ -241,43 +241,43 @@ public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n       PipelineReportsProto pipelineReportsProto) {\n \n-    InetAddress dnAddress = Server.getRemoteIp();\n-    if (dnAddress != null) {\n-      // Mostly called inside an RPC, update ip and peer hostname\n-      datanodeDetails.setHostName(dnAddress.getHostName());\n-      datanodeDetails.setIpAddress(dnAddress.getHostAddress());\n-    }\n-    try {\n-      String dnsName;\n-      String networkLocation;\n-      datanodeDetails.setNetworkName(datanodeDetails.getUuidString());\n-      if (useHostname) {\n-        dnsName = datanodeDetails.getHostName();\n-      } else {\n-        dnsName = datanodeDetails.getIpAddress();\n-      }\n-      networkLocation = nodeResolve(dnsName);\n-      if (networkLocation != null) {\n-        datanodeDetails.setNetworkLocation(networkLocation);\n+    if (!isNodeRegistered(datanodeDetails)) {\n+      InetAddress dnAddress = Server.getRemoteIp();\n+      if (dnAddress != null) {\n+        // Mostly called inside an RPC, update ip and peer hostname\n+        datanodeDetails.setHostName(dnAddress.getHostName());\n+        datanodeDetails.setIpAddress(dnAddress.getHostAddress());\n       }\n-      if (!isNodeRegistered(datanodeDetails)) {\n+      try {\n+        String dnsName;\n+        String networkLocation;\n+        datanodeDetails.setNetworkName(datanodeDetails.getUuidString());\n+        if (useHostname) {\n+          dnsName = datanodeDetails.getHostName();\n+        } else {\n+          dnsName = datanodeDetails.getIpAddress();\n+        }\n+        networkLocation = nodeResolve(dnsName);\n+        if (networkLocation != null) {\n+          datanodeDetails.setNetworkLocation(networkLocation);\n+        }\n+\n         clusterMap.add(datanodeDetails);\n         nodeStateManager.addNode(datanodeDetails);\n         // Check that datanode in nodeStateManager has topology parent set\n-        DatanodeDetails dn =\n-            getNodeByUuid(datanodeDetails.getUuid().toString());\n+        DatanodeDetails dn = nodeStateManager.getNode(datanodeDetails);\n         Preconditions.checkState(dn.getParent() != null);\n         addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n         // Updating Node Report, as registration is successful\n         processNodeReport(datanodeDetails, nodeReport);\n         LOG.info(\"Registered Data node : {}\", datanodeDetails);\n-      } else {\n-        LOG.trace(\"Datanode is already registered. Datanode: {}\",\n-            datanodeDetails.toString());\n-      }\n-    } catch (NodeAlreadyExistsException e) {\n-      if (LOG.isTraceEnabled()) {\n-        LOG.trace(\"Datanode is already registered. Datanode: {}\",\n+      } catch (NodeAlreadyExistsException e) {\n+        if (LOG.isTraceEnabled()) {\n+          LOG.trace(\"Datanode is already registered. Datanode: {}\",\n+              datanodeDetails.toString());\n+        }\n+      } catch (NodeNotFoundException e) {\n+        LOG.error(\"Cannot find datanode {} from nodeStateManager\",\n             datanodeDetails.toString());\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450526641", "bodyText": "When SCM does not have information about a datanode, it is usually the datanode is dead. So skip processing those delayed report makes sense to me .", "author": "xiaoyuyao", "createdAt": "2020-07-06T23:16:49Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "diffHunk": "@@ -102,8 +102,15 @@ public ContainerReportHandler(final NodeManager nodeManager,\n   public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n                         final EventPublisher publisher) {\n \n-    final DatanodeDetails datanodeDetails =\n+    final DatanodeDetails dnFromReport =\n         reportFromDatanode.getDatanodeDetails();\n+    DatanodeDetails datanodeDetails =", "originalCommit": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NDA5Nw==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452064097", "bodyText": "Xiaoyu, the key point here is we need the DatanodeDetails object from the nodeManager which has topology parent  correctly set.  The DatanodeDetails object parsed from container report always has no parent which will make the Replication Manager treat it as a datanode under /default-rack, further treat the container as under-replicated since cross rack requirement is not satisfied.", "author": "ChenSammi", "createdAt": "2020-07-09T08:50:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTg3Mg==", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452609872", "bodyText": "That's a good catch. Thanks for the details.", "author": "xiaoyuyao", "createdAt": "2020-07-10T03:59:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "url": "https://github.com/apache/ozone/commit/6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "message": "Address comments and remove unused import", "committedDate": "2020-07-09T08:51:35Z", "type": "commit"}, {"oid": "e228c6a46f7816868b02ee559b3ed3b89a6420d9", "url": "https://github.com/apache/ozone/commit/e228c6a46f7816868b02ee559b3ed3b89a6420d9", "message": "trigger new CI check", "committedDate": "2020-07-10T07:14:28Z", "type": "commit"}]}