{"pr_number": 1346, "pr_title": "HDDS-4115. CLI command to show current SCM leader and follower status.", "pr_createdAt": "2020-08-25T04:41:09Z", "pr_url": "https://github.com/apache/ozone/pull/1346", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477533235", "bodyText": "One thing I am not sure is what should be fetched from Ratis peers. Should I also include which one is leader and which one is follower?", "author": "amaliujia", "createdAt": "2020-08-26T19:18:34Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "diffHunk": "@@ -560,6 +563,13 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n+  @Override\n+  public List<String> getScmRatisStatus() throws IOException {\n+    return scm.getScmHAManager()\n+        .getRatisServer().getRaftPeers()\n+        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNTk0MQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481135941", "bodyText": "Could potentially throw NPE", "author": "timmylicheng", "createdAt": "2020-09-01T13:26:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNjc1Mw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481136753", "bodyText": "I can see this method be wrapper in ScmHAManager to show a list of scm hosts.", "author": "timmylicheng", "createdAt": "2020-09-01T13:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3ODQ1NA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481378454", "bodyText": "Got it. Will move this functionality to ScmHAManager.", "author": "amaliujia", "createdAt": "2020-09-01T19:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java\nindex d63df8123f..d2d0f3cb72 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java\n\n@@ -563,13 +562,6 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n-  @Override\n-  public List<String> getScmRatisStatus() throws IOException {\n-    return scm.getScmHAManager()\n-        .getRatisServer().getRaftPeers()\n-        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());\n-  }\n-\n   /**\n    * Queries a list of Node that match a set of statuses.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477533780", "bodyText": "Does this API belongs to StorageContainerLocationProtocol?", "author": "amaliujia", "createdAt": "2020-08-26T19:19:33Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java", "diffHunk": "@@ -230,4 +230,5 @@ Pipeline createReplicationPipeline(HddsProtos.ReplicationType type,\n    */\n   boolean getReplicationManagerStatus() throws IOException;\n \n+  List<String> getScmRatisStatus() throws IOException;", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NzAxOQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481147019", "bodyText": "Any way to merge it with GetSCMInfo?", "author": "timmylicheng", "createdAt": "2020-09-01T13:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTEzMQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481469131", "bodyText": "Pushed a new commit to merge this logic into GetScmInfo", "author": "amaliujia", "createdAt": "2020-09-01T22:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA=="}], "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java\nindex e826aee2fd..c1ab25d015 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java\n\n@@ -229,6 +229,4 @@ Pipeline createReplicationPipeline(HddsProtos.ReplicationType type,\n    * @return True if ReplicationManager is running, false otherwise.\n    */\n   boolean getReplicationManagerStatus() throws IOException;\n-\n-  List<String> getScmRatisStatus() throws IOException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNDI2Ng==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477534266", "bodyText": "This is actually not a unit test as it does not check what is returned. I will think about whether there is a simple way to test that API directly.", "author": "amaliujia", "createdAt": "2020-08-26T19:20:31Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.apache.hadoop.ozone.shell;\n+\n+import java.io.File;\n+import java.net.InetSocketAddress;\n+import java.util.Arrays;\n+import java.util.UUID;\n+import org.apache.hadoop.fs.FileUtil;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.admin.OzoneAdmin;\n+import org.apache.hadoop.ozone.admin.scm.ScmAdmin;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import picocli.CommandLine;\n+import picocli.CommandLine.RunLast;\n+\n+public class TestScmAdminHA {\n+  private static OzoneAdmin ozoneAdmin;\n+  private static OzoneConfiguration conf;\n+  private static String omServiceId;\n+  private static int numOfOMs;\n+  private static String clusterId;\n+  private static String scmId;\n+  private static MiniOzoneCluster cluster;\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    ozoneAdmin = new OzoneAdmin();\n+    conf = new OzoneConfiguration();\n+\n+    // Init HA cluster\n+    omServiceId = \"om-service-test1\";\n+    numOfOMs = 3;\n+    clusterId = UUID.randomUUID().toString();\n+    scmId = UUID.randomUUID().toString();\n+    cluster = MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(clusterId)\n+        .setScmId(scmId)\n+        .setOMServiceId(omServiceId)\n+        .setNumOfOzoneManagers(numOfOMs)\n+        .build();\n+    conf.setQuietMode(false);\n+    // enable ratis for Scm.\n+    conf.setBoolean(ScmConfigKeys.DFS_CONTAINER_RATIS_ENABLED_KEY, true);\n+    cluster.waitForClusterToBeReady();\n+  }\n+\n+  @AfterClass\n+  public static void shutdown() {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void testGetLeaderStatus() {\n+    InetSocketAddress address = cluster.getStorageContainerManager().getClientRpcAddress();\n+    String hostPort = address.getHostName() + \":\" + address.getPort();\n+    String[] args = {\"--scm\", hostPort, \"scmha\", \"listratisstatus\"};\n+    ozoneAdmin.execute(args);", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\nindex 03aedeac28..266854a85f 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n\n@@ -57,10 +57,10 @@ public static void shutdown() {\n   }\n \n   @Test\n-  public void testGetLeaderStatus() {\n+  public void testGetRatisStatus() {\n     InetSocketAddress address = cluster.getStorageContainerManager().getClientRpcAddress();\n     String hostPort = address.getHostName() + \":\" + address.getPort();\n-    String[] args = {\"--scm\", hostPort, \"scmha\", \"listratisstatus\"};\n+    String[] args = {\"--scm\", hostPort, \"scm\", \"status\"};\n     ozoneAdmin.execute(args);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNDc0MQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481134741", "bodyText": "GetSCMRatisRole will be better", "author": "timmylicheng", "createdAt": "2020-09-01T13:25:03Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java", "diffHunk": "@@ -271,6 +273,14 @@ public ScmContainerLocationResponse processRequest(\n             .setGetSafeModeRuleStatusesResponse(getSafeModeRuleStatues(\n                 request.getGetSafeModeRuleStatusesRequest()))\n             .build();\n+      case ScmHAStatus:", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java\nindex b9e1f4fe17..b132429f19 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java\n\n@@ -273,14 +271,6 @@ public ScmContainerLocationResponse processRequest(\n             .setGetSafeModeRuleStatusesResponse(getSafeModeRuleStatues(\n                 request.getGetSafeModeRuleStatusesRequest()))\n             .build();\n-      case ScmHAStatus:\n-        return\n-            ScmContainerLocationResponse.newBuilder()\n-            .setCmdType(request.getCmdType())\n-            .setStatus(Status.OK)\n-            .setGetScmHARatisStatusResponse(\n-                getScmHARatisStatusResponseProto(request.getGetScmHARatisStatusRequest())\n-            ).build();\n       default:\n         throw new IllegalArgumentException(\n             \"Unknown command type: \" + request.getCmdType());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481142517", "bodyText": "Name seems a bit verbose. Let me find a syntax to align with OM HA", "author": "timmylicheng", "createdAt": "2020-09-01T13:36:31Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1OTM4Mw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481359383", "bodyText": "I think both this one and OM HA getserviceroles can be improved.", "author": "adoroszlai", "createdAt": "2020-09-01T18:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3MTQ4Ng==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481371486", "bodyText": "@adoroszlai\nWhat kind of improvement OM HA getserviceroles you are thinking of? I am happy to make a separate PR for that.", "author": "amaliujia", "createdAt": "2020-09-01T19:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4MDQ1Mg==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481380452", "bodyText": "status or roles would probably be enough to indicate the goal of the subcommand, something like\nozone admin (om|scm) status", "author": "adoroszlai", "createdAt": "2020-09-01T19:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxNDEyMw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481414123", "bodyText": "Thanks. I will adopt ozone admin scm status in this PR and I will send another PR for ozone admin om status", "author": "amaliujia", "createdAt": "2020-09-01T20:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1NzIxNw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481557217", "bodyText": "ozone admin om getserviceroles -id=<>\nThis is what OM does. I have my +1 on ozone admin (om|scm) roles. Status is more like health check.", "author": "timmylicheng", "createdAt": "2020-09-02T02:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzODI1Nw==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481638257", "bodyText": "I am ok with both.\n@adoroszlai  what do you think?", "author": "amaliujia", "createdAt": "2020-09-02T04:01:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTcwOTMzOA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481709338", "bodyText": "I think it depends on whether you want to keep this command specific to roles, or may extend the same command in the future with other status info.  Probably \"roles\" is better now, and \"status\" can be either a separate command or another alias later.", "author": "adoroszlai", "createdAt": "2020-09-02T05:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc0NjI3MA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481746270", "bodyText": "that makes sense. Indeed status sounds more like a health check and can carry much more information.\nConsider OM is also actually getting, essentially, roles. We can start from roles", "author": "amaliujia", "createdAt": "2020-09-02T05:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}], "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java b/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java\nindex 0ad77dfdba..e21c25c5ea 100644\n--- a/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java\n+++ b/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java\n\n@@ -7,7 +7,7 @@\n import picocli.CommandLine;\n \n @CommandLine.Command(\n-    name = \"listratisstatus\",\n+    name = \"status\",\n     description = \"\",\n     mixinStandardHelpOptions = true,\n     versionProvider = HddsVersionProvider.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NjY2NQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481146665", "bodyText": "Apart from UT, we can have an acceptance test to test CLI.\nYou may find examples here: #375", "author": "timmylicheng", "createdAt": "2020-09-01T13:42:02Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.apache.hadoop.ozone.shell;", "originalCommit": "8cf37411626ad478b219c48755c8783954118b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTQxMg==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481469412", "bodyText": "ack", "author": "amaliujia", "createdAt": "2020-09-01T22:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NjY2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "0269d6c98181b233de43eda22e890ec42f416e0f", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\nindex 03aedeac28..266854a85f 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n\n@@ -57,10 +57,10 @@ public static void shutdown() {\n   }\n \n   @Test\n-  public void testGetLeaderStatus() {\n+  public void testGetRatisStatus() {\n     InetSocketAddress address = cluster.getStorageContainerManager().getClientRpcAddress();\n     String hostPort = address.getHostName() + \":\" + address.getPort();\n-    String[] args = {\"--scm\", hostPort, \"scmha\", \"listratisstatus\"};\n+    String[] args = {\"--scm\", hostPort, \"scm\", \"status\"};\n     ozoneAdmin.execute(args);\n   }\n }\n"}}, {"oid": "ad3962e0bce8613919b086f2b0d9e47cabef350c", "url": "https://github.com/apache/ozone/commit/ad3962e0bce8613919b086f2b0d9e47cabef350c", "message": "HDDS-4115. CLI command to show current SCM leader and follower status.", "committedDate": "2020-09-01T19:20:27Z", "type": "commit"}, {"oid": "0269d6c98181b233de43eda22e890ec42f416e0f", "url": "https://github.com/apache/ozone/commit/0269d6c98181b233de43eda22e890ec42f416e0f", "message": "fixup! address comments.", "committedDate": "2020-09-01T22:42:04Z", "type": "commit"}, {"oid": "0269d6c98181b233de43eda22e890ec42f416e0f", "url": "https://github.com/apache/ozone/commit/0269d6c98181b233de43eda22e890ec42f416e0f", "message": "fixup! address comments.", "committedDate": "2020-09-01T22:42:04Z", "type": "forcePushed"}, {"oid": "98508154f18058c920074f03f106859eb841145d", "url": "https://github.com/apache/ozone/commit/98508154f18058c920074f03f106859eb841145d", "message": "fixup! fix style", "committedDate": "2020-09-01T22:54:59Z", "type": "commit"}, {"oid": "08ce2bc24a08260ad6d6e6df9732462704ae89cb", "url": "https://github.com/apache/ozone/commit/08ce2bc24a08260ad6d6e6df9732462704ae89cb", "message": "fixup! fix style", "committedDate": "2020-09-01T23:02:20Z", "type": "commit"}, {"oid": "56f20369b1d9939bb525656869ff00c34e9a5d66", "url": "https://github.com/apache/ozone/commit/56f20369b1d9939bb525656869ff00c34e9a5d66", "message": "fixup! add cli command description", "committedDate": "2020-09-01T23:09:27Z", "type": "commit"}, {"oid": "8373b6d498113991d98a85ed50cc2b8ef0e43b71", "url": "https://github.com/apache/ozone/commit/8373b6d498113991d98a85ed50cc2b8ef0e43b71", "message": "fixup! 1. use `ozone admin scm roles` 2. fix acceptance test", "committedDate": "2020-09-02T07:58:11Z", "type": "commit"}, {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a", "url": "https://github.com/apache/ozone/commit/277089b59186debc0c2f769fac69ac1cafe6a56a", "message": "fixup! fix checkstyle", "committedDate": "2020-09-02T08:04:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODUzNQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495538535", "bodyText": "We probably want to align the naming here. Either we use roles or status for all external and internal interfaces.", "author": "timmylicheng", "createdAt": "2020-09-27T07:05:35Z", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of scm status command.\n+ */\n+@CommandLine.Command(\n+    name = \"roles\",\n+    description = \"List all SCMs and their respective Ratis server status\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class GetScmRatisStatusSubcommand implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private ScmAdmin parent;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    ScmClient scmClient = parent.createScmClient();\n+    List<String> status = scmClient.getScmRatisStatus();", "originalCommit": "277089b59186debc0c2f769fac69ac1cafe6a56a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTI5OA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601298", "bodyText": "Good point. I have switched all status to roles", "author": "amaliujia", "createdAt": "2020-09-27T18:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODUzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "02810b277399746db7c8b51fc68914b8020fb839", "chunk": "diff --git a/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java b/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisRolesSubcommand.java\nsimilarity index 89%\nrename from hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java\nrename to hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisRolesSubcommand.java\nindex 77fb933e50..cf2310c3cd 100644\n--- a/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java\n+++ b/hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisRolesSubcommand.java\n\n@@ -28,10 +28,10 @@\n  */\n @CommandLine.Command(\n     name = \"roles\",\n-    description = \"List all SCMs and their respective Ratis server status\",\n+    description = \"List all SCMs and their respective Ratis server roles\",\n     mixinStandardHelpOptions = true,\n     versionProvider = HddsVersionProvider.class)\n-public class GetScmRatisStatusSubcommand implements Callable<Void> {\n+public class GetScmRatisRolesSubcommand implements Callable<Void> {\n \n   @CommandLine.ParentCommand\n   private ScmAdmin parent;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODc1Mg==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495538752", "bodyText": "You mean SCM here?", "author": "timmylicheng", "createdAt": "2020-09-27T07:08:11Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell;\n+\n+import java.net.InetSocketAddress;\n+import java.util.UUID;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.admin.OzoneAdmin;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * This class tests ozone admin scm commands.\n+ */\n+public class TestScmAdminHA {\n+  private static OzoneAdmin ozoneAdmin;\n+  private static OzoneConfiguration conf;\n+  private static String omServiceId;\n+  private static int numOfOMs;\n+  private static String clusterId;\n+  private static String scmId;\n+  private static MiniOzoneCluster cluster;\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    ozoneAdmin = new OzoneAdmin();\n+    conf = new OzoneConfiguration();\n+\n+    // Init HA cluster\n+    omServiceId = \"om-service-test1\";", "originalCommit": "277089b59186debc0c2f769fac69ac1cafe6a56a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTM0MQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601341", "bodyText": "Actually I meant OM. It turns out that I cannot ignore omServiceId to start the cluster (there is a check for this service id).", "author": "amaliujia", "createdAt": "2020-09-27T18:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODc1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "02810b277399746db7c8b51fc68914b8020fb839", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\nindex f9280acc4a..63a8e7186c 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java\n\n@@ -69,11 +69,11 @@ public static void shutdown() {\n   }\n \n   @Test\n-  public void testGetRatisStatus() {\n+  public void testGetRatisRoles() {\n     InetSocketAddress address =\n         cluster.getStorageContainerManager().getClientRpcAddress();\n     String hostPort = address.getHostName() + \":\" + address.getPort();\n-    String[] args = {\"--scm\", hostPort, \"scm\", \"status\"};\n+    String[] args = {\"--scm\", hostPort, \"scm\", \"roles\"};\n     ozoneAdmin.execute(args);\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzOTQ3MQ==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495539471", "bodyText": "You can use the default SCM RatisServer port. Check ratisBindPort in SCMHAConfiguration", "author": "timmylicheng", "createdAt": "2020-09-27T07:15:37Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -107,6 +108,14 @@ public void shutdown() throws IOException {\n     ratisServer.stop();\n   }\n \n+  @Override\n+  public List<String> getRatisStatus() {\n+    return Arrays.asList(", "originalCommit": "277089b59186debc0c2f769fac69ac1cafe6a56a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTQyOA==", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601428", "bodyText": "Switched to use the default port. In the future I will think about how to better construct MockSCMHAManager for testing purpose (as the code is evolving we can keep updating MockSCMHAManager)", "author": "amaliujia", "createdAt": "2020-09-27T18:34:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzOTQ3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "02810b277399746db7c8b51fc68914b8020fb839", "chunk": "diff --git a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java\nindex 80f44e4a7a..e31e7e16bc 100644\n--- a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java\n+++ b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java\n\n@@ -109,11 +109,11 @@ public void shutdown() throws IOException {\n   }\n \n   @Override\n-  public List<String> getRatisStatus() {\n+  public List<String> getRatisRoles() {\n     return Arrays.asList(\n-        \"180.3.14.5:2333\",\n-        \"180.3.14.21:2333\",\n-        \"180.3.14.145:2333\");\n+        \"180.3.14.5:9865\",\n+        \"180.3.14.21:9865\",\n+        \"180.3.14.145:9865\");\n   }\n \n   /**\n"}}, {"oid": "02810b277399746db7c8b51fc68914b8020fb839", "url": "https://github.com/apache/ozone/commit/02810b277399746db7c8b51fc68914b8020fb839", "message": "fixup! address comments", "committedDate": "2020-09-27T18:31:52Z", "type": "commit"}]}