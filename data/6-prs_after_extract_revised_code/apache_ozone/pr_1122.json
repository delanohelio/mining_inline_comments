{"pr_number": 1122, "pr_title": "HDDS-3861. Fix handlePipelineFailure throw exception if role is follower", "pr_createdAt": "2020-06-24T11:22:28Z", "pr_url": "https://github.com/apache/ozone/pull/1122", "timeline": [{"oid": "8228bc6479a3ceb1abac4cac2c4ec6509a0df599", "url": "https://github.com/apache/ozone/commit/8228bc6479a3ceb1abac4cac2c4ec6509a0df599", "message": "HDDS-3861. Fix handlePipelineFailure throw exception if role is follower", "committedDate": "2020-06-24T09:05:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4OTc0Ng==", "url": "https://github.com/apache/ozone/pull/1122#discussion_r445689746", "bodyText": "Can we update the msg accordingly with the reason. The reason precisely was when installSnapshotFromLeader gets invoked on follower, as leader snapshot doesn't contain any data to replay. All the log entries prior to the snapshot might have been purged. So , follower should not try to install snapshot from leader but can close the pipeline here.", "author": "bshashikant", "createdAt": "2020-06-25T16:34:36Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -552,6 +552,10 @@ private void handlePipelineFailure(RaftGroupId groupId,\n       msg = datanode + \" is in candidate state for \" +\n           roleInfoProto.getCandidateInfo().getLastLeaderElapsedTimeMs() + \"ms\";\n       break;\n+    case FOLLOWER:\n+      msg = datanode + \" is in follower state for \" +", "originalCommit": "8228bc6479a3ceb1abac4cac2c4ec6509a0df599", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTkzNTIxMQ==", "url": "https://github.com/apache/ozone/pull/1122#discussion_r445935211", "bodyText": "@bshashikant Thanks for you review and explanation. I have updated the patch.", "author": "runzhiwang", "createdAt": "2020-06-26T02:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4OTc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2ea1fa691ce5b8caa79cb01357bd9d3c1e10e59b", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\nindex 5ae8096ad..1b0ad3cfb 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n\n@@ -553,7 +553,11 @@ private void handlePipelineFailure(RaftGroupId groupId,\n           roleInfoProto.getCandidateInfo().getLastLeaderElapsedTimeMs() + \"ms\";\n       break;\n     case FOLLOWER:\n-      msg = datanode + \" is in follower state for \" +\n+      msg = datanode + \" closes pipeline when installSnapshot from leader \" +\n+          \"because leader snapshot doesn't contain any data to replay, \" +\n+          \"all the log entries prior to the snapshot might have been purged.\" +\n+          \"So follower should not try to install snapshot from leader but\" +\n+          \"can close the pipeline here. It's in follower state for \" +\n           roleInfoProto.getRoleElapsedTimeMs() + \"ms\";\n       break;\n     case LEADER:\n"}}, {"oid": "2ea1fa691ce5b8caa79cb01357bd9d3c1e10e59b", "url": "https://github.com/apache/ozone/commit/2ea1fa691ce5b8caa79cb01357bd9d3c1e10e59b", "message": "fix code review", "committedDate": "2020-06-26T02:24:20Z", "type": "commit"}, {"oid": "2ea1fa691ce5b8caa79cb01357bd9d3c1e10e59b", "url": "https://github.com/apache/ozone/commit/2ea1fa691ce5b8caa79cb01357bd9d3c1e10e59b", "message": "fix code review", "committedDate": "2020-06-26T02:24:20Z", "type": "forcePushed"}, {"oid": "b4765d2b7770443eb8096d2adb11c2081d4187eb", "url": "https://github.com/apache/ozone/commit/b4765d2b7770443eb8096d2adb11c2081d4187eb", "message": "triger ci", "committedDate": "2020-06-26T07:36:02Z", "type": "commit"}]}