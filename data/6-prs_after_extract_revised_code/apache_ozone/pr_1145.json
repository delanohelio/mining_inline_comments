{"pr_number": 1145, "pr_title": "HDDS-3895. Implement container related operations in ContainerManagerImpl", "pr_createdAt": "2020-06-29T05:36:15Z", "pr_url": "https://github.com/apache/ozone/pull/1145", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2ODk1OA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r447268958", "bodyText": "Need to hold the writeLock?", "author": "xiaoyuyao", "createdAt": "2020-06-29T21:37:46Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -279,6 +257,24 @@ public void notifyContainerReportProcessing(final boolean isFullReport,\n     throw new UnsupportedOperationException(\"Not yet implemented!\");\n   }\n \n+  @Override\n+  public void deleteContainer(final ContainerID containerID)\n+      throws IOException {\n+    final HddsProtos.ContainerID id = containerID.getProtobuf();", "originalCommit": "5c96c3bba3241e9756621245e171f8f87053a746", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg5OTMxMA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r447899310", "bodyText": "Thanks for the review. Missed this somehow \ud83d\ude04", "author": "nandakumar131", "createdAt": "2020-06-30T18:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2ODk1OA=="}], "type": "inlineReview", "revised_code": {"commit": "3b961ec50164e34d88657d4dfcf8a46965773479", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\nindex 92cdd9db1..7d4786f40 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n\n@@ -258,13 +258,16 @@ public void notifyContainerReportProcessing(final boolean isFullReport,\n   }\n \n   @Override\n-  public void deleteContainer(final ContainerID containerID)\n+  public void deleteContainer(final ContainerID id)\n       throws IOException {\n-    final HddsProtos.ContainerID id = containerID.getProtobuf();\n-    if (!containerStateManager.contains(id)) {\n-      throw new ContainerNotFoundException(\"ID \" + containerID);\n+    final HddsProtos.ContainerID cid = id.getProtobuf();\n+    lock.writeLock().lock();\n+    try {\n+      checkIfContainerExist(cid);\n+      containerStateManager.removeContainer(cid);\n+    } finally {\n+      lock.writeLock().unlock();\n     }\n-    containerStateManager.removeContainer(id);\n   }\n \n   private void checkIfContainerExist(final HddsProtos.ContainerID id)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI2OTA4Ng==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r447269086", "bodyText": "Can we use checkIfContainerExist()?", "author": "xiaoyuyao", "createdAt": "2020-06-29T21:38:01Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -279,6 +257,24 @@ public void notifyContainerReportProcessing(final boolean isFullReport,\n     throw new UnsupportedOperationException(\"Not yet implemented!\");\n   }\n \n+  @Override\n+  public void deleteContainer(final ContainerID containerID)\n+      throws IOException {\n+    final HddsProtos.ContainerID id = containerID.getProtobuf();\n+    if (!containerStateManager.contains(id)) {", "originalCommit": "5c96c3bba3241e9756621245e171f8f87053a746", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3b961ec50164e34d88657d4dfcf8a46965773479", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\nindex 92cdd9db1..7d4786f40 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n\n@@ -258,13 +258,16 @@ public void notifyContainerReportProcessing(final boolean isFullReport,\n   }\n \n   @Override\n-  public void deleteContainer(final ContainerID containerID)\n+  public void deleteContainer(final ContainerID id)\n       throws IOException {\n-    final HddsProtos.ContainerID id = containerID.getProtobuf();\n-    if (!containerStateManager.contains(id)) {\n-      throw new ContainerNotFoundException(\"ID \" + containerID);\n+    final HddsProtos.ContainerID cid = id.getProtobuf();\n+    lock.writeLock().lock();\n+    try {\n+      checkIfContainerExist(cid);\n+      containerStateManager.removeContainer(cid);\n+    } finally {\n+      lock.writeLock().unlock();\n     }\n-    containerStateManager.removeContainer(id);\n   }\n \n   private void checkIfContainerExist(final HddsProtos.ContainerID id)\n"}}, {"oid": "4ad25999f3946d342f75d177298928ec008afd76", "url": "https://github.com/apache/ozone/commit/4ad25999f3946d342f75d177298928ec008afd76", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-06-30T18:33:26Z", "type": "forcePushed"}, {"oid": "3b961ec50164e34d88657d4dfcf8a46965773479", "url": "https://github.com/apache/ozone/commit/3b961ec50164e34d88657d4dfcf8a46965773479", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-06-30T18:39:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE5MDc5OA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r449190798", "bodyText": "NIT: can we use a different name startId and startID is confusing.", "author": "xiaoyuyao", "createdAt": "2020-07-02T18:13:44Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -93,94 +98,45 @@ public ContainerManagerImpl(\n   }\n \n   @Override\n-  public Set<ContainerID> getContainerIDs() {\n-    lock.readLock().lock();\n-    try {\n-      return containerStateManager.getContainerIDs();\n-    } finally {\n-      lock.readLock().unlock();\n-    }\n-  }\n-\n-  @Override\n-  public Set<ContainerInfo> getContainers() {\n-    lock.readLock().lock();\n-    try {\n-      return containerStateManager.getContainerIDs().stream().map(id -> {\n-        try {\n-          return containerStateManager.getContainer(id);\n-        } catch (ContainerNotFoundException e) {\n-          // How can this happen? o_O\n-          return null;\n-        }\n-      }).filter(Objects::nonNull).collect(Collectors.toSet());\n-    } finally {\n-      lock.readLock().unlock();\n-    }\n-  }\n-\n-  @Override\n-  public ContainerInfo getContainer(final ContainerID containerID)\n+  public ContainerInfo getContainer(final ContainerID id)\n       throws ContainerNotFoundException {\n     lock.readLock().lock();\n     try {\n-      return containerStateManager.getContainer(containerID);\n+      return Optional.ofNullable(containerStateManager\n+          .getContainer(id.getProtobuf()))\n+          .orElseThrow(() -> new ContainerNotFoundException(\"ID \" + id));\n     } finally {\n       lock.readLock().unlock();\n     }\n   }\n \n   @Override\n-  public Set<ContainerInfo> getContainers(final LifeCycleState state) {\n-    lock.readLock().lock();\n-    try {\n-      return containerStateManager.getContainerIDs(state).stream().map(id -> {\n-        try {\n-          return containerStateManager.getContainer(id);\n-        } catch (ContainerNotFoundException e) {\n-          // How can this happen? o_O\n-          return null;\n-        }\n-      }).filter(Objects::nonNull).collect(Collectors.toSet());\n-    } finally {\n-      lock.readLock().unlock();\n-    }\n-  }\n-\n-  @Override\n-  public boolean exists(final ContainerID containerID) {\n+  public List<ContainerInfo> listContainers(final ContainerID startID,\n+                                            final int count) {\n     lock.readLock().lock();\n     try {\n-      return (containerStateManager.getContainer(containerID) != null);\n-    } catch (ContainerNotFoundException ex) {\n-      return false;\n+      final long startId = startID == null ? 0 : startID.getId();", "originalCommit": "3b961ec50164e34d88657d4dfcf8a46965773479", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e6e5758ce701bbc17b30d03383838aa9dd82a7e", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\nindex 7d4786f40..3477eea2c 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java\n\n@@ -115,12 +115,12 @@ public ContainerInfo getContainer(final ContainerID id)\n                                             final int count) {\n     lock.readLock().lock();\n     try {\n-      final long startId = startID == null ? 0 : startID.getId();\n+      final long start = startID == null ? 0 : startID.getId();\n       final List<ContainerID> containersIds =\n           new ArrayList<>(containerStateManager.getContainerIDs());\n       Collections.sort(containersIds);\n       return containersIds.stream()\n-          .filter(id -> id.getId() > startId).limit(count)\n+          .filter(id -> id.getId() > start).limit(count)\n           .map(ContainerID::getProtobuf)\n           .map(containerStateManager::getContainer)\n           .collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5MjQwOQ==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r449292409", "bodyText": "NIT: javadoc update @throws", "author": "xiaoyuyao", "createdAt": "2020-07-02T22:26:34Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerV2.java", "diffHunk": "@@ -113,7 +90,7 @@ void deleteContainer(ContainerID containerID)\n    */\n   void updateContainerState(ContainerID containerID,\n                             LifeCycleEvent event)\n-      throws ContainerNotFoundException;\n+      throws IOException, InvalidStateTransitionException;", "originalCommit": "3b961ec50164e34d88657d4dfcf8a46965773479", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg4NDI3NA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r458884274", "bodyText": "I'm planning to add detailed javadoc in follow up jiras. Will fix the @throws here.", "author": "nandakumar131", "createdAt": "2020-07-22T15:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI5MjQwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e6e5758ce701bbc17b30d03383838aa9dd82a7e", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerV2.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerV2.java\nindex f974db43a..dcedb6ced 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerV2.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerV2.java\n\n@@ -87,6 +87,7 @@ ContainerInfo allocateContainer(ReplicationType type,\n    * @param containerID - Container ID\n    * @param event - container life cycle event\n    * @throws IOException\n+   * @throws InvalidStateTransitionException\n    */\n   void updateContainerState(ContainerID containerID,\n                             LifeCycleEvent event)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDQ4Mw==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r449304483", "bodyText": "Same question here. I see we have a RWLock in ContainerMangerImpl and one RWLock in ContainerStateManager. Can we rely only on the lock in ContainerStateManager?", "author": "xiaoyuyao", "createdAt": "2020-07-02T23:12:19Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -60,6 +64,7 @@\n   /**\n    *\n    */\n+  //Can we move this lock to ContainerStateManager?", "originalCommit": "3b961ec50164e34d88657d4dfcf8a46965773479", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3ODg1Mw==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r458878853", "bodyText": "I would also like to move the lock to ContainerStateManager and not have any lock in ContainerMangerImpl. I'm still thinking of corner cases where this might cause issues.\nState change calls to ContainerStateManager are made via Ratis, so we should not check some state in ContainerMangerImpl and make a Ratis call to change the state without holding any lock.\nI will remove the lock in followup jira after making sure that we are not missing any corner cases.", "author": "nandakumar131", "createdAt": "2020-07-22T15:26:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc4MDkyNw==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r473780927", "bodyText": "Agree with @xiaoyuyao 's suggestion.\n@nandakumar131 Can we also track it in a separate Jira?", "author": "timmylicheng", "createdAt": "2020-08-20T08:52:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDQ4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwOTM2Mg==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r449309362", "bodyText": "Can we add unit test if any the updateContainerState with @replicate?", "author": "xiaoyuyao", "createdAt": "2020-07-02T23:33:08Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManagerV2.java", "diffHunk": "@@ -130,6 +141,21 @@ ContainerInfo getContainer(ContainerID containerID)\n   void addContainer(ContainerInfoProto containerInfo)\n       throws IOException;\n \n+  /**\n+   *\n+   */\n+  @Replicate\n+  void updateContainerState(HddsProtos.ContainerID id,", "originalCommit": "3b961ec50164e34d88657d4dfcf8a46965773479", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg4NDQzMA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r458884430", "bodyText": "Sure.", "author": "nandakumar131", "createdAt": "2020-07-22T15:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwOTM2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2e6e5758ce701bbc17b30d03383838aa9dd82a7e", "url": "https://github.com/apache/ozone/commit/2e6e5758ce701bbc17b30d03383838aa9dd82a7e", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-07-22T16:28:13Z", "type": "forcePushed"}, {"oid": "88da682be1997106f2f0c637f53480fa588ba886", "url": "https://github.com/apache/ozone/commit/88da682be1997106f2f0c637f53480fa588ba886", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-08-11T15:22:33Z", "type": "forcePushed"}, {"oid": "bc5f64834f7be8d4e74105b1561475b8ad902759", "url": "https://github.com/apache/ozone/commit/bc5f64834f7be8d4e74105b1561475b8ad902759", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-08-19T09:32:36Z", "type": "commit"}, {"oid": "bc5f64834f7be8d4e74105b1561475b8ad902759", "url": "https://github.com/apache/ozone/commit/bc5f64834f7be8d4e74105b1561475b8ad902759", "message": "HDDS-3895. Implement container related operations in ContainerManagerImpl.", "committedDate": "2020-08-19T09:32:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2NDk0Ng==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r473664946", "bodyText": "Show we update containerStore as well ?", "author": "GlenGeng", "createdAt": "2020-08-20T06:53:59Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManagerImpl.java", "diffHunk": "@@ -291,23 +328,14 @@ ContainerInfo getMatchingContainer(final long size, String owner,\n     throw new UnsupportedOperationException(\"Not yet implemented!\");\n   }\n \n-\n   NavigableSet<ContainerID> getMatchingContainerIDs(final String owner,\n       final ReplicationType type, final ReplicationFactor factor,\n       final LifeCycleState state) {\n     throw new UnsupportedOperationException(\"Not yet implemented!\");\n   }\n \n-  void removeContainerReplica(final ContainerID containerID,\n-                              final ContainerReplica replica)\n-      throws ContainerNotFoundException, ContainerReplicaNotFoundException {\n-    throw new UnsupportedOperationException(\"Not yet implemented!\");\n-  }\n-\n-\n-  void removeContainer(final ContainerID containerID)\n-      throws ContainerNotFoundException {\n-    throw new UnsupportedOperationException(\"Not yet implemented!\");\n+  public void removeContainer(final HddsProtos.ContainerID id) {\n+    containers.removeContainer(ContainerID.getFromProtobuf(id));", "originalCommit": "bc5f64834f7be8d4e74105b1561475b8ad902759", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzY2NjIwMA==", "url": "https://github.com/apache/ozone/pull/1145#discussion_r473666200", "bodyText": "Show we update containerStore as well ?", "author": "GlenGeng", "createdAt": "2020-08-20T06:55:41Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManagerImpl.java", "diffHunk": "@@ -254,32 +260,63 @@ public void addContainer(final ContainerInfoProto containerInfo)\n     final ContainerID containerID = container.containerID();\n     final PipelineID pipelineID = container.getPipelineID();\n \n-    /*\n-     * TODO:\n-     *  Check if the container already exist in in ContainerStateManager.\n-     *  This optimization can be done after moving ContainerNotFoundException\n-     *  from ContainerStateMap to ContainerManagerImpl.\n-     */\n+    if (!containers.contains(containerID)) {\n+      containerStore.put(containerID, container);\n+      try {\n+        containers.addContainer(container);\n+        pipelineManager.addContainerToPipeline(pipelineID, containerID);\n+      } catch (Exception ex) {\n+        containers.removeContainer(containerID);\n+        containerStore.delete(containerID);\n+        throw ex;\n+      }\n+    }\n+  }\n \n-    containerStore.put(containerID, container);\n-    containers.addContainer(container);\n-    pipelineManager.addContainerToPipeline(pipelineID, containerID);\n-    nextContainerID.incrementAndGet();\n+  @Override\n+  public boolean contains(final HddsProtos.ContainerID id) {\n+    // TODO: Remove the protobuf conversion after fixing ContainerStateMap.\n+    return containers.contains(ContainerID.getFromProtobuf(id));\n   }\n \n-  void updateContainerState(final ContainerID containerID,\n-                            final LifeCycleEvent event)\n-      throws IOException {\n-    throw new UnsupportedOperationException(\"Not yet implemented!\");\n+  public void updateContainerState(final HddsProtos.ContainerID containerID,\n+                                   final LifeCycleEvent event)\n+      throws IOException, InvalidStateTransitionException {\n+    // TODO: Remove the protobuf conversion after fixing ContainerStateMap.\n+    final ContainerID id = ContainerID.getFromProtobuf(containerID);", "originalCommit": "bc5f64834f7be8d4e74105b1561475b8ad902759", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}