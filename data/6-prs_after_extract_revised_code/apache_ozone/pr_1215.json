{"pr_number": 1215, "pr_title": "HDDS-3982. Disable moveToTrash in o3fs and ofs temporarily", "pr_createdAt": "2020-07-17T19:14:09Z", "pr_url": "https://github.com/apache/ozone/pull/1215", "timeline": [{"oid": "6f4ead520d5b979f43b7635e80887945e56df87e", "url": "https://github.com/apache/ozone/commit/6f4ead520d5b979f43b7635e80887945e56df87e", "message": "BasicOzoneFileSystem#rename(src, dst, options)\nBasicRootedOzoneFileSystem#rename(src, dst, options)", "committedDate": "2020-07-17T19:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMDY5Mw==", "url": "https://github.com/apache/ozone/pull/1215#discussion_r456730693", "bodyText": "Please check my above comment.", "author": "umamaheswararao", "createdAt": "2020-07-18T01:12:00Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -397,6 +398,32 @@ public boolean rename(Path src, Path dst) throws IOException {\n     return result;\n   }\n \n+  /**\n+   * Intercept rename to trash calls from TrashPolicyDefault,\n+   * convert them to delete calls instead.\n+   */\n+  @Deprecated\n+  protected void rename(final Path src, final Path dst,\n+      final Rename... options) throws IOException {\n+    boolean hasMoveToTrash = false;\n+    if (options != null) {\n+      for (Rename option : options) {\n+        if (option == Rename.TO_TRASH) {\n+          hasMoveToTrash = true;\n+          break;\n+        }\n+      }\n+    }\n+    if (!hasMoveToTrash) {\n+      // if doesn't have TO_TRASH option, just pass the call to super\n+      super.rename(src, dst, options);\n+    } else {\n+      // intercept when TO_TRASH is found", "originalCommit": "6f4ead520d5b979f43b7635e80887945e56df87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU5NTI0OA==", "url": "https://github.com/apache/ozone/pull/1215#discussion_r457595248", "bodyText": "done in a929357", "author": "smengcl", "createdAt": "2020-07-20T18:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMDY5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a929357c62a60bdfccfb48f1c65f5adf47c30069", "chunk": "diff --git a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\nindex ed4be3dbb..7b20fa0db 100644\n--- a/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n+++ b/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n\n@@ -419,7 +419,9 @@ protected void rename(final Path src, final Path dst,\n       super.rename(src, dst, options);\n     } else {\n       // intercept when TO_TRASH is found\n-      LOG.info(\"Move to trash is disabled for o3fs, deleting instead: {}\", src);\n+      LOG.info(\"Move to trash is disabled for o3fs, deleting instead: {}. \"\n+          + \"Files or directories will NOT be retained in trash. \"\n+          + \"Ignore the following TrashPolicyDefault message.\", src);\n       delete(src, true);\n     }\n   }\n"}}, {"oid": "a929357c62a60bdfccfb48f1c65f5adf47c30069", "url": "https://github.com/apache/ozone/commit/a929357c62a60bdfccfb48f1c65f5adf47c30069", "message": "Improve user message.\n\nChange-Id: I594717fd5895efb59ff0f9646fcee328122747c6", "committedDate": "2020-07-20T18:03:34Z", "type": "commit"}, {"oid": "6829a7094215f78d39bcf9d81aa5f39185123c1d", "url": "https://github.com/apache/ozone/commit/6829a7094215f78d39bcf9d81aa5f39185123c1d", "message": "if any\n\nChange-Id: I347583f47a4f4f9a3558243f9fea72403631c653", "committedDate": "2020-07-20T18:33:57Z", "type": "commit"}, {"oid": "7c625dfb30cd9e706bd1e51920d7de9372236b21", "url": "https://github.com/apache/ozone/commit/7c625dfb30cd9e706bd1e51920d7de9372236b21", "message": "Add testRenameToTrashDisabled for o3fs.\n\nChange-Id: Ie5a4a7f622561aaae0baf1e045508041cf616d26", "committedDate": "2020-07-20T18:34:08Z", "type": "commit"}, {"oid": "fc161c8115172f09c6f82164ac793a0b1f39b407", "url": "https://github.com/apache/ozone/commit/fc161c8115172f09c6f82164ac793a0b1f39b407", "message": "Add testRenameToTrashDisabled for ofs.\n\nChange-Id: I9e37b8a1d6e18f236cc3e861cdb9ae33ca84ca43", "committedDate": "2020-07-20T19:49:41Z", "type": "commit"}, {"oid": "62dc794061f8fcc51e75382419be4f642170cc09", "url": "https://github.com/apache/ozone/commit/62dc794061f8fcc51e75382419be4f642170cc09", "message": "Ignore existing test testDeleteToTrashOrSkipTrash because we have disabled trash.", "committedDate": "2020-07-20T19:58:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTgwNQ==", "url": "https://github.com/apache/ozone/pull/1215#discussion_r457671805", "bodyText": "One last thing: Currently we are straight a way deleting files. Since users coming from Hadoop shell, there could be assumptions that files may move to trash if no -skipTrash flag. But we will be deleting instead of trashing them.\nUser may realize after looking at this log message, but by this time already things happened.\nThere should be a way to shout out this behavior to users. One way is documenting and any other better way?", "author": "umamaheswararao", "createdAt": "2020-07-20T20:27:05Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -372,6 +373,34 @@ public boolean rename(Path src, Path dst) throws IOException {\n     return result;\n   }\n \n+  /**\n+   * Intercept rename to trash calls from TrashPolicyDefault,\n+   * convert them to delete calls instead.\n+   */\n+  @Deprecated\n+  protected void rename(final Path src, final Path dst,\n+      final Options.Rename... options) throws IOException {\n+    boolean hasMoveToTrash = false;\n+    if (options != null) {\n+      for (Options.Rename option : options) {\n+        if (option == Options.Rename.TO_TRASH) {\n+          hasMoveToTrash = true;\n+          break;\n+        }\n+      }\n+    }\n+    if (!hasMoveToTrash) {\n+      // if doesn't have TO_TRASH option, just pass the call to super\n+      super.rename(src, dst, options);\n+    } else {\n+      // intercept when TO_TRASH is found\n+      LOG.info(\"Move to trash is disabled for ofs, deleting instead: {}. \"\n+          + \"Files or directories will NOT be retained in trash. \"\n+          + \"Ignore the following TrashPolicyDefault message, if any.\", src);", "originalCommit": "7c625dfb30cd9e706bd1e51920d7de9372236b21", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "82d5af280b87b02123071f56dc2c61b78627bec2", "url": "https://github.com/apache/ozone/commit/82d5af280b87b02123071f56dc2c61b78627bec2", "message": "Add doc.\n\nChange-Id: I29fcc402b03b8abc2fc0325c9daf568b6e6c2329", "committedDate": "2020-07-20T21:08:43Z", "type": "commit"}]}