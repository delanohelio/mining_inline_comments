{"pr_number": 1066, "pr_title": "HDDS-3770. Improve getPipelines performance", "pr_createdAt": "2020-06-12T01:51:03Z", "pr_url": "https://github.com/apache/ozone/pull/1066", "timeline": [{"oid": "7d05a2cc5731238bc95153fbc71a9bda5f2658d7", "url": "https://github.com/apache/ozone/commit/7d05a2cc5731238bc95153fbc71a9bda5f2658d7", "message": "HDDS-3770. Improve getPipelines performance", "committedDate": "2020-06-12T01:58:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY5MTg3NA==", "url": "https://github.com/apache/ozone/pull/1066#discussion_r439691874", "bodyText": "Collections.emptySet() to avoid unnecessary allocation", "author": "xiaoyuyao", "createdAt": "2020-06-13T00:42:44Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -416,13 +417,12 @@ public void updateDeleteTransactionId(Map<Long, Long> deleteTransactionMap)\n    */\n   public ContainerInfo getMatchingContainer(final long sizeRequired,\n       String owner, Pipeline pipeline) {\n-    return getMatchingContainer(sizeRequired, owner, pipeline, Collections\n-        .emptyList());\n+    return getMatchingContainer(sizeRequired, owner, pipeline, new HashSet<>());", "originalCommit": "1efdc23a245662847c823f3e18c5f3bc013fdb28", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1c7cd6a19408567720ae1323bb8459659c55f3f1", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java\nindex 1237da5a6c..822dd0c628 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java\n\n@@ -422,44 +422,43 @@ public ContainerInfo getMatchingContainer(final long sizeRequired,\n \n   @SuppressWarnings(\"squid:S2445\")\n   public ContainerInfo getMatchingContainer(final long sizeRequired,\n-      String owner, Pipeline pipeline, Set<ContainerID> excludedContainers) {\n+                                            String owner, Pipeline pipeline,\n+                                            Set<ContainerID>\n+                                                      excludedContainers) {\n     NavigableSet<ContainerID> containerIDs;\n+    ContainerInfo containerInfo;\n     try {\n       synchronized (pipeline) {\n         containerIDs = getContainersForOwner(pipeline, owner);\n \n         if (containerIDs.size() < numContainerPerOwnerInPipeline) {\n-          ContainerInfo containerInfo =\n-              containerStateManager.allocateContainer(pipelineManager, owner,\n-                  pipeline);\n-          // Add to DB\n-          addContainerToDB(containerInfo);\n-          containerStateManager.updateLastUsedMap(pipeline.getId(),\n-              containerInfo.containerID(), owner);\n-          return containerInfo;\n-        }\n-      }\n-\n-      containerIDs.removeAll(excludedContainers);\n-      ContainerInfo containerInfo =\n-          containerStateManager.getMatchingContainer(sizeRequired, owner,\n-              pipeline.getId(), containerIDs);\n-      if (containerInfo == null) {\n-        synchronized (pipeline) {\n           containerInfo =\n-              containerStateManager.allocateContainer(pipelineManager, owner,\n-                  pipeline);\n+                  containerStateManager.allocateContainer(\n+                          pipelineManager, owner, pipeline);\n           // Add to DB\n           addContainerToDB(containerInfo);\n+        } else {\n+          containerIDs.removeAll(excludedContainers);\n+          containerInfo =\n+                  containerStateManager.getMatchingContainer(\n+                          sizeRequired, owner, pipeline.getId(), containerIDs);\n+          if (containerInfo == null) {\n+            containerInfo =\n+                    containerStateManager.\n+                            allocateContainer(pipelineManager, owner,\n+                                    pipeline);\n+            // Add to DB\n+            addContainerToDB(containerInfo);\n+          }\n         }\n+        containerStateManager.updateLastUsedMap(pipeline.getId(),\n+                containerInfo.containerID(), owner);\n+        // TODO: #CLUTIL cleanup entries in lastUsedMap\n+        return containerInfo;\n       }\n-      containerStateManager.updateLastUsedMap(pipeline.getId(),\n-          containerInfo.containerID(), owner);\n-      // TODO: #CLUTIL cleanup entries in lastUsedMap\n-      return containerInfo;\n     } catch (Exception e) {\n       LOG.warn(\"Container allocation failed for pipeline={} requiredSize={} {}\",\n-          pipeline, sizeRequired, e);\n+              pipeline, sizeRequired, e);\n       return null;\n     }\n   }\n"}}, {"oid": "1c7cd6a19408567720ae1323bb8459659c55f3f1", "url": "https://github.com/apache/ozone/commit/1c7cd6a19408567720ae1323bb8459659c55f3f1", "message": "HDDS-3770. Improve getPipelines performance", "committedDate": "2020-06-14T06:20:23Z", "type": "commit"}, {"oid": "212a7899df964616c0f3c92a1fa69326f4f31fea", "url": "https://github.com/apache/ozone/commit/212a7899df964616c0f3c92a1fa69326f4f31fea", "message": "fix code review", "committedDate": "2020-06-14T06:22:30Z", "type": "forcePushed"}, {"oid": "212a7899df964616c0f3c92a1fa69326f4f31fea", "url": "https://github.com/apache/ozone/commit/212a7899df964616c0f3c92a1fa69326f4f31fea", "message": "fix code review", "committedDate": "2020-06-14T06:22:30Z", "type": "forcePushed"}, {"oid": "32627906002f0f76510bf7afc83af7fc739ea254", "url": "https://github.com/apache/ozone/commit/32627906002f0f76510bf7afc83af7fc739ea254", "message": "fix code review", "committedDate": "2020-06-19T00:30:37Z", "type": "forcePushed"}, {"oid": "32627906002f0f76510bf7afc83af7fc739ea254", "url": "https://github.com/apache/ozone/commit/32627906002f0f76510bf7afc83af7fc739ea254", "message": "fix code review", "committedDate": "2020-06-19T00:30:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE3MDI1Ng==", "url": "https://github.com/apache/ozone/pull/1066#discussion_r443170256", "bodyText": "Can we change here to Collection to make the interface neutral to implementation? The underlying can be List or Set.", "author": "xiaoyuyao", "createdAt": "2020-06-21T00:34:57Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManager.java", "diffHunk": "@@ -180,7 +180,7 @@ ContainerInfo getMatchingContainer(long size, String owner,\n    * @return ContainerInfo for the matching container.\n    */\n   ContainerInfo getMatchingContainer(long size, String owner,\n-      Pipeline pipeline, List<ContainerID> excludedContainerIDS);\n+      Pipeline pipeline, Set<ContainerID> excludedContainerIDS);", "originalCommit": "32627906002f0f76510bf7afc83af7fc739ea254", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efbfbc9400de5f97a6819de5618be991594bd1dc", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManager.java\nindex a2312ef727..0e1c98f9c5 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManager.java\n\n@@ -180,7 +181,7 @@ ContainerInfo getMatchingContainer(long size, String owner,\n    * @return ContainerInfo for the matching container.\n    */\n   ContainerInfo getMatchingContainer(long size, String owner,\n-      Pipeline pipeline, Set<ContainerID> excludedContainerIDS);\n+      Pipeline pipeline, Collection<ContainerID> excludedContainerIDS);\n \n   /**\n    * Once after report processor handler completes, call this to notify\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE3MDMyMQ==", "url": "https://github.com/apache/ozone/pull/1066#discussion_r443170321", "bodyText": "Can we keep the existing one parameter as Collection which allows passing Set here?", "author": "xiaoyuyao", "createdAt": "2020-06-21T00:36:14Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManager.java", "diffHunk": "@@ -61,8 +61,8 @@ Pipeline createPipeline(ReplicationType type, ReplicationFactor factor,\n       ReplicationFactor factor, Pipeline.PipelineState state);\n \n   List<Pipeline> getPipelines(ReplicationType type, ReplicationFactor factor,\n-      Pipeline.PipelineState state, Collection<DatanodeDetails> excludeDns,\n-      Collection<PipelineID> excludePipelines);", "originalCommit": "32627906002f0f76510bf7afc83af7fc739ea254", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efbfbc9400de5f97a6819de5618be991594bd1dc", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManager.java\nindex 8b1f67913f..48068d82fe 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManager.java\n\n@@ -61,8 +61,8 @@ Pipeline createPipeline(ReplicationType type, ReplicationFactor factor,\n       ReplicationFactor factor, Pipeline.PipelineState state);\n \n   List<Pipeline> getPipelines(ReplicationType type, ReplicationFactor factor,\n-      Pipeline.PipelineState state, Set<DatanodeDetails> excludeDns,\n-      Set<PipelineID> excludePipelines);\n+      Pipeline.PipelineState state, Collection<DatanodeDetails> excludeDns,\n+      Collection<PipelineID> excludePipelines);\n \n   void addContainerToPipeline(PipelineID pipelineID, ContainerID containerID)\n       throws IOException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE3MDM0NA==", "url": "https://github.com/apache/ozone/pull/1066#discussion_r443170344", "bodyText": "Same as above.", "author": "xiaoyuyao", "createdAt": "2020-06-21T00:36:33Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java", "diffHunk": "@@ -81,8 +81,8 @@ Pipeline getPipeline(PipelineID pipelineID) throws PipelineNotFoundException {\n   }\n \n   List<Pipeline> getPipelines(ReplicationType type, ReplicationFactor factor,\n-      PipelineState state, Collection<DatanodeDetails> excludeDns,\n-      Collection<PipelineID> excludePipelines) {", "originalCommit": "32627906002f0f76510bf7afc83af7fc739ea254", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efbfbc9400de5f97a6819de5618be991594bd1dc", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\nindex 9cca232b38..bb56a0380b 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\n\n@@ -81,8 +81,8 @@ Pipeline getPipeline(PipelineID pipelineID) throws PipelineNotFoundException {\n   }\n \n   List<Pipeline> getPipelines(ReplicationType type, ReplicationFactor factor,\n-      PipelineState state, Set<DatanodeDetails> excludeDns,\n-      Set<PipelineID> excludePipelines) {\n+      PipelineState state, Collection<DatanodeDetails> excludeDns,\n+      Collection<PipelineID> excludePipelines) {\n     return pipelineStateMap\n         .getPipelines(type, factor, state, excludeDns, excludePipelines);\n   }\n"}}, {"oid": "efbfbc9400de5f97a6819de5618be991594bd1dc", "url": "https://github.com/apache/ozone/commit/efbfbc9400de5f97a6819de5618be991594bd1dc", "message": "fix code review", "committedDate": "2020-06-21T01:46:01Z", "type": "commit"}, {"oid": "efbfbc9400de5f97a6819de5618be991594bd1dc", "url": "https://github.com/apache/ozone/commit/efbfbc9400de5f97a6819de5618be991594bd1dc", "message": "fix code review", "committedDate": "2020-06-21T01:46:01Z", "type": "forcePushed"}, {"oid": "ffaf425f172f85fb838320235780d079230f0102", "url": "https://github.com/apache/ozone/commit/ffaf425f172f85fb838320235780d079230f0102", "message": "triger ci", "committedDate": "2020-06-21T03:10:37Z", "type": "commit"}]}