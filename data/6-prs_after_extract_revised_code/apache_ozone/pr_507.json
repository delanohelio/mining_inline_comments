{"pr_number": 507, "pr_title": "HDDS-2936. Hive queries fail at readFully", "pr_createdAt": "2020-01-30T07:30:53Z", "pr_url": "https://github.com/apache/ozone/pull/507", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTA1OA==", "url": "https://github.com/apache/ozone/pull/507#discussion_r372931058", "bodyText": "writeLen, goes in both as an agrument as well as a return value to the function. Can we change this to something like expectedWritelen, and writtenLen", "author": "mukul1987", "createdAt": "2020-01-30T12:55:34Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -201,7 +209,11 @@ private void handleWrite(byte[] b, int off, long len, boolean retry)\n         // comes via Exception path.\n         int writeLen = Math.min((int) len, (int) current.getRemaining());\n         long currentPos = current.getWrittenDataLength();\n-        writeToOutputStream(current, retry, len, b, writeLen, off, currentPos);\n+        // writeLen will be updated based on whether the write was succeeded\n+        // or if it sees an exception, how much the actual write was\n+        // acknowledged.\n+        writeLen = writeToOutputStream(current, retry, len, b, writeLen,", "originalCommit": "dd753bcc4d6ce443e0687bec0990e791558bcb50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a967de23c0a2bffaef8be1827001315646ef928b", "chunk": "diff --git a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\nindex b6ccd5d32..7cf55d6bb 100644\n--- a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n+++ b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n\n@@ -209,11 +201,7 @@ private void handleWrite(byte[] b, int off, long len, boolean retry)\n         // comes via Exception path.\n         int writeLen = Math.min((int) len, (int) current.getRemaining());\n         long currentPos = current.getWrittenDataLength();\n-        // writeLen will be updated based on whether the write was succeeded\n-        // or if it sees an exception, how much the actual write was\n-        // acknowledged.\n-        writeLen = writeToOutputStream(current, retry, len, b, writeLen,\n-                off, currentPos);\n+        writeToOutputStream(current, retry, len, b, writeLen, off, currentPos);\n         if (current.getRemaining() <= 0) {\n           // since the current block is already written close the stream.\n           handleFlushOrClose(StreamAction.FULL);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTk1Mg==", "url": "https://github.com/apache/ozone/pull/507#discussion_r372931952", "bodyText": "Lets put\nisException &  throw new IOException(msg, exception); into one function. So that both of these are always updated together.", "author": "mukul1987", "createdAt": "2020-01-30T12:57:13Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -356,6 +370,7 @@ private void handleRetry(IOException exception, long len) throws IOException {\n         msg = \"Retry request failed. \" + action.reason;\n         LOG.error(msg, exception);\n       }\n+      isException = true;\n       throw new IOException(msg, exception);", "originalCommit": "dd753bcc4d6ce443e0687bec0990e791558bcb50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAwNDg3NA==", "url": "https://github.com/apache/ozone/pull/507#discussion_r373004874", "bodyText": "Actually I would say this whole duplication is because RetryPolicy.shouldRetry has two fail states, one when it fails with an exception, and one when it fails with a fail status without an exception by contract.\nThe handling of this underlying speciality at once should go into some method, and perhaps we should use that method to throw an exception in all the cases, and handle the exception only in this code, and the utility method over RetryPolicy.shouldRetry can do the logging and tinkering with the exception message.\nWhat do you think?", "author": "fapifta", "createdAt": "2020-01-30T15:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3NjAwOQ==", "url": "https://github.com/apache/ozone/pull/507#discussion_r373376009", "bodyText": "Addressed in the latest patch..", "author": "bshashikant", "createdAt": "2020-01-31T09:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTk1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a967de23c0a2bffaef8be1827001315646ef928b", "chunk": "diff --git a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\nindex b6ccd5d32..7cf55d6bb 100644\n--- a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n+++ b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n\n@@ -370,7 +356,6 @@ private void handleRetry(IOException exception, long len) throws IOException {\n         msg = \"Retry request failed. \" + action.reason;\n         LOG.error(msg, exception);\n       }\n-      isException = true;\n       throw new IOException(msg, exception);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk5NTUxMA==", "url": "https://github.com/apache/ozone/pull/507#discussion_r372995510", "bodyText": "At this point in the code I am not the fan of throwing an IllegalArgumentException, wouldn't it be better to keep this as an IOException with a specific explaining message?", "author": "fapifta", "createdAt": "2020-01-30T14:54:12Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -484,6 +499,9 @@ public void close() throws IOException {\n     closed = true;\n     try {\n       handleFlushOrClose(StreamAction.CLOSE);\n+      if (!isException) {\n+        Preconditions.checkArgument(writeOffset == offset);", "originalCommit": "dd753bcc4d6ce443e0687bec0990e791558bcb50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM3NTgyMg==", "url": "https://github.com/apache/ozone/pull/507#discussion_r373375822", "bodyText": "I would prefer to have the precondition check intact, as its just in place to validate the logic. If its not met, the code is buggy. Also, throwing Runtime exception is okay as this exception does not need be caught and handled anywhere in general.", "author": "bshashikant", "createdAt": "2020-01-31T09:04:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk5NTUxMA=="}], "type": "inlineReview", "revised_code": {"commit": "a967de23c0a2bffaef8be1827001315646ef928b", "chunk": "diff --git a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\nindex b6ccd5d32..7cf55d6bb 100644\n--- a/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n+++ b/hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java\n\n@@ -499,9 +484,6 @@ public void close() throws IOException {\n     closed = true;\n     try {\n       handleFlushOrClose(StreamAction.CLOSE);\n-      if (!isException) {\n-        Preconditions.checkArgument(writeOffset == offset);\n-      }\n       blockOutputStreamEntryPool.commitKey(offset);\n     } finally {\n       blockOutputStreamEntryPool.cleanup();\n"}}, {"oid": "a967de23c0a2bffaef8be1827001315646ef928b", "url": "https://github.com/apache/ozone/commit/a967de23c0a2bffaef8be1827001315646ef928b", "message": "HDDS-2833. Enable integrations tests for github actions\n\nCloses #416", "committedDate": "2020-01-31T09:03:02Z", "type": "forcePushed"}, {"oid": "10f0715157c5c9f0709aca7abd620bb956a18a16", "url": "https://github.com/apache/ozone/commit/10f0715157c5c9f0709aca7abd620bb956a18a16", "message": "Addressed review comments.", "committedDate": "2020-01-31T12:21:01Z", "type": "commit"}]}