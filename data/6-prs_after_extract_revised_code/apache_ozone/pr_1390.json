{"pr_number": 1390, "pr_title": "HDDS-4196. Add an endpoint in Recon to query Prometheus", "pr_createdAt": "2020-09-03T20:00:31Z", "pr_url": "https://github.com/apache/ozone/pull/1390", "timeline": [{"oid": "ddf1f211ce44b5c92df11174bf2efc724082fb00", "url": "https://github.com/apache/ozone/commit/ddf1f211ce44b5c92df11174bf2efc724082fb00", "message": "HDDS-4196. Add an endpoint in Recon to query Prometheus", "committedDate": "2020-09-03T19:46:40Z", "type": "commit"}, {"oid": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "url": "https://github.com/apache/ozone/commit/19e35f6b3a39d67ab4c40c301348a44f9b10670c", "message": "Fix rat and integration test failure", "committedDate": "2020-09-04T01:24:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTUzNw==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483749537", "bodyText": "Nit. can be StringUtils.isEmpty(prometheusEndpoint)\nNit. Let's add a log line saying we are choosing \"Prometheus\" as the configured Metrics provider here or inside the constructor of PrometheusServiceProviderImpl.", "author": "avijayanhwx", "createdAt": "2020-09-04T17:03:05Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/MetricsServiceProviderFactory.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.recon.ReconConfigKeys;\n+import org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider;\n+import org.apache.hadoop.ozone.recon.spi.impl.PrometheusServiceProviderImpl;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+/**\n+ * Factory class that is used to get the instance of configured Metrics Service\n+ * Provider.\n+ */\n+@Singleton\n+public class MetricsServiceProviderFactory {\n+\n+  private OzoneConfiguration configuration;\n+  private ReconUtils reconUtils;\n+\n+  @Inject\n+  public MetricsServiceProviderFactory(OzoneConfiguration configuration,\n+                                       ReconUtils reconUtils) {\n+    this.configuration = configuration;\n+    this.reconUtils = reconUtils;\n+  }\n+\n+  /**\n+   * Returns the configured MetricsServiceProvider implementation (defaults\n+   * to prometheus).\n+   * If no metrics service providers are configured, returns null.\n+   *\n+   * @return MetricsServiceProvider instance that is configured.\n+   */\n+  public MetricsServiceProvider getMetricsServiceProvider() {\n+    String prometheusEndpoint = getPrometheusEndpoint();\n+    if (prometheusEndpoint != null && !prometheusEndpoint.isEmpty()) {", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/MetricsServiceProviderFactory.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/MetricsServiceProviderFactory.java\nindex 41533f8bec..609f1e4e03 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/MetricsServiceProviderFactory.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/MetricsServiceProviderFactory.java\n\n@@ -18,10 +18,13 @@\n \n package org.apache.hadoop.ozone.recon;\n \n+import org.apache.commons.lang3.StringUtils;\n import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n import org.apache.hadoop.hdds.recon.ReconConfigKeys;\n import org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider;\n import org.apache.hadoop.ozone.recon.spi.impl.PrometheusServiceProviderImpl;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import javax.inject.Inject;\n import javax.inject.Singleton;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MDQ4Mw==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483750483", "bodyText": "Nit. These constants can go inside PrometheusServiceProviderImpl.", "author": "avijayanhwx", "createdAt": "2020-09-04T17:05:19Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconConstants.java", "diffHunk": "@@ -52,6 +52,9 @@ private ReconConstants() {\n   public static final String RECON_QUERY_BUCKET = \"bucket\";\n   public static final String RECON_QUERY_FILE_SIZE = \"fileSize\";\n \n+  public static final String PROMETHEUS_INSTANT_QUERY_API = \"query\";", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconConstants.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconConstants.java\nindex 385883b782..0cbc61fa24 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconConstants.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/ReconConstants.java\n\n@@ -52,9 +52,6 @@ private ReconConstants() {\n   public static final String RECON_QUERY_BUCKET = \"bucket\";\n   public static final String RECON_QUERY_FILE_SIZE = \"fileSize\";\n \n-  public static final String PROMETHEUS_INSTANT_QUERY_API = \"query\";\n-  public static final String PROMETHEUS_RANGED_QUERY_API = \"query_range\";\n-\n   public static final String RECON_SCM_CONTAINER_DB =\n       \"recon-\" + CONTAINER_DB_SUFFIX;\n   public static final String RECON_SCM_PIPELINE_DB = \"recon-\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MTg2Nw==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483751867", "bodyText": "Nit. getEndpointConfigKey() can be a method on the MetricsServiceProvider interface.", "author": "avijayanhwx", "createdAt": "2020-09-04T17:08:40Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/MetricsProxyEndpoint.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.api;\n+\n+import org.apache.hadoop.ozone.recon.MetricsServiceProviderFactory;\n+import org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider;\n+import org.apache.hadoop.ozone.recon.spi.impl.PrometheusServiceProviderImpl;\n+\n+import javax.inject.Inject;\n+import javax.servlet.http.HttpServletResponse;\n+import javax.ws.rs.DefaultValue;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.UriInfo;\n+\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.HttpURLConnection;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.Channels;\n+import java.nio.channels.ReadableByteChannel;\n+import java.nio.channels.WritableByteChannel;\n+\n+import static org.apache.hadoop.ozone.recon.ReconConstants.PROMETHEUS_INSTANT_QUERY_API;\n+\n+/**\n+ * Endpoint to fetch metrics data from Prometheus HTTP endpoint.\n+ */\n+@Path(\"/metrics\")\n+public class MetricsProxyEndpoint {\n+\n+  private MetricsServiceProvider metricsServiceProvider;\n+\n+  @Inject\n+  public MetricsProxyEndpoint(\n+      MetricsServiceProviderFactory metricsServiceProviderFactory) {\n+    this.metricsServiceProvider =\n+        metricsServiceProviderFactory.getMetricsServiceProvider();\n+  }\n+\n+  /**\n+   * Return a response from the configured metrics endpoint.\n+   */\n+  @GET\n+  @Produces(MediaType.APPLICATION_JSON)\n+  @Path(\"/{api}\")\n+  public void getMetricsResponse(\n+      @DefaultValue (PROMETHEUS_INSTANT_QUERY_API) @PathParam(\"api\") String api,\n+      @Context UriInfo uriInfo,\n+      @Context HttpServletResponse httpServletResponse\n+  ) throws Exception {\n+    if (metricsServiceProvider != null) {\n+      HttpURLConnection connection = metricsServiceProvider.getMetricsResponse(\n+          api, uriInfo.getRequestUri().getQuery());\n+      InputStream inputStream;\n+      if (Response.Status.fromStatusCode(connection.getResponseCode())\n+          .getFamily() == Response.Status.Family.SUCCESSFUL) {\n+        inputStream = connection.getInputStream();\n+      } else {\n+        // Throw a bad gateway error if HttpResponseCode is not 2xx\n+        httpServletResponse.setStatus(HttpServletResponse.SC_BAD_GATEWAY);\n+        inputStream = connection.getErrorStream();\n+      }\n+      try (\n+          OutputStream outputStream =\n+              httpServletResponse.getOutputStream();\n+          ReadableByteChannel inputChannel =\n+              Channels.newChannel(inputStream);\n+          WritableByteChannel outputChannel =\n+              Channels.newChannel(outputStream)\n+        ) {\n+        final ByteBuffer buffer = ByteBuffer.allocateDirect(16 * 1024);\n+\n+        while(inputChannel.read(buffer) != -1) {\n+          buffer.flip();\n+          outputChannel.write(buffer);\n+          buffer.compact();\n+        }\n+\n+        buffer.flip();\n+\n+        while(buffer.hasRemaining()) {\n+          outputChannel.write(buffer);\n+        }\n+      } finally {\n+        inputStream.close();\n+      }\n+    } else {\n+      // Throw a Bad Gateway Error\n+      httpServletResponse.sendError(HttpServletResponse.SC_BAD_GATEWAY,\n+          \"Metrics endpoint is not configured. Configure \" +\n+              PrometheusServiceProviderImpl.getEndpointConfigKey() + \" and \" +", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg0OTI2OQ==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483849269", "bodyText": "@avijayanhwx I thought about keeping this method as part of the interface. But, then to construct this error message, we will have to instantiate PrometheusServiceProviderImpl to get endpoint config key. This is because, metricsServiceProviderFactory.getMetricsServiceProvider() will return null when no metrics service providers are configured.", "author": "vivekratnavel", "createdAt": "2020-09-04T21:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MTg2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDUyMw==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r485120523", "bodyText": "@vivekratnavel Makes sense, thanks!", "author": "avijayanhwx", "createdAt": "2020-09-08T18:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MTg2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/MetricsProxyEndpoint.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/MetricsProxyEndpoint.java\nindex c52054e86e..327e9b1926 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/MetricsProxyEndpoint.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/MetricsProxyEndpoint.java\n\n@@ -42,7 +42,8 @@\n import java.nio.channels.ReadableByteChannel;\n import java.nio.channels.WritableByteChannel;\n \n-import static org.apache.hadoop.ozone.recon.ReconConstants.PROMETHEUS_INSTANT_QUERY_API;\n+import static org.apache.hadoop.ozone.recon.spi.impl.PrometheusServiceProviderImpl.PROMETHEUS_INSTANT_QUERY_API;\n+\n \n /**\n  * Endpoint to fetch metrics data from Prometheus HTTP endpoint.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1MjM2OA==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483752368", "bodyText": "We should do values.addAll() or Collections. unmodifiableMap() here, since the caller may mutate the passed in reference.", "author": "avijayanhwx", "createdAt": "2020-09-04T17:09:46Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.metrics;\n+\n+import org.apache.hadoop.hdds.annotation.InterfaceAudience;\n+\n+import java.util.Map;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+/**\n+ * Class for wrapping a metric response from\n+ * {@link org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider}.\n+ */\n+@InterfaceAudience.Private\n+public final class Metric {\n+\n+  private Map<String, String> metadata;\n+  private TreeMap<Double, Double> values;\n+\n+  public Metric(Map<String, String> metadata,\n+                SortedMap<Double, Double> values) {\n+    this.metadata = metadata;\n+    this.values = (TreeMap<Double, Double>) values;", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\nindex 7a1b40f294..1b492b250c 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n\n@@ -31,28 +31,21 @@\n @InterfaceAudience.Private\n public final class Metric {\n \n-  private Map<String, String> metadata;\n-  private TreeMap<Double, Double> values;\n+  private final Map<String, String> metadata;\n+  private final TreeMap<Double, Double> values;\n \n   public Metric(Map<String, String> metadata,\n                 SortedMap<Double, Double> values) {\n     this.metadata = metadata;\n-    this.values = (TreeMap<Double, Double>) values;\n+    this.values = new TreeMap<>();\n+    this.values.putAll(values);\n   }\n \n   public Map<String, String> getMetadata() {\n     return metadata;\n   }\n \n-  public void setMetadata(Map<String, String> metadata) {\n-    this.metadata = metadata;\n-  }\n-\n   public SortedMap<Double, Double> getValues() {\n     return values;\n   }\n-\n-  public void setValues(SortedMap<Double, Double> values) {\n-    this.values = (TreeMap<Double, Double>) values;\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1Mzg1OA==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483753858", "bodyText": "Nit. Can be final fields.", "author": "avijayanhwx", "createdAt": "2020-09-04T17:13:14Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.metrics;\n+\n+import org.apache.hadoop.hdds.annotation.InterfaceAudience;\n+\n+import java.util.Map;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+/**\n+ * Class for wrapping a metric response from\n+ * {@link org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider}.\n+ */\n+@InterfaceAudience.Private\n+public final class Metric {\n+\n+  private Map<String, String> metadata;\n+  private TreeMap<Double, Double> values;", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\nindex 7a1b40f294..1b492b250c 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n\n@@ -31,28 +31,21 @@\n @InterfaceAudience.Private\n public final class Metric {\n \n-  private Map<String, String> metadata;\n-  private TreeMap<Double, Double> values;\n+  private final Map<String, String> metadata;\n+  private final TreeMap<Double, Double> values;\n \n   public Metric(Map<String, String> metadata,\n                 SortedMap<Double, Double> values) {\n     this.metadata = metadata;\n-    this.values = (TreeMap<Double, Double>) values;\n+    this.values = new TreeMap<>();\n+    this.values.putAll(values);\n   }\n \n   public Map<String, String> getMetadata() {\n     return metadata;\n   }\n \n-  public void setMetadata(Map<String, String> metadata) {\n-    this.metadata = metadata;\n-  }\n-\n   public SortedMap<Double, Double> getValues() {\n     return values;\n   }\n-\n-  public void setValues(SortedMap<Double, Double> values) {\n-    this.values = (TreeMap<Double, Double>) values;\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc1NDA1MA==", "url": "https://github.com/apache/ozone/pull/1390#discussion_r483754050", "bodyText": "Nit. Do we need setters in a Metric class?", "author": "avijayanhwx", "createdAt": "2020-09-04T17:13:40Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.metrics;\n+\n+import org.apache.hadoop.hdds.annotation.InterfaceAudience;\n+\n+import java.util.Map;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+/**\n+ * Class for wrapping a metric response from\n+ * {@link org.apache.hadoop.ozone.recon.spi.MetricsServiceProvider}.\n+ */\n+@InterfaceAudience.Private\n+public final class Metric {\n+\n+  private Map<String, String> metadata;\n+  private TreeMap<Double, Double> values;\n+\n+  public Metric(Map<String, String> metadata,\n+                SortedMap<Double, Double> values) {\n+    this.metadata = metadata;\n+    this.values = (TreeMap<Double, Double>) values;\n+  }\n+\n+  public Map<String, String> getMetadata() {\n+    return metadata;\n+  }\n+\n+  public void setMetadata(Map<String, String> metadata) {", "originalCommit": "19e35f6b3a39d67ab4c40c301348a44f9b10670c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "chunk": "diff --git a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\nindex 7a1b40f294..1b492b250c 100644\n--- a/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n+++ b/hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/metrics/Metric.java\n\n@@ -31,28 +31,21 @@\n @InterfaceAudience.Private\n public final class Metric {\n \n-  private Map<String, String> metadata;\n-  private TreeMap<Double, Double> values;\n+  private final Map<String, String> metadata;\n+  private final TreeMap<Double, Double> values;\n \n   public Metric(Map<String, String> metadata,\n                 SortedMap<Double, Double> values) {\n     this.metadata = metadata;\n-    this.values = (TreeMap<Double, Double>) values;\n+    this.values = new TreeMap<>();\n+    this.values.putAll(values);\n   }\n \n   public Map<String, String> getMetadata() {\n     return metadata;\n   }\n \n-  public void setMetadata(Map<String, String> metadata) {\n-    this.metadata = metadata;\n-  }\n-\n   public SortedMap<Double, Double> getValues() {\n     return values;\n   }\n-\n-  public void setValues(SortedMap<Double, Double> values) {\n-    this.values = (TreeMap<Double, Double>) values;\n-  }\n }\n"}}, {"oid": "cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "url": "https://github.com/apache/ozone/commit/cd1a5a978cb2270e1da2e6ec8feb577c713b27e2", "message": "Address review comments", "committedDate": "2020-09-04T21:29:44Z", "type": "commit"}, {"oid": "d87ba9cdf02b9be9944b38f21c171e7830640d3d", "url": "https://github.com/apache/ozone/commit/d87ba9cdf02b9be9944b38f21c171e7830640d3d", "message": "Fix error message in PipelineEndpoint.", "committedDate": "2020-09-04T21:36:48Z", "type": "commit"}]}