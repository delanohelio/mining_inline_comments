{"pr_number": 1023, "pr_title": "HDDS-3718: Improve OmKeyLocationInfoGroup internal data structure", "pr_createdAt": "2020-06-04T16:40:00Z", "pr_url": "https://github.com/apache/ozone/pull/1023", "timeline": [{"oid": "bea8a333f3d75db4881d4e0697a93c7fbacf15dd", "url": "https://github.com/apache/ozone/commit/bea8a333f3d75db4881d4e0697a93c7fbacf15dd", "message": "HDDS-3718: imporve OmKeyLocationInfoGroup internal data structure to improve its performance in trivial cases", "committedDate": "2020-06-04T16:37:08Z", "type": "commit"}, {"oid": "686dcfb858e8432d69b90010b03d7b5410896024", "url": "https://github.com/apache/ozone/commit/686dcfb858e8432d69b90010b03d7b5410896024", "message": "Merge branch 'master' into HDDS-3718-2\n\n# Conflicts:\n#\thadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java", "committedDate": "2020-06-12T05:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDMxNg==", "url": "https://github.com/apache/ozone/pull/1023#discussion_r448010316", "bodyText": "should we change the order of 47/49 so that there is always an ArrayList for the version and the locations is added to that arraylist.", "author": "xiaoyuyao", "createdAt": "2020-06-30T22:16:52Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java", "diffHunk": "@@ -30,12 +30,23 @@\n  */\n public class OmKeyLocationInfoGroup {\n   private final long version;\n-  private final List<OmKeyLocationInfo> locationList;\n+  private final Map<Long, List<OmKeyLocationInfo>> locationVersionList;\n \n   public OmKeyLocationInfoGroup(long version,\n                                 List<OmKeyLocationInfo> locations) {\n     this.version = version;\n-    this.locationList = locations;\n+    this.locationVersionList = locations.stream()\n+        .collect(Collectors.groupingBy(OmKeyLocationInfo::getCreateVersion));\n+    //prevent NPE\n+    this.locationVersionList.putIfAbsent(version, new ArrayList<>());\n+  }\n+\n+  public OmKeyLocationInfoGroup(long version,\n+                                Map<Long, List<OmKeyLocationInfo>> locations) {\n+    this.version = version;\n+    this.locationVersionList = locations;", "originalCommit": "686dcfb858e8432d69b90010b03d7b5410896024", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc3NjEzMw==", "url": "https://github.com/apache/ozone/pull/1023#discussion_r449776133", "bodyText": "It will cause a redundant instantiation of the map and provides no benefit because the map reassigned by the constructor parameter.", "author": "esahekmat", "createdAt": "2020-07-04T14:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDMxNg=="}], "type": "inlineReview", "revised_code": {"commit": "c7dd178f03c92b422e6f912edcd655cd5c101295", "chunk": "diff --git a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\nindex 6d284f846..edebb67b6 100644\n--- a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\n+++ b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\n\n@@ -30,23 +30,23 @@\n  */\n public class OmKeyLocationInfoGroup {\n   private final long version;\n-  private final Map<Long, List<OmKeyLocationInfo>> locationVersionList;\n+  private final Map<Long, List<OmKeyLocationInfo>> locationVersionMap;\n \n   public OmKeyLocationInfoGroup(long version,\n                                 List<OmKeyLocationInfo> locations) {\n     this.version = version;\n-    this.locationVersionList = locations.stream()\n+    this.locationVersionMap = locations.stream()\n         .collect(Collectors.groupingBy(OmKeyLocationInfo::getCreateVersion));\n     //prevent NPE\n-    this.locationVersionList.putIfAbsent(version, new ArrayList<>());\n+    this.locationVersionMap.putIfAbsent(version, new ArrayList<>());\n   }\n \n   public OmKeyLocationInfoGroup(long version,\n                                 Map<Long, List<OmKeyLocationInfo>> locations) {\n     this.version = version;\n-    this.locationVersionList = locations;\n+    this.locationVersionMap = locations;\n     //prevent NPE\n-    this.locationVersionList.putIfAbsent(version, new ArrayList<>());\n+    this.locationVersionMap.putIfAbsent(version, new ArrayList<>());\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMTM1OQ==", "url": "https://github.com/apache/ozone/pull/1023#discussion_r448011359", "bodyText": "NIT: should we rename to locationVersionMap to avoid confusion?", "author": "xiaoyuyao", "createdAt": "2020-06-30T22:19:42Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java", "diffHunk": "@@ -30,12 +30,23 @@\n  */\n public class OmKeyLocationInfoGroup {\n   private final long version;\n-  private final List<OmKeyLocationInfo> locationList;\n+  private final Map<Long, List<OmKeyLocationInfo>> locationVersionList;", "originalCommit": "686dcfb858e8432d69b90010b03d7b5410896024", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc3NjIxMw==", "url": "https://github.com/apache/ozone/pull/1023#discussion_r449776213", "bodyText": "Sure, I will change it", "author": "esahekmat", "createdAt": "2020-07-04T14:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMTM1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7dd178f03c92b422e6f912edcd655cd5c101295", "chunk": "diff --git a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\nindex 6d284f846..edebb67b6 100644\n--- a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\n+++ b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java\n\n@@ -30,23 +30,23 @@\n  */\n public class OmKeyLocationInfoGroup {\n   private final long version;\n-  private final Map<Long, List<OmKeyLocationInfo>> locationVersionList;\n+  private final Map<Long, List<OmKeyLocationInfo>> locationVersionMap;\n \n   public OmKeyLocationInfoGroup(long version,\n                                 List<OmKeyLocationInfo> locations) {\n     this.version = version;\n-    this.locationVersionList = locations.stream()\n+    this.locationVersionMap = locations.stream()\n         .collect(Collectors.groupingBy(OmKeyLocationInfo::getCreateVersion));\n     //prevent NPE\n-    this.locationVersionList.putIfAbsent(version, new ArrayList<>());\n+    this.locationVersionMap.putIfAbsent(version, new ArrayList<>());\n   }\n \n   public OmKeyLocationInfoGroup(long version,\n                                 Map<Long, List<OmKeyLocationInfo>> locations) {\n     this.version = version;\n-    this.locationVersionList = locations;\n+    this.locationVersionMap = locations;\n     //prevent NPE\n-    this.locationVersionList.putIfAbsent(version, new ArrayList<>());\n+    this.locationVersionMap.putIfAbsent(version, new ArrayList<>());\n   }\n \n   /**\n"}}, {"oid": "c7dd178f03c92b422e6f912edcd655cd5c101295", "url": "https://github.com/apache/ozone/commit/c7dd178f03c92b422e6f912edcd655cd5c101295", "message": "HDDS-3718: rename locationVersionList to locationVersionMap", "committedDate": "2020-07-04T14:06:38Z", "type": "commit"}]}