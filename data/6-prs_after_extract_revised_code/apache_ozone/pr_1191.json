{"pr_number": 1191, "pr_title": "HDDS-3837 Add isLeader check in SCMHAManager.", "pr_createdAt": "2020-07-10T08:45:00Z", "pr_url": "https://github.com/apache/ozone/pull/1191", "timeline": [{"oid": "27920f49ebfd173bfde03caa91329eb5ea4bf89f", "url": "https://github.com/apache/ozone/commit/27920f49ebfd173bfde03caa91329eb5ea4bf89f", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-10T09:00:20Z", "type": "forcePushed"}, {"oid": "89b3d3a50098d280d7f1ad1863c9920d79d6660c", "url": "https://github.com/apache/ozone/commit/89b3d3a50098d280d7f1ad1863c9920d79d6660c", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-10T10:07:05Z", "type": "forcePushed"}, {"oid": "9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "url": "https://github.com/apache/ozone/commit/9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-11T13:08:45Z", "type": "forcePushed"}, {"oid": "76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "url": "https://github.com/apache/ozone/commit/76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-11T13:10:03Z", "type": "forcePushed"}, {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "url": "https://github.com/apache/ozone/commit/0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-13T02:33:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTkzNg==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454161936", "bodyText": "Would it be cleaner by using InvocationHander to inject these isLeader() check ?\nStateManager pipelineStateManager = (StateManager) Proxy.newProxyInstance(\n    null,\n    new Class<?>[] {StateManager.class}, \n    (proxy, method, args) -> {\n      if (method.getName().equals(\"xxx\")) {\n        // do is leader check;\n        // throw exception if needed;\n      }\n      return method.invoke(args);\n    });\n\nYou may use hashmap or annotation to speed up the method name check.\nJust a recommendation.", "author": "GlenGeng", "createdAt": "2020-07-14T07:35:15Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -327,6 +349,9 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n    * @throws IOException\n    */\n   protected void removePipeline(Pipeline pipeline) throws IOException {\n+    if (!scmhaManager.isLeader()) {", "originalCommit": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5OTk0Ng==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454199946", "bodyText": "If we want to refactor the code, I would prefer annotation just like @replicate in which we would create something like CheckLeaderInvocationHandler extends InvocationHandler and do isLeader check there.\nIt would be convenient in interface. However, We also use isLeader check in some local methods instead of override methods. Let's keep it this fashion for now and we see if we can polish this.", "author": "timmylicheng", "createdAt": "2020-07-14T08:43:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTkzNg=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\nindex c64ca449a..069540ce2 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n\n@@ -349,9 +337,7 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n    * @throws IOException\n    */\n   protected void removePipeline(Pipeline pipeline) throws IOException {\n-    if (!scmhaManager.isLeader()) {\n-      throw scmhaManager.triggerNotLeaderException();\n-    }\n+    checkLeader();\n     pipelineFactory.close(pipeline.getType(), pipeline);\n     PipelineID pipelineID = pipeline.getId();\n     lock.writeLock().lock();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1MjkwMQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454752901", "bodyText": "Add a todo please\n// will change from RaftServerImpl:::isLeader() to RaftServerImpl::getRoleInfoProto()\n// after RATIS-1001 is merged.", "author": "GlenGeng", "createdAt": "2020-07-15T02:29:28Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -56,7 +69,28 @@ public void start() throws IOException {\n    */\n   @Override\n   public boolean isLeader() {\n-    return isLeader;\n+    if (!SCMHAUtils.isSCMHAEnabled(conf)) {\n+      // When SCM HA is not enabled, the current SCM is always the leader.\n+      return true;\n+    }", "originalCommit": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg2MjUyMg==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454862522", "bodyText": "https://issues.apache.org/jira/browse/HDDS-3962\nCreated a JIRA to track this.", "author": "timmylicheng", "createdAt": "2020-07-15T07:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1MjkwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\nindex c3e5b99b1..3ab81f996 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n\n@@ -80,16 +80,16 @@ public boolean isLeader() {\n       // SCM only has one raft group.\n       serverImpl = ((RaftServerProxy) server)\n           .getImpl(ratisServer.getRaftGroupId());\n-    } catch (IOException ioe) {\n-      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n-          \"whether it's leader. \", ioe);\n-    } finally {\n       if (serverImpl != null) {\n         // Only when it's sure the current SCM is the leader, otherwise\n         // it should all return false.\n         return serverImpl.isLeader();\n       }\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n     }\n+\n     return false;\n   }\n \n"}}, {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "url": "https://github.com/apache/ozone/commit/9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-15T07:58:47Z", "type": "commit"}, {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "url": "https://github.com/apache/ozone/commit/9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "message": "HDDS-3837 Add isLeader check in SCMHAManager.", "committedDate": "2020-07-15T07:58:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEwNTAwMA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r461105000", "bodyText": "should we move this to the try block?", "author": "xiaoyuyao", "createdAt": "2020-07-27T19:02:45Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -56,7 +69,28 @@ public void start() throws IOException {\n    */\n   @Override\n   public boolean isLeader() {\n-    return isLeader;\n+    if (!SCMHAUtils.isSCMHAEnabled(conf)) {\n+      // When SCM HA is not enabled, the current SCM is always the leader.\n+      return true;\n+    }\n+    RaftServer server = ratisServer.getServer();\n+    Preconditions.checkState(server instanceof RaftServerProxy);\n+    RaftServerImpl serverImpl = null;\n+    try {\n+      // SCM only has one raft group.\n+      serverImpl = ((RaftServerProxy) server)\n+          .getImpl(ratisServer.getRaftGroupId());\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n+    } finally {\n+      if (serverImpl != null) {", "originalCommit": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMDA3OA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r462010078", "bodyText": "Done", "author": "timmylicheng", "createdAt": "2020-07-29T03:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEwNTAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\nindex c3e5b99b1..3ab81f996 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n\n@@ -80,16 +80,16 @@ public boolean isLeader() {\n       // SCM only has one raft group.\n       serverImpl = ((RaftServerProxy) server)\n           .getImpl(ratisServer.getRaftGroupId());\n-    } catch (IOException ioe) {\n-      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n-          \"whether it's leader. \", ioe);\n-    } finally {\n       if (serverImpl != null) {\n         // Only when it's sure the current SCM is the leader, otherwise\n         // it should all return false.\n         return serverImpl.isLeader();\n       }\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n     }\n+\n     return false;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExMTgzNQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r461111835", "bodyText": "getId().getAddress() seems unnecessary.", "author": "xiaoyuyao", "createdAt": "2020-07-27T19:15:43Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -67,6 +101,44 @@ public SCMRatisServer getRatisServer() {\n     return ratisServer;\n   }\n \n+  private RaftPeerId getPeerIdFromRoleInfo(RaftServerImpl serverImpl) {\n+    if (serverImpl.isLeader()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getLeaderInfo().toString());\n+    } else if (serverImpl.isFollower()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getFollowerInfo()\n+              .getLeaderInfo().getId().getAddress());", "originalCommit": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMDA1NA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r462010054", "bodyText": "I update with what OM does.", "author": "timmylicheng", "createdAt": "2020-07-29T03:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExMTgzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\nindex c3e5b99b1..3ab81f996 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n\n@@ -106,9 +106,9 @@ private RaftPeerId getPeerIdFromRoleInfo(RaftServerImpl serverImpl) {\n       return RaftPeerId.getRaftPeerId(\n           serverImpl.getRoleInfoProto().getLeaderInfo().toString());\n     } else if (serverImpl.isFollower()) {\n-      return RaftPeerId.getRaftPeerId(\n+      return RaftPeerId.valueOf(\n           serverImpl.getRoleInfoProto().getFollowerInfo()\n-              .getLeaderInfo().getId().getAddress());\n+              .getLeaderInfo().getId().getId());\n     } else {\n       return null;\n     }\n"}}, {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139", "url": "https://github.com/apache/ozone/commit/3629ed3d71174d79fd2e6ef75491b101084fb139", "message": "Update comments.", "committedDate": "2020-07-28T12:50:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0ODEwMQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463348101", "bodyText": "Same as above, can we move this to the try block?", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:49:07Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -67,6 +101,44 @@ public SCMRatisServer getRatisServer() {\n     return ratisServer;\n   }\n \n+  private RaftPeerId getPeerIdFromRoleInfo(RaftServerImpl serverImpl) {\n+    if (serverImpl.isLeader()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getLeaderInfo().toString());\n+    } else if (serverImpl.isFollower()) {\n+      return RaftPeerId.valueOf(\n+          serverImpl.getRoleInfoProto().getFollowerInfo()\n+              .getLeaderInfo().getId().getId());\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  @Override\n+  public RaftPeer getSuggestedLeader() {\n+    RaftServer server = ratisServer.getServer();\n+    Preconditions.checkState(server instanceof RaftServerProxy);\n+    RaftServerImpl serverImpl = null;\n+    try {\n+      // SCM only has one raft group.\n+      serverImpl = ((RaftServerProxy) server)\n+          .getImpl(ratisServer.getRaftGroupId());\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n+    } finally {\n+      if (serverImpl != null) {", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQyMDA0NQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464420045", "bodyText": "Updated", "author": "timmylicheng", "createdAt": "2020-08-03T13:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0ODEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\nindex 3ab81f996..8bb94578b 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java\n\n@@ -123,18 +123,16 @@ public RaftPeer getSuggestedLeader() {\n       // SCM only has one raft group.\n       serverImpl = ((RaftServerProxy) server)\n           .getImpl(ratisServer.getRaftGroupId());\n-    } catch (IOException ioe) {\n-      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n-          \"whether it's leader. \", ioe);\n-    } finally {\n       if (serverImpl != null) {\n         RaftPeerId peerId =  getPeerIdFromRoleInfo(serverImpl);\n         if (peerId != null) {\n           return new RaftPeer(peerId);\n-        } else {\n-          return null;\n         }\n+        return null;\n       }\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n     }\n     return null;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTU3OQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463349579", "bodyText": "why ScmRatiSserver only have one entry in the raft peers, is this something we plan to implement in future?", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:53:37Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java", "diffHunk": "@@ -110,4 +111,18 @@ public void stop() throws IOException {\n     server.close();\n   }\n \n+  @Override\n+  public RaftServer getServer() {\n+    return server;\n+  }\n+\n+  @Override\n+  public RaftGroupId getRaftGroupId() {\n+    return raftGroupId;\n+  }\n+\n+  @Override\n+  public List<RaftPeer> getRaftPeers() {\n+    return Collections.singletonList(new RaftPeer(raftPeerId));", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyNzY3NA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464227674", "bodyText": "Yes. And this class will be deprecated soon in SCM group feature.", "author": "timmylicheng", "createdAt": "2020-08-03T06:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTU3OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTk2Nw==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463349967", "bodyText": "Can we put this as debug log to avoid spamming the SCM log?", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:55:08Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java", "diffHunk": "@@ -41,6 +46,11 @@ public NewNodeHandler(PipelineManager pipelineManager,\n   @Override\n   public void onMessage(DatanodeDetails datanodeDetails,\n       EventPublisher publisher) {\n-    pipelineManager.triggerPipelineCreation();\n+    try {\n+      pipelineManager.triggerPipelineCreation();\n+    } catch (NotLeaderException ex) {\n+      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxODg4NQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464418885", "bodyText": "Updated", "author": "timmylicheng", "createdAt": "2020-08-03T13:38:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTk2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java\nindex 3cd477d36..42cada998 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java\n\n@@ -49,7 +49,7 @@ public void onMessage(DatanodeDetails datanodeDetails,\n     try {\n       pipelineManager.triggerPipelineCreation();\n     } catch (NotLeaderException ex) {\n-      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +\n+      LOG.debug(\"Not the current leader SCM and cannot start pipeline\" +\n           \" creation.\");\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDA0Mw==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463350043", "bodyText": "Same as above.", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:55:24Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java", "diffHunk": "@@ -42,6 +47,11 @@ public NonHealthyToHealthyNodeHandler(\n   @Override\n   public void onMessage(DatanodeDetails datanodeDetails,\n       EventPublisher publisher) {\n-    pipelineManager.triggerPipelineCreation();\n+    try {\n+      pipelineManager.triggerPipelineCreation();\n+    } catch (NotLeaderException ex) {\n+      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxODgyOQ==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464418829", "bodyText": "Updated", "author": "timmylicheng", "createdAt": "2020-08-03T13:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDA0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java\nindex ef5c858fc..e73231be6 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java\n\n@@ -50,7 +50,7 @@ public void onMessage(DatanodeDetails datanodeDetails,\n     try {\n       pipelineManager.triggerPipelineCreation();\n     } catch (NotLeaderException ex) {\n-      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +\n+      LOG.debug(\"Not the current leader SCM and cannot start pipeline\" +\n           \" creation.\");\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDU5OA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463350598", "bodyText": "NIT: Can we add a helper function like checkLeader() to dedup the code?", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:57:45Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -136,6 +139,9 @@ public static PipelineManagerV2Impl newPipelineManager(\n   @Override\n   public Pipeline createPipeline(ReplicationType type,\n                                  ReplicationFactor factor) throws IOException {\n+    if (!scmhaManager.isLeader()) {", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxODcyNg==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464418726", "bodyText": "Updated.", "author": "timmylicheng", "createdAt": "2020-08-03T13:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDU5OA=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\nindex 0dabfba02..069540ce2 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n\n@@ -139,9 +139,7 @@ public static PipelineManagerV2Impl newPipelineManager(\n   @Override\n   public Pipeline createPipeline(ReplicationType type,\n                                  ReplicationFactor factor) throws IOException {\n-    if (!scmhaManager.isLeader()) {\n-      throw scmhaManager.triggerNotLeaderException();\n-    }\n+    checkLeader();\n     if (!isPipelineCreationAllowed() && factor != ReplicationFactor.ONE) {\n       LOG.debug(\"Pipeline creation is not allowed until safe mode prechecks \" +\n           \"complete\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MTE2NA==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463351164", "bodyText": "when scm leader changes, how to ensure the creator and scrubber threads are started on the new leader and stopped on the old leader?", "author": "xiaoyuyao", "createdAt": "2020-07-31T00:59:52Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -431,15 +464,21 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n    * Schedules a fixed interval job to create pipelines.\n    */\n   @Override\n-  public void startPipelineCreator() {\n+  public void startPipelineCreator() throws NotLeaderException {\n+    if (!scmhaManager.isLeader()) {", "originalCommit": "3629ed3d71174d79fd2e6ef75491b101084fb139", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxODY3Nw==", "url": "https://github.com/apache/ozone/pull/1191#discussion_r464418677", "bodyText": "My thought:\n\nEvery SCM starts a pipeline creator thread. So I remove checkLeader in startPipelineCreator\nFor triggerPipelineCreator, if we decide to let follower go thru safemode once it steps up to be leader, we can have checkLeader there as well.", "author": "timmylicheng", "createdAt": "2020-08-03T13:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MTE2NA=="}], "type": "inlineReview", "revised_code": {"commit": "13908ed70b6413eddc4b4675362357fd54b4cec0", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\nindex 0dabfba02..069540ce2 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java\n\n@@ -464,10 +444,7 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n    * Schedules a fixed interval job to create pipelines.\n    */\n   @Override\n-  public void startPipelineCreator() throws NotLeaderException {\n-    if (!scmhaManager.isLeader()) {\n-      throw scmhaManager.triggerNotLeaderException();\n-    }\n+  public void startPipelineCreator() {\n     backgroundPipelineCreator.startFixedIntervalPipelineCreator();\n   }\n \n"}}, {"oid": "13908ed70b6413eddc4b4675362357fd54b4cec0", "url": "https://github.com/apache/ozone/commit/13908ed70b6413eddc4b4675362357fd54b4cec0", "message": "Improve handling NotLeaderException.", "committedDate": "2020-08-03T13:40:37Z", "type": "forcePushed"}, {"oid": "570d9d78390d258330eb910e7e34a368a3ab03fe", "url": "https://github.com/apache/ozone/commit/570d9d78390d258330eb910e7e34a368a3ab03fe", "message": "Improve handling NotLeaderException.", "committedDate": "2020-08-04T03:20:46Z", "type": "commit"}, {"oid": "570d9d78390d258330eb910e7e34a368a3ab03fe", "url": "https://github.com/apache/ozone/commit/570d9d78390d258330eb910e7e34a368a3ab03fe", "message": "Improve handling NotLeaderException.", "committedDate": "2020-08-04T03:20:46Z", "type": "forcePushed"}]}