{"pr_number": 907, "pr_title": "HDDS-3556 Refactor conf in SCMRatisServer to Java-based conf.", "pr_createdAt": "2020-05-09T08:54:51Z", "pr_url": "https://github.com/apache/ozone/pull/907", "timeline": [{"oid": "bd44c3d3cf528f2ce813ce8cd4d4ca70723f20c6", "url": "https://github.com/apache/ozone/commit/bd44c3d3cf528f2ce813ce8cd4d4ca70723f20c6", "message": "HDDS-3556 Refactor configuration in SCMRatisServer to Java-based configuration.", "committedDate": "2020-05-11T03:36:53Z", "type": "forcePushed"}, {"oid": "a7773929bb90da4c8c29e3557a67fa854ab90570", "url": "https://github.com/apache/ozone/commit/a7773929bb90da4c8c29e3557a67fa854ab90570", "message": "HDDS-3556 Refactor configuration in SCMRatisServer to Java-based configuration.", "committedDate": "2020-05-11T09:40:47Z", "type": "commit"}, {"oid": "a7773929bb90da4c8c29e3557a67fa854ab90570", "url": "https://github.com/apache/ozone/commit/a7773929bb90da4c8c29e3557a67fa854ab90570", "message": "HDDS-3556 Refactor configuration in SCMRatisServer to Java-based configuration.", "committedDate": "2020-05-11T09:40:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODQyOQ==", "url": "https://github.com/apache/ozone/pull/907#discussion_r424078429", "bodyText": "Passing half created object (this) to SCMRatisServer constructor could cause subtle bugs that are tricky to get right. We should avoid it if possible.", "author": "xiaoyuyao", "createdAt": "2020-05-12T22:51:50Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -1141,9 +1142,11 @@ private void initializeRatisServer() throws IOException {\n     if (scmRatisServer == null) {\n       SCMNodeDetails scmNodeDetails = SCMNodeDetails\n           .initStandAlone(configuration);\n-      //TODO enable Ratis ring\n-      scmRatisServer = SCMRatisServer.newSCMRatisServer(configuration, this,\n-          scmNodeDetails, Collections.EMPTY_LIST);\n+      //TODO enable Ratis group\n+      scmRatisServer = SCMRatisServer.newSCMRatisServer(configuration\n+              .getObject(SCMRatisServer.SCMRatisServerConfiguration.class),\n+          this, scmNodeDetails, Collections.EMPTY_LIST,", "originalCommit": "a7773929bb90da4c8c29e3557a67fa854ab90570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI3NDEyNw==", "url": "https://github.com/apache/ozone/pull/907#discussion_r424274127", "bodyText": "I have made updates to have SCM use static method for createSCM and make constructor private. SCMRatisServer will be constructed after SCM is constructed.", "author": "timmylicheng", "createdAt": "2020-05-13T08:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3ODQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "ba67c7610eb4b027a053bc3ea2584727ee51655d", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\nindex fee4341d2..59bbe3a90 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\n\n@@ -1138,20 +1156,20 @@ public NetworkTopology getClusterMap() {\n     return this.clusterMap;\n   }\n \n-  private void initializeRatisServer() throws IOException {\n-    if (scmRatisServer == null) {\n-      SCMNodeDetails scmNodeDetails = SCMNodeDetails\n-          .initStandAlone(configuration);\n-      //TODO enable Ratis group\n-      scmRatisServer = SCMRatisServer.newSCMRatisServer(configuration\n-              .getObject(SCMRatisServer.SCMRatisServerConfiguration.class),\n-          this, scmNodeDetails, Collections.EMPTY_LIST,\n-          SCMRatisServer.getSCMRatisDirectory(configuration));\n-      if (scmRatisServer != null) {\n-        LOG.info(\"SCM Ratis server initialized at port {}\",\n-            scmRatisServer.getServerPort());\n-      }\n+  private static SCMRatisServer initializeRatisServer(\n+      OzoneConfiguration conf, StorageContainerManager scm) throws IOException {\n+    SCMNodeDetails scmNodeDetails = SCMNodeDetails\n+        .initStandAlone(conf);\n+    //TODO enable Ratis group\n+    SCMRatisServer scmRatisServer = SCMRatisServer.newSCMRatisServer(\n+        conf.getObject(SCMRatisServer.SCMRatisServerConfiguration.class),\n+        scm, scmNodeDetails, Collections.EMPTY_LIST,\n+        SCMRatisServer.getSCMRatisDirectory(conf));\n+    if (scmRatisServer != null) {\n+      LOG.info(\"SCM Ratis server initialized at port {}\",\n+          scmRatisServer.getServerPort());\n     }\n+    return scmRatisServer;\n   }\n \n   @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MjI2Mg==", "url": "https://github.com/apache/ozone/pull/907#discussion_r424082262", "bodyText": "Is it possible to make these RATIS related configuration reusable among DN,SCM and OM?\nJust different prefix like, ozone.om.ratis, ozone.scm.ratis, ozone.dn.ratis as prefix?", "author": "xiaoyuyao", "createdAt": "2020-05-12T23:02:48Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/ratis/SCMRatisServer.java", "diffHunk": "@@ -479,4 +425,166 @@ private void setServerRole(RaftPeerRole currentRole,\n       this.roleCheckLock.writeLock().unlock();\n     }\n   }\n+\n+  /**\n+   * Configuration used by SCM Ratis Server.\n+   */\n+  @ConfigGroup(prefix = \"ozone.scm.ratis\")", "originalCommit": "a7773929bb90da4c8c29e3557a67fa854ab90570", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEzOTUxMA==", "url": "https://github.com/apache/ozone/pull/907#discussion_r424139510", "bodyText": "Yea it looks like we currently have ozone.om.ratis, ozone.scm.ratis, hdds.datanode.ratis, dfs.container.ratis and even dfs.ratis.\nIf we decide to refactor all config into Java-based configuration, we shall consider refactoring all config to be like ozone.ratis.*\nThen we can take a look at reusable configuration among OM, SCM and container. I create Jira to track: https://issues.apache.org/jira/browse/HDDS-3577", "author": "timmylicheng", "createdAt": "2020-05-13T02:33:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4MjI2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ba67c7610eb4b027a053bc3ea2584727ee51655d", "url": "https://github.com/apache/ozone/commit/ba67c7610eb4b027a053bc3ea2584727ee51655d", "message": "Make SCM constructor private and have SCMRatisServer constructed in static method.", "committedDate": "2020-05-13T08:16:21Z", "type": "commit"}, {"oid": "ba67c7610eb4b027a053bc3ea2584727ee51655d", "url": "https://github.com/apache/ozone/commit/ba67c7610eb4b027a053bc3ea2584727ee51655d", "message": "Make SCM constructor private and have SCMRatisServer constructed in static method.", "committedDate": "2020-05-13T08:16:21Z", "type": "forcePushed"}, {"oid": "affe58cfa6ad9113fb955d1d5589c9a8c27ddf80", "url": "https://github.com/apache/ozone/commit/affe58cfa6ad9113fb955d1d5589c9a8c27ddf80", "message": "Update java doc for createSCM.", "committedDate": "2020-05-19T08:37:36Z", "type": "commit"}]}