{"pr_number": 1371, "pr_title": "HDDS-2922. Balance ratis leader distribution in datanodes", "pr_createdAt": "2020-09-01T02:43:14Z", "pr_url": "https://github.com/apache/ozone/pull/1371", "timeline": [{"oid": "d5b2d64c58484324136ab99d5ec4e2d57e487886", "url": "https://github.com/apache/ozone/commit/d5b2d64c58484324136ab99d5ec4e2d57e487886", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-02T06:26:52Z", "type": "forcePushed"}, {"oid": "73b86226a0ad4efffdc7efab2568ac447f6651fe", "url": "https://github.com/apache/ozone/commit/73b86226a0ad4efffdc7efab2568ac447f6651fe", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-02T06:28:19Z", "type": "forcePushed"}, {"oid": "73b86226a0ad4efffdc7efab2568ac447f6651fe", "url": "https://github.com/apache/ozone/commit/73b86226a0ad4efffdc7efab2568ac447f6651fe", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-02T06:28:19Z", "type": "forcePushed"}, {"oid": "73b86226a0ad4efffdc7efab2568ac447f6651fe", "url": "https://github.com/apache/ozone/commit/73b86226a0ad4efffdc7efab2568ac447f6651fe", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-02T06:28:19Z", "type": "forcePushed"}, {"oid": "ed22ef0fae3e2ae00e6bab725cc21b73c643e87b", "url": "https://github.com/apache/ozone/commit/ed22ef0fae3e2ae00e6bab725cc21b73c643e87b", "message": "triger ci", "committedDate": "2020-09-03T12:15:39Z", "type": "forcePushed"}, {"oid": "e10cf62c22791f1be675d3e26f32b792934c96ea", "url": "https://github.com/apache/ozone/commit/e10cf62c22791f1be675d3e26f32b792934c96ea", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-06T03:44:25Z", "type": "forcePushed"}, {"oid": "904a161b628b3a6837b735d0fa6d09178a7cc4f0", "url": "https://github.com/apache/ozone/commit/904a161b628b3a6837b735d0fa6d09178a7cc4f0", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-06T05:52:04Z", "type": "forcePushed"}, {"oid": "904a161b628b3a6837b735d0fa6d09178a7cc4f0", "url": "https://github.com/apache/ozone/commit/904a161b628b3a6837b735d0fa6d09178a7cc4f0", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-06T05:52:04Z", "type": "forcePushed"}, {"oid": "8fc9e0c2426cbf439af3fdcfa80060512b4ef1d8", "url": "https://github.com/apache/ozone/commit/8fc9e0c2426cbf439af3fdcfa80060512b4ef1d8", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-07T01:11:33Z", "type": "forcePushed"}, {"oid": "ae548311a722ba992d32d389475d2a67b9983581", "url": "https://github.com/apache/ozone/commit/ae548311a722ba992d32d389475d2a67b9983581", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-07T04:45:08Z", "type": "forcePushed"}, {"oid": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "url": "https://github.com/apache/ozone/commit/b58df38136f0b76262cfc5b6a0fe4282375462d3", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-09-07T23:43:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA4NjAxOA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486086018", "bodyText": "miss java doc for these public method.", "author": "GlenGeng", "createdAt": "2020-09-10T06:05:52Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/protocol/DatanodeDetails.java", "diffHunk": "@@ -190,6 +195,18 @@ public Port getPort(Port.Name name) {\n     return null;\n   }\n \n+  public int getSuggestedLeaderCount() {", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/protocol/DatanodeDetails.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/protocol/DatanodeDetails.java\nindex 4487f5570..a3db139b9 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/protocol/DatanodeDetails.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/protocol/DatanodeDetails.java\n\n@@ -195,18 +190,6 @@ public Port getPort(Port.Name name) {\n     return null;\n   }\n \n-  public int getSuggestedLeaderCount() {\n-    return suggestedLeaderCount.get();\n-  }\n-\n-  public void incSuggestedLeaderCount() {\n-    suggestedLeaderCount.incrementAndGet();\n-  }\n-\n-  public void decSuggestedLeaderCount() {\n-    suggestedLeaderCount.decrementAndGet();\n-  }\n-\n   /**\n    * Returns a DatanodeDetails from the protocol buffers.\n    *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5MDMxMw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486090313", "bodyText": "sanity check for peers.size() == priorityList.size()", "author": "GlenGeng", "createdAt": "2020-09-10T06:17:26Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/ratis/RatisHelper.java", "diffHunk": "@@ -125,6 +131,17 @@ private static RaftGroup newRaftGroup(Collection<RaftPeer> peers) {\n         : RaftGroup.valueOf(DUMMY_GROUP_ID, peers);\n   }\n \n+  public static RaftGroup newRaftGroup(RaftGroupId groupId,\n+      List<DatanodeDetails> peers, List<Integer> priorityList) {\n+    final List<RaftPeer> newPeers = new ArrayList<>();", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/ratis/RatisHelper.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/ratis/RatisHelper.java\nindex 3bbc9b117..324774d7d 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/ratis/RatisHelper.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/ratis/RatisHelper.java\n\n@@ -133,6 +133,8 @@ private static RaftGroup newRaftGroup(Collection<RaftPeer> peers) {\n \n   public static RaftGroup newRaftGroup(RaftGroupId groupId,\n       List<DatanodeDetails> peers, List<Integer> priorityList) {\n+    assert peers.size() == priorityList.size();\n+\n     final List<RaftPeer> newPeers = new ArrayList<>();\n     for (int i = 0; i < peers.size(); i++) {\n       RaftPeer peer = RatisHelper.toRaftPeer(peers.get(i), priorityList.get(i));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5MTcwNw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486091707", "bodyText": "how about suggestedLeaderId ?", "author": "GlenGeng", "createdAt": "2020-09-10T06:20:57Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java", "diffHunk": "@@ -61,6 +61,7 @@\n   private UUID leaderId;\n   // Timestamp for pipeline upon creation\n   private Instant creationTimestamp;\n+  private UUID suggestedLeader;", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\nindex dc7624295..3019464cc 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n\n@@ -61,7 +61,7 @@\n   private UUID leaderId;\n   // Timestamp for pipeline upon creation\n   private Instant creationTimestamp;\n-  private UUID suggestedLeader;\n+  private UUID suggestedLeaderId;\n \n   /**\n    * The immutable properties of pipeline object is used in\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5MjE0Mw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486092143", "bodyText": "miss java doc for public method.\nWhy not set suggestedLeader in Ctor and remove the getter/setter ? I guess, it would be final/immutable after creating, just like type/factor.", "author": "GlenGeng", "createdAt": "2020-09-10T06:22:09Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java", "diffHunk": "@@ -123,6 +124,14 @@ public Instant getCreationTimestamp() {\n     return creationTimestamp;\n   }\n \n+  public void setSuggestedLeader(UUID suggestedLeader) {", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\nindex dc7624295..3019464cc 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n\n@@ -124,12 +124,12 @@ public Instant getCreationTimestamp() {\n     return creationTimestamp;\n   }\n \n-  public void setSuggestedLeader(UUID suggestedLeader) {\n-    this.suggestedLeader = suggestedLeader;\n+  public void setSuggestedLeaderId(UUID suggestedLeaderId) {\n+    this.suggestedLeaderId = suggestedLeaderId;\n   }\n \n-  public UUID getSuggestedLeader() {\n-    return suggestedLeader;\n+  public UUID getSuggestedLeaderId() {\n+    return suggestedLeaderId;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5ODAwNg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486098006", "bodyText": "increase the counter after successfully created the pipeline ? Might throw exception during the creation.", "author": "GlenGeng", "createdAt": "2020-09-10T06:36:34Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/CreatePipelineCommandHandler.java", "diffHunk": "@@ -82,18 +104,22 @@ public void handle(SCMCommand command, OzoneContainer ozoneContainer,\n     final CreatePipelineCommandProto createCommand =\n         ((CreatePipelineCommand)command).getProto();\n     final HddsProtos.PipelineID pipelineID = createCommand.getPipelineID();\n-    final Collection<DatanodeDetails> peers =\n+    final List<DatanodeDetails> peers =\n         createCommand.getDatanodeList().stream()\n             .map(DatanodeDetails::getFromProtoBuf)\n             .collect(Collectors.toList());\n+    final List<Integer> priorityList = createCommand.getPriorityList();\n+\n+    incSuggestedLeaderCount(priorityList, peers, dn);", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/CreatePipelineCommandHandler.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/CreatePipelineCommandHandler.java\nindex 990edbd48..235ec7a18 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/CreatePipelineCommandHandler.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/CreatePipelineCommandHandler.java\n\n@@ -110,7 +88,6 @@ public void handle(SCMCommand command, OzoneContainer ozoneContainer,\n             .collect(Collectors.toList());\n     final List<Integer> priorityList = createCommand.getPriorityList();\n \n-    incSuggestedLeaderCount(priorityList, peers, dn);\n \n     try {\n       XceiverServerSpi server = ozoneContainer.getWriteChannel();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEwMjkxMA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486102910", "bodyText": "List<Integer> priorityList = new ArrayList<>(peers.size()); for (...)\nso that won't be bothered by unused var dn", "author": "GlenGeng", "createdAt": "2020-09-10T06:47:18Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -711,10 +711,23 @@ private long calculatePipelineBytesWritten(HddsProtos.PipelineID pipelineID) {\n \n   @Override\n   public void addGroup(HddsProtos.PipelineID pipelineId,\n-      Collection<DatanodeDetails> peers) throws IOException {\n+      List<DatanodeDetails> peers) throws IOException {\n+    List<Integer> priorityList = new ArrayList<>();", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da89a36934ca8688d0d13d7bab60201a9e096d4a", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\nindex ae3b2f9bc..0d42edcba 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n\n@@ -712,11 +713,8 @@ private long calculatePipelineBytesWritten(HddsProtos.PipelineID pipelineID) {\n   @Override\n   public void addGroup(HddsProtos.PipelineID pipelineId,\n       List<DatanodeDetails> peers) throws IOException {\n-    List<Integer> priorityList = new ArrayList<>();\n-    for (DatanodeDetails dn : peers) {\n-      priorityList.add(0);\n-    }\n-\n+    List<Integer> priorityList =\n+        new ArrayList<>(Collections.nCopies(peers.size(), 0));\n     addGroup(pipelineId, peers, priorityList);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEwNDU4MQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486104581", "bodyText": "ditto", "author": "GlenGeng", "createdAt": "2020-09-10T06:50:48Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java", "diffHunk": "@@ -48,16 +50,34 @@ public CreatePipelineCommand(final PipelineID pipelineID,\n     this.factor = factor;\n     this.type = type;\n     this.nodelist = datanodeList;\n+    this.priorityList = new ArrayList<>();\n+    for (DatanodeDetails dn : datanodeList) {", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da89a36934ca8688d0d13d7bab60201a9e096d4a", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\nindex 6aa7fc0d5..082ecc1fb 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n\n@@ -50,10 +51,8 @@ public CreatePipelineCommand(final PipelineID pipelineID,\n     this.factor = factor;\n     this.type = type;\n     this.nodelist = datanodeList;\n-    this.priorityList = new ArrayList<>();\n-    for (DatanodeDetails dn : datanodeList) {\n-      priorityList.add(0);\n-    }\n+    this.priorityList =\n+        new ArrayList<>(Collections.nCopies(datanodeList.size(), 0));\n   }\n \n   public CreatePipelineCommand(final PipelineID pipelineID,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEwODUyOQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r486108529", "bodyText": "as suggested by idea, range for\nfor (dn : dns)", "author": "GlenGeng", "createdAt": "2020-09-10T06:59:01Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -98,8 +102,40 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n+    int minLeaderCount = Integer.MAX_VALUE;\n+    DatanodeDetails suggestedLeader = null;\n+\n+    for (int i = 0; i < dns.size(); i++) {", "originalCommit": "b58df38136f0b76262cfc5b6a0fe4282375462d3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex efda1aca7..5c6fb73dc 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -102,15 +105,41 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n+      List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n+    for (DatanodeDetails dn : dns) {\n+      suggestedLeaderCount.put(dn, 0);\n+\n+      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n+      for (PipelineID pipelineID : pipelineIDSet) {\n+        try {\n+          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n+          if (!pipeline.isClosed()\n+              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n+            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n+          }\n+        } catch (PipelineNotFoundException e) {\n+          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n+              pipelineID, e);\n+        }\n+      }\n+    }\n+\n+    return suggestedLeaderCount;\n+  }\n+\n   private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount =\n+        getSuggestedLeaderCount(dns);\n     int minLeaderCount = Integer.MAX_VALUE;\n     DatanodeDetails suggestedLeader = null;\n \n-    for (int i = 0; i < dns.size(); i++) {\n-      DatanodeDetails dn = dns.get(i);\n-      if (dn.getSuggestedLeaderCount() < minLeaderCount) {\n-        minLeaderCount = dn.getSuggestedLeaderCount();\n-        suggestedLeader = dn;\n+    for (Map.Entry<DatanodeDetails, Integer> entry :\n+        suggestedLeaderCount.entrySet()) {\n+      if (entry.getValue() < minLeaderCount) {\n+        minLeaderCount = entry.getValue();\n+        suggestedLeader = entry.getKey();\n       }\n     }\n \n"}}, {"oid": "7ac9dc8c698829b24876d31a7825d806ee0d0b84", "url": "https://github.com/apache/ozone/commit/7ac9dc8c698829b24876d31a7825d806ee0d0b84", "message": "fix code review", "committedDate": "2020-09-10T23:55:49Z", "type": "forcePushed"}, {"oid": "289a38010c8a449139558b3f4b9ba74cfc2aaf9e", "url": "https://github.com/apache/ozone/commit/289a38010c8a449139558b3f4b9ba74cfc2aaf9e", "message": "fix code review", "committedDate": "2020-09-11T00:38:54Z", "type": "forcePushed"}, {"oid": "da89a36934ca8688d0d13d7bab60201a9e096d4a", "url": "https://github.com/apache/ozone/commit/da89a36934ca8688d0d13d7bab60201a9e096d4a", "message": "fix code review", "committedDate": "2020-09-11T06:48:45Z", "type": "forcePushed"}, {"oid": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "url": "https://github.com/apache/ozone/commit/a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "message": "fix code review", "committedDate": "2020-09-11T10:58:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3MTg5Mw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489771893", "bodyText": "NIT: can we have a static default priority list here?", "author": "xiaoyuyao", "createdAt": "2020-09-16T21:44:14Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -711,10 +712,20 @@ private long calculatePipelineBytesWritten(HddsProtos.PipelineID pipelineID) {\n \n   @Override\n   public void addGroup(HddsProtos.PipelineID pipelineId,\n-      Collection<DatanodeDetails> peers) throws IOException {\n+      List<DatanodeDetails> peers) throws IOException {\n+    List<Integer> priorityList =", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjQzMw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489826433", "bodyText": "Updated", "author": "runzhiwang", "createdAt": "2020-09-17T00:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3MTg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\nindex 0d42edcba..424011999 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n\n@@ -713,8 +712,11 @@ private long calculatePipelineBytesWritten(HddsProtos.PipelineID pipelineID) {\n   @Override\n   public void addGroup(HddsProtos.PipelineID pipelineId,\n       List<DatanodeDetails> peers) throws IOException {\n-    List<Integer> priorityList =\n-        new ArrayList<>(Collections.nCopies(peers.size(), 0));\n+    List<Integer> priorityList = new ArrayList<>();\n+    for (DatanodeDetails dn : peers) {\n+      priorityList.add(0);\n+    }\n+\n     addGroup(pipelineId, peers, priorityList);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489778062", "bodyText": "should we use getLeaderId() instead of getSuggestedLeaderId() here to reflect the actual leader count?", "author": "xiaoyuyao", "createdAt": "2020-09-16T21:58:46Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -98,8 +105,65 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n+      List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n+    for (DatanodeDetails dn : dns) {\n+      suggestedLeaderCount.put(dn, 0);\n+\n+      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n+      for (PipelineID pipelineID : pipelineIDSet) {\n+        try {\n+          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n+          if (!pipeline.isClosed()\n+              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3OTM0OQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489779349", "bodyText": "And the method name can be changed to getLeaderCount() so that the suggest leader is determined by the actual leader count.", "author": "xiaoyuyao", "createdAt": "2020-09-16T22:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgzMzEzNg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489833136", "bodyText": "RATIS-967 guarantee the highpriority node act as leader when create pipeline. In a long running cluster, the leader maybe crash, then some follower will take the leadership, but when the old leader restart and catch up with current leader's log, the old leader can grab the leadership again by RATIS-967.\nSo let me suppose the following case, there are 3 servers: s1, s2, s3, there are 2 pipelines now,  the first pipeline's leader is s1, the second pipeline's leader is s2, both the 2 leaders are suggested leader with high priority. Then s1 crash, suppose s3 will take the first pipline's leader.  Then s1 restart, but has not grab leadership of the first pipeline. If we use getLeaderId() instead of getSuggestedLeaderId() to reflect the actual leader count, when we create the 3 third pipeline, we find the leader number on s1, s2, s3 is 0, 1, 1, so we will select s1 as the suggest leader,  then s1 grab the leadership of the first pipeline by RATIS-967, so the leader number on s1, s2, s3 will be 2, 1, 0, it's not balance.", "author": "runzhiwang", "createdAt": "2020-09-17T00:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY2Njg3Mg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r490666872", "bodyText": "bq.  then s1 grab the leadership of the first pipeline by RATIS-967,\nDoes RATIS-967 always gives up its leader when s1 is back online even the current leader works fine? I think this is more specific to RATIS-967 wrt. how the priority is enforced. Any performance impact on the pipeline of forcing leader to be the original one?\nI'm thinking of instead of forcing leader of pipeline P1, P2, P3 like\nS1   S2   S3\nP1   P2\nP3\nIn the case of S1 temporarily down, why don't we keep P1 leader on S3 and create P3 with leader on S1, this gives more flexibility for higher level to choose leader?\nS1   S2   S3\nP2\nP1\nP3\nAnother situation I'm thinking of is writers on pipeline with slow leader(e.g., hardware slowness) may not be able to recover by leader change.", "author": "xiaoyuyao", "createdAt": "2020-09-18T02:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY3NTM3NA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r490675374", "bodyText": "@xiaoyuyao Good point, I also have thought this.\n\nAny performance impact on the pipeline of forcing leader to be the original one.\n\nIf there is performance problem, I can improve forcing leader change within 1 second. I already know how to improve it, but has not implemented it.\n\nAnother situation I'm thinking of is writers on pipeline with slow leader(e.g., hardware slowness) may not be able to recover by leader change.\n\nWe can find slow leader by some metric, decrease the priority of the slow leader, select one faster datanode and increase it's priority, so the faster datanode will grab the leadership from the slow leader.\n\nIn the case of S1 temporarily down, why don't we keep P1 leader on S3 and create P3 with leader on S1, this gives more flexibility for higher level to choose leader?\n\nI want the cluster leader distribution as we planned, if the plan is not appropriate, we can adjust the plan by change priority.\nIf the leader distribution totally depends on hardware rather than plan, we maybe lost control of the leader distribution. Because the leaderId in scm was reported by datanode, it maybe a delayed leaderId. For example, datanode report:\nS1  ..  S2 ..   S3\nP1  ..  P2\nthen P1's leader transfer to S3, but SCM has not received this report, SCM allocate P3's leader to S3, then\nS1 .. S2 .. S3\n........P2 ..  P1\n...............P3\nIt's not balance now.", "author": "runzhiwang", "createdAt": "2020-09-18T03:12:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxODMwMg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r492218302", "bodyText": "Good point, planed leader distribution should work with RATIS-967. How do we scale with this. Plan weight for each of node as a leader when the cluster has thousands of nodes can be difficult.", "author": "xiaoyuyao", "createdAt": "2020-09-21T17:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjkyNQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r492416925", "bodyText": "Plan weight for each of node as a leader when the cluster has thousands of nodes can be difficult.\n\nIf each node has similar hardware, i.e. CPU, memory, we just plan weight as now, assign each node with same leader number, it is cheap and reasonable.\nI think the only case we need to consider is that some nodes' hardware is weaker than other nodes' obviously.  I think the weeker datanodes should engage in less pipeline than the stronger datanodes,  but ozone does not support this now. If we can support this, the maxum leader number of each datanode should be less or equal to ((1/3) * the pipeline number it engaged in),  and we select the datanode as the leader which has lowest value of (leader number / pipeline number it engaged in) in 3 datanodes,  this is also cheap. We can change this if there is requirement in the future, but now it is enough to allocate the same leader number in each datanode.", "author": "runzhiwang", "createdAt": "2020-09-22T00:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc3ODA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex 4a7234074..e7c376fae 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -105,41 +102,15 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n-  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n-      List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n-    for (DatanodeDetails dn : dns) {\n-      suggestedLeaderCount.put(dn, 0);\n-\n-      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n-      for (PipelineID pipelineID : pipelineIDSet) {\n-        try {\n-          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n-          if (!pipeline.isClosed()\n-              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n-            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n-          }\n-        } catch (PipelineNotFoundException e) {\n-          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n-              pipelineID, e);\n-        }\n-      }\n-    }\n-\n-    return suggestedLeaderCount;\n-  }\n-\n   private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount =\n-        getSuggestedLeaderCount(dns);\n     int minLeaderCount = Integer.MAX_VALUE;\n     DatanodeDetails suggestedLeader = null;\n \n-    for (Map.Entry<DatanodeDetails, Integer> entry :\n-        suggestedLeaderCount.entrySet()) {\n-      if (entry.getValue() < minLeaderCount) {\n-        minLeaderCount = entry.getValue();\n-        suggestedLeader = entry.getKey();\n+    for (int i = 0; i < dns.size(); i++) {\n+      DatanodeDetails dn = dns.get(i);\n+      if (dn.getSuggestedLeaderCount() < minLeaderCount) {\n+        minLeaderCount = dn.getSuggestedLeaderCount();\n+        suggestedLeader = dn;\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4MDY3NA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489780674", "bodyText": "Does Ratis have guarantee to have the highpriority node act as leader?", "author": "xiaoyuyao", "createdAt": "2020-09-16T22:05:43Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -98,8 +105,65 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n+      List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n+    for (DatanodeDetails dn : dns) {\n+      suggestedLeaderCount.put(dn, 0);\n+\n+      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n+      for (PipelineID pipelineID : pipelineIDSet) {\n+        try {\n+          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n+          if (!pipeline.isClosed()\n+              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n+            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n+          }\n+        } catch (PipelineNotFoundException e) {\n+          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n+              pipelineID, e);\n+        }\n+      }\n+    }\n+\n+    return suggestedLeaderCount;\n+  }\n+\n+  private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount =\n+        getSuggestedLeaderCount(dns);\n+    int minLeaderCount = Integer.MAX_VALUE;\n+    DatanodeDetails suggestedLeader = null;\n+\n+    for (Map.Entry<DatanodeDetails, Integer> entry :\n+        suggestedLeaderCount.entrySet()) {\n+      if (entry.getValue() < minLeaderCount) {\n+        minLeaderCount = entry.getValue();\n+        suggestedLeader = entry.getKey();\n+      }\n+    }\n+\n+    return suggestedLeader;\n+  }\n+\n+  private List<Integer> getPriorityList(\n+      List<DatanodeDetails> dns, DatanodeDetails suggestedLeader) {\n+    List<Integer> priorityList = new ArrayList<>();\n+\n+    for (DatanodeDetails dn : dns) {\n+      if (dn.getUuid().equals(suggestedLeader.getUuid())) {\n+        priorityList.add(HIGH_PRIORITY);", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNjc2MA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489826760", "bodyText": "Yes, RATIS-967 guarantee the highpriority node act as leader", "author": "runzhiwang", "createdAt": "2020-09-17T00:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4MDY3NA=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex 4a7234074..e7c376fae 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -105,41 +102,15 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n-  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n-      List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n-    for (DatanodeDetails dn : dns) {\n-      suggestedLeaderCount.put(dn, 0);\n-\n-      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n-      for (PipelineID pipelineID : pipelineIDSet) {\n-        try {\n-          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n-          if (!pipeline.isClosed()\n-              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n-            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n-          }\n-        } catch (PipelineNotFoundException e) {\n-          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n-              pipelineID, e);\n-        }\n-      }\n-    }\n-\n-    return suggestedLeaderCount;\n-  }\n-\n   private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount =\n-        getSuggestedLeaderCount(dns);\n     int minLeaderCount = Integer.MAX_VALUE;\n     DatanodeDetails suggestedLeader = null;\n \n-    for (Map.Entry<DatanodeDetails, Integer> entry :\n-        suggestedLeaderCount.entrySet()) {\n-      if (entry.getValue() < minLeaderCount) {\n-        minLeaderCount = entry.getValue();\n-        suggestedLeader = entry.getKey();\n+    for (int i = 0; i < dns.size(); i++) {\n+      DatanodeDetails dn = dns.get(i);\n+      if (dn.getSuggestedLeaderCount() < minLeaderCount) {\n+        minLeaderCount = dn.getSuggestedLeaderCount();\n+        suggestedLeader = dn;\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4MTYxNg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489781616", "bodyText": "Does the new logic cause more timeout without increasing this?", "author": "xiaoyuyao", "createdAt": "2020-09-16T22:08:05Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestMiniOzoneCluster.java", "diffHunk": "@@ -102,7 +102,7 @@ public static void afterClass() {\n     FileUtils.deleteQuietly(READ_TMP);\n   }\n \n-  @Test(timeout = 30000)\n+  @Test(timeout = 60000)", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgyNzQ2Nw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r489827467", "bodyText": "Yes, the highpriority node act as leader will increase the time of leader election,  but almost the increased time is within 10 seconds.", "author": "runzhiwang", "createdAt": "2020-09-17T00:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc4MTYxNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU0MDY2MA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r488540660", "bodyText": "can we remove this commented out lines?", "author": "bshashikant", "createdAt": "2020-09-15T09:56:39Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestRatisPipelineCreateAndDestroy.java", "diffHunk": "@@ -92,11 +98,128 @@ public void testAutomaticPipelineCreationOnPipelineDestroy()\n     waitForPipelines(2);\n   }\n \n+  private void checkLeaderBalance(int dnNum, int leaderNumOfEachDn)\n+      throws Exception {\n+    List<Pipeline> pipelines = pipelineManager\n+        .getPipelines(HddsProtos.ReplicationType.RATIS,\n+            HddsProtos.ReplicationFactor.THREE, Pipeline.PipelineState.OPEN);\n+\n+    for (Pipeline pipeline : pipelines) {\n+      LambdaTestUtils.await(30000, 500, () ->\n+          pipeline.getLeaderId().equals(pipeline.getSuggestedLeaderId()));\n+    }\n+\n+    Map<UUID, Integer> leaderCount = new HashMap<>();\n+    for (Pipeline pipeline : pipelines) {\n+      UUID leader = pipeline.getLeaderId();\n+      if (!leaderCount.containsKey(leader)) {\n+        leaderCount.put(leader, 0);\n+      }\n+\n+      leaderCount.put(leader, leaderCount.get(leader) + 1);\n+    }\n+\n+    Assert.assertTrue(leaderCount.size() == dnNum);\n+    for (UUID key : leaderCount.keySet()) {\n+      Assert.assertTrue(leaderCount.get(key) == leaderNumOfEachDn);\n+    }\n+  }\n+\n+  @Test(timeout = 360000)\n+  public void testRestoreSuggestedLeader() throws Exception {\n+    conf.setBoolean(OZONE_SCM_PIPELINE_AUTO_CREATE_FACTOR_ONE, false);\n+    int dnNum = 3;\n+    int dnPipelineLimit = 3;\n+    int leaderNumOfEachDn = dnPipelineLimit / dnNum;\n+    int pipelineNum = 3;\n+\n+    init(dnNum, dnPipelineLimit);\n+    // make sure two pipelines are created\n+    waitForPipelines(pipelineNum);\n+    // No Factor ONE pipeline is auto created.\n+    Assert.assertEquals(0, pipelineManager.getPipelines(\n+        HddsProtos.ReplicationType.RATIS,\n+        HddsProtos.ReplicationFactor.ONE).size());\n+\n+    // pipelineNum pipelines in 3 datanodes,\n+    // each datanode has leaderNumOfEachDn leaders after balance\n+    checkLeaderBalance(dnNum, leaderNumOfEachDn);\n+    List<Pipeline> pipelinesBeforeRestart =\n+        cluster.getStorageContainerManager().getPipelineManager()\n+            .getPipelines();\n+\n+    cluster.restartStorageContainerManager(true);\n+\n+    checkLeaderBalance(dnNum, leaderNumOfEachDn);\n+    List<Pipeline> pipelinesAfterRestart =\n+        cluster.getStorageContainerManager().getPipelineManager()\n+            .getPipelines();\n+\n+    Assert.assertEquals(\n+        pipelinesBeforeRestart.size(), pipelinesAfterRestart.size());\n+\n+    for (Pipeline p : pipelinesBeforeRestart) {\n+      boolean equal = false;\n+      for (Pipeline q : pipelinesAfterRestart) {\n+        if (p.getId().equals(q.getId())\n+            && p.getSuggestedLeaderId().equals(q.getSuggestedLeaderId())) {\n+          equal = true;\n+        }\n+      }\n+\n+      Assert.assertTrue(equal);\n+    }\n+  }\n+\n+  @Test(timeout = 360000)\n+  public void testPipelineLeaderBalance() throws Exception {\n+    conf.setBoolean(OZONE_SCM_PIPELINE_AUTO_CREATE_FACTOR_ONE, false);\n+    int dnNum = 3;\n+    int dnPipelineLimit = 3;\n+    int leaderNumOfEachDn = dnPipelineLimit / dnNum;\n+    int pipelineNum = 3;\n+\n+    init(dnNum, dnPipelineLimit);\n+    // make sure two pipelines are created\n+    waitForPipelines(pipelineNum);\n+    // No Factor ONE pipeline is auto created.\n+    Assert.assertEquals(0, pipelineManager.getPipelines(\n+        HddsProtos.ReplicationType.RATIS,\n+        HddsProtos.ReplicationFactor.ONE).size());\n+\n+    // pipelineNum pipelines in 3 datanodes,\n+    // each datanode has leaderNumOfEachDn leaders after balance\n+    checkLeaderBalance(dnNum, leaderNumOfEachDn);\n+\n+    //cluster.restartStorageContainerManager(true);", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestRatisPipelineCreateAndDestroy.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestRatisPipelineCreateAndDestroy.java\nindex a46c29c6c..9dd6a06bc 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestRatisPipelineCreateAndDestroy.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestRatisPipelineCreateAndDestroy.java\n\n@@ -106,7 +107,7 @@ private void checkLeaderBalance(int dnNum, int leaderNumOfEachDn)\n \n     for (Pipeline pipeline : pipelines) {\n       LambdaTestUtils.await(30000, 500, () ->\n-          pipeline.getLeaderId().equals(pipeline.getSuggestedLeaderId()));\n+          pipeline.getLeaderId().equals(pipeline.getSuggestedLeader()));\n     }\n \n     Map<UUID, Integer> leaderCount = new HashMap<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU0MzA3OQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r488543079", "bodyText": "I think suggested leader selection can be made a policy driven change.\n\ndefault policy can be Min leader election count\nIt can also be driven by factors like memory/resource availability on a datanode\nCan be determined by the topology as well. The node nearest to the client can be made the leader .\n\nIts better to make it a pluggable model like this.", "author": "bshashikant", "createdAt": "2020-09-15T10:00:34Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -98,8 +105,65 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n+      List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n+    for (DatanodeDetails dn : dns) {\n+      suggestedLeaderCount.put(dn, 0);\n+\n+      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n+      for (PipelineID pipelineID : pipelineIDSet) {\n+        try {\n+          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n+          if (!pipeline.isClosed()\n+              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n+            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n+          }\n+        } catch (PipelineNotFoundException e) {\n+          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n+              pipelineID, e);\n+        }\n+      }\n+    }\n+\n+    return suggestedLeaderCount;\n+  }\n+\n+  private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n+    Map<DatanodeDetails, Integer> suggestedLeaderCount =", "originalCommit": "a1a7f4e22dd8b1cdf16f839b3678acadf534ec30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU5NTI5NA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r492595294", "bodyText": "@bshashikant I agree. @xiaoyuyao What do you think of this suggestion?", "author": "runzhiwang", "createdAt": "2020-09-22T09:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU0MzA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex 4a7234074..e7c376fae 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -105,41 +102,15 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n-  private Map<DatanodeDetails, Integer> getSuggestedLeaderCount(\n-      List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount = new HashMap<>();\n-    for (DatanodeDetails dn : dns) {\n-      suggestedLeaderCount.put(dn, 0);\n-\n-      Set<PipelineID> pipelineIDSet = getNodeManager().getPipelines(dn);\n-      for (PipelineID pipelineID : pipelineIDSet) {\n-        try {\n-          Pipeline pipeline = getPipelineStateManager().getPipeline(pipelineID);\n-          if (!pipeline.isClosed()\n-              && dn.getUuid().equals(pipeline.getSuggestedLeaderId())) {\n-            suggestedLeaderCount.put(dn, suggestedLeaderCount.get(dn) + 1);\n-          }\n-        } catch (PipelineNotFoundException e) {\n-          LOG.debug(\"Pipeline not found in pipeline state manager : {}\",\n-              pipelineID, e);\n-        }\n-      }\n-    }\n-\n-    return suggestedLeaderCount;\n-  }\n-\n   private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n-    Map<DatanodeDetails, Integer> suggestedLeaderCount =\n-        getSuggestedLeaderCount(dns);\n     int minLeaderCount = Integer.MAX_VALUE;\n     DatanodeDetails suggestedLeader = null;\n \n-    for (Map.Entry<DatanodeDetails, Integer> entry :\n-        suggestedLeaderCount.entrySet()) {\n-      if (entry.getValue() < minLeaderCount) {\n-        minLeaderCount = entry.getValue();\n-        suggestedLeader = entry.getKey();\n+    for (int i = 0; i < dns.size(); i++) {\n+      DatanodeDetails dn = dns.get(i);\n+      if (dn.getSuggestedLeaderCount() < minLeaderCount) {\n+        minLeaderCount = dn.getSuggestedLeaderCount();\n+        suggestedLeader = dn;\n       }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ4Mjc0Ng==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496482746", "bodyText": "Return the suggested leaderId which has a high priority among DNs of the pipeline.", "author": "GlenGeng", "createdAt": "2020-09-29T07:40:20Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java", "diffHunk": "@@ -123,6 +126,15 @@ public Instant getCreationTimestamp() {\n     return creationTimestamp;\n   }\n \n+  /**\n+   * Return the suggested leaderId with high priority of pipeline.", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\nindex f8b9c94a5..dc7624295 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java\n\n@@ -126,13 +124,12 @@ public Instant getCreationTimestamp() {\n     return creationTimestamp;\n   }\n \n-  /**\n-   * Return the suggested leaderId with high priority of pipeline.\n-   *\n-   * @return Suggested LeaderId\n-   */\n-  public UUID getSuggestedLeaderId() {\n-    return suggestedLeaderId;\n+  public void setSuggestedLeader(UUID suggestedLeader) {\n+    this.suggestedLeader = suggestedLeader;\n+  }\n+\n+  public UUID getSuggestedLeader() {\n+    return suggestedLeader;\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5MjUwMg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496492502", "bodyText": "why we need this DEFAULT_PRIORITY_LIST ?\nAt all the locations it appears, it dn number does not equal to it, you always create a new list.\nSuggest to remove this static var.", "author": "GlenGeng", "createdAt": "2020-09-29T07:56:33Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -115,6 +116,9 @@\n   private static final Logger LOG = LoggerFactory\n       .getLogger(XceiverServerRatis.class);\n   private static final AtomicLong CALL_ID_COUNTER = new AtomicLong();\n+  public static final List<Integer> DEFAULT_PRIORITY_LIST =", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyODE0OA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496628148", "bodyText": "why always create a new list ? The size of DEFAULT_PRIORITY_LIST is 3, most case the size of datanode list is 3, their size are equal.", "author": "runzhiwang", "createdAt": "2020-09-29T11:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5MjUwMg=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\nindex 72ec4c184..424011999 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java\n\n@@ -116,9 +115,6 @@\n   private static final Logger LOG = LoggerFactory\n       .getLogger(XceiverServerRatis.class);\n   private static final AtomicLong CALL_ID_COUNTER = new AtomicLong();\n-  public static final List<Integer> DEFAULT_PRIORITY_LIST =\n-      new ArrayList<>(\n-          Collections.nCopies(HddsProtos.ReplicationFactor.THREE_VALUE, 0));\n \n   private static long nextCallId() {\n     return CALL_ID_COUNTER.getAndIncrement() & Long.MAX_VALUE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5NjUzMQ==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496496531", "bodyText": "just forward to the Ctor with priorityList .\nthis(pipelineID, factor, type, datanodeList,\n    new ArrayList<>(Collections.nCopies(datanodeList.size(), 0))", "author": "GlenGeng", "createdAt": "2020-09-29T08:00:24Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java", "diffHunk": "@@ -48,16 +52,37 @@ public CreatePipelineCommand(final PipelineID pipelineID,\n     this.factor = factor;\n     this.type = type;\n     this.nodelist = datanodeList;\n+    if (datanodeList.size() ==\n+        XceiverServerRatis.DEFAULT_PRIORITY_LIST.size()) {", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyODQyNA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496628424", "bodyText": "always new is a waste.", "author": "runzhiwang", "createdAt": "2020-09-29T11:02:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5NjUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\nindex 80495c315..6aa7fc0d5 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n\n@@ -52,12 +50,9 @@ public CreatePipelineCommand(final PipelineID pipelineID,\n     this.factor = factor;\n     this.type = type;\n     this.nodelist = datanodeList;\n-    if (datanodeList.size() ==\n-        XceiverServerRatis.DEFAULT_PRIORITY_LIST.size()) {\n-      this.priorityList = XceiverServerRatis.DEFAULT_PRIORITY_LIST;\n-    } else {\n-      this.priorityList =\n-          new ArrayList<>(Collections.nCopies(datanodeList.size(), 0));\n+    this.priorityList = new ArrayList<>();\n+    for (DatanodeDetails dn : datanodeList) {\n+      priorityList.add(0);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5OTY4OA==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496499688", "bodyText": "revert unnecessary change.", "author": "GlenGeng", "createdAt": "2020-09-29T08:03:25Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java", "diffHunk": "@@ -59,7 +59,8 @@ void addContainerToPipeline(PipelineID pipelineId, ContainerID containerID)\n     pipelineStateMap.addContainerToPipeline(pipelineId, containerID);\n   }\n \n-  Pipeline getPipeline(PipelineID pipelineID) throws PipelineNotFoundException {\n+  public Pipeline getPipeline(PipelineID pipelineID)", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYyNDM1Mw==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496624353", "bodyText": "This is necessary, otherwise we can not call getPipeline in MinLeaderCountChoosePolicy", "author": "runzhiwang", "createdAt": "2020-09-29T10:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5OTY4OA=="}], "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\nindex 8bc5bd5ed..bb56a0380 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateManager.java\n\n@@ -59,8 +59,7 @@ void addContainerToPipeline(PipelineID pipelineId, ContainerID containerID)\n     pipelineStateMap.addContainerToPipeline(pipelineId, containerID);\n   }\n \n-  public Pipeline getPipeline(PipelineID pipelineID)\n-      throws PipelineNotFoundException {\n+  Pipeline getPipeline(PipelineID pipelineID) throws PipelineNotFoundException {\n     return pipelineStateMap.getPipeline(pipelineID);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUwNzQ1Ng==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496507456", "bodyText": "why not use DatanodeDetails.equals() ?", "author": "GlenGeng", "createdAt": "2020-09-29T08:10:53Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -98,8 +115,28 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n+  @VisibleForTesting\n+  public LeaderChoosePolicy getLeaderChoosePolicy() {\n+    return leaderChoosePolicy;\n+  }\n+  private List<Integer> getPriorityList(\n+      List<DatanodeDetails> dns, DatanodeDetails suggestedLeader) {\n+    List<Integer> priorityList = new ArrayList<>();\n+\n+    for (DatanodeDetails dn : dns) {\n+      if (dn.getUuid().equals(suggestedLeader.getUuid())) {", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex 29de7b1bf..e7c376fae 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -115,16 +102,28 @@ private boolean exceedPipelineNumberLimit(ReplicationFactor factor) {\n     return false;\n   }\n \n-  @VisibleForTesting\n-  public LeaderChoosePolicy getLeaderChoosePolicy() {\n-    return leaderChoosePolicy;\n+  private DatanodeDetails getSuggestedLeader(List<DatanodeDetails> dns) {\n+    int minLeaderCount = Integer.MAX_VALUE;\n+    DatanodeDetails suggestedLeader = null;\n+\n+    for (int i = 0; i < dns.size(); i++) {\n+      DatanodeDetails dn = dns.get(i);\n+      if (dn.getSuggestedLeaderCount() < minLeaderCount) {\n+        minLeaderCount = dn.getSuggestedLeaderCount();\n+        suggestedLeader = dn;\n+      }\n+    }\n+\n+    return suggestedLeader;\n   }\n+\n   private List<Integer> getPriorityList(\n       List<DatanodeDetails> dns, DatanodeDetails suggestedLeader) {\n     List<Integer> priorityList = new ArrayList<>();\n \n-    for (DatanodeDetails dn : dns) {\n-      if (dn.getUuid().equals(suggestedLeader.getUuid())) {\n+    for (int i = 0; i < dns.size(); i++) {\n+      if (dns.get(i).getUuid().equals(suggestedLeader.getUuid())) {\n+        dns.get(i).incSuggestedLeaderCount();\n         priorityList.add(HIGH_PRIORITY);\n       } else {\n         priorityList.add(LOW_PRIORITY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUxMjA4Ng==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496512086", "bodyText": "make node manager and pipeline manager be member of leaderChoosePolicy, so that leaderChoosePolicy can has it own state, which will make future extension easier.", "author": "GlenGeng", "createdAt": "2020-09-29T08:15:05Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java", "diffHunk": "@@ -121,18 +158,24 @@ public Pipeline create(ReplicationFactor factor) throws IOException {\n       throw new IllegalStateException(\"Unknown factor: \" + factor.name());\n     }\n \n+    DatanodeDetails suggestedLeader = leaderChoosePolicy.chooseLeader(", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\nindex 29de7b1bf..e7c376fae 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/RatisPipelineProvider.java\n\n@@ -158,8 +157,7 @@ public synchronized Pipeline create(ReplicationFactor factor)\n       throw new IllegalStateException(\"Unknown factor: \" + factor.name());\n     }\n \n-    DatanodeDetails suggestedLeader = leaderChoosePolicy.chooseLeader(\n-        dns, getNodeManager(), getPipelineStateManager());\n+    DatanodeDetails suggestedLeader = getSuggestedLeader(dns);\n \n     Pipeline pipeline = Pipeline.newBuilder()\n         .setId(PipelineID.randomId())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUxNDkzMg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496514932", "bodyText": "why need this change ?  The sequence of sending SCMCommand and removing state may affect SCM HA.", "author": "GlenGeng", "createdAt": "2020-09-29T08:17:41Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java", "diffHunk": "@@ -619,9 +619,9 @@ private void finalizePipeline(PipelineID pipelineId) throws IOException {\n    * @throws IOException\n    */\n   protected void destroyPipeline(Pipeline pipeline) throws IOException {\n-    pipelineFactory.close(pipeline.getType(), pipeline);\n     // remove the pipeline from the pipeline manager\n     removePipeline(pipeline.getId());\n+    pipelineFactory.close(pipeline.getType(), pipeline);", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\nindex f10b47481..352709bdf 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java\n\n@@ -619,9 +619,22 @@ private void finalizePipeline(PipelineID pipelineId) throws IOException {\n    * @throws IOException\n    */\n   protected void destroyPipeline(Pipeline pipeline) throws IOException {\n+    // Make sure decrease leader count happen before BackgroundPipelineCreator\n+    // create new pipeline, so decrease leader count must happen before close\n+    // pipeline. Otherwise, maybe happen the order: close pipeline,\n+    // BackgroundPipelineCreator create new pipeline, decrease leader count,\n+    // and leader distribution will not balance.\n+    if (pipeline != null && pipeline.getSuggestedLeader() != null) {\n+      String suggestedLeader = pipeline.getSuggestedLeader().toString();\n+      DatanodeDetails dn = nodeManager.getNodeByUuid(suggestedLeader);\n+      if (dn != null) {\n+        dn.decSuggestedLeaderCount();\n+      }\n+    }\n+\n+    pipelineFactory.close(pipeline.getType(), pipeline);\n     // remove the pipeline from the pipeline manager\n     removePipeline(pipeline.getId());\n-    pipelineFactory.close(pipeline.getType(), pipeline);\n     triggerPipelineCreation();\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMzUxNg==", "url": "https://github.com/apache/ozone/pull/1371#discussion_r496533516", "bodyText": "I consider that, should move RatisPipelineProvider.getPriorityList(), HIGH_PRIORITY, LOW_PRIORITY here, and replace priorityList in Ctor param as suggestedLeader.\nWe can minimize the existence of priorityList, and the calculation logic of priority in RatisPipelineProvider is a little bit weird.", "author": "GlenGeng", "createdAt": "2020-09-29T08:34:47Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java", "diffHunk": "@@ -39,6 +42,7 @@\n   private final ReplicationFactor factor;\n   private final ReplicationType type;\n   private final List<DatanodeDetails> nodelist;\n+  private final List<Integer> priorityList;", "originalCommit": "317591ba9b3ab855305ad9095381001be4ae298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "dce2d2e2b1fd1ca15d4c9df7ae7cc131f7895554", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\nindex 80495c315..fed59b907 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/commands/CreatePipelineCommand.java\n\n@@ -38,6 +39,9 @@\n public class CreatePipelineCommand\n     extends SCMCommand<CreatePipelineCommandProto> {\n \n+  private static final Integer HIGH_PRIORITY = 1;\n+  private static final Integer LOW_PRIORITY = 0;\n+\n   private final PipelineID pipelineID;\n   private final ReplicationFactor factor;\n   private final ReplicationType type;\n"}}, {"oid": "758a736bf58fbd3122545ce0f64216dcd83f9db2", "url": "https://github.com/apache/ozone/commit/758a736bf58fbd3122545ce0f64216dcd83f9db2", "message": "HDDS-2922. Balance ratis leader distribution in datanodes", "committedDate": "2020-10-06T02:48:51Z", "type": "commit"}, {"oid": "e3e118243193936a7a83353ab94136b99add5ad4", "url": "https://github.com/apache/ozone/commit/e3e118243193936a7a83353ab94136b99add5ad4", "message": "fix code review", "committedDate": "2020-10-06T02:49:22Z", "type": "commit"}, {"oid": "4fb1cb01e58f804c72b6ec79ee86fce382659e22", "url": "https://github.com/apache/ozone/commit/4fb1cb01e58f804c72b6ec79ee86fce382659e22", "message": "change priorityList to static DEFAULT_PRIORITY_LIST", "committedDate": "2020-10-06T02:49:22Z", "type": "commit"}, {"oid": "b4c84fffae0d05bd53fe64fa695830c64ae3805e", "url": "https://github.com/apache/ozone/commit/b4c84fffae0d05bd53fe64fa695830c64ae3805e", "message": "add choose leader policy", "committedDate": "2020-10-06T02:51:16Z", "type": "commit"}, {"oid": "dce2d2e2b1fd1ca15d4c9df7ae7cc131f7895554", "url": "https://github.com/apache/ozone/commit/dce2d2e2b1fd1ca15d4c9df7ae7cc131f7895554", "message": "fix code review", "committedDate": "2020-10-06T04:30:07Z", "type": "forcePushed"}, {"oid": "da9214825b2a6f2b8e79e59c03cf7cf564ffd345", "url": "https://github.com/apache/ozone/commit/da9214825b2a6f2b8e79e59c03cf7cf564ffd345", "message": "fix code review", "committedDate": "2020-10-06T04:48:55Z", "type": "forcePushed"}, {"oid": "4f79a711f525eec16c973fd8af3f416b41620e41", "url": "https://github.com/apache/ozone/commit/4f79a711f525eec16c973fd8af3f416b41620e41", "message": "fix code review", "committedDate": "2020-10-06T06:35:15Z", "type": "forcePushed"}, {"oid": "9ad8da58a2f87b47e8755b32b535971af261af68", "url": "https://github.com/apache/ozone/commit/9ad8da58a2f87b47e8755b32b535971af261af68", "message": "fix code review", "committedDate": "2020-10-06T08:43:18Z", "type": "forcePushed"}, {"oid": "8eee20ed82bd6a667e7be78d3895bf36fc2291f3", "url": "https://github.com/apache/ozone/commit/8eee20ed82bd6a667e7be78d3895bf36fc2291f3", "message": "fix code review", "committedDate": "2020-10-06T08:49:56Z", "type": "forcePushed"}, {"oid": "eefb81936c3c620e4aedeb57dc57f8b4b7cfe831", "url": "https://github.com/apache/ozone/commit/eefb81936c3c620e4aedeb57dc57f8b4b7cfe831", "message": "fix code review", "committedDate": "2020-10-06T08:51:41Z", "type": "forcePushed"}, {"oid": "f573b4a8b45f4463f0bcb95971a45789bda91d5c", "url": "https://github.com/apache/ozone/commit/f573b4a8b45f4463f0bcb95971a45789bda91d5c", "message": "fix code review", "committedDate": "2020-10-06T08:56:35Z", "type": "commit"}, {"oid": "f573b4a8b45f4463f0bcb95971a45789bda91d5c", "url": "https://github.com/apache/ozone/commit/f573b4a8b45f4463f0bcb95971a45789bda91d5c", "message": "fix code review", "committedDate": "2020-10-06T08:56:35Z", "type": "forcePushed"}, {"oid": "e405f4f9d2d967415ac1d89279bf4e2e3e772e09", "url": "https://github.com/apache/ozone/commit/e405f4f9d2d967415ac1d89279bf4e2e3e772e09", "message": "rename RandomLeaderChoosePolicy", "committedDate": "2020-10-07T09:44:11Z", "type": "forcePushed"}, {"oid": "d3a7ad09ccf0dae3c1cc1d962728acf6f13834c5", "url": "https://github.com/apache/ozone/commit/d3a7ad09ccf0dae3c1cc1d962728acf6f13834c5", "message": "rename RandomLeaderChoosePolicy", "committedDate": "2020-10-07T10:56:18Z", "type": "commit"}, {"oid": "d3a7ad09ccf0dae3c1cc1d962728acf6f13834c5", "url": "https://github.com/apache/ozone/commit/d3a7ad09ccf0dae3c1cc1d962728acf6f13834c5", "message": "rename RandomLeaderChoosePolicy", "committedDate": "2020-10-07T10:56:18Z", "type": "forcePushed"}, {"oid": "c264e3734fe4643ddc327254e21249001458ae31", "url": "https://github.com/apache/ozone/commit/c264e3734fe4643ddc327254e21249001458ae31", "message": "triger ci", "committedDate": "2020-10-07T12:11:40Z", "type": "commit"}]}