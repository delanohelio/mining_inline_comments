{"pr_number": 1688, "pr_title": "HDDS-3378. OzoneManager group init failed because of incorrect snapshot directory location.", "pr_createdAt": "2020-12-11T00:44:20Z", "pr_url": "https://github.com/apache/ozone/pull/1688", "timeline": [{"oid": "2ef8451350fdebb5f0de8dc1f7476d0872174e81", "url": "https://github.com/apache/ozone/commit/2ef8451350fdebb5f0de8dc1f7476d0872174e81", "message": "HDDS-3378. OzoneManager group init failed because of incorrect snapshot directory location.", "committedDate": "2020-12-11T21:34:59Z", "type": "commit"}, {"oid": "f404f3d615225d455e315f0611c82c1179bd5b44", "url": "https://github.com/apache/ozone/commit/f404f3d615225d455e315f0611c82c1179bd5b44", "message": "fix cs and java doc", "committedDate": "2020-12-11T21:34:59Z", "type": "commit"}, {"oid": "8b9f7c9c621d800f180acffc31a0d5abc4c124fe", "url": "https://github.com/apache/ozone/commit/8b9f7c9c621d800f180acffc31a0d5abc4c124fe", "message": "fix find bug", "committedDate": "2020-12-11T21:34:59Z", "type": "commit"}, {"oid": "a8ee672cc267e398fbd454eb296817cbdde72066", "url": "https://github.com/apache/ozone/commit/a8ee672cc267e398fbd454eb296817cbdde72066", "message": "add back removed code mistakenly.", "committedDate": "2020-12-11T21:35:00Z", "type": "commit"}, {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825", "url": "https://github.com/apache/ozone/commit/3a2be63d33532cf0739c45568d2e04578ce70825", "message": "fix test", "committedDate": "2020-12-11T21:35:00Z", "type": "commit"}, {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825", "url": "https://github.com/apache/ozone/commit/3a2be63d33532cf0739c45568d2e04578ce70825", "message": "fix test", "committedDate": "2020-12-11T21:35:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczNjg5Mg==", "url": "https://github.com/apache/ozone/pull/1688#discussion_r543736892", "bodyText": "Instead of listing the files and trying to find if snapshot subdir exists, why don't we construct the snapshot subdir path and check it that exists and move it.", "author": "hanishakoneru", "createdAt": "2020-12-15T22:35:13Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -464,16 +465,33 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n             \" must be defined.\");\n       }\n       OmUtils.createOMDir(omRatisDirectory);\n+\n       // Create Ratis snapshot dir\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n+      // Before starting ratis server check, if previous installation has\n+      // snapshot directory in Ratis storage directory if so, move it to\n+      // snapshot directory.\n+      File[] dirs = new File(omRatisDirectory).listFiles();\n+\n+      if (dirs != null) {\n+        for (File dir : dirs) {\n+          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {\n+            FileUtils.moveDirectory(dir.toPath(), omRatisSnapshotDir.toPath());\n+            break;", "originalCommit": "3a2be63d33532cf0739c45568d2e04578ce70825", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxODU0MQ==", "url": "https://github.com/apache/ozone/pull/1688#discussion_r544518541", "bodyText": "Yes, it can be, thanks for the suggestion updated it.", "author": "bharatviswa504", "createdAt": "2020-12-16T18:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczNjg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5a554afa491a06a89c6876281bd64891a672b27d", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\nindex 5501c68952..f530ca4265 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n\n@@ -470,18 +471,15 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n-      // Before starting ratis server check, if previous installation has\n-      // snapshot directory in Ratis storage directory if so, move it to\n-      // snapshot directory.\n-      File[] dirs = new File(omRatisDirectory).listFiles();\n+      // Before starting ratis server, check if previous installation has\n+      // snapshot directory in Ratis storage directory. if yes, move it to\n+      // new snapshot directory.\n \n-      if (dirs != null) {\n-        for (File dir : dirs) {\n-          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {\n-            FileUtils.moveDirectory(dir.toPath(), omRatisSnapshotDir.toPath());\n-            break;\n-          }\n-        }\n+      File snapshotDir = new File(omRatisDirectory, RATIS_SNAPSHOT_DIR);\n+\n+      if (snapshotDir.isDirectory()) {\n+        FileUtils.moveDirectory(snapshotDir.toPath(),\n+            omRatisSnapshotDir.toPath());\n       }\n \n       if (peerNodes != null && !peerNodes.isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczODMyNg==", "url": "https://github.com/apache/ozone/pull/1688#discussion_r543738326", "bodyText": "Can we define \"snapshot\" as a constant in OzoneConsts and use that here and in getOMRatisSnapshotDirectory().", "author": "hanishakoneru", "createdAt": "2020-12-15T22:38:03Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -464,16 +465,33 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n             \" must be defined.\");\n       }\n       OmUtils.createOMDir(omRatisDirectory);\n+\n       // Create Ratis snapshot dir\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n+      // Before starting ratis server check, if previous installation has\n+      // snapshot directory in Ratis storage directory if so, move it to\n+      // snapshot directory.\n+      File[] dirs = new File(omRatisDirectory).listFiles();\n+\n+      if (dirs != null) {\n+        for (File dir : dirs) {\n+          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {", "originalCommit": "3a2be63d33532cf0739c45568d2e04578ce70825", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxODU4NQ==", "url": "https://github.com/apache/ozone/pull/1688#discussion_r544518585", "bodyText": "Done", "author": "bharatviswa504", "createdAt": "2020-12-16T18:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczODMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "5a554afa491a06a89c6876281bd64891a672b27d", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\nindex 5501c68952..f530ca4265 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n\n@@ -470,18 +471,15 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n-      // Before starting ratis server check, if previous installation has\n-      // snapshot directory in Ratis storage directory if so, move it to\n-      // snapshot directory.\n-      File[] dirs = new File(omRatisDirectory).listFiles();\n+      // Before starting ratis server, check if previous installation has\n+      // snapshot directory in Ratis storage directory. if yes, move it to\n+      // new snapshot directory.\n \n-      if (dirs != null) {\n-        for (File dir : dirs) {\n-          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {\n-            FileUtils.moveDirectory(dir.toPath(), omRatisSnapshotDir.toPath());\n-            break;\n-          }\n-        }\n+      File snapshotDir = new File(omRatisDirectory, RATIS_SNAPSHOT_DIR);\n+\n+      if (snapshotDir.isDirectory()) {\n+        FileUtils.moveDirectory(snapshotDir.toPath(),\n+            omRatisSnapshotDir.toPath());\n       }\n \n       if (peerNodes != null && !peerNodes.isEmpty()) {\n"}}, {"oid": "5a554afa491a06a89c6876281bd64891a672b27d", "url": "https://github.com/apache/ozone/commit/5a554afa491a06a89c6876281bd64891a672b27d", "message": "address review comments", "committedDate": "2020-12-16T18:15:26Z", "type": "commit"}, {"oid": "10f8e8766644c89062e831c4e54fc0c28ed4d30f", "url": "https://github.com/apache/ozone/commit/10f8e8766644c89062e831c4e54fc0c28ed4d30f", "message": "rename by adding prefix OM", "committedDate": "2020-12-16T18:17:19Z", "type": "commit"}, {"oid": "6739f1e12eb0989de4aa61d595c8c8046287cd46", "url": "https://github.com/apache/ozone/commit/6739f1e12eb0989de4aa61d595c8c8046287cd46", "message": "update config default explanation", "committedDate": "2020-12-16T18:18:57Z", "type": "commit"}, {"oid": "56adbaeeb56d05b9efa6eac8ed25e1721381e0d4", "url": "https://github.com/apache/ozone/commit/56adbaeeb56d05b9efa6eac8ed25e1721381e0d4", "message": "fix review comment", "committedDate": "2020-12-21T23:24:11Z", "type": "commit"}, {"oid": "47aae9742ac3f65a13c63f8b9381f494c1ecf810", "url": "https://github.com/apache/ozone/commit/47aae9742ac3f65a13c63f8b9381f494c1ecf810", "message": "Merge branch 'master' into HDDS-3378", "committedDate": "2020-12-22T17:11:08Z", "type": "commit"}]}