{"pr_number": 909, "pr_title": "HDDS-3416. Enable TestSCMNodeManager#testScmStatsFromNodeReport", "pr_createdAt": "2020-05-10T15:02:38Z", "pr_url": "https://github.com/apache/ozone/pull/909", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjM4Nw==", "url": "https://github.com/apache/ozone/pull/909#discussion_r424106387", "bodyText": "Shouldn't we find out why the existing NodeReportHandler that is part of the created SCM not getting triggered?", "author": "avijayanhwx", "createdAt": "2020-05-13T00:24:38Z", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java", "diffHunk": "@@ -855,6 +860,10 @@ public void testScmStatsFromNodeReport()\n         String storagePath = testDir.getAbsolutePath() + \"/\" + dnId;\n         StorageReportProto report = TestUtils\n             .createStorageReport(dnId, storagePath, capacity, used, free, null);\n+        NodeReportProto nodeReportProto = TestUtils.createNodeReport(report);\n+        nodeReportHandler.onMessage(", "originalCommit": "5a3fcc80a3acdd7555997c3bb5312b02d8446e90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwOTMyMQ==", "url": "https://github.com/apache/ozone/pull/909#discussion_r425309321", "bodyText": "@cku328 Thanks for the refactoring. I looked at the description of the test, and the what we are trying to validate. The test is meant to validate the logic to process a NodeReport correctly. It is not meant to validate whether a Node report is processed IF a heartbeat is got. Hence, I am OK with either of your patches - Using nodeReportHandler.onMessage or using nodeManager.processNodeReport. Maybe it is better to use the onMessage to keep it consistent with the other test you recently fixed. what do you think?", "author": "avijayanhwx", "createdAt": "2020-05-14T17:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU3MDAxOQ==", "url": "https://github.com/apache/ozone/pull/909#discussion_r429570019", "bodyText": "Thanks @avijayanhwx for the comment, I changed some code so that NodeReport can be sent out with the initial heartbeat. I confirmed the NodeReportHandler in SCM is working properly and it can be triggered to process node reports from multiple nodes.", "author": "cku328", "createdAt": "2020-05-23T18:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwNjM4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d93e5d2189e617791cf4cec0df0c045abfacf8ad", "chunk": "diff --git a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\nindex 789b56c55b..dd8fcf7d38 100644\n--- a/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\n+++ b/hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java\n\n@@ -861,9 +859,7 @@ public void testScmStatsFromNodeReport()\n         StorageReportProto report = TestUtils\n             .createStorageReport(dnId, storagePath, capacity, used, free, null);\n         NodeReportProto nodeReportProto = TestUtils.createNodeReport(report);\n-        nodeReportHandler.onMessage(\n-                new NodeReportFromDatanode(datanodeDetails, nodeReportProto),\n-                publisher);\n+        nodeManager.processNodeReport(datanodeDetails,nodeReportProto);\n         nodeManager.processHeartbeat(datanodeDetails);\n       }\n       //TODO: wait for heartbeat to be processed\n"}}, {"oid": "d93e5d2189e617791cf4cec0df0c045abfacf8ad", "url": "https://github.com/apache/ozone/commit/d93e5d2189e617791cf4cec0df0c045abfacf8ad", "message": "modify process node report method", "committedDate": "2020-05-13T08:37:59Z", "type": "forcePushed"}, {"oid": "c5edb4f950dc0b3e1806ac2a88d8dea6206021e5", "url": "https://github.com/apache/ozone/commit/c5edb4f950dc0b3e1806ac2a88d8dea6206021e5", "message": "HDDS-3416. Enable TestSCMNodeManager#testScmStatsFromNodeReport", "committedDate": "2020-05-23T18:41:53Z", "type": "commit"}, {"oid": "7347a86994772f6b2b0e3e44c604f7bc24dd6b06", "url": "https://github.com/apache/ozone/commit/7347a86994772f6b2b0e3e44c604f7bc24dd6b06", "message": "Modify code for node register", "committedDate": "2020-05-23T18:56:29Z", "type": "commit"}, {"oid": "7347a86994772f6b2b0e3e44c604f7bc24dd6b06", "url": "https://github.com/apache/ozone/commit/7347a86994772f6b2b0e3e44c604f7bc24dd6b06", "message": "Modify code for node register", "committedDate": "2020-05-23T18:56:29Z", "type": "forcePushed"}, {"oid": "bd2a4014463379f95751ec22e7453c293c03b63f", "url": "https://github.com/apache/ozone/commit/bd2a4014463379f95751ec22e7453c293c03b63f", "message": "fix checkstyle", "committedDate": "2020-05-23T19:15:54Z", "type": "commit"}]}