{"pr_number": 1645, "pr_title": "HDDS-4463. Verify that OM/SCM start fails when Software Layout Version < Metadata Layout Version.", "pr_createdAt": "2020-12-01T15:55:29Z", "pr_url": "https://github.com/apache/ozone/pull/1645", "timeline": [{"oid": "6ad26b017930b879e9478e7271a9418e522ed8cc", "url": "https://github.com/apache/ozone/commit/6ad26b017930b879e9478e7271a9418e522ed8cc", "message": "First draft of tests", "committedDate": "2020-11-14T00:10:05Z", "type": "commit"}, {"oid": "0f0ef7076fcab05744fe2bcbf6aca3fa69cad17d", "url": "https://github.com/apache/ozone/commit/0f0ef7076fcab05744fe2bcbf6aca3fa69cad17d", "message": "Switch javadoc at top to normal comment", "committedDate": "2020-11-16T14:41:35Z", "type": "commit"}, {"oid": "c28380ea4f73647f038fc44d84d4e4cdb93ffc3f", "url": "https://github.com/apache/ozone/commit/c28380ea4f73647f038fc44d84d4e4cdb93ffc3f", "message": "Add comments and minor fixes", "committedDate": "2020-11-16T16:31:59Z", "type": "commit"}, {"oid": "d06b88c9d7a53ee04008f6eee9be6019db28a119", "url": "https://github.com/apache/ozone/commit/d06b88c9d7a53ee04008f6eee9be6019db28a119", "message": "Add base version file to test resources", "committedDate": "2020-11-16T16:32:22Z", "type": "commit"}, {"oid": "814df79f85ca66a3e9a475be22cc79ddecceecfb", "url": "https://github.com/apache/ozone/commit/814df79f85ca66a3e9a475be22cc79ddecceecfb", "message": "Add separate test and utils for SCM", "committedDate": "2020-11-17T12:20:54Z", "type": "commit"}, {"oid": "b689978a62e5fe750009d852bc03c043522af7cc", "url": "https://github.com/apache/ozone/commit/b689978a62e5fe750009d852bc03c043522af7cc", "message": "MLV > SLV test passes for SCM", "committedDate": "2020-11-25T21:30:08Z", "type": "commit"}, {"oid": "8d383418c616921582f58d743c703a951da53f67", "url": "https://github.com/apache/ozone/commit/8d383418c616921582f58d743c703a951da53f67", "message": "Merge branch 'HDDS-3698-upgrade' into HDDS-4463\n\n* HDDS-3698-upgrade: (47 commits)\n  HDDS-4468. Fix Goofys listBucket large than 1000 objects will stuck forever (#1595)\n  HDDS-4417. Simplify Ozone client code with configuration object -- addendum (#1581)\n  HDDS-4476. Improve the ZH translation of the HA.md in doc. (#1597)\n  HDDS-4432. Update Ratis version to latest snapshot. (#1586)\n  HDDS-4488. Open RocksDB read only when loading containers at Datanode startup (#1605)\n  HDDS-4478. Large deletedKeyset slows down OM via listStatus. (#1598)\n  HDDS-4452. findbugs.sh couldn't be executed after a full build (#1576)\n  HDDS-4427. Avoid ContainerCache in ContainerReader at Datanode startup (#1549)\n  HDDS-4448. Duplicate refreshPipeline in listStatus (#1569)\n  HDDS-4450. Cannot run ozone if HADOOP_HOME points to Hadoop install (#1572)\n  HDDS-4346.Ozone specific Trash Policy (#1535)\n  HDDS-4426. SCM should create transactions using all blocks received from OM (#1561)\n  HDDS-4399. Safe mode rule for piplelines should only consider open pipelines. (#1526)\n  HDDS-4367. Configuration for deletion service intervals should be different for OM, SCM and datanodes (#1573)\n  HDDS-4462. Add --frozen-lockfile to pnpm install to prevent ozone-recon-web/pnpm-lock.yaml from being updated automatically (#1589)\n  HDDS-4082. Create ZH translation of HA.md in doc. (#1591)\n  HDDS-4464. Upgrade httpclient version due to CVE-2020-13956. (#1590)\n  HDDS-4467. Acceptance test fails due to new Hadoop 3 image (#1594)\n  HDDS-4466. Update url in .asf.yaml to use TLP project (#1592)\n  HDDS-4458. Fix Max Transaction ID value in OM. (#1585)\n  ...", "committedDate": "2020-11-25T22:24:51Z", "type": "commit"}, {"oid": "d75b923e4035cdc890b01578cc972c75ab87fd4a", "url": "https://github.com/apache/ozone/commit/d75b923e4035cdc890b01578cc972c75ab87fd4a", "message": "Move version file test utils to a util class in upgrade", "committedDate": "2020-11-25T22:42:46Z", "type": "commit"}, {"oid": "efbc5608d68176851e4bf174618e1d7953a2c787", "url": "https://github.com/apache/ozone/commit/efbc5608d68176851e4bf174618e1d7953a2c787", "message": "Add unit test for datanode slv < mlv\n\nFixed typo in OzoneConsts that was causing test to fail.", "committedDate": "2020-11-25T22:43:33Z", "type": "commit"}, {"oid": "6eb20bee67d9d062d44712558908a7d0e521c1e4", "url": "https://github.com/apache/ozone/commit/6eb20bee67d9d062d44712558908a7d0e521c1e4", "message": "Use existing exception message assertion from GenericTestUtils", "committedDate": "2020-11-30T18:13:13Z", "type": "commit"}, {"oid": "69637b57988681bdf85f0a65f57e790dfd3e256b", "url": "https://github.com/apache/ozone/commit/69637b57988681bdf85f0a65f57e790dfd3e256b", "message": "Add integration test for slv < mlv on OM startup", "committedDate": "2020-11-30T21:48:23Z", "type": "commit"}, {"oid": "ff3c295b68261239e8db8b5d2971bd336d295f3d", "url": "https://github.com/apache/ozone/commit/ff3c295b68261239e8db8b5d2971bd336d295f3d", "message": "Add comments", "committedDate": "2020-11-30T21:57:58Z", "type": "commit"}, {"oid": "5014ec983562b75f8efbac438bc66acf42ed875a", "url": "https://github.com/apache/ozone/commit/5014ec983562b75f8efbac438bc66acf42ed875a", "message": "Merge branch 'HDDS-3698-upgrade' into HDDS-4463\n\n* HDDS-3698-upgrade:\n  HDDS-4429. Create unit test for SimpleContainerDownloader. (#1551)\n  HDDS-4461. Reuse compiled binaries in acceptance test (#1588)\n  HDDS-4511: Avoiding StaleNodeHandler to take effect in TestDeleteWithSlowFollower. (#1625)\n  HDDS-4510. SCM can avoid creating RetriableDatanodeEventWatcher for deletion command ACK (#1626)\n  HDDS-3363. Intermittent failure in testContainerImportExport (#1618)\n  HDDS-4370. Datanode deletion service can avoid storing deleted blocks. (#1620)\n  HDDS-4512. Remove unused netty3 transitive dependency (#1627)\n  HDDS-4481. With HA OM can send deletion blocks to SCM multiple times. (#1608)\n  HDDS-4487. SCM can avoid using RETRIABLE_DATANODE_COMMAND for datanode deletion commands. (#1621)\n  HDDS-4471. GrpcOutputStream length can overflow (#1617)\n  HDDS-4308. Fix issue with quota update (#1489)\n  HDDS-4392. [DOC] Add Recon architecture to docs (#1602)\n  HDDS-4501. Reload OM State fail should terminate OM for any exceptions. (#1622)\n  HDDS-4492. CLI flag --quota should default to 'spaceQuota' to preserve backward compatibility. (#1609)\n  HDDS-3689. Add various profiles to MiniOzoneChaosCluster to run different modes. (#1420)\n  HDDS-4497. Recon File Size Count task throws SQL Exception. (#1612)", "committedDate": "2020-12-01T15:34:43Z", "type": "commit"}, {"oid": "6a1239463112c7b33e6fc9f5a0d0a185b2d0dac8", "url": "https://github.com/apache/ozone/commit/6a1239463112c7b33e6fc9f5a0d0a185b2d0dac8", "message": "Fix checkstyle violations", "committedDate": "2020-12-01T15:50:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU5NjA0Ng==", "url": "https://github.com/apache/ozone/pull/1645#discussion_r533596046", "bodyText": "Changing this may break backward compatibility in the Datanode since the value of this constant is written down to and read from the Version file. We can either leave it as it is, or make sure that the writers always use \"layoutVersion\", and the readers fall back to \"layOutVersion\" if the default is not present.", "author": "avijayanhwx", "createdAt": "2020-12-01T17:34:29Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -43,7 +43,7 @@\n   public static final String STORAGE_ID = \"storageID\";\n   public static final String DATANODE_UUID = \"datanodeUuid\";\n   public static final String CLUSTER_ID = \"clusterID\";\n-  public static final String LAYOUTVERSION = \"layOutVersion\";\n+  public static final String LAYOUTVERSION = \"layoutVersion\";", "originalCommit": "6a1239463112c7b33e6fc9f5a0d0a185b2d0dac8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b5af43d5c2e23a966b69ad3286e90b525f4ea6a8", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java\nindex 785cbfa16..a7aca164b 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java\n\n@@ -43,7 +43,7 @@\n   public static final String STORAGE_ID = \"storageID\";\n   public static final String DATANODE_UUID = \"datanodeUuid\";\n   public static final String CLUSTER_ID = \"clusterID\";\n-  public static final String LAYOUTVERSION = \"layoutVersion\";\n+  public static final String LAYOUTVERSION = \"layOutVersion\";\n   public static final String CTIME = \"ctime\";\n   /*\n    * BucketName length is used for both buckets and volume lengths\n"}}, {"oid": "b5af43d5c2e23a966b69ad3286e90b525f4ea6a8", "url": "https://github.com/apache/ozone/commit/b5af43d5c2e23a966b69ad3286e90b525f4ea6a8", "message": "Use DatanodeVersionFile instead of StorageInfo for DN tests\n\nThis test currently fails, because there is one DN version file per volume.\nIf all version files have a bad layout version, none of the volumes are used\nand we get an out of space exception.", "committedDate": "2020-12-01T22:35:09Z", "type": "commit"}, {"oid": "49c02287deba7424256281803099af3ea7c3d59a", "url": "https://github.com/apache/ozone/commit/49c02287deba7424256281803099af3ea7c3d59a", "message": "Remove datanode startup test\n\nLogic for DN version files needs to be implemented differently before we will proceed with this test.", "committedDate": "2020-12-01T22:42:54Z", "type": "commit"}, {"oid": "d050cfc7e6c80e26eda356ca823f1b64d220de1b", "url": "https://github.com/apache/ozone/commit/d050cfc7e6c80e26eda356ca823f1b64d220de1b", "message": "Move SCM tests to their own class\n\nToo many issues trying to run the test from the TestStorageContainerManager class.", "committedDate": "2020-12-02T17:33:16Z", "type": "commit"}]}