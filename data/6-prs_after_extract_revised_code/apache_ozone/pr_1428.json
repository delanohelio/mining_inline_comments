{"pr_number": 1428, "pr_title": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names", "pr_createdAt": "2020-09-16T10:54:13Z", "pr_url": "https://github.com/apache/ozone/pull/1428", "timeline": [{"oid": "62c75a414f18e1028342a33658348826dff1b1b0", "url": "https://github.com/apache/ozone/commit/62c75a414f18e1028342a33658348826dff1b1b0", "message": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names", "committedDate": "2020-09-17T02:35:07Z", "type": "commit"}, {"oid": "62c75a414f18e1028342a33658348826dff1b1b0", "url": "https://github.com/apache/ozone/commit/62c75a414f18e1028342a33658348826dff1b1b0", "message": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names", "committedDate": "2020-09-17T02:35:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODMxMw==", "url": "https://github.com/apache/ozone/pull/1428#discussion_r495538313", "bodyText": "Could we move this self validation to an overall IP validation method so that we could throw in more validation once we are getting close to the ultimate HA config version?", "author": "timmylicheng", "createdAt": "2020-09-27T07:03:05Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java", "diffHunk": "@@ -59,18 +68,62 @@\n   SCMRatisServerImpl(final SCMHAConfiguration haConf,\n                      final ConfigurationSource conf)\n       throws IOException {\n-    final String scmServiceId = \"SCM-HA-Service\";\n-    final String scmNodeId = \"localhost\";\n-    this.raftPeerId = RaftPeerId.getRaftPeerId(scmNodeId);\n+    // If the SCM group starts from OZONE_SCM_NAMES, its raft peers\n+    // should locate on different nodes, and use the same port to\n+    // communicate with each other.\n+    //\n+    // Assume ozone.scm.names is \"ip0,ip1,ip2\", scm with ip0 identifies\n+    // its RaftPeerId as scm0, scm with ip1 identifies its RaftPeerId\n+    // as scm1, scm with ip2 identifies its RaftPeerId as scm2. After\n+    // startup, they will communicate with each other via\n+    // ozone.scm.ha.ratis.bind.port, and form a raft group with\n+    // groupID \"SCM-HA-Service\".\n+    List<String> scmHosts =\n+        Arrays.stream(conf.getTrimmedStrings(ScmConfigKeys.OZONE_SCM_NAMES))\n+            .map(scmName -> HddsUtils.getHostName(scmName).get())\n+            .collect(Collectors.toList());\n+\n     this.address = haConf.getRatisBindAddress();\n-    final RaftPeer localRaftPeer = new RaftPeer(raftPeerId, address);\n+    InetAddress localHost = InetAddress.getLocalHost();\n+\n+    int selfIndex = -1;", "originalCommit": "62c75a414f18e1028342a33658348826dff1b1b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ca9cb783fe5a8d7a7ac2119acad657374231b115", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java\nindex 0384657409..8611b1fb59 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java\n\n@@ -62,65 +62,17 @@\n   private final ClientId clientId = ClientId.randomId();\n   private final AtomicLong callId = new AtomicLong();\n \n-\n   // TODO: Refactor and remove ConfigurationSource and use only\n   //  SCMHAConfiguration.\n   SCMRatisServerImpl(final SCMHAConfiguration haConf,\n                      final ConfigurationSource conf)\n       throws IOException {\n-    // If the SCM group starts from OZONE_SCM_NAMES, its raft peers\n-    // should locate on different nodes, and use the same port to\n-    // communicate with each other.\n-    //\n-    // Assume ozone.scm.names is \"ip0,ip1,ip2\", scm with ip0 identifies\n-    // its RaftPeerId as scm0, scm with ip1 identifies its RaftPeerId\n-    // as scm1, scm with ip2 identifies its RaftPeerId as scm2. After\n-    // startup, they will communicate with each other via\n-    // ozone.scm.ha.ratis.bind.port, and form a raft group with\n-    // groupID \"SCM-HA-Service\".\n-    List<String> scmHosts =\n-        Arrays.stream(conf.getTrimmedStrings(ScmConfigKeys.OZONE_SCM_NAMES))\n-            .map(scmName -> HddsUtils.getHostName(scmName).get())\n-            .collect(Collectors.toList());\n-\n     this.address = haConf.getRatisBindAddress();\n-    InetAddress localHost = InetAddress.getLocalHost();\n-\n-    int selfIndex = -1;\n-    RaftPeerId selfPeerId = null;\n-    final List<RaftPeer> raftPeers = new ArrayList<>();\n \n-    for (int i = 0; i < scmHosts.size(); ++i) {\n-      String scmNodeId = \"scm\" + i;\n-      RaftPeerId scmPeerId = RaftPeerId.getRaftPeerId(scmNodeId);\n-\n-      String scmHost = scmHosts.get(i);\n-      if (InetAddress.getByName(scmHost).equals(localHost)) {\n-        selfIndex = i;\n-        selfPeerId = scmPeerId;\n-      }\n-\n-      raftPeers.add(new RaftPeer(\n-          scmPeerId, scmHost + \":\" + address.getPort()));\n-    }\n-\n-    if (selfIndex == -1) {\n-      String errorMessage = \"localhost \" +  localHost\n-          + \" does not exist in ozone.scm.names \"\n-          + conf.get(ScmConfigKeys.OZONE_SCM_NAMES);\n-      throw new IOException(errorMessage);\n-    }\n-\n-    LOG.info(\"SCMRatisServer started, \" +\n-        \"localHost: {}, OZONE_SCM_NAMES: {}, selfIndex: {}\",\n-        localHost, conf.get(ScmConfigKeys.OZONE_SCM_NAMES), selfIndex);\n-\n-    this.raftPeerId = selfPeerId;\n-\n-    final String scmServiceId = \"SCM-HA-Service\";\n-    this.raftGroupId = RaftGroupId.valueOf(\n-        UUID.nameUUIDFromBytes(scmServiceId.getBytes(StandardCharsets.UTF_8)));\n-    this.raftGroup = RaftGroup.valueOf(raftGroupId, raftPeers);\n+    SCMHAGroupBuilder scmHAGroupBuilder = new SCMHAGroupBuilder(haConf, conf);\n+    this.raftPeerId = scmHAGroupBuilder.getPeerId();\n+    this.raftGroupId = scmHAGroupBuilder.getRaftGroupId();\n+    this.raftGroup = scmHAGroupBuilder.getRaftGroup();\n \n     final RaftProperties serverProperties = RatisUtil\n         .newRaftProperties(haConf, conf);\n"}}, {"oid": "ca9cb783fe5a8d7a7ac2119acad657374231b115", "url": "https://github.com/apache/ozone/commit/ca9cb783fe5a8d7a7ac2119acad657374231b115", "message": "HDDS-4192: Fix comments", "committedDate": "2020-10-09T10:34:58Z", "type": "forcePushed"}, {"oid": "5ebf168d478fb572ac583b51f181a38affe59114", "url": "https://github.com/apache/ozone/commit/5ebf168d478fb572ac583b51f181a38affe59114", "message": "HDDS-4192: fix comments", "committedDate": "2020-10-09T11:14:56Z", "type": "commit"}, {"oid": "5ebf168d478fb572ac583b51f181a38affe59114", "url": "https://github.com/apache/ozone/commit/5ebf168d478fb572ac583b51f181a38affe59114", "message": "HDDS-4192: fix comments", "committedDate": "2020-10-09T11:14:56Z", "type": "forcePushed"}, {"oid": "77751832fc88e98001c22e65b8aaff3e8d802198", "url": "https://github.com/apache/ozone/commit/77751832fc88e98001c22e65b8aaff3e8d802198", "message": "Merge remote-tracking branch 'github/HDDS-2823' into HDDS-4192.", "committedDate": "2020-10-09T12:59:49Z", "type": "commit"}, {"oid": "77751832fc88e98001c22e65b8aaff3e8d802198", "url": "https://github.com/apache/ozone/commit/77751832fc88e98001c22e65b8aaff3e8d802198", "message": "Merge remote-tracking branch 'github/HDDS-2823' into HDDS-4192.", "committedDate": "2020-10-09T12:59:49Z", "type": "forcePushed"}]}