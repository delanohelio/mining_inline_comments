{"pr_number": 666, "pr_title": "HDDS-2848. Recon changes to make snapshots work with OM HA.", "pr_createdAt": "2020-03-11T23:51:07Z", "pr_url": "https://github.com/apache/ozone/pull/666", "timeline": [{"oid": "680de7987979c2ed420f1a334be3d8505c911908", "url": "https://github.com/apache/ozone/commit/680de7987979c2ed420f1a334be3d8505c911908", "message": "HDDS-2848. Recon changes to make snapshots work with OM HA.", "committedDate": "2020-03-11T23:49:37Z", "type": "commit"}, {"oid": "52a69090a4ea23c59e0a43be45a26e32e056cdef", "url": "https://github.com/apache/ozone/commit/52a69090a4ea23c59e0a43be45a26e32e056cdef", "message": "HDDS-2848. Checkstyle fixes.", "committedDate": "2020-03-12T00:19:45Z", "type": "commit"}, {"oid": "2368839aa86a5e49cec5e72e57be4159b6d913de", "url": "https://github.com/apache/ozone/commit/2368839aa86a5e49cec5e72e57be4159b6d913de", "message": "HDDS-2848. Checkstyle fix.", "committedDate": "2020-03-12T00:24:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4ODQ3NQ==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391388475", "bodyText": "We don't need to set the Recon HTTP and RPC port. By default a free port is assigned. The setters are needed in case the test needs to know the port that was assigned.", "author": "avijayanhwx", "createdAt": "2020-03-12T03:52:07Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.recon;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.OZONE_OM_DB_CHECKPOINT_HTTP_ENDPOINT;\n+\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.net.NetUtils;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.MiniOzoneHAClusterImpl;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.om.OMConfigKeys;\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.recon.spi.impl.OzoneManagerServiceProviderImpl;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.Timeout;\n+\n+/**\n+ * This class sets up a MiniOzoneHACluster to test with Recon.\n+ */\n+public class TestReconWithOzoneManagerHA {\n+  @Rule\n+  public Timeout timeout = new Timeout(300_000);\n+\n+  private MiniOzoneHAClusterImpl cluster;\n+  private ObjectStore objectStore;\n+  private final String omServiceId = \"omService1\";\n+\n+  @Before\n+  public void setup() throws Exception {\n+    OzoneConfiguration conf = new OzoneConfiguration();\n+    conf.set(OMConfigKeys.OZONE_OM_RATIS_ENABLE_KEY, Boolean.TRUE.toString());\n+    cluster = (MiniOzoneHAClusterImpl) MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(UUID.randomUUID().toString())\n+        .setScmId(UUID.randomUUID().toString())\n+        .setOMServiceId(omServiceId)\n+        .setNumDatanodes(1)\n+        .setNumOfOzoneManagers(3)\n+        .includeRecon(true)\n+        .setReconHttpPort(NetUtils.getFreeSocketPort())", "originalCommit": "2368839aa86a5e49cec5e72e57be4159b6d913de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MzI0NQ==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391393245", "bodyText": "Fair enough.", "author": "swagle", "createdAt": "2020-03-12T04:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4ODQ3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "eb9bf298fca2918e3a87a221c703541f85b9b992", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\nindex 2d55deac6a..4ed64329c2 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\n\n@@ -61,8 +61,6 @@ public void setup() throws Exception {\n         .setNumDatanodes(1)\n         .setNumOfOzoneManagers(3)\n         .includeRecon(true)\n-        .setReconHttpPort(NetUtils.getFreeSocketPort())\n-        .setReconDatanodePort(NetUtils.getFreeSocketPort())\n         .build();\n     cluster.waitForClusterToBeReady();\n     objectStore = OzoneClientFactory.getRpcClient(omServiceId, conf)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MTU5MA==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391391590", "bodyText": "Do we need to trigger an OM DB sync here and see if the sync is working?", "author": "avijayanhwx", "createdAt": "2020-03-12T04:08:09Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.recon;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.OZONE_OM_DB_CHECKPOINT_HTTP_ENDPOINT;\n+\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.net.NetUtils;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.MiniOzoneHAClusterImpl;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.om.OMConfigKeys;\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.recon.spi.impl.OzoneManagerServiceProviderImpl;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.Timeout;\n+\n+/**\n+ * This class sets up a MiniOzoneHACluster to test with Recon.\n+ */\n+public class TestReconWithOzoneManagerHA {\n+  @Rule\n+  public Timeout timeout = new Timeout(300_000);\n+\n+  private MiniOzoneHAClusterImpl cluster;\n+  private ObjectStore objectStore;\n+  private final String omServiceId = \"omService1\";\n+\n+  @Before\n+  public void setup() throws Exception {\n+    OzoneConfiguration conf = new OzoneConfiguration();\n+    conf.set(OMConfigKeys.OZONE_OM_RATIS_ENABLE_KEY, Boolean.TRUE.toString());\n+    cluster = (MiniOzoneHAClusterImpl) MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(UUID.randomUUID().toString())\n+        .setScmId(UUID.randomUUID().toString())\n+        .setOMServiceId(omServiceId)\n+        .setNumDatanodes(1)\n+        .setNumOfOzoneManagers(3)\n+        .includeRecon(true)\n+        .setReconHttpPort(NetUtils.getFreeSocketPort())\n+        .setReconDatanodePort(NetUtils.getFreeSocketPort())\n+        .build();\n+    cluster.waitForClusterToBeReady();\n+    objectStore = OzoneClientFactory.getRpcClient(omServiceId, conf)\n+        .getObjectStore();\n+  }\n+\n+  @After\n+  public void tearDown() throws Exception {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void testReconGetsSnapshotFromLeader() throws Exception {\n+    AtomicReference<OzoneManager> ozoneManager = new AtomicReference<>();\n+    // Wait for OM leader election to finish\n+    GenericTestUtils.waitFor(() -> {\n+      OzoneManager om = cluster.getOMLeader();\n+      ozoneManager.set(om);\n+      return om != null;\n+    }, 100, 120000);\n+    Assert.assertNotNull(\"Timed out waiting OM leader election to finish: \"\n+        + \"no leader or more than one leader.\", ozoneManager);\n+    Assert.assertTrue(\"Should have gotten the leader!\",\n+        ozoneManager.get().isLeader());\n+\n+    OzoneManagerServiceProviderImpl impl = (OzoneManagerServiceProviderImpl)\n+        cluster.getReconServer().getOzoneManagerServiceProvider();\n+\n+    String hostname =\n+        ozoneManager.get().getHttpServer().getHttpAddress().getHostName();\n+    String expectedUrl = \"http://\" +\n+        (hostname.equals(\"0.0.0.0\") ? \"localhost\" : hostname) + \":\" +\n+        ozoneManager.get().getHttpServer().getHttpAddress().getPort() +\n+        OZONE_OM_DB_CHECKPOINT_HTTP_ENDPOINT;\n+    String snapshotUrl = impl.getOzoneManagerSnapshotUrl();\n+    Assert.assertEquals(\"OM Snapshot should be requested from the leader.\",\n+        expectedUrl, snapshotUrl);", "originalCommit": "2368839aa86a5e49cec5e72e57be4159b6d913de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MzQxMA==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391393410", "bodyText": "I intended to test only changes I made but this Test class I envision can easily extend to add more tests for HA but those can be separate Jiras, IMO.", "author": "swagle", "createdAt": "2020-03-12T04:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MTU5MA=="}], "type": "inlineReview", "revised_code": {"commit": "eb9bf298fca2918e3a87a221c703541f85b9b992", "chunk": "diff --git a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\nindex 2d55deac6a..4ed64329c2 100644\n--- a/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\n+++ b/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/recon/TestReconWithOzoneManagerHA.java\n\n@@ -61,8 +61,6 @@ public void setup() throws Exception {\n         .setNumDatanodes(1)\n         .setNumOfOzoneManagers(3)\n         .includeRecon(true)\n-        .setReconHttpPort(NetUtils.getFreeSocketPort())\n-        .setReconDatanodePort(NetUtils.getFreeSocketPort())\n         .build();\n     cluster.waitForClusterToBeReady();\n     objectStore = OzoneClientFactory.getRpcClient(omServiceId, conf)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MTg4Mg==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391391882", "bodyText": "For single node RATIS, we can still use the regular URL.", "author": "avijayanhwx", "createdAt": "2020-03-12T04:09:48Z", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/spi/impl/OzoneManagerServiceProviderImpl.java", "diffHunk": "@@ -237,19 +241,47 @@ public void stop() throws Exception {\n     scheduler.shutdownNow();\n   }\n \n+  /**\n+   * Find the OM leader's address to get the snapshot from.\n+   */\n+  @VisibleForTesting\n+  public String getOzoneManagerSnapshotUrl() throws IOException {\n+    if (!configuration.getBoolean(\n+        OMConfigKeys.OZONE_OM_RATIS_ENABLE_KEY, false)) {", "originalCommit": "2368839aa86a5e49cec5e72e57be4159b6d913de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MzU3NQ==", "url": "https://github.com/apache/ozone/pull/666#discussion_r391393575", "bodyText": "OM AFAIK is either 3 node RATIS or no HA based on this configuration, although not sure why we cannot check, the result should be the same.", "author": "swagle", "createdAt": "2020-03-12T04:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM5MTg4Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "eb9bf298fca2918e3a87a221c703541f85b9b992", "url": "https://github.com/apache/ozone/commit/eb9bf298fca2918e3a87a221c703541f85b9b992", "message": "Review comment addressed.", "committedDate": "2020-03-12T04:42:58Z", "type": "commit"}, {"oid": "636b12befcbfb2d37b700359e1e0d98841ff1abb", "url": "https://github.com/apache/ozone/commit/636b12befcbfb2d37b700359e1e0d98841ff1abb", "message": "Unused import.", "committedDate": "2020-03-12T04:45:45Z", "type": "commit"}, {"oid": "854291b5825bf0483aa5358d22f8e132fdce5488", "url": "https://github.com/apache/ozone/commit/854291b5825bf0483aa5358d22f8e132fdce5488", "message": "Verify snapshot is synced to Recon.", "committedDate": "2020-03-12T23:06:57Z", "type": "commit"}, {"oid": "de29759209906633ea32f06b8ad8f37262c598b8", "url": "https://github.com/apache/ozone/commit/de29759209906633ea32f06b8ad8f37262c598b8", "message": "Minor whitespace fix.", "committedDate": "2020-03-13T04:04:11Z", "type": "commit"}, {"oid": "531b4b5cdd2e7844eae2d87f6bcfe02dbad37169", "url": "https://github.com/apache/ozone/commit/531b4b5cdd2e7844eae2d87f6bcfe02dbad37169", "message": "trigger new CI check", "committedDate": "2020-03-13T20:55:51Z", "type": "commit"}]}