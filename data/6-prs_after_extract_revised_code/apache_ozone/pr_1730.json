{"pr_number": 1730, "pr_title": "HDDS-4619. Intermittent error exporting same container to multiple datanodes", "pr_createdAt": "2020-12-23T12:47:55Z", "pr_url": "https://github.com/apache/ozone/pull/1730", "timeline": [{"oid": "fc8ef1aa3f23ad4090121853430cd1cda0b85776", "url": "https://github.com/apache/ozone/commit/fc8ef1aa3f23ad4090121853430cd1cda0b85776", "message": "HDDS-4619. Intermittent error exporting same container to multiple datanodes", "committedDate": "2020-12-22T15:05:44Z", "type": "commit"}, {"oid": "aa7ddab10e77d9160fb335500df4f979c962156c", "url": "https://github.com/apache/ozone/commit/aa7ddab10e77d9160fb335500df4f979c962156c", "message": "HDDS-4619. Add unit test", "committedDate": "2020-12-23T08:52:13Z", "type": "commit"}, {"oid": "d7f9606ba84a01dfee191515b15758716587b224", "url": "https://github.com/apache/ozone/commit/d7f9606ba84a01dfee191515b15758716587b224", "message": "HDDS-4619. Downgrade lock after compaction", "committedDate": "2020-12-23T09:32:28Z", "type": "commit"}, {"oid": "d7a9e7a3e85d515cf45960ec041838b07916e2b9", "url": "https://github.com/apache/ozone/commit/d7a9e7a3e85d515cf45960ec041838b07916e2b9", "message": "Fix checkstyle", "committedDate": "2020-12-23T10:35:52Z", "type": "commit"}, {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946", "url": "https://github.com/apache/ozone/commit/1ae7e06f27a0efefb9252eb99d7da912f7793946", "message": "Downgrade lock in case of exception, too", "committedDate": "2021-01-04T12:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg==", "url": "https://github.com/apache/ozone/pull/1730#discussion_r552958106", "bodyText": "The exception here should be a rare occurrence, so we are almost always going to have to escalate the read lock into a write lock. I think it would be simpler to just take the write lock at the start and forget about the read lock.\nThe part of the code under the read lock should be very fast, and the code under the write lock may be slow (compactDB) so I suspect we are saving very little by doing some work under the read lock. I think this lock is also only for this container (not for all containers on the DN) so contention should not be a big issue.\nWhat do you think?", "author": "sodonnel", "createdAt": "2021-01-06T20:58:38Z", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "originalCommit": "1ae7e06f27a0efefb9252eb99d7da912f7793946", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3OTIxNA==", "url": "https://github.com/apache/ozone/pull/1730#discussion_r552979214", "bodyText": "Agreed, the first read lock can be removed.  I think we need to keep the second one, though (for packer.pack()).", "author": "adoroszlai", "createdAt": "2021-01-06T21:53:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA5NDYwOQ==", "url": "https://github.com/apache/ozone/pull/1730#discussion_r553094609", "bodyText": "Agreed, the first read lock can be removed. I think we need to keep the second one, though (for packer.pack()).\n\nAgree +1", "author": "lamberken", "createdAt": "2021-01-07T03:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzM3NDQyNQ==", "url": "https://github.com/apache/ozone/pull/1730#discussion_r553374425", "bodyText": "Thanks @sodonnel for the suggestion.  Patch is updated accordingly, can you please take another look?", "author": "adoroszlai", "createdAt": "2021-01-07T14:50:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e25b481dd6a3057adfe1dd0fe8def8d52a4a7fef", "chunk": "diff --git a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java\nindex 847eafa86d..53d616293d 100644\n--- a/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java\n+++ b/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java\n\n@@ -516,7 +516,7 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    readLock();\n+    writeLock();\n     try {\n       // Closed/ Quasi closed containers are considered for replication by\n       // replication manager if they are under-replicated.\n"}}, {"oid": "e25b481dd6a3057adfe1dd0fe8def8d52a4a7fef", "url": "https://github.com/apache/ozone/commit/e25b481dd6a3057adfe1dd0fe8def8d52a4a7fef", "message": "Skip first read lock, take write lock right away", "committedDate": "2021-01-06T22:26:21Z", "type": "commit"}]}