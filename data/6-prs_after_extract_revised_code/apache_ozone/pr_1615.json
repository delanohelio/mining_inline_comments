{"pr_number": 1615, "pr_title": "HDDS-4451.Handle start & stop of Trash Emptier thread when node becom\u2026", "pr_createdAt": "2020-11-24T05:45:55Z", "pr_url": "https://github.com/apache/ozone/pull/1615", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg==", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529647472", "bodyText": "I think this should happen after the thread.sleep at line 117. As for most of the cases, when an OM restart the trash emptier it should check this status and skip doing any Trash processing.", "author": "mukul1987", "createdAt": "2020-11-24T15:36:55Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -98,7 +105,8 @@ public Runnable getEmptier() throws IOException {\n \n     @Override\n     public void run() {\n-      if (emptierInterval == 0) {\n+      // if this is not the leader node,don't run the emptier\n+      if (emptierInterval == 0 || !om.isLeader()) {", "originalCommit": "0dea3ba4689da4be804ae727c16081091b7f1960", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0ODI3MA==", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529648270", "bodyText": "Also lets see if we can add a unit test for this change. Please check with @bharatviswa504 on the test", "author": "mukul1987", "createdAt": "2020-11-24T15:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7e74d15722a3b8a747485606e19568c36b2b39b6", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\nindex 13429bc54..91ad4afc0 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\n\n@@ -106,7 +127,7 @@ public Runnable getEmptier() throws IOException {\n     @Override\n     public void run() {\n       // if this is not the leader node,don't run the emptier\n-      if (emptierInterval == 0 || !om.isLeader()) {\n+      if (emptierInterval == 0 || !om.isLeaderReady()) {\n         return;                                   // trash disabled\n       }\n       long now, end;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5MTE2Nw==", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540691167", "bodyText": "This should be continue here ?", "author": "mukul1987", "createdAt": "2020-12-11T04:57:52Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -107,6 +136,9 @@ public void run() {\n         end = ceiling(now, emptierInterval);\n         try {                                     // sleep for interval\n           Thread.sleep(end - now);\n+          if (!om.isLeader()){\n+            return;", "originalCommit": "a99449edf2820609680bbaad0c4dcd155fa960a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6387da4418c552f68dfadc5f915100033fca1e78", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\nindex d532619a1..13429bc54 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java\n\n@@ -136,9 +115,6 @@ public void run() {\n         end = ceiling(now, emptierInterval);\n         try {                                     // sleep for interval\n           Thread.sleep(end - now);\n-          if (!om.isLeader()){\n-            return;\n-          }\n         } catch (InterruptedException e) {\n           break;                                  // exit on interrupt\n         }\n"}}, {"oid": "6387da4418c552f68dfadc5f915100033fca1e78", "url": "https://github.com/apache/ozone/commit/6387da4418c552f68dfadc5f915100033fca1e78", "message": "HDDS-4451.Handle start & stop of Trash Emptier thread when node becomes leader/follower", "committedDate": "2020-12-11T06:15:09Z", "type": "commit"}, {"oid": "c7baaa7f29bbeb995be69ea03155f7013d771d2d", "url": "https://github.com/apache/ozone/commit/c7baaa7f29bbeb995be69ea03155f7013d771d2d", "message": "addressed some comments", "committedDate": "2020-12-11T06:15:09Z", "type": "commit"}, {"oid": "3c85a4a1c32a3dad761e8847b5bb2ecd4372fea2", "url": "https://github.com/apache/ozone/commit/3c85a4a1c32a3dad761e8847b5bb2ecd4372fea2", "message": "addressed comments", "committedDate": "2020-12-11T06:15:09Z", "type": "commit"}, {"oid": "b04abb496ba7c2d22c841148679c97d466f397bc", "url": "https://github.com/apache/ozone/commit/b04abb496ba7c2d22c841148679c97d466f397bc", "message": "trigger new CI check", "committedDate": "2020-12-11T06:15:09Z", "type": "commit"}, {"oid": "694aa7ff093c55d33ccfe42d567b15ff1485424c", "url": "https://github.com/apache/ozone/commit/694aa7ff093c55d33ccfe42d567b15ff1485424c", "message": "trigger new CI check", "committedDate": "2020-12-11T06:15:09Z", "type": "commit"}, {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6", "url": "https://github.com/apache/ozone/commit/7e74d15722a3b8a747485606e19568c36b2b39b6", "message": "resolved conflict", "committedDate": "2020-12-11T06:38:51Z", "type": "commit"}, {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6", "url": "https://github.com/apache/ozone/commit/7e74d15722a3b8a747485606e19568c36b2b39b6", "message": "resolved conflict", "committedDate": "2020-12-11T06:38:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5ODA4Ng==", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540798086", "bodyText": "Lets remove this TODO's", "author": "mukul1987", "createdAt": "2020-12-11T09:12:35Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1402,10 +1394,7 @@ public void stop() {\n       }\n       // TODO:Also stop this thread if an OM switches from leader to follower.", "originalCommit": "7e74d15722a3b8a747485606e19568c36b2b39b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68d35f3da2d28e360bcc8e781b520ae954be9320", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\nindex 037cea46e..1b4fc47dc 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java\n\n@@ -1392,8 +1392,6 @@ public void stop() {\n       if (httpServer != null) {\n         httpServer.stop();\n       }\n-      // TODO:Also stop this thread if an OM switches from leader to follower.\n-      //  Should be fixed after HDDS-4451.\n       stopTrashEmptier();\n       metadataManager.stop();\n       metrics.unRegister();\n"}}, {"oid": "68d35f3da2d28e360bcc8e781b520ae954be9320", "url": "https://github.com/apache/ozone/commit/68d35f3da2d28e360bcc8e781b520ae954be9320", "message": "Update OzoneManager.java", "committedDate": "2020-12-11T09:14:34Z", "type": "commit"}]}