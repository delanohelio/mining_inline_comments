{"pr_number": 471, "pr_title": "HDDS-2906. Added Unit Test Cases ofr CRLCodec", "pr_createdAt": "2020-01-22T00:24:30Z", "pr_url": "https://github.com/apache/ozone/pull/471", "timeline": [{"oid": "b3fbe6f4338d6bb4184a1d929e1e5f2f14244a00", "url": "https://github.com/apache/ozone/commit/b3fbe6f4338d6bb4184a1d929e1e5f2f14244a00", "message": "HDDS-2906. Added Unit Test Cases ofr CRLCodec", "committedDate": "2020-01-22T00:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MzEwMg==", "url": "https://github.com/apache/ozone/pull/471#discussion_r370293102", "bodyText": "NIT: should we rename the method from get509CRL to getX509CRL?", "author": "xiaoyuyao", "createdAt": "2020-01-23T18:49:48Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/utils/CRLCodec.java", "diffHunk": "@@ -78,7 +78,7 @@ public CRLCodec(SecurityConfig securityConfig) {\n    * Returns a X509 CRL from the CRL Holder.\n    *\n    * @param holder - Holder\n-   * @return X509Certificate.\n+   * @return X509CRL - X509 CRL.\n    * @throws CRLException - on Error.\n    */\n   public static X509CRL get509CRL(X509CRLHolder holder)", "originalCommit": "b3fbe6f4338d6bb4184a1d929e1e5f2f14244a00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwODUyMQ==", "url": "https://github.com/apache/ozone/pull/471#discussion_r370308521", "bodyText": "Good point. Done.", "author": "abhishekaypurohit", "createdAt": "2020-01-23T19:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5MzEwMg=="}], "type": "inlineReview", "revised_code": {"commit": "f3f1ab51a104808d6519b773f93242b882ad8992", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/utils/CRLCodec.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/utils/CRLCodec.java\nindex e39d052d9e..19a6f58dd3 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/utils/CRLCodec.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/security/x509/certificate/utils/CRLCodec.java\n\n@@ -81,7 +81,7 @@ public CRLCodec(SecurityConfig securityConfig) {\n    * @return X509CRL - X509 CRL.\n    * @throws CRLException - on Error.\n    */\n-  public static X509CRL get509CRL(X509CRLHolder holder)\n+  public static X509CRL getX509CRL(X509CRLHolder holder)\n       throws CRLException {\n     return CRL_CONVERTER.getCRL(holder);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5NzI4NA==", "url": "https://github.com/apache/ozone/pull/471#discussion_r370297284", "bodyText": "NIT: the InputStream can be wrapped with try-with-resource.", "author": "xiaoyuyao", "createdAt": "2020-01-23T18:58:38Z", "path": "hadoop-hdds/common/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/utils/TestCRLCodec.java", "diffHunk": "@@ -101,11 +122,124 @@ public void testWriteCRL() throws IOException, OperatorCreationException {\n         builder.build(contentSignerBuilder.build(privateKey));\n \n     CRLCodec crlCodec = new CRLCodec(securityConfig);\n-    crlCodec.writeCRL(cRLHolder, CRL_FILE_NAME, true);\n+    crlCodec.writeCRL(cRLHolder, this.securityConfig.getCrlName(), true);\n \n     X509CRLEntryHolder entryHolder =\n         cRLHolder.getRevokedCertificate(BigInteger.ONE);\n     assertNotNull(entryHolder);\n+\n+    // verify file generation\n+    File crlFile =\n+        Paths.get(crlCodec.getLocation().toString(),\n+                  this.securityConfig.getCrlName()).toFile();\n+    assertTrue(crlFile.exists());\n+\n+    try (BufferedReader reader = new BufferedReader(new FileReader(crlFile))){\n+\n+      // Verify contents of the file\n+      String header = reader.readLine();\n+      assertEquals(\"-----BEGIN X509 CRL-----\", header);\n+\n+      String footer = null;\n+      String line = null;\n+      while ((line = reader.readLine()) != null) {\n+        footer = line;\n+      }\n+      assertEquals(\"-----END X509 CRL-----\", footer);\n+    }\n+  }\n+\n+  @Test\n+  public void testWriteCRLX509() throws IOException,\n+      OperatorCreationException, CertificateException, CRLException {\n+\n+    X500Name issuer = x509CertificateHolder.getIssuer();\n+    Date now = new Date();\n+    X509v2CRLBuilder builder = new X509v2CRLBuilder(issuer, now);\n+    builder.addCRLEntry(x509CertificateHolder.getSerialNumber(), now,\n+                        CRLReason.cACompromise);\n+\n+    InputStream inStream = null;\n+    byte[] crlBytes = TMP_CRL_ENTRY.getBytes();\n+    try {", "originalCommit": "b3fbe6f4338d6bb4184a1d929e1e5f2f14244a00", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwODM4Mw==", "url": "https://github.com/apache/ozone/pull/471#discussion_r370308383", "bodyText": "Done.", "author": "abhishekaypurohit", "createdAt": "2020-01-23T19:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI5NzI4NA=="}], "type": "inlineReview", "revised_code": {"commit": "f3f1ab51a104808d6519b773f93242b882ad8992", "chunk": "diff --git a/hadoop-hdds/common/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/utils/TestCRLCodec.java b/hadoop-hdds/common/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/utils/TestCRLCodec.java\nindex 730cd41485..c8201c06b4 100644\n--- a/hadoop-hdds/common/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/utils/TestCRLCodec.java\n+++ b/hadoop-hdds/common/src/test/java/org/apache/hadoop/hdds/security/x509/certificate/utils/TestCRLCodec.java\n\n@@ -159,10 +159,8 @@ public void testWriteCRLX509() throws IOException,\n     builder.addCRLEntry(x509CertificateHolder.getSerialNumber(), now,\n                         CRLReason.cACompromise);\n \n-    InputStream inStream = null;\n     byte[] crlBytes = TMP_CRL_ENTRY.getBytes();\n-    try {\n-      inStream = new ByteArrayInputStream(crlBytes);\n+    try (InputStream inStream = new ByteArrayInputStream(crlBytes)) {\n       CertificateFactory cf = CertificateFactory.getInstance(\"X.509\");\n       X509CRL crl = (X509CRL)cf.generateCRL(inStream);\n \n"}}, {"oid": "f3f1ab51a104808d6519b773f93242b882ad8992", "url": "https://github.com/apache/ozone/commit/f3f1ab51a104808d6519b773f93242b882ad8992", "message": "HDDS-2906. Updated name and try with resource", "committedDate": "2020-01-23T19:21:45Z", "type": "commit"}]}