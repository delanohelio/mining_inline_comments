{"pr_number": 605, "pr_title": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode.", "pr_createdAt": "2020-02-25T20:38:51Z", "pr_url": "https://github.com/apache/ozone/pull/605", "timeline": [{"oid": "cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "url": "https://github.com/apache/ozone/commit/cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode.", "committedDate": "2020-02-25T20:41:51Z", "type": "forcePushed"}, {"oid": "9fe0ae46f11703ef52b228bbc97a47121e16c4ec", "url": "https://github.com/apache/ozone/commit/9fe0ae46f11703ef52b228bbc97a47121e16c4ec", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode.", "committedDate": "2020-02-25T20:42:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MDI2NA==", "url": "https://github.com/apache/ozone/pull/605#discussion_r387570264", "bodyText": "We can save this step as most likely it's still in safe mode at the time.", "author": "ChenSammi", "createdAt": "2020-03-04T10:17:41Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -358,6 +358,9 @@ public StorageContainerManager(OzoneConfiguration conf,\n     eventQueue.addHandler(SCMEvents.PIPELINE_ACTIONS, pipelineActionHandler);\n     eventQueue.addHandler(SCMEvents.PIPELINE_REPORT, pipelineReportHandler);\n     eventQueue.addHandler(SCMEvents.SAFE_MODE_STATUS, safeModeHandler);\n+\n+    // Emit initial safe mode status, as now handlers are registered.\n+    scmSafeModeManager.emitSafeModeStatus();", "originalCommit": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg3MjIzNQ==", "url": "https://github.com/apache/ozone/pull/605#discussion_r387872235", "bodyText": "This is there here, so that in all Managers and protocolServer where we need safeModeStatus will get the value accordingly.\n    isInSafeMode.set(safeModeStatus.getSafeModeStatus());\n    scmClientProtocolServer.setSafeModeStatus(isInSafeMode.get());\n    scmBlockManager.setSafeModeStatus(isInSafeMode.get());\n    scmPipelineManager.setSafeModeStatus(isInSafeMode.get());\n\nWith the current code, we don't need it but in the future, if some manager has not read the HDDS_SCM_SAFEMODE_ENABLED and waiting for this to set the initial safemode status and then take specific actions it will help.", "author": "bharatviswa504", "createdAt": "2020-03-04T19:05:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MDI2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MTg2Ng==", "url": "https://github.com/apache/ozone/pull/605#discussion_r387571866", "bodyText": "Thanks @bharatviswa504 for the detail explanation.\nWhen add triggerPipelineCreation() here,  we'd better remove the pipelineManager.startPipelineCreator(); in SCMSafeModeManager#exitSafeMode, otherwise, the time wait actually doesn't has effect on pipeline scrubber in PipelineManager.\nAlso, I would suggest move the scmPipelineManager.setSafeModeStatus(isInSafeMode.get()); into the safeModeExitThread run.", "author": "ChenSammi", "createdAt": "2020-03-04T10:20:36Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java", "diffHunk": "@@ -115,7 +113,7 @@ public void onMessage(SafeModeStatus safeModeStatus,\n           Thread.currentThread().interrupt();\n         }\n         replicationManager.start();\n-        cleanupPipelines();\n+        scmPipelineManager.triggerPipelineCreation();", "originalCommit": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NDk5Mg==", "url": "https://github.com/apache/ozone/pull/605#discussion_r387884992", "bodyText": "pipelineManager.startPipelineCreator(); is there in exitSafeMode so that once after we are out of safeMode schedule a periodic task to create pipelines.\ntriggerPipelineCreation will schedule a task if no pipeline creator is running when the call happened, as previously here we used to destroy pipelines, now replaced it with a call to trigger pipeline creation.\nAnd also we want to run scrubber after safe mode exit, but I think we should be fine to scrub pipelines after an additional safeModewait time. Addressed this.", "author": "bharatviswa504", "createdAt": "2020-03-04T19:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MTg2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java\nindex ff5db1b52..50095abbf 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java\n\n@@ -112,6 +111,7 @@ public void onMessage(SafeModeStatus safeModeStatus,\n         } catch (InterruptedException e) {\n           Thread.currentThread().interrupt();\n         }\n+        scmPipelineManager.setSafeModeStatus(isInSafeMode.get());\n         replicationManager.start();\n         scmPipelineManager.triggerPipelineCreation();\n       });\n"}}, {"oid": "87ba67a0d18e96c4689f88393df8808dc21b9dae", "url": "https://github.com/apache/ozone/commit/87ba67a0d18e96c4689f88393df8808dc21b9dae", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode.", "committedDate": "2020-03-04T18:47:02Z", "type": "commit"}, {"oid": "b8d5fee8e889bb0b0848ac9231e3927054eecc7a", "url": "https://github.com/apache/ozone/commit/b8d5fee8e889bb0b0848ac9231e3927054eecc7a", "message": "remove test change", "committedDate": "2020-03-04T18:47:03Z", "type": "commit"}, {"oid": "486a3cb4d7c3553ee60d2f4ba0311d20e69da3c0", "url": "https://github.com/apache/ozone/commit/486a3cb4d7c3553ee60d2f4ba0311d20e69da3c0", "message": "check style.", "committedDate": "2020-03-04T18:47:03Z", "type": "commit"}, {"oid": "a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "url": "https://github.com/apache/ozone/commit/a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "message": "fix sammi comment", "committedDate": "2020-03-04T19:29:06Z", "type": "commit"}, {"oid": "a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "url": "https://github.com/apache/ozone/commit/a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "message": "fix sammi comment", "committedDate": "2020-03-04T19:29:06Z", "type": "forcePushed"}]}