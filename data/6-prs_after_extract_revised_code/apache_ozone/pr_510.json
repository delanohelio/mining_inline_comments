{"pr_number": 510, "pr_title": "HDDS-2958. Handle replay of OM Volume ACL requests", "pr_createdAt": "2020-01-30T18:35:34Z", "pr_url": "https://github.com/apache/ozone/pull/510", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTY0OQ==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373335649", "bodyText": "Now no use of exception here. Unused param", "author": "bharatviswa504", "createdAt": "2020-01-31T06:43:34Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java", "diffHunk": "@@ -80,29 +80,36 @@ public String getVolumeName() {\n \n   @Override\n   OMClientResponse onSuccess(OMResponse.Builder omResponse,\n-      OmVolumeArgs omVolumeArgs, boolean result){\n+      OmVolumeArgs omVolumeArgs, boolean aclApplied){\n     omResponse.setSetAclResponse(OzoneManagerProtocolProtos.SetAclResponse\n-        .newBuilder().setResponse(result).build());\n-    return new OMVolumeAclOpResponse(omVolumeArgs, omResponse.build());\n+        .newBuilder().setResponse(aclApplied).build());\n+    return new OMVolumeAclOpResponse(omResponse.build(), omVolumeArgs);\n   }\n \n   @Override\n   OMClientResponse onFailure(OMResponse.Builder omResponse,\n       IOException ex) {\n-    return new OMVolumeAclOpResponse(null,\n-        createErrorOMResponse(omResponse, ex));\n+    return new OMVolumeAclOpResponse(createErrorOMResponse(omResponse, ex));\n   }\n \n   @Override\n-  void onComplete(IOException ex) {\n-    if (ex == null) {\n-      if (LOG.isDebugEnabled()) {\n-        LOG.debug(\"Set acls: {} to volume: {} success!\",\n-            getAcls(), getVolumeName());\n-      }\n-    } else {\n-      LOG.error(\"Set acls {} to volume {} failed!\",\n-          getAcls(), getVolumeName(), ex);\n+  void onComplete(Result result, IOException ex, long trxnLogIndex) {", "originalCommit": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTczNA==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373335734", "bodyText": "Same applies for all requests.", "author": "bharatviswa504", "createdAt": "2020-01-31T06:43:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwNzQ4OA==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373607488", "bodyText": "We are using it to log the exception in case of FAILURE.", "author": "hanishakoneru", "createdAt": "2020-01-31T17:56:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyMzEyMw==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373723123", "bodyText": "Yes, missed it.", "author": "bharatviswa504", "createdAt": "2020-01-31T23:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTY0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\nindex 69bcc20ba..49b98bd16 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\n\n@@ -96,12 +96,16 @@ OMClientResponse onFailure(OMResponse.Builder omResponse,\n   void onComplete(Result result, IOException ex, long trxnLogIndex) {\n     switch (result) {\n     case SUCCESS:\n-      LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),\n-          getVolumeName());\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),\n+            getVolumeName());\n+      }\n       break;\n     case REPLAY:\n-      LOG.debug(\"Replayed Transaction {} ignored. Request: {}\", trxnLogIndex,\n-          getOmRequest());\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Replayed Transaction {} ignored. Request: {}\", trxnLogIndex,\n+            getOmRequest());\n+      }\n       break;\n     case FAILURE:\n       LOG.error(\"Set acls {} to volume {} failed!\", getAcls(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNjU5OA==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373336598", "bodyText": "We need to set updateID even in the case of applyAcl false.\nScenario:\n\nAdd Acl T1\nAdd existing Acl T2\n\nNow replay T2 it will not be considered as replay as updateID will be still 1.", "author": "bharatviswa504", "createdAt": "2020-01-31T06:47:53Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java", "diffHunk": "@@ -73,53 +74,71 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n     OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n     boolean lockAcquired = false;\n+    Result result = null;\n     try {\n       // check Acl\n       if (ozoneManager.getAclsEnabled()) {\n         checkAcls(ozoneManager, OzoneObj.ResourceType.VOLUME,\n             OzoneObj.StoreType.OZONE, IAccessAuthorizer.ACLType.WRITE_ACL,\n             volume, null, null);\n       }\n-      lockAcquired =\n-          omMetadataManager.getLock().acquireWriteLock(VOLUME_LOCK, volume);\n+      lockAcquired = omMetadataManager.getLock().acquireWriteLock(\n+          VOLUME_LOCK, volume);\n       String dbVolumeKey = omMetadataManager.getVolumeKey(volume);\n       omVolumeArgs = omMetadataManager.getVolumeTable().get(dbVolumeKey);\n       if (omVolumeArgs == null) {\n         throw new OMException(OMException.ResultCodes.VOLUME_NOT_FOUND);\n       }\n \n+      // Check if this transaction is a replay of ratis logs.\n+      // If this is a replay, then the response has already been returned to\n+      // the client. So take no further action and return a dummy\n+      // OMClientResponse.\n+      if (isReplay(ozoneManager, omVolumeArgs.getUpdateID(),\n+          trxnLogIndex)) {\n+        throw new OMReplayException();\n+      }\n+\n       // result is false upon add existing acl or remove non-existing acl\n-      boolean result = true;\n+      boolean applyAcl = true;\n       try {\n         omVolumeAclOp.apply(ozoneAcls, omVolumeArgs);\n       } catch (OMException ex) {\n-        result = false;\n+        applyAcl = false;\n       }\n \n-      if (result) {\n+      if (applyAcl) {\n+        omVolumeArgs.setUpdateID(trxnLogIndex);", "originalCommit": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYwODQyMw==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373608423", "bodyText": "We do not update the DB in case applyAcl is false. So this would add an unnecessary DB op. Tradeoff is replay transaction would also check and reach the same decision - applyAcl false. So I think it should be ok here. Thoughts?", "author": "hanishakoneru", "createdAt": "2020-01-31T17:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNjU5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcyMzA1Nw==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373723057", "bodyText": "No when replay it will not be considered as replay as UpdateID will be less than transaction ID. As we are doing best effort to find all the replay cases, I think we can set updateID when applyAcl false and it will help in replay.\n\nSo this would add an unnecessary DB op.\n\nWe are using DoubleBuffer and Batch, so we should be fine here.", "author": "bharatviswa504", "createdAt": "2020-01-31T23:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNjU5OA=="}], "type": "inlineReview", "revised_code": {"commit": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java\nindex ff7e3d207..fe04b48e3 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java\n\n@@ -107,13 +107,14 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         applyAcl = false;\n       }\n \n-      if (applyAcl) {\n-        omVolumeArgs.setUpdateID(trxnLogIndex);\n-        // update cache.\n-        omMetadataManager.getVolumeTable().addCacheEntry(\n-            new CacheKey<>(dbVolumeKey),\n-            new CacheValue<>(Optional.of(omVolumeArgs), trxnLogIndex));\n-      }\n+      // We set the updateID even if applyAcl = false to catch the replay\n+      // transactions.\n+      omVolumeArgs.setUpdateID(trxnLogIndex);\n+\n+      // update cache.\n+      omMetadataManager.getVolumeTable().addCacheEntry(\n+          new CacheKey<>(dbVolumeKey),\n+          new CacheValue<>(Optional.of(omVolumeArgs), trxnLogIndex));\n \n       omClientResponse = onSuccess(omResponse, omVolumeArgs, applyAcl);\n       result = Result.SUCCESS;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzODk3OA==", "url": "https://github.com/apache/ozone/pull/510#discussion_r373338978", "bodyText": "Removed isDebugEnabled.\nNeed same in other requests also. (I see it is missing in other requests)", "author": "bharatviswa504", "createdAt": "2020-01-31T06:58:56Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java", "diffHunk": "@@ -80,29 +80,36 @@ public String getVolumeName() {\n \n   @Override\n   OMClientResponse onSuccess(OMResponse.Builder omResponse,\n-      OmVolumeArgs omVolumeArgs, boolean result){\n+      OmVolumeArgs omVolumeArgs, boolean aclApplied){\n     omResponse.setSetAclResponse(OzoneManagerProtocolProtos.SetAclResponse\n-        .newBuilder().setResponse(result).build());\n-    return new OMVolumeAclOpResponse(omVolumeArgs, omResponse.build());\n+        .newBuilder().setResponse(aclApplied).build());\n+    return new OMVolumeAclOpResponse(omResponse.build(), omVolumeArgs);\n   }\n \n   @Override\n   OMClientResponse onFailure(OMResponse.Builder omResponse,\n       IOException ex) {\n-    return new OMVolumeAclOpResponse(null,\n-        createErrorOMResponse(omResponse, ex));\n+    return new OMVolumeAclOpResponse(createErrorOMResponse(omResponse, ex));\n   }\n \n   @Override\n-  void onComplete(IOException ex) {\n-    if (ex == null) {\n-      if (LOG.isDebugEnabled()) {\n-        LOG.debug(\"Set acls: {} to volume: {} success!\",\n-            getAcls(), getVolumeName());\n-      }\n-    } else {\n-      LOG.error(\"Set acls {} to volume {} failed!\",\n-          getAcls(), getVolumeName(), ex);\n+  void onComplete(Result result, IOException ex, long trxnLogIndex) {\n+    switch (result) {\n+    case SUCCESS:\n+      LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),", "originalCommit": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\nindex 69bcc20ba..49b98bd16 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java\n\n@@ -96,12 +96,16 @@ OMClientResponse onFailure(OMResponse.Builder omResponse,\n   void onComplete(Result result, IOException ex, long trxnLogIndex) {\n     switch (result) {\n     case SUCCESS:\n-      LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),\n-          getVolumeName());\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),\n+            getVolumeName());\n+      }\n       break;\n     case REPLAY:\n-      LOG.debug(\"Replayed Transaction {} ignored. Request: {}\", trxnLogIndex,\n-          getOmRequest());\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Replayed Transaction {} ignored. Request: {}\", trxnLogIndex,\n+            getOmRequest());\n+      }\n       break;\n     case FAILURE:\n       LOG.error(\"Set acls {} to volume {} failed!\", getAcls(),\n"}}, {"oid": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "url": "https://github.com/apache/ozone/commit/22e359aa2a2a9487d7e16b539789df1235d88ff0", "message": "UpdateDB even if applyAcl is false", "committedDate": "2020-02-04T23:25:15Z", "type": "forcePushed"}, {"oid": "aaf782218fe0151485aef22aec8a6dc7fd6d3a82", "url": "https://github.com/apache/ozone/commit/aaf782218fe0151485aef22aec8a6dc7fd6d3a82", "message": "HDDS-2958. Handle replay of OM Volume ACL requests", "committedDate": "2020-02-10T21:04:27Z", "type": "commit"}, {"oid": "a8ec13f313ef274dac5d991317650e684f70d8d2", "url": "https://github.com/apache/ozone/commit/a8ec13f313ef274dac5d991317650e684f70d8d2", "message": "CI unit test fix", "committedDate": "2020-02-10T21:04:27Z", "type": "commit"}, {"oid": "cd035cebd428e006a7cf6dd970e8198940c7846a", "url": "https://github.com/apache/ozone/commit/cd035cebd428e006a7cf6dd970e8198940c7846a", "message": "Unit tests for Remove and Set ACL requests", "committedDate": "2020-02-10T21:04:27Z", "type": "commit"}, {"oid": "328d53956dd9656e9ee5956334031156a63e946e", "url": "https://github.com/apache/ozone/commit/328d53956dd9656e9ee5956334031156a63e946e", "message": "Adding debug enabled check", "committedDate": "2020-02-10T21:04:27Z", "type": "commit"}, {"oid": "5a3a5c77be2cc059b685c53d093f1186eb39d9b2", "url": "https://github.com/apache/ozone/commit/5a3a5c77be2cc059b685c53d093f1186eb39d9b2", "message": "UpdateDB even if applyAcl is false", "committedDate": "2020-02-10T21:04:27Z", "type": "commit"}, {"oid": "87179bebbb940b89b72049230177804fa075c3f5", "url": "https://github.com/apache/ozone/commit/87179bebbb940b89b72049230177804fa075c3f5", "message": "rebase", "committedDate": "2020-02-10T21:12:19Z", "type": "commit"}, {"oid": "87179bebbb940b89b72049230177804fa075c3f5", "url": "https://github.com/apache/ozone/commit/87179bebbb940b89b72049230177804fa075c3f5", "message": "rebase", "committedDate": "2020-02-10T21:12:19Z", "type": "forcePushed"}]}