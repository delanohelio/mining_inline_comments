{"pr_number": 982, "pr_title": "HDDS-3668. OzoneManager start fails with RocksDB error on downgrade to older version.", "pr_createdAt": "2020-05-28T15:14:33Z", "pr_url": "https://github.com/apache/ozone/pull/982", "timeline": [{"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be", "url": "https://github.com/apache/ozone/commit/cf0d67b7151ae674e2e473d6372e31dbb16d13be", "message": "HDDS-3668. OzoneManager start fails with RocksDB error on downgrade to older version.", "committedDate": "2020-05-28T15:12:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MzA5OA==", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993098", "bodyText": "One question, can these extra column families can be dropped, if they are not required after upgrade/downgrade.\nBecause now we removed S3Table in #940. So, once after upgrade, technically we don't require the column family any more.", "author": "bharatviswa504", "createdAt": "2020-05-28T17:09:31Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "originalCommit": "cf0d67b7151ae674e2e473d6372e31dbb16d13be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4MDUxMg==", "url": "https://github.com/apache/ozone/pull/982#discussion_r433480512", "bodyText": "@bharatviswa504 That is a good point. Based on our offline discussion, this will be handled on a case-by-case basis as outlined in the Ozone upgrades design doc (HDDS-3698).", "author": "avijayanhwx", "createdAt": "2020-06-01T20:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MzA5OA=="}], "type": "inlineReview", "revised_code": {"commit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 672e8659d..80a74ed99 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -100,9 +101,10 @@ public RDBStore(File dbFile, DBOptions options,\n       List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n       List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n           cf -> !families.contains(cf)).collect(Collectors.toList());\n-      for (TableConfig family : extraCf) {\n-        LOG.info(\"Adding column family {}\", family.getName());\n-        columnFamilyDescriptors.add(family.getDescriptor());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {\n+        LOG.info(\"Found the following extra column families in existing DB : \" +\n+                \"{}\", Arrays.toString(extraCf.toArray()));\n+        extraCf.forEach(cf -> columnFamilyDescriptors.add(cf.getDescriptor()));\n       }\n \n       db = RocksDB.open(dbOptions, dbLocation.getAbsolutePath(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5Mzc2MQ==", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993761", "bodyText": "Can this comment be more clear saying ColumnFamily in DB, but not in the current version something like that?", "author": "bharatviswa504", "createdAt": "2020-05-28T17:10:40Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "originalCommit": "cf0d67b7151ae674e2e473d6372e31dbb16d13be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3MzU5Ng==", "url": "https://github.com/apache/ozone/pull/982#discussion_r433473596", "bodyText": "Will do.", "author": "avijayanhwx", "createdAt": "2020-06-01T20:33:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5Mzc2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 672e8659d..80a74ed99 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -100,9 +101,10 @@ public RDBStore(File dbFile, DBOptions options,\n       List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n       List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n           cf -> !families.contains(cf)).collect(Collectors.toList());\n-      for (TableConfig family : extraCf) {\n-        LOG.info(\"Adding column family {}\", family.getName());\n-        columnFamilyDescriptors.add(family.getDescriptor());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {\n+        LOG.info(\"Found the following extra column families in existing DB : \" +\n+                \"{}\", Arrays.toString(extraCf.toArray()));\n+        extraCf.forEach(cf -> columnFamilyDescriptors.add(cf.getDescriptor()));\n       }\n \n       db = RocksDB.open(dbOptions, dbLocation.getAbsolutePath(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NDcxNQ==", "url": "https://github.com/apache/ozone/pull/982#discussion_r431994715", "bodyText": "Question: If column family is missing also, but DBStore will open that column family right currently? So, do we need to check the columnFamily is opened or not also?", "author": "bharatviswa504", "createdAt": "2020-05-28T17:12:21Z", "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java", "diffHunk": "@@ -348,5 +348,40 @@ public void testGetDBUpdatesSince() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testDowngrade() throws Exception {\n+\n+    // Write data to current DB which has 6 column families at the time of\n+    // writing this test.\n+    for (String family : families) {\n+      try (Table table = rdbStore.getTable(family)) {\n+        byte[] key = family.getBytes(StandardCharsets.UTF_8);\n+        byte[] value =\n+            RandomStringUtils.random(10).getBytes(StandardCharsets.UTF_8);\n+        table.put(key, value);\n+      }\n+    }\n+    // Close current DB.\n+    rdbStore.close();\n+\n+    // Reopen DB with the last column family removed.\n+    options = new DBOptions();\n+    options.setCreateIfMissing(true);\n+    options.setCreateMissingColumnFamilies(true);\n+    configSet = new HashSet<>();\n+    List<String> familiesMinusOne = families.subList(0, families.size() - 1);\n+    for(String name : familiesMinusOne) {\n+      TableConfig newConfig = new TableConfig(name, new ColumnFamilyOptions());\n+      configSet.add(newConfig);\n+    }\n+    rdbStore = new RDBStore(rdbStore.getDbLocation(), options, configSet);\n+    for (String family : familiesMinusOne) {", "originalCommit": "cf0d67b7151ae674e2e473d6372e31dbb16d13be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3OTgwOQ==", "url": "https://github.com/apache/ozone/pull/982#discussion_r433479809", "bodyText": "Added check for the extra column family.", "author": "avijayanhwx", "createdAt": "2020-06-01T20:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NDcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "chunk": "diff --git a/hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java b/hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java\nindex 171baf9da..d640c4a97 100644\n--- a/hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java\n+++ b/hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java\n\n@@ -382,6 +382,15 @@ public void testDowngrade() throws Exception {\n         Assert.assertNotNull(val);\n       }\n     }\n+\n+    // Technically the extra column family should also be open, even though\n+    // we do not use it.\n+    String extraFamily = families.get(families.size() - 1);\n+    try (Table table = rdbStore.getTable(extraFamily)) {\n+      Assert.assertNotNull(extraFamily + \"is null\", table);\n+      Object val = table.get(extraFamily.getBytes(StandardCharsets.UTF_8));\n+      Assert.assertNotNull(val);\n+    }\n   }\n \n }\n\\ No newline at end of file\n"}}, {"oid": "520eda58ae48fc060eadfe63e3539b97bc72c9b9", "url": "https://github.com/apache/ozone/commit/520eda58ae48fc060eadfe63e3539b97bc72c9b9", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3668-master", "committedDate": "2020-06-01T20:44:40Z", "type": "commit"}, {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "url": "https://github.com/apache/ozone/commit/97bcc5063c13efe6ceff243d80e9f736b01c8505", "message": "Address review comments.", "committedDate": "2020-06-01T20:45:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzI5NQ==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773295", "bodyText": "Nit: extraCf cannot be null, so I would prefer not adding a dependency:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (CollectionUtils.isNotEmpty(extraCf)) {\n          \n          \n            \n                  if (!extraCf.isEmpty()) {", "author": "adoroszlai", "createdAt": "2020-06-05T08:36:51Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..b05af9173 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -103,7 +101,7 @@ public RDBStore(File dbFile, DBOptions options,\n           cf -> !families.contains(cf)).collect(Collectors.toList());\n       if (CollectionUtils.isNotEmpty(extraCf)) {\n         LOG.info(\"Found the following extra column families in existing DB : \" +\n-                \"{}\", Arrays.toString(extraCf.toArray()));\n+                \"{}\", extraCf);\n         extraCf.forEach(cf -> columnFamilyDescriptors.add(cf.getDescriptor()));\n       }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzc5MA==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773790", "bodyText": "Nit: I think List.toString is just as good:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"{}\", Arrays.toString(extraCf.toArray()));\n          \n          \n            \n                            \"{}\", extraCf);", "author": "adoroszlai", "createdAt": "2020-06-05T08:37:41Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {\n+        LOG.info(\"Found the following extra column families in existing DB : \" +\n+                \"{}\", Arrays.toString(extraCf.toArray()));", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..b05af9173 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -103,7 +101,7 @@ public RDBStore(File dbFile, DBOptions options,\n           cf -> !families.contains(cf)).collect(Collectors.toList());\n       if (CollectionUtils.isNotEmpty(extraCf)) {\n         LOG.info(\"Found the following extra column families in existing DB : \" +\n-                \"{}\", Arrays.toString(extraCf.toArray()));\n+                \"{}\", extraCf);\n         extraCf.forEach(cf -> columnFamilyDescriptors.add(cf.getDescriptor()));\n       }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzk3Mg==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773972", "bodyText": "Nit: same here regarding arrays:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      Arrays.toString(columnFamiliesInDb.toArray()));\n          \n          \n            \n                      columnFamiliesInDb);", "author": "adoroszlai", "createdAt": "2020-06-05T08:38:00Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))\n+        .collect(Collectors.toList());\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Found column Families in DB : {}\",\n+          Arrays.toString(columnFamiliesInDb.toArray()));", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8a2616ad2a3a8034ef470e135d139a886c45c0c1", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..29c92bac3 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -173,7 +173,7 @@ public RDBStore(File dbFile, DBOptions options,\n         dbLocation.getAbsolutePath());\n     List<TableConfig> columnFamiliesInDb = bytes.stream()\n         .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n-            DBProfile.DISK.getColumnFamilyOptions()))\n+            DBStoreBuilder.HDDS_DEFAULT_DB_PROFILE.getColumnFamilyOptions()))\n         .collect(Collectors.toList());\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"Found column Families in DB : {}\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDIzNA==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774234", "bodyText": "Corresponding to suggestion about list to string:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.Arrays;", "author": "adoroszlai", "createdAt": "2020-06-05T08:38:30Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4469d6a0c649dadbc2f357600c418df58d3efbc", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..a6fa13d95 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -24,7 +24,6 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDY0OQ==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774649", "bodyText": "Corresponding to suggestion about empty list:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.commons.collections.CollectionUtils;", "author": "adoroszlai", "createdAt": "2020-06-05T08:39:15Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n+import org.apache.commons.collections.CollectionUtils;", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4469d6a0c649dadbc2f357600c418df58d3efbc", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..a6fa13d95 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -24,7 +24,6 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n-import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3ODkzNg==", "url": "https://github.com/apache/ozone/pull/982#discussion_r435778936", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        DBProfile.DISK.getColumnFamilyOptions()))\n          \n          \n            \n                        DBStoreBuilder.HDDS_DEFAULT_DB_PROFILE.getColumnFamilyOptions()))", "author": "adoroszlai", "createdAt": "2020-06-05T08:47:04Z", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))", "originalCommit": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8a2616ad2a3a8034ef470e135d139a886c45c0c1", "chunk": "diff --git a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\nindex 80a74ed99..29c92bac3 100644\n--- a/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n+++ b/hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\n@@ -173,7 +173,7 @@ public RDBStore(File dbFile, DBOptions options,\n         dbLocation.getAbsolutePath());\n     List<TableConfig> columnFamiliesInDb = bytes.stream()\n         .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n-            DBProfile.DISK.getColumnFamilyOptions()))\n+            DBStoreBuilder.HDDS_DEFAULT_DB_PROFILE.getColumnFamilyOptions()))\n         .collect(Collectors.toList());\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"Found column Families in DB : {}\",\n"}}, {"oid": "8a2616ad2a3a8034ef470e135d139a886c45c0c1", "url": "https://github.com/apache/ozone/commit/8a2616ad2a3a8034ef470e135d139a886c45c0c1", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:10:34Z", "type": "commit"}, {"oid": "e4469d6a0c649dadbc2f357600c418df58d3efbc", "url": "https://github.com/apache/ozone/commit/e4469d6a0c649dadbc2f357600c418df58d3efbc", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:10:49Z", "type": "commit"}, {"oid": "66eb8faaedb7f633ebd5c66c9003f0e1e281f645", "url": "https://github.com/apache/ozone/commit/66eb8faaedb7f633ebd5c66c9003f0e1e281f645", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:11:22Z", "type": "commit"}, {"oid": "facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "url": "https://github.com/apache/ozone/commit/facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:11:28Z", "type": "commit"}, {"oid": "312efe68251d374de6d354fd105b4e31eee9b1bc", "url": "https://github.com/apache/ozone/commit/312efe68251d374de6d354fd105b4e31eee9b1bc", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:11:33Z", "type": "commit"}, {"oid": "04a1a0edabe52b02b9ecb9f68e4886fcba402583", "url": "https://github.com/apache/ozone/commit/04a1a0edabe52b02b9ecb9f68e4886fcba402583", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>", "committedDate": "2020-06-05T17:11:41Z", "type": "commit"}, {"oid": "362a7bbe62d863b8885111b6af0fe75bb01b4024", "url": "https://github.com/apache/ozone/commit/362a7bbe62d863b8885111b6af0fe75bb01b4024", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3668-master", "committedDate": "2020-06-05T17:21:51Z", "type": "commit"}, {"oid": "70237e265b6be75bb7520b5d57beede24e786788", "url": "https://github.com/apache/ozone/commit/70237e265b6be75bb7520b5d57beede24e786788", "message": "Add todo", "committedDate": "2020-06-05T17:24:53Z", "type": "commit"}]}