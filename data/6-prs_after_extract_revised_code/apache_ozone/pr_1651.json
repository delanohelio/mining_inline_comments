{"pr_number": 1651, "pr_title": "HDDS-4178. SCM Finalize client command implementation", "pr_createdAt": "2020-12-02T22:58:18Z", "pr_url": "https://github.com/apache/ozone/pull/1651", "timeline": [{"oid": "3b3027b09b6120539bbfb8598d786cb7daed633a", "url": "https://github.com/apache/ozone/commit/3b3027b09b6120539bbfb8598d786cb7daed633a", "message": "HDDS-4178. SCM Finalize command implementation.", "committedDate": "2020-12-03T00:07:46Z", "type": "forcePushed"}, {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "url": "https://github.com/apache/ozone/commit/ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "message": "HDDS-4178. SCM Finalize command implementation.", "committedDate": "2020-12-04T02:36:11Z", "type": "forcePushed"}, {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "url": "https://github.com/apache/ozone/commit/ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "message": "HDDS-4178. SCM Finalize command implementation.", "committedDate": "2020-12-04T02:36:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3ODEyOA==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536378128", "bodyText": "Nit. Can be UpgradeFinalizer<StorageContainerManager>.", "author": "avijayanhwx", "createdAt": "2020-12-04T21:03:27Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -211,6 +214,7 @@\n   private PipelineChoosePolicy pipelineChoosePolicy;\n \n   private HDDSLayoutVersionManager scmLayoutVersionManager;\n+  private UpgradeFinalizer upgradeFinalizer;", "originalCommit": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5MTI1Nw==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539691257", "bodyText": "yup. Made the changes as suggested.", "author": "prashantpogde", "createdAt": "2020-12-09T22:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3ODEyOA=="}], "type": "inlineReview", "revised_code": {"commit": "867a4b587f87aa35131ac826e600ed72f58422c6", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\nindex cdf1feae9..48d5cdc84 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java\n\n@@ -214,7 +214,7 @@\n   private PipelineChoosePolicy pipelineChoosePolicy;\n \n   private HDDSLayoutVersionManager scmLayoutVersionManager;\n-  private UpgradeFinalizer upgradeFinalizer;\n+  private UpgradeFinalizer<StorageContainerManager> upgradeFinalizer;\n \n   /**\n    * Creates a new StorageContainerManager. Configuration will be\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3OTUxNQ==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536379515", "bodyText": "Why do we need ScmSubCommand to extend FinalizeUpgradeBaseCommand? Shouldn't the inheritance be the other way?", "author": "avijayanhwx", "createdAt": "2020-12-04T21:06:30Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java", "diffHunk": "@@ -17,21 +17,25 @@\n  */\n package org.apache.hadoop.hdds.scm.cli;\n \n+import org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeBaseCommand;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import picocli.CommandLine;\n \n import java.io.IOException;\n import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n \n /**\n  * Base class for admin commands that connect via SCM client.\n  */\n-public abstract class ScmSubcommand implements Callable<Void> {\n+public abstract class ScmSubcommand extends FinalizeUpgradeBaseCommand", "originalCommit": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5MTYzNw==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539691637", "bodyText": "I changed the structure as discussed over call so this is not applicable anymore.", "author": "prashantpogde", "createdAt": "2020-12-09T22:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3OTUxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "867a4b587f87aa35131ac826e600ed72f58422c6", "chunk": "diff --git a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java\nindex ff50a594f..b3e8512ae 100644\n--- a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java\n+++ b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java\n\n@@ -17,7 +17,6 @@\n  */\n package org.apache.hadoop.hdds.scm.cli;\n \n-import org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeBaseCommand;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import picocli.CommandLine;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NjE2Ng==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536386166", "bodyText": "With this patch I see the CLI different for OM and SCM.\nFor SCM, it is something like ozone admin upgrade FinalizeSCM\nFor OM, it is ozone admin om finalizeupgrade\nCan we make sure it is common across OM and SCM? I believe the following are OK ->\nozone admin om/scm finalizeupgrade\nozone admin upgrade finalize-om-upgrade/finalize-scm-upgrade\nIn Ozone, the convention is to have CLI operations use lower case with \"-\" between words as needed.", "author": "avijayanhwx", "createdAt": "2020-12-04T21:20:37Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"FinalizeScm\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {", "originalCommit": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY5MzQyNw==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539693427", "bodyText": "yes! I changed  it to\nozone admin om/scm finalizeupgrade", "author": "prashantpogde", "createdAt": "2020-12-09T22:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NjE2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "867a4b587f87aa35131ac826e600ed72f58422c6", "chunk": "diff --git a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\nindex 06a9fcedf..dd7229ba8 100644\n--- a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n+++ b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n\n@@ -18,6 +18,16 @@\n \n package org.apache.hadoop.hdds.scm.cli.upgrade;\n \n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitCancellationMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitExitMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitFinishedMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitGeneralErrorMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.handleInvalidRequestAfterInitiatingFinalization;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isDone;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isFinalized;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isInprogress;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isStarting;\n+\n import java.io.IOException;\n import java.util.UUID;\n import java.util.concurrent.Callable;\n"}}, {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6", "url": "https://github.com/apache/ozone/commit/867a4b587f87aa35131ac826e600ed72f58422c6", "message": "HDDS-4178. Addressing review comments.", "committedDate": "2020-12-09T22:24:40Z", "type": "forcePushed"}, {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6", "url": "https://github.com/apache/ozone/commit/867a4b587f87aa35131ac826e600ed72f58422c6", "message": "HDDS-4178. Addressing review comments.", "committedDate": "2020-12-09T22:24:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMTk5Ng==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539731996", "bodyText": "If we add here, then OM finalization will also print out the message. Can we print out the message after the actual work is done (freeze pipeline creation, pipelines are closed etc)?", "author": "avijayanhwx", "createdAt": "2020-12-09T23:42:55Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java", "diffHunk": "@@ -218,14 +218,15 @@ private void persistStorage(Storage config) throws IOException {\n \n   protected void emitNOOPMsg(String feature) {\n     String msg = \"No finalization work defined for feature: \" + feature + \".\";\n-    String msg2 = \"Skipping.\";\n \n     logAndEmit(msg);\n-    logAndEmit(msg2);\n   }\n \n   protected void emitStartingMsg() {\n-    String msg = \"Finalization started.\";\n+    String msg = \"Finalization started.\\n\";\n+    msg += \"Existing pipelines and containers will be closed during Upgrade.\\n\";", "originalCommit": "867a4b587f87aa35131ac826e600ed72f58422c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTc3NTQzNQ==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539775435", "bodyText": "yup, I thought I was making change in ScmFinalizer. Fixed now.", "author": "prashantpogde", "createdAt": "2020-12-10T01:32:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMTk5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "chunk": "diff --git a/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java b/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java\nindex 95808cafa..552da5414 100644\n--- a/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java\n+++ b/hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java\n\n@@ -223,10 +223,7 @@ protected void emitNOOPMsg(String feature) {\n   }\n \n   protected void emitStartingMsg() {\n-    String msg = \"Finalization started.\\n\";\n-    msg += \"Existing pipelines and containers will be closed during Upgrade.\\n\";\n-    msg += \"New pipelines creation will remain frozen until Upgrade is \" +\n-        \"finalized\";\n+    String msg = \"Finalization started.\";\n     logAndEmit(msg);\n   }\n \n"}}, {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "url": "https://github.com/apache/ozone/commit/39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "message": "HDDS-4178. Addressing review comments : part 2.", "committedDate": "2020-12-10T18:00:19Z", "type": "forcePushed"}, {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "url": "https://github.com/apache/ozone/commit/39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "message": "HDDS-4178. Addressing review comments : part 2.", "committedDate": "2020-12-10T18:00:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODc0NQ==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r540598745", "bodyText": "I think, here we should just throw the cause of the ExecutionException wrapped into an IOException here.\nI believe it is a better approach, as with that other subcommands are not forced to declare to throw two types of exceptions.\nHowever as an alternative I am absolutely fine with declaring execute to throw an Exception, and do not mark specific Exceptions to be thrown, as the problem I see is the number of exceptions that method needs to declare and seems to declare implicitly for all SCM subcommands.", "author": "fapifta", "createdAt": "2020-12-11T00:22:54Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitCancellationMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitExitMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitFinishedMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitGeneralErrorMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.handleInvalidRequestAfterInitiatingFinalization;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isDone;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isFinalized;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isInprogress;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isStarting;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"finalizeupgrade\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {\n+  @CommandLine.Option(\n+      names = {\"--takeover\"},\n+      description = \"Forces takeover of monitoring from another client, if \"\n+          + \"finalization has already been started and did not finish yet.\"\n+  )\n+  private boolean force;\n+\n+  @Override\n+  public void execute(ScmClient scmClient)\n+      throws IOException, ExecutionException {\n+    String upgradeClientID = \"Upgrade-Client-\" + UUID.randomUUID().toString();\n+    try {\n+      StatusAndMessages finalizationResponse =\n+          scmClient.finalizeScmUpgrade(upgradeClientID);\n+      if (isFinalized(finalizationResponse.status())){\n+        System.out.println(\"Upgrade has already been finalized.\");\n+        emitExitMsg();\n+        return;\n+      } else if (!isStarting(finalizationResponse.status())){\n+        System.err.println(\"Invalid response from Storage Container Manager.\");\n+        System.err.println(\n+            \"Current finalization status is: \" + finalizationResponse.status()\n+        );\n+        throw new IOException(\"Exiting...\");\n+      }\n+    } catch (UpgradeException e) {\n+      handleInvalidRequestAfterInitiatingFinalization(force, e);\n+    }\n+    monitorAndWaitFinalization(scmClient, upgradeClientID);\n+    return;\n+  }\n+\n+  private void monitorAndWaitFinalization(ScmClient client,\n+                                          String upgradeClientID) throws\n+      ExecutionException {\n+    ExecutorService exec = Executors.newSingleThreadExecutor();\n+    Future<?> monitor =\n+        exec.submit(new UpgradeMonitor(client, upgradeClientID, force));\n+    try {\n+      monitor.get();\n+      emitFinishedMsg(\"Storage Container Manager\");\n+    } catch (CancellationException |InterruptedException e) {\n+      emitCancellationMsg(\"Storage Container Manager\");\n+    } catch (ExecutionException e) {\n+      emitGeneralErrorMsg();\n+      throw e;", "originalCommit": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc0ODY4Ng==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r540748686", "bodyText": "yup, I will make the change.", "author": "prashantpogde", "createdAt": "2020-12-11T07:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODc0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "128ec4a824bb05972a6f524739516361b9bf80d4", "chunk": "diff --git a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\nindex dd7229ba8..430fdb296 100644\n--- a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n+++ b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n\n@@ -64,8 +64,7 @@\n   private boolean force;\n \n   @Override\n-  public void execute(ScmClient scmClient)\n-      throws IOException, ExecutionException {\n+  public void execute(ScmClient scmClient) throws IOException {\n     String upgradeClientID = \"Upgrade-Client-\" + UUID.randomUUID().toString();\n     try {\n       StatusAndMessages finalizationResponse =\n"}}, {"oid": "128ec4a824bb05972a6f524739516361b9bf80d4", "url": "https://github.com/apache/ozone/commit/128ec4a824bb05972a6f524739516361b9bf80d4", "message": "HDDS-4178. Addressing review comments : part 3.", "committedDate": "2020-12-11T07:55:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5MTE3Mw==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r540791173", "bodyText": "Thank you for making this change, one more thing still regarding this part, I think it is more beneficial to do not swallow the stack trace of this exception and having it reported in the output, so can we provide e.getCause() instead of e.getMessage() here to the wrapping IOException?", "author": "fapifta", "createdAt": "2020-12-11T09:01:01Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitCancellationMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitExitMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitFinishedMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitGeneralErrorMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.handleInvalidRequestAfterInitiatingFinalization;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isDone;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isFinalized;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isInprogress;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isStarting;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"finalizeupgrade\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {\n+  @CommandLine.Option(\n+      names = {\"--takeover\"},\n+      description = \"Forces takeover of monitoring from another client, if \"\n+          + \"finalization has already been started and did not finish yet.\"\n+  )\n+  private boolean force;\n+\n+  @Override\n+  public void execute(ScmClient scmClient) throws IOException {\n+    String upgradeClientID = \"Upgrade-Client-\" + UUID.randomUUID().toString();\n+    try {\n+      StatusAndMessages finalizationResponse =\n+          scmClient.finalizeScmUpgrade(upgradeClientID);\n+      if (isFinalized(finalizationResponse.status())){\n+        System.out.println(\"Upgrade has already been finalized.\");\n+        emitExitMsg();\n+        return;\n+      } else if (!isStarting(finalizationResponse.status())){\n+        System.err.println(\"Invalid response from Storage Container Manager.\");\n+        System.err.println(\n+            \"Current finalization status is: \" + finalizationResponse.status()\n+        );\n+        throw new IOException(\"Exiting...\");\n+      }\n+    } catch (UpgradeException e) {\n+      handleInvalidRequestAfterInitiatingFinalization(force, e);\n+    }\n+    monitorAndWaitFinalization(scmClient, upgradeClientID);\n+    return;\n+  }\n+\n+  private void monitorAndWaitFinalization(ScmClient client,\n+                                          String upgradeClientID)\n+      throws IOException {\n+    ExecutorService exec = Executors.newSingleThreadExecutor();\n+    Future<?> monitor =\n+        exec.submit(new UpgradeMonitor(client, upgradeClientID, force));\n+    try {\n+      monitor.get();\n+      emitFinishedMsg(\"Storage Container Manager\");\n+    } catch (CancellationException |InterruptedException e) {\n+      emitCancellationMsg(\"Storage Container Manager\");\n+    } catch (ExecutionException e) {\n+      emitGeneralErrorMsg();\n+      throw new IOException(e.getMessage());", "originalCommit": "128ec4a824bb05972a6f524739516361b9bf80d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE2MzM4OA==", "url": "https://github.com/apache/ozone/pull/1651#discussion_r541163388", "bodyText": "Done.", "author": "prashantpogde", "createdAt": "2020-12-11T18:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5MTE3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6c921cafc3abe1fbb681c2d4f18364beba4c4cc7", "chunk": "diff --git a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\nindex 430fdb296..73533b98b 100644\n--- a/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n+++ b/hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java\n\n@@ -100,7 +100,7 @@ private void monitorAndWaitFinalization(ScmClient client,\n       emitCancellationMsg(\"Storage Container Manager\");\n     } catch (ExecutionException e) {\n       emitGeneralErrorMsg();\n-      throw new IOException(e.getMessage());\n+      throw new IOException(e.getCause());\n     } finally {\n       exec.shutdown();\n     }\n"}}, {"oid": "6c921cafc3abe1fbb681c2d4f18364beba4c4cc7", "url": "https://github.com/apache/ozone/commit/6c921cafc3abe1fbb681c2d4f18364beba4c4cc7", "message": "HDDS-4178. Addressing review comments : part 4.", "committedDate": "2020-12-11T17:33:15Z", "type": "commit"}, {"oid": "7a37268d73b6b89324e19458d30558b6dab9aa6d", "url": "https://github.com/apache/ozone/commit/7a37268d73b6b89324e19458d30558b6dab9aa6d", "message": "trigger new CI check", "committedDate": "2020-12-14T17:49:52Z", "type": "commit"}]}