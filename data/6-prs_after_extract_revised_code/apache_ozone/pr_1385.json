{"pr_number": 1385, "pr_title": "HDDS-3947: Sort DNs for client when the key is a file for #getFileStatus #listStatus APIs", "pr_createdAt": "2020-09-03T11:25:00Z", "pr_url": "https://github.com/apache/ozone/pull/1385", "timeline": [{"oid": "98663c83f9f87815b92d24faf41f6041fae71e68", "url": "https://github.com/apache/ozone/commit/98663c83f9f87815b92d24faf41f6041fae71e68", "message": "HDDS-3947: Sort DNs for client when the key is a file for #getFileStatus #listStatus APIs", "committedDate": "2020-09-03T11:19:57Z", "type": "commit"}, {"oid": "b016bfa01649b9d5d5cb2f98c92980b490c35a6e", "url": "https://github.com/apache/ozone/commit/b016bfa01649b9d5d5cb2f98c92980b490c35a6e", "message": "Fixed TestKeyManagerImpl conflicts", "committedDate": "2020-09-03T11:34:02Z", "type": "commit"}, {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2", "url": "https://github.com/apache/ozone/commit/0ec0ee3c192b491b1bb43091f59f86e313f18db2", "message": "Fixed checkstyle warnings", "committedDate": "2020-09-04T05:23:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzA5MQ==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483453091", "bodyText": "I think refreshPipeline condition was removed intentionally in HDDS-3658 and should not be restored.  (This is also causing failure of TestKeyManagerUnit.testLookupFileWithDnFailure unit test.)", "author": "adoroszlai", "createdAt": "2020-09-04T07:58:04Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -1783,7 +1802,9 @@ private OzoneFileStatus getOzoneFileStatus(String volumeName,\n \n       // if the key is a file then do refresh pipeline info in OM by asking SCM\n       if (fileKeyInfo != null) {\n-        refreshPipeline(fileKeyInfo);\n+        if (refreshPipeline) {", "originalCommit": "0ec0ee3c192b491b1bb43091f59f86e313f18db2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY0NTEwMQ==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483645101", "bodyText": "Thanks @adoroszlai again for the review help.\nYes, you are correct. Test passed locally without the if (refreshPipeline) condition.\nPoint-1) That means, the caller should callrefreshPipeline(OmKeyInfo value) method without the refreshPipeline condition.\nPoint-2) Also, I'm planning to move the refreshPipeline call outside BUCKET_LOCK and will be moving to here. Now, its a duplicate call added as part of HDDS-3658.\nDoes these two changes make sense to you?", "author": "rakeshadr", "createdAt": "2020-09-04T14:19:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY0OTQ4Nw==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483649487", "bodyText": "Yes, both points make sense.  Thanks for noticing the duplicate call.", "author": "adoroszlai", "createdAt": "2020-09-04T14:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwOTQ2Ng==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r489309466", "bodyText": "OK, Done!", "author": "rakeshadr", "createdAt": "2020-09-16T09:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzA5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "088e40d2f79ab0e8c6021523fd4e2b8db23127af", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java\nindex 4d05f48ee..681dc22ca 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java\n\n@@ -1802,9 +1802,10 @@ private OzoneFileStatus getOzoneFileStatus(String volumeName,\n \n       // if the key is a file then do refresh pipeline info in OM by asking SCM\n       if (fileKeyInfo != null) {\n-        if (refreshPipeline) {\n-          refreshPipeline(fileKeyInfo);\n-        }\n+        // refreshPipeline flag check has been removed as part of\n+        // https://issues.apache.org/jira/browse/HDDS-3658.\n+        // Please refer this jira for more details.\n+        refreshPipeline(fileKeyInfo);\n         if (sortDatanodes) {\n           sortDatanodeInPipeline(fileKeyInfo, clientAddress);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzU2Mw==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483453563", "bodyText": "@ChenSammi Was this instance of getRefreshPipeline condition retained in HDDS-3658 intentionally?", "author": "adoroszlai", "createdAt": "2020-09-04T07:58:55Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2144,10 +2166,14 @@ private void listStatusFindKeyInTableCache(\n       metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n           bucketName);\n     }\n-    if (args.getRefreshPipeline()) {\n-      for(OzoneFileStatus fileStatus : fileStatusList){\n+\n+    for (OzoneFileStatus fileStatus : fileStatusList) {\n+      if (args.getRefreshPipeline()) {", "originalCommit": "0ec0ee3c192b491b1bb43091f59f86e313f18db2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483491046", "bodyText": "In my comment on the previous PR:\n\nShould we also keep the two original methods?\n\nI meant both getFileStatus and listStatus.  Sorry if it was unclear.", "author": "adoroszlai", "createdAt": "2020-09-04T09:08:25Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java", "diffHunk": "@@ -49,6 +69,21 @@ OpenKeySession createFile(OmKeyArgs args, boolean isOverWrite,\n    */\n   OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress) throws IOException;\n \n+  /**\n+   * List the status for a file or a directory and its contents.\n+   *\n+   * @param keyArgs       the args of the key provided by client.\n+   * @param recursive     For a directory if true all the descendants of a\n+   *                      particular directory are listed\n+   * @param startKey      Key from which listing needs to start. If startKey\n+   *                      exists its status is included in the final list.\n+   * @param numEntries    Number of entries to list from the start key\n+   * @param clientAddress a hint to key manager, order the datanode in returned\n+   *                      pipeline by distance between client and datanode.\n+   * @return list of file status\n+   * @throws IOException if file or bucket or volume does not exist\n+   */\n   List<OzoneFileStatus> listStatus(OmKeyArgs keyArgs, boolean recursive,\n-      String startKey, long numEntries) throws IOException;\n+      String startKey, long numEntries, String clientAddress)", "originalCommit": "0ec0ee3c192b491b1bb43091f59f86e313f18db2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY0NTUyMg==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483645522", "bodyText": "Sure, I will make the changes in my next commit.", "author": "rakeshadr", "createdAt": "2020-09-04T14:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcyNzg3MA==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483727870", "bodyText": "@adoroszlai , Sorry for re-opening the discussion on this comment. On a second thought listStatus is only used in one place in the source code and there won't be any other caller for listStatus() without ClientAddress. So, how about deleting the original method and can add it later if there is any need ?", "author": "rakeshadr", "createdAt": "2020-09-04T16:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUxNzQyNg==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r488517426", "bodyText": "listStatus is only used in one place in the source code\n\nIt is also used by several tests, which all pass null as address.", "author": "adoroszlai", "createdAt": "2020-09-15T09:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwOTIwNA==", "url": "https://github.com/apache/ozone/pull/1385#discussion_r489309204", "bodyText": "OK, addressed in my new commit", "author": "rakeshadr", "createdAt": "2020-09-16T09:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "088e40d2f79ab0e8c6021523fd4e2b8db23127af", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java\nindex be28c9601..a7329c81c 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java\n\n@@ -69,6 +69,22 @@ OpenKeySession createFile(OmKeyArgs args, boolean isOverWrite,\n    */\n   OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress) throws IOException;\n \n+  /**\n+   * List the status for a file or a directory and its contents.\n+   *\n+   * @param keyArgs       the args of the key provided by client.\n+   * @param recursive     For a directory if true all the descendants of a\n+   *                      particular directory are listed\n+   * @param startKey      Key from which listing needs to start. If startKey\n+   *                      exists its status is included in the final list.\n+   * @param numEntries    Number of entries to list from the start key\n+   * @return list of file status\n+   * @throws IOException if file or bucket or volume does not exist\n+   */\n+  List<OzoneFileStatus> listStatus(OmKeyArgs keyArgs, boolean recursive,\n+                                   String startKey, long numEntries)\n+          throws IOException;\n+\n   /**\n    * List the status for a file or a directory and its contents.\n    *\n"}}, {"oid": "088e40d2f79ab0e8c6021523fd4e2b8db23127af", "url": "https://github.com/apache/ozone/commit/088e40d2f79ab0e8c6021523fd4e2b8db23127af", "message": "Fixed review comments - removed refreshPipeline check and added listStatus overloaded api", "committedDate": "2020-09-16T09:43:25Z", "type": "commit"}, {"oid": "b48a1ba19a1c96c1e83842b59c0cb0ccff2b802c", "url": "https://github.com/apache/ozone/commit/b48a1ba19a1c96c1e83842b59c0cb0ccff2b802c", "message": "Addressed comment - added clientAddress to #getFileStatus call from #listStatus", "committedDate": "2020-09-17T02:41:43Z", "type": "commit"}]}