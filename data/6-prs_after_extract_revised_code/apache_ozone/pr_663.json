{"pr_number": 663, "pr_title": "HDDS-3156 update allocateContainer to remove additional createPipeline step.", "pr_createdAt": "2020-03-11T08:37:42Z", "pr_url": "https://github.com/apache/ozone/pull/663", "timeline": [{"oid": "0d847c8307beab85bcf96a149ad47e544c2d4865", "url": "https://github.com/apache/ozone/commit/0d847c8307beab85bcf96a149ad47e544c2d4865", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer.", "committedDate": "2020-03-11T09:02:03Z", "type": "forcePushed"}, {"oid": "adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "url": "https://github.com/apache/ozone/commit/adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer.", "committedDate": "2020-03-11T10:36:22Z", "type": "forcePushed"}, {"oid": "2a827cf2593797b016fe1ee0b2e2c8c85969054c", "url": "https://github.com/apache/ozone/commit/2a827cf2593797b016fe1ee0b2e2c8c85969054c", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer.", "committedDate": "2020-03-11T13:23:04Z", "type": "forcePushed"}, {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55", "url": "https://github.com/apache/ozone/commit/ab3f2a047e424d51f63e77d3a4da190f14344d55", "message": "HDDS-3156 update allocateContainer to remove additional createPipeline step.", "committedDate": "2020-03-11T16:21:06Z", "type": "commit"}, {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55", "url": "https://github.com/apache/ozone/commit/ab3f2a047e424d51f63e77d3a4da190f14344d55", "message": "HDDS-3156 update allocateContainer to remove additional createPipeline step.", "committedDate": "2020-03-11T16:21:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0OTUwNw==", "url": "https://github.com/apache/ozone/pull/663#discussion_r391349507", "bodyText": "If ozone.scm.pipeline.creation.auto.factor.one is not disabled even ratis with factor one pipeline creation is taken care by BackGroundPipelineCreator.", "author": "bharatviswa504", "createdAt": "2020-03-12T00:54:22Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java", "diffHunk": "@@ -247,23 +247,29 @@ ContainerInfo allocateContainer(final PipelineManager pipelineManager,\n       final HddsProtos.ReplicationType type,\n       final HddsProtos.ReplicationFactor replicationFactor, final String owner)\n       throws IOException {\n-\n+    final List<Pipeline> pipelines = pipelineManager\n+        .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n     Pipeline pipeline;\n-    try {\n-      // TODO: #CLUTIL remove creation logic when all replication types and\n-      // factors are handled by pipeline creator job.\n-      pipeline = pipelineManager.createPipeline(type, replicationFactor);\n-      pipelineManager.waitPipelineReady(pipeline.getId(), 0);\n-    } catch (IOException e) {\n-      final List<Pipeline> pipelines = pipelineManager\n-          .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n-      if (pipelines.isEmpty()) {\n-        throw new IOException(\"Could not allocate container. Cannot get any\" +\n-            \" matching pipeline for Type:\" + type +\n-            \", Factor:\" + replicationFactor + \", State:PipelineState.OPEN\");\n-      }\n+\n+    if (!pipelines.isEmpty() && replicationFactor == ReplicationFactor.THREE\n+        && type == ReplicationType.RATIS) {\n+      // Let background create Ratis THREE pipelines.", "originalCommit": "ab3f2a047e424d51f63e77d3a4da190f14344d55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0OTY4Nw==", "url": "https://github.com/apache/ozone/pull/663#discussion_r391349687", "bodyText": "So, shall we need to check that config, if enabled and let factor 1 also be skipped here?", "author": "bharatviswa504", "createdAt": "2020-03-12T00:55:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0OTUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ3Mjc5Ng==", "url": "https://github.com/apache/ozone/pull/663#discussion_r391472796", "bodyText": "Yea, that's a good point. I update it.", "author": "timmylicheng", "createdAt": "2020-03-12T08:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0OTUwNw=="}], "type": "inlineReview", "revised_code": {"commit": "a37e2a320abb5eb9e0192c9221254400fb037357", "chunk": "diff --git a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java\nindex da3b42f9c..36259c49f 100644\n--- a/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java\n+++ b/hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java\n\n@@ -251,9 +255,13 @@ ContainerInfo allocateContainer(final PipelineManager pipelineManager,\n         .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n     Pipeline pipeline;\n \n-    if (!pipelines.isEmpty() && replicationFactor == ReplicationFactor.THREE\n-        && type == ReplicationType.RATIS) {\n-      // Let background create Ratis THREE pipelines.\n+    boolean bgCreateOne = (type == ReplicationType.RATIS) && replicationFactor\n+        == ReplicationFactor.ONE && autoCreateRatisOne;\n+    boolean bgCreateThree = (type == ReplicationType.RATIS) && replicationFactor\n+        == ReplicationFactor.THREE;\n+\n+    if (!pipelines.isEmpty() && (bgCreateOne || bgCreateThree)) {\n+      // let background create Ratis pipelines.\n       pipeline = pipelines.get((int) containerCount.get() % pipelines.size());\n     } else {\n       try {\n"}}, {"oid": "a37e2a320abb5eb9e0192c9221254400fb037357", "url": "https://github.com/apache/ozone/commit/a37e2a320abb5eb9e0192c9221254400fb037357", "message": "Consider ratis one pipeline when auto creatiom is disabled.", "committedDate": "2020-03-13T03:24:59Z", "type": "commit"}, {"oid": "a37e2a320abb5eb9e0192c9221254400fb037357", "url": "https://github.com/apache/ozone/commit/a37e2a320abb5eb9e0192c9221254400fb037357", "message": "Consider ratis one pipeline when auto creatiom is disabled.", "committedDate": "2020-03-13T03:24:59Z", "type": "forcePushed"}]}