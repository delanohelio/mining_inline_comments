{"pr_number": 880, "pr_title": "HDDS-3327. Fix s3api  create bucket BUCKET_NOT_FOUND and acl initialization problem when enable acl.", "pr_createdAt": "2020-04-28T15:10:00Z", "pr_url": "https://github.com/apache/ozone/pull/880", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MTQyMw==", "url": "https://github.com/apache/ozone/pull/880#discussion_r416791423", "bodyText": "Move this statement before if and use awsAccessId to check not null in if\nString awsAccessId = v4RequestParser.getAwsAccessId();\nif (awsAccessId != null) {", "author": "vivekratnavel", "createdAt": "2020-04-28T17:24:27Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -103,6 +107,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n+      } else if (isAclenable) {\n+        if (v4RequestParser.getAwsAccessId() != null) {\n+          String awsAccessId = v4RequestParser.getAwsAccessId();", "originalCommit": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "chunk": "diff --git a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\nindex fd69b1e6f..19a949e57 100644\n--- a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n+++ b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n\n@@ -107,9 +107,9 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n-      } else if (isAclenable) {\n-        if (v4RequestParser.getAwsAccessId() != null) {\n-          String awsAccessId = v4RequestParser.getAwsAccessId();\n+      } else if (isAclEnable) {\n+        String awsAccessId = v4RequestParser.getAwsAccessId();\n+        if (awsAccessId != null) {\n           UserGroupInformation remoteUser =\n               UserGroupInformation.createRemoteUser(awsAccessId);\n           UserGroupInformation.setLoginUser(remoteUser);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MTQ3Mw==", "url": "https://github.com/apache/ozone/pull/880#discussion_r416791473", "bodyText": "Rename variable to isAclEnabled for consistency in casing.", "author": "vivekratnavel", "createdAt": "2020-04-28T17:24:32Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -76,6 +78,8 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n+      Boolean isAclenable = config.getBoolean(", "originalCommit": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "chunk": "diff --git a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\nindex fd69b1e6f..19a949e57 100644\n--- a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n+++ b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n\n@@ -78,7 +78,7 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n-      Boolean isAclenable = config.getBoolean(\n+      Boolean isAclEnable = config.getBoolean(\n           OZONE_ACL_ENABLED, OZONE_ACL_ENABLED_DEFAULT);\n       if (OzoneSecurityUtil.isSecurityEnabled(config)) {\n         LOG.debug(\"Creating s3 auth info for client.\");\n"}}, {"oid": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "url": "https://github.com/apache/ozone/commit/d7c77c79b38fb9671c2fe48f34366437f93a6730", "message": "fix BUCKET_NOT_FOUND", "committedDate": "2020-04-29T02:04:40Z", "type": "commit"}, {"oid": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "url": "https://github.com/apache/ozone/commit/d7c77c79b38fb9671c2fe48f34366437f93a6730", "message": "fix BUCKET_NOT_FOUND", "committedDate": "2020-04-29T02:04:40Z", "type": "forcePushed"}, {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d", "url": "https://github.com/apache/ozone/commit/6917de3a70945a2db7a5341b80038f943d3beb7d", "message": "Always use awsAccessId to update the acl info.", "committedDate": "2020-04-29T09:38:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM4NDExMA==", "url": "https://github.com/apache/ozone/pull/880#discussion_r420384110", "bodyText": "Should we move the createRemoteUser, setLoginUser outside the if condition and addToken when security is enabled?", "author": "xiaoyuyao", "createdAt": "2020-05-05T20:25:17Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -103,6 +107,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n+      } else {", "originalCommit": "6917de3a70945a2db7a5341b80038f943d3beb7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "chunk": "diff --git a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\nindex fa45798b2..3cd7b7c5d 100644\n--- a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n+++ b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n\n@@ -97,24 +96,14 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n               identifier.getSignature().getBytes(UTF_8),\n               identifier.getKind(),\n               omService);\n-          UserGroupInformation remoteUser =\n-              UserGroupInformation.createRemoteUser(\n-                  v4RequestParser.getAwsAccessId());\n           remoteUser.addToken(token);\n-          UserGroupInformation.setLoginUser(remoteUser);\n         } catch (OS3Exception | URISyntaxException ex) {\n           LOG.error(\"S3 auth info creation failed.\");\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n-      } else {\n-        String awsAccessId = v4RequestParser.getAwsAccessId();\n-        if (awsAccessId != null) {\n-          UserGroupInformation remoteUser =\n-              UserGroupInformation.createRemoteUser(awsAccessId);\n-          UserGroupInformation.setLoginUser(remoteUser);\n-        }\n       }\n+      UserGroupInformation.setLoginUser(remoteUser);\n     } catch (Exception e) {\n       LOG.error(\"Error: \", e);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM4NDIxNg==", "url": "https://github.com/apache/ozone/pull/880#discussion_r420384216", "bodyText": "Do we still need this?", "author": "xiaoyuyao", "createdAt": "2020-05-05T20:25:29Z", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -76,6 +78,8 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n+      Boolean isAclEnable = config.getBoolean(", "originalCommit": "6917de3a70945a2db7a5341b80038f943d3beb7d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "chunk": "diff --git a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\nindex fa45798b2..3cd7b7c5d 100644\n--- a/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n+++ b/hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java\n\n@@ -78,8 +76,9 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n-      Boolean isAclEnable = config.getBoolean(\n-          OZONE_ACL_ENABLED, OZONE_ACL_ENABLED_DEFAULT);\n+      String awsAccessId = v4RequestParser.getAwsAccessId();\n+      UserGroupInformation remoteUser =\n+          UserGroupInformation.createRemoteUser(awsAccessId);\n       if (OzoneSecurityUtil.isSecurityEnabled(config)) {\n         LOG.debug(\"Creating s3 auth info for client.\");\n         try {\n"}}, {"oid": "fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "url": "https://github.com/apache/ozone/commit/fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "message": "fix review issues.", "committedDate": "2020-05-06T01:22:59Z", "type": "commit"}]}