{"pr_number": 1050, "pr_title": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage ", "pr_createdAt": "2020-06-10T13:44:13Z", "pr_url": "https://github.com/apache/ozone/pull/1050", "timeline": [{"oid": "97213e350f00152236a1c8609dd86aee3d696c87", "url": "https://github.com/apache/ozone/commit/97213e350f00152236a1c8609dd86aee3d696c87", "message": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage", "committedDate": "2020-06-15T15:39:49Z", "type": "commit"}, {"oid": "97213e350f00152236a1c8609dd86aee3d696c87", "url": "https://github.com/apache/ozone/commit/97213e350f00152236a1c8609dd86aee3d696c87", "message": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage", "committedDate": "2020-06-15T15:39:49Z", "type": "forcePushed"}, {"oid": "1d266ab46939d4a0213b59747b20f5fc292525b4", "url": "https://github.com/apache/ozone/commit/1d266ab46939d4a0213b59747b20f5fc292525b4", "message": "fix thread problem", "committedDate": "2020-06-16T16:58:25Z", "type": "commit"}, {"oid": "2ddef62c11d916ae6eaf3b3befc4b9829f28e0fa", "url": "https://github.com/apache/ozone/commit/2ddef62c11d916ae6eaf3b3befc4b9829f28e0fa", "message": "checkstyle fixes", "committedDate": "2020-06-16T19:56:20Z", "type": "commit"}, {"oid": "28d9cdf2e0e73598a9c6997c501f0e12255bc3db", "url": "https://github.com/apache/ozone/commit/28d9cdf2e0e73598a9c6997c501f0e12255bc3db", "message": "retrigger build with empty commit", "committedDate": "2020-06-17T12:04:52Z", "type": "commit"}, {"oid": "8b7a5582b0cba046198bbbccbf9651132826cf72", "url": "https://github.com/apache/ozone/commit/8b7a5582b0cba046198bbbccbf9651132826cf72", "message": "supress checkstye problem", "committedDate": "2020-06-17T15:56:44Z", "type": "commit"}, {"oid": "6886c22c521098747a98ac0042d09ca653d49437", "url": "https://github.com/apache/ozone/commit/6886c22c521098747a98ac0042d09ca653d49437", "message": "cleanup unnecessary changes", "committedDate": "2020-06-17T16:07:32Z", "type": "commit"}, {"oid": "b0a27c7f5881cc154cbfeff406b690ec9a0e406a", "url": "https://github.com/apache/ozone/commit/b0a27c7f5881cc154cbfeff406b690ec9a0e406a", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757", "committedDate": "2020-06-17T16:08:12Z", "type": "commit"}, {"oid": "5ab7fd30f15c42e4094e9176f8d30d186d51acb2", "url": "https://github.com/apache/ozone/commit/5ab7fd30f15c42e4094e9176f8d30d186d51acb2", "message": "retrigger build with empty commit", "committedDate": "2020-06-18T09:06:31Z", "type": "commit"}, {"oid": "31b28aa10e2babad8e54b14804d2a80f456a152f", "url": "https://github.com/apache/ozone/commit/31b28aa10e2babad8e54b14804d2a80f456a152f", "message": "fix path of the jacoco file", "committedDate": "2020-06-19T13:16:21Z", "type": "commit"}, {"oid": "76f2aefbda4d79b516c7035344a065566ae788ce", "url": "https://github.com/apache/ozone/commit/76f2aefbda4d79b516c7035344a065566ae788ce", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757", "committedDate": "2020-06-19T13:16:39Z", "type": "commit"}, {"oid": "3f7198ecfd7a0246d49470a85ebdba9b6094dc98", "url": "https://github.com/apache/ozone/commit/3f7198ecfd7a0246d49470a85ebdba9b6094dc98", "message": "use new style of testing", "committedDate": "2020-06-19T17:53:34Z", "type": "commit"}, {"oid": "c27a22b5f2865a7984ca4070dd370bd4ac06211c", "url": "https://github.com/apache/ozone/commit/c27a22b5f2865a7984ca4070dd370bd4ac06211c", "message": "acceptance only test", "committedDate": "2020-06-19T17:54:23Z", "type": "commit"}, {"oid": "1457eb90de01aca3d4ef99110f31f49a56e4fcc6", "url": "https://github.com/apache/ozone/commit/1457eb90de01aca3d4ef99110f31f49a56e4fcc6", "message": "Revert \"acceptance only test\"\n\nThis reverts commit c27a22b5f2865a7984ca4070dd370bd4ac06211c.", "committedDate": "2020-06-22T10:24:39Z", "type": "commit"}, {"oid": "b82507d2aa333d932eb82119febc2ff2d760bd6c", "url": "https://github.com/apache/ozone/commit/b82507d2aa333d932eb82119febc2ff2d760bd6c", "message": "Merge remote-tracking branch 'origin/master' into HDDS-3757", "committedDate": "2020-06-22T10:24:50Z", "type": "commit"}, {"oid": "d36ffb1990ede2541a56a9aafc960363d74201b7", "url": "https://github.com/apache/ozone/commit/d36ffb1990ede2541a56a9aafc960363d74201b7", "message": "run acceptance tests only", "committedDate": "2020-06-22T10:25:58Z", "type": "commit"}, {"oid": "f96a8f3d7efe4cacdb08fe6424c121e514f18812", "url": "https://github.com/apache/ozone/commit/f96a8f3d7efe4cacdb08fe6424c121e514f18812", "message": "Merge remote-tracking branch 'origin/master' into HDDS-3757", "committedDate": "2020-06-22T11:54:32Z", "type": "commit"}, {"oid": "1fd961cf195a62183ff5320f13e9c8457032a33c", "url": "https://github.com/apache/ozone/commit/1fd961cf195a62183ff5320f13e9c8457032a33c", "message": "no longer needs build", "committedDate": "2020-06-22T12:03:04Z", "type": "commit"}, {"oid": "31b2f0e3a98efe91635ce114f8b99d6387356623", "url": "https://github.com/apache/ozone/commit/31b2f0e3a98efe91635ce114f8b99d6387356623", "message": "fix checkout for PR", "committedDate": "2020-06-22T13:11:17Z", "type": "commit"}, {"oid": "feb74c36db9530d5326de05612cecf48b903062a", "url": "https://github.com/apache/ozone/commit/feb74c36db9530d5326de05612cecf48b903062a", "message": "restore other checks", "committedDate": "2020-06-22T15:14:16Z", "type": "commit"}, {"oid": "4c804260884244543162488db703a29cce343127", "url": "https://github.com/apache/ozone/commit/4c804260884244543162488db703a29cce343127", "message": "coverage depends on acceptance", "committedDate": "2020-06-22T15:15:05Z", "type": "commit"}, {"oid": "4f0ae379f5ff50ceff8a2cb72192db61daefe205", "url": "https://github.com/apache/ozone/commit/4f0ae379f5ff50ceff8a2cb72192db61daefe205", "message": "trigger new CI check", "committedDate": "2020-06-22T17:51:20Z", "type": "commit"}, {"oid": "e8cace0450c0b81d284ceb2c95b8640c662993f4", "url": "https://github.com/apache/ozone/commit/e8cace0450c0b81d284ceb2c95b8640c662993f4", "message": "retrigger build with empty commit", "committedDate": "2020-06-23T12:58:53Z", "type": "commit"}, {"oid": "3dcd13a50ec0f4b808d20172ed44e036e3dbae58", "url": "https://github.com/apache/ozone/commit/3dcd13a50ec0f4b808d20172ed44e036e3dbae58", "message": "retrigger build with empty commit", "committedDate": "2020-06-25T15:38:46Z", "type": "commit"}, {"oid": "9aa004aa8fcbcf6c91f788c00c2d7fe29efbf567", "url": "https://github.com/apache/ozone/commit/9aa004aa8fcbcf6c91f788c00c2d7fe29efbf567", "message": "Do not skip npx", "committedDate": "2020-06-25T18:29:20Z", "type": "commit"}, {"oid": "2858ea0935c68053427f5fef0189b0c2ccf92cf8", "url": "https://github.com/apache/ozone/commit/2858ea0935c68053427f5fef0189b0c2ccf92cf8", "message": "trigger new CI check", "committedDate": "2020-06-25T20:51:22Z", "type": "commit"}, {"oid": "3b06c431fbbca626e7748ef8eaf3d3591511b054", "url": "https://github.com/apache/ozone/commit/3b06c431fbbca626e7748ef8eaf3d3591511b054", "message": "trigger new CI check", "committedDate": "2020-06-26T01:38:12Z", "type": "commit"}, {"oid": "f0fc1bc017c1b00242d4c2c1c2994e26ef8dfda1", "url": "https://github.com/apache/ozone/commit/f0fc1bc017c1b00242d4c2c1c2994e26ef8dfda1", "message": "trigger new CI check", "committedDate": "2020-06-26T03:00:33Z", "type": "commit"}, {"oid": "539d2e03c84a4a9522f65a42feb682e9621c1e34", "url": "https://github.com/apache/ozone/commit/539d2e03c84a4a9522f65a42feb682e9621c1e34", "message": "retrigger build with empty commit", "committedDate": "2020-06-26T06:31:18Z", "type": "commit"}, {"oid": "760f0c6f6939dde1687a2090ea9db67ea5fdda5f", "url": "https://github.com/apache/ozone/commit/760f0c6f6939dde1687a2090ea9db67ea5fdda5f", "message": "trigger new CI check", "committedDate": "2020-06-26T08:18:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNzg1Ng==", "url": "https://github.com/apache/ozone/pull/1050#discussion_r446037856", "bodyText": "I've found that these calls to ExecutionDataWriter's methods should be synchronized to avoid producing garbage files, which result in the following exception when trying to read them:\nException in thread \"main\" java.io.UTFDataFormatException: malformed input around byte 2\n  at java.io.DataInputStream.readUTF(DataInputStream.java:634)\n  at java.io.DataInputStream.readUTF(DataInputStream.java:564)\n  at org.jacoco.cli.internal.core.data.ExecutionDataReader.readExecutionData(ExecutionDataReader.java:149)\n\nor similar Unknown block type error.", "author": "adoroszlai", "createdAt": "2020-06-26T08:17:44Z", "path": "hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.test;\n+\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+\n+import org.jacoco.core.data.ExecutionDataWriter;\n+import org.jacoco.core.runtime.RemoteControlReader;\n+import org.jacoco.core.runtime.RemoteControlWriter;\n+\n+/**\n+ * Simple TPC server to collect all the Jacoco coverage data.\n+ */\n+public final class JacocoServer {\n+\n+  private static int port = 6300;\n+\n+  private static String destinationFile = \"/tmp/jacoco-combined.exec\";\n+\n+  private JacocoServer() {\n+  }\n+\n+  @SuppressWarnings(\"checkstyle:EmptyStatement\")\n+  public static void main(String[] args) throws IOException {\n+    ExecutionDataWriter destination =\n+        new ExecutionDataWriter(new FileOutputStream(destinationFile));\n+    ServerSocket serverSocket = new ServerSocket(port);\n+    Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+      try {\n+        destination.flush();\n+        serverSocket.close();\n+      } catch (Exception ex) {\n+        ex.printStackTrace();\n+      }\n+    }));\n+\n+    while (true) {\n+      final Socket socket = serverSocket.accept();\n+      new Thread(() -> {\n+        try {\n+          RemoteControlWriter writer =\n+              new RemoteControlWriter(socket.getOutputStream());\n+          RemoteControlReader reader =\n+              new RemoteControlReader(socket.getInputStream());\n+          reader.setSessionInfoVisitor(destination::visitSessionInfo);\n+          reader.setExecutionDataVisitor(destination::visitClassExecution);\n+          while (reader.read()) {\n+            ;//read until the end of the stream.\n+          }\n+          destination.flush();", "originalCommit": "539d2e03c84a4a9522f65a42feb682e9621c1e34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEwNDA1Nw==", "url": "https://github.com/apache/ozone/pull/1050#discussion_r446104057", "bodyText": "Thanks to investigate it. I uploaded a synchronized version.\nThe main problem is that the same functionality is written in Jacoco project under LGPL which couldn't be imported. I wrote my own version from scratch, and this mistake clearly proves that it's independent, as I added my own mistakes ;-)", "author": "elek", "createdAt": "2020-06-26T10:31:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNzg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE2NzQxOA==", "url": "https://github.com/apache/ozone/pull/1050#discussion_r446167418", "bodyText": "destination.flush(); should be synced, too.", "author": "adoroszlai", "createdAt": "2020-06-26T12:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNzg1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjMwNDE0Ng==", "url": "https://github.com/apache/ozone/pull/1050#discussion_r446304146", "bodyText": "added.", "author": "elek", "createdAt": "2020-06-26T17:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNzg1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "20d61e6b8c7981b7d0c61d4257c4001b115725a8", "chunk": "diff --git a/hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java b/hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java\nindex 4aa590ec3a..46999faaaf 100644\n--- a/hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java\n+++ b/hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java\n\n@@ -23,6 +23,8 @@\n import java.net.Socket;\n \n import org.jacoco.core.data.ExecutionDataWriter;\n+import org.jacoco.core.data.IExecutionDataVisitor;\n+import org.jacoco.core.data.ISessionInfoVisitor;\n import org.jacoco.core.runtime.RemoteControlReader;\n import org.jacoco.core.runtime.RemoteControlWriter;\n \n"}}, {"oid": "20d61e6b8c7981b7d0c61d4257c4001b115725a8", "url": "https://github.com/apache/ozone/commit/20d61e6b8c7981b7d0c61d4257c4001b115725a8", "message": "syncrhonize jacoco file writes", "committedDate": "2020-06-26T10:27:00Z", "type": "commit"}, {"oid": "b96dc4656b1b5e296ba7720596107d70cda7f972", "url": "https://github.com/apache/ozone/commit/b96dc4656b1b5e296ba7720596107d70cda7f972", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757", "committedDate": "2020-06-26T10:29:06Z", "type": "commit"}, {"oid": "5583f82af36d540083d121bfeac9fc2aa20d8b27", "url": "https://github.com/apache/ozone/commit/5583f82af36d540083d121bfeac9fc2aa20d8b27", "message": "retrigger build with empty commit", "committedDate": "2020-06-26T12:10:41Z", "type": "commit"}, {"oid": "0da23f2fb0b299204e404cea3fc508815789c2fe", "url": "https://github.com/apache/ozone/commit/0da23f2fb0b299204e404cea3fc508815789c2fe", "message": "fix recon test (move it before admincli)", "committedDate": "2020-06-26T12:58:17Z", "type": "commit"}, {"oid": "3991ed34a375a5f0af0ebdbee48b56f39a9350ab", "url": "https://github.com/apache/ozone/commit/3991ed34a375a5f0af0ebdbee48b56f39a9350ab", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757", "committedDate": "2020-06-26T13:00:08Z", "type": "commit"}, {"oid": "36eff2eabad93adf169364b14c013283b6bfd8e7", "url": "https://github.com/apache/ozone/commit/36eff2eabad93adf169364b14c013283b6bfd8e7", "message": "retrigger build with empty commit", "committedDate": "2020-06-26T15:30:29Z", "type": "commit"}, {"oid": "5f9146f79b92793a34a8f802578559b99904f7fc", "url": "https://github.com/apache/ozone/commit/5f9146f79b92793a34a8f802578559b99904f7fc", "message": "retrigger build with empty commit", "committedDate": "2020-06-26T16:57:42Z", "type": "commit"}, {"oid": "af9874b924ff3f60bcb1b98fa5e11833f8fb0dc9", "url": "https://github.com/apache/ozone/commit/af9874b924ff3f60bcb1b98fa5e11833f8fb0dc9", "message": "syncrhonize flush", "committedDate": "2020-06-26T17:00:38Z", "type": "commit"}, {"oid": "507dcf811bc1cc407b8d095fe3272ddeed31e256", "url": "https://github.com/apache/ozone/commit/507dcf811bc1cc407b8d095fe3272ddeed31e256", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757", "committedDate": "2020-06-26T17:02:20Z", "type": "commit"}]}