{"pr_number": 1458, "pr_title": "HDDS-3728. Bucket space: check quotaUsageInBytes when write key and allocate block.", "pr_createdAt": "2020-09-30T07:15:08Z", "pr_url": "https://github.com/apache/ozone/pull/1458", "timeline": [{"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a", "url": "https://github.com/apache/ozone/commit/2b53f6922e264dfee085dc2499c94078a09d4f0a", "message": "add bucket quota check", "committedDate": "2020-09-30T07:03:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMTExNA==", "url": "https://github.com/apache/ozone/pull/1458#discussion_r502231114", "bodyText": "Are these two used somewhere?", "author": "ChenSammi", "createdAt": "2020-10-09T07:12:12Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -218,6 +219,8 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // update usedBytes atomically.\n       omVolumeArgs.getUsedBytes().add(preAllocatedSpace);\n       omBucketInfo.getUsedBytes().add(preAllocatedSpace);\n+      long vol = omVolumeArgs.getUsedBytes().sum();\n+      long buk = omBucketInfo.getUsedBytes().sum();", "originalCommit": "2b53f6922e264dfee085dc2499c94078a09d4f0a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI3OTk5OQ==", "url": "https://github.com/apache/ozone/pull/1458#discussion_r502279999", "bodyText": "Redundancy code,  will delete this.", "author": "captainzmc", "createdAt": "2020-10-09T08:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMTExNA=="}], "type": "inlineReview", "revised_code": {"commit": "77e57ca3323d714b58bf037a373f4f26ff7580d1", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java\nindex 2eb052b186..194e7ef9de 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java\n\n@@ -219,8 +219,6 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // update usedBytes atomically.\n       omVolumeArgs.getUsedBytes().add(preAllocatedSpace);\n       omBucketInfo.getUsedBytes().add(preAllocatedSpace);\n-      long vol = omVolumeArgs.getUsedBytes().sum();\n-      long buk = omBucketInfo.getUsedBytes().sum();\n \n       omResponse.setAllocateBlockResponse(AllocateBlockResponse.newBuilder()\n           .setKeyLocation(blockLocation).build());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjA5NA==", "url": "https://github.com/apache/ozone/pull/1458#discussion_r502232094", "bodyText": "Better check bucket quota before volume quota check.", "author": "ChenSammi", "createdAt": "2020-10-09T07:14:34Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -279,11 +279,12 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n       omBucketInfo = getBucketInfo(omMetadataManager, volumeName, bucketName);\n-      // check volume quota\n+      // check volume and bucket quota\n       long preAllocatedSpace = newLocationList.size()\n           * ozoneManager.getScmBlockSize()\n           * omKeyInfo.getFactor().getNumber();\n       checkVolumeQuotaInBytes(omVolumeArgs, preAllocatedSpace);\n+      checkBucketQuotaInBytes(omBucketInfo, preAllocatedSpace);", "originalCommit": "2b53f6922e264dfee085dc2499c94078a09d4f0a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "77e57ca3323d714b58bf037a373f4f26ff7580d1", "chunk": "diff --git a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java\nindex 90ac11b066..9a7f31aece 100644\n--- a/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java\n+++ b/hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java\n\n@@ -279,12 +279,12 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n       omBucketInfo = getBucketInfo(omMetadataManager, volumeName, bucketName);\n-      // check volume and bucket quota\n+      // check bucket and volume quota\n       long preAllocatedSpace = newLocationList.size()\n           * ozoneManager.getScmBlockSize()\n           * omKeyInfo.getFactor().getNumber();\n-      checkVolumeQuotaInBytes(omVolumeArgs, preAllocatedSpace);\n       checkBucketQuotaInBytes(omBucketInfo, preAllocatedSpace);\n+      checkVolumeQuotaInBytes(omVolumeArgs, preAllocatedSpace);\n \n       // Add to cache entry can be done outside of lock for this openKey.\n       // Even if bucket gets deleted, when commitKey we shall identify if\n"}}, {"oid": "77e57ca3323d714b58bf037a373f4f26ff7580d1", "url": "https://github.com/apache/ozone/commit/77e57ca3323d714b58bf037a373f4f26ff7580d1", "message": "fix review issues", "committedDate": "2020-10-09T08:42:51Z", "type": "commit"}]}