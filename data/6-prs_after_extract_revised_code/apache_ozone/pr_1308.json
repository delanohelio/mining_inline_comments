{"pr_number": 1308, "pr_title": "HDDS-1889. Add support for verifying multiline log entry", "pr_createdAt": "2020-08-10T12:51:15Z", "pr_url": "https://github.com/apache/ozone/pull/1308", "timeline": [{"oid": "29efbc9e57bf4bbb67dccd930641cfa540dd4691", "url": "https://github.com/apache/ozone/commit/29efbc9e57bf4bbb67dccd930641cfa540dd4691", "message": "checkstyle fix", "committedDate": "2020-08-10T12:43:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzUyNA==", "url": "https://github.com/apache/ozone/pull/1308#discussion_r467973524", "bodyText": "at ...TestOzoneAuditLogger.java:160\nThis is very fragile.  Any code change above line 160 (as benign as changing imports or whitespace) might break it.  Can you please omit the check for line number?", "author": "adoroszlai", "createdAt": "2020-08-10T15:11:29Z", "path": "hadoop-hdds/common/src/test/java/org/apache/hadoop/ozone/audit/TestOzoneAuditLogger.java", "diffHunk": "@@ -143,7 +150,35 @@ public void notLogReadEvents() throws IOException {\n     verifyNoLog();\n   }\n \n-  private void verifyLog(String expected) throws IOException {\n+  /**\n+   * Test to verify if multiline entries can be checked.\n+   */\n+\n+  @Test\n+  public void messageIncludesMultilineException() throws IOException {\n+    String exceptionMessage = \"Dummy exception message\";\n+    TestException testException = new TestException(exceptionMessage);\n+    AuditMessage exceptionAuditMessage =\n+        new AuditMessage.Builder()\n+            .setUser(USER)\n+            .atIp(IP_ADDRESS)\n+            .forOperation(DummyAction.CREATE_VOLUME)\n+            .withParams(PARAMS)\n+            .withResult(FAILURE)\n+            .withException(testException).build();\n+    AUDIT.logWriteFailure(exceptionAuditMessage);\n+    verifyLog(\n+        \"ERROR | OMAudit | user=john | \"\n+            + \"ip=192.168.0.1 | op=CREATE_VOLUME \"\n+            + \"{key1=value1, key2=value2} | ret=FAILURE\",\n+        \"org.apache.hadoop.ozone.audit.\"\n+            + \"TestOzoneAuditLogger$TestException: Dummy exception message\",\n+        \"at org.apache.hadoop.ozone.audit.TestOzoneAuditLogger\"\n+            + \".messageIncludesMultilineException\"\n+            + \"(TestOzoneAuditLogger.java:160) [test-classes/:?]\");", "originalCommit": "29efbc9e57bf4bbb67dccd930641cfa540dd4691", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMzMTQzMg==", "url": "https://github.com/apache/ozone/pull/1308#discussion_r468331432", "bodyText": "@adoroszlai indeed, thank you for pointing that out. Fixed in latest commit.", "author": "llemec", "createdAt": "2020-08-11T05:17:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "4f32464052a55416140758f138c6e9d9e6e1a98b", "chunk": "diff --git a/hadoop-hdds/common/src/test/java/org/apache/hadoop/ozone/audit/TestOzoneAuditLogger.java b/hadoop-hdds/common/src/test/java/org/apache/hadoop/ozone/audit/TestOzoneAuditLogger.java\nindex ec403ba578..30cdc62c5d 100644\n--- a/hadoop-hdds/common/src/test/java/org/apache/hadoop/ozone/audit/TestOzoneAuditLogger.java\n+++ b/hadoop-hdds/common/src/test/java/org/apache/hadoop/ozone/audit/TestOzoneAuditLogger.java\n\n@@ -175,7 +175,7 @@ public void messageIncludesMultilineException() throws IOException {\n             + \"TestOzoneAuditLogger$TestException: Dummy exception message\",\n         \"at org.apache.hadoop.ozone.audit.TestOzoneAuditLogger\"\n             + \".messageIncludesMultilineException\"\n-            + \"(TestOzoneAuditLogger.java:160) [test-classes/:?]\");\n+            + \"(TestOzoneAuditLogger.java\");\n   }\n \n   private void verifyLog(String... expectedStrings) throws IOException {\n"}}, {"oid": "4f32464052a55416140758f138c6e9d9e6e1a98b", "url": "https://github.com/apache/ozone/commit/4f32464052a55416140758f138c6e9d9e6e1a98b", "message": "removed line number from test as suggested in review", "committedDate": "2020-08-11T05:15:14Z", "type": "commit"}]}