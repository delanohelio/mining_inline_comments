{"pr_number": 650, "pr_title": "Object store/ base", "pr_createdAt": "2020-04-08T17:10:43Z", "pr_url": "https://github.com/phac-nml/irida/pull/650", "timeline": [{"oid": "8c2c6fab24eb0638a277ad088f0c7ce3cd067459", "url": "https://github.com/phac-nml/irida/commit/8c2c6fab24eb0638a277ad088f0c7ce3cd067459", "message": "Added base object store support (upload file to cloud, get file from cloud, display file size)", "committedDate": "2020-03-23T21:16:48Z", "type": "commit"}, {"oid": "ff216e9d5718e7b47a510eee24944a337884a410", "url": "https://github.com/phac-nml/irida/commit/ff216e9d5718e7b47a510eee24944a337884a410", "message": "Changed to service. Added comments", "committedDate": "2020-03-24T19:05:22Z", "type": "commit"}, {"oid": "517ba57e4ee39f3783000716aa4bb5af30e9abbe", "url": "https://github.com/phac-nml/irida/commit/517ba57e4ee39f3783000716aa4bb5af30e9abbe", "message": "fixed merge conflicts", "committedDate": "2020-03-26T16:58:54Z", "type": "commit"}, {"oid": "c80a6c5bb054066f6252564ced100da538162c0c", "url": "https://github.com/phac-nml/irida/commit/c80a6c5bb054066f6252564ced100da538162c0c", "message": "Created subclasses of sequence file to support local and cloud based storage. Updated creating of sequence files. Updated tests", "committedDate": "2020-03-28T00:18:10Z", "type": "commit"}, {"oid": "28b419bc0c339f90efdd11a239c256df21f2aa15", "url": "https://github.com/phac-nml/irida/commit/28b419bc0c339f90efdd11a239c256df21f2aa15", "message": "Refactored code", "committedDate": "2020-03-28T20:24:27Z", "type": "commit"}, {"oid": "fbaa2cf5c39a286ec372b3538bff1d85211c342a", "url": "https://github.com/phac-nml/irida/commit/fbaa2cf5c39a286ec372b3538bff1d85211c342a", "message": "Created separate services for azure, aws, and local storage which the bean instantiates depending on storage type.", "committedDate": "2020-04-01T03:23:02Z", "type": "commit"}, {"oid": "756694199b672acfee293001730141bb72a34488", "url": "https://github.com/phac-nml/irida/commit/756694199b672acfee293001730141bb72a34488", "message": "Updated file processors and tests to use iridafilestorageservice", "committedDate": "2020-04-01T17:00:38Z", "type": "commit"}, {"oid": "081b1d1c39992f54d6d163612d397712a20be83f", "url": "https://github.com/phac-nml/irida/commit/081b1d1c39992f54d6d163612d397712a20be83f", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-01T17:40:58Z", "type": "commit"}, {"oid": "d567a128c68e9a474e4e6850a6f64aa21b704831", "url": "https://github.com/phac-nml/irida/commit/d567a128c68e9a474e4e6850a6f64aa21b704831", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-07T15:28:58Z", "type": "commit"}, {"oid": "aaa48be3feb1f9c3e0d0cf3348e439e61ba62dcc", "url": "https://github.com/phac-nml/irida/commit/aaa48be3feb1f9c3e0d0cf3348e439e61ba62dcc", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-04-07T17:40:09Z", "type": "commit"}, {"oid": "2f7fb763df88f29a4fe6ffcd6e2aa18b28fdd605", "url": "https://github.com/phac-nml/irida/commit/2f7fb763df88f29a4fe6ffcd6e2aa18b28fdd605", "message": "Updated tests. Updated logic for sequencefile concatenation to work with the iridafilestoragefactory", "committedDate": "2020-04-08T17:09:47Z", "type": "commit"}, {"oid": "457d4f90bf21d9492941f00c6a6c3d49c8d08aca", "url": "https://github.com/phac-nml/irida/commit/457d4f90bf21d9492941f00c6a6c3d49c8d08aca", "message": "Set default value to local for storage type if not set in irida.conf or argument is not found. Removed controller methods which are now in the samplesajaxcontroller", "committedDate": "2020-04-08T18:31:17Z", "type": "commit"}, {"oid": "4d9c84400b1fe6c66e785ceb7ccdf1ffed3150dc", "url": "https://github.com/phac-nml/irida/commit/4d9c84400b1fe6c66e785ceb7ccdf1ffed3150dc", "message": "Moved default setting of irida.storage.type to filesystem.properties", "committedDate": "2020-04-08T18:39:47Z", "type": "commit"}, {"oid": "55650284aa1fd06b1be2707159236feaa0a1eea5", "url": "https://github.com/phac-nml/irida/commit/55650284aa1fd06b1be2707159236feaa0a1eea5", "message": "Removed unused imports and added missing javadoc comments", "committedDate": "2020-04-08T19:03:43Z", "type": "commit"}, {"oid": "8c712e4f2ee26b51a23afa3617fea986d1791822", "url": "https://github.com/phac-nml/irida/commit/8c712e4f2ee26b51a23afa3617fea986d1791822", "message": "Set default values for azure container and connection string if not found", "committedDate": "2020-04-08T19:10:18Z", "type": "commit"}, {"oid": "e9e990a2d6e2d3322ca67dc763c809e0532f83ec", "url": "https://github.com/phac-nml/irida/commit/e9e990a2d6e2d3322ca67dc763c809e0532f83ec", "message": "Added missing javadoc comments", "committedDate": "2020-04-08T19:39:24Z", "type": "commit"}, {"oid": "3a5f7308fa16c27f4cd9bc0a4ca57099b0e65078", "url": "https://github.com/phac-nml/irida/commit/3a5f7308fa16c27f4cd9bc0a4ca57099b0e65078", "message": "Added missing @param and @throws", "committedDate": "2020-04-08T20:11:59Z", "type": "commit"}, {"oid": "3d0dc9cae2051bb71b000f87e60060e6ff5dd0f6", "url": "https://github.com/phac-nml/irida/commit/3d0dc9cae2051bb71b000f87e60060e6ff5dd0f6", "message": "Fixed @throws text", "committedDate": "2020-04-08T20:30:43Z", "type": "commit"}, {"oid": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "url": "https://github.com/phac-nml/irida/commit/ba008ae0e244fc7c938a58e9c9988c16e95e1060", "message": "Removed iridafilestoragefactory from samplescontroller and samplescontrollertest as the code for which it was used has been moved to samplesajaxcontroller", "committedDate": "2020-04-08T20:44:56Z", "type": "commit"}, {"oid": "2805d1a0a0daa01fbb96ea533fdf8b88c78f2d5c", "url": "https://github.com/phac-nml/irida/commit/2805d1a0a0daa01fbb96ea533fdf8b88c78f2d5c", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-09T15:42:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5Mzc1Mw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r406293753", "bodyText": "Avoid getSuperClass if you can.  That gets us into dodgy places.", "author": "tom114", "createdAt": "2020-04-09T15:36:17Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java", "diffHunk": "@@ -215,9 +220,14 @@ private Type writeFilesToDisk(Path baseDirectory, Type objectToWrite) {\n \n \t\tPredicate<Field> pathFilter = f -> f.getType().equals(Path.class);\n \t\t// now find any members that are of type Path and shuffle them around:\n-\t\tSet<Field> pathFields = Arrays.stream(objectToWrite.getClass().getDeclaredFields()).filter(pathFilter)\n+\t\tSet<Field> pathFields = Arrays.stream(objectToWrite.getClass().getSuperclass().getDeclaredFields()).filter(pathFilter)", "originalCommit": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc3NDI3MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407774271", "bodyText": "Updated in 3569c6b", "author": "deepsidhu85", "createdAt": "2020-04-13T23:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5Mzc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3569c6bffc239051ba0b600141464aff94fcdd6e", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\nindex 24d8cd6afa..c118173414 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\n\n@@ -220,14 +219,9 @@ public abstract class FilesystemSupplementedRepositoryImpl<Type extends Versione\n \n \t\tPredicate<Field> pathFilter = f -> f.getType().equals(Path.class);\n \t\t// now find any members that are of type Path and shuffle them around:\n-\t\tSet<Field> pathFields = Arrays.stream(objectToWrite.getClass().getSuperclass().getDeclaredFields()).filter(pathFilter)\n+\t\tSet<Field> pathFields = Arrays.stream(FieldUtils.getAllFields(objectToWrite.getClass())).filter(pathFilter)\n \t\t\t\t.collect(Collectors.toSet());\n \n-\t\tif(pathFields.size() == 0) {\n-\t\t\tpathFields = Arrays.stream(objectToWrite.getClass().getDeclaredFields()).filter(pathFilter)\n-\t\t\t\t\t.collect(Collectors.toSet());\n-\t\t}\n-\n \t\tSet<Field> fieldsToUpdate = new HashSet<>();\n \t\tfor (Field field : pathFields) {\n \t\t\tReflectionUtils.makeAccessible(field);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NDY1MA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r406294650", "bodyText": "As much as we can avoid this if the better.  If the repo level can just call the filestorageservice to do its directory creation and such that would be better.  Keep the responsibility of managing files to that level if we can.", "author": "tom114", "createdAt": "2020-04-09T15:37:39Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java", "diffHunk": "@@ -238,28 +248,28 @@ private Type writeFilesToDisk(Path baseDirectory, Type objectToWrite) {\n \t\t\t\tPath source = (Path) ReflectionUtils.getField(field, objectToWrite);\n \t\t\t\tPath target = sequenceFileDirWithRevision.resolve(source.getFileName());\n \t\t\t\tlogger.debug(\"Target is [\" + target.toString() + \"]\");\n-\t\t\t\ttry {\n-\t\t\t\t\tif (!Files.exists(sequenceFileDir)) {\n-\t\t\t\t\t\tFiles.createDirectory(sequenceFileDir);\n-\t\t\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDir.toString() + \"]\");\n-\t\t\t\t\t}\n \n-\t\t\t\t\tif (!Files.exists(sequenceFileDirWithRevision)) {\n-\t\t\t\t\t\tFiles.createDirectory(sequenceFileDirWithRevision);\n-\t\t\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDirWithRevision.toString() + \"]\");\n-\t\t\t\t\t}\n+\t\t\t\tif(iridaFileStorageService.storageTypeIsLocal()) {", "originalCommit": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MzU3NQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407743575", "bodyText": "Updated in e9d5d85", "author": "deepsidhu85", "createdAt": "2020-04-13T21:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NDY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "e9d5d85b90d82ec70a6779780f6b0d0fd138cd82", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\nindex 24d8cd6afa..48bbd1ce3e 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/FilesystemSupplementedRepositoryImpl.java\n\n@@ -248,24 +248,7 @@ public abstract class FilesystemSupplementedRepositoryImpl<Type extends Versione\n \t\t\t\tPath source = (Path) ReflectionUtils.getField(field, objectToWrite);\n \t\t\t\tPath target = sequenceFileDirWithRevision.resolve(source.getFileName());\n \t\t\t\tlogger.debug(\"Target is [\" + target.toString() + \"]\");\n-\n-\t\t\t\tif(iridaFileStorageService.storageTypeIsLocal()) {\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tif (!Files.exists(sequenceFileDir)) {\n-\t\t\t\t\t\t\tFiles.createDirectory(sequenceFileDir);\n-\t\t\t\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDir.toString() + \"]\");\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tif (!Files.exists(sequenceFileDirWithRevision)) {\n-\t\t\t\t\t\t\tFiles.createDirectory(sequenceFileDirWithRevision);\n-\t\t\t\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDirWithRevision.toString() + \"]\");\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} catch (IOException e) {\n-\t\t\t\t\t\tlogger.error(\"Unable to create new directory\", e);\n-\t\t\t\t\t\tthrow new StorageException(\"Failed to create new directory.\", e);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tiridaFileStorageService.writeFile(source, target);\n+\t\t\t\tiridaFileStorageService.writeFile(source, target, sequenceFileDir, sequenceFileDirWithRevision);\n \t\t\t\tReflectionUtils.setField(field, objectToWrite, target);\n \t\t\t}\n \t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTQ4Mg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r406295482", "bodyText": "Really like what's happening with this class.  That's exactly what I'd hope to see with the interface and multiple implementations.", "author": "tom114", "createdAt": "2020-04-09T15:38:52Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAzureServiceImpl.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.util.Date;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.azure.storage.blob.BlobClient;\n+import com.azure.storage.blob.BlobContainerClient;\n+import com.azure.storage.blob.BlobServiceClient;\n+import com.azure.storage.blob.BlobServiceClientBuilder;\n+import com.azure.storage.blob.models.BlobStorageException;\n+\n+/**\n+ * Component implementation of file utitlities for azure storage\n+ */\n+@Component\n+public class IridaFileStorageAzureServiceImpl implements IridaFileStorageService {", "originalCommit": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MzI0NQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407743245", "bodyText": "Thanks :)", "author": "deepsidhu85", "createdAt": "2020-04-13T21:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NTQ4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e9d5d85b90d82ec70a6779780f6b0d0fd138cd82", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAzureServiceImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAzureServiceImpl.java\nindex 5d6671547c..7ba2efbf61 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAzureServiceImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageAzureServiceImpl.java\n\n@@ -87,7 +87,7 @@ public class IridaFileStorageAzureServiceImpl implements IridaFileStorageService\n \t * {@inheritDoc}\n \t */\n \t@Override\n-\tpublic void writeFile(Path source, Path target) {\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision) {\n \t\t// We set the blobClient \"path\" to which we want to upload our file to\n \t\tblobClient = containerClient.getBlobClient(target.toAbsolutePath()\n \t\t\t\t.toString()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NzczNw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r406297737", "bodyText": "You can check to see but this might not be necessary if you could do all the stuff from this file in the IridaFileStorageService instead.  You could maybe use that as the factory.  Play with it to see though.", "author": "tom114", "createdAt": "2020-04-09T15:42:06Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/IridaFileStorageFactoryImpl.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package ca.corefacility.bioinformatics.irida.service.impl;\n+\n+import java.nio.file.Path;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.CloudSequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.LocalSequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageService;\n+\n+/**\n+ * Service implementation for creating SequenceFiles {@link LocalSequenceFile} and {@link CloudSequenceFile}\n+ */\n+@Service\n+public class IridaFileStorageFactoryImpl {", "originalCommit": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MzE3MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407743171", "bodyText": "Removed the factory and moved the code to the iridafilestorageservice implementations in\nc8672d6", "author": "deepsidhu85", "createdAt": "2020-04-13T21:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5NzczNw=="}], "type": "inlineReview", "revised_code": {"commit": "c8672d656aba541db4571a30762c2c670de2ab59", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/service/impl/IridaFileStorageFactoryImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/service/impl/IridaFileStorageFactoryImpl.java\ndeleted file mode 100644\nindex 721b7fa768..0000000000\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/service/impl/IridaFileStorageFactoryImpl.java\n+++ /dev/null\n\n@@ -1,60 +0,0 @@\n-package ca.corefacility.bioinformatics.irida.service.impl;\n-\n-import java.nio.file.Path;\n-\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.stereotype.Service;\n-\n-import ca.corefacility.bioinformatics.irida.model.sequenceFile.CloudSequenceFile;\n-import ca.corefacility.bioinformatics.irida.model.sequenceFile.LocalSequenceFile;\n-import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n-import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageService;\n-\n-/**\n- * Service implementation for creating SequenceFiles {@link LocalSequenceFile} and {@link CloudSequenceFile}\n- */\n-@Service\n-public class IridaFileStorageFactoryImpl {\n-\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageFactoryImpl.class);\n-\tprivate IridaFileStorageService iridaFileStorageService;\n-\n-\t@Autowired\n-\tpublic IridaFileStorageFactoryImpl(IridaFileStorageService iridaFileStorageService) {\n-\t\tthis.iridaFileStorageService = iridaFileStorageService;\n-\t}\n-\n-\t/**\n-\t * Creates a {@link LocalSequenceFile} or {@link CloudSequenceFile} depending\n-\t * on the storage type.\n-\t *\n-\t * @param file The path to the file for which to create an object for\n-\t * @return a {@link LocalSequenceFile} or {@link CloudSequenceFile} as\n-\t * a {@link SequenceFile}\n-\t */\n-\tpublic SequenceFile createSequenceFile(Path file) {\n-\t\tif (iridaFileStorageService.storageTypeIsLocal()) {\n-\t\t\treturn new LocalSequenceFile(file);\n-\t\t} else {\n-\t\t\treturn new CloudSequenceFile(file);\n-\t\t}\n-\t}\n-\n-\t/**\n-\t * Creates an empty {@link LocalSequenceFile} or {@link CloudSequenceFile} depending\n-\t * on the storage type.\n-\t *\n-\t * @return an empty {@link LocalSequenceFile} or {@link CloudSequenceFile} object as\n-\t * a {@link SequenceFile}\n-\t */\n-\tpublic SequenceFile createEmptySequenceFile() {\n-\t\tif (iridaFileStorageService.storageTypeIsLocal()) {\n-\t\t\treturn new LocalSequenceFile();\n-\n-\t\t} else {\n-\t\t\treturn new CloudSequenceFile();\n-\t\t}\n-\t}\n-\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwMjQ5NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r406302494", "bodyText": "We haven't been using the @DiscriminatorColumn in our other inheritance strategies.  If you just leave it off, it automatically creates a DTYPE column with the class name`.\nI'll leave it to you whether to use the SINGLE_TABLE or JOINED approach.  In general we've preferred the JOINED approach because it means less unnecessary blank columns.  If it's just 1 or 2 empty columns it's not a big deal though.", "author": "tom114", "createdAt": "2020-04-09T15:49:08Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java", "diffHunk": "@@ -56,10 +37,15 @@\n  * particular {@link Sample}.\n  */\n @Entity\n+@Inheritance(strategy=InheritanceType.SINGLE_TABLE)\n+@DiscriminatorColumn(", "originalCommit": "ba008ae0e244fc7c938a58e9c9988c16e95e1060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA5NTA0NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407095044", "bodyText": "For this case it's probably best to use a SINGLE_TABLE approach as there are no extra fields being declared in the LocalSequenceFile or CloudSequenceFile classes", "author": "deepsidhu85", "createdAt": "2020-04-11T18:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwMjQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MzUwOQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r407743509", "bodyText": "Updated in e9d5d85", "author": "deepsidhu85", "createdAt": "2020-04-13T21:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMwMjQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "8dcfd9491da7f6605d7e5b284573e3a583776de9", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\nindex bf67914248..e1c898a6a9 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n\n@@ -44,12 +46,14 @@ import com.fasterxml.jackson.annotation.JsonIgnore;\n )\n @Table(name = \"sequence_file\")\n @Audited\n-@EntityListeners({ AuditingEntityListener.class, RelativePathTranslatorListener.class })\n+@EntityListeners({ AuditingEntityListener.class, RelativePathTranslatorListener.class, IridaFileStorageServiceListener.class })\n public abstract class SequenceFile extends IridaResourceSupport implements MutableIridaThing, Comparable<SequenceFile>,\n \t\tVersionedFileFields<Long>, IridaSequenceFile, RemoteSynchronizable {\n \n \tprivate static final Logger logger = LoggerFactory.getLogger(SequenceFile.class);\n \n+\tprivate static IridaFileStorageService iridaFileStorageService;\n+\n \t@Id\n \t@GeneratedValue(strategy = GenerationType.IDENTITY)\n \tprivate Long id;\n"}}, {"oid": "4b976252df1a3db51917b62a2b751464d70f9231", "url": "https://github.com/phac-nml/irida/commit/4b976252df1a3db51917b62a2b751464d70f9231", "message": "Merged dev and fixed merge conflict", "committedDate": "2020-04-09T22:02:14Z", "type": "commit"}, {"oid": "8dcfd9491da7f6605d7e5b284573e3a583776de9", "url": "https://github.com/phac-nml/irida/commit/8dcfd9491da7f6605d7e5b284573e3a583776de9", "message": "IridaFileStorageService is now wired into the sequencefile entity using @postload", "committedDate": "2020-04-10T02:59:43Z", "type": "commit"}, {"oid": "e9d5d85b90d82ec70a6779780f6b0d0fd138cd82", "url": "https://github.com/phac-nml/irida/commit/e9d5d85b90d82ec70a6779780f6b0d0fd138cd82", "message": "Removed discriminator column and discriminator values for sequencefile, localsequencefile, and cloud sequencefile and added a DTYPE to th the sequencefile table. Added iridafilestorageservice entity listener with provides the SequenceFile model with access to the iridiaFileStorageService after it has been loaded. Moved directory creation when using local storage into the iridafilestorage implementation for the local storage. Updated ProjectReferenceFileController to get the size of the reference file from the iridaFileStorageService", "committedDate": "2020-04-11T21:31:05Z", "type": "commit"}, {"oid": "c8672d656aba541db4571a30762c2c670de2ab59", "url": "https://github.com/phac-nml/irida/commit/c8672d656aba541db4571a30762c2c670de2ab59", "message": "Removed iridafilestoragefactory and moved sequencefile creation code into iridafilestorageservice", "committedDate": "2020-04-11T22:24:22Z", "type": "commit"}, {"oid": "8fa814cbe476213a6f6faa61dc43a61b5da9cbcd", "url": "https://github.com/phac-nml/irida/commit/8fa814cbe476213a6f6faa61dc43a61b5da9cbcd", "message": "Moved appendToFile and getFileExtension for the sequencefileconcatenator to the implementations for the iridafilestorageservice. Refactored code in azure iridafilestorage service", "committedDate": "2020-04-13T18:58:50Z", "type": "commit"}, {"oid": "8b5c5b0bae0b5fdf7413803d2c2fc93218c0cba4", "url": "https://github.com/phac-nml/irida/commit/8b5c5b0bae0b5fdf7413803d2c2fc93218c0cba4", "message": "Added a listener for GenomeAssembly to give the model access to iridaFileStorageService after loading the model.", "committedDate": "2020-04-13T21:03:27Z", "type": "commit"}, {"oid": "3569c6bffc239051ba0b600141464aff94fcdd6e", "url": "https://github.com/phac-nml/irida/commit/3569c6bffc239051ba0b600141464aff94fcdd6e", "message": "Changed 'private Path' to 'protected Path' so we don't need to use .getSuperClass in the writeFilesToDisk method. Changed debug statements in iridafilestorage azure service to trace.", "committedDate": "2020-04-13T23:19:28Z", "type": "commit"}, {"oid": "781c7b57d31768b153f1b57f8ef7502d6f401f93", "url": "https://github.com/phac-nml/irida/commit/781c7b57d31768b153f1b57f8ef7502d6f401f93", "message": "Updated jackson version to 2.10.3 as azure blob requires >= 2.10.1", "committedDate": "2020-04-13T23:22:22Z", "type": "commit"}, {"oid": "32521d0bb632e916a1edac0434f30e74702dd5bc", "url": "https://github.com/phac-nml/irida/commit/32521d0bb632e916a1edac0434f30e74702dd5bc", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-16T15:36:04Z", "type": "commit"}, {"oid": "e121004fdeeb6cbb9070faf5f3d454bd1d4495eb", "url": "https://github.com/phac-nml/irida/commit/e121004fdeeb6cbb9070faf5f3d454bd1d4495eb", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-20T20:54:05Z", "type": "commit"}, {"oid": "96988c29c7620a30dd059156a23aed3c79c213ce", "url": "https://github.com/phac-nml/irida/commit/96988c29c7620a30dd059156a23aed3c79c213ce", "message": "Removed aws and azure implementations from the base and will be put into individual implementations", "committedDate": "2020-04-20T21:18:14Z", "type": "commit"}, {"oid": "ba77462890a28e8eeb17db2571fd7b8ccdfc8816", "url": "https://github.com/phac-nml/irida/commit/ba77462890a28e8eeb17db2571fd7b8ccdfc8816", "message": "Removed aws and azure dependencies from pom as they are in separate branches", "committedDate": "2020-04-20T21:29:18Z", "type": "commit"}, {"oid": "163cafa7a846102905b39d5bf4f6bcf45af36015", "url": "https://github.com/phac-nml/irida/commit/163cafa7a846102905b39d5bf4f6bcf45af36015", "message": "Added newline", "committedDate": "2020-04-20T21:36:13Z", "type": "commit"}, {"oid": "4ebd4a0881382a834b289c009e166d9b4fb4160d", "url": "https://github.com/phac-nml/irida/commit/4ebd4a0881382a834b289c009e166d9b4fb4160d", "message": "Reverted tests as they are in another branch", "committedDate": "2020-04-20T22:20:29Z", "type": "commit"}, {"oid": "776546d8ba439f413b89f2f9b9679a1f2f9859bc", "url": "https://github.com/phac-nml/irida/commit/776546d8ba439f413b89f2f9b9679a1f2f9859bc", "message": "Removed newlines", "committedDate": "2020-04-20T22:26:46Z", "type": "commit"}, {"oid": "fb554ab4139a3c322d7e6c0c362a2276c8958658", "url": "https://github.com/phac-nml/irida/commit/fb554ab4139a3c322d7e6c0c362a2276c8958658", "message": "Updated changeset for sequence-file dtype", "committedDate": "2020-04-20T23:29:22Z", "type": "commit"}, {"oid": "b13db5862b22ca2e286103b78c67bb7dd76d8f1d", "url": "https://github.com/phac-nml/irida/commit/b13db5862b22ca2e286103b78c67bb7dd76d8f1d", "message": "Added default value for DTYPE", "committedDate": "2020-04-21T00:47:13Z", "type": "commit"}, {"oid": "efc8cfb005541a735b06c86670e7ff2d6f6aebac", "url": "https://github.com/phac-nml/irida/commit/efc8cfb005541a735b06c86670e7ff2d6f6aebac", "message": "Updated changeset to set a default value for dtype if one isn't provided", "committedDate": "2020-04-21T17:36:37Z", "type": "commit"}, {"oid": "4f86e81e46cf9e77434f4acf04a4173e6c11ed28", "url": "https://github.com/phac-nml/irida/commit/4f86e81e46cf9e77434f4acf04a4173e6c11ed28", "message": "Removed local and cloud sequence files as we can access the necessary data using the iridafilestorageservice in sequence file using @postload", "committedDate": "2020-04-22T00:19:59Z", "type": "commit"}, {"oid": "0b3307619fcb57db8f0e775614101e9bef09cb76", "url": "https://github.com/phac-nml/irida/commit/0b3307619fcb57db8f0e775614101e9bef09cb76", "message": "Updated tests", "committedDate": "2020-04-22T03:33:16Z", "type": "commit"}, {"oid": "4e4c1e16b076ff948285138ad56d7435c5953dba", "url": "https://github.com/phac-nml/irida/commit/4e4c1e16b076ff948285138ad56d7435c5953dba", "message": "Merge pull request #4 from deepsidhu85/object_store/_remove-sequence-file-extensions\n\nRemoved local and cloud sequence files as we can access the necessary\u2026", "committedDate": "2020-04-22T03:34:59Z", "type": "commit"}, {"oid": "b53cbd4edd8cfda9c4a6ab89dd41893dbee3d5e7", "url": "https://github.com/phac-nml/irida/commit/b53cbd4edd8cfda9c4a6ab89dd41893dbee3d5e7", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-04-22T14:42:27Z", "type": "commit"}, {"oid": "ac612b8e3c1695f82a346cadae65df756e19c840", "url": "https://github.com/phac-nml/irida/commit/ac612b8e3c1695f82a346cadae65df756e19c840", "message": "Reverted changes", "committedDate": "2020-04-22T14:49:52Z", "type": "commit"}, {"oid": "e9fd1c40da2e2c12b48c3c5ff80c93c0ad093ba8", "url": "https://github.com/phac-nml/irida/commit/e9fd1c40da2e2c12b48c3c5ff80c93c0ad093ba8", "message": "Removed unused imports", "committedDate": "2020-04-22T14:53:41Z", "type": "commit"}, {"oid": "69e3137d412125192c62b9090fdd9a1ccb3a483e", "url": "https://github.com/phac-nml/irida/commit/69e3137d412125192c62b9090fdd9a1ccb3a483e", "message": "Removed unused imports", "committedDate": "2020-04-22T14:57:53Z", "type": "commit"}, {"oid": "d54618ee31989fe484c4e4d5c9d1b6cc30f5a239", "url": "https://github.com/phac-nml/irida/commit/d54618ee31989fe484c4e4d5c9d1b6cc30f5a239", "message": "Mocked iridafilestorageservice instead of autowiring", "committedDate": "2020-04-22T15:59:45Z", "type": "commit"}, {"oid": "fed5fd3d68ed5cbbe16a18c53300cd501b022c29", "url": "https://github.com/phac-nml/irida/commit/fed5fd3d68ed5cbbe16a18c53300cd501b022c29", "message": "Removed mocks for iridafilestoragelocalserviceimpl and instantiated instead", "committedDate": "2020-04-22T16:59:52Z", "type": "commit"}, {"oid": "61de952cd33ca845f0677268ab66e9cd6c7c8995", "url": "https://github.com/phac-nml/irida/commit/61de952cd33ca845f0677268ab66e9cd6c7c8995", "message": "Fixed doc testing (removed imports not needed and added missing comments). Moved sequencefilelistener and genomeassemblylistener to a common file as both were providing access to the iridafilestorageservice in an entity on @postload", "committedDate": "2020-04-22T18:49:57Z", "type": "commit"}, {"oid": "3a7a9e26522c85bd89358029f453440cf4024e94", "url": "https://github.com/phac-nml/irida/commit/3a7a9e26522c85bd89358029f453440cf4024e94", "message": "Removed unused imports", "committedDate": "2020-04-22T19:37:40Z", "type": "commit"}, {"oid": "58be9671b4901b359166ebf93dbf5029b25e82f9", "url": "https://github.com/phac-nml/irida/commit/58be9671b4901b359166ebf93dbf5029b25e82f9", "message": "Merged object-store and fixed merge conflict", "committedDate": "2020-04-29T15:56:59Z", "type": "commit"}, {"oid": "521d4adb0b9a47bffc5089506c5123007e2d5684", "url": "https://github.com/phac-nml/irida/commit/521d4adb0b9a47bffc5089506c5123007e2d5684", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-04-30T18:54:39Z", "type": "commit"}, {"oid": "47847bb0134a55bc0daa6725dba9c24984990c73", "url": "https://github.com/phac-nml/irida/commit/47847bb0134a55bc0daa6725dba9c24984990c73", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-05-06T13:57:03Z", "type": "commit"}, {"oid": "d60666f588f3ca80cf05d13a56a58e697f9ae490", "url": "https://github.com/phac-nml/irida/commit/d60666f588f3ca80cf05d13a56a58e697f9ae490", "message": "Merge branch 'development' into object_store/_base", "committedDate": "2020-05-20T19:40:07Z", "type": "commit"}, {"oid": "1d43e744795d99792e40f41f7d8c2954a6c5313c", "url": "https://github.com/phac-nml/irida/commit/1d43e744795d99792e40f41f7d8c2954a6c5313c", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-05-22T23:32:55Z", "type": "commit"}, {"oid": "1fa610cb3b388fe5bab99bf2efee7ec38224ca95", "url": "https://github.com/phac-nml/irida/commit/1fa610cb3b388fe5bab99bf2efee7ec38224ca95", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-05-26T19:23:30Z", "type": "commit"}, {"oid": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "url": "https://github.com/phac-nml/irida/commit/c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-06-16T20:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjMzNA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441122334", "bodyText": "Is this here because VersionedFileFields doesn't have the setIridaFileStorageService method?  If so we can avoid the reflection by adding that method to the interface, or creating a different interface that has that method.  It would be much cleaner than having this reflection stuff.", "author": "tom114", "createdAt": "2020-06-16T20:28:40Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package ca.corefacility.bioinformatics.irida.repositories.entity.listeners;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+\n+import javax.persistence.PostLoad;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.context.support.SpringBeanAutowiringSupport;\n+\n+import ca.corefacility.bioinformatics.irida.model.VersionedFileFields;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageService;\n+\n+/**\n+ * Component implementation to run on an entity after it is has been accessed from the db.\n+ */\n+@Component\n+public class IridaFileStorageListener {\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageListener.class);\n+\n+\t@Autowired\n+\tprivate IridaFileStorageService iridaFileStorageService;\n+\n+\t/**\n+\t * After the entity is loaded this method will provide\n+\t * the entity access to the iridaFileStorageService\n+\t *\n+\t * @param fileSystemEntity The entity to provide the iridaFileStorageService to\n+\t */\n+\t@PostLoad\n+\tpublic void afterEntityLoad(final VersionedFileFields<Long> fileSystemEntity) {\n+\t\ttry {\n+\t\t\tSpringBeanAutowiringSupport.processInjectionBasedOnCurrentContext(this);\n+\t\t\t// Use reflection to get the setIridaFileStorageService method, make it accessible, and invoke it\n+\t\t\tMethod iridaFileStorageServiceSetter = fileSystemEntity.getClass()", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NjQ4OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441186488", "bodyText": "That plus we can't autowire in the IridaFileStorageService into the model classes so I added this file to provide that access to it after the entity is loaded. If we add it to the VersionedFileFields wouldn't we still have the issue of not being able to access it? I hope I'm talking about the same thing as your are :)", "author": "deepsidhu85", "createdAt": "2020-06-16T22:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIxNjUyNw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441216527", "bodyText": "Sorry I wasn't clear  I understand the listener, just I think you could get away from the reflection if you added a method setIridaFileStorageService in VersionedFileFields.  That way you wouldn't need the reflection stuff and could just call the method on fileSystemEntity.", "author": "tom114", "createdAt": "2020-06-17T00:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwODA0OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441708049", "bodyText": "I think I had just misunderstood you the first time! Thanks it all makes sense now", "author": "deepsidhu85", "createdAt": "2020-06-17T17:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjMzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjMyNg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441722326", "bodyText": "Updated in 8477bb9", "author": "deepsidhu85", "createdAt": "2020-06-17T17:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMjMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\nindex 81c773c426..6ed20b73e3 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\n\n@@ -1,8 +1,5 @@\n package ca.corefacility.bioinformatics.irida.repositories.entity.listeners;\n \n-import java.lang.reflect.InvocationTargetException;\n-import java.lang.reflect.Method;\n-\n import javax.persistence.PostLoad;\n \n import org.slf4j.Logger;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzQ2OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441123468", "bodyText": "Can we name this something other than a Service?  The way it functions is nice, but the name Service imples it's in the service layer of our tiers.  Since we use it all over the place it feels like it has a dependency cycle.  Even just something like IridaFileStorageUtility.", "author": "tom114", "createdAt": "2020-06-16T20:30:47Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageService.java", "diffHunk": "@@ -0,0 +1,128 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+\n+import com.google.common.collect.Lists;\n+\n+/**\n+ * Interface describing methods for performing storage actions\n+ */\n+\n+public interface IridaFileStorageService {", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NjY0Mg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441186642", "bodyText": "Good idea!", "author": "deepsidhu85", "createdAt": "2020-06-16T22:55:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzQ2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjQxMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441722413", "bodyText": "Updated in 8477bb9", "author": "deepsidhu85", "createdAt": "2020-06-17T17:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyMzQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageService.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\nsimilarity index 89%\nrename from src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageService.java\nrename to src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\nindex 219797eac3..5bd02239b8 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageService.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\n\n@@ -16,7 +16,7 @@ import com.google.common.collect.Lists;\n  * Interface describing methods for performing storage actions\n  */\n \n-public interface IridaFileStorageService {\n+public interface IridaFileStorageUtility {\n \t//Valid extensions to try to concatenate with this tool\n \tpublic static final List<String> VALID_EXTENSIONS = Lists.newArrayList(\"fastq\", \"fastq.gz\");\n \t/**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDYyNg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441124626", "bodyText": "Will we ever want a getter for this?  I feel like it should just be an internal thing of the class.", "author": "tom114", "createdAt": "2020-06-16T20:32:53Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java", "diffHunk": "@@ -307,4 +297,13 @@ public String getUploadSha256() {\n \tpublic void setUploadSha256(String uploadSha256) {\n \t\tthis.uploadSha256 = uploadSha256;\n \t}\n+\n+\tpublic IridaFileStorageService getIridaFileStorageService() {", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NzAyOA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441187028", "bodyText": "Nope I think this might be something I forgot to remove. I think I auto generated that", "author": "deepsidhu85", "createdAt": "2020-06-16T22:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjQ4Ng==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441722486", "bodyText": "Removed in 8477bb9", "author": "deepsidhu85", "createdAt": "2020-06-17T17:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\nindex 7078738931..b7683795fa 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n\n@@ -298,12 +301,24 @@ public class SequenceFile extends IridaResourceSupport implements MutableIridaTh\n \t\tthis.uploadSha256 = uploadSha256;\n \t}\n \n-\tpublic IridaFileStorageService getIridaFileStorageService() {\n-\t\treturn iridaFileStorageService;\n+\t@Override\n+\tpublic void setIridaFileStorageUtility(IridaFileStorageUtility iridaFileStorageUtility) {\n+\t\tthis.iridaFileStorageUtility = iridaFileStorageUtility;\n+\t}\n+\n+\tpublic InputStream getFileInputStream() {\n+\t\treturn iridaFileStorageUtility.getFileInputStream(getFile());\n \t}\n \n-\tpublic void setIridaFileStorageService(IridaFileStorageService iridaFileStorageService) {\n-\t\tthis.iridaFileStorageService = iridaFileStorageService;\n+\tpublic boolean isGzipped() throws Exception {\n+\t\treturn iridaFileStorageUtility.isGzipped(getFile());\n \t}\n \n+\tpublic File getTemporaryFile() {\n+\t\treturn iridaFileStorageUtility.getTemporaryFile(getFile());\n+\t}\n+\n+\tpublic boolean fileExists() {\n+\t\treturn iridaFileStorageUtility.fileExists(getFile());\n+\t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTA1OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441135059", "bodyText": "Why the blank methods?  If they're not to be used I think they should be removed from the interface and these implemetations until we need them.", "author": "tom114", "createdAt": "2020-06-16T20:52:46Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java", "diffHunk": "@@ -0,0 +1,217 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+\n+/**\n+ * Component implementation of file utitlities for local storage\n+ */\n+@Component\n+public class IridaFileStorageLocalServiceImpl implements IridaFileStorageService{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalServiceImpl.class);\n+\n+\t@Autowired\n+\tpublic IridaFileStorageLocalServiceImpl(){\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic File getTemporaryFile(Path file) {\n+\t\tFile fileToProcess = null;\n+\t\tfileToProcess = file.toFile();\n+\t\treturn fileToProcess;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic Long getFileSize(Path file) {\n+\t\tLong fileSize = 0L;\n+\t\ttry {\n+\t\t\tfileSize = Files.size(file);\n+\t\t} catch (NoSuchFileException e) {\n+\t\t\tlogger.error(\"Could not find file \" + file);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Could not calculate file size: \", e);\n+\t\t}\n+\n+\t\treturn fileSize;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision) {\n+\t\ttry {\n+\t\t\tif (!Files.exists(sequenceFileDir)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDir);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDir.toString() + \"]\");\n+\t\t\t}\n+\n+\t\t\tif (!Files.exists(sequenceFileDirWithRevision)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDirWithRevision);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDirWithRevision.toString() + \"]\");\n+\t\t\t}\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to create new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to create new directory.\", e);\n+\t\t}\n+\n+\t\ttry {\n+\t\t\tFiles.move(source, target);\n+\t\t\tlogger.trace(\"Moved file \" + source + \" to \" + target);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to move file into new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to move file into new directory.\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic void deleteFile() {", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NzIxNQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441187215", "bodyText": "Another thing I forgot to remove. I added these before I was made aware of how deleting files would be a pain. I will remove them", "author": "deepsidhu85", "createdAt": "2020-06-16T22:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTA1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjU1MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441722551", "bodyText": "Removed in 8477bb9", "author": "deepsidhu85", "createdAt": "2020-06-17T17:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTA1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nsimilarity index 93%\nrename from src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java\nrename to src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nindex 757697c5f9..99109f3af2 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n\n@@ -27,11 +27,11 @@ import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n  * Component implementation of file utitlities for local storage\n  */\n @Component\n-public class IridaFileStorageLocalServiceImpl implements IridaFileStorageService{\n-\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalServiceImpl.class);\n+public class IridaFileStorageLocalUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalUtilityImpl.class);\n \n \t@Autowired\n-\tpublic IridaFileStorageLocalServiceImpl(){\n+\tpublic IridaFileStorageLocalUtilityImpl(){\n \t}\n \n \t/**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTk1NQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441135955", "bodyText": "I love how the concern was moved here from the FilesystemSupplementedRepositoryImpl.  I think this was a good way to go with things.  When this all gets done we'll likely need to rename that file to something less \"filesystem\".", "author": "tom114", "createdAt": "2020-06-16T20:54:32Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java", "diffHunk": "@@ -0,0 +1,217 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+\n+/**\n+ * Component implementation of file utitlities for local storage\n+ */\n+@Component\n+public class IridaFileStorageLocalServiceImpl implements IridaFileStorageService{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalServiceImpl.class);\n+\n+\t@Autowired\n+\tpublic IridaFileStorageLocalServiceImpl(){\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic File getTemporaryFile(Path file) {\n+\t\tFile fileToProcess = null;\n+\t\tfileToProcess = file.toFile();\n+\t\treturn fileToProcess;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic Long getFileSize(Path file) {\n+\t\tLong fileSize = 0L;\n+\t\ttry {\n+\t\t\tfileSize = Files.size(file);\n+\t\t} catch (NoSuchFileException e) {\n+\t\t\tlogger.error(\"Could not find file \" + file);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Could not calculate file size: \", e);\n+\t\t}\n+\n+\t\treturn fileSize;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision) {\n+\t\ttry {\n+\t\t\tif (!Files.exists(sequenceFileDir)) {", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NzM1OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441187359", "bodyText": "Awesome thanks. Yeah it's going to need a rename for sure", "author": "deepsidhu85", "createdAt": "2020-06-16T22:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTk1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nsimilarity index 93%\nrename from src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java\nrename to src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nindex 757697c5f9..99109f3af2 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalServiceImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n\n@@ -27,11 +27,11 @@ import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n  * Component implementation of file utitlities for local storage\n  */\n @Component\n-public class IridaFileStorageLocalServiceImpl implements IridaFileStorageService{\n-\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalServiceImpl.class);\n+public class IridaFileStorageLocalUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalUtilityImpl.class);\n \n \t@Autowired\n-\tpublic IridaFileStorageLocalServiceImpl(){\n+\tpublic IridaFileStorageLocalUtilityImpl(){\n \t}\n \n \t/**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzOTM3NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441139374", "bodyText": "Should we maybe add some of these file methods into the model classes?  That way we don't need to wire the IridaFileStorageService into some places it maybe doesn't belong (like this class).\nSome examples I can see: getFileSize, getFileInputStream, maybe some of the other things that are like \"read\" operations on the file.", "author": "tom114", "createdAt": "2020-06-16T21:01:03Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java", "diffHunk": "@@ -93,12 +94,7 @@ public String getProjectReferenceFilesPage(final Model model, final Principal pr\n \t\t\tmap.put(\"label\", file.getLabel());\n \t\t\tmap.put(\"createdDate\", file.getCreatedDate());\n \t\t\tPath path = file.getFile();\n-\t\t\ttry {\n-\t\t\t\tmap.put(\"size\", Files.size(path));\n-\t\t\t} catch (IOException e) {\n-\t\t\t\tlogger.error(\"Cannot find the size of file \" + file.getLabel());\n-\t\t\t\tmap.put(\"size\", messageSource.getMessage(\"projects.reference-file.not-found\", new Object[] {}, locale));\n-\t\t\t}\n+\t\t\tmap.put(\"size\", iridaFileStorageService.getFileSize(path));", "originalCommit": "c572ba62bd15b3b97c6b300722a2efc7affdc6a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4NzU0MA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441187540", "bodyText": "Yup that's a good idea!", "author": "deepsidhu85", "createdAt": "2020-06-16T22:57:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzOTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMjY5OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441722699", "bodyText": "Updated in 8477bb9", "author": "deepsidhu85", "createdAt": "2020-06-17T17:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzOTM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java\nindex 6b9017c89f..b37a115a3a 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java\n\n@@ -94,7 +94,7 @@ public class ProjectReferenceFileController {\n \t\t\tmap.put(\"label\", file.getLabel());\n \t\t\tmap.put(\"createdDate\", file.getCreatedDate());\n \t\t\tPath path = file.getFile();\n-\t\t\tmap.put(\"size\", iridaFileStorageService.getFileSize(path));\n+\t\t\tmap.put(\"size\", iridaFileStorageUtility.getFileSize(path));\n \t\t\tfiles.add(map);\n \t\t}\n \t\treturn ImmutableMap.of(\"files\", files);\n"}}, {"oid": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "url": "https://github.com/phac-nml/irida/commit/8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "message": "Renamed IridaFileStorageService to IridaFileStorageUtility. Moved setIridaFileStorageUtility method into VersionedFields to remove unnecessary reflection. Removed methods not used. Added file methods to sequencefile so we can call them directly rather than autowiring in the iridafilestorageutility into files where it doesn't need to be", "committedDate": "2020-06-17T17:48:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTE5OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441789198", "bodyText": "This is likely one that should stay with the iridaFileStorageUtility.  It's not really an action on the SequenceFile, it's a filesystem option.", "author": "tom114", "createdAt": "2020-06-17T19:40:19Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java", "diffHunk": "@@ -307,4 +300,25 @@ public String getUploadSha256() {\n \tpublic void setUploadSha256(String uploadSha256) {\n \t\tthis.uploadSha256 = uploadSha256;\n \t}\n+\n+\t@Override\n+\tpublic void setIridaFileStorageUtility(IridaFileStorageUtility iridaFileStorageUtility) {\n+\t\tthis.iridaFileStorageUtility = iridaFileStorageUtility;\n+\t}\n+\n+\tpublic InputStream getFileInputStream() {\n+\t\treturn iridaFileStorageUtility.getFileInputStream(getFile());\n+\t}\n+\n+\tpublic boolean isGzipped() throws Exception {\n+\t\treturn iridaFileStorageUtility.isGzipped(getFile());\n+\t}\n+\n+\tpublic File getTemporaryFile() {", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxNTczNQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441815735", "bodyText": "I can have it call the method directly in iridaFileStorageUtility but then we will need to add it to the fileprocessor methods. My reasoning behind it was so we don't need to add it to the files such as FastQcFileProcessor and can call the method getTemporaryFile on a SequenceFile object which would call it in the iridaFileStorageLocalUtility etc", "author": "deepsidhu85", "createdAt": "2020-06-17T20:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkyMjMxMQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441922311", "bodyText": "Yeah understood we would have to wire that utility in to those places, but it feels like a big mixing of concerns to have a model object creating temporary files.\nThat said, we should think whether the temp files should just be created with the regular Files object locally anyway.  For cloud systems we likely wouldn't want to create temporary files on the cloud storage service anyway would we?  Maybe a local temp file that's then transferred up to the object store is enough?", "author": "tom114", "createdAt": "2020-06-18T01:45:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1MzU3NQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442253575", "bodyText": "We only use this method to get a temporary file from cloud storage to the local filesystem when we need to do something with the file. Like for example once a file is uploaded to the cloud and then the fastqcfileprocessor needs to run on the file. It will pull the file and run the processor", "author": "deepsidhu85", "createdAt": "2020-06-18T14:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyNzY0MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442927641", "bodyText": "Updated in 2f3e957", "author": "deepsidhu85", "createdAt": "2020-06-19T16:10:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "2f3e957f7a3a515362d5c8c107008236a1146e4d", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\nindex b7683795fa..429710412d 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/model/sequenceFile/SequenceFile.java\n\n@@ -314,10 +314,6 @@ public class SequenceFile extends IridaResourceSupport implements MutableIridaTh\n \t\treturn iridaFileStorageUtility.isGzipped(getFile());\n \t}\n \n-\tpublic File getTemporaryFile() {\n-\t\treturn iridaFileStorageUtility.getTemporaryFile(getFile());\n-\t}\n-\n \tpublic boolean fileExists() {\n \t\treturn iridaFileStorageUtility.fileExists(getFile());\n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQxNw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441789417", "bodyText": "Is this the right logic here?  Now fileToProcess isn't getting used.", "author": "tom114", "createdAt": "2020-06-17T19:40:44Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java", "diffHunk": "@@ -92,7 +97,7 @@ private void processSingleFile(SequenceFile sequenceFile) throws FileProcessorEx\n \t\t\t\t\t\tLocaleContextHolder.getLocale()));\n \t\ttry {\n \t\t\tuk.ac.babraham.FastQC.Sequence.SequenceFile fastQCSequenceFile = SequenceFactory.getSequenceFile(\n-\t\t\t\t\tfileToProcess.toFile());\n+\t\t\t\t\tsequenceFile.getTemporaryFile());", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMzIzNA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441813234", "bodyText": "That is correct. But if we want to keep the getTemporaryFile in the iridaFileStorageUtility classes rather than having a getTemporaryFile method in the SequenceFile then we will need to use it.", "author": "deepsidhu85", "createdAt": "2020-06-17T20:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkyMjQxMQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441922411", "bodyText": "Yeah understood.  We'll have to finish that conversation first.", "author": "tom114", "createdAt": "2020-06-18T01:45:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyNzczMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442927733", "bodyText": "Updated in 2f3e957", "author": "deepsidhu85", "createdAt": "2020-06-19T16:10:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "2f3e957f7a3a515362d5c8c107008236a1146e4d", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java\nindex af97b2023d..b8c20202d5 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java\n\n@@ -97,7 +97,7 @@ public class FastqcFileProcessor implements FileProcessor {\n \t\t\t\t\t\tLocaleContextHolder.getLocale()));\n \t\ttry {\n \t\t\tuk.ac.babraham.FastQC.Sequence.SequenceFile fastQCSequenceFile = SequenceFactory.getSequenceFile(\n-\t\t\t\t\tsequenceFile.getTemporaryFile());\n+\t\t\t\t\tiridaFileStorageUtility.getTemporaryFile(fileToProcess));\n \t\t\tBasicStats basicStats = new BasicStats();\n \t\t\tPerBaseQualityScores pbqs = new PerBaseQualityScores();\n \t\t\tPerSequenceQualityScores psqs = new PerSequenceQualityScores();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQ2Mw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441789463", "bodyText": "This isn't being used anymore.", "author": "tom114", "createdAt": "2020-06-17T19:40:50Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/FastqcFileProcessor.java", "diffHunk": "@@ -52,6 +54,7 @@\n \tprivate final SequenceFileRepository sequenceFileRepository;\n \tprivate final AnalysisOutputFileRepository outputFileRepository;\n \tprivate final MessageSource messageSource;\n+\tprivate IridaFileStorageUtility iridaFileStorageUtility;", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyOTYwNw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442929607", "bodyText": "This is now required as we moved the getTemporaryFile method out of the sequenceFile", "author": "deepsidhu85", "createdAt": "2020-06-19T16:14:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTQ2Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4OTgzNA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441789834", "bodyText": "I like this now.  Less cyclic dependencies.", "author": "tom114", "createdAt": "2020-06-17T19:41:30Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java", "diffHunk": "@@ -111,10 +110,10 @@ public void processSingleFile(SequenceFile sequenceFile) throws FileProcessorExc\n \n \t\ttry {\n \t\t\tlogger.trace(\"About to try handling a gzip file.\");\n-\t\t\tif (FileUtils.isGzipped(file)) {\n+\t\t\tif (sequenceFile.isGzipped()) {\n \t\t\t\tfile = addExtensionToFilename(file, GZIP_EXTENSION);\n \n-\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(Files.newInputStream(file))) {\n+\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(sequenceFile.getFileInputStream())) {", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "26c6867728ab9a3f95978ee45058e3710d0f5984", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\nindex 596103fb83..0ce5b695d3 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\n\n@@ -110,8 +110,10 @@ public class GzipFileProcessor implements FileProcessor {\n \n \t\ttry {\n \t\t\tlogger.trace(\"About to try handling a gzip file.\");\n+\n \t\t\tif (sequenceFile.isGzipped()) {\n \t\t\t\tfile = addExtensionToFilename(file, GZIP_EXTENSION);\n+\t\t\t\tsequenceFile.setFile(file);\n \n \t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(sequenceFile.getFileInputStream())) {\n \t\t\t\t\tlogger.trace(\"Handling gzip compressed file.\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MDEzMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441790133", "bodyText": "Is this line necessary?  If so can you add a comment why it's there?", "author": "tom114", "createdAt": "2020-06-17T19:42:03Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package ca.corefacility.bioinformatics.irida.repositories.entity.listeners;\n+\n+import javax.persistence.PostLoad;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.context.support.SpringBeanAutowiringSupport;\n+\n+import ca.corefacility.bioinformatics.irida.model.VersionedFileFields;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageUtility;\n+\n+/**\n+ * Component implementation to run on a versioned entity after it is has been accessed from the db.\n+ */\n+@Component\n+public class IridaFileStorageListener {\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageListener.class);\n+\n+\t@Autowired\n+\tprivate IridaFileStorageUtility iridaFileStorageUtility;\n+\n+\t/**\n+\t * After the versioned entity is loaded this method will provide\n+\t * the entity access to the iridaFileStorageUtility\n+\t *\n+\t * @param fileSystemEntity The versioned entity to provide the iridaFileStorageUtility to\n+\t */\n+\t@PostLoad\n+\tpublic void afterEntityLoad(final VersionedFileFields<Long> fileSystemEntity) {\n+\t\t\tSpringBeanAutowiringSupport.processInjectionBasedOnCurrentContext(this);", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMTg2OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441811868", "bodyText": "I should be able to remove this now", "author": "deepsidhu85", "createdAt": "2020-06-17T20:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyNzg1NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442927854", "bodyText": "This ended up being required. Added in 2f3e957", "author": "deepsidhu85", "createdAt": "2020-06-19T16:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MDEzMw=="}], "type": "inlineReview", "revised_code": {"commit": "2f3e957f7a3a515362d5c8c107008236a1146e4d", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\nindex 6ed20b73e3..900c510bc8 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/entity/listeners/IridaFileStorageListener.java\n\n@@ -29,6 +29,7 @@ public class IridaFileStorageListener {\n \t */\n \t@PostLoad\n \tpublic void afterEntityLoad(final VersionedFileFields<Long> fileSystemEntity) {\n+\t\t\t// Required so that Spring's IoC container can handle the injection\n \t\t\tSpringBeanAutowiringSupport.processInjectionBasedOnCurrentContext(this);\n \t\t\tfileSystemEntity.setIridaFileStorageUtility(iridaFileStorageUtility);\n \t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MDc3Nw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441790777", "bodyText": "This isn't used.  Is it used in later branches?", "author": "tom114", "createdAt": "2020-06-17T19:43:20Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+\n+import com.google.common.collect.Lists;\n+\n+/**\n+ * Interface describing methods for performing storage actions\n+ */\n+\n+public interface IridaFileStorageUtility {\n+\t//Valid extensions to try to concatenate with this tool\n+\tpublic static final List<String> VALID_EXTENSIONS = Lists.newArrayList(\"fastq\", \"fastq.gz\");\n+\t/**\n+\t * Get a temporarry file from storage\n+\t *\n+\t * @param file The {@link Path} to the file\n+\t * @return {@link File} which was retrieved from path\n+\t */\n+\tpublic File getTemporaryFile(Path file);\n+\n+\t/**\n+\t * Get file size in bytes\n+\t *\n+\t * @param file The {@link Path} to the file\n+\t * @return {@link Long} size of file retrieved from path\n+\t */\n+\tpublic Long getFileSize(Path file);\n+\n+\t/**\n+\t * Write file to storage (azure, aws, or local)\n+\t *\n+\t * @param source The {@link Path} to the file\n+\t * @param target The {@link Path} to where file should be moved\n+\t * @param sequenceFileDir The {@link Path} to sequence file directory\n+\t * @param sequenceFileDirWithRevision The {@link Path} to sequence file revision directory\n+\t */\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision);\n+\n+\t/**\n+\t * Returns if the storage type is local or not\n+\t *\n+\t * @return {@link Boolean#TRUE} if local, {@link Boolean#FALSE} if not.\n+\t */\n+\tpublic boolean storageTypeIsLocal();", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyODA1NQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442928055", "bodyText": "I think it was used in some later branches. If not I will remove in a future branch", "author": "deepsidhu85", "createdAt": "2020-06-19T16:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MDc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3dcf4f3235e7e62530f13147e1d0321600de0065", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\nindex 5bd02239b8..0597c7c1e1 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\n\n@@ -28,12 +28,12 @@ public interface IridaFileStorageUtility {\n \tpublic File getTemporaryFile(Path file);\n \n \t/**\n-\t * Get file size in bytes\n+\t * Get file size\n \t *\n \t * @param file The {@link Path} to the file\n \t * @return {@link Long} size of file retrieved from path\n \t */\n-\tpublic Long getFileSize(Path file);\n+\tpublic String getFileSize(Path file);\n \n \t/**\n \t * Write file to storage (azure, aws, or local)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTQ0OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441791449", "bodyText": "Want to add this method onto the ReferenceFile class the same as you added it to SequenceFile so it can get rid of the IridaFileStorageUtility dependency?", "author": "tom114", "createdAt": "2020-06-17T19:44:46Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/projects/settings/ProjectReferenceFileController.java", "diffHunk": "@@ -93,12 +94,7 @@ public String getProjectReferenceFilesPage(final Model model, final Principal pr\n \t\t\tmap.put(\"label\", file.getLabel());\n \t\t\tmap.put(\"createdDate\", file.getCreatedDate());\n \t\t\tPath path = file.getFile();\n-\t\t\ttry {\n-\t\t\t\tmap.put(\"size\", Files.size(path));\n-\t\t\t} catch (IOException e) {\n-\t\t\t\tlogger.error(\"Cannot find the size of file \" + file.getLabel());\n-\t\t\t\tmap.put(\"size\", messageSource.getMessage(\"projects.reference-file.not-found\", new Object[] {}, locale));\n-\t\t\t}\n+\t\t\tmap.put(\"size\", iridaFileStorageUtility.getFileSize(path));", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxMTU2MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441811561", "bodyText": "I have this added in a separate branch", "author": "deepsidhu85", "createdAt": "2020-06-17T20:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTQ0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTkxOA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r441791918", "bodyText": "Not used.", "author": "tom114", "createdAt": "2020-06-17T19:45:44Z", "path": "src/test/java/ca/corefacility/bioinformatics/irida/processing/impl/unit/ChecksumFileProcessorTest.java", "diffHunk": "@@ -17,17 +17,21 @@\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SingleEndSequenceFile;\n import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n import ca.corefacility.bioinformatics.irida.processing.impl.ChecksumFileProcessor;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageLocalUtilityImpl;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageUtility;\n import ca.corefacility.bioinformatics.irida.repositories.sequencefile.SequenceFileRepository;\n \n public class ChecksumFileProcessorTest {\n \tprivate ChecksumFileProcessor fileProcessor;\n \tprivate SequenceFileRepository sequenceFileRepository;\n \tprivate static final String FILE_CONTENTS = \">test read\\nACGTACTCATG\";\n \tprivate static final String CHECKSUM = \"aeaa0755dc44b393ffe12f02e9bd42b0169b12ca9c15708085db6a4ac9110ee0\";\n+\tprivate IridaFileStorageUtility iridaFileStorageUtility;\n \n \t@Before\n \tpublic void setUp() {\n \t\tsequenceFileRepository = mock(SequenceFileRepository.class);\n+\t\tiridaFileStorageUtility = new IridaFileStorageLocalUtilityImpl();", "originalCommit": "8477bb95ad7d2dd6a2e12591e61c4870bba42f7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkyOTE3Nw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r442929177", "bodyText": "Ended up needing this to set the iridaFileStorageUtility for the sequence file", "author": "deepsidhu85", "createdAt": "2020-06-19T16:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5MTkxOA=="}], "type": "inlineReview", "revised_code": {"commit": "2f3e957f7a3a515362d5c8c107008236a1146e4d", "chunk": "diff --git a/src/test/java/ca/corefacility/bioinformatics/irida/processing/impl/unit/ChecksumFileProcessorTest.java b/src/test/java/ca/corefacility/bioinformatics/irida/processing/impl/unit/ChecksumFileProcessorTest.java\nindex d64354071f..f09219178f 100644\n--- a/src/test/java/ca/corefacility/bioinformatics/irida/processing/impl/unit/ChecksumFileProcessorTest.java\n+++ b/src/test/java/ca/corefacility/bioinformatics/irida/processing/impl/unit/ChecksumFileProcessorTest.java\n\n@@ -38,7 +38,7 @@ public class ChecksumFileProcessorTest {\n \t@Test\n \tpublic void testChecksumCreated() throws IOException {\n \t\tfinal SequenceFile sf = constructSequenceFile();\n-\n+\t\tsf.setIridaFileStorageUtility(iridaFileStorageUtility);\n \t\tSingleEndSequenceFile so = new SingleEndSequenceFile(sf);\n \n \t\tfileProcessor.process(so);\n"}}, {"oid": "2f3e957f7a3a515362d5c8c107008236a1146e4d", "url": "https://github.com/phac-nml/irida/commit/2f3e957f7a3a515362d5c8c107008236a1146e4d", "message": "Removed getTemporaryFile() from SequenceFile. Updated tests.", "committedDate": "2020-06-18T20:34:48Z", "type": "commit"}, {"oid": "26c6867728ab9a3f95978ee45058e3710d0f5984", "url": "https://github.com/phac-nml/irida/commit/26c6867728ab9a3f95978ee45058e3710d0f5984", "message": "Fixed failing test (gzipped file without an extension) by setting file for sequence file after adding an extension to the file name", "committedDate": "2020-06-19T16:02:14Z", "type": "commit"}, {"oid": "716e4677e843155efa1dfd736ebc263f42c949cf", "url": "https://github.com/phac-nml/irida/commit/716e4677e843155efa1dfd736ebc263f42c949cf", "message": "Removed unused imports and added javadoc comments", "committedDate": "2020-06-19T16:44:59Z", "type": "commit"}, {"oid": "410d81be16b34c7bf54227182a20086e78f2ffc9", "url": "https://github.com/phac-nml/irida/commit/410d81be16b34c7bf54227182a20086e78f2ffc9", "message": "Removed fileExists from SequenceFile as it's not really a read operation and more of a filesystem operation", "committedDate": "2020-06-19T18:18:13Z", "type": "commit"}, {"oid": "0d7d0cf7048afec0807d5a840225ce44467aef7f", "url": "https://github.com/phac-nml/irida/commit/0d7d0cf7048afec0807d5a840225ce44467aef7f", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-06-23T17:44:25Z", "type": "commit"}, {"oid": "83cd0382f10cdd36f6cdd2270e63d2e4c6cb5f17", "url": "https://github.com/phac-nml/irida/commit/83cd0382f10cdd36f6cdd2270e63d2e4c6cb5f17", "message": "Fixed failing tests", "committedDate": "2020-06-23T19:04:08Z", "type": "commit"}, {"oid": "526bd1dc4fa7200ea0f138a8688237c9bb5c0c1e", "url": "https://github.com/phac-nml/irida/commit/526bd1dc4fa7200ea0f138a8688237c9bb5c0c1e", "message": "Reverted change", "committedDate": "2020-06-23T19:19:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ0OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444230448", "bodyText": "Something off with this comment.  Does this methond belong in here?", "author": "tom114", "createdAt": "2020-06-23T13:38:27Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+\n+import com.google.common.collect.Lists;\n+\n+/**\n+ * Interface describing methods for performing storage actions\n+ */\n+\n+public interface IridaFileStorageUtility {\n+\t//Valid extensions to try to concatenate with this tool\n+\tpublic static final List<String> VALID_EXTENSIONS = Lists.newArrayList(\"fastq\", \"fastq.gz\");\n+\t/**\n+\t * Get a temporarry file from storage\n+\t *\n+\t * @param file The {@link Path} to the file\n+\t * @return {@link File} which was retrieved from path\n+\t */\n+\tpublic File getTemporaryFile(Path file);\n+\n+\t/**\n+\t * Get file size in bytes\n+\t *\n+\t * @param file The {@link Path} to the file\n+\t * @return {@link Long} size of file retrieved from path\n+\t */\n+\tpublic Long getFileSize(Path file);\n+\n+\t/**\n+\t * Write file to storage (azure, aws, or local)\n+\t *\n+\t * @param source The {@link Path} to the file\n+\t * @param target The {@link Path} to where file should be moved\n+\t * @param sequenceFileDir The {@link Path} to sequence file directory\n+\t * @param sequenceFileDirWithRevision The {@link Path} to sequence file revision directory\n+\t */\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision);\n+\n+\t/**\n+\t * Returns if the storage type is local or not\n+\t *\n+\t * @return {@link Boolean#TRUE} if local, {@link Boolean#FALSE} if not.\n+\t */\n+\tpublic boolean storageTypeIsLocal();\n+\n+\t/**\n+\t * Gets the file name from the storage type that the file\n+\t * is saved to (azure, aws, or local disk)\n+\t *\n+\t * @param file The path to the file for which to get name for\n+\t * @return {@link String} The file name for the file\n+\t */\n+\tpublic String getFileName(Path file);\n+\n+\n+\t/**\n+\t * Checks if file exists\n+\t *\n+\t * @param file The path to the file\n+\t * @return true if file exists otherwise false\n+\t *\n+\t */\n+\tpublic boolean fileExists(Path file);\n+\n+\t/**\n+\t * Gets the file inputstream\n+\t *\n+\t * @param file The path to the file\n+\t * @return file inputstream\n+\t *\n+\t */\n+\tpublic InputStream getFileInputStream(Path file);\n+\n+\t/**\n+\t * Checks if file is gzipped\n+\t *\n+\t * @param file The path to the file\n+\t * @return true if file is gzipped otherwise false\n+\t * @throws IOException if file can't be read\n+\t *\n+\t */\n+\tpublic boolean isGzipped(Path file) throws IOException;\n+\n+\t/**\n+\t * Append a {@link SequenceFile} to a {@link Path} on the filesystem\n+\t *\n+\t * @param target the {@link Path} to append to\n+\t * @param file   the {@link SequenceFile} to append to the path\n+\t * @throws ConcatenateException if there is an error appending the file\n+\t */\n+\tpublic void appendToFile(Path target, SequenceFile file) throws ConcatenateException;\n+\n+\t/**\n+\t * Get the extension of the files to concatenate", "originalCommit": "410d81be16b34c7bf54227182a20086e78f2ffc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MjkzNw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444492937", "bodyText": "See comment for public String getFileExtension below", "author": "deepsidhu85", "createdAt": "2020-06-23T20:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwMjAyMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444502023", "bodyText": "Ok that's fine.  I think the comment here should be updated to remove \"to concatenate\".  It's a bit confusing since this isn't specifically an concatenation thing.", "author": "tom114", "createdAt": "2020-06-23T20:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNzEzOQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444507139", "bodyText": "Yeah I totally agree after looking at it. Will update it. Thanks!", "author": "deepsidhu85", "createdAt": "2020-06-23T21:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMTA5Mg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r447201092", "bodyText": "Updated in 660b10c", "author": "deepsidhu85", "createdAt": "2020-06-29T19:26:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ0OA=="}], "type": "inlineReview", "revised_code": {"commit": "3dcf4f3235e7e62530f13147e1d0321600de0065", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\nindex 5bd02239b8..0597c7c1e1 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageUtility.java\n\n@@ -28,12 +28,12 @@ public interface IridaFileStorageUtility {\n \tpublic File getTemporaryFile(Path file);\n \n \t/**\n-\t * Get file size in bytes\n+\t * Get file size\n \t *\n \t * @param file The {@link Path} to the file\n \t * @return {@link Long} size of file retrieved from path\n \t */\n-\tpublic Long getFileSize(Path file);\n+\tpublic String getFileSize(Path file);\n \n \t/**\n \t * Write file to storage (azure, aws, or local)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMzIxOQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444233219", "bodyText": "The Concatenator classes should likely be the ones throwing a ConcatenateException.  The IOException (or another exception) should maybe ride up to those classes before ConcatenateException gets thrown.", "author": "tom114", "createdAt": "2020-06-23T13:42:23Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java", "diffHunk": "@@ -0,0 +1,196 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+\n+/**\n+ * Component implementation of file utitlities for local storage\n+ */\n+@Component\n+public class IridaFileStorageLocalUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalUtilityImpl.class);\n+\n+\t@Autowired\n+\tpublic IridaFileStorageLocalUtilityImpl(){\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic File getTemporaryFile(Path file) {\n+\t\tFile fileToProcess = null;\n+\t\tfileToProcess = file.toFile();\n+\t\treturn fileToProcess;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic Long getFileSize(Path file) {\n+\t\tLong fileSize = 0L;\n+\t\ttry {\n+\t\t\tfileSize = Files.size(file);\n+\t\t} catch (NoSuchFileException e) {\n+\t\t\tlogger.error(\"Could not find file \" + file);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Could not calculate file size: \", e);\n+\t\t}\n+\n+\t\treturn fileSize;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision) {\n+\t\ttry {\n+\t\t\tif (!Files.exists(sequenceFileDir)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDir);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDir.toString() + \"]\");\n+\t\t\t}\n+\n+\t\t\tif (!Files.exists(sequenceFileDirWithRevision)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDirWithRevision);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDirWithRevision.toString() + \"]\");\n+\t\t\t}\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to create new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to create new directory.\", e);\n+\t\t}\n+\n+\t\ttry {\n+\t\t\tFiles.move(source, target);\n+\t\t\tlogger.trace(\"Moved file \" + source + \" to \" + target);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to move file into new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to move file into new directory.\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic boolean storageTypeIsLocal(){\n+\t\treturn true;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic String getFileName(Path file) {\n+\t\tString fileName = \"\";\n+\t\tfileName = file.getFileName().toString();\n+\t\treturn fileName;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic boolean fileExists(Path file) {\n+\t\treturn Files.exists(file);\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic InputStream getFileInputStream(Path file) {\n+\t\ttry {\n+\t\t\treturn Files.newInputStream(file, StandardOpenOption.READ);\n+\t\t} catch(IOException e) {\n+\t\t\tthrow new FileProcessorException(\"could not read file\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic boolean isGzipped(Path file) throws IOException {\n+\t\ttry (InputStream is = getFileInputStream(file)) {\n+\t\t\tbyte[] bytes = new byte[2];\n+\t\t\tis.read(bytes);\n+\t\t\treturn ((bytes[0] == (byte) (GZIPInputStream.GZIP_MAGIC))\n+\t\t\t\t\t&& (bytes[1] == (byte) (GZIPInputStream.GZIP_MAGIC >> 8)));\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic void appendToFile(Path target, SequenceFile file) throws ConcatenateException {\n+\n+\t\ttry (FileChannel out = FileChannel.open(target, StandardOpenOption.CREATE, StandardOpenOption.APPEND,\n+\t\t\t\tStandardOpenOption.WRITE)) {\n+\t\t\ttry (FileChannel in = FileChannel.open(file.getFile(), StandardOpenOption.READ)) {\n+\t\t\t\tfor (long p = 0, l = in.size(); p < l; ) {\n+\t\t\t\t\tp += in.transferTo(p, l - p, out);\n+\t\t\t\t}\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tthrow new ConcatenateException(\"Could not open input file for reading\", e);", "originalCommit": "410d81be16b34c7bf54227182a20086e78f2ffc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MjY3MA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444492670", "bodyText": "Sure I can update this", "author": "deepsidhu85", "createdAt": "2020-06-23T20:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMzIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIwMTE3OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r447201179", "bodyText": "Updated in 660b10c", "author": "deepsidhu85", "createdAt": "2020-06-29T19:26:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMzIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "3dcf4f3235e7e62530f13147e1d0321600de0065", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nindex 99109f3af2..f2aa4174b8 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n\n@@ -22,6 +22,7 @@ import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+import ca.corefacility.bioinformatics.irida.util.FileUtils;\n \n /**\n  * Component implementation of file utitlities for local storage\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNTA1Ng==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444235056", "bodyText": "Should this also stay in the concatenator classes?", "author": "tom114", "createdAt": "2020-06-23T13:44:51Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java", "diffHunk": "@@ -0,0 +1,196 @@\n+package ca.corefacility.bioinformatics.irida.repositories.filesystem;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.channels.FileChannel;\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n+import java.nio.file.Path;\n+import java.nio.file.StandardOpenOption;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import ca.corefacility.bioinformatics.irida.exceptions.ConcatenateException;\n+import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n+import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+\n+/**\n+ * Component implementation of file utitlities for local storage\n+ */\n+@Component\n+public class IridaFileStorageLocalUtilityImpl implements IridaFileStorageUtility{\n+\tprivate static final Logger logger = LoggerFactory.getLogger(IridaFileStorageLocalUtilityImpl.class);\n+\n+\t@Autowired\n+\tpublic IridaFileStorageLocalUtilityImpl(){\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic File getTemporaryFile(Path file) {\n+\t\tFile fileToProcess = null;\n+\t\tfileToProcess = file.toFile();\n+\t\treturn fileToProcess;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic Long getFileSize(Path file) {\n+\t\tLong fileSize = 0L;\n+\t\ttry {\n+\t\t\tfileSize = Files.size(file);\n+\t\t} catch (NoSuchFileException e) {\n+\t\t\tlogger.error(\"Could not find file \" + file);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Could not calculate file size: \", e);\n+\t\t}\n+\n+\t\treturn fileSize;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic void writeFile(Path source, Path target, Path sequenceFileDir, Path sequenceFileDirWithRevision) {\n+\t\ttry {\n+\t\t\tif (!Files.exists(sequenceFileDir)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDir);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDir.toString() + \"]\");\n+\t\t\t}\n+\n+\t\t\tif (!Files.exists(sequenceFileDirWithRevision)) {\n+\t\t\t\tFiles.createDirectory(sequenceFileDirWithRevision);\n+\t\t\t\tlogger.trace(\"Created directory: [\" + sequenceFileDirWithRevision.toString() + \"]\");\n+\t\t\t}\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to create new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to create new directory.\", e);\n+\t\t}\n+\n+\t\ttry {\n+\t\t\tFiles.move(source, target);\n+\t\t\tlogger.trace(\"Moved file \" + source + \" to \" + target);\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Unable to move file into new directory\", e);\n+\t\t\tthrow new StorageException(\"Failed to move file into new directory.\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic boolean storageTypeIsLocal(){\n+\t\treturn true;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic String getFileName(Path file) {\n+\t\tString fileName = \"\";\n+\t\tfileName = file.getFileName().toString();\n+\t\treturn fileName;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic boolean fileExists(Path file) {\n+\t\treturn Files.exists(file);\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic InputStream getFileInputStream(Path file) {\n+\t\ttry {\n+\t\t\treturn Files.newInputStream(file, StandardOpenOption.READ);\n+\t\t} catch(IOException e) {\n+\t\t\tthrow new FileProcessorException(\"could not read file\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@Override\n+\tpublic boolean isGzipped(Path file) throws IOException {\n+\t\ttry (InputStream is = getFileInputStream(file)) {\n+\t\t\tbyte[] bytes = new byte[2];\n+\t\t\tis.read(bytes);\n+\t\t\treturn ((bytes[0] == (byte) (GZIPInputStream.GZIP_MAGIC))\n+\t\t\t\t\t&& (bytes[1] == (byte) (GZIPInputStream.GZIP_MAGIC >> 8)));\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic void appendToFile(Path target, SequenceFile file) throws ConcatenateException {\n+\n+\t\ttry (FileChannel out = FileChannel.open(target, StandardOpenOption.CREATE, StandardOpenOption.APPEND,\n+\t\t\t\tStandardOpenOption.WRITE)) {\n+\t\t\ttry (FileChannel in = FileChannel.open(file.getFile(), StandardOpenOption.READ)) {\n+\t\t\t\tfor (long p = 0, l = in.size(); p < l; ) {\n+\t\t\t\t\tp += in.transferTo(p, l - p, out);\n+\t\t\t\t}\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tthrow new ConcatenateException(\"Could not open input file for reading\", e);\n+\t\t\t}\n+\n+\t\t} catch (IOException e) {\n+\t\t\tthrow new ConcatenateException(\"Could not open target file for writing\", e);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\tpublic String getFileExtension(List<? extends SequencingObject> toConcatenate) throws ConcatenateException {", "originalCommit": "410d81be16b34c7bf54227182a20086e78f2ffc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ5MjUyMA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444492520", "bodyText": "This and appendFile above were moved into the IridaFileStorageUtility*Impl files (Local, Azure, and AWS) as the local and cloud implementations have a different way of getting the file data. So keeping it in the concatenator class (SequencingObjectConcatenator) would not work.", "author": "deepsidhu85", "createdAt": "2020-06-23T20:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNTA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwMjE1Ng==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r444502156", "bodyText": "Understood.  Thanks.", "author": "tom114", "createdAt": "2020-06-23T20:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzNTA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3dcf4f3235e7e62530f13147e1d0321600de0065", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\nindex 99109f3af2..f2aa4174b8 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/repositories/filesystem/IridaFileStorageLocalUtilityImpl.java\n\n@@ -22,6 +22,7 @@ import ca.corefacility.bioinformatics.irida.exceptions.StorageException;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n import ca.corefacility.bioinformatics.irida.processing.FileProcessorException;\n+import ca.corefacility.bioinformatics.irida.util.FileUtils;\n \n /**\n  * Component implementation of file utitlities for local storage\n"}}, {"oid": "60f4aac137e7250b86bf891ff709f19eb128d697", "url": "https://github.com/phac-nml/irida/commit/60f4aac137e7250b86bf891ff709f19eb128d697", "message": "Removed isgzipped and getfileinputstream from sequencefile as they broke a lot of the tests.", "committedDate": "2020-06-24T22:04:28Z", "type": "commit"}, {"oid": "4fa9df951a8ca908154f048bcc41033f8c9c41de", "url": "https://github.com/phac-nml/irida/commit/4fa9df951a8ca908154f048bcc41033f8c9c41de", "message": "Added getiridafilestorageutility method to sequencefile which is called by the Fast5Object when setting the type", "committedDate": "2020-06-24T22:16:33Z", "type": "commit"}, {"oid": "6c06e3a0ad1ce747408d1d63193129f555fd17c4", "url": "https://github.com/phac-nml/irida/commit/6c06e3a0ad1ce747408d1d63193129f555fd17c4", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-06-25T12:55:58Z", "type": "commit"}, {"oid": "725b73cfebc7da35d2f3b54ba0e9366c1396e854", "url": "https://github.com/phac-nml/irida/commit/725b73cfebc7da35d2f3b54ba0e9366c1396e854", "message": "Merged object-store branch and removed unused imports", "committedDate": "2020-06-25T13:07:33Z", "type": "commit"}, {"oid": "3dcf4f3235e7e62530f13147e1d0321600de0065", "url": "https://github.com/phac-nml/irida/commit/3dcf4f3235e7e62530f13147e1d0321600de0065", "message": "Moved getFileSize out of SequenceFile model and updated Fast5Object model to no longer rely on iridaFileStorageUtility set in SequenceFile. Updated tests.", "committedDate": "2020-06-26T16:26:25Z", "type": "commit"}, {"oid": "bc0f800320b8908f93591eb059e07ab75b774341", "url": "https://github.com/phac-nml/irida/commit/bc0f800320b8908f93591eb059e07ab75b774341", "message": "Fixed tests. Removed unused imports. Added javadoc comments", "committedDate": "2020-06-26T18:13:06Z", "type": "commit"}, {"oid": "d57f0adbe638b532bfc4f53b415582077e4a4d55", "url": "https://github.com/phac-nml/irida/commit/d57f0adbe638b532bfc4f53b415582077e4a4d55", "message": "Fixed test", "committedDate": "2020-06-26T18:28:05Z", "type": "commit"}, {"oid": "94f05f1f4f2024b859a0de913931cf7be63d769d", "url": "https://github.com/phac-nml/irida/commit/94f05f1f4f2024b859a0de913931cf7be63d769d", "message": "Fixed issue with single end file not being deleted. Reverted change to test", "committedDate": "2020-06-26T20:48:05Z", "type": "commit"}, {"oid": "aa4cc7a84226f25c9b0f6681e9b112f60cd62141", "url": "https://github.com/phac-nml/irida/commit/aa4cc7a84226f25c9b0f6681e9b112f60cd62141", "message": "Updated sequencing runs details page (run_files) to work with getting file sizes from the iridaFileStorageUtility implementation", "committedDate": "2020-06-29T16:17:26Z", "type": "commit"}, {"oid": "39a1f32d23852993b105c2f79e5d26f4885bd426", "url": "https://github.com/phac-nml/irida/commit/39a1f32d23852993b105c2f79e5d26f4885bd426", "message": "Fixed typo in template. Fixed logic for creating a new sequenceFileList for each sequencing object", "committedDate": "2020-06-29T17:12:43Z", "type": "commit"}, {"oid": "660b10c024aff6e9ee61bcf60eb6f05820f8fa01", "url": "https://github.com/phac-nml/irida/commit/660b10c024aff6e9ee61bcf60eb6f05820f8fa01", "message": "Updated which exceptions are thrown when getting file extensions and appending files. Updated method comments", "committedDate": "2020-06-29T19:24:47Z", "type": "commit"}, {"oid": "295deea2ff19f2a7196243e135ac84c9bccde830", "url": "https://github.com/phac-nml/irida/commit/295deea2ff19f2a7196243e135ac84c9bccde830", "message": "Updated throws exception", "committedDate": "2020-06-29T21:31:21Z", "type": "commit"}, {"oid": "bb473520319daca580837dbc4ed1ca61cb2eab8f", "url": "https://github.com/phac-nml/irida/commit/bb473520319daca580837dbc4ed1ca61cb2eab8f", "message": "Added IOException to @throws and added catch block for IOException", "committedDate": "2020-06-30T14:21:56Z", "type": "commit"}, {"oid": "b2d4822cd63d9292b42167d83f42d0f85f2171ac", "url": "https://github.com/phac-nml/irida/commit/b2d4822cd63d9292b42167d83f42d0f85f2171ac", "message": "Updated tests to except IOException", "committedDate": "2020-06-30T14:44:02Z", "type": "commit"}, {"oid": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "url": "https://github.com/phac-nml/irida/commit/ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "message": "Updated doc testing", "committedDate": "2020-06-30T14:51:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4MzI5NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449683294", "bodyText": "Why protected?  Is there subclassing of this anywhere?", "author": "tom114", "createdAt": "2020-07-03T18:58:43Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/project/ReferenceFile.java", "diffHunk": "@@ -44,7 +44,7 @@\n \n \t@Column(name = \"filePath\", unique = true)\n \t@NotNull(message = \"{reference.file.file.notnull}\")\n-\tprivate Path file;\n+\tprotected Path file;", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4MzM2MQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449683361", "bodyText": "Same deal in UploadedAssembly", "author": "tom114", "createdAt": "2020-07-03T18:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4MzI5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NDU5NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449684594", "bodyText": "and AnalysisOutputFile.java", "author": "tom114", "createdAt": "2020-07-03T19:05:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4MzI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "165d0c43e10722b416655fbe62e2155040f811fb", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/model/project/ReferenceFile.java b/src/main/java/ca/corefacility/bioinformatics/irida/model/project/ReferenceFile.java\nindex 0dcab3c252..522246b416 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/model/project/ReferenceFile.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/model/project/ReferenceFile.java\n\n@@ -44,7 +44,7 @@ public class ReferenceFile implements VersionedFileFields<Long>, MutableIridaThi\n \n \t@Column(name = \"filePath\", unique = true)\n \t@NotNull(message = \"{reference.file.file.notnull}\")\n-\tprotected Path file;\n+\tprivate Path file;\n \n \t@CreatedDate\n \t@NotNull\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NDQ5OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449684498", "bodyText": "Hrm.  Ok now pulling out that utility causes a problem now with creating these files.  The 2 stage creation here of the constructor with the file and setType is a problem because the object isn't valid until both of those are called.\n2 solutions I can think of:\n\nAdd isGzipped to the constructor.\nJust get the type based on the file extension in the constructor.  if ends in .gz, it's Fast5Type.ZIPPED.  if ends in .fast5 its a Fast5Type.SINGLE, etc.\n\nI would lean towards option 2.  We're already pulling the extension to check.  Reading the file to confirm it's a zip file is nice, but probably not really necessary in this case because we can usually rely on the fact that a zipped file will be called .gz.", "author": "tom114", "createdAt": "2020-07-03T19:05:19Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java", "diffHunk": "@@ -189,6 +192,8 @@ private void createSequenceFileInSample(MultipartFile file, Sample sample) throw\n \t */\n \tprivate void createFast5FileInSample(MultipartFile file, Sample sample) throws IOException {\n \t\tSequenceFile sequenceFile = createSequenceFile(file);\n+\t\tFast5Object fast5Object = new Fast5Object(sequenceFile);\n+\t\tfast5Object.setType(iridaFileStorageUtility.isGzipped(sequenceFile.getFile()));", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "165d0c43e10722b416655fbe62e2155040f811fb", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\nindex bb8a5f479f..ecd0e1ce12 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\n\n@@ -193,7 +193,6 @@ public class SamplesAjaxController {\n \tprivate void createFast5FileInSample(MultipartFile file, Sample sample) throws IOException {\n \t\tSequenceFile sequenceFile = createSequenceFile(file);\n \t\tFast5Object fast5Object = new Fast5Object(sequenceFile);\n-\t\tfast5Object.setType(iridaFileStorageUtility.isGzipped(sequenceFile.getFile()));\n \t\tsequencingObjectService.createSequencingObjectInSample(new Fast5Object(sequenceFile), sample);\n \t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NTAzNQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449685035", "bodyText": "If you wrap this line in a 2nd try/catch that re-throws the ConcatenateException, you don't have to worry about this method throwing IOException.  That way everything calling this method doesn't need to also handle IOException", "author": "tom114", "createdAt": "2020-07-03T19:08:29Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/processing/concatenate/impl/SequenceFilePairConcatenator.java", "diffHunk": "@@ -5,28 +5,37 @@\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFilePair;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n import ca.corefacility.bioinformatics.irida.processing.concatenate.SequencingObjectConcatenator;\n+import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageUtility;\n \n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.util.List;\n \n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n /**\n  * {@link SequencingObjectConcatenator} for {@link SequenceFilePair}s\n  */\n+@Component\n public class SequenceFilePairConcatenator extends SequencingObjectConcatenator<SequenceFilePair> {\n-\t\n-\tpublic SequenceFilePairConcatenator() {\n+\n+\tprivate IridaFileStorageUtility iridaFileStorageUtility;\n+\n+\t@Autowired\n+\tpublic SequenceFilePairConcatenator(IridaFileStorageUtility iridaFileStorageUtility) {\n+\t\tthis.iridaFileStorageUtility = iridaFileStorageUtility;\n \t}\n \n \t/**\n \t * {@inheritDoc}\n \t */\n \t@Override\n \tpublic SequenceFilePair concatenateFiles(List<? extends SequencingObject> toConcatenate, String filename)\n-\t\t\tthrows ConcatenateException {\n+\t\t\tthrows ConcatenateException, IOException {\n \n-\t\tString extension = getFileExtension(toConcatenate);\n+\t\tString extension = iridaFileStorageUtility.getFileExtension(toConcatenate);", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NTI2NA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449685264", "bodyText": "Same deal with SingleEndSequenceFileConcatenator.java.  Then you can remove it from the method signature in SequencingObjectConcatenator.java and it'll remove all your exception testing changes down below.", "author": "tom114", "createdAt": "2020-07-03T19:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NTAzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "69343634fe14ff86c31763c0dca8cd1bf3083350", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/processing/concatenate/impl/SequenceFilePairConcatenator.java b/src/main/java/ca/corefacility/bioinformatics/irida/processing/concatenate/impl/SequenceFilePairConcatenator.java\nindex 7d22d42d46..abfc0f424c 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/processing/concatenate/impl/SequenceFilePairConcatenator.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/processing/concatenate/impl/SequenceFilePairConcatenator.java\n\n@@ -5,7 +5,7 @@ import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFile;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequenceFilePair;\n import ca.corefacility.bioinformatics.irida.model.sequenceFile.SequencingObject;\n import ca.corefacility.bioinformatics.irida.processing.concatenate.SequencingObjectConcatenator;\n-import ca.corefacility.bioinformatics.irida.repositories.filesystem.IridaFileStorageUtility;\n+import ca.corefacility.bioinformatics.irida.util.IridaFiles;\n \n import java.io.IOException;\n import java.nio.file.Files;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NTQ1Ng==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449685456", "bodyText": "It's too bad we've had to go back and forth on this, but when you look at the change this way I think it makes sense.  It's a direct change to iridaFileStorageUtility.getFileInputStream from Files.newInputStream.  I think that abstraction works.", "author": "tom114", "createdAt": "2020-07-03T19:10:53Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java", "diffHunk": "@@ -111,10 +114,12 @@ public void processSingleFile(SequenceFile sequenceFile) throws FileProcessorExc\n \n \t\ttry {\n \t\t\tlogger.trace(\"About to try handling a gzip file.\");\n-\t\t\tif (FileUtils.isGzipped(file)) {\n+\n+\t\t\tif (iridaFileStorageUtility.isGzipped(file)) {\n \t\t\t\tfile = addExtensionToFilename(file, GZIP_EXTENSION);\n+\t\t\t\tsequenceFile.setFile(file);\n \n-\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(Files.newInputStream(file))) {\n+\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(iridaFileStorageUtility.getFileInputStream(file))) {", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "165d0c43e10722b416655fbe62e2155040f811fb", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\nindex 55345459a5..8981f16e28 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/processing/impl/GzipFileProcessor.java\n\n@@ -115,11 +115,11 @@ public class GzipFileProcessor implements FileProcessor {\n \t\ttry {\n \t\t\tlogger.trace(\"About to try handling a gzip file.\");\n \n-\t\t\tif (iridaFileStorageUtility.isGzipped(file)) {\n+\t\t\tif (sequenceFile.isGzipped()) {\n \t\t\t\tfile = addExtensionToFilename(file, GZIP_EXTENSION);\n \t\t\t\tsequenceFile.setFile(file);\n \n-\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(iridaFileStorageUtility.getFileInputStream(file))) {\n+\t\t\t\ttry (GZIPInputStream zippedInputStream = new GZIPInputStream(sequenceFile.getFileInputStream())) {\n \t\t\t\t\tlogger.trace(\"Handling gzip compressed file.\");\n \n \t\t\t\t\tPath targetDirectory = Files.createTempDirectory(null);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NTcyNg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449685726", "bodyText": "This sort of stuff is one of the biggest pains with adding the filestorageutility, but I guess it's just something we'll have to deal with.", "author": "tom114", "createdAt": "2020-07-03T19:12:28Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/pipelines/PipelineController.java", "diffHunk": "@@ -225,18 +230,31 @@ public String getSpecifiedPipelinePage(final Model model, Principal principal, L\n \t\t\t\t\t\tif (description.acceptsPairedSequenceFiles()) {\n \t\t\t\t\t\t\tCollection<SampleSequencingObjectJoin> pairs = sequencingObjectService.getSequencesForSampleOfType(\n \t\t\t\t\t\t\t\t\tsample, SequenceFilePair.class);\n-\t\t\t\t\t\t\tfiles.put(\"paired_end\", pairs.stream()\n-\t\t\t\t\t\t\t\t\t.map(SampleSequencingObjectJoin::getObject)\n-\t\t\t\t\t\t\t\t\t.collect(Collectors.toList()));\n+\n+\t\t\t\t\t\t\tList<PairedEndFiles> pairedEndFilesList = new ArrayList<>();\n+\t\t\t\t\t\t\tfor(SampleSequencingObjectJoin p : pairs) {\n+\t\t\t\t\t\t\t\tSequenceFilePair pair = (SequenceFilePair) p.getObject();\n+\t\t\t\t\t\t\t\tString forwardFileSize = iridaFileStorageUtility.getFileSize(pair.getForwardSequenceFile().getFile());\n+\t\t\t\t\t\t\t\tString reverseFileSize = iridaFileStorageUtility.getFileSize(pair.getReverseSequenceFile().getFile());", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "165d0c43e10722b416655fbe62e2155040f811fb", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/pipelines/PipelineController.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/pipelines/PipelineController.java\nindex 03a5554ec4..2ae32d9c28 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/pipelines/PipelineController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/pipelines/PipelineController.java\n\n@@ -231,30 +226,19 @@ public class PipelineController extends BaseController {\n \t\t\t\t\t\t\tCollection<SampleSequencingObjectJoin> pairs = sequencingObjectService.getSequencesForSampleOfType(\n \t\t\t\t\t\t\t\t\tsample, SequenceFilePair.class);\n \n-\t\t\t\t\t\t\tList<PairedEndFiles> pairedEndFilesList = new ArrayList<>();\n-\t\t\t\t\t\t\tfor(SampleSequencingObjectJoin p : pairs) {\n-\t\t\t\t\t\t\t\tSequenceFilePair pair = (SequenceFilePair) p.getObject();\n-\t\t\t\t\t\t\t\tString forwardFileSize = iridaFileStorageUtility.getFileSize(pair.getForwardSequenceFile().getFile());\n-\t\t\t\t\t\t\t\tString reverseFileSize = iridaFileStorageUtility.getFileSize(pair.getReverseSequenceFile().getFile());\n-\t\t\t\t\t\t\t\tpairedEndFilesList.add(new PairedEndFiles(pair, forwardFileSize, reverseFileSize));\n-\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\tfiles.put(\"paired_end\", pairedEndFilesList);\n+\t\t\t\t\t\t\tfiles.put(\"paired_end\", pairs.stream()\n+\t\t\t\t\t\t\t\t\t.map(SampleSequencingObjectJoin::getObject)\n+\t\t\t\t\t\t\t\t\t.collect(Collectors.toList()));\n \t\t\t\t\t\t}\n \n-\t\t\t\t\t\tList<SingleEndFiles> singleEndFilesList = new ArrayList<>();\n \t\t\t\t\t\t// get the single end reads\n \t\t\t\t\t\tif (description.acceptsSingleSequenceFiles()) {\n \t\t\t\t\t\t\tCollection<SampleSequencingObjectJoin> singles = sequencingObjectService.getSequencesForSampleOfType(\n \t\t\t\t\t\t\t\t\tsample, SingleEndSequenceFile.class);\n \n-\t\t\t\t\t\t\tfor(SampleSequencingObjectJoin p : singles) {\n-\t\t\t\t\t\t\t\tSingleEndSequenceFile singleEndSequenceFile = (SingleEndSequenceFile) p.getObject();\n-\t\t\t\t\t\t\t\tString fileSize = iridaFileStorageUtility.getFileSize(singleEndSequenceFile.getSequenceFile().getFile());\n-\t\t\t\t\t\t\t\tsingleEndFilesList.add(new SingleEndFiles(singleEndSequenceFile, fileSize));\n-\t\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\t\tfiles.put(\"single_end\", singleEndFilesList);\n+\t\t\t\t\t\t\tfiles.put(\"single_end\", singles.stream()\n+\t\t\t\t\t\t\t\t\t.map(SampleSequencingObjectJoin::getObject)\n+\t\t\t\t\t\t\t\t\t.collect(Collectors.toList()));\n \t\t\t\t\t\t}\n \n \t\t\t\t\t\tsampleMap.put(\"files\", files);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY4NjI3OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449686279", "bodyText": "Yeah.  Seeing the file creation with 2 steps here just feels like we're begging to miss calling this method.", "author": "tom114", "createdAt": "2020-07-03T19:15:32Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/web/controller/api/samples/RESTSampleSequenceFilesController.java", "diffHunk": "@@ -529,6 +532,8 @@ public ModelMap addNewFast5FileToSample(@PathVariable Long sampleId, @RequestPar\n \t\t\tsf.setFile(target);\n \n \t\t\tFast5Object fast5Object = new Fast5Object(sf);\n+\t\t\tfast5Object.setType(iridaFileStorageUtility.isGzipped(sf.getFile()));", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "165d0c43e10722b416655fbe62e2155040f811fb", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/web/controller/api/samples/RESTSampleSequenceFilesController.java b/src/main/java/ca/corefacility/bioinformatics/irida/web/controller/api/samples/RESTSampleSequenceFilesController.java\nindex fdc62d3daf..58436524d3 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/web/controller/api/samples/RESTSampleSequenceFilesController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/web/controller/api/samples/RESTSampleSequenceFilesController.java\n\n@@ -532,7 +532,6 @@ public class RESTSampleSequenceFilesController {\n \t\t\tsf.setFile(target);\n \n \t\t\tFast5Object fast5Object = new Fast5Object(sf);\n-\t\t\tfast5Object.setType(iridaFileStorageUtility.isGzipped(sf.getFile()));\n \n \t\t\tif (sequencingRun != null) {\n \t\t\t\tif (sequencingRun.getUploadStatus() != SequencingRunUploadStatus.UPLOADING) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NDE3OA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r449694178", "bodyText": "These DTO classes are a pain, but I guess no way around them if we need to group some of this stuff together.", "author": "tom114", "createdAt": "2020-07-03T20:03:23Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/dto/SingleEndFiles.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.samples.dto;\n+\n+import ca.corefacility.bioinformatics.irida.model.sequenceFile.SingleEndSequenceFile;\n+\n+/**\n+ * Used as a response for encapsulating a single end file and its size\n+ */\n+\n+\n+public class SingleEndFiles {", "originalCommit": "ab225e6d847c88ed6b2ecadc1c167d5e6d634b36", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0ee4c8b2ec5bf5570d5b24bf5bb06de7e4a8fb9f", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/dto/SingleEndFiles.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/dto/SingleEndFiles.java\ndeleted file mode 100644\nindex a637ba3446..0000000000\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/dto/SingleEndFiles.java\n+++ /dev/null\n\n@@ -1,34 +0,0 @@\n-package ca.corefacility.bioinformatics.irida.ria.web.samples.dto;\n-\n-import ca.corefacility.bioinformatics.irida.model.sequenceFile.SingleEndSequenceFile;\n-\n-/**\n- * Used as a response for encapsulating a single end file and its size\n- */\n-\n-\n-public class SingleEndFiles {\n-\tprivate SingleEndSequenceFile singleEndSequenceFile;\n-\tprivate String fileSize;\n-\n-\tpublic SingleEndFiles(SingleEndSequenceFile singleEndSequenceFile, String fileSize) {\n-\t\tthis.singleEndSequenceFile = singleEndSequenceFile;\n-\t\tthis.fileSize = fileSize;\n-\t}\n-\n-\tpublic SingleEndSequenceFile getSingleEndSequenceFile() {\n-\t\treturn singleEndSequenceFile;\n-\t}\n-\n-\tpublic void setSingleEndSequenceFile(SingleEndSequenceFile singleEndSequenceFile) {\n-\t\tthis.singleEndSequenceFile = singleEndSequenceFile;\n-\t}\n-\n-\tpublic String getFileSize() {\n-\t\treturn fileSize;\n-\t}\n-\n-\tpublic void setFileSize(String fileSize) {\n-\t\tthis.fileSize = fileSize;\n-\t}\n-}\n"}}, {"oid": "165d0c43e10722b416655fbe62e2155040f811fb", "url": "https://github.com/phac-nml/irida/commit/165d0c43e10722b416655fbe62e2155040f811fb", "message": "Moved getFileSize, isGzipped, and getFileInputStream into a static class IridaFiles. Updated tests and templates", "committedDate": "2020-07-08T20:51:49Z", "type": "commit"}, {"oid": "ccfd5fbcd23cce7a9f7a2abf0c5429b0da2e6b9d", "url": "https://github.com/phac-nml/irida/commit/ccfd5fbcd23cce7a9f7a2abf0c5429b0da2e6b9d", "message": "Added jsonignore annotation so that the methods would not be serialized by jackson", "committedDate": "2020-07-09T18:20:19Z", "type": "commit"}, {"oid": "69343634fe14ff86c31763c0dca8cd1bf3083350", "url": "https://github.com/phac-nml/irida/commit/69343634fe14ff86c31763c0dca8cd1bf3083350", "message": "Removed iridaFileStorageUtility from SequencingObjectConcatenator and added appendFile and getFileExtension to IridaFiles static class. Updated tests", "committedDate": "2020-07-09T19:25:45Z", "type": "commit"}, {"oid": "8bac91e773dae1a253a0b3570628d4933b8133a4", "url": "https://github.com/phac-nml/irida/commit/8bac91e773dae1a253a0b3570628d4933b8133a4", "message": "Added missing @throws and removed unused import", "committedDate": "2020-07-09T19:51:57Z", "type": "commit"}, {"oid": "0ee4c8b2ec5bf5570d5b24bf5bb06de7e4a8fb9f", "url": "https://github.com/phac-nml/irida/commit/0ee4c8b2ec5bf5570d5b24bf5bb06de7e4a8fb9f", "message": "Removed dtos no longer required. Updated exception handling so only the concatenator classes throw a ConcatenateException", "committedDate": "2020-07-09T21:26:42Z", "type": "commit"}, {"oid": "1675e3a782e0f16ec957be2e7132f345dcc47039", "url": "https://github.com/phac-nml/irida/commit/1675e3a782e0f16ec957be2e7132f345dcc47039", "message": "Removed unused imports", "committedDate": "2020-07-09T21:43:23Z", "type": "commit"}, {"oid": "97e0014e1c5aa5584ad4b4f07bf67f3d54fbaf70", "url": "https://github.com/phac-nml/irida/commit/97e0014e1c5aa5584ad4b4f07bf67f3d54fbaf70", "message": "Removed staticcontextinitalizer and instead set the IridaFiles iridaFileStorageUtility when creating the bean. Removed appendFile from IridaFiles as its an actual file operation and instead the iridaFileStorageUtility append file method is called. Updated tests", "committedDate": "2020-07-10T17:01:50Z", "type": "commit"}, {"oid": "1eab223352b5b57285bcc7f724b38b24d4e6e897", "url": "https://github.com/phac-nml/irida/commit/1eab223352b5b57285bcc7f724b38b24d4e6e897", "message": "Updated to set iridafilestorageutility before each test", "committedDate": "2020-07-10T17:33:17Z", "type": "commit"}, {"oid": "987e491117e9ca0bced011205e6e3d7e201914a3", "url": "https://github.com/phac-nml/irida/commit/987e491117e9ca0bced011205e6e3d7e201914a3", "message": "Added comment to iridaFileStorageUtility bean config", "committedDate": "2020-07-10T22:00:10Z", "type": "commit"}, {"oid": "f4b1781018da1b9485e0508473d21bb2a463cb11", "url": "https://github.com/phac-nml/irida/commit/f4b1781018da1b9485e0508473d21bb2a463cb11", "message": "Merge pull request #5 from deepsidhu85/object_store/_static-irida-files-class\n\nObject store/ static irida files class", "committedDate": "2020-07-15T14:27:15Z", "type": "commit"}, {"oid": "e6a499c11a312a0ac26121da0c6f916113c1099d", "url": "https://github.com/phac-nml/irida/commit/e6a499c11a312a0ac26121da0c6f916113c1099d", "message": "Merge branch 'object-store' into object_store/_base", "committedDate": "2020-07-15T15:43:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NjMzMQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455886331", "bodyText": "This line isn't used.", "author": "tom114", "createdAt": "2020-07-16T15:45:15Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java", "diffHunk": "@@ -189,6 +189,7 @@ private void createSequenceFileInSample(MultipartFile file, Sample sample) throw\n \t */\n \tprivate void createFast5FileInSample(MultipartFile file, Sample sample) throws IOException {\n \t\tSequenceFile sequenceFile = createSequenceFile(file);\n+\t\tFast5Object fast5Object = new Fast5Object(sequenceFile);", "originalCommit": "e6a499c11a312a0ac26121da0c6f916113c1099d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk2MjQxMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455962413", "bodyText": "Removed in 56ac519", "author": "deepsidhu85", "createdAt": "2020-07-16T17:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NjMzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "56ac519f9ce8049dfaf894978357291373d24e8a", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\nindex 79ae167df1..05dafa7f8a 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesAjaxController.java\n\n@@ -189,7 +189,6 @@ public class SamplesAjaxController {\n \t */\n \tprivate void createFast5FileInSample(MultipartFile file, Sample sample) throws IOException {\n \t\tSequenceFile sequenceFile = createSequenceFile(file);\n-\t\tFast5Object fast5Object = new Fast5Object(sequenceFile);\n \t\tsequencingObjectService.createSequencingObjectInSample(new Fast5Object(sequenceFile), sample);\n \t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NzI2OQ==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455887269", "bodyText": "This is just swallowing the exception, should it give the concatenation error and redirect like the catch below?", "author": "tom114", "createdAt": "2020-07-16T15:46:36Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesController.java", "diffHunk": "@@ -581,7 +581,10 @@ public String concatenateSequenceFiles(@PathVariable Long sampleId, @RequestPara\n \t\ttry {\n \t\t\tsequencingObjectService.concatenateSequences(Lists.newArrayList(readMultiple), filename, sample,\n \t\t\t\t\tremoveOriginals);\n-\t\t} catch (ConcatenateException ex) {\n+\t\t} catch (IOException e) {\n+\t\t\tlogger.error(\"Error reading files: \", e);", "originalCommit": "e6a499c11a312a0ac26121da0c6f916113c1099d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk2MjczMA==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455962730", "bodyText": "Removed the IOException catch block in 56ac519 as it is never thrown.", "author": "deepsidhu85", "createdAt": "2020-07-16T17:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4NzI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "56ac519f9ce8049dfaf894978357291373d24e8a", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesController.java b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesController.java\nindex 778fa534ea..ca423798a2 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesController.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/ria/web/samples/SamplesController.java\n\n@@ -581,10 +581,7 @@ public class SamplesController extends BaseController {\n \t\ttry {\n \t\t\tsequencingObjectService.concatenateSequences(Lists.newArrayList(readMultiple), filename, sample,\n \t\t\t\t\tremoveOriginals);\n-\t\t} catch (IOException e) {\n-\t\t\tlogger.error(\"Error reading files: \", e);\n-\t\t}\n-\t\tcatch (ConcatenateException ex) {\n+\t\t} catch (ConcatenateException ex) {\n \t\t\tlogger.error(\"Error concatenating files: \", ex);\n \t\t\t\n \t\t\tmodel.addAttribute(\"concatenateError\", true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4Nzg1Mg==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455887852", "bodyText": "This doesn't actually throw IOException anymore.", "author": "tom114", "createdAt": "2020-07-16T15:47:26Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/SequencingObjectService.java", "diffHunk": "@@ -140,7 +141,8 @@\n \t *                        the sample\n \t * @return the new {@link SampleSequencingObjectJoin}\n \t * @throws ConcatenateException if there was an error concatenating the sequences\n+\t * @throws IOException if there was an error reading the sequences to concatenate\n \t */\n \tpublic SampleSequencingObjectJoin concatenateSequences(List<SequencingObject> toJoin, String filename,\n-\t\t\tSample targetSample, boolean removeOriginals) throws ConcatenateException;\n+\t\t\tSample targetSample, boolean removeOriginals) throws ConcatenateException, IOException;", "originalCommit": "e6a499c11a312a0ac26121da0c6f916113c1099d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk2MjUwMw==", "url": "https://github.com/phac-nml/irida/pull/650#discussion_r455962503", "bodyText": "Removed in 56ac519", "author": "deepsidhu85", "createdAt": "2020-07-16T17:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4Nzg1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "56ac519f9ce8049dfaf894978357291373d24e8a", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/service/SequencingObjectService.java b/src/main/java/ca/corefacility/bioinformatics/irida/service/SequencingObjectService.java\nindex 7df8dc52d2..a458feda28 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/service/SequencingObjectService.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/service/SequencingObjectService.java\n\n@@ -144,5 +144,5 @@ public interface SequencingObjectService extends CRUDService<Long, SequencingObj\n \t * @throws IOException if there was an error reading the sequences to concatenate\n \t */\n \tpublic SampleSequencingObjectJoin concatenateSequences(List<SequencingObject> toJoin, String filename,\n-\t\t\tSample targetSample, boolean removeOriginals) throws ConcatenateException, IOException;\n+\t\t\tSample targetSample, boolean removeOriginals) throws ConcatenateException;\n }\n"}}, {"oid": "56ac519f9ce8049dfaf894978357291373d24e8a", "url": "https://github.com/phac-nml/irida/commit/56ac519f9ce8049dfaf894978357291373d24e8a", "message": "Removed unused line of code, removed IOException from method header, removed IOException never being thrown in a try/catch block", "committedDate": "2020-07-16T17:45:02Z", "type": "commit"}, {"oid": "820770ee39759cbc2fba404d83a4390f4bc88fbf", "url": "https://github.com/phac-nml/irida/commit/820770ee39759cbc2fba404d83a4390f4bc88fbf", "message": "Removed @throws from method comment", "committedDate": "2020-07-16T19:28:21Z", "type": "commit"}, {"oid": "9cc8b8dc15263663fda58e5feed9acf80cbc6029", "url": "https://github.com/phac-nml/irida/commit/9cc8b8dc15263663fda58e5feed9acf80cbc6029", "message": "Removed unused import", "committedDate": "2020-07-16T19:40:21Z", "type": "commit"}]}