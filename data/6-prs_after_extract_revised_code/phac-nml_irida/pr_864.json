{"pr_number": 864, "pr_title": "Add fast5 sync", "pr_createdAt": "2020-11-19T15:51:43Z", "pr_url": "https://github.com/phac-nml/irida/pull/864", "timeline": [{"oid": "f3532a237fc74b88e6bace6d8ad9f41ca2ca5da9", "url": "https://github.com/phac-nml/irida/commit/f3532a237fc74b88e6bace6d8ad9f41ca2ca5da9", "message": "Updated project synchronization to also sync fast5 data", "committedDate": "2020-11-16T21:40:27Z", "type": "commit"}, {"oid": "22b20d844d724c2b1388408bf0bd2024942404ef", "url": "https://github.com/phac-nml/irida/commit/22b20d844d724c2b1388408bf0bd2024942404ef", "message": "Merge branch 'development' into add-fast5-sync", "committedDate": "2020-11-19T15:46:32Z", "type": "commit"}, {"oid": "730286a0bf25c3687e3ea1545fbef60cea979659", "url": "https://github.com/phac-nml/irida/commit/730286a0bf25c3687e3ea1545fbef60cea979659", "message": "Updated fast5object to set sequencefile", "committedDate": "2020-11-20T05:07:04Z", "type": "commit"}, {"oid": "b2dcbeb2527ba6561de903ceff591c9de051a3e1", "url": "https://github.com/phac-nml/irida/commit/b2dcbeb2527ba6561de903ceff591c9de051a3e1", "message": "Updated CHANGELOG", "committedDate": "2020-11-20T05:08:45Z", "type": "commit"}, {"oid": "033ad3e6a4a4e6dc14e7ac44ab54ee8376630de1", "url": "https://github.com/phac-nml/irida/commit/033ad3e6a4a4e6dc14e7ac44ab54ee8376630de1", "message": "Updated test for syncing fast5 data to project", "committedDate": "2020-11-23T16:12:47Z", "type": "commit"}, {"oid": "e3cac4ca41221bd373a5dcbbc8a3603dc7420db9", "url": "https://github.com/phac-nml/irida/commit/e3cac4ca41221bd373a5dcbbc8a3603dc7420db9", "message": "Changed url for fast5object remotestatus", "committedDate": "2020-11-23T16:13:45Z", "type": "commit"}, {"oid": "c3e6ade8bf2eacf6d38b7a01c6ceffdcb9f7827c", "url": "https://github.com/phac-nml/irida/commit/c3e6ade8bf2eacf6d38b7a01c6ceffdcb9f7827c", "message": "Updated docs", "committedDate": "2020-11-23T16:18:47Z", "type": "commit"}, {"oid": "454abbdea5fcc4a42a048c5a4999dbdb08e0df49", "url": "https://github.com/phac-nml/irida/commit/454abbdea5fcc4a42a048c5a4999dbdb08e0df49", "message": "Merge branch 'development' into add-fast5-sync", "committedDate": "2020-11-23T16:32:44Z", "type": "commit"}, {"oid": "cc9696bb8d262371fcfbbf428efc6ac66971dd09", "url": "https://github.com/phac-nml/irida/commit/cc9696bb8d262371fcfbbf428efc6ac66971dd09", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-11-30T20:49:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcyNzM4Ng==", "url": "https://github.com/phac-nml/irida/pull/864#discussion_r533727386", "bodyText": "Note the try/catch around this block in the assemblies section below.  It should be added in case the host system doesn't support fast5 data.", "author": "tom114", "createdAt": "2020-12-01T21:18:11Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java", "diffHunk": "@@ -374,6 +377,24 @@ private void syncProject(Project project) {\n \t\t\t}\n \t\t}\n \n+\t\t//list the fast5 files from the remote api\n+\t\tList<Fast5Object> fast5FilesForSample = fast5ObjectRemoteService.getFast5FilesForSample(sample);", "originalCommit": "cc9696bb8d262371fcfbbf428efc6ac66971dd09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3NDEwOA==", "url": "https://github.com/phac-nml/irida/pull/864#discussion_r534274108", "bodyText": "Added in ccf8d68", "author": "deepsidhu85", "createdAt": "2020-12-02T15:49:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcyNzM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "ccf8d68de322f55c99d3283986c593dd49df391e", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java b/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\nindex 57325fb300..e9027fce7a 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\n\n@@ -378,12 +375,19 @@ public class ProjectSynchronizationService {\n \t\t}\n \n \t\t//list the fast5 files from the remote api\n-\t\tList<Fast5Object> fast5FilesForSample = fast5ObjectRemoteService.getFast5FilesForSample(sample);\n+\t\tList<Fast5Object> fast5FilesForSample;\n+\t\ttry {\n+\t\t\tfast5FilesForSample = fast5ObjectRemoteService.getFast5FilesForSample(sample);\n+\t\t} catch (LinkNotFoundException e) {\n+\t\t\tlogger.warn(\"The sample on the referenced IRIDA doesn't support assemblies: \" + sample.getSelfHref());\n+\t\t\tfast5FilesForSample = Lists.newArrayList();\n+\t\t}\n \n \t\t//for each fast5 file\n \t\tfor (Fast5Object fast5Object : fast5FilesForSample) {\n \t\t\t//check if we already have it\n-\t\t\tif (!objectsByUrl.contains(fast5Object.getRemoteStatus().getURL())) {\n+\t\t\tif (!objectsByUrl.contains(fast5Object.getRemoteStatus()\n+\t\t\t\t\t.getURL())) {\n \t\t\t\tfast5Object.setId(null);\n \t\t\t\t//if not, get it locally and save it\n \t\t\t\ttry {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcyOTA3Nw==", "url": "https://github.com/phac-nml/irida/pull/864#discussion_r533729077", "bodyText": "This whole section is exactly the same for single end and fast5 files, and nearly the same for pairs.  Want to encapsulate it into a private method that can be called here and in those other file types?", "author": "tom114", "createdAt": "2020-12-01T21:21:22Z", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java", "diffHunk": "@@ -465,6 +488,39 @@ public void syncSingleEndSequenceFile(SingleEndSequenceFile file, Sample sample)\n \t\t}\n \t}\n \n+\t/**\n+\t * Synchronize a given {@link Fast5Object} to the local\n+\t * installation\n+\t *\n+\t * @param fast5Object\n+\t *            the {@link Fast5Object} to sync\n+\t * @param sample\n+\t *            the {@link Sample} to add the file to\n+\t */\n+\tpublic void syncFast5File(Fast5Object fast5Object, Sample sample) {\n+\t\tRemoteStatus fileStatus = fast5Object.getRemoteStatus();\n+\t\tfileStatus.setSyncStatus(SyncStatus.UPDATING);\n+\t\ttry {\n+\t\t\tfast5Object = fast5ObjectRemoteService.mirrorSequencingObject(fast5Object);\n+\n+\t\t\tfast5Object.setProcessingState(SequencingObject.ProcessingState.UNPROCESSED);\n+\t\t\tfast5Object.setFileProcessor(null);\n+\n+\t\t\tfast5Object.getFile().setId(null);\n+\t\t\tfast5Object.getRemoteStatus().setSyncStatus(SyncStatus.SYNCHRONIZED);\n+\n+\t\t\tobjectService.createSequencingObjectInSample(fast5Object, sample);\n+\n+\t\t\tfileStatus.setSyncStatus(SyncStatus.SYNCHRONIZED);\n+\n+\t\t\tobjectService.updateRemoteStatus(fast5Object.getId(), fileStatus);", "originalCommit": "cc9696bb8d262371fcfbbf428efc6ac66971dd09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDI3NDM2NA==", "url": "https://github.com/phac-nml/irida/pull/864#discussion_r534274364", "bodyText": "Yup that was a good idea. Added in ccf8d68", "author": "deepsidhu85", "createdAt": "2020-12-02T15:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcyOTA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ccf8d68de322f55c99d3283986c593dd49df391e", "chunk": "diff --git a/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java b/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\nindex 57325fb300..e9027fce7a 100644\n--- a/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\n+++ b/src/main/java/ca/corefacility/bioinformatics/irida/service/remote/ProjectSynchronizationService.java\n\n@@ -469,18 +473,7 @@ public class ProjectSynchronizationService {\n \t\tfileStatus.setSyncStatus(SyncStatus.UPDATING);\n \t\ttry {\n \t\t\tfile = singleEndRemoteService.mirrorSequencingObject(file);\n-\n-\t\t\tfile.setProcessingState(SequencingObject.ProcessingState.UNPROCESSED);\n-\t\t\tfile.setFileProcessor(null);\n-\n-\t\t\tfile.getSequenceFile().setId(null);\n-\t\t\tfile.getSequenceFile().getRemoteStatus().setSyncStatus(SyncStatus.SYNCHRONIZED);\n-\n-\t\t\tobjectService.createSequencingObjectInSample(file, sample);\n-\n-\t\t\tfileStatus.setSyncStatus(SyncStatus.SYNCHRONIZED);\n-\n-\t\t\tobjectService.updateRemoteStatus(file.getId(), fileStatus);\n+\t\t\tsyncSequencingObject(file, sample);\n \t\t} catch (Exception e) {\n \t\t\tlogger.error(\"Error transferring file: \" + file.getRemoteStatus().getURL(), e);\n \t\t\tthrow new ProjectSynchronizationException(\"Could not synchronize file \" + file.getRemoteStatus().getURL(),\n"}}, {"oid": "ccf8d68de322f55c99d3283986c593dd49df391e", "url": "https://github.com/phac-nml/irida/commit/ccf8d68de322f55c99d3283986c593dd49df391e", "message": "Added try/catch when attempting to get fast5 file data from remote installation. Updated docs. Added a private method to to sync the sequencing object to a local installation which is used by sequencefilepair, singleendsequencfile, and fast5object", "committedDate": "2020-12-02T15:48:54Z", "type": "commit"}, {"oid": "955479ae87aa5da6fa4764b3c016b5a764305959", "url": "https://github.com/phac-nml/irida/commit/955479ae87aa5da6fa4764b3c016b5a764305959", "message": "Updated user docs. Updated sequencefilepair, singleendsequencefiles, and fast5object to pass the remote status to the syncSequencingObject as we already retrieved it.", "committedDate": "2020-12-02T16:34:48Z", "type": "commit"}, {"oid": "f1d02ccb5025a86602212c8b2d784e05d39482f5", "url": "https://github.com/phac-nml/irida/commit/f1d02ccb5025a86602212c8b2d784e05d39482f5", "message": "Merged dev and fixed merge conflicts", "committedDate": "2020-12-02T17:08:24Z", "type": "commit"}, {"oid": "bfb636885a7b2cb68594ba2b685924359891c5de", "url": "https://github.com/phac-nml/irida/commit/bfb636885a7b2cb68594ba2b685924359891c5de", "message": "Merge branch 'development' into add-fast5-sync", "committedDate": "2020-12-02T19:09:12Z", "type": "commit"}, {"oid": "6497259f108893d0f5a31be63670b4fe8ec1c503", "url": "https://github.com/phac-nml/irida/commit/6497259f108893d0f5a31be63670b4fe8ec1c503", "message": "Updated logging statement", "committedDate": "2020-12-02T19:40:34Z", "type": "commit"}]}