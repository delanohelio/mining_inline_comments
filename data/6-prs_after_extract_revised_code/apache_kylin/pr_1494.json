{"pr_number": 1494, "pr_title": "KYLIN-4833 create hfile on hadoop hdfs and distcp to hbase hdfs", "pr_createdAt": "2020-12-02T06:04:13Z", "pr_url": "https://github.com/apache/kylin/pull/1494", "timeline": [{"oid": "bf233c4be4135621107799ee8902dc6787cea043", "url": "https://github.com/apache/kylin/commit/bf233c4be4135621107799ee8902dc6787cea043", "message": "create hfile on hadoop hdfs and distcp to hbase hdfs", "committedDate": "2020-11-27T10:18:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjE5OQ==", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532199", "bodyText": "remove commented code if not needed , will help in code readability going forward.", "author": "nyshthefantastic", "createdAt": "2020-12-24T13:34:58Z", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "diffHunk": "@@ -72,6 +80,26 @@ public HadoopShellExecutable createCreateHTableStep(String jobId, CuboidModeEnum\n         return createHtableStep;\n     }\n \n+    public AbstractExecutable createDistcpHFileStep(String jobId){\n+        String inputPath = getRealizationRootPath(jobId) + \"/hfile\";\n+        MapReduceExecutable createHFilesStep = new MapReduceExecutable();\n+        createHFilesStep.setName(ExecutableConstants.STEP_NAME_HFILE_DISTCP);\n+        StringBuilder cmd = new StringBuilder();\n+\n+        appendMapReduceParameters(cmd);\n+        appendExecCmdParameters(cmd, BatchConstants.ARG_CUBE_NAME, seg.getRealization().getName());\n+//        appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000_hfile\");", "originalCommit": "bf233c4be4135621107799ee8902dc6787cea043", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjQ0MQ==", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532441", "bodyText": "good to use final if variable is not mutated : final Path parentPath", "author": "nyshthefantastic", "createdAt": "2020-12-24T13:36:04Z", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HDFSPathGarbageCollectionStep.java", "diffHunk": "@@ -91,7 +91,8 @@ private void dropHdfsPathOnCluster(List<String> oldHdfsPaths, FileSystem fileSys\n                 }\n                 // If hbase was deployed on another cluster, the job dir is empty and should be dropped,\n                 // because of rowkey_stats and hfile dirs are both dropped.\n-                if (fileSystem.listStatus(oldPath.getParent()).length == 0) {\n+                Path parentPath = oldPath.getParent();", "originalCommit": "bf233c4be4135621107799ee8902dc6787cea043", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjc3MA==", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532770", "bodyText": "good to change to final", "author": "nyshthefantastic", "createdAt": "2020-12-24T13:37:24Z", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HFileDistcpJob.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *     http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+\r\n+package org.apache.kylin.storage.hbase.steps;\r\n+\r\n+import com.google.common.collect.Lists;\r\n+import org.apache.commons.cli.Options;\r\n+import org.apache.hadoop.conf.Configuration;\r\n+import org.apache.hadoop.fs.FileSystem;\r\n+import org.apache.hadoop.fs.Path;\r\n+import org.apache.hadoop.mapred.JobContext;\r\n+import org.apache.hadoop.tools.DistCp;\r\n+import org.apache.hadoop.tools.DistCpOptions;\r\n+import org.apache.hadoop.util.ToolRunner;\r\n+import org.apache.kylin.common.KylinConfig;\r\n+import org.apache.kylin.common.util.HadoopUtil;\r\n+import org.apache.kylin.cube.CubeInstance;\r\n+import org.apache.kylin.cube.CubeManager;\r\n+import org.apache.kylin.engine.mr.common.AbstractHadoopJob;\r\n+import org.apache.kylin.engine.mr.common.BatchConstants;\r\n+import org.apache.kylin.storage.hbase.HBaseConnection;\r\n+import org.slf4j.Logger;\r\n+import org.slf4j.LoggerFactory;\r\n+\r\n+import java.util.List;\r\n+\r\n+/**\r\n+ * @author fengpod\r\n+ */\r\n+public class HFileDistcpJob extends AbstractHadoopJob {\r\n+\r\n+    protected static final Logger logger = LoggerFactory.getLogger(HFileDistcpJob.class);\r\n+\r\n+    public int run(String[] args) throws Exception {\r\n+        Options options = new Options();\r\n+\r\n+        try {\r\n+            options.addOption(OPTION_CUBE_NAME);\r\n+            options.addOption(OPTION_JOB_NAME);\r\n+            options.addOption(OPTION_INPUT_PATH);\r\n+            options.addOption(OPTION_OUTPUT_PATH);\r\n+            options.addOption(OPTION_HTABLE_NAME);\r\n+            parseOptions(options, args);\r\n+\r\n+            // use current hbase configuration\r\n+            Configuration configuration = new Configuration();\r\n+            HBaseConnection.addHBaseClusterNNHAConfiguration(configuration);\r\n+\r\n+            Path input = new Path(getOptionValue(OPTION_INPUT_PATH));\r", "originalCommit": "bf233c4be4135621107799ee8902dc6787cea043", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTM1MQ==", "url": "https://github.com/apache/kylin/pull/1494#discussion_r549549351", "bodyText": "Append paramters twice for BatchConstants.ARG_PARTITION .", "author": "hit-lacus", "createdAt": "2020-12-29T02:52:32Z", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "diffHunk": "@@ -63,6 +64,13 @@ public HadoopShellExecutable createCreateHTableStep(String jobId, CuboidModeEnum\n         appendExecCmdParameters(cmd, BatchConstants.ARG_SEGMENT_ID, seg.getUuid());\n         appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,\n                 getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\");\n+        if(this.seg.getConfig().isHFileDistCP()){\n+            String partitionOutputPath = getRealizationRootPath(jobId) + \"/rowkey_stats/part-r-00000_hfile\";\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, partitionOutputPath);\n+        }else {\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,", "originalCommit": "bf233c4be4135621107799ee8902dc6787cea043", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyMjM2OQ==", "url": "https://github.com/apache/kylin/pull/1494#discussion_r549922369", "bodyText": "new commit fixed this", "author": "fengpod", "createdAt": "2020-12-30T03:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTM1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d37b1e7b402cc6fe3412f29c3e9681760bc93686", "chunk": "diff --git a/storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java b/storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java\nindex 3f39e8001..d2e3ba3f3 100644\n--- a/storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java\n+++ b/storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java\n\n@@ -64,13 +64,13 @@ public abstract class HBaseJobSteps extends JobBuilderSupport {\n         appendExecCmdParameters(cmd, BatchConstants.ARG_SEGMENT_ID, seg.getUuid());\n         appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,\n                 getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\");\n+        String partitionOutputPath = null;\n         if(this.seg.getConfig().isHFileDistCP()){\n-            String partitionOutputPath = getRealizationRootPath(jobId) + \"/rowkey_stats/part-r-00000_hfile\";\n-            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, partitionOutputPath);\n+            partitionOutputPath = getRealizationRootPath(jobId) + \"/rowkey_stats/part-r-00000_hfile\";\n         }else {\n-            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,\n-                getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\");\n+            partitionOutputPath = getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\";\n         }\n+        appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, partitionOutputPath);\n         appendExecCmdParameters(cmd, BatchConstants.ARG_CUBOID_MODE, cuboidMode.toString());\n         appendExecCmdParameters(cmd, BatchConstants.ARG_HBASE_CONF_PATH, getHBaseConfFilePath(jobId));\n \n"}}, {"oid": "d37b1e7b402cc6fe3412f29c3e9681760bc93686", "url": "https://github.com/apache/kylin/commit/d37b1e7b402cc6fe3412f29c3e9681760bc93686", "message": "code style", "committedDate": "2020-12-30T03:21:12Z", "type": "commit"}]}