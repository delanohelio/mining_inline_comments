{"pr_number": 1710, "pr_title": "[JBTM-3379] make participant timeout configurable", "pr_createdAt": "2020-10-29T19:34:02Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1710", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515036560", "bodyText": "This method was added in a later revision of the JAX-RS spec (and was the reason I chose async). Will you research whether or not we need to support any of the earlier versions?", "author": "mmusgrov", "createdAt": "2020-10-30T11:37:46Z", "path": "rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -424,7 +424,9 @@ private boolean afterLRARequest(URI target, String payload) {\n         Client client = null;\n \n         try {\n-            client = ClientBuilder.newClient();\n+            client = ClientBuilder.newBuilder()\n+                    .readTimeout(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS)", "originalCommit": "3d06a0cd9e6652c536bdb56cfb24d7d5c96584b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE3Mzk2OQ==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515173969", "bodyText": "Hm... I thought that we are fine to use the JAX-RS 2.1 when we defined it in dependencies.\nRegarding the need of  support of the earlier versions. I can't see any need for the support or earlier versions. The Quarkus uses the 2.1 from start, for WildFly there will be for sure no support with older versions (at least for the reason that for integration there will be created an extension and WildFly supports extensions only in new versions).", "author": "ochaloup", "createdAt": "2020-10-30T15:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM0OTc4MA==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r517349780", "bodyText": "Why would we want to restrict our user base without any significant discernible benefit?", "author": "mmusgrov", "createdAt": "2020-11-04T13:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MzU5NQ==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r517973595", "bodyText": "So if you can indicate why the benefit of making this change outweighs the drawback of restricting our user base then I'll mark it as approved.", "author": "mmusgrov", "createdAt": "2020-11-05T11:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAxNzU2Nw==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r518017567", "bodyText": "Also bear in mind that I want to move to a reactive solution in a later revision so your changes would ultimately be rolled back.", "author": "mmusgrov", "createdAt": "2020-11-05T12:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAzMTAwMg==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r518031002", "bodyText": "Also since the config property and the implementation technique of using async calls are independent of each I would recommend that you split up the issue to avoid one blocking the other.", "author": "mmusgrov", "createdAt": "2020-11-05T12:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzNjU2MA=="}], "type": "inlineReview", "revised_code": {"commit": "7beb5ea7bdac85a1301c94d5bb1b57d239d12b14", "chunk": "diff --git a/rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java b/rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java\nindex d13b489c3..83ae52560 100644\n--- a/rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java\n+++ b/rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java\n\n@@ -424,9 +424,7 @@ public class LRARecord extends AbstractRecord implements Comparable<AbstractReco\n         Client client = null;\n \n         try {\n-            client = ClientBuilder.newBuilder()\n-                    .readTimeout(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS)\n-                    .newClient();\n+            client = ClientBuilder.newClient();\n             Invocation.Builder builder = client.target(target)\n                 .request()\n                 .header(LRA_HTTP_RECOVERY_HEADER, recoveryURI.toASCIIString());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzODkzNQ==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515038935", "bodyText": "Should we prefix these properties with narayana to avoid any potential conflicts with future LRA spec versions.\nAlso participants/compensators are referred to as participants or compensators so it would be more consistent to call this property lra.participant.timeout (also participant is a well understood noun in the IT community whereas participation may not be for non English speakers).", "author": "mmusgrov", "createdAt": "2020-10-30T11:42:07Z", "path": "rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java", "diffHunk": "@@ -42,7 +42,14 @@\n     public static final String RECOVERY_PARAM = \"recoveryCount\";\n     public static final String HTTP_METHOD_NAME = \"method\"; // the name of the HTTP method used to invoke participants\n \n-    public static final long PARTICIPANT_TIMEOUT = 2; // number of seconds to wait for requests\n+    /**\n+     * System property name which defines the connection read timeout which is used\n+     * by LRA Coordinator and its friends when connecting remote participants and other coordinators.\n+     * The value is in seconds. The default value is {@value LRAConstants#PARTICIPANT_DEFAULT_TIMEOUT_S}.\n+     */\n+    public static final String PARTICIPANT_TIMEOUT_PARAM = \"lra.participation.timeout\";", "originalCommit": "3d06a0cd9e6652c536bdb56cfb24d7d5c96584b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0ODkyMg==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515148922", "bodyText": "Yes, agree, really good points. Thank you.", "author": "ochaloup", "createdAt": "2020-10-30T14:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAzODkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec93ec4b3f0775feb3b31b68aed0a0701762e745", "chunk": "diff --git a/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java b/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\nindex f12cdea13..a43e6529f 100644\n--- a/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\n+++ b/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\n\n@@ -45,11 +45,10 @@ public final class LRAConstants {\n     /**\n      * System property name which defines the connection read timeout which is used\n      * by LRA Coordinator and its friends when connecting remote participants and other coordinators.\n-     * The value is in seconds. The default value is {@value LRAConstants#PARTICIPANT_DEFAULT_TIMEOUT_S}.\n+     * The value is in seconds. The default value is {@code 2}.\n      */\n-    public static final String PARTICIPANT_TIMEOUT_PARAM = \"lra.participation.timeout\";\n-    private static final long PARTICIPANT_DEFAULT_TIMEOUT_S = 2; // number of seconds to wait for requests\n-    public static final long PARTICIPANT_TIMEOUT = Long.getLong(PARTICIPANT_TIMEOUT_PARAM, PARTICIPANT_DEFAULT_TIMEOUT_S);\n+    public static final String PARTICIPANT_TIMEOUT_PARAM = \"narayana.lra.participant.timeout\";\n+    public static final long PARTICIPANT_TIMEOUT = Long.getLong(PARTICIPANT_TIMEOUT_PARAM, 2);\n \n     private LRAConstants() {\n         // utility class\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA0MjExMg==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515042112", "bodyText": "It seems odd to declare a private constant that is only used once and then only on the next line. The less code in an application the easier it is to understand and maintain.", "author": "mmusgrov", "createdAt": "2020-10-30T11:48:20Z", "path": "rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java", "diffHunk": "@@ -42,7 +42,14 @@\n     public static final String RECOVERY_PARAM = \"recoveryCount\";\n     public static final String HTTP_METHOD_NAME = \"method\"; // the name of the HTTP method used to invoke participants\n \n-    public static final long PARTICIPANT_TIMEOUT = 2; // number of seconds to wait for requests\n+    /**\n+     * System property name which defines the connection read timeout which is used\n+     * by LRA Coordinator and its friends when connecting remote participants and other coordinators.\n+     * The value is in seconds. The default value is {@value LRAConstants#PARTICIPANT_DEFAULT_TIMEOUT_S}.\n+     */\n+    public static final String PARTICIPANT_TIMEOUT_PARAM = \"lra.participation.timeout\";\n+    private static final long PARTICIPANT_DEFAULT_TIMEOUT_S = 2; // number of seconds to wait for requests", "originalCommit": "3d06a0cd9e6652c536bdb56cfb24d7d5c96584b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE0ODcyMA==", "url": "https://github.com/jbosstm/narayana/pull/1710#discussion_r515148720", "bodyText": "I don't agree with this statement but I don't want to dispute about it.\nFixed.", "author": "ochaloup", "createdAt": "2020-10-30T14:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA0MjExMg=="}], "type": "inlineReview", "revised_code": {"commit": "ec93ec4b3f0775feb3b31b68aed0a0701762e745", "chunk": "diff --git a/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java b/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\nindex f12cdea13..a43e6529f 100644\n--- a/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\n+++ b/rts/lra/service-base/src/main/java/io/narayana/lra/LRAConstants.java\n\n@@ -45,11 +45,10 @@ public final class LRAConstants {\n     /**\n      * System property name which defines the connection read timeout which is used\n      * by LRA Coordinator and its friends when connecting remote participants and other coordinators.\n-     * The value is in seconds. The default value is {@value LRAConstants#PARTICIPANT_DEFAULT_TIMEOUT_S}.\n+     * The value is in seconds. The default value is {@code 2}.\n      */\n-    public static final String PARTICIPANT_TIMEOUT_PARAM = \"lra.participation.timeout\";\n-    private static final long PARTICIPANT_DEFAULT_TIMEOUT_S = 2; // number of seconds to wait for requests\n-    public static final long PARTICIPANT_TIMEOUT = Long.getLong(PARTICIPANT_TIMEOUT_PARAM, PARTICIPANT_DEFAULT_TIMEOUT_S);\n+    public static final String PARTICIPANT_TIMEOUT_PARAM = \"narayana.lra.participant.timeout\";\n+    public static final long PARTICIPANT_TIMEOUT = Long.getLong(PARTICIPANT_TIMEOUT_PARAM, 2);\n \n     private LRAConstants() {\n         // utility class\n"}}, {"oid": "ec93ec4b3f0775feb3b31b68aed0a0701762e745", "url": "https://github.com/jbosstm/narayana/commit/ec93ec4b3f0775feb3b31b68aed0a0701762e745", "message": "[JBTM-3379] make participant timouet configurable and without async calls", "committedDate": "2020-10-30T15:12:16Z", "type": "forcePushed"}, {"oid": "7beb5ea7bdac85a1301c94d5bb1b57d239d12b14", "url": "https://github.com/jbosstm/narayana/commit/7beb5ea7bdac85a1301c94d5bb1b57d239d12b14", "message": "[JBTM-3379] make participant timeout configurable", "committedDate": "2020-11-09T08:43:27Z", "type": "commit"}, {"oid": "7beb5ea7bdac85a1301c94d5bb1b57d239d12b14", "url": "https://github.com/jbosstm/narayana/commit/7beb5ea7bdac85a1301c94d5bb1b57d239d12b14", "message": "[JBTM-3379] make participant timeout configurable", "committedDate": "2020-11-09T08:43:27Z", "type": "forcePushed"}]}