{"pr_number": 1738, "pr_title": "JBTM-3245 report request and response filter processing failures back\u2026", "pr_createdAt": "2020-12-04T19:27:15Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1738", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537452148", "bodyText": "I wonder what is the benefit for having this verbose flag here. My opinion is that when the LRA is not created it's generally usable to understand the reason. The throwGenericLRAException was changed to contain this information in case of error. Then the verbose flag won't provide more information, will it?", "author": "ochaloup", "createdAt": "2020-12-07T12:00:49Z", "path": "rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -265,13 +287,17 @@ public URI startLRA(URI parentLRA, String clientID, Long timeout, ChronoUnit uni\n                 .queryParam(TIMELIMIT_PARAM_NAME, Duration.of(timeout, unit).toMillis())\n                 .queryParam(PARENT_LRA_PARAM_NAME, encodedParentLRA)\n                 .request()\n-                .post(null);\n+                .async()\n+                .post(null)\n+                .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n \n             // validate the HTTP status code says an LRA resource was created\n             if (isUnexpectedResponseStatus(response, Response.Status.CREATED)) {\n                 String responseEntity = response.hasEntity() ? response.readEntity(String.class) : \"\";\n-                LRALogger.i18NLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n-                throwGenericLRAException(null, INTERNAL_SERVER_ERROR.getStatusCode(),\n+                if (verbose) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjIyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606225", "bodyText": "The code is generating a stacktrace and that is not useful. The user wants a new LRA but the system responsible for fulfilling that request is not available. I don't think that is a good reason to start generating stack traces in the logs (this is a distributed system and Availability cannot be guaranteed - ie it is an expected condition).\nLRA operates in an environment where failure/unavailability conditions are the norm and dumping stacktraces is not the way to go, it gives the sense that the s/w is buggy. We only need to generate a decent response back to the client and a warning in the logs for further analysis and correlation. And this is what this PR is trying to achieve.", "author": "mmusgrov", "createdAt": "2020-12-07T15:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE2NjY5Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538166696", "bodyText": "Ok, I see, thanks. Then I assume this could be done in more Java way. We have exception handling and logging setup.\nWhen there is generated an Exception by throwGenericLRAException then we don't need a special logging when the exception has set the cause exception. Client may catch the exception and ignore it. There could be no logging at all.\nIf we think this is not exceptional occasion then the exception should not be thrown at all. The verbosity of the logging should be set by definition of the log level. This could be info and the stacktrace can be printed only for debug (ie. we don't need to add a special API for verbosity when Java manages this managed by logging levels).", "author": "ochaloup", "createdAt": "2020-12-08T09:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0MzAxNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539343016", "bodyText": "Exactly right, we should not be throwing exceptions and my code changes log the warning but avoid the exception.\nThe verbosity flag was added because I don't want the server side filters throwing exceptions. Existing code using this client API is unaffected (I still think it's wrong even for them but it isn't the subject of my PR).", "author": "mmusgrov", "createdAt": "2020-12-09T14:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwMzkyNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539403924", "bodyText": "Ok, I would design the API differently.", "author": "ochaloup", "createdAt": "2020-12-09T15:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537453926", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .async()\n          \n          \n            \n                            .async()", "author": "ochaloup", "createdAt": "2020-12-07T12:03:43Z", "path": "rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -370,14 +387,19 @@ public void leaveLRA(URI lraId, String body) throws WebApplicationException {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n-                .put(Entity.text(body));\n+                    .async()", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NTE3OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537455179", "bodyText": "For me there is a strange formatting for these async calls and get calls. This formatting is used overall of the whole class. Is it intentional?", "author": "ochaloup", "createdAt": "2020-12-07T12:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjUwNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606506", "bodyText": "Yes the whole file probably needs reformatting. I am not doing that in the PR so it can be the subject of another issue.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE2MDc5Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538160796", "bodyText": "I'm not talking about the whole file. I refer to the .async or .put calls which are called at the client. There are some later in the PR and I think it would be nice to adjust them all to be in the same style - with the same indentation.", "author": "ochaloup", "createdAt": "2020-12-08T09:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0MzQzNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539343436", "bodyText": "Perhaps, but the formatting in this file has already diverged.", "author": "mmusgrov", "createdAt": "2020-12-09T14:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNDcyOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539404729", "bodyText": "I can't find any place where the formatting diverges now but if it's so, still the PR should not be adding more divergence.", "author": "ochaloup", "createdAt": "2020-12-09T15:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 6751ae8f5..7a2b6e6ed 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n\n@@ -387,7 +387,7 @@ public class NarayanaLRAClient implements Closeable {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n-                    .async()\n+                .async()\n                 .put(Entity.text(body))\n             .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537458476", "bodyText": "What is the reason to explicitly provide the message code when it's printed by logger when logged?", "author": "ochaloup", "createdAt": "2020-12-07T12:11:24Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -78,10 +83,13 @@\n     private static final String TERMINAL_LRA_PROP = \"terminateLRA\";\n     private static final String SUSPENDED_LRA_PROP = \"suspendLRA\";\n     private static final String NEW_LRA_PROP = \"newLRA\";\n+    private static final String ABORT_WITH_PROP = \"abortWith\";\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-\n+    private static final String JOIN = \"join\";\n+    // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n+    private static final int i18nMessageCode = 25145;", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjY3NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606675", "bodyText": "Take a look at where the constant gets used.\nIt provides a way for correlating the response with what's in the logs.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3NjYyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538176625", "bodyText": "Ok, the point is to correlate the response with what is in logs.\nI haven't seen this approach so far thus I wonder. I assume the same correlation can be done with time and the message content. If you consider a benefit in printing the global log identifier, ok.\nTwo questions\n\nShould not be the id linked with some constants on both places to be better coupled to each other?\nIf the point is correlation would not be better to correlate directly the particular response and the log message instance? Not having some general global log id that could be correlated with other means but having identifier of the message which will be \"unique\" overall?", "author": "ochaloup", "createdAt": "2020-12-08T09:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0NDc0Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539344743", "bodyText": "I am not following your logic, all I've done is to include the log message id in the response to the client. I am not advocating anything complex here, we just need a story to tell the user.", "author": "mmusgrov", "createdAt": "2020-12-09T14:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNzY1Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539407656", "bodyText": "I see I was interested what the correlation is expected to be used for.\nFrom that I'm not following what is the benefit of adding the log error code to client response. But if there is then ok.", "author": "ochaloup", "createdAt": "2020-12-09T15:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODgzOA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537458838", "bodyText": "Is this constant used somewhere?", "author": "ochaloup", "createdAt": "2020-12-07T12:11:56Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -78,10 +83,13 @@\n     private static final String TERMINAL_LRA_PROP = \"terminateLRA\";\n     private static final String SUSPENDED_LRA_PROP = \"suspendLRA\";\n     private static final String NEW_LRA_PROP = \"newLRA\";\n+    private static final String ABORT_WITH_PROP = \"abortWith\";\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-\n+    private static final String JOIN = \"join\";", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjkwOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606909", "bodyText": "No. I will remove it.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MDYwNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537460605", "bodyText": "Please, use  StringBuilder", "author": "ochaloup", "createdAt": "2020-12-07T12:15:14Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzA2MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607061", "bodyText": "okay", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MDYwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTE4OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537461188", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n          \n          \n            \n                     * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed", "author": "ochaloup", "createdAt": "2020-12-07T12:16:20Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTg5Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537461892", "bodyText": "Could this be called from multiple threads?", "author": "ochaloup", "createdAt": "2020-12-07T12:17:36Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n+         * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n+         */\n+\n+        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+    }\n \n-        return terminateURIs.get(\"Link\");\n+    private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n+        return progress.stream().noneMatch(p -> p.progress == step);\n     }\n \n-    private void lraTrace(URI lraId, String reason) {\n-        if (LRALogger.logger.isTraceEnabled()) {\n-            Method method = resourceInfo.getResourceMethod();\n-            LRALogger.logger.tracef(\"%s: container request for method %s: lra: %s%n\",\n-                    reason, method.getDeclaringClass().getName() + \"#\" + method.getName(),\n-                    lraId == null ? \"context\" : lraId);\n+    // add another step to the list of steps performed so far\n+    private ArrayList<Progress> updateProgress(ArrayList<Progress> progress, ProgressStep step, String reason) {\n+        if (progress == null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2MTc3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537661776", "bodyText": "I missed these comments, github had collapse them all. Anyway,\nThis code is part of a request response processing filter chain. The context for such a request is passed into the filter method and applies to the particular request context. If you check the variable progress you will see that it is a method local variable and therefore not subject to your implied concurrency concern. In addition the contents of progress are passed to the response filter via a context property (of the request context)n and again there are no concurrency concerns.", "author": "mmusgrov", "createdAt": "2020-12-07T16:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537463564", "bodyText": "a minor thing, the ClientLRAFilter uses the call as updateProgress(progres, ...) while this class uses the format progress = updateProgress(progress, .... Would not be better to use the same format of the call (probably just updateProgress(...)?", "author": "ochaloup", "createdAt": "2020-12-07T12:20:36Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -385,10 +460,24 @@ public void filter(ContainerRequestContext requestContext, ContainerResponseCont\n         try {\n             if (current != null && isCancel) {\n                 try {\n-                    lraClient.cancelLRA(current);\n+                    // do not attempt to cancel if the request filter tried but failed to start a new LRA\n+                    if (progress == null || progressDoesNotContain(progress, ProgressStep.StartFailed)) {\n+                        lraClient.cancelLRA(current);\n+                        progress = updateProgress(progress, ProgressStep.Ended, null);", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2Mjg2Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537662862", "bodyText": "This is a server side request filter and it is only on the server that we need to check for coordinator availability. The ClientLRAFilter is for client side processing and is of no concern to the goals of this PR.", "author": "mmusgrov", "createdAt": "2020-12-07T16:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4MDQyOA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538180428", "bodyText": "Oh, sorry. I referred wrong class. I should say other method of the ServerLRAFilter.\nI'm talking about code style. My question of the different style was in reference to this method: https://github.com/jbosstm/narayana/pull/1738/files#diff-0b58c3a08c0d4f3a8f3953db76f78e21ca70325b035a36779d0739195444faf4R704", "author": "ochaloup", "createdAt": "2020-12-08T09:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1Nzc3NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539357775", "bodyText": "What other method (that link just takes me to the top of the PR diffs). Is this one another complaint about my coding style not matching up with what you prefer.", "author": "mmusgrov", "createdAt": "2020-12-09T14:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNjc1MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539416751", "bodyText": "No, here I'm not talking about the coding style. I'm talking to use the same way of method call in the code of this PR. Once it's updateProgress(progres, ...) while in a moment in the same PR it's progress = updateProgress(progress, ...). I'm advocating here the consistency of code snippets in the PR code. Let's leave it as it is.\nAnd, I'm not complaining about anything in any of my comments. I'm discussing the PR, trying to understand the purpose and find a ways how to improve it.", "author": "ochaloup", "createdAt": "2020-12-09T15:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537465287", "bodyText": "Using the enum ordinal for identity is not a good practice in java programming (https://wiki.sei.cmu.edu/confluence/display/java/DCL56-J.+Do+not+attach+significance+to+the+ordinal+associated+with+an+enum). There should be used a different approach for codes.", "author": "ochaloup", "createdAt": "2020-12-07T12:23:40Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2MzUwOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537663509", "bodyText": "The advice you quote (DCL56-J) \"Do not attach significance to the ordinal associated with an enum\" does not apply.\nI am not attaching any significance to the ordinal value and I am using it as an identifier, identifiers do not carry significance, other than the fact that they imply uniqueness.", "author": "mmusgrov", "createdAt": "2020-12-07T16:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMzkwMg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538203902", "bodyText": "I don't agree. The ordinal is used here for definition of the op code - they are reported to user as a code with significance of particular state.\nThe main reason is maitanance - enum constant reordering means troubles, op codes are not unique as any other constant enum will need to be used the values will be same... Check e.g. Effective Java from Joshua Bloch, Item 35.", "author": "ochaloup", "createdAt": "2020-12-08T10:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537466617", "bodyText": "Should not be \"end suceeded\"?", "author": "ochaloup", "createdAt": "2020-12-07T12:25:55Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NDQxMQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537664411", "bodyText": "Maybe, or \"join ok\" would work too from a consistency point of view.", "author": "mmusgrov", "createdAt": "2020-12-07T16:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3MTcyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538171725", "bodyText": "and \"leave ok\" when \"ok\" is taken", "author": "ochaloup", "createdAt": "2020-12-08T09:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537468014", "bodyText": "When the progress data structure is used for seeking on existence would not be better to use the map structure?", "author": "ochaloup", "createdAt": "2020-12-07T12:28:15Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n+         * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n+         */\n+\n+        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+    }\n \n-        return terminateURIs.get(\"Link\");\n+    private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n+        return progress.stream().noneMatch(p -> p.progress == step);", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NTIzMw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537665233", "bodyText": "I don't know. Let's get the functionality out there rather than getting the code absolutely perfect. There is plenty of scope for improving the code elsewhere.", "author": "mmusgrov", "createdAt": "2020-12-07T16:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3MDU2OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538170569", "bodyText": "And this could be one of them. I'm providing a feedback. If you consider not worthy for fixing it then ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537469842", "bodyText": "Would no this EnumSet be more appropriate to be part (a member) of the ProgressStep Enum itself?", "author": "ochaloup", "createdAt": "2020-12-07T12:31:27Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NzcwNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537667704", "bodyText": "Not necessarily. Progress knows what constitutes a failure. Again, if we want this code to be perfect then different engineers have different concepts of perfection and such a strategy just serves to prolong the process.", "author": "mmusgrov", "createdAt": "2020-12-07T16:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NTE0NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538185144", "bodyText": "This was a regular question, nothing about perfection. I want to understand the code from the design perspective.\nI understand that it's intended that the Progress to have this responsibility. That's fine by me.", "author": "ochaloup", "createdAt": "2020-12-08T09:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537471079", "bodyText": "Maybe this would be better to be name with success? These this term seems to be used more in the sources here than ok to say that's all fine.", "author": "ochaloup", "createdAt": "2020-12-07T12:33:31Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzMwNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607305", "bodyText": "It is a private method and there are lots of other words that mean the same thing.\nIf I change it to something you want then what about the next person who prefers something different.", "author": "mmusgrov", "createdAt": "2020-12-07T15:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NzM5NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538187394", "bodyText": "We can discuss it with the other person if he finds some part of code misleading.\nI don't talk about my private preference, I talk about using the same terms for the same thing.\nWhen the ok phrase are going to be used in other places then let's go with \"ok\".", "author": "ochaloup", "createdAt": "2020-12-08T09:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0NjE5NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539346194", "bodyText": "This is a trivial PR comment and is subjective. But if you're going to dig your feat in then I'll change it. I could be flippant and ask you for a coding style guide which passes your coding criteria, but I'll change it.", "author": "mmusgrov", "createdAt": "2020-12-09T14:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDc0Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539420747", "bodyText": "Anything what we do is subjective. I'm advocating the recommended sw practices for naming in this comment. There is no guide only recommendations in this are (e.g. Clean Code - Pick One Word per Concept).\nWhen you feel differently I'm not going to insist on this.", "author": "ochaloup", "createdAt": "2020-12-09T15:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537473295", "bodyText": "Why the ProgressStep#status is reported for success and not for the failure?", "author": "ochaloup", "createdAt": "2020-12-07T12:37:19Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzY3Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607673", "bodyText": "Because the stuff in the brackets is only there to give more information about the step.\nThe failure branch includes the exception message whereas in the successful branch it adds nothing other than a more verbose description of name().", "author": "mmusgrov", "createdAt": "2020-12-07T15:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4ODA1Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538188057", "bodyText": "Ok, thanks for clarification.", "author": "ochaloup", "createdAt": "2020-12-08T09:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537475758", "bodyText": "Would not be clearer and faster not to concatenate the progress ops in case of succesful run (ie. the most probably much more often case than the failure)?\nChecking here for empy ops failure or similar, instead of checking the content of string of failureMesssage?", "author": "ochaloup", "createdAt": "2020-12-07T12:41:32Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -431,6 +529,23 @@ public void filter(ContainerRequestContext requestContext, ContainerResponseCont\n                         Response.Status.ACCEPTED.getStatusCode(),\n                         Response.Status.OK.getStatusCode());\n             }\n+\n+            /*\n+             * report any failed steps (ie if progress contains any failures) to the caller.\n+             * If either filter encountered a failure they may have completed partial actions and\n+             * we need tell the caller which steps failed and which ones succeeded. We use a\n+             * different warning code for each scenario:\n+             */\n+            if (progress != null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwODYxMg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537608612", "bodyText": "Let's deal with performance enhancements when we have the primary functionality in place. There are many places throughout the code that need to be optimised.", "author": "mmusgrov", "createdAt": "2020-12-07T15:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4MjU3Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538182573", "bodyText": "It could be good to consider it during design phase as well. But ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537479941", "bodyText": "After a while of decoding I understand the idea here.\nI would use probably a format but it's a matter of taste as discussed elsewhere.\nI would rather ask here what happens when there are multiple failed (or successful) op codes. They seem to be appended without any delimiter, or not?\nIn fact I wonder what is the purpose of having these opcodes as part of the user readable failure message?", "author": "ochaloup", "createdAt": "2020-12-07T12:47:51Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwOTkzMQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537609931", "bodyText": "Not. The code is using java.util.StringJoiner which includes the delimiter in the constructor.\nThe purpose is for knowing which operations are potentially in doubt.\nWe need some response to tell the caller that something is in doubt and this gives him a fighting chance of figuring out what went wrong i.e. it's not meant for users to read, rather it is for application logic to reason about the status of the system.\nYou/we can provide something more comprehensive in MP release 1.x", "author": "mmusgrov", "createdAt": "2020-12-07T15:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzk2MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538197961", "bodyText": "I see, thanks for clarification about the StringJoiner.\nThese type of changes could be difficult to done if this is a feature which is expected to be used by application logic and when some application starts to depend on it.\nMy trouble is that I don't understand well the usecase to be able to consider other possibilities. If there is some maybe we can discuss other approaches.\nIf you consider this the best for LRA design, ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0ODI0NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539348244", "bodyText": "We need to make progress and we don't have time for long protracted coding style debates.\nAfter we have finally got the code in front of users we can take our foot off the pedal and you can rework it all to satisfy your sensibilities.", "author": "mmusgrov", "createdAt": "2020-12-09T14:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODE3Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539428177", "bodyText": "This change defines an API and as such it's good to be topic of a discussion.\nNever mind, I'm resolving this conversation thread.", "author": "ochaloup", "createdAt": "2020-12-09T15:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537481259", "bodyText": "Why this check for null is needed when the updateProgress checks on null?", "author": "ochaloup", "createdAt": "2020-12-07T12:50:00Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -240,41 +286,65 @@ public void filter(ContainerRequestContext containerRequestContext) {\n \n                         // if there is an LRA present nest a new LRA under it\n                         suspendedLRA = incommingLRA;\n-                        lraTrace(suspendedLRA, \"ServerLRAFilter before: REQUIRED start new LRA\");\n-                        newLRA = lraId = startLRA(incommingLRA, method, timeout);\n+\n+                        if (progress == null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxMDE5MA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537610190", "bodyText": "Because it might be null and updateProgress might not have been called.", "author": "mmusgrov", "createdAt": "2020-12-07T15:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3ODg0MA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538178840", "bodyText": "I see. I have additional question of matter of preference.\nWould not be easier to initiate it at start (https://github.com/jbosstm/narayana/pull/1738/files#diff-0b58c3a08c0d4f3a8f3953db76f78e21ca70325b035a36779d0739195444faf4R139) instead?", "author": "ochaloup", "createdAt": "2020-12-08T09:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0ODg2OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539348869", "bodyText": "I could rewrite the whole thing in many different ways. Code is an art as well as a science.", "author": "mmusgrov", "createdAt": "2020-12-09T14:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwOTA3OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539409078", "bodyText": "Okay...", "author": "ochaloup", "createdAt": "2020-12-09T15:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "chunk": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n\n@@ -322,7 +321,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n //                    previous = AtomicAction.suspend();\n                 suspendedLRA = incommingLRA;\n \n-                if (progress == null) { // NB my IDE seems to think this check is redundant\n+                if (progress == null) {\n                     progress = new ArrayList<>();\n                 }\n                 newLRA = lraId = startLRA(containerRequestContext,null, method, timeout, progress);\n"}}, {"oid": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "url": "https://github.com/jbosstm/narayana/commit/b3de967d8f9de5d9716a9f50a3db5ff76349768b", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-10T14:23:34Z", "type": "forcePushed"}, {"oid": "9bc8e4975f73622058d51161408318db3eda0dde", "url": "https://github.com/jbosstm/narayana/commit/9bc8e4975f73622058d51161408318db3eda0dde", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-13T23:36:15Z", "type": "commit"}, {"oid": "9bc8e4975f73622058d51161408318db3eda0dde", "url": "https://github.com/jbosstm/narayana/commit/9bc8e4975f73622058d51161408318db3eda0dde", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-13T23:36:15Z", "type": "forcePushed"}]}