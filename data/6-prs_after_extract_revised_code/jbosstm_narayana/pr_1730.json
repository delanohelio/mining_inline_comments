{"pr_number": 1730, "pr_title": "Make 4.17 testable on JDK6", "pr_createdAt": "2020-11-26T10:13:58Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1730", "timeline": [{"oid": "292087d51f60db64242182b0ec9f711e95e3eb11", "url": "https://github.com/jbosstm/narayana/commit/292087d51f60db64242182b0ec9f711e95e3eb11", "message": "[SCRIPTS ONLY] possible to use JDK6 to run tests", "committedDate": "2020-11-06T09:32:30Z", "type": "commit"}, {"oid": "bc6d8154345fb06e63000f54ef5bc707f201b31b", "url": "https://github.com/jbosstm/narayana/commit/bc6d8154345fb06e63000f54ef5bc707f201b31b", "message": "Using maven 3.2.5 as the last version working on JDK6", "committedDate": "2020-11-06T09:32:30Z", "type": "commit"}, {"oid": "2faefe628819d93bd6f70e21588e7d715eefd475", "url": "https://github.com/jbosstm/narayana/commit/2faefe628819d93bd6f70e21588e7d715eefd475", "message": "[RELEASE SCRIPT ONLY] 4.17 branch works with tags only not with the binary releases", "committedDate": "2020-11-06T09:32:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532717729", "bodyText": "Why do we only run the tests on JDK 1.6?", "author": "mmusgrov", "createdAt": "2020-11-30T16:15:03Z", "path": "ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/FailAfterPrepareBase.java", "diffHunk": "@@ -50,6 +52,12 @@\n     private SimpleXAResource xaResource;\n     private CommitMarkableResourceRecordRecoveryModule recoveryModule;\n \n+    @Before\n+    public void setUp() {\n+        // not running with JDK6\n+        Assume.assumeTrue(!System.getProperty(\"java.version\").startsWith(\"1.6\"));", "originalCommit": "1ed83025da1d7d0b07f49bb0112f35740ce3e672", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczODEyOA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532738128", "bodyText": "It's the test for not being run on JDK 1.6 as there is the trouble as test checks for suppressed exceptions. Skipping these few tests on 1.6 was the shortcut to proceed with testing on JDK6.", "author": "ochaloup", "createdAt": "2020-11-30T16:42:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0OTAxMA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532749010", "bodyText": "Will we run these tests for JDK7+ still?", "author": "tomjenkinson", "createdAt": "2020-11-30T16:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc1NDE3NA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532754174", "bodyText": "Is that because we aren't allowed to do introspection to see if suppressed exceptions are available (I think that is what the later code did)? And is there no check for 1.5 because we don't support 1.5?", "author": "mmusgrov", "createdAt": "2020-11-30T17:03:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NDY3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532764676", "bodyText": "@tomjenkinson  Yes. It will be still running on JDK7+.\n@mmusgrov It's because the tests assertion work with the suppressed exceptions. I would need to change the logic of the tests which I don't want to do.\nYes, there is not check for 1.5 as it's not possible to start Narayana on JDK1.5 (aka. we do not support it).", "author": "ochaloup", "createdAt": "2020-11-30T17:18:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3OTE1MA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532779150", "bodyText": "I meant why aren't we using refection to see if the method exists like we do in the main code (\nhttps://github.com/jbosstm/narayana/blob/4.17.43.Final/ArjunaJTA/jta/classes/com/arjuna/ats/internal/jta/transaction/arjunacore/TransactionImple.java#L1684) rather than checking for specific JDK versions.", "author": "mmusgrov", "createdAt": "2020-11-30T17:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIwNjAzOA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r533206038", "bodyText": "By my opinion we can use both approaches here. The reflection targets the difference more precisely as we do use from JDK API only this method.", "author": "ochaloup", "createdAt": "2020-12-01T09:22:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIwODIyOA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r533208228", "bodyText": "And the reason why I chose to use the check for the java version is that it sounds me more reasonable for the test approach.", "author": "ochaloup", "createdAt": "2020-12-01T09:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIyMTAxNQ==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r533221015", "bodyText": "I will use the similar approach as for TransactionImple to be done in the same way", "author": "ochaloup", "createdAt": "2020-12-01T09:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcxNzcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "0323f19dec710bfd134f5bdd7536dca2d0b5bb33", "chunk": "diff --git a/ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/FailAfterPrepareBase.java b/ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/FailAfterPrepareBase.java\nindex e15f4ff12..97a4a62af 100644\n--- a/ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/FailAfterPrepareBase.java\n+++ b/ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/FailAfterPrepareBase.java\n\n@@ -54,8 +55,9 @@ public class FailAfterPrepareBase extends TestCommitMarkableResourceBase {\n \n     @Before\n     public void setUp() {\n-        // not running with JDK6\n-        Assume.assumeTrue(!System.getProperty(\"java.version\").startsWith(\"1.6\"));\n+        // tests runs with JDK API 7+ where suppressed exceptions are available\n+        // otherwise the test is skipped as it would fail\n+        Assume.assumeTrue(SuppressedExceptionsHelper.canSuppress());\n     }\n \n     protected Uid generateCMRRecord(final DataSource dataSource) throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTc3MA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532721770", "bodyText": "What was the problem with Utils.removeRecursive? Is it using features that aren't in 1.6?", "author": "mmusgrov", "createdAt": "2020-11-30T16:20:36Z", "path": "ArjunaJTA/jta/tests/classes/com/hp/mwtests/ts/jta/commitmarkable/TestCommitMarkableResourceBase.java", "diffHunk": "@@ -49,7 +50,7 @@ public final void setup() throws Exception {\n \n \t\tFile file = new File(System.getProperty(\"user.dir\") + \"/ObjectStore\");\n \t\tif (file.exists()) {\n-\t\t\tUtils.removeRecursive(file.toPath());\n+\t\t\tFileUtils.deleteRecursive(file.getAbsolutePath(), false);", "originalCommit": "1ed83025da1d7d0b07f49bb0112f35740ce3e672", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczODMyMA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532738320", "bodyText": "Yes. It's from 1.7 in Java.", "author": "ochaloup", "createdAt": "2020-11-30T16:42:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc1NDkxNA==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532754914", "bodyText": "So do you mean that the code inside FileUtils.deleteRecursive() is using features that are not available 1.6", "author": "mmusgrov", "createdAt": "2020-11-30T17:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2MzM5OQ==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532763399", "bodyText": "Sorry, I probably explained wrongly.\nThe FileUtils uses the code which is available in 1.6. That's the reason why I took that class it into the changeset.\nThe Utils class uses the file nio utils methods which are not available on JDK6. That's the reason for replacing it.", "author": "ochaloup", "createdAt": "2020-11-30T17:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3OTkwMw==", "url": "https://github.com/jbosstm/narayana/pull/1730#discussion_r532779903", "bodyText": "Ah right, got you thanks. I'll mark this conversation as resolved then.", "author": "mmusgrov", "createdAt": "2020-11-30T17:41:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTc3MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0e1025f69d6954b32eda676d8687dd551013a512", "url": "https://github.com/jbosstm/narayana/commit/0e1025f69d6954b32eda676d8687dd551013a512", "message": "[JDK6 compatibility] test changes to fix JDK6 compatibility\n\n* Throwable#getSuppressed is available from JDK7\n* do not using java nio methods from JDK7\n* fix dependencies to be compatible with JDK6 (H2 and maven enforcer plugin)\n* skip tests which does not work on JDK6 because of InitialContext rebind\n* not executing 'narayana-full' on tests as assembly was already created\n  during build and it fails with JDK6", "committedDate": "2020-11-30T16:51:06Z", "type": "forcePushed"}, {"oid": "0323f19dec710bfd134f5bdd7536dca2d0b5bb33", "url": "https://github.com/jbosstm/narayana/commit/0323f19dec710bfd134f5bdd7536dca2d0b5bb33", "message": "[JDK6 compatibility] test changes to fix JDK6 compatibility\n\n* Throwable#getSuppressed is available from JDK7\n* do not using java nio methods from JDK7\n* fix dependencies to be compatible with JDK6 (H2 and maven enforcer plugin)\n* skip tests which does not work on JDK6 because of InitialContext rebind\n* not executing 'narayana-full' on tests as assembly was already created\n  during build and it fails with JDK6", "committedDate": "2020-12-01T09:30:27Z", "type": "commit"}, {"oid": "0323f19dec710bfd134f5bdd7536dca2d0b5bb33", "url": "https://github.com/jbosstm/narayana/commit/0323f19dec710bfd134f5bdd7536dca2d0b5bb33", "message": "[JDK6 compatibility] test changes to fix JDK6 compatibility\n\n* Throwable#getSuppressed is available from JDK7\n* do not using java nio methods from JDK7\n* fix dependencies to be compatible with JDK6 (H2 and maven enforcer plugin)\n* skip tests which does not work on JDK6 because of InitialContext rebind\n* not executing 'narayana-full' on tests as assembly was already created\n  during build and it fails with JDK6", "committedDate": "2020-12-01T09:30:27Z", "type": "forcePushed"}]}