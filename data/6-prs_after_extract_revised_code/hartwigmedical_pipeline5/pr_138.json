{"pr_number": 138, "pr_title": "DEV-1163 Make CMEK a required argument", "pr_createdAt": "2020-03-09T08:46:14Z", "pr_url": "https://github.com/hartwigmedical/pipeline5/pull/138", "timeline": [{"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "url": "https://github.com/hartwigmedical/pipeline5/commit/ad2697d3e9817b1f83a310445f9b9345b751c0da", "message": "DEV-1163 Make CMEK a required argument\n\nBetter to require every invocation to have a key (even if it is just a\ndevelopment one) than risk not having one on a run that requires it.", "committedDate": "2020-03-09T08:44:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NjI1NA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389846254", "bodyText": "better to pull these up into CommonArguments than to introduce a dependency on pipeline Arguments", "author": "pauldwolfe", "createdAt": "2020-03-09T17:29:39Z", "path": "batch/src/main/java/com/hartwig/batch/BatchArguments.java", "diffHunk": "@@ -41,8 +33,8 @@ static BatchArguments from(String[] args) {\n             CommandLine commandLine = new DefaultParser().parse(options(), args);\n             return ImmutableBatchArguments.builder()\n                     .command(args[0])\n-                    .project(commandLine.getOptionValue(PROJECT, \"hmf-pipeline-development\"))\n-                    .region(commandLine.getOptionValue(REGION, \"europe-west4\"))\n+                    .project(commandLine.getOptionValue(PROJECT, Arguments.DEFAULT_DEVELOPMENT_PROJECT))", "originalCommit": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "chunk": "diff --git a/batch/src/main/java/com/hartwig/batch/BatchArguments.java b/batch/src/main/java/com/hartwig/batch/BatchArguments.java\nindex e0222049..5be458a1 100644\n--- a/batch/src/main/java/com/hartwig/batch/BatchArguments.java\n+++ b/batch/src/main/java/com/hartwig/batch/BatchArguments.java\n\n@@ -33,7 +33,7 @@ public interface BatchArguments extends CommonArguments {\n             CommandLine commandLine = new DefaultParser().parse(options(), args);\n             return ImmutableBatchArguments.builder()\n                     .command(args[0])\n-                    .project(commandLine.getOptionValue(PROJECT, Arguments.DEFAULT_DEVELOPMENT_PROJECT))\n+                    .project(commandLine.getOptionValue(PROJECT, CommonArguments.DEFAULT_DEVELOPMENT_PROJECT))\n                     .region(commandLine.getOptionValue(REGION, Arguments.DEFAULT_PRODUCTION_REGION))\n                     .useLocalSsds(parseBoolean(commandLine.getOptionValue(LOCAL_SSDS, \"true\")))\n                     .usePreemptibleVms(parseBoolean(commandLine.getOptionValue(PREEMPTIBLE_VMS, \"true\")))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzE2Nw==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389847167", "bodyText": "Normal the CMEK is actually just the name of the key used ie. projects/project/location/blah/blah. Does this actually work having it a json file? I don't see why running in Docker would need to impact CMEK (it's more like the prokect or location setttings).", "author": "pauldwolfe", "createdAt": "2020-03-09T17:31:06Z", "path": "cluster/src/main/java/com/hartwig/pipeline/Arguments.java", "diffHunk": "@@ -17,6 +17,120 @@\n \n     boolean cleanup();\n \n+    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";", "originalCommit": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "chunk": "diff --git a/cluster/src/main/java/com/hartwig/pipeline/Arguments.java b/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\nindex 7efc651b..7be5bb26 100644\n--- a/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\n+++ b/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\n\n@@ -17,8 +17,6 @@ public interface Arguments extends CommonArguments {\n \n     boolean cleanup();\n \n-    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";\n-\n     boolean upload();\n \n     boolean uploadFromGcp();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzcxMA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389847710", "bodyText": "Why are these all \"new lines\"?", "author": "pauldwolfe", "createdAt": "2020-03-09T17:32:02Z", "path": "cluster/src/main/java/com/hartwig/pipeline/Arguments.java", "diffHunk": "@@ -17,6 +17,120 @@\n \n     boolean cleanup();\n \n+    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";\n+\n+    boolean upload();", "originalCommit": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2MzY2OA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r392563668", "bodyText": "Ah. I moved the builder method below the constants and interface methods.", "author": "nedleitch", "createdAt": "2020-03-14T07:04:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzcxMA=="}], "type": "inlineReview", "revised_code": {"commit": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "chunk": "diff --git a/cluster/src/main/java/com/hartwig/pipeline/Arguments.java b/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\nindex 7efc651b..7be5bb26 100644\n--- a/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\n+++ b/cluster/src/main/java/com/hartwig/pipeline/Arguments.java\n\n@@ -17,8 +17,6 @@ public interface Arguments extends CommonArguments {\n \n     boolean cleanup();\n \n-    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";\n-\n     boolean upload();\n \n     boolean uploadFromGcp();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0ODEyMQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389848121", "bodyText": "use cmek().trim().isEmpty()", "author": "pauldwolfe", "createdAt": "2020-03-09T17:32:39Z", "path": "cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java", "diffHunk": "@@ -49,10 +48,11 @@ private synchronized static RuntimeBucket createBucketIfNeeded(final Storage sto\n             LOGGER.debug(\"Creating runtime bucket [{}] in Google Storage\", runId);\n             BucketInfo.Builder builder =\n                     BucketInfo.newBuilder(runId).setStorageClass(StorageClass.REGIONAL).setLocation(arguments.region());\n-            arguments.cmek().ifPresent(key -> {\n-                LOGGER.info(\"Using CMEK key [{}] to encrypt all buckets\", key);\n-                builder.setDefaultKmsKeyName(key);\n-            });\n+            if (\"\".equals(arguments.cmek().trim())) {", "originalCommit": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk1MDkxMg==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r391950912", "bodyText": "Yeah that's weak.", "author": "nedleitch", "createdAt": "2020-03-12T23:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0ODEyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "chunk": "diff --git a/cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java b/cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java\nindex 90f9fc01..bf477807 100644\n--- a/cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java\n+++ b/cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java\n\n@@ -48,7 +48,7 @@ public class RuntimeBucket {\n             LOGGER.debug(\"Creating runtime bucket [{}] in Google Storage\", runId);\n             BucketInfo.Builder builder =\n                     BucketInfo.newBuilder(runId).setStorageClass(StorageClass.REGIONAL).setLocation(arguments.region());\n-            if (\"\".equals(arguments.cmek().trim())) {\n+            if (arguments.cmek().trim().isEmpty()) {\n                 throw new IllegalArgumentException(\"CMEK key must be used\");\n             }\n             LOGGER.info(\"Using CMEK key [{}] to encrypt all buckets\", arguments.cmek());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0OTQ1NQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389849455", "bodyText": "As you pointed out this doesn't make it very external friendly. But... I don't think that's the most important thing right now so we can decide later whether its worth the additional complexity of having a separate flag to disable cmek and make this an optional again.", "author": "pauldwolfe", "createdAt": "2020-03-09T17:34:44Z", "path": "cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java", "diffHunk": "@@ -39,7 +39,7 @@\n \n     String serviceAccountEmail();\n \n-    Optional<String> cmek();", "originalCommit": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a032433cc09d80915116678e45784449ea544c44", "chunk": "diff --git a/cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java b/cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java\nindex 6d61b921..081bd987 100644\n--- a/cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java\n+++ b/cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java\n\n@@ -35,7 +43,7 @@ public interface CommonArguments {\n \n     boolean useLocalSsds();\n \n-    Optional<String> privateNetwork();\n+    String privateNetwork();\n \n     String serviceAccountEmail();\n \n"}}, {"oid": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "url": "https://github.com/hartwigmedical/pipeline5/commit/1d2cb2cf39c55999dc812d5c5e8d90256550248d", "message": "DEV-1163 Refactor CMEK arguments", "committedDate": "2020-03-14T06:51:14Z", "type": "commit"}, {"oid": "8fac7cda6bbbc39af43f94f4e5bbdf042875ee7a", "url": "https://github.com/hartwigmedical/pipeline5/commit/8fac7cda6bbbc39af43f94f4e5bbdf042875ee7a", "message": "DEV-1163 Move default region to CommonArguments", "committedDate": "2020-03-14T07:06:51Z", "type": "commit"}, {"oid": "a032433cc09d80915116678e45784449ea544c44", "url": "https://github.com/hartwigmedical/pipeline5/commit/a032433cc09d80915116678e45784449ea544c44", "message": "Merge branch 'master' into DEV-1163", "committedDate": "2020-03-16T15:00:41Z", "type": "commit"}]}