{"pr_number": 112, "pr_title": "DEV-1101 Integrate pipeline5 with bcl2fastq on GCP", "pr_createdAt": "2020-01-09T17:37:50Z", "pr_url": "https://github.com/hartwigmedical/pipeline5/pull/112", "timeline": [{"oid": "1e00de1848d989ae443244940a365e7a4524e6be", "url": "https://github.com/hartwigmedical/pipeline5/commit/1e00de1848d989ae443244940a365e7a4524e6be", "message": "DEV-1101 Fix bugs found in initial integration\n\nFastq files were not getting picked up when listing the runtime bucket. Fastq filenames should have\nthe flowcell name included as the second token.", "committedDate": "2020-01-07T20:20:35Z", "type": "commit"}, {"oid": "c52ca77d09bd51736eea6622ca15bf2481671170", "url": "https://github.com/hartwigmedical/pipeline5/commit/c52ca77d09bd51736eea6622ca15bf2481671170", "message": "DEV-1101 Add integration for fastq located in GCP to the pipeline\n\nAdds a toggle that once enabled, will upload fastq input from GCP rather than the SBP S3.\nThe location of the fastq is still taken from the SBP API (run->sample->fastq).\n\nAlso updated the Bcl2Fastq command thread settings to match production.", "committedDate": "2020-01-09T17:36:42Z", "type": "commit"}, {"oid": "16b0b95ac834b3e5620a4c21d8dd35477e185897", "url": "https://github.com/hartwigmedical/pipeline5/commit/16b0b95ac834b3e5620a4c21d8dd35477e185897", "message": "DEV-1101 Build docker for branch", "committedDate": "2020-01-09T19:21:44Z", "type": "commit"}, {"oid": "fd62f1da1075c62f1d2ddba164bc91c48145e624", "url": "https://github.com/hartwigmedical/pipeline5/commit/fd62f1da1075c62f1d2ddba164bc91c48145e624", "message": "DEV-1101 Use correct main in docker container", "committedDate": "2020-01-09T19:57:31Z", "type": "commit"}, {"oid": "372199a065a6b91c7bb0af297eb5e2b15c05cc0f", "url": "https://github.com/hartwigmedical/pipeline5/commit/372199a065a6b91c7bb0af297eb5e2b15c05cc0f", "message": "DEV-1101 Remove private key path from docker profile", "committedDate": "2020-01-09T22:12:50Z", "type": "commit"}, {"oid": "e9c8141c3058d915bac4618a4855a4cc66423361", "url": "https://github.com/hartwigmedical/pipeline5/commit/e9c8141c3058d915bac4618a4855a4cc66423361", "message": "DEV-1101 Remove private key path from docker profile", "committedDate": "2020-01-09T22:13:05Z", "type": "commit"}, {"oid": "44b72c0569cfe0464f8a7fa9f9ada2979312f3cf", "url": "https://github.com/hartwigmedical/pipeline5/commit/44b72c0569cfe0464f8a7fa9f9ada2979312f3cf", "message": "DEV-1101 Remove private key path from docker profile", "committedDate": "2020-01-10T20:26:09Z", "type": "commit"}, {"oid": "8a39eaf0ac580e46e683b076d90fcbf2471d76a3", "url": "https://github.com/hartwigmedical/pipeline5/commit/8a39eaf0ac580e46e683b076d90fcbf2471d76a3", "message": "Merge branch 'master' into DEV-1101", "committedDate": "2020-01-13T17:39:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA0MjA3MA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/112#discussion_r366042070", "bodyText": "Response.Status.CREATED or something similar?", "author": "nedleitch", "createdAt": "2020-01-13T21:38:17Z", "path": "bcl2fastq/src/main/java/com/hartwig/bcl2fastq/metadata/SbpFastqMetadataApi.java", "diffHunk": "@@ -55,7 +55,7 @@ public SbpSample findOrCreate(String barcode, String submission) {\n                 try {\n                     Response response = samples().request()\n                             .post(Entity.entity(objectMapper.writeValueAsString(sample), MediaType.APPLICATION_JSON_TYPE));\n-                    if (response.getStatus() == 200) {\n+                    if (response.getStatus() == 201) {", "originalCommit": "e9c8141c3058d915bac4618a4855a4cc66423361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTI0OQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/112#discussion_r366091249", "bodyText": "Good suggestion", "author": "pauldwolfe", "createdAt": "2020-01-13T23:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA0MjA3MA=="}], "type": "inlineReview", "revised_code": {"commit": "60856a65a8ce47aa0c708cb9fd47a25ef877f98f", "chunk": "diff --git a/bcl2fastq/src/main/java/com/hartwig/bcl2fastq/metadata/SbpFastqMetadataApi.java b/bcl2fastq/src/main/java/com/hartwig/bcl2fastq/metadata/SbpFastqMetadataApi.java\nindex f388bb4f..cdbb04e4 100644\n--- a/bcl2fastq/src/main/java/com/hartwig/bcl2fastq/metadata/SbpFastqMetadataApi.java\n+++ b/bcl2fastq/src/main/java/com/hartwig/bcl2fastq/metadata/SbpFastqMetadataApi.java\n\n@@ -55,7 +55,7 @@ public class SbpFastqMetadataApi {\n                 try {\n                     Response response = samples().request()\n                             .post(Entity.entity(objectMapper.writeValueAsString(sample), MediaType.APPLICATION_JSON_TYPE));\n-                    if (response.getStatus() == 201) {\n+                    if (isCreated(response)) {\n                         return findOrCreate(barcode, submission);\n                     } else {\n                         throw new RuntimeException(String.format(\"Unable to post new sample [%s] api returned status [%s] and message [%s]\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA0Mjc2OQ==", "url": "https://github.com/hartwigmedical/pipeline5/pull/112#discussion_r366042769", "bodyText": "Much better.", "author": "nedleitch", "createdAt": "2020-01-13T21:39:57Z", "path": "cluster/src/main/java/com/hartwig/pipeline/execution/vm/VirtualMachinePerformanceProfile.java", "diffHunk": "@@ -1,24 +1,26 @@\n package com.hartwig.pipeline.execution.vm;\n \n-import static java.lang.String.format;\n-\n import com.hartwig.pipeline.execution.MachineType;\n import com.hartwig.pipeline.execution.PerformanceProfile;\n \n import org.immutables.value.Value;\n \n @Value.Immutable\n-public interface VirtualMachinePerformanceProfile extends PerformanceProfile{\n+public interface VirtualMachinePerformanceProfile extends PerformanceProfile {\n+\n+    @Value.Default\n+    default String uri() {\n+        return machineType().uri();\n+    }\n \n-    String uri();\n+    MachineType machineType();", "originalCommit": "e9c8141c3058d915bac4618a4855a4cc66423361", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA0NDY3MA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/112#discussion_r366044670", "bodyText": "We have had surprises in the past, would it be wise to check the filename conforms to expectations?", "author": "nedleitch", "createdAt": "2020-01-13T21:44:21Z", "path": "bcl2fastq/src/main/java/com/hartwig/bcl2fastq/conversion/ResultAggregation.java", "diffHunk": "@@ -95,7 +95,15 @@ static ConvertedFastq fastq(IlluminaSample sample, Map.Entry<String, List<Blob>>\n     }\n \n     private static String outputPath(final IlluminaSample sample, final Stats stats, final Blob blobR1) {\n-        return stats.flowcell() + \"/\" + sample.barcode() + \"/\" + new File(blobR1.getName()).getName();\n+        String[] fileNameSplit = new File(blobR1.getName()).getName().split(\"_\");", "originalCommit": "e9c8141c3058d915bac4618a4855a4cc66423361", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTQ2NA==", "url": "https://github.com/hartwigmedical/pipeline5/pull/112#discussion_r366091464", "bodyText": "hmm, as this file convention is produced by the version of bcl2fastq also in this codebase I think its fine to have this implicit dependency on the filename.", "author": "pauldwolfe", "createdAt": "2020-01-13T23:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA0NDY3MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "03e8246aa22b736dfb0497515f6dea2d6d239cfb", "url": "https://github.com/hartwigmedical/pipeline5/commit/03e8246aa22b736dfb0497515f6dea2d6d239cfb", "message": "DEV-1101 Still link flowcell, samples, fastq on flowcell QC fail", "committedDate": "2020-01-13T22:03:49Z", "type": "commit"}, {"oid": "60856a65a8ce47aa0c708cb9fd47a25ef877f98f", "url": "https://github.com/hartwigmedical/pipeline5/commit/60856a65a8ce47aa0c708cb9fd47a25ef877f98f", "message": "DEV-1101 Review comments\n\nUse jax-rs constants for created status.", "committedDate": "2020-01-13T23:54:54Z", "type": "commit"}]}