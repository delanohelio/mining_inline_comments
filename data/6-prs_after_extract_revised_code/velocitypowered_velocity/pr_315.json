{"pr_number": 315, "pr_title": "Implement legacy forwarding BungeeGuard handshake support", "pr_createdAt": "2020-06-02T22:12:20Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/315", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwNTIyMw==", "url": "https://github.com/VelocityPowered/Velocity/pull/315#discussion_r434205223", "bodyText": "Shorten to BUNGEEGUARD", "author": "astei", "createdAt": "2020-06-02T22:15:44Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/config/PlayerInfoForwarding.java", "diffHunk": "@@ -3,5 +3,6 @@\n public enum PlayerInfoForwarding {\n   NONE,\n   LEGACY,\n+  LEGACY_BUNGEEGUARD,", "originalCommit": "6eb9a66e0f3fded72166852b71ebf74e0afb456b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/config/PlayerInfoForwarding.java b/proxy/src/main/java/com/velocitypowered/proxy/config/PlayerInfoForwarding.java\nindex 0111eb2f..908a26a3 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/config/PlayerInfoForwarding.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/config/PlayerInfoForwarding.java\n\n@@ -3,6 +3,6 @@ package com.velocitypowered.proxy.config;\n public enum PlayerInfoForwarding {\n   NONE,\n   LEGACY,\n-  LEGACY_BUNGEEGUARD,\n+  BUNGEEGUARD,\n   MODERN\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwNjIwNA==", "url": "https://github.com/VelocityPowered/Velocity/pull/315#discussion_r434206204", "bodyText": "I'd prefer a description closer to this:\n\"bungeeguard\": Forward player IPs and UUIDs in a format supported by\n               the BungeeGuard plugin. Use this if you run servers\n               using Minecraft 1.12 and below, are on a shared\n               host, and would like to use BungeeGuard to provide\n               additional security.\n\nI'd prefer if this was made a bit more concise, though.", "author": "astei", "createdAt": "2020-06-02T22:18:25Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java", "diffHunk": "@@ -61,6 +61,8 @@\n       \"            proxy and will have offline-mode UUIDs.\",\n       \"- \\\"legacy\\\": Forward player IPs and UUIDs in a BungeeCord-compatible format. Use this if\",\n       \"            you run servers using Minecraft 1.12 or lower.\",\n+      \"- \\\"legacy_bungeeguard\\\": Forward player IPs and UUIDs in a BungeeCord-compatible format.\",", "originalCommit": "6eb9a66e0f3fded72166852b71ebf74e0afb456b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java b/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\nindex ad43f9a0..ffe8ea83 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\n\n@@ -61,8 +61,9 @@ public class VelocityConfiguration extends AnnotatedConfig implements ProxyConfi\n       \"            proxy and will have offline-mode UUIDs.\",\n       \"- \\\"legacy\\\": Forward player IPs and UUIDs in a BungeeCord-compatible format. Use this if\",\n       \"            you run servers using Minecraft 1.12 or lower.\",\n-      \"- \\\"legacy_bungeeguard\\\": Forward player IPs and UUIDs in a BungeeCord-compatible format.\",\n-      \"            Use this if you run servers using Minecraft 1.12 or lower with BungeeGuard.\",\n+      \"- \\\"bungeeguard\\\": Forward player IPs and UUIDs in a format supported by the BungeeGuard\",\n+      \"            plugin. Use this if you run servers using Minecraft 1.12 or lower, and are\",\n+      \"            unable to implement network level firewalling (on a shared host).\",\n       \"- \\\"modern\\\": Forward player IPs and UUIDs as part of the login process using Velocity's \",\n       \"            native forwarding. Only applicable for Minecraft 1.13 or higher.\"\n   })\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIwNjk0NQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/315#discussion_r434206945", "bodyText": "Instead of duplicating createLegacyForwardingAddress(), perhaps we can make this more generic by refactoring createLegacyForwardingAddress() to allow the list of profile properties to vary.", "author": "astei", "createdAt": "2020-06-02T22:20:28Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java", "diffHunk": "@@ -133,6 +137,24 @@ private String createLegacyForwardingAddress() {\n     return data.toString();\n   }\n \n+  private String createBungeeGuardForwardingAddress(byte[] forwardingSecret) {\n+    StringBuilder data = new StringBuilder()", "originalCommit": "6eb9a66e0f3fded72166852b71ebf74e0afb456b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java\nindex fbbc2fcc..5b87b95b 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/backend/VelocityServerConnection.java\n\n@@ -133,26 +122,22 @@ public class VelocityServerConnection implements MinecraftConnectionAssociation,\n         .append('\\0')\n         .append(proxyPlayer.getGameProfile().getUndashedId())\n         .append('\\0');\n-    GSON.toJson(proxyPlayer.getGameProfile().getProperties(), data);\n+    GSON.toJson(propertiesTransform.apply(proxyPlayer.getGameProfile().getProperties()), data);\n     return data.toString();\n   }\n \n-  private String createBungeeGuardForwardingAddress(byte[] forwardingSecret) {\n-    StringBuilder data = new StringBuilder()\n-            .append(registeredServer.getServerInfo().getAddress().getHostString())\n-            .append('\\0')\n-            .append(proxyPlayer.getRemoteAddress().getHostString())\n-            .append('\\0')\n-            .append(proxyPlayer.getGameProfile().getUndashedId())\n-            .append('\\0');\n+  private String createLegacyForwardingAddress() {\n+    return createLegacyForwardingAddress(UnaryOperator.identity());\n+  }\n \n+  private String createBungeeGuardForwardingAddress(byte[] forwardingSecret) {\n     // Append forwarding secret as a BungeeGuard token.\n-    List<Property> properties = new ArrayList<>(proxyPlayer.getGameProfile().getProperties());\n-    String token = new String(forwardingSecret, StandardCharsets.UTF_8);\n-    properties.add(new Property(\"bungeeguard-token\", token, \"\"));\n-\n-    GSON.toJson(properties, data);\n-    return data.toString();\n+    Property property = new Property(\"bungeeguard-token\",\n+        new String(forwardingSecret, StandardCharsets.UTF_8), \"\");\n+    return createLegacyForwardingAddress(properties -> ImmutableList.<Property>builder()\n+        .addAll(properties)\n+        .add(property)\n+        .build());\n   }\n \n   private void startHandshake() {\n"}}, {"oid": "70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "url": "https://github.com/VelocityPowered/Velocity/commit/70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "message": "Implement legacy forwarding BungeeGuard handshake support", "committedDate": "2020-06-02T22:48:42Z", "type": "commit"}, {"oid": "70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "url": "https://github.com/VelocityPowered/Velocity/commit/70abda9c5bf4cccd2cf52a58936c1a25cf5cad48", "message": "Implement legacy forwarding BungeeGuard handshake support", "committedDate": "2020-06-02T22:48:42Z", "type": "forcePushed"}, {"oid": "2cd9f081c3a7187d1d88d5e6396a526ad9fe1759", "url": "https://github.com/VelocityPowered/Velocity/commit/2cd9f081c3a7187d1d88d5e6396a526ad9fe1759", "message": "Merge branch 'dev/1.1.0' into feature/bungeeguard", "committedDate": "2020-06-02T23:32:27Z", "type": "commit"}, {"oid": "c563372ffdd69a1276ca352eb4d03798d9876df7", "url": "https://github.com/VelocityPowered/Velocity/commit/c563372ffdd69a1276ca352eb4d03798d9876df7", "message": "Remove unnecessary imports", "committedDate": "2020-06-02T23:35:04Z", "type": "commit"}]}