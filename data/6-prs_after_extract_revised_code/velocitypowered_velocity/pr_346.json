{"pr_number": 346, "pr_title": "Add PRE_SERVER_JOIN to DisconnectEvent#LoginStatus", "pr_createdAt": "2020-08-03T15:44:06Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/346", "timeline": [{"oid": "cfaf6800bc2001fd9f1f663d1ebb4f584eb850aa", "url": "https://github.com/VelocityPowered/Velocity/commit/cfaf6800bc2001fd9f1f663d1ebb4f584eb850aa", "message": "Added PRE_SERVER_JOIN status to DisconnectEvent", "committedDate": "2020-08-03T15:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5NzU4Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r464797583", "bodyText": "Maybe make connectedPlayer.get() to a variable and use that instead of explicitly calling .get", "author": "MrIvanPlays", "createdAt": "2020-08-04T04:50:40Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -695,8 +695,12 @@ void teardown() {\n \n     DisconnectEvent.LoginStatus status;\n     if (connectedPlayer.isPresent()) {\n-      status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n-          : LoginStatus.CONFLICTING_LOGIN;\n+      if (!connectedPlayer.get().getCurrentServer().isPresent()) {", "originalCommit": "cfaf6800bc2001fd9f1f663d1ebb4f584eb850aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2MDIzOA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465260238", "bodyText": "Fixed in 4adc859", "author": "STG-Allen", "createdAt": "2020-08-04T18:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5NzU4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4adc859cf11c62319f637d090bf0bc8d11f23ae8", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\nindex 3dbfdcd6..56f0a52b 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n\n@@ -690,15 +690,15 @@ public class ConnectedPlayer implements MinecraftConnectionAssociation, Player {\n       connectedServer.disconnect();\n     }\n \n-    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n-    if (connectedPlayer.isPresent()) {\n-      if (!connectedPlayer.get().getCurrentServer().isPresent()) {\n+    if (server.getPlayer(this.getUniqueId()).isPresent()) {\n+      Player connectedPlayer = server.getPlayer(this.getUniqueId()).get();\n+      if (!connectedPlayer.getCurrentServer().isPresent()) {\n         status = LoginStatus.PRE_SERVER_JOIN;\n       } else {\n-        status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n+        status = connectedPlayer == this ? LoginStatus.SUCCESSFUL_LOGIN\n             : LoginStatus.CONFLICTING_LOGIN;\n       }\n     } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5NzYxOA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r464797618", "bodyText": "See L698", "author": "MrIvanPlays", "createdAt": "2020-08-04T04:50:50Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -695,8 +695,12 @@ void teardown() {\n \n     DisconnectEvent.LoginStatus status;\n     if (connectedPlayer.isPresent()) {\n-      status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n-          : LoginStatus.CONFLICTING_LOGIN;\n+      if (!connectedPlayer.get().getCurrentServer().isPresent()) {\n+        status = LoginStatus.PRE_SERVER_JOIN;\n+      } else {\n+        status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN", "originalCommit": "cfaf6800bc2001fd9f1f663d1ebb4f584eb850aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2MDI5MA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465260290", "bodyText": "Fixed in 4adc859", "author": "STG-Allen", "createdAt": "2020-08-04T18:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc5NzYxOA=="}], "type": "inlineReview", "revised_code": {"commit": "4adc859cf11c62319f637d090bf0bc8d11f23ae8", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\nindex 3dbfdcd6..56f0a52b 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n\n@@ -690,15 +690,15 @@ public class ConnectedPlayer implements MinecraftConnectionAssociation, Player {\n       connectedServer.disconnect();\n     }\n \n-    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n-    if (connectedPlayer.isPresent()) {\n-      if (!connectedPlayer.get().getCurrentServer().isPresent()) {\n+    if (server.getPlayer(this.getUniqueId()).isPresent()) {\n+      Player connectedPlayer = server.getPlayer(this.getUniqueId()).get();\n+      if (!connectedPlayer.getCurrentServer().isPresent()) {\n         status = LoginStatus.PRE_SERVER_JOIN;\n       } else {\n-        status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n+        status = connectedPlayer == this ? LoginStatus.SUCCESSFUL_LOGIN\n             : LoginStatus.CONFLICTING_LOGIN;\n       }\n     } else {\n"}}, {"oid": "4adc859cf11c62319f637d090bf0bc8d11f23ae8", "url": "https://github.com/VelocityPowered/Velocity/commit/4adc859cf11c62319f637d090bf0bc8d11f23ae8", "message": "Move away from multiple connectedPlayer.get() in favor of cleaner code.", "committedDate": "2020-08-04T18:52:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMDgyNA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465300824", "bodyText": "Arguably this is worse than before (even if player lookups are constant). I disagree with @MrIvanPlays, previous code was fine.", "author": "hugmanrique", "createdAt": "2020-08-04T20:07:58Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -690,13 +690,17 @@ void teardown() {\n       connectedServer.disconnect();\n     }\n \n-    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n-    if (connectedPlayer.isPresent()) {\n-      status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n-          : LoginStatus.CONFLICTING_LOGIN;\n+    if (server.getPlayer(this.getUniqueId()).isPresent()) {\n+      Player connectedPlayer = server.getPlayer(this.getUniqueId()).get();", "originalCommit": "4adc859cf11c62319f637d090bf0bc8d11f23ae8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTA4OQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465301089", "bodyText": "I'll just revert it then", "author": "STG-Allen", "createdAt": "2020-08-04T20:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMDgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTUxMQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465301511", "bodyText": "This revised code actually introduces a bug.", "author": "astei", "createdAt": "2020-08-04T20:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMDgyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMTc0Nw==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465301747", "bodyText": "Yeah, figured such would occur. Will do as i stated previously", "author": "STG-Allen", "createdAt": "2020-08-04T20:09:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwMDgyNA=="}], "type": "inlineReview", "revised_code": {"commit": "05af7fa375e6688b6cac58272456381d62734efd", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\nindex 56f0a52b..3dbfdcd6 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n\n@@ -690,15 +690,15 @@ public class ConnectedPlayer implements MinecraftConnectionAssociation, Player {\n       connectedServer.disconnect();\n     }\n \n+    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n-    if (server.getPlayer(this.getUniqueId()).isPresent()) {\n-      Player connectedPlayer = server.getPlayer(this.getUniqueId()).get();\n-      if (!connectedPlayer.getCurrentServer().isPresent()) {\n+    if (connectedPlayer.isPresent()) {\n+      if (!connectedPlayer.get().getCurrentServer().isPresent()) {\n         status = LoginStatus.PRE_SERVER_JOIN;\n       } else {\n-        status = connectedPlayer == this ? LoginStatus.SUCCESSFUL_LOGIN\n+        status = connectedPlayer.get() == this ? LoginStatus.SUCCESSFUL_LOGIN\n             : LoginStatus.CONFLICTING_LOGIN;\n       }\n     } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwOTQyNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465309426", "bodyText": "This is still incorrect. Now the successful login case is never fired. Your first revision was correct.\nTo fix this just put this line back where it was - before the unregisterConnection call.", "author": "astei", "createdAt": "2020-08-04T20:24:56Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java", "diffHunk": "@@ -690,13 +690,17 @@ void teardown() {\n       connectedServer.disconnect();\n     }\n \n-    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n+    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     if (connectedPlayer.isPresent()) {", "originalCommit": "508391dfdac54ede49d68bc34684c09ad3dbbad8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwOTgyMA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465309820", "bodyText": "I commented on the wrong line, the offending line is above this one. I was reviewing this from my phone. Whoops!", "author": "astei", "createdAt": "2020-08-04T20:25:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwOTQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMxMDc0OA==", "url": "https://github.com/VelocityPowered/Velocity/pull/346#discussion_r465310748", "bodyText": "Should be fixed now.", "author": "STG-Allen", "createdAt": "2020-08-04T20:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwOTQyNg=="}], "type": "inlineReview", "revised_code": {"commit": "05af7fa375e6688b6cac58272456381d62734efd", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\nindex a7d4ebe4..3dbfdcd6 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/ConnectedPlayer.java\n\n@@ -690,10 +690,10 @@ public class ConnectedPlayer implements MinecraftConnectionAssociation, Player {\n       connectedServer.disconnect();\n     }\n \n+    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     server.unregisterConnection(this);\n \n     DisconnectEvent.LoginStatus status;\n-    Optional<Player> connectedPlayer = server.getPlayer(this.getUniqueId());\n     if (connectedPlayer.isPresent()) {\n       if (!connectedPlayer.get().getCurrentServer().isPresent()) {\n         status = LoginStatus.PRE_SERVER_JOIN;\n"}}, {"oid": "05af7fa375e6688b6cac58272456381d62734efd", "url": "https://github.com/VelocityPowered/Velocity/commit/05af7fa375e6688b6cac58272456381d62734efd", "message": "Undo code revision", "committedDate": "2020-08-04T20:26:02Z", "type": "commit"}]}