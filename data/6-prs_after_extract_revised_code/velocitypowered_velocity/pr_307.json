{"pr_number": 307, "pr_title": "Add prevent-proxy-connections option", "pr_createdAt": "2020-05-08T00:06:36Z", "pr_url": "https://github.com/VelocityPowered/Velocity/pull/307", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5NTA2Nw==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422195067", "bodyText": "Mind adding the same description here?", "author": "hugmanrique", "createdAt": "2020-05-08T15:02:27Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java", "diffHunk": "@@ -62,6 +62,13 @@\n    */\n   boolean isOnlineMode();\n \n+  /**\n+   * TODO", "originalCommit": "01fc1776864df8327efa988da6330bb5ec080b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIxMzU2NA==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422213564", "bodyText": "Oops", "author": "mikroskeem", "createdAt": "2020-05-08T15:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5NTA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\nindex 832ebaa5..6e5de237 100644\n--- a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n+++ b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n\n@@ -63,9 +63,11 @@ public interface ProxyConfig {\n   boolean isOnlineMode();\n \n   /**\n-   * TODO\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\n+   * authentication server, the player is kicked. This disallows some VPN and proxy\n+   * connections but is a weak form of protection.\n    *\n-   * @return prevent proxy connections\n+   * @return whether to prevent client proxy connections by checking the IP with Mojang servers\n    */\n   boolean shouldPreventClientProxyConnections();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5ODMyOQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422198329", "bodyText": "Previous code always passed the IP param, should this be true instead?", "author": "hugmanrique", "createdAt": "2020-05-08T15:08:15Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java", "diffHunk": "@@ -54,6 +54,14 @@\n   @ConfigKey(\"online-mode\")\n   private boolean onlineMode = true;\n \n+  @Comment({\n+      \"If client's ISP/AS sent from this proxy is different from the one from Mojang's\",\n+      \"authentication server, the player is kicked. Effectively disallows players from\",\n+      \"using proxies or VPNs when enabled.\"\n+  })\n+  @ConfigKey(\"prevent-client-proxy-connections\")\n+  private boolean preventClientProxyConnections = false;", "originalCommit": "01fc1776864df8327efa988da6330bb5ec080b25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIxMzUxOQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422213519", "bodyText": "Vanilla has this off by default, so I went with false.", "author": "mikroskeem", "createdAt": "2020-05-08T15:36:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5ODMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1ODA2NQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422258065", "bodyText": "I'm inclined to say we should leave this off, as prevent-proxy-connections is a rather weak form of protection that can be easily bypassed.", "author": "astei", "createdAt": "2020-05-08T17:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5ODMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java b/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\nindex 24a3a6c8..3b83c438 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/config/VelocityConfiguration.java\n\n@@ -56,8 +56,8 @@ public class VelocityConfiguration extends AnnotatedConfig implements ProxyConfi\n \n   @Comment({\n       \"If client's ISP/AS sent from this proxy is different from the one from Mojang's\",\n-      \"authentication server, the player is kicked. Effectively disallows players from\",\n-      \"using proxies or VPNs when enabled.\"\n+      \"authentication server, the player is kicked. This disallows some VPN and proxy\",\n+      \"connections but is a weak form of protection.\"\n   })\n   @ConfigKey(\"prevent-client-proxy-connections\")\n   private boolean preventClientProxyConnections = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4OTA2NQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422289065", "bodyText": "Errant \"", "author": "astei", "createdAt": "2020-05-08T18:05:32Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java", "diffHunk": "@@ -62,6 +62,15 @@\n    */\n   boolean isOnlineMode();\n \n+  /**\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"", "originalCommit": "b5faa561ead6e9d1ef28482fca667425fda5d62d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5MDAwNg==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422290006", "bodyText": "Yeah copied from the configuration class, oops.", "author": "mikroskeem", "createdAt": "2020-05-08T18:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4OTA2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\nindex eaf94f43..6e5de237 100644\n--- a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n+++ b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n\n@@ -63,11 +63,11 @@ public interface ProxyConfig {\n   boolean isOnlineMode();\n \n   /**\n-   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"\n-   * authentication server, the player is kicked. Effectively disallows players from\n-   * using proxies or VPNs when enabled.\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\n+   * authentication server, the player is kicked. This disallows some VPN and proxy\n+   * connections but is a weak form of protection.\n    *\n-   * @return prevent client proxy connections\n+   * @return whether to prevent client proxy connections by checking the IP with Mojang servers\n    */\n   boolean shouldPreventClientProxyConnections();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4OTE5Mg==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422289192", "bodyText": "Make this a little bit more explanatory", "author": "astei", "createdAt": "2020-05-08T18:05:46Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java", "diffHunk": "@@ -62,6 +62,15 @@\n    */\n   boolean isOnlineMode();\n \n+  /**\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"\n+   * authentication server, the player is kicked. Effectively disallows players from\n+   * using proxies or VPNs when enabled.\n+   *\n+   * @return prevent client proxy connections", "originalCommit": "b5faa561ead6e9d1ef28482fca667425fda5d62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\nindex eaf94f43..6e5de237 100644\n--- a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n+++ b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n\n@@ -63,11 +63,11 @@ public interface ProxyConfig {\n   boolean isOnlineMode();\n \n   /**\n-   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"\n-   * authentication server, the player is kicked. Effectively disallows players from\n-   * using proxies or VPNs when enabled.\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\n+   * authentication server, the player is kicked. This disallows some VPN and proxy\n+   * connections but is a weak form of protection.\n    *\n-   * @return prevent client proxy connections\n+   * @return whether to prevent client proxy connections by checking the IP with Mojang servers\n    */\n   boolean shouldPreventClientProxyConnections();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI4OTQ4Mw==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422289483", "bodyText": "Not sure if we need to escape the &ip= here. We probably should escape the IP but that's it.", "author": "astei", "createdAt": "2020-05-08T18:06:25Z", "path": "proxy/src/main/java/com/velocitypowered/proxy/connection/client/LoginSessionHandler.java", "diffHunk": "@@ -96,8 +96,11 @@ public boolean handle(EncryptionResponse packet) {\n \n       String playerIp = ((InetSocketAddress) mcConnection.getRemoteAddress()).getHostString();\n       String url = String.format(MOJANG_HASJOINED_URL,\n-          urlFormParameterEscaper().escape(login.getUsername()), serverId,\n-          urlFormParameterEscaper().escape(playerIp));\n+          urlFormParameterEscaper().escape(login.getUsername()), serverId);\n+\n+      if (server.getConfiguration().shouldPreventClientProxyConnections()) {\n+        url += urlFormParameterEscaper().escape(\"&ip=\" + playerIp);", "originalCommit": "b5faa561ead6e9d1ef28482fca667425fda5d62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/LoginSessionHandler.java b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/LoginSessionHandler.java\nindex 7cb63c26..e367174c 100644\n--- a/proxy/src/main/java/com/velocitypowered/proxy/connection/client/LoginSessionHandler.java\n+++ b/proxy/src/main/java/com/velocitypowered/proxy/connection/client/LoginSessionHandler.java\n\n@@ -99,7 +99,7 @@ public class LoginSessionHandler implements MinecraftSessionHandler {\n           urlFormParameterEscaper().escape(login.getUsername()), serverId);\n \n       if (server.getConfiguration().shouldPreventClientProxyConnections()) {\n-        url += urlFormParameterEscaper().escape(\"&ip=\" + playerIp);\n+        url += \"&ip=\" + urlFormParameterEscaper().escape(playerIp);\n       }\n \n       ListenableFuture<Response> hasJoinedResponse = server.getAsyncHttpClient().prepareGet(url)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI5MDA3MQ==", "url": "https://github.com/VelocityPowered/Velocity/pull/307#discussion_r422290071", "bodyText": "\"Effectively\" is too strong. I'd do \"This disallows some VPN and proxy connections but is a weak form of protection.\"", "author": "astei", "createdAt": "2020-05-08T18:07:42Z", "path": "api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java", "diffHunk": "@@ -62,6 +62,15 @@\n    */\n   boolean isOnlineMode();\n \n+  /**\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"\n+   * authentication server, the player is kicked. Effectively disallows players from", "originalCommit": "b5faa561ead6e9d1ef28482fca667425fda5d62d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "chunk": "diff --git a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\nindex eaf94f43..6e5de237 100644\n--- a/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n+++ b/api/src/main/java/com/velocitypowered/api/proxy/config/ProxyConfig.java\n\n@@ -63,11 +63,11 @@ public interface ProxyConfig {\n   boolean isOnlineMode();\n \n   /**\n-   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\"\n-   * authentication server, the player is kicked. Effectively disallows players from\n-   * using proxies or VPNs when enabled.\n+   * If client's ISP/AS sent from this proxy is different from the one from Mojang's\n+   * authentication server, the player is kicked. This disallows some VPN and proxy\n+   * connections but is a weak form of protection.\n    *\n-   * @return prevent client proxy connections\n+   * @return whether to prevent client proxy connections by checking the IP with Mojang servers\n    */\n   boolean shouldPreventClientProxyConnections();\n \n"}}, {"oid": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "url": "https://github.com/VelocityPowered/Velocity/commit/21f03d5d504ad0e1e222acbeb311875e7857d70b", "message": "Add prevent-proxy-connections option to make sending client IP to Mojang toggleable", "committedDate": "2020-05-08T18:16:12Z", "type": "commit"}, {"oid": "21f03d5d504ad0e1e222acbeb311875e7857d70b", "url": "https://github.com/VelocityPowered/Velocity/commit/21f03d5d504ad0e1e222acbeb311875e7857d70b", "message": "Add prevent-proxy-connections option to make sending client IP to Mojang toggleable", "committedDate": "2020-05-08T18:16:12Z", "type": "forcePushed"}]}