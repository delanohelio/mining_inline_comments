{"pr_number": 1480, "pr_title": "fix task poll NPE", "pr_createdAt": "2020-01-07T18:26:08Z", "pr_url": "https://github.com/Netflix/conductor/pull/1480", "timeline": [{"oid": "b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4", "url": "https://github.com/Netflix/conductor/commit/b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4", "message": "fix task poll NPE", "committedDate": "2020-01-07T18:25:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkwNzQyNw==", "url": "https://github.com/Netflix/conductor/pull/1480#discussion_r363907427", "bodyText": "Is it intentional to have two thenReturn statements?", "author": "kishorebanala", "createdAt": "2020-01-07T19:18:09Z", "path": "client/src/test/java/com/netflix/conductor/client/automator/TaskPollExecutorTest.java", "diffHunk": "@@ -166,14 +164,45 @@ public void testTaskPollException() {\n         Worker worker = mock(Worker.class);\n         when(worker.getPollingInterval()).thenReturn(3000);\n         when(worker.getTaskDefName()).thenReturn(\"test\");\n-        when(worker.preAck(any())).thenReturn(true);\n         when(worker.execute(any())).thenReturn(new TaskResult(task));\n \n         TaskClient taskClient = Mockito.mock(TaskClient.class);\n         when(taskClient.pollTask(any(), any(), any()))\n             .thenThrow(ConductorClientException.class)\n             .thenReturn(task);\n-        when(taskClient.ack(any(), any())).thenReturn(true);\n+\n+        TaskPollExecutor taskPollExecutor = new TaskPollExecutor(null, taskClient, 1, 1, \"test-worker-\");\n+        CountDownLatch latch = new CountDownLatch(1);\n+        doAnswer(invocation -> {\n+                Object[] args = invocation.getArguments();\n+                TaskResult result = (TaskResult) args[0];\n+                assertEquals(IN_PROGRESS, result.getStatus());\n+                assertEquals(task.getTaskId(), result.getTaskId());\n+                latch.countDown();\n+                return null;\n+            }\n+        ).when(taskClient).updateTask(any());\n+\n+        Executors.newSingleThreadScheduledExecutor()\n+            .scheduleAtFixedRate(() -> taskPollExecutor.pollAndExecute(worker), 0, 1, TimeUnit.SECONDS);\n+\n+        Uninterruptibles.awaitUninterruptibly(latch);\n+        verify(taskClient).updateTask(any());\n+    }\n+\n+    @Test\n+    public void testTaskPoll() {\n+        Task task = testTask();\n+\n+        Worker worker = mock(Worker.class);\n+        when(worker.getPollingInterval()).thenReturn(3000);\n+        when(worker.getTaskDefName()).thenReturn(\"test\");\n+        when(worker.execute(any())).thenReturn(new TaskResult(task));\n+\n+        TaskClient taskClient = Mockito.mock(TaskClient.class);\n+        when(taskClient.pollTask(any(), any(), any()))\n+            .thenReturn(new Task())\n+            .thenReturn(task);", "originalCommit": "b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkxMTMzNQ==", "url": "https://github.com/Netflix/conductor/pull/1480#discussion_r363911335", "bodyText": "yes, these will be the values returned by this method on 2 consecutive invocations.", "author": "apanicker-nflx", "createdAt": "2020-01-07T19:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkwNzQyNw=="}], "type": "inlineReview", "revised_code": null}]}