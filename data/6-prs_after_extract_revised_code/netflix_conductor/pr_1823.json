{"pr_number": 1823, "pr_title": "1816: getNextTask will get wrong task if DO_WHILE task is embed in FORK or DECISION", "pr_createdAt": "2020-08-06T16:33:42Z", "pr_url": "https://github.com/Netflix/conductor/pull/1823", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcxOTM2MQ==", "url": "https://github.com/Netflix/conductor/pull/1823#discussion_r470719361", "bodyText": "@alex-fu Since we are diverging the DECISION block by so many lines of code. We can define a separate switch case for DO_WHILE task. And move common code to one function.", "author": "manan164", "createdAt": "2020-08-14T16:10:41Z", "path": "common/src/main/java/com/netflix/conductor/common/metadata/workflow/WorkflowTask.java", "diffHunk": "@@ -569,6 +569,13 @@ public WorkflowTask next(String taskReferenceName, WorkflowTask parent) {\n \t\t\t\t\t\t\treturn nextTask;\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (task.has(taskReferenceName)) {\n+\t\t\t\t\t\t\tif (TaskType.DO_WHILE.name().equals(task.getType())) {", "originalCommit": "d4a33fcc451eed883d04ae9ea38fae6634083665", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzMTc2NQ==", "url": "https://github.com/Netflix/conductor/pull/1823#discussion_r495431765", "bodyText": "OK, I'll move this common code to a function. But this function should be called from DECISION block and FORK block, not DO_WHILE block(since we don't allow nested DO_WHILE task).", "author": "alex-fu", "createdAt": "2020-09-26T08:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcxOTM2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "ce62d75e84d8f1fdb7d603d7c98ef0c952789168", "chunk": "diff --git a/common/src/main/java/com/netflix/conductor/common/metadata/workflow/WorkflowTask.java b/common/src/main/java/com/netflix/conductor/common/metadata/workflow/WorkflowTask.java\nindex 351a883f..353a4f2e 100644\n--- a/common/src/main/java/com/netflix/conductor/common/metadata/workflow/WorkflowTask.java\n+++ b/common/src/main/java/com/netflix/conductor/common/metadata/workflow/WorkflowTask.java\n\n@@ -569,13 +586,6 @@ public class WorkflowTask {\n \t\t\t\t\t\t\treturn nextTask;\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (task.has(taskReferenceName)) {\n-\t\t\t\t\t\t\tif (TaskType.DO_WHILE.name().equals(task.getType())) {\n-\t\t\t\t\t\t\t\t// come here means task is DO_WHILE task and `taskReferenceName` is the last task in\n-\t\t\t\t\t\t\t\t// this DO_WHILE task, because DO_WHILE task need to be executed to decide whether to\n-\t\t\t\t\t\t\t\t// schedule next iteration, so we just return the DO_WHILE task, and then ignore\n-\t\t\t\t\t\t\t\t// generating this task again in deciderService.getNextTask()\n-\t\t\t\t\t\t\t\treturn task;\n-\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\tbreak;\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyMDc0OA==", "url": "https://github.com/Netflix/conductor/pull/1823#discussion_r470720748", "bodyText": "Why we are returning an empty list. We are making get next task to return the parent DO_WHILE task let it propagates it further to decider service.", "author": "manan164", "createdAt": "2020-08-14T16:13:29Z", "path": "core/src/main/java/com/netflix/conductor/core/execution/DeciderService.java", "diffHunk": "@@ -362,6 +363,13 @@ private boolean checkForWorkflowCompletion(final Workflow workflow) throws Termi\n         while (isTaskSkipped(taskToSchedule, workflow)) {\n             taskToSchedule = workflowDef.getNextTask(taskToSchedule.getTaskReferenceName());\n         }\n+        if (taskToSchedule != null && TaskType.DO_WHILE.name().equals(taskToSchedule.getType())) {\n+            // check if already has this DO_WHILE task, ignore it if it already exists\n+            String nextTaskReferenceName = taskToSchedule.getTaskReferenceName();\n+            if (workflow.getTasks().stream().anyMatch(runningTask -> runningTask.getReferenceTaskName().equals(nextTaskReferenceName))) {\n+                return Collections.emptyList();", "originalCommit": "d4a33fcc451eed883d04ae9ea38fae6634083665", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzMjMyMw==", "url": "https://github.com/Netflix/conductor/pull/1823#discussion_r495432323", "bodyText": "Because in this case the parent DO_WHILE task is already exist, so we don't need to generate again. By the way, even though we return the parent DO_WHILE task, deciderService will also exclude it in below line. tasksToBeScheduled already contains this task, and putIfAbsent will not add this task again.\nnextTasks.forEach(nextTask -> tasksToBeScheduled.putIfAbsent(nextTask.getReferenceTaskName(), nextTask));", "author": "alex-fu", "createdAt": "2020-09-26T08:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyMDc0OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "73bdde4bec2f3120b22d8b321a1531acced7ac1f", "url": "https://github.com/Netflix/conductor/commit/73bdde4bec2f3120b22d8b321a1531acced7ac1f", "message": "1816: getNextTask will get wrong task if DO_WHILE task is embed in FORK or DECISION", "committedDate": "2020-09-26T08:40:04Z", "type": "forcePushed"}, {"oid": "e80fea4c8b9d22f4b8c9eb32cbe52e798f3dff6c", "url": "https://github.com/Netflix/conductor/commit/e80fea4c8b9d22f4b8c9eb32cbe52e798f3dff6c", "message": "1816: getNextTask will get wrong task if DO_WHILE task is embed in FORK or DECISION", "committedDate": "2020-10-07T16:22:03Z", "type": "commit"}, {"oid": "e80fea4c8b9d22f4b8c9eb32cbe52e798f3dff6c", "url": "https://github.com/Netflix/conductor/commit/e80fea4c8b9d22f4b8c9eb32cbe52e798f3dff6c", "message": "1816: getNextTask will get wrong task if DO_WHILE task is embed in FORK or DECISION", "committedDate": "2020-10-07T16:22:03Z", "type": "forcePushed"}, {"oid": "ce62d75e84d8f1fdb7d603d7c98ef0c952789168", "url": "https://github.com/Netflix/conductor/commit/ce62d75e84d8f1fdb7d603d7c98ef0c952789168", "message": "1816: refactor WorkflowTask.next(); add integration test", "committedDate": "2020-10-08T12:38:14Z", "type": "commit"}, {"oid": "3140193571c51d94de4adacfc4d3ab47ba1fa2a0", "url": "https://github.com/Netflix/conductor/commit/3140193571c51d94de4adacfc4d3ab47ba1fa2a0", "message": "1816: refine getNextTask in WorkflowDef", "committedDate": "2020-10-08T13:49:10Z", "type": "commit"}]}