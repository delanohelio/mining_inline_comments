{"pr_number": 2094, "pr_title": "Support CodeSystem/$validate-code for R4, R5", "pr_createdAt": "2020-09-19T19:22:41Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2094", "timeline": [{"oid": "64f2bae2e7ed279df7bcfe7eb6ac2909a27e613c", "url": "https://github.com/hapifhir/hapi-fhir/commit/64f2bae2e7ed279df7bcfe7eb6ac2909a27e613c", "message": "Impl CodeSystem $validate-code for R4 with basic test cases", "committedDate": "2020-09-19T02:30:59Z", "type": "commit"}, {"oid": "05de0c503124bd20bfe7081838d533ef68fb8dc5", "url": "https://github.com/hapifhir/hapi-fhir/commit/05de0c503124bd20bfe7081838d533ef68fb8dc5", "message": "Added more test cases for R4", "committedDate": "2020-09-19T16:36:14Z", "type": "commit"}, {"oid": "7db9f7475b4c9b6618edf3a6ae80316860bf3cf5", "url": "https://github.com/hapifhir/hapi-fhir/commit/7db9f7475b4c9b6618edf3a6ae80316860bf3cf5", "message": "Changed fetch size to 1 for CodeSystem $validate-code", "committedDate": "2020-09-19T16:52:18Z", "type": "commit"}, {"oid": "01d88a665d4db8ff3d8a4abe9b65edeb5f373aae", "url": "https://github.com/hapifhir/hapi-fhir/commit/01d88a665d4db8ff3d8a4abe9b65edeb5f373aae", "message": "Added CodeSystem/$validate-code for R5", "committedDate": "2020-09-19T18:13:07Z", "type": "commit"}, {"oid": "a3a032584bc8c083591f48a4176e94e56aa61860", "url": "https://github.com/hapifhir/hapi-fhir/commit/a3a032584bc8c083591f48a4176e94e56aa61860", "message": "Made Transactional", "committedDate": "2020-09-19T19:18:28Z", "type": "commit"}, {"oid": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "url": "https://github.com/hapifhir/hapi-fhir/commit/8f692a4776001ffce2b2ac2779bf106fd4f90775", "message": "CodeSystem/$validate-code not supported for DSTU2, DSTU3", "committedDate": "2020-09-20T02:54:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMDAxNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492700014", "bodyText": "Minor suggestion: Create a unit test to validate that an exception is thrown for this method just to ensure that this does not bring down our test coverage statistics.", "author": "IanMMarshall", "createdAt": "2020-09-22T12:40:33Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/FhirResourceDaoValueSetDstu2.java", "diffHunk": "@@ -312,4 +314,10 @@ public static String toStringOrNull(IPrimitiveType<String> thePrimitive) {\n \t\treturn myTerminologySvc.validateCode(vsValidateCodeOptions(), theId, toStringOrNull(theValueSetIdentifier), toStringOrNull(theSystem), toStringOrNull(theCode), toStringOrNull(theDisplay), theCoding, theCodeableConcept);\n \t}\n \n+\t@Override\n+\tpublic CodeValidationResult validateCode(IIdType theCodeSystemId, IPrimitiveType<String> theCodeSystemUrl, IPrimitiveType<String> theVersion, IPrimitiveType<String> theCode, \n+\t\t\tIPrimitiveType<String> theDisplay, CodingDt theCoding, CodeableConceptDt theCodeableConcept, RequestDetails theRequestDetails) {\n+\t\tthrow new UnsupportedOperationException();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTA0Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493101043", "bodyText": "For dust2, CodeSystem Resource does not exists. Can't create test case.", "author": "frankjtao", "createdAt": "2020-09-23T00:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMDAxNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMDE1MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492700150", "bodyText": "Minor suggestion: Create a unit test to validate that an exception is thrown for this method just to ensure that this does not bring down our test coverage statistics.", "author": "IanMMarshall", "createdAt": "2020-09-22T12:40:45Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java", "diffHunk": "@@ -169,4 +172,10 @@ public ResourceTable updateEntity(RequestDetails theRequest, IBaseResource theRe\n \t\treturn retVal;\n \t}\n \n+\t@Override\n+\tpublic CodeValidationResult validateCode(IIdType theCodeSystemId, IPrimitiveType<String> theCodeSystemUrl, IPrimitiveType<String> theVersion, IPrimitiveType<String> theCode, \n+\t\t\tIPrimitiveType<String> theDisplay, Coding theCoding, CodeableConcept theCodeableConcept, RequestDetails theRequestDetails) {\t\n+\t\tthrow new UnsupportedOperationException();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMzYyNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493103624", "bodyText": "New test case added", "author": "frankjtao", "createdAt": "2020-09-23T00:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMDE1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjM0Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492702343", "bodyText": "Maybe consider moving this method to a common dao package-level utility so as to avoid dependency on a version-specific dao class.", "author": "IanMMarshall", "createdAt": "2020-09-22T12:44:14Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java", "diffHunk": "@@ -51,6 +52,8 @@\n import java.util.List;\n import java.util.Set;\n \n+import static ca.uhn.fhir.jpa.dao.FhirResourceDaoValueSetDstu2.toStringOrNull;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNDAxNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493104014", "bodyText": "The import is unused, removed", "author": "frankjtao", "createdAt": "2020-09-23T00:19:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjM0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "20661c7a2b906e67b17585fa9a2d5b72086520bf", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\nindex 29200610da..eccfdac0ff 100644\n--- a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\n+++ b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\n\n@@ -52,8 +52,6 @@ import java.util.Date;\n import java.util.List;\n import java.util.Set;\n \n-import static ca.uhn.fhir.jpa.dao.FhirResourceDaoValueSetDstu2.toStringOrNull;\n-import static ca.uhn.fhir.jpa.dao.dstu3.FhirResourceDaoValueSetDstu3.vsValidateCodeOptions;\n import static org.apache.commons.lang3.StringUtils.isNotBlank;\n import static org.hl7.fhir.convertors.conv30_40.CodeSystem30_40.convertCodeSystem;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwNTY0Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492705643", "bodyText": "Maybe consider moving this method to a common dao package-level utility so as to avoid dependency on ValueSet class.", "author": "IanMMarshall", "createdAt": "2020-09-22T12:49:17Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java", "diffHunk": "@@ -51,6 +52,8 @@\n import java.util.List;\n import java.util.Set;\n \n+import static ca.uhn.fhir.jpa.dao.FhirResourceDaoValueSetDstu2.toStringOrNull;\n+import static ca.uhn.fhir.jpa.dao.dstu3.FhirResourceDaoValueSetDstu3.vsValidateCodeOptions;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNDMwNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493104304", "bodyText": "The import is not needed, it's removed from the class", "author": "frankjtao", "createdAt": "2020-09-23T00:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwNTY0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "20661c7a2b906e67b17585fa9a2d5b72086520bf", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\nindex 29200610da..eccfdac0ff 100644\n--- a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\n+++ b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/dstu3/FhirResourceDaoCodeSystemDstu3.java\n\n@@ -52,8 +52,6 @@ import java.util.Date;\n import java.util.List;\n import java.util.Set;\n \n-import static ca.uhn.fhir.jpa.dao.FhirResourceDaoValueSetDstu2.toStringOrNull;\n-import static ca.uhn.fhir.jpa.dao.dstu3.FhirResourceDaoValueSetDstu3.vsValidateCodeOptions;\n import static org.apache.commons.lang3.StringUtils.isNotBlank;\n import static org.hl7.fhir.convertors.conv30_40.CodeSystem30_40.convertCodeSystem;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwNjQzNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492706437", "bodyText": "See my comments above about moving these two methods to a common dao utility. I think we should avoid dependencies between FHIR versions and between ValueSet and CodeSystem classes.", "author": "IanMMarshall", "createdAt": "2020-09-22T12:50:30Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoCodeSystemR4.java", "diffHunk": "@@ -50,6 +51,8 @@\n import java.util.List;\n import java.util.Set;\n \n+import static ca.uhn.fhir.jpa.dao.FhirResourceDaoValueSetDstu2.toStringOrNull;\n+import static ca.uhn.fhir.jpa.dao.dstu3.FhirResourceDaoValueSetDstu3.vsValidateCodeOptions;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNjAyNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492716025", "bodyText": "This method maybe could also be moved into a dao package level utility .", "author": "IanMMarshall", "createdAt": "2020-09-22T13:04:42Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r4/BaseJpaResourceProviderCodeSystemR4.java", "diffHunk": "@@ -23,20 +37,11 @@\n import ca.uhn.fhir.context.support.IValidationSupport;\n import ca.uhn.fhir.jpa.api.dao.IFhirResourceDaoCodeSystem;\n import ca.uhn.fhir.jpa.model.util.JpaConstants;\n+import ca.uhn.fhir.jpa.provider.BaseJpaResourceProviderValueSetDstu2;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNjAyMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493106022", "bodyText": "This is provider level class, it's already in the ca.uhn.fhir.jpa.provider package.  Please check the package ca.uhn.fhir.jpa.provider . All classes under this package has Dstu2 at the end. I just followed the class name pattern. I don't think we need rename all the classes under this package", "author": "frankjtao", "createdAt": "2020-09-23T00:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcxNjAyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMTE4Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492731183", "bodyText": "Should this not create a failure CodeValidationResult instead of throwing an exception? This could be considered a validation failure as opposed to an error in usage of the $validate-code operation like the previous exceptions.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:25:59Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2555,5 +2561,120 @@ static boolean isOurLastResultsFromTranslationWithReverseCache() {\n \t\treturn ourLastResultsFromTranslationWithReverseCache;\n \t}\n \n+\t@Override\n+\t@Transactional\n+\tpublic CodeValidationResult codeSystemValidateCode(IIdType theCodeSystemId, String theCodeSystemUrl, String theVersion, String theCode, String theDisplay, IBaseDatatype theCoding, IBaseDatatype theCodeableConcept) {\n+\n+\t\tCodeableConcept codeableConcept = toCanonicalCodeableConcept(theCodeableConcept);\n+\t\tboolean haveCodeableConcept = codeableConcept != null && codeableConcept.getCoding().size() > 0;\n+\n+\t\tCoding coding = toCanonicalCoding(theCoding);\n+\t\tboolean haveCoding = coding != null && coding.isEmpty() == false;\n+\n+\t\tboolean haveCode = theCode != null && theCode.isEmpty() == false;\n+\n+\t\tif (!haveCodeableConcept && !haveCoding && !haveCode) {\n+\t\t\tthrow new InvalidRequestException(\"No code, coding, or codeableConcept provided to validate.\");\n+\t\t}\n+\t\tif (!LogicUtil.multiXor(haveCodeableConcept, haveCoding, haveCode)) {\n+\t\t\tthrow new InvalidRequestException(\"$validate-code can only validate (code) OR (coding) OR (codeableConcept)\");\n+\t\t}\n+\n+\t\tboolean haveIdentifierParam = isNotBlank(theCodeSystemUrl);\n+\t\tString codeSystemUrl;\n+\t\tif (theCodeSystemId != null) {\n+\t\t\tIBaseResource codeSystem = myDaoRegistry.getResourceDao(\"CodeSystem\").read(theCodeSystemId);\n+\t\t\tcodeSystemUrl = CommonCodeSystemsTerminologyService.getCodeSystemUrl(codeSystem);\n+\t\t} else if (haveIdentifierParam) {\n+\t\t\tcodeSystemUrl = theCodeSystemUrl;\n+\t\t} else {\n+\t\t\tthrow new InvalidRequestException(\"Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\");\n+\t\t}\n+\n+\t\t\n+\t\tString code = theCode;\n+\t\tString version = theVersion;\n+\t\tString display = theDisplay;\n+\t\t\n+\t\tif (haveCodeableConcept) {\n+\t\t\tfor (int i = 0; i < codeableConcept.getCoding().size(); i++) {\n+\t\t\t\tCoding nextCoding = codeableConcept.getCoding().get(i);\n+\t\t\t\tif (nextCoding.hasSystem()) {\n+\t\t\t\t\tif (!codeSystemUrl.equalsIgnoreCase(nextCoding.getSystem())) {\n+\t\t\t\t\t\tthrow new InvalidRequestException(\"Coding.system '\" + nextCoding.getSystem() + \"' does not equal with CodeSystem.url '\" + theCodeSystemUrl + \"'. Unable to validate.\");", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNzIwNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493107204", "bodyText": "InvalidRequestException and createFailureCodeValidationResult are different. InvalidRequestException is at the request level, and createFailureCodeValidationResult  is at the result level according to the FHIR spec. I followed the code pattern of ValueSet/$validate-code, please review validateCode() method for valueSet at same class of line 1737", "author": "frankjtao", "createdAt": "2020-09-23T00:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMTE4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMjI0OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492732249", "bodyText": "Once again, I would argue that this could potentially be considered a validation failure rather than a usage error and therefore should result in the creation of a failure CodeValidationResult instead of throwing an exception.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:27:20Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -2555,5 +2561,120 @@ static boolean isOurLastResultsFromTranslationWithReverseCache() {\n \t\treturn ourLastResultsFromTranslationWithReverseCache;\n \t}\n \n+\t@Override\n+\t@Transactional\n+\tpublic CodeValidationResult codeSystemValidateCode(IIdType theCodeSystemId, String theCodeSystemUrl, String theVersion, String theCode, String theDisplay, IBaseDatatype theCoding, IBaseDatatype theCodeableConcept) {\n+\n+\t\tCodeableConcept codeableConcept = toCanonicalCodeableConcept(theCodeableConcept);\n+\t\tboolean haveCodeableConcept = codeableConcept != null && codeableConcept.getCoding().size() > 0;\n+\n+\t\tCoding coding = toCanonicalCoding(theCoding);\n+\t\tboolean haveCoding = coding != null && coding.isEmpty() == false;\n+\n+\t\tboolean haveCode = theCode != null && theCode.isEmpty() == false;\n+\n+\t\tif (!haveCodeableConcept && !haveCoding && !haveCode) {\n+\t\t\tthrow new InvalidRequestException(\"No code, coding, or codeableConcept provided to validate.\");\n+\t\t}\n+\t\tif (!LogicUtil.multiXor(haveCodeableConcept, haveCoding, haveCode)) {\n+\t\t\tthrow new InvalidRequestException(\"$validate-code can only validate (code) OR (coding) OR (codeableConcept)\");\n+\t\t}\n+\n+\t\tboolean haveIdentifierParam = isNotBlank(theCodeSystemUrl);\n+\t\tString codeSystemUrl;\n+\t\tif (theCodeSystemId != null) {\n+\t\t\tIBaseResource codeSystem = myDaoRegistry.getResourceDao(\"CodeSystem\").read(theCodeSystemId);\n+\t\t\tcodeSystemUrl = CommonCodeSystemsTerminologyService.getCodeSystemUrl(codeSystem);\n+\t\t} else if (haveIdentifierParam) {\n+\t\t\tcodeSystemUrl = theCodeSystemUrl;\n+\t\t} else {\n+\t\t\tthrow new InvalidRequestException(\"Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\");\n+\t\t}\n+\n+\t\t\n+\t\tString code = theCode;\n+\t\tString version = theVersion;\n+\t\tString display = theDisplay;\n+\t\t\n+\t\tif (haveCodeableConcept) {\n+\t\t\tfor (int i = 0; i < codeableConcept.getCoding().size(); i++) {\n+\t\t\t\tCoding nextCoding = codeableConcept.getCoding().get(i);\n+\t\t\t\tif (nextCoding.hasSystem()) {\n+\t\t\t\t\tif (!codeSystemUrl.equalsIgnoreCase(nextCoding.getSystem())) {\n+\t\t\t\t\t\tthrow new InvalidRequestException(\"Coding.system '\" + nextCoding.getSystem() + \"' does not equal with CodeSystem.url '\" + theCodeSystemUrl + \"'. Unable to validate.\");\n+\t\t\t\t\t}\n+\t\t\t\t\tcodeSystemUrl = nextCoding.getSystem();\n+\t\t\t\t}\n+\t\t\t\tcode = nextCoding.getCode();\n+\t\t\t\tdisplay = nextCoding.getDisplay();\n+\t\t\t\tCodeValidationResult nextValidation = codeSystemValidateCode(codeSystemUrl, version, code, display);\n+\t\t\t\tif (nextValidation.isOk() || i == codeableConcept.getCoding().size() - 1) {\n+\t\t\t\t\treturn nextValidation;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else if (haveCoding) {\n+\t\t\tif (coding.hasSystem()) {\n+\t\t\t\tif (!codeSystemUrl.equalsIgnoreCase(coding.getSystem())) {\n+\t\t\t\t\tthrow new InvalidRequestException(\"Coding.system '\" + coding.getSystem() + \"' does not equal with CodeSystem.url '\" + theCodeSystemUrl + \"'. Unable to validate.\");", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNzI5Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493107293", "bodyText": "Same as above", "author": "frankjtao", "createdAt": "2020-09-23T00:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjczMjI0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjA3NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492742074", "bodyText": "Suggestion: Would include a JUnit fail() statement after this statement, just in case the exception is not thrown as expected.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:40:30Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODQyOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493108429", "bodyText": "added fail();", "author": "frankjtao", "createdAt": "2020-09-23T00:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjI5Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492742292", "bodyText": "Suggestion: Would include a JUnit fail() statement after this statement, just in case the exception is not thrown as expected.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:40:46Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithId() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onInstance(myCsId).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithoutCodeOrCodingOrCodeableConcept() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODQ1NQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493108455", "bodyText": "added fail();", "author": "frankjtao", "createdAt": "2020-09-23T00:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjI5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjUzMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492742532", "bodyText": "Suggestion: Would include a JUnit fail() statement after this statement, just in case the exception is not thrown as expected.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:41:02Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithId() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onInstance(myCsId).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithoutCodeOrCodingOrCodeableConcept() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: No code, coding, or codeableConcept provided to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithCodeAndCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-1\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODQ3NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493108474", "bodyText": "added fail();", "author": "frankjtao", "createdAt": "2020-09-23T00:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjUzMg=="}], "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjgzOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492742839", "bodyText": "Suggestion: Would include a JUnit fail() statement after this statement, just in case the exception is not thrown as expected.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:41:25Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithId() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onInstance(myCsId).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithoutCodeOrCodingOrCodeableConcept() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: No code, coding, or codeableConcept provided to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithCodeAndCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-1\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: $validate-code can only validate (code) OR (coding) OR (codeableConcept)\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithUrlNotMatch() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(\"http://url2\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODQ5MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493108490", "bodyText": "added fail();", "author": "frankjtao", "createdAt": "2020-09-23T00:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MjgzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MzU1OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492743559", "bodyText": "Suggestion: Once again, would include a JUnit fail() statement after this statement, just in case the exception is not thrown as expected.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:42:19Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithId() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onInstance(myCsId).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithoutCodeOrCodingOrCodeableConcept() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: No code, coding, or codeableConcept provided to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithCodeAndCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-1\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: $validate-code can only validate (code) OR (coding) OR (codeableConcept)\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithUrlNotMatch() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(\"http://url2\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Coding.system 'http://url2' does not equal with CodeSystem.url 'http://acme.org'. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\")));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithSystem() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(CS_ACMS_URL)));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingUrlNotMatch() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(\"http://url2\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwODY3Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493108676", "bodyText": "added fail();", "author": "frankjtao", "createdAt": "2020-09-23T00:37:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0MzU1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc0NDc1Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492744753", "bodyText": "Very impressed by the thoroughness of your testing. Nice!", "author": "IanMMarshall", "createdAt": "2020-09-22T13:43:55Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java", "diffHunk": "@@ -0,0 +1,553 @@\n+package ca.uhn.fhir.jpa.provider.r4;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.instance.model.api.IIdType;\n+import org.hl7.fhir.r4.model.BooleanType;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeSystem.ConceptDefinitionComponent;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.hl7.fhir.r4.model.CodeableConcept;\n+import org.hl7.fhir.r4.model.Coding;\n+import org.hl7.fhir.r4.model.Parameters;\n+import org.hl7.fhir.r4.model.StringType;\n+import org.hl7.fhir.r4.model.UriType;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.transaction.TransactionStatus;\n+import org.springframework.transaction.annotation.Transactional;\n+import org.springframework.transaction.support.TransactionCallbackWithoutResult;\n+import org.springframework.transaction.support.TransactionTemplate;\n+\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+\n+public class ResourceProviderR4CodeSystemValidationTest extends BaseResourceProviderR4Test {\n+\n+\tprivate static final org.slf4j.Logger ourLog = org.slf4j.LoggerFactory.getLogger(ResourceProviderR4CodeSystemValidationTest.class);\n+\n+\tprivate IIdType myCsId;\n+\tprivate static final String CS_ACMS_URL = \"http://acme.org\";\n+\n+\t@BeforeEach\n+\t@Transactional\n+\tpublic void before02() throws IOException {\n+\t\tloadAndPersistCodeSystem();\n+\t}\n+\t\n+\tprivate void loadAndPersistCodeSystem() throws IOException {\n+\t\tCodeSystem codeSystem = loadResourceFromClasspath(CodeSystem.class, \"/extensional-case-3-cs.xml\");\n+\t\tcodeSystem.setId(\"CodeSystem/cs\");\n+\t\tpersistCodeSystem(codeSystem);\n+\t}\n+\n+\tprivate void persistCodeSystem(CodeSystem theCodeSystem) {\n+\t\tnew TransactionTemplate(myTxManager).execute(new TransactionCallbackWithoutResult() {\n+\t\t\t@Override\n+\t\t\tprotected void doInTransactionWithoutResult(@Nonnull TransactionStatus theStatus) {\n+\t\t\t\tmyCsId = myCodeSystemDao.create(theCodeSystem, mySrd).getId().toUnqualifiedVersionless();\n+\t\t\t}\n+\t\t});\n+\t\tmyCodeSystemDao.readEntity(myCsId, null).getId();\n+\t}\n+\n+\t@Test\n+\tpublic void testValidateCodeFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCode() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5-a\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeNotMatchDisplay() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Old Systolic blood pressure.inspiration - expiration\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5 - Concept Display : Old Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithoutUrl() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Either CodeSystem ID or CodeSystem identifier must be provided. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeWithId() throws Exception {\n+\t\t\t\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\t\n+\t\tParameters respParam = myClient.operation().onInstance(myCsId).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithoutCodeOrCodingOrCodeableConcept() throws Exception {\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"display\").setValue(new StringType(\"Systolic blood pressure.inspiration - expiration\"));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: No code, coding, or codeableConcept provided to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithCodeAndCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"8452-5\"));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-1\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: $validate-code can only validate (code) OR (coding) OR (codeableConcept)\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithUrlNotMatch() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(\"http://url2\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Coding.system 'http://url2' does not equal with CodeSystem.url 'http://acme.org'. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\")));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithSystem() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(CS_ACMS_URL)));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingUrlNotMatch() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setSystem(\"http://url2\")));\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Coding.system 'http://url2' does not equal with CodeSystem.url 'http://acme.org'. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodingWithDisplay() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5\").setDisplay(\"Systolic blood pressure.inspiration - expiration\")));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCoding() throws Exception {\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"coding\").setValue((new Coding().setCode(\"8452-5-a\")));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConcept() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptWithSystem() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\").setSystem(CS_ACMS_URL);\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptWithDisplay() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure.inspiration - expiration\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeNotFoundByCodeableConcept() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5-a\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(false, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Unknown code {http://acme.org}8452-5-a\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptUrlNotMatch() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\").setSystem(\"http://url2\").setDisplay(\"Systolic blood pressure.inspiration - expiration\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\ttry {\n+\t\t\tmyClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\t\t} catch (InvalidRequestException e) {\n+\t\t\tassertEquals(\"HTTP 400 Bad Request: Coding.system 'http://url2' does not equal with CodeSystem.url 'http://acme.org'. Unable to validate.\",e.getMessage());\n+\t\t}\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptWithMultipleMatchedEntries() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure.inspiration - expiration\");\n+\t\tcc.addCoding().setCode(\"8451-7\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure--inspiration\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptWithMultipleMatchedFirstEntry() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure.inspiration - expiration\");\n+\t\tcc.addCoding().setCode(\"8451-7-a\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure--inspiration\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure.inspiration - expiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeFoundByCodeableConceptWithMultipleMatchedSecondEntry() throws Exception {\n+\t\t\n+\t\tCodeableConcept cc = new CodeableConcept();\n+\t\tcc.addCoding().setCode(\"8452-5-a\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure.inspiration - expiration\");\n+\t\tcc.addCoding().setCode(\"8451-7\").setSystem(CS_ACMS_URL).setDisplay(\"Systolic blood pressure--inspiration\");\n+\t\t\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(CS_ACMS_URL));\n+\t\tinParams.addParameter().setName(\"codeableConcept\").setValue(cc);\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(respParam);\n+\t\tourLog.info(resp);\n+\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Systolic blood pressure--inspiration\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithUrlAndVersion_v1() {\n+\t\t\n+\t\tString url = \"http://url\";\n+\t\tcreateCodeSystem(url, \"v1\", \"1\", \"Code v1 display\");\n+\t\tcreateCodeSystem(url, \"v2\", \"1\", \"Code v2 display\");\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(url));\n+\t\tinParams.addParameter().setName(\"version\").setValue(new StringType(\"v1\"));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"1\"));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tourLog.info(\"Response Parameters\\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(respParam));\n+\t\t\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Code v1 display\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithUrlAndVersion_v2() {\n+\t\t\n+\t\tString url = \"http://url\";\n+\t\tcreateCodeSystem(url, \"v1\", \"1\", \"Code v1 display\");\n+\t\tcreateCodeSystem(url, \"v2\", \"1\", \"Code v2 display\");\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(url));\n+\t\tinParams.addParameter().setName(\"version\").setValue(new StringType(\"v2\"));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"1\"));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tourLog.info(\"Response Parameters\\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(respParam));\n+\t\t\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Code v2 display\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithUrlAndVersion_noVersion() {\n+\t\t\n+\t\tString url = \"http://url\";\n+\t\tcreateCodeSystem(url, \"v1\", \"1\", \"Code v1 display\");\n+\t\tcreateCodeSystem(url, \"v2\", \"1\", \"Code v2 display\");\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(url));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"1\"));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tourLog.info(\"Response Parameters\\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(respParam));\n+\t\t\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Code v2 display\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithUrlAndVersion_noVersion_null_v1() {\n+\t\t\n+\t\tString url = \"http://url\";\n+\t\tcreateCodeSystem(url, null, \"1\", \"Code v1 display\");\n+\t\tcreateCodeSystem(url, \"v2\", \"1\", \"Code v2 display\");\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(url));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"1\"));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tourLog.info(\"Response Parameters\\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(respParam));\n+\t\t\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Code v2 display\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\t\n+\t@Test\n+\tpublic void testValidateCodeWithUrlAndVersion_noVersion_null_v2() {\n+\t\t\n+\t\tString url = \"http://url\";\n+\t\tcreateCodeSystem(url, \"v1\", \"1\", \"Code v1 display\");\n+\t\tcreateCodeSystem(url, null, \"1\", \"Code v2 display\");\n+\n+\t\tParameters inParams = new Parameters();\n+\t\tinParams.addParameter().setName(\"url\").setValue(new UriType(url));\n+\t\tinParams.addParameter().setName(\"code\").setValue(new CodeType(\"1\"));\n+\n+\t\tParameters respParam = myClient.operation().onType(CodeSystem.class).named(\"validate-code\").withParameters(inParams).execute();\n+\n+\t\tourLog.info(\"Response Parameters\\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(respParam));\n+\t\t\n+\t\tassertEquals(true, ((BooleanType) respParam.getParameter().get(0).getValue()).booleanValue());\n+\t\tassertEquals(\"Code v2 display\", ((StringType) respParam.getParameter().get(1).getValue()).getValueAsString());\n+\t}\n+\t\n+\tprivate void createCodeSystem(String url, String version, String code, String display) {\n+\t\t\n+\t\tCodeSystem codeSystem = new CodeSystem();\n+\t\tcodeSystem.setUrl(url).setVersion(version);\n+\n+\t\tConceptDefinitionComponent concept1 = codeSystem.addConcept();\n+\t\tconcept1.setCode(\"1000\").setDisplay(\"Code Dispaly 1000\");\n+\n+\t\tConceptDefinitionComponent concept = codeSystem.addConcept();\n+\t\tconcept.setCode(code).setDisplay(display);\n+\n+\t\tConceptDefinitionComponent concept2 = codeSystem.addConcept();\n+\t\tconcept2.setCode(\"2000\").setDisplay(\"Code Dispaly 2000\");\n+\n+\t\tourLog.info(\"CodeSystem: \\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(codeSystem));\n+\t\t\n+\t\t myCodeSystemDao.create(codeSystem, mySrd);\n+\t}\n+}", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\nindex e92450d6dd..c4d705303f 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4CodeSystemValidationTest.java\n\n@@ -1,6 +1,7 @@\n package ca.uhn.fhir.jpa.provider.r4;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n import java.io.IOException;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1MzA0Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492753046", "bodyText": "To maintain the current level of test coverage, we either need to add a test for this or perhaps remove this case since CodeSystem code-validation is not being supported for DSTU2 and DSTU3.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:54:21Z", "path": "hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java", "diffHunk": "@@ -332,6 +332,32 @@ public static String getValueSetUrl(@Nonnull IBaseResource theValueSet) {\n \t\treturn url;\n \t}\n \n+\tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n+\t\tString url;\n+\t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n+\t\t\tcase DSTU2_HL7ORG: {\n+\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTUxNg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493109516", "bodyText": "Removed", "author": "frankjtao", "createdAt": "2020-09-23T00:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1MzA0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e6a669444d4278b98fde5c30a9ece182eba19af0", "chunk": "diff --git a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\nindex cfea4d2ac8..41170364e8 100644\n--- a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n+++ b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n\n@@ -335,14 +335,6 @@ public class CommonCodeSystemsTerminologyService implements IValidationSupport {\n \tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n \t\tString url;\n \t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n-\t\t\tcase DSTU2_HL7ORG: {\n-\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t\tcase DSTU3: {\n-\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n \t\t\tcase R4: {\n \t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n \t\t\t\tbreak;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1MzE1Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492753157", "bodyText": "To maintain the current level of test coverage, we either need to add a test for this or perhaps remove this case since CodeSystem code-validation is not being supported for DSTU2 and DSTU3.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:54:29Z", "path": "hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java", "diffHunk": "@@ -332,6 +332,32 @@ public static String getValueSetUrl(@Nonnull IBaseResource theValueSet) {\n \t\treturn url;\n \t}\n \n+\tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n+\t\tString url;\n+\t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n+\t\t\tcase DSTU2_HL7ORG: {\n+\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase DSTU3: {\n+\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6a669444d4278b98fde5c30a9ece182eba19af0", "chunk": "diff --git a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\nindex cfea4d2ac8..41170364e8 100644\n--- a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n+++ b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n\n@@ -335,14 +335,6 @@ public class CommonCodeSystemsTerminologyService implements IValidationSupport {\n \tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n \t\tString url;\n \t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n-\t\t\tcase DSTU2_HL7ORG: {\n-\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t\tcase DSTU3: {\n-\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n \t\t\tcase R4: {\n \t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n \t\t\t\tbreak;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1NTk1MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492755950", "bodyText": "Perhaps augment the R5 provider test to include a case that includes CodeSystem ID so that this code is also included in the tests.", "author": "IanMMarshall", "createdAt": "2020-09-22T13:57:55Z", "path": "hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java", "diffHunk": "@@ -332,6 +332,32 @@ public static String getValueSetUrl(@Nonnull IBaseResource theValueSet) {\n \t\treturn url;\n \t}\n \n+\tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n+\t\tString url;\n+\t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n+\t\t\tcase DSTU2_HL7ORG: {\n+\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase DSTU3: {\n+\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase R4: {\n+\t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase R5: {\n+\t\t\t\turl = ((org.hl7.fhir.r5.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTUzNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493109537", "bodyText": "Removed", "author": "frankjtao", "createdAt": "2020-09-23T00:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc1NTk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "e6a669444d4278b98fde5c30a9ece182eba19af0", "chunk": "diff --git a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\nindex cfea4d2ac8..41170364e8 100644\n--- a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n+++ b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n\n@@ -335,14 +335,6 @@ public class CommonCodeSystemsTerminologyService implements IValidationSupport {\n \tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n \t\tString url;\n \t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n-\t\t\tcase DSTU2_HL7ORG: {\n-\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t\tcase DSTU3: {\n-\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n \t\t\tcase R4: {\n \t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n \t\t\t\tbreak;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwODcwNg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r492808706", "bodyText": "May need a dedicated test case here to maintain the test coverage level.", "author": "IanMMarshall", "createdAt": "2020-09-22T15:02:59Z", "path": "hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java", "diffHunk": "@@ -332,6 +332,32 @@ public static String getValueSetUrl(@Nonnull IBaseResource theValueSet) {\n \t\treturn url;\n \t}\n \n+\tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n+\t\tString url;\n+\t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n+\t\t\tcase DSTU2_HL7ORG: {\n+\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase DSTU3: {\n+\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase R4: {\n+\t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase R5: {\n+\t\t\t\turl = ((org.hl7.fhir.r5.model.CodeSystem) theCodeSystem).getUrl();\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tcase DSTU2:\n+\t\t\tcase DSTU2_1:\n+\t\t\tdefault:\n+\t\t\t\tthrow new IllegalArgumentException(\"Can not handle version: \" + theCodeSystem.getStructureFhirVersionEnum());", "originalCommit": "8f692a4776001ffce2b2ac2779bf106fd4f90775", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMjE2Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493112166", "bodyText": "Removed DSTU2, and DSTU2_1 since there is no CodeSystem resource for the FHIR version. Added test case for DTU3", "author": "frankjtao", "createdAt": "2020-09-23T00:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwODcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e6a669444d4278b98fde5c30a9ece182eba19af0", "chunk": "diff --git a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\nindex cfea4d2ac8..41170364e8 100644\n--- a/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n+++ b/hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/CommonCodeSystemsTerminologyService.java\n\n@@ -335,14 +335,6 @@ public class CommonCodeSystemsTerminologyService implements IValidationSupport {\n \tpublic static String getCodeSystemUrl(@Nonnull IBaseResource theCodeSystem) {\n \t\tString url;\n \t\tswitch (theCodeSystem.getStructureFhirVersionEnum()) {\n-\t\t\tcase DSTU2_HL7ORG: {\n-\t\t\t\turl = ((CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n-\t\t\tcase DSTU3: {\n-\t\t\t\turl = ((org.hl7.fhir.dstu3.model.CodeSystem) theCodeSystem).getUrl();\n-\t\t\t\tbreak;\n-\t\t\t}\n \t\t\tcase R4: {\n \t\t\t\turl = ((org.hl7.fhir.r4.model.CodeSystem) theCodeSystem).getUrl();\n \t\t\t\tbreak;\n"}}, {"oid": "673274a966580af4f02ad902514bc912bd973816", "url": "https://github.com/hapifhir/hapi-fhir/commit/673274a966580af4f02ad902514bc912bd973816", "message": "Added invalid test cases for CodeSystem/$validate-code R3", "committedDate": "2020-09-23T00:18:18Z", "type": "commit"}, {"oid": "20661c7a2b906e67b17585fa9a2d5b72086520bf", "url": "https://github.com/hapifhir/hapi-fhir/commit/20661c7a2b906e67b17585fa9a2d5b72086520bf", "message": "Removed unused import", "committedDate": "2020-09-23T00:19:43Z", "type": "commit"}, {"oid": "b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "url": "https://github.com/hapifhir/hapi-fhir/commit/b6d86dc5f2ef3f819e5c7c7b09b0cde5629260ac", "message": "Added fail(); in the invalid test cases", "committedDate": "2020-09-23T00:39:20Z", "type": "commit"}, {"oid": "e6a669444d4278b98fde5c30a9ece182eba19af0", "url": "https://github.com/hapifhir/hapi-fhir/commit/e6a669444d4278b98fde5c30a9ece182eba19af0", "message": "Added invalid test cases for DSTU3", "committedDate": "2020-09-23T00:51:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzU2ODk0NQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2094#discussion_r493568945", "bodyText": "I think I may have missed this in my previous review. I think the above import should be for the r5 IdType.", "author": "IanMMarshall", "createdAt": "2020-09-23T13:09:27Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r5/BaseJpaResourceProviderCodeSystemR5.java", "diffHunk": "@@ -23,9 +23,13 @@\n import ca.uhn.fhir.context.support.IValidationSupport;\n import ca.uhn.fhir.jpa.api.dao.IFhirResourceDaoCodeSystem;\n import ca.uhn.fhir.jpa.model.util.JpaConstants;\n+import ca.uhn.fhir.jpa.provider.BaseJpaResourceProviderValueSetDstu2;\n+import ca.uhn.fhir.rest.annotation.IdParam;\n import ca.uhn.fhir.rest.annotation.Operation;\n import ca.uhn.fhir.rest.annotation.OperationParam;\n import ca.uhn.fhir.rest.api.server.RequestDetails;\n+\n+import org.hl7.fhir.r4.model.IdType;", "originalCommit": "e6a669444d4278b98fde5c30a9ece182eba19af0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d3d013d72e6f4d7ca6665897c79641157486b2a", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r5/BaseJpaResourceProviderCodeSystemR5.java b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r5/BaseJpaResourceProviderCodeSystemR5.java\nindex 1c13173d58..122149c6f8 100644\n--- a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r5/BaseJpaResourceProviderCodeSystemR5.java\n+++ b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/provider/r5/BaseJpaResourceProviderCodeSystemR5.java\n\n@@ -29,7 +29,7 @@ import ca.uhn.fhir.rest.annotation.Operation;\n import ca.uhn.fhir.rest.annotation.OperationParam;\n import ca.uhn.fhir.rest.api.server.RequestDetails;\n \n-import org.hl7.fhir.r4.model.IdType;\n+import org.hl7.fhir.r5.model.IdType;\n import org.hl7.fhir.r5.model.BooleanType;\n import org.hl7.fhir.r5.model.CodeSystem;\n import org.hl7.fhir.r5.model.CodeType;\n"}}, {"oid": "3d3d013d72e6f4d7ca6665897c79641157486b2a", "url": "https://github.com/hapifhir/hapi-fhir/commit/3d3d013d72e6f4d7ca6665897c79641157486b2a", "message": "Changed import of IdType to r5.", "committedDate": "2020-09-23T13:19:06Z", "type": "commit"}]}