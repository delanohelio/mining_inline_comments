{"pr_number": 1655, "pr_title": "Fixed JSON generation for profiled resource.", "pr_createdAt": "2020-01-02T14:19:10Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1655", "timeline": [{"oid": "a76573a825ceb0284c981927f071bb11cad6216e", "url": "https://github.com/hapifhir/hapi-fhir/commit/a76573a825ceb0284c981927f071bb11cad6216e", "message": "[(fixjsongeneration)] When max cardinality in profile is changed to 1 output JSON should still contain an array.", "committedDate": "2020-01-02T13:38:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTU2NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1655#discussion_r362919564", "bodyText": "This seems like it would have pretty negative performance implications, as it introduces several reflection calls to every composite element we serialize.\nCould this check be moved into the reflection checks that happen when the model is initially scanned? I.e. in the constructor to BaseRuntimeChildDatatypeDefinition or something like that?", "author": "jamesagnew", "createdAt": "2020-01-03T18:51:06Z", "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/parser/JsonParser.java", "diffHunk": "@@ -581,6 +587,24 @@ private void encodeCompositeElementChildrenToStreamWriter(RuntimeResourceDefinit\n \t\t}\n \t}\n \n+\tprivate boolean isMultipleCardinality(int maxCardinality) {\n+\t\treturn maxCardinality > 1 || maxCardinality == Child.MAX_UNLIMITED;\n+\t}\n+\n+\tprivate Map<String, Child> getParentProfileElementMetadata(IBase theElement) {", "originalCommit": "a76573a825ceb0284c981927f071bb11cad6216e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0NjY1MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1655#discussion_r364746651", "bodyText": "@jamesagnew  Thank you for advise. Please have a look to commit 8961a0a .", "author": "mykhsystematic", "createdAt": "2020-01-09T13:48:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTU2NA=="}], "type": "inlineReview", "revised_code": {"commit": "8961a0a036cad5cf7f46127da716a5b68abe6229", "chunk": "diff --git a/hapi-fhir-base/src/main/java/ca/uhn/fhir/parser/JsonParser.java b/hapi-fhir-base/src/main/java/ca/uhn/fhir/parser/JsonParser.java\nindex 018ea362c8..7a0c1939a2 100644\n--- a/hapi-fhir-base/src/main/java/ca/uhn/fhir/parser/JsonParser.java\n+++ b/hapi-fhir-base/src/main/java/ca/uhn/fhir/parser/JsonParser.java\n\n@@ -591,20 +587,6 @@ public class JsonParser extends BaseParser implements IJsonLikeParser {\n \t\treturn maxCardinality > 1 || maxCardinality == Child.MAX_UNLIMITED;\n \t}\n \n-\tprivate Map<String, Child> getParentProfileElementMetadata(IBase theElement) {\n-\t\tClass<?> superclass = theElement.getClass().getSuperclass();\n-\t\tMap<String, Child> parentProfileElementsMetadata = new HashMap<>();\n-\t\tif(superclass.isAnnotationPresent(ResourceDef.class) || superclass.isAnnotationPresent(DatatypeDef.class)) {\n-\t\t\tfor (Field field: superclass.getDeclaredFields()) {\n-\t\t\t\tChild childAnnotation = field.getAnnotation(Child.class);\n-\t\t\t\tif(childAnnotation != null) {\n-\t\t\t\t\tparentProfileElementsMetadata.put(childAnnotation.name(), childAnnotation);\n-\t\t\t\t}\n-\t\t\t}\n-\t\t}\n-\t\treturn parentProfileElementsMetadata;\n-\t}\n-\n \tprivate void encodeCompositeElementToStreamWriter(RuntimeResourceDefinition theResDef, IBaseResource theResource, IBase theNextValue, JsonLikeWriter theEventWriter, boolean theContainedResource, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  CompositeChildElement theParent, EncodeContext theEncodeContext) throws IOException, DataFormatException {\n \n \t\twriteCommentsPreAndPost(theNextValue, theEventWriter);\n"}}, {"oid": "8961a0a036cad5cf7f46127da716a5b68abe6229", "url": "https://github.com/hapifhir/hapi-fhir/commit/8961a0a036cad5cf7f46127da716a5b68abe6229", "message": "[(fixjsongenerationtomaster)] When max cardinality in profile is changed to 1 output JSON contain an array.", "committedDate": "2020-01-09T13:42:12Z", "type": "commit"}, {"oid": "c714fedcd223b501f37faf53f8447637ae91ca0d", "url": "https://github.com/hapifhir/hapi-fhir/commit/c714fedcd223b501f37faf53f8447637ae91ca0d", "message": "[(fixjsongenerationtomaster)] Remove unused import.", "committedDate": "2020-01-09T13:45:17Z", "type": "commit"}]}