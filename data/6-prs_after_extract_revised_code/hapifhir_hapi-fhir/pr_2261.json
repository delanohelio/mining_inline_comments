{"pr_number": 2261, "pr_title": "UCUM Service Support ", "pr_createdAt": "2020-12-22T19:41:53Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2261", "timeline": [{"oid": "8fd9a526470fb6d1d93bb6a2b7f2704e788a9d8c", "url": "https://github.com/hapifhir/hapi-fhir/commit/8fd9a526470fb6d1d93bb6a2b7f2704e788a9d8c", "message": "Added UcumServiceUtil", "committedDate": "2020-12-13T20:43:05Z", "type": "commit"}, {"oid": "6b40f2c578193029d08c15d504ba29e3e63b2adc", "url": "https://github.com/hapifhir/hapi-fhir/commit/6b40f2c578193029d08c15d504ba29e3e63b2adc", "message": "Removed ucum-essense.xml", "committedDate": "2020-12-13T21:14:34Z", "type": "commit"}, {"oid": "4dfb0cc075da11f1f634edf4468aa90b2e2b7bfd", "url": "https://github.com/hapifhir/hapi-fhir/commit/4dfb0cc075da11f1f634edf4468aa90b2e2b7bfd", "message": "Added ucum service existing test cases passed", "committedDate": "2020-12-21T21:52:05Z", "type": "commit"}, {"oid": "744f4cff9a5cc8bde17d49bb2477e995e90454ff", "url": "https://github.com/hapifhir/hapi-fhir/commit/744f4cff9a5cc8bde17d49bb2477e995e90454ff", "message": "Added more test cases", "committedDate": "2020-12-22T19:20:35Z", "type": "commit"}, {"oid": "225248b02c1d87dc8e33d8107b42742d4033bfc7", "url": "https://github.com/hapifhir/hapi-fhir/commit/225248b02c1d87dc8e33d8107b42742d4033bfc7", "message": "Merge branch 'master' into ft-ucum-support", "committedDate": "2020-12-22T21:17:34Z", "type": "commit"}, {"oid": "9c1ff7441f0ff3056c5710335a583e89ba333555", "url": "https://github.com/hapifhir/hapi-fhir/commit/9c1ff7441f0ff3056c5710335a583e89ba333555", "message": "Merge branch 'master' into ft-ucum-support\n\n# Please enter a commit message to explain why this merge is necessary,\n# especially if it merges an updated upstream into a topic branch.\n#\n# Lines starting with '#' will be ignored, and an empty message aborts\n# the commit.", "committedDate": "2020-12-22T23:59:45Z", "type": "commit"}, {"oid": "208c2d218887fa572072e03e74dd0bfb1496b9ab", "url": "https://github.com/hapifhir/hapi-fhir/commit/208c2d218887fa572072e03e74dd0bfb1496b9ab", "message": "Added back extractReferenceParamsAsQueryTokens", "committedDate": "2020-12-23T02:03:37Z", "type": "commit"}, {"oid": "1c9e7ec9f227b5be1ec1a6f9162a8165567da771", "url": "https://github.com/hapifhir/hapi-fhir/commit/1c9e7ec9f227b5be1ec1a6f9162a8165567da771", "message": "Added changelog and migration script", "committedDate": "2020-12-23T03:15:15Z", "type": "commit"}, {"oid": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "url": "https://github.com/hapifhir/hapi-fhir/commit/6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "message": "Added length for the string type", "committedDate": "2020-12-23T14:53:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjE5Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551256197", "bodyText": "I think calling this feature \"ucum support\" is perhaps a bit too vague, since there are other ways you can use UCUM (e.g. for validation) even with this featured turned off.\nHow about getNormalizedQuantitySearch...?", "author": "jamesagnew", "createdAt": "2021-01-04T11:15:57Z", "path": "hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ModelConfig.java", "diffHunk": "@@ -585,4 +588,44 @@ private static void validateTreatBaseUrlsAsLocal(String theUrl) {\n \t\t}\n \n \t}\n+\n+\t/**\n+\t * Set the UCUM service support level\n+     * \n+\t * <p>\n+\t * The default value is {@link UcumSupportLevelEnum#UCUM_NOT_SUPPORTED} which is current behavior.\n+\t * </p>\n+\t * <p>\n+\t * Here is the UCUM service support level\n+\t *    <ul>\n+\t *       <li>{@link UcumSupportLevelEnum#UCUM_NOT_SUPPORTED}, default, Quantity is stored in {@link ResourceIndexedSearchParamQuantity} only and it is used by searching.</li>\n+\t *       <li>{@link UcumSupportLevelEnum#UCUM_STORAGE_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, but {@link ResourceIndexedSearchParamQuantity} is used by searching.</li>\n+\t *       <li>{@link UcumSupportLevelEnum#UCUM_SEARCH_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching.</li>\n+\t *       <li>{@link UcumSupportLevelEnum#UCUM_FULL_SUPPORTED}, Quantity is stored in only in {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching. NOTE\uff1a this option is not supported yet.</li>\n+\t *     </ul>\n+\t * </p>\n+\t *\n+\t * @since 5.3.0\n+\t */\n+\tpublic UcumSupportLevelEnum getUcumSupportLevel() {", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2NzQ2Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551567467", "bodyText": "Will rename", "author": "frankjtao", "createdAt": "2021-01-04T21:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjE5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "0ae7772d09b05f4513766a36c08b31926629ff11", "chunk": "diff --git a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ModelConfig.java b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ModelConfig.java\nindex 1542e8d345..d88ce62718 100644\n--- a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ModelConfig.java\n+++ b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ModelConfig.java\n\n@@ -593,39 +593,39 @@ public class ModelConfig {\n \t * Set the UCUM service support level\n      * \n \t * <p>\n-\t * The default value is {@link UcumSupportLevelEnum#UCUM_NOT_SUPPORTED} which is current behavior.\n+\t * The default value is {@link NormalizedQuantitySearchLevel#NORMALIZED_QUANTITY_SEARCH_NOT_SUPPORTED} which is current behavior.\n \t * </p>\n \t * <p>\n \t * Here is the UCUM service support level\n \t *    <ul>\n-\t *       <li>{@link UcumSupportLevelEnum#UCUM_NOT_SUPPORTED}, default, Quantity is stored in {@link ResourceIndexedSearchParamQuantity} only and it is used by searching.</li>\n-\t *       <li>{@link UcumSupportLevelEnum#UCUM_STORAGE_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, but {@link ResourceIndexedSearchParamQuantity} is used by searching.</li>\n-\t *       <li>{@link UcumSupportLevelEnum#UCUM_SEARCH_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching.</li>\n-\t *       <li>{@link UcumSupportLevelEnum#UCUM_FULL_SUPPORTED}, Quantity is stored in only in {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching. NOTE\uff1a this option is not supported yet.</li>\n+\t *       <li>{@link NormalizedQuantitySearchLevel#NORMALIZED_QUANTITY_SEARCH_NOT_SUPPORTED}, default, Quantity is stored in {@link ResourceIndexedSearchParamQuantity} only and it is used by searching.</li>\n+\t *       <li>{@link NormalizedQuantitySearchLevel#NORMALIZED_QUANTITY_STORAGE_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, but {@link ResourceIndexedSearchParamQuantity} is used by searching.</li>\n+\t *       <li>{@link NormalizedQuantitySearchLevel#NORMALIZED_QUANTITY_SEARCH_SUPPORTED}, Quantity is stored in both {@link ResourceIndexedSearchParamQuantity} and {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching.</li>\n+\t *       <li>{@link NormalizedQuantitySearchLevel#NORMALIZED_QUANTITY_SEARCH_FULL_SUPPORTED}, Quantity is stored in only in {@link ResourceIndexedSearchParamQuantityNormalized}, {@link ResourceIndexedSearchParamQuantityNormalized} is used by searching. NOTE\uff1a this option is not supported yet.</li>\n \t *     </ul>\n \t * </p>\n \t *\n \t * @since 5.3.0\n \t */\n-\tpublic UcumSupportLevelEnum getUcumSupportLevel() {\n-\t\treturn myUcumSupportLevel;\n+\tpublic NormalizedQuantitySearchLevel getNormalizedQuantitySearchLevel() {\n+\t\treturn myNormalizedQuantitySearchLevel;\n \t}\n-\tpublic void setUcumSupportLevel(UcumSupportLevelEnum theUcumSupportLevel) {\n-\t\tmyUcumSupportLevel = theUcumSupportLevel;\n+\tpublic void setNormalizedQuantitySearchLevel(NormalizedQuantitySearchLevel theNormalizedQuantitySearchLevel) {\n+\t\tmyNormalizedQuantitySearchLevel = theNormalizedQuantitySearchLevel;\n \t}\n-\tpublic boolean isUcumSearchSupported() {\n-\t\treturn myUcumSupportLevel.equals(UcumSupportLevelEnum.UCUM_SEARCH_SUPPORTED);\n+\tpublic boolean isNormalizedQuantitySearchSupported() {\n+\t\treturn myNormalizedQuantitySearchLevel.equals(NormalizedQuantitySearchLevel.NORMALIZED_QUANTITY_SEARCH_SUPPORTED);\n \t}\n-\tpublic boolean isUcumStorageSupported() {\n-\t\treturn myUcumSupportLevel.equals(UcumSupportLevelEnum.UCUM_STORAGE_SUPPORTED);\n+\tpublic boolean isNormalizedQuantityStorageSupported() {\n+\t\treturn myNormalizedQuantitySearchLevel.equals(NormalizedQuantitySearchLevel.NORMALIZED_QUANTITY_STORAGE_SUPPORTED);\n \t}\n-\tpublic void setUcumNotSupported() {\n-\t\tmyUcumSupportLevel = UcumSupportLevelEnum.UCUM_NOT_SUPPORTED;\n+\tpublic void setNormalizedQuantitySearchNotSupported() {\n+\t\tmyNormalizedQuantitySearchLevel = NormalizedQuantitySearchLevel.NORMALIZED_QUANTITY_SEARCH_NOT_SUPPORTED;\n \t}\n-\tpublic void setUcumStorageSupported() {\n-\t\tmyUcumSupportLevel = UcumSupportLevelEnum.UCUM_STORAGE_SUPPORTED;\n+\tpublic void setNormalizedQuantityStorageSupported() {\n+\t\tmyNormalizedQuantitySearchLevel = NormalizedQuantitySearchLevel.NORMALIZED_QUANTITY_STORAGE_SUPPORTED;\n \t}\n-\tpublic void setUcumSearchSupported() {\n-\t\tmyUcumSupportLevel = UcumSupportLevelEnum.UCUM_SEARCH_SUPPORTED;\n+\tpublic void setNormalizedQuantitySearchSupported() {\n+\t\tmyNormalizedQuantitySearchLevel = NormalizedQuantitySearchLevel.NORMALIZED_QUANTITY_SEARCH_SUPPORTED;\n \t}\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551256579", "bodyText": "It should be 530 at this point. Version 5.2.0 is already released.", "author": "jamesagnew", "createdAt": "2021-01-04T11:16:46Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -83,6 +83,32 @@ protected void init520() {\n \t\t\t.addForeignKey(\"20201029.3\", \"FK_EMPI_LINK_GOLDEN_RESOURCE\")\n \t\t\t.toColumn(\"GOLDEN_RESOURCE_PID\")\n \t\t\t.references(\"HFJ_RESOURCE\", \"RES_ID\");\n+\t\t\n+\t\t// Version 520 or 530?", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2OTQ4OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551569489", "bodyText": "hapi-fhir/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n    \n    \n         Line 73\n      in\n      86f254c\n    \n    \n    \n    \n\n        \n          \n           init520(); // 20201029 - Present \n        \n    \n  \n\n\n520 was added after 5.2.0 was released. Should it be changed to 530. There is no migration task for 520 @jamesagnew", "author": "frankjtao", "createdAt": "2021-01-04T21:08:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU3NTY1MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551575651", "bodyText": "@frankjtao oh haha! Yeah, this should be renamed please. Good catch!", "author": "jamesagnew", "createdAt": "2021-01-04T21:21:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU4OTUyNg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551589526", "bodyText": "I have added a new field SP_QUANTITY_NRML_PRESENT to the ResourceTable, after deploying the war to my local server (tomcat+postgresql), the field is set to NULL instead false for the existing column, is this normal? @jamesagnew", "author": "frankjtao", "createdAt": "2021-01-04T21:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU5MzgxMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551593813", "bodyText": "@frankjtao yup, it'll default to null. You should set your code up to treat null as if it was false so that it doesn't cause any issues for people who are migrating.", "author": "jamesagnew", "createdAt": "2021-01-04T21:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU5NzU5Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551597592", "bodyText": "The field is set to boolean  in the Hibernate mapping, it should be take care of by Hibernate.\n\n  \n    \n      hapi-fhir/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java\n    \n    \n         Line 158\n      in\n      6683a22\n    \n    \n    \n    \n\n        \n          \n           private boolean myParamsQuantityNormalizedPopulated; \n        \n    \n  \n\n @jamesagnew", "author": "frankjtao", "createdAt": "2021-01-04T22:06:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NjU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a709a6a995703c8903981db43c17a9ab1e59cd52", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 3b4e9cb686..ca90bca02e 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -84,7 +84,6 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \t\t\t.toColumn(\"GOLDEN_RESOURCE_PID\")\n \t\t\t.references(\"HFJ_RESOURCE\", \"RES_ID\");\n \t\t\n-\t\t// Version 520 or 530?\n \t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n \t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n \t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1ODE4Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551258187", "bodyText": "Thanks for removing this. Always appreciate when people clean up test cruft as they find them! :)", "author": "jamesagnew", "createdAt": "2021-01-04T11:20:15Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderHasParamR4Test.java", "diffHunk": "@@ -163,7 +163,6 @@ public void testMultipleHasParametersOfSameType() throws Exception {\n \t\tourLog.info(\"uri = \" + uri);\n \t\t\n \t\tList<String> ids = searchAndReturnUnqualifiedVersionlessIdValues(uri);\n-\t\tSystem.out.println(\"ids.size() = \" + ids.size());", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1OTIwOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551259209", "bodyText": "Not that it makes much difference, but just to match the style we usually use in these tests can you move this line up into the @AfterEach method in this test class (or create one if there isn't already one)", "author": "jamesagnew", "createdAt": "2021-01-04T11:22:36Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java", "diffHunk": "@@ -2959,6 +3062,32 @@ public void testSearchQuantityWrongParam() {\n \n \t}\n \n+\t@Test\n+\tpublic void testSearchQuantityWithUcumSearchSupported() {\n+\t\t\n+\t\tmyModelConfig.setUcumSearchSupported();\n+\t\tCondition c1 = new Condition();\n+\t\tc1.setAbatement(new Range().setLow(new SimpleQuantity().setValue(1L)).setHigh(new SimpleQuantity().setValue(1L)));\n+\t\tString id1 = myConditionDao.create(c1).getId().toUnqualifiedVersionless().getValue();\n+\n+\t\tCondition c2 = new Condition();\n+\t\tc2.setOnset(new Range().setLow(new SimpleQuantity().setValue(1L)).setHigh(new SimpleQuantity().setValue(1L)));\n+\t\tString id2 = myConditionDao.create(c2).getId().toUnqualifiedVersionless().getValue();\n+\n+\t\t{\n+\t\t\tIBundleProvider found = myConditionDao.search(new SearchParameterMap().setLoadSynchronous(true).add(Condition.SP_ABATEMENT_AGE, new QuantityParam(\"1\")));\n+\t\t\tassertThat(toUnqualifiedVersionlessIdValues(found), containsInAnyOrder(id1));\n+\t\t\tassertEquals(1, found.size().intValue());\n+\t\t}\n+\t\t{\n+\t\t\tIBundleProvider found = myConditionDao.search(new SearchParameterMap().setLoadSynchronous(true).add(Condition.SP_ONSET_AGE, new QuantityParam(\"1\")));\n+\t\t\tassertThat(toUnqualifiedVersionlessIdValues(found), containsInAnyOrder(id2));\n+\t\t\tassertEquals(1, found.size().intValue());\n+\t\t}\n+\n+\t\tmyModelConfig.setUcumNotSupported();", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0ae7772d09b05f4513766a36c08b31926629ff11", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\nindex 8318f54250..73c7e28d21 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n\n@@ -3065,7 +3065,7 @@ public class FhirResourceDaoR4SearchNoFtTest extends BaseJpaR4Test {\n \t@Test\n \tpublic void testSearchQuantityWithUcumSearchSupported() {\n \t\t\n-\t\tmyModelConfig.setUcumSearchSupported();\n+\t\tmyModelConfig.setNormalizedQuantitySearchSupported();\n \t\tCondition c1 = new Condition();\n \t\tc1.setAbatement(new Range().setLow(new SimpleQuantity().setValue(1L)).setHigh(new SimpleQuantity().setValue(1L)));\n \t\tString id1 = myConditionDao.create(c1).getId().toUnqualifiedVersionless().getValue();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NjIyMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551266223", "bodyText": "It's possible I just missed these, but there are a couple of cases I don't see tests for that I think would be good to add:\n\n\nUcum Search Enabled, but search using a quantity that has an invalid UCUM code, e.g. \"system\":\"http://unitsofmeasure.org\", \"code\": \"FOO\", \"value\": 100 (I think we should make sure this can be performed, just in case the UCUM library is missing a real unit)\n\n\nUcum Search Enabled, but search using a quantity that isn't UCUM, e.g. \"system\":\"http://bar\", \"code\": \"FOO\", \"value\": 100\n\n\nUcum Search Enabled, then use an OR expression combining UCUM and non-UCUM query, e.g. `Observation?value-quantity=100|http://unitsofmeasure|cm,100|foo|cm", "author": "jamesagnew", "createdAt": "2021-01-04T11:38:04Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java", "diffHunk": "@@ -2959,6 +3062,32 @@ public void testSearchQuantityWrongParam() {\n \n \t}\n \n+\t@Test\n+\tpublic void testSearchQuantityWithUcumSearchSupported() {", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM0MDQ3Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r552340472", "bodyText": "Add test cases to cover the above scenario", "author": "frankjtao", "createdAt": "2021-01-06T03:10:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NjIyMw=="}], "type": "inlineReview", "revised_code": {"commit": "0ae7772d09b05f4513766a36c08b31926629ff11", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\nindex 8318f54250..73c7e28d21 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n\n@@ -3065,7 +3065,7 @@ public class FhirResourceDaoR4SearchNoFtTest extends BaseJpaR4Test {\n \t@Test\n \tpublic void testSearchQuantityWithUcumSearchSupported() {\n \t\t\n-\t\tmyModelConfig.setUcumSearchSupported();\n+\t\tmyModelConfig.setNormalizedQuantitySearchSupported();\n \t\tCondition c1 = new Condition();\n \t\tc1.setAbatement(new Range().setLow(new SimpleQuantity().setValue(1L)).setHigh(new SimpleQuantity().setValue(1L)));\n \t\tString id1 = myConditionDao.create(c1).getId().toUnqualifiedVersionless().getValue();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2ODk4Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551268982", "bodyText": "It's possible I just missed these, but there are a couple of cases I don't see tests for that I think would be good to add:\n\nUcum Storage supported - Make sure we create rows in both the standard and normalized quantity index tables\nUcum Search supported - Make sure we create rows in both the standard and normalized quantity index tables", "author": "jamesagnew", "createdAt": "2021-01-04T11:44:36Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4CreateTest.java", "diffHunk": "@@ -1,40 +1,47 @@\n package ca.uhn.fhir.jpa.dao.r4;\n \n-import ca.uhn.fhir.jpa.api.config.DaoConfig;\n-import ca.uhn.fhir.jpa.searchparam.SearchParameterMap;\n-import ca.uhn.fhir.rest.param.StringParam;\n-import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n-import ca.uhn.fhir.rest.server.exceptions.ResourceVersionConflictException;\n-import ca.uhn.fhir.rest.server.exceptions.UnprocessableEntityException;\n-import ca.uhn.fhir.util.TestUtil;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.matchesPattern;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.util.Date;\n+import java.util.List;\n+\n import org.apache.commons.lang3.time.DateUtils;\n+import org.hl7.fhir.instance.model.api.IBaseResource;\n import org.hl7.fhir.instance.model.api.IIdType;\n import org.hl7.fhir.r4.model.Bundle;\n import org.hl7.fhir.r4.model.DateType;\n+import org.hl7.fhir.r4.model.DecimalType;\n import org.hl7.fhir.r4.model.Enumerations;\n import org.hl7.fhir.r4.model.IdType;\n import org.hl7.fhir.r4.model.Observation;\n import org.hl7.fhir.r4.model.Organization;\n import org.hl7.fhir.r4.model.Patient;\n+import org.hl7.fhir.r4.model.Quantity;\n import org.hl7.fhir.r4.model.SampledData;\n import org.hl7.fhir.r4.model.SearchParameter;\n-import org.junit.jupiter.api.AfterAll;\n import org.junit.jupiter.api.AfterEach;\n import org.junit.jupiter.api.Test;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.data.domain.PageRequest;\n \n-import java.io.IOException;\n-import java.util.Date;\n-\n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.contains;\n-import static org.hamcrest.Matchers.empty;\n-import static org.hamcrest.Matchers.matchesPattern;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n-import static org.junit.jupiter.api.Assertions.fail;\n+import ca.uhn.fhir.jpa.api.config.DaoConfig;\n+import ca.uhn.fhir.jpa.searchparam.SearchParameterMap;\n+import ca.uhn.fhir.rest.api.server.IBundleProvider;\n+import ca.uhn.fhir.rest.param.QuantityParam;\n+import ca.uhn.fhir.rest.param.StringParam;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n+import ca.uhn.fhir.rest.server.exceptions.ResourceVersionConflictException;\n+import ca.uhn.fhir.rest.server.exceptions.UnprocessableEntityException;\n+import ca.uhn.fhir.util.UcumServiceUtil;\n \n public class FhirResourceDaoR4CreateTest extends BaseJpaR4Test {", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM0MjA1Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r552342056", "bodyText": "@jamesagnew\nUcum Storage support is covered at \n  \n    \n      hapi-fhir/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n    \n    \n         Line 1346\n      in\n      c78e2af\n    \n    \n    \n    \n\n        \n          \n           runInTransaction(() -> { \n        \n    \n  \n\n\nUcum Search Support is covered at \n  \n    \n      hapi-fhir/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n    \n    \n         Line 1256\n      in\n      c78e2af\n    \n    \n    \n    \n\n        \n          \n           runInTransaction(() -> {", "author": "frankjtao", "createdAt": "2021-01-06T03:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2ODk4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "41e7349898eafc92268bbea595548814cdf8b498", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4CreateTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4CreateTest.java\nindex d328915f1b..1e1b2769cb 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4CreateTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4CreateTest.java\n\n@@ -41,7 +41,7 @@ import ca.uhn.fhir.rest.param.StringParam;\n import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;\n import ca.uhn.fhir.rest.server.exceptions.ResourceVersionConflictException;\n import ca.uhn.fhir.rest.server.exceptions.UnprocessableEntityException;\n-import ca.uhn.fhir.util.UcumServiceUtil;\n+import ca.uhn.fhir.jpa.model.util.UcumServiceUtil;\n \n public class FhirResourceDaoR4CreateTest extends BaseJpaR4Test {\n \tprivate static final Logger ourLog = LoggerFactory.getLogger(FhirResourceDaoR4CreateTest.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MDM3OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r551270379", "bodyText": "Not related to this line, but adding a comment here: Could you also add tests to InMemorySubscriptionMatcherR4Test with normalized search mode enabled, just to make sure that enabling this new mode doesn't break the in-memory search mode (this feature is used for subscription processing)", "author": "jamesagnew", "createdAt": "2021-01-04T11:47:44Z", "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/util/UcumServiceUtil.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package ca.uhn.fhir.util;", "originalCommit": "6683a22057f85bdcf0f680e5c67091bc3e9a21d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM0Mjc3OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r552342779", "bodyText": "Good catch, I have found a bug in the inmemory search. It's fixed and added more test cases in InMemorySubscriptionMatcherR4Test  @jamesagnew", "author": "frankjtao", "createdAt": "2021-01-06T03:18:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MDM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "41e7349898eafc92268bbea595548814cdf8b498", "chunk": "diff --git a/hapi-fhir-base/src/main/java/ca/uhn/fhir/util/UcumServiceUtil.java b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\nsimilarity index 97%\nrename from hapi-fhir-base/src/main/java/ca/uhn/fhir/util/UcumServiceUtil.java\nrename to hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\nindex dc4c4917ec..e21534c374 100644\n--- a/hapi-fhir-base/src/main/java/ca/uhn/fhir/util/UcumServiceUtil.java\n+++ b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\n\n@@ -1,4 +1,4 @@\n-package ca.uhn.fhir.util;\n+package ca.uhn.fhir.jpa.model.util;\n \n /*\n  * #%L\n"}}, {"oid": "41e7349898eafc92268bbea595548814cdf8b498", "url": "https://github.com/hapifhir/hapi-fhir/commit/41e7349898eafc92268bbea595548814cdf8b498", "message": "Moved UCUM util to hapi-fhir-jpaserver-model", "committedDate": "2021-01-04T15:06:50Z", "type": "commit"}, {"oid": "0ae7772d09b05f4513766a36c08b31926629ff11", "url": "https://github.com/hapifhir/hapi-fhir/commit/0ae7772d09b05f4513766a36c08b31926629ff11", "message": "Renamed UCUM support to Normalized Quantity Search Support", "committedDate": "2021-01-04T20:43:13Z", "type": "commit"}, {"oid": "40f33cdb4807b7c93dc2e3edce508dcd8c0d7671", "url": "https://github.com/hapifhir/hapi-fhir/commit/40f33cdb4807b7c93dc2e3edce508dcd8c0d7671", "message": "Moved setNormalizedQuantitySearchNotSupported to AfterEach", "committedDate": "2021-01-05T02:33:08Z", "type": "commit"}, {"oid": "220766f4668acd6752bb9fc1e75ce13669944ac4", "url": "https://github.com/hapifhir/hapi-fhir/commit/220766f4668acd6752bb9fc1e75ce13669944ac4", "message": "Changed migrate task to 530", "committedDate": "2021-01-05T02:34:45Z", "type": "commit"}, {"oid": "a709a6a995703c8903981db43c17a9ab1e59cd52", "url": "https://github.com/hapifhir/hapi-fhir/commit/a709a6a995703c8903981db43c17a9ab1e59cd52", "message": "Removed comments", "committedDate": "2021-01-05T02:37:13Z", "type": "commit"}, {"oid": "c78e2af052f0ea2cfd57bcdf6dc361c911bf5936", "url": "https://github.com/hapifhir/hapi-fhir/commit/c78e2af052f0ea2cfd57bcdf6dc361c911bf5936", "message": "Fixed in memory search issue and added more test cases", "committedDate": "2021-01-06T02:44:31Z", "type": "commit"}, {"oid": "bc1b52e063b9e73535eb7f85ebc95fe4df90f738", "url": "https://github.com/hapifhir/hapi-fhir/commit/bc1b52e063b9e73535eb7f85ebc95fe4df90f738", "message": "Merge branch 'master' into ft-ucum-support\n\n# Conflicts:\n#\thapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n#\thapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceIndexedSearchParamQuantity.java", "committedDate": "2021-01-06T04:36:29Z", "type": "commit"}, {"oid": "cc528d6a0aef6f9623f6cb3d08bd43c6ef25adfb", "url": "https://github.com/hapifhir/hapi-fhir/commit/cc528d6a0aef6f9623f6cb3d08bd43c6ef25adfb", "message": "Fixed the version order", "committedDate": "2021-01-06T14:13:45Z", "type": "commit"}, {"oid": "9559c569a44535280b6ca290f298bd980972d346", "url": "https://github.com/hapifhir/hapi-fhir/commit/9559c569a44535280b6ca290f298bd980972d346", "message": "License header updates", "committedDate": "2021-01-06T14:26:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEzMTQxMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554131412", "bodyText": "Is there a reason that a second patient is being added here? Seems to be identical to the first patient and none of the assertions in this test seem to involve this second patient.", "author": "IanMMarshall", "createdAt": "2021-01-08T18:55:43Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java", "diffHunk": "@@ -4050,6 +4083,168 @@ public void testSearchReturnsSearchDate() throws Exception {\n \t\tassertTrue(value.before(after), new InstantDt(value) + \" should be before \" + new InstantDt(after));\n \t}\n \n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported() throws Exception {\n+\t\t\n+\t\tmyDaoConfig.getModelConfig().setNormalizedQuantitySearchSupported();\n+\t\tIIdType pid0;\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tpid0 = myPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tmyPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ0NDI3OA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554444278", "bodyText": "It's a cut/paste, the second patient is removed.", "author": "frankjtao", "createdAt": "2021-01-09T16:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEzMTQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "513db1417a95832b6362f27a669e19b8074f016b", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\nindex 9b4e29b472..62576b232c 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\n\n@@ -4094,12 +4094,6 @@ public class ResourceProviderR4Test extends BaseResourceProviderR4Test {\n \t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n \t\t\tpid0 = myPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n \t\t}\n-\t\t{\n-\t\t\tPatient patient = new Patient();\n-\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n-\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n-\t\t\tmyPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n-\t\t}\n \t\t{\n \t\t\tObservation obs = new Observation();\n \t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEzMzg2Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554133866", "bodyText": "Once again, just curious whether this second patient is required for this test.", "author": "IanMMarshall", "createdAt": "2021-01-08T19:00:42Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java", "diffHunk": "@@ -4050,6 +4083,168 @@ public void testSearchReturnsSearchDate() throws Exception {\n \t\tassertTrue(value.before(after), new InstantDt(value) + \" should be before \" + new InstantDt(after));\n \t}\n \n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported() throws Exception {\n+\t\t\n+\t\tmyDaoConfig.getModelConfig().setNormalizedQuantitySearchSupported();\n+\t\tIIdType pid0;\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tpid0 = myPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tmyPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}\n+\t\t{\n+\t\t\tObservation obs = new Observation();\n+\t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n+\t\t\tobs.getSubject().setReferenceElement(pid0);\n+\t\t\tCodeableConcept cc = obs.getCode();\n+\t\t\tcc.addCoding().setCode(\"2345-7\").setSystem(\"http://loinc.org\");\n+\t\t\tobs.setValue(new Quantity().setValueElement(new DecimalType(125.12)).setUnit(\"CM\").setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"cm\"));\n+\t\t\t\n+\t\t\tmyObservationDao.create(obs, mySrd);\n+\t\t\t\n+\t\t\tourLog.info(\"Observation: \\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(obs));\n+\t\t}\n+\n+\t\t{\n+\t\t\tObservation obs = new Observation();\n+\t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n+\t\t\tobs.getSubject().setReferenceElement(pid0);\n+\t\t\tCodeableConcept cc = obs.getCode();\n+\t\t\tcc.addCoding().setCode(\"2345-7\").setSystem(\"http://loinc.org\");\n+\t\t\tobs.setValue(new Quantity().setValueElement(new DecimalType(13.45)).setUnit(\"DM\").setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"dm\"));\n+\t\t\t\n+\t\t\tmyObservationDao.create(obs, mySrd);\n+\t\t\t\n+\t\t\tourLog.info(\"Observation: \\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(obs));\n+\t\t}\n+\n+\t\t{\n+\t\t\tObservation obs = new Observation();\n+\t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n+\t\t\tobs.getSubject().setReferenceElement(pid0);\n+\t\t\tCodeableConcept cc = obs.getCode();\n+\t\t\tcc.addCoding().setCode(\"2345-7\").setSystem(\"http://loinc.org\");\n+\t\t\tobs.setValue(new Quantity().setValueElement(new DecimalType(1.45)).setUnit(\"M\").setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"m\"));\n+\n+\t\t\tmyObservationDao.create(obs, mySrd);\n+\t\t\t\n+\t\t\tourLog.info(\"Observation: \\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(obs));\n+\t\t}\n+\t\t\n+\t\t{\n+\t\t\tObservation obs = new Observation();\n+\t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n+\t\t\tobs.getSubject().setReferenceElement(pid0);\n+\t\t\tCodeableConcept cc = obs.getCode();\n+\t\t\tcc.addCoding().setCode(\"2345-7\").setSystem(\"http://loinc.org\");\n+\t\t\tobs.setValue(new Quantity().setValueElement(new DecimalType(25)).setUnit(\"CM\").setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"cm\"));\n+\t\t\t\t\t\t\t\t\n+\t\t\tmyObservationDao.create(obs, mySrd);\n+\t\t\t\n+\t\t\tourLog.info(\"Observation: \\n\" + myFhirCtx.newJsonParser().setPrettyPrint(true).encodeResourceToString(obs));\n+\t\t}\n+\t\t\n+\t\t// > 1m\n+\t\tString uri = ourServerBase + \"/Observation?code-value-quantity=http://\" + UrlUtil.escapeUrlParam(\"loinc.org|2345-7$gt1|http://unitsofmeasure.org|m\");\n+\t\tourLog.info(\"uri = \" + uri);\n+\t\tList<String> ids = searchAndReturnUnqualifiedVersionlessIdValues(uri);\n+\t\tassertEquals(3, ids.size());\n+\t\t\n+\t\t//>= 100cm\n+\t\turi = ourServerBase + \"/Observation?code-value-quantity=http://\" + UrlUtil.escapeUrlParam(\"loinc.org|2345-7$gt100|http://unitsofmeasure.org|cm\");\n+\t\tourLog.info(\"uri = \" + uri);\n+\t\tids = searchAndReturnUnqualifiedVersionlessIdValues(uri);\n+\t\tassertEquals(3, ids.size());\n+\n+\t\t//>= 10dm\n+\t\turi = ourServerBase + \"/Observation?code-value-quantity=http://\" + UrlUtil.escapeUrlParam(\"loinc.org|2345-7$gt10|http://unitsofmeasure.org|dm\");\n+\t\tourLog.info(\"uri = \" + uri);\n+\t\tids = searchAndReturnUnqualifiedVersionlessIdValues(uri);\n+\t\tassertEquals(3, ids.size());\n+\t}\n+\t\n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported_CombineUCUMOrNonUCUM() throws Exception {\n+\t\t\n+\t\tmyDaoConfig.getModelConfig().setNormalizedQuantitySearchSupported();\n+\t\tIIdType pid0;\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tpid0 = myPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}\n+\t\t{\n+\t\t\tPatient patient = new Patient();\n+\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n+\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n+\t\t\tmyPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n+\t\t}", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ0NDM5MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554444390", "bodyText": "The second patient is removed.", "author": "frankjtao", "createdAt": "2021-01-09T16:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDEzMzg2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "513db1417a95832b6362f27a669e19b8074f016b", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\nindex 9b4e29b472..62576b232c 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r4/ResourceProviderR4Test.java\n\n@@ -4094,12 +4094,6 @@ public class ResourceProviderR4Test extends BaseResourceProviderR4Test {\n \t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n \t\t\tpid0 = myPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n \t\t}\n-\t\t{\n-\t\t\tPatient patient = new Patient();\n-\t\t\tpatient.addIdentifier().setSystem(\"urn:system\").setValue(\"001\");\n-\t\t\tpatient.addName().setFamily(\"Tester\").addGiven(\"Joe\");\n-\t\t\tmyPatientDao.create(patient, mySrd).getId().toUnqualifiedVersionless();\n-\t\t}\n \t\t{\n \t\t\tObservation obs = new Observation();\n \t\t\tobs.addIdentifier().setSystem(\"urn:system\").setValue(\"FOO\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0MTE4Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554141182", "bodyText": "Do we maybe need to reset the ModelConfig settings between tests?", "author": "IanMMarshall", "createdAt": "2021-01-08T19:16:23Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/module/matcher/InMemorySubscriptionMatcherR4Test.java", "diffHunk": "@@ -235,7 +240,90 @@ public void testComponentQuantityEquals() {\n \t\tSearchParameterMap params = new SearchParameterMap().setLoadSynchronous(true).add(param, v1);\n \t\tassertMatched(o1, params);\n \t}\n+\t\n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported() {\n+\t\t\n+\t\tmyModelConfig.setNormalizedQuantitySearchSupported();\n+\t\t\n+\t\t\n+\t\tObservation o1 = new Observation();\n+\t\to1.addComponent()\n+\t\t\t.setCode(new CodeableConcept().addCoding(new Coding().setSystem(\"http://foo\").setCode(\"cm\")))\n+\t\t\t.setValue(new Quantity().setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"cm\").setValue(150));\n+\n+\t\tString param1 = Observation.SP_COMPONENT_VALUE_QUANTITY;\n+\n+\t\tQuantityParam v1 = new QuantityParam(null, 1.5, UcumServiceUtil.UCUM_CODESYSTEM_URL, \"m\");\n+\t\tSearchParameterMap params1 = new SearchParameterMap().setLoadSynchronous(true).add(param1, v1);\n+\t\tassertMatched(o1, params1);\n+\t\t\n+\t\tObservation o2 = new Observation();\n+\t\to2.addComponent()\n+\t\t\t.setCode(new CodeableConcept().addCoding(new Coding().setSystem(\"http://foo\").setCode(\"cm\")))\n+\t\t\t.setValue(new Quantity().setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"cm\").setValue(150));\n+\n+\t\tString param2 = Observation.SP_COMPONENT_VALUE_QUANTITY;\n+\n+\t\tQuantityParam v2 = new QuantityParam(null, 15, UcumServiceUtil.UCUM_CODESYSTEM_URL, \"dm\");\n+\t\tSearchParameterMap params2 = new SearchParameterMap().setLoadSynchronous(true).add(param2, v2);\n+\t\tassertMatched(o2, params2);\n+\n+\t\tv2 = new QuantityParam(null, 150, UcumServiceUtil.UCUM_CODESYSTEM_URL, \"cm\");\n+\t\tparams2 = new SearchParameterMap().setLoadSynchronous(true).add(param2, v2);\n+\t\tassertMatched(o2, params2);\n+\n+\t}\n+\t\n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported_InvalidUCUMUnit() {\n+\t\tmyModelConfig.setNormalizedQuantitySearchSupported();\n+\t\t\t\t\n+\t\tObservation o1 = new Observation();\n+\t\to1.addComponent()\n+\t\t\t.setCode(new CodeableConcept().addCoding(new Coding().setSystem(\"http://bar\").setCode(\"foo\")))\n+\t\t\t.setValue(new Quantity().setSystem(UcumServiceUtil.UCUM_CODESYSTEM_URL).setCode(\"foo\").setValue(150));\n \n+\t\tString param1 = Observation.SP_COMPONENT_VALUE_QUANTITY;\n+\n+\t\tQuantityParam v1 = new QuantityParam(null, 150, UcumServiceUtil.UCUM_CODESYSTEM_URL, \"foo\");\n+\t\tSearchParameterMap params1 = new SearchParameterMap().setLoadSynchronous(true).add(param1, v1);\n+\t\tassertMatched(o1, params1);\n+\t}\n+\t\n+\t@Test\n+\tpublic void testSearchWithNormalizedQuantitySearchSupported_NoSystem() {\n+\t\tmyModelConfig.setNormalizedQuantitySearchSupported();", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1MDU4MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554450580", "bodyText": "added reset in @AfterEach", "author": "frankjtao", "createdAt": "2021-01-09T17:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0MTE4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "513db1417a95832b6362f27a669e19b8074f016b", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/module/matcher/InMemorySubscriptionMatcherR4Test.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/module/matcher/InMemorySubscriptionMatcherR4Test.java\nindex ee920d50f5..e3764d8296 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/module/matcher/InMemorySubscriptionMatcherR4Test.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/subscription/module/matcher/InMemorySubscriptionMatcherR4Test.java\n\n@@ -245,8 +251,7 @@ public class InMemorySubscriptionMatcherR4Test {\n \tpublic void testSearchWithNormalizedQuantitySearchSupported() {\n \t\t\n \t\tmyModelConfig.setNormalizedQuantitySearchSupported();\n-\t\t\n-\t\t\n+\n \t\tObservation o1 = new Observation();\n \t\to1.addComponent()\n \t\t\t.setCode(new CodeableConcept().addCoding(new Coding().setSystem(\"http://foo\").setCode(\"cm\")))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0NTIyNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554145227", "bodyText": "RES_TYPE should be a STRING of length 100, not a LONG.", "author": "IanMMarshall", "createdAt": "2021-01-08T19:25:08Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -76,12 +76,40 @@ public HapiFhirJpaMigrationTasks(Set<String> theFlags) {\n \n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n+\t\n+\t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n+\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n+\t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ3Nzg1Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554477857", "bodyText": "The Column Type for the RES_TYPE still needs to be fixed (RES_TYPE is a STRING not a LONG).", "author": "IanMMarshall", "createdAt": "2021-01-09T21:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0NTIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "d32a44d82351b547502b214a74dacde50890c521", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 097d3da19b..746c0f79a6 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -77,9 +77,18 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n \t\n+\t\t//-- TRM\n+\t\tversion\n+\t\t\t.onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t\t.dropIndex(\"20210104.1\", \"IDX_VS_CONCEPT_CS_CODE\");\n+\t\t\n+\t    version\n+\t\t    .onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t    .addIndex(\"20210104.2\", \"IDX_VS_CONCEPT_CSCD\").unique(true).withColumns(\"VALUESET_PID\", \"SYSTEM_URL\", \"CODEVAL\");\n+\t    \n \t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n-\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n-\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tversion.addIdGenerator(\"20210109.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20210109.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n \t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0Njg4Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554146887", "bodyText": "I think SP_VALUE should be of type FLOAT rather than LONG.", "author": "IanMMarshall", "createdAt": "2021-01-08T19:28:28Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -76,12 +76,40 @@ public HapiFhirJpaMigrationTasks(Set<String> theFlags) {\n \n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n+\t\n+\t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n+\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n+\t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n+\t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n+\t\tpkg.addColumn(\"SP_MISSING\").nonNullable().type(ColumnTypeEnum.BOOLEAN);\t\n+\t\tpkg.addColumn(\"SP_NAME\").nonNullable().type(ColumnTypeEnum.STRING, 100);\n+\t\tpkg.addColumn(\"SP_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\t\n+\t\tpkg.addColumn(\"SP_SYSTEM\").nullable().type(ColumnTypeEnum.STRING, 200);\n+\t\tpkg.addColumn(\"SP_UNITS\").nullable().type(ColumnTypeEnum.STRING, 200);\n+\t\tpkg.addColumn(\"HASH_IDENTITY_AND_UNITS\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"HASH_IDENTITY_SYS_UNITS\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"HASH_IDENTITY\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"SP_VALUE\").nullable().type(ColumnTypeEnum.LONG);", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1MjEwOA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554452108", "bodyText": "Changed to FLOAT", "author": "frankjtao", "createdAt": "2021-01-09T17:38:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE0Njg4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d32a44d82351b547502b214a74dacde50890c521", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 097d3da19b..746c0f79a6 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -77,9 +77,18 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n \t\n+\t\t//-- TRM\n+\t\tversion\n+\t\t\t.onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t\t.dropIndex(\"20210104.1\", \"IDX_VS_CONCEPT_CS_CODE\");\n+\t\t\n+\t    version\n+\t\t    .onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t    .addIndex(\"20210104.2\", \"IDX_VS_CONCEPT_CSCD\").unique(true).withColumns(\"VALUESET_PID\", \"SYSTEM_URL\", \"CODEVAL\");\n+\t    \n \t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n-\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n-\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tversion.addIdGenerator(\"20210109.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20210109.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n \t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE1MjA4Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554152087", "bodyText": "I believe that all of the code related to HFJ_SPIDX_QUANTITY_NRML should appear in this method after task \"20210104.2\", i.e. the tasks should be ordered based on the date that they were added so that the 20210122.* tasks are executed after the 20210104.* tasks.", "author": "IanMMarshall", "createdAt": "2021-01-08T19:39:50Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -76,12 +76,40 @@ public HapiFhirJpaMigrationTasks(Set<String> theFlags) {\n \n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n+\t\n+\t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1Mzc4MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554453780", "bodyText": "Moved to the end and changed the date to 20210109", "author": "frankjtao", "createdAt": "2021-01-09T17:55:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE1MjA4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "d32a44d82351b547502b214a74dacde50890c521", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 097d3da19b..746c0f79a6 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -77,9 +77,18 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n \t\n+\t\t//-- TRM\n+\t\tversion\n+\t\t\t.onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t\t.dropIndex(\"20210104.1\", \"IDX_VS_CONCEPT_CS_CODE\");\n+\t\t\n+\t    version\n+\t\t    .onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t    .addIndex(\"20210104.2\", \"IDX_VS_CONCEPT_CSCD\").unique(true).withColumns(\"VALUESET_PID\", \"SYSTEM_URL\", \"CODEVAL\");\n+\t    \n \t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n-\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n-\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tversion.addIdGenerator(\"20210109.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20210109.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n \t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE1NzU2MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554157561", "bodyText": "I do not see this foreign key referenced in the entity class for HFJ_SPIDX_QUANTITY_NRML. I do not think you need to include this in the migration.", "author": "IanMMarshall", "createdAt": "2021-01-08T19:51:44Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -76,12 +76,40 @@ public HapiFhirJpaMigrationTasks(Set<String> theFlags) {\n \n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n+\t\n+\t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n+\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n+\t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n+\t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n+\t\tpkg.addColumn(\"SP_MISSING\").nonNullable().type(ColumnTypeEnum.BOOLEAN);\t\n+\t\tpkg.addColumn(\"SP_NAME\").nonNullable().type(ColumnTypeEnum.STRING, 100);\n+\t\tpkg.addColumn(\"SP_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\t\n+\t\tpkg.addColumn(\"SP_SYSTEM\").nullable().type(ColumnTypeEnum.STRING, 200);\n+\t\tpkg.addColumn(\"SP_UNITS\").nullable().type(ColumnTypeEnum.STRING, 200);\n+\t\tpkg.addColumn(\"HASH_IDENTITY_AND_UNITS\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"HASH_IDENTITY_SYS_UNITS\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"HASH_IDENTITY\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addColumn(\"SP_VALUE\").nullable().type(ColumnTypeEnum.LONG);\n+\t\tpkg.addIndex(\"20201222.3\", \"IDX_SP_QNTY_NRML_HASH\").unique(false).withColumns(\"HASH_IDENTITY\",\"SP_VALUE\");\n+\t\tpkg.addIndex(\"20201222.4\", \"IDX_SP_QNTY_NRML_HASH_UN\").unique(false).withColumns(\"HASH_IDENTITY_AND_UNITS\",\"SP_VALUE\");\n+\t\tpkg.addIndex(\"20201222.5\", \"IDX_SP_QNTY_NRML_HASH_SYSUN\").unique(false).withColumns(\"HASH_IDENTITY_SYS_UNITS\",\"SP_VALUE\");\n+\t\tpkg.addIndex(\"20201222.6\", \"IDX_SP_QNTY_NRML_UPDATED\").unique(false).withColumns(\"SP_UPDATED\");\n+\t\tpkg.addIndex(\"20201222.7\", \"IDX_SP_QNTY_NRML_RESID\").unique(false).withColumns(\"RES_ID\");\n+\t\tpkg.addForeignKey(\"20201222.8\", \"FK_QNTY_NRML_RESID\").toColumn(\"RES_ID\").references(\"HFJ_RESOURCE\", \"RES_ID\");", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1NDMzNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554454337", "bodyText": "The foreign key is defined entity via the relationship at\n@ManyToOne(optional = false, fetch = FetchType.LAZY, cascade = {})\n\t@JoinColumn(name = \"RES_ID\", referencedColumnName = \"RES_ID\", nullable = false)\n\tprivate ResourceTable myResource;\n\nI checked the postgreSQL database, the foreign key is generated by hibernate. Not sure it should be added to the migration task or not. I have commented out for now", "author": "frankjtao", "createdAt": "2021-01-09T17:58:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE1NzU2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d32a44d82351b547502b214a74dacde50890c521", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 097d3da19b..746c0f79a6 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -77,9 +77,18 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \tprivate void init530() {\n \t\tBuilder version = forVersion(VersionEnum.V5_3_0);\n \t\n+\t\t//-- TRM\n+\t\tversion\n+\t\t\t.onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t\t.dropIndex(\"20210104.1\", \"IDX_VS_CONCEPT_CS_CODE\");\n+\t\t\n+\t    version\n+\t\t    .onTable(\"TRM_VALUESET_CONCEPT\")\n+\t\t    .addIndex(\"20210104.2\", \"IDX_VS_CONCEPT_CSCD\").unique(true).withColumns(\"VALUESET_PID\", \"SYSTEM_URL\", \"CODEVAL\");\n+\t    \n \t\t//-- Add new Table, HFJ_SPIDX_QUANTITY_NRML\n-\t\tversion.addIdGenerator(\"20201222.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n-\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20201222.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n+\t\tversion.addIdGenerator(\"20210109.1\", \"SEQ_SPIDX_QUANTITY_NRML\");\n+\t\tBuilder.BuilderAddTableByColumns pkg = version.addTableByColumns(\"20210109.2\", \"HFJ_SPIDX_QUANTITY_NRML\", \"SP_ID\");\n \t\tpkg.addColumn(\"RES_ID\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"RES_TYPE\").nonNullable().type(ColumnTypeEnum.LONG);\t\n \t\tpkg.addColumn(\"SP_UPDATED\").nullable().type(ColumnTypeEnum.DATE_TIMESTAMP);\t\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE3MDY3Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554170676", "bodyText": "Nitpick - file header is duplicated here.", "author": "IanMMarshall", "createdAt": "2021-01-08T20:19:10Z", "path": "hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package ca.uhn.fhir.jpa.model.util;\n+\n+/*\n+ * #%L\n+ * HAPI FHIR Model\n+ * %%\n+ * Copyright (C) 2014 - 2021 Smile CDR, Inc.\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */\n+\n+import java.io.InputStream;\n+import java.math.BigDecimal;\n+\n+/*\n+ * #%L\n+ * HAPI FHIR Model\n+ * %%\n+ * Copyright (C) 2014 - 2021 Smile CDR, Inc.\n+ * %%\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * #L%\n+ */", "originalCommit": "9559c569a44535280b6ca290f298bd980972d346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDQ1MDQ5Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554450496", "bodyText": "Removed the dup file header", "author": "frankjtao", "createdAt": "2021-01-09T17:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE3MDY3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "513db1417a95832b6362f27a669e19b8074f016b", "chunk": "diff --git a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\nindex bae3cef579..3224067fbc 100644\n--- a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\n+++ b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/util/UcumServiceUtil.java\n\n@@ -23,26 +23,6 @@ package ca.uhn.fhir.jpa.model.util;\n import java.io.InputStream;\n import java.math.BigDecimal;\n \n-/*\n- * #%L\n- * HAPI FHIR Model\n- * %%\n- * Copyright (C) 2014 - 2021 Smile CDR, Inc.\n- * %%\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- * #L%\n- */\n-\n import org.fhir.ucum.Decimal;\n import org.fhir.ucum.Pair;\n import org.fhir.ucum.UcumEssenceService;\n"}}, {"oid": "513db1417a95832b6362f27a669e19b8074f016b", "url": "https://github.com/hapifhir/hapi-fhir/commit/513db1417a95832b6362f27a669e19b8074f016b", "message": "Updated based on review comments", "committedDate": "2021-01-09T17:33:41Z", "type": "commit"}, {"oid": "6aba995dfdc8a48506d3b2fc5812c26839e15d49", "url": "https://github.com/hapifhir/hapi-fhir/commit/6aba995dfdc8a48506d3b2fc5812c26839e15d49", "message": "Merge branch 'master' into ft-ucum-support", "committedDate": "2021-01-09T17:34:32Z", "type": "commit"}, {"oid": "d32a44d82351b547502b214a74dacde50890c521", "url": "https://github.com/hapifhir/hapi-fhir/commit/d32a44d82351b547502b214a74dacde50890c521", "message": "Updated the migration task based on review comments", "committedDate": "2021-01-09T19:40:38Z", "type": "commit"}, {"oid": "713ee773e80eb99dfe2ed932c72b3868d6ac7e6c", "url": "https://github.com/hapifhir/hapi-fhir/commit/713ee773e80eb99dfe2ed932c72b3868d6ac7e6c", "message": "Fixed RES_TYPE with type String and length 100", "committedDate": "2021-01-09T22:08:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYwODkxNA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554608914", "bodyText": "Just discovered a problem with this field that occurs during DB migration. It appears that during startup when a new column is added to an existing table that has rows in it, it will also attempt to populate the column with null values. However primitive types cannot be null and so this causes errors.\nI think the safest option to fix this problem is to type this column as a java Boolean class rather than as a boolean primitive.", "author": "IanMMarshall", "createdAt": "2021-01-10T19:03:59Z", "path": "hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java", "diffHunk": "@@ -149,6 +146,22 @@\n \t@Column(name = \"SP_QUANTITY_PRESENT\")\n \t@OptimisticLock(excluded = true)\n \tprivate boolean myParamsQuantityPopulated;\n+\t\n+\t/**\n+\t * Added to support UCUM conversion\n+\t * since 5.3.0\n+\t */\n+\t@OneToMany(mappedBy = \"myResource\", cascade = {}, fetch = FetchType.LAZY, orphanRemoval = false)\n+\t@OptimisticLock(excluded = true)\n+\tprivate Collection<ResourceIndexedSearchParamQuantityNormalized> myParamsQuantityNormalized;\n+\t\n+\t/**\n+\t * Added to support UCUM conversion\n+\t * since 5.3.0\n+\t */\n+\t@Column(name = \"SP_QUANTITY_NRML_PRESENT\")\n+\t@OptimisticLock(excluded = true)\n+\tprivate boolean myParamsQuantityNormalizedPopulated;", "originalCommit": "713ee773e80eb99dfe2ed932c72b3868d6ac7e6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYzMDYzMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2261#discussion_r554630633", "bodyText": "Changed to Boolean class, tested on local server.", "author": "frankjtao", "createdAt": "2021-01-10T22:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDYwODkxNA=="}], "type": "inlineReview", "revised_code": {"commit": "3d8e2c8d82968d3019851553c35c38cebcab6be9", "chunk": "diff --git a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java\nindex 0e44c2a3c4..0b6ac43c38 100644\n--- a/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java\n+++ b/hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceTable.java\n\n@@ -156,12 +156,13 @@ public class ResourceTable extends BaseHasResource implements Serializable, IBas\n \tprivate Collection<ResourceIndexedSearchParamQuantityNormalized> myParamsQuantityNormalized;\n \t\n \t/**\n-\t * Added to support UCUM conversion\n+\t * Added to support UCUM conversion, \n+\t * NOTE : use Boolean class instead of boolean primitive, in order to set the existing rows to null\n \t * since 5.3.0\n \t */\n \t@Column(name = \"SP_QUANTITY_NRML_PRESENT\")\n \t@OptimisticLock(excluded = true)\n-\tprivate boolean myParamsQuantityNormalizedPopulated;\n+\tprivate Boolean myParamsQuantityNormalizedPopulated = Boolean.FALSE;\n \n \t@OneToMany(mappedBy = \"myResource\", cascade = {}, fetch = FetchType.LAZY, orphanRemoval = false)\n \t@OptimisticLock(excluded = true)\n"}}, {"oid": "3d8e2c8d82968d3019851553c35c38cebcab6be9", "url": "https://github.com/hapifhir/hapi-fhir/commit/3d8e2c8d82968d3019851553c35c38cebcab6be9", "message": "Changed myParamsQuantityNormalizedPopulated type to Boolean class", "committedDate": "2021-01-10T22:13:09Z", "type": "commit"}]}