{"pr_number": 1761, "pr_title": "Avoid duplicate predicate in _id queries", "pr_createdAt": "2020-03-14T23:45:39Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1761", "timeline": [{"oid": "da6db60d875c990005ff08ecf7d401988abdf96a", "url": "https://github.com/hapifhir/hapi-fhir/commit/da6db60d875c990005ff08ecf7d401988abdf96a", "message": "Avoid duplicate predicate in _id queries", "committedDate": "2020-03-14T23:44:37Z", "type": "commit"}, {"oid": "bc7673374128a444bf57be8ac3ede48a5cd4007f", "url": "https://github.com/hapifhir/hapi-fhir/commit/bc7673374128a444bf57be8ac3ede48a5cd4007f", "message": "Add changelog", "committedDate": "2020-03-14T23:48:07Z", "type": "commit"}, {"oid": "04e9a0ae81061458b70f1f1866af9b7f432828f1", "url": "https://github.com/hapifhir/hapi-fhir/commit/04e9a0ae81061458b70f1f1866af9b7f432828f1", "message": "Change to trigger CI", "committedDate": "2020-03-15T00:15:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMzQ0NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1761#discussion_r393233444", "bodyText": "nice!", "author": "tadgh", "createdAt": "2020-03-16T18:33:46Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/SearchBuilder.java", "diffHunk": "@@ -316,7 +345,8 @@ private void init(SearchParameterMap theParams, String theTheSearchUuid) {\n \t\t * If we have any joins to index tables, we get this behaviour already guaranteed so we don't\n \t\t * need an explicit predicate for it.\n \t\t */\n-\t\tif (!myQueryRoot.hasIndexJoins()) {\n+\t\tboolean haveNoIndexSearchParams = myParams.size() == 0 || myParams.keySet().stream().allMatch(t -> t.startsWith(\"_\"));\n+\t\tif (haveNoIndexSearchParams) {", "originalCommit": "04e9a0ae81061458b70f1f1866af9b7f432828f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY4NTcyMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1761#discussion_r393685723", "bodyText": "Tx!", "author": "jamesagnew", "createdAt": "2020-03-17T13:39:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMzQ0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMzY4OA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1761#discussion_r393233688", "bodyText": "the logging part can be probably be removed for the merge", "author": "tadgh", "createdAt": "2020-03-16T18:34:18Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java", "diffHunk": "@@ -1064,7 +1065,9 @@ public void testSearchByIdParam() {\n \n \t\tparams = new SearchParameterMap();\n \t\tparams.add(\"_id\", new StringParam(id1));\n+\t\tmyCaptureQueriesListener.clear();\n \t\tassertThat(toUnqualifiedVersionlessIdValues(myPatientDao.search(params)), contains(id1));\n+\t\tmyCaptureQueriesListener.logSelectQueriesForCurrentThread();", "originalCommit": "04e9a0ae81061458b70f1f1866af9b7f432828f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ce0f334ec98248d35650e9b27cc62b5eee48083", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\nindex dbca2965ba..22760f3d62 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4SearchNoFtTest.java\n\n@@ -1065,9 +1065,7 @@ public class FhirResourceDaoR4SearchNoFtTest extends BaseJpaR4Test {\n \n \t\tparams = new SearchParameterMap();\n \t\tparams.add(\"_id\", new StringParam(id1));\n-\t\tmyCaptureQueriesListener.clear();\n \t\tassertThat(toUnqualifiedVersionlessIdValues(myPatientDao.search(params)), contains(id1));\n-\t\tmyCaptureQueriesListener.logSelectQueriesForCurrentThread();\n \n \t\tparams = new SearchParameterMap();\n \t\tparams.add(\"_id\", new StringParam(\"9999999999999999\"));\n"}}, {"oid": "1ce0f334ec98248d35650e9b27cc62b5eee48083", "url": "https://github.com/hapifhir/hapi-fhir/commit/1ce0f334ec98248d35650e9b27cc62b5eee48083", "message": "Address review comments", "committedDate": "2020-03-17T14:59:39Z", "type": "commit"}]}