{"pr_number": 1933, "pr_title": "Fix ValueSet$expand with offset and count parameters.", "pr_createdAt": "2020-06-22T20:58:25Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1933", "timeline": [{"oid": "314df430913f1e2d269a482aabc0701ee8a3be6f", "url": "https://github.com/hapifhir/hapi-fhir/commit/314df430913f1e2d269a482aabc0701ee8a3be6f", "message": "BaseValidationSupportWrapper.expandValueSet(...) and ValidationSupportChain.expandValueSet(...) were incorrectly replacing expansion options (i.e. offset and count) with null.", "committedDate": "2020-06-22T20:52:52Z", "type": "commit"}, {"oid": "ced376f7ba0ecfa14003d58beb0914a474227b96", "url": "https://github.com/hapifhir/hapi-fhir/commit/ced376f7ba0ecfa14003d58beb0914a474227b96", "message": "Add changelog entry; fix typo.", "committedDate": "2020-06-22T21:02:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNDgxNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1933#discussion_r443824817", "bodyText": "I think a better assert here would be to test that expanded.getContains().size() has a size of 1", "author": "jamesagnew", "createdAt": "2020-06-22T21:03:22Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r5/ResourceProviderR5ValueSetTest.java", "diffHunk": "@@ -301,6 +301,122 @@ public void testExpandByIdWithPreExpansion() throws Exception {\n \n \t}\n \n+\t@Test\n+\tpublic void testExpandByIdWithPreExpansionWithOffset() throws Exception {\n+\t\tmyDaoConfig.setPreExpandValueSets(true);\n+\n+\t\tloadAndPersistCodeSystemAndValueSet(HTTPVerb.POST);\n+\t\tmyTermSvc.preExpandDeferredValueSetsToTerminologyTables();\n+\n+\t\tParameters respParam = ourClient\n+\t\t\t.operation()\n+\t\t\t.onInstance(myExtensionalVsId)\n+\t\t\t.named(\"expand\")\n+\t\t\t.withParameter(Parameters.class, \"offset\", new IntegerType(1))\n+\t\t\t.execute();\n+\t\tValueSet expanded = (ValueSet) respParam.getParameter().get(0).getResource();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(expanded);\n+\t\tourLog.info(resp);\n+\t\tassertThat(resp, stringContainsInOrder(\n+\t\t\t\"<total value=\\\"24\\\"/>\\n\",\n+\t\t\t\"<offset value=\\\"1\\\"/>\\n\",\n+\t\t\t\"<parameter>\\n\",\n+\t\t\t\"<name value=\\\"offset\\\"/>\\n\",\n+\t\t\t\"<valueInteger value=\\\"1\\\"/>\\n\",\n+\t\t\t\"</parameter>\\n\",\n+\t\t\t\"<parameter>\\n\",\n+\t\t\t\"<name value=\\\"count\\\"/>\\n\",\n+\t\t\t\"<valueInteger value=\\\"1000\\\"/>\\n\",\n+\t\t\t\"</parameter>\\n\",\n+\t\t\t\"<contains>\\n\",\n+\t\t\t\"<system value=\\\"http://acme.org\\\"/>\\n\",\n+\t\t\t\"<code value=\\\"11378-7\\\"/>\\n\",\n+\t\t\t\"<display value=\\\"Systolic blood pressure at First encounter\\\"/>\\n\",\n+\t\t\t\"</contains>\\n\",\n+\t\t\t\"<contains>\\n\",\n+\t\t\t\"<system value=\\\"http://acme.org\\\"/>\\n\",\n+\t\t\t\"<code value=\\\"8493-9\\\"/>\\n\",\n+\t\t\t\"<display value=\\\"Systolic blood pressure 10 hour minimum\\\"/>\\n\",\n+\t\t\t\"</contains>\"));\n+\n+\t}\n+\n+\t@Test\n+\tpublic void testExpandByIdWithPreExpansionWithCount() throws Exception {\n+\t\tmyDaoConfig.setPreExpandValueSets(true);\n+\n+\t\tloadAndPersistCodeSystemAndValueSet(HTTPVerb.POST);\n+\t\tmyTermSvc.preExpandDeferredValueSetsToTerminologyTables();\n+\n+\t\tParameters respParam = ourClient\n+\t\t\t.operation()\n+\t\t\t.onInstance(myExtensionalVsId)\n+\t\t\t.named(\"expand\")\n+\t\t\t.withParameter(Parameters.class, \"count\", new IntegerType(1))\n+\t\t\t.execute();\n+\t\tValueSet expanded = (ValueSet) respParam.getParameter().get(0).getResource();\n+\n+\t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(expanded);\n+\t\tourLog.info(resp);\n+\t\tassertThat(resp, stringContainsInOrder(", "originalCommit": "314df430913f1e2d269a482aabc0701ee8a3be6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNDMwMg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1933#discussion_r443834302", "bodyText": "Agreed. I wrote those tests to be similar to the other tests in that class. I've since improved the new tests; however, I haven't gone back to change all of the old tests.", "author": "dmuylwyk", "createdAt": "2020-06-22T21:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNDgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "ce0cb8916eda93b730e0bb787f60c9b977049a7f", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r5/ResourceProviderR5ValueSetTest.java b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r5/ResourceProviderR5ValueSetTest.java\nindex 905713fe25..58a6bf69e5 100644\n--- a/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r5/ResourceProviderR5ValueSetTest.java\n+++ b/hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/provider/r5/ResourceProviderR5ValueSetTest.java\n\n@@ -318,27 +318,20 @@ public class ResourceProviderR5ValueSetTest extends BaseResourceProviderR5Test {\n \n \t\tString resp = myFhirCtx.newXmlParser().setPrettyPrint(true).encodeResourceToString(expanded);\n \t\tourLog.info(resp);\n-\t\tassertThat(resp, stringContainsInOrder(\n-\t\t\t\"<total value=\\\"24\\\"/>\\n\",\n-\t\t\t\"<offset value=\\\"1\\\"/>\\n\",\n-\t\t\t\"<parameter>\\n\",\n-\t\t\t\"<name value=\\\"offset\\\"/>\\n\",\n-\t\t\t\"<valueInteger value=\\\"1\\\"/>\\n\",\n-\t\t\t\"</parameter>\\n\",\n-\t\t\t\"<parameter>\\n\",\n-\t\t\t\"<name value=\\\"count\\\"/>\\n\",\n-\t\t\t\"<valueInteger value=\\\"1000\\\"/>\\n\",\n-\t\t\t\"</parameter>\\n\",\n-\t\t\t\"<contains>\\n\",\n-\t\t\t\"<system value=\\\"http://acme.org\\\"/>\\n\",\n-\t\t\t\"<code value=\\\"11378-7\\\"/>\\n\",\n-\t\t\t\"<display value=\\\"Systolic blood pressure at First encounter\\\"/>\\n\",\n-\t\t\t\"</contains>\\n\",\n-\t\t\t\"<contains>\\n\",\n-\t\t\t\"<system value=\\\"http://acme.org\\\"/>\\n\",\n-\t\t\t\"<code value=\\\"8493-9\\\"/>\\n\",\n-\t\t\t\"<display value=\\\"Systolic blood pressure 10 hour minimum\\\"/>\\n\",\n-\t\t\t\"</contains>\"));\n+\n+\t\tassertEquals(24, expanded.getExpansion().getTotal());\n+\t\tassertEquals(1, expanded.getExpansion().getOffset());\n+\t\tassertEquals(\"offset\", expanded.getExpansion().getParameter().get(0).getName());\n+\t\tassertEquals(1, expanded.getExpansion().getParameter().get(0).getValueIntegerType().getValue().intValue());\n+\t\tassertEquals(\"count\", expanded.getExpansion().getParameter().get(1).getName());\n+\t\tassertEquals(1000, expanded.getExpansion().getParameter().get(1).getValueIntegerType().getValue().intValue());\n+\t\tassertEquals(23, expanded.getExpansion().getContains().size());\n+\t\tassertEquals(\"http://acme.org\", expanded.getExpansion().getContains().get(0).getSystem());\n+\t\tassertEquals(\"11378-7\", expanded.getExpansion().getContains().get(0).getCode());\n+\t\tassertEquals(\"Systolic blood pressure at First encounter\", expanded.getExpansion().getContains().get(0).getDisplay());\n+\t\tassertEquals(\"http://acme.org\", expanded.getExpansion().getContains().get(1).getSystem());\n+\t\tassertEquals(\"8493-9\", expanded.getExpansion().getContains().get(1).getCode());\n+\t\tassertEquals(\"Systolic blood pressure 10 hour minimum\", expanded.getExpansion().getContains().get(1).getDisplay());\n \n \t}\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNjY1OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1933#discussion_r443826659", "bodyText": "doh.....", "author": "jamesagnew", "createdAt": "2020-06-22T21:07:12Z", "path": "hapi-fhir-validation/src/main/java/org/hl7/fhir/common/hapi/validation/support/BaseValidationSupportWrapper.java", "diffHunk": "@@ -70,7 +70,7 @@ public boolean isValueSetSupported(ValidationSupportContext theValidationSupport\n \n \t@Override\n \tpublic IValidationSupport.ValueSetExpansionOutcome expandValueSet(ValidationSupportContext theValidationSupportContext, ValueSetExpansionOptions theExpansionOptions, IBaseResource theValueSetToExpand) {\n-\t\treturn myWrap.expandValueSet(theValidationSupportContext, null, theValueSetToExpand);\n+\t\treturn myWrap.expandValueSet(theValidationSupportContext, theExpansionOptions, theValueSetToExpand);", "originalCommit": "314df430913f1e2d269a482aabc0701ee8a3be6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNDc1Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1933#discussion_r443834752", "bodyText": "Mistakes happen. : )\nI'm surprised we didn't already have tests for the offset and count parameters. \u00af_(\u30c4)_/\u00af", "author": "dmuylwyk", "createdAt": "2020-06-22T21:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgyNjY1OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ce0cb8916eda93b730e0bb787f60c9b977049a7f", "url": "https://github.com/hapifhir/hapi-fhir/commit/ce0cb8916eda93b730e0bb787f60c9b977049a7f", "message": "Improve tests.", "committedDate": "2020-06-22T21:22:21Z", "type": "commit"}]}