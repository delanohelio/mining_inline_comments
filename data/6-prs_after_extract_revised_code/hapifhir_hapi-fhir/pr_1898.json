{"pr_number": 1898, "pr_title": "Empi 58 no match create person", "pr_createdAt": "2020-06-04T18:02:58Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1898", "timeline": [{"oid": "b1e4a935c4eacf0860907b18c77c9877518695d9", "url": "https://github.com/hapifhir/hapi-fhir/commit/b1e4a935c4eacf0860907b18c77c9877518695d9", "message": "done", "committedDate": "2020-06-04T17:58:41Z", "type": "commit"}, {"oid": "a77f495285345e8ac0e263bd2243c23c108ce327", "url": "https://github.com/hapifhir/hapi-fhir/commit/a77f495285345e8ac0e263bd2243c23c108ce327", "message": "pre-review cleanup", "committedDate": "2020-06-04T18:01:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0ODUzNg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435448536", "bodyText": "Does this nullable annotation provide us anything here? Normally I see these on the surface of the API, not inside the impl.", "author": "tadgh", "createdAt": "2020-06-04T18:04:39Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/EmpiLinkDaoSvc.java", "diffHunk": "@@ -192,4 +193,14 @@ public EmpiLink save(EmpiLink theEmpiLink) {\n    public List<EmpiLink> findEmpiLinkByExample(Example<EmpiLink> theExampleLink) {\n \t\treturn myEmpiLinkDao.findAll(theExampleLink);\n    }\n+\n+\tpublic List<EmpiLink> findEmpiLinksByTarget(Patient theTargetResource) {\n+\t\t@Nullable Long pid = myIdHelperService.getPidOrNull(theTargetResource);", "originalCommit": "a77f495285345e8ac0e263bd2243c23c108ce327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NDA5OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435484099", "bodyText": "Done", "author": "fil512", "createdAt": "2020-06-04T18:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0ODUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "60f0f4353351b918a3aedd256e25def8ef2f1e2d", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/EmpiLinkDaoSvc.java b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/EmpiLinkDaoSvc.java\nindex 5480ae5a0a..8cf57e23bf 100644\n--- a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/EmpiLinkDaoSvc.java\n+++ b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/EmpiLinkDaoSvc.java\n\n@@ -195,7 +195,7 @@ public class EmpiLinkDaoSvc {\n    }\n \n \tpublic List<EmpiLink> findEmpiLinksByTarget(Patient theTargetResource) {\n-\t\t@Nullable Long pid = myIdHelperService.getPidOrNull(theTargetResource);\n+\t\tLong pid = myIdHelperService.getPidOrNull(theTargetResource);\n \t\tif (pid == null) {\n \t\t\treturn Collections.emptyList();\n \t\t}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ1ODczMQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435458731", "bodyText": "One thing I'm wondering with regards to transactionality. Are we sure the DB has flushed at this point? If not, is it possible that this call will just return the same existing link?", "author": "tadgh", "createdAt": "2020-06-04T18:21:58Z", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImpl.java", "diffHunk": "@@ -98,6 +82,33 @@ public IAnyResource updateLink(IAnyResource thePerson, IAnyResource theTarget, E\n \t\tmyEmpiLinkDaoSvc.save(empiLink);\n \t\tmyEmpiLinkSvc.syncEmpiLinksToPersonLinks(thePerson, theEmpiContext);\n \t\tmyEmpiResourceDaoSvc.updatePerson(thePerson);\n+\t\tif (theMatchResult == EmpiMatchResultEnum.NO_MATCH) {\n+\t\t\t// Need to find a new Person to link this target to\n+\t\t\tmyEmpiMatchLinkSvc.updateEmpiLinksForEmpiTarget(theTarget, theEmpiContext);", "originalCommit": "a77f495285345e8ac0e263bd2243c23c108ce327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NTMwNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435485307", "bodyText": "I wondered about the same thing.  All the tests pass.  Hibernate keeps active entities in session so since we\u2019re on the same thread, any entity reads on the modified entities should pick up the changes.  Leaving Tx boundary unchanged.", "author": "fil512", "createdAt": "2020-06-04T19:01:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ1ODczMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NDA5Nw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435464097", "bodyText": "\ud83d\udc4d for breaking this into its own function", "author": "tadgh", "createdAt": "2020-06-04T18:28:39Z", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImpl.java", "diffHunk": "@@ -98,6 +82,33 @@ public IAnyResource updateLink(IAnyResource thePerson, IAnyResource theTarget, E\n \t\tmyEmpiLinkDaoSvc.save(empiLink);\n \t\tmyEmpiLinkSvc.syncEmpiLinksToPersonLinks(thePerson, theEmpiContext);\n \t\tmyEmpiResourceDaoSvc.updatePerson(thePerson);\n+\t\tif (theMatchResult == EmpiMatchResultEnum.NO_MATCH) {\n+\t\t\t// Need to find a new Person to link this target to\n+\t\t\tmyEmpiMatchLinkSvc.updateEmpiLinksForEmpiTarget(theTarget, theEmpiContext);\n+\t\t}\n \t\treturn thePerson;\n \t}\n+\n+\tprivate void validateUpdateLinkRequest(IAnyResource thePerson, IAnyResource theTarget, EmpiMatchResultEnum theMatchResult, String theTargetType) {\n+\t\tString personType = myFhirContext.getResourceType(thePerson);\n+\t\tif (theMatchResult != EmpiMatchResultEnum.NO_MATCH &&\n+\t\ttheMatchResult != EmpiMatchResultEnum.MATCH) {\n+\t\t\tthrow new InvalidRequestException(\"Match Result may only be set to \" + EmpiMatchResultEnum.NO_MATCH + \" or \" + EmpiMatchResultEnum.MATCH);\n+\t\t}\n+\n+\t\tif (!\"Person\".equals(personType)) {\n+\t\t\tthrow new InvalidRequestException(\"First argument to updateLink must be a Person.  Was \" + personType);\n+\t\t}\n+\t\tif (!EmpiUtil.supportedTargetType(theTargetType)) {\n+\t\t\tthrow new InvalidRequestException(\"Second argument to updateLink must be a Patient or Practitioner.  Was \" + theTargetType);\n+\t\t}\n+\n+\t\tif (!EmpiUtil.isEmpiManaged(thePerson)) {\n+\t\t\tthrow new InvalidRequestException(\"Only EMPI Managed Person resources may be updated via this operation.  The Person resource provided is not tagged as managed by hapi-empi\");\n+\t\t}\n+\n+\t\tif (!EmpiUtil.isEmpiAccessible(theTarget)) {\n+\t\t\tthrow new InvalidRequestException(\"The target is marked with the \" + EmpiConstants.CODE_NO_EMPI_MANAGED + \" tag which means it may not be EMPI linked.\");\n+\t\t}\n+\t}", "originalCommit": "a77f495285345e8ac0e263bd2243c23c108ce327", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NDM5MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435464390", "bodyText": "TODO?", "author": "tadgh", "createdAt": "2020-06-04T18:28:59Z", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImplTest.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package ca.uhn.fhir.jpa.empi.svc;\n+\n+import ca.uhn.fhir.jpa.empi.provider.EmpiProviderUpdateLinkR4Test;\n+\n+/**\n+ * @see EmpiProviderUpdateLinkR4Test\n+ */\n+public class EmpiLinkUpdaterSvcImplTest {", "originalCommit": "a77f495285345e8ac0e263bd2243c23c108ce327", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NTkzMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435465933", "bodyText": "I guess my comment was unclear.  I will improve.", "author": "fil512", "createdAt": "2020-06-04T18:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NDM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4NjY3Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1898#discussion_r435486672", "bodyText": "Done", "author": "fil512", "createdAt": "2020-06-04T19:03:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ2NDM5MA=="}], "type": "inlineReview", "revised_code": {"commit": "1e2ff81316d717d9937e6d2daa17d662ddf8e0cb", "chunk": "diff --git a/hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImplTest.java b/hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImplTest.java\nindex 34494daa74..3e812f48de 100644\n--- a/hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImplTest.java\n+++ b/hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiLinkUpdaterSvcImplTest.java\n\n@@ -3,6 +3,7 @@ package ca.uhn.fhir.jpa.empi.svc;\n import ca.uhn.fhir.jpa.empi.provider.EmpiProviderUpdateLinkR4Test;\n \n /**\n+ * Tests for this service are in the test for the provider that wraps this service:\n  * @see EmpiProviderUpdateLinkR4Test\n  */\n public class EmpiLinkUpdaterSvcImplTest {\n"}}, {"oid": "60f0f4353351b918a3aedd256e25def8ef2f1e2d", "url": "https://github.com/hapifhir/hapi-fhir/commit/60f0f4353351b918a3aedd256e25def8ef2f1e2d", "message": "review feedback", "committedDate": "2020-06-04T18:58:53Z", "type": "commit"}, {"oid": "1e2ff81316d717d9937e6d2daa17d662ddf8e0cb", "url": "https://github.com/hapifhir/hapi-fhir/commit/1e2ff81316d717d9937e6d2daa17d662ddf8e0cb", "message": "review feedback", "committedDate": "2020-06-04T19:03:38Z", "type": "commit"}]}