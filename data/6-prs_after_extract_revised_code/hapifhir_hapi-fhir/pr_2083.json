{"pr_number": 2083, "pr_title": "SearchCoordinatorSvcImpl gets ExecutorService from injected ThreadPoolTaskExecutor", "pr_createdAt": "2020-09-15T19:33:50Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2083", "timeline": [{"oid": "69d6f494387df3811a4c027c8798650482607836", "url": "https://github.com/hapifhir/hapi-fhir/commit/69d6f494387df3811a4c027c8798650482607836", "message": "Get ExecutorService from injected ThreadPoolTaskExecutor which enables support of TaskDecorators (e.g. to add/clear ThreadLocal logging context (MDC) variables)", "committedDate": "2020-09-15T19:20:46Z", "type": "commit"}, {"oid": "aecbfff59dcc245ceb876d3b64593922063c8aea", "url": "https://github.com/hapifhir/hapi-fhir/commit/aecbfff59dcc245ceb876d3b64593922063c8aea", "message": "Properly initialize ThreadPoolTaskExecutor", "committedDate": "2020-09-16T11:39:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM3MTUzOA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2083#discussion_r616371538", "bodyText": "I think this accidentally changes the way thread pool was working before. According to javadoc this acts similar to single thread executor (because core pool size is 1 and queue is unbounded -> it won't increase the thread count). This default leads to pretty large performance degradation because all searches are ran with the same thread. Before this change SearchCoordinatorSvcImpl used unbounded thread pool that always immediately created a new thread.\nhttps://www.baeldung.com/java-threadpooltaskexecutor-core-vs-max-poolsize (and also note the reject policy if queue is full and pool is in maximum)\nping @jamesagnew\nAt least I think this should be documented that the thread pool is now acting differently and may need configuration.", "author": "tuomoa", "createdAt": "2021-04-20T06:12:03Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/config/BaseConfig.java", "diffHunk": "@@ -262,6 +262,14 @@ public ISearchResultCacheSvc searchResultCacheSvc() {\n \t\treturn new DatabaseSearchResultCacheSvcImpl();\n \t}\n \n+\t@Bean\n+\tpublic ThreadPoolTaskExecutor searchCoordinatorThreadFactory() {\n+\t\tfinal ThreadPoolTaskExecutor threadPoolTaskExecutor = new ThreadPoolTaskExecutor();", "originalCommit": "aecbfff59dcc245ceb876d3b64593922063c8aea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjQ2NTI5NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2083#discussion_r616465294", "bodyText": "Oh, nicely spotted. This is unintended (not something I was aware of when making this PR).\nPlease feel free to make a new PR that fixes this, restoring the original ExecutorService functionality, but still as a Spring ThreadPoolTaskExecutor (such that TaskDecorators can still be used)", "author": "ttntrifork", "createdAt": "2021-04-20T08:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNjM3MTUzOA=="}], "type": "inlineReview", "revised_code": null}]}