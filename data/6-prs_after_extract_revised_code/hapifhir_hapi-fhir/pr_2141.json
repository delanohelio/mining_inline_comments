{"pr_number": 2141, "pr_title": "Enable package installer to load non-Conformance resources", "pr_createdAt": "2020-10-21T19:49:47Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2141", "timeline": [{"oid": "756432e61ac60b3ee2e3924a92838f4a0d5b3350", "url": "https://github.com/hapifhir/hapi-fhir/commit/756432e61ac60b3ee2e3924a92838f4a0d5b3350", "message": "Enable package installer to load resources other than conformance resources.", "committedDate": "2020-10-21T19:47:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NzcwNg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2141#discussion_r509657706", "bodyText": "You should probably deal with the null case here (and maybe also rename that \"my\" variable since it's not a field) - I'm not actually sure what would happen here in the case of something that didn't have a URL or an identifier, but it's probably safe to just not upload it in that case.", "author": "jamesagnew", "createdAt": "2020-10-21T20:17:16Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/PackageInstallerSvcImpl.java", "diffHunk": "@@ -412,6 +419,22 @@ private String extractUniqueUrlFromMetadataResource(IBaseResource resource) {\n \t\treturn (String) asPrimitiveType.getValue();\n \t}\n \n+\tprivate TokenParam extractIdentifierFromOtherResourceTypes(IBaseResource resource) {\n+\t\tFhirTerser terser = myFhirContext.newTerser();\n+\t\tIdentifier myIdentifier = (Identifier) terser.getSingleValueOrNull(resource, \"identifier\");", "originalCommit": "756432e61ac60b3ee2e3924a92838f4a0d5b3350", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcxNzg1OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2141#discussion_r509717859", "bodyText": "Good point. I have changed this to throw an UnsupportedOperationException if the resource has no identifier and added a corresponding JUnit test for this case.", "author": "IanMMarshall", "createdAt": "2020-10-21T21:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY1NzcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "115b09e4d4dd0bc0bbc0a97444f98b28f0bd0996", "chunk": "diff --git a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/PackageInstallerSvcImpl.java b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/PackageInstallerSvcImpl.java\nindex 4cb69ff28d..0433f4da73 100644\n--- a/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/PackageInstallerSvcImpl.java\n+++ b/hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/packages/PackageInstallerSvcImpl.java\n\n@@ -421,8 +421,12 @@ public class PackageInstallerSvcImpl implements IPackageInstallerSvc {\n \n \tprivate TokenParam extractIdentifierFromOtherResourceTypes(IBaseResource resource) {\n \t\tFhirTerser terser = myFhirContext.newTerser();\n-\t\tIdentifier myIdentifier = (Identifier) terser.getSingleValueOrNull(resource, \"identifier\");\n-\t\treturn new TokenParam(myIdentifier.getSystem(), myIdentifier.getValue());\n+\t\tIdentifier identifier = (Identifier) terser.getSingleValueOrNull(resource, \"identifier\");\n+\t\tif (identifier != null) {\n+\t\t\treturn new TokenParam(identifier.getSystem(), identifier.getValue());\n+\t\t} else {\n+\t\t\tthrow new UnsupportedOperationException(\"Resources in a package must have a url or identifier to be loaded by the package installer.\");\n+\t\t}\n \t}\n \n \tprivate boolean resourceHasUrlElement(IBaseResource resource) {\n"}}, {"oid": "830ad700898a1076b0d16674b9eba3b92b54bb56", "url": "https://github.com/hapifhir/hapi-fhir/commit/830ad700898a1076b0d16674b9eba3b92b54bb56", "message": "Add changelog for package installer enhancement.", "committedDate": "2020-10-21T20:18:10Z", "type": "commit"}, {"oid": "115b09e4d4dd0bc0bbc0a97444f98b28f0bd0996", "url": "https://github.com/hapifhir/hapi-fhir/commit/115b09e4d4dd0bc0bbc0a97444f98b28f0bd0996", "message": "Throw exception if any resources in package have no url and no identifier.", "committedDate": "2020-10-21T21:23:40Z", "type": "commit"}]}