{"pr_number": 1997, "pr_title": "Allow empty candidateSearchParams in EMPI module config. ", "pr_createdAt": "2020-07-24T01:08:38Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1997", "timeline": [{"oid": "6a5b96d05f03e91f8a61cf9575b3e6293ef0f401", "url": "https://github.com/hapifhir/hapi-fhir/commit/6a5b96d05f03e91f8a61cf9575b3e6293ef0f401", "message": "Start with broken test for #1996", "committedDate": "2020-07-23T22:52:12Z", "type": "commit"}, {"oid": "2da64119bb2f171bd7c46faa49f1175c0bb028d4", "url": "https://github.com/hapifhir/hapi-fhir/commit/2da64119bb2f171bd7c46faa49f1175c0bb028d4", "message": "Resolve issue with test", "committedDate": "2020-07-24T00:28:20Z", "type": "commit"}, {"oid": "698b18eb2f8a841f45dae03f1f5db0b36bbe5a8d", "url": "https://github.com/hapifhir/hapi-fhir/commit/698b18eb2f8a841f45dae03f1f5db0b36bbe5a8d", "message": "Fix NPE in iterator, fix empi-rules.json, add extra tests", "committedDate": "2020-07-24T01:01:08Z", "type": "commit"}, {"oid": "31d0ed3ac19b5ef5ba777e1009bfa49dfa49e1f7", "url": "https://github.com/hapifhir/hapi-fhir/commit/31d0ed3ac19b5ef5ba777e1009bfa49dfa49e1f7", "message": "remove question, put in PR instead", "committedDate": "2020-07-24T01:09:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE2NjU4NQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1997#discussion_r460166585", "bodyText": "this doesn't look right to me.  if there are no criteria, then we still need to add the filter to cover the case where there is a filter but no criteria", "author": "fil512", "createdAt": "2020-07-24T16:41:19Z", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchCriteriaBuilderSvc.java", "diffHunk": "@@ -43,19 +44,25 @@\n \t * Patient?active=true&name.given=Gary,Grant&name.family=Graham\n \t */\n \t@Nonnull\n-\tpublic Optional<String> buildResourceQueryString(String theResourceType, IAnyResource theResource, List<String> theFilterCriteria, EmpiResourceSearchParamJson resourceSearchParam) {\n+\tpublic Optional<String> buildResourceQueryString(String theResourceType, IAnyResource theResource, List<String> theFilterCriteria, @Nullable EmpiResourceSearchParamJson resourceSearchParam) {\n \t\tList<String> criteria = new ArrayList<>();\n \n-\t\tresourceSearchParam.iterator().forEachRemaining(searchParam -> {\n-\t\t\t//to compare it to all known PERSON objects, using the overlapping search parameters that they have.\n-\t\t\tList<String> valuesFromResourceForSearchParam = myEmpiSearchParamSvc.getValueFromResourceForSearchParam(theResource, searchParam);\n-\t\t\tif (!valuesFromResourceForSearchParam.isEmpty()) {\n-\t\t\t\tcriteria.add(buildResourceMatchQuery(searchParam, valuesFromResourceForSearchParam));\n+\t\t// If there are candidate search params, then make use of them, otherwise, search with only the filters.\n+\t\tif (resourceSearchParam != null) {\n+\t\t\tresourceSearchParam.iterator().forEachRemaining(searchParam -> {\n+\t\t\t\t//to compare it to all known PERSON objects, using the overlapping search parameters that they have.\n+\t\t\t\tList<String> valuesFromResourceForSearchParam = myEmpiSearchParamSvc.getValueFromResourceForSearchParam(theResource, searchParam);\n+\t\t\t\tif (!valuesFromResourceForSearchParam.isEmpty()) {\n+\t\t\t\t\tcriteria.add(buildResourceMatchQuery(searchParam, valuesFromResourceForSearchParam));\n+\t\t\t\t}\n+\t\t\t});\n+\n+\t\t\tif (criteria.isEmpty()) {", "originalCommit": "31d0ed3ac19b5ef5ba777e1009bfa49dfa49e1f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3NDE3Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1997#discussion_r460174173", "bodyText": "This isn't that case. This logical block says:  If there are candidate search params, but the resource has no value for any of them, leave early. That's what this block is doing. The case where there are no candidate search params is covered by the null check on L51", "author": "tadgh", "createdAt": "2020-07-24T16:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE2NjU4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5Nzg2NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1997#discussion_r460197864", "bodyText": "I've removed the null check and instead just do an emptiness check", "author": "tadgh", "createdAt": "2020-07-24T17:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE2NjU4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "7fd690f83005c0c56ef4f74e598a512678c9bd99", "chunk": "diff --git a/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchCriteriaBuilderSvc.java b/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchCriteriaBuilderSvc.java\nindex 6185f76287..b2e033b60b 100644\n--- a/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchCriteriaBuilderSvc.java\n+++ b/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchCriteriaBuilderSvc.java\n\n@@ -56,7 +56,6 @@ public class EmpiCandidateSearchCriteriaBuilderSvc {\n \t\t\t\t\tcriteria.add(buildResourceMatchQuery(searchParam, valuesFromResourceForSearchParam));\n \t\t\t\t}\n \t\t\t});\n-\n \t\t\tif (criteria.isEmpty()) {\n \t\t\t\t//TODO GGG/KHS, re-evaluate whether we should early drop here.\n \t\t\t\treturn Optional.empty();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE2Njg4OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1997#discussion_r460166889", "bodyText": "is it possible for candidateSearchParams to ever be null?  I thought we validated this on json deserialization, but I could be wrong.", "author": "fil512", "createdAt": "2020-07-24T16:41:54Z", "path": "hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchSvc.java", "diffHunk": "@@ -75,18 +75,23 @@ public EmpiCandidateSearchSvc() {\n \t */\n \tpublic Collection<IAnyResource> findCandidates(String theResourceType, IAnyResource theResource) {\n \t\tMap<Long, IAnyResource> matchedPidsToResources = new HashMap<>();\n-\n \t\tList<EmpiFilterSearchParamJson> filterSearchParams = myEmpiConfig.getEmpiRules().getCandidateFilterSearchParams();\n-\n \t\tList<String> filterCriteria = buildFilterQuery(filterSearchParams, theResourceType);\n+\t\tList<EmpiResourceSearchParamJson> candidateSearchParams = myEmpiConfig.getEmpiRules().getCandidateSearchParams();\n \n-\t\tfor (EmpiResourceSearchParamJson resourceSearchParam : myEmpiConfig.getEmpiRules().getCandidateSearchParams()) {\n+\t\t//If there are zero EmpiResourceSearchParamJson, we end up only making a single search, otherwise we\n+\t\t//must perform one search per EmpiResourceSearchParamJson.\n+\t\tif (candidateSearchParams == null || candidateSearchParams.isEmpty()) {", "originalCommit": "31d0ed3ac19b5ef5ba777e1009bfa49dfa49e1f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7fd690f83005c0c56ef4f74e598a512678c9bd99", "chunk": "diff --git a/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchSvc.java b/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchSvc.java\nindex ab6afb332c..bae3f51844 100644\n--- a/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchSvc.java\n+++ b/hapi-fhir-jpaserver-empi/src/main/java/ca/uhn/fhir/jpa/empi/svc/candidate/EmpiCandidateSearchSvc.java\n\n@@ -81,7 +81,7 @@ public class EmpiCandidateSearchSvc {\n \n \t\t//If there are zero EmpiResourceSearchParamJson, we end up only making a single search, otherwise we\n \t\t//must perform one search per EmpiResourceSearchParamJson.\n-\t\tif (candidateSearchParams == null || candidateSearchParams.isEmpty()) {\n+\t\tif (candidateSearchParams.isEmpty()) {\n \t\t\tsearchForIdsAndAddToMap(theResourceType, theResource, matchedPidsToResources, filterCriteria, null);\n \t\t} else {\n \t\t\tfor (EmpiResourceSearchParamJson resourceSearchParam : candidateSearchParams) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MTAyMA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1997#discussion_r460171020", "bodyText": "these two tests definitely seem to cover the key issue", "author": "fil512", "createdAt": "2020-07-24T16:49:33Z", "path": "hapi-fhir-jpaserver-empi/src/test/java/ca/uhn/fhir/jpa/empi/svc/EmpiCandidateSearchCriteriaBuilderSvcTest.java", "diffHunk": "@@ -67,4 +69,21 @@ public void testIdentifier() {\n \t\tassertTrue(result.isPresent());\n \t\tassertEquals(result.get(), \"Patient?identifier=urn:oid:1.2.36.146.595.217.0.1|12345\");\n \t}\n+\n+\t@Test\n+\tpublic void testOmittingCandidateSearchParamsIsAllowed() {", "originalCommit": "31d0ed3ac19b5ef5ba777e1009bfa49dfa49e1f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "7fd690f83005c0c56ef4f74e598a512678c9bd99", "url": "https://github.com/hapifhir/hapi-fhir/commit/7fd690f83005c0c56ef4f74e598a512678c9bd99", "message": "Add test in provider with different empi json rules", "committedDate": "2020-07-24T17:42:21Z", "type": "commit"}, {"oid": "df6f028768f526b248bdcc142e69fbea1efd201c", "url": "https://github.com/hapifhir/hapi-fhir/commit/df6f028768f526b248bdcc142e69fbea1efd201c", "message": "It is allowed to have empty candidate search params, so validator test is, ironically, invalid", "committedDate": "2020-07-24T18:52:32Z", "type": "commit"}]}