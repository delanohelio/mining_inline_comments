{"pr_number": 2236, "pr_title": "Add support for unregistering components in the IResourceProviderFactory", "pr_createdAt": "2020-12-11T21:32:02Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2236", "timeline": [{"oid": "9ef3f90773c28f7c9335d3356604652b7a3ceb7e", "url": "https://github.com/hapifhir/hapi-fhir/commit/9ef3f90773c28f7c9335d3356604652b7a3ceb7e", "message": "Initial implementation", "committedDate": "2020-12-11T21:29:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQwOTM3Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2236#discussion_r541409373", "bodyText": "This change looks good, but I have one overall question/comment that I'm adding here for no particular reason.\nYou have a bunch of these MDM Providers for various versions of FHIR. This is a pattern that is used in HAPI FHIR a lot, but we're using it less these days as it's very often possible to create a generic provider that handles all versions of FHIR. See BaseJpaSystemProviderDstu2Plus for an example, which supplies the $mark-all-resources-for-reindexing operation to all versions of FHIR.\nThis approach wasn't possible for a long time which is why it's uncommon in HAPI FHIR, but for anything newer I always try to at least question whether what I'm doing could be written in a cross-version way.\nCan these providers work this way?", "author": "jamesagnew", "createdAt": "2020-12-11T23:28:15Z", "path": "hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/provider/MdmProviderLoader.java", "diffHunk": "@@ -45,17 +47,30 @@\n \t@Autowired\n \tprivate IMdmSubmitSvc myMdmSubmitSvc;\n \n+\tprivate BaseMdmProvider myMdmProvider;\n+\n \tpublic void loadProvider() {\n \t\tswitch (myFhirContext.getVersion().getVersion()) {\n \t\t\tcase DSTU3:\n-\t\t\t\tmyResourceProviderFactory.addSupplier(() -> new MdmProviderDstu3(myFhirContext, myMdmControllerSvc, myMdmMatchFinderSvc, myMdmExpungeSvc, myMdmSubmitSvc));\n+\t\t\t\tmyResourceProviderFactory.addSupplier(() -> {", "originalCommit": "9ef3f90773c28f7c9335d3356604652b7a3ceb7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYxMTQ1OA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2236#discussion_r541611458", "bodyText": "These Providers mostly return Bundles, which appear to be STU-Specific. Do we have something that is generic that could be returned here?", "author": "tadgh", "createdAt": "2020-12-12T15:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQwOTM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTkzNzA0MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2236#discussion_r541937041", "bodyText": "We have a class called TransactionBuilder that can build Bundle resources in a version independent way.\nIt's currently focused on building transaction bundles, but I could see us renaming it to BundleBuilder and adding for working with other types of Bundles. It already looks like it does much of what would be needed to replace the version-specific stuff in the MDM providers.. it'd need score and a few other attributes added presumably..", "author": "jamesagnew", "createdAt": "2020-12-13T14:32:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQwOTM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e0d9b155b6a9e5536c70e7e13d900937c3f61557", "chunk": "diff --git a/hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/provider/MdmProviderLoader.java b/hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/provider/MdmProviderLoader.java\nindex 585a1ca5e1..def9d43b36 100644\n--- a/hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/provider/MdmProviderLoader.java\n+++ b/hapi-fhir-server-mdm/src/main/java/ca/uhn/fhir/mdm/provider/MdmProviderLoader.java\n\n@@ -52,14 +52,9 @@ public class MdmProviderLoader {\n \tpublic void loadProvider() {\n \t\tswitch (myFhirContext.getVersion().getVersion()) {\n \t\t\tcase DSTU3:\n-\t\t\t\tmyResourceProviderFactory.addSupplier(() -> {\n-\t\t\t\t\tmyMdmProvider = new MdmProviderDstu3(myFhirContext, myMdmControllerSvc, myMdmMatchFinderSvc, myMdmExpungeSvc, myMdmSubmitSvc);\n-\t\t\t\t\treturn myMdmProvider;\n-\t\t\t\t});\n-\t\t\t\tbreak;\n \t\t\tcase R4:\n \t\t\t\tmyResourceProviderFactory.addSupplier(() -> {\n-\t\t\t\t\tmyMdmProvider = new MdmProviderR4(myFhirContext, myMdmControllerSvc, myMdmMatchFinderSvc, myMdmExpungeSvc, myMdmSubmitSvc);\n+\t\t\t\t\tmyMdmProvider = new MdmProviderDstu3Plus(myFhirContext, myMdmControllerSvc, myMdmMatchFinderSvc, myMdmExpungeSvc, myMdmSubmitSvc);\n \t\t\t\t\treturn myMdmProvider;\n \t\t\t\t});\n \t\t\t\tbreak;\n"}}, {"oid": "d41eb2c1357a4b5fe80cf89c6a47bcca329ca0e1", "url": "https://github.com/hapifhir/hapi-fhir/commit/d41eb2c1357a4b5fe80cf89c6a47bcca329ca0e1", "message": "Generic provider PoC", "committedDate": "2020-12-14T02:01:06Z", "type": "commit"}, {"oid": "d8f50690f21bad8eb76d62297762326869ac1f15", "url": "https://github.com/hapifhir/hapi-fhir/commit/d8f50690f21bad8eb76d62297762326869ac1f15", "message": "Refactored provider to use BundleBuilder", "committedDate": "2020-12-14T22:50:11Z", "type": "commit"}, {"oid": "e0d9b155b6a9e5536c70e7e13d900937c3f61557", "url": "https://github.com/hapifhir/hapi-fhir/commit/e0d9b155b6a9e5536c70e7e13d900937c3f61557", "message": "Removed version-specific MDM providers", "committedDate": "2020-12-15T00:51:30Z", "type": "commit"}, {"oid": "cdbcb4a3b59df2e4d55a49c3154e558ce854536c", "url": "https://github.com/hapifhir/hapi-fhir/commit/cdbcb4a3b59df2e4d55a49c3154e558ce854536c", "message": "Addressed code review comments", "committedDate": "2020-12-15T15:18:41Z", "type": "commit"}, {"oid": "a77f27886d5313671b1f61eacbfd19ea48b50dfe", "url": "https://github.com/hapifhir/hapi-fhir/commit/a77f27886d5313671b1f61eacbfd19ea48b50dfe", "message": "Merge branch 'revert-2223-revert-2177-gg_20201105-remove-person-references' into 2235_Add_support_for_unregistering_components_in_the_IResourceProviderFactory", "committedDate": "2020-12-15T15:40:55Z", "type": "commit"}, {"oid": "1320b1729fb4dde8278a9d0b10c1d657d1733abb", "url": "https://github.com/hapifhir/hapi-fhir/commit/1320b1729fb4dde8278a9d0b10c1d657d1733abb", "message": "Merge branch 'revert-2223-revert-2177-gg_20201105-remove-person-references' into 2235_Add_support_for_unregistering_components_in_the_IResourceProviderFactory", "committedDate": "2020-12-15T15:42:18Z", "type": "commit"}, {"oid": "3476b6825a402eb8dc10ec5f9aea04c7568fd3b3", "url": "https://github.com/hapifhir/hapi-fhir/commit/3476b6825a402eb8dc10ec5f9aea04c7568fd3b3", "message": "Fixed after merge", "committedDate": "2020-12-15T16:07:01Z", "type": "commit"}, {"oid": "cd8ad9ec2440614260f1e2c0f46933be45eb554a", "url": "https://github.com/hapifhir/hapi-fhir/commit/cd8ad9ec2440614260f1e2c0f46933be45eb554a", "message": "Fixed docs", "committedDate": "2020-12-15T18:51:17Z", "type": "commit"}]}