{"pr_number": 1693, "pr_title": "Changes to schema to loosen dependencies involving Forced ID table", "pr_createdAt": "2020-01-31T16:35:57Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1693", "timeline": [{"oid": "5d5b3d7639910e009a77cc8abdc6c2063e674d7c", "url": "https://github.com/hapifhir/hapi-fhir/commit/5d5b3d7639910e009a77cc8abdc6c2063e674d7c", "message": "Changes to schema to loosen dependencies between Forced ID table and the Resource and Resource History tables.", "committedDate": "2020-01-31T16:16:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMDIwNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1693#discussion_r380800205", "bodyText": "Can you merge master into this branch, and adjust this to put these tasks in a new init430 method with the current date on the tasks?", "author": "jamesagnew", "createdAt": "2020-02-18T16:49:40Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -61,6 +61,11 @@ public HapiFhirJpaMigrationTasks(Set<String> theFlags) {\n \n \tprotected void init420() { // 20191015 - present\n \t\tBuilder version = forVersion(VersionEnum.V4_2_0);\n+\n+\t\t// Eliminate circular dependency.\n+\t\tversion.onTable(\"HFJ_RESOURCE\").dropColumn(\"20200130.1\", \"FORCED_ID_PID\");\n+\t\tversion.onTable(\"HFJ_RES_VER\").dropColumn(\"20200130.2\", \"FORCED_ID_PID\");\n+\t\tversion.onTable(\"HFJ_RES_VER\").addForeignKey(\"20200130.3\", \"FK_RESOURCE_HISTORY_RESOURCE\").toColumn(\"RES_ID\").references(\"HFJ_RESOURCE\", \"RES_ID\");", "originalCommit": "5d5b3d7639910e009a77cc8abdc6c2063e674d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3ODI5Mw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1693#discussion_r380878293", "bodyText": "Done.", "author": "IanMMarshall", "createdAt": "2020-02-18T19:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMDIwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f7db280099f84a36d6ebef4fd09a4f82eaae3a45", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex 51667c1374..7638ed1b60 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -62,10 +62,12 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \tprotected void init420() { // 20191015 - present\n \t\tBuilder version = forVersion(VersionEnum.V4_2_0);\n \n-\t\t// Eliminate circular dependency.\n-\t\tversion.onTable(\"HFJ_RESOURCE\").dropColumn(\"20200130.1\", \"FORCED_ID_PID\");\n-\t\tversion.onTable(\"HFJ_RES_VER\").dropColumn(\"20200130.2\", \"FORCED_ID_PID\");\n-\t\tversion.onTable(\"HFJ_RES_VER\").addForeignKey(\"20200130.3\", \"FK_RESOURCE_HISTORY_RESOURCE\").toColumn(\"RES_ID\").references(\"HFJ_RESOURCE\", \"RES_ID\");\n+\t\t// TermValueSetConceptDesignation\n+\t\tversion.onTable(\"TRM_VALUESET_C_DESIGNATION\").dropIndex(\"20200202.1\", \"IDX_VALUESET_C_DSGNTN_VAL\").failureAllowed();\n+\t\tBuilder.BuilderWithTableName searchTable = version.onTable(\"HFJ_SEARCH\");\n+\t\tsearchTable.dropIndex(\"20200203.1\", \"IDX_SEARCH_LASTRETURNED\");\n+\t\tsearchTable.dropColumn(\"20200203.2\", \"SEARCH_LAST_RETURNED\");\n+\t\tsearchTable.addIndex(\"20200203.3\", \"IDX_SEARCH_CREATED\").unique(false).withColumns(\"CREATED\");\n \t}\n \n \tprotected void init410() { // 20190815 - 20191014\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMTg0MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1693#discussion_r380801840", "bodyText": "Overall comment- This could use a changelog.", "author": "jamesagnew", "createdAt": "2020-02-18T16:52:19Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/dao/expunge/ExpungeEverythingService.java", "diffHunk": "@@ -78,8 +78,6 @@ void expungeEverything(RequestDetails theRequest) {\n \t\tourLog.info(\"BEGINNING GLOBAL $expunge\");", "originalCommit": "5d5b3d7639910e009a77cc8abdc6c2063e674d7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3NzYwMA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1693#discussion_r380877600", "bodyText": "New changelog added.", "author": "IanMMarshall", "createdAt": "2020-02-18T19:11:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMTg0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg3ODQzOA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1693#discussion_r380878438", "bodyText": "New changelog added.", "author": "IanMMarshall", "createdAt": "2020-02-18T19:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMTg0MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f7db280099f84a36d6ebef4fd09a4f82eaae3a45", "url": "https://github.com/hapifhir/hapi-fhir/commit/f7db280099f84a36d6ebef4fd09a4f82eaae3a45", "message": "Merge remote-tracking branch 'remotes/origin/master' into im_20200131_remove_circular_dependency_forcedid\n\n# Conflicts:\n#\thapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "committedDate": "2020-02-18T17:13:00Z", "type": "commit"}, {"oid": "96d00f633cdba901031f6aa5a8edf84978bd10ab", "url": "https://github.com/hapifhir/hapi-fhir/commit/96d00f633cdba901031f6aa5a8edf84978bd10ab", "message": "Move new migration task to version 4.3.0.", "committedDate": "2020-02-18T19:09:17Z", "type": "commit"}, {"oid": "2f4f62b32eb18c9cb629b3cacb19b0426eaa9720", "url": "https://github.com/hapifhir/hapi-fhir/commit/2f4f62b32eb18c9cb629b3cacb19b0426eaa9720", "message": "Add change log for Resource and Resource History table changes.", "committedDate": "2020-02-18T19:09:59Z", "type": "commit"}]}