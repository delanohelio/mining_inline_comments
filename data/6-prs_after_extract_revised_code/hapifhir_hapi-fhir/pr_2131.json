{"pr_number": 2131, "pr_title": "delete expunge", "pr_createdAt": "2020-10-13T17:36:03Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2131", "timeline": [{"oid": "3c40659670e086a949d1741c38c9664bccbbab8d", "url": "https://github.com/hapifhir/hapi-fhir/commit/3c40659670e086a949d1741c38c9664bccbbab8d", "message": "delete expunge take 2.  start with failing test.", "committedDate": "2020-10-12T00:15:05Z", "type": "commit"}, {"oid": "e78da44ce3f30bd0632192579c8bf1f21c7a3885", "url": "https://github.com/hapifhir/hapi-fhir/commit/e78da44ce3f30bd0632192579c8bf1f21c7a3885", "message": "finished implementing main functionality", "committedDate": "2020-10-12T14:00:41Z", "type": "commit"}, {"oid": "522d1de93a3b791bdaa3cc80cadaabd4d35d0805", "url": "https://github.com/hapifhir/hapi-fhir/commit/522d1de93a3b791bdaa3cc80cadaabd4d35d0805", "message": "retool empi clear to use new deleteExpunge", "committedDate": "2020-10-12T14:54:37Z", "type": "commit"}, {"oid": "c507b07271f2f83dae47b3efc6c19791d928495c", "url": "https://github.com/hapifhir/hapi-fhir/commit/c507b07271f2f83dae47b3efc6c19791d928495c", "message": "don't run empty partitions", "committedDate": "2020-10-12T16:02:31Z", "type": "commit"}, {"oid": "ba0aa5b2a48b2af45aabdbf515b5af3c66d07939", "url": "https://github.com/hapifhir/hapi-fhir/commit/ba0aa5b2a48b2af45aabdbf515b5af3c66d07939", "message": "move service methods into dedicated class", "committedDate": "2020-10-12T20:53:17Z", "type": "commit"}, {"oid": "903860b50750c94dc24986ffe7e79dc5b485254d", "url": "https://github.com/hapifhir/hapi-fhir/commit/903860b50750c94dc24986ffe7e79dc5b485254d", "message": "move service methods into dedicated class", "committedDate": "2020-10-12T20:55:20Z", "type": "commit"}, {"oid": "0a5d8ca4e2aadb42011c2e873c497c9f3b531336", "url": "https://github.com/hapifhir/hapi-fhir/commit/0a5d8ca4e2aadb42011c2e873c497c9f3b531336", "message": "fix test", "committedDate": "2020-10-12T21:22:21Z", "type": "commit"}, {"oid": "b4d591d080598c3a5e92438014466b9e654ae0ba", "url": "https://github.com/hapifhir/hapi-fhir/commit/b4d591d080598c3a5e92438014466b9e654ae0ba", "message": "added delete expunge permission rules", "committedDate": "2020-10-13T15:10:05Z", "type": "commit"}, {"oid": "f72d1d1ccb7f1f7bdcc68155943342d4958625ab", "url": "https://github.com/hapifhir/hapi-fhir/commit/f72d1d1ccb7f1f7bdcc68155943342d4958625ab", "message": "initial attempt at delete expunge permissions", "committedDate": "2020-10-13T15:10:23Z", "type": "commit"}, {"oid": "f7d97edea68f6ded4da164683bfc40c9c1d53715", "url": "https://github.com/hapifhir/hapi-fhir/commit/f7d97edea68f6ded4da164683bfc40c9c1d53715", "message": "Merge remote-tracking branch 'origin/master' into ks-20201011-delete-expunge-2", "committedDate": "2020-10-13T15:10:50Z", "type": "commit"}, {"oid": "beb233c3ee9d61ded555c3f1c3858f3700aa91cb", "url": "https://github.com/hapifhir/hapi-fhir/commit/beb233c3ee9d61ded555c3f1c3858f3700aa91cb", "message": "fix test", "committedDate": "2020-10-13T16:12:30Z", "type": "commit"}, {"oid": "f7ccb9ee7bb83d20a7798f2519f361159fe15433", "url": "https://github.com/hapifhir/hapi-fhir/commit/f7ccb9ee7bb83d20a7798f2519f361159fe15433", "message": "fix test", "committedDate": "2020-10-13T17:24:01Z", "type": "commit"}, {"oid": "31adb3e21aba039824a7ff52af34a276fa066e6a", "url": "https://github.com/hapifhir/hapi-fhir/commit/31adb3e21aba039824a7ff52af34a276fa066e6a", "message": "Merge remote-tracking branch 'origin/master' into ks-20201011-delete-expunge-2", "committedDate": "2020-10-13T17:35:13Z", "type": "commit"}, {"oid": "320c66a6146be42846c45f4f61fe6f501236a4b0", "url": "https://github.com/hapifhir/hapi-fhir/commit/320c66a6146be42846c45f4f61fe6f501236a4b0", "message": "change log", "committedDate": "2020-10-13T18:21:06Z", "type": "commit"}, {"oid": "40b37094ee2afd6a445e1f2a943e2ade771bf844", "url": "https://github.com/hapifhir/hapi-fhir/commit/40b37094ee2afd6a445e1f2a943e2ade771bf844", "message": "FIXME", "committedDate": "2020-10-13T20:15:43Z", "type": "commit"}, {"oid": "38f9b14732c32bdb69fee32656ef0a6cbde05161", "url": "https://github.com/hapifhir/hapi-fhir/commit/38f9b14732c32bdb69fee32656ef0a6cbde05161", "message": "pre-review cleanup", "committedDate": "2020-10-13T22:17:45Z", "type": "commit"}, {"oid": "51a6598ae3ae2e2ee578394cd45bd9b7e9477e62", "url": "https://github.com/hapifhir/hapi-fhir/commit/51a6598ae3ae2e2ee578394cd45bd9b7e9477e62", "message": "added logging for intermittently failing test", "committedDate": "2020-10-14T13:34:16Z", "type": "commit"}, {"oid": "9c492bed54f8acf438e58194fccb2491438444d5", "url": "https://github.com/hapifhir/hapi-fhir/commit/9c492bed54f8acf438e58194fccb2491438444d5", "message": "spring bean cast exception sigh", "committedDate": "2020-10-14T16:55:06Z", "type": "commit"}, {"oid": "4cdb6ac16b538f4ef6c0175360fe43d30ae54c2e", "url": "https://github.com/hapifhir/hapi-fhir/commit/4cdb6ac16b538f4ef6c0175360fe43d30ae54c2e", "message": "review feedback: add daoConfig.setDeleteExpunge()", "committedDate": "2020-10-15T14:41:02Z", "type": "commit"}, {"oid": "a2445d70de49b3a207d2aaf5ceb9efb9c7d99a75", "url": "https://github.com/hapifhir/hapi-fhir/commit/a2445d70de49b3a207d2aaf5ceb9efb9c7d99a75", "message": "Review feedback add pointcut for batch.  Also optimized deletes.", "committedDate": "2020-10-15T15:27:32Z", "type": "commit"}, {"oid": "c3da4e6f2224d8dfdb309dda24f5deda55d6754e", "url": "https://github.com/hapifhir/hapi-fhir/commit/c3da4e6f2224d8dfdb309dda24f5deda55d6754e", "message": "fix jpa entitymanager dependency", "committedDate": "2020-10-15T16:34:03Z", "type": "commit"}, {"oid": "a0aae901dc7735682610b83a0b14ab2f9c234f3f", "url": "https://github.com/hapifhir/hapi-fhir/commit/a0aae901dc7735682610b83a0b14ab2f9c234f3f", "message": "improved logging when expunge delete fails", "committedDate": "2020-10-15T17:20:14Z", "type": "commit"}, {"oid": "23137ba206976c06aae5ca56d9ab39f228c2e487", "url": "https://github.com/hapifhir/hapi-fhir/commit/23137ba206976c06aae5ca56d9ab39f228c2e487", "message": "fixed bug in empi clear", "committedDate": "2020-10-15T21:42:46Z", "type": "commit"}, {"oid": "d1653529955393c3a7d7be61f4987dc6abe05634", "url": "https://github.com/hapifhir/hapi-fhir/commit/d1653529955393c3a7d7be61f4987dc6abe05634", "message": "fixed bug in empi merge", "committedDate": "2020-10-15T22:09:39Z", "type": "commit"}, {"oid": "503db3ef40aa7c3bd89567a38e333363f92aff88", "url": "https://github.com/hapifhir/hapi-fhir/commit/503db3ef40aa7c3bd89567a38e333363f92aff88", "message": "empi link bug finally fixed, with failing tests", "committedDate": "2020-10-16T00:33:48Z", "type": "commit"}, {"oid": "92b55f8ac56082b2154e527dbd036b1915f40ca4", "url": "https://github.com/hapifhir/hapi-fhir/commit/92b55f8ac56082b2154e527dbd036b1915f40ca4", "message": "fix tests", "committedDate": "2020-10-16T01:25:02Z", "type": "commit"}, {"oid": "8c7485d864fcc64e57169790f6dcb69f78cfb211", "url": "https://github.com/hapifhir/hapi-fhir/commit/8c7485d864fcc64e57169790f6dcb69f78cfb211", "message": "finally resolved all the empi link issues", "committedDate": "2020-10-16T14:02:48Z", "type": "commit"}, {"oid": "56e1efadc12c175e83635b7155ef43ac5caf16c1", "url": "https://github.com/hapifhir/hapi-fhir/commit/56e1efadc12c175e83635b7155ef43ac5caf16c1", "message": "test error", "committedDate": "2020-10-16T14:35:06Z", "type": "commit"}, {"oid": "671e213421b92587048698419db2059fef014e3e", "url": "https://github.com/hapifhir/hapi-fhir/commit/671e213421b92587048698419db2059fef014e3e", "message": "Merge remote-tracking branch 'origin/master' into ks-20201011-delete-expunge-2", "committedDate": "2020-10-16T22:23:42Z", "type": "commit"}, {"oid": "26caf734ad03dfbdd676bf07c4269bf6c329b168", "url": "https://github.com/hapifhir/hapi-fhir/commit/26caf734ad03dfbdd676bf07c4269bf6c329b168", "message": "unit test", "committedDate": "2020-10-18T20:33:18Z", "type": "commit"}, {"oid": "f61419b0429cfb44c75d269c4087781d7f1140e9", "url": "https://github.com/hapifhir/hapi-fhir/commit/f61419b0429cfb44c75d269c4087781d7f1140e9", "message": "ResourceTableFKProviderTest", "committedDate": "2020-10-18T22:34:06Z", "type": "commit"}, {"oid": "391bde3d23e61c2fddbda2f33e0e97811dc93ede", "url": "https://github.com/hapifhir/hapi-fhir/commit/391bde3d23e61c2fddbda2f33e0e97811dc93ede", "message": "single-thread empi processing", "committedDate": "2020-10-19T14:25:54Z", "type": "commit"}, {"oid": "9383c27de86ebbb6e350bf64ed97e68d79a549d8", "url": "https://github.com/hapifhir/hapi-fhir/commit/9383c27de86ebbb6e350bf64ed97e68d79a549d8", "message": "Merge remote-tracking branch 'origin/master' into ks-20201011-delete-expunge-2", "committedDate": "2020-10-19T22:11:42Z", "type": "commit"}, {"oid": "dc387e86e419c70846b5f8cdfd82083233b0f036", "url": "https://github.com/hapifhir/hapi-fhir/commit/dc387e86e419c70846b5f8cdfd82083233b0f036", "message": "fixed delete by url operation outcome", "committedDate": "2020-10-19T23:16:59Z", "type": "commit"}, {"oid": "93d606a23b93674908ab900f40ff9734fafbcd3d", "url": "https://github.com/hapifhir/hapi-fhir/commit/93d606a23b93674908ab900f40ff9734fafbcd3d", "message": "disable failing test with fixme", "committedDate": "2020-10-19T23:53:14Z", "type": "commit"}, {"oid": "c616f549d84fadfdd7471fbb36302bc10f68de06", "url": "https://github.com/hapifhir/hapi-fhir/commit/c616f549d84fadfdd7471fbb36302bc10f68de06", "message": "Merge remote-tracking branch 'origin/master' into ks-20201011-delete-expunge-2", "committedDate": "2020-10-20T00:21:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzNjE1MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508136151", "bodyText": "I'm not sure about the name of this.. The pointcuts are almost all named after steps in the processing lifecycle. We should give this a name  that makes it clear how this is different from STORAGE_PRE_DELETE_EXPUNGE (if it is? can they be collapsed?)", "author": "jamesagnew", "createdAt": "2020-10-20T00:22:36Z", "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java", "diffHunk": "@@ -916,6 +916,95 @@\n \t\t\"org.hl7.fhir.instance.model.api.IBaseResource\"\n \t),\n \n+\t/**\n+\t * <b>Storage Hook:</b>\n+\t * Invoked when a set of resources are about to be deleted and expunged via url like http://localhost/Patient?active=false&_expunge=true\n+\t * <p>\n+\t * Hooks may accept the following parameters:\n+\t * </p>\n+\t * <ul>\n+\t * <li>\n+\t * ca.uhn.fhir.rest.api.server.RequestDetails - A bean containing details about the request that is about to be processed, including details such as the\n+\t * resource type and logical ID (if any) and other FHIR-specific aspects of the request which have been\n+\t * pulled out of the servlet request. Note that the bean\n+\t * properties are not all guaranteed to be populated, depending on how early during processing the\n+\t * exception occurred. <b>Note that this parameter may be null in contexts where the request is not\n+\t * known, such as while processing searches</b>\n+\t * </li>\n+\t * <li>\n+\t * ca.uhn.fhir.rest.server.servlet.ServletRequestDetails - A bean containing details about the request that is about to be processed, including details such as the\n+\t * resource type and logical ID (if any) and other FHIR-specific aspects of the request which have been\n+\t * pulled out of the servlet request. This parameter is identical to the RequestDetails parameter above but will\n+\t * only be populated when operating in a RestfulServer implementation. It is provided as a convenience.\n+\t * </li>\n+\t * <li>\n+\t * java.lang.String - Contains the url used to delete and expunge the resources\n+\t * </li>\n+\t * </ul>\n+\t * <p>\n+\t * Hooks should return <code>void</code>. They may choose to throw an exception however, in\n+\t * which case the delete expunge will not occur.\n+\t * </p>\n+\t */\n+\n+\tSTORAGE_PRE_DELETE_EXPUNGE(\n+\t\tvoid.class,\n+\t\t\"ca.uhn.fhir.rest.api.server.RequestDetails\",\n+\t\t\"ca.uhn.fhir.rest.server.servlet.ServletRequestDetails\",\n+\t\t\"java.lang.String\"\n+\t),\n+\n+\t/**\n+\t * <b>Storage Hook:</b>\n+\t * Invoked when a batch of resource pids are about to be deleted and expunged via url like http://localhost/Patient?active=false&_expunge=true\n+\t * <p>\n+\t * Hooks may accept the following parameters:\n+\t * </p>\n+\t * <ul>\n+\t * <li>\n+\t * java.lang.String - the name of the resource type being deleted\n+\t * </li>\n+\t * <li>\n+\t * java.util.List - the list of Long pids of the resources about to be deleted\n+\t * </li>\n+\t * <li>\n+\t * java.util.concurrent.atomic.AtomicLong - holds a running tally of all entities deleted so far.\n+\t * If the pointcut callback deletes any entities, then this parameter should be incremented by the total number\n+\t * of additional entities deleted.\n+\t * </li>\n+\t * <li>\n+\t * ca.uhn.fhir.rest.api.server.RequestDetails - A bean containing details about the request that is about to be processed, including details such as the\n+\t * resource type and logical ID (if any) and other FHIR-specific aspects of the request which have been\n+\t * pulled out of the servlet request. Note that the bean\n+\t * properties are not all guaranteed to be populated, depending on how early during processing the\n+\t * exception occurred. <b>Note that this parameter may be null in contexts where the request is not\n+\t * known, such as while processing searches</b>\n+\t * </li>\n+\t * <li>\n+\t * ca.uhn.fhir.rest.server.servlet.ServletRequestDetails - A bean containing details about the request that is about to be processed, including details such as the\n+\t * resource type and logical ID (if any) and other FHIR-specific aspects of the request which have been\n+\t * pulled out of the servlet request. This parameter is identical to the RequestDetails parameter above but will\n+\t * only be populated when operating in a RestfulServer implementation. It is provided as a convenience.\n+\t * </li>\n+\t * <li>\n+\t * java.lang.String - Contains the url used to delete and expunge the resources\n+\t * </li>\n+\t * </ul>\n+\t * <p>\n+\t * Hooks should return <code>void</code>. They may choose to throw an exception however, in\n+\t * which case the delete expunge will not occur.\n+\t * </p>\n+\t */\n+\n+\tSTORAGE_DELETE_EXPUNGE_PID_LIST(", "originalCommit": "c616f549d84fadfdd7471fbb36302bc10f68de06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwNzMxNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508507315", "bodyText": "One is pre all of them, the other receives the pid chunks", "author": "fil512", "createdAt": "2020-10-20T13:35:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzNjE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwODYxOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508508619", "bodyText": "Changed to STORAGE_PRE_DELETE_EXPUNGE_PID_LIST", "author": "fil512", "createdAt": "2020-10-20T13:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzNjE1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b2be49ea8212cf464ceed9c09c21e4f532176269", "chunk": "diff --git a/hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java b/hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java\nindex caa870fa2f..bd86c55a04 100644\n--- a/hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java\n+++ b/hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java\n\n@@ -996,7 +996,7 @@ public enum Pointcut {\n \t * </p>\n \t */\n \n-\tSTORAGE_DELETE_EXPUNGE_PID_LIST(\n+\tSTORAGE_PRE_DELETE_EXPUNGE_PID_LIST(\n \t\tvoid.class,\n \t\t\"java.lang.String\",\n \t\t\"java.util.List\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzNzk2NA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508137964", "bodyText": "Fix has been merged to master\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t@Disabled", "author": "jamesagnew", "createdAt": "2020-10-20T00:29:16Z", "path": "hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/client/GenericClientDstu3Test.java", "diffHunk": "@@ -1187,7 +1196,9 @@ public InputStream answer(InvocationOnMock theInvocation) throws Throwable {\n \t\tidx++;\n \t}\n \n+\t// FIXME KHS disable until it's fixed\n \t@Test\n+\t@Disabled", "originalCommit": "c616f549d84fadfdd7471fbb36302bc10f68de06", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b2be49ea8212cf464ceed9c09c21e4f532176269", "chunk": "diff --git a/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/client/GenericClientDstu3Test.java b/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/client/GenericClientDstu3Test.java\nindex dbad739bc4..130aec7454 100644\n--- a/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/client/GenericClientDstu3Test.java\n+++ b/hapi-fhir-structures-dstu3/src/test/java/ca/uhn/fhir/rest/client/GenericClientDstu3Test.java\n\n@@ -1196,9 +1195,7 @@ public class GenericClientDstu3Test {\n \t\tidx++;\n \t}\n \n-\t// FIXME KHS disable until it's fixed\n \t@Test\n-\t@Disabled\n \tpublic void testSearchByDate() throws Exception {\n \t\tfinal String msg = \"{\\\"resourceType\\\":\\\"Bundle\\\",\\\"id\\\":null,\\\"base\\\":\\\"http://localhost:57931/fhir/contextDev\\\",\\\"total\\\":1,\\\"link\\\":[{\\\"relation\\\":\\\"self\\\",\\\"url\\\":\\\"http://localhost:57931/fhir/contextDev/Patient?identifier=urn%3AMultiFhirVersionTest%7CtestSubmitPatient01&_format=json\\\"}],\\\"entry\\\":[{\\\"resource\\\":{\\\"resourceType\\\":\\\"Patient\\\",\\\"id\\\":\\\"1\\\",\\\"meta\\\":{\\\"versionId\\\":\\\"1\\\",\\\"lastUpdated\\\":\\\"2014-12-20T18:41:29.706-05:00\\\"},\\\"identifier\\\":[{\\\"system\\\":\\\"urn:MultiFhirVersionTest\\\",\\\"value\\\":\\\"testSubmitPatient01\\\"}]}}]}\";\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzODMwMQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508138301", "bodyText": "Is there a test for this? I'd recommend putting one or two in AuthorizationInterceptorJpaR4Test", "author": "jamesagnew", "createdAt": "2020-10-20T00:30:29Z", "path": "hapi-fhir-server/src/main/java/ca/uhn/fhir/rest/server/interceptor/auth/IAuthRuleBuilderRuleOpDelete.java", "diffHunk": "@@ -30,4 +30,9 @@\n \t */\n \tIAuthRuleBuilderRuleOp onCascade();\n \n+\t/**\n+\t * Specifies that this rule applies to delete expunges as opposed to regular\n+\t * deletes.  A delete expunge is a delete operation called with the _expunge=true parameter.\n+\t */\n+\tIAuthRuleBuilderRuleOp onExpunge();", "originalCommit": "c616f549d84fadfdd7471fbb36302bc10f68de06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUyMDM2OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2131#discussion_r508520369", "bodyText": "thanks.  there's a test in a different place, but I like the tests here; I have added the tests.", "author": "fil512", "createdAt": "2020-10-20T13:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzODMwMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b2be49ea8212cf464ceed9c09c21e4f532176269", "url": "https://github.com/hapifhir/hapi-fhir/commit/b2be49ea8212cf464ceed9c09c21e4f532176269", "message": "review feedback", "committedDate": "2020-10-20T13:48:42Z", "type": "commit"}]}