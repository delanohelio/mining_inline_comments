{"pr_number": 1830, "pr_title": "Clean up hash code calculation", "pr_createdAt": "2020-05-04T22:22:03Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1830", "timeline": [{"oid": "711ea8fd34a06ee56e1760fb371872142624c226", "url": "https://github.com/hapifhir/hapi-fhir/commit/711ea8fd34a06ee56e1760fb371872142624c226", "message": "Clean up hash code calculation", "committedDate": "2020-05-04T22:20:28Z", "type": "commit"}, {"oid": "9c76c3941a509aeec57b80486f9e13e31b2e92d1", "url": "https://github.com/hapifhir/hapi-fhir/commit/9c76c3941a509aeec57b80486f9e13e31b2e92d1", "message": "Test fixes", "committedDate": "2020-05-05T00:41:57Z", "type": "commit"}, {"oid": "7f3a5642ef8545be3eef94692c41b727bc0871dd", "url": "https://github.com/hapifhir/hapi-fhir/commit/7f3a5642ef8545be3eef94692c41b727bc0871dd", "message": "Test fix", "committedDate": "2020-05-05T09:49:40Z", "type": "commit"}, {"oid": "d0c3757465e377f39697b5e6b0fb85a1d79ef4a4", "url": "https://github.com/hapifhir/hapi-fhir/commit/d0c3757465e377f39697b5e6b0fb85a1d79ef4a4", "message": "Test fixes", "committedDate": "2020-05-05T09:59:12Z", "type": "commit"}, {"oid": "55ecc0f9c46e165a8ff75b0f798ab11024f25f68", "url": "https://github.com/hapifhir/hapi-fhir/commit/55ecc0f9c46e165a8ff75b0f798ab11024f25f68", "message": "Compile fix", "committedDate": "2020-05-05T11:13:35Z", "type": "commit"}, {"oid": "f6cf9557db464b0cb5af2335ed188f9ef1476a64", "url": "https://github.com/hapifhir/hapi-fhir/commit/f6cf9557db464b0cb5af2335ed188f9ef1476a64", "message": "Test fix", "committedDate": "2020-05-05T11:41:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MDA3OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1830#discussion_r420170079", "bodyText": "Trying to understand this change.  Are you removing transitional code we had in there to bridge the pre-hash installs to the post-hash installs?  Or is this a performance optimization that's no longer possible due to changes in the way hashing works?", "author": "fil512", "createdAt": "2020-05-05T14:50:09Z", "path": "hapi-fhir-jpaserver-model/src/main/java/ca/uhn/fhir/jpa/model/entity/ResourceIndexedSearchParamCoords.java", "diffHunk": "@@ -68,21 +76,14 @@ public ResourceIndexedSearchParamCoords(PartitionSettings thePartitionSettings,\n \t\tsetParamName(theParamName);\n \t\tsetLatitude(theLatitude);\n \t\tsetLongitude(theLongitude);\n+\t\tcalculateHashes();\n \t}\n \n \t@Override\n-\t@PrePersist\n \tpublic void calculateHashes() {\n-\t\tif (myHashIdentity == null && getParamName() != null) {", "originalCommit": "f6cf9557db464b0cb5af2335ed188f9ef1476a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3ODAxOA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1830#discussion_r420178018", "bodyText": "The general idea here is that we calculated the hashes via 2 different ways, both of which were kind of haphazard:\n\nWe calculated then in a @PrePersist hook as the data was sent to the database\nWe calculated them if someone called hashCode()\n\nThis probably made sense originally where we only ever created them and put them in the DB and that was that.. But increasingly we're using these structures for all kinds of other stuff (e.g. in memory matching, reusing rows in the index tables rather than deleting one and adding a new one, etc.) and this haphazard logic was causing unexpected bugs when unpredicted situations arose (such as a stored row having no hash, whcih is the actual thing we're fixing here).\nWhat this change does, more importantly, is remove chance from the equation by just explicitly calcuating the hashes as soon as possible.", "author": "jamesagnew", "createdAt": "2020-05-05T15:00:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE5MDQzNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1830#discussion_r420190437", "bodyText": "nice", "author": "fil512", "createdAt": "2020-05-05T15:16:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3MDA3OQ=="}], "type": "inlineReview", "revised_code": null}]}