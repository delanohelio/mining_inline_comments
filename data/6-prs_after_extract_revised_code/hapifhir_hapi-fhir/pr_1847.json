{"pr_number": 1847, "pr_title": "Add missing indexes on ResourceIndexedSearchParamDate", "pr_createdAt": "2020-05-14T19:50:38Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1847", "timeline": [{"oid": "269c3f2b04525905c06bdfa4a04ebd6e8da185d4", "url": "https://github.com/hapifhir/hapi-fhir/commit/269c3f2b04525905c06bdfa4a04ebd6e8da185d4", "message": "Add migration tasks for new indexes. Add new indexes to ResourceIndexedSearchParamDate", "committedDate": "2020-05-14T18:32:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxNzAxNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1847#discussion_r425417015", "bodyText": "This might be higher than the length limit.  James has a test that enforces this so hopefully that test will catch it.  I forget what the length limit is.", "author": "fil512", "createdAt": "2020-05-14T20:40:18Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -122,7 +124,17 @@ private void init430() {\n \t\tversion.addNop(\"20200420.42\");\n \t}\n \n-\tprotected void init500() { // 20200218 - present\n+\n+\tprivate void init501() { //20200520 - present\n+\t\tBuilder version = forVersion(VersionEnum.V5_0_1);\n+\n+\t\tBuilder.BuilderWithTableName spidxDate = version.onTable(\"HFJ_SPIDX_DATE\");\n+\t\tspidxDate.addIndex(\"20200520.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");\n+\t\tspidxDate.addIndex(\"20200520.2\", \"IDX_SP_DATE_ORD_DATE_HASH\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\", \"SP_VALUE_HIGH_DATE_ORDINAL\");\n+\t\tspidxDate.addIndex(\"20200520.3\", \"IDX_SP_DATE_ORD_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\");", "originalCommit": "269c3f2b04525905c06bdfa4a04ebd6e8da185d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyODY2OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1847#discussion_r425428669", "bodyText": "James just got back to us.  The max length is 30.  This one has length 29 so we're good.", "author": "fil512", "createdAt": "2020-05-14T21:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQxNzAxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7c64bcbb0a99651e145f5c2fd424afb9b4a2e72", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex b333bc1d06..f46402c6a5 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -129,9 +129,9 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \t\tBuilder version = forVersion(VersionEnum.V5_0_1);\n \n \t\tBuilder.BuilderWithTableName spidxDate = version.onTable(\"HFJ_SPIDX_DATE\");\n-\t\tspidxDate.addIndex(\"20200520.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");\n-\t\tspidxDate.addIndex(\"20200520.2\", \"IDX_SP_DATE_ORD_DATE_HASH\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\", \"SP_VALUE_HIGH_DATE_ORDINAL\");\n-\t\tspidxDate.addIndex(\"20200520.3\", \"IDX_SP_DATE_ORD_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\");\n+\t\tspidxDate.addIndex(\"20200514.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");\n+\t\tspidxDate.addIndex(\"20200514.2\", \"IDX_SP_DATE_ORD_DATE_HASH\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\", \"SP_VALUE_HIGH_DATE_ORDINAL\");\n+\t\tspidxDate.addIndex(\"20200514.3\", \"IDX_SP_DATE_ORD_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\");\n \t}\n \n \tprotected void init500() { // 20200218 - 20200519\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyMDEwOQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1847#discussion_r425420109", "bodyText": "Shouldn't this be 20200514.1?", "author": "fil512", "createdAt": "2020-05-14T20:46:33Z", "path": "hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java", "diffHunk": "@@ -122,7 +124,17 @@ private void init430() {\n \t\tversion.addNop(\"20200420.42\");\n \t}\n \n-\tprotected void init500() { // 20200218 - present\n+\n+\tprivate void init501() { //20200520 - present\n+\t\tBuilder version = forVersion(VersionEnum.V5_0_1);\n+\n+\t\tBuilder.BuilderWithTableName spidxDate = version.onTable(\"HFJ_SPIDX_DATE\");\n+\t\tspidxDate.addIndex(\"20200520.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");", "originalCommit": "269c3f2b04525905c06bdfa4a04ebd6e8da185d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQzNzA0OQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1847#discussion_r425437049", "bodyText": "Heh, here's why I thought it was May 20th:", "author": "tadgh", "createdAt": "2020-05-14T21:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQyMDEwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c7c64bcbb0a99651e145f5c2fd424afb9b4a2e72", "chunk": "diff --git a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\nindex b333bc1d06..f46402c6a5 100644\n--- a/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n+++ b/hapi-fhir-jpaserver-migrate/src/main/java/ca/uhn/fhir/jpa/migrate/tasks/HapiFhirJpaMigrationTasks.java\n\n@@ -129,9 +129,9 @@ public class HapiFhirJpaMigrationTasks extends BaseMigrationTasks<VersionEnum> {\n \t\tBuilder version = forVersion(VersionEnum.V5_0_1);\n \n \t\tBuilder.BuilderWithTableName spidxDate = version.onTable(\"HFJ_SPIDX_DATE\");\n-\t\tspidxDate.addIndex(\"20200520.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");\n-\t\tspidxDate.addIndex(\"20200520.2\", \"IDX_SP_DATE_ORD_DATE_HASH\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\", \"SP_VALUE_HIGH_DATE_ORDINAL\");\n-\t\tspidxDate.addIndex(\"20200520.3\", \"IDX_SP_DATE_ORD_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\");\n+\t\tspidxDate.addIndex(\"20200514.1\", \"IDX_SP_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW\");\n+\t\tspidxDate.addIndex(\"20200514.2\", \"IDX_SP_DATE_ORD_DATE_HASH\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\", \"SP_VALUE_HIGH_DATE_ORDINAL\");\n+\t\tspidxDate.addIndex(\"20200514.3\", \"IDX_SP_DATE_ORD_DATE_HASH_LOW\").unique(false).withColumns(\"HASH_IDENTITY\", \"SP_VALUE_LOW_DATE_ORDINAL\");\n \t}\n \n \tprotected void init500() { // 20200218 - 20200519\n"}}, {"oid": "c7c64bcbb0a99651e145f5c2fd424afb9b4a2e72", "url": "https://github.com/hapifhir/hapi-fhir/commit/c7c64bcbb0a99651e145f5c2fd424afb9b4a2e72", "message": "fix dates on task, remove redundant index", "committedDate": "2020-05-14T22:28:10Z", "type": "commit"}, {"oid": "325240e41124d13404bdc3a7f18addcdc29c14d2", "url": "https://github.com/hapifhir/hapi-fhir/commit/325240e41124d13404bdc3a7f18addcdc29c14d2", "message": "Today is not the 20th", "committedDate": "2020-05-14T22:30:04Z", "type": "commit"}, {"oid": "dfb04dd1221f7df9998e2b7e885d9ecbbc70b59b", "url": "https://github.com/hapifhir/hapi-fhir/commit/dfb04dd1221f7df9998e2b7e885d9ecbbc70b59b", "message": "Fix incorrectly named migration indexes", "committedDate": "2020-05-15T00:20:14Z", "type": "commit"}, {"oid": "2149c4ab5ef4797e78a05ca07bf487aaa045945c", "url": "https://github.com/hapifhir/hapi-fhir/commit/2149c4ab5ef4797e78a05ca07bf487aaa045945c", "message": "out of order indexes", "committedDate": "2020-05-15T02:12:22Z", "type": "commit"}]}