{"pr_number": 1958, "pr_title": "Im 20200630 code system load", "pr_createdAt": "2020-07-02T16:15:30Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1958", "timeline": [{"oid": "0788e79d514499da07f4b4fafde4b66837c80b0b", "url": "https://github.com/hapifhir/hapi-fhir/commit/0788e79d514499da07f4b4fafde4b66837c80b0b", "message": "Fix to address deferred save of TermConcept when code system version changes prior to save.", "committedDate": "2020-06-30T19:07:14Z", "type": "commit"}, {"oid": "557f732e17bf9969aa14e53c29b77ea15bc6dda9", "url": "https://github.com/hapifhir/hapi-fhir/commit/557f732e17bf9969aa14e53c29b77ea15bc6dda9", "message": "Cleanup and improved Unit tests.", "committedDate": "2020-07-02T16:03:15Z", "type": "commit"}, {"oid": "46abdfafe0c71921ccb61e53ed531b114137fd0b", "url": "https://github.com/hapifhir/hapi-fhir/commit/46abdfafe0c71921ccb61e53ed531b114137fd0b", "message": "Merge remote-tracking branch 'remotes/origin/master' into im_20200630_code_system_load", "committedDate": "2020-07-02T17:29:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwMjUyMQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449602521", "bodyText": "nitpick: Convention is to put helper methods below the place where they are first used.", "author": "fil512", "createdAt": "2020-07-03T14:09:51Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/TermCodeSystemStorageSvcTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package ca.uhn.fhir.jpa.term;\n+\n+import ca.uhn.fhir.jpa.dao.r4.BaseJpaR4Test;\n+import ca.uhn.fhir.jpa.model.entity.ResourceTable;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class TermCodeSystemStorageSvcTest extends BaseJpaR4Test {\n+\n+\tpublic static final String URL_MY_CODE_SYSTEM = \"http://example.com/my_code_system\";\n+\n+\tprivate CodeSystem createCodeSystemWithMoreThan100Concepts() {", "originalCommit": "46abdfafe0c71921ccb61e53ed531b114137fd0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYyNzExNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449627115", "bodyText": "Good point - forgot my Clean Code principles here...", "author": "IanMMarshall", "createdAt": "2020-07-03T15:08:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwMjUyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwMzYyNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449603627", "bodyText": "Some comments in this test would help clarify the race condition it's testing", "author": "fil512", "createdAt": "2020-07-03T14:12:12Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/TermCodeSystemStorageSvcTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package ca.uhn.fhir.jpa.term;\n+\n+import ca.uhn.fhir.jpa.dao.r4.BaseJpaR4Test;\n+import ca.uhn.fhir.jpa.model.entity.ResourceTable;\n+import org.hl7.fhir.r4.model.CodeSystem;\n+import org.hl7.fhir.r4.model.CodeType;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+public class TermCodeSystemStorageSvcTest extends BaseJpaR4Test {\n+\n+\tpublic static final String URL_MY_CODE_SYSTEM = \"http://example.com/my_code_system\";\n+\n+\tprivate CodeSystem createCodeSystemWithMoreThan100Concepts() {\n+\t\tCodeSystem codeSystem = new CodeSystem();\n+\t\tcodeSystem.setUrl(URL_MY_CODE_SYSTEM);\n+\t\tcodeSystem.setContent(CodeSystem.CodeSystemContentMode.NOTPRESENT);\n+\n+\t\tfor (int i = 0; i < 125; i++) {\n+\t\t\tcodeSystem.addConcept(new CodeSystem.ConceptDefinitionComponent(new CodeType(\"codeA \" + i)));\n+\t\t}\n+\n+\t\treturn codeSystem;\n+\n+\t}\n+\n+\t@Test\n+\tpublic void testStoreNewCodeSystemVersionForExistingCodeSystem() {\n+\t\tCodeSystem upload = createCodeSystemWithMoreThan100Concepts();\n+\n+\t\tResourceTable codeSystemResourceEntity = (ResourceTable)myCodeSystemDao.create(upload, mySrd).getEntity();\n+\n+\t\trunInTransaction(() -> myTermCodeSystemStorageSvc.storeNewCodeSystemVersionIfNeeded(upload, codeSystemResourceEntity));\n+\n+\t\tmyTerminologyDeferredStorageSvc.setProcessDeferred(true);\n+\t\tmyTerminologyDeferredStorageSvc.saveDeferred();\n+\t\tmyTerminologyDeferredStorageSvc.saveDeferred();\n+\n+\t\tassertEquals(125, myTermConceptDao.count());", "originalCommit": "46abdfafe0c71921ccb61e53ed531b114137fd0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzMDgyMQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449630821", "bodyText": "Good point. Done.", "author": "IanMMarshall", "createdAt": "2020-07-03T15:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwMzYyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxMDk1Ng==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449610956", "bodyText": "This doesn't eliminate the race condition, but greatly reduces it.  If both the findById and save are in the same transaction with the right isolation level, that last gap could be closed.  Or it might be cleaner to just put the save in a try block so one failure doesn't interfere with the following saves in the loop.\nI don't think it's worth the effort, but if you really wanted to test this final tiny race condition gap, you could create a version of your test where your mock returns a valid findById but then by the time the save is called it is no longer valid.", "author": "fil512", "createdAt": "2020-07-03T14:29:19Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/TermDeferredStorageSvcImpl.java", "diffHunk": "@@ -142,7 +145,12 @@ private void processDeferredConcepts() {\n \t\tourLog.info(\"Saving {} deferred concepts...\", count);\n \t\twhile (codeCount < count && myDeferredConcepts.size() > 0) {\n \t\t\tTermConcept next = myDeferredConcepts.remove(0);\n-\t\t\tcodeCount += myCodeSystemStorageSvc.saveConcept(next);\n+\t\t\tif(myCodeSystemVersionDao.findById(next.getCodeSystemVersion().getPid()).isPresent()) {", "originalCommit": "46abdfafe0c71921ccb61e53ed531b114137fd0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzNjg1MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449636850", "bodyText": "Good call. I will use the try block per your suggestion. It's a little more blunt than what I had, but it should be cleaner and perform better than my original solution.", "author": "IanMMarshall", "createdAt": "2020-07-03T15:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxMDk1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxNDYyNQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449614625", "bodyText": "Another option you can use for this pattern is rather than using setXYZForUnitTest is you can use the MockBean pattern.  See SearchParamRegistryImplTest for an example.  Totally optional, but what I like about this pattern is it means you can remove all the setXYZForUnitTest methods.", "author": "fil512", "createdAt": "2020-07-03T14:38:01Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/TermDeferredStorageSvcImplTest.java", "diffHunk": "@@ -38,16 +44,45 @@ public void testSaveDeferred_Concept() {\n \t\tTermConcept concept = new TermConcept();\n \t\tconcept.setCode(\"CODE_A\");\n \n+\t\tTermCodeSystemVersion myTermCodeSystemVersion = new TermCodeSystemVersion();\n+\t\tmyTermCodeSystemVersion.setId(1L);\n+\t\tconcept.setCodeSystemVersion(myTermCodeSystemVersion);\n+\n \t\tTermDeferredStorageSvcImpl svc = new TermDeferredStorageSvcImpl();\n \t\tsvc.setTransactionManagerForUnitTest(myTxManager);\n \t\tsvc.setCodeSystemStorageSvcForUnitTest(myTermConceptStorageSvc);\n \t\tsvc.setDaoConfigForUnitTest(new DaoConfig());\n+\n+\t\twhen(myTermCodeSystemVersionDao.findById(anyLong())).thenReturn(Optional.of(myTermCodeSystemVersion));\n+\t\tsvc.setCodeSystemVersionDaoForUnitTest(myTermCodeSystemVersionDao);\n \t\tsvc.setProcessDeferred(true);\n \t\tsvc.addConceptToStorageQueue(concept);\n \t\tsvc.saveDeferred();\n-\n \t\tverify(myTermConceptStorageSvc, times(1)).saveConcept(same(concept));\n \t\tverifyNoMoreInteractions(myTermConceptStorageSvc);\n+\n+\t}\n+\n+\t@Test\n+\tpublic void testSaveDeferred_Concept_StaleCodeSystemVersion() {\n+\t\tTermConcept concept = new TermConcept();\n+\t\tconcept.setCode(\"CODE_A\");\n+\n+\t\tTermCodeSystemVersion myTermCodeSystemVersion = new TermCodeSystemVersion();\n+\t\tconcept.setCodeSystemVersion(myTermCodeSystemVersion);\n+\n+\t\tTermDeferredStorageSvcImpl svc = new TermDeferredStorageSvcImpl();\n+\t\tsvc.setTransactionManagerForUnitTest(myTxManager);", "originalCommit": "46abdfafe0c71921ccb61e53ed531b114137fd0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2MjAzNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1958#discussion_r449662037", "bodyText": "I like this idea, but found that it got complicated rather quickly (a surprisingly large number of dependencies that would need to be mocked here to make this work). Will note this for later.", "author": "IanMMarshall", "createdAt": "2020-07-03T17:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxNDYyNQ=="}], "type": "inlineReview", "revised_code": null}]}