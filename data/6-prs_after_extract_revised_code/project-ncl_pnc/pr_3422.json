{"pr_number": 3422, "pr_title": "[NCL-6237] Could set closed milestone as current", "pr_createdAt": "2020-11-25T10:48:40Z", "pr_url": "https://github.com/project-ncl/pnc/pull/3422", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyNjcxNQ==", "url": "https://github.com/project-ncl/pnc/pull/3422#discussion_r530326715", "bodyText": "use Product milestone mapper method to get id mapper to map the milestone id.", "author": "janinko", "createdAt": "2020-11-25T12:10:24Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -158,6 +164,25 @@ private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEn\n         }\n     }\n \n+    private void validateMilestone(String id, ProductVersion entity) {\n+        if (entity.getCurrentProductMilestone() != null) {\n+            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());", "originalCommit": "f87e3492583c6a00baf6d9af1a5dc17e11209b99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a543d98725d7584d572f2593c1c0de0ee90481b", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\nindex 71242e7f1..d71ba2089 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n\n@@ -166,18 +166,16 @@ public class ProductVersionProviderImpl extends\n \n     private void validateMilestone(String id, ProductVersion entity) {\n         if (entity.getCurrentProductMilestone() != null) {\n-            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());\n-            if (newMilestoneId != null) {\n-                org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(Integer.parseInt(id));\n-                ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n-                if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n-                    ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n-                    if (newMilestone == null) {\n-                        throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n-                    } else if (newMilestone.getEndDate() != null) {\n-                        throw new InvalidEntityException(\n-                                \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n-                    }\n+            Integer newMilestoneId = mapper.getIdMapper().toEntity(entity.getCurrentProductMilestone().getId());\n+            org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(mapper.getIdMapper().toEntity(id));\n+            ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n+            if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n+                ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n+                if (newMilestone == null) {\n+                    throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n+                } else if (newMilestone.getEndDate() != null) {\n+                    throw new InvalidEntityException(\n+                            \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyODg0Mw==", "url": "https://github.com/project-ncl/pnc/pull/3422#discussion_r530328843", "bodyText": "newMilestoneId can't be null, because if entity.getCurrentProductMilestone().getId() is null, then you get NPE.", "author": "janinko", "createdAt": "2020-11-25T12:14:27Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -158,6 +164,25 @@ private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEn\n         }\n     }\n \n+    private void validateMilestone(String id, ProductVersion entity) {\n+        if (entity.getCurrentProductMilestone() != null) {\n+            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());\n+            if (newMilestoneId != null) {", "originalCommit": "f87e3492583c6a00baf6d9af1a5dc17e11209b99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a543d98725d7584d572f2593c1c0de0ee90481b", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\nindex 71242e7f1..d71ba2089 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n\n@@ -166,18 +166,16 @@ public class ProductVersionProviderImpl extends\n \n     private void validateMilestone(String id, ProductVersion entity) {\n         if (entity.getCurrentProductMilestone() != null) {\n-            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());\n-            if (newMilestoneId != null) {\n-                org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(Integer.parseInt(id));\n-                ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n-                if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n-                    ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n-                    if (newMilestone == null) {\n-                        throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n-                    } else if (newMilestone.getEndDate() != null) {\n-                        throw new InvalidEntityException(\n-                                \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n-                    }\n+            Integer newMilestoneId = mapper.getIdMapper().toEntity(entity.getCurrentProductMilestone().getId());\n+            org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(mapper.getIdMapper().toEntity(id));\n+            ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n+            if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n+                ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n+                if (newMilestone == null) {\n+                    throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n+                } else if (newMilestone.getEndDate() != null) {\n+                    throw new InvalidEntityException(\n+                            \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDMyOTEzMQ==", "url": "https://github.com/project-ncl/pnc/pull/3422#discussion_r530329131", "bodyText": "use Product version mapper method to get id mapper to map the product version id.", "author": "janinko", "createdAt": "2020-11-25T12:14:55Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -158,6 +164,25 @@ private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEn\n         }\n     }\n \n+    private void validateMilestone(String id, ProductVersion entity) {\n+        if (entity.getCurrentProductMilestone() != null) {\n+            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());\n+            if (newMilestoneId != null) {\n+                org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(Integer.parseInt(id));", "originalCommit": "f87e3492583c6a00baf6d9af1a5dc17e11209b99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7a543d98725d7584d572f2593c1c0de0ee90481b", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\nindex 71242e7f1..d71ba2089 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n\n@@ -166,18 +166,16 @@ public class ProductVersionProviderImpl extends\n \n     private void validateMilestone(String id, ProductVersion entity) {\n         if (entity.getCurrentProductMilestone() != null) {\n-            Integer newMilestoneId = Integer.parseInt(entity.getCurrentProductMilestone().getId());\n-            if (newMilestoneId != null) {\n-                org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(Integer.parseInt(id));\n-                ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n-                if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n-                    ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n-                    if (newMilestone == null) {\n-                        throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n-                    } else if (newMilestone.getEndDate() != null) {\n-                        throw new InvalidEntityException(\n-                                \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n-                    }\n+            Integer newMilestoneId = mapper.getIdMapper().toEntity(entity.getCurrentProductMilestone().getId());\n+            org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(mapper.getIdMapper().toEntity(id));\n+            ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n+            if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n+                ProductMilestone newMilestone = milestoneRepository.queryById(newMilestoneId);\n+                if (newMilestone == null) {\n+                    throw new InvalidEntityException(\"Milestone with id: \" + newMilestoneId + \" does not exist.\");\n+                } else if (newMilestone.getEndDate() != null) {\n+                    throw new InvalidEntityException(\n+                            \"Milestone with id: \" + newMilestoneId + \" is closed, so cannot be set as current.\");\n                 }\n             }\n         }\n"}}, {"oid": "7a543d98725d7584d572f2593c1c0de0ee90481b", "url": "https://github.com/project-ncl/pnc/commit/7a543d98725d7584d572f2593c1c0de0ee90481b", "message": "[NCL-6237] Could set closed milestone as current", "committedDate": "2020-11-25T13:47:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2NDY3OQ==", "url": "https://github.com/project-ncl/pnc/pull/3422#discussion_r531064679", "bodyText": "mapper is not ProductMilestoneMapper, is it?", "author": "janinko", "createdAt": "2020-11-26T14:27:22Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java", "diffHunk": "@@ -158,6 +164,23 @@ private void validateGroupConfigsBeforeUpdating(String id, ProductVersion restEn\n         }\n     }\n \n+    private void validateMilestone(String id, ProductVersion entity) {\n+        if (entity.getCurrentProductMilestone() != null) {\n+            Integer newMilestoneId = mapper.getIdMapper().toEntity(entity.getCurrentProductMilestone().getId());", "originalCommit": "7a543d98725d7584d572f2593c1c0de0ee90481b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTEyMjA1Nw==", "url": "https://github.com/project-ncl/pnc/pull/3422#discussion_r531122057", "bodyText": "depends on time when you look at it", "author": "jomrazek", "createdAt": "2020-11-26T16:03:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA2NDY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "76842e236325aa66af16c95e6a600b329fbe7125", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\nindex d71ba2089..0593b655d 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/ProductVersionProviderImpl.java\n\n@@ -166,7 +170,8 @@ public class ProductVersionProviderImpl extends\n \n     private void validateMilestone(String id, ProductVersion entity) {\n         if (entity.getCurrentProductMilestone() != null) {\n-            Integer newMilestoneId = mapper.getIdMapper().toEntity(entity.getCurrentProductMilestone().getId());\n+            Integer newMilestoneId = milestoneMapper.getIdMapper()\n+                    .toEntity(entity.getCurrentProductMilestone().getId());\n             org.jboss.pnc.model.ProductVersion productVersion = repository.queryById(mapper.getIdMapper().toEntity(id));\n             ProductMilestone currentMilestone = productVersion.getCurrentProductMilestone();\n             if (currentMilestone == null || currentMilestone.getId() != newMilestoneId) {\n"}}, {"oid": "76842e236325aa66af16c95e6a600b329fbe7125", "url": "https://github.com/project-ncl/pnc/commit/76842e236325aa66af16c95e6a600b329fbe7125", "message": "[NCL-6237] Could set closed milestone as current", "committedDate": "2020-11-26T16:01:17Z", "type": "commit"}, {"oid": "76842e236325aa66af16c95e6a600b329fbe7125", "url": "https://github.com/project-ncl/pnc/commit/76842e236325aa66af16c95e6a600b329fbe7125", "message": "[NCL-6237] Could set closed milestone as current", "committedDate": "2020-11-26T16:01:17Z", "type": "forcePushed"}]}