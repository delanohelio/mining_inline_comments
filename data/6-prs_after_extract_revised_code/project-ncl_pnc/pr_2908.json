{"pr_number": 2908, "pr_title": "[NCL-5558] Respond with 403 status when Brew Push is forbidden becaus\u2026", "pr_createdAt": "2020-03-11T09:46:40Z", "pr_url": "https://github.com/project-ncl/pnc/pull/2908", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MDI5MA==", "url": "https://github.com/project-ncl/pnc/pull/2908#discussion_r390890290", "bodyText": "use the pushedResponse.get(0) before this if and everything will be much simpler.", "author": "janinko", "createdAt": "2020-03-11T10:55:54Z", "path": "facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java", "diffHunk": "@@ -121,6 +119,10 @@ public BuildPushResult brewPush(String id, BuildPushRequest buildPushRequest) th\n                                 .build())\n                 .collect(Collectors.toList());\n \n+        if (pushed.stream().anyMatch(r -> r.getMessage().contains(\"BLACKLISTED/DELETED\"))) {", "originalCommit": "bf0c576c1120adb1b0fd991bd67c1cfe33c4f49c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "08a06a606691c92e42086c76abf09d6b499232cb", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java b/facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java\nindex 4957ac510..53a768574 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/impl/BrewPusherImpl.java\n\n@@ -118,12 +118,13 @@ public class BrewPusherImpl implements BrewPusher {\n                                 .log(r.getMessage())\n                                 .build())\n                 .collect(Collectors.toList());\n+        BuildPushResult result = pushedResponse.get(0);\n \n-        if (pushed.stream().anyMatch(r -> r.getMessage().contains(\"BLACKLISTED/DELETED\"))) {\n+        if (result.getLog().contains(\"BLACKLISTED/DELETED\"))) {\n             throw new ClientErrorException(Response.status(403).entity(pushedResponse.get(0)).build());\n         }\n \n-        return pushedResponse.get(0);\n+        return result;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MDkzNA==", "url": "https://github.com/project-ncl/pnc/pull/2908#discussion_r390890934", "bodyText": "the schema is actually BuildPushResultPage", "author": "janinko", "createdAt": "2020-03-11T10:57:07Z", "path": "rest-api/src/main/java/org/jboss/pnc/rest/api/endpoints/BuildEndpoint.java", "diffHunk": "@@ -328,6 +330,10 @@ void removeAttribute(\n                             responseCode = INVALID_CODE,\n                             description = INVALID_DESCRIPTION,\n                             content = @Content(schema = @Schema(implementation = ErrorResponse.class))),\n+                    @ApiResponse(\n+                            responseCode = FORBIDDEN_CODE,\n+                            description = FORBIDDEN_PUSH_DESCRIPTION,\n+                            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),", "originalCommit": "bf0c576c1120adb1b0fd991bd67c1cfe33c4f49c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "08a06a606691c92e42086c76abf09d6b499232cb", "chunk": "diff --git a/rest-api/src/main/java/org/jboss/pnc/rest/api/endpoints/BuildEndpoint.java b/rest-api/src/main/java/org/jboss/pnc/rest/api/endpoints/BuildEndpoint.java\nindex 55a1fcb1a..e8ae8df53 100644\n--- a/rest-api/src/main/java/org/jboss/pnc/rest/api/endpoints/BuildEndpoint.java\n+++ b/rest-api/src/main/java/org/jboss/pnc/rest/api/endpoints/BuildEndpoint.java\n\n@@ -333,7 +333,7 @@ public interface BuildEndpoint {\n                     @ApiResponse(\n                             responseCode = FORBIDDEN_CODE,\n                             description = FORBIDDEN_PUSH_DESCRIPTION,\n-                            content = @Content(schema = @Schema(implementation = ErrorResponse.class))),\n+                            content = @Content(schema = @Schema(implementation = BuildPushResultPage.class))),\n                     @ApiResponse(\n                             responseCode = CONFLICTED_CODE,\n                             description = CONFLICTED_DESCRIPTION,\n"}}, {"oid": "08a06a606691c92e42086c76abf09d6b499232cb", "url": "https://github.com/project-ncl/pnc/commit/08a06a606691c92e42086c76abf09d6b499232cb", "message": "[NCL-5558] Respond with 403 status when Brew Push is forbidden because of bad artifact quality", "committedDate": "2020-03-11T12:23:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NzY4MA==", "url": "https://github.com/project-ncl/pnc/pull/2908#discussion_r390947680", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String FORBIDDEN_PUSH_DESCRIPTION = \"Build contains artifacts of of insufficient quality\";\n          \n          \n            \n                public static final String FORBIDDEN_PUSH_DESCRIPTION = \"Build contains artifacts of insufficient quality\";", "author": "michalovjan", "createdAt": "2020-03-11T12:51:42Z", "path": "rest-api/src/main/java/org/jboss/pnc/rest/configuration/SwaggerConstants.java", "diffHunk": "@@ -42,6 +42,7 @@\n     public static final String INVALID_CODE = \"400\";\n     public static final String FORBIDDEN_DESCRIPTION = \"User must be logged in.\";\n     public static final String FORBIDDEN_CODE = \"403\";\n+    public static final String FORBIDDEN_PUSH_DESCRIPTION = \"Build contains artifacts of of insufficient quality\";", "originalCommit": "08a06a606691c92e42086c76abf09d6b499232cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk3MjY5OQ==", "url": "https://github.com/project-ncl/pnc/pull/2908#discussion_r390972699", "bodyText": "eagle eye!", "author": "jomrazek", "createdAt": "2020-03-11T13:34:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0NzY4MA=="}], "type": "inlineReview", "revised_code": {"commit": "f5ce2a8f7a35ca026124968e2412d8bf7da54970", "chunk": "diff --git a/rest-api/src/main/java/org/jboss/pnc/rest/configuration/SwaggerConstants.java b/rest-api/src/main/java/org/jboss/pnc/rest/configuration/SwaggerConstants.java\nindex dc35fb53b..f96912cb7 100644\n--- a/rest-api/src/main/java/org/jboss/pnc/rest/configuration/SwaggerConstants.java\n+++ b/rest-api/src/main/java/org/jboss/pnc/rest/configuration/SwaggerConstants.java\n\n@@ -42,7 +42,7 @@ public interface SwaggerConstants {\n     public static final String INVALID_CODE = \"400\";\n     public static final String FORBIDDEN_DESCRIPTION = \"User must be logged in.\";\n     public static final String FORBIDDEN_CODE = \"403\";\n-    public static final String FORBIDDEN_PUSH_DESCRIPTION = \"Build contains artifacts of of insufficient quality\";\n+    public static final String FORBIDDEN_PUSH_DESCRIPTION = \"Build contains artifacts of insufficient quality\";\n     public static final String MOVED_TEMPORARILY_DESCRIPTION = \"Redirected to resource\";\n     public static final String MOVED_TEMPORARILY_CODE = \"302\";\n     public static final String NOT_FOUND_DESCRIPTION = \"Can not find specified result\";\n"}}, {"oid": "f5ce2a8f7a35ca026124968e2412d8bf7da54970", "url": "https://github.com/project-ncl/pnc/commit/f5ce2a8f7a35ca026124968e2412d8bf7da54970", "message": "[NCL-5558] Respond with 403 status when Brew Push is forbidden because of bad artifact quality", "committedDate": "2020-03-11T16:16:28Z", "type": "commit"}, {"oid": "f5ce2a8f7a35ca026124968e2412d8bf7da54970", "url": "https://github.com/project-ncl/pnc/commit/f5ce2a8f7a35ca026124968e2412d8bf7da54970", "message": "[NCL-5558] Respond with 403 status when Brew Push is forbidden because of bad artifact quality", "committedDate": "2020-03-11T16:16:28Z", "type": "forcePushed"}]}