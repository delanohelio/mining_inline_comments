{"pr_number": 3342, "pr_title": "[NCL-6011] Add websocket notifications for milestone push jobs", "pr_createdAt": "2020-10-07T09:52:10Z", "pr_url": "https://github.com/project-ncl/pnc/pull/3342", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDAxMg==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r500890012", "bodyText": "Please add super.close() there so that the underlying regular client closes too.", "author": "michalovjan", "createdAt": "2020-10-07T10:02:00Z", "path": "rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient;\n+\n+import org.jboss.pnc.client.Configuration;\n+import org.jboss.pnc.client.ProductMilestoneClient;\n+import org.jboss.pnc.client.RemoteResourceException;\n+import org.jboss.pnc.dto.ProductMilestoneCloseResult;\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+import org.jboss.pnc.restclient.websocket.VertxWebSocketClient;\n+import org.jboss.pnc.restclient.websocket.WebSocketClient;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import static org.jboss.pnc.restclient.websocket.predicates.ProductMilestoneCloseResultNotificationPredicates.withMilestoneId;\n+\n+public class AdvancedProductMilestoneClient extends ProductMilestoneClient {\n+\n+    private WebSocketClient webSocketClient = new VertxWebSocketClient();\n+\n+    public AdvancedProductMilestoneClient(Configuration configuration) {\n+        super(configuration);\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> waitForMilestoneClose(String milestoneId) {\n+        webSocketClient.connect(\"ws://\" + configuration.getHost() + BASE_PATH + \"/notifications\").join();\n+        return webSocketClient.catchProductMilestoneCloseResult(withMilestoneId(milestoneId))\n+                .thenApply(ProductMilestoneCloseResultNotification::getProductMilestoneCloseResult)\n+                .whenComplete((x, y) -> webSocketClient.disconnect());\n+    }\n+\n+    public CompletableFuture<ProductMilestoneCloseResult> executeMilestoneClose(String milestoneId)\n+            throws RemoteResourceException {\n+        CompletableFuture<ProductMilestoneCloseResult> future = waitForMilestoneClose(milestoneId);\n+        super.closeMilestone(milestoneId);\n+        return future;\n+    }\n+\n+    @Override\n+    public void close() {\n+        if (webSocketClient != null) {", "originalCommit": "7d70cbc7cab14c1bc687c460379904ddeb094eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzA4MjA0NA==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507082044", "bodyText": "btw neither of other advanced clients are doing this", "author": "jomrazek", "createdAt": "2020-10-18T10:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MjUxMA==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507682510", "bodyText": "I am aware. I've got them fixed in up-and-not-in-nearest-time-coming issue NCL-5662. It'd be great to have it fixed in 2.0.1.", "author": "michalovjan", "createdAt": "2020-10-19T11:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDAxMg=="}], "type": "inlineReview", "revised_code": {"commit": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "chunk": "diff --git a/rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java b/rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java\nindex ee60cfc19..47fb33e08 100644\n--- a/rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java\n+++ b/rest-client/src/main/java/org/jboss/pnc/restclient/AdvancedProductMilestoneClient.java\n\n@@ -55,6 +55,7 @@ public class AdvancedProductMilestoneClient extends ProductMilestoneClient {\n     public void close() {\n         if (webSocketClient != null) {\n             try {\n+                super.close();\n                 webSocketClient.close();\n             } catch (Exception e) {\n                 throw new RuntimeException(\"Couldn't close websocket\", e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDUwNQ==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r500890505", "bodyText": "JavaDoc :D", "author": "michalovjan", "createdAt": "2020-10-07T10:02:46Z", "path": "rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java", "diffHunk": "@@ -196,6 +197,10 @@ ListenerUnsubscriber onSCMRepositoryCreationSuccess(\n             Consumer<SCMRepositoryCreationSuccess> onNotification,\n             Predicate<SCMRepositoryCreationSuccess>... filters) throws ConnectionClosedException;\n \n+    ListenerUnsubscriber onProductMilestoneCloseResult(", "originalCommit": "7d70cbc7cab14c1bc687c460379904ddeb094eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzA4MTg5Ng==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507081896", "bodyText": "yup fail...", "author": "jomrazek", "createdAt": "2020-10-18T10:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg5MDUwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "chunk": "diff --git a/rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java b/rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java\nindex aec3ff824..cac45afdd 100644\n--- a/rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java\n+++ b/rest-client/src/main/java/org/jboss/pnc/restclient/websocket/WebSocketClient.java\n\n@@ -197,6 +197,16 @@ public interface WebSocketClient extends AutoCloseable {\n             Consumer<SCMRepositoryCreationSuccess> onNotification,\n             Predicate<SCMRepositoryCreationSuccess>... filters) throws ConnectionClosedException;\n \n+    /**\n+     * Specific version of {@link #onMessage} method for {@link ProductMilestoneCloseResultNotification}.\n+     *\n+     * @param onNotification listener invoked on notification\n+     * @param filters the filters\n+     * @return the listener unsubscriber\n+     * @throws ConnectionClosedException The exception is thrown, when attempting to register a listener on closed\n+     *         connection.\n+     * @see #onMessage\n+     */\n     ListenerUnsubscriber onProductMilestoneCloseResult(\n             Consumer<ProductMilestoneCloseResultNotification> onNotification,\n             Predicate<ProductMilestoneCloseResultNotification>... filters) throws ConnectionClosedException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r503883866", "bodyText": "If the close fails, is the milestone present? I'd like to avoid all possible NPEs.", "author": "michalovjan", "createdAt": "2020-10-13T11:45:40Z", "path": "rest-client/src/main/java/org/jboss/pnc/restclient/websocket/predicates/ProductMilestoneCloseResultNotificationPredicates.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2014-2020 Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.jboss.pnc.restclient.websocket.predicates;\n+\n+import org.jboss.pnc.dto.notification.ProductMilestoneCloseResultNotification;\n+\n+import java.util.function.Predicate;\n+\n+public final class ProductMilestoneCloseResultNotificationPredicates {\n+\n+    public static Predicate<ProductMilestoneCloseResultNotification> withMilestoneId(String milestoneId) {\n+        return (notification) -> notification.getProductMilestoneCloseResult() == null ? false\n+                : notification.getProductMilestoneCloseResult().getMilestone().getId().equals(milestoneId);", "originalCommit": "7d70cbc7cab14c1bc687c460379904ddeb094eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzA4NDI3Mw==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507084273", "bodyText": "if it fails it throws exception, if no there should be result available", "author": "jomrazek", "createdAt": "2020-10-18T10:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY4MDg5Mw==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507680893", "bodyText": "I meant it like this scenario. You request a milestone close (request is successful) -> milestone closing in progress -> milestone close fails -> orch sends a notification that the close failed. Will the notification have anything missing that could throw NPE here?", "author": "michalovjan", "createdAt": "2020-10-19T11:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5MDM2MA==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507690360", "bodyText": "even if it fails \"regularly\" without throwing exception, milestone is set and this should not throw npe", "author": "jomrazek", "createdAt": "2020-10-19T12:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzY5NzQ5MA==", "url": "https://github.com/project-ncl/pnc/pull/3342#discussion_r507697490", "bodyText": "no problem then!", "author": "michalovjan", "createdAt": "2020-10-19T12:15:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4Mzg2Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "url": "https://github.com/project-ncl/pnc/commit/f8f2fb9918d33c8fcc830c441c742bf60579f254", "message": "[NCL-6011] Add websocket notifications for milestone push jobs", "committedDate": "2020-10-18T10:25:27Z", "type": "commit"}, {"oid": "f8f2fb9918d33c8fcc830c441c742bf60579f254", "url": "https://github.com/project-ncl/pnc/commit/f8f2fb9918d33c8fcc830c441c742bf60579f254", "message": "[NCL-6011] Add websocket notifications for milestone push jobs", "committedDate": "2020-10-18T10:25:27Z", "type": "forcePushed"}, {"oid": "25051642d19e9f4e63fa2e6b5ae05fa9273d37cd", "url": "https://github.com/project-ncl/pnc/commit/25051642d19e9f4e63fa2e6b5ae05fa9273d37cd", "message": "Close also regular clients when closing advanced ones", "committedDate": "2020-10-19T12:58:09Z", "type": "commit"}]}