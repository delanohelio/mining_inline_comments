{"pr_number": 2961, "pr_title": "NCL-5497 - Store User in BuildConfiguration and BuildConfigurationAudited", "pr_createdAt": "2020-04-07T11:29:24Z", "pr_url": "https://github.com/project-ncl/pnc/pull/2961", "timeline": [{"oid": "dc781cfe55a3587cf237e1bf47ecc0f27e5a89cb", "url": "https://github.com/project-ncl/pnc/commit/dc781cfe55a3587cf237e1bf47ecc0f27e5a89cb", "message": "NCL-5497 - Store User in BuildConfiguration and BuildConfigurationAudited", "committedDate": "2020-04-07T10:33:30Z", "type": "commit"}, {"oid": "ae30a557e2774b8c9635bfaf1823931cdea679db", "url": "https://github.com/project-ncl/pnc/commit/ae30a557e2774b8c9635bfaf1823931cdea679db", "message": "Add sql script to add new columns, indexes, foreign keys", "committedDate": "2020-04-07T11:27:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc1ODM2Mw==", "url": "https://github.com/project-ncl/pnc/pull/2961#discussion_r404758363", "bodyText": "Here you are changing the creationUser of existing BC. This method creates new BC-audited for existing BC. It's called createRevision because from API point it is creating new entity, but it's actually just updating the BC.", "author": "janinko", "createdAt": "2020-04-07T12:10:35Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java", "diffHunk": "@@ -219,6 +239,9 @@ public BuildConfigurationRevision createRevision(String id, BuildConfiguration b\n             return buildConfigurationRevisionMapper.toDTO(latestRevision);\n         }\n         bcEntity.setCreationTime(latestRevision.getCreationTime());\n+        org.jboss.pnc.model.User user = userService.currentUser();\n+        bcEntity.setCreationUser(user);", "originalCommit": "ae30a557e2774b8c9635bfaf1823931cdea679db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NjAyMw==", "url": "https://github.com/project-ncl/pnc/pull/2961#discussion_r404776023", "bodyText": "ah good point, thanks for the clarification, the name tricked me, I am now going to update just the lastModificationUser", "author": "vibe13", "createdAt": "2020-04-07T12:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc1ODM2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5ac6ce52324b448da217595bdac74685d9135562", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\nindex 66591d5e9..8093905a2 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n\n@@ -240,7 +240,6 @@ public class BuildConfigurationProviderImpl\n         }\n         bcEntity.setCreationTime(latestRevision.getCreationTime());\n         org.jboss.pnc.model.User user = userService.currentUser();\n-        bcEntity.setCreationUser(user);\n         bcEntity.setLastModificationUser(user);\n \n         buildConfigRevisionHelper.updateBuildConfiguration(bcEntity);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MjI0NQ==", "url": "https://github.com/project-ncl/pnc/pull/2961#discussion_r404762245", "bodyText": "Dependencies are not audited. Should we update the user even when no audited data got changed?", "author": "janinko", "createdAt": "2020-04-07T12:17:23Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java", "diffHunk": "@@ -308,6 +335,7 @@ public void addDependency(String configId, String dependencyId) {\n \n         logger.debug(\"Didn't throw any validation errors\");\n         buildConfig.addDependency(dependency);\n+        buildConfig.setLastModificationUser(user);", "originalCommit": "ae30a557e2774b8c9635bfaf1823931cdea679db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MDM4OA==", "url": "https://github.com/project-ncl/pnc/pull/2961#discussion_r404780388", "bodyText": "I would have done that by default, if anything got changed in the BuildConfiguration, I would have updated the lastModificationUser, even if the changes were not audited. But that would indeed cause some confusion now, as users would see a lastModificationUser changed but possibly no corresponding revision in the list...so yep, better not updating it at the moment. Thanks!", "author": "vibe13", "createdAt": "2020-04-07T12:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MjI0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5ac6ce52324b448da217595bdac74685d9135562", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\nindex 66591d5e9..8093905a2 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n\n@@ -335,7 +333,6 @@ public class BuildConfigurationProviderImpl\n \n         logger.debug(\"Didn't throw any validation errors\");\n         buildConfig.addDependency(dependency);\n-        buildConfig.setLastModificationUser(user);\n         repository.save(buildConfig);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MjMzNQ==", "url": "https://github.com/project-ncl/pnc/pull/2961#discussion_r404762335", "bodyText": "^", "author": "janinko", "createdAt": "2020-04-07T12:17:34Z", "path": "facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java", "diffHunk": "@@ -316,12 +344,14 @@ public void removeDependency(String configId, String dependencyId) {\n \n         org.jboss.pnc.model.BuildConfiguration buildConfig = repository.queryById(Integer.valueOf(configId));\n         org.jboss.pnc.model.BuildConfiguration dependency = repository.queryById(Integer.valueOf(dependencyId));\n+        org.jboss.pnc.model.User user = userService.currentUser();\n \n         ValidationBuilder.validateObject(buildConfig, WhenUpdating.class)\n                 .validateCondition(buildConfig != null, \"No build config exists with id: \" + configId)\n                 .validateCondition(dependency != null, \"No dependency build config exists with id: \" + dependencyId);\n \n         buildConfig.removeDependency(dependency);\n+        buildConfig.setLastModificationUser(user);", "originalCommit": "ae30a557e2774b8c9635bfaf1823931cdea679db", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ac6ce52324b448da217595bdac74685d9135562", "chunk": "diff --git a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\nindex 66591d5e9..8093905a2 100644\n--- a/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n+++ b/facade/src/main/java/org/jboss/pnc/facade/providers/BuildConfigurationProviderImpl.java\n\n@@ -344,14 +341,12 @@ public class BuildConfigurationProviderImpl\n \n         org.jboss.pnc.model.BuildConfiguration buildConfig = repository.queryById(Integer.valueOf(configId));\n         org.jboss.pnc.model.BuildConfiguration dependency = repository.queryById(Integer.valueOf(dependencyId));\n-        org.jboss.pnc.model.User user = userService.currentUser();\n \n         ValidationBuilder.validateObject(buildConfig, WhenUpdating.class)\n                 .validateCondition(buildConfig != null, \"No build config exists with id: \" + configId)\n                 .validateCondition(dependency != null, \"No dependency build config exists with id: \" + dependencyId);\n \n         buildConfig.removeDependency(dependency);\n-        buildConfig.setLastModificationUser(user);\n         repository.save(buildConfig);\n     }\n \n"}}, {"oid": "5ac6ce52324b448da217595bdac74685d9135562", "url": "https://github.com/project-ncl/pnc/commit/5ac6ce52324b448da217595bdac74685d9135562", "message": "Do not change lastModificatioUser when changing dependencies; do not change creationUser when creating a new revision", "committedDate": "2020-04-07T12:53:20Z", "type": "commit"}, {"oid": "92e85012833129d930124d7f356312447895dcb0", "url": "https://github.com/project-ncl/pnc/commit/92e85012833129d930124d7f356312447895dcb0", "message": "Apply correct formatting", "committedDate": "2020-04-07T13:35:48Z", "type": "commit"}]}