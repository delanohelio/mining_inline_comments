{"pr_number": 327, "pr_title": "Rendering optimizations", "pr_createdAt": "2020-10-18T07:20:42Z", "pr_url": "https://github.com/dedica-team/nivio/pull/327", "timeline": [{"oid": "cfe2143b6532c883fafc091e0e502a682af02caf", "url": "https://github.com/dedica-team/nivio/commit/cfe2143b6532c883fafc091e0e502a682af02caf", "message": "[#326] extended test data, added debug request param", "committedDate": "2020-10-17T12:05:11Z", "type": "commit"}, {"oid": "8ae4ea9345aec4739e57e9af77c0e8eeec2ab313", "url": "https://github.com/dedica-team/nivio/commit/8ae4ea9345aec4739e57e9af77c0e8eeec2ab313", "message": "[#326] extending group area, fix for missed items", "committedDate": "2020-10-17T12:11:30Z", "type": "commit"}, {"oid": "68b910dafc481a80ae0330a38939926613c0c6db", "url": "https://github.com/dedica-team/nivio/commit/68b910dafc481a80ae0330a38939926613c0c6db", "message": "Merge branch 'develop' into rendering_optimizations", "committedDate": "2020-10-17T16:06:16Z", "type": "commit"}, {"oid": "36acf3b68f1aee0ff3cfa3d2b47522da11c8c202", "url": "https://github.com/dedica-team/nivio/commit/36acf3b68f1aee0ff3cfa3d2b47522da11c8c202", "message": "[#325] reducing map file size", "committedDate": "2020-10-18T06:04:50Z", "type": "commit"}, {"oid": "cbde401d9e061f055150e68cd061cf7bb66aacbb", "url": "https://github.com/dedica-team/nivio/commit/cbde401d9e061f055150e68cd061cf7bb66aacbb", "message": "[#325] less aggressive growing of group areas", "committedDate": "2020-10-18T06:05:22Z", "type": "commit"}, {"oid": "a3b5a8a2f1f78e679887d73f2e64c731c1d6fd0f", "url": "https://github.com/dedica-team/nivio/commit/a3b5a8a2f1f78e679887d73f2e64c731c1d6fd0f", "message": "higher group area opacity", "committedDate": "2020-10-18T06:15:39Z", "type": "commit"}, {"oid": "d954a1bb54a5cc5523cf083556d37ebd2cac4912", "url": "https://github.com/dedica-team/nivio/commit/d954a1bb54a5cc5523cf083556d37ebd2cac4912", "message": "item label position below", "committedDate": "2020-10-18T06:35:09Z", "type": "commit"}, {"oid": "06e76ff97284238559643bebac645e26ff6c7336", "url": "https://github.com/dedica-team/nivio/commit/06e76ff97284238559643bebac645e26ff6c7336", "message": "integer precision is sufficient for group outlines", "committedDate": "2020-10-18T06:39:54Z", "type": "commit"}, {"oid": "0e2336af5e8435ed31b857964df19e9f201d534e", "url": "https://github.com/dedica-team/nivio/commit/0e2336af5e8435ed31b857964df19e9f201d534e", "message": "moved group label down a little", "committedDate": "2020-10-18T07:23:43Z", "type": "commit"}, {"oid": "1c0e1846e0251c4d0a8d6ef961238b0a59138a32", "url": "https://github.com/dedica-team/nivio/commit/1c0e1846e0251c4d0a8d6ef961238b0a59138a32", "message": "slightly less triangle in data flow relation rendering", "committedDate": "2020-10-18T07:40:55Z", "type": "commit"}, {"oid": "5e8b14fbf97ab973fb04e140848e53677e8de487", "url": "https://github.com/dedica-team/nivio/commit/5e8b14fbf97ab973fb04e140848e53677e8de487", "message": "svg group area fix", "committedDate": "2020-10-18T10:18:15Z", "type": "commit"}, {"oid": "161c657b010e63a7bd8b1f96b028235657e8ceb5", "url": "https://github.com/dedica-team/nivio/commit/161c657b010e63a7bd8b1f96b028235657e8ceb5", "message": "cleanup", "committedDate": "2020-10-18T10:19:07Z", "type": "commit"}, {"oid": "b018d5b4dadc4532fe1c8e5abd8b3b02474afa48", "url": "https://github.com/dedica-team/nivio/commit/b018d5b4dadc4532fe1c8e5abd8b3b02474afa48", "message": "some background hex tweaks", "committedDate": "2020-10-18T19:15:57Z", "type": "commit"}, {"oid": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "url": "https://github.com/dedica-team/nivio/commit/8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "message": "cleanup", "committedDate": "2020-10-18T19:22:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MDU3Mw==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508070573", "bodyText": "About the TODO, that was mine I think :D The first one ItemFactory, the second one, no one. What do we need it for?", "author": "mfbieber", "createdAt": "2020-10-19T21:23:00Z", "path": "src/main/java/de/bonndan/nivio/model/ServiceInterface.java", "diffHunk": "@@ -18,7 +18,6 @@\n     public ServiceInterface() {\n     }\n \n-    //TODO: who uses these constructors?\n     public ServiceInterface(InterfaceDescription interfaceItem) {", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxMTk5NA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508211994", "bodyText": "The other way round: the first one is unused. I have removed it now.", "author": "bonndan", "createdAt": "2020-10-20T05:06:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MDU3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "4ec3b1c73730620748eca756c5ff4a189891526f", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/model/ServiceInterface.java b/src/main/java/de/bonndan/nivio/model/ServiceInterface.java\nindex c293bb37..352964fb 100644\n--- a/src/main/java/de/bonndan/nivio/model/ServiceInterface.java\n+++ b/src/main/java/de/bonndan/nivio/model/ServiceInterface.java\n\n@@ -15,9 +15,6 @@ public class ServiceInterface {\n     private URL url;\n     private String protection;\n \n-    public ServiceInterface() {\n-    }\n-\n     public ServiceInterface(InterfaceDescription interfaceItem) {\n         this.description = interfaceItem.getDescription();\n         this.format = interfaceItem.getFormat();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MzY3Ng==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508073676", "bodyText": "\ud83d\udc4d", "author": "mfbieber", "createdAt": "2020-10-19T21:29:23Z", "path": "src/main/java/de/bonndan/nivio/output/Color.java", "diffHunk": "@@ -52,11 +52,14 @@ public static String getGroupColor(Item item) {\n     }\n \n     public static String getGroupColor(String name, Landscape landscape) {\n-        Group g = landscape.getGroup(name).orElse(landscape.getGroup(Group.COMMON).get()); //TODO: optional.get() without ifPresent check\n+        Group g = landscape.getGroup(name).orElse(landscape.getGroup(Group.COMMON).orElse(null));\n         return getGroupColor(g);\n     }\n \n     public static String getGroupColor(Group group) {\n+        if (group == null) {\n+            return Color.DARKGRAY;\n+        }", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3ODE2Mg==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508078162", "bodyText": "I just checked the usage of this method (I tend to do such things while reviewing :D), my IDE shows me no usage - is this correct, or what was it intended for?", "author": "mfbieber", "createdAt": "2020-10-19T21:38:56Z", "path": "src/main/java/de/bonndan/nivio/output/Renderer.java", "diffHunk": "@@ -12,7 +12,7 @@\n  */\n public interface Renderer<T> {\n \n-    T render(LayoutedComponent landscape);\n+    T render(LayoutedComponent layoutedComponent, boolean debug);\n \n-    void render(LayoutedComponent landscape, File file) throws IOException;\n+    void render(LayoutedComponent landscape, File file, boolean debug) throws IOException;", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNDMyOQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508214329", "bodyText": "I've added some documentation to the interface which hopefully explains my intention. Although the second method is not used yet, I'd like to keep it. There have been different renderers before (e.g. png binary output), and maybe there will be others (3D stuff?).", "author": "bonndan", "createdAt": "2020-10-20T05:15:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3ODE2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f39d66f01f00a35a48612f9e41d5e1f3c142a73d", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/Renderer.java b/src/main/java/de/bonndan/nivio/output/Renderer.java\nindex 4d9dae45..286127dd 100644\n--- a/src/main/java/de/bonndan/nivio/output/Renderer.java\n+++ b/src/main/java/de/bonndan/nivio/output/Renderer.java\n\n@@ -12,7 +12,22 @@ import java.io.IOException;\n  */\n public interface Renderer<T> {\n \n-    T render(LayoutedComponent layoutedComponent, boolean debug);\n+    /**\n+     * Renders a landscape layout to the given type.\n+     *\n+     * @param landscape layouted landscape\n+     * @param debug             if true, result may contain extra elements to show internal rendering details\n+     * @return the rendering result in the given type\n+     */\n+    T render(LayoutedComponent landscape, boolean debug);\n \n+    /**\n+     * Renders the layouted landscape and writes the result directly into a file.\n+     *\n+     * @param landscape layouted landscape\n+     * @param file      destination file\n+     * @param debug     if true, result may contain extra elements to show internal rendering details\n+     * @throws IOException if file cannot be written\n+     */\n     void render(LayoutedComponent landscape, File file, boolean debug) throws IOException;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3ODcyMQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508078721", "bodyText": "Do we have a switch in the frontend to trigger the debug view?", "author": "mfbieber", "createdAt": "2020-10-19T21:40:11Z", "path": "src/main/java/de/bonndan/nivio/output/map/MapController.java", "diffHunk": "@@ -33,14 +30,16 @@ public MapController(LandscapeRepository landscapeRepository, RenderCache render\n \n     @CrossOrigin(methods = RequestMethod.GET)\n     @RequestMapping(method = RequestMethod.GET, path = \"/{landscape}/\" + MAP_SVG_ENDPOINT)\n-    public ResponseEntity<String> svg(@PathVariable(name = \"landscape\") final String landscapeIdentifier) {\n+    public ResponseEntity<String> svg(@PathVariable(name = \"landscape\") final String landscapeIdentifier,\n+                                      @RequestParam(value = \"debug\", required = false, defaultValue = \"false\") boolean debug\n+    ) {\n         Landscape landscape = getLandscape(landscapeIdentifier);\n \n         try {\n             HttpHeaders headers = new HttpHeaders();\n             headers.add(HttpHeaders.CONTENT_TYPE, \"image/svg+xml\");\n             return new ResponseEntity<>(\n-                    renderCache.getSVG(landscape),\n+                    renderCache.getSVG(landscape, debug),", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNDY4Nw==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508214687", "bodyText": "Yes, the svg map endpoint accepts a request param. However, I'd like to keep it hidden for now.", "author": "bonndan", "createdAt": "2020-10-20T05:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3ODcyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4OTgzMA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508089830", "bodyText": "This logic is hard to review. Maybe it is best if we talk this through in a call?\nAre our tests good enough? I saw that you did not need to make many changes there :)", "author": "mfbieber", "createdAt": "2020-10-19T22:05:10Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -34,37 +35,57 @@\n \n         Set<Item> items = group.getItems();\n         Set<Hex> inArea = new HashSet<>();\n+        List<Item> connected = new ArrayList<>();\n \n+        if (!items.iterator().hasNext()) {\n+            LOGGER.warn(\"Could not determine group area for group {}\", group);\n+            return inArea;\n+        }\n         //surround each item\n-        items.forEach(item -> {\n-            Hex hex = allVertexHexes.get(item);\n+        Item next = items.iterator().next();\n+        while (next != null) {\n+\n+            LOGGER.debug(\"adding {} to group area\", next);\n+            Hex hex = allVertexHexes.get(next);\n             inArea.add(hex);\n             hex.neighbours().forEach(neigh -> {\n                 if (!occupied.contains(neigh))\n                     inArea.add(neigh);\n             });\n \n-            Set<Hex> closestNeighbours = getClosestItemsHexes(item, items, allVertexHexes);\n+            Optional<Item> closest = getClosestItem(next, items, allVertexHexes, connected);\n+            if (closest.isEmpty()) {\n+                LOGGER.debug(\"no closest item found for {}\", next);\n+                break;\n+            }\n+\n             // we dont care for occupied tiles here, since we just want the closest item within group, and non-group\n             // items cannot be anywhere nearby (other types of obstacles do not exist yet)\n             PathFinder pathFinder = new PathFinder(Set.of());\n-            closestNeighbours.forEach(neighbour -> {\n-                Optional<HexPath> path = pathFinder.getPath(hex, neighbour);\n-                if (path.isEmpty()) {\n-                    return;\n-                }\n+\n+            Hex destination = allVertexHexes.get(closest.get());\n+            Optional<HexPath> path = pathFinder.getPath(hex, destination);\n+            if (path.isPresent()) {\n                 Set<Hex> padded = new HashSet<>(); //pad to avoid thin bridges, also workaround for svh outline issue\n                 path.get().getHexes().forEach(pathTile -> {\n                     padded.add(pathTile);\n                     padded.addAll(pathTile.neighbours());\n                 });\n                 padded.stream().filter(hex1 -> !occupied.contains(hex1)).forEach(inArea::add);\n-            });\n+            }\n \n-        });\n+            connected.add(next);\n+            // stop if the next one has been connected already\n+            next = connected.contains(closest.get()) ? null : closest.get();\n+        }\n+\n+        // adding hexes with many sides adjacent to group area until no more can be added\n \n-        Set<Hex> bridges = getBridges(inArea);\n-        inArea.addAll(bridges);\n+        Set<Hex> bridges = getBridges(inArea, 2);\n+        while (!bridges.isEmpty()) {\n+            inArea.addAll(bridges);\n+            bridges = getBridges(inArea, 3); // 2 might be too aggressive and collide with other group areas\n+        }\n \n         return inArea;", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4f15a0a57e19997dde35913b8183a9ead1fb0f11", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex cfb453db..9434b1d0 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n\n@@ -66,7 +66,7 @@ public class GroupAreaFactory {\n             Hex destination = allVertexHexes.get(closest.get());\n             Optional<HexPath> path = pathFinder.getPath(hex, destination);\n             if (path.isPresent()) {\n-                Set<Hex> padded = new HashSet<>(); //pad to avoid thin bridges, also workaround for svh outline issue\n+                Set<Hex> padded = new HashSet<>(); //pad to avoid thin bridges, also workaround for svg outline issue\n                 path.get().getHexes().forEach(pathTile -> {\n                     padded.add(pathTile);\n                     padded.addAll(pathTile.neighbours());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5MzY0OA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508093648", "bodyText": "Where does the necesity of the AtomicReference arise? What could (concurrently) change/read that reference?", "author": "mfbieber", "createdAt": "2020-10-19T22:14:33Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -75,41 +96,42 @@\n      * @param item           the current group item\n      * @param items          all group items\n      * @param allVertexHexes item hex mapping\n+     * @param connected\n      * @return the closest neighbours\n      */\n-    private static Set<Hex> getClosestItemsHexes(Item item, Set<Item> items, Map<Item, Hex> allVertexHexes) {\n+    private static Optional<Item> getClosestItem(Item item, Set<Item> items, Map<Item, Hex> allVertexHexes, List<Item> connected) {\n         Hex start = allVertexHexes.get(item);\n         AtomicInteger minDist = new AtomicInteger(Integer.MAX_VALUE);\n-        final Set<Hex> min = new HashSet<>();\n+        AtomicReference<Item> min = new AtomicReference<>(null);", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNTMzMg==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508215332", "bodyText": "It's the stream below which requires a (effectively) final variable.", "author": "bonndan", "createdAt": "2020-10-20T05:19:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5MzY0OA=="}], "type": "inlineReview", "revised_code": {"commit": "41d59ff45a6fa3f8f3ac6a5aa21a85fd757a9602", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex cfb453db..4463b125 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n\n@@ -96,18 +98,18 @@ public class GroupAreaFactory {\n      * @param item           the current group item\n      * @param items          all group items\n      * @param allVertexHexes item hex mapping\n-     * @param connected\n+     * @param connected      the items which have been connected previously\n      * @return the closest neighbours\n      */\n-    private static Optional<Item> getClosestItem(Item item, Set<Item> items, Map<Item, Hex> allVertexHexes, List<Item> connected) {\n-        Hex start = allVertexHexes.get(item);\n+    private static Optional<Item> getClosestItem(Item item, Set<Item> items, BidiMap<Hex, Object> allVertexHexes, List<Item> connected) {\n+        Hex start = allVertexHexes.getKey(item);\n         AtomicInteger minDist = new AtomicInteger(Integer.MAX_VALUE);\n         AtomicReference<Item> min = new AtomicReference<>(null);\n         items.stream()\n                 .filter(otherGroupItem -> !item.equals(otherGroupItem))\n                 .filter(otherGroupItem -> !connected.contains(otherGroupItem))\n                 .forEach(otherGroupItem -> {\n-                    Hex dest = allVertexHexes.get(otherGroupItem);\n+                    Hex dest = allVertexHexes.getKey(otherGroupItem);\n                     int distance = start.distance(dest);\n                     if (distance > minDist.get()) {\n                         return;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5NDIxMQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508094211", "bodyText": "This is also tough to review, we could discuss this in a call.\nI did not find a test for this \ud83d\ude28, we should have one!", "author": "mfbieber", "createdAt": "2020-10-19T22:15:46Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package de.bonndan.nivio.output.map.svg;\n+\n+import de.bonndan.nivio.output.map.hex.Hex;\n+import j2html.tags.ContainerTag;\n+\n+import java.awt.geom.Point2D;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static java.lang.Math.round;\n+\n+public class SVGBackgroundFactory {\n+\n+    private static final String HEX = \"hex\";\n+\n+    public static ContainerTag getHex() {\n+        ContainerTag fullHex = (ContainerTag) new SVGHex(new Hex(0, 0), \"none\", \"#cccccc\")\n+                .render();\n+        fullHex.attr(\"id\", \"hex\");\n+        return fullHex;\n+    }\n+\n+    public static List<ContainerTag> getBackgroundTiles(int minQ, int maxQ, int minR, int maxR, int height) {\n+        //render background hexes\n+        List<ContainerTag> background = new ArrayList<>();\n+        var i = 0;\n+        for (int q = minQ; q <= maxQ; q++) {\n+            for (int r = minR - i; r < (maxR + maxQ - q); r++) {\n+                Point2D.Double hex = new Hex(q, r).toPixel();\n+                float y = round((hex.y + 146)*10f)/10f ; //TODO why 146? without this bg hexes are displaced\n+                if (y < 0 || y > height) continue;\n+                ContainerTag use = SvgTagCreator.use(\"#\" + HEX)\n+                        .attr(\"x\", (int) hex.x - 2 * Hex.HEX_SIZE)\n+                        .attr(\"y\", y);\n+                background.add(use);\n+            }\n+            i++;\n+        }\n+\n+        return background;\n+    }", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1e1f91145f203eded31dc02e8be4e487a1f4132e", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java b/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\nindex db27a16f..3d543bb1 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\n\n@@ -20,7 +20,7 @@ public class SVGBackgroundFactory {\n         return fullHex;\n     }\n \n-    public static List<ContainerTag> getBackgroundTiles(int minQ, int maxQ, int minR, int maxR, int height) {\n+    public static List<ContainerTag> getBackgroundTiles(int minQ, int maxQ, int minR, int maxR, int minY, int height) {\n         //render background hexes\n         List<ContainerTag> background = new ArrayList<>();\n         var i = 0;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5NTIyNA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508095224", "bodyText": "Is this the logic we now have in SVGBackgroundFactory?", "author": "mfbieber", "createdAt": "2020-10-19T22:18:18Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGDocument.java", "diffHunk": "@@ -120,16 +123,14 @@ public DomContent render() {\n         }).collect(Collectors.toList());\n \n         //render background hexes\n-        var i = 0;\n-        for (int q = minQ.get(); q <= maxQ.get(); q++) {\n-            for (int r = minR.get() - i; r <= (maxR.get() + (maxQ.get())); r++) {\n-                background.add(new SVGHex(new Hex(q, r), \"none\", \"#cccccc\").render());\n-            }\n-            i++;\n-        }\n-\n-        int paddingTopLeft = 2 * Hex.HEX_SIZE;\n-", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIxNTU1Mw==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508215553", "bodyText": "Yes", "author": "bonndan", "createdAt": "2020-10-20T05:19:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5NTIyNA=="}], "type": "inlineReview", "revised_code": {"commit": "41d59ff45a6fa3f8f3ac6a5aa21a85fd757a9602", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/svg/SVGDocument.java b/src/main/java/de/bonndan/nivio/output/map/svg/SVGDocument.java\nindex acc9ac09..a358a4de 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/svg/SVGDocument.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/svg/SVGDocument.java\n\n@@ -122,6 +120,8 @@ public class SVGDocument extends Component {\n             return area.render();\n         }).collect(Collectors.toList());\n \n+        List<SVGRelation> relations = getRelations(layouted);\n+\n         //render background hexes\n         defs.add(SVGBackgroundFactory.getHex());\n         minQ.decrementAndGet();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5NTg4Mw==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508095883", "bodyText": "Why don't we need this anymore?", "author": "mfbieber", "createdAt": "2020-10-19T22:20:01Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGItemLabel.java", "diffHunk": "@@ -2,60 +2,39 @@\n \n import de.bonndan.nivio.model.FullyQualifiedIdentifier;\n import de.bonndan.nivio.model.Item;\n-import de.bonndan.nivio.model.Labeled;\n import j2html.tags.ContainerTag;\n import j2html.tags.DomContent;\n import org.springframework.util.StringUtils;\n \n-import java.util.Map;\n-\n import static de.bonndan.nivio.output.map.svg.SVGRenderer.DEFAULT_ICON_SIZE;\n \n+/**\n+ *\n+ */\n class SVGItemLabel extends Component {\n \n-    public static final int LABEL_WIDTH = 140;\n-    public static final int CORNER_RADIUS = 10;\n-    private final Item item;\n-    private int width;\n+    private final String name;\n+    private final String id;\n+    private final String identifier;\n \n     SVGItemLabel(Item item) {\n-        this.item = item;\n-        this.width = LABEL_WIDTH;\n+        name = StringUtils.isEmpty(item.getName()) ? item.getIdentifier() : item.getName();\n+        id = getId(item);\n+        identifier = item.getFullyQualifiedIdentifier().jsonValue();\n     }\n \n     public DomContent render() {\n-        String name = StringUtils.isEmpty(item.getName()) ? item.getIdentifier() : item.getName();\n-        ContainerTag labelText = new SVGLabelText(name, DEFAULT_ICON_SIZE * 2 + 15 + \"\", \"0\", \"itemLabel\").render();\n \n-        //TODO this is naive\n-        if (name.length() < 10) {\n-            this.width = 100;\n-        }\n-        if (name.length() > 19) {\n-            this.width = 200;\n-        }\n+        ContainerTag labelText = new SVGLabelText(name, \"0\", 2 * DEFAULT_ICON_SIZE + 30 + \"\", \"itemLabel\").render();\n \n         ContainerTag g = SvgTagCreator.g(null, labelText).attr(\"class\", \"label\");\n-        g.attr(\"id\", getId());\n-        g.attr(\"data-identifier\", item.getFullyQualifiedIdentifier().jsonValue());\n-        if (!StringUtils.isEmpty(item.getName()))\n-            g.attr(\"data-name\", item.getName());\n-        if (!StringUtils.isEmpty(item.getDescription()))\n-            g.attr(\"data-description\", item.getDescription());\n-        if (!StringUtils.isEmpty(item.getOwner()))\n-            g.attr(\"data-owner\", item.getOwner());\n-\n-        Map<String, String> groupedLabels = Labeled.groupedByPrefixes(item.getLabels());\n-        groupedLabels.forEach((key, value) -> {\n-            if (!StringUtils.isEmpty(value)) {\n-                g.attr(\"data-\" + key, value);\n-            }\n-        });\n-", "originalCommit": "8f49c14f63c2aa7406749bd590a3c5175f38c7a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODIyMjg0OQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r508222849", "bodyText": "My initial idea was to stuff as much data into the svg as possible, so that data can be retrieved by any post-processors without the need to call nivio again. This is required yet and comes at the cost of large file sizes, so I think it's better to remove it for now.", "author": "bonndan", "createdAt": "2020-10-20T05:42:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA5NTg4Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4ec3b1c73730620748eca756c5ff4a189891526f", "url": "https://github.com/dedica-team/nivio/commit/4ec3b1c73730620748eca756c5ff4a189891526f", "message": "removed obsolete constructor", "committedDate": "2020-10-20T05:06:09Z", "type": "commit"}, {"oid": "f39d66f01f00a35a48612f9e41d5e1f3c142a73d", "url": "https://github.com/dedica-team/nivio/commit/f39d66f01f00a35a48612f9e41d5e1f3c142a73d", "message": "added Renderer interface documentation", "committedDate": "2020-10-20T05:13:26Z", "type": "commit"}, {"oid": "4f15a0a57e19997dde35913b8183a9ead1fb0f11", "url": "https://github.com/dedica-team/nivio/commit/4f15a0a57e19997dde35913b8183a9ead1fb0f11", "message": "occupied hexes in hexmap contain group area hexes as well", "committedDate": "2020-10-21T01:46:28Z", "type": "commit"}, {"oid": "41d59ff45a6fa3f8f3ac6a5aa21a85fd757a9602", "url": "https://github.com/dedica-team/nivio/commit/41d59ff45a6fa3f8f3ac6a5aa21a85fd757a9602", "message": "improved pathfinding, regards group areas", "committedDate": "2020-10-21T03:43:34Z", "type": "commit"}, {"oid": "1e1f91145f203eded31dc02e8be4e487a1f4132e", "url": "https://github.com/dedica-team/nivio/commit/1e1f91145f203eded31dc02e8be4e487a1f4132e", "message": "svg and viewbox fixes, not perfect yet", "committedDate": "2020-10-21T03:55:24Z", "type": "commit"}, {"oid": "aae372b1a3067934ec65bdeed5ad790e89c95e51", "url": "https://github.com/dedica-team/nivio/commit/aae372b1a3067934ec65bdeed5ad790e89c95e51", "message": "commented SVGBackgroundFactory, added two simple tests", "committedDate": "2020-10-21T04:01:54Z", "type": "commit"}, {"oid": "34d4213e03a731f7bc5e1b101ccabe075e3a5774", "url": "https://github.com/dedica-team/nivio/commit/34d4213e03a731f7bc5e1b101ccabe075e3a5774", "message": "more iterations for group layouting for better positioning of groups", "committedDate": "2020-10-21T04:12:25Z", "type": "commit"}, {"oid": "8cdc129a856af0a1e62cada78df36a37e2820497", "url": "https://github.com/dedica-team/nivio/commit/8cdc129a856af0a1e62cada78df36a37e2820497", "message": "[#315] extracted method and added some comments", "committedDate": "2020-10-24T08:10:19Z", "type": "commit"}, {"oid": "1a541a39ef65ff2d843b2a1bb096c3b8294e522f", "url": "https://github.com/dedica-team/nivio/commit/1a541a39ef65ff2d843b2a1bb096c3b8294e522f", "message": "small refactoring", "committedDate": "2020-10-24T08:35:39Z", "type": "commit"}, {"oid": "b45f737a3440debc5e06e59ae1652096f691ea3e", "url": "https://github.com/dedica-team/nivio/commit/b45f737a3440debc5e06e59ae1652096f691ea3e", "message": "extended externals landscape", "committedDate": "2020-10-24T08:56:19Z", "type": "commit"}, {"oid": "09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "url": "https://github.com/dedica-team/nivio/commit/09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "message": "increased between-group layout initial temp for better layouts", "committedDate": "2020-10-24T08:57:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4Njk3NQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512286975", "bodyText": "Which special functionality provided by the BidiMap data structure are we using? I have only seen getKey() and containsKey(). If that is so, why isn't that just the value in a normal Map structure?", "author": "mfbieber", "createdAt": "2020-10-26T21:42:37Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -26,95 +28,112 @@\n      * <p>\n      * There is clearly much room for improvement here. It's only that I haven't found a better approach so far.\n      *\n-     * @param occupied       tiles occupied by items\n-     * @param group          the group\n-     * @param allVertexHexes a mapping from item to its hex (all, unfiltered)\n+     * @param hexesToItems tiles occupied by items\n+     * @param group        the group\n      * @return all hexes the group consists of (an area)\n      */\n-    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<Item, Hex> allVertexHexes) {\n+    public static Set<Hex> getGroup(BidiMap<Hex, Object> hexesToItems, Group group) {", "originalCommit": "09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4MjUxMQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r514182511", "bodyText": "Excellent observation. It has been refactored.", "author": "bonndan", "createdAt": "2020-10-29T11:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4Njk3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8f36aa8e148f5475e4ecca193f20c09faccbb2f3", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 90a2bc51..91f0623a 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n\n@@ -28,11 +28,11 @@ public class GroupAreaFactory {\n      * <p>\n      * There is clearly much room for improvement here. It's only that I haven't found a better approach so far.\n      *\n-     * @param hexesToItems tiles occupied by items\n+     * @param itemsToHexes tiles occupied by items\n      * @param group        the group\n      * @return all hexes the group consists of (an area)\n      */\n-    public static Set<Hex> getGroup(BidiMap<Hex, Object> hexesToItems, Group group) {\n+    public static Set<Hex> getGroup(Map<Object, Hex> itemsToHexes, Group group) {\n \n         Set<Item> items = group.getItems();\n         Set<Hex> inArea = new HashSet<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4ODA2Nw==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512288067", "bodyText": "Great! Extracting this into an own method makes everything better readable and understandable \ud83d\ude04", "author": "mfbieber", "createdAt": "2020-10-26T21:44:55Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -26,95 +28,112 @@\n      * <p>\n      * There is clearly much room for improvement here. It's only that I haven't found a better approach so far.\n      *\n-     * @param occupied       tiles occupied by items\n-     * @param group          the group\n-     * @param allVertexHexes a mapping from item to its hex (all, unfiltered)\n+     * @param hexesToItems tiles occupied by items\n+     * @param group        the group\n      * @return all hexes the group consists of (an area)\n      */\n-    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<Item, Hex> allVertexHexes) {\n+    public static Set<Hex> getGroup(BidiMap<Hex, Object> hexesToItems, Group group) {\n \n         Set<Item> items = group.getItems();\n         Set<Hex> inArea = new HashSet<>();\n-        List<Item> connected = new ArrayList<>();\n \n         if (!items.iterator().hasNext()) {\n             LOGGER.warn(\"Could not determine group area for group {}\", group);\n             return inArea;\n         }\n-        //surround each item\n+\n+        //build the area by adding paths\n+        addPathsBetweenClosestItems(hexesToItems, items, inArea);", "originalCommit": "09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8f36aa8e148f5475e4ecca193f20c09faccbb2f3", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 90a2bc51..91f0623a 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n\n@@ -28,11 +28,11 @@ public class GroupAreaFactory {\n      * <p>\n      * There is clearly much room for improvement here. It's only that I haven't found a better approach so far.\n      *\n-     * @param hexesToItems tiles occupied by items\n+     * @param itemsToHexes tiles occupied by items\n      * @param group        the group\n      * @return all hexes the group consists of (an area)\n      */\n-    public static Set<Hex> getGroup(BidiMap<Hex, Object> hexesToItems, Group group) {\n+    public static Set<Hex> getGroup(Map<Object, Hex> itemsToHexes, Group group) {\n \n         Set<Item> items = group.getItems();\n         Set<Hex> inArea = new HashSet<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzI3OQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512293279", "bodyText": "What technical debt do you think that we are collecting here? For me it is just that I don't really understand what is going on (but I also haven't fully understood the other rendering logics).", "author": "mfbieber", "createdAt": "2020-10-26T21:56:33Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java", "diffHunk": "@@ -9,6 +9,11 @@\n \n import static java.lang.Math.round;\n \n+/**\n+ * This generates the background hex tiles.\n+ *\n+ * TODO It is a bad bank for technical debt.", "originalCommit": "09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzNDYwOQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512934609", "bodyText": "Here we produce hundreds of hexagons to display them in the background. There is no real added value and no business logic, but the designer suggested it like that.", "author": "bonndan", "createdAt": "2020-10-27T18:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE4MjMwMA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r514182300", "bodyText": "I have refactored it a bit and added some comments.", "author": "bonndan", "createdAt": "2020-10-29T11:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk4NTM1MQ==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r514985351", "bodyText": "Nice, it is better readble now!", "author": "mfbieber", "createdAt": "2020-10-30T09:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5MzI3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b2720958676691040abebf12b373f9d91606193e", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java b/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\nindex 90e07fa3..3c0b3473 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/svg/SVGBackgroundFactory.java\n\n@@ -12,7 +12,6 @@ import static java.lang.Math.round;\n /**\n  * This generates the background hex tiles.\n  *\n- * TODO It is a bad bank for technical debt.\n  */\n public class SVGBackgroundFactory {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDI2Ng==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512294266", "bodyText": "Do these tests cover the logic of finding the closest items and the correct occupation of tiles as implemented in the methods getGroup(), addPathsBetweenClosestItems(), getClosestItem() and getBridges()?", "author": "mfbieber", "createdAt": "2020-10-26T21:58:43Z", "path": "src/test/java/de/bonndan/nivio/output/map/hex/GroupAreaFactoryTest.java", "diffHunk": "@@ -2,12 +2,15 @@\n \n import de.bonndan.nivio.model.*;\n import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.apache.commons.collections4.BidiMap;\n+import org.apache.commons.collections4.bidimap.DualHashBidiMap;\n import org.apache.commons.collections4.set.UnmodifiableSet;\n import org.junit.jupiter.api.Test;\n \n import java.util.*;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.in;\n import static org.junit.jupiter.api.Assertions.assertEquals;\n \n class GroupAreaFactoryTest {", "originalCommit": "09f8818a07a7e18f90aa456adc8ecd26bbcef7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzNTgwMA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r512935800", "bodyText": "Yes, but it's more like a blackbox test, i.e. we do not test the exact behaviour, but the outcome.", "author": "bonndan", "createdAt": "2020-10-27T18:33:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDI2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk4MjA0NA==", "url": "https://github.com/dedica-team/nivio/pull/327#discussion_r514982044", "bodyText": "Okay, is it hard to add tests for the steps in between? The problem to me is, that it is hard to understand what is going on and also hard to refactor if we only have blackbox tests :-/", "author": "mfbieber", "createdAt": "2020-10-30T09:53:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDI2Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "8f36aa8e148f5475e4ecca193f20c09faccbb2f3", "url": "https://github.com/dedica-team/nivio/commit/8f36aa8e148f5475e4ecca193f20c09faccbb2f3", "message": "[#326] using simple map where possible", "committedDate": "2020-10-28T07:04:15Z", "type": "commit"}, {"oid": "b2720958676691040abebf12b373f9d91606193e", "url": "https://github.com/dedica-team/nivio/commit/b2720958676691040abebf12b373f9d91606193e", "message": "[#326] introduced SVGDimension to separate and fix background rendering", "committedDate": "2020-10-29T11:06:05Z", "type": "commit"}, {"oid": "fdfc0c294b4e59abab29f52b64a9776d9fd786f4", "url": "https://github.com/dedica-team/nivio/commit/fdfc0c294b4e59abab29f52b64a9776d9fd786f4", "message": "[#326] cleanup", "committedDate": "2020-10-29T11:17:33Z", "type": "commit"}]}