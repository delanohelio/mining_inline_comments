{"pr_number": 148, "pr_title": "4 k8s", "pr_createdAt": "2020-06-03T20:27:23Z", "pr_url": "https://github.com/dedica-team/nivio/pull/148", "timeline": [{"oid": "cf91ea24604498d61350bd861f21231b42253a0e", "url": "https://github.com/dedica-team/nivio/commit/cf91ea24604498d61350bd861f21231b42253a0e", "message": "[#4] minikube instruction", "committedDate": "2020-05-21T09:40:42Z", "type": "commit"}, {"oid": "934b3f17870e6dd17a0bd18e2a1cb815d39b1d3d", "url": "https://github.com/dedica-team/nivio/commit/934b3f17870e6dd17a0bd18e2a1cb815d39b1d3d", "message": "changed startup process: fs watchers declared deprecated because unreliable", "committedDate": "2020-05-22T07:48:23Z", "type": "commit"}, {"oid": "5a4a4823402106f971814c543fee53bbdd7201b8", "url": "https://github.com/dedica-team/nivio/commit/5a4a4823402106f971814c543fee53bbdd7201b8", "message": "[#4] version bump", "committedDate": "2020-05-22T09:51:26Z", "type": "commit"}, {"oid": "44c84e2297461e65acb06085065b676d547e20be", "url": "https://github.com/dedica-team/nivio/commit/44c84e2297461e65acb06085065b676d547e20be", "message": "changed startup listener to react on app ready event (was running too early)", "committedDate": "2020-05-23T09:19:08Z", "type": "commit"}, {"oid": "c75f9698c40c73884200674e23d9445dedff1b22", "url": "https://github.com/dedica-team/nivio/commit/c75f9698c40c73884200674e23d9445dedff1b22", "message": "[#4] volumes and nodes as items, preliminary icons", "committedDate": "2020-05-24T09:14:38Z", "type": "commit"}, {"oid": "edf8b58875882eddcadf10a3b9e172cc520e8799", "url": "https://github.com/dedica-team/nivio/commit/edf8b58875882eddcadf10a3b9e172cc520e8799", "message": "fix for overlapping items in hex maps", "committedDate": "2020-05-26T21:20:50Z", "type": "commit"}, {"oid": "5eb351ed5092cfd769df3748fc22129e2721cef2", "url": "https://github.com/dedica-team/nivio/commit/5eb351ed5092cfd769df3748fc22129e2721cef2", "message": "extracted constant", "committedDate": "2020-05-26T21:24:02Z", "type": "commit"}, {"oid": "0e9e42dcb4936bbb6287c610f68e5b0d23327426", "url": "https://github.com/dedica-team/nivio/commit/0e9e42dcb4936bbb6287c610f68e5b0d23327426", "message": "SEED and DEMO mode can run together", "committedDate": "2020-06-01T20:43:37Z", "type": "commit"}, {"oid": "6395a056686d47aee5c596219fa040aa724d584c", "url": "https://github.com/dedica-team/nivio/commit/6395a056686d47aee5c596219fa040aa724d584c", "message": "fix for AllGroupsGraph: when items had no group, not virtual group connections were created", "committedDate": "2020-06-01T22:08:51Z", "type": "commit"}, {"oid": "42a7a32040fece3c445da35031dca6cb91be1d07", "url": "https://github.com/dedica-team/nivio/commit/42a7a32040fece3c445da35031dca6cb91be1d07", "message": "slightly more svg padding in order not to cut connections drawn close to borders", "committedDate": "2020-06-03T05:02:11Z", "type": "commit"}, {"oid": "d406952631393b22057bb06ac3461d4ab56caaec", "url": "https://github.com/dedica-team/nivio/commit/d406952631393b22057bb06ac3461d4ab56caaec", "message": "slighty improved group container radius calculation", "committedDate": "2020-06-03T05:09:06Z", "type": "commit"}, {"oid": "e297d11a861906ad6fbeb77a09f109556f6a7286", "url": "https://github.com/dedica-team/nivio/commit/e297d11a861906ad6fbeb77a09f109556f6a7286", "message": "added data to svg relations, prevent inverse relation painting", "committedDate": "2020-06-03T06:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5NjkyOA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435296928", "bodyText": "Should be renamed to isReference or something similar because process is already a method in our class", "author": "MarvinSchoening", "createdAt": "2020-06-04T14:21:38Z", "path": "src/main/java/de/bonndan/nivio/input/FileChangeProcessor.java", "diffHunk": "@@ -1,65 +1,69 @@\n package de.bonndan.nivio.input;\n \n+import de.bonndan.nivio.IndexEvent;\n import de.bonndan.nivio.ProcessingException;\n import de.bonndan.nivio.input.dto.LandscapeDescription;\n import de.bonndan.nivio.model.LandscapeRepository;\n+import org.springframework.context.ApplicationEventPublisher;\n import org.springframework.context.ApplicationListener;\n import org.springframework.stereotype.Component;\n import org.springframework.util.StringUtils;\n \n import java.io.File;\n-import java.util.Optional;\n-import java.util.concurrent.atomic.AtomicReference;\n+import java.util.concurrent.atomic.AtomicBoolean;\n \n+/**\n+ * This class handles local file changes to tries to find the landscape belonging to the file, then trigger an indexing.\n+ *\n+ *\n+ */\n @Component\n public class FileChangeProcessor implements ApplicationListener<FSChangeEvent> {\n \n-    private final Indexer indexer;\n     private final LandscapeRepository landscapeRepository;\n+    private final ApplicationEventPublisher applicationEventPublisher;\n \n-    public FileChangeProcessor(Indexer indexer, LandscapeRepository landscapeRepository) {\n-        this.indexer = indexer;\n+    public FileChangeProcessor(LandscapeRepository landscapeRepository,\n+                               ApplicationEventPublisher applicationEventPublisher\n+    ) {\n         this.landscapeRepository = landscapeRepository;\n+        this.applicationEventPublisher = applicationEventPublisher;\n     }\n \n     @Override\n     public void onApplicationEvent(FSChangeEvent fsChangeEvent) {\n-        process(fsChangeEvent.getChangedFile());\n-    }\n \n-    public ProcessLog process(File envFile) {\n-        LandscapeDescription landscapeDescription = LandscapeDescriptionFactory.fromYaml(envFile);\n+        File changedFile = fsChangeEvent.getChangedFile();\n+        LandscapeDescription landscapeDescription = LandscapeDescriptionFactory.fromYaml(changedFile);\n         if (landscapeDescription == null) {\n-            return new ProcessLog(new ProcessingException(\"Could not read environment from \" + envFile, new RuntimeException()));\n+            new ProcessLog(new ProcessingException(\"Could not read environment from \" + changedFile, new RuntimeException()));\n+            return;\n         }\n \n         //this is not an environment file, but likely a service description file\n         if (landscapeDescription.getIdentifier() == null && !StringUtils.isEmpty(landscapeDescription.getSource())) {\n-            return handleServiceDescriptionFileChange(landscapeDescription).orElse(\n-                    new ProcessLog(new ProcessingException(\"Could not read environment from \" + envFile, new RuntimeException()))\n-            );\n+            if (handleServiceDescriptionFileChange(landscapeDescription, changedFile)) {\n+                return;\n+            }\n         }\n-        return process(landscapeDescription);\n+        process(landscapeDescription, changedFile);\n     }\n \n-    private Optional<ProcessLog> handleServiceDescriptionFileChange(LandscapeDescription landscapeDescription) {\n-\n-        AtomicReference<ProcessLog> process = new AtomicReference<>();\n+    private boolean handleServiceDescriptionFileChange(LandscapeDescription landscapeDescription,\n+                                                                    File changedFile\n+    ) {\n+        AtomicBoolean process = new AtomicBoolean(false);", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ4OTgzNw==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435489837", "bodyText": "done", "author": "bonndan", "createdAt": "2020-06-04T19:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI5NjkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/FileChangeProcessor.java b/src/main/java/de/bonndan/nivio/input/FileChangeProcessor.java\nindex a107a55d..e4f7f0ef 100644\n--- a/src/main/java/de/bonndan/nivio/input/FileChangeProcessor.java\n+++ b/src/main/java/de/bonndan/nivio/input/FileChangeProcessor.java\n\n@@ -52,15 +52,15 @@ public class FileChangeProcessor implements ApplicationListener<FSChangeEvent> {\n     private boolean handleServiceDescriptionFileChange(LandscapeDescription landscapeDescription,\n                                                                     File changedFile\n     ) {\n-        AtomicBoolean process = new AtomicBoolean(false);\n+        AtomicBoolean isHandled = new AtomicBoolean(false);\n         landscapeRepository.findAll().forEach(landscape -> {\n             LandscapeDescription env1 = LandscapeDescriptionFactory.fromYaml(new File(landscape.getSource()));\n             if (env1 != null && env1.hasReference(landscapeDescription.getSource())) {\n                 process(env1, changedFile);\n-                process.set(true);\n+                isHandled.set(true);\n             }\n         });\n-        return process.get();\n+        return isHandled.get();\n     }\n \n     private void process(LandscapeDescription landscapeDescription, File changedFile) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMwNjg3Ng==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435306876", "bodyText": "Objects.requireNonNull throws a nullPointer exception on failur but wont be caught", "author": "MarvinSchoening", "createdAt": "2020-06-04T14:34:10Z", "path": "src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java", "diffHunk": "@@ -2,25 +2,95 @@\n \n import com.fasterxml.jackson.databind.JsonMappingException;\n import com.fasterxml.jackson.databind.ObjectMapper;\n+import de.bonndan.nivio.ProcessingErrorEvent;\n+import de.bonndan.nivio.ProcessingException;\n import de.bonndan.nivio.input.dto.LandscapeDescription;\n import de.bonndan.nivio.util.Mappers;\n+import de.bonndan.nivio.util.URLHelper;\n import org.apache.commons.text.StringSubstitutor;\n import org.apache.commons.text.lookup.StringLookupFactory;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n+import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.stereotype.Component;\n import org.springframework.util.StringUtils;\n \n import java.io.File;\n import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URISyntaxException;\n import java.net.URL;\n import java.nio.file.Files;\n import java.nio.file.NoSuchFileException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n \n+@Component\n public class LandscapeDescriptionFactory {\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(LandscapeDescriptionFactory.class);\n     private static final ObjectMapper mapper = Mappers.gracefulYamlMapper;\n \n+    private final ApplicationEventPublisher publisher;\n+    private final FileFetcher fileFetcher;\n+\n+    public LandscapeDescriptionFactory(ApplicationEventPublisher publisher, FileFetcher fileFetcher) {\n+        this.publisher = publisher;\n+        this.fileFetcher = fileFetcher;\n+    }\n+\n+    public List<LandscapeDescription> getDescriptions(Seed seed) {\n+\n+        List<URL> locations = new ArrayList<>();\n+        try {\n+            if (seed.hasValue()) {\n+                locations = seed.getLocations();\n+            }\n+            if (!StringUtils.isEmpty(System.getenv(Seed.DEMO))) {\n+                locations.addAll(seed.getDemoFiles());\n+            }\n+        } catch (MalformedURLException e) {\n+            ProcessingException processingException = new ProcessingException(\"Failed to initialize watchers from seed\", e);\n+            publisher.publishEvent(new ProcessingErrorEvent(this, processingException));\n+        }\n+\n+        List<LandscapeDescription> descriptions = new ArrayList<>();\n+\n+        locations.forEach(url -> {\n+            LandscapeDescription env = null;\n+            if (URLHelper.isLocal(url)) {\n+                File file;\n+                try {\n+                    file = Paths.get(url.toURI()).toFile();\n+                } catch (URISyntaxException e) {\n+                    throw new ProcessingException(\"Failed to initialize watchers from seed\", e);\n+                }\n+                LOGGER.info(\"Created directory watcher for url \" + url);\n+                try {\n+                    env = LandscapeDescriptionFactory.fromYaml(file);\n+                } catch (ReadingException ex) {\n+                    publisher.publishEvent(new ProcessingErrorEvent(this, ex));\n+                    LOGGER.error(\"Failed to parse file {}\", file);\n+                }\n+            } else {\n+                try {\n+                    env = LandscapeDescriptionFactory.fromString(fileFetcher.get(url), url);\n+                    Objects.requireNonNull(env);", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNjkzMQ==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435506931", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:43:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMwNjg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java b/src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java\nindex 4dbc71b2..97855419 100644\n--- a/src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java\n+++ b/src/main/java/de/bonndan/nivio/input/LandscapeDescriptionFactory.java\n\n@@ -12,6 +12,7 @@ import org.apache.commons.text.lookup.StringLookupFactory;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.context.ApplicationEventPublisher;\n+import org.springframework.lang.NonNull;\n import org.springframework.stereotype.Component;\n import org.springframework.util.StringUtils;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxMTM3MQ==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435311371", "bodyText": "DemoFiles shouldn't throw a MalformedURLException", "author": "MarvinSchoening", "createdAt": "2020-06-04T14:40:07Z", "path": "src/main/java/de/bonndan/nivio/input/Seed.java", "diffHunk": "@@ -23,12 +23,12 @@\n     static final String NIVIO_ENV_DIRECTORY = \"file:/opt/nivio/environments\";\n     static boolean ESCAPE_AUTHORITY = SystemUtils.IS_OS_WINDOWS;\n \n-    public static List<File> getDemoFiles() {\n+    public List<URL> getDemoFiles() throws MalformedURLException {", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzY4OA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435493688", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxMTM3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/Seed.java b/src/main/java/de/bonndan/nivio/input/Seed.java\nindex 36f0d6f8..b88740eb 100644\n--- a/src/main/java/de/bonndan/nivio/input/Seed.java\n+++ b/src/main/java/de/bonndan/nivio/input/Seed.java\n\n@@ -14,22 +14,30 @@ import java.nio.file.Paths;\n import java.util.ArrayList;\n import java.util.List;\n \n+/**\n+ * Evaluation of the SEED environment variable.\n+ *\n+ *\n+ */\n public class Seed {\n \n     private static final Logger logger = LoggerFactory.getLogger(Seed.class);\n \n     public static final String DEMO = \"DEMO\";\n \n-    static final String NIVIO_ENV_DIRECTORY = \"file:/opt/nivio/environments\";\n     static boolean ESCAPE_AUTHORITY = SystemUtils.IS_OS_WINDOWS;\n \n-    public List<URL> getDemoFiles() throws MalformedURLException {\n+    public List<URL> getDemoFiles() {\n         Path currentRelativePath = Paths.get(\"\");\n         String absPath = currentRelativePath.toAbsolutePath().toString();\n         List<URL> demoFiles = new ArrayList<>();\n-        demoFiles.add(new File(absPath + \"/src/test/resources/example/example_env.yml\").toURI().toURL());\n-        demoFiles.add(new File(absPath + \"/src/test/resources/example/inout.yml\").toURI().toURL());\n-        //demoFiles.add(new File(absPath + \"/src/test/resources/example/dedica.yml\"));\n+        try {\n+            demoFiles.add(new File(absPath + \"/src/test/resources/example/example_env.yml\").toURI().toURL());\n+            demoFiles.add(new File(absPath + \"/src/test/resources/example/inout.yml\").toURI().toURL());\n+            //demoFiles.add(new File(absPath + \"/src/test/resources/example/dedica.yml\"));\n+        } catch (MalformedURLException e) {\n+            logger.error(\"Error in demo files: \" + e.getMessage(), e);\n+        }\n         return demoFiles;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxOTYxNw==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435319617", "bodyText": "Same as LandscapeDescriptionFactory", "author": "MarvinSchoening", "createdAt": "2020-06-04T14:50:57Z", "path": "src/main/java/de/bonndan/nivio/input/WatcherFactory.java", "diffHunk": "@@ -4,80 +4,75 @@\n import de.bonndan.nivio.ProcessingException;\n import de.bonndan.nivio.input.dto.LandscapeDescription;\n import de.bonndan.nivio.util.URLHelper;\n-import org.apache.commons.lang3.SystemUtils;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n-import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.context.ApplicationEventPublisher;\n import org.springframework.stereotype.Component;\n \n import java.io.File;\n-import java.net.MalformedURLException;\n import java.net.URISyntaxException;\n+import java.net.URL;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Objects;\n \n+@Deprecated\n @Component\n public class WatcherFactory {\n \n     private static final Logger logger = LoggerFactory.getLogger(WatcherFactory.class);\n \n-    private final Seed seed;\n-\n     private final ApplicationEventPublisher publisher;\n \n     private final FileFetcher fileFetcher;\n     private final Indexer indexer;\n \n-    public WatcherFactory(Seed seed, ApplicationEventPublisher publisher, FileFetcher fileFetcher, Indexer indexer) {\n-        this.seed = seed;\n+    public WatcherFactory(ApplicationEventPublisher publisher, FileFetcher fileFetcher, Indexer indexer) {\n         this.publisher = publisher;\n         this.fileFetcher = fileFetcher;\n         this.indexer = indexer;\n     }\n \n-    public List<Runnable> getWatchers() {\n+    public List<Runnable> getWatchers(List<URL> locations) {\n \n         List<Runnable> runnables = new ArrayList<>();\n-        try {\n-            seed.getLocations().forEach(url -> {\n-                LandscapeDescription env = null;\n-                if (URLHelper.isLocal(url)) {\n-                    DirectoryWatcher directoryWatcher;\n-                    File file;\n-                    try {\n-                        file = Paths.get(url.toURI()).toFile();\n-                        directoryWatcher = new DirectoryWatcher(publisher, file);\n-                    } catch (URISyntaxException e) {\n-                        throw new ProcessingException(\"Failed to initialize watchers from seed\", e);\n-                    }\n-                    runnables.add(directoryWatcher);\n-                    logger.info(\"Created directory watcher for url \" + url);\n-                    try {\n-                        env = LandscapeDescriptionFactory.fromYaml(file);\n-                    } catch (ReadingException ex) {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, ex));\n-                        logger.error(\"Failed to parse file {}\", file);\n-                    }\n-                } else {\n-                    try {\n-                        env = LandscapeDescriptionFactory.fromString(fileFetcher.get(url), url);\n-                        Objects.requireNonNull(env);\n-                    } catch (ReadingException ex) {\n-                        publisher.publishEvent(new ProcessingErrorEvent(this, ex));\n-                        logger.error(\"Failed to parse file {}\", url);\n-                    }\n+\n+        logger.info(\"getWatchers {}\", locations);\n+\n+        locations.forEach(url -> {\n+            LandscapeDescription env = null;\n+            if (URLHelper.isLocal(url)) {\n+                DirectoryWatcher directoryWatcher;\n+                File file;\n+                try {\n+                    file = Paths.get(url.toURI()).toFile();\n+                    directoryWatcher = new DirectoryWatcher(publisher, file);\n+                } catch (URISyntaxException e) {\n+                    throw new ProcessingException(\"Failed to initialize watchers from seed\", e);\n                 }\n-                if (env != null) {\n-                    indexer.reIndex(env);\n+                runnables.add(directoryWatcher);\n+                logger.info(\"Created directory watcher for url \" + url);\n+                try {\n+                    env = LandscapeDescriptionFactory.fromYaml(file);\n+                } catch (ReadingException ex) {\n+                    publisher.publishEvent(new ProcessingErrorEvent(this, ex));\n+                    logger.error(\"Failed to parse file {}\", file);\n                 }\n-            });\n-        } catch (MalformedURLException e) {\n-            ProcessingException processingException = new ProcessingException(\"Failed to initialize watchers from seed\", e);\n-            publisher.publishEvent(new ProcessingErrorEvent(this, processingException));\n-        }\n+            } else {\n+                try {\n+                    env = LandscapeDescriptionFactory.fromString(fileFetcher.get(url), url);\n+                    Objects.requireNonNull(env);", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNzExOA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435507118", "bodyText": "wont fix, is deprecated", "author": "bonndan", "createdAt": "2020-06-04T19:43:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMxOTYxNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMyMTEwNg==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435321106", "bodyText": "used for groupname but this is not obvious", "author": "MarvinSchoening", "createdAt": "2020-06-04T14:52:52Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -1,28 +1,39 @@\n package de.bonndan.nivio.input.kubernetes;\n \n+import de.bonndan.nivio.ProcessingException;\n+import de.bonndan.nivio.assessment.StatusValue;\n import de.bonndan.nivio.input.ItemDescriptionFactory;\n import de.bonndan.nivio.input.dto.ItemDescription;\n+import de.bonndan.nivio.input.dto.RelationDescription;\n import de.bonndan.nivio.input.dto.SourceReference;\n import de.bonndan.nivio.model.Label;\n import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.model.RelationType;\n import de.bonndan.nivio.util.URLHelper;\n import io.fabric8.kubernetes.api.model.HasMetadata;\n import io.fabric8.kubernetes.api.model.Pod;\n+import io.fabric8.kubernetes.api.model.PodStatus;\n import io.fabric8.kubernetes.api.model.Service;\n import io.fabric8.kubernetes.client.Config;\n import io.fabric8.kubernetes.client.DefaultKubernetesClient;\n import io.fabric8.kubernetes.client.KubernetesClient;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.util.StringUtils;\n \n import java.net.MalformedURLException;\n import java.net.URL;\n import java.util.*;\n+import java.util.stream.Collectors;\n \n @org.springframework.stereotype.Service\n public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory {\n \n+    private static final Logger LOGGER = LoggerFactory.getLogger(ItemDescriptionFactoryKubernetes.class);\n+\n     public static final String NAMESPACE = \"namespace\";\n     public static final String GROUP_LABEL = \"groupLabel\";\n+    public static final String APP_KUBERNETES_IO_INSTANCE_LABEL = \"app.kubernetes.io/instance\";", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTcyOA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435495728", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMyMTEwNg=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -1,8 +1,8 @@\n package de.bonndan.nivio.input.kubernetes;\n \n import de.bonndan.nivio.ProcessingException;\n-import de.bonndan.nivio.assessment.StatusValue;\n import de.bonndan.nivio.input.ItemDescriptionFactory;\n+import de.bonndan.nivio.input.ItemType;\n import de.bonndan.nivio.input.dto.ItemDescription;\n import de.bonndan.nivio.input.dto.RelationDescription;\n import de.bonndan.nivio.input.dto.SourceReference;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzMDU0OQ==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435330549", "bodyText": "Returning a list is not necessary", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:05:07Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -60,26 +76,62 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n         KubernetesClient client = getClient(reference.getUrl());\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n-        client.pods().list().getItems().stream()\n-                .filter(pod -> {\n-                    if (namespace == null)\n-                        return true;\n-                    return namespace.equals(pod.getMetadata().getNamespace());\n-                })\n-                .forEach(pod -> descriptions.addAll(createDescriptionFromService(pod)));\n+        final List<ItemDescription> pods = new ArrayList<>();\n+        getPods().forEach(pod -> {\n+            ItemDescription podItem = createPodItemDescription(pod);\n+            descriptions.add(podItem);\n+            pods.add(podItem);\n+            List<ItemDescription> descriptionsFromPod = createDescriptionsFromPod(pod, podItem);\n+            descriptions.addAll(descriptionsFromPod);\n+        });\n \n-        client.services().list().getItems().stream()\n+        List<Service> services = client.services().list().getItems();\n+        LOGGER.info(\"Found services: {}\", services.stream().map(service -> service.getMetadata().getName()).collect(Collectors.toList()));\n+        services.stream()\n                 .filter(service -> {\n                     if (namespace == null)\n                         return true;\n                     return namespace.equals(service.getMetadata().getNamespace());\n                 })\n-                .forEach(service -> descriptions.addAll(createDescriptionFromService(service, descriptions)));\n+                .forEach(service -> descriptions.addAll(createDescriptionFromService(service, pods)));\n \n         return descriptions;\n     }\n \n-    private Collection<? extends ItemDescription> createDescriptionFromService(Service kubernetesService, List<ItemDescription> items) {\n+    /**\n+     * Creates a pod item\n+     *\n+     * @param pod k8s pod object\n+     * @return pod (yet ungrouped)\n+     */\n+    private ItemDescription createPodItemDescription(Pod pod) {\n+        ItemDescription itemDescription = new ItemDescription();\n+        itemDescription.setName(pod.getMetadata().getName());\n+        itemDescription.setIdentifier(pod.getMetadata().getName());\n+        itemDescription.setType(\"pod\");\n+        pod.getMetadata().getLabels().forEach((s, s2) -> itemDescription.setLabel(s, s2));\n+        return itemDescription;\n+    }\n+\n+    /**\n+     * @return all pods in the namespace\n+     */\n+    private List<Pod> getPods() {\n+        try {\n+            List<Pod> pods = client.pods().list().getItems();\n+            LOGGER.info(\"Found pods: {}\", pods.stream().map(pod -> pod.getMetadata().getName()).collect(Collectors.toList()));\n+            return pods.stream()\n+                    .filter(pod -> {\n+                        if (namespace == null)\n+                            return true;\n+                        return namespace.equals(pod.getMetadata().getNamespace());\n+                    }).collect(Collectors.toList());\n+        } catch (Exception ex) {\n+            throw new ProcessingException(\"Failed to load pods \", ex);\n+        }\n+    }\n+\n+    private Collection<? extends ItemDescription> createDescriptionFromService(Service kubernetesService, List<ItemDescription> pods) {", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -88,12 +90,8 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         List<Service> services = client.services().list().getItems();\n         LOGGER.info(\"Found services: {}\", services.stream().map(service -> service.getMetadata().getName()).collect(Collectors.toList()));\n         services.stream()\n-                .filter(service -> {\n-                    if (namespace == null)\n-                        return true;\n-                    return namespace.equals(service.getMetadata().getNamespace());\n-                })\n-                .forEach(service -> descriptions.addAll(createDescriptionFromService(service, pods)));\n+                .filter(service -> namespace == null || namespace.equals(service.getMetadata().getNamespace()))\n+                .forEach(service -> descriptions.add(createDescriptionFromService(service, pods)));\n \n         return descriptions;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzMzQ3Ng==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435333476", "bodyText": "maybe add a type enum", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:09:15Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -98,48 +150,114 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n \n         //TODO, check if this is reliable\n         if (!StringUtils.isEmpty(targetId)) {\n-            service.getLabels().put(\"nivio.relations\", \"[\" + targetId + \"]\");\n+            service.addRelation(new RelationDescription(service.getIdentifier(), targetId));\n         }\n \n         descriptions.add(service);\n \n+        //link pods as providers\n+        pods.stream()\n+                .filter(pod -> pod.getName().startsWith(service.getIdentifier()))\n+                .forEach(pod -> {\n+                    RelationDescription rel = new RelationDescription(pod.getIdentifier(), service.getIdentifier());\n+                    rel.setType(RelationType.PROVIDER);\n+                    service.addRelation(rel);\n+                    pod.setGroup(service.getGroup());\n+                });\n+\n         return descriptions;\n     }\n \n     public Config getConfiguration() {\n         return getClient(\"\").getConfiguration();\n     }\n \n-    private List<ItemDescription> createDescriptionFromService(Pod pod) {\n+    private List<ItemDescription> createDescriptionsFromPod(Pod pod, ItemDescription podItem) {\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n \n+        ItemDescription node = new ItemDescription();\n+        node.setName(pod.getSpec().getNodeName());\n+        node.setIdentifier(pod.getSpec().getNodeName());\n+        node.setType(\"server\");", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -145,7 +139,7 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         String targetId = \"\";\n         Map<String, String> selector = kubernetesService.getSpec().getSelector();\n         if (selector != null) {\n-            targetId = selector.getOrDefault(\"app\", null);\n+            targetId = selector.getOrDefault(APP_SELECTOR, null);\n         }\n \n         //TODO, check if this is reliable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNDcwOQ==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435334709", "bodyText": "reverse direction", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:10:55Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -98,48 +150,114 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n \n         //TODO, check if this is reliable\n         if (!StringUtils.isEmpty(targetId)) {\n-            service.getLabels().put(\"nivio.relations\", \"[\" + targetId + \"]\");\n+            service.addRelation(new RelationDescription(service.getIdentifier(), targetId));\n         }\n \n         descriptions.add(service);\n \n+        //link pods as providers\n+        pods.stream()\n+                .filter(pod -> pod.getName().startsWith(service.getIdentifier()))\n+                .forEach(pod -> {\n+                    RelationDescription rel = new RelationDescription(pod.getIdentifier(), service.getIdentifier());\n+                    rel.setType(RelationType.PROVIDER);\n+                    service.addRelation(rel);\n+                    pod.setGroup(service.getGroup());\n+                });\n+\n         return descriptions;\n     }\n \n     public Config getConfiguration() {\n         return getClient(\"\").getConfiguration();\n     }\n \n-    private List<ItemDescription> createDescriptionFromService(Pod pod) {\n+    private List<ItemDescription> createDescriptionsFromPod(Pod pod, ItemDescription podItem) {\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n \n+        ItemDescription node = new ItemDescription();\n+        node.setName(pod.getSpec().getNodeName());\n+        node.setIdentifier(pod.getSpec().getNodeName());\n+        node.setType(\"server\");\n+        descriptions.add(node);\n+        podItem.addRelation(new RelationDescription(node.getIdentifier(), podItem.getIdentifier()));\n+\n         String group = getGroup(pod);\n         pod.getSpec().getContainers().forEach(container -> {\n-            ItemDescription description = new ItemDescription();\n-            description.setGroup(group);\n-            description.setName(container.getName());\n-            description.setIdentifier(container.getName());\n-            description.setLabel(Label.SOFTWARE, container.getImage());\n-            description.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n-            pod.getMetadata().getLabels().forEach((s, s2) -> description.setLabel(s, s2));\n+            ItemDescription containerDesc = new ItemDescription();\n+            containerDesc.setGroup(group);\n+            containerDesc.setName(container.getName());\n+            containerDesc.setIdentifier(podItem.getName() + \"-\" + container.getName());\n+            containerDesc.setLabel(Label.SOFTWARE, container.getImage());\n+            containerDesc.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n+            containerDesc.setType(\"container\");\n+            pod.getMetadata().getLabels().forEach((s, s2) -> containerDesc.setLabel(s, s2));\n+            RelationDescription relationDescription = new RelationDescription(podItem.getIdentifier(), containerDesc.getIdentifier());", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTk3MA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435495970", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNDcwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -145,7 +139,7 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         String targetId = \"\";\n         Map<String, String> selector = kubernetesService.getSpec().getSelector();\n         if (selector != null) {\n-            targetId = selector.getOrDefault(\"app\", null);\n+            targetId = selector.getOrDefault(APP_SELECTOR, null);\n         }\n \n         //TODO, check if this is reliable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNjA3Ng==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435336076", "bodyText": "extract to method", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:12:50Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -98,48 +150,114 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n \n         //TODO, check if this is reliable\n         if (!StringUtils.isEmpty(targetId)) {\n-            service.getLabels().put(\"nivio.relations\", \"[\" + targetId + \"]\");\n+            service.addRelation(new RelationDescription(service.getIdentifier(), targetId));\n         }\n \n         descriptions.add(service);\n \n+        //link pods as providers\n+        pods.stream()\n+                .filter(pod -> pod.getName().startsWith(service.getIdentifier()))\n+                .forEach(pod -> {\n+                    RelationDescription rel = new RelationDescription(pod.getIdentifier(), service.getIdentifier());\n+                    rel.setType(RelationType.PROVIDER);\n+                    service.addRelation(rel);\n+                    pod.setGroup(service.getGroup());\n+                });\n+\n         return descriptions;\n     }\n \n     public Config getConfiguration() {\n         return getClient(\"\").getConfiguration();\n     }\n \n-    private List<ItemDescription> createDescriptionFromService(Pod pod) {\n+    private List<ItemDescription> createDescriptionsFromPod(Pod pod, ItemDescription podItem) {\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n \n+        ItemDescription node = new ItemDescription();\n+        node.setName(pod.getSpec().getNodeName());\n+        node.setIdentifier(pod.getSpec().getNodeName());\n+        node.setType(\"server\");\n+        descriptions.add(node);\n+        podItem.addRelation(new RelationDescription(node.getIdentifier(), podItem.getIdentifier()));\n+\n         String group = getGroup(pod);\n         pod.getSpec().getContainers().forEach(container -> {\n-            ItemDescription description = new ItemDescription();\n-            description.setGroup(group);\n-            description.setName(container.getName());\n-            description.setIdentifier(container.getName());\n-            description.setLabel(Label.SOFTWARE, container.getImage());\n-            description.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n-            pod.getMetadata().getLabels().forEach((s, s2) -> description.setLabel(s, s2));\n+            ItemDescription containerDesc = new ItemDescription();\n+            containerDesc.setGroup(group);\n+            containerDesc.setName(container.getName());\n+            containerDesc.setIdentifier(podItem.getName() + \"-\" + container.getName());\n+            containerDesc.setLabel(Label.SOFTWARE, container.getImage());\n+            containerDesc.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n+            containerDesc.setType(\"container\");\n+            pod.getMetadata().getLabels().forEach((s, s2) -> containerDesc.setLabel(s, s2));\n+            RelationDescription relationDescription = new RelationDescription(podItem.getIdentifier(), containerDesc.getIdentifier());\n+            relationDescription.setType(RelationType.PROVIDER);\n+            containerDesc.addRelation(relationDescription);\n \n             // TODO\n-            //set Labels, introduce new labels property (docker/k8s)\n-            //description.getProvided_by().add(pod.getSpec().)\n             //description.setScale(...);\n             // statuses: pod.getStatus()\n+            setConditionsAndHealth(pod.getStatus(), podItem);\n+            podItem.setLabel(\"hostIP\", pod.getStatus().getHostIP());\n+            podItem.setLabel(\"podIP\", pod.getStatus().getPodIP());\n+            podItem.setLabel(\"phase\", pod.getStatus().getPhase());\n+            podItem.setLabel(\"startTime\", pod.getStatus().getStartTime());\n             //description.setNetworks();\n \n-            descriptions.add(description);\n+            descriptions.add(containerDesc);\n+        });\n+\n+        pod.getSpec().getVolumes().forEach(volume -> {", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxOTIxNw==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435519217", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T20:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNjA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -145,7 +139,7 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         String targetId = \"\";\n         Map<String, String> selector = kubernetesService.getSpec().getSelector();\n         if (selector != null) {\n-            targetId = selector.getOrDefault(\"app\", null);\n+            targetId = selector.getOrDefault(APP_SELECTOR, null);\n         }\n \n         //TODO, check if this is reliable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNjg0Nw==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435336847", "bodyText": "implement!", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:13:52Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -98,48 +150,114 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n \n         //TODO, check if this is reliable\n         if (!StringUtils.isEmpty(targetId)) {\n-            service.getLabels().put(\"nivio.relations\", \"[\" + targetId + \"]\");\n+            service.addRelation(new RelationDescription(service.getIdentifier(), targetId));\n         }\n \n         descriptions.add(service);\n \n+        //link pods as providers\n+        pods.stream()\n+                .filter(pod -> pod.getName().startsWith(service.getIdentifier()))\n+                .forEach(pod -> {\n+                    RelationDescription rel = new RelationDescription(pod.getIdentifier(), service.getIdentifier());\n+                    rel.setType(RelationType.PROVIDER);\n+                    service.addRelation(rel);\n+                    pod.setGroup(service.getGroup());\n+                });\n+\n         return descriptions;\n     }\n \n     public Config getConfiguration() {\n         return getClient(\"\").getConfiguration();\n     }\n \n-    private List<ItemDescription> createDescriptionFromService(Pod pod) {\n+    private List<ItemDescription> createDescriptionsFromPod(Pod pod, ItemDescription podItem) {\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n \n+        ItemDescription node = new ItemDescription();\n+        node.setName(pod.getSpec().getNodeName());\n+        node.setIdentifier(pod.getSpec().getNodeName());\n+        node.setType(\"server\");\n+        descriptions.add(node);\n+        podItem.addRelation(new RelationDescription(node.getIdentifier(), podItem.getIdentifier()));\n+\n         String group = getGroup(pod);\n         pod.getSpec().getContainers().forEach(container -> {\n-            ItemDescription description = new ItemDescription();\n-            description.setGroup(group);\n-            description.setName(container.getName());\n-            description.setIdentifier(container.getName());\n-            description.setLabel(Label.SOFTWARE, container.getImage());\n-            description.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n-            pod.getMetadata().getLabels().forEach((s, s2) -> description.setLabel(s, s2));\n+            ItemDescription containerDesc = new ItemDescription();\n+            containerDesc.setGroup(group);\n+            containerDesc.setName(container.getName());\n+            containerDesc.setIdentifier(podItem.getName() + \"-\" + container.getName());\n+            containerDesc.setLabel(Label.SOFTWARE, container.getImage());\n+            containerDesc.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n+            containerDesc.setType(\"container\");\n+            pod.getMetadata().getLabels().forEach((s, s2) -> containerDesc.setLabel(s, s2));\n+            RelationDescription relationDescription = new RelationDescription(podItem.getIdentifier(), containerDesc.getIdentifier());\n+            relationDescription.setType(RelationType.PROVIDER);\n+            containerDesc.addRelation(relationDescription);\n \n             // TODO\n-            //set Labels, introduce new labels property (docker/k8s)\n-            //description.getProvided_by().add(pod.getSpec().)\n             //description.setScale(...);\n             // statuses: pod.getStatus()", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcyMzA1MA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435723050", "bodyText": "implemented a KPI evaluating the condition (status)", "author": "bonndan", "createdAt": "2020-06-05T06:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzNjg0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -145,7 +139,7 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         String targetId = \"\";\n         Map<String, String> selector = kubernetesService.getSpec().getSelector();\n         if (selector != null) {\n-            targetId = selector.getOrDefault(\"app\", null);\n+            targetId = selector.getOrDefault(APP_SELECTOR, null);\n         }\n \n         //TODO, check if this is reliable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzODAwNw==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435338007", "bodyText": "maybe add enum here too", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:15:28Z", "path": "src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java", "diffHunk": "@@ -98,48 +150,114 @@ public ItemDescriptionFactoryKubernetes(KubernetesClient client) {\n \n         //TODO, check if this is reliable\n         if (!StringUtils.isEmpty(targetId)) {\n-            service.getLabels().put(\"nivio.relations\", \"[\" + targetId + \"]\");\n+            service.addRelation(new RelationDescription(service.getIdentifier(), targetId));\n         }\n \n         descriptions.add(service);\n \n+        //link pods as providers\n+        pods.stream()\n+                .filter(pod -> pod.getName().startsWith(service.getIdentifier()))\n+                .forEach(pod -> {\n+                    RelationDescription rel = new RelationDescription(pod.getIdentifier(), service.getIdentifier());\n+                    rel.setType(RelationType.PROVIDER);\n+                    service.addRelation(rel);\n+                    pod.setGroup(service.getGroup());\n+                });\n+\n         return descriptions;\n     }\n \n     public Config getConfiguration() {\n         return getClient(\"\").getConfiguration();\n     }\n \n-    private List<ItemDescription> createDescriptionFromService(Pod pod) {\n+    private List<ItemDescription> createDescriptionsFromPod(Pod pod, ItemDescription podItem) {\n \n         List<ItemDescription> descriptions = new ArrayList<>();\n \n+        ItemDescription node = new ItemDescription();\n+        node.setName(pod.getSpec().getNodeName());\n+        node.setIdentifier(pod.getSpec().getNodeName());\n+        node.setType(\"server\");\n+        descriptions.add(node);\n+        podItem.addRelation(new RelationDescription(node.getIdentifier(), podItem.getIdentifier()));\n+\n         String group = getGroup(pod);\n         pod.getSpec().getContainers().forEach(container -> {\n-            ItemDescription description = new ItemDescription();\n-            description.setGroup(group);\n-            description.setName(container.getName());\n-            description.setIdentifier(container.getName());\n-            description.setLabel(Label.SOFTWARE, container.getImage());\n-            description.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n-            pod.getMetadata().getLabels().forEach((s, s2) -> description.setLabel(s, s2));\n+            ItemDescription containerDesc = new ItemDescription();\n+            containerDesc.setGroup(group);\n+            containerDesc.setName(container.getName());\n+            containerDesc.setIdentifier(podItem.getName() + \"-\" + container.getName());\n+            containerDesc.setLabel(Label.SOFTWARE, container.getImage());\n+            containerDesc.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n+            containerDesc.setType(\"container\");\n+            pod.getMetadata().getLabels().forEach((s, s2) -> containerDesc.setLabel(s, s2));\n+            RelationDescription relationDescription = new RelationDescription(podItem.getIdentifier(), containerDesc.getIdentifier());\n+            relationDescription.setType(RelationType.PROVIDER);\n+            containerDesc.addRelation(relationDescription);\n \n             // TODO\n-            //set Labels, introduce new labels property (docker/k8s)\n-            //description.getProvided_by().add(pod.getSpec().)\n             //description.setScale(...);\n             // statuses: pod.getStatus()\n+            setConditionsAndHealth(pod.getStatus(), podItem);\n+            podItem.setLabel(\"hostIP\", pod.getStatus().getHostIP());\n+            podItem.setLabel(\"podIP\", pod.getStatus().getPodIP());\n+            podItem.setLabel(\"phase\", pod.getStatus().getPhase());\n+            podItem.setLabel(\"startTime\", pod.getStatus().getStartTime());\n             //description.setNetworks();\n \n-            descriptions.add(description);\n+            descriptions.add(containerDesc);\n+        });\n+\n+        pod.getSpec().getVolumes().forEach(volume -> {\n+\n+            //storing configmap volumes in labels\n+            if (volume.getConfigMap() != null) {\n+                podItem.setLabel(\"configMap\" + Label.DELIMITER + volume.getConfigMap().getName(), volume.getConfigMap().getName());\n+                return;\n+            }\n+\n+            ItemDescription volumeDesc = new ItemDescription();\n+            volumeDesc.setGroup(group);\n+            volumeDesc.setName(volume.getName());\n+            volumeDesc.setIdentifier(podItem.getName() + \"-\" + volume.getName());\n+            volumeDesc.setLabel(Label.MACHINE, pod.getSpec().getNodeName()); //ip?\n+            volumeDesc.setType(\"volume\");\n+            if (volume.getSecret() != null && volume.getSecret().getSecretName().equals(volume.getName())) {\n+                volumeDesc.setLabel(\"secret\", 1);", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM0MDI5MA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435340290", "bodyText": "or add string constants for our presets", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzODAwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NjE1MQ==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435496151", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:22:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMzODAwNw=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\nindex 46e1850e..d93f42d4 100644\n--- a/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n+++ b/src/main/java/de/bonndan/nivio/input/kubernetes/ItemDescriptionFactoryKubernetes.java\n\n@@ -145,7 +139,7 @@ public class ItemDescriptionFactoryKubernetes implements ItemDescriptionFactory\n         String targetId = \"\";\n         Map<String, String> selector = kubernetesService.getSpec().getSelector();\n         if (selector != null) {\n-            targetId = selector.getOrDefault(\"app\", null);\n+            targetId = selector.getOrDefault(APP_SELECTOR, null);\n         }\n \n         //TODO, check if this is reliable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM1OTM0NA==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435359344", "bodyText": "rename variable", "author": "MarvinSchoening", "createdAt": "2020-06-04T15:41:48Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/SvgFactory.java", "diffHunk": "@@ -105,16 +111,20 @@ public DomContent render() {\n \n         List<DomContent> relations = landscape.getItems().all().stream().flatMap(item -> {\n                     LOGGER.debug(\"Adding {} relations for {}\", item.getRelations().size(), item.getFullyQualifiedIdentifier());\n-                    return item.getRelations().stream().map(rel -> {\n-                        Hex start = vertexHexes.get(item);\n-                        Hex target = vertexHexes.get((Item) rel.getTarget());\n-                        HexPath bestPath = pathFinder.getPath(start, target);\n-                        if (bestPath != null) {\n-                            SVGRelation SVGRelation = new SVGRelation(bestPath, item.getColor(), rel);\n-                            return SVGRelation.render();\n-                        }\n-                        return null;\n-                    });\n+                    return item.getRelations().stream()\n+                            .filter(rel -> rel.getSource().equals(item)) //do not paint twice / incoming (inverse) relations\n+                            .map(rel -> {\n+                                Hex start = vertexHexes.get(item);\n+                                Hex target = vertexHexes.get(rel.getTarget());\n+                                HexPath bestPath = pathFinder.getPath(start, target);\n+                                if (bestPath != null) {\n+                                    SVGRelation SVGRelation = new SVGRelation(bestPath, item.getColor(), rel);", "originalCommit": "e297d11a861906ad6fbeb77a09f109556f6a7286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzI4Ng==", "url": "https://github.com/dedica-team/nivio/pull/148#discussion_r435497286", "bodyText": "\ud83d\udc4d", "author": "bonndan", "createdAt": "2020-06-04T19:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM1OTM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "chunk": "diff --git a/src/main/java/de/bonndan/nivio/output/map/svg/SvgFactory.java b/src/main/java/de/bonndan/nivio/output/map/svg/SvgFactory.java\nindex 4dfdc473..21559b08 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/svg/SvgFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/svg/SvgFactory.java\n\n@@ -118,11 +118,11 @@ public class SvgFactory extends Component {\n                                 Hex target = vertexHexes.get(rel.getTarget());\n                                 HexPath bestPath = pathFinder.getPath(start, target);\n                                 if (bestPath != null) {\n-                                    SVGRelation SVGRelation = new SVGRelation(bestPath, item.getColor(), rel);\n+                                    SVGRelation svgRelation = new SVGRelation(bestPath, item.getColor(), rel);\n                                     LOGGER.debug(\"Added path for item {} relation {} -> {}\", item, rel.getSource(), rel.getTarget());\n-                                    return SVGRelation.render();\n+                                    return svgRelation.render();\n                                 }\n-                                LOGGER.warn(\"No path found for item {} relation {}\", item, rel);\n+                                LOGGER.error(\"No path found for item {} relation {}\", item, rel);\n                                 return null;\n                             });\n                 }\n"}}, {"oid": "5d9aefc6d612884e61e23f4f459e09eceedab0a7", "url": "https://github.com/dedica-team/nivio/commit/5d9aefc6d612884e61e23f4f459e09eceedab0a7", "message": "[#4] cleanup", "committedDate": "2020-06-04T20:10:47Z", "type": "commit"}, {"oid": "8375ed65debf51e75065903a080903e898a622bd", "url": "https://github.com/dedica-team/nivio/commit/8375ed65debf51e75065903a080903e898a622bd", "message": "[#4] test fix", "committedDate": "2020-06-04T20:32:21Z", "type": "commit"}, {"oid": "86dfee172c01084621d08486d5d7bf4f82105ae7", "url": "https://github.com/dedica-team/nivio/commit/86dfee172c01084621d08486d5d7bf4f82105ae7", "message": "refactored kpis", "committedDate": "2020-06-05T06:51:32Z", "type": "commit"}]}