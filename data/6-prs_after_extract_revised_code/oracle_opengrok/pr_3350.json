{"pr_number": 3350, "pr_title": "support OPTIONAL control flag in authorization framework", "pr_createdAt": "2020-11-03T13:05:22Z", "pr_url": "https://github.com/oracle/opengrok/pull/3350", "timeline": [{"oid": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "url": "https://github.com/oracle/opengrok/commit/8f6c94cb1db52712d02b817efebffdb7e16e647e", "message": "support OPTIONAL verb in authorization framework\n\nfixes #3289", "committedDate": "2020-11-03T13:03:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNTQzNA==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517235434", "bodyText": "It's a little harder to follow with this three-state variable.\nSo the idea is that it fails the decision only when the OPTIONAL are the only plugins in the stack?\nIf so, the original structure may stay it was (except the OPTIONAL else-if) and here you could do\nif(optionalFailure && getStack().stream().filter(Predicate::not(AuthorizationEntity::isOptional)).findAny().isEmpty()) {\n  return optionalFailure;\n}", "author": "tulinkry", "createdAt": "2020-11-04T10:15:34Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java", "diffHunk": "@@ -277,6 +292,14 @@ protected boolean processStack(Nameable entity,\n             }\n         }\n \n+        if (overallDecision == null && optionalFailure) {\n+            return false;\n+        }\n+\n+        if (overallDecision == null) {\n+            return true;\n+        }\n+", "originalCommit": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY3NjA1NA==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r519676054", "bodyText": "Used the original pattern according to the Unix PAM implementation (it is actually more complicated there). The stream interface makes the code arguably a bit more readable at the expense of traversing the plugins.", "author": "vladak", "createdAt": "2020-11-09T09:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzNTQzNA=="}], "type": "inlineReview", "revised_code": {"commit": "2ae10785f5a748d0f4ed3f2aa1f6a23a6a9f09f6", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\nindex 0d9c32f209..7aa672886e 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\n\n@@ -292,14 +288,12 @@ public class AuthorizationStack extends AuthorizationEntity {\n             }\n         }\n \n-        if (overallDecision == null && optionalFailure) {\n+        if (optionalFailure &&\n+                getStack().stream().filter(AuthorizationEntity::isOptional).count() == 1 &&\n+                getStack().stream().filter(Predicate.not(AuthorizationEntity::isOptional)).findAny().isEmpty()) {\n             return false;\n         }\n \n-        if (overallDecision == null) {\n-            return true;\n-        }\n-\n         return overallDecision;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzODA1Ng==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517238056", "bodyText": "maybe worth noting that: A success of a optional plugin is ignored and processing of the stack continues unaffected.", "author": "tulinkry", "createdAt": "2020-11-04T10:19:52Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java", "diffHunk": "@@ -48,13 +48,17 @@\n      */\n     REQUISITE(\"requisite\"),\n     /**\n-     * If such a plugin succeeds and no prior required plugin has failed the\n-     * authorization framework returns success to the application immediately\n-     * without calling any further plugins in the stack. A failure of a\n-     * sufficient plugin is ignored and processing of the plugin list continues\n-     * unaffected.\n+     * If such a plugin succeeds and no prior required plugin has failed,\n+     * the authorization framework returns success immediately\n+     * without calling any further plugins in the stack.\n+     * A failure of a sufficient plugin is ignored and processing of the stack continues unaffected.\n      */\n-    SUFFICIENT(\"sufficient\");\n+    SUFFICIENT(\"sufficient\"),\n+    /**\n+     * The failure is returned only if stack traversal finished and\n+     * there was no prior result recorded.", "originalCommit": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NTY1Mg==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517555652", "bodyText": "added", "author": "vladak", "createdAt": "2020-11-04T18:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzODA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d0185ada5b89fd75dea8bdadf75463487645638c", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\nindex fa8834e6fe..09b6d40a02 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\n\n@@ -55,6 +55,7 @@ public enum AuthControlFlag {\n      */\n     SUFFICIENT(\"sufficient\"),\n     /**\n+     * A success of a optional plugin is ignored and processing of the stack continues unaffected.\n      * The failure is returned only if stack traversal finished and\n      * there was no prior result recorded.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzODI2MQ==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517238261", "bodyText": "copyright", "author": "tulinkry", "createdAt": "2020-11-04T10:20:10Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java", "diffHunk": "@@ -48,13 +48,17 @@\n      */\n     REQUISITE(\"requisite\"),\n     /**", "originalCommit": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NTI4Ng==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517555286", "bodyText": "will fix", "author": "vladak", "createdAt": "2020-11-04T18:42:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzODI2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0185ada5b89fd75dea8bdadf75463487645638c", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\nindex fa8834e6fe..09b6d40a02 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthControlFlag.java\n\n@@ -55,6 +55,7 @@ public enum AuthControlFlag {\n      */\n     SUFFICIENT(\"sufficient\"),\n     /**\n+     * A success of a optional plugin is ignored and processing of the stack continues unaffected.\n      * The failure is returned only if stack traversal finished and\n      * there was no prior result recorded.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTE2MA==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517239160", "bodyText": "\"if\" not necessary here, but i don't mind it", "author": "tulinkry", "createdAt": "2020-11-04T10:21:43Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java", "diffHunk": "@@ -219,7 +219,13 @@ protected boolean processStack(Nameable entity,\n             PluginDecisionPredicate pluginPredicate,\n             PluginSkippingPredicate skippingPredicate) {\n \n-        boolean overallDecision = true;\n+        Boolean overallDecision = null;\n+        boolean optionalFailure = false;\n+\n+        if (getStack().isEmpty()) {\n+            return true;\n+        }", "originalCommit": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU1NDg4Nw==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517554887", "bodyText": "I think it makes the code a little more easier to follow.", "author": "vladak", "createdAt": "2020-11-04T18:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTE2MA=="}], "type": "inlineReview", "revised_code": {"commit": "2ae10785f5a748d0f4ed3f2aa1f6a23a6a9f09f6", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\nindex 0d9c32f209..7aa672886e 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/authorization/AuthorizationStack.java\n\n@@ -219,7 +220,7 @@ public class AuthorizationStack extends AuthorizationEntity {\n             PluginDecisionPredicate pluginPredicate,\n             PluginSkippingPredicate skippingPredicate) {\n \n-        Boolean overallDecision = null;\n+        boolean overallDecision = true;\n         boolean optionalFailure = false;\n \n         if (getStack().isEmpty()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTgzNQ==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517239835", "bodyText": "a test with two optionals, both returning different result, would be nice", "author": "tulinkry", "createdAt": "2020-11-04T10:22:49Z", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/authorization/AuthorizationFrameworkTest.java", "diffHunk": "@@ -654,6 +654,57 @@ public AuthorizationFrameworkTest(StackSetup setup) {\n                 NewTest(false, createAllowedProject()),\n                 NewTest(false, createAllowedGroup()))\n             },\n+            {\n+                new StackSetup(\n+                    NewStack(AuthControlFlag.REQUIRED,\n+                        new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createTestFailingPlugin()),\n+                        new AuthorizationPlugin(AuthControlFlag.REQUIRED, createAllowedPrefixPlugin())),\n+                    // optional plugin returns false\n+                    // required plugin returns false => false\n+                    NewTest(false, createUnallowedProject()),\n+                    NewTest(false, createUnallowedGroup()),\n+                    // optional plugin returns false\n+                    // required plugin returns true => true\n+                    NewTest(true, createAllowedProject()),\n+                    NewTest(true, createAllowedGroup()))\n+            },\n+            {\n+                new StackSetup(\n+                    NewStack(AuthControlFlag.REQUIRED,\n+                            new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createAllowedPrefixPlugin()),\n+                            new AuthorizationPlugin(AuthControlFlag.REQUIRED, createNotAllowedPrefixPlugin())),\n+                    // optional plugin returns false\n+                    // required plugin returns true => true\n+                    NewTest(true, createUnallowedProject()),\n+                    NewTest(true, createUnallowedGroup()),\n+                    // optional plugin returns true\n+                    // required plugin returns false => false\n+                    NewTest(false, createAllowedProject()),\n+                    NewTest(false, createAllowedGroup()))\n+            },\n+            {\n+                new StackSetup(\n+                    NewStack(AuthControlFlag.REQUIRED,\n+                            new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createTestFailingPlugin())\n+                            ),\n+                    // optional plugin returns false => false\n+                    NewTest(false, createUnallowedProject()),\n+                    NewTest(false, createUnallowedGroup()),\n+                    NewTest(false, createAllowedProject()),\n+                    NewTest(false, createAllowedGroup()))\n+            },\n+            {\n+                new StackSetup(\n+                    NewStack(AuthControlFlag.REQUIRED,\n+                            new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createAllowedPrefixPlugin())\n+                    ),\n+                    // optional plugin returns false => false\n+                    NewTest(false, createUnallowedProject()),\n+                    NewTest(false, createUnallowedGroup()),\n+                    // optional plugin returns true => true\n+                    NewTest(true, createAllowedProject()),\n+                    NewTest(true, createAllowedGroup()))", "originalCommit": "8f6c94cb1db52712d02b817efebffdb7e16e647e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0MDM5MQ==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517240391", "bodyText": "a test including sufficient and optional would be nice too", "author": "tulinkry", "createdAt": "2020-11-04T10:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU2NDg0MA==", "url": "https://github.com/oracle/opengrok/pull/3350#discussion_r517564840", "bodyText": "added", "author": "vladak", "createdAt": "2020-11-04T18:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzOTgzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "5d0e4ff5749fd3dabddeb75a20c224b6c29726b7", "chunk": "diff --git a/opengrok-indexer/src/test/java/org/opengrok/indexer/authorization/AuthorizationFrameworkTest.java b/opengrok-indexer/src/test/java/org/opengrok/indexer/authorization/AuthorizationFrameworkTest.java\nindex 57d97da180..2af1c7f5de 100644\n--- a/opengrok-indexer/src/test/java/org/opengrok/indexer/authorization/AuthorizationFrameworkTest.java\n+++ b/opengrok-indexer/src/test/java/org/opengrok/indexer/authorization/AuthorizationFrameworkTest.java\n\n@@ -705,6 +705,21 @@ public class AuthorizationFrameworkTest {\n                     NewTest(true, createAllowedProject()),\n                     NewTest(true, createAllowedGroup()))\n             },\n+            {\n+                new StackSetup(\n+                    NewStack(AuthControlFlag.REQUIRED,\n+                            new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createAllowedPrefixPlugin()),\n+                            new AuthorizationPlugin(AuthControlFlag.OPTIONAL, createNotAllowedPrefixPlugin())\n+                    ),\n+                    // optional plugin1 returns false\n+                    // optional plugin2 returns true => true\n+                    NewTest(true, createUnallowedProject()),\n+                    NewTest(true, createUnallowedGroup()),\n+                    // optional plugin1 returns true\n+                    // optional plugin2 returns false\n+                    NewTest(true, createAllowedProject()),\n+                    NewTest(true, createAllowedGroup()))\n+            },\n         };\n     }\n \n"}}, {"oid": "9f757fe6a15fa6153123410b6def0197122f7ce3", "url": "https://github.com/oracle/opengrok/commit/9f757fe6a15fa6153123410b6def0197122f7ce3", "message": "update copyright", "committedDate": "2020-11-04T18:42:28Z", "type": "commit"}, {"oid": "d0185ada5b89fd75dea8bdadf75463487645638c", "url": "https://github.com/oracle/opengrok/commit/d0185ada5b89fd75dea8bdadf75463487645638c", "message": "add comment", "committedDate": "2020-11-04T18:43:03Z", "type": "commit"}, {"oid": "5d0e4ff5749fd3dabddeb75a20c224b6c29726b7", "url": "https://github.com/oracle/opengrok/commit/5d0e4ff5749fd3dabddeb75a20c224b6c29726b7", "message": "add test with 2 OPTIONAL plugins", "committedDate": "2020-11-04T18:49:32Z", "type": "commit"}, {"oid": "47422fe7c5a13ea10180ddc5f27eae8bf34955fe", "url": "https://github.com/oracle/opengrok/commit/47422fe7c5a13ea10180ddc5f27eae8bf34955fe", "message": "add test with SUFFICIENT + OPTIONAL plugins", "committedDate": "2020-11-04T18:59:00Z", "type": "commit"}, {"oid": "2ae10785f5a748d0f4ed3f2aa1f6a23a6a9f09f6", "url": "https://github.com/oracle/opengrok/commit/2ae10785f5a748d0f4ed3f2aa1f6a23a6a9f09f6", "message": "use stream() for the final OPTIONAL check", "committedDate": "2020-11-09T09:44:20Z", "type": "commit"}]}