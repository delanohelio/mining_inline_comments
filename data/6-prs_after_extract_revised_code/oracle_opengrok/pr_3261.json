{"pr_number": 3261, "pr_title": "do not call createCache() unnecessarily", "pr_createdAt": "2020-10-05T10:14:22Z", "pr_url": "https://github.com/oracle/opengrok/pull/3261", "timeline": [{"oid": "1e03c471c766ae1b0fdd4455b5b458e9f09d785b", "url": "https://github.com/oracle/opengrok/commit/1e03c471c766ae1b0fdd4455b5b458e9f09d785b", "message": "do not call createCache() for repositories without history for directories\n\nit cannot create the cache anyway", "committedDate": "2020-10-05T10:14:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNjM5MQ==", "url": "https://github.com/oracle/opengrok/pull/3261#discussion_r499616391", "bodyText": ":(", "author": "tulinkry", "createdAt": "2020-10-05T13:54:22Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java", "diffHunk": "@@ -731,24 +729,16 @@ public void ensureHistoryCacheExists(File file) throws HistoryException {\n \n         Repository repository = getRepository(file);\n         if (repository == null) {\n-            // no repository -> no history :(", "originalCommit": "1e03c471c766ae1b0fdd4455b5b458e9f09d785b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzMzYzNw==", "url": "https://github.com/oracle/opengrok/pull/3261#discussion_r499633637", "bodyText": "depends on point of view I guess. Also, emojis are now the cool thing to have in (UTF-8 encoded) source code.", "author": "vladak", "createdAt": "2020-10-05T14:19:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNjM5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b3c2529927408a57727c3cb8a2947d37de764e0", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\nindex 441f7a52dd..e1dea60caf 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\n\n@@ -733,8 +747,7 @@ public final class HistoryGuru {\n             return;\n         }\n \n-        if (!repository.hasHistoryForDirectories() ||\n-                historyCache.hasCacheForDirectory(file, repository)) {\n+        if (historyCache.hasCacheForDirectory(file, repository)) {\n             return;\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNzY3OQ==", "url": "https://github.com/oracle/opengrok/pull/3261#discussion_r499617679", "bodyText": "but what if it has history but for older revision?", "author": "tulinkry", "createdAt": "2020-10-05T13:56:13Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java", "diffHunk": "@@ -731,24 +729,16 @@ public void ensureHistoryCacheExists(File file) throws HistoryException {\n \n         Repository repository = getRepository(file);\n         if (repository == null) {\n-            // no repository -> no history :(\n+            // no repository -> no history\n             return;\n         }\n \n-        String sinceRevision = null;\n-\n-        if (historyCache.hasCacheForDirectory(file, repository)) {\n-            sinceRevision = historyCache.getLatestCachedRevision(repository);", "originalCommit": "1e03c471c766ae1b0fdd4455b5b458e9f09d785b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYzNDUzNA==", "url": "https://github.com/oracle/opengrok/pull/3261#discussion_r499634534", "bodyText": "That would fall through. However I think this is not the place to catch this.", "author": "vladak", "createdAt": "2020-10-05T14:20:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNzY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6b3c2529927408a57727c3cb8a2947d37de764e0", "chunk": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\nindex 441f7a52dd..e1dea60caf 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/history/HistoryGuru.java\n\n@@ -733,8 +747,7 @@ public final class HistoryGuru {\n             return;\n         }\n \n-        if (!repository.hasHistoryForDirectories() ||\n-                historyCache.hasCacheForDirectory(file, repository)) {\n+        if (historyCache.hasCacheForDirectory(file, repository)) {\n             return;\n         }\n \n"}}, {"oid": "6b3c2529927408a57727c3cb8a2947d37de764e0", "url": "https://github.com/oracle/opengrok/commit/6b3c2529927408a57727c3cb8a2947d37de764e0", "message": "be content with just history cache directory in ensureHistoryCacheExists()\n\nfixes #3260", "committedDate": "2020-10-08T07:14:40Z", "type": "commit"}, {"oid": "3a97d4a5d5d253057ccfd98d5d02d56f81b3918a", "url": "https://github.com/oracle/opengrok/commit/3a97d4a5d5d253057ccfd98d5d02d56f81b3918a", "message": "do not call createCache() for repositories without history for directories\n\nit cannot create the cache anyway", "committedDate": "2020-10-08T07:14:40Z", "type": "commit"}, {"oid": "4bf679eaa7042acf2566e678b8147a0990d24af9", "url": "https://github.com/oracle/opengrok/commit/4bf679eaa7042acf2566e678b8147a0990d24af9", "message": "ensureHistoryCacheExists() be gone", "committedDate": "2020-10-08T07:15:37Z", "type": "forcePushed"}, {"oid": "5e2ab9607a7f3b6f1646a1f125d9479fb0e3a55a", "url": "https://github.com/oracle/opengrok/commit/5e2ab9607a7f3b6f1646a1f125d9479fb0e3a55a", "message": "ensureHistoryCacheExists() be gone", "committedDate": "2020-10-08T08:34:39Z", "type": "commit"}, {"oid": "5e2ab9607a7f3b6f1646a1f125d9479fb0e3a55a", "url": "https://github.com/oracle/opengrok/commit/5e2ab9607a7f3b6f1646a1f125d9479fb0e3a55a", "message": "ensureHistoryCacheExists() be gone", "committedDate": "2020-10-08T08:34:39Z", "type": "forcePushed"}]}