{"pr_number": 3079, "pr_title": "Otp2 separate out config loading in updaters", "pr_createdAt": "2020-05-18T14:13:04Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079", "timeline": [{"oid": "530d7e19a80f4f97fc02fee3a51dcb97e2de999e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/530d7e19a80f4f97fc02fee3a51dcb97e2de999e", "message": "Load updater config into a type safe structure", "committedDate": "2020-05-18T12:25:25Z", "type": "commit"}, {"oid": "444c03374d487ee9812f36b8143d55b4cc7f56af", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/444c03374d487ee9812f36b8143d55b4cc7f56af", "message": "Refactor GraphUpdaterConfigurator to load updater config as a separate step", "committedDate": "2020-05-18T12:26:14Z", "type": "commit"}, {"oid": "a5430667ad3b23b242371b34a1508d90128e2a27", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a5430667ad3b23b242371b34a1508d90128e2a27", "message": "- Create inner config interfaces in updaters\n- Change configure methods to take these interfaces as arguments instead of jsonNode\n- Rename configurePolling to configure\n- Change PollingGraphUpdaters to call configure method in base class instead of the other way around", "committedDate": "2020-05-18T12:27:51Z", "type": "commit"}, {"oid": "a16decb6f0e9455e2ea8a131214170f9ae088698", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a16decb6f0e9455e2ea8a131214170f9ae088698", "message": "Javadoc", "committedDate": "2020-05-18T13:08:15Z", "type": "commit"}, {"oid": "da44c431576b052660786bdb1229965229ec75c5", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/da44c431576b052660786bdb1229965229ec75c5", "message": "Remove graph as JsonConfigurable parameter", "committedDate": "2020-05-18T13:33:36Z", "type": "commit"}, {"oid": "e87104b1cff4f8d1872cce18c0eec79d0a3c9b82", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e87104b1cff4f8d1872cce18c0eec79d0a3c9b82", "message": "Remove graph as configure parameter, move graph logic to setup method where necessary", "committedDate": "2020-05-18T14:09:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MjQ0OA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426752448", "bodyText": "Use the  #asRawNode() method instead of breaking encapsulation - this could lead to false-positive warnings when starting the server...", "author": "t2gran", "createdAt": "2020-05-18T16:30:29Z", "path": "src/main/java/org/opentripplanner/standalone/config/NodeAdapter.java", "diffHunk": "@@ -84,6 +84,10 @@ JsonNode asRawNode(String paramName) {\n         return param(paramName);\n     }\n \n+    public JsonNode asRawNode() {\n+        return json;\n+    }\n+", "originalCommit": "530d7e19a80f4f97fc02fee3a51dcb97e2de999e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MDQ1MA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r427960450", "bodyText": "I removed this method, as it is not needed anymore.", "author": "gmellemstrand", "createdAt": "2020-05-20T12:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MjQ0OA=="}], "type": "inlineReview", "revised_code": {"commit": "3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "chunk": "diff --git a/src/main/java/org/opentripplanner/standalone/config/NodeAdapter.java b/src/main/java/org/opentripplanner/standalone/config/NodeAdapter.java\nindex 79c7b9b78..d22eadc5c 100644\n--- a/src/main/java/org/opentripplanner/standalone/config/NodeAdapter.java\n+++ b/src/main/java/org/opentripplanner/standalone/config/NodeAdapter.java\n\n@@ -84,10 +97,6 @@ public class NodeAdapter {\n         return param(paramName);\n     }\n \n-    public JsonNode asRawNode() {\n-        return json;\n-    }\n-\n     public boolean isEmpty() {\n         return json.isMissingNode();\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MzY3Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426753672", "bodyText": "Use the path method, and asRawNode()and pass in 2 arguments (if you need access to the JsonNode). I will explain below.", "author": "t2gran", "createdAt": "2020-05-18T16:32:37Z", "path": "src/main/java/org/opentripplanner/standalone/config/RouterConfig.java", "diffHunk": "@@ -43,10 +45,7 @@ public RouterConfig(JsonNode node, String source, boolean logUnusedParams) {\n         );\n         this.transitConfig = new TransitRoutingConfig(adapter.path(\"transit\"));\n         this.routingRequestDefaults = mapRoutingRequest(adapter.path(\"routingDefaults\"));\n-\n-        // Touch parameters read at a later point in time to avoid reporting them when\n-        // logging unused parameters.\n-        adapter.path(\"updaters\");\n+        this.updaterConfig = new UpdaterConfig(adapter.asRawNode(\"updaters\"));", "originalCommit": "530d7e19a80f4f97fc02fee3a51dcb97e2de999e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI2MDkxOQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r427260919", "bodyText": "I don't think you explained how to do this", "author": "gmellemstrand", "createdAt": "2020-05-19T12:26:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MzY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk2MDI0MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r427960241", "bodyText": "I removed this method, as it is not needed anymore.", "author": "gmellemstrand", "createdAt": "2020-05-20T12:15:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MzY3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "chunk": "diff --git a/src/main/java/org/opentripplanner/standalone/config/RouterConfig.java b/src/main/java/org/opentripplanner/standalone/config/RouterConfig.java\nindex 36e5d05d7..8f849140d 100644\n--- a/src/main/java/org/opentripplanner/standalone/config/RouterConfig.java\n+++ b/src/main/java/org/opentripplanner/standalone/config/RouterConfig.java\n\n@@ -45,7 +45,7 @@ public class RouterConfig implements Serializable {\n         );\n         this.transitConfig = new TransitRoutingConfig(adapter.path(\"transit\"));\n         this.routingRequestDefaults = mapRoutingRequest(adapter.path(\"routingDefaults\"));\n-        this.updaterConfig = new UpdaterConfig(adapter.asRawNode(\"updaters\"));\n+        this.updaterConfigList = adapter.asList(\"updaters\", UpdaterConfig::new);\n \n         if(logUnusedParams) {\n             adapter.logAllUnusedParameters(LOG);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NTExMw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426755113", "bodyText": "Here you create the NodeAdapter, but you should never do that - only do that for root config objects. I will try to remember this an prevent someone form doing it later, but this brake the \"parent\" reference and error reporting mechanish in the NodeAdapter. Also, you have lost track of the source, when you do this.", "author": "t2gran", "createdAt": "2020-05-18T16:35:10Z", "path": "src/main/java/org/opentripplanner/standalone/config/updater_config/UpdaterConfig.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.opentripplanner.standalone.config.updater_config;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.MissingNode;\n+import org.opentripplanner.standalone.config.NodeAdapter;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class UpdaterConfig {\n+\n+  public static final UpdaterConfig DEFAULT = new UpdaterConfig(\n+      MissingNode.getInstance()\n+  );\n+\n+  private final List<UpdaterConfigItem> configItems = new ArrayList<>();\n+\n+  public UpdaterConfig(JsonNode c) {\n+    for (JsonNode updater : c) {\n+      configItems.add(new UpdaterConfigItem(new NodeAdapter(updater, null)));", "originalCommit": "530d7e19a80f4f97fc02fee3a51dcb97e2de999e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwMDAzMg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426800032", "bodyText": "Also, the entire class is unnecessary. This can be put in the NodeAdapter as a general-purpose factory method:\n    public <T> List<T> asList(String paramName, Function<NodeAdapter, T> factory) {\n        List<T> result = new ArrayList<>();\n        int i = 0;\n        for (JsonNode node : param(paramName)) {\n            String pName = paramName + \"[\" + i + \"]\";\n            NodeAdapter child = new NodeAdapter(node, source, fullPath(pName));\n            children.add(child);\n            result.add(factory.apply(child));\n            ++i;\n        }\n        return result;\n    }\n\nRemember to add unit test as well:\n@Test\n    public void objectAsList() {\n        NodeAdapter subject  = newNodeAdapterForTest(\"{ key : [{ a: 'I' }, { a: '2' } ] }\");\n\n        List<String> result = subject.asList(\"key\", a -> a.asText(\"a\"));\n\n        assertEquals(\"[I, 2]\", result.toString());\n    }", "author": "t2gran", "createdAt": "2020-05-18T17:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwMDUyNw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426800527", "bodyText": "Then the UpdaterConfigItem can be renamed UpdaterConfig.", "author": "t2gran", "createdAt": "2020-05-18T17:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1NTExMw=="}], "type": "inlineReview", "revised_code": {"commit": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "chunk": "diff --git a/src/main/java/org/opentripplanner/standalone/config/updater_config/UpdaterConfig.java b/src/main/java/org/opentripplanner/standalone/config/updater_config/UpdaterConfig.java\ndeleted file mode 100644\nindex 5bd9e99b1..000000000\n--- a/src/main/java/org/opentripplanner/standalone/config/updater_config/UpdaterConfig.java\n+++ /dev/null\n\n@@ -1,27 +0,0 @@\n-package org.opentripplanner.standalone.config.updater_config;\n-\n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.node.MissingNode;\n-import org.opentripplanner.standalone.config.NodeAdapter;\n-\n-import java.util.ArrayList;\n-import java.util.List;\n-\n-public class UpdaterConfig {\n-\n-  public static final UpdaterConfig DEFAULT = new UpdaterConfig(\n-      MissingNode.getInstance()\n-  );\n-\n-  private final List<UpdaterConfigItem> configItems = new ArrayList<>();\n-\n-  public UpdaterConfig(JsonNode c) {\n-    for (JsonNode updater : c) {\n-      configItems.add(new UpdaterConfigItem(new NodeAdapter(updater, null)));\n-    }\n-  }\n-\n-  public List<UpdaterConfigItem> getItems() {\n-    return configItems;\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2MjY5NA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426762694", "bodyText": "Comment: I guess you are gone change this later to just:\nupdater = new BikeRentalUpdater(configItem);\n\nAnd then inject the graph later.\nWhen the config is injected using the constructor the cast will be unnecessary and the fields in the updater can become final.", "author": "t2gran", "createdAt": "2020-05-18T16:48:03Z", "path": "src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java", "diffHunk": "@@ -61,72 +64,75 @@ public static void setupGraph(Graph graph, JsonNode mainConfig) {\n      * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n-    private static GraphUpdaterManager createManagerFromConfig(Graph graph, JsonNode config) {\n+    private static List<GraphUpdater> createUpdatersFromConfig(Graph graph, UpdaterConfig config) {\n \n-        GraphUpdaterManager updaterManager = new GraphUpdaterManager(graph);\n-        for (JsonNode configItem : config.path(\"updaters\")) {\n+        List<GraphUpdater> updaters = new ArrayList<>();\n+\n+        for (UpdaterConfigItem configItem : config.getItems()) {\n \n             // For each sub-node, determine which kind of updater is being created.\n-            String type = configItem.path(\"type\").asText();\n+            String type = configItem.getType();\n             GraphUpdater updater = null;\n-            if (type != null) {\n-                if (type.equals(\"bike-rental\")) {\n-                    updater = new BikeRentalUpdater();\n-                }\n-                else if (type.equals(\"bike-park\")) {\n-                    updater = new BikeParkUpdater();\n-                }\n-                else if (type.equals(\"stop-time-updater\")) {\n-                    updater = new PollingStoptimeUpdater();\n-                }\n-                else if (type.equals(\"websocket-gtfs-rt-updater\")) {\n-                    updater = new WebsocketGtfsRealtimeUpdater();\n-                }\n-                else if (type.equals(\"real-time-alerts\")) {\n-                    updater = new GtfsRealtimeAlertsUpdater();\n-                }\n-                else if (type.equals(\"example-updater\")) {\n-                    updater = new ExampleGraphUpdater();\n-                }\n-                else if (type.equals(\"example-polling-updater\")) {\n-                    updater = new ExamplePollingGraphUpdater();\n-                }\n-                else if (type.equals(\"winkki-polling-updater\")) {\n-                    updater = new WinkkiPollingGraphUpdater();\n-                }\n-                else if (type.equals(\"siri-et-updater\")) {\n-                    updater = new SiriETUpdater();\n-                }\n-                else if (type.equals(\"siri-vm-updater\")) {\n-                    updater = new SiriVMUpdater();\n+\n+            try {\n+                if (type != null) {\n+                    switch (type) {\n+                        case \"bike-rental\":\n+                            updater = new BikeRentalUpdater();\n+                            ((BikeRentalUpdater) updater).configure(graph, configItem);", "originalCommit": "444c03374d487ee9812f36b8143d55b4cc7f56af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "chunk": "diff --git a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\nindex a0fdcc02c..82ecbc1cb 100644\n--- a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n+++ b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n\n@@ -64,11 +63,13 @@ public abstract class GraphUpdaterConfigurator {\n      * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n-    private static List<GraphUpdater> createUpdatersFromConfig(Graph graph, UpdaterConfig config) {\n-\n+    private static List<GraphUpdater> createUpdatersFromConfig(\n+        Graph graph,\n+        List<UpdaterConfig> configList\n+    ) {\n         List<GraphUpdater> updaters = new ArrayList<>();\n \n-        for (UpdaterConfigItem configItem : config.getItems()) {\n+        for (UpdaterConfig configItem : configList) {\n \n             // For each sub-node, determine which kind of updater is being created.\n             String type = configItem.getType();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3MzQxOA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426773418", "bodyText": "I cannot see that the updater are started in the new code?", "author": "t2gran", "createdAt": "2020-05-18T17:07:09Z", "path": "src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java", "diffHunk": "@@ -61,72 +64,75 @@ public static void setupGraph(Graph graph, JsonNode mainConfig) {\n      * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n-    private static GraphUpdaterManager createManagerFromConfig(Graph graph, JsonNode config) {\n+    private static List<GraphUpdater> createUpdatersFromConfig(Graph graph, UpdaterConfig config) {\n \n-        GraphUpdaterManager updaterManager = new GraphUpdaterManager(graph);\n-        for (JsonNode configItem : config.path(\"updaters\")) {\n+        List<GraphUpdater> updaters = new ArrayList<>();\n+\n+        for (UpdaterConfigItem configItem : config.getItems()) {\n \n             // For each sub-node, determine which kind of updater is being created.\n-            String type = configItem.path(\"type\").asText();\n+            String type = configItem.getType();\n             GraphUpdater updater = null;\n-            if (type != null) {\n-                if (type.equals(\"bike-rental\")) {\n-                    updater = new BikeRentalUpdater();\n-                }\n-                else if (type.equals(\"bike-park\")) {\n-                    updater = new BikeParkUpdater();\n-                }\n-                else if (type.equals(\"stop-time-updater\")) {\n-                    updater = new PollingStoptimeUpdater();\n-                }\n-                else if (type.equals(\"websocket-gtfs-rt-updater\")) {\n-                    updater = new WebsocketGtfsRealtimeUpdater();\n-                }\n-                else if (type.equals(\"real-time-alerts\")) {\n-                    updater = new GtfsRealtimeAlertsUpdater();\n-                }\n-                else if (type.equals(\"example-updater\")) {\n-                    updater = new ExampleGraphUpdater();\n-                }\n-                else if (type.equals(\"example-polling-updater\")) {\n-                    updater = new ExamplePollingGraphUpdater();\n-                }\n-                else if (type.equals(\"winkki-polling-updater\")) {\n-                    updater = new WinkkiPollingGraphUpdater();\n-                }\n-                else if (type.equals(\"siri-et-updater\")) {\n-                    updater = new SiriETUpdater();\n-                }\n-                else if (type.equals(\"siri-vm-updater\")) {\n-                    updater = new SiriVMUpdater();\n+\n+            try {\n+                if (type != null) {\n+                    switch (type) {\n+                        case \"bike-rental\":\n+                            updater = new BikeRentalUpdater();\n+                            ((BikeRentalUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"bike-park\":\n+                            updater = new BikeParkUpdater();\n+                            ((BikeParkUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"stop-time-updater\":\n+                            updater = new PollingStoptimeUpdater();\n+                            ((PollingStoptimeUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"websocket-gtfs-rt-updater\":\n+                            updater = new WebsocketGtfsRealtimeUpdater();\n+                            ((WebsocketGtfsRealtimeUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"real-time-alerts\":\n+                            updater = new GtfsRealtimeAlertsUpdater();\n+                            ((GtfsRealtimeAlertsUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"example-updater\":\n+                            updater = new ExampleGraphUpdater();\n+                            ((ExampleGraphUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"example-polling-updater\":\n+                            updater = new ExamplePollingGraphUpdater();\n+                            ((ExamplePollingGraphUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"winkki-polling-updater\":\n+                            updater = new WinkkiPollingGraphUpdater();\n+                            ((WinkkiPollingGraphUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"siri-et-updater\":\n+                            updater = new SiriETUpdater();\n+                            ((SiriETUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"siri-vm-updater\":\n+                            updater = new SiriVMUpdater();\n+                            ((SiriVMUpdater) updater).configure(graph, configItem);\n+                            break;\n+                        case \"siri-sx-updater\":\n+                            updater = new SiriSXUpdater();\n+                            ((SiriSXUpdater) updater).configure(graph, configItem);\n+                            break;\n+                    }\n                 }\n-                else if (type.equals(\"siri-sx-updater\")) {\n-                    updater = new SiriSXUpdater();\n+                if (updater != null) {\n+                    updaters.add(updater);\n                 }\n             }\n-\n-            if (updater == null) {\n-                LOG.error(\"Unknown updater type: \" + type);\n-            } else {\n-                try {\n-                    // Inform the GraphUpdater of its parent Manager so the updater can enqueue write operations.\n-                    // Perhaps this should be done in \"addUpdater\" below, to ensure the link is reciprocal.\n-                    updater.setGraphUpdaterManager(updaterManager);\n-                    // All GraphUpdaters are JsonConfigurable - send them their config information.\n-                    updater.configure(graph, configItem);\n-                    // Perform any initial setup in a single-threaded manner to avoid concurrent reads/writes.\n-                    updater.setup(graph);\n-                    // Add graph updater to manager.\n-                    updaterManager.addUpdater(updater);\n-                    LOG.info(\"Configured GraphUpdater: {}\", updater);\n-                } catch (Exception e) {\n-                    LOG.error(\"Failed to configure graph updater:\" + configItem.asText(), e);\n-                }\n+            catch (Exception e) {\n+                LOG.error(\"Failed to configure graph updater:\" + configItem.getType(), e);\n             }\n         }\n-        // Now that all the updaters are configured, kick them all off in their own threads.\n-        updaterManager.startUpdaters();\n-        return updaterManager;", "originalCommit": "444c03374d487ee9812f36b8143d55b4cc7f56af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzIzNjk0Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r427236942", "bodyText": "The updaters are started in GraphUpdaterConfigurator.java line 51.", "author": "gmellemstrand", "createdAt": "2020-05-19T11:43:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3MzQxOA=="}], "type": "inlineReview", "revised_code": {"commit": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "chunk": "diff --git a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\nindex a0fdcc02c..82ecbc1cb 100644\n--- a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n+++ b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n\n@@ -64,11 +63,13 @@ public abstract class GraphUpdaterConfigurator {\n      * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n-    private static List<GraphUpdater> createUpdatersFromConfig(Graph graph, UpdaterConfig config) {\n-\n+    private static List<GraphUpdater> createUpdatersFromConfig(\n+        Graph graph,\n+        List<UpdaterConfig> configList\n+    ) {\n         List<GraphUpdater> updaters = new ArrayList<>();\n \n-        for (UpdaterConfigItem configItem : config.getItems()) {\n+        for (UpdaterConfig configItem : configList) {\n \n             // For each sub-node, determine which kind of updater is being created.\n             String type = configItem.getType();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3NjYwMg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426776602", "bodyText": "Tip! There is no need to extend - unless you add/override parameters. The good thing of not extending is that is is clear that the super-config is enough.", "author": "t2gran", "createdAt": "2020-05-18T17:13:02Z", "path": "src/ext/java/org/opentripplanner/ext/examples/updater/ExampleGraphUpdater.java", "diffHunk": "@@ -41,43 +42,41 @@\n     private String url;\n \n     // Here the updater can be configured using the properties in the file 'Graph.properties'.\n-    @Override\n-    public void configure(Graph graph, JsonNode config) throws Exception {\n-        frequencySec = config.path(\"frequencySec\").asInt(5);\n-        url = config.path(\"url\").asText();\n+    public void configure(Graph graph, ExampleGraphUpdaterConfig config) {\n+        frequencySec = config.getFrequencySec();\n+        url = config.getUrl();\n         LOG.info(\"Configured example updater: frequencySec={} and url={}\", frequencySec, url);\n     }\n \n     // Here the updater gets to know its parent manager to execute GraphWriterRunnables.\n-    @Override\n     public void setGraphUpdaterManager(GraphUpdaterManager updaterManager) {\n         LOG.info(\"Example updater: updater manager is set\");\n         this.updaterManager = updaterManager;\n     }\n \n     // Here the updater can be initialized.\n-    @Override\n     public void setup(Graph graph) {\n         LOG.info(\"Setup example updater\");\n     }\n \n     // This is where the updater thread receives updates and applies them to the graph.\n     // This method only runs once.\n-    @Override\n     public void run() {\n         LOG.info(\"Run example updater with hashcode: {}\", this.hashCode());\n         // Here the updater can connect to a server and register a callback function\n         // to handle updates to the graph\n     }\n \n     // Here the updater can cleanup after itself.\n-    @Override\n     public void teardown() {\n         LOG.info(\"Teardown example updater\");\n     }\n \n-    @Override\n     public String getName() {\n         return \"ExampleGraphUpdater\";\n     }\n+\n+    public interface ExampleGraphUpdaterConfig\n+        extends PollingGraphUpdater.PollingGraphUpdaterConfig {\n+    }", "originalCommit": "a5430667ad3b23b242371b34a1508d90128e2a27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3ODIzMw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r426778233", "bodyText": "Also, this break the established naming convention - using Parameters for the role defined by the config consumer, and using Config for the role implementing the Parameters delivering the config to the consumer/domain.", "author": "t2gran", "createdAt": "2020-05-18T17:16:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc3NjYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "chunk": "diff --git a/src/ext/java/org/opentripplanner/ext/examples/updater/ExampleGraphUpdater.java b/src/ext/java/org/opentripplanner/ext/examples/updater/ExampleGraphUpdater.java\nindex c3976c7f5..d0ee314a4 100644\n--- a/src/ext/java/org/opentripplanner/ext/examples/updater/ExampleGraphUpdater.java\n+++ b/src/ext/java/org/opentripplanner/ext/examples/updater/ExampleGraphUpdater.java\n\n@@ -42,7 +42,7 @@ public class ExampleGraphUpdater implements GraphUpdater {\n     private String url;\n \n     // Here the updater can be configured using the properties in the file 'Graph.properties'.\n-    public void configure(Graph graph, ExampleGraphUpdaterConfig config) {\n+    public void configure(ExampleGraphUpdaterConfig config) {\n         frequencySec = config.getFrequencySec();\n         url = config.getUrl();\n         LOG.info(\"Configured example updater: frequencySec={} and url={}\", frequencySec, url);\n"}}, {"oid": "6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6adcf23c9c5b162b7a4d490cea97b9c50cd5f5e8", "message": "Add list support to NodeAdapter and use it for loading updater config", "committedDate": "2020-05-19T12:31:01Z", "type": "commit"}, {"oid": "3c49bf829f1c6f66a91f1003f7a2e240085f2e9f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3c49bf829f1c6f66a91f1003f7a2e240085f2e9f", "message": "Set updater config in constructors instead of configure method", "committedDate": "2020-05-19T12:58:55Z", "type": "commit"}, {"oid": "4a2304b41ac0ad54fa5424a37ee976a0afdebd44", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/4a2304b41ac0ad54fa5424a37ee976a0afdebd44", "message": "Add type-safe config to updater sources", "committedDate": "2020-05-20T11:42:16Z", "type": "commit"}, {"oid": "fae249d155325e8697a5f5bc6fc90de234e82c79", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fae249d155325e8697a5f5bc6fc90de234e82c79", "message": "Merge branch 'dev-2.x' into otp2_refactor_updaters", "committedDate": "2020-05-20T11:45:20Z", "type": "commit"}, {"oid": "19606077b52c5aca882db3a23a82ecaf8dec1944", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/19606077b52c5aca882db3a23a82ecaf8dec1944", "message": "Rename inner config interfaces to just Config", "committedDate": "2020-05-20T11:52:11Z", "type": "commit"}, {"oid": "ec9943c108d1ec6bc23f1fcddcb77ce96d0b23bb", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/ec9943c108d1ec6bc23f1fcddcb77ce96d0b23bb", "message": "Cleanup unused exception declarations, make fields final etc.", "committedDate": "2020-05-20T12:13:48Z", "type": "commit"}, {"oid": "3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "message": "Remove NodeAdapter.asRawNode() - not needed anymore", "committedDate": "2020-05-20T12:14:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzE4NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r429147185", "bodyText": "Remove graph", "author": "t2gran", "createdAt": "2020-05-22T09:39:53Z", "path": "src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java", "diffHunk": "@@ -36,16 +39,15 @@\n \n     private static Logger LOG = LoggerFactory.getLogger(GraphUpdaterConfigurator.class);\n \n-    public static void setupGraph(Graph graph, JsonNode mainConfig) {\n+    public static void setupGraph(Graph graph, List<UpdaterConfig> updaterConfigList) {\n+\n+        List<GraphUpdater> updaters = new ArrayList<>();\n \n-        // Look for embedded config if it exists\n-        // TODO figure out how & when we will use embedded config in absence of main config.\n-        JsonNode embeddedConfig = null; // graph.routerConfig;\n-        LOG.info(\"Using configurations: \" + (mainConfig == null ? \"\" : \"[main]\") + \" \"\n-                + (embeddedConfig == null ? \"\" : \"[embedded]\"));\n+        updaters.addAll(createUpdatersFromConfig(graph, updaterConfigList));", "originalCommit": "3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1b03e6e7db71869e15f9cdedc28b104404a7721e", "chunk": "diff --git a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\nindex dd8225ff9..52717cd30 100644\n--- a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n+++ b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n\n@@ -43,7 +43,7 @@ public abstract class GraphUpdaterConfigurator {\n \n         List<GraphUpdater> updaters = new ArrayList<>();\n \n-        updaters.addAll(createUpdatersFromConfig(graph, updaterConfigList));\n+        updaters.addAll(createUpdatersFromConfig(updaterConfigList));\n \n         setupUpdaters(graph, updaters);\n         GraphUpdaterManager updaterManager = new GraphUpdaterManager(graph, updaters);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzQ0NQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r429147445", "bodyText": "bindUpdatersToGraph", "author": "t2gran", "createdAt": "2020-05-22T09:40:26Z", "path": "src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java", "diffHunk": "@@ -36,16 +39,15 @@\n \n     private static Logger LOG = LoggerFactory.getLogger(GraphUpdaterConfigurator.class);\n \n-    public static void setupGraph(Graph graph, JsonNode mainConfig) {\n+    public static void setupGraph(Graph graph, List<UpdaterConfig> updaterConfigList) {\n+\n+        List<GraphUpdater> updaters = new ArrayList<>();\n \n-        // Look for embedded config if it exists\n-        // TODO figure out how & when we will use embedded config in absence of main config.\n-        JsonNode embeddedConfig = null; // graph.routerConfig;\n-        LOG.info(\"Using configurations: \" + (mainConfig == null ? \"\" : \"[main]\") + \" \"\n-                + (embeddedConfig == null ? \"\" : \"[embedded]\"));\n+        updaters.addAll(createUpdatersFromConfig(graph, updaterConfigList));\n \n-        // Create a updater manager for this graph, and create updaters according to the JSON configuration.\n-        GraphUpdaterManager updaterManager = createManagerFromConfig(graph, mainConfig);\n+        setupUpdaters(graph, updaters);", "originalCommit": "3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1b03e6e7db71869e15f9cdedc28b104404a7721e", "chunk": "diff --git a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\nindex dd8225ff9..52717cd30 100644\n--- a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n+++ b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n\n@@ -43,7 +43,7 @@ public abstract class GraphUpdaterConfigurator {\n \n         List<GraphUpdater> updaters = new ArrayList<>();\n \n-        updaters.addAll(createUpdatersFromConfig(graph, updaterConfigList));\n+        updaters.addAll(createUpdatersFromConfig(updaterConfigList));\n \n         setupUpdaters(graph, updaters);\n         GraphUpdaterManager updaterManager = new GraphUpdaterManager(graph, updaters);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0ODUwNQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3079#discussion_r429148505", "bodyText": "rename configItem", "author": "t2gran", "createdAt": "2020-05-22T09:42:45Z", "path": "src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java", "diffHunk": "@@ -61,72 +63,66 @@ public static void setupGraph(Graph graph, JsonNode mainConfig) {\n      * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n-    private static GraphUpdaterManager createManagerFromConfig(Graph graph, JsonNode config) {\n+    private static List<GraphUpdater> createUpdatersFromConfig(\n+        Graph graph,\n+        List<UpdaterConfig> configList\n+    ) {\n+        List<GraphUpdater> updaters = new ArrayList<>();\n \n-        GraphUpdaterManager updaterManager = new GraphUpdaterManager(graph);\n-        for (JsonNode configItem : config.path(\"updaters\")) {\n+        for (UpdaterConfig configItem : configList) {\n \n             // For each sub-node, determine which kind of updater is being created.\n-            String type = configItem.path(\"type\").asText();\n+            String type = configItem.getType();\n             GraphUpdater updater = null;\n-            if (type != null) {\n-                if (type.equals(\"bike-rental\")) {\n-                    updater = new BikeRentalUpdater();\n-                }\n-                else if (type.equals(\"bike-park\")) {\n-                    updater = new BikeParkUpdater();\n-                }\n-                else if (type.equals(\"stop-time-updater\")) {\n-                    updater = new PollingStoptimeUpdater();\n-                }\n-                else if (type.equals(\"websocket-gtfs-rt-updater\")) {\n-                    updater = new WebsocketGtfsRealtimeUpdater();\n-                }\n-                else if (type.equals(\"real-time-alerts\")) {\n-                    updater = new GtfsRealtimeAlertsUpdater();\n-                }\n-                else if (type.equals(\"example-updater\")) {\n-                    updater = new ExampleGraphUpdater();\n-                }\n-                else if (type.equals(\"example-polling-updater\")) {\n-                    updater = new ExamplePollingGraphUpdater();\n-                }\n-                else if (type.equals(\"winkki-polling-updater\")) {\n-                    updater = new WinkkiPollingGraphUpdater();\n-                }\n-                else if (type.equals(\"siri-et-updater\")) {\n-                    updater = new SiriETUpdater();\n-                }\n-                else if (type.equals(\"siri-vm-updater\")) {\n-                    updater = new SiriVMUpdater();\n+\n+            try {\n+                if (type != null) {\n+                    switch (type) {\n+                        case \"bike-rental\":\n+                            updater = new BikeRentalUpdater(configItem);", "originalCommit": "3b3d2f5b1fc6520c490e193a26e7d49de1a1460c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1b03e6e7db71869e15f9cdedc28b104404a7721e", "chunk": "diff --git a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\nindex dd8225ff9..52717cd30 100644\n--- a/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n+++ b/src/main/java/org/opentripplanner/updater/GraphUpdaterConfigurator.java\n\n@@ -60,11 +60,9 @@ public abstract class GraphUpdaterConfigurator {\n     }\n \n     /**\n-     * @param graph the graph that will be modified by these updaters\n      * @return a GraphUpdaterManager containing all the created updaters\n      */\n     private static List<GraphUpdater> createUpdatersFromConfig(\n-        Graph graph,\n         List<UpdaterConfig> configList\n     ) {\n         List<GraphUpdater> updaters = new ArrayList<>();\n"}}, {"oid": "1b03e6e7db71869e15f9cdedc28b104404a7721e", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1b03e6e7db71869e15f9cdedc28b104404a7721e", "message": "Remove graph from createUpdatersFromConfig arguments", "committedDate": "2020-05-25T10:55:34Z", "type": "commit"}, {"oid": "b38debfcda9730d3c49dd841b29c843a1b65f1e6", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b38debfcda9730d3c49dd841b29c843a1b65f1e6", "message": "- Add mapping from updater \"type\"(JSON) to the updater class, keeping a type-safe list a config for each updater -  @t2gran\n- Create separate parameter classes for each updater type", "committedDate": "2020-05-27T09:38:08Z", "type": "commit"}, {"oid": "29a05ca2082d49580732a1f3eb3552667d3dedff", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/29a05ca2082d49580732a1f3eb3552667d3dedff", "message": "Rename updater config to parameters", "committedDate": "2020-05-27T09:51:44Z", "type": "commit"}, {"oid": "29a05ca2082d49580732a1f3eb3552667d3dedff", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/29a05ca2082d49580732a1f3eb3552667d3dedff", "message": "Rename updater config to parameters", "committedDate": "2020-05-27T09:51:44Z", "type": "forcePushed"}, {"oid": "26f86f6723bbddf7441edbc485ea051df9e17a99", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/26f86f6723bbddf7441edbc485ea051df9e17a99", "message": "Also make updater data sources type safe", "committedDate": "2020-05-27T13:52:48Z", "type": "commit"}, {"oid": "508700f8f4fea132789652444d17954f3640cc79", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/508700f8f4fea132789652444d17954f3640cc79", "message": "Merge branch 'dev-2.x' into otp2_refactor_updaters", "committedDate": "2020-05-27T13:53:17Z", "type": "commit"}, {"oid": "da5e1c9d3c4eb200104f4df339e3b3ad891e67bd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/da5e1c9d3c4eb200104f4df339e3b3ad891e67bd", "message": "Fix incorrect mapping of KmlBikeParkSourceParameters", "committedDate": "2020-05-28T08:55:02Z", "type": "commit"}, {"oid": "b2b686eb5f07ea8b3cbe14a62aa688e08501c85c", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b2b686eb5f07ea8b3cbe14a62aa688e08501c85c", "message": "Added sourceType requirement to migration guide and updated javadoc", "committedDate": "2020-05-28T10:34:19Z", "type": "commit"}, {"oid": "b0e7ba2d4b80cbedbdd4facae7be70d220226302", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/b0e7ba2d4b80cbedbdd4facae7be70d220226302", "message": "Extract UpdaterDataSourceConfig interface", "committedDate": "2020-05-29T12:06:27Z", "type": "commit"}]}