{"pr_number": 3077, "pr_title": "Otp2 fix debug filter error", "pr_createdAt": "2020-05-13T22:33:26Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077", "timeline": [{"oid": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "message": "Bugfix\n - The itinerary filter debug mode did not always report all removed trips, this has been fixed by slightly changing the debug-filtering strategy.\n - This also fixes the potential error of having an itinerary marked with a system notice pass through the filtering without being deleted even when it should.", "committedDate": "2020-05-13T22:28:46Z", "type": "commit"}, {"oid": "7636b8fd9a85d7c6f46a032df78e50c80fdb8c47", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/7636b8fd9a85d7c6f46a032df78e50c80fdb8c47", "message": "Bugfix - Fix the sorting order for arrive-by search.", "committedDate": "2020-05-13T22:28:46Z", "type": "commit"}, {"oid": "f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4", "message": "Bug-fix on search-widow metadata returned to client for arriveBy routing search. The nex- and prev- dateTime was not calculated correct for arriveBy search.\n- There are also a some small cleanups.", "committedDate": "2020-05-15T15:39:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3MjI3Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427072277", "bodyText": "Typo: Wrppers => Wrappers", "author": "hannesj", "createdAt": "2020-05-19T07:00:19Z", "path": "src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java", "diffHunk": "@@ -103,6 +104,18 @@ public ItineraryFilter build() {\n             filters.add(new MaxLimitFilter(\"MAX\", maxLimit));\n         }\n \n-        return debug ? new DebugFilterChain(filters) : new FilterChain(filters);\n+        if(debug) {\n+            filters = addDebugWrppers(filters);", "originalCommit": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4fd904d3f32e7383913d86ce677eb5648ec83a3b", "chunk": "diff --git a/src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java b/src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java\nindex 48ff9d460..8eb766b74 100644\n--- a/src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java\n+++ b/src/main/java/org/opentripplanner/routing/algorithm/filterchain/ItineraryFilterChainBuilder.java\n\n@@ -97,15 +120,15 @@ public class ItineraryFilterChainBuilder {\n         }\n \n         // Sort itineraries\n-        filters.add(new SortOnWalkingArrivalAndDeparture());\n+        filters.add(new OtpDefaultSortOrder(arriveBy));\n \n         // Remove itineraries if max limit is exceeded\n         if (maxLimit >= minLimit) {\n-            filters.add(new MaxLimitFilter(\"MAX\", maxLimit));\n+            filters.add(new MaxLimitFilter(\"MAX\", maxLimit, maxLimitReachedSubscriber));\n         }\n \n         if(debug) {\n-            filters = addDebugWrppers(filters);\n+            filters = addDebugWrappers(filters);\n         }\n \n         return new FilterChain(filters);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NTM3Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427075372", "bodyText": "remaning? Although I think something like previouslyUnfiltered might make more sense.", "author": "hannesj", "createdAt": "2020-05-19T07:07:07Z", "path": "src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.opentripplanner.routing.algorithm.filterchain.filters;\n+\n+import org.opentripplanner.model.SystemNotice;\n+import org.opentripplanner.model.plan.Itinerary;\n+import org.opentripplanner.routing.algorithm.filterchain.ItineraryFilter;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class DebugFilterWrapper implements ItineraryFilter {\n+\n+  private final ItineraryFilter delegate;\n+  private final List<Itinerary> deletedItineraries;\n+\n+  public DebugFilterWrapper(ItineraryFilter delegate, List<Itinerary> deletedItineraries) {\n+    this.delegate = delegate;\n+    this.deletedItineraries = deletedItineraries;\n+  }\n+\n+  @Override\n+  public String name() {\n+    return delegate.name();\n+  }\n+\n+  @Override\n+  public List<Itinerary> filter(List<Itinerary> itineraries) {\n+    List<Itinerary> reminding = remindingItineraries(itineraries);", "originalCommit": "0bf18c1f36a1e7d97d2fbd122a5c060859701ef8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4fd904d3f32e7383913d86ce677eb5648ec83a3b", "chunk": "diff --git a/src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java b/src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java\nindex 88ebc43d0..3cb492c25 100644\n--- a/src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java\n+++ b/src/main/java/org/opentripplanner/routing/algorithm/filterchain/filters/DebugFilterWrapper.java\n\n@@ -25,10 +25,10 @@ public class DebugFilterWrapper implements ItineraryFilter {\n \n   @Override\n   public List<Itinerary> filter(List<Itinerary> itineraries) {\n-    List<Itinerary> reminding = remindingItineraries(itineraries);\n-    List<Itinerary> filtered = delegate.filter(reminding);\n+    List<Itinerary> previouslyUnfiltered = remindingItineraries(itineraries);\n+    List<Itinerary> filtered = delegate.filter(previouslyUnfiltered);\n \n-    for (Itinerary it : reminding) {\n+    for (Itinerary it : previouslyUnfiltered) {\n       if(!filtered.contains(it)) {\n         markItineraryAsDeleted(it);\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4MzY0Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427083647", "bodyText": "We might want to make it more explicit, that this is only when changing the direction of the search. Now it is not clear, when skimming the text. When searching in the same direction, there is no need to se the numOfItineraries any higher.", "author": "hannesj", "createdAt": "2020-05-19T07:23:48Z", "path": "src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java", "diffHunk": "@@ -9,12 +9,18 @@\n      * This is the time window used by the raptor search. The window is an optional parameter and\n      * OTP might override it/dynamically assign a new value.\n      * <p>\n+     * Note! This parameter is NOT adjusted when the number of itineraries are reduced due to the\n+     * request {@code numOfItineraries} parameter. When getting the next results\n+     * ({@code arriveBy=true}) or previous results({@code arriveBy=false}), be sure to set the\n+     * {@code numOfItineraries} high enough to include all itineraries. If not, the combined results\n+     * will be missing trips.\n+     * <p>", "originalCommit": "f03aefcfb6d5e6d5ccfc6a4bcfec95b4684feeb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkxMTQ4OQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3077#discussion_r427911489", "bodyText": "I tried to make it clearer se the new doc on: searchWindow, nextDateTime and prevDateTime.", "author": "t2gran", "createdAt": "2020-05-20T10:40:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4MzY0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4fd904d3f32e7383913d86ce677eb5648ec83a3b", "chunk": "diff --git a/src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java b/src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java\nindex 102a4d6fb..01322b20e 100644\n--- a/src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java\n+++ b/src/main/java/org/opentripplanner/api/model/ApiTripSearchMetadata.java\n\n@@ -9,11 +9,11 @@ public class ApiTripSearchMetadata {\n      * This is the time window used by the raptor search. The window is an optional parameter and\n      * OTP might override it/dynamically assign a new value.\n      * <p>\n-     * Note! This parameter is NOT adjusted when the number of itineraries are reduced due to the\n-     * request {@code numOfItineraries} parameter. When getting the next results\n-     * ({@code arriveBy=true}) or previous results({@code arriveBy=false}), be sure to set the\n-     * {@code numOfItineraries} high enough to include all itineraries. If not, the combined results\n-     * will be missing trips.\n+     * Note! The `searchWindowUsed` is NOT adjusted in the post-search-filtering. If the\n+     * {@code numOfItineraries} request parameter is set, optimal itineraries are removed from the\n+     * end of the result. Be aware of this when adding the results of more than on search together.\n+     * If the client support paging/scrolling, do not use the {@code numOfItineraries} parameter,\n+     * cache or hide the last part of the returned list of itineraries instead.\n      * <p>\n      * Unit : seconds\n      */\n"}}, {"oid": "4fd904d3f32e7383913d86ce677eb5648ec83a3b", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/4fd904d3f32e7383913d86ce677eb5648ec83a3b", "message": "Review fixes - Otp2 fix debug filter error.", "committedDate": "2020-05-20T10:14:13Z", "type": "commit"}, {"oid": "11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_fix_debug_filter_error", "committedDate": "2020-05-20T10:41:48Z", "type": "commit"}, {"oid": "11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/11d093308abbcc0ca76dbb81ca2dc1feee23d4b0", "message": "Merge remote-tracking branch 'otp/dev-2.x' into otp2_fix_debug_filter_error", "committedDate": "2020-05-20T10:41:48Z", "type": "forcePushed"}]}