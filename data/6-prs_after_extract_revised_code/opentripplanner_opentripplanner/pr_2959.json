{"pr_number": 2959, "pr_title": "Keep an index of realtime patternsForStop in the TimetableSnapshot.", "pr_createdAt": "2020-02-05T15:12:08Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959", "timeline": [{"oid": "6cee6b117252ea6952bcc9ca425c7a3e4e94dec3", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6cee6b117252ea6952bcc9ca425c7a3e4e94dec3", "message": "Keep an index of realtime patternsForStop in the TimetableSnapshot.", "committedDate": "2020-02-05T14:40:15Z", "type": "commit"}, {"oid": "141cdbcc60de5fc060c2429c1ab85a404206abc7", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/141cdbcc60de5fc060c2429c1ab85a404206abc7", "message": "Added javadoc", "committedDate": "2020-02-05T14:58:53Z", "type": "commit"}, {"oid": "3683044ed11544c56b290bb2f0fa7715a8f51492", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3683044ed11544c56b290bb2f0fa7715a8f51492", "message": "Added changelog entry", "committedDate": "2020-02-05T15:01:50Z", "type": "commit"}, {"oid": "21168855ea4da60f040815bf1d107a4419451acf", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/21168855ea4da60f040815bf1d107a4419451acf", "message": "Rename variable", "committedDate": "2020-02-05T15:03:53Z", "type": "commit"}, {"oid": "c4997dfb54cb1fca24fd6c148f86e658c463bd03", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c4997dfb54cb1fca24fd6c148f86e658c463bd03", "message": "Remove todo that is no longer relevant", "committedDate": "2020-02-06T08:07:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1NTY1MQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959#discussion_r378155651", "bodyText": "This conditional is probably not necessary, even from a performance point of view. The meaning might be clearer with only the put() call and no conditional.", "author": "abyrd", "createdAt": "2020-02-12T10:14:44Z", "path": "src/main/java/org/opentripplanner/model/TimetableSnapshot.java", "diffHunk": "@@ -369,4 +385,19 @@ public String toString() {\n         return timetables.keySet();\n     }\n \n+    private void addPatternToIndex(TripPattern tripPattern) {\n+        for (Stop stop: tripPattern.getStops()) {\n+            if (!patternsForStop.containsEntry(stop, tripPattern)) {", "originalCommit": "c4997dfb54cb1fca24fd6c148f86e658c463bd03", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "51189a972bb33563bf820e9f9608bcc0cabdad67", "chunk": "diff --git a/src/main/java/org/opentripplanner/model/TimetableSnapshot.java b/src/main/java/org/opentripplanner/model/TimetableSnapshot.java\nindex 8bdd09d64..fbf888274 100644\n--- a/src/main/java/org/opentripplanner/model/TimetableSnapshot.java\n+++ b/src/main/java/org/opentripplanner/model/TimetableSnapshot.java\n\n@@ -387,9 +387,7 @@ public class TimetableSnapshot {\n \n     private void addPatternToIndex(TripPattern tripPattern) {\n         for (Stop stop: tripPattern.getStops()) {\n-            if (!patternsForStop.containsEntry(stop, tripPattern)) {\n-                patternsForStop.put(stop, tripPattern);\n-            }\n+            patternsForStop.put(stop, tripPattern);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MzM1Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959#discussion_r378163357", "bodyText": "We just discussed the fact that this is getting a snapshot within a single small method. Snapshots are intended to be held and reused throughout a full request cycle. So methods like this should really be on the snapshot (or applied to a snapshot) rather than applied to the Graph or GraphIndex. The problem is that GraphIndex contains both an index of the essentially immutable data in a Graph, plus a bunch of methods that produce API responses that happen to use that index. But those methods also examine things like realtime data. Really, those API methods should be outside GraphIndex, and they should have a reference to a realtime snapshot, which in turn gives access to an underlying long-lived Graph and GraphIndex.", "author": "abyrd", "createdAt": "2020-02-12T10:28:41Z", "path": "src/main/java/org/opentripplanner/routing/graph/GraphIndex.java", "diffHunk": "@@ -434,14 +436,19 @@ public BitSet servicesRunning (LocalDate date) {\n         return ret;\n     }\n \n-    // TODO OTP2 - Add support for includeRealtimeUpdates\n+    /**\n+     * Returns all the patterns for a specific stop. If includeRealtimeUpdates is set, new patterns\n+     * added by realtime updates are added to the collection.\n+     */\n     public Collection<TripPattern> getPatternsForStop(Stop stop, boolean includeRealtimeUpdates) {\n         List<TripPattern> tripPatterns = new ArrayList<>(patternsForStop.get(stop));\n-        /*\n-        if (includeRealtimeUpdates && graph.timetableSnapshotSource != null) {\n-            tripPatterns.addAll(graph.timetableSnapshotSource.getAddedTripPatternsForStop(stop));\n+\n+        TimetableSnapshot timetableSnapshot = graph.getTimetableSnapshot();", "originalCommit": "c4997dfb54cb1fca24fd6c148f86e658c463bd03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2ODUxOQ==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959#discussion_r378168519", "bodyText": "We discussed further - this will work in a loose sense, but it defies some of our assumptions. This method getPatternsForStop is called in many places, various small methods within a GraphQL query. This means a single GraphQL query could fetch different snapshots. It will be easier to reason about this, and to describe behavior to API clients, if we can state concisely that every request always sees exactly one snapshot. There are also performance implications, since the snapshot provider only expects to be called once per request, so may have some slightly time-consuming side effects that amount to committing a transaction.", "author": "abyrd", "createdAt": "2020-02-12T10:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ5OTE4Mg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959#discussion_r378499182", "bodyText": "I had a look at this to see if we could refactor to make it better. Gard will try do the following:\nExtract a fasade out of the GraphIndex and Graph (lets call it RoutingService). The RoutingService should be the entry point for all access to all logic in the routing java package (from outside of the package). Put it on in the org.opentripplanner.routing package.. We can let the routing service have a request scope and delegate to the GraphIndex and Graph. Some of the methods in the Graph and Index should be moved where they belong. The RoutingService will have a lazy getter to the TimeTableSnapshot and inject this instance where needed. The APIs should get one RoutingService and use it for the duration of each request. The RoutingService would be a stateful service. It should contain a minimum of logic, delegating other parts of the routing package like the GraphIndex and Graph.", "author": "t2gran", "createdAt": "2020-02-12T20:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MzM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM1NTQwNg==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/2959#discussion_r379355406", "bodyText": "We will try to use the Lombok library @Delegate to make this a true Facade.", "author": "t2gran", "createdAt": "2020-02-14T10:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MzM1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "61fb84c0e2fd2362fd413d7a5bf3963223a52c50", "chunk": "diff --git a/src/main/java/org/opentripplanner/routing/graph/GraphIndex.java b/src/main/java/org/opentripplanner/routing/graph/GraphIndex.java\nindex e61765fde..eef42d38b 100644\n--- a/src/main/java/org/opentripplanner/routing/graph/GraphIndex.java\n+++ b/src/main/java/org/opentripplanner/routing/graph/GraphIndex.java\n\n@@ -441,7 +490,7 @@ public class GraphIndex {\n      * added by realtime updates are added to the collection.\n      */\n     public Collection<TripPattern> getPatternsForStop(Stop stop, boolean includeRealtimeUpdates) {\n-        List<TripPattern> tripPatterns = new ArrayList<>(patternsForStop.get(stop));\n+        List<TripPattern> tripPatterns = new ArrayList<>(getPatternsForStop().get(stop));\n \n         TimetableSnapshot timetableSnapshot = graph.getTimetableSnapshot();\n \n"}}, {"oid": "51189a972bb33563bf820e9f9608bcc0cabdad67", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/51189a972bb33563bf820e9f9608bcc0cabdad67", "message": "Removed unecessary check before adding to map", "committedDate": "2020-02-12T15:05:53Z", "type": "commit"}, {"oid": "61fb84c0e2fd2362fd413d7a5bf3963223a52c50", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/61fb84c0e2fd2362fd413d7a5bf3963223a52c50", "message": "Encapsulate fields in GraphIndex", "committedDate": "2020-02-13T08:17:29Z", "type": "commit"}, {"oid": "6a6044758c9844b8072885d2f38f1da4a48f8582", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6a6044758c9844b8072885d2f38f1da4a48f8582", "message": "Move GraphIndex class to root of routing package", "committedDate": "2020-02-13T08:19:59Z", "type": "commit"}, {"oid": "3daff90db3b607a6368db3cfa79fe10da0189a38", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/3daff90db3b607a6368db3cfa79fe10da0189a38", "message": "Fixed references to RoutingService and GraphIndex", "committedDate": "2020-02-13T09:43:30Z", "type": "commit"}, {"oid": "474c8513ec83262b8862026e0a13cf2baf51bdbd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/474c8513ec83262b8862026e0a13cf2baf51bdbd", "message": "Change apis to use RoutingService", "committedDate": "2020-02-13T11:50:11Z", "type": "commit"}, {"oid": "270c7f46ac0914d8b4ca55e8ceaca49c25b904b3", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/270c7f46ac0914d8b4ca55e8ceaca49c25b904b3", "message": "Move some methods from RoutingService to their own classes", "committedDate": "2020-02-13T13:03:46Z", "type": "commit"}, {"oid": "dad5b8d4572c508855f5d91cab6e0b5709e17a64", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/dad5b8d4572c508855f5d91cab6e0b5709e17a64", "message": "Instanciate a TimetableSnapshot for each RoutingService", "committedDate": "2020-02-13T13:04:27Z", "type": "commit"}, {"oid": "fb2ff547f96ed0f640cfd60b0881e903f714ed41", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/fb2ff547f96ed0f640cfd60b0881e903f714ed41", "message": "More javadoc", "committedDate": "2020-02-14T13:05:06Z", "type": "commit"}, {"oid": "13d06968762417b9d33428d6ace5295879a4cb40", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/13d06968762417b9d33428d6ace5295879a4cb40", "message": "Added todos", "committedDate": "2020-02-14T13:28:46Z", "type": "commit"}, {"oid": "13d06968762417b9d33428d6ace5295879a4cb40", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/13d06968762417b9d33428d6ace5295879a4cb40", "message": "Added todos", "committedDate": "2020-02-14T13:28:46Z", "type": "forcePushed"}, {"oid": "6751eb2af462371f79e9702bc60fcf02f177fe19", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6751eb2af462371f79e9702bc60fcf02f177fe19", "message": "Make getTimetableSnapshot private", "committedDate": "2020-02-14T13:36:34Z", "type": "commit"}, {"oid": "498a908c0530cd4f0f784c855b8e45dee8e58053", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/498a908c0530cd4f0f784c855b8e45dee8e58053", "message": "Instanciate a RoutingService for each REST api call", "committedDate": "2020-02-14T13:43:25Z", "type": "commit"}, {"oid": "1c61d6751398254575ba759711803085a5990a6b", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1c61d6751398254575ba759711803085a5990a6b", "message": "Refactor the TransmodelAPI to use a new RoutingService per request", "committedDate": "2020-02-17T09:09:31Z", "type": "commit"}, {"oid": "1c61d6751398254575ba759711803085a5990a6b", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1c61d6751398254575ba759711803085a5990a6b", "message": "Refactor the TransmodelAPI to use a new RoutingService per request", "committedDate": "2020-02-17T09:09:31Z", "type": "forcePushed"}, {"oid": "450693d96be83d096fd7456e6366e23c441f3f15", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/450693d96be83d096fd7456e6366e23c441f3f15", "message": "Change PlannerResource to use RoutingService", "committedDate": "2020-02-17T09:17:23Z", "type": "commit"}, {"oid": "09a8a3b39fd862f3d65d0d82d5e8fe66791d6ef3", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/09a8a3b39fd862f3d65d0d82d5e8fe66791d6ef3", "message": "Merge branch 'dev-2.x' into otp2_realtime_indexes", "committedDate": "2020-02-17T09:47:38Z", "type": "commit"}, {"oid": "e6a870d8e869350560dcfe17f655fed58263ddc8", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e6a870d8e869350560dcfe17f655fed58263ddc8", "message": "Fixed wrong argument type to AlertPathService", "committedDate": "2020-02-17T10:17:19Z", "type": "commit"}, {"oid": "afed058b8dc71c3b439ba17d5c54c98e6561e6cb", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/afed058b8dc71c3b439ba17d5c54c98e6561e6cb", "message": "Add Lombok and delegate RoutingService to Graph", "committedDate": "2020-02-17T11:47:11Z", "type": "commit"}, {"oid": "c2edfd0685a40e112f7454599a5191ca7060795f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c2edfd0685a40e112f7454599a5191ca7060795f", "message": "RoutingService delegates to both Graph and GraphIndex", "committedDate": "2020-02-17T11:58:50Z", "type": "commit"}, {"oid": "c2e532e0c764e45936403b058b82428277f0bb74", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c2e532e0c764e45936403b058b82428277f0bb74", "message": "Remove unused methods in Graph and GraphIndex", "committedDate": "2020-02-17T12:07:03Z", "type": "forcePushed"}, {"oid": "c2edfd0685a40e112f7454599a5191ca7060795f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c2edfd0685a40e112f7454599a5191ca7060795f", "message": "RoutingService delegates to both Graph and GraphIndex", "committedDate": "2020-02-17T11:58:50Z", "type": "forcePushed"}, {"oid": "c2edfd0685a40e112f7454599a5191ca7060795f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/c2edfd0685a40e112f7454599a5191ca7060795f", "message": "RoutingService delegates to both Graph and GraphIndex", "committedDate": "2020-02-17T11:58:50Z", "type": "forcePushed"}, {"oid": "6798cc7c70050616015ad4e30b3c543e6e8b1686", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/6798cc7c70050616015ad4e30b3c543e6e8b1686", "message": "Remove RoutingService graph getter, change ServiceDay constructor not to require graph", "committedDate": "2020-02-20T15:18:06Z", "type": "commit"}, {"oid": "af3dda1a11b7120cc39090cdbfbc8c6f1f918fae", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/af3dda1a11b7120cc39090cdbfbc8c6f1f918fae", "message": "Remove old GraphQL API", "committedDate": "2020-02-20T15:21:51Z", "type": "commit"}, {"oid": "e641eede078a2b29d800e93d9493dbf604225b08", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e641eede078a2b29d800e93d9493dbf604225b08", "message": "Removed unused method from RoutingService", "committedDate": "2020-02-20T15:24:51Z", "type": "commit"}, {"oid": "44010680daa9ef5d08aa8678fc68488a70b79468", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/44010680daa9ef5d08aa8678fc68488a70b79468", "message": "Removed unecessary timetableSnapshot parameters", "committedDate": "2020-02-20T15:27:22Z", "type": "commit"}, {"oid": "e022e482566acff4eb1dc843724e5d91295be179", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/e022e482566acff4eb1dc843724e5d91295be179", "message": "Merge branch 'dev-2.x' into otp2_realtime_indexes", "committedDate": "2020-02-21T11:34:04Z", "type": "commit"}]}