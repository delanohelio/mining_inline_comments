{"pr_number": 3238, "pr_title": "Otp2 fix SIRI timezones", "pr_createdAt": "2020-11-10T09:03:15Z", "pr_url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238", "timeline": [{"oid": "f1472d40a5fe21464ae4857f7b7710d15718fb48", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/f1472d40a5fe21464ae4857f7b7710d15718fb48", "message": "Move siri stoptime calculation to DateMapper and take graph timezone into account", "committedDate": "2020-11-06T13:46:36Z", "type": "commit"}, {"oid": "1a9a466725e39cd5f58696a93e511ee557036324", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/1a9a466725e39cd5f58696a93e511ee557036324", "message": "One more zone taken into account when fuzzy-matching realtime with planned data", "committedDate": "2020-11-09T12:43:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU3MzAyOA==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r520573028", "bodyText": "Could you add a comment on the above method on why we skip the noon - 12 hours calculation here. Comment:\n// In OTP LocalDate is sometimes used to represent ServiceDate. This calculation is \"safe\" because \n// calculations on LocalDate ignore TimeZone adjustments, just like the ServiceDate. So, in this case it is not \n// necessary to: 'NOON - 12 hours + secondsSinceStartOfDay'\n\nThis method would also be clearer if the variable names was serviceDate and serviceTimeInSeconds. To me the secondsSinceStartOfDay means midnight, which is not true given a time-zone and DST switch.", "author": "t2gran", "createdAt": "2020-11-10T13:46:34Z", "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java", "diffHunk": "@@ -33,4 +33,15 @@ public static int secondsSinceStartOfTime(ZonedDateTime startOfTime, Instant ins\n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n+", "originalCommit": "f1472d40a5fe21464ae4857f7b7710d15718fb48", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "23190a97e32907ad1a842aeacbc4b871c2d98495", "chunk": "diff --git a/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java b/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\nindex 66f40b448..04b1da44a 100644\n--- a/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\n+++ b/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\n\n@@ -31,17 +31,16 @@ public class DateMapper {\n     }\n \n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n+        // In OTP LocalDate is sometimes used to represent ServiceDate. This calculation is \"safe\" because\n+        // calculations on LocalDate ignore TimeZone adjustments, just like the ServiceDate. So, in this case it is not\n+        // necessary to: 'NOON - 12 hours + secondsSinceStartOfDay'\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n \n     public static int secondsSinceStartOfService(\n         ZonedDateTime departureDate, ZonedDateTime dateTime, ZoneId zoneId\n     ) {\n-        ZonedDateTime startOfService = asStartOfService(departureDate, zoneId);\n+        ZonedDateTime startOfService = asStartOfService(departureDate.toLocalDate(), zoneId);\n         return (int) Duration.between(startOfService, dateTime).toSeconds();\n     }\n-\n-    private static ZonedDateTime asStartOfService(ZonedDateTime dateTime, ZoneId zoneId) {\n-        return asStartOfService(dateTime.withZoneSameInstant(zoneId));\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0OTI1Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r520949253", "bodyText": "I do not think this is correct. I had to write a little test to verify it:\nZoneId fi = ZoneId.of(\"Europe/Helsinki\");\nZoneId no = ZoneId.of(\"Europe/Oslo\");\nZonedDateTime t0 = ZonedDateTime.of(2020, 11, 1, 0, 20, 0,0, fi);\nZonedDateTime t1 = ZonedDateTime.of(2020, 11, 1, 1, 20, 0,0, fi);\nSystem.out.println(TimeUtils.timeToStrShort(secondsSinceStartOfService(t0, t0, no)));\nSystem.out.println(TimeUtils.timeToStrShort(secondsSinceStartOfService(t1, t1, no)));\n$ 23:20\n$ 00:20\n\nThe Netex import uses the \"raw\" local date of the xsd:Date passed in as the service date. The SiriTimetableSnapshotSource seems to use the first estimated call and the \"raw\" date from that.\nOne problem here is that for input times with time-zone ahead of the graph timezone we may get negative time offset, assuming we use the \"raw\" date. The other option is to move the service date to the day before, but that is very confusing. So, I am in favor of using the \"raw\" date and then risk negative times.", "author": "t2gran", "createdAt": "2020-11-10T23:55:20Z", "path": "src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java", "diffHunk": "@@ -33,4 +33,15 @@ public static int secondsSinceStartOfTime(ZonedDateTime startOfTime, Instant ins\n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n+\n+    public static int secondsSinceStartOfService(\n+        ZonedDateTime departureDate, ZonedDateTime dateTime, ZoneId zoneId\n+    ) {\n+        ZonedDateTime startOfService = asStartOfService(departureDate, zoneId);\n+        return (int) Duration.between(startOfService, dateTime).toSeconds();\n+    }\n+\n+    private static ZonedDateTime asStartOfService(ZonedDateTime dateTime, ZoneId zoneId) {\n+        return asStartOfService(dateTime.withZoneSameInstant(zoneId));\n+    }", "originalCommit": "f1472d40a5fe21464ae4857f7b7710d15718fb48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk1MDY0Mw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r520950643", "bodyText": "Changing line 40 to will use the \"raw\" date:\nZonedDateTime startOfService = asStartOfService(departureDate.toLocalDate(), zoneId);\nThen the last method, line 44, can be deleted.", "author": "t2gran", "createdAt": "2020-11-10T23:59:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0OTI1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE1Mzk2Ng==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r521153966", "bodyText": "As I commented on #3234 currently one unit test fails depending on system timezone.\nFor offsets of GMT-1, UTC, GMT+xx the test passes (TZ=Etc/GMT\u00b1XX), e.g.\nTZ=Europe/Oslo LANG=C mvn -Dtest=SiriAlertsUpdateHandlerTest\\#testSiriSxUpdateForTrip test\n\nbut for offsets of GMT-12 to GMT-2 the test fails, e.g.\nTZ=Europe/Helsinki LANG=C mvn -Dtest=SiriAlertsUpdateHandlerTest\\#testSiriSxUpdateForTrip test\n\nAt least this suggested change is not enough to fix the unit test, but is it actually that unit test somehow misusing system locale instead of RT update code?", "author": "tvainika", "createdAt": "2020-11-11T06:58:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0OTI1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "23190a97e32907ad1a842aeacbc4b871c2d98495", "chunk": "diff --git a/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java b/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\nindex 66f40b448..04b1da44a 100644\n--- a/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\n+++ b/src/main/java/org/opentripplanner/routing/algorithm/raptor/transit/mappers/DateMapper.java\n\n@@ -31,17 +31,16 @@ public class DateMapper {\n     }\n \n     public static LocalDateTime asDateTime(LocalDate localDate, int secondsSinceStartOfDay) {\n+        // In OTP LocalDate is sometimes used to represent ServiceDate. This calculation is \"safe\" because\n+        // calculations on LocalDate ignore TimeZone adjustments, just like the ServiceDate. So, in this case it is not\n+        // necessary to: 'NOON - 12 hours + secondsSinceStartOfDay'\n         return localDate.atStartOfDay().plusSeconds(secondsSinceStartOfDay);\n     }\n \n     public static int secondsSinceStartOfService(\n         ZonedDateTime departureDate, ZonedDateTime dateTime, ZoneId zoneId\n     ) {\n-        ZonedDateTime startOfService = asStartOfService(departureDate, zoneId);\n+        ZonedDateTime startOfService = asStartOfService(departureDate.toLocalDate(), zoneId);\n         return (int) Duration.between(startOfService, dateTime).toSeconds();\n     }\n-\n-    private static ZonedDateTime asStartOfService(ZonedDateTime dateTime, ZoneId zoneId) {\n-        return asStartOfService(dateTime.withZoneSameInstant(zoneId));\n-    }\n }\n"}}, {"oid": "23190a97e32907ad1a842aeacbc4b871c2d98495", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/23190a97e32907ad1a842aeacbc4b871c2d98495", "message": "Changes based on comments", "committedDate": "2020-11-11T13:28:15Z", "type": "commit"}, {"oid": "768fe3e61e6a5c0109e3864174c51fd997012b4f", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/768fe3e61e6a5c0109e3864174c51fd997012b4f", "message": "Create a ScheduledIndex to store TripPatternsForDate", "committedDate": "2020-11-12T00:17:09Z", "type": "forcePushed"}, {"oid": "2430becb340864d695b6493909ce66028f8db563", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/2430becb340864d695b6493909ce66028f8db563", "message": "Update ServiceDate and deprecate all methods using the system TimeZone.", "committedDate": "2020-11-12T11:07:48Z", "type": "commit"}, {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a534ac2546944ec6921f2131ced5d9325e5dd2dd", "message": "Taking graph timezone into account when calculating alert validity", "committedDate": "2020-11-12T11:10:31Z", "type": "commit"}, {"oid": "a534ac2546944ec6921f2131ced5d9325e5dd2dd", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a534ac2546944ec6921f2131ced5d9325e5dd2dd", "message": "Taking graph timezone into account when calculating alert validity", "committedDate": "2020-11-12T11:10:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzNDc5Nw==", "url": "https://github.com/opentripplanner/OpenTripPlanner/pull/3238#discussion_r522034797", "bodyText": "I think you should pass in the graphTimezone here, not the graph.\nIf all you need is the \"salt\", why do you pass the \"dinner table\"?\n(Sorry for my bad humor ;-)", "author": "t2gran", "createdAt": "2020-11-12T11:26:20Z", "path": "src/ext/java/org/opentripplanner/ext/siri/SiriAlertsUpdateHandler.java", "diffHunk": "@@ -69,10 +65,13 @@\n \n     private final String feedId;\n \n+    private final Graph graph;\n+\n     private final Set<TransitAlert> alerts = new HashSet<>();\n \n-    public SiriAlertsUpdateHandler(String feedId) {\n+    public SiriAlertsUpdateHandler(String feedId, Graph graph) {", "originalCommit": "a534ac2546944ec6921f2131ced5d9325e5dd2dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a79a0cd2a25d4e5b17a6cf785dd6febddc4535b1", "url": "https://github.com/opentripplanner/OpenTripPlanner/commit/a79a0cd2a25d4e5b17a6cf785dd6febddc4535b1", "message": "Merge branch 'dev-2.x' into otp2_fix_realtime_timezones", "committedDate": "2020-11-12T14:55:36Z", "type": "commit"}]}