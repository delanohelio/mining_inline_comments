{"pr_number": 4517, "pr_title": "Show date from which statistics are counting", "pr_createdAt": "2020-10-10T12:47:37Z", "pr_url": "https://github.com/AntennaPod/AntennaPod/pull/4517", "timeline": [{"oid": "dbab71a96363e60eeb15fcb76d7f976336fa2266", "url": "https://github.com/AntennaPod/AntennaPod/commit/dbab71a96363e60eeb15fcb76d7f976336fa2266", "message": "add counting since to statistics", "committedDate": "2020-10-10T12:45:13Z", "type": "commit"}, {"oid": "2196362c2ada18c9b5cbbda80f70ec2d9600fd0c", "url": "https://github.com/AntennaPod/AntennaPod/commit/2196362c2ada18c9b5cbbda80f70ec2d9600fd0c", "message": "Localize text", "committedDate": "2020-10-15T16:19:14Z", "type": "commit"}, {"oid": "8893023d081cc67189b50e1e94c0ca233b5ff544", "url": "https://github.com/AntennaPod/AntennaPod/commit/8893023d081cc67189b50e1e94c0ca233b5ff544", "message": "use PreferenceUpgrader to check if app is on first run", "committedDate": "2020-10-21T16:14:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY2OTU3Nw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r509669577", "bodyText": "Please revert the unrelated change to keep the git history clean", "author": "ByteHamster", "createdAt": "2020-10-21T20:30:21Z", "path": "app/src/main/java/de/danoeh/antennapod/PodcastApp.java", "diffHunk": "@@ -12,6 +12,7 @@\n import de.danoeh.antennapod.activity.SplashActivity;\n import de.danoeh.antennapod.core.ApCoreEventBusIndex;\n import de.danoeh.antennapod.core.ClientConfig;\n+import de.danoeh.antennapod.core.preferences.UserPreferences;", "originalCommit": "8893023d081cc67189b50e1e94c0ca233b5ff544", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e00997bf64e49472a83068a16d364a714320689d", "chunk": "diff --git a/app/src/main/java/de/danoeh/antennapod/PodcastApp.java b/app/src/main/java/de/danoeh/antennapod/PodcastApp.java\nindex ed00a19d2..534d48479 100644\n--- a/app/src/main/java/de/danoeh/antennapod/PodcastApp.java\n+++ b/app/src/main/java/de/danoeh/antennapod/PodcastApp.java\n\n@@ -12,7 +12,6 @@ import com.joanzapata.iconify.fonts.MaterialModule;\n import de.danoeh.antennapod.activity.SplashActivity;\n import de.danoeh.antennapod.core.ApCoreEventBusIndex;\n import de.danoeh.antennapod.core.ClientConfig;\n-import de.danoeh.antennapod.core.preferences.UserPreferences;\n import de.danoeh.antennapod.error.CrashReportWriter;\n import de.danoeh.antennapod.error.RxJavaErrorHandlerSetup;\n import de.danoeh.antennapod.spa.SPAUtil;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3MDM5NA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r509670394", "bodyText": "Please add something like \"date\" to the name. It currently sounds like it returns the millis between today and the first install.", "author": "ByteHamster", "createdAt": "2020-10-21T20:31:43Z", "path": "core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java", "diffHunk": "@@ -1057,4 +1059,15 @@ public static void setFeedFilter(String value) {\n                 .apply();\n     }\n \n+    public static long getUsageCountingMillis() {", "originalCommit": "8893023d081cc67189b50e1e94c0ca233b5ff544", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e00997bf64e49472a83068a16d364a714320689d", "chunk": "diff --git a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\nindex f35d1b972..98c36567f 100644\n--- a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n+++ b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n\n@@ -1059,15 +1059,12 @@ public class UserPreferences {\n                 .apply();\n     }\n \n-    public static long getUsageCountingMillis() {\n+    public static long getUsageCountingDateMillis() {\n         return prefs.getLong(PREF_USAGE_COUNTING_DATE, -1);\n     }\n \n-    private static void setUsageCountingMillis(long value) {\n-        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE, value).apply();\n-    }\n-\n-    public static void resetUsageCounting() {\n-        setUsageCountingMillis(Calendar.getInstance().getTimeInMillis());\n+    public static void resetUsageCountingDate() {\n+        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE,\n+                Calendar.getInstance().getTimeInMillis()).apply();\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3Mjg2OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r509672868", "bodyText": "As a safeguard, could you please move this into the .subscribe lambda? If for whatever reason the database call fails, the date should not be reset. I do not think this will ever happen (or if it happens, users will not care) but it feels somehow more clean to only update after it is actually reset.", "author": "ByteHamster", "createdAt": "2020-10-21T20:35:31Z", "path": "app/src/main/java/de/danoeh/antennapod/fragment/preferences/PlaybackStatisticsFragment.java", "diffHunk": "@@ -156,6 +157,8 @@ private void doResetStatistics() {\n             disposable.dispose();\n         }\n \n+        UserPreferences.resetUsageCounting();", "originalCommit": "8893023d081cc67189b50e1e94c0ca233b5ff544", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e00997bf64e49472a83068a16d364a714320689d", "chunk": "diff --git a/app/src/main/java/de/danoeh/antennapod/fragment/preferences/PlaybackStatisticsFragment.java b/app/src/main/java/de/danoeh/antennapod/fragment/preferences/PlaybackStatisticsFragment.java\nindex 69a9d8c60..4819e0b94 100644\n--- a/app/src/main/java/de/danoeh/antennapod/fragment/preferences/PlaybackStatisticsFragment.java\n+++ b/app/src/main/java/de/danoeh/antennapod/fragment/preferences/PlaybackStatisticsFragment.java\n\n@@ -157,12 +157,13 @@ public class PlaybackStatisticsFragment extends Fragment {\n             disposable.dispose();\n         }\n \n-        UserPreferences.resetUsageCounting();\n-\n         disposable = Completable.fromFuture(DBWriter.resetStatistics())\n                 .subscribeOn(Schedulers.io())\n                 .observeOn(AndroidSchedulers.mainThread())\n-                .subscribe(this::refreshStatistics, error -> Log.e(TAG, Log.getStackTraceString(error)));\n+                .subscribe(() -> {\n+                    refreshStatistics();\n+                    UserPreferences.resetUsageCountingDate();\n+                }, error -> Log.e(TAG, Log.getStackTraceString(error)));\n     }\n \n     private void refreshStatistics() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3Mzc4OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r509673788", "bodyText": "Why is this \"if\" needed? I think the code should only be called on the very first install. We therefore know that the usage stats are not yet counting. Did I miss something?", "author": "ByteHamster", "createdAt": "2020-10-21T20:36:43Z", "path": "app/src/main/java/de/danoeh/antennapod/preferences/PreferenceUpgrader.java", "diffHunk": "@@ -34,6 +34,10 @@ public static void checkUpgrades(Context context) {\n \n     private static void upgrade(int oldVersion) {\n         if (oldVersion == -1) {\n+            //New installation\n+            if(UserPreferences.getUsageCountingMillis() < 0){", "originalCommit": "8893023d081cc67189b50e1e94c0ca233b5ff544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3MzQ4OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r510373488", "bodyText": "Yes this is not necessary, but just to be sure ;)", "author": "asdoi", "createdAt": "2020-10-22T18:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3Mzc4OA=="}], "type": "inlineReview", "revised_code": {"commit": "e00997bf64e49472a83068a16d364a714320689d", "chunk": "diff --git a/app/src/main/java/de/danoeh/antennapod/preferences/PreferenceUpgrader.java b/app/src/main/java/de/danoeh/antennapod/preferences/PreferenceUpgrader.java\nindex 219341c26..b174c2da4 100644\n--- a/app/src/main/java/de/danoeh/antennapod/preferences/PreferenceUpgrader.java\n+++ b/app/src/main/java/de/danoeh/antennapod/preferences/PreferenceUpgrader.java\n\n@@ -35,8 +35,8 @@ public class PreferenceUpgrader {\n     private static void upgrade(int oldVersion) {\n         if (oldVersion == -1) {\n             //New installation\n-            if(UserPreferences.getUsageCountingMillis() < 0){\n-                UserPreferences.resetUsageCounting();\n+            if(UserPreferences.getUsageCountingDateMillis() < 0){\n+                UserPreferences.resetUsageCountingDate();\n             }\n             return;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTY3NDcxMA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r509674710", "bodyText": "I would combine set/reset to a single method. Can't think of a case where we want to use set without reset.", "author": "ByteHamster", "createdAt": "2020-10-21T20:38:03Z", "path": "core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java", "diffHunk": "@@ -1057,4 +1059,15 @@ public static void setFeedFilter(String value) {\n                 .apply();\n     }\n \n+    public static long getUsageCountingMillis() {\n+        return prefs.getLong(PREF_USAGE_COUNTING_DATE, -1);\n+    }\n+\n+    private static void setUsageCountingMillis(long value) {", "originalCommit": "8893023d081cc67189b50e1e94c0ca233b5ff544", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e00997bf64e49472a83068a16d364a714320689d", "chunk": "diff --git a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\nindex f35d1b972..98c36567f 100644\n--- a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n+++ b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n\n@@ -1059,15 +1059,12 @@ public class UserPreferences {\n                 .apply();\n     }\n \n-    public static long getUsageCountingMillis() {\n+    public static long getUsageCountingDateMillis() {\n         return prefs.getLong(PREF_USAGE_COUNTING_DATE, -1);\n     }\n \n-    private static void setUsageCountingMillis(long value) {\n-        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE, value).apply();\n-    }\n-\n-    public static void resetUsageCounting() {\n-        setUsageCountingMillis(Calendar.getInstance().getTimeInMillis());\n+    public static void resetUsageCountingDate() {\n+        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE,\n+                Calendar.getInstance().getTimeInMillis()).apply();\n     }\n }\n"}}, {"oid": "e00997bf64e49472a83068a16d364a714320689d", "url": "https://github.com/AntennaPod/AntennaPod/commit/e00997bf64e49472a83068a16d364a714320689d", "message": "fix code", "committedDate": "2020-10-22T18:33:20Z", "type": "commit"}, {"oid": "82b3cbc319ff9b62b2311dbc3532f57e2664ea2f", "url": "https://github.com/AntennaPod/AntennaPod/commit/82b3cbc319ff9b62b2311dbc3532f57e2664ea2f", "message": "use formatAbbrev", "committedDate": "2020-10-22T18:43:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MzI3Nw==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r510453277", "bodyText": "This should also be called when a database is imported.", "author": "ByteHamster", "createdAt": "2020-10-22T20:59:00Z", "path": "core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java", "diffHunk": "@@ -1057,4 +1059,12 @@ public static void setFeedFilter(String value) {\n                 .apply();\n     }\n \n+    public static long getUsageCountingDateMillis() {\n+        return prefs.getLong(PREF_USAGE_COUNTING_DATE, -1);\n+    }\n+\n+    public static void resetUsageCountingDate() {", "originalCommit": "82b3cbc319ff9b62b2311dbc3532f57e2664ea2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkzMTA4OA==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r510931088", "bodyText": "Thank you. I forgot this, but should not be the date set to -1 (unset) because we do not know the date the new statistics were counted since?", "author": "asdoi", "createdAt": "2020-10-23T14:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MzI3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk5MjMzNg==", "url": "https://github.com/AntennaPod/AntennaPod/pull/4517#discussion_r510992336", "bodyText": "Oh, right. Sorry.", "author": "ByteHamster", "createdAt": "2020-10-23T16:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ1MzI3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b7ea64d90296d69096d7f61e9187fb044d68d600", "chunk": "diff --git a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\nindex 98c36567f..bcf73bfea 100644\n--- a/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n+++ b/core/src/main/java/de/danoeh/antennapod/core/preferences/UserPreferences.java\n\n@@ -1063,8 +1062,15 @@ public class UserPreferences {\n         return prefs.getLong(PREF_USAGE_COUNTING_DATE, -1);\n     }\n \n+    private static void setUsageCountingDateMillis(long value) {\n+        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE, value).apply();\n+    }\n+\n     public static void resetUsageCountingDate() {\n-        prefs.edit().putLong(PREF_USAGE_COUNTING_DATE,\n-                Calendar.getInstance().getTimeInMillis()).apply();\n+        setUsageCountingDateMillis(Calendar.getInstance().getTimeInMillis());\n+    }\n+\n+    public static void unsetUsageCountingDate() {\n+        setUsageCountingDateMillis(-1);\n     }\n }\n"}}, {"oid": "b7ea64d90296d69096d7f61e9187fb044d68d600", "url": "https://github.com/AntennaPod/AntennaPod/commit/b7ea64d90296d69096d7f61e9187fb044d68d600", "message": "unset usage counting", "committedDate": "2020-10-24T20:26:41Z", "type": "commit"}, {"oid": "0cab7fc3902198abf7d5c1ed2819bbec745e12e9", "url": "https://github.com/AntennaPod/AntennaPod/commit/0cab7fc3902198abf7d5c1ed2819bbec745e12e9", "message": "fix checkstyle", "committedDate": "2020-10-24T20:30:57Z", "type": "commit"}]}