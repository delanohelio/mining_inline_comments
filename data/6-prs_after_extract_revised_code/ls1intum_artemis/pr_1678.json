{"pr_number": 1678, "pr_title": "[Exam] Generate student exams", "pr_createdAt": "2020-06-18T17:54:23Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1678", "timeline": [{"oid": "b8d828a5d4fa82f24184c4ebbb4719e245eb3bc9", "url": "https://github.com/ls1intum/Artemis/commit/b8d828a5d4fa82f24184c4ebbb4719e245eb3bc9", "message": "add REST call stub", "committedDate": "2020-06-18T13:10:46Z", "type": "commit"}, {"oid": "b8fb579a49d5673970c73728d9ffd3d0664f3aa0", "url": "https://github.com/ls1intum/Artemis/commit/b8fb579a49d5673970c73728d9ffd3d0664f3aa0", "message": "first (simplified) verison of the random assignment", "committedDate": "2020-06-18T13:37:17Z", "type": "commit"}, {"oid": "ac2350bdcc66d71a4732206b61bab106b0a7e651", "url": "https://github.com/ls1intum/Artemis/commit/ac2350bdcc66d71a4732206b61bab106b0a7e651", "message": "add test and fix errors in random generation algorithm", "committedDate": "2020-06-18T14:21:20Z", "type": "commit"}, {"oid": "9e541113e56444640f7e6798e79856973fec196a", "url": "https://github.com/ls1intum/Artemis/commit/9e541113e56444640f7e6798e79856973fec196a", "message": "move logic into service", "committedDate": "2020-06-18T14:25:08Z", "type": "commit"}, {"oid": "39dda8372bc7027aa5f90bb4f09fa9514a3e7967", "url": "https://github.com/ls1intum/Artemis/commit/39dda8372bc7027aa5f90bb4f09fa9514a3e7967", "message": "fix cycles", "committedDate": "2020-06-18T14:29:46Z", "type": "commit"}, {"oid": "14fd6149418731535e72b4674a7b0ff3f65e82ea", "url": "https://github.com/ls1intum/Artemis/commit/14fd6149418731535e72b4674a7b0ff3f65e82ea", "message": "Implement \"Generate student exams\" functionality", "committedDate": "2020-06-18T15:18:30Z", "type": "commit"}, {"oid": "f991447ff3c513068e492e68871c9efab6c6f8be", "url": "https://github.com/ls1intum/Artemis/commit/f991447ff3c513068e492e68871c9efab6c6f8be", "message": "Show error messages", "committedDate": "2020-06-18T16:25:14Z", "type": "commit"}, {"oid": "98f3ee048ecc67cc8825f09d54840cc55e5650df", "url": "https://github.com/ls1intum/Artemis/commit/98f3ee048ecc67cc8825f09d54840cc55e5650df", "message": "Delete existing student exams on re-generate", "committedDate": "2020-06-18T17:30:48Z", "type": "commit"}, {"oid": "09abf20b9de59bc2ac44bdc6f997718a7aad29ab", "url": "https://github.com/ls1intum/Artemis/commit/09abf20b9de59bc2ac44bdc6f997718a7aad29ab", "message": "Fix that undefined is returned", "committedDate": "2020-06-18T17:43:44Z", "type": "commit"}, {"oid": "81e835acf7119debfe41c1c42f472cc86fc3b3a4", "url": "https://github.com/ls1intum/Artemis/commit/81e835acf7119debfe41c1c42f472cc86fc3b3a4", "message": "Check that all exercise groups have an exam", "committedDate": "2020-06-18T17:58:28Z", "type": "commit"}, {"oid": "29e112860a8e9c41c5a99aac503aa94e1e08cd49", "url": "https://github.com/ls1intum/Artemis/commit/29e112860a8e9c41c5a99aac503aa94e1e08cd49", "message": "Ensure that numberOfExercisesInExam is equal to the actual number of exercises added to all generated student exams", "committedDate": "2020-06-18T19:05:00Z", "type": "commit"}, {"oid": "280e53357491b0e859f51ef9f0392ee25314c385", "url": "https://github.com/ls1intum/Artemis/commit/280e53357491b0e859f51ef9f0392ee25314c385", "message": "Fix testDeleteExamThatDoesNotExist", "committedDate": "2020-06-18T19:09:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MTQ2Ng==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442481466", "bodyText": "I like that you explicitly assign this, it helps with understanding what you are doing here. I would suggest to copy the whole array instead of just referencing it. This way no one will use a modified mandatoryIndices in the future.", "author": "JonasPetry", "createdAt": "2020-06-18T20:22:39Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ExamService.java", "diffHunk": "@@ -115,4 +140,163 @@ public void delete(Long examId) {\n     public Set<Exam> filterVisibleExams(Set<Exam> exams) {\n         return exams.stream().filter(Exam::isVisibleToStudents).collect(Collectors.toSet());\n     }\n+\n+    /**\n+     * Generates the student exams randomly based on the exam configuration and the exercise groups\n+     *\n+     * @param examId        the id of the exam\n+     * @return the list of student exams with their corresponding users\n+     */\n+    public List<StudentExam> generateStudentExams(Long examId) {\n+        List<StudentExam> studentExams = new ArrayList<>();\n+        SecureRandom random = new SecureRandom();\n+\n+        // Delete all existing student exams via orphan removal\n+        Exam examWithExistingStudentExams = examRepository.findWithStudentExamsById(examId).get();\n+        studentExamRepository.deleteInBatch(examWithExistingStudentExams.getStudentExams());\n+\n+        Exam exam = examRepository.findWithExercisesRegisteredUsersStudentExamsById(examId).get();\n+\n+        // Ensure that all exercise groups have at least one exercise\n+        for (ExerciseGroup exerciseGroup : exam.getExerciseGroups()) {\n+            if (exerciseGroup.getExercises().isEmpty()) {\n+                throw new BadRequestAlertException(\"All exercise groups must have at least one exercise\", \"Exam\", \"artemisApp.exam.validation.atLeastOneExercisePerExerciseGroup\");\n+            }\n+        }\n+\n+        // Check that numberOfExercisesInExam is set\n+        if (exam.getNumberOfExercisesInExam() == null) {\n+            throw new BadRequestAlertException(\"The number of exercises in the exam is not set.\", \"Exam\", \"artemisApp.exam.validation.numberOfExercisesInExamNotSet\");\n+        }\n+\n+        // Prepare indices of mandatory and optional exercise groups to preserve order of exercise groups\n+        List<Integer> indicesOfMandatoryExerciseGroups = new ArrayList<>();\n+        List<Integer> indicesOfOptionalExerciseGroups = new ArrayList<>();\n+        for (int i = 0; i < exam.getExerciseGroups().size(); i++) {\n+            if (Boolean.TRUE.equals(exam.getExerciseGroups().get(i).getIsMandatory())) {\n+                indicesOfMandatoryExerciseGroups.add(i);\n+            }\n+            else {\n+                indicesOfOptionalExerciseGroups.add(i);\n+            }\n+        }\n+\n+        List<ExerciseGroup> exerciseGroups = exam.getExerciseGroups();\n+\n+        // Check that there are enough exercise groups\n+        if (exerciseGroups.size() < exam.getNumberOfExercisesInExam()) {\n+            throw new BadRequestAlertException(\"The number of exercise groups is too small\", \"Exam\", \"artemisApp.exam.validation.tooFewExerciseGroups\");\n+        }\n+\n+        long numberOfOptionalExercises = exam.getNumberOfExercisesInExam() - exerciseGroups.stream().filter(ExerciseGroup::getIsMandatory).count();\n+\n+        // Check that there are not too much mandatory exercise groups\n+        if (numberOfOptionalExercises < 0) {\n+            throw new BadRequestAlertException(\"The number of mandatory exercise groups is too large\", \"Exam\", \"artemisApp.exam.validation.tooManyMandatoryExerciseGroups\");\n+        }\n+\n+        for (User registeredUser : exam.getRegisteredUsers()) {\n+            // Create one student exam per user\n+            StudentExam studentExam = new StudentExam();\n+            studentExam.setExam(exam);\n+            studentExam.setUser(registeredUser);\n+\n+            // Select exercises from exercise groups randomly\n+            List<Integer> assembledIndices = assembleIndicesListWithRandomSelection(indicesOfMandatoryExerciseGroups, indicesOfOptionalExerciseGroups, numberOfOptionalExercises);\n+            for (int i = 0; i < exam.getExerciseGroups().size(); i++) {\n+                if (assembledIndices.contains(i)) {\n+                    // we get one random exercise from all preselected exercise groups\n+                    studentExam.addExercise(selectRandomExercise(random, exam.getExerciseGroups().get(i)));\n+                }\n+            }\n+\n+            // Apply random exercise order\n+            if (Boolean.TRUE.equals(exam.getRandomizeExerciseOrder())) {\n+                Collections.shuffle(studentExam.getExercises());\n+            }\n+\n+            studentExams.add(studentExam);\n+        }\n+\n+        studentExams = studentExamRepository.saveAll(studentExams);\n+\n+        // TODO: make sure the student exams still contain non proxy users\n+\n+        return studentExams;\n+    }\n+\n+    /**\n+     * Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId      the id of the course\n+     * @param examId        the id of the exam\n+     * @param studentDtos   the list of students (with at least registration number) who should get access to the exam\n+     * @return the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    public List<StudentDTO> registerStudentsForExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        var course = courseService.findOne(courseId);\n+        var exam = findOneWithRegisteredUsers(examId);\n+        List<StudentDTO> notFoundStudentsDtos = new ArrayList<>();\n+        for (var studentDto : studentDtos) {\n+            var registrationNumber = studentDto.getRegistrationNumber();\n+            try {\n+                // 1) we use the registration number and try to find the student in the Artemis user database\n+                Optional<User> optionalStudent = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    // we only need to add the student to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                    if (!student.getGroups().contains(course.getStudentGroupName())) {\n+                        userService.addUserToGroup(student, course.getStudentGroupName());\n+                    }\n+                    exam.addUser(student);\n+                    continue;\n+                }\n+                // 2) if we cannot find the student, we use the registration number and try to find the student in the (TUM) LDAP, create it in the Artemis DB and in a potential\n+                // external user management system\n+                optionalStudent = userService.createUserFromLdap(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    // the newly created student needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                    userService.addUserToGroup(student, course.getStudentGroupName());\n+                    exam.addUser(student);\n+                    continue;\n+                }\n+                // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+                log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            }\n+            catch (Exception ex) {\n+                log.warn(\"Error while processing user with registration number \" + registrationNumber + \": \" + ex.getMessage(), ex);\n+            }\n+\n+            notFoundStudentsDtos.add(studentDto);\n+        }\n+        examRepository.save(exam);\n+        return notFoundStudentsDtos;\n+    }\n+\n+    private List<Integer> assembleIndicesListWithRandomSelection(List<Integer> mandatoryIndices, List<Integer> optionalIndices, Long numberOfOptionalExercises) {\n+        // Add all mandatory indices\n+        List<Integer> indices = mandatoryIndices;", "originalCommit": "280e53357491b0e859f51ef9f0392ee25314c385", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4NzcwNg==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442487706", "bodyText": "Thanks for the comment! I've applied it here: c1b337e", "author": "sascha11110", "createdAt": "2020-06-18T20:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4MTQ2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c1b337e9fb26fccaef7ddc1e1e800c86ccefd4e9", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\nindex f22e3d2cd..54d4786eb 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n\n@@ -169,18 +169,6 @@ public class ExamService {\n             throw new BadRequestAlertException(\"The number of exercises in the exam is not set.\", \"Exam\", \"artemisApp.exam.validation.numberOfExercisesInExamNotSet\");\n         }\n \n-        // Prepare indices of mandatory and optional exercise groups to preserve order of exercise groups\n-        List<Integer> indicesOfMandatoryExerciseGroups = new ArrayList<>();\n-        List<Integer> indicesOfOptionalExerciseGroups = new ArrayList<>();\n-        for (int i = 0; i < exam.getExerciseGroups().size(); i++) {\n-            if (Boolean.TRUE.equals(exam.getExerciseGroups().get(i).getIsMandatory())) {\n-                indicesOfMandatoryExerciseGroups.add(i);\n-            }\n-            else {\n-                indicesOfOptionalExerciseGroups.add(i);\n-            }\n-        }\n-\n         List<ExerciseGroup> exerciseGroups = exam.getExerciseGroups();\n \n         // Check that there are enough exercise groups\n"}}, {"oid": "c1b337e9fb26fccaef7ddc1e1e800c86ccefd4e9", "url": "https://github.com/ls1intum/Artemis/commit/c1b337e9fb26fccaef7ddc1e1e800c86ccefd4e9", "message": "Improve code readability", "committedDate": "2020-06-18T20:27:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4OTY1OQ==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442489659", "bodyText": "Do we really need this to be a long?", "author": "JonasPetry", "createdAt": "2020-06-18T20:39:50Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ExamService.java", "diffHunk": "@@ -115,4 +140,161 @@ public void delete(Long examId) {\n     public Set<Exam> filterVisibleExams(Set<Exam> exams) {\n         return exams.stream().filter(Exam::isVisibleToStudents).collect(Collectors.toSet());\n     }\n+\n+    /**\n+     * Generates the student exams randomly based on the exam configuration and the exercise groups\n+     *\n+     * @param examId        the id of the exam\n+     * @return the list of student exams with their corresponding users\n+     */\n+    public List<StudentExam> generateStudentExams(Long examId) {\n+        List<StudentExam> studentExams = new ArrayList<>();\n+        SecureRandom random = new SecureRandom();\n+\n+        // Delete all existing student exams via orphan removal\n+        Exam examWithExistingStudentExams = examRepository.findWithStudentExamsById(examId).get();\n+        studentExamRepository.deleteInBatch(examWithExistingStudentExams.getStudentExams());\n+\n+        Exam exam = examRepository.findWithExercisesRegisteredUsersStudentExamsById(examId).get();\n+\n+        // Ensure that all exercise groups have at least one exercise\n+        for (ExerciseGroup exerciseGroup : exam.getExerciseGroups()) {\n+            if (exerciseGroup.getExercises().isEmpty()) {\n+                throw new BadRequestAlertException(\"All exercise groups must have at least one exercise\", \"Exam\", \"artemisApp.exam.validation.atLeastOneExercisePerExerciseGroup\");\n+            }\n+        }\n+\n+        // Check that numberOfExercisesInExam is set\n+        if (exam.getNumberOfExercisesInExam() == null) {\n+            throw new BadRequestAlertException(\"The number of exercises in the exam is not set.\", \"Exam\", \"artemisApp.exam.validation.numberOfExercisesInExamNotSet\");\n+        }\n+\n+        List<ExerciseGroup> exerciseGroups = exam.getExerciseGroups();\n+\n+        // Check that there are enough exercise groups\n+        if (exerciseGroups.size() < exam.getNumberOfExercisesInExam()) {\n+            throw new BadRequestAlertException(\"The number of exercise groups is too small\", \"Exam\", \"artemisApp.exam.validation.tooFewExerciseGroups\");\n+        }\n+\n+        long numberOfOptionalExercises = exam.getNumberOfExercisesInExam() - exerciseGroups.stream().filter(ExerciseGroup::getIsMandatory).count();", "originalCommit": "c1b337e9fb26fccaef7ddc1e1e800c86ccefd4e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5MDM2OA==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442490368", "bodyText": "stream.count() returns a long, and I did not want to cast this to an int.\nI don't think it makes a difference", "author": "krusche", "createdAt": "2020-06-18T20:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4OTY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5ODAwMw==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442498003", "bodyText": "The implementation of count() for Java streams returns a long :-)", "author": "sascha11110", "createdAt": "2020-06-18T20:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4OTY1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "92df128e2ff65a9b2309ae9d663ddd9a8be2b791", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\nindex 54d4786eb..21908f4e8 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n\n@@ -287,7 +287,7 @@ public class ExamService {\n             indices = Stream.concat(indices.stream(), optionalIndices.stream().limit(numberOfOptionalExercises)).collect(Collectors.toList());\n         }\n \n-        // Sort the indices\n+        // Sort the indices to preserve the original order\n         Collections.sort(indices);\n         return indices;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5MjAwMw==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442492003", "bodyText": "Please clarify why you sort the indices.", "author": "JonasPetry", "createdAt": "2020-06-18T20:44:49Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ExamService.java", "diffHunk": "@@ -115,4 +140,161 @@ public void delete(Long examId) {\n     public Set<Exam> filterVisibleExams(Set<Exam> exams) {\n         return exams.stream().filter(Exam::isVisibleToStudents).collect(Collectors.toSet());\n     }\n+\n+    /**\n+     * Generates the student exams randomly based on the exam configuration and the exercise groups\n+     *\n+     * @param examId        the id of the exam\n+     * @return the list of student exams with their corresponding users\n+     */\n+    public List<StudentExam> generateStudentExams(Long examId) {\n+        List<StudentExam> studentExams = new ArrayList<>();\n+        SecureRandom random = new SecureRandom();\n+\n+        // Delete all existing student exams via orphan removal\n+        Exam examWithExistingStudentExams = examRepository.findWithStudentExamsById(examId).get();\n+        studentExamRepository.deleteInBatch(examWithExistingStudentExams.getStudentExams());\n+\n+        Exam exam = examRepository.findWithExercisesRegisteredUsersStudentExamsById(examId).get();\n+\n+        // Ensure that all exercise groups have at least one exercise\n+        for (ExerciseGroup exerciseGroup : exam.getExerciseGroups()) {\n+            if (exerciseGroup.getExercises().isEmpty()) {\n+                throw new BadRequestAlertException(\"All exercise groups must have at least one exercise\", \"Exam\", \"artemisApp.exam.validation.atLeastOneExercisePerExerciseGroup\");\n+            }\n+        }\n+\n+        // Check that numberOfExercisesInExam is set\n+        if (exam.getNumberOfExercisesInExam() == null) {\n+            throw new BadRequestAlertException(\"The number of exercises in the exam is not set.\", \"Exam\", \"artemisApp.exam.validation.numberOfExercisesInExamNotSet\");\n+        }\n+\n+        List<ExerciseGroup> exerciseGroups = exam.getExerciseGroups();\n+\n+        // Check that there are enough exercise groups\n+        if (exerciseGroups.size() < exam.getNumberOfExercisesInExam()) {\n+            throw new BadRequestAlertException(\"The number of exercise groups is too small\", \"Exam\", \"artemisApp.exam.validation.tooFewExerciseGroups\");\n+        }\n+\n+        long numberOfOptionalExercises = exam.getNumberOfExercisesInExam() - exerciseGroups.stream().filter(ExerciseGroup::getIsMandatory).count();\n+\n+        // Check that there are not too much mandatory exercise groups\n+        if (numberOfOptionalExercises < 0) {\n+            throw new BadRequestAlertException(\"The number of mandatory exercise groups is too large\", \"Exam\", \"artemisApp.exam.validation.tooManyMandatoryExerciseGroups\");\n+        }\n+\n+        // Prepare indices of mandatory and optional exercise groups to preserve order of exercise groups\n+        List<Integer> indicesOfMandatoryExerciseGroups = new ArrayList<>();\n+        List<Integer> indicesOfOptionalExerciseGroups = new ArrayList<>();\n+        for (int i = 0; i < exam.getExerciseGroups().size(); i++) {\n+            if (Boolean.TRUE.equals(exam.getExerciseGroups().get(i).getIsMandatory())) {\n+                indicesOfMandatoryExerciseGroups.add(i);\n+            }\n+            else {\n+                indicesOfOptionalExerciseGroups.add(i);\n+            }\n+        }\n+\n+        for (User registeredUser : exam.getRegisteredUsers()) {\n+            // Create one student exam per user\n+            StudentExam studentExam = new StudentExam();\n+            studentExam.setExam(exam);\n+            studentExam.setUser(registeredUser);\n+\n+            // Add a random exercise for each exercise group if the index of the exercise group is in assembledIndices\n+            List<Integer> assembledIndices = assembleIndicesListWithRandomSelection(indicesOfMandatoryExerciseGroups, indicesOfOptionalExerciseGroups, numberOfOptionalExercises);\n+            for (Integer index : assembledIndices) {\n+                // we get one random exercise from all preselected exercise groups\n+                studentExam.addExercise(selectRandomExercise(random, exerciseGroups.get(index)));\n+            }\n+\n+            // Apply random exercise order\n+            if (Boolean.TRUE.equals(exam.getRandomizeExerciseOrder())) {\n+                Collections.shuffle(studentExam.getExercises());\n+            }\n+\n+            studentExams.add(studentExam);\n+        }\n+\n+        studentExams = studentExamRepository.saveAll(studentExams);\n+\n+        // TODO: make sure the student exams still contain non proxy users\n+\n+        return studentExams;\n+    }\n+\n+    /**\n+     * Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId      the id of the course\n+     * @param examId        the id of the exam\n+     * @param studentDtos   the list of students (with at least registration number) who should get access to the exam\n+     * @return the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    public List<StudentDTO> registerStudentsForExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        var course = courseService.findOne(courseId);\n+        var exam = findOneWithRegisteredUsers(examId);\n+        List<StudentDTO> notFoundStudentsDtos = new ArrayList<>();\n+        for (var studentDto : studentDtos) {\n+            var registrationNumber = studentDto.getRegistrationNumber();\n+            try {\n+                // 1) we use the registration number and try to find the student in the Artemis user database\n+                Optional<User> optionalStudent = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    // we only need to add the student to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                    if (!student.getGroups().contains(course.getStudentGroupName())) {\n+                        userService.addUserToGroup(student, course.getStudentGroupName());\n+                    }\n+                    exam.addUser(student);\n+                    continue;\n+                }\n+                // 2) if we cannot find the student, we use the registration number and try to find the student in the (TUM) LDAP, create it in the Artemis DB and in a potential\n+                // external user management system\n+                optionalStudent = userService.createUserFromLdap(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    // the newly created student needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                    userService.addUserToGroup(student, course.getStudentGroupName());\n+                    exam.addUser(student);\n+                    continue;\n+                }\n+                // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+                log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            }\n+            catch (Exception ex) {\n+                log.warn(\"Error while processing user with registration number \" + registrationNumber + \": \" + ex.getMessage(), ex);\n+            }\n+\n+            notFoundStudentsDtos.add(studentDto);\n+        }\n+        examRepository.save(exam);\n+        return notFoundStudentsDtos;\n+    }\n+\n+    private List<Integer> assembleIndicesListWithRandomSelection(List<Integer> mandatoryIndices, List<Integer> optionalIndices, Long numberOfOptionalExercises) {\n+        // Add all mandatory indices\n+        List<Integer> indices = new ArrayList<>(mandatoryIndices);\n+\n+        // Add as many optional indices as numberOfOptionalExercises\n+        if (numberOfOptionalExercises > 0) {\n+            Collections.shuffle(optionalIndices);\n+            indices = Stream.concat(indices.stream(), optionalIndices.stream().limit(numberOfOptionalExercises)).collect(Collectors.toList());\n+        }\n+\n+        // Sort the indices", "originalCommit": "c1b337e9fb26fccaef7ddc1e1e800c86ccefd4e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5Nzc2Nw==", "url": "https://github.com/ls1intum/Artemis/pull/1678#discussion_r442497767", "bodyText": "92df128", "author": "sascha11110", "createdAt": "2020-06-18T20:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5MjAwMw=="}], "type": "inlineReview", "revised_code": {"commit": "92df128e2ff65a9b2309ae9d663ddd9a8be2b791", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\nindex 54d4786eb..21908f4e8 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/ExamService.java\n\n@@ -287,7 +287,7 @@ public class ExamService {\n             indices = Stream.concat(indices.stream(), optionalIndices.stream().limit(numberOfOptionalExercises)).collect(Collectors.toList());\n         }\n \n-        // Sort the indices\n+        // Sort the indices to preserve the original order\n         Collections.sort(indices);\n         return indices;\n     }\n"}}, {"oid": "92df128e2ff65a9b2309ae9d663ddd9a8be2b791", "url": "https://github.com/ls1intum/Artemis/commit/92df128e2ff65a9b2309ae9d663ddd9a8be2b791", "message": "Enhance comment", "committedDate": "2020-06-18T20:46:15Z", "type": "commit"}, {"oid": "dc53e5211fd789bf12b09197549cbaab0d901c6d", "url": "https://github.com/ls1intum/Artemis/commit/dc53e5211fd789bf12b09197549cbaab0d901c6d", "message": "Merge branch 'develop' into feature/generate-student-exams", "committedDate": "2020-06-18T20:51:29Z", "type": "commit"}, {"oid": "568448d97a26ebbfb069ec76a6f3da46aaa8edb9", "url": "https://github.com/ls1intum/Artemis/commit/568448d97a26ebbfb069ec76a6f3da46aaa8edb9", "message": "Update src/main/webapp/i18n/de/exam.json\n\nCo-authored-by: Jonas Petry <51994246+JonasPetry@users.noreply.github.com>", "committedDate": "2020-06-18T20:57:12Z", "type": "commit"}, {"oid": "4aa5dcfac8a119720d909092c261b93980d8634c", "url": "https://github.com/ls1intum/Artemis/commit/4aa5dcfac8a119720d909092c261b93980d8634c", "message": "Merge branch 'develop' into feature/generate-student-exams", "committedDate": "2020-06-18T21:08:42Z", "type": "commit"}]}