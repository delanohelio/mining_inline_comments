{"pr_number": 1652, "pr_title": "Server side implementation to register students in exams", "pr_createdAt": "2020-06-14T21:06:27Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1652", "timeline": [{"oid": "8e7bd1177a25edcc33f38ff0a0de7a4d876de001", "url": "https://github.com/ls1intum/Artemis/commit/8e7bd1177a25edcc33f38ff0a0de7a4d876de001", "message": "server implementation for registration of students in an exam", "committedDate": "2020-06-14T19:54:28Z", "type": "commit"}, {"oid": "d934a7aae52e9924cf615127bd004cafe66ef6d3", "url": "https://github.com/ls1intum/Artemis/commit/d934a7aae52e9924cf615127bd004cafe66ef6d3", "message": "Merge branch 'develop' into exam/management/register-students\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/repository/ExamRepository.java\n#\tsrc/main/java/de/tum/in/www1/artemis/service/ExamService.java\n#\tsrc/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n#\tsrc/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java", "committedDate": "2020-06-14T20:54:51Z", "type": "commit"}, {"oid": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "url": "https://github.com/ls1intum/Artemis/commit/2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "message": "Merge branch 'develop' into exam/management/register-students", "committedDate": "2020-06-14T21:23:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTUxMw==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869513", "bodyText": "Why removing the TODO?\nThe length of the method won't go away.", "author": "julian-christl", "createdAt": "2020-06-14T21:31:29Z", "path": "src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public User getOrCreateUser(Authentication authentication, String firstName, Str\n         return getOrCreateUser(authentication, skipPasswordCheck);\n     }\n \n-    // TODO this method is way too long, split it up", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMTM4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440321382", "bodyText": "I think the length is ok and we have more important TODOs ;-)\nI now refactored it because some parts were a bit confusing", "author": "krusche", "createdAt": "2020-06-15T17:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTUxMw=="}], "type": "inlineReview", "revised_code": {"commit": "032e6727612850457185e520fc90640188a168bd", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java b/src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java\nindex 5568466ae4..a2bee6d208 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/connectors/jira/JiraAuthenticationProvider.java\n\n@@ -120,7 +113,6 @@ public class JiraAuthenticationProvider extends ArtemisAuthenticationProviderImp\n         return getOrCreateUser(authentication, skipPasswordCheck);\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n     private User getOrCreateUser(Authentication authentication, Boolean skipPasswordCheck) {\n         String username = authentication.getName().toLowerCase();\n         String password = authentication.getCredentials().toString();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTY1MA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869650", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String TUM_LDAP_MATRIKEL_NUMBER = \"imMatrikelNr\";\n          \n          \n            \n                public static final String TUM_LDAP_REGISTRATION_NUMBER = \"imMatrikelNr\";\n          \n      \n    \n    \n  \n\nSince you use the term \"registration number\" for all your attributes I think it would make sense to use it here too.", "author": "julian-christl", "createdAt": "2020-06-14T21:33:04Z", "path": "src/main/java/de/tum/in/www1/artemis/config/Constants.java", "diffHunk": "@@ -71,6 +71,8 @@\n \n     public static final Pattern TITLE_NAME_PATTERN = Pattern.compile(\"^[a-zA-Z0-9_\\\\-\\\\s]*\");\n \n+    public static final String TUM_LDAP_MATRIKEL_NUMBER = \"imMatrikelNr\";", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMDg0Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440320842", "bodyText": "It's just a constant and in the context of the LDAP it's called Matrikel number. It think this is fine.", "author": "krusche", "createdAt": "2020-06-15T17:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTY1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTg4Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439869882", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "author": "julian-christl", "createdAt": "2020-06-14T21:35:54Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNjI4NQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440326285", "bodyText": "Thanks for noticing it, I am not really sure if conflict is correct here, but to be consistent I changed it accordingly", "author": "krusche", "createdAt": "2020-06-15T17:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2OTg4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDA2MA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870060", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "author": "julian-christl", "createdAt": "2020-06-14T21:38:08Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5Nzg4MA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440397880", "bodyText": "done", "author": "krusche", "createdAt": "2020-06-15T19:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDA2MA=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDE2OA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870168", "bodyText": "If I see this correctly if the user is not part of the exam but has access to the course there will still be a HTTP 200, right? I think that should either be a HTTP 404 or HTTP 409 as well in that case.", "author": "julian-christl", "createdAt": "2020-06-14T21:39:52Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.removeUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyMzA4NQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440323085", "bodyText": "Why should this be a problem? I guess this is fine, because then the request worked. This call should be used when the instructor clicks on Remove in the mockups for one user. This does not automatically remove the user from the course.\nIt could be the case that students are registered for a course, but not for an exam.\nWhat we actually need on the other hand is that students who are added to the exam, also have access to the course. I will add this above.", "author": "krusche", "createdAt": "2020-06-15T17:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDE2OA=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDI2NA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439870264", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return forbidden();\n          \n          \n            \n                        return conflict();\n          \n      \n    \n    \n  \n\nWe introduced a new HTTP status earlier this weekend I think it would fit here.", "author": "julian-christl", "createdAt": "2020-06-14T21:40:44Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNjMzMA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440326330", "bodyText": "Thanks for noticing it, I am not really sure if conflict is correct here, but to be consistent I changed it accordingly", "author": "krusche", "createdAt": "2020-06-15T17:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MDI2NA=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MTcyNg==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439871726", "bodyText": "Could this be an improvement? I think you can cut the for loop there and improve the performance through intelligend Database queries instead of tackeling this one by one.\nDon't know for sure though. Would be interesting what you think.\nKeep in mind this was only written in Github not with a proper IDE and I invented some \"multiple count\"-variations of already existing methods were I thought it would help the performance. This is not a safe and finished code.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<StudentDTO> notFoundStudents = new ArrayList<>();\n          \n          \n            \n                    for (var student : students) {\n          \n          \n            \n                        var registrationNumber = student.getRegistrationNumber();\n          \n          \n            \n                        // 1) we use the registration number and try to find the student in the Artemis user database\n          \n          \n            \n                        Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n          \n          \n            \n                        if (user.isPresent()) {\n          \n          \n            \n                            exam.addUser(user.get());\n          \n          \n            \n                            // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n          \n          \n            \n                            if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n          \n          \n            \n                                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n          \n          \n            \n                            }\n          \n          \n            \n                            continue;\n          \n          \n            \n                        }\n          \n          \n            \n                        // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n          \n          \n            \n                        user = userService.createUserFromLdap(registrationNumber);\n          \n          \n            \n                        if (user.isPresent()) {\n          \n          \n            \n                            exam.addUser(user.get());\n          \n          \n            \n                            // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n          \n          \n            \n                            userService.addUserToGroup(user.get(), course.getStudentGroupName());\n          \n          \n            \n                            continue;\n          \n          \n            \n                        }\n          \n          \n            \n                        // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n          \n          \n            \n                        log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n          \n          \n            \n                        notFoundStudents.add(student);\n          \n          \n            \n                    }\n          \n          \n            \n                    examRepository.save(exam);\n          \n          \n            \n                    return ResponseEntity.ok().body(notFoundStudents);\n          \n          \n            \n                }\n          \n          \n            \n                    List<String> registrationNumbers = students.stream().map(StudentDTO::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    List<User> artemisUsers = userService.findAllUsersWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumbers);\n          \n          \n            \n                    exam.addAllUsers(artemisUsers);\n          \n          \n            \n                    \n          \n          \n            \n                    //Get only registration numbers in here that are not present in artemis\n          \n          \n            \n                    registrationNumbers.removeAll(artemisUsers.stream().map(User::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    List<User> artemisUsersFromLdap = registrationNumbers.stream().map(e->userService.createUserFromLdap(e)).collect(Collections.toList());\n          \n          \n            \n                    exam.addAllUsers(artemisUsersFromLdap);\n          \n          \n            \n                    userService.addUsersToGroup(artemisUsersFromLdap, course.getStudentGroupName());\n          \n          \n            \n                    \n          \n          \n            \n                    //Get only registration numbers in here that were not found at all\n          \n          \n            \n                    registrationNumbers.removeAll(artemisUsersFromLdap.stream().map(User::getRegistrationNumber()).collect(Collections.toList());\n          \n          \n            \n                    \n          \n          \n            \n                    //ToDo: print proper warning\n          \n          \n            \n                        // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n          \n          \n            \n                        log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n          \n          \n            \n                    examRepository.save(exam);\n          \n          \n            \n                    \n          \n          \n            \n                    return ResponseEntity.ok().body(students.stream.filter(e->registrationNumbers.contains(e.getRegistrationNumber())).collect(Collections.toList()));\n          \n          \n            \n                }", "author": "julian-christl", "createdAt": "2020-06-14T22:01:08Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // the newly created user needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                continue;\n+            }\n+            // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+            log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            notFoundStudents.add(student);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudents);\n+    }", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNjk0NA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440326944", "bodyText": "Thanks for the detailed comment. This functionality won't be used often, so I keep the slower (but in my opinion easier to understand) version for now. I also added some additional source code and reworking it would be too much effort for now.", "author": "krusche", "createdAt": "2020-06-15T17:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3MTcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3NjE4OA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439976188", "bodyText": "Maybe it would be a good idea to create the users with a randomised password and send it to them via email. As the users will access their exams from Artemis, there might be data privacy concerns if their accounts are left with an empty password. To my knowledge, it is not possible to change the password later in Artemis?\nThis extension could be part of a follow-up PR.", "author": "anditurdiu", "createdAt": "2020-06-15T07:22:09Z", "path": "src/main/java/de/tum/in/www1/artemis/service/UserService.java", "diffHunk": "@@ -325,6 +311,35 @@ private boolean removeNonActivatedUser(User existingUser) {\n         return true;\n     }\n \n+    /**\n+     * searches the (optional) LDAP service for a user with the give registration number (= Matrikelnummer) and returns a new Artemis user\n+     * Note: this method should only be used if the user does not yet exist in the database\n+     *\n+     * @param registrationNumber the matriculation number of the student\n+     * @return a new user or null if the LDAP user was not found\n+     */\n+    public Optional<User> createUserFromLdap(String registrationNumber) {\n+        if (ldapUserService.isPresent()) {\n+            Optional<LdapUserDto> ldapUserOptional = ldapUserService.get().findByRegistrationNumber(registrationNumber);\n+            if (ldapUserOptional.isPresent()) {\n+                LdapUserDto ldapUser = ldapUserOptional.get();\n+                log.info(\"Ldap User \" + ldapUser.getUsername() + \" has registration number: \" + ldapUser.getRegistrationNumber());\n+                // Use empty password, so that we don't store the credentials of Jira users in the Artemis DB\n+                User user = createUser(ldapUser.getUsername(), \"\", ldapUser.getFirstName(), ldapUser.getLastName(), ldapUser.getEmail(), null, \"en\");", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk4NDAzMA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r439984030", "bodyText": "This is intentional. Students use their TUM LDAP password, which is NOT stored in the Artemis database (therefore we have an empty password here). In the TUM setup it works as follows: during login, Artemis asks JIRA, which in turn asks the TUM LDAP. If the password is correct, the user is logged in, otherwise an error message is shown. So basically, for TUM users, the password column in the database is ignore. We can, however, not set it null, because then Spring would complain", "author": "krusche", "createdAt": "2020-06-15T07:38:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3NjE4OA=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/UserService.java b/src/main/java/de/tum/in/www1/artemis/service/UserService.java\nindex dabb877ffb..f46b4ee4af 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/UserService.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/UserService.java\n\n@@ -312,7 +310,8 @@ public class UserService {\n     }\n \n     /**\n-     * searches the (optional) LDAP service for a user with the give registration number (= Matrikelnummer) and returns a new Artemis user\n+     * Searches the (optional) LDAP service for a user with the give registration number (= Matrikelnummer) and returns a new Artemis user-\n+     * Also creates the user in the external user management (e.g. JIRA), in case this is activated\n      * Note: this method should only be used if the user does not yet exist in the database\n      *\n      * @param registrationNumber the matriculation number of the student\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzOTUwNQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440039505", "bodyText": "TODO: make sure the user is actually created in the external authentication provider (e.g. JIRA), otherwise the call below userService.addUserToGroup(..) will throw an exception", "author": "krusche", "createdAt": "2020-06-15T09:16:06Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,119 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param students     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> students) {\n+        log.debug(\"REST request to add {} as students to exam : {}\", students, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return forbidden();\n+        }\n+        List<StudentDTO> notFoundStudents = new ArrayList<>();\n+        for (var student : students) {\n+            var registrationNumber = student.getRegistrationNumber();\n+            // 1) we use the registration number and try to find the student in the Artemis user database\n+            Optional<User> user = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+            if (user.isPresent()) {\n+                exam.addUser(user.get());\n+                // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                if (!user.get().getGroups().contains(course.getStudentGroupName())) {\n+                    userService.addUserToGroup(user.get(), course.getStudentGroupName());\n+                }\n+                continue;\n+            }\n+            // 2) if we cannot find the user, we use the registration number and try to find the student in the (TUM) LDAP\n+            user = userService.createUserFromLdap(registrationNumber);", "originalCommit": "2d9b3cfa79cde5fe638f18a8b40e4ea042ed466b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5Nzc4MA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440397780", "bodyText": "fixed", "author": "krusche", "createdAt": "2020-06-15T19:28:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzOTUwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\nindex c893e107a3..c07377ad00 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java\n\n@@ -197,7 +197,7 @@ public class ExamResource {\n      */\n     @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n     @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n-    public ResponseEntity<Void> addStudentToCourse(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n         log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n         var course = courseService.findOne(courseId);\n         var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n"}}, {"oid": "624061e0258559f0629e13f94ea9051e350364d1", "url": "https://github.com/ls1intum/Artemis/commit/624061e0258559f0629e13f94ea9051e350364d1", "message": "specify JavaDoc in more detail", "committedDate": "2020-06-15T12:47:42Z", "type": "commit"}, {"oid": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "url": "https://github.com/ls1intum/Artemis/commit/002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "message": "also create the user in the external user management when they are registered in the exam and can be found using Ldap\n\nrefactor the LDAP integration when user log in on Artemis\nfirst example for mocking the LdapService\napply some of the PR feedback", "committedDate": "2020-06-15T14:15:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNzM2OQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440217369", "bodyText": "This should be Typo instead of Type, also in the 2 other occurrences. Also, we could probably replace \"3456789\" with registrationNumber3.", "author": "sleiss", "createdAt": "2020-06-15T14:29:30Z", "path": "src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java", "diffHunk": "@@ -70,22 +75,108 @@\n     private Exam exam1;\n \n     @BeforeEach\n-    public void initTestCase() {\n+    public void initTestCase() throws URISyntaxException {\n         users = database.addUsers(4, 5, 1);\n         course1 = database.addEmptyCourse();\n         course2 = database.addEmptyCourse();\n         exam1 = database.addExam(course1);\n+        jiraRequestMockProvider.enableMockingOfRequests();\n+        jiraRequestMockProvider.mockAddUserToGroup(Set.of(course1.getStudentGroupName()));\n     }\n \n     @AfterEach\n     public void resetDatabase() {\n         database.resetDatabase();\n     }\n \n+    @Test\n+    @WithMockUser(username = \"instructor1\", roles = \"INSTRUCTOR\")\n+    public void registerUsersInExam() throws Exception {\n+\n+        var exam = createExam();\n+        var savedExam = examRepository.save(exam);\n+        var student1 = database.getUserByLogin(\"student1\");\n+        var student2 = database.getUserByLogin(\"student2\");\n+        var student3 = database.getUserByLogin(\"student3\");\n+        var registrationNumber1 = \"1234567\";\n+        var registrationNumber2 = \"2345678\";\n+        var registrationNumber3 = \"3456789\";\n+        var registrationNumber3WithType = \"3456789\" + \"0\";", "originalCommit": "002c8ee88faeb3e6e36b1805b9cf18a824b09de2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDMyNzA1Mw==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440327053", "bodyText": "done, thanks!", "author": "krusche", "createdAt": "2020-06-15T17:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNzM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "35c345dfdabe7dbd14e4a49aea5394a734fec3ba", "chunk": "diff --git a/src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java b/src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java\nindex 824855f37b..ee370bc45c 100644\n--- a/src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java\n+++ b/src/test/java/de/tum/in/www1/artemis/ExamIntegrationTest.java\n\n@@ -101,7 +101,7 @@ public class ExamIntegrationTest extends AbstractSpringIntegrationBambooBitbucke\n         var registrationNumber1 = \"1234567\";\n         var registrationNumber2 = \"2345678\";\n         var registrationNumber3 = \"3456789\";\n-        var registrationNumber3WithType = \"3456789\" + \"0\";\n+        var registrationNumber3WithTypo = registrationNumber3 + \"0\";\n         var registrationNumber6 = \"9876543\";\n         student1.setRegistrationNumber(registrationNumber1);\n         student2.setRegistrationNumber(registrationNumber2);\n"}}, {"oid": "98d14826ccb3e8ef4d3f33111ce8093d653d48e5", "url": "https://github.com/ls1intum/Artemis/commit/98d14826ccb3e8ef4d3f33111ce8093d653d48e5", "message": "fix logic error", "committedDate": "2020-06-15T14:35:19Z", "type": "commit"}, {"oid": "35c345dfdabe7dbd14e4a49aea5394a734fec3ba", "url": "https://github.com/ls1intum/Artemis/commit/35c345dfdabe7dbd14e4a49aea5394a734fec3ba", "message": "fix Typo in Typo :-D", "committedDate": "2020-06-15T14:46:14Z", "type": "commit"}, {"oid": "2ac6dbd444246d934dc05706d749657374950c11", "url": "https://github.com/ls1intum/Artemis/commit/2ac6dbd444246d934dc05706d749657374950c11", "message": "further improve server integration tests", "committedDate": "2020-06-15T16:29:56Z", "type": "commit"}, {"oid": "28215c323f743b5b281e54f6b2d359d809989da4", "url": "https://github.com/ls1intum/Artemis/commit/28215c323f743b5b281e54f6b2d359d809989da4", "message": "Merge branch 'develop' into exam/management/register-students", "committedDate": "2020-06-15T16:30:24Z", "type": "commit"}, {"oid": "d4d3970f65651b0ce006680282571350b43171ab", "url": "https://github.com/ls1intum/Artemis/commit/d4d3970f65651b0ce006680282571350b43171ab", "message": "improve createUserInExternalUserManagement", "committedDate": "2020-06-15T17:03:05Z", "type": "commit"}, {"oid": "80773e20d2be5223bc144a69141141c18f462cd4", "url": "https://github.com/ls1intum/Artemis/commit/80773e20d2be5223bc144a69141141c18f462cd4", "message": "also add single users to the course student group if they are not yet part of it when they are registered for an exam\n\nsome smaller code improvements", "committedDate": "2020-06-15T17:14:25Z", "type": "commit"}, {"oid": "f77c56a97c204915a78901846fa9e30a8bf3b9eb", "url": "https://github.com/ls1intum/Artemis/commit/f77c56a97c204915a78901846fa9e30a8bf3b9eb", "message": "fix wrong parameters in mock", "committedDate": "2020-06-15T17:25:06Z", "type": "commit"}, {"oid": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "url": "https://github.com/ls1intum/Artemis/commit/8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "message": "fix JavaDoc", "committedDate": "2020-06-15T18:22:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDMwMQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394301", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "author": "sascha11110", "createdAt": "2020-06-15T19:21:53Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "originalCommit": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwNDQyNw==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440404427", "bodyText": "\ud83d\udc4d I will change it in a follow-up PR", "author": "krusche", "createdAt": "2020-06-15T19:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDMwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDUyOQ==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394529", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "author": "sascha11110", "createdAt": "2020-06-15T19:22:21Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        // NOTE: we intentionally add the user to the course group, because the user only has access to the exam of a course, if the student also\n+        // has access to the course of the exam.\n+        // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+        if (!student.get().getGroups().contains(course.getStudentGroupName())) {\n+            userService.addUserToGroup(student.get(), course.getStudentGroupName());\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentDtos     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentsToExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        log.debug(\"REST request to add {} as students to exam {}\", studentDtos, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "originalCommit": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5ODQ1Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440398452", "bodyText": "\ud83d\udc4d I will change it in a follow-up PR", "author": "krusche", "createdAt": "2020-06-15T19:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDUyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDc3Mw==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440394773", "bodyText": "We could use checkCourseAndExamAccess() from ExamAccessService here.", "author": "sascha11110", "createdAt": "2020-06-15T19:22:45Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/ExamResource.java", "diffHunk": "@@ -177,4 +186,136 @@ public ExamResource(UserService userService, ExamService examService, ExamAccess\n \n         return ResponseEntity.ok().headers(HeaderUtil.createEntityDeletionAlert(applicationName, true, ENTITY_NAME, exam.getTitle())).build();\n     }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students/:studentLogin : Add one single given user (based on the login) to the students of the exam so that the student can access the exam\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should get student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> addStudentToExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to add {} as student to exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        Optional<User> student = userService.getUserWithGroupsAndAuthoritiesByLogin(studentLogin);\n+        if (student.isEmpty()) {\n+            return notFound();\n+        }\n+        exam.addUser(student.get());\n+        // NOTE: we intentionally add the user to the course group, because the user only has access to the exam of a course, if the student also\n+        // has access to the course of the exam.\n+        // we only need to add the user to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+        if (!student.get().getGroups().contains(course.getStudentGroupName())) {\n+            userService.addUserToGroup(student.get(), course.getStudentGroupName());\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(null);\n+    }\n+\n+    /**\n+     * Post /courses/:courseId/exams/:examId/students : Add multiple users to the students of the exam so that they can access the exam\n+     * The passed list of UserDTOs must include the registration number (the other entries are currently ignored and can be left out)\n+     * Note: registration based on other user attributes (e.g. email, name, login) is currently NOT supported\n+     *\n+     * This method first tries to find the student in the internal Artemis user database (because the user is most probably already using Artemis).\n+     * In case the user cannot be found, we additionally search the (TUM) LDAP in case it is configured properly.\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentDtos     the list of students (with at least registration number) who should get access to the exam\n+     * @return             the list of students who could not be registered for the exam, because they could NOT be found in the Artemis database and could NOT be found in the TUM LDAP\n+     */\n+    @PostMapping(value = \"/courses/{courseId}/exams/{examId}/students\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<List<StudentDTO>> addStudentsToExam(@PathVariable Long courseId, @PathVariable Long examId, @RequestBody List<StudentDTO> studentDtos) {\n+        log.debug(\"REST request to add {} as students to exam {}\", studentDtos, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }\n+        List<StudentDTO> notFoundStudentsDtos = new ArrayList<>();\n+        for (var studentDto : studentDtos) {\n+            var registrationNumber = studentDto.getRegistrationNumber();\n+            try {\n+                // 1) we use the registration number and try to find the student in the Artemis user database\n+                Optional<User> optionalStudent = userService.findUserWithGroupsAndAuthoritiesByRegistrationNumber(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    exam.addUser(student);\n+                    // we only need to add the student to the course group, if the student is not yet part of it, otherwise the student cannot access the exam (within the course)\n+                    if (!student.getGroups().contains(course.getStudentGroupName())) {\n+                        userService.addUserToGroup(student, course.getStudentGroupName());\n+                    }\n+                    continue;\n+                }\n+                // 2) if we cannot find the student, we use the registration number and try to find the student in the (TUM) LDAP, create it in the Artemis DB and in a potential\n+                // external user management system\n+                optionalStudent = userService.createUserFromLdap(registrationNumber);\n+                if (optionalStudent.isPresent()) {\n+                    var student = optionalStudent.get();\n+                    exam.addUser(student);\n+                    // the newly created student needs to get the rights to access the course, otherwise the student cannot access the exam (within the course)\n+                    userService.addUserToGroup(student, course.getStudentGroupName());\n+                    continue;\n+                }\n+                // 3) if we cannot find the user in the (TUM) LDAP, we report this to the client\n+                log.warn(\"User with registration number \" + registrationNumber + \" not found in Artemis user database and not found in (TUM) LDAP\");\n+            }\n+            catch (Exception ex) {\n+                log.warn(\"Error while processing user with registration number \" + registrationNumber + \": \" + ex.getMessage(), ex);\n+            }\n+\n+            notFoundStudentsDtos.add(studentDto);\n+        }\n+        examRepository.save(exam);\n+        return ResponseEntity.ok().body(notFoundStudentsDtos);\n+    }\n+\n+    /**\n+     * DELETE /courses/:courseId/exams/:examId/students/:studentLogin : Remove one single given user (based on the login) from the students of the exam so that the student cannot access the exam any more\n+     *\n+     * @param courseId     the id of the course\n+     * @param examId       the id of the exam\n+     * @param studentLogin the login of the user who should lose student access\n+     * @return empty ResponseEntity with status 200 (OK) or with status 404 (Not Found)\n+     */\n+    @DeleteMapping(value = \"/courses/{courseId}/exams/{examId}/students/{studentLogin:\" + Constants.LOGIN_REGEX + \"}\")\n+    @PreAuthorize(\"hasAnyRole('INSTRUCTOR', 'ADMIN')\")\n+    public ResponseEntity<Void> removeStudentFromExam(@PathVariable Long courseId, @PathVariable Long examId, @PathVariable String studentLogin) {\n+        log.debug(\"REST request to remove {} as student from exam : {}\", studentLogin, examId);\n+        var course = courseService.findOne(courseId);\n+        var instructorOrAdmin = userService.getUserWithGroupsAndAuthorities();\n+        if (!authCheckService.isAtLeastInstructorInCourse(course, instructorOrAdmin)) {\n+            return forbidden();\n+        }\n+        var exam = examService.findOneWithRegisteredUsers(examId);\n+        if (!course.equals(exam.getCourse())) {\n+            return conflict();\n+        }", "originalCommit": "8d4212faeb47276b33f8e74c1ca4e7ba6bcaaa4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5ODQ3NA==", "url": "https://github.com/ls1intum/Artemis/pull/1652#discussion_r440398474", "bodyText": "\ud83d\udc4d I will change it in a follow-up PR", "author": "krusche", "createdAt": "2020-06-15T19:29:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM5NDc3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ffcd513fd76bcb2db857a9720e1907cebc5978b7", "url": "https://github.com/ls1intum/Artemis/commit/ffcd513fd76bcb2db857a9720e1907cebc5978b7", "message": "Merge branch 'develop' into exam/management/register-students", "committedDate": "2020-06-15T19:28:52Z", "type": "commit"}, {"oid": "032e6727612850457185e520fc90640188a168bd", "url": "https://github.com/ls1intum/Artemis/commit/032e6727612850457185e520fc90640188a168bd", "message": "fix issue when ldap user during login is not found", "committedDate": "2020-06-15T19:38:25Z", "type": "commit"}]}