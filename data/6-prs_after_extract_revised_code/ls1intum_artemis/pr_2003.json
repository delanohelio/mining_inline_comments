{"pr_number": 2003, "pr_title": "Re-evaluate automatic results of programming exercises", "pr_createdAt": "2020-08-06T17:35:34Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2003", "timeline": [{"oid": "84aae4f2beba58dfd0b64f72e21b717dac1edc8a", "url": "https://github.com/ls1intum/Artemis/commit/84aae4f2beba58dfd0b64f72e21b717dac1edc8a", "message": "Add database query for participations with latest automatic results", "committedDate": "2020-08-06T16:48:19Z", "type": "commit"}, {"oid": "c6f6b03f5643491ce07694fa8d1dd369e5ac794f", "url": "https://github.com/ls1intum/Artemis/commit/c6f6b03f5643491ce07694fa8d1dd369e5ac794f", "message": "Add corresponding method in participation service", "committedDate": "2020-08-06T16:49:41Z", "type": "commit"}, {"oid": "298cb946f32ba308a47e63eb5d0b618ca8225eca", "url": "https://github.com/ls1intum/Artemis/commit/298cb946f32ba308a47e63eb5d0b618ca8225eca", "message": "Allow updating all latest automatic results from the latest tests cases", "committedDate": "2020-08-06T16:53:32Z", "type": "commit"}, {"oid": "4f0191b140b77a92d9e922d407c361a0e16c63c0", "url": "https://github.com/ls1intum/Artemis/commit/4f0191b140b77a92d9e922d407c361a0e16c63c0", "message": "Set the completion date when updating a result", "committedDate": "2020-08-06T16:54:01Z", "type": "commit"}, {"oid": "bd99e78c0f29cc2d77a74d3e928b8408ce4ddee6", "url": "https://github.com/ls1intum/Artemis/commit/bd99e78c0f29cc2d77a74d3e928b8408ce4ddee6", "message": "Fix spelling mistake", "committedDate": "2020-08-06T17:25:23Z", "type": "commit"}, {"oid": "a8fdada3be17630ec34424c53095325583e19860", "url": "https://github.com/ls1intum/Artemis/commit/a8fdada3be17630ec34424c53095325583e19860", "message": "Correct comment", "committedDate": "2020-08-06T17:26:25Z", "type": "commit"}, {"oid": "246c6d8d47548f9957c96ab680ee18359a32ced1", "url": "https://github.com/ls1intum/Artemis/commit/246c6d8d47548f9957c96ab680ee18359a32ced1", "message": "Add REST endpoint for re-evaluating programming exercises", "committedDate": "2020-08-06T17:27:38Z", "type": "commit"}, {"oid": "32e805f3c36d11ddddc87013f330ee59badb7b5b", "url": "https://github.com/ls1intum/Artemis/commit/32e805f3c36d11ddddc87013f330ee59badb7b5b", "message": "Fix missing authorization check", "committedDate": "2020-08-06T17:28:10Z", "type": "commit"}, {"oid": "bca46fc2d14631cc1e6329d47f17fe2aa9617799", "url": "https://github.com/ls1intum/Artemis/commit/bca46fc2d14631cc1e6329d47f17fe2aa9617799", "message": "Fix Hibernate query", "committedDate": "2020-08-06T18:03:51Z", "type": "commit"}, {"oid": "85fc390c995053de5c49ac618790d7312d2ce4c1", "url": "https://github.com/ls1intum/Artemis/commit/85fc390c995053de5c49ac618790d7312d2ce4c1", "message": "Merge branch 'develop' into feature/programming-exercise/reevaluate-from-test-cases", "committedDate": "2020-08-06T18:08:49Z", "type": "commit"}, {"oid": "804e5427b0c5cb544e805f3ec7e3583003f95f55", "url": "https://github.com/ls1intum/Artemis/commit/804e5427b0c5cb544e805f3ec7e3583003f95f55", "message": "Improve code style and fix bug", "committedDate": "2020-08-06T18:34:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMzYwMA==", "url": "https://github.com/ls1intum/Artemis/pull/2003#discussion_r466613600", "bodyText": "do we really need the part or result is null?\nWe cannot update a non existing result so we don't even need to fetch it from the database right?", "author": "krusche", "createdAt": "2020-08-06T18:43:03Z", "path": "src/main/java/de/tum/in/www1/artemis/repository/StudentParticipationRepository.java", "diffHunk": "@@ -68,6 +69,16 @@\n     @Query(\"select distinct participation from StudentParticipation participation left join fetch participation.results result where participation.exercise.id = :#{#exerciseId} and (result.id = (select max(id) from participation.results) or result is null)\")\n     List<StudentParticipation> findByExerciseIdWithLatestResult(@Param(\"exerciseId\") Long exerciseId);\n \n+    /**\n+     * Get all participations for an exercise with each latest {@link AssessmentType#AUTOMATIC} result (determined by id).\n+     * If there is no latest result (= no result at all), the participation will still be included in the returned ResultSet, but will have an empty Result array.\n+     *\n+     * @param exerciseId Exercise id.\n+     * @return participations for exercise.\n+     */\n+    @Query(\"select distinct participation from StudentParticipation participation left join fetch participation.results result where participation.exercise.id = :#{#exerciseId} and (result.id = (select max(prs.id) from participation.results prs where prs.assessmentType = 'AUTOMATIC') or result is null)\")", "originalCommit": "804e5427b0c5cb544e805f3ec7e3583003f95f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNDY4MA==", "url": "https://github.com/ls1intum/Artemis/pull/2003#discussion_r466614680", "bodyText": "I adapted that from the query above, but I guess we can also leave it out.", "author": "MaisiKoleni", "createdAt": "2020-08-06T18:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMzYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNzgyNw==", "url": "https://github.com/ls1intum/Artemis/pull/2003#discussion_r466617827", "bodyText": "I would leave it out for performance reasons. Or is typically not performant and we would filter those participations out later anyway", "author": "krusche", "createdAt": "2020-08-06T18:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxMzYwMA=="}], "type": "inlineReview", "revised_code": {"commit": "c2678b54268dd8e507ba19dad9174f6894c6c8d2", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/repository/StudentParticipationRepository.java b/src/main/java/de/tum/in/www1/artemis/repository/StudentParticipationRepository.java\nindex 9129099cd..ff6a3a6ba 100644\n--- a/src/main/java/de/tum/in/www1/artemis/repository/StudentParticipationRepository.java\n+++ b/src/main/java/de/tum/in/www1/artemis/repository/StudentParticipationRepository.java\n\n@@ -71,12 +71,11 @@ public interface StudentParticipationRepository extends JpaRepository<StudentPar\n \n     /**\n      * Get all participations for an exercise with each latest {@link AssessmentType#AUTOMATIC} result (determined by id).\n-     * If there is no latest result (= no result at all), the participation will still be included in the returned ResultSet, but will have an empty Result array.\n      *\n      * @param exerciseId Exercise id.\n      * @return participations for exercise.\n      */\n-    @Query(\"select distinct participation from StudentParticipation participation left join fetch participation.results result where participation.exercise.id = :#{#exerciseId} and (result.id = (select max(prs.id) from participation.results prs where prs.assessmentType = 'AUTOMATIC') or result is null)\")\n+    @Query(\"select distinct participation from StudentParticipation participation left join fetch participation.results result where participation.exercise.id = :#{#exerciseId} and (result.id = (select max(prs.id) from participation.results prs where prs.assessmentType = 'AUTOMATIC'))\")\n     List<StudentParticipation> findByExerciseIdWithLatestAutomaticResult(@Param(\"exerciseId\") Long exerciseId);\n \n     @Query(\"select distinct participation from StudentParticipation participation left join fetch participation.submissions where participation.exercise.id = :#{#exerciseId} and participation.student.id = :#{#studentId}\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNDM3Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2003#discussion_r466614376", "bodyText": "should we update the templateParticipation and the solutionParticipation as well?\nWhile they should have 0% and 100% anyway, this is not always the case, so I guess this would make sense.\nEspecially when there is a bonus, the solution result might change (e.g. from 100% to 125%)", "author": "krusche", "createdAt": "2020-08-06T18:44:37Z", "path": "src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java", "diffHunk": "@@ -150,13 +151,56 @@ public boolean generateTestCasesFromFeedbacks(List<Feedback> feedbacks, Programm\n      * @return Result with updated feedbacks, score and result string.\n      */\n     public Result updateResultFromTestCases(Result result, ProgrammingExercise exercise, boolean isStudentParticipation) {\n-        boolean shouldTestsWithAfterDueDateFlagBeRemoved = isStudentParticipation && exercise.getBuildAndTestStudentSubmissionsAfterDueDate() != null\n-                && ZonedDateTime.now().isBefore(exercise.getBuildAndTestStudentSubmissionsAfterDueDate());\n         Set<ProgrammingExerciseTestCase> testCases = findActiveByExerciseId(exercise.getId());\n+        Set<ProgrammingExerciseTestCase> testCasesForCurrentDate = testCases;\n+        // We don't filter the test cases for the solution/template participation's results as they are used as indicators for the instructor!\n+        if (isStudentParticipation) {\n+            testCasesForCurrentDate = filterTestCasesForCurrentDate(exercise, testCases);\n+        }\n+        return updateResultFromTestCases(testCases, testCasesForCurrentDate, result);\n+    }\n+\n+    /**\n+     * Updates <b>all</b> latest automatic results of the given exercise with the information of the exercises test cases. This update includes:\n+     * - Checking which test cases were not executed as this is not part of the bamboo build (not all test cases are executed in an exercise with sequential test runs)\n+     * - Checking the due date and the afterDueDate flag\n+     * - Recalculating the score based based on the successful test cases weight vs the total weight of all test cases.\n+     *\n+     * If there are no test cases stored in the database for the given exercise (i.e. we have a legacy exercise) or the weight has not been changed, then the result will not change\n+     *\n+     * @param exercise the exercise whose results should be updated\n+     * @return the results of the exercise that have been updated\n+     */\n+    public List<Result> updateAllResultsFromTestCases(ProgrammingExercise exercise) {\n+        Set<ProgrammingExerciseTestCase> testCases = findActiveByExerciseId(exercise.getId());\n+        Set<ProgrammingExerciseTestCase> testCasesForCurrentDate = filterTestCasesForCurrentDate(exercise, testCases);\n+        // We only update the latest automatic results here, later manual assessments are not affected\n+        List<StudentParticipation> participations = participationService.findByExerciseIdWithLatestAutomaticResult(exercise.getId());", "originalCommit": "804e5427b0c5cb544e805f3ec7e3583003f95f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY0MzQyNg==", "url": "https://github.com/ls1intum/Artemis/pull/2003#discussion_r466643426", "bodyText": "Template and solution are now updated as well.", "author": "MaisiKoleni", "createdAt": "2020-08-06T19:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNDM3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a86800b22cc7bf54e94ace95db642e797e3a547c", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java b/src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java\nindex 2b2764162..a590ccd30 100644\n--- a/src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java\n+++ b/src/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java\n\n@@ -173,17 +173,24 @@ public class ProgrammingExerciseTestCaseService {\n      */\n     public List<Result> updateAllResultsFromTestCases(ProgrammingExercise exercise) {\n         Set<ProgrammingExerciseTestCase> testCases = findActiveByExerciseId(exercise.getId());\n+\n+        ArrayList<Result> updatedResults = new ArrayList<>();\n+\n+        Result templateResult = exercise.getTemplateParticipation().findLatestResult();\n+        Result solutionResult = exercise.getSolutionParticipation().findLatestResult();\n+        // template and solution are always updated using all test cases\n+        updateResultFromTestCases(testCases, testCases, templateResult);\n+        updateResultFromTestCases(testCases, testCases, solutionResult);\n+        updatedResults.add(templateResult);\n+        updatedResults.add(solutionResult);\n+\n+        // filter the test cases for the student results if necessary\n         Set<ProgrammingExerciseTestCase> testCasesForCurrentDate = filterTestCasesForCurrentDate(exercise, testCases);\n         // We only update the latest automatic results here, later manual assessments are not affected\n         List<StudentParticipation> participations = participationService.findByExerciseIdWithLatestAutomaticResult(exercise.getId());\n \n-        ArrayList<Result> updatedResults = new ArrayList<>();\n         for (StudentParticipation studentParticipation : participations) {\n             Result result = studentParticipation.findLatestResult();\n-            // Ignore participations without result\n-            if (result == null) {\n-                continue;\n-            }\n             updateResultFromTestCases(testCases, testCasesForCurrentDate, result);\n             updatedResults.add(result);\n         }\n"}}, {"oid": "0c2602076039541ed0260a398fb7d10f372d6608", "url": "https://github.com/ls1intum/Artemis/commit/0c2602076039541ed0260a398fb7d10f372d6608", "message": "Add client side rest call to service", "committedDate": "2020-08-06T19:37:08Z", "type": "commit"}, {"oid": "c2678b54268dd8e507ba19dad9174f6894c6c8d2", "url": "https://github.com/ls1intum/Artemis/commit/c2678b54268dd8e507ba19dad9174f6894c6c8d2", "message": "Change query to only include participations with automatic result", "committedDate": "2020-08-06T19:38:43Z", "type": "commit"}, {"oid": "a86800b22cc7bf54e94ace95db642e797e3a547c", "url": "https://github.com/ls1intum/Artemis/commit/a86800b22cc7bf54e94ace95db642e797e3a547c", "message": "Update template and solution as well", "committedDate": "2020-08-06T19:39:14Z", "type": "commit"}, {"oid": "32bb05f871b9c09943219a382b4ca4583b9061db", "url": "https://github.com/ls1intum/Artemis/commit/32bb05f871b9c09943219a382b4ca4583b9061db", "message": "Basic client side implementation", "committedDate": "2020-08-06T20:31:37Z", "type": "commit"}, {"oid": "32bb05f871b9c09943219a382b4ca4583b9061db", "url": "https://github.com/ls1intum/Artemis/commit/32bb05f871b9c09943219a382b4ca4583b9061db", "message": "Basic client side implementation", "committedDate": "2020-08-06T20:31:37Z", "type": "forcePushed"}, {"oid": "934c2536a754bc275665eca19e2e129fd709b8d4", "url": "https://github.com/ls1intum/Artemis/commit/934c2536a754bc275665eca19e2e129fd709b8d4", "message": "Fix formatting 1", "committedDate": "2020-08-06T21:46:50Z", "type": "commit"}, {"oid": "434da6f68619c7ae7f97ebd4e7def5200d5681a1", "url": "https://github.com/ls1intum/Artemis/commit/434da6f68619c7ae7f97ebd4e7def5200d5681a1", "message": "Fix formatting 2", "committedDate": "2020-08-06T21:48:51Z", "type": "commit"}, {"oid": "cbe53542756149d1634bdeac7ca2c115fc5284a0", "url": "https://github.com/ls1intum/Artemis/commit/cbe53542756149d1634bdeac7ca2c115fc5284a0", "message": "Fix missing results for template and solution", "committedDate": "2020-08-07T01:28:14Z", "type": "commit"}, {"oid": "87313cff5a154a3e7ed6329c2ca1c47f6880556a", "url": "https://github.com/ls1intum/Artemis/commit/87313cff5a154a3e7ed6329c2ca1c47f6880556a", "message": "Revert update the completion date because it messes the latest result up", "committedDate": "2020-08-07T01:32:07Z", "type": "commit"}, {"oid": "7aa9bce54d7f8e14873b04459136a80aaef4e08b", "url": "https://github.com/ls1intum/Artemis/commit/7aa9bce54d7f8e14873b04459136a80aaef4e08b", "message": "Add feedbacks to database query and rename method", "committedDate": "2020-08-07T02:11:32Z", "type": "commit"}, {"oid": "7efba32242470067cb54efd36ff95d48448c1416", "url": "https://github.com/ls1intum/Artemis/commit/7efba32242470067cb54efd36ff95d48448c1416", "message": "Set score to zero if there are test cases and no test passes", "committedDate": "2020-08-07T02:33:21Z", "type": "commit"}, {"oid": "68236b60c31423b6cf8fdcf10288e4c1696a976b", "url": "https://github.com/ls1intum/Artemis/commit/68236b60c31423b6cf8fdcf10288e4c1696a976b", "message": "Test draft for re-evaluate", "committedDate": "2020-08-07T03:35:06Z", "type": "commit"}, {"oid": "e2682a96d6b1dd6f732ed9479300598d2b6abd14", "url": "https://github.com/ls1intum/Artemis/commit/e2682a96d6b1dd6f732ed9479300598d2b6abd14", "message": "Merge branch 'develop' into feature/programming-exercise/reevaluate-from-test-cases\n\n# Conflicts:\n#\tsrc/main/java/de/tum/in/www1/artemis/service/ProgrammingExerciseTestCaseService.java", "committedDate": "2020-08-07T07:17:56Z", "type": "commit"}, {"oid": "97a52f0bdd8ebdf8cbd15596a83335fb2c052429", "url": "https://github.com/ls1intum/Artemis/commit/97a52f0bdd8ebdf8cbd15596a83335fb2c052429", "message": "fix test case error", "committedDate": "2020-08-07T08:58:01Z", "type": "commit"}, {"oid": "a1fb668bf97dd58504945c50d398a98e4a8d4bfe", "url": "https://github.com/ls1intum/Artemis/commit/a1fb668bf97dd58504945c50d398a98e4a8d4bfe", "message": "Merge branch 'develop' into feature/programming-exercise/reevaluate-from-test-cases", "committedDate": "2020-08-07T09:00:42Z", "type": "commit"}, {"oid": "cc4ec15b6d941276043d710ce0fa02ffa2a16899", "url": "https://github.com/ls1intum/Artemis/commit/cc4ec15b6d941276043d710ce0fa02ffa2a16899", "message": "Merge branch 'feature/programming-exercise/reevaluate-from-test-cases' of https://github.com/ls1intum/Artemis into feature/programming-exercise/reevaluate-from-test-cases", "committedDate": "2020-08-07T09:00:56Z", "type": "commit"}, {"oid": "d1701213ba65d5a74f881731624701843d7d7b11", "url": "https://github.com/ls1intum/Artemis/commit/d1701213ba65d5a74f881731624701843d7d7b11", "message": "fix test case errors", "committedDate": "2020-08-07T09:04:18Z", "type": "commit"}, {"oid": "c8faf69d508334c314a54e75db2e2e478aaf36a0", "url": "https://github.com/ls1intum/Artemis/commit/c8faf69d508334c314a54e75db2e2e478aaf36a0", "message": "fix test", "committedDate": "2020-08-07T09:22:41Z", "type": "commit"}, {"oid": "a6518a74ec715502953dc86b69e5c6ef6b90f7bd", "url": "https://github.com/ls1intum/Artemis/commit/a6518a74ec715502953dc86b69e5c6ef6b90f7bd", "message": "fix disable logic in client and nullpointer exception for Boolean unwrap", "committedDate": "2020-08-07T09:35:17Z", "type": "commit"}, {"oid": "3c87fc1d1d535af129c5f53e25710a086330ff7f", "url": "https://github.com/ls1intum/Artemis/commit/3c87fc1d1d535af129c5f53e25710a086330ff7f", "message": "fix null pointer exceptions", "committedDate": "2020-08-07T11:49:39Z", "type": "commit"}, {"oid": "aa37272ccea1b293400bf71175cae476b5d83419", "url": "https://github.com/ls1intum/Artemis/commit/aa37272ccea1b293400bf71175cae476b5d83419", "message": "make sure the default value for bonus points is stored in the database", "committedDate": "2020-08-07T11:53:48Z", "type": "commit"}]}