{"pr_number": 1454, "pr_title": "Assessment of team submissions by team owner tutor", "pr_createdAt": "2020-05-11T18:06:21Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1454", "timeline": [{"oid": "327719df69f461523738979514fe0f41d4f2ed35", "url": "https://github.com/ls1intum/Artemis/commit/327719df69f461523738979514fe0f41d4f2ed35", "message": "Preparation", "committedDate": "2020-05-09T17:04:59Z", "type": "commit"}, {"oid": "db3e82508c9b825a85aa765f18853f8bad14dd30", "url": "https://github.com/ls1intum/Artemis/commit/db3e82508c9b825a85aa765f18853f8bad14dd30", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-11T18:06:46Z", "type": "commit"}, {"oid": "7e689362de052df2361f25dee45959d4918f1002", "url": "https://github.com/ls1intum/Artemis/commit/7e689362de052df2361f25dee45959d4918f1002", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-13T14:49:02Z", "type": "commit"}, {"oid": "b3798951d6ba8fc4f32e73bdac1b12dc9d7466a6", "url": "https://github.com/ls1intum/Artemis/commit/b3798951d6ba8fc4f32e73bdac1b12dc9d7466a6", "message": "Fetch latest submission", "committedDate": "2020-05-17T11:43:19Z", "type": "commit"}, {"oid": "5de8fa890f077d5b18bab781665940236e1ee032", "url": "https://github.com/ls1intum/Artemis/commit/5de8fa890f077d5b18bab781665940236e1ee032", "message": "Assessment column in team participation table", "committedDate": "2020-05-17T12:53:55Z", "type": "commit"}, {"oid": "729eb1e79cd5a4f5e9bb6691762a4d1a7210b4fc", "url": "https://github.com/ls1intum/Artemis/commit/729eb1e79cd5a4f5e9bb6691762a4d1a7210b4fc", "message": "Template fix", "committedDate": "2020-05-17T12:59:17Z", "type": "commit"}, {"oid": "ff914f4605fc5383806eaec30e26b0fa8ce1a165", "url": "https://github.com/ls1intum/Artemis/commit/ff914f4605fc5383806eaec30e26b0fa8ce1a165", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-17T13:00:06Z", "type": "commit"}, {"oid": "5e3b8b82dc1b3467146313044a00710db2c1f392", "url": "https://github.com/ls1intum/Artemis/commit/5e3b8b82dc1b3467146313044a00710db2c1f392", "message": "Link from tutor course dashboard to teams for team exercises", "committedDate": "2020-05-17T13:15:38Z", "type": "commit"}, {"oid": "4331f55544329cf45bfc1bc20ff6d7ad4b547aa7", "url": "https://github.com/ls1intum/Artemis/commit/4331f55544329cf45bfc1bc20ff6d7ad4b547aa7", "message": "Link from tutor course dashboard to teams for team exercises", "committedDate": "2020-05-17T13:47:46Z", "type": "commit"}, {"oid": "74a9b7491905688a6f1f2e5b61b6a44ef740c850", "url": "https://github.com/ls1intum/Artemis/commit/74a9b7491905688a6f1f2e5b61b6a44ef740c850", "message": "Fix test", "committedDate": "2020-05-17T14:12:59Z", "type": "commit"}, {"oid": "630559153817785fc67bd2d32c25383118a88935", "url": "https://github.com/ls1intum/Artemis/commit/630559153817785fc67bd2d32c25383118a88935", "message": "Result", "committedDate": "2020-05-17T18:16:47Z", "type": "commit"}, {"oid": "c72cd52cbb03beacecffbf89a82625d809012f29", "url": "https://github.com/ls1intum/Artemis/commit/c72cd52cbb03beacecffbf89a82625d809012f29", "message": "Cleanup", "committedDate": "2020-05-17T18:25:32Z", "type": "commit"}, {"oid": "5fb0d52fd78871a4111ab008719901728546563e", "url": "https://github.com/ls1intum/Artemis/commit/5fb0d52fd78871a4111ab008719901728546563e", "message": "Cleanup", "committedDate": "2020-05-17T18:27:50Z", "type": "commit"}, {"oid": "b21ec724cdeedb3d983a36df5550635ef6f650a9", "url": "https://github.com/ls1intum/Artemis/commit/b21ec724cdeedb3d983a36df5550635ef6f650a9", "message": "Server tests", "committedDate": "2020-05-17T19:17:48Z", "type": "commit"}, {"oid": "4835dea764091eff8251cdcb11857ad7debf5feb", "url": "https://github.com/ls1intum/Artemis/commit/4835dea764091eff8251cdcb11857ad7debf5feb", "message": "Allow assessing before due date", "committedDate": "2020-05-17T19:54:12Z", "type": "commit"}, {"oid": "5ce0476e9e09bf379c4d04a60027e9d134495232", "url": "https://github.com/ls1intum/Artemis/commit/5ce0476e9e09bf379c4d04a60027e9d134495232", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-18T11:42:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Mzg3Ng==", "url": "https://github.com/ls1intum/Artemis/pull/1454#discussion_r426563876", "bodyText": "I don't know if that's possible, but can the teams have different tutors in different exercises?\nIf so, I believe the anyMatch predicate would return too many teams (so maybe allMatch should be used?).", "author": "sleiss", "createdAt": "2020-05-18T11:41:56Z", "path": "src/main/java/de/tum/in/www1/artemis/web/rest/TeamResource.java", "diffHunk": "@@ -384,18 +388,28 @@ public TeamResource(TeamRepository teamRepository, TeamService teamService, Team\n         // Set teams on exercises\n         exercises.forEach(exercise -> exercise.setTeams(Set.of(exerciseTeamMap.get(exercise.getId()))));\n \n-        // Fetch participations for team and set the submission count for each participation\n-        List<StudentParticipation> participations = participationService.findAllByCourseIdAndTeamShortName(courseId, teamShortName);\n+        // Fetch participations for team\n+        List<StudentParticipation> participations;\n+        if (authCheckService.isAtLeastInstructorInCourse(course, user) || teams.stream().map(Team::getOwner).anyMatch(user::equals)) {", "originalCommit": "4835dea764091eff8251cdcb11857ad7debf5feb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU3OTI5MA==", "url": "https://github.com/ls1intum/Artemis/pull/1454#discussion_r426579290", "bodyText": "This is a little tricky. In terms of business logic, all team instances of a team should be assigned to the same tutor for a course. If this were given, it wouldn't matter whether anyMatch or allMatch is used. However, there is nothing enforcing this in application logic at the moment, so instances of the \"same\" team (meaning same short name but different team entity in other exercise) could have different tutors if an instructor re-assigns one of the exercise teams to a different tutor.\nIn this auth check, I decided to opt for anyMatch to be a little more lenient if this situation occurs (since the endpoint would otherwise return nothing at all if the tutor is not the owner of one of the instances). Right now, this means: If a user is the team owner for any of the team instances, he gets access to their participations for all exercises.\nAs long as it's only about reading, I don't think that's a big issue but it actually can be an issue when it comes to the assessment since then more than one tutor would see the assessment button and both would think it's their job to assess this submission.\nI think the easiest solution would be if we enforce the rule that the team owner must be the same for all team instances in a course. This is normally given anyway when using the Import Teams functionality but if instructors re-assign tutors afterwards, this change is only performed for the single team instance and not for its clones in other exercises. The solution would be: In the updateTeam endpoint, changes to the team owner have to be propagated to all instances of a team.", "author": "madwau", "createdAt": "2020-05-18T12:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Mzg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY0NTU4NA==", "url": "https://github.com/ls1intum/Artemis/pull/1454#discussion_r426645584", "bodyText": "Updates to the team tutor are now propagated to all instances of the same team for a course. I changed the auth check to now use allMatch instead so that we definitely don't run into the situation that two tutors are asked to assess the same submission.\nWhen the team update dialog is opened and a different tutor is selected, this warning is now shown:", "author": "madwau", "createdAt": "2020-05-18T13:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Mzg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE0MTkyOA==", "url": "https://github.com/ls1intum/Artemis/pull/1454#discussion_r427141928", "bodyText": "Thanks for the clarification!\nYour selected solution seems good for me.", "author": "sleiss", "createdAt": "2020-05-19T08:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU2Mzg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "066303b19ba66f8354002931f5c8a37c070c7ce3", "chunk": "diff --git a/src/main/java/de/tum/in/www1/artemis/web/rest/TeamResource.java b/src/main/java/de/tum/in/www1/artemis/web/rest/TeamResource.java\nindex e707d96dd7..6571d65306 100644\n--- a/src/main/java/de/tum/in/www1/artemis/web/rest/TeamResource.java\n+++ b/src/main/java/de/tum/in/www1/artemis/web/rest/TeamResource.java\n\n@@ -390,7 +398,7 @@ public class TeamResource {\n \n         // Fetch participations for team\n         List<StudentParticipation> participations;\n-        if (authCheckService.isAtLeastInstructorInCourse(course, user) || teams.stream().map(Team::getOwner).anyMatch(user::equals)) {\n+        if (authCheckService.isAtLeastInstructorInCourse(course, user) || teams.stream().map(Team::getOwner).allMatch(user::equals)) {\n             // fetch including submissions and results for team tutor and instructors\n             participations = participationService.findAllByCourseIdAndTeamShortNameWithEagerSubmissionsResult(course.getId(), teamShortName);\n             submissionService.reduceParticipationSubmissionsToLatest(participations, true);\n"}}, {"oid": "700e72e44fd5b2754f1e8c201991ebe425d69395", "url": "https://github.com/ls1intum/Artemis/commit/700e72e44fd5b2754f1e8c201991ebe425d69395", "message": "Checkbox fot filtering teams", "committedDate": "2020-05-18T12:40:56Z", "type": "commit"}, {"oid": "09e8c8304470fc260ae64e2b73b7ef25e6dc5b31", "url": "https://github.com/ls1intum/Artemis/commit/09e8c8304470fc260ae64e2b73b7ef25e6dc5b31", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-18T12:45:00Z", "type": "commit"}, {"oid": "888ddd4c0323c140d76a00b1134ba6b151041763", "url": "https://github.com/ls1intum/Artemis/commit/888ddd4c0323c140d76a00b1134ba6b151041763", "message": "Propagate tutor change", "committedDate": "2020-05-18T13:54:00Z", "type": "commit"}, {"oid": "066303b19ba66f8354002931f5c8a37c070c7ce3", "url": "https://github.com/ls1intum/Artemis/commit/066303b19ba66f8354002931f5c8a37c070c7ce3", "message": "Change to allMatch", "committedDate": "2020-05-18T13:55:46Z", "type": "commit"}, {"oid": "ff02befadc9f529583342d0ac12b202799167b9f", "url": "https://github.com/ls1intum/Artemis/commit/ff02befadc9f529583342d0ac12b202799167b9f", "message": "Merge branch 'develop' into feature/assessment-by-team-owner", "committedDate": "2020-05-18T13:57:33Z", "type": "commit"}, {"oid": "4f4c7a52f8cddddb2af8279a0427bc5faa8e142c", "url": "https://github.com/ls1intum/Artemis/commit/4f4c7a52f8cddddb2af8279a0427bc5faa8e142c", "message": "Optional participation", "committedDate": "2020-05-18T15:58:30Z", "type": "commit"}]}