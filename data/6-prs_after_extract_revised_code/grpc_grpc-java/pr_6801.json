{"pr_number": 6801, "pr_title": "xds: add support for server side Listener watcher in XdsClient", "pr_createdAt": "2020-03-04T19:34:09Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6801", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389166741", "bodyText": "nit: you can use MoreObjects.toStringHelper.", "author": "voidzcy", "createdAt": "2020-03-06T22:05:23Z", "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;\n+\n+    private ListenerUpdate(Listener listener) {\n+      this.listener = listener;\n+    }\n+\n+    public Listener getListener() {\n+      return listener;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"ListenerUpdate{\"", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMTU2Nw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389911567", "bodyText": "This is what the IDE generated for me. After flattening I will get this for free the way you suggesed.", "author": "sanjaypujare", "createdAt": "2020-03-09T19:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3Nzc3OA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389977778", "bodyText": "btw, you can switch template in intellij to what @voidzcy suggested.", "author": "creamsoup", "createdAt": "2020-03-09T21:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NjA0OA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389986048", "bodyText": "switched template", "author": "sanjaypujare", "createdAt": "2020-03-09T22:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2Njc0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClient.java b/xds/src/main/java/io/grpc/xds/XdsClient.java\nindex 2439e03d4..4ecede643 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClient.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClient.java\n\n@@ -357,6 +344,7 @@ abstract class XdsClient {\n    * config for security, RBAC or other server side features such as rate limit.\n    */\n   static final class ListenerUpdate {\n+    // TODO(sanjaypujare): flatten structure by moving Listener class members here.\n     private final Listener listener;\n \n     private ListenerUpdate(Listener listener) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE3NjMzMw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389176333", "bodyText": "nit: it's safest to initialize with private int port = -1;", "author": "voidzcy", "createdAt": "2020-03-06T22:33:17Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -164,6 +170,12 @@\n   @Nullable\n   private String ldsResourceName;\n \n+  // only a ConfigWatcher or ListenerWatcher can be registered.\n+  @Nullable\n+  private ListenerWatcher listenerWatcher;\n+  // port of the listener that server builder is targeting for.\n+  private int port;", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0746fa6df72e477067a765fd3dc82b18ec465fff", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..e7f49c17e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -163,9 +163,6 @@ final class XdsClientImpl extends XdsClient {\n   // never change. Only a ConfigWatcher or ListenerWatcher can be registered.\n   @Nullable\n   private ConfigWatcher configWatcher;\n-  // The host name portion of \"xds:\" URI that the gRPC client targets for.\n-  @Nullable\n-  private String hostName;\n   // The \"xds:\" URI (including port suffix if present) that the gRPC client targets for.\n   @Nullable\n   private String ldsResourceName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5MjI2Mw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389192263", "bodyText": "I do not have the knowledge of design. But you are forwarding a complex structure Listener to gRPC, which seems very unnecessary. You could make the converted data as flat as possible. That's another reason to use converted data instead of proto.\nFrom existing code I see, I think at least the layer of this Listener encapsulation is redundant.\nclass ListenerUpdate {\n  private String listenerName;\n  private String listeningAddr;\n  private List<FilterChain> filterChains;\n}\nI don't know whether FilterChain can be further flattened or not depending on your design.", "author": "voidzcy", "createdAt": "2020-03-06T23:29:13Z", "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwNzIwOA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389907208", "bodyText": "I do agree that flattening Listener into ListenerUpdate (and FilterChainMatch into FilterChain) is a good idea. However the existing class hierarchy under  'io.grpc.xds.EnvoyServerProtoData.Listener' was already in place in a previous PR and this PR is leveraging it. I will put TODO comments in 2 places for the flattening to be done in future.", "author": "sanjaypujare", "createdAt": "2020-03-09T19:18:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5MjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3NjcwNw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389976707", "bodyText": "Done as per my comment", "author": "sanjaypujare", "createdAt": "2020-03-09T21:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5MjI2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClient.java b/xds/src/main/java/io/grpc/xds/XdsClient.java\nindex 2439e03d4..4ecede643 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClient.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClient.java\n\n@@ -357,6 +344,7 @@ abstract class XdsClient {\n    * config for security, RBAC or other server side features such as rate limit.\n    */\n   static final class ListenerUpdate {\n+    // TODO(sanjaypujare): flatten structure by moving Listener class members here.\n     private final Listener listener;\n \n     private ListenerUpdate(Listener listener) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTMwNQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389195305", "bodyText": "nit: The added comment is redundant. It only adds confusion. You can just put it in updateNodeMetadataForListenerRequest method.", "author": "voidzcy", "createdAt": "2020-03-06T23:42:28Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -99,8 +104,9 @@\n   private final Stopwatch adsStreamRetryStopwatch;\n   // The node identifier to be included in xDS requests. Management server only requires the\n   // first request to carry the node identifier on a stream. It should be identical if present\n-  // more than once.\n-  private final Node node;\n+  // more than once. In case of Listener watcher metadata will be updated to include specific", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMzQzNg==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389903436", "bodyText": "Okay, will do", "author": "sanjaypujare", "createdAt": "2020-03-09T19:11:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTMwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..9e2fe2f07 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -104,8 +104,7 @@ final class XdsClientImpl extends XdsClient {\n   private final Stopwatch adsStreamRetryStopwatch;\n   // The node identifier to be included in xDS requests. Management server only requires the\n   // first request to carry the node identifier on a stream. It should be identical if present\n-  // more than once. In case of Listener watcher metadata will be updated to include specific\n-  // information.\n+  // more than once.\n   private Node node;\n \n   // Cached data for CDS responses, keyed by cluster names.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389195861", "bodyText": "You can just call with empty list (e.g., Collections.emptyList()) so that you don't need to any special logic in sendXXXRequest() method.", "author": "voidzcy", "createdAt": "2020-03-06T23:45:00Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -414,6 +427,39 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkState(port > 0, \"port needs to be > 0\");\n+    this.port = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, null);", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMjk1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389902951", "bodyText": "Sending an empty list vs null has different implications on the xDS server side and the xDS folks (TD) told me they expect null in this case.", "author": "sanjaypujare", "createdAt": "2020-03-09T19:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4NDEwNA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389984104", "bodyText": "that is very surprising, do they check internal value of proto? it will still return emptyList. maybe different type of list.", "author": "creamsoup", "createdAt": "2020-03-09T21:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5OTAzNQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389999035", "bodyText": "I found this the hard way while testing with the xDS server (TD). An uninitialized list field and initialized list of 0 size are different apparently. I'll post a pointer if I find one.", "author": "sanjaypujare", "createdAt": "2020-03-09T22:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMDU0OA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390000548", "bodyText": "As far as I know, calling addAllXXX() method with an empty list is equivalent to not setting that field in protobuf. There isn't a real null semantics in protos. Empty collections or strings are not sent out in wire and getters return at least an empty collection/string even if the field is not set.", "author": "voidzcy", "createdAt": "2020-03-09T22:40:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMjI1Nw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390002257", "bodyText": "I examine the code. addAll(emptyList) has side effect of setting the internal collection to ArrayList instead of Collections.emptyList(). usually emptyList can cause more problems...", "author": "creamsoup", "createdAt": "2020-03-09T22:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMzc2MQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390003761", "bodyText": "But it shouldn't have behavior-wise difference than not setting it, right? Anyway, @sanjaypujare said the design is still half baked and later it will contain some resources explicitly. I am fine being this now.", "author": "voidzcy", "createdAt": "2020-03-09T22:49:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNTUwOQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390005509", "bodyText": "It's not about the design being half-baked or half-ready. It is about how the server treats the request differently: I didn't pursue why they don't treat both the same but I need to do what the server expects.", "author": "sanjaypujare", "createdAt": "2020-03-09T22:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzODU5Mg==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390038592", "bodyText": "Changed to using Collections.emptyList()", "author": "sanjaypujare", "createdAt": "2020-03-10T00:51:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NTg2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0746fa6df72e477067a765fd3dc82b18ec465fff", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..e7f49c17e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -429,7 +421,7 @@ final class XdsClientImpl extends XdsClient {\n \n   @Override\n   void watchListenerData(int port, ListenerWatcher watcher) {\n-    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", ldsResourceName);\n     checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n     listenerWatcher = checkNotNull(watcher, \"watcher\");\n     checkState(port > 0, \"port needs to be > 0\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjUwMA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389202500", "bodyText": "Let's make this more elegant. Put the logic of unpacking Listeners and selecting the requested Listener in handleLdsResponse(). Then branching into different helper methods for processing different data.\nvoid handleLdsResponse(DiscoverResponse ldsResponse) {\n  checkState((configWatcher != null) != (listenerWatcher != null), ...);  // XOR\n  Listener requestedListener = null;\n  // unpack Listeners and choose the only one that we are interested in.\n  // ...\n  if (configWatcher != null) {\n    processListenerForConfigUpdate(requestedListener);\n  } else {\n    processListenerForListenerUpdate(requestedListener);\n  }\n}\n\nvoid processListenerForConfigUpdate(Listener listener) {\n  // ...\n}\n\nvoid processListenerForListenerUpdate(Listener listener) {\n  // ...\n}", "author": "voidzcy", "createdAt": "2020-03-07T00:18:10Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -472,14 +518,19 @@ private void startRpcStream() {\n   }\n \n   /**\n-   * Handles LDS response to find the HttpConnectionManager message for the requested resource name.\n+   * If listenerWatcher is set it just calls handleLdsResponseForListener. Otherwise\n+   * handles LDS response to find the HttpConnectionManager message for the requested resource name.\n    * Proceed with the resolved RouteConfiguration in HttpConnectionManager message of the requested\n    * listener, if exists, to find the VirtualHost configuration for the \"xds:\" URI\n    * (with the port, if any, stripped off). Or sends an RDS request if configured for dynamic\n    * resolution. The response is NACKed if contains invalid data for gRPC's usage. Otherwise, an\n    * ACK request is sent to management server.\n    */\n   private void handleLdsResponse(DiscoveryResponse ldsResponse) {", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMjI5Mw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389902293", "bodyText": "Okay, let me do it but I don't think it's that different in terms of the structure.", "author": "sanjaypujare", "createdAt": "2020-03-09T19:08:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3NzIyOA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389977228", "bodyText": "The logic to locate the requestedListener is different in the 2 cases so it is best to put it in the respective methods (processListenerForConfigUpdate vs processListenerForListenerUpdate). Done.", "author": "sanjaypujare", "createdAt": "2020-03-09T21:40:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMjUwMA=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..9e2fe2f07 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -518,25 +510,34 @@ final class XdsClientImpl extends XdsClient {\n   }\n \n   /**\n-   * If listenerWatcher is set it just calls handleLdsResponseForListener. Otherwise\n-   * handles LDS response to find the HttpConnectionManager message for the requested resource name.\n-   * Proceed with the resolved RouteConfiguration in HttpConnectionManager message of the requested\n-   * listener, if exists, to find the VirtualHost configuration for the \"xds:\" URI\n-   * (with the port, if any, stripped off). Or sends an RDS request if configured for dynamic\n-   * resolution. The response is NACKed if contains invalid data for gRPC's usage. Otherwise, an\n-   * ACK request is sent to management server.\n+   * Calls handleLdsResponseForListener or handleLdsResponseForConfigUpdate based on which watcher\n+   * was set.\n    */\n   private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n-    if (listenerWatcher != null) {\n-      handleLdsResponseForListener(ldsResponse);\n-      return;\n-    }\n-    checkState(ldsResourceName != null && configWatcher != null,\n+    checkState((configWatcher != null) != (listenerWatcher != null),\n         \"No LDS request was ever sent. Management server is doing something wrong\");\n     if (logger.isLoggable(XdsLogLevel.DEBUG)) {\n       logger.log(\n           XdsLogLevel.DEBUG, \"Received  LDS response:\\n{0}\", respPrinter.print(ldsResponse));\n     }\n+    if (listenerWatcher != null) {\n+      handleLdsResponseForListener(ldsResponse);\n+    } else {\n+      handleLdsResponseForConfigUpdate(ldsResponse);\n+    }\n+  }\n+\n+  /**\n+   * Handles LDS response to find the HttpConnectionManager message for the requested resource name.\n+   * Proceed with the resolved RouteConfiguration in HttpConnectionManager message of the requested\n+   * listener, if exists, to find the VirtualHost configuration for the \"xds:\" URI\n+   * (with the port, if any, stripped off). Or sends an RDS request if configured for dynamic\n+   * resolution. The response is NACKed if contains invalid data for gRPC's usage. Otherwise, an\n+   * ACK request is sent to management server.\n+   */\n+  private void handleLdsResponseForConfigUpdate(DiscoveryResponse ldsResponse) {\n+    checkState(ldsResourceName != null && configWatcher != null,\n+        \"LDS request for ConfigWatcher was never sent!\");\n \n     // Unpack Listener messages.\n     List<Listener> listeners = new ArrayList<>(ldsResponse.getResourcesCount());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMTQ2Mw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389211463", "bodyText": "You should revert changes made in #6718 that puts a Listener into ConfigUpdate.", "author": "voidzcy", "createdAt": "2020-03-07T01:13:12Z", "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkwMDkwNA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389900904", "bodyText": "good point! My bad.", "author": "sanjaypujare", "createdAt": "2020-03-09T19:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMTQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClient.java b/xds/src/main/java/io/grpc/xds/XdsClient.java\nindex 2439e03d4..4ecede643 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClient.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClient.java\n\n@@ -357,6 +344,7 @@ abstract class XdsClient {\n    * config for security, RBAC or other server side features such as rate limit.\n    */\n   static final class ListenerUpdate {\n+    // TODO(sanjaypujare): flatten structure by moving Listener class members here.\n     private final Listener listener;\n \n     private ListenerUpdate(Listener listener) {\n"}}, {"oid": "0746fa6df72e477067a765fd3dc82b18ec465fff", "url": "https://github.com/grpc/grpc-java/commit/0746fa6df72e477067a765fd3dc82b18ec465fff", "message": "xds: add support for server side Listener watcher in XdsClient", "committedDate": "2020-03-09T19:42:16Z", "type": "commit"}, {"oid": "d0f470ba97167862db88d560954d47c983a6e260", "url": "https://github.com/grpc/grpc-java/commit/d0f470ba97167862db88d560954d47c983a6e260", "message": "add suppress-warning for deprecation", "committedDate": "2020-03-09T19:42:16Z", "type": "commit"}, {"oid": "0d246e558152212be440e7eacd426697972eeec0", "url": "https://github.com/grpc/grpc-java/commit/0d246e558152212be440e7eacd426697972eeec0", "message": "rebase and address various review comments", "committedDate": "2020-03-09T21:32:48Z", "type": "commit"}, {"oid": "0d246e558152212be440e7eacd426697972eeec0", "url": "https://github.com/grpc/grpc-java/commit/0d246e558152212be440e7eacd426697972eeec0", "message": "rebase and address various review comments", "committedDate": "2020-03-09T21:32:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NTg0Ng==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387965846", "bodyText": "builder pattern here seems a bit overkill unless you expect to add many more fields. consider Factory?", "author": "creamsoup", "createdAt": "2020-03-04T22:11:59Z", "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -352,6 +352,51 @@ EndpointUpdate build() {\n     }\n   }\n \n+  /**\n+   * Updates via resource discovery RPCs using LDS. Includes {@link Listener} object containing\n+   * config for security, RBAC or other server side features such as rate limit.\n+   */\n+  static final class ListenerUpdate {\n+    private final Listener listener;\n+\n+    private ListenerUpdate(Listener listener) {\n+      this.listener = listener;\n+    }\n+\n+    public Listener getListener() {\n+      return listener;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return \"ListenerUpdate{\"\n+          + \"listener=\" + listener\n+          + '}';\n+    }\n+\n+    static Builder newBuilder() {\n+      return new Builder();\n+    }\n+\n+    static final class Builder {", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzODA0Ng==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390038046", "bodyText": "I agree with Listener being the only field. However in a later PR I will be flattening Listener into ListenerUpdate as per the comment on line 347. At that time builder pattern will be useful.", "author": "sanjaypujare", "createdAt": "2020-03-10T00:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2NTg0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "0d246e558152212be440e7eacd426697972eeec0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClient.java b/xds/src/main/java/io/grpc/xds/XdsClient.java\nindex 2439e03d4..4ecede643 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClient.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClient.java\n\n@@ -357,6 +344,7 @@ abstract class XdsClient {\n    * config for security, RBAC or other server side features such as rate limit.\n    */\n   static final class ListenerUpdate {\n+    // TODO(sanjaypujare): flatten structure by moving Listener class members here.\n     private final Listener listener;\n \n     private ListenerUpdate(Listener listener) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk2Nzk3NA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387967974", "bodyText": "if port sounds confusing, rename to listenerPort? can remove the comment after this.", "author": "creamsoup", "createdAt": "2020-03-04T22:16:41Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -164,6 +170,12 @@\n   @Nullable\n   private String ldsResourceName;\n \n+  // only a ConfigWatcher or ListenerWatcher can be registered.\n+  @Nullable\n+  private ListenerWatcher listenerWatcher;\n+  // port of the listener that server builder is targeting for.\n+  private int port;", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0746fa6df72e477067a765fd3dc82b18ec465fff", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..e7f49c17e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -163,9 +163,6 @@ final class XdsClientImpl extends XdsClient {\n   // never change. Only a ConfigWatcher or ListenerWatcher can be registered.\n   @Nullable\n   private ConfigWatcher configWatcher;\n-  // The host name portion of \"xds:\" URI that the gRPC client targets for.\n-  @Nullable\n-  private String hostName;\n   // The \"xds:\" URI (including port suffix if present) that the gRPC client targets for.\n   @Nullable\n   private String ldsResourceName;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MTUxNA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387971514", "bodyText": "2020", "author": "creamsoup", "createdAt": "2020-03-04T22:25:04Z", "path": "xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java", "diffHunk": "@@ -0,0 +1,664 @@\n+/*\n+ * Copyright 2019 The gRPC Authors", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0746fa6df72e477067a765fd3dc82b18ec465fff", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java b/xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java\nindex 1c5618777..4a17191b1 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsClientImplTestForListener.java\n\n@@ -632,7 +632,6 @@ public class XdsClientImplTestForListener {\n             .build();\n   }\n \n-  @SuppressWarnings(\"deprecation\")\n   static FilterChain buildFilterChain(FilterChainMatch filterChainMatch,\n                                       DownstreamTlsContext tlsContext, Filter...filters) {\n     return\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MjUxNA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r387972514", "bodyText": "ConfigWatcher error message is not very clear, can you mention only one of them can be set?", "author": "creamsoup", "createdAt": "2020-03-04T22:27:17Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -414,6 +427,39 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);", "originalCommit": "f4c081008900d072be9e480d046977fa8863c29b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0746fa6df72e477067a765fd3dc82b18ec465fff", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 2bcad483d..e7f49c17e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -429,7 +421,7 @@ final class XdsClientImpl extends XdsClient {\n \n   @Override\n   void watchListenerData(int port, ListenerWatcher watcher) {\n-    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", hostName);\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", ldsResourceName);\n     checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n     listenerWatcher = checkNotNull(watcher, \"watcher\");\n     checkState(port > 0, \"port needs to be > 0\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk3OTAxOQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389979019", "bodyText": "nit: checkArgument", "author": "creamsoup", "createdAt": "2020-03-09T21:44:18Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +418,40 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", ldsResourceName);\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkState(port > 0, \"port needs to be > 0\");", "originalCommit": "0d246e558152212be440e7eacd426697972eeec0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 9e2fe2f07..1a810a5d9 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -420,11 +419,12 @@ final class XdsClientImpl extends XdsClient {\n \n   @Override\n   void watchListenerData(int port, ListenerWatcher watcher) {\n-    checkState(configWatcher == null, \"ConfigWatcher for %s already registered\", ldsResourceName);\n+    checkState(configWatcher == null,\n+        \"ListenerWatcher cannot be set when ConfigWatcher set\");\n     checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n     listenerWatcher = checkNotNull(watcher, \"watcher\");\n-    checkState(port > 0, \"port needs to be > 0\");\n-    this.port = port;\n+    checkArgument(port > 0, \"port needs to be > 0\");\n+    this.listenerPort = port;\n     logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n     if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n       // Currently in retry backoff.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDMwNg==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r389980306", "bodyText": "nit: those helper methods can be static", "author": "creamsoup", "createdAt": "2020-03-09T21:47:09Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -605,6 +665,72 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n     }\n   }\n \n+  private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n+    checkState(ldsResourceName == null && port > 0 && listenerWatcher != null,\n+        \"LDS request for ListenerWatcher was never sent!\");\n+\n+    // Unpack Listener messages.\n+    Listener requestedListener = null;\n+    logger.log(XdsLogLevel.DEBUG, \"Listener count: {0}\", ldsResponse.getResourcesCount());\n+    try {\n+      for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        Listener listener = res.unpack(Listener.class);\n+        logger.log(XdsLogLevel.DEBUG, \"Found listener {0}\", listener.toString());\n+        if (isRequestedListener(listener)) {\n+          requestedListener = listener;\n+          logger.log(XdsLogLevel.DEBUG, \"Requested listener found: {0}\", listener.getName());\n+        }\n+      }\n+    } catch (InvalidProtocolBufferException e) {\n+      adsStream.sendNackRequest(ADS_TYPE_URL_LDS, null,\n+          ldsResponse.getVersionInfo(), \"Broken LDS response.\");\n+      return;\n+    }\n+    adsStream.sendAckRequest(ADS_TYPE_URL_LDS, null,\n+        ldsResponse.getVersionInfo());\n+    if (requestedListener != null) {\n+      // Found requestedListener\n+      if (ldsRespTimer != null) {\n+        ldsRespTimer.cancel();\n+        ldsRespTimer = null;\n+      }\n+      ListenerUpdate listenerUpdate = ListenerUpdate.newBuilder()\n+          .setListener(EnvoyServerProtoData.Listener.fromEnvoyProtoListener(requestedListener))\n+          .build();\n+      listenerWatcher.onListenerChanged(listenerUpdate);\n+    } else {\n+      // did not find the requested listener:\n+      if (ldsRespTimer == null) {\n+        listenerWatcher.onError(Status.NOT_FOUND.withDescription(\"did not find listener for \"\n+            + port));\n+      }\n+    }\n+  }\n+\n+  private boolean isRequestedListener(Listener listener) {", "originalCommit": "0d246e558152212be440e7eacd426697972eeec0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNjEzOA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390036138", "bodyText": "both the called helper methods use port which is a member variable. I can pass port and make the method static but...", "author": "sanjaypujare", "createdAt": "2020-03-10T00:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDMwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNjMyNQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390036325", "bodyText": "oh i missed that!", "author": "creamsoup", "createdAt": "2020-03-10T00:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk4MDMwNg=="}], "type": "inlineReview", "revised_code": {"commit": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 9e2fe2f07..1a810a5d9 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -666,7 +674,7 @@ final class XdsClientImpl extends XdsClient {\n   }\n \n   private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n-    checkState(ldsResourceName == null && port > 0 && listenerWatcher != null,\n+    checkState(ldsResourceName == null && listenerPort > 0 && listenerWatcher != null,\n         \"LDS request for ListenerWatcher was never sent!\");\n \n     // Unpack Listener messages.\n"}}, {"oid": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "url": "https://github.com/grpc/grpc-java/commit/2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "message": "address review comments", "committedDate": "2020-03-10T00:45:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTk5OQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390039999", "bodyText": "I am confused about this method. Isn't ldsResourceName always null when XdsClient is used to watch Listener data? Then this should just be an empty list as always. Why do we need this helper method?", "author": "voidzcy", "createdAt": "2020-03-10T00:56:39Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +417,49 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null,\n+        \"ListenerWatcher cannot be set when ConfigWatcher set\");\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkArgument(port > 0, \"port needs to be > 0\");\n+    this.listenerPort = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(ldsResourceName));", "originalCommit": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2OTEwMA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390069100", "bodyText": "In this particular case you are correct: I can just use ImmutableList.of() or Collections.emptyList(). But calls to sendAckRequest and sendNackRequest  used ImmutableList.of(resourceName) which generates NPE when resourceName == null. So I used getListOfResourceNames(ldsResourceName) everywhere.", "author": "sanjaypujare", "createdAt": "2020-03-10T02:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyNjM3OQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390126379", "bodyText": "You can use empty list for sendAckRequest() and sendNackRequest() as well. getListOfResourceNames(ldsResourceName) does not make any sense to my previous implementation.", "author": "voidzcy", "createdAt": "2020-03-10T07:10:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyOTk3OA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390129978", "bodyText": "removed method since only one place really needed it", "author": "sanjaypujare", "createdAt": "2020-03-10T07:22:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzOTk5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 1a810a5d9..fb4df591e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -434,7 +434,7 @@ final class XdsClientImpl extends XdsClient {\n       startRpcStream();\n     }\n     updateNodeMetadataForListenerRequest(port);\n-    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(ldsResourceName));\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of());\n     ldsRespTimer =\n         syncContext\n             .schedule(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyNzI1Nw==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390127257", "bodyText": "nit: include the exception in error message. See line 495.", "author": "voidzcy", "createdAt": "2020-03-10T07:13:16Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -605,6 +673,72 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n     }\n   }\n \n+  private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n+    checkState(ldsResourceName == null && listenerPort > 0 && listenerWatcher != null,\n+        \"LDS request for ListenerWatcher was never sent!\");\n+\n+    // Unpack Listener messages.\n+    Listener requestedListener = null;\n+    logger.log(XdsLogLevel.DEBUG, \"Listener count: {0}\", ldsResponse.getResourcesCount());\n+    try {\n+      for (com.google.protobuf.Any res : ldsResponse.getResourcesList()) {\n+        Listener listener = res.unpack(Listener.class);\n+        logger.log(XdsLogLevel.DEBUG, \"Found listener {0}\", listener.toString());\n+        if (isRequestedListener(listener)) {\n+          requestedListener = listener;\n+          logger.log(XdsLogLevel.DEBUG, \"Requested listener found: {0}\", listener.getName());\n+        }\n+      }\n+    } catch (InvalidProtocolBufferException e) {\n+      adsStream.sendNackRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(null),\n+          ldsResponse.getVersionInfo(), \"Broken LDS response.\");", "originalCommit": "2a23b3c4c1e7264664b64c655297ffaf84dd00d0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 1a810a5d9..fb4df591e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -690,14 +682,15 @@ final class XdsClientImpl extends XdsClient {\n         }\n       }\n     } catch (InvalidProtocolBufferException e) {\n-      adsStream.sendNackRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(null),\n-          ldsResponse.getVersionInfo(), \"Broken LDS response.\");\n+      logger.log(XdsLogLevel.WARNING, \"Failed to unpack Listeners in LDS response {0}\", e);\n+      adsStream.sendNackRequest(\n+          ADS_TYPE_URL_LDS, ImmutableList.<String>of(),\n+          ldsResponse.getVersionInfo(), \"Malformed LDS response: \" + e);\n       return;\n     }\n-    adsStream.sendAckRequest(ADS_TYPE_URL_LDS, getListOfResourceNames(null),\n+    adsStream.sendAckRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of(),\n         ldsResponse.getVersionInfo());\n     if (requestedListener != null) {\n-      // Found requestedListener\n       if (ldsRespTimer != null) {\n         ldsRespTimer.cancel();\n         ldsRespTimer = null;\n"}}, {"oid": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "url": "https://github.com/grpc/grpc-java/commit/8bbf048782d3d9fc430854873b8aff68717ec7ee", "message": "address more review comments", "committedDate": "2020-03-10T15:55:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NzE1Ng==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390457156", "bodyText": "nit: this should be private", "author": "voidzcy", "createdAt": "2020-03-10T16:45:02Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -406,6 +417,41 @@ void cancelEndpointDataWatch(String clusterName, EndpointWatcher watcher) {\n     }\n   }\n \n+  @Override\n+  void watchListenerData(int port, ListenerWatcher watcher) {\n+    checkState(configWatcher == null,\n+        \"ListenerWatcher cannot be set when ConfigWatcher set\");\n+    checkState(listenerWatcher == null, \"ListenerWatcher already registered\");\n+    listenerWatcher = checkNotNull(watcher, \"watcher\");\n+    checkArgument(port > 0, \"port needs to be > 0\");\n+    this.listenerPort = port;\n+    logger.log(XdsLogLevel.INFO, \"Started watching listener for port {0}\", port);\n+    if (rpcRetryTimer != null && rpcRetryTimer.isPending()) {\n+      // Currently in retry backoff.\n+      return;\n+    }\n+    if (adsStream == null) {\n+      startRpcStream();\n+    }\n+    updateNodeMetadataForListenerRequest(port);\n+    adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of());\n+    ldsRespTimer =\n+        syncContext\n+            .schedule(\n+                new ListenerResourceFetchTimeoutTask(\":\" + port),\n+                INITIAL_RESOURCE_FETCH_TIMEOUT_SEC, TimeUnit.SECONDS, timeService);\n+  }\n+\n+  /** In case of Listener watcher metadata to be updated to include port. */\n+  void updateNodeMetadataForListenerRequest(int port) {", "originalCommit": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1OTc4OA==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390459788", "bodyText": "done", "author": "sanjaypujare", "createdAt": "2020-03-10T16:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1NzE1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "fa6df647cc431a373c60db3a57dff3ca7e570913", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex fb4df591e..25a0f1cfb 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -443,7 +443,7 @@ final class XdsClientImpl extends XdsClient {\n   }\n \n   /** In case of Listener watcher metadata to be updated to include port. */\n-  void updateNodeMetadataForListenerRequest(int port) {\n+  private void updateNodeMetadataForListenerRequest(int port) {\n     // TODO(sanjaypujare): fields of metadata to update to be finalized\n     Struct newMetadata = node.getMetadata().toBuilder()\n         .putFields(\"listener_inbound_port\",\n"}}, {"oid": "fa6df647cc431a373c60db3a57dff3ca7e570913", "url": "https://github.com/grpc/grpc-java/commit/fa6df647cc431a373c60db3a57dff3ca7e570913", "message": "address more review comments: make private", "committedDate": "2020-03-10T16:48:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1OTcxNg==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390459716", "bodyText": "Why change this? When configWatcher is not null, ldsResourceName will never be null.", "author": "voidzcy", "createdAt": "2020-03-10T16:48:45Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1021,7 +1147,8 @@ private void handleEdsResponse(DiscoveryResponse edsResponse) {\n     public void run() {\n       startRpcStream();\n       if (configWatcher != null) {\n-        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.of(ldsResourceName));\n+        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ldsResourceName != null", "originalCommit": "8bbf048782d3d9fc430854873b8aff68717ec7ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ2MTkxOQ==", "url": "https://github.com/grpc/grpc-java/pull/6801#discussion_r390461919", "bodyText": "You are right. I should have a separate if clause with listenerWatcher != null and use ListenerResourceFetchTimeoutTask. Will make that change and see if a test is needed", "author": "sanjaypujare", "createdAt": "2020-03-10T16:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1OTcxNg=="}], "type": "inlineReview", "revised_code": {"commit": "fde93b30c2a1d4f47c909accc85a40bf525e0c58", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex fb4df591e..bac3cd3c2 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -1147,14 +1147,21 @@ final class XdsClientImpl extends XdsClient {\n     public void run() {\n       startRpcStream();\n       if (configWatcher != null) {\n-        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ldsResourceName != null\n-            ? ImmutableList.of(ldsResourceName) : ImmutableList.<String>of());\n+        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.of(ldsResourceName));\n         ldsRespTimer =\n             syncContext\n                 .schedule(\n                     new LdsResourceFetchTimeoutTask(ldsResourceName),\n                     INITIAL_RESOURCE_FETCH_TIMEOUT_SEC, TimeUnit.SECONDS, timeService);\n       }\n+      if (listenerWatcher != null) {\n+        adsStream.sendXdsRequest(ADS_TYPE_URL_LDS, ImmutableList.<String>of());\n+        ldsRespTimer =\n+            syncContext\n+                .schedule(\n+                    new ListenerResourceFetchTimeoutTask(\":\" + listenerPort),\n+                    INITIAL_RESOURCE_FETCH_TIMEOUT_SEC, TimeUnit.SECONDS, timeService);\n+      }\n       if (!clusterWatchers.isEmpty()) {\n         adsStream.sendXdsRequest(ADS_TYPE_URL_CDS, clusterWatchers.keySet());\n         for (String clusterName : clusterWatchers.keySet()) {\n"}}, {"oid": "fde93b30c2a1d4f47c909accc85a40bf525e0c58", "url": "https://github.com/grpc/grpc-java/commit/fde93b30c2a1d4f47c909accc85a40bf525e0c58", "message": "address more review comments: more listener specific code", "committedDate": "2020-03-10T23:49:54Z", "type": "commit"}]}