{"pr_number": 6851, "pr_title": "core: copy the SchemaDescriptor when rebuilding descriptor", "pr_createdAt": "2020-03-23T16:43:49Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6851", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwNzUzMQ==", "url": "https://github.com/grpc/grpc-java/pull/6851#discussion_r397407531", "bodyText": "wrappedMethods is never used, and this is causing the CI error.", "author": "zhangkun83", "createdAt": "2020-03-24T19:28:29Z", "path": "api/src/main/java/io/grpc/ServerInterceptors.java", "diffHunk": "@@ -187,13 +187,15 @@ public InputStream parse(final InputStream stream) {\n       wrappedMethods.add(wrapMethod(definition, wrappedMethodDescriptor));", "originalCommit": "3c98d9322cfd0a933e59277e3f4223dd54f3b2fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxMjA1NA==", "url": "https://github.com/grpc/grpc-java/pull/6851#discussion_r397412054", "bodyText": "Look like the earlier for loop should not have been deleted and should occur after serviceBuilder is created (just like before).", "author": "ejona86", "createdAt": "2020-03-24T19:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwNzUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQxODMzNw==", "url": "https://github.com/grpc/grpc-java/pull/6851#discussion_r397418337", "bodyText": "Sorry, not sure what happened--some patching problem on my end. Should look something like this:\n    // Build the new service descriptor\n    final ServiceDescriptor.Builder serviceDescriptorBuilder =\n        ServiceDescriptor.newBuilder(serviceDef.getServiceDescriptor().getName())\n            .setSchemaDescriptor(serviceDef.getServiceDescriptor().getSchemaDescriptor());\n    // Create the new service definition.\n    final ServerServiceDefinition.Builder serviceBuilder =\n        ServerServiceDefinition.builder(serviceDescriptorBuilder.build());\n    for (ServerMethodDefinition<?, ?> definition : wrappedMethods) {\n      serviceBuilder.addMethod(definition);\n    }\n    return serviceBuilder.build();", "author": "herbyderby", "createdAt": "2020-03-24T19:48:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwNzUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM3MzQxMw==", "url": "https://github.com/grpc/grpc-java/pull/6851#discussion_r400373413", "bodyText": "Applied fix.", "author": "zhangkun83", "createdAt": "2020-03-30T17:38:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQwNzUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7537c5df623ced7931b0c1d5279aeffd6ff1c57c", "chunk": "diff --git a/api/src/main/java/io/grpc/ServerInterceptors.java b/api/src/main/java/io/grpc/ServerInterceptors.java\nindex 6d925caee..6110cf9ca 100644\n--- a/api/src/main/java/io/grpc/ServerInterceptors.java\n+++ b/api/src/main/java/io/grpc/ServerInterceptors.java\n\n@@ -196,6 +196,9 @@ public final class ServerInterceptors {\n     // Create the new service definition.\n     final ServerServiceDefinition.Builder serviceBuilder =\n         ServerServiceDefinition.builder(serviceDescriptorBuilder.build());\n+    for (ServerMethodDefinition<?, ?> definition : wrappedMethods) {\n+      serviceBuilder.addMethod(definition);\n+    }\n     return serviceBuilder.build();\n   }\n \n"}}, {"oid": "5f504ec744a008fde6cf018697f4d4e20ae748a2", "url": "https://github.com/grpc/grpc-java/commit/5f504ec744a008fde6cf018697f4d4e20ae748a2", "message": "core: copy the SchemaDescriptor when rebuilding descriptor\n\nuseMarshalledMessages works by duplicating a ServerServiceDefinition while replacing just the marshallers. It currently does not copy over the SchemaDescriptors, which breaks at least the ProtoReflectionService.", "committedDate": "2020-03-30T16:39:49Z", "type": "commit"}, {"oid": "5f504ec744a008fde6cf018697f4d4e20ae748a2", "url": "https://github.com/grpc/grpc-java/commit/5f504ec744a008fde6cf018697f4d4e20ae748a2", "message": "core: copy the SchemaDescriptor when rebuilding descriptor\n\nuseMarshalledMessages works by duplicating a ServerServiceDefinition while replacing just the marshallers. It currently does not copy over the SchemaDescriptors, which breaks at least the ProtoReflectionService.", "committedDate": "2020-03-30T16:39:49Z", "type": "forcePushed"}, {"oid": "7537c5df623ced7931b0c1d5279aeffd6ff1c57c", "url": "https://github.com/grpc/grpc-java/commit/7537c5df623ced7931b0c1d5279aeffd6ff1c57c", "message": "Fix patch error", "committedDate": "2020-03-30T17:37:30Z", "type": "commit"}]}