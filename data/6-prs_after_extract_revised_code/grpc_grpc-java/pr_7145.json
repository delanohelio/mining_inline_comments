{"pr_number": 7145, "pr_title": "xds: replace UpstreamTlsContext with internal definition", "pr_createdAt": "2020-06-19T18:51:32Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7145", "timeline": [{"oid": "124c4646dab24cb622b68f8e08714a8dda2f6967", "url": "https://github.com/grpc/grpc-java/commit/124c4646dab24cb622b68f8e08714a8dda2f6967", "message": "xds: replace UpstreamTlsContext with internal definition", "committedDate": "2020-06-19T18:41:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNjUyNg==", "url": "https://github.com/grpc/grpc-java/pull/7145#discussion_r443026526", "bodyText": "nit: remove", "author": "creamsoup", "createdAt": "2020-06-19T20:15:55Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java", "diffHunk": "@@ -375,4 +419,6 @@ public String toString() {\n           + '}';\n     }\n   }\n+\n+", "originalCommit": "124c4646dab24cb622b68f8e08714a8dda2f6967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ad52c5aec33a877956a516537c5ab22330a3c4d", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java b/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\nindex 827000724..ce8688e6c 100644\n--- a/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\n+++ b/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\n\n@@ -419,6 +419,4 @@ public final class EnvoyServerProtoData {\n           + '}';\n     }\n   }\n-\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNjkwNQ==", "url": "https://github.com/grpc/grpc-java/pull/7145#discussion_r443026905", "bodyText": "nit: indent", "author": "creamsoup", "createdAt": "2020-06-19T20:16:52Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1074,10 +1074,11 @@ private static UpstreamTlsContext getTlsContextFromCluster(Cluster cluster)\n       throws InvalidProtocolBufferException {\n     if (cluster.hasTransportSocket() && \"tls\".equals(cluster.getTransportSocket().getName())) {\n       Any any = cluster.getTransportSocket().getTypedConfig();\n-      return UpstreamTlsContext.parseFrom(any.getValue());\n+      return UpstreamTlsContext.fromEnvoyProtoUpstreamTlsContext(\n+              io.envoyproxy.envoy.api.v2.auth.UpstreamTlsContext.parseFrom(any.getValue()));", "originalCommit": "124c4646dab24cb622b68f8e08714a8dda2f6967", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9ad52c5aec33a877956a516537c5ab22330a3c4d", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex af14bd7f9..30ed4c6a8 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -1075,7 +1075,7 @@ final class XdsClientImpl extends XdsClient {\n     if (cluster.hasTransportSocket() && \"tls\".equals(cluster.getTransportSocket().getName())) {\n       Any any = cluster.getTransportSocket().getTypedConfig();\n       return UpstreamTlsContext.fromEnvoyProtoUpstreamTlsContext(\n-              io.envoyproxy.envoy.api.v2.auth.UpstreamTlsContext.parseFrom(any.getValue()));\n+          io.envoyproxy.envoy.api.v2.auth.UpstreamTlsContext.parseFrom(any.getValue()));\n     }\n     // TODO(sanjaypujare): remove when we move to envoy protos v3\n     return UpstreamTlsContext.fromEnvoyProtoUpstreamTlsContext(cluster.getTlsContext());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzAxNA==", "url": "https://github.com/grpc/grpc-java/pull/7145#discussion_r443027014", "bodyText": "commonTlsContext is nullable?", "author": "creamsoup", "createdAt": "2020-06-19T20:17:14Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java", "diffHunk": "@@ -38,14 +38,60 @@\n   private EnvoyServerProtoData() {\n   }\n \n-  public static final class DownstreamTlsContext {\n+  public abstract static class BaseTlsContext {\n+    protected final CommonTlsContext commonTlsContext;\n+\n+    public BaseTlsContext(CommonTlsContext commonTlsContext) {", "originalCommit": "124c4646dab24cb622b68f8e08714a8dda2f6967", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MjIwMA==", "url": "https://github.com/grpc/grpc-java/pull/7145#discussion_r443072200", "bodyText": "In a later PR I will translate CommonTlsContext to its internal version in which case default instance will be mapped to null and will be nullable but currently it will be non-null. I will mark it nullable. Practically speaking it is an error/bug for the xDS server to include UpstreamTlsContext with a default instance (as explained before).", "author": "sanjaypujare", "createdAt": "2020-06-19T23:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MjQ4OQ==", "url": "https://github.com/grpc/grpc-java/pull/7145#discussion_r443072489", "bodyText": "okay, i left the comment because there are few places checking nullness of commonTlsContext.", "author": "creamsoup", "createdAt": "2020-06-19T23:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyNzAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "9ad52c5aec33a877956a516537c5ab22330a3c4d", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java b/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\nindex 827000724..ce8688e6c 100644\n--- a/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\n+++ b/xds/src/main/java/io/grpc/xds/EnvoyServerProtoData.java\n\n@@ -39,13 +39,13 @@ public final class EnvoyServerProtoData {\n   }\n \n   public abstract static class BaseTlsContext {\n-    protected final CommonTlsContext commonTlsContext;\n+    @Nullable protected final CommonTlsContext commonTlsContext;\n \n-    public BaseTlsContext(CommonTlsContext commonTlsContext) {\n+    public BaseTlsContext(@Nullable CommonTlsContext commonTlsContext) {\n       this.commonTlsContext = commonTlsContext;\n     }\n \n-    public CommonTlsContext getCommonTlsContext() {\n+    @Nullable public CommonTlsContext getCommonTlsContext() {\n       return commonTlsContext;\n     }\n \n"}}, {"oid": "9ad52c5aec33a877956a516537c5ab22330a3c4d", "url": "https://github.com/grpc/grpc-java/commit/9ad52c5aec33a877956a516537c5ab22330a3c4d", "message": "address review comments", "committedDate": "2020-06-19T23:24:55Z", "type": "commit"}]}