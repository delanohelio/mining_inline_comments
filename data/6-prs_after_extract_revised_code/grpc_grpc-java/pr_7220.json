{"pr_number": 7220, "pr_title": "xds: fix DistributorWatcher to send last updates to newly added watchers", "pr_createdAt": "2020-07-16T17:28:20Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7220", "timeline": [{"oid": "3b8ad78781a57d364ac1cb06bcd6a54152fa525b", "url": "https://github.com/grpc/grpc-java/commit/3b8ad78781a57d364ac1cb06bcd6a54152fa525b", "message": "xds: fix DistributorWatcher to send last updates to newly added watchers", "committedDate": "2020-07-16T17:25:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5MDk3MA==", "url": "https://github.com/grpc/grpc-java/pull/7220#discussion_r456590970", "bodyText": "Maybe move the null checks to the public API updateCertificate(PrivateKey key, List<X509Certificate> certChain).", "author": "dapengzhang0", "createdAt": "2020-07-17T17:55:57Z", "path": "xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java", "diffHunk": "@@ -47,33 +49,57 @@\n \n   @VisibleForTesting\n   static final class DistributorWatcher implements Watcher {\n+    private PrivateKey lastKey;\n+    private List<X509Certificate> lastCertChain;\n+    private List<X509Certificate> lastTrustedRoots;\n+\n     @VisibleForTesting\n     final Set<Watcher> downsstreamWatchers = new HashSet<>();\n \n     synchronized void addWatcher(Watcher watcher) {\n       downsstreamWatchers.add(watcher);\n+      if (lastKey != null && lastCertChain != null) {\n+        sendLastCertificateUpdate(watcher);\n+      }\n+      if (lastTrustedRoots != null) {\n+        sendLastTrustedRootsUpdate(watcher);\n+      }\n     }\n \n     synchronized void removeWatcher(Watcher watcher) {\n       downsstreamWatchers.remove(watcher);\n     }\n \n+    private void sendLastCertificateUpdate(Watcher watcher) {\n+      checkNotNull(lastKey, \"lastKey\");\n+      checkNotNull(lastCertChain, \"lastCertChain\");", "originalCommit": "3b8ad78781a57d364ac1cb06bcd6a54152fa525b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxMzc0MA==", "url": "https://github.com/grpc/grpc-java/pull/7220#discussion_r456613740", "bodyText": "done", "author": "sanjaypujare", "createdAt": "2020-07-17T18:43:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU5MDk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "5cdac0da3c5381144464661a8c73770e9c31ad09", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java b/xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java\nindex e2a8846ff..89d695489 100644\n--- a/xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java\n+++ b/xds/src/main/java/io/grpc/xds/internal/certprovider/CertificateProvider.java\n\n@@ -71,18 +71,17 @@ public abstract class CertificateProvider implements Closeable {\n     }\n \n     private void sendLastCertificateUpdate(Watcher watcher) {\n-      checkNotNull(lastKey, \"lastKey\");\n-      checkNotNull(lastCertChain, \"lastCertChain\");\n       watcher.updateCertificate(lastKey, lastCertChain);\n     }\n \n     private void sendLastTrustedRootsUpdate(Watcher watcher) {\n-      checkNotNull(lastTrustedRoots, \"lastTrustedRoots\");\n       watcher.updateTrustedRoots(lastTrustedRoots);\n     }\n \n     @Override\n     public synchronized void updateCertificate(PrivateKey key, List<X509Certificate> certChain) {\n+      checkNotNull(key, \"key\");\n+      checkNotNull(certChain, \"certChain\");\n       lastKey = key;\n       lastCertChain = certChain;\n       for (Watcher watcher : downsstreamWatchers) {\n"}}, {"oid": "5cdac0da3c5381144464661a8c73770e9c31ad09", "url": "https://github.com/grpc/grpc-java/commit/5cdac0da3c5381144464661a8c73770e9c31ad09", "message": "address comments", "committedDate": "2020-07-17T18:42:03Z", "type": "commit"}]}