{"pr_number": 7750, "pr_title": "core: DelayedStream should start() real stream immediately", "pr_createdAt": "2020-12-22T21:00:47Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7750", "timeline": [{"oid": "e8ffac75a220cf46b35c72ac524150612ff593bd", "url": "https://github.com/grpc/grpc-java/commit/e8ffac75a220cf46b35c72ac524150612ff593bd", "message": "core: DelayedStream should start() real stream immediately\n\nDelayedClientTransport needs to avoid becoming terminated while it owns\nRPCs. Previously DelayedClientTransport could terminate when some of its\nRPCs had their realStream but realStream.start() hadn't yet been called.\n\nTo avoid that, we now make sure to call realStream.start()\nsynchronously with setting realStream. Since start() and the method\ncalls before start execute quickly, we can run it in-line. But it does\nmean we now need to split the Stream methods into \"before start\" and\n\"after start\" categories for queuing.\n\nFixes #6283", "committedDate": "2020-12-22T20:55:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUyNDM2MA==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553524360", "bodyText": "Why not use @Nullable or @CheckForNull annotation rather than comment?", "author": "dapengzhang0", "createdAt": "2021-01-07T19:04:25Z", "path": "core/src/main/java/io/grpc/internal/DelayedClientTransport.java", "diffHunk": "@@ -346,7 +344,8 @@ private PendingStream(PickSubchannelArgs args) {\n       this.args = args;\n     }\n \n-    private void createRealStream(ClientTransport transport) {\n+    /** Runnable may be null. */", "originalCommit": "e8ffac75a220cf46b35c72ac524150612ff593bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU0ODM1MQ==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553548351", "bodyText": "All of those are equivalent, and I wouldn't spend any time debating which to use for a private method. If we had a nullness checker such that the annotations weren't just a comment with a different syntax, it would be different.", "author": "ejona86", "createdAt": "2021-01-07T19:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUyNDM2MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUzNzM1MA==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553537350", "bodyText": "Seems listenerToClose must be nonnull here (after adding assertion checkState(listener != null)). delegateToRealStream  == true iff listenerToClose == null as they change value together.", "author": "dapengzhang0", "createdAt": "2021-01-07T19:26:43Z", "path": "core/src/main/java/io/grpc/internal/DelayedStream.java", "diffHunk": "@@ -298,10 +325,11 @@ public void run() {\n         }\n       });\n     } else {\n+      drainPendingCalls();\n       if (listenerToClose != null) {", "originalCommit": "e8ffac75a220cf46b35c72ac524150612ff593bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU1NzIyOA==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553557228", "bodyText": "Yes, listener is non-null and it is copied to listenerToClose only when delegateToRealStream = false. Removed listenerToClose, as there's no longer any synchronization necessary when accessing listener.", "author": "ejona86", "createdAt": "2021-01-07T20:00:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzUzNzM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "2f8cd49816007538331d3ffd5eb03a4e05cc5543", "chunk": "diff --git a/core/src/main/java/io/grpc/internal/DelayedStream.java b/core/src/main/java/io/grpc/internal/DelayedStream.java\nindex c697c0b22..7abd51703 100644\n--- a/core/src/main/java/io/grpc/internal/DelayedStream.java\n+++ b/core/src/main/java/io/grpc/internal/DelayedStream.java\n\n@@ -326,10 +323,8 @@ class DelayedStream implements ClientStream {\n       });\n     } else {\n       drainPendingCalls();\n-      if (listenerToClose != null) {\n-        // Note that listenerToClose is a DelayedStreamListener\n-        listenerToClose.closed(reason, new Metadata());\n-      }\n+      // Note that listener is a DelayedStreamListener\n+      listener.closed(reason, new Metadata());\n     }\n   }\n \n"}}, {"oid": "2f8cd49816007538331d3ffd5eb03a4e05cc5543", "url": "https://github.com/grpc/grpc-java/commit/2f8cd49816007538331d3ffd5eb03a4e05cc5543", "message": "Remove unnecessary listenerToClose variable", "committedDate": "2021-01-07T19:57:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2ODE5MQ==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553568191", "bodyText": "Separate note: there might be a race at delayedClientTransport shutdownNow() to make start() call after cancel(), which may cause shutdownNow fail?", "author": "YifeiZhuang", "createdAt": "2021-01-07T20:23:33Z", "path": "core/src/main/java/io/grpc/internal/DelayedStream.java", "diffHunk": "@@ -306,14 +306,11 @@ public void cancel(final Status reason) {\n     checkState(listener != null, \"May only be called after start\");", "originalCommit": "2f8cd49816007538331d3ffd5eb03a4e05cc5543", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU5NTk5Nw==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553595997", "bodyText": "Yes, shutdownNow() could call cancel() before start() which is now disallowed. Fixing that is not trivial; I'll need to look into a few options.", "author": "ejona86", "createdAt": "2021-01-07T21:21:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2ODE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwODE3Nw==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553608177", "bodyText": "For shutdownNow(), we can do\nAhh, the stream.cancel() in shutdownNow() is wrong usage of ClientStream.cancel() API as its javadoc specifies \"it may only be called after start\"", "author": "dapengzhang0", "createdAt": "2021-01-07T21:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2ODE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzY1NjYzMg==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r553656632", "bodyText": "If we keep reusing cancel() for force shutdown then we can't avoid competing with customer call and there is no way we can guarantee the call order, and we would have to support that. I feel it would be fair to have delayedStream take the responsibility instead of shutdownNow(). Or we use another method to do force shutdown to not mix with cancel(), but that would require same about of change. This problem is originally there so I guess we should fix that separately.", "author": "YifeiZhuang", "createdAt": "2021-01-07T23:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2ODE5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTMzMTA5NQ==", "url": "https://github.com/grpc/grpc-java/pull/7750#discussion_r561331095", "bodyText": "I was wrong. Fixing it was trivial! \"Use setStream() instead of cancel().\" Thank you @YifeiZhuang for noticing.", "author": "ejona86", "createdAt": "2021-01-20T21:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzU2ODE5MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a60d92b85e103907793e7672a8ad015c6021bf7a", "url": "https://github.com/grpc/grpc-java/commit/a60d92b85e103907793e7672a8ad015c6021bf7a", "message": "core: Avoid calling cancel() before start()", "committedDate": "2021-01-20T21:38:26Z", "type": "commit"}]}