{"pr_number": 7677, "pr_title": "all: migrate to interceptor-based config selector", "pr_createdAt": "2020-11-30T23:29:02Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7677", "timeline": [{"oid": "e7a73fa625fb762bcb6586b57285ab29c48eeac7", "url": "https://github.com/grpc/grpc-java/commit/e7a73fa625fb762bcb6586b57285ab29c48eeac7", "message": "all: migrate to interceptor based config selector", "committedDate": "2020-11-30T23:22:40Z", "type": "commit"}, {"oid": "774b39c42bb209c5dac80d7701d87d1027763ace", "url": "https://github.com/grpc/grpc-java/commit/774b39c42bb209c5dac80d7701d87d1027763ace", "message": "move ConfigSelectingClientCall to inner class", "committedDate": "2020-11-30T23:27:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MDY0Mw==", "url": "https://github.com/grpc/grpc-java/pull/7677#discussion_r533990643", "bodyText": "nit: Nullable. But whatever...", "author": "voidzcy", "createdAt": "2020-12-02T08:48:49Z", "path": "xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java", "diffHunk": "@@ -466,15 +464,21 @@ private void assertEmptyResolutionResult() {\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  private static Result assertCallSelectResult(\n+  private Result assertCallSelectResult(\n       CallInfo call, InternalConfigSelector configSelector, String expectedCluster,\n-      double expectedTimeoutSec) {\n+      Double expectedTimeoutSec) {", "originalCommit": "774b39c42bb209c5dac80d7701d87d1027763ace", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f376dd7a1e5bbff94fd3989f8122a9e418a6c4b", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java b/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\nindex 179dae8ab..ca4bcaf2d 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\n\n@@ -466,7 +467,7 @@ public class XdsNameResolverTest {\n   @SuppressWarnings(\"unchecked\")\n   private Result assertCallSelectResult(\n       CallInfo call, InternalConfigSelector configSelector, String expectedCluster,\n-      Double expectedTimeoutSec) {\n+      @Nullable Double expectedTimeoutSec) {\n     Result result = configSelector.selectConfig(\n         new PickSubchannelArgsImpl(call.methodDescriptor, new Metadata(), CallOptions.DEFAULT));\n     assertThat(result.getStatus().isOk()).isTrue();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjYyNw==", "url": "https://github.com/grpc/grpc-java/pull/7677#discussion_r533992627", "bodyText": "Is the return value still needed? If not, we can change it to void. Or it can be changed to return the ClientCall, so that you can get rid of the global testCall. Slightly improves code integrity.", "author": "voidzcy", "createdAt": "2020-12-02T08:52:03Z", "path": "xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java", "diffHunk": "@@ -466,15 +464,21 @@ private void assertEmptyResolutionResult() {\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  private static Result assertCallSelectResult(\n+  private Result assertCallSelectResult(", "originalCommit": "774b39c42bb209c5dac80d7701d87d1027763ace", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTUyODM2Nw==", "url": "https://github.com/grpc/grpc-java/pull/7677#discussion_r535528367", "bodyText": "The return value is used for some assertions following it:\n\n  \n    \n      grpc-java/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\n    \n    \n        Lines 454 to 455\n      in\n      774b39c\n    \n    \n    \n    \n\n        \n          \n           selectResult = assertCallSelectResult(call1, configSelector, cluster1, null); \n        \n\n        \n          \n           assertServiceConfigForMethodConfig(20.0, (Map<String, ?>) selectResult.getConfig()); \n        \n    \n  \n\n\nReturning void makes more sense. Assertion method ideally should not return anything. Unfortunately assertCallSelectResult  is ugly in the sense that it does an action (the config selection) and an assertion for some of the state changes, but is followed by another assertion assertServiceConfigForMethodConfig() for some other state changes in the result of the first assertion method's action. The two assertions should be combined. WDYT?", "author": "dapengzhang0", "createdAt": "2020-12-03T19:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MzYyNA==", "url": "https://github.com/grpc/grpc-java/pull/7677#discussion_r535583624", "bodyText": "Yeah, it is ugly. That's why I was wondering if the returned value is still needed. If you'd like to merge assertCallSelectResult() and assertServiceConfigForMethodConfig(), that would be great (it should be easy, only one test method needs to be cleaned up).", "author": "voidzcy", "createdAt": "2020-12-03T20:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjYyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NjYxNw==", "url": "https://github.com/grpc/grpc-java/pull/7677#discussion_r535586617", "bodyText": "Also, it would be great to rename assertCallSelectResult() to selectConfig(). But whatever, I am fine with leaving it...", "author": "voidzcy", "createdAt": "2020-12-03T20:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5MjYyNw=="}], "type": "inlineReview", "revised_code": {"commit": "1f376dd7a1e5bbff94fd3989f8122a9e418a6c4b", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java b/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\nindex 179dae8ab..ca4bcaf2d 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsNameResolverTest.java\n\n@@ -466,7 +467,7 @@ public class XdsNameResolverTest {\n   @SuppressWarnings(\"unchecked\")\n   private Result assertCallSelectResult(\n       CallInfo call, InternalConfigSelector configSelector, String expectedCluster,\n-      Double expectedTimeoutSec) {\n+      @Nullable Double expectedTimeoutSec) {\n     Result result = configSelector.selectConfig(\n         new PickSubchannelArgsImpl(call.methodDescriptor, new Metadata(), CallOptions.DEFAULT));\n     assertThat(result.getStatus().isOk()).isTrue();\n"}}, {"oid": "1f376dd7a1e5bbff94fd3989f8122a9e418a6c4b", "url": "https://github.com/grpc/grpc-java/commit/1f376dd7a1e5bbff94fd3989f8122a9e418a6c4b", "message": "add @Nullable", "committedDate": "2020-12-03T23:21:42Z", "type": "commit"}, {"oid": "ba40f9d79d4f165f0487cd9103519073aae383a6", "url": "https://github.com/grpc/grpc-java/commit/ba40f9d79d4f165f0487cd9103519073aae383a6", "message": "merge two assertion methods to one", "committedDate": "2020-12-03T23:36:56Z", "type": "commit"}]}