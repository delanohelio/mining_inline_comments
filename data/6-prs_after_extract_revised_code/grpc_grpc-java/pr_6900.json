{"pr_number": 6900, "pr_title": "stub: add Blocking StubType to blocking ClientCalls methods.", "pr_createdAt": "2020-04-03T21:22:26Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6900", "timeline": [{"oid": "56ffea84e8e78887588673ca97f5e6564e35a057", "url": "https://github.com/grpc/grpc-java/commit/56ffea84e8e78887588673ca97f5e6564e35a057", "message": "stub: add Blocking StubType to blocking ClientCalls methods.", "committedDate": "2020-04-03T21:19:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5MDU4Nw==", "url": "https://github.com/grpc/grpc-java/pull/6900#discussion_r403390587", "bodyText": "unaryBlockingCallFailed() uses a NoopClientCall that calls listener.onClose() in its start(). That is closer to the reality. We should also keep the same style throughout a file.", "author": "zhangkun83", "createdAt": "2020-04-04T00:04:07Z", "path": "stub/src/test/java/io/grpc/stub/ClientCallsTest.java", "diffHunk": "@@ -203,6 +220,48 @@ public void blockingUnaryCall2_interruptedWaitsForOnClose() throws Exception {\n     assertTrue(\"context not cancelled\", methodImpl.observer.isCancelled());\n   }\n \n+  @Test\n+  public void blockingUnaryCall_HasBlockingStubType() {\n+    when(mockChannel.newCall(\n+        ArgumentMatchers.<MethodDescriptor<Integer, Integer>>any(), any(CallOptions.class)))\n+        .thenReturn(mockClientCall);\n+    // we only interested in the call options, stop the call by thrown.\n+    doThrow(new RuntimeException(\"intended\")).when(mockClientCall).sendMessage(any(Integer.class));", "originalCommit": "56ffea84e8e78887588673ca97f5e6564e35a057", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzQxMDkzMg==", "url": "https://github.com/grpc/grpc-java/pull/6900#discussion_r403410932", "bodyText": "Done.", "author": "ran-su", "createdAt": "2020-04-04T02:19:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5MDU4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c6f2976f469950d0f45b3a611a614d1879da22a3", "chunk": "diff --git a/stub/src/test/java/io/grpc/stub/ClientCallsTest.java b/stub/src/test/java/io/grpc/stub/ClientCallsTest.java\nindex 892cb24ed..b33b94c26 100644\n--- a/stub/src/test/java/io/grpc/stub/ClientCallsTest.java\n+++ b/stub/src/test/java/io/grpc/stub/ClientCallsTest.java\n\n@@ -222,18 +219,19 @@ public class ClientCallsTest {\n \n   @Test\n   public void blockingUnaryCall_HasBlockingStubType() {\n+    NoopClientCall<Integer, Integer> call = new NoopClientCall<Integer, Integer>() {\n+      @Override\n+      public void start(io.grpc.ClientCall.Listener<Integer> listener, Metadata headers) {\n+        listener.onMessage(1);\n+        listener.onClose(Status.OK, new Metadata());\n+      }\n+    };\n     when(mockChannel.newCall(\n         ArgumentMatchers.<MethodDescriptor<Integer, Integer>>any(), any(CallOptions.class)))\n-        .thenReturn(mockClientCall);\n-    // we only interested in the call options, stop the call by thrown.\n-    doThrow(new RuntimeException(\"intended\")).when(mockClientCall).sendMessage(any(Integer.class));\n-    try {\n-      Integer unused =\n-          ClientCalls.blockingUnaryCall(mockChannel, UNARY_METHOD, CallOptions.DEFAULT, 1);\n-      fail();\n-    } catch (RuntimeException e) {\n-      assertThat(e).hasMessageThat().isEqualTo(\"intended\");\n-    }\n+        .thenReturn(call);\n+\n+    Integer unused =\n+        ClientCalls.blockingUnaryCall(mockChannel, UNARY_METHOD, CallOptions.DEFAULT, 1);\n \n     verify(mockChannel).newCall(methodDescriptorCaptor.capture(), callOptionsCaptor.capture());\n     CallOptions capturedCallOption = callOptionsCaptor.getValue();\n"}}, {"oid": "c6f2976f469950d0f45b3a611a614d1879da22a3", "url": "https://github.com/grpc/grpc-java/commit/c6f2976f469950d0f45b3a611a614d1879da22a3", "message": "use noop clientCall instead of mock.", "committedDate": "2020-04-04T01:45:28Z", "type": "commit"}]}