{"pr_number": 6949, "pr_title": "okhttp: Skip enabling SNI and session ticket for fake/test host names", "pr_createdAt": "2020-04-20T19:27:50Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6949", "timeline": [{"oid": "a296276f6ccb6e34ffd4879e9fad22aaadd51845", "url": "https://github.com/grpc/grpc-java/commit/a296276f6ccb6e34ffd4879e9fad22aaadd51845", "message": "Do not enable SNI and session ticket when hostname is invalid (under test environment).", "committedDate": "2020-04-20T19:26:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNjE4Ng==", "url": "https://github.com/grpc/grpc-java/pull/6949#discussion_r411636186", "bodyText": "Hmmm, don't like the idea of adding \"special\" code/workaround in main code to make tests pass. Why not modify test certs so they don't need special handling in mainline code?", "author": "sanjaypujare", "createdAt": "2020-04-20T19:32:21Z", "path": "okhttp/src/main/java/io/grpc/okhttp/OkHttpProtocolNegotiator.java", "diffHunk": "@@ -235,7 +236,9 @@ protected void configureTlsExtensions(\n       SSLParameters sslParams = sslSocket.getSSLParameters();\n       try {\n         // Enable SNI and session tickets.\n-        if (hostname != null) {\n+        // Skip if hostname is not a real internet domain name, which is usually used with\n+        // test certificates.", "originalCommit": "a296276f6ccb6e34ffd4879e9fad22aaadd51845", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY0MTY5OQ==", "url": "https://github.com/grpc/grpc-java/pull/6949#discussion_r411641699", "bodyText": "Details in b/154375837. According to @ejona86, changing those test certs seems to be hard and we compromise to work them around.", "author": "voidzcy", "createdAt": "2020-04-20T19:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNjE4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTczNTkwNw==", "url": "https://github.com/grpc/grpc-java/pull/6949#discussion_r411735907", "bodyText": "FWIW, SunJSSE ignores SNI if it is invalid (at least in some ways): #4912 (comment) .\nWhile I could potentially agree using IDN is a good idea, it is a bit more subtle of a change. How would you feel about calling GrpcUtil.checkAuthority() (with try/catch) here instead? Then we could say that checkAuthority is normally performed in the builder so it should virtually always succeed. We then reference the bug id, and say we are working around cases where checkAuthority is disabled and we want to avoid them causing trouble here. We can also mention that underscore is the troublesome character.\nDoing it that way makes it much more obvious this changes no behavior change for most users and makes it more obvious if/when it is no longer needed (e.g., because the broken certs have been replaced).", "author": "ejona86", "createdAt": "2020-04-20T22:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTYzNjE4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6b9d8e7ac7343b776501ed66805402c73f252252", "chunk": "diff --git a/okhttp/src/main/java/io/grpc/okhttp/OkHttpProtocolNegotiator.java b/okhttp/src/main/java/io/grpc/okhttp/OkHttpProtocolNegotiator.java\nindex 391cabee3..544367554 100644\n--- a/okhttp/src/main/java/io/grpc/okhttp/OkHttpProtocolNegotiator.java\n+++ b/okhttp/src/main/java/io/grpc/okhttp/OkHttpProtocolNegotiator.java\n\n@@ -236,9 +236,11 @@ class OkHttpProtocolNegotiator {\n       SSLParameters sslParams = sslSocket.getSSLParameters();\n       try {\n         // Enable SNI and session tickets.\n-        // Skip if hostname is not a real internet domain name, which is usually used with\n-        // test certificates.\n-        if (hostname != null && isValidDomainName(hostname)) {\n+        // Hostname is normally validated in the builder (see checkAuthority) and it should\n+        // virtually always succeed. Check again here to avoid troubles (e.g., hostname with\n+        // underscore) enabling SNI, which works around cases where checkAuthority is disabled.\n+        // See b/154375837.\n+        if (hostname != null && isValidHostName(hostname)) {\n           if (SSL_SOCKETS_IS_SUPPORTED_SOCKET != null\n               && (boolean) SSL_SOCKETS_IS_SUPPORTED_SOCKET.invoke(null, sslSocket)) {\n             SSL_SOCKETS_SET_USE_SESSION_TICKET.invoke(null, sslSocket, true);\n"}}, {"oid": "6b9d8e7ac7343b776501ed66805402c73f252252", "url": "https://github.com/grpc/grpc-java/commit/6b9d8e7ac7343b776501ed66805402c73f252252", "message": "Use GrpcUtil.checkAuthority for hostname validation.", "committedDate": "2020-04-20T23:26:43Z", "type": "commit"}]}