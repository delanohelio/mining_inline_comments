{"pr_number": 7630, "pr_title": "alts: create handshaker RPC lazily", "pr_createdAt": "2020-11-17T05:05:10Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7630", "timeline": [{"oid": "d20c4be2288a30cc18460a6b11c04c665d23c60e", "url": "https://github.com/grpc/grpc-java/commit/d20c4be2288a30cc18460a6b11c04c665d23c60e", "message": "alts: create handshaker RPC lazily", "committedDate": "2020-11-17T05:00:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ5MjQ2NA==", "url": "https://github.com/grpc/grpc-java/pull/7630#discussion_r525492464", "bodyText": "Delete this line. It does nothing. Initialization is only required for final fields. Other fields default to 0/null. Ditto below.", "author": "ejona86", "createdAt": "2020-11-17T20:22:48Z", "path": "alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java", "diffHunk": "@@ -29,28 +29,29 @@\n /** An interface to the ALTS handshaker service. */\n class AltsHandshakerStub {\n   private final StreamObserver<HandshakerResp> reader = new Reader();\n-  private final StreamObserver<HandshakerReq> writer;\n+  private StreamObserver<HandshakerReq> writer;\n+  private final HandshakerServiceStub serviceStub;\n   private final ArrayBlockingQueue<Optional<HandshakerResp>> responseQueue =\n       new ArrayBlockingQueue<>(1);\n   private final AtomicReference<String> exceptionMessage = new AtomicReference<>();\n \n   private static final long HANDSHAKE_RPC_DEADLINE_SECS = 20;\n \n   AltsHandshakerStub(HandshakerServiceStub serviceStub) {\n-    this.writer =\n-        serviceStub\n-            .withDeadlineAfter(HANDSHAKE_RPC_DEADLINE_SECS, SECONDS)\n-            .doHandshake(this.reader);\n+    writer = null;", "originalCommit": "d20c4be2288a30cc18460a6b11c04c665d23c60e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f15738da65d579c36e92344a7f036d8b833efa27", "chunk": "diff --git a/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java b/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\nindex 1a48cd5ee..61d9fd2f8 100644\n--- a/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\n+++ b/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\n\n@@ -38,13 +38,11 @@ class AltsHandshakerStub {\n   private static final long HANDSHAKE_RPC_DEADLINE_SECS = 20;\n \n   AltsHandshakerStub(HandshakerServiceStub serviceStub) {\n-    writer = null;\n     this.serviceStub = serviceStub;\n   }\n \n   @VisibleForTesting\n   AltsHandshakerStub() {\n-    writer = null;\n     serviceStub = null;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ5NDQ0Mw==", "url": "https://github.com/grpc/grpc-java/pull/7630#discussion_r525494443", "bodyText": "Why is this synchronized? I don't think this class can be used from multiple callers/threads.", "author": "ejona86", "createdAt": "2020-11-17T20:24:23Z", "path": "alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java", "diffHunk": "@@ -72,6 +74,14 @@ public HandshakerResp send(HandshakerReq req) throws InterruptedException, IOExc\n     return result.get();\n   }\n \n+  /** Create a new writer if the writer is null. */\n+  private synchronized void createWriterIfNull() {", "originalCommit": "d20c4be2288a30cc18460a6b11c04c665d23c60e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5OTA1MQ==", "url": "https://github.com/grpc/grpc-java/pull/7630#discussion_r525599051", "bodyText": "You are right. I was just being cautious :)  synchronized removed.", "author": "jiangtaoli2016", "createdAt": "2020-11-17T23:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ5NDQ0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f15738da65d579c36e92344a7f036d8b833efa27", "chunk": "diff --git a/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java b/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\nindex 1a48cd5ee..61d9fd2f8 100644\n--- a/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\n+++ b/alts/src/main/java/io/grpc/alts/internal/AltsHandshakerStub.java\n\n@@ -75,7 +73,7 @@ class AltsHandshakerStub {\n   }\n \n   /** Create a new writer if the writer is null. */\n-  private synchronized void createWriterIfNull() {\n+  private void createWriterIfNull() {\n     if (writer == null) {\n       writer =\n           serviceStub.withDeadlineAfter(HANDSHAKE_RPC_DEADLINE_SECS, SECONDS).doHandshake(reader);\n"}}, {"oid": "f15738da65d579c36e92344a7f036d8b833efa27", "url": "https://github.com/grpc/grpc-java/commit/f15738da65d579c36e92344a7f036d8b833efa27", "message": "alts: address review comments", "committedDate": "2020-11-17T23:41:20Z", "type": "commit"}]}