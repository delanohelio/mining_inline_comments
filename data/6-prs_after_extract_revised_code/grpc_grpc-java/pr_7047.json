{"pr_number": 7047, "pr_title": "xds: change route data validation logic", "pr_createdAt": "2020-05-18T21:42:02Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7047", "timeline": [{"oid": "f0de162208032fc0a9b6aa1dbbd9b23e44c9bf01", "url": "https://github.com/grpc/grpc-java/commit/f0de162208032fc0a9b6aa1dbbd9b23e44c9bf01", "message": "Routes with action that specifies cluster_header should be skipped.", "committedDate": "2020-05-18T21:20:39Z", "type": "commit"}, {"oid": "e4239350f374286d117743c7103f87a17c170a4c", "url": "https://github.com/grpc/grpc-java/commit/e4239350f374286d117743c7103f87a17c170a4c", "message": "Eliminate unnecessary validation logic in XdsClientImpl, they are already covered in converters.", "committedDate": "2020-05-18T21:38:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTM1MA==", "url": "https://github.com/grpc/grpc-java/pull/7047#discussion_r426909350", "bodyText": "Justification: The converted object EnvoyProtoData.Route is guaranteed to have one of cluster or weighted_cluster set. So this logic is redundant here.", "author": "voidzcy", "createdAt": "2020-05-18T21:43:18Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -864,30 +864,10 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n           \"Virtual host [\" + virtualHost.getName()\n               + \"] contains non-default route as the last route\");\n     }\n-    // We only validate the default route unless path matching is enabled.\n     if (!enableExperimentalRouting) {\n       EnvoyProtoData.Route defaultRoute = Iterables.getLast(routes);\n-      if (defaultRoute.getRouteAction().getCluster() == null) {\n-        throw new InvalidProtoDataException(\n-            \"Virtual host [\" + virtualHost.getName()\n-                + \"] default route contains no cluster name\");\n-      }\n       return Collections.singletonList(defaultRoute);\n     }\n-\n-    // We do more validation if path matching is enabled, but whether every single route is\n-    // required to be valid for grpc is TBD.\n-    // For now we consider the whole list invalid if anything invalid for grpc is found.\n-    // TODO(zdapeng): Fix it if the decision is different from current implementation.\n-    // TODO(zdapeng): Add test for validation.\n-    for (EnvoyProtoData.Route route : routes) {", "originalCommit": "e4239350f374286d117743c7103f87a17c170a4c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTUyOQ==", "url": "https://github.com/grpc/grpc-java/pull/7047#discussion_r426909529", "bodyText": "No longer require the default route to have cluster as the cluster_specifier.", "author": "voidzcy", "createdAt": "2020-05-18T21:43:50Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -864,30 +864,10 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n           \"Virtual host [\" + virtualHost.getName()\n               + \"] contains non-default route as the last route\");\n     }\n-    // We only validate the default route unless path matching is enabled.\n     if (!enableExperimentalRouting) {\n       EnvoyProtoData.Route defaultRoute = Iterables.getLast(routes);\n-      if (defaultRoute.getRouteAction().getCluster() == null) {", "originalCommit": "e4239350f374286d117743c7103f87a17c170a4c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}