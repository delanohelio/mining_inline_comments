{"pr_number": 6654, "pr_title": "xds: print xDS responses nicely with protobuf JsonFormat", "pr_createdAt": "2020-01-28T21:50:12Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6654", "timeline": [{"oid": "30e307706f8c10b7e5ce2f58aae6bcd79071f240", "url": "https://github.com/grpc/grpc-java/commit/30e307706f8c10b7e5ce2f58aae6bcd79071f240", "message": "Print xDS responses nicely with protobuf JsonFormat.", "committedDate": "2020-01-28T21:49:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyOTk3Mw==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372129973", "bodyText": "This language will be a bit confusing in the logs. Maybe something closer to: message + \" (failed to pretty-print: \" + e + \")\"", "author": "ejona86", "createdAt": "2020-01-29T00:15:20Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -1360,4 +1364,37 @@ static boolean matchHostName(String hostName, String pattern) {\n     return index == pattern.length() - 1\n         && hostName.startsWith(pattern.substring(0, pattern.length() - 1));\n   }\n+\n+  /**\n+   * Convert protobuf message to human readable String format. Useful for protobuf messages\n+   * containing {@link com.google.protobuf.Any} fields.\n+   */\n+  @VisibleForTesting\n+  static class MessagePrinter {\n+    private final JsonFormat.Printer printer;\n+\n+    @VisibleForTesting\n+    MessagePrinter() {\n+      com.google.protobuf.TypeRegistry registry =\n+          com.google.protobuf.TypeRegistry.newBuilder()\n+              .add(Listener.getDescriptor())\n+              .add(HttpConnectionManager.getDescriptor())\n+              .add(RouteConfiguration.getDescriptor())\n+              .add(Cluster.getDescriptor())\n+              .add(ClusterLoadAssignment.getDescriptor())\n+              .build();\n+      printer = JsonFormat.printer().usingTypeRegistry(registry);\n+    }\n+\n+    @VisibleForTesting\n+    String print(MessageOrBuilder message) {\n+      String res;\n+      try {\n+        res = printer.print(message);\n+      } catch (InvalidProtocolBufferException e) {\n+        res = \"Failed to convert message [\" + message + \"] to readable String. Reason: \" + e;", "originalCommit": "30e307706f8c10b7e5ce2f58aae6bcd79071f240", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMjExMw==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372132113", "bodyText": "Changed. Thanks for the suggestion.", "author": "voidzcy", "createdAt": "2020-01-29T00:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyOTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEzMjkzNg==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372132936", "bodyText": "Why not just return message.toString()? And the error will happen again and can be logged in sendNackRequest() in error detail \"Broken LDS response.  \" + e", "author": "dapengzhang0", "createdAt": "2020-01-29T00:26:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyOTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE0MTc0OQ==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372141749", "bodyText": "That would cause confusion when seeing raw bytes (\"why does formatting not work?\"). So it would be better to indicate errors.\nAlso, implementations should be modularized, methods should define what they are doing without making assumptions for what callers will do for things they do not.", "author": "voidzcy", "createdAt": "2020-01-29T01:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEyOTk3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2205850ff8e6fc714959c0f67300853f1379d3de", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex ada32c286..1cd133fa9 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -1392,7 +1392,7 @@ final class XdsClientImpl extends XdsClient {\n       try {\n         res = printer.print(message);\n       } catch (InvalidProtocolBufferException e) {\n-        res = \"Failed to convert message [\" + message + \"] to readable String. Reason: \" + e;\n+        res = message + \" (failed to pretty-print: \" + e + \")\";\n       }\n       return res;\n     }\n"}}, {"oid": "2205850ff8e6fc714959c0f67300853f1379d3de", "url": "https://github.com/grpc/grpc-java/commit/2205850ff8e6fc714959c0f67300853f1379d3de", "message": "Rephrase error message for conversion failure.", "committedDate": "2020-01-29T00:23:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3MjgxMA==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372172810", "bodyText": "Because respPrinter.print() is heavy, check isLoggable first. Otherwise LGTM.\nif (logger.isLoggable(Level.FINE)) {\n  logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));\n}", "author": "dapengzhang0", "createdAt": "2020-01-29T03:25:29Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -569,7 +573,7 @@ private void handleLdsResponse(DiscoveryResponse ldsResponse) {\n    * invalid data for gRPC's usage. Otherwise, an ACK request is sent to management server.\n    */\n   private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n-    logger.log(Level.FINE, \"Received an RDS response: {0}\", rdsResponse);\n+    logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));", "originalCommit": "2205850ff8e6fc714959c0f67300853f1379d3de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI1OTgwNw==", "url": "https://github.com/grpc/grpc-java/pull/6654#discussion_r372259807", "bodyText": "Sure, change. Btw, I will be working on improving general xDS logging and the logging mechanism will be changed. This PR mainly implements the proto printer, which is needed anyway.", "author": "voidzcy", "createdAt": "2020-01-29T09:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3MjgxMA=="}], "type": "inlineReview", "revised_code": {"commit": "8834a5e3c071a54f74eb29d5e7302d0afc36e238", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex 1cd133fa9..2e0043ca5 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -573,7 +575,9 @@ final class XdsClientImpl extends XdsClient {\n    * invalid data for gRPC's usage. Otherwise, an ACK request is sent to management server.\n    */\n   private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n-    logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));\n+    if (logger.isLoggable(Level.FINE)) {\n+      logger.log(Level.FINE, \"Received an RDS response: {0}\", respPrinter.print(rdsResponse));\n+    }\n     checkState(adsStream.rdsResourceName != null,\n         \"Never requested for RDS resources, management server is doing something wrong\");\n \n"}}, {"oid": "8834a5e3c071a54f74eb29d5e7302d0afc36e238", "url": "https://github.com/grpc/grpc-java/commit/8834a5e3c071a54f74eb29d5e7302d0afc36e238", "message": "Only log response messages when log level is FINE.", "committedDate": "2020-01-29T08:58:43Z", "type": "commit"}]}