{"pr_number": 6742, "pr_title": "okhttp: fix incorrect connection-level flow control handling at beginning of connection", "pr_createdAt": "2020-02-22T00:17:47Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6742", "timeline": [{"oid": "ea6a6d02ee02f52efad50267986867a1ba67c3c5", "url": "https://github.com/grpc/grpc-java/commit/ea6a6d02ee02f52efad50267986867a1ba67c3c5", "message": "okhttp: fix incorrect initial size of outbound flow control window", "committedDate": "2020-02-25T02:04:17Z", "type": "commit"}, {"oid": "22eb66e47ec54a0dc134b64ffc66fff66ebc171d", "url": "https://github.com/grpc/grpc-java/commit/22eb66e47ec54a0dc134b64ffc66fff66ebc171d", "message": "okhttp: fix incorrect initial size of outbound flow control window", "committedDate": "2020-02-25T02:04:22Z", "type": "commit"}, {"oid": "aac0867923badf9bdd92d68e339f13d11441baa9", "url": "https://github.com/grpc/grpc-java/commit/aac0867923badf9bdd92d68e339f13d11441baa9", "message": "okhttp: simplify OutboundFlowController constructor", "committedDate": "2020-02-25T02:04:30Z", "type": "commit"}, {"oid": "14ada64ab0cfb69dca0117a5a9122e2035766c88", "url": "https://github.com/grpc/grpc-java/commit/14ada64ab0cfb69dca0117a5a9122e2035766c88", "message": "okhttp: unit tests for outbound flow control window changes", "committedDate": "2020-02-25T02:04:42Z", "type": "commit"}, {"oid": "8da35397b0ece339398edc2dec5043c3b09216eb", "url": "https://github.com/grpc/grpc-java/commit/8da35397b0ece339398edc2dec5043c3b09216eb", "message": "okhttp: unit testing sending initialWindowSize in settings", "committedDate": "2020-02-25T02:04:50Z", "type": "commit"}, {"oid": "8da35397b0ece339398edc2dec5043c3b09216eb", "url": "https://github.com/grpc/grpc-java/commit/8da35397b0ece339398edc2dec5043c3b09216eb", "message": "okhttp: unit testing sending initialWindowSize in settings", "committedDate": "2020-02-25T02:04:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwOTc0OA==", "url": "https://github.com/grpc/grpc-java/pull/6742#discussion_r383609748", "bodyText": "I think these three tests should still be around. They are trying to test that the outbound flow controller observes the flow control given to it. Since passing windowSize to startTransport() no longer works, these need to get something like frameHandler().settings(false, new Settings()); (but with the INITIAL_WINDOW_SIZE set to windowSize) to change the window size available.", "author": "ejona86", "createdAt": "2020-02-25T01:22:18Z", "path": "okhttp/src/test/java/io/grpc/okhttp/OkHttpClientTransportTest.java", "diffHunk": "@@ -838,37 +868,34 @@ public void windowUpdateWithInboundFlowControl() throws Exception {\n \n   @Test\n   public void outboundFlowControl() throws Exception {\n-    outboundFlowControl(INITIAL_WINDOW_SIZE);", "originalCommit": "2fd5b206ff9d981ff63265678a60735781b0c0d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyNDkxMA==", "url": "https://github.com/grpc/grpc-java/pull/6742#discussion_r384824910", "bodyText": "Done. I initially thought those cases were already covered by outboundFlowControlWithInitialWindowSizeChange(), but realized it wasn't testing where the initial window size is changed before the stream is started.", "author": "chrisschek", "createdAt": "2020-02-26T23:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYwOTc0OA=="}], "type": "inlineReview", "revised_code": {"commit": "ea6a6d02ee02f52efad50267986867a1ba67c3c5", "chunk": "diff --git a/okhttp/src/test/java/io/grpc/okhttp/OkHttpClientTransportTest.java b/okhttp/src/test/java/io/grpc/okhttp/OkHttpClientTransportTest.java\nindex 091105efd..769d0097f 100644\n--- a/okhttp/src/test/java/io/grpc/okhttp/OkHttpClientTransportTest.java\n+++ b/okhttp/src/test/java/io/grpc/okhttp/OkHttpClientTransportTest.java\n\n@@ -868,34 +838,37 @@ public class OkHttpClientTransportTest {\n \n   @Test\n   public void outboundFlowControl() throws Exception {\n-    initTransport();\n+    outboundFlowControl(INITIAL_WINDOW_SIZE);\n+  }\n+\n+  private void outboundFlowControl(int windowSize) throws Exception {\n+    startTransport(\n+        DEFAULT_START_STREAM_ID, null, true, DEFAULT_MAX_MESSAGE_SIZE, windowSize, null);\n     MockStreamListener listener = new MockStreamListener();\n     OkHttpClientStream stream =\n         clientTransport.newStream(method, new Metadata(), CallOptions.DEFAULT);\n     stream.start(listener);\n-\n-    // Outbound window always starts at 65535 until changed by Settings.INITIAL_WINDOW_SIZE\n-    int initialOutboundWindowSize = 65535;\n-    int messageLength = initialOutboundWindowSize / 2 + 1;\n-\n     // The first message should be sent out.\n+    int messageLength = windowSize / 2 + 1;\n     InputStream input = new ByteArrayInputStream(new byte[messageLength]);\n     stream.writeMessage(input);\n     stream.flush();\n     verify(frameWriter, timeout(TIME_OUT_MS)).data(\n         eq(false), eq(3), any(Buffer.class), eq(messageLength + HEADER_LENGTH));\n \n+\n     // The second message should be partially sent out.\n     input = new ByteArrayInputStream(new byte[messageLength]);\n     stream.writeMessage(input);\n     stream.flush();\n-    int partiallySentSize = initialOutboundWindowSize - messageLength - HEADER_LENGTH;\n+    int partiallySentSize =\n+        windowSize - messageLength - HEADER_LENGTH;\n     verify(frameWriter, timeout(TIME_OUT_MS))\n         .data(eq(false), eq(3), any(Buffer.class), eq(partiallySentSize));\n \n     // Get more credit, the rest data should be sent out.\n-    frameHandler().windowUpdate(3, initialOutboundWindowSize);\n-    frameHandler().windowUpdate(0, initialOutboundWindowSize);\n+    frameHandler().windowUpdate(3, windowSize);\n+    frameHandler().windowUpdate(0, windowSize);\n     verify(frameWriter, timeout(TIME_OUT_MS)).data(\n         eq(false), eq(3), any(Buffer.class),\n         eq(messageLength + HEADER_LENGTH - partiallySentSize));\n"}}, {"oid": "671dd3319335668adc439a99a590a21c29aa7ba3", "url": "https://github.com/grpc/grpc-java/commit/671dd3319335668adc439a99a590a21c29aa7ba3", "message": "okhttp: restore test cases for outboundFlowControl big/small window size", "committedDate": "2020-02-26T23:53:14Z", "type": "commit"}, {"oid": "671dd3319335668adc439a99a590a21c29aa7ba3", "url": "https://github.com/grpc/grpc-java/commit/671dd3319335668adc439a99a590a21c29aa7ba3", "message": "okhttp: restore test cases for outboundFlowControl big/small window size", "committedDate": "2020-02-26T23:53:14Z", "type": "forcePushed"}]}