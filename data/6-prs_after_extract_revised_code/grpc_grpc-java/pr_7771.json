{"pr_number": 7771, "pr_title": "Log expected STREAM_CLOSED exceptions for already closed streams at FINE level", "pr_createdAt": "2020-12-30T14:56:21Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7771", "timeline": [{"oid": "bb739ac0d63eafccf872e03b054db590c493b0e5", "url": "https://github.com/grpc/grpc-java/commit/bb739ac0d63eafccf872e03b054db590c493b0e5", "message": "change logging level to finer", "committedDate": "2020-12-30T14:49:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIxMTI5Ng==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r555211296", "bodyText": "Do we need a null check for http2Ex or are you sure it will never be null in this context?", "author": "sanjaypujare", "createdAt": "2021-01-11T17:18:42Z", "path": "netty/src/main/java/io/grpc/netty/NettyServerHandler.java", "diffHunk": "@@ -532,7 +532,8 @@ protected void onConnectionError(ChannelHandlerContext ctx, boolean outbound, Th\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n-    logger.log(Level.WARNING, \"Stream Error\", cause);\n+    Level level = http2Ex.error() == Http2Error.STREAM_CLOSED ? Level.FINE : Level.WARNING;", "originalCommit": "bb739ac0d63eafccf872e03b054db590c493b0e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI4Njg5OQ==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r555286899", "bodyText": "It shouldn't be null. Netty doesn't guarantee that all that well, but Netty itself assumes it is non-null and there's no reason for it to be null.", "author": "ejona86", "createdAt": "2021-01-11T19:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIxMTI5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c22a9ddeadf19c116c2eb6798eba62add94ebf3e", "chunk": "diff --git a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\nindex b45d3662b..e95770e88 100644\n--- a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n+++ b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n\n@@ -532,7 +532,10 @@ class NettyServerHandler extends AbstractNettyHandler {\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n-    Level level = http2Ex.error() == Http2Error.STREAM_CLOSED ? Level.FINE : Level.WARNING;\n+    Level level = Level.WARNING;\n+    if (serverStream == null && http2Ex.error() == Http2Error.STREAM_CLOSED) {\n+      level = Level.FINE;\n+    }\n     logger.log(level, \"Stream Error\", cause);\n     NettyServerStream.TransportState serverStream = serverStream(\n         connection().stream(Http2Exception.streamId(http2Ex)));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQzNDE5Mg==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r566434192", "bodyText": "Let's use FINE only if serverStream == null as well. Really, connection().stream(Http2Exception.streamId(http2Ex)) == null is the more precise check, but serverStream == null is pretty close and is easy, and I don't think will mislead readers.", "author": "ejona86", "createdAt": "2021-01-28T21:56:42Z", "path": "netty/src/main/java/io/grpc/netty/NettyServerHandler.java", "diffHunk": "@@ -532,7 +532,8 @@ protected void onConnectionError(ChannelHandlerContext ctx, boolean outbound, Th\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n-    logger.log(Level.WARNING, \"Stream Error\", cause);\n+    Level level = http2Ex.error() == Http2Error.STREAM_CLOSED ? Level.FINE : Level.WARNING;", "originalCommit": "bb739ac0d63eafccf872e03b054db590c493b0e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc1NTM3MQ==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r566755371", "bodyText": "Do you mean changing the condition to serverStream == null && http2Ex.error() == Http2Error.STREAM_CLOSED?", "author": "lriuui0x0", "createdAt": "2021-01-29T11:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQzNDE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njk3NzM4NQ==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r566977385", "bodyText": "Yes, effectively. And the logging lines would need to move slightly. It may be good to use an if, but whatever.", "author": "ejona86", "createdAt": "2021-01-29T17:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQzNDE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzk2MjY2OQ==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r567962669", "bodyText": "@ejona86 Cool I have made the suggested change!", "author": "lriuui0x0", "createdAt": "2021-02-01T16:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjQzNDE5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c22a9ddeadf19c116c2eb6798eba62add94ebf3e", "chunk": "diff --git a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\nindex b45d3662b..e95770e88 100644\n--- a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n+++ b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n\n@@ -532,7 +532,10 @@ class NettyServerHandler extends AbstractNettyHandler {\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n-    Level level = http2Ex.error() == Http2Error.STREAM_CLOSED ? Level.FINE : Level.WARNING;\n+    Level level = Level.WARNING;\n+    if (serverStream == null && http2Ex.error() == Http2Error.STREAM_CLOSED) {\n+      level = Level.FINE;\n+    }\n     logger.log(level, \"Stream Error\", cause);\n     NettyServerStream.TransportState serverStream = serverStream(\n         connection().stream(Http2Exception.streamId(http2Ex)));\n"}}, {"oid": "c22a9ddeadf19c116c2eb6798eba62add94ebf3e", "url": "https://github.com/grpc/grpc-java/commit/c22a9ddeadf19c116c2eb6798eba62add94ebf3e", "message": "add more check", "committedDate": "2021-02-01T16:30:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODA1ODE2NA==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r568058164", "bodyText": "This won't build. serverStream is defined on the next line. The lines will need to be swapped.", "author": "ejona86", "createdAt": "2021-02-01T18:47:33Z", "path": "netty/src/main/java/io/grpc/netty/NettyServerHandler.java", "diffHunk": "@@ -532,7 +532,11 @@ protected void onConnectionError(ChannelHandlerContext ctx, boolean outbound, Th\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n-    logger.log(Level.WARNING, \"Stream Error\", cause);\n+    Level level = Level.WARNING;\n+    if (serverStream == null && http2Ex.error() == Http2Error.STREAM_CLOSED) {", "originalCommit": "c22a9ddeadf19c116c2eb6798eba62add94ebf3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODc0MjE3OA==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r568742178", "bodyText": "@ejona86 I have pushed the fix. Please review again.", "author": "lriuui0x0", "createdAt": "2021-02-02T16:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODA1ODE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODg1NDI1NQ==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r568854255", "bodyText": "Because the serverStream code was moved up to line 535 one unintended consequence is that if that code throws exception (not sure if it ever will) the logger.log line will never execute now (which was executing before this change) so we'll not see a log message that used to come out before this change. One way to address it is to put try-catch around line 535. Just pointing it out.", "author": "sanjaypujare", "createdAt": "2021-02-02T18:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODA1ODE2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODkwMDY4Ng==", "url": "https://github.com/grpc/grpc-java/pull/7771#discussion_r568900686", "bodyText": "That line to get the stream is fairly safe. There may be a few edge cases, but I'm not that worried as there is very little code (transitively) and we'd be seeing NPEs already.", "author": "ejona86", "createdAt": "2021-02-02T20:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODA1ODE2NA=="}], "type": "inlineReview", "revised_code": {"commit": "8d7eb094e4cf8a18229eb92a4da153d48c890b3f", "chunk": "diff --git a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\nindex e95770e88..697534bb6 100644\n--- a/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n+++ b/netty/src/main/java/io/grpc/netty/NettyServerHandler.java\n\n@@ -532,13 +532,13 @@ class NettyServerHandler extends AbstractNettyHandler {\n   @Override\n   protected void onStreamError(ChannelHandlerContext ctx, boolean outbound, Throwable cause,\n       StreamException http2Ex) {\n+    NettyServerStream.TransportState serverStream = serverStream(\n+        connection().stream(Http2Exception.streamId(http2Ex)));\n     Level level = Level.WARNING;\n     if (serverStream == null && http2Ex.error() == Http2Error.STREAM_CLOSED) {\n       level = Level.FINE;\n     }\n     logger.log(level, \"Stream Error\", cause);\n-    NettyServerStream.TransportState serverStream = serverStream(\n-        connection().stream(Http2Exception.streamId(http2Ex)));\n     Tag tag = serverStream != null ? serverStream.tag() : PerfMark.createTag();\n     PerfMark.startTask(\"NettyServerHandler.onStreamError\", tag);\n     try {\n"}}, {"oid": "8d7eb094e4cf8a18229eb92a4da153d48c890b3f", "url": "https://github.com/grpc/grpc-java/commit/8d7eb094e4cf8a18229eb92a4da153d48c890b3f", "message": "fix", "committedDate": "2021-02-02T16:26:52Z", "type": "commit"}]}