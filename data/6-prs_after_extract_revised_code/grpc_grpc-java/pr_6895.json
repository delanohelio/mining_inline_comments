{"pr_number": 6895, "pr_title": "xds: use separate LB configs for EDS policy running with different code paths", "pr_createdAt": "2020-04-02T21:19:53Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6895", "timeline": [{"oid": "537547209647b7f5c8f394c9e674c4c2d32a4879", "url": "https://github.com/grpc/grpc-java/commit/537547209647b7f5c8f394c9e674c4c2d32a4879", "message": "Define EdsConfig for full LDS flow use case.", "committedDate": "2020-04-02T20:34:26Z", "type": "commit"}, {"oid": "417cb67bc77c5352b0aa89739545f4edc8e33235", "url": "https://github.com/grpc/grpc-java/commit/417cb67bc77c5352b0aa89739545f4edc8e33235", "message": "EdsLoadBalancer will always receive EdsConfig rather than XdsConfig.", "committedDate": "2020-04-02T20:35:44Z", "type": "commit"}, {"oid": "8322951695660069661d8a7bfddb3ef99d3d2028", "url": "https://github.com/grpc/grpc-java/commit/8322951695660069661d8a7bfddb3ef99d3d2028", "message": "Change to generate EdsConfig in CdsLoadBalancer.", "committedDate": "2020-04-02T20:37:33Z", "type": "commit"}, {"oid": "a0639fddc92d32e08d29e42db3f16cc8b0158318", "url": "https://github.com/grpc/grpc-java/commit/a0639fddc92d32e08d29e42db3f16cc8b0158318", "message": "Modified XdsConfig definition to match that in internal proto definition. Changed its usage in XdsLoadBalancer.", "committedDate": "2020-04-02T20:40:03Z", "type": "commit"}, {"oid": "5b4d5d43d95f35c8be82db3f3bdb4f45b3d23359", "url": "https://github.com/grpc/grpc-java/commit/5b4d5d43d95f35c8be82db3f3bdb4f45b3d23359", "message": "Modified usage of XdsConfig in FallbackLb.", "committedDate": "2020-04-02T20:40:51Z", "type": "commit"}, {"oid": "5e890c201b858b6b02d917cffa884d8659dd5356", "url": "https://github.com/grpc/grpc-java/commit/5e890c201b858b6b02d917cffa884d8659dd5356", "message": "Merge branch 'master' of github.com:grpc/grpc-java into refactor/use_separate_lb_config_for_full_flow_and_eds_only", "committedDate": "2020-04-14T19:39:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYwMjY5Ng==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408602696", "bodyText": "endpointPickingPolicy is not null", "author": "dapengzhang0", "createdAt": "2020-04-15T06:12:40Z", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -108,27 +108,26 @@\n   public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n     logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n     Object lbConfig = resolvedAddresses.getLoadBalancingPolicyConfig();\n-    if (lbConfig == null) {\n-      edsLbHelper.updateBalancingState(\n-          TRANSIENT_FAILURE,\n-          new ErrorPicker(Status.UNAVAILABLE.withDescription(\"Missing EDS lb config\")));\n-      return;\n-    }\n-    XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    checkNotNull(lbConfig, \"missing EDS lb config\");\n+    EdsConfig newEdsConfig = (EdsConfig) lbConfig;\n     if (logger.isLoggable(XdsLogLevel.INFO)) {\n       logger.log(\n           XdsLogLevel.INFO,\n-          \"Received EDS lb config: cluster={0}, child_policy={1}, fallback_policy={2}, \"\n-              + \"eds_service_name={3}, report_load={4}\",\n-          newXdsConfig.cluster,\n-          newXdsConfig.endpointPickingPolicy != null\n-              ? newXdsConfig.endpointPickingPolicy.getProvider().getPolicyName() : \"\",\n-          newXdsConfig.fallbackPolicy != null\n-              ? newXdsConfig.fallbackPolicy.getProvider().getPolicyName() : \"\",\n-          newXdsConfig.edsServiceName,\n-          newXdsConfig.lrsServerName != null);\n+          \"Received EDS lb config: cluster={0}, child_policy={1}, \"\n+              + \"eds_service_name={2}, report_load={3}\",\n+          newEdsConfig.clusterName,\n+          newEdsConfig.endpointPickingPolicy != null", "originalCommit": "5e890c201b858b6b02d917cffa884d8659dd5356", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3NTAzNA==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r409075034", "bodyText": "Done.", "author": "voidzcy", "createdAt": "2020-04-15T19:15:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYwMjY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "94f95392f01d5ef93e9d75db563b453befad1394", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\nindex a6170490d..835a59c01 100644\n--- a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n\n@@ -116,8 +116,7 @@ final class EdsLoadBalancer extends LoadBalancer {\n           \"Received EDS lb config: cluster={0}, child_policy={1}, \"\n               + \"eds_service_name={2}, report_load={3}\",\n           newEdsConfig.clusterName,\n-          newEdsConfig.endpointPickingPolicy != null\n-              ? newEdsConfig.endpointPickingPolicy.getProvider().getPolicyName() : \"\",\n+          newEdsConfig.endpointPickingPolicy.getProvider().getPolicyName(),\n           newEdsConfig.edsServiceName,\n           newEdsConfig.lrsServerName != null);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMDEyMw==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408610123", "bodyText": "nit: This field is only used in one place, and can be inlined with helper.getAuthority() there. No need to check nullness of  helper's authority.", "author": "dapengzhang0", "createdAt": "2020-04-15T06:33:05Z", "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java", "diffHunk": "@@ -91,7 +96,8 @@ public void onAllDrop() {\n       Helper helper,\n       PrimaryLbFactory primaryLbFactory,\n       LoadBalancer.Factory fallbackLbFactory) {\n-    this.helper = helper;\n+    this.helper = checkNotNull(helper, \"helper\");\n+    authority = checkNotNull(helper.getAuthority(), \"authority\");", "originalCommit": "5e890c201b858b6b02d917cffa884d8659dd5356", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3NDk5Mw==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r409074993", "bodyText": "Done.", "author": "voidzcy", "createdAt": "2020-04-15T19:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMDEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "0edb10bce6dccd4c391b2d2f29631046f2deb3a4", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java b/xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java\nindex 94e9fef5a..d522eab08 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsLoadBalancer.java\n\n@@ -97,7 +96,6 @@ final class XdsLoadBalancer extends LoadBalancer {\n       PrimaryLbFactory primaryLbFactory,\n       LoadBalancer.Factory fallbackLbFactory) {\n     this.helper = checkNotNull(helper, \"helper\");\n-    authority = checkNotNull(helper.getAuthority(), \"authority\");\n     this.primaryLb = primaryLbFactory.newLoadBalancer(\n         new PrimaryLbHelper(), resourceUpdateCallback);\n     this.fallbackLbFactory = fallbackLbFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMjY5Nw==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r408612697", "bodyText": "Why change this behavior? If childPolicyConfigs  is not empty but does not include any registered policy, it should use round robin instead of return a ConfigOrError.", "author": "dapengzhang0", "createdAt": "2020-04-15T06:39:48Z", "path": "xds/src/main/java/io/grpc/xds/XdsLoadBalancerProvider.java", "diffHunk": "@@ -77,32 +77,24 @@ public ConfigOrError parseLoadBalancingPolicyConfig(\n   static ConfigOrError parseLoadBalancingConfigPolicy(\n       Map<String, ?> rawLoadBalancingPolicyConfig, LoadBalancerRegistry registry) {\n     try {\n-      String cluster = JsonUtil.getString(rawLoadBalancingPolicyConfig, \"cluster\");\n-\n       LbConfig roundRobinConfig = new LbConfig(\"round_robin\", ImmutableMap.<String, Object>of());\n-      List<LbConfig> endpointPickingConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n-          JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"endpointPickingPolicy\"));\n-      if (endpointPickingConfigs == null) {\n-        endpointPickingConfigs = new ArrayList<>(1);\n-      } else {\n-        endpointPickingConfigs = new ArrayList<>(endpointPickingConfigs);\n+      List<LbConfig> childPolicyConfigs = ServiceConfigUtil.unwrapLoadBalancingConfigList(\n+          JsonUtil.getListOfObjects(rawLoadBalancingPolicyConfig, \"childPolicy\"));\n+      if (childPolicyConfigs == null || childPolicyConfigs.isEmpty()) {\n+        childPolicyConfigs = Collections.singletonList(roundRobinConfig);\n       }\n-      endpointPickingConfigs.add(roundRobinConfig);", "originalCommit": "5e890c201b858b6b02d917cffa884d8659dd5356", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA0MjI5Ng==", "url": "https://github.com/grpc/grpc-java/pull/6895#discussion_r409042296", "bodyText": "Confirmed with Mark the behavior change is the correct behavior.", "author": "dapengzhang0", "createdAt": "2020-04-15T18:19:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODYxMjY5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "94f95392f01d5ef93e9d75db563b453befad1394", "url": "https://github.com/grpc/grpc-java/commit/94f95392f01d5ef93e9d75db563b453befad1394", "message": "Removed unnecessary null branch for field that is never null.", "committedDate": "2020-04-15T19:14:11Z", "type": "commit"}, {"oid": "0edb10bce6dccd4c391b2d2f29631046f2deb3a4", "url": "https://github.com/grpc/grpc-java/commit/0edb10bce6dccd4c391b2d2f29631046f2deb3a4", "message": "Styling issue.", "committedDate": "2020-04-15T19:14:32Z", "type": "commit"}]}