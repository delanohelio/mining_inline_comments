{"pr_number": 6639, "pr_title": "interop-testing: use server hostname instead of id for xds test", "pr_createdAt": "2020-01-24T18:47:08Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6639", "timeline": [{"oid": "0942fe612d1e5d7e9635436a4462679ba9265c1c", "url": "https://github.com/grpc/grpc-java/commit/0942fe612d1e5d7e9635436a4462679ba9265c1c", "message": "interop-testing: use server hostname instead of id for xds test", "committedDate": "2020-01-24T18:46:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Mjk0MQ==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370792941", "bodyText": "You might need use a generated random hostname as a fallback hostname in XdsTestServer.  As in e7d7c5b#diff-2140bcb433e6510183658de7492bfb57R58", "author": "dapengzhang0", "createdAt": "2020-01-24T19:03:01Z", "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestClient.java", "diffHunk": "@@ -295,14 +295,14 @@ private XdsStatsWatcher(long startId, long endId) {\n       this.endId = endId;\n     }\n \n-    void rpcCompleted(long requestId, @Nullable String serverId) {\n+    void rpcCompleted(long requestId, @Nullable String hostname) {\n       synchronized (lock) {\n         if (startId <= requestId && requestId < endId) {\n-          if (serverId != null) {\n-            if (rpcsByPeer.containsKey(serverId)) {\n-              rpcsByPeer.put(serverId, rpcsByPeer.get(serverId) + 1);\n+          if (hostname != null) {\n+            if (rpcsByPeer.containsKey(hostname)) {\n+              rpcsByPeer.put(hostname, rpcsByPeer.get(hostname) + 1);", "originalCommit": "0942fe612d1e5d7e9635436a4462679ba9265c1c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5NTQ1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370795451", "bodyText": "I think it's WAI as-is: the test driver script will need to assert on the hostnames recorded by the client, and so a randomly generated host won't be useful - if hostname is missing, the test will (and should) be failed.", "author": "ericgribkoff", "createdAt": "2020-01-24T19:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg0MjQ4MA==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370842480", "bodyText": "If the hostname is missing, how will test fail? Is it easy to debug then?", "author": "dapengzhang0", "createdAt": "2020-01-24T21:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg0ODYxNw==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370848617", "bodyText": "The test spec is still in progress, but a sample scenario is something like: there are four backends, and we expect the client to round-robin over all four. If one of the hostnames is missing, the test will see that it is round-robining over three backends and fail.", "author": "ericgribkoff", "createdAt": "2020-01-24T21:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MTA5Mw==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370851093", "bodyText": "Good point about debugging. Modified server to throw (fail) if it can't get hostname.", "author": "ericgribkoff", "createdAt": "2020-01-24T21:30:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc5Mjk0MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "6734ad6ea680f61be98ee80f4668b802b5b80847", "url": "https://github.com/grpc/grpc-java/commit/6734ad6ea680f61be98ee80f4668b802b5b80847", "message": "throw if server cannot get host", "committedDate": "2020-01-24T21:29:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1Mjk4OQ==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370852989", "bodyText": "host can be final now.  But not a big deal.", "author": "dapengzhang0", "createdAt": "2020-01-24T21:35:36Z", "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java", "diffHunk": "@@ -130,7 +130,8 @@ private TestServiceImpl() {\n       try {\n         host = InetAddress.getLocalHost().getHostName();", "originalCommit": "6734ad6ea680f61be98ee80f4668b802b5b80847", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1NTE2NA==", "url": "https://github.com/grpc/grpc-java/pull/6639#discussion_r370855164", "bodyText": "done", "author": "ericgribkoff", "createdAt": "2020-01-24T21:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1Mjk4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7cb02b6d3a5ebda90a61be6207bb60dd95108a9d", "chunk": "diff --git a/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java b/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\nindex 5ce1b5787..915be98a4 100644\n--- a/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\n+++ b/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\n\n@@ -124,7 +124,7 @@ public final class XdsTestServer {\n   }\n \n   private class TestServiceImpl extends TestServiceGrpc.TestServiceImplBase {\n-    private String host = \"\";\n+    private final String host;\n \n     private TestServiceImpl() {\n       try {\n"}}, {"oid": "7cb02b6d3a5ebda90a61be6207bb60dd95108a9d", "url": "https://github.com/grpc/grpc-java/commit/7cb02b6d3a5ebda90a61be6207bb60dd95108a9d", "message": "final host", "committedDate": "2020-01-24T21:40:54Z", "type": "commit"}]}