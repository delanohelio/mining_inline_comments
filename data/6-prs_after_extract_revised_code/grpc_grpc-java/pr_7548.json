{"pr_number": 7548, "pr_title": "interop-testing: support rpc keep-open for xDS test server", "pr_createdAt": "2020-10-22T18:50:11Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7548", "timeline": [{"oid": "108b8dc162d15fd551c5292e9e7ec6595e223283", "url": "https://github.com/grpc/grpc-java/commit/108b8dc162d15fd551c5292e9e7ec6595e223283", "message": "Support keep-open on the server side.", "committedDate": "2020-10-22T18:48:50Z", "type": "commit"}, {"oid": "de84e5afdbcb03029ae5ef0b410ba6aadec19a9b", "url": "https://github.com/grpc/grpc-java/commit/de84e5afdbcb03029ae5ef0b410ba6aadec19a9b", "message": "Make rpc-behavior key private.", "committedDate": "2020-10-22T20:29:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNjQzOQ==", "url": "https://github.com/grpc/grpc-java/pull/7548#discussion_r511326439", "bodyText": "I don't see how the keepOpen atomic's value is correlated with this call after this interceptor sets it to true.\nMy reading of the spec for these tests was that, for an incoming call with keep-open in the metadata, that call should be kept open by the server. As I understand the code here, instead any call with keep-open in the metadata essentially flips a global boolean and all calls from that point on will be kept open (at least until another RPC comes without keep-open). Is that intended?\nTo set a value that would instead be scoped to this particular call, I think you could set a value in the context, as in https://github.com/GoogleCloudPlatform/traffic-director-grpc-examples/blob/master/java/src/main/java/io/grpc/examples/wallet/WalletInterceptors.java#L106 (there might be a better way to accomplish this)", "author": "ericgribkoff", "createdAt": "2020-10-24T06:14:09Z", "path": "interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java", "diffHunk": "@@ -203,18 +214,22 @@ public void setNotServing(\n     }\n   }\n \n-  private static class HostnameInterceptor implements ServerInterceptor {\n+  private static class TestInfoInterceptor implements ServerInterceptor {\n     private final String host;\n+    private final AtomicBoolean keepOpenCaptor;\n \n-    private HostnameInterceptor(String host) {\n+    private TestInfoInterceptor(String host, AtomicBoolean keepOpenCaptor) {\n       this.host = host;\n+      this.keepOpenCaptor = keepOpenCaptor;\n     }\n \n     @Override\n     public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(\n         ServerCall<ReqT, RespT> call,\n         final Metadata requestHeaders,\n         ServerCallHandler<ReqT, RespT> next) {\n+      String callBehavior = requestHeaders.get(CALL_BEHAVIOR_KEY);\n+      keepOpenCaptor.set(\"keep-open\".equals(callBehavior));", "originalCommit": "de84e5afdbcb03029ae5ef0b410ba6aadec19a9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTM2NDMzNQ==", "url": "https://github.com/grpc/grpc-java/pull/7548#discussion_r511364335", "bodyText": "Oops, you are right. This is screwed up, I was too focused on how the test case will be running, in which all calls will be open after some point of time.", "author": "voidzcy", "createdAt": "2020-10-24T09:35:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNjQzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2NjEyMw==", "url": "https://github.com/grpc/grpc-java/pull/7548#discussion_r511766123", "bodyText": "Should be fixed now.", "author": "voidzcy", "createdAt": "2020-10-26T07:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTMyNjQzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "51703da987c5074ec01c56e8c720e0bab4d40fc2", "chunk": "diff --git a/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java b/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\nindex e08019934..4fc832eca 100644\n--- a/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\n+++ b/interop-testing/src/main/java/io/grpc/testing/integration/XdsTestServer.java\n\n@@ -216,11 +216,9 @@ public final class XdsTestServer {\n \n   private static class TestInfoInterceptor implements ServerInterceptor {\n     private final String host;\n-    private final AtomicBoolean keepOpenCaptor;\n \n-    private TestInfoInterceptor(String host, AtomicBoolean keepOpenCaptor) {\n+    private TestInfoInterceptor(String host) {\n       this.host = host;\n-      this.keepOpenCaptor = keepOpenCaptor;\n     }\n \n     @Override\n"}}, {"oid": "51703da987c5074ec01c56e8c720e0bab4d40fc2", "url": "https://github.com/grpc/grpc-java/commit/51703da987c5074ec01c56e8c720e0bab4d40fc2", "message": "Convert put call_behavior metadata into Context and use it as per call basis.", "committedDate": "2020-10-26T07:44:22Z", "type": "commit"}, {"oid": "51703da987c5074ec01c56e8c720e0bab4d40fc2", "url": "https://github.com/grpc/grpc-java/commit/51703da987c5074ec01c56e8c720e0bab4d40fc2", "message": "Convert put call_behavior metadata into Context and use it as per call basis.", "committedDate": "2020-10-26T07:44:22Z", "type": "forcePushed"}]}