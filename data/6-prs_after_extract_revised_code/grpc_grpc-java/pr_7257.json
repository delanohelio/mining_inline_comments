{"pr_number": 7257, "pr_title": "xds: parse timeout from RDS responses", "pr_createdAt": "2020-07-28T20:58:24Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7257", "timeline": [{"oid": "4e2acd87633daf75846954561fa0b3b047738ae2", "url": "https://github.com/grpc/grpc-java/commit/4e2acd87633daf75846954561fa0b3b047738ae2", "message": "Parse timeout from RDS responses.", "committedDate": "2020-07-28T20:56:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2ODUyNA==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462568524", "bodyText": "If configured as 0, the maximum allowed timeout for gRPC requests is infinity.\nhttps://github.com/envoyproxy/envoy/blob/c694e470dbc9a1dd24b296d117330f0e5becb2c9/api/envoy/api/v2/route/route_components.proto#L964", "author": "dapengzhang0", "createdAt": "2020-07-29T20:28:34Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1146,7 +1162,13 @@ public String toString() {\n           return StructOrError.fromError(\n               \"Unknown cluster specifier: \" + proto.getClusterSpecifierCase());\n       }\n-      return StructOrError.fromStruct(new RouteAction(cluster, weightedClusters));\n+      long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n+      if (proto.hasMaxGrpcTimeout()) {\n+        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());", "originalCommit": "4e2acd87633daf75846954561fa0b3b047738ae2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "138f6b4dcf4cf2b8696c1151c394e843853bebe2", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java b/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\nindex 223cd807e..53cf85364 100644\n--- a/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\n+++ b/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\n\n@@ -1164,7 +1164,8 @@ final class EnvoyProtoData {\n       }\n       long timeoutNano = TimeUnit.SECONDS.toNanos(15L);  // default 15s\n       if (proto.hasMaxGrpcTimeout()) {\n-        timeoutNano = Durations.toNanos(proto.getMaxGrpcTimeout());\n+        long time = Durations.toNanos(proto.getMaxGrpcTimeout());\n+        timeoutNano = time == 0 ? Long.MAX_VALUE : time;\n       } else if (proto.hasTimeout()) {\n         timeoutNano  = Durations.toNanos(proto.getTimeout());\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462573456", "bodyText": "The \"downstream end-of-stream has been processed\" in envoy API doc is about the stream from client to the envoy proxy, which more or less corresponds to onComplete() of client's request StreamObserver in proxyless case (Because the local xds plugin itself is the \"envoy proxy\".). I think it shouldn't be stated as \"end-of-stream has been processed\" for the proxyless case, in which the stream connects to the backend directly.  cc @dfawley @ejona86", "author": "dapengzhang0", "createdAt": "2020-07-29T20:37:42Z", "path": "xds/src/main/java/io/grpc/xds/EnvoyProtoData.java", "diffHunk": "@@ -1067,18 +1069,30 @@ public String toString() {\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteAction}. */\n   static final class RouteAction {\n+    // Specifies the upstream timeout for the route, which spans between the point at which\n+    // the entire downstream request (i.e., end-of-stream) has been processed and when the", "originalCommit": "4e2acd87633daf75846954561fa0b3b047738ae2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3Nzk4OA==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462577988", "bodyText": "I also just noticed that by the description of this envoy API doc, in bidi-streaming or client-streaming case, the timeout may not be converted to grpc deadline. (Although max_grpc_timeout can always be converted to grpc deadline)", "author": "dapengzhang0", "createdAt": "2020-07-29T20:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU5ODQ4MQ==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462598481", "bodyText": "Deleted the comment if you don't like it (although I don't think there is any problem stating in that way as the description is from the perspective of a Route, \"downstream\" still makes senses from an implementation's perspective).\nEnvoy's API doc also mentions that a value of 0 for timeout will disable the route's timeout.  Added that case as well.", "author": "voidzcy", "createdAt": "2020-07-29T21:25:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxNDcwMg==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462614702", "bodyText": "Deleted the comment if you don't like it (although I don't think there is any problem stating in that way as the description is from the perspective of a Route, \"downstream\" still makes senses from an implementation's perspective).\n\nThe timeout java field is a combination of timeout envoy api field and max_grpc_timeout envoy api field (The latter, if specified, overrides the former). And I noticed that the two envoy api fields measure different time span for grpc requests, especially for client-streaming case. The latter definitely does not measure the span from \"downstream EOS\"", "author": "dapengzhang0", "createdAt": "2020-07-29T22:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY1MzM5OA==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r462653398", "bodyText": "I didn't notice this detail before (timeout starts counting after the client sends its end-stream).  This behavior might be difficult to implement -- at least we can't do it in Go for unary RPCs without some changes in the channel.\n@markdroth do you think we'll need to match Envoy behavior here, or could we treat it as a known difference and call it out in the design?", "author": "dfawley", "createdAt": "2020-07-29T23:49:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1MTMzNQ==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r463051335", "bodyText": "I don't think it's really necessary to mimic Envoy's behavior in this regard.  I think it's fine for us to just use this to control our existing timeout semantics, just as if timeout were set via the service config.\nWe should call this out in the gRFC, though.", "author": "markdroth", "createdAt": "2020-07-30T14:46:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEzNTE4NQ==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r463135185", "bodyText": "A preexisting management server may set the HTTP timeout for only 500ms, with grpc_max_timeout unset. This works perfectly for long client streaming with envoy proxy. But it will fail all client streaming requests from a proxyless grpc client.", "author": "dapengzhang0", "createdAt": "2020-07-30T16:50:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0MDczMg==", "url": "https://github.com/grpc/grpc-java/pull/7257#discussion_r463140732", "bodyText": "How about we don't support HTTP timeout for client/bidi streaming, only max_grpc_timeout is supported for them?", "author": "dapengzhang0", "createdAt": "2020-07-30T17:00:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MzQ1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "0cfc73b6ad38c4d5afc139a82dfcb63185a2906f", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java b/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\nindex 223cd807e..fac1c93d4 100644\n--- a/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\n+++ b/xds/src/main/java/io/grpc/xds/EnvoyProtoData.java\n\n@@ -1069,9 +1069,6 @@ final class EnvoyProtoData {\n \n   /** See corresponding Envoy proto message {@link io.envoyproxy.envoy.api.v2.route.RouteAction}. */\n   static final class RouteAction {\n-    // Specifies the upstream timeout for the route, which spans between the point at which\n-    // the entire downstream request (i.e., end-of-stream) has been processed and when the\n-    // upstream response has been completely processed.\n     private final long timeoutNano;\n     // Exactly one of the following fields is non-null.\n     @Nullable\n"}}, {"oid": "138f6b4dcf4cf2b8696c1151c394e843853bebe2", "url": "https://github.com/grpc/grpc-java/commit/138f6b4dcf4cf2b8696c1151c394e843853bebe2", "message": "Set timeout to infinite if maxGrpcTimeout is set to 0", "committedDate": "2020-07-29T20:58:30Z", "type": "commit"}, {"oid": "0cfc73b6ad38c4d5afc139a82dfcb63185a2906f", "url": "https://github.com/grpc/grpc-java/commit/0cfc73b6ad38c4d5afc139a82dfcb63185a2906f", "message": "Delete comment", "committedDate": "2020-07-29T20:59:55Z", "type": "commit"}, {"oid": "4c416aa79958211a48f8cd47e7294708186e85c2", "url": "https://github.com/grpc/grpc-java/commit/4c416aa79958211a48f8cd47e7294708186e85c2", "message": "Add case for timeout disabled.", "committedDate": "2020-07-29T21:24:38Z", "type": "commit"}, {"oid": "910790d382a79ab29c9a74df9ca06fba42326cc1", "url": "https://github.com/grpc/grpc-java/commit/910790d382a79ab29c9a74df9ca06fba42326cc1", "message": "Use max value instead of null.", "committedDate": "2020-07-30T22:17:37Z", "type": "commit"}]}