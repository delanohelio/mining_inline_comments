{"pr_number": 6824, "pr_title": "xds: implement XdsRoutingLoadBalancer", "pr_createdAt": "2020-03-13T18:44:25Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6824", "timeline": [{"oid": "f78b974db529de2b2151a690661a82ad4675328a", "url": "https://github.com/grpc/grpc-java/commit/f78b974db529de2b2151a690661a82ad4675328a", "message": "xds: implement XdsRoutingLoadBalancer", "committedDate": "2020-03-17T18:20:06Z", "type": "commit"}, {"oid": "f78b974db529de2b2151a690661a82ad4675328a", "url": "https://github.com/grpc/grpc-java/commit/f78b974db529de2b2151a690661a82ad4675328a", "message": "xds: implement XdsRoutingLoadBalancer", "committedDate": "2020-03-17T18:20:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395934318", "bodyText": "This is wrong. This in core/src/test/java/io/grpc/internal/TestUtils.java. It is an in-module utility class for grpc-core's unit test only. Not a test utility.", "author": "voidzcy", "createdAt": "2020-03-20T23:45:14Z", "path": "core/src/test/java/io/grpc/internal/TestUtils.java", "diffHunk": "@@ -36,7 +41,41 @@\n /**\n  * Common utility methods for tests.\n  */\n-final class TestUtils {\n+public final class TestUtils {", "originalCommit": "f78b974db529de2b2151a690661a82ad4675328a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNzU5MQ==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395937591", "bodyText": "The javadoc is specifying it's a test utility. I'm extending it to be public to the entire project.", "author": "dapengzhang0", "createdAt": "2020-03-21T00:03:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTM1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395939351", "bodyText": "It's a test utility for grpc-core's unit tests, not for other modules. Look at its file path. It's in the test sourceSet of grpc-core. It is intentionally package private.", "author": "voidzcy", "createdAt": "2020-03-21T00:13:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MDY1Mg==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395940652", "bodyText": "We did the same for FakeClock. We can not put it in main sourceSet, but we want all modules to use it. grpc-core is the most reasonable module for all modules to use.", "author": "dapengzhang0", "createdAt": "2020-03-21T00:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0NzU0Nw==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395947547", "bodyText": "I am surprised FakeClock is from grpc-core's test scope.\nI looked at its history. I suspect initially it was created for testing classes in grpc-core's io.grpc.internal package (#1282). It was package-private at that time. Then it was used for testing classes in grpc-core's io.grpc package (#1602) and it was made to public. This usage was still fair as no cross-module happened. After that, people started to use (abused easily as it is public) it with cross-module reference and put the hack (project(':grpc-core').sourceSets.test.output) in build files.\nI filed #6847 to address this issue (and we may discuss it in next API meeting).\nAnyway, using classes from another module's test scope is bad, it's access is hacked. You should not do this. Also, as I mentioned in the next comment, in your case the usage is completely unnecessary.", "author": "voidzcy", "createdAt": "2020-03-21T01:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNDMxOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395935790", "bodyText": "A fake LoadBalancerProvider is trivial to implement, although it might be a little verbose to always implement isAvailable(), getPriority(), etc in unit test. If your test case is just trying to verify the behavior of looking up the registry correctly, the real default registry suffices.", "author": "voidzcy", "createdAt": "2020-03-20T23:53:05Z", "path": "core/src/test/java/io/grpc/internal/TestUtils.java", "diffHunk": "@@ -36,7 +41,41 @@\n /**\n  * Common utility methods for tests.\n  */\n-final class TestUtils {\n+public final class TestUtils {\n+\n+  /** Base class for a standard LoadBalancerProvider implementation. */\n+  public abstract static class StandardLoadBalancerProvider extends LoadBalancerProvider {", "originalCommit": "f78b974db529de2b2151a690661a82ad4675328a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzODAxNg==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395938016", "bodyText": "This class is not about which registry to use, it's about registering fake policy.", "author": "dapengzhang0", "createdAt": "2020-03-21T00:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MTU4OA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395941588", "bodyText": "My point is:\nIf you are just verifying your provider's behavior of looking up a policy in the registry, you can use the default registry and look up existing policies such as 'round_robin'. The behavior of looking up 'round_robin' isn't different from looking up 'foo'.\nIf you really have to register a fake policy into the registry, fully implementing all LoadBalancerProvider's methods is still trivial, do not need to have this StandardLoadBalancerProvider.", "author": "voidzcy", "createdAt": "2020-03-21T00:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU1MTE1Mg==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396551152", "bodyText": "Fully implementing all LoadBalancerProvider's methods is trivial but is just repeating boilerplates that's not relevant to the test at all, it's distracting to read the test, the new base class does provide some benefit.", "author": "dapengzhang0", "createdAt": "2020-03-23T15:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwOTI3Mg==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396609272", "bodyText": "Whatever...", "author": "voidzcy", "createdAt": "2020-03-23T17:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNTc5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNzg5NQ==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395937895", "bodyText": "nit: keep our convention checkNotNull, although the instantiation is completely internal. Maybe it's always a good practice to check null in constructors for arguments that are saved as fields and to be used later.", "author": "voidzcy", "createdAt": "2020-03-21T00:04:53Z", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -16,18 +16,209 @@\n \n package io.grpc.xds;\n \n+import static io.grpc.ConnectivityState.CONNECTING;\n+import static io.grpc.ConnectivityState.IDLE;\n+import static io.grpc.ConnectivityState.READY;\n+import static io.grpc.ConnectivityState.TRANSIENT_FAILURE;\n+import static io.grpc.xds.XdsSubchannelPickers.BUFFER_PICKER;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.ConnectivityState;\n+import io.grpc.InternalLogId;\n import io.grpc.LoadBalancer;\n+import io.grpc.MethodDescriptor;\n import io.grpc.Status;\n+import io.grpc.internal.ServiceConfigUtil.PolicySelection;\n+import io.grpc.util.ForwardingLoadBalancerHelper;\n+import io.grpc.util.GracefulSwitchLoadBalancer;\n+import io.grpc.xds.XdsLogger.XdsLogLevel;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.MethodName;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.Route;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.XdsRoutingConfig;\n+import io.grpc.xds.XdsSubchannelPickers.ErrorPicker;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n \n-// TODO(zdapeng): Implementation.\n /** Load balancer for xds_routing policy. */\n final class XdsRoutingLoadBalancer extends LoadBalancer {\n \n+  private final XdsLogger logger;\n+  private final Helper helper;\n+  private final Map<String, GracefulSwitchLoadBalancer> routeBalancers = new HashMap<>();\n+  private final Map<String, RouteHelper> routeHelpers = new HashMap<>();\n+\n+  private Map<String, PolicySelection> actions = ImmutableMap.of();\n+  private List<Route> routes = ImmutableList.of();\n+\n+  XdsRoutingLoadBalancer(Helper helper) {\n+    this.helper = helper;", "originalCommit": "f78b974db529de2b2151a690661a82ad4675328a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU2NTY0OA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396565648", "bodyText": "done.", "author": "dapengzhang0", "createdAt": "2020-03-23T16:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzNzg5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2d8fc2e6d603eb2c36966b5382f09991e2509c90", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java b/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\nindex 1ad74e42e..f2c9b971e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\n\n@@ -16,6 +16,7 @@\n \n package io.grpc.xds;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n import static io.grpc.ConnectivityState.CONNECTING;\n import static io.grpc.ConnectivityState.IDLE;\n import static io.grpc.ConnectivityState.READY;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r395939124", "bodyText": "Should this also shut down child balancers (if exist) as well?\nNote you shouldn't call handleNameResolutionError() API directly. You could have a helper method for error handling and have handleNameResolutionError() call it as well.", "author": "voidzcy", "createdAt": "2020-03-21T00:12:08Z", "path": "xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java", "diffHunk": "@@ -16,18 +16,209 @@\n \n package io.grpc.xds;\n \n+import static io.grpc.ConnectivityState.CONNECTING;\n+import static io.grpc.ConnectivityState.IDLE;\n+import static io.grpc.ConnectivityState.READY;\n+import static io.grpc.ConnectivityState.TRANSIENT_FAILURE;\n+import static io.grpc.xds.XdsSubchannelPickers.BUFFER_PICKER;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import io.grpc.ConnectivityState;\n+import io.grpc.InternalLogId;\n import io.grpc.LoadBalancer;\n+import io.grpc.MethodDescriptor;\n import io.grpc.Status;\n+import io.grpc.internal.ServiceConfigUtil.PolicySelection;\n+import io.grpc.util.ForwardingLoadBalancerHelper;\n+import io.grpc.util.GracefulSwitchLoadBalancer;\n+import io.grpc.xds.XdsLogger.XdsLogLevel;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.MethodName;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.Route;\n+import io.grpc.xds.XdsRoutingLoadBalancerProvider.XdsRoutingConfig;\n+import io.grpc.xds.XdsSubchannelPickers.ErrorPicker;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n \n-// TODO(zdapeng): Implementation.\n /** Load balancer for xds_routing policy. */\n final class XdsRoutingLoadBalancer extends LoadBalancer {\n \n+  private final XdsLogger logger;\n+  private final Helper helper;\n+  private final Map<String, GracefulSwitchLoadBalancer> routeBalancers = new HashMap<>();\n+  private final Map<String, RouteHelper> routeHelpers = new HashMap<>();\n+\n+  private Map<String, PolicySelection> actions = ImmutableMap.of();\n+  private List<Route> routes = ImmutableList.of();\n+\n+  XdsRoutingLoadBalancer(Helper helper) {\n+    this.helper = helper;\n+    logger = XdsLogger.withLogId(\n+        InternalLogId.allocate(\"xds-routing-lb\", helper.getAuthority()));\n+    logger.log(XdsLogLevel.INFO, \"Created\");\n+  }\n+\n+  @Override\n+  public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n+    logger.log(XdsLogLevel.DEBUG, \"Received resolution result: {0}\", resolvedAddresses);\n+    XdsRoutingConfig xdsRoutingConfig =\n+        (XdsRoutingConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n+    if (xdsRoutingConfig == null) {\n+      helper.updateBalancingState(", "originalCommit": "f78b974db529de2b2151a690661a82ad4675328a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU1Njc4NQ==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396556785", "bodyText": "Why should this shutdown child balancers? Even handleNameResolutionError() does not shutdown child balancers.", "author": "dapengzhang0", "createdAt": "2020-03-23T15:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYwODc2MA==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396608760", "bodyText": "I mean propagate error to child policies. handleNameResolutionError() propagates error down to child policies and eventually have leaf policies propagate TRANSIENT_FAILURE back to root policy. But here, it behaves differently.", "author": "voidzcy", "createdAt": "2020-03-23T17:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYyMzk5Mw==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396623993", "bodyText": "Maybe we can just checkNotNull for  xdsRoutingConfig like CdsLoadBalancer does, it can be only programing error of our own.  I don't remember why EdsLoadBalancer needs updateBalancingState instead of checkNotNull.", "author": "dapengzhang0", "createdAt": "2020-03-23T17:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYzNDQ3Mw==", "url": "https://github.com/grpc/grpc-java/pull/6824#discussion_r396634473", "bodyText": "I am fine with either. But if you are updating balancing state, you'd better do it completely.", "author": "voidzcy", "createdAt": "2020-03-23T17:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzOTEyNA=="}], "type": "inlineReview", "revised_code": {"commit": "2d8fc2e6d603eb2c36966b5382f09991e2509c90", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java b/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\nindex 1ad74e42e..f2c9b971e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsRoutingLoadBalancer.java\n\n@@ -16,6 +16,7 @@\n \n package io.grpc.xds;\n \n+import static com.google.common.base.Preconditions.checkNotNull;\n import static io.grpc.ConnectivityState.CONNECTING;\n import static io.grpc.ConnectivityState.IDLE;\n import static io.grpc.ConnectivityState.READY;\n"}}, {"oid": "2d8fc2e6d603eb2c36966b5382f09991e2509c90", "url": "https://github.com/grpc/grpc-java/commit/2d8fc2e6d603eb2c36966b5382f09991e2509c90", "message": "check not null", "committedDate": "2020-03-23T16:02:50Z", "type": "commit"}, {"oid": "eb23aa0dddd477c7fcec8cfbd0f40fb450fa8e68", "url": "https://github.com/grpc/grpc-java/commit/eb23aa0dddd477c7fcec8cfbd0f40fb450fa8e68", "message": "checkNotNull for resolved lb config", "committedDate": "2020-03-23T18:30:31Z", "type": "commit"}, {"oid": "2b761d94e965315a57cbb114001688df5488e966", "url": "https://github.com/grpc/grpc-java/commit/2b761d94e965315a57cbb114001688df5488e966", "message": "minor grammar fix", "committedDate": "2020-03-23T18:46:45Z", "type": "commit"}]}