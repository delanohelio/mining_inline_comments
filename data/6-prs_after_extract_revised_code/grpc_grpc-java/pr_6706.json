{"pr_number": 6706, "pr_title": "xds: report load stats for all clusters over a single LRS client", "pr_createdAt": "2020-02-13T02:05:47Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6706", "timeline": [{"oid": "e96e60a146c8ed0b644f60e801e1a7552aa8c8fc", "url": "https://github.com/grpc/grpc-java/commit/e96e60a146c8ed0b644f60e801e1a7552aa8c8fc", "message": "Bind each LoadStatsStore instance with cluster:eds_service.", "committedDate": "2020-02-13T00:43:43Z", "type": "commit"}, {"oid": "e82e8370336ecc628f7c5a26b7ac7a7502c24f24", "url": "https://github.com/grpc/grpc-java/commit/e82e8370336ecc628f7c5a26b7ac7a7502c24f24", "message": "An LoadReportClient instance should be responsible for reporting loads for all clusters.", "committedDate": "2020-02-13T00:44:59Z", "type": "commit"}, {"oid": "6d2f8fb1ab198362629e4bf25c159d660326619b", "url": "https://github.com/grpc/grpc-java/commit/6d2f8fb1ab198362629e4bf25c159d660326619b", "message": "An XdsClient instance should contain at most one LoadReportClient instance. All load reporting work should be delegated to the contained LoadReportClient instance.", "committedDate": "2020-02-13T00:47:09Z", "type": "commit"}, {"oid": "dcc515c116a9a61ad355ac6e3313e1902378431c", "url": "https://github.com/grpc/grpc-java/commit/dcc515c116a9a61ad355ac6e3313e1902378431c", "message": "Change EdsLoadBalancer to enable/disable load reporting with the new XdsClient APIs.", "committedDate": "2020-02-13T01:09:15Z", "type": "commit"}, {"oid": "efce45619e2b9913fd448e1b069f2443c8e9883f", "url": "https://github.com/grpc/grpc-java/commit/efce45619e2b9913fd448e1b069f2443c8e9883f", "message": "Eliminate interface for LoadReportClient.", "committedDate": "2020-02-13T01:09:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIwODIzOQ==", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379208239", "bodyText": "It only works for the case cluster_service name is never changed, otherwise the first ClusterEndpointsBalancer.shutdown will cancel the second ClusterEndpointsBalancer's load report. It that intended behavior for now?", "author": "dapengzhang0", "createdAt": "2020-02-14T01:21:06Z", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -339,9 +324,9 @@ public boolean canHandleEmptyAddressListFromNameResolution() {\n \n       @Override\n       public void shutdown() {\n-        loadStatsStoreMap.remove(clusterServiceName);\n-        if (isReportingStats()) {\n-          loadReportClient.removeLoadStatsStore(clusterServiceName);\n+        if (isReportingLoad) {\n+          xdsClient.cancelClientStatsReport(clusterName, null);", "originalCommit": "efce45619e2b9913fd448e1b069f2443c8e9883f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\nindex a540992f6..ddc183a9b 100644\n--- a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n\n@@ -324,10 +306,6 @@ final class EdsLoadBalancer extends LoadBalancer {\n \n       @Override\n       public void shutdown() {\n-        if (isReportingLoad) {\n-          xdsClient.cancelClientStatsReport(clusterName, null);\n-          isReportingLoad = false;\n-        }\n         localityStore.reset();\n         xdsClient.cancelEndpointDataWatch(clusterServiceName, endpointWatcher);\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTIxMDQxNQ==", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r379210415", "bodyText": "This only works for the case cluster_service name is never changed, otherwise it will throw because of the graceful switch. It that intended behavior for now?", "author": "dapengzhang0", "createdAt": "2020-02-14T01:30:18Z", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -321,7 +287,26 @@ public int hashCode() {\n         EdsLoadBalancer.this.endpointWatcher = endpointWatcher;\n       }\n \n-      // TODO(zddapeng): In handleResolvedAddresses() handle child policy change if any.\n+      @Override\n+      public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n+        XdsConfig config = (XdsConfig) resolvedAddresses.getLoadBalancingPolicyConfig();\n+        if (config.lrsServerName != null) {\n+          if (!config.lrsServerName.equals(\"\")) {\n+            throw new AssertionError(\n+                \"Can only report load to the same management server\");\n+          }\n+          if (!isReportingLoad) {\n+            xdsClient.reportClientStats(clusterName, null, loadStatsStore);", "originalCommit": "efce45619e2b9913fd448e1b069f2443c8e9883f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "58bb8fea86c390f5b9354fca24b2042a451b2901", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\nindex a540992f6..9e64d3b74 100644\n--- a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n\n@@ -280,11 +266,6 @@ final class EdsLoadBalancer extends LoadBalancer {\n \n         endpointWatcher = new EndpointWatcherImpl(localityStore);\n         xdsClient.watchEndpointData(clusterServiceName, endpointWatcher);\n-        if (EdsLoadBalancer.this.endpointWatcher != null) {\n-          xdsClient.cancelEndpointDataWatch(\n-              oldClusterServiceName, EdsLoadBalancer.this.endpointWatcher);\n-        }\n-        EdsLoadBalancer.this.endpointWatcher = endpointWatcher;\n       }\n \n       @Override\n"}}, {"oid": "58bb8fea86c390f5b9354fca24b2042a451b2901", "url": "https://github.com/grpc/grpc-java/commit/58bb8fea86c390f5b9354fca24b2042a451b2901", "message": "Merge branch 'master' of github.com:grpc/grpc-java into impl/rework_lrs_integration_with_xds_client", "committedDate": "2020-02-19T19:00:49Z", "type": "commit"}, {"oid": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "url": "https://github.com/grpc/grpc-java/commit/74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "message": "Do not support switching cluster_service, report loads per cluter only. Cluster_service field is never used.", "committedDate": "2020-02-20T00:24:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjU2MA==", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r381626560", "bodyText": "(If there is attributes or addresses change in resolvedAddresses) we still need call switchingLoadBalancer.handleResolvedAddresses(resolvedAddresses)\nbefore return.", "author": "dapengzhang0", "createdAt": "2020-02-20T00:32:25Z", "path": "xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java", "diffHunk": "@@ -114,6 +117,9 @@ public void handleResolvedAddresses(ResolvedAddresses resolvedAddresses) {\n       return;\n     }\n     XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n+    if (Objects.equals(newXdsConfig, xdsConfig)) {\n+      return;", "originalCommit": "74ddf7f7a04714cc2a7251bf4f1b8b7f8531125d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzMjg3OA==", "url": "https://github.com/grpc/grpc-java/pull/6706#discussion_r381632878", "bodyText": "Sure, removed this block. The following two blocks will only happen when specific fields (i.e., lrsServerName, edsServiceName) in lb config changes. ResolvedAddresses is always delegated to switchLoadBalancer.handleResolvedAddresses(...).", "author": "voidzcy", "createdAt": "2020-02-20T00:53:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYyNjU2MA=="}], "type": "inlineReview", "revised_code": {"commit": "6e09cb8b6abecdf098b9632d5da1779ca775c1ab", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\nindex ddc183a9b..1b439dcd2 100644\n--- a/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n+++ b/xds/src/main/java/io/grpc/xds/EdsLoadBalancer.java\n\n@@ -117,9 +117,6 @@ final class EdsLoadBalancer extends LoadBalancer {\n       return;\n     }\n     XdsConfig newXdsConfig = (XdsConfig) lbConfig;\n-    if (Objects.equals(newXdsConfig, xdsConfig)) {\n-      return;\n-    }\n \n     if (xdsClientPool == null) {\n       // Init xdsClientPool and xdsClient.\n"}}, {"oid": "6e09cb8b6abecdf098b9632d5da1779ca775c1ab", "url": "https://github.com/grpc/grpc-java/commit/6e09cb8b6abecdf098b9632d5da1779ca775c1ab", "message": "Should still handle resolved addresses even if lb config does not change.", "committedDate": "2020-02-20T00:50:45Z", "type": "commit"}]}