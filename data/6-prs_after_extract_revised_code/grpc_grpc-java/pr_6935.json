{"pr_number": 6935, "pr_title": "xds: add tests & misc fixes based on outstanding items", "pr_createdAt": "2020-04-16T16:58:59Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6935", "timeline": [{"oid": "d47d343e8630e6802ae6f23511fba855b3e63037", "url": "https://github.com/grpc/grpc-java/commit/d47d343e8630e6802ae6f23511fba855b3e63037", "message": "xds: add tests & misc fixes based on outstanding items", "committedDate": "2020-04-16T16:55:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzMyOA==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409723328", "bodyText": "this does not look correct. it is not even an IO exception (this is why it is originally not an IO exception), consider using custom checked exception if there isn't any good exception to use.", "author": "creamsoup", "createdAt": "2020-04-16T17:21:42Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientWrapperForServerSds.java", "diffHunk": "@@ -84,7 +84,7 @@ public static XdsClientWrapperForServerSds newInstance(\n     Bootstrapper.BootstrapInfo bootstrapInfo = bootstrapper.readBootstrap();\n     final List<Bootstrapper.ServerInfo> serverList = bootstrapInfo.getServers();\n     if (serverList.isEmpty()) {\n-      throw new NoSuchElementException(\"No management server provided by bootstrap\");\n+      throw new FileNotFoundException(\"No management server provided by bootstrap\");", "originalCommit": "d47d343e8630e6802ae6f23511fba855b3e63037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0MTEzMw==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409741133", "bodyText": "Yeah, I can create a custom checked exception or just return null with a log message. I think the latter is preferred but let me know your preference.", "author": "sanjaypujare", "createdAt": "2020-04-16T17:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0NzE5Mg==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409747192", "bodyText": "it is definitely preferred to throw exception especially if the caller need to do something.\nLooked at the code i think the getXdsClientWrapperForServerSds shouldn't return null. it should just throw and  serverProtocolNegotiator can handle the exception (or just remove the getXdsClientWrapperForServerSds and inline it since it does not really belong to ServerSdsProtocolNegotiator); it sees exception so it can fallback seems more natural than hmm somehow we have null, lets fallback (not very idiomatic java, it is c style - no offense to c =p).", "author": "creamsoup", "createdAt": "2020-04-16T18:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzMyOA=="}], "type": "inlineReview", "revised_code": {"commit": "4a15ed6e03f37346562c7b49a13678f0bcd7fe27", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientWrapperForServerSds.java b/xds/src/main/java/io/grpc/xds/XdsClientWrapperForServerSds.java\nindex 61d1bac2c..bd803befb 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientWrapperForServerSds.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientWrapperForServerSds.java\n\n@@ -80,11 +91,12 @@ public final class XdsClientWrapperForServerSds {\n    * @param syncContext {@link SynchronizationContext} needed by {@link XdsClient}.\n    */\n   public static XdsClientWrapperForServerSds newInstance(\n-      int port, Bootstrapper bootstrapper, SynchronizationContext syncContext) throws IOException {\n+      int port, Bootstrapper bootstrapper, SynchronizationContext syncContext)\n+      throws IOException, ManagementServerNotFoundException {\n     Bootstrapper.BootstrapInfo bootstrapInfo = bootstrapper.readBootstrap();\n     final List<Bootstrapper.ServerInfo> serverList = bootstrapInfo.getServers();\n     if (serverList.isEmpty()) {\n-      throw new FileNotFoundException(\"No management server provided by bootstrap\");\n+      throw new ManagementServerNotFoundException(\"No management server provided by bootstrap\");\n     }\n     final Node node = bootstrapInfo.getNode();\n     ScheduledExecutorService timeService = SharedResourceHolder.get(timeServiceResource);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409725586", "bodyText": "IIRC there was a test checking scheme http if plaintext. the test should be fixed.", "author": "creamsoup", "createdAt": "2020-04-16T17:25:19Z", "path": "xds/src/main/java/io/grpc/xds/internal/sds/SdsProtocolNegotiators.java", "diffHunk": "@@ -60,7 +60,7 @@ private SdsProtocolNegotiators() {\n \n   private static final Logger logger = Logger.getLogger(SdsProtocolNegotiators.class.getName());\n \n-  private static final AsciiString SCHEME = AsciiString.of(\"https\");\n+  private static final AsciiString SCHEME = AsciiString.of(\"http\");", "originalCommit": "d47d343e8630e6802ae6f23511fba855b3e63037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczOTU3NA==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409739574", "bodyText": "There was/is no test - otherwise the build would have failed. Do you want me to add a test - the test will just verify this init so not sure about it's value.", "author": "sanjaypujare", "createdAt": "2020-04-16T17:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0MTQ2OQ==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409741469", "bodyText": "https://github.com/grpc/grpc-java/blob/master/xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java#L288\nthat test, it was checking \"http\" vs \"https\". now everything is \"http\". this test is no longer relevant and should be fixed.", "author": "creamsoup", "createdAt": "2020-04-16T17:51:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0MzI1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409743251", "bodyText": "Yes, you are right, may bad! I will have to modify the test to detect plaintext vs Sds PN and let me think about it.", "author": "sanjaypujare", "createdAt": "2020-04-16T17:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc1Mzk4Mg==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409753982", "bodyText": "With scheme being the same the only other thing to check is the class-name of the returned protocolNegotiator it should match ...ServerPlaintextNegotiator or should have plaintext in it. Do you have a better suggestion?", "author": "sanjaypujare", "createdAt": "2020-04-16T18:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMzAwNQ==", "url": "https://github.com/grpc/grpc-java/pull/6935#discussion_r409813005", "bodyText": "yeah there isn't a good way to test this other than using name of the class. i think it is fine to check the class name (ServerPlaintextNegotiator).", "author": "creamsoup", "createdAt": "2020-04-16T19:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNTU4Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4a15ed6e03f37346562c7b49a13678f0bcd7fe27", "url": "https://github.com/grpc/grpc-java/commit/4a15ed6e03f37346562c7b49a13678f0bcd7fe27", "message": "address review comments", "committedDate": "2020-04-17T17:28:30Z", "type": "commit"}]}