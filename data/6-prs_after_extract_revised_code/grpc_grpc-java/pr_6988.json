{"pr_number": 6988, "pr_title": "xds: add onResourceDoesNotExist API for resource watchers", "pr_createdAt": "2020-04-29T17:52:30Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6988", "timeline": [{"oid": "47c4d1731da1724c4920ec790071d4fde7bfc2ce", "url": "https://github.com/grpc/grpc-java/commit/47c4d1731da1724c4920ec790071d4fde7bfc2ce", "message": "Refactor watcher interface definition to add an onResourceDoesNotExist api.", "committedDate": "2020-04-29T17:46:21Z", "type": "commit"}, {"oid": "3875565f787a6477fa8d9c979c55f0c16b8920ee", "url": "https://github.com/grpc/grpc-java/commit/3875565f787a6477fa8d9c979c55f0c16b8920ee", "message": "Invoke onResourceDoesNotExist when receiving xDS responses for resource not found.", "committedDate": "2020-04-29T17:48:19Z", "type": "commit"}, {"oid": "134233dde5ee7058c24f357d1c75e9160d2dd15a", "url": "https://github.com/grpc/grpc-java/commit/134233dde5ee7058c24f357d1c75e9160d2dd15a", "message": "Change xDS resolver to use onResourceDoesNotExist() for resource not found.", "committedDate": "2020-04-29T17:49:14Z", "type": "commit"}, {"oid": "233fb9a9e0b275fdb6cddd639123d3655b60eeb7", "url": "https://github.com/grpc/grpc-java/commit/233fb9a9e0b275fdb6cddd639123d3655b60eeb7", "message": "Implement onResourceDoesNotExist in CDS lb policy.", "committedDate": "2020-04-29T17:51:10Z", "type": "commit"}, {"oid": "df07ecc683683560981a47d7eb43c22c60cfda52", "url": "https://github.com/grpc/grpc-java/commit/df07ecc683683560981a47d7eb43c22c60cfda52", "message": "Implement onResourceDoesNotExist in EDS lb policy.", "committedDate": "2020-04-29T17:51:30Z", "type": "commit"}, {"oid": "61a2a91113cbbce31ac9af20d3b9d623aeff7688", "url": "https://github.com/grpc/grpc-java/commit/61a2a91113cbbce31ac9af20d3b9d623aeff7688", "message": "Change Listener watcher to use onResourceDoesNotExist api.", "committedDate": "2020-04-29T19:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NTc4Ng==", "url": "https://github.com/grpc/grpc-java/pull/6988#discussion_r417665786", "bodyText": "Based on the code elsewhere, it looks like you don't wait for a DiscoveryResponse before calling this but you may call it if you found resourceName in the absent*Resources set. Is that semantic correct and agreeable to everyone?", "author": "sanjaypujare", "createdAt": "2020-04-29T23:13:33Z", "path": "xds/src/main/java/io/grpc/xds/XdsClient.java", "diffHunk": "@@ -389,50 +389,60 @@ ListenerUpdate build() {\n     }\n   }\n \n+  /**\n+   * Watcher interface for a single requested xDS resource.\n+   */\n+  private interface ResourceWatcher {\n+\n+    /**\n+     * Called when the resource discovery RPC encounters some transient error.\n+     */\n+    void onError(Status error);\n+\n+    /**\n+     * Called when the requested resource is not available.\n+     *\n+     * @param resourceName name of the resource requested in discovery request.\n+     */\n+    void onResourceDoesNotExist(String resourceName);", "originalCommit": "61a2a91113cbbce31ac9af20d3b9d623aeff7688", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE3ODU2MA==", "url": "https://github.com/grpc/grpc-java/pull/6988#discussion_r418178560", "bodyText": "absent*Resources is the cache for resources that known to be absent. For example, if some watcher is already watching resource A (sent A in request), but A does not exist. We need to memorize this information. When another watcher is added to also watch A, we know immediately it doesn't exist. If we do not memorize that information, the second watcher will never get notified.", "author": "voidzcy", "createdAt": "2020-04-30T17:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY2NTc4Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4MzYzMg==", "url": "https://github.com/grpc/grpc-java/pull/6988#discussion_r417683632", "bodyText": "The actual resource name used in the request in this case was null/empty string. But you are reporting it as \":\" + listenerPort. I don't have a better suggestion other than to put a comment mentioning that.", "author": "sanjaypujare", "createdAt": "2020-04-30T00:09:47Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -730,8 +721,7 @@ private void handleLdsResponseForListener(DiscoveryResponse ldsResponse) {\n       listenerWatcher.onListenerChanged(listenerUpdate);\n     } else {\n       if (ldsRespTimer == null) {\n-        listenerWatcher.onError(Status.NOT_FOUND.withDescription(\"did not find listener for \"\n-            + listenerPort));\n+        listenerWatcher.onResourceDoesNotExist(\":\" + listenerPort);", "originalCommit": "61a2a91113cbbce31ac9af20d3b9d623aeff7688", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNDEzNQ==", "url": "https://github.com/grpc/grpc-java/pull/6988#discussion_r417704135", "bodyText": "Yeah, I noticed that. Maybe the doc on onResourceDoesNotExist() is somewhat imprecise. The argument is the resource name that we are looking for but does not exist. I am going to update that.\nFor Listener watcher, this is kind of ambiguous as it sits on the border of the design (i.e., the way we watch Listener is to request all and select the one we are seeking for). But at least, using \":\" + listenerPort turns out to be better than using null/empty string.\nActually ConfigWatcher also has somewhat similar issue, since resource-not-found may be caused by the intermediate RDS lookup, which uses a different resource name (other than what was used for registering the watcher) for the discovery request. In that case, the onResourceDoesNotExist() callback is invoked (and IMO it should be) with the actual requested RDS resource name.", "author": "voidzcy", "createdAt": "2020-04-30T01:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY4MzYzMg=="}], "type": "inlineReview", "revised_code": null}]}