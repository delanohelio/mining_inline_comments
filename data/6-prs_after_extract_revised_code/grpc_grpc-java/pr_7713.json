{"pr_number": 7713, "pr_title": "core: On unexpected EOS, mention whether the frame was empty", "pr_createdAt": "2020-12-10T00:58:03Z", "pr_url": "https://github.com/grpc/grpc-java/pull/7713", "timeline": [{"oid": "2f4bbb12f518d2ac11c4343d592ba4e8ea2af221", "url": "https://github.com/grpc/grpc-java/commit/2f4bbb12f518d2ac11c4343d592ba4e8ea2af221", "message": "core: On unexpected EOS, mention whether the frame was empty\n\nEmpty DATA frames with EOS tell a stronger tale as to where the server\nmay have its bug.", "committedDate": "2020-12-09T23:07:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUwMDczMw==", "url": "https://github.com/grpc/grpc-java/pull/7713#discussion_r540500733", "bodyText": "The return value of readableBytes() may depend on the current read index, and inboundDataReceived(frame) may have changed the read index?", "author": "dapengzhang0", "createdAt": "2020-12-10T21:13:21Z", "path": "core/src/main/java/io/grpc/internal/Http2ClientStreamTransportState.java", "diffHunk": "@@ -147,8 +147,13 @@ protected void transportDataReceived(ReadableBuffer frame, boolean endOfStream)\n       inboundDataReceived(frame);\n       if (endOfStream) {\n         // This is a protocol violation as we expect to receive trailers.\n-        transportError =\n-            Status.INTERNAL.withDescription(\"Received unexpected EOS on DATA frame from server.\");\n+        if (frame.readableBytes() > 0) {", "originalCommit": "2f4bbb12f518d2ac11c4343d592ba4e8ea2af221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUwNDI3Mw==", "url": "https://github.com/grpc/grpc-java/pull/7713#discussion_r540504273", "bodyText": "Good catch. Fixed. This problem would have impacted #7277 as well.", "author": "ejona86", "createdAt": "2020-12-10T21:19:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDUwMDczMw=="}], "type": "inlineReview", "revised_code": {"commit": "031a7a14ba4645e1854b3a9a44a24a2ffa6a0253", "chunk": "diff --git a/core/src/main/java/io/grpc/internal/Http2ClientStreamTransportState.java b/core/src/main/java/io/grpc/internal/Http2ClientStreamTransportState.java\nindex edab7d0c3..c2bcb350a 100644\n--- a/core/src/main/java/io/grpc/internal/Http2ClientStreamTransportState.java\n+++ b/core/src/main/java/io/grpc/internal/Http2ClientStreamTransportState.java\n\n@@ -144,10 +144,11 @@ public abstract class Http2ClientStreamTransportState extends AbstractClientStre\n             new Metadata());\n         return;\n       }\n+      int frameSize = frame.readableBytes();\n       inboundDataReceived(frame);\n       if (endOfStream) {\n         // This is a protocol violation as we expect to receive trailers.\n-        if (frame.readableBytes() > 0) {\n+        if (frameSize > 0) {\n           transportError = Status.INTERNAL\n               .withDescription(\"Received unexpected EOS on non-empty DATA frame from server\");\n         } else {\n"}}, {"oid": "031a7a14ba4645e1854b3a9a44a24a2ffa6a0253", "url": "https://github.com/grpc/grpc-java/commit/031a7a14ba4645e1854b3a9a44a24a2ffa6a0253", "message": "Save frame size before inboundDataReceived", "committedDate": "2020-12-10T21:17:31Z", "type": "commit"}]}