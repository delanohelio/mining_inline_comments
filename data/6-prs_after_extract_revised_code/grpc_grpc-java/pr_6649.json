{"pr_number": 6649, "pr_title": "all: log picker when updating balancing state", "pr_createdAt": "2020-01-27T22:46:30Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6649", "timeline": [{"oid": "b5031f32fc0994c535372d4b1f86658866f48c41", "url": "https://github.com/grpc/grpc-java/commit/b5031f32fc0994c535372d4b1f86658866f48c41", "message": "all: log picker undate when updating balancing state", "committedDate": "2020-01-27T22:44:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDA2Ng==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371554066", "bodyText": "The default toString() should work fine, or toStringHelper.", "author": "zhangkun83", "createdAt": "2020-01-28T00:17:59Z", "path": "core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java", "diffHunk": "@@ -431,6 +431,11 @@ public String toString() {\n     public PickResult pickSubchannel(PickSubchannelArgs args) {\n       return PickResult.withNoResult();\n     }\n+\n+    @Override\n+    public String toString() {", "originalCommit": "b5031f32fc0994c535372d4b1f86658866f48c41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU3MzMxNQ==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371573315", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-01-28T01:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDA2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "48faf38480dce33febb60dc1a2d452cc356d7273", "chunk": "diff --git a/core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java b/core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java\nindex a5e124612..93da3347b 100644\n--- a/core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java\n+++ b/core/src/main/java/io/grpc/internal/AutoConfiguredLoadBalancerFactory.java\n\n@@ -434,7 +434,7 @@ public final class AutoConfiguredLoadBalancerFactory {\n \n     @Override\n     public String toString() {\n-      return \"Empty picker\";\n+      return MoreObjects.toStringHelper(EmptyPicker.class).toString();\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDMxNw==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371554317", "bodyText": "Better to use toStringHelper in all cases to produce standardized outputs.", "author": "zhangkun83", "createdAt": "2020-01-28T00:18:51Z", "path": "core/src/main/java/io/grpc/internal/OobChannel.java", "diffHunk": "@@ -180,6 +180,11 @@ public Object getInternalSubchannel() {\n         public PickResult pickSubchannel(PickSubchannelArgs args) {\n           return result;\n         }\n+\n+        @Override\n+        public String toString() {\n+          return \"Subchannel picker with pick result: \" + result;", "originalCommit": "b5031f32fc0994c535372d4b1f86658866f48c41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU3MzM1Mw==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371573353", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-01-28T01:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDMxNw=="}], "type": "inlineReview", "revised_code": {"commit": "48faf38480dce33febb60dc1a2d452cc356d7273", "chunk": "diff --git a/core/src/main/java/io/grpc/internal/OobChannel.java b/core/src/main/java/io/grpc/internal/OobChannel.java\nindex f5dba6a8e..aae3314f3 100644\n--- a/core/src/main/java/io/grpc/internal/OobChannel.java\n+++ b/core/src/main/java/io/grpc/internal/OobChannel.java\n\n@@ -173,19 +173,23 @@ final class OobChannel extends ManagedChannel implements InternalInstrumented<Ch\n         }\n     };\n \n-    subchannelPicker = new SubchannelPicker() {\n-        final PickResult result = PickResult.withSubchannel(subchannelImpl);\n-\n-        @Override\n-        public PickResult pickSubchannel(PickSubchannelArgs args) {\n-          return result;\n-        }\n+    final class OobSubchannelPicker extends SubchannelPicker {\n+      final PickResult result = PickResult.withSubchannel(subchannelImpl);\n+\n+      @Override\n+      public PickResult pickSubchannel(PickSubchannelArgs args) {\n+        return result;\n+      }\n+\n+      @Override\n+      public String toString() {\n+        return MoreObjects.toStringHelper(OobSubchannelPicker.class)\n+            .add(\"result\", result)\n+            .toString();\n+      }\n+    }\n \n-        @Override\n-        public String toString() {\n-          return \"Subchannel picker with pick result: \" + result;\n-        }\n-      };\n+    subchannelPicker = new OobSubchannelPicker();\n     delayedTransport.reprocess(subchannelPicker);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDM3MQ==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371554371", "bodyText": "ditto", "author": "zhangkun83", "createdAt": "2020-01-28T00:19:06Z", "path": "core/src/main/java/io/grpc/util/GracefulSwitchLoadBalancer.java", "diffHunk": "@@ -63,6 +63,11 @@ public void handleNameResolutionError(final Status error) {\n             public PickResult pickSubchannel(PickSubchannelArgs args) {\n               return PickResult.withError(error);\n             }\n+\n+            @Override\n+            public String toString() {\n+              return \"Error picker with status: \" + error;", "originalCommit": "b5031f32fc0994c535372d4b1f86658866f48c41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU3MzM4Ng==", "url": "https://github.com/grpc/grpc-java/pull/6649#discussion_r371573386", "bodyText": "Done.", "author": "dapengzhang0", "createdAt": "2020-01-28T01:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU1NDM3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "48faf38480dce33febb60dc1a2d452cc356d7273", "chunk": "diff --git a/core/src/main/java/io/grpc/util/GracefulSwitchLoadBalancer.java b/core/src/main/java/io/grpc/util/GracefulSwitchLoadBalancer.java\nindex 0ab767dc9..ecd1f7757 100644\n--- a/core/src/main/java/io/grpc/util/GracefulSwitchLoadBalancer.java\n+++ b/core/src/main/java/io/grpc/util/GracefulSwitchLoadBalancer.java\n\n@@ -56,19 +57,21 @@ public final class GracefulSwitchLoadBalancer extends ForwardingLoadBalancer {\n \n     @Override\n     public void handleNameResolutionError(final Status error) {\n+      class ErrorPicker extends SubchannelPicker {\n+        @Override\n+        public PickResult pickSubchannel(PickSubchannelArgs args) {\n+          return PickResult.withError(error);\n+        }\n+\n+        @Override\n+        public String toString() {\n+          return MoreObjects.toStringHelper(ErrorPicker.class).add(\"error\", error).toString();\n+        }\n+      }\n+\n       helper.updateBalancingState(\n           ConnectivityState.TRANSIENT_FAILURE,\n-          new SubchannelPicker() {\n-            @Override\n-            public PickResult pickSubchannel(PickSubchannelArgs args) {\n-              return PickResult.withError(error);\n-            }\n-\n-            @Override\n-            public String toString() {\n-              return \"Error picker with status: \" + error;\n-            }\n-          });\n+          new ErrorPicker());\n     }\n \n     @Override\n"}}, {"oid": "48faf38480dce33febb60dc1a2d452cc356d7273", "url": "https://github.com/grpc/grpc-java/commit/48faf38480dce33febb60dc1a2d452cc356d7273", "message": "use toStringHelper for all", "committedDate": "2020-01-28T01:36:03Z", "type": "commit"}]}