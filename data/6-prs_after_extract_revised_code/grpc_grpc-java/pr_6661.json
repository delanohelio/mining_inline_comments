{"pr_number": 6661, "pr_title": "xds: precise logic for selecting the virtual host in RDS responses", "pr_createdAt": "2020-01-30T20:49:48Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6661", "timeline": [{"oid": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "url": "https://github.com/grpc/grpc-java/commit/84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "message": "Correct logic for choosing the right VirtualHost.", "committedDate": "2020-01-30T20:42:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NDc1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373194751", "bodyText": "If both a.example.com (exact matching) and *.example.com (suffix matching ) are in the list, then suffix matching will be finally selected if it comes later.", "author": "dapengzhang0", "createdAt": "2020-01-30T21:09:37Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -624,21 +624,39 @@ private void handleRdsResponse(DiscoveryResponse rdsResponse) {\n   }\n \n   /**\n-   * Processes RouteConfiguration message (from an resource information in an LDS or RDS\n-   * response), which may contain a VirtualHost with domains matching the \"xds:\"\n-   * URI hostname directly in-line. Returns the clusterName found in that VirtualHost\n-   * message. Returns {@code null} if such a clusterName cannot be resolved.\n+   * Processes a RouteConfiguration message to find the name of upstream cluster that requests\n+   * for the given host will be routed to. Returns the clusterName if found.\n+   * Otherwise, returns {@code null}.\n    *\n-   * <p>Note we only validate VirtualHosts with domains matching the \"xds:\" URI hostname.\n    */\n+  @VisibleForTesting\n   @Nullable\n-  private String processRouteConfig(RouteConfiguration config) {\n+  static String findClusterNameInRouteConfig(RouteConfiguration config, String hostname) {\n     List<VirtualHost> virtualHosts = config.getVirtualHostsList();\n-    int matchingLen = -1;  // longest length of wildcard pattern that matches host name\n+    // Domain search order:\n+    //  1. Exact domain names: ``www.foo.com``.\n+    //  2. Suffix domain wildcards: ``*.foo.com`` or ``*-bar.foo.com``.\n+    //  3. Prefix domain wildcards: ``foo.*`` or ``foo-*``.\n+    //  4. Special wildcard ``*`` matching any domain.\n+    //\n+    //  The longest wildcards match first.\n+    //  Assuming only a single virtual host in the entire route configuration can match\n+    //  on ``*`` and a domain must be unique across all virtual hosts.\n+    int matchingLen = -1; // longest length of wildcard pattern that matches host name\n     VirtualHost targetVirtualHost = null;  // target VirtualHost with longest matched domain\n     for (VirtualHost vHost : virtualHosts) {\n       for (String domain : vHost.getDomainsList()) {\n-        if (matchHostName(hostName, domain) && domain.length() > matchingLen) {\n+        boolean selected = false;\n+        if (matchHostName(hostname, domain)) { // matching\n+          if (!domain.contains(\"*\")) { // exact matching\n+            selected = true;\n+          } else if (domain.length() > matchingLen) { // longer matching pattern\n+            selected = true;\n+          } else if (domain.length() == matchingLen && domain.startsWith(\"*\")) { // suffix matching", "originalCommit": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI0MDM1OQ==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373240359", "bodyText": "Yep. Fix.", "author": "voidzcy", "createdAt": "2020-01-30T23:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NDc1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "39bad7060fc4ef86b14e8dab44961fc1f9e9b387", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex f6d54513b..fffb8c02e 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -627,11 +627,10 @@ final class XdsClientImpl extends XdsClient {\n    * Processes a RouteConfiguration message to find the name of upstream cluster that requests\n    * for the given host will be routed to. Returns the clusterName if found.\n    * Otherwise, returns {@code null}.\n-   *\n    */\n   @VisibleForTesting\n   @Nullable\n-  static String findClusterNameInRouteConfig(RouteConfiguration config, String hostname) {\n+  static String findClusterNameInRouteConfig(RouteConfiguration config, String hostName) {\n     List<VirtualHost> virtualHosts = config.getVirtualHostsList();\n     // Domain search order:\n     //  1. Exact domain names: ``www.foo.com``.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NzQzMw==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373197433", "bodyText": "Not sure about the spec. If the best matching targetVirtualHost doesn't satisfy this condition, but the rank 2 matching satisfies, still return null?", "author": "dapengzhang0", "createdAt": "2020-01-30T21:15:51Z", "path": "xds/src/main/java/io/grpc/xds/XdsClientImpl.java", "diffHunk": "@@ -649,13 +667,15 @@ private String processRouteConfig(RouteConfiguration config) {\n     // hostname in original \"xds:\" URI.\n     if (targetVirtualHost != null) {\n       // The client will look only at the last route in the list (the default route),\n-      // whose match field must be empty and whose route field must be set.\n+      // whose match field must contain a prefix field whose value is empty string\n+      // and whose route field must be set.", "originalCommit": "84f21c21d33e548b03ad7c38c4f77dbab9127eeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwNDQxMQ==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373204411", "bodyText": "Hmm... That's very subtle edge case. It's not specified (and I guess this detail won't be specified precisely even in the future, as this detail is very deep in terms of implementation). But I think returning null would make more sense. Domain matching decides which virtual host to be routed to, if that virtual host is not configured correctly for gRPC, then returning null as for result not found will at least raise our attention if this causes failure. If we've ever hit such an edge case, discussions will be brought up. I think for now, we don't need to consider this too complicatedly.", "author": "voidzcy", "createdAt": "2020-01-30T21:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NzQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIwOTI2Mw==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373209263", "bodyText": "It may worth a comment to describe the behavior of our implementation or rationale of our choice for the edge case.", "author": "dapengzhang0", "createdAt": "2020-01-30T21:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NzQzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI0MDM5NQ==", "url": "https://github.com/grpc/grpc-java/pull/6661#discussion_r373240395", "bodyText": "Okay.", "author": "voidzcy", "createdAt": "2020-01-30T23:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE5NzQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "700bcf50b9c6fb4a6610220ef947b3b4cebb6626", "chunk": "diff --git a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\nindex f6d54513b..a2c3dffe3 100644\n--- a/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n+++ b/xds/src/main/java/io/grpc/xds/XdsClientImpl.java\n\n@@ -661,6 +663,9 @@ final class XdsClientImpl extends XdsClient {\n           targetVirtualHost = vHost;\n         }\n       }\n+      if (exactMatchFound) {\n+        break;\n+      }\n     }\n \n     // Proceed with the virtual host that has longest wildcard matched domain name with the\n"}}, {"oid": "39bad7060fc4ef86b14e8dab44961fc1f9e9b387", "url": "https://github.com/grpc/grpc-java/commit/39bad7060fc4ef86b14e8dab44961fc1f9e9b387", "message": "Fix style issue.", "committedDate": "2020-01-30T21:49:03Z", "type": "commit"}, {"oid": "700bcf50b9c6fb4a6610220ef947b3b4cebb6626", "url": "https://github.com/grpc/grpc-java/commit/700bcf50b9c6fb4a6610220ef947b3b4cebb6626", "message": "Fix logic bug of domain matching. A domain name with ending asterisk takes over exact matching if appears after the exact matching domain and the asterisk matches a single character.", "committedDate": "2020-01-30T22:56:11Z", "type": "commit"}, {"oid": "0fdd04e8aef5ca55bef6d72ce322c36ee37365d2", "url": "https://github.com/grpc/grpc-java/commit/0fdd04e8aef5ca55bef6d72ce322c36ee37365d2", "message": "Add a note for subtle edge case of selected virtual host not correctly configured.", "committedDate": "2020-01-30T23:01:04Z", "type": "commit"}]}