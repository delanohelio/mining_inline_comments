{"pr_number": 6924, "pr_title": "xds: remove UpstreamTlsContext from XdsChannelBuilder", "pr_createdAt": "2020-04-14T06:43:39Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6924", "timeline": [{"oid": "00f64655885b650e9e821277006a94795893df58", "url": "https://github.com/grpc/grpc-java/commit/00f64655885b650e9e821277006a94795893df58", "message": "xds: remove UpstreamTlsContext from XdsChannelBuilder", "committedDate": "2020-04-14T06:25:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODY5Ng==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408378696", "bodyText": "this seems very hard / messy to use the SdsNameResolver. Can you do something similar to FakeNameResolver in ManagedChannelImplTest. it is not the best example, but seems simpler than this. also, it is using less resources and provider easier interface to test. Mock should be last option to consider. (e.g. this code can be easily converted to fake impl which will be much shorter and easier to read)", "author": "creamsoup", "createdAt": "2020-04-14T19:22:27Z", "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -181,12 +205,38 @@ private static int findFreePort() throws IOException {\n   }\n \n   private SimpleServiceGrpc.SimpleServiceBlockingStub getBlockingStub(\n-      UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n-    XdsChannelBuilder builder =\n-        XdsChannelBuilder.forTarget(\"localhost:\" + port).tlsContext(upstreamTlsContext);\n+      final UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n+    XdsChannelBuilder builder = XdsChannelBuilder.forTarget(\"sdstest:///localhost:\" + port);\n     if (overrideAuthority != null) {\n       builder = builder.overrideAuthority(overrideAuthority);\n     }\n+    doAnswer(", "originalCommit": "00f64655885b650e9e821277006a94795893df58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3ODkxNg==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408478916", "bodyText": "I find doing mock and doAnswer simpler than how ManagedChannelImplTest.FakeNameResolverFactory.FakeNameResolver does it because you mock/construct the required input inline. But I realize this is subjective and if mock is not the preferred pattern for most people I will switch to it.", "author": "sanjaypujare", "createdAt": "2020-04-14T22:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUwNjgxMQ==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408506811", "bodyText": "no, this is not subjective at all.\nmock is definitely anti pattern, in this case it is very easy to not use the mock (even as it is).\nBut the worse part is the TestSdsNameResolver extends the DnsNameResolver for no reason. The actual use case in test will be the interceptor (Callback) intercepts the onResult and returns a fake result. However, because it is a real DnsNameResolver, it uses thread for no reason, it performs IO for no reason. it even can call Listner#onError unless it is localhost (otherwise it will be environment dependent), and therefore it is pretty much localhost only NameResolver. List can goes on and on. Why we do all of those if we can just make a fake NameResolver, expects a URI and returns a specific value or an error?", "author": "creamsoup", "createdAt": "2020-04-15T00:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODY5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxMzU2NQ==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408513565", "bodyText": "I wanted to do something more general than only for localhost (assuming it could be useful later) so decided to extend DnsNameResolver to be able to add the \"mock\" attribute for all returned addresses.\nI agree the\nManagedChannelImplTest.FakeNameResolverFactory.FakeNameResolver pattern is less intrusive and easier to understand and I will use it. I will be \"hardcoding\" the localhost -> 127.0.0.1 mapping in my FakeNameResolver. There are cases where the loopback adapter (i.e. 127.0.0.1) is not configured or localhost does not resolve to 127.0.0.1 (but a configured local IP) although very rare - which was another reason I used the DnsNameResolver (\"the environment\").", "author": "sanjaypujare", "createdAt": "2020-04-15T00:33:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b3dddbf2b904d7fd512bef8fa0d3554640c21b22", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\nindex d6939fe72..d294df083 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n\n@@ -206,37 +209,16 @@ public class XdsSdsClientServerTest {\n \n   private SimpleServiceGrpc.SimpleServiceBlockingStub getBlockingStub(\n       final UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n-    XdsChannelBuilder builder = XdsChannelBuilder.forTarget(\"sdstest:///localhost:\" + port);\n     if (overrideAuthority != null) {\n       builder = builder.overrideAuthority(overrideAuthority);\n     }\n-    doAnswer(\n-        new Answer<NameResolver.ResolutionResult>() {\n-          @Override\n-          public NameResolver.ResolutionResult answer(InvocationOnMock invocation)\n-              throws Throwable {\n-            Object[] args = invocation.getArguments();\n-            NameResolver.ResolutionResult resolutionResult =\n-                (NameResolver.ResolutionResult) args[0];\n-            List<EquivalentAddressGroup> addresses = resolutionResult.getAddresses();\n-            if (upstreamTlsContext != null && addresses != null) {\n-              ArrayList<EquivalentAddressGroup> copyList = new ArrayList<>(addresses.size());\n-              for (EquivalentAddressGroup eag : addresses) {\n-                EquivalentAddressGroup eagCopy =\n-                    new EquivalentAddressGroup(\n-                        eag.getAddresses(),\n-                        eag.getAttributes().toBuilder()\n-                            .set(XdsAttributes.ATTR_UPSTREAM_TLS_CONTEXT, upstreamTlsContext)\n-                            .build());\n-                copyList.add(eagCopy);\n-              }\n-              resolutionResult = resolutionResult.toBuilder().setAddresses(copyList).build();\n-            }\n-            return resolutionResult;\n-          }\n-        })\n-        .when(callback)\n-        .onResult(any(NameResolver.ResolutionResult.class));\n+    InetSocketAddress socketAddress = new InetSocketAddress(Inet4Address.getLoopbackAddress(),\n+        port);\n+    Attributes attrs = (upstreamTlsContext != null) ? Attributes.newBuilder()\n+        .set(XdsAttributes.ATTR_UPSTREAM_TLS_CONTEXT, upstreamTlsContext).build()\n+        : Attributes.EMPTY;\n+    fakeNameResolverFactory\n+        .setServers(Collections.singletonList(new EquivalentAddressGroup(socketAddress, attrs)));\n     return SimpleServiceGrpc.newBlockingStub(cleanupRule.register(builder.build()));\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODY1MA==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408388650", "bodyText": "nit: should be noTlsContext, null is not allowed.", "author": "creamsoup", "createdAt": "2020-04-14T19:40:41Z", "path": "xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java", "diffHunk": "@@ -143,9 +147,8 @@ private static CommonTlsContext getCommonTlsContext(\n   }\n \n   @Test\n-  public void clientSdsProtocolNegotiatorNewHandler_nullTlsContext() {\n-    ClientSdsProtocolNegotiator pn =\n-        new ClientSdsProtocolNegotiator(/* upstreamTlsContext= */ null);\n+  public void clientSdsProtocolNegotiatorNewHandler_nullTlsContextAttribute() {", "originalCommit": "00f64655885b650e9e821277006a94795893df58", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3dddbf2b904d7fd512bef8fa0d3554640c21b22", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java b/xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java\nindex eb29a4288..4c500653e 100644\n--- a/xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java\n+++ b/xds/src/test/java/io/grpc/xds/internal/sds/SdsProtocolNegotiatorsTest.java\n\n@@ -147,7 +147,7 @@ public class SdsProtocolNegotiatorsTest {\n   }\n \n   @Test\n-  public void clientSdsProtocolNegotiatorNewHandler_nullTlsContextAttribute() {\n+  public void clientSdsProtocolNegotiatorNewHandler_noTlsContextAttribute() {\n     ClientSdsProtocolNegotiator pn = new ClientSdsProtocolNegotiator();\n     ChannelHandler newHandler = pn.newHandler(grpcHandler);\n     assertThat(newHandler).isNotNull();\n"}}, {"oid": "b3dddbf2b904d7fd512bef8fa0d3554640c21b22", "url": "https://github.com/grpc/grpc-java/commit/b3dddbf2b904d7fd512bef8fa0d3554640c21b22", "message": "address review comments: implement FakeNameResolver to set attrs", "committedDate": "2020-04-15T03:53:48Z", "type": "commit"}, {"oid": "857df3b5d6008e8737fbcdb316ce56318db2a901", "url": "https://github.com/grpc/grpc-java/commit/857df3b5d6008e8737fbcdb316ce56318db2a901", "message": "java fix format", "committedDate": "2020-04-15T04:51:57Z", "type": "commit"}, {"oid": "d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "url": "https://github.com/grpc/grpc-java/commit/d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "message": "minor refactor/cleanup", "committedDate": "2020-04-15T05:17:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU5MTQxMA==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408591410", "bodyText": "this seems worse than what it used to be. this is not even used elsewhere.", "author": "creamsoup", "createdAt": "2020-04-15T05:36:45Z", "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -59,15 +73,23 @@\n \n   @Rule public final GrpcCleanupRule cleanupRule = new GrpcCleanupRule();\n   private int port;\n+  private FakeNameResolverFactory fakeNameResolverFactory;\n+  private XdsChannelBuilder channelBuilder;\n \n   @Before\n-  public void setUp() throws IOException {\n+  public void setUp() throws IOException, URISyntaxException {\n+    MockitoAnnotations.initMocks(this);\n     port = findFreePort();\n+    URI expectedUri = new URI(\"sdstest://localhost:\" + port);\n+    fakeNameResolverFactory = new FakeNameResolverFactory.Builder(expectedUri).build();\n+    channelBuilder =", "originalCommit": "d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "073c767207488d6f9814f9e14e8b36c5b1c8a08c", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\nindex 51bc119b0..29a8fd7f9 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n\n@@ -73,22 +69,15 @@ public class XdsSdsClientServerTest {\n \n   @Rule public final GrpcCleanupRule cleanupRule = new GrpcCleanupRule();\n   private int port;\n-  private FakeNameResolverFactory fakeNameResolverFactory;\n-  private XdsChannelBuilder channelBuilder;\n \n   @Before\n   public void setUp() throws IOException, URISyntaxException {\n     MockitoAnnotations.initMocks(this);\n     port = findFreePort();\n-    URI expectedUri = new URI(\"sdstest://localhost:\" + port);\n-    fakeNameResolverFactory = new FakeNameResolverFactory.Builder(expectedUri).build();\n-    channelBuilder =\n-        XdsChannelBuilder.forTarget(\"sdstest://localhost:\" + port)\n-            .nameResolverFactory(fakeNameResolverFactory);\n   }\n \n   @Test\n-  public void plaintextClientServer() throws IOException {\n+  public void plaintextClientServer() throws IOException, URISyntaxException {\n     buildServerWithTlsContext(/* downstreamTlsContext= */ null);\n \n     SimpleServiceGrpc.SimpleServiceBlockingStub blockingStub =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU5MjEwMQ==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408592101", "bodyText": "nit/java optional suggestion: using ImmutableList is preferred than Collections.singletonList especially if ImmutableList is already imported.", "author": "creamsoup", "createdAt": "2020-04-15T05:38:47Z", "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -181,13 +203,21 @@ private static int findFreePort() throws IOException {\n   }\n \n   private SimpleServiceGrpc.SimpleServiceBlockingStub getBlockingStub(\n-      UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n-    XdsChannelBuilder builder =\n-        XdsChannelBuilder.forTarget(\"localhost:\" + port).tlsContext(upstreamTlsContext);\n+      final UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n     if (overrideAuthority != null) {\n-      builder = builder.overrideAuthority(overrideAuthority);\n+      channelBuilder = channelBuilder.overrideAuthority(overrideAuthority);\n     }\n-    return SimpleServiceGrpc.newBlockingStub(cleanupRule.register(builder.build()));\n+    InetSocketAddress socketAddress =\n+        new InetSocketAddress(Inet4Address.getLoopbackAddress(), port);\n+    Attributes attrs =\n+        (upstreamTlsContext != null)\n+            ? Attributes.newBuilder()\n+                .set(XdsAttributes.ATTR_UPSTREAM_TLS_CONTEXT, upstreamTlsContext)\n+                .build()\n+            : Attributes.EMPTY;\n+    fakeNameResolverFactory.setServers(\n+        Collections.singletonList(new EquivalentAddressGroup(socketAddress, attrs)));", "originalCommit": "d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "073c767207488d6f9814f9e14e8b36c5b1c8a08c", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\nindex 51bc119b0..29a8fd7f9 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n\n@@ -203,7 +193,14 @@ public class XdsSdsClientServerTest {\n   }\n \n   private SimpleServiceGrpc.SimpleServiceBlockingStub getBlockingStub(\n-      final UpstreamTlsContext upstreamTlsContext, String overrideAuthority) {\n+      final UpstreamTlsContext upstreamTlsContext, String overrideAuthority)\n+      throws URISyntaxException {\n+    URI expectedUri = new URI(\"sdstest://localhost:\" + port);\n+    FakeNameResolverFactory fakeNameResolverFactory = new FakeNameResolverFactory.Builder(\n+        expectedUri).build();\n+    XdsChannelBuilder channelBuilder =\n+        XdsChannelBuilder.forTarget(\"sdstest://localhost:\" + port)\n+            .nameResolverFactory(fakeNameResolverFactory);\n     if (overrideAuthority != null) {\n       channelBuilder = channelBuilder.overrideAuthority(overrideAuthority);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU5MjMyOQ==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408592329", "bodyText": "this doesn't match to sdstest", "author": "creamsoup", "createdAt": "2020-04-15T05:39:23Z", "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -210,4 +240,121 @@ public void unaryRpc(SimpleRequest req, StreamObserver<SimpleResponse> responseO\n       responseObserver.onCompleted();\n     }\n   }\n+\n+  private static final class FakeNameResolverFactory extends NameResolver.Factory {\n+    final URI expectedUri;\n+    List<EquivalentAddressGroup> servers = ImmutableList.of();\n+    final boolean resolvedAtStart;\n+    final Status error;\n+    final ArrayList<FakeNameResolver> resolvers = new ArrayList<>();\n+    final AtomicReference<ConfigOrError> nextConfigOrError = new AtomicReference<>();\n+\n+    FakeNameResolverFactory(URI expectedUri, boolean resolvedAtStart, Status error) {\n+      this.expectedUri = expectedUri;\n+      this.resolvedAtStart = resolvedAtStart;\n+      this.error = error;\n+    }\n+\n+    void setServers(List<EquivalentAddressGroup> servers) {\n+      this.servers = servers;\n+    }\n+\n+    @Override\n+    public NameResolver newNameResolver(final URI targetUri, NameResolver.Args args) {\n+      if (!expectedUri.equals(targetUri)) {\n+        return null;\n+      }\n+      FakeNameResolver resolver = new FakeNameResolver(error);\n+      resolvers.add(resolver);\n+      return resolver;\n+    }\n+\n+    @Override\n+    public String getDefaultScheme() {\n+      return \"fake\";", "originalCommit": "d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "073c767207488d6f9814f9e14e8b36c5b1c8a08c", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\nindex 51bc119b0..29a8fd7f9 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n\n@@ -244,15 +241,10 @@ public class XdsSdsClientServerTest {\n   private static final class FakeNameResolverFactory extends NameResolver.Factory {\n     final URI expectedUri;\n     List<EquivalentAddressGroup> servers = ImmutableList.of();\n-    final boolean resolvedAtStart;\n-    final Status error;\n     final ArrayList<FakeNameResolver> resolvers = new ArrayList<>();\n-    final AtomicReference<ConfigOrError> nextConfigOrError = new AtomicReference<>();\n \n-    FakeNameResolverFactory(URI expectedUri, boolean resolvedAtStart, Status error) {\n+    FakeNameResolverFactory(URI expectedUri) {\n       this.expectedUri = expectedUri;\n-      this.resolvedAtStart = resolvedAtStart;\n-      this.error = error;\n     }\n \n     void setServers(List<EquivalentAddressGroup> servers) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODU5MjYxNg==", "url": "https://github.com/grpc/grpc-java/pull/6924#discussion_r408592616", "bodyText": "you can remove unused code. private unused code is dead code.", "author": "creamsoup", "createdAt": "2020-04-15T05:40:20Z", "path": "xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java", "diffHunk": "@@ -210,4 +240,121 @@ public void unaryRpc(SimpleRequest req, StreamObserver<SimpleResponse> responseO\n       responseObserver.onCompleted();\n     }\n   }\n+\n+  private static final class FakeNameResolverFactory extends NameResolver.Factory {", "originalCommit": "d93a277423e02d48b3cdaaabb8cbb8c8e9cca62c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "073c767207488d6f9814f9e14e8b36c5b1c8a08c", "chunk": "diff --git a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\nindex 51bc119b0..29a8fd7f9 100644\n--- a/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n+++ b/xds/src/test/java/io/grpc/xds/XdsSdsClientServerTest.java\n\n@@ -244,15 +241,10 @@ public class XdsSdsClientServerTest {\n   private static final class FakeNameResolverFactory extends NameResolver.Factory {\n     final URI expectedUri;\n     List<EquivalentAddressGroup> servers = ImmutableList.of();\n-    final boolean resolvedAtStart;\n-    final Status error;\n     final ArrayList<FakeNameResolver> resolvers = new ArrayList<>();\n-    final AtomicReference<ConfigOrError> nextConfigOrError = new AtomicReference<>();\n \n-    FakeNameResolverFactory(URI expectedUri, boolean resolvedAtStart, Status error) {\n+    FakeNameResolverFactory(URI expectedUri) {\n       this.expectedUri = expectedUri;\n-      this.resolvedAtStart = resolvedAtStart;\n-      this.error = error;\n     }\n \n     void setServers(List<EquivalentAddressGroup> servers) {\n"}}, {"oid": "073c767207488d6f9814f9e14e8b36c5b1c8a08c", "url": "https://github.com/grpc/grpc-java/commit/073c767207488d6f9814f9e14e8b36c5b1c8a08c", "message": "address review comments - 2nd set", "committedDate": "2020-04-15T15:46:57Z", "type": "commit"}, {"oid": "648836fbb8a3309175eafef5c8d6ef4827b9bd4d", "url": "https://github.com/grpc/grpc-java/commit/648836fbb8a3309175eafef5c8d6ef4827b9bd4d", "message": "address review comments - 3nd set", "committedDate": "2020-04-15T16:04:02Z", "type": "commit"}]}