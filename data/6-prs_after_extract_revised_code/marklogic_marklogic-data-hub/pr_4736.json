{"pr_number": 4736, "pr_title": "DHFPROD-6121: Set the right target database in mapping step navigation", "pr_createdAt": "2020-10-19T21:12:08Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4736", "timeline": [{"oid": "c07f83554e55e71b038382c4a233f3c05a0f961f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c07f83554e55e71b038382c4a233f3c05a0f961f", "message": "DHFPROD-6121: Set the right target database in mapping step navigation", "committedDate": "2020-10-20T16:21:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4MzcwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508783700", "bodyText": "Is this always true? Or is it only true if targetDatabase is configured in the step options?", "author": "rjrudin", "createdAt": "2020-10-20T19:27:07Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java", "diffHunk": "@@ -126,6 +126,7 @@ void test() throws Exception {\n                 .andDo(result -> {\n                     JsonNode response = parseJsonResponse(result);\n                 assertEquals(mappingInfo.targetEntityType, response.path(\"stepResponses\").path(\"1\").path(\"targetEntityType\").asText(), \"Info for the step should specify the Target Entity Type; response: \" + response);\n+                assertEquals(\"final\", response.path(\"stepResponses\").path(\"1\").path(\"targetDatabase\").asText(), \"Info for the step should specify the target database; response: \" + response);", "originalCommit": "c07f83554e55e71b038382c4a233f3c05a0f961f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg2Njc4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508866780", "bodyText": "It's only true if targetDatabase is configured in step options.", "author": "akshaysonvane", "createdAt": "2020-10-20T22:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4MzcwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMDIxNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509520217", "bodyText": "Can you add that to the assertion message? The current assertion message is restating what the assertEquals is communicating - that we expect the stepResponse to have the targetDatabase. The assertion message needs to explain why that is - in this case, the reason is that if the step options contain targetDatabase, then it's expected to be added to the stepResponse.", "author": "rjrudin", "createdAt": "2020-10-21T17:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4MzcwMA=="}], "type": "inlineReview", "revised_code": {"commit": "7f97041eb493bf5f84b91bd7761df33749db2238", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java\nindex 2fe97dc53..b9f2070c7 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/FlowControllerTest.java\n\n@@ -126,7 +126,7 @@ public class FlowControllerTest extends AbstractMvcTest {\n                 .andDo(result -> {\n                     JsonNode response = parseJsonResponse(result);\n                 assertEquals(mappingInfo.targetEntityType, response.path(\"stepResponses\").path(\"1\").path(\"targetEntityType\").asText(), \"Info for the step should specify the Target Entity Type; response: \" + response);\n-                assertEquals(\"final\", response.path(\"stepResponses\").path(\"1\").path(\"targetDatabase\").asText(), \"Info for the step should specify the target database; response: \" + response);\n+                assertEquals(\"final\", response.path(\"stepResponses\").path(\"1\").path(\"targetDatabase\").asText(), \"Step response should specify the target database since the step options contain the targetDatabase; response: \" + response);\n             });\n \n         // Remove the step\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4NDU0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508784547", "bodyText": "It's a bit difficult to look at this and be sure there's no error. I think some unit tests are needed for the withStep method - none exist yet. Those tests would verify that targetDatabase is set if it exists in the options for the given step, but not set if targetDatabase doesn't exist in the given step's options but does exist in another step's options.", "author": "rjrudin", "createdAt": "2020-10-20T19:28:46Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/RunStepResponse.java", "diffHunk": "@@ -90,6 +92,7 @@ public RunStepResponse withStep(String stepNum) {\n         if (targetEntityTextNode != null) {\n             this.targetEntityType = targetEntityTextNode.asText();\n         }\n+        Optional.of(step.getOptions()).map(optionMap -> (TextNode) optionMap.get(\"targetDatabase\")).ifPresent(node -> this.targetDatabase = node.asText());", "originalCommit": "c07f83554e55e71b038382c4a233f3c05a0f961f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc4Njc1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r508786756", "bodyText": "I don't see any test coverage for this. I think it would be reasonable to do unit tests against this method with a fake jobNode - i.e. no need to run a job first.", "author": "rjrudin", "createdAt": "2020-10-20T19:32:54Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/JobsController.java", "diffHunk": "@@ -62,12 +65,38 @@ private JsonNode flattenJobsJson(JsonNode jobJSON) {\n             });\n             return array;\n         } else if (jobJSON.has(\"job\")) {\n-            return jobJSON.get(\"job\");\n+            return processTargetDatabase(jobJSON.get(\"job\"));\n         } else {\n             return jobJSON;\n         }\n     }\n \n+    /**", "originalCommit": "c07f83554e55e71b038382c4a233f3c05a0f961f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "message": "DHFPROD-6121: Set the right target database in mapping step navigation", "committedDate": "2020-10-21T17:24:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMTk3NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509521974", "bodyText": "Because this test has no dependency on ML or Spring, don't extend this base class. Just instantiate a new JobsController. That makes it clear that the method being tested has no dependencies too (and the test runs a bit faster too).", "author": "rjrudin", "createdAt": "2020-10-21T17:58:06Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/JobsControllerTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.central.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.hub.central.AbstractHubCentralTest;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class JobsControllerTest extends AbstractHubCentralTest {", "originalCommit": "6f48eb32f299b1b36bc1a882e5f6e40fa8878f9b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzMTM5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509531399", "bodyText": "The processTargetDatabase function in JobsController depends on Spring since it needs access to the HubClient for getting the database name.", "author": "akshaysonvane", "createdAt": "2020-10-21T18:04:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMTk3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTU2MDEwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4736#discussion_r509560107", "bodyText": "Ah - bummer", "author": "rjrudin", "createdAt": "2020-10-21T18:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUyMTk3NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7f97041eb493bf5f84b91bd7761df33749db2238", "message": "DHFPROD-6121: Set the right target database in mapping step navigation", "committedDate": "2020-10-21T18:06:59Z", "type": "commit"}, {"oid": "7f97041eb493bf5f84b91bd7761df33749db2238", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7f97041eb493bf5f84b91bd7761df33749db2238", "message": "DHFPROD-6121: Set the right target database in mapping step navigation", "committedDate": "2020-10-21T18:06:59Z", "type": "forcePushed"}]}