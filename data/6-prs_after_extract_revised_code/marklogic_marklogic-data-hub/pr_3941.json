{"pr_number": 3941, "pr_title": "DHFPROD-4704: Deploy entity model configs after saving an entity", "pr_createdAt": "2020-05-12T22:49:44Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3941", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5NzM1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424397356", "bodyText": "Yeah I think this is fine here for now. Once we know it's all working correctly, we can consider how to refactor it into DH core and possibly replace parts of EntityManagerImpl with it.", "author": "rjrudin", "createdAt": "2020-05-13T12:28:50Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +84,85 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 0fcb607fc..8eb4971ab 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -96,56 +98,103 @@ public class ModelController extends BaseController {\n \n     void deployModelConfigs() {\n         ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n-        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n-        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n \n         JsonNode modelConfigNode = newService().generateModelConfig();\n \n-        // Deploy search options\n-        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n-        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployQueryRolesets(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"queryRolesets\").forEach(jsonNode -> {\n+                try {\n+                    manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString());\n+                }\n+                catch (HttpClientErrorException ex) {\n+                    QueryRolesetUtil.handleSaveException(ex);\n+                }\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy query-rolesets after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployProtectedPaths(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"protectedPaths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy protected-paths after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deploySearchOptions(JsonNode modelConfigNode) {\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        String explorerOptions = modelConfigNode.get(\"searchOptions\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"searchOptions\").get(\"default\").asText();\n         Map<String, DatabaseClient> clientMap = new HashMap<>();\n         clientMap.put(\"staging\", stagingDatabaseClient);\n         clientMap.put(\"final\", finalDatabaseClient);\n         clientMap.forEach((databaseKind, databaseClient) -> {\n             QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n-            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n-            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+            writeOptions(databaseKind, queryOptionsManager, \"exp-\" + databaseKind + \"-entity-options\", explorerOptions);\n+            writeOptions(databaseKind, queryOptionsManager, databaseKind + \"-entity-options\", defaultOptions);\n         });\n+    }\n \n-        // Deploy protected-paths\n-        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n-\n-        // Deploy query-rolesets\n+    private void writeOptions(String databaseKind, QueryOptionsManager queryOptionsManager, String optionName, String options) {\n         try {\n-            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));\n+            queryOptionsManager.writeOptionsAs(optionName, Format.XML, options);\n         }\n-        catch (HttpClientErrorException ex) {\n-            QueryRolesetUtil.handleSaveException(ex);\n+        catch (Exception e) {\n+            throw new RuntimeException(String.format(\"Unable to deploy search options file %s to %s database after updating entity models.\", optionName, databaseKind), e);\n         }\n+    }\n \n-        // Deploy index configuration\n-        modelConfigNode.get(\"index\").get(\"database-names\").forEach(dbNameNode -> {\n-            // Get updated entity index configs\n-            JsonNode indexNode = modelConfigNode.get(\"index\").get(\"index-config\");\n-\n-            try {\n-                // Get current db configuration\n-                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\");\n-                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n-\n-                // Get fields common to current db config and updated entity index config\n-                JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n-\n-                // Merge fields so that we dont delete any existing index config that's not in the entity index config\n-                indexNode = JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n-            }\n-            catch (JsonProcessingException e) {\n-                throw new RuntimeException(e);\n-            }\n-\n-            manageClient.putJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\", indexNode.toString());\n-        });\n+    /**\n+     * Gets fields common to both dbNode and indexNode and then merges them together.\n+     *\n+     * @param dbNode\n+     * @param indexNode\n+     * @return - Merged node\n+     */\n+    protected JsonNode mergeIndexConfigs(JsonNode dbNode, JsonNode indexNode) {\n+        // Get fields common to current db config and updated entity index config\n+        JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n+\n+        // Merge fields so that we dont delete any existing index config that's not in the entity index config\n+        return JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n     }\n \n     private JsonNode getCommonFields(JsonNode targetNode, JsonNode sourceNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5OTQ3Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424399472", "bodyText": "Let's put each of these deploy steps in a separate private method and then put each call to ML in a try-catch iof the form:\ntry {\n     make a single call to ML - e.g. to deploy explorer search options to staging\n} catch (Exception ex) {\n     throw new RuntimeException(\"Unable to deploy explorer search options to staging after updating entity models: cause: \" + ex.getMessage(), ex);\n}\n\nThe reason for this is that the typical errors we get back from the Manage API and REST API don't give a ton of context and often lead to the conclusion of \"Gradle is broken, we must replace it\". Gradle isn't being used here, so hopefully it won't be blamed, but providing some context around the source of the error will be helpful.", "author": "rjrudin", "createdAt": "2020-05-13T12:32:20Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +84,85 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        // Deploy search options\n+        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4NjkzMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425986930", "bodyText": "Right, updated in here b6777af", "author": "akshaysonvane", "createdAt": "2020-05-15T18:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM5OTQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 0fcb607fc..8eb4971ab 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -96,56 +98,103 @@ public class ModelController extends BaseController {\n \n     void deployModelConfigs() {\n         ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n-        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n-        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n \n         JsonNode modelConfigNode = newService().generateModelConfig();\n \n-        // Deploy search options\n-        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n-        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployQueryRolesets(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"queryRolesets\").forEach(jsonNode -> {\n+                try {\n+                    manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString());\n+                }\n+                catch (HttpClientErrorException ex) {\n+                    QueryRolesetUtil.handleSaveException(ex);\n+                }\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy query-rolesets after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployProtectedPaths(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"protectedPaths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy protected-paths after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deploySearchOptions(JsonNode modelConfigNode) {\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        String explorerOptions = modelConfigNode.get(\"searchOptions\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"searchOptions\").get(\"default\").asText();\n         Map<String, DatabaseClient> clientMap = new HashMap<>();\n         clientMap.put(\"staging\", stagingDatabaseClient);\n         clientMap.put(\"final\", finalDatabaseClient);\n         clientMap.forEach((databaseKind, databaseClient) -> {\n             QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n-            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n-            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+            writeOptions(databaseKind, queryOptionsManager, \"exp-\" + databaseKind + \"-entity-options\", explorerOptions);\n+            writeOptions(databaseKind, queryOptionsManager, databaseKind + \"-entity-options\", defaultOptions);\n         });\n+    }\n \n-        // Deploy protected-paths\n-        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n-\n-        // Deploy query-rolesets\n+    private void writeOptions(String databaseKind, QueryOptionsManager queryOptionsManager, String optionName, String options) {\n         try {\n-            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));\n+            queryOptionsManager.writeOptionsAs(optionName, Format.XML, options);\n         }\n-        catch (HttpClientErrorException ex) {\n-            QueryRolesetUtil.handleSaveException(ex);\n+        catch (Exception e) {\n+            throw new RuntimeException(String.format(\"Unable to deploy search options file %s to %s database after updating entity models.\", optionName, databaseKind), e);\n         }\n+    }\n \n-        // Deploy index configuration\n-        modelConfigNode.get(\"index\").get(\"database-names\").forEach(dbNameNode -> {\n-            // Get updated entity index configs\n-            JsonNode indexNode = modelConfigNode.get(\"index\").get(\"index-config\");\n-\n-            try {\n-                // Get current db configuration\n-                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\");\n-                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n-\n-                // Get fields common to current db config and updated entity index config\n-                JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n-\n-                // Merge fields so that we dont delete any existing index config that's not in the entity index config\n-                indexNode = JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n-            }\n-            catch (JsonProcessingException e) {\n-                throw new RuntimeException(e);\n-            }\n-\n-            manageClient.putJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\", indexNode.toString());\n-        });\n+    /**\n+     * Gets fields common to both dbNode and indexNode and then merges them together.\n+     *\n+     * @param dbNode\n+     * @param indexNode\n+     * @return - Merged node\n+     */\n+    protected JsonNode mergeIndexConfigs(JsonNode dbNode, JsonNode indexNode) {\n+        // Get fields common to current db config and updated entity index config\n+        JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n+\n+        // Merge fields so that we dont delete any existing index config that's not in the entity index config\n+        return JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n     }\n \n     private JsonNode getCommonFields(JsonNode targetNode, JsonNode sourceNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMDI3MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424400271", "bodyText": "You need to do a try/catch for each individual postJson call. While we only expect one query roleset for now (pii-reader), there could be more in the future. And if the first one fails because it already exists, we still want to try to deploy the others.", "author": "rjrudin", "createdAt": "2020-05-13T12:33:35Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +84,85 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        // Deploy search options\n+        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        Map<String, DatabaseClient> clientMap = new HashMap<>();\n+        clientMap.put(\"staging\", stagingDatabaseClient);\n+        clientMap.put(\"final\", finalDatabaseClient);\n+        clientMap.forEach((databaseKind, databaseClient) -> {\n+            QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n+            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n+            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+        });\n+\n+        // Deploy protected-paths\n+        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+\n+        // Deploy query-rolesets\n+        try {\n+            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4NzM4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425987380", "bodyText": "Good catch. Updated in here b6777af", "author": "akshaysonvane", "createdAt": "2020-05-15T18:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMDI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 0fcb607fc..8eb4971ab 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -96,56 +98,103 @@ public class ModelController extends BaseController {\n \n     void deployModelConfigs() {\n         ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n-        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n-        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n \n         JsonNode modelConfigNode = newService().generateModelConfig();\n \n-        // Deploy search options\n-        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n-        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployQueryRolesets(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"queryRolesets\").forEach(jsonNode -> {\n+                try {\n+                    manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString());\n+                }\n+                catch (HttpClientErrorException ex) {\n+                    QueryRolesetUtil.handleSaveException(ex);\n+                }\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy query-rolesets after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployProtectedPaths(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"protectedPaths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy protected-paths after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deploySearchOptions(JsonNode modelConfigNode) {\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        String explorerOptions = modelConfigNode.get(\"searchOptions\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"searchOptions\").get(\"default\").asText();\n         Map<String, DatabaseClient> clientMap = new HashMap<>();\n         clientMap.put(\"staging\", stagingDatabaseClient);\n         clientMap.put(\"final\", finalDatabaseClient);\n         clientMap.forEach((databaseKind, databaseClient) -> {\n             QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n-            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n-            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+            writeOptions(databaseKind, queryOptionsManager, \"exp-\" + databaseKind + \"-entity-options\", explorerOptions);\n+            writeOptions(databaseKind, queryOptionsManager, databaseKind + \"-entity-options\", defaultOptions);\n         });\n+    }\n \n-        // Deploy protected-paths\n-        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n-\n-        // Deploy query-rolesets\n+    private void writeOptions(String databaseKind, QueryOptionsManager queryOptionsManager, String optionName, String options) {\n         try {\n-            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));\n+            queryOptionsManager.writeOptionsAs(optionName, Format.XML, options);\n         }\n-        catch (HttpClientErrorException ex) {\n-            QueryRolesetUtil.handleSaveException(ex);\n+        catch (Exception e) {\n+            throw new RuntimeException(String.format(\"Unable to deploy search options file %s to %s database after updating entity models.\", optionName, databaseKind), e);\n         }\n+    }\n \n-        // Deploy index configuration\n-        modelConfigNode.get(\"index\").get(\"database-names\").forEach(dbNameNode -> {\n-            // Get updated entity index configs\n-            JsonNode indexNode = modelConfigNode.get(\"index\").get(\"index-config\");\n-\n-            try {\n-                // Get current db configuration\n-                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\");\n-                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n-\n-                // Get fields common to current db config and updated entity index config\n-                JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n-\n-                // Merge fields so that we dont delete any existing index config that's not in the entity index config\n-                indexNode = JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n-            }\n-            catch (JsonProcessingException e) {\n-                throw new RuntimeException(e);\n-            }\n-\n-            manageClient.putJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\", indexNode.toString());\n-        });\n+    /**\n+     * Gets fields common to both dbNode and indexNode and then merges them together.\n+     *\n+     * @param dbNode\n+     * @param indexNode\n+     * @return - Merged node\n+     */\n+    protected JsonNode mergeIndexConfigs(JsonNode dbNode, JsonNode indexNode) {\n+        // Get fields common to current db config and updated entity index config\n+        JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n+\n+        // Merge fields so that we dont delete any existing index config that's not in the entity index config\n+        return JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n     }\n \n     private JsonNode getCommonFields(JsonNode targetNode, JsonNode sourceNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjAzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424402038", "bodyText": "Starting with this line, put the rest into a protected method so we can unit-test it easily without depending on ML at all. This is relatively complex logic here, and we want to make sure it behaves correctly. It's easiest to do that if we can pass in our own inputs for the existing dbConfig and the generated indexNode and then verify that they are merged together correctly. Those tests will be much easier to write and will run very quickly - I recommend putting them into a separate test class that doesn't extend anything, can call it \"MergeDatabaseConfigTest\".", "author": "rjrudin", "createdAt": "2020-05-13T12:36:39Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +84,85 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        // Deploy search options\n+        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        Map<String, DatabaseClient> clientMap = new HashMap<>();\n+        clientMap.put(\"staging\", stagingDatabaseClient);\n+        clientMap.put(\"final\", finalDatabaseClient);\n+        clientMap.forEach((databaseKind, databaseClient) -> {\n+            QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n+            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n+            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+        });\n+\n+        // Deploy protected-paths\n+        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+\n+        // Deploy query-rolesets\n+        try {\n+            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));\n+        }\n+        catch (HttpClientErrorException ex) {\n+            QueryRolesetUtil.handleSaveException(ex);\n+        }\n+\n+        // Deploy index configuration\n+        modelConfigNode.get(\"index\").get(\"database-names\").forEach(dbNameNode -> {\n+            // Get updated entity index configs\n+            JsonNode indexNode = modelConfigNode.get(\"index\").get(\"index-config\");\n+\n+            try {\n+                // Get current db configuration\n+                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\");\n+                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4NzU3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425987577", "bodyText": "Added the test.", "author": "akshaysonvane", "createdAt": "2020-05-15T18:51:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 0fcb607fc..8eb4971ab 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -96,56 +98,103 @@ public class ModelController extends BaseController {\n \n     void deployModelConfigs() {\n         ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n-        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n-        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n \n         JsonNode modelConfigNode = newService().generateModelConfig();\n \n-        // Deploy search options\n-        String explorerOptions = modelConfigNode.get(\"search-options\").get(\"explorer\").asText();\n-        String defaultOptions = modelConfigNode.get(\"search-options\").get(\"default\").asText();\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployQueryRolesets(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"queryRolesets\").forEach(jsonNode -> {\n+                try {\n+                    manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString());\n+                }\n+                catch (HttpClientErrorException ex) {\n+                    QueryRolesetUtil.handleSaveException(ex);\n+                }\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy query-rolesets after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployProtectedPaths(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"protectedPaths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy protected-paths after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deploySearchOptions(JsonNode modelConfigNode) {\n+        DatabaseClient finalDatabaseClient = hubClientProvider.getHubClient().getFinalClient();\n+        DatabaseClient stagingDatabaseClient = hubClientProvider.getHubClient().getStagingClient();\n+\n+        String explorerOptions = modelConfigNode.get(\"searchOptions\").get(\"explorer\").asText();\n+        String defaultOptions = modelConfigNode.get(\"searchOptions\").get(\"default\").asText();\n         Map<String, DatabaseClient> clientMap = new HashMap<>();\n         clientMap.put(\"staging\", stagingDatabaseClient);\n         clientMap.put(\"final\", finalDatabaseClient);\n         clientMap.forEach((databaseKind, databaseClient) -> {\n             QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n-            queryOptionsManager.writeOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, explorerOptions);\n-            queryOptionsManager.writeOptionsAs(databaseKind + \"-entity-options\", Format.XML, defaultOptions);\n+            writeOptions(databaseKind, queryOptionsManager, \"exp-\" + databaseKind + \"-entity-options\", explorerOptions);\n+            writeOptions(databaseKind, queryOptionsManager, databaseKind + \"-entity-options\", defaultOptions);\n         });\n+    }\n \n-        // Deploy protected-paths\n-        modelConfigNode.get(\"protected-paths\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/protected-paths\", jsonNode.toString()));\n-\n-        // Deploy query-rolesets\n+    private void writeOptions(String databaseKind, QueryOptionsManager queryOptionsManager, String optionName, String options) {\n         try {\n-            modelConfigNode.get(\"query-rolesets\").forEach(jsonNode -> manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString()));\n+            queryOptionsManager.writeOptionsAs(optionName, Format.XML, options);\n         }\n-        catch (HttpClientErrorException ex) {\n-            QueryRolesetUtil.handleSaveException(ex);\n+        catch (Exception e) {\n+            throw new RuntimeException(String.format(\"Unable to deploy search options file %s to %s database after updating entity models.\", optionName, databaseKind), e);\n         }\n+    }\n \n-        // Deploy index configuration\n-        modelConfigNode.get(\"index\").get(\"database-names\").forEach(dbNameNode -> {\n-            // Get updated entity index configs\n-            JsonNode indexNode = modelConfigNode.get(\"index\").get(\"index-config\");\n-\n-            try {\n-                // Get current db configuration\n-                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\");\n-                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n-\n-                // Get fields common to current db config and updated entity index config\n-                JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n-\n-                // Merge fields so that we dont delete any existing index config that's not in the entity index config\n-                indexNode = JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n-            }\n-            catch (JsonProcessingException e) {\n-                throw new RuntimeException(e);\n-            }\n-\n-            manageClient.putJson(\"/manage/v2/databases/\" + dbNameNode.asText() + \"/properties\", indexNode.toString());\n-        });\n+    /**\n+     * Gets fields common to both dbNode and indexNode and then merges them together.\n+     *\n+     * @param dbNode\n+     * @param indexNode\n+     * @return - Merged node\n+     */\n+    protected JsonNode mergeIndexConfigs(JsonNode dbNode, JsonNode indexNode) {\n+        // Get fields common to current db config and updated entity index config\n+        JsonNode currentIndexNode = getCommonFields(dbNode, indexNode);\n+\n+        // Merge fields so that we dont delete any existing index config that's not in the entity index config\n+        return JsonNodeUtil.mergeObjectNodes((ObjectNode) indexNode, (ObjectNode) currentIndexNode);\n     }\n \n     private JsonNode getCommonFields(JsonNode targetNode, JsonNode sourceNode) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjc3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424402773", "bodyText": "Shouldn't this be a different namespace - isn't this the one that's generated too?", "author": "rjrudin", "createdAt": "2020-05-13T12:37:53Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java", "diffHunk": "@@ -60,26 +69,114 @@ private void updateModelInfo() {\n     }\n \n     private void updateModelEntityTypes() {\n+        // Loading unrelated indexes so that we can check for them after updating entity model\n+        loadUnrelatedIndexes();\n+\n         String entityTypes = \"{\\\"\" + MODEL_NAME + \"\\\" : {\\n\" +\n             \"      \\\"required\\\" : [ ],\\n\" +\n+            \"      \\\"pii\\\" : [ \\\"someProperty\\\" ],\" +\n+            \"      \\\"elementRangeIndex\\\" : [ \\\"someProperty\\\" ],\\n\" +\n+            \"      \\\"rangeIndex\\\" : [ \\\"someOtherProperty\\\" ],\" +\n             \"      \\\"properties\\\" : {\\n\" +\n             \"        \\\"someProperty\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n-            \"        }\\n\" +\n+            \"        },\\n\" +\n+            \"         \\\"someOtherProperty\\\" : {\\n\" +\n+            \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n+            \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n+            \"        }\" +\n             \"      }\\n\" +\n             \"    }}\";\n \n         try {\n             controller.updateModelEntityTypes(objectMapper.readTree(entityTypes), MODEL_NAME);\n-        } catch (JsonProcessingException e) {\n+        }\n+        catch (JsonProcessingException e) {\n             throw new RuntimeException(e);\n         }\n \n+        assertSearchOptionsDeployment();\n+        assertPIIFilesDeployment();\n+        assertIndexDeployment();\n+\n         assertEquals(\"string\", loadModel(getHubClient().getFinalClient()).get(\"definitions\").get(MODEL_NAME).get(\"properties\").get(\"someProperty\").get(\"datatype\").asText());\n     }\n \n     private JsonNode loadModel(DatabaseClient client) {\n         return client.newJSONDocumentManager().read(\"/entities/\" + MODEL_NAME + \".entity.json\", new JacksonHandle()).get();\n     }\n+\n+    private void assertSearchOptionsDeployment() {\n+        DatabaseClient stagingDatabaseClient = getHubClient().getStagingClient();\n+        DatabaseClient finalDatabaseClient = getHubClient().getFinalClient();\n+        Map<String, DatabaseClient> clientMap = new HashMap<>();\n+        clientMap.put(\"staging\", stagingDatabaseClient);\n+        clientMap.put(\"final\", finalDatabaseClient);\n+        clientMap.forEach((databaseKind, databaseClient) -> {\n+            QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n+            assertTrue(queryOptionsManager.readOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, String.class).contains(MODEL_NAME));\n+            assertTrue(queryOptionsManager.readOptionsAs(databaseKind + \"-entity-options\", Format.XML, String.class).contains(MODEL_NAME));\n+        });\n+    }\n+\n+    private void assertPIIFilesDeployment() {\n+        runAsAdmin();\n+        ManageClient manageClient = getHubClient().getManageClient();\n+\n+        try {\n+            assertTrue(manageClient.getJson(\"/manage/v2/protected-paths\").contains(\"someProperty\"));\n+\n+            JsonNode queryRolesets = objectMapper.readTree(manageClient.getJson(\"/manage/v2/query-rolesets\"));\n+            assertTrue(queryRolesets.get(\"query-roleset-default-list\").get(\"list-items\").get(\"list-count\").get(\"value\").asInt() >= 1);\n+        }\n+        catch (JsonProcessingException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private void assertIndexDeployment() {\n+        ManageClient manageClient = getHubClient().getManageClient();\n+        Stream.of(getHubConfig().getDbName(DatabaseKind.STAGING), getHubConfig().getDbName(DatabaseKind.FINAL)).forEach(databaseKind -> {\n+            String indexConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseKind + \"/properties\");\n+            assertTrue(indexConfig.contains(\"testRangeIndexForDHFPROD4704\"));\n+            assertTrue(indexConfig.contains(\"testPathIndexForDHFPROD4704\"));\n+            assertTrue(indexConfig.contains(\"someProperty\"));\n+            assertTrue(indexConfig.contains(\"someOtherProperty\"));\n+        });\n+    }\n+\n+    private void loadUnrelatedIndexes() {\n+        String indexConfig = \"{\\n\" +\n+            \"   \\\"lang\\\":\\\"zxx\\\",\\n\" +\n+            \"   \\\"path-namespace\\\":[\\n\" +\n+            \"      {\\n\" +\n+            \"         \\\"prefix\\\":\\\"es\\\",\\n\" +", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4NzkzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425987935", "bodyText": "Yep, forgot to change it while copying.\nUpdated in here b6777af", "author": "akshaysonvane", "createdAt": "2020-05-15T18:52:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMjc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\nindex 0f2d13edf..291a411c4 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n\n@@ -74,15 +84,15 @@ public class ModelControllerTest extends AbstractHubCentralTest {\n \n         String entityTypes = \"{\\\"\" + MODEL_NAME + \"\\\" : {\\n\" +\n             \"      \\\"required\\\" : [ ],\\n\" +\n-            \"      \\\"pii\\\" : [ \\\"someProperty\\\" ],\" +\n-            \"      \\\"elementRangeIndex\\\" : [ \\\"someProperty\\\" ],\\n\" +\n-            \"      \\\"rangeIndex\\\" : [ \\\"someOtherProperty\\\" ],\" +\n+            \"      \\\"pii\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\" +\n+            \"      \\\"elementRangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\\n\" +\n+            \"      \\\"rangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_2 + \"\\\" ],\" +\n             \"      \\\"properties\\\" : {\\n\" +\n-            \"        \\\"someProperty\\\" : {\\n\" +\n+            \"        \\\"\" + ENTITY_PROPERTY_1 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        },\\n\" +\n-            \"         \\\"someOtherProperty\\\" : {\\n\" +\n+            \"         \\\"\" + ENTITY_PROPERTY_2 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        }\" +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMzkxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424403915", "bodyText": "A testing technique - a problem with assertTrue/assertFalse is that if it fails, it's not known why. We really want to see the value of indexConfig to find out what's going on.\nTo improve on that, I'd do this:\n[\"someProperty\", \"someOtherProperty\", etc].forEach(prop -> {\n    assertTrue(indexConfig.contains(property), \"Expected \" + property + \" to be in indexConfig: \" + indexConfig);\n});\n\nThat makes debugging a test failure much easier.", "author": "rjrudin", "createdAt": "2020-05-13T12:39:51Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java", "diffHunk": "@@ -60,26 +69,114 @@ private void updateModelInfo() {\n     }\n \n     private void updateModelEntityTypes() {\n+        // Loading unrelated indexes so that we can check for them after updating entity model\n+        loadUnrelatedIndexes();\n+\n         String entityTypes = \"{\\\"\" + MODEL_NAME + \"\\\" : {\\n\" +\n             \"      \\\"required\\\" : [ ],\\n\" +\n+            \"      \\\"pii\\\" : [ \\\"someProperty\\\" ],\" +\n+            \"      \\\"elementRangeIndex\\\" : [ \\\"someProperty\\\" ],\\n\" +\n+            \"      \\\"rangeIndex\\\" : [ \\\"someOtherProperty\\\" ],\" +\n             \"      \\\"properties\\\" : {\\n\" +\n             \"        \\\"someProperty\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n-            \"        }\\n\" +\n+            \"        },\\n\" +\n+            \"         \\\"someOtherProperty\\\" : {\\n\" +\n+            \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n+            \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n+            \"        }\" +\n             \"      }\\n\" +\n             \"    }}\";\n \n         try {\n             controller.updateModelEntityTypes(objectMapper.readTree(entityTypes), MODEL_NAME);\n-        } catch (JsonProcessingException e) {\n+        }\n+        catch (JsonProcessingException e) {\n             throw new RuntimeException(e);\n         }\n \n+        assertSearchOptionsDeployment();\n+        assertPIIFilesDeployment();\n+        assertIndexDeployment();\n+\n         assertEquals(\"string\", loadModel(getHubClient().getFinalClient()).get(\"definitions\").get(MODEL_NAME).get(\"properties\").get(\"someProperty\").get(\"datatype\").asText());\n     }\n \n     private JsonNode loadModel(DatabaseClient client) {\n         return client.newJSONDocumentManager().read(\"/entities/\" + MODEL_NAME + \".entity.json\", new JacksonHandle()).get();\n     }\n+\n+    private void assertSearchOptionsDeployment() {\n+        DatabaseClient stagingDatabaseClient = getHubClient().getStagingClient();\n+        DatabaseClient finalDatabaseClient = getHubClient().getFinalClient();\n+        Map<String, DatabaseClient> clientMap = new HashMap<>();\n+        clientMap.put(\"staging\", stagingDatabaseClient);\n+        clientMap.put(\"final\", finalDatabaseClient);\n+        clientMap.forEach((databaseKind, databaseClient) -> {\n+            QueryOptionsManager queryOptionsManager = databaseClient.newServerConfigManager().newQueryOptionsManager();\n+            assertTrue(queryOptionsManager.readOptionsAs(\"exp-\" + databaseKind + \"-entity-options\", Format.XML, String.class).contains(MODEL_NAME));\n+            assertTrue(queryOptionsManager.readOptionsAs(databaseKind + \"-entity-options\", Format.XML, String.class).contains(MODEL_NAME));\n+        });\n+    }\n+\n+    private void assertPIIFilesDeployment() {\n+        runAsAdmin();\n+        ManageClient manageClient = getHubClient().getManageClient();\n+\n+        try {\n+            assertTrue(manageClient.getJson(\"/manage/v2/protected-paths\").contains(\"someProperty\"));\n+\n+            JsonNode queryRolesets = objectMapper.readTree(manageClient.getJson(\"/manage/v2/query-rolesets\"));\n+            assertTrue(queryRolesets.get(\"query-roleset-default-list\").get(\"list-items\").get(\"list-count\").get(\"value\").asInt() >= 1);\n+        }\n+        catch (JsonProcessingException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private void assertIndexDeployment() {\n+        ManageClient manageClient = getHubClient().getManageClient();\n+        Stream.of(getHubConfig().getDbName(DatabaseKind.STAGING), getHubConfig().getDbName(DatabaseKind.FINAL)).forEach(databaseKind -> {\n+            String indexConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseKind + \"/properties\");\n+            assertTrue(indexConfig.contains(\"testRangeIndexForDHFPROD4704\"));", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk4ODA5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425988099", "bodyText": "Makes sense. Updated in here b6777af", "author": "akshaysonvane", "createdAt": "2020-05-15T18:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwMzkxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\nindex 0f2d13edf..291a411c4 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n\n@@ -74,15 +84,15 @@ public class ModelControllerTest extends AbstractHubCentralTest {\n \n         String entityTypes = \"{\\\"\" + MODEL_NAME + \"\\\" : {\\n\" +\n             \"      \\\"required\\\" : [ ],\\n\" +\n-            \"      \\\"pii\\\" : [ \\\"someProperty\\\" ],\" +\n-            \"      \\\"elementRangeIndex\\\" : [ \\\"someProperty\\\" ],\\n\" +\n-            \"      \\\"rangeIndex\\\" : [ \\\"someOtherProperty\\\" ],\" +\n+            \"      \\\"pii\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\" +\n+            \"      \\\"elementRangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\\n\" +\n+            \"      \\\"rangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_2 + \"\\\" ],\" +\n             \"      \\\"properties\\\" : {\\n\" +\n-            \"        \\\"someProperty\\\" : {\\n\" +\n+            \"        \\\"\" + ENTITY_PROPERTY_1 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        },\\n\" +\n-            \"         \\\"someOtherProperty\\\" : {\\n\" +\n+            \"         \\\"\" + ENTITY_PROPERTY_2 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        }\" +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNTM3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r424405373", "bodyText": "I believe you need to call Installer.applyDatabasePropertiesForTests after each test here because you're modifying the config of the staging/final databases, which could break other tests.", "author": "rjrudin", "createdAt": "2020-05-13T12:42:00Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java", "diffHunk": "@@ -60,26 +69,114 @@ private void updateModelInfo() {\n     }\n \n     private void updateModelEntityTypes() {\n+        // Loading unrelated indexes so that we can check for them after updating entity model", "originalCommit": "25f007b41a746e449effeb2608322abf15c421e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk5MDMwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r425990306", "bodyText": "Updated in here b6777af", "author": "akshaysonvane", "createdAt": "2020-05-15T18:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNTM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\nindex 0f2d13edf..291a411c4 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n\n@@ -74,15 +84,15 @@ public class ModelControllerTest extends AbstractHubCentralTest {\n \n         String entityTypes = \"{\\\"\" + MODEL_NAME + \"\\\" : {\\n\" +\n             \"      \\\"required\\\" : [ ],\\n\" +\n-            \"      \\\"pii\\\" : [ \\\"someProperty\\\" ],\" +\n-            \"      \\\"elementRangeIndex\\\" : [ \\\"someProperty\\\" ],\\n\" +\n-            \"      \\\"rangeIndex\\\" : [ \\\"someOtherProperty\\\" ],\" +\n+            \"      \\\"pii\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\" +\n+            \"      \\\"elementRangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_1 + \"\\\" ],\\n\" +\n+            \"      \\\"rangeIndex\\\" : [ \\\"\" + ENTITY_PROPERTY_2 + \"\\\" ],\" +\n             \"      \\\"properties\\\" : {\\n\" +\n-            \"        \\\"someProperty\\\" : {\\n\" +\n+            \"        \\\"\" + ENTITY_PROPERTY_1 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        },\\n\" +\n-            \"         \\\"someOtherProperty\\\" : {\\n\" +\n+            \"         \\\"\" + ENTITY_PROPERTY_2 + \"\\\" : {\\n\" +\n             \"          \\\"datatype\\\" : \\\"string\\\",\\n\" +\n             \"          \\\"collation\\\" : \\\"http://marklogic.com/collation/codepoint\\\"\\n\" +\n             \"        }\" +\n"}}, {"oid": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "message": "DHFPROD-4704: Deploy entity model configs after saving an entity", "committedDate": "2020-05-15T18:48:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNzc2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426017765", "bodyText": "Nice. I'm such a big fan of this, because these method names immediately answer a reader's question of - what does it mean to \"deploy model configs\"? Answer = it means deploying search options, protected paths, query rolesets, and indexes. No comments needed.", "author": "rjrudin", "createdAt": "2020-05-15T19:56:27Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +86,132 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        deploySearchOptions(modelConfigNode);", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNzg5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426017891", "bodyText": "Btw, the book Clean Code is very persuasive in arguing for this style", "author": "rjrudin", "createdAt": "2020-05-15T19:56:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNzc2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 8eb4971ab..7a13e0980 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -109,26 +107,21 @@ public class ModelController extends BaseController {\n \n     private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n         try {\n-            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+            for (String databaseName : Arrays.asList(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL))) {\n                 // Get updated entity index configs\n                 JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n \n-                try {\n-                    // Get current db configuration\n-                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n-                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+                // Get current db configuration\n+                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n \n-                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n-                }\n-                catch (JsonProcessingException e) {\n-                    throw new RuntimeException(e);\n-                }\n+                indexNode = mergeIndexConfigs(dbNode, indexNode);\n \n                 manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n-            });\n+            }\n         }\n         catch (Exception e) {\n-            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+            throw new RuntimeException(\"Unable to deploy database indexes after updating entity models; cause: \" + e.getMessage(), e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxODQzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426018437", "bodyText": "I don't think you need this try/catch here - you've already got a try/catch in the method, that'll catch this error (and it's of course very unlikely that the error will occur).", "author": "rjrudin", "createdAt": "2020-05-15T19:57:55Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +86,132 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 8eb4971ab..7a13e0980 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -109,26 +107,21 @@ public class ModelController extends BaseController {\n \n     private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n         try {\n-            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+            for (String databaseName : Arrays.asList(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL))) {\n                 // Get updated entity index configs\n                 JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n \n-                try {\n-                    // Get current db configuration\n-                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n-                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+                // Get current db configuration\n+                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n \n-                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n-                }\n-                catch (JsonProcessingException e) {\n-                    throw new RuntimeException(e);\n-                }\n+                indexNode = mergeIndexConfigs(dbNode, indexNode);\n \n                 manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n-            });\n+            }\n         }\n         catch (Exception e) {\n-            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+            throw new RuntimeException(\"Unable to deploy database indexes after updating entity models; cause: \" + e.getMessage(), e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxODkxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426018912", "bodyText": "I like to include the original exception message when rethrowing an error because in many contexts, the user will only see this message, and it can be confusing not to include the more detailed message. So I frequently do this:\nthrow new RuntimeException(\"Unable to deploy databases indexes after updating entity models; cause: \" + e.getMessage(), e);\n\nI also think it's better to say \"Unable to deploy database indexes\", which is more clear than \"index configuration\".", "author": "rjrudin", "createdAt": "2020-05-15T19:59:11Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +86,132 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MjY5Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426072697", "bodyText": "Makes sense, updated in here da196c8", "author": "akshaysonvane", "createdAt": "2020-05-15T22:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxODkxMg=="}], "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 8eb4971ab..7a13e0980 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -109,26 +107,21 @@ public class ModelController extends BaseController {\n \n     private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n         try {\n-            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+            for (String databaseName : Arrays.asList(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL))) {\n                 // Get updated entity index configs\n                 JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n \n-                try {\n-                    // Get current db configuration\n-                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n-                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+                // Get current db configuration\n+                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n \n-                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n-                }\n-                catch (JsonProcessingException e) {\n-                    throw new RuntimeException(e);\n-                }\n+                indexNode = mergeIndexConfigs(dbNode, indexNode);\n \n                 manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n-            });\n+            }\n         }\n         catch (Exception e) {\n-            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+            throw new RuntimeException(\"Unable to deploy database indexes after updating entity models; cause: \" + e.getMessage(), e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxOTA0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426019044", "bodyText": "Same thing here, include the \"cause\".", "author": "rjrudin", "createdAt": "2020-05-15T19:59:30Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java", "diffHunk": "@@ -76,11 +86,132 @@\n     @RequestMapping(value = \"/{modelName}/entityTypes\", method = RequestMethod.PUT)\n     @ApiImplicitParam(required = true, paramType = \"body\", dataType = \"ModelDefinitions\")\n     public ResponseEntity<Void> updateModelEntityTypes(@ApiParam(hidden = true) @RequestBody JsonNode entityTypes, @PathVariable String modelName) {\n+        // update the model\n         newService().updateModelEntityTypes(modelName, entityTypes);\n+\n+        //deploy updated configs\n+        deployModelConfigs();\n+\n         return new ResponseEntity<>(HttpStatus.OK);\n     }\n \n \n+    void deployModelConfigs() {\n+        ManageClient manageClient = hubClientProvider.getHubClient().getManageClient();\n+\n+        JsonNode modelConfigNode = newService().generateModelConfig();\n+\n+        deploySearchOptions(modelConfigNode);\n+        deployProtectedPaths(modelConfigNode, manageClient);\n+        deployQueryRolesets(modelConfigNode, manageClient);\n+        deployIndexConfig(modelConfigNode, manageClient);\n+    }\n+\n+    private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+                // Get updated entity index configs\n+                JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n+\n+                try {\n+                    // Get current db configuration\n+                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+\n+                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n+                }\n+                catch (JsonProcessingException e) {\n+                    throw new RuntimeException(e);\n+                }\n+\n+                manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+        }\n+    }\n+\n+    private void deployQueryRolesets(JsonNode modelConfigNode, ManageClient manageClient) {\n+        try {\n+            modelConfigNode.get(\"queryRolesets\").forEach(jsonNode -> {\n+                try {\n+                    manageClient.postJson(\"/manage/v2/query-rolesets\", jsonNode.toString());\n+                }\n+                catch (HttpClientErrorException ex) {\n+                    QueryRolesetUtil.handleSaveException(ex);\n+                }\n+            });\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to deploy query-rolesets after updating entity models.\", e);", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\nindex 8eb4971ab..7a13e0980 100644\n--- a/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n+++ b/marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/ModelController.java\n\n@@ -109,26 +107,21 @@ public class ModelController extends BaseController {\n \n     private void deployIndexConfig(JsonNode modelConfigNode, ManageClient manageClient) {\n         try {\n-            Stream.of(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL)).forEach(databaseName -> {\n+            for (String databaseName : Arrays.asList(getHubClient().getDbName(DatabaseKind.STAGING), getHubClient().getDbName(DatabaseKind.FINAL))) {\n                 // Get updated entity index configs\n                 JsonNode indexNode = modelConfigNode.get(\"indexConfig\");\n \n-                try {\n-                    // Get current db configuration\n-                    String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n-                    JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n+                // Get current db configuration\n+                String dbConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseName + \"/properties\");\n+                JsonNode dbNode = new ObjectMapper().readTree(dbConfig);\n \n-                    indexNode = mergeIndexConfigs(dbNode, indexNode);\n-                }\n-                catch (JsonProcessingException e) {\n-                    throw new RuntimeException(e);\n-                }\n+                indexNode = mergeIndexConfigs(dbNode, indexNode);\n \n                 manageClient.putJson(\"/manage/v2/databases/\" + databaseName + \"/properties\", indexNode.toString());\n-            });\n+            }\n         }\n         catch (Exception e) {\n-            throw new RuntimeException(\"Unable to deploy index configuration after updating entity models.\", e);\n+            throw new RuntimeException(\"Unable to deploy database indexes after updating entity models; cause: \" + e.getMessage(), e);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDA2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426020069", "bodyText": "For future reference - ml-app-deployer has a bunch of POJOs to build this stuff, which is a lot easier to write and read than doing inline JSON in Java. See UpgradeProjectTest for examples of using ElementIndex and Database.", "author": "rjrudin", "createdAt": "2020-05-15T20:01:52Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.central.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class MergeDatabaseConfigTest {\n+\n+    @Test\n+    public void testMergeIndexConfigs() throws JsonProcessingException {\n+        String entityServicesRangeIndex = \"testEntityServicesRangeIndexForDHFPROD4704\";\n+        String entityServicesPathIndex = \"testEntityServicesPathIndexForDHFPROD4704\";\n+        String databaseRangeIndex = \"testRangeIndexForDHFPROD4704\";\n+        String databasePathIndex = \"testPathIndexForDHFPROD4704\";\n+        String databaseField1 = \"language\";\n+        String databaseField2 = \"forest\";\n+\n+        String indexConfig = \"{\\n\" +", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MzA0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426073046", "bodyText": "Awesome, updated the test to use the POJOs.", "author": "akshaysonvane", "createdAt": "2020-05-15T22:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDA2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\nindex d0559296c..57048d76c 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\n\n@@ -1,89 +1,89 @@\n package com.marklogic.hub.central.controllers;\n \n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.api.database.ElementIndex;\n+import org.apache.commons.lang3.StringUtils;\n import org.junit.jupiter.api.Test;\n \n-import static org.junit.jupiter.api.Assertions.assertFalse;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n \n public class MergeDatabaseConfigTest {\n \n+    private static String ENTITY_SERVICES_RANGE_INDEX = \"testEntityServicesRangeIndexForDHFPROD4704\";\n+    private static String ENTITY_SERVICES_PATH_INDEX = \"testEntityServicesPathIndexForDHFPROD4704\";\n+    private static String DATABASE_RANGE_INDEX = \"testRangeIndexForDHFPROD4704\";\n+    private static String DATABASE_PATH_INDEX = \"testPathIndexForDHFPROD4704\";\n+    private static String DATABASE_FIELD_1 = \"language\";\n+    private static String DATABASE_FIELD_2 = \"security\";\n+\n     @Test\n-    public void testMergeIndexConfigs() throws JsonProcessingException {\n-        String entityServicesRangeIndex = \"testEntityServicesRangeIndexForDHFPROD4704\";\n-        String entityServicesPathIndex = \"testEntityServicesPathIndexForDHFPROD4704\";\n-        String databaseRangeIndex = \"testRangeIndexForDHFPROD4704\";\n-        String databasePathIndex = \"testPathIndexForDHFPROD4704\";\n-        String databaseField1 = \"language\";\n-        String databaseField2 = \"forest\";\n-\n-        String indexConfig = \"{\\n\" +\n-            \"   \\\"lang\\\":\\\"zxx\\\",\\n\" +\n-            \"   \\\"path-namespace\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"prefix\\\":\\\"es\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":\\\"http://marklogic.com/entity-services\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-element-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\",\\n\" +\n-            \"         \\\"localname\\\":\\\"\" + entityServicesRangeIndex + \"\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":null,\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"decimal\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-path-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"string\\\",\\n\" +\n-            \"         \\\"path-expression\\\":\\\"//*:instance/\" + entityServicesPathIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"http://marklogic.com/collation/\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ]\\n\" +\n-            \"}\";\n-\n-        String dbConfig = \"{\\n\" +\n-            \"   \\\"\" + databaseField1 + \"\\\":\\\"en\\\",\\n\" +\n-            \"   \\\"\" + databaseField2 + \"\\\":[\\n\" +\n-            \"      \\\"data-hub-FINAL-1\\\"\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-element-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"string\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":\\\"\\\",\\n\" +\n-            \"         \\\"localname\\\":\\\"\" + databaseRangeIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"http://marklogic.com/collation//S1\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-path-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"int\\\",\\n\" +\n-            \"         \\\"path-expression\\\":\\\"//*:instance/\" + databasePathIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ]\\n\" +\n-            \"}\";\n-\n-        ObjectMapper mapper = new ObjectMapper();\n+    public void testMergeIndexConfigsHavingUniqueIndexes() {\n+        JsonNode indexConfig = getIndexConfig(Collections.singletonList(ENTITY_SERVICES_RANGE_INDEX), Collections.singletonList(ENTITY_SERVICES_PATH_INDEX), null, null);\n+        JsonNode dbConfig = getIndexConfig(Collections.singletonList(DATABASE_RANGE_INDEX), Collections.singletonList(DATABASE_PATH_INDEX), DATABASE_FIELD_1, DATABASE_FIELD_2);\n+\n         ModelController modelController = new ModelController();\n \n-        JsonNode mergedNode = modelController.mergeIndexConfigs(mapper.readTree(dbConfig), mapper.readTree(indexConfig));\n+        JsonNode mergedNode = modelController.mergeIndexConfigs(dbConfig, indexConfig);\n         String mergedConfig = mergedNode.toString();\n \n-        assertFalse(mergedConfig.contains(databaseField1), \"Expected \" + databaseField1 + \" to not be in mergedConfig: \" + mergedConfig);\n-        assertFalse(mergedConfig.contains(databaseField2), \"Expected \" + databaseField2 + \" to not be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(entityServicesRangeIndex), \"Expected \" + entityServicesRangeIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(entityServicesPathIndex), \"Expected \" + entityServicesPathIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(databaseRangeIndex), \"Expected \" + databaseRangeIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(databasePathIndex), \"Expected \" + databasePathIndex + \" to be in mergedConfig: \" + mergedConfig);\n+        assertIndexesAndFields(mergedConfig);\n+    }\n+\n+    @Test\n+    public void testMergeIndexConfigsHavingCommonIndexes() {\n+        JsonNode indexConfig = getIndexConfig(Collections.singletonList(ENTITY_SERVICES_RANGE_INDEX), Collections.singletonList(ENTITY_SERVICES_PATH_INDEX), null, null);\n+        JsonNode dbConfig = getIndexConfig(Arrays.asList(ENTITY_SERVICES_RANGE_INDEX, DATABASE_RANGE_INDEX), Arrays.asList(ENTITY_SERVICES_PATH_INDEX, DATABASE_PATH_INDEX), DATABASE_FIELD_1, DATABASE_FIELD_2);\n+\n+        ModelController modelController = new ModelController();\n+\n+        JsonNode mergedNode = modelController.mergeIndexConfigs(dbConfig, indexConfig);\n+        String mergedConfig = mergedNode.toString();\n+\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, ENTITY_SERVICES_RANGE_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, DATABASE_RANGE_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, ENTITY_SERVICES_PATH_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, DATABASE_PATH_INDEX));\n+        assertIndexesAndFields(mergedConfig);\n+    }\n+\n+    private void assertIndexesAndFields(String mergedConfig) {\n+        assertFalse(mergedConfig.contains(DATABASE_FIELD_1), \"Expected \" + DATABASE_FIELD_1 + \" to not be in mergedConfig: \" + mergedConfig);\n+        assertFalse(mergedConfig.contains(DATABASE_FIELD_2), \"Expected \" + DATABASE_FIELD_2 + \" to not be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(ENTITY_SERVICES_RANGE_INDEX), \"Expected \" + ENTITY_SERVICES_RANGE_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(ENTITY_SERVICES_PATH_INDEX), \"Expected \" + ENTITY_SERVICES_PATH_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(DATABASE_RANGE_INDEX), \"Expected \" + DATABASE_RANGE_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(DATABASE_PATH_INDEX), \"Expected \" + DATABASE_PATH_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+    }\n+\n+    private JsonNode getIndexConfig(List<String> rangeIndexes, List<String> pathRangeIndexes, String language, String securityDatabase) {\n+        Database db = new Database(null, \"data-hub-FINAL\");\n+\n+        List<ElementIndex> elementIndexList = new ArrayList<>();\n+        rangeIndexes.forEach(rangeIndex -> {\n+            ElementIndex index = new ElementIndex();\n+            index.setLocalname(rangeIndex);\n+            elementIndexList.add(index);\n+        });\n+        db.setRangeElementIndex(elementIndexList);\n+\n+        db.setLanguage(language);\n+        db.setSecurityDatabase(securityDatabase);\n+\n+        ObjectNode jsonNode = db.toObjectNode();\n+        ArrayNode pathIndexes = jsonNode.putArray(\"range-path-index\");\n+        pathRangeIndexes.forEach(pathRangeIndex -> {\n+            ObjectNode pathIndex = pathIndexes.addObject();\n+            pathIndex.put(\"path-expression\", pathRangeIndex);\n+        });\n+\n+        return jsonNode;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDQ1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426020452", "bodyText": "I think you also need a scenario for where the entity indexes already exist. So keep this scenario, and add another one that has the same setup here, and the existing indexes includes the entity indexes.", "author": "rjrudin", "createdAt": "2020-05-15T20:02:51Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package com.marklogic.hub.central.controllers;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class MergeDatabaseConfigTest {\n+\n+    @Test\n+    public void testMergeIndexConfigs() throws JsonProcessingException {", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MzIzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426073237", "bodyText": "Added the scenario in here da196c8", "author": "akshaysonvane", "createdAt": "2020-05-15T22:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMDQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "da196c85281e73752f8f10bfd994508de7644daa", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\nindex d0559296c..57048d76c 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/MergeDatabaseConfigTest.java\n\n@@ -1,89 +1,89 @@\n package com.marklogic.hub.central.controllers;\n \n-import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.api.database.ElementIndex;\n+import org.apache.commons.lang3.StringUtils;\n import org.junit.jupiter.api.Test;\n \n-import static org.junit.jupiter.api.Assertions.assertFalse;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n \n public class MergeDatabaseConfigTest {\n \n+    private static String ENTITY_SERVICES_RANGE_INDEX = \"testEntityServicesRangeIndexForDHFPROD4704\";\n+    private static String ENTITY_SERVICES_PATH_INDEX = \"testEntityServicesPathIndexForDHFPROD4704\";\n+    private static String DATABASE_RANGE_INDEX = \"testRangeIndexForDHFPROD4704\";\n+    private static String DATABASE_PATH_INDEX = \"testPathIndexForDHFPROD4704\";\n+    private static String DATABASE_FIELD_1 = \"language\";\n+    private static String DATABASE_FIELD_2 = \"security\";\n+\n     @Test\n-    public void testMergeIndexConfigs() throws JsonProcessingException {\n-        String entityServicesRangeIndex = \"testEntityServicesRangeIndexForDHFPROD4704\";\n-        String entityServicesPathIndex = \"testEntityServicesPathIndexForDHFPROD4704\";\n-        String databaseRangeIndex = \"testRangeIndexForDHFPROD4704\";\n-        String databasePathIndex = \"testPathIndexForDHFPROD4704\";\n-        String databaseField1 = \"language\";\n-        String databaseField2 = \"forest\";\n-\n-        String indexConfig = \"{\\n\" +\n-            \"   \\\"lang\\\":\\\"zxx\\\",\\n\" +\n-            \"   \\\"path-namespace\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"prefix\\\":\\\"es\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":\\\"http://marklogic.com/entity-services\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-element-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\",\\n\" +\n-            \"         \\\"localname\\\":\\\"\" + entityServicesRangeIndex + \"\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":null,\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"decimal\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-path-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"string\\\",\\n\" +\n-            \"         \\\"path-expression\\\":\\\"//*:instance/\" + entityServicesPathIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"http://marklogic.com/collation/\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ]\\n\" +\n-            \"}\";\n-\n-        String dbConfig = \"{\\n\" +\n-            \"   \\\"\" + databaseField1 + \"\\\":\\\"en\\\",\\n\" +\n-            \"   \\\"\" + databaseField2 + \"\\\":[\\n\" +\n-            \"      \\\"data-hub-FINAL-1\\\"\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-element-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"string\\\",\\n\" +\n-            \"         \\\"namespace-uri\\\":\\\"\\\",\\n\" +\n-            \"         \\\"localname\\\":\\\"\" + databaseRangeIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"http://marklogic.com/collation//S1\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ],\\n\" +\n-            \"   \\\"range-path-index\\\":[\\n\" +\n-            \"      {\\n\" +\n-            \"         \\\"scalar-type\\\":\\\"int\\\",\\n\" +\n-            \"         \\\"path-expression\\\":\\\"//*:instance/\" + databasePathIndex + \"\\\",\\n\" +\n-            \"         \\\"collation\\\":\\\"\\\",\\n\" +\n-            \"         \\\"range-value-positions\\\":false,\\n\" +\n-            \"         \\\"invalid-values\\\":\\\"reject\\\"\\n\" +\n-            \"      }\\n\" +\n-            \"   ]\\n\" +\n-            \"}\";\n-\n-        ObjectMapper mapper = new ObjectMapper();\n+    public void testMergeIndexConfigsHavingUniqueIndexes() {\n+        JsonNode indexConfig = getIndexConfig(Collections.singletonList(ENTITY_SERVICES_RANGE_INDEX), Collections.singletonList(ENTITY_SERVICES_PATH_INDEX), null, null);\n+        JsonNode dbConfig = getIndexConfig(Collections.singletonList(DATABASE_RANGE_INDEX), Collections.singletonList(DATABASE_PATH_INDEX), DATABASE_FIELD_1, DATABASE_FIELD_2);\n+\n         ModelController modelController = new ModelController();\n \n-        JsonNode mergedNode = modelController.mergeIndexConfigs(mapper.readTree(dbConfig), mapper.readTree(indexConfig));\n+        JsonNode mergedNode = modelController.mergeIndexConfigs(dbConfig, indexConfig);\n         String mergedConfig = mergedNode.toString();\n \n-        assertFalse(mergedConfig.contains(databaseField1), \"Expected \" + databaseField1 + \" to not be in mergedConfig: \" + mergedConfig);\n-        assertFalse(mergedConfig.contains(databaseField2), \"Expected \" + databaseField2 + \" to not be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(entityServicesRangeIndex), \"Expected \" + entityServicesRangeIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(entityServicesPathIndex), \"Expected \" + entityServicesPathIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(databaseRangeIndex), \"Expected \" + databaseRangeIndex + \" to be in mergedConfig: \" + mergedConfig);\n-        assertTrue(mergedConfig.contains(databasePathIndex), \"Expected \" + databasePathIndex + \" to be in mergedConfig: \" + mergedConfig);\n+        assertIndexesAndFields(mergedConfig);\n+    }\n+\n+    @Test\n+    public void testMergeIndexConfigsHavingCommonIndexes() {\n+        JsonNode indexConfig = getIndexConfig(Collections.singletonList(ENTITY_SERVICES_RANGE_INDEX), Collections.singletonList(ENTITY_SERVICES_PATH_INDEX), null, null);\n+        JsonNode dbConfig = getIndexConfig(Arrays.asList(ENTITY_SERVICES_RANGE_INDEX, DATABASE_RANGE_INDEX), Arrays.asList(ENTITY_SERVICES_PATH_INDEX, DATABASE_PATH_INDEX), DATABASE_FIELD_1, DATABASE_FIELD_2);\n+\n+        ModelController modelController = new ModelController();\n+\n+        JsonNode mergedNode = modelController.mergeIndexConfigs(dbConfig, indexConfig);\n+        String mergedConfig = mergedNode.toString();\n+\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, ENTITY_SERVICES_RANGE_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, DATABASE_RANGE_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, ENTITY_SERVICES_PATH_INDEX));\n+        assertEquals(1, StringUtils.countMatches(mergedConfig, DATABASE_PATH_INDEX));\n+        assertIndexesAndFields(mergedConfig);\n+    }\n+\n+    private void assertIndexesAndFields(String mergedConfig) {\n+        assertFalse(mergedConfig.contains(DATABASE_FIELD_1), \"Expected \" + DATABASE_FIELD_1 + \" to not be in mergedConfig: \" + mergedConfig);\n+        assertFalse(mergedConfig.contains(DATABASE_FIELD_2), \"Expected \" + DATABASE_FIELD_2 + \" to not be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(ENTITY_SERVICES_RANGE_INDEX), \"Expected \" + ENTITY_SERVICES_RANGE_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(ENTITY_SERVICES_PATH_INDEX), \"Expected \" + ENTITY_SERVICES_PATH_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(DATABASE_RANGE_INDEX), \"Expected \" + DATABASE_RANGE_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+        assertTrue(mergedConfig.contains(DATABASE_PATH_INDEX), \"Expected \" + DATABASE_PATH_INDEX + \" to be in mergedConfig: \" + mergedConfig);\n+    }\n+\n+    private JsonNode getIndexConfig(List<String> rangeIndexes, List<String> pathRangeIndexes, String language, String securityDatabase) {\n+        Database db = new Database(null, \"data-hub-FINAL\");\n+\n+        List<ElementIndex> elementIndexList = new ArrayList<>();\n+        rangeIndexes.forEach(rangeIndex -> {\n+            ElementIndex index = new ElementIndex();\n+            index.setLocalname(rangeIndex);\n+            elementIndexList.add(index);\n+        });\n+        db.setRangeElementIndex(elementIndexList);\n+\n+        db.setLanguage(language);\n+        db.setSecurityDatabase(securityDatabase);\n+\n+        ObjectNode jsonNode = db.toObjectNode();\n+        ArrayNode pathIndexes = jsonNode.putArray(\"range-path-index\");\n+        pathRangeIndexes.forEach(pathRangeIndex -> {\n+            ObjectNode pathIndex = pathIndexes.addObject();\n+            pathIndex.put(\"path-expression\", pathRangeIndex);\n+        });\n+\n+        return jsonNode;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAyMTk2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3941#discussion_r426021963", "bodyText": "Food for thought for the future - no change needed now:\n\"NounTest\" - e.g. \"ModelControllerTest\" - is usually a decent approach for the first couple tests. But that doesn't scale well as the \"Noun\" becomes able to do more \"Verbs\". At that points, it's worth refactoring into \"Verb1Test\", \"Verb2Test\", etc, and putting them into a package specific to the Noun.\nI think ModelControllerTest isn't too big yet, but when we add more tests, it's likely going to be worth moving to a VerbTest approach.", "author": "rjrudin", "createdAt": "2020-05-15T20:06:17Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java", "diffHunk": "@@ -60,26 +79,115 @@ private void updateModelInfo() {\n     }\n \n     private void updateModelEntityTypes() {\n+        // Loading unrelated indexes so that we can check for them after updating entity model", "originalCommit": "b6777afc22dfc3a5bd4d452ff1d0df426f91e0cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cbe12729dc9e0c6c31a4ffce5578d122277c9955", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\nindex 291a411c4..a2479fae0 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/model/ModelControllerTest.java\n\n@@ -147,16 +155,34 @@ public class ModelControllerTest extends AbstractHubCentralTest {\n     }\n \n     private void assertIndexDeployment() {\n-        ManageClient manageClient = getHubClient().getManageClient();\n         Stream.of(getHubConfig().getDbName(DatabaseKind.STAGING), getHubConfig().getDbName(DatabaseKind.FINAL)).forEach(databaseKind -> {\n-            String indexConfig = manageClient.getJson(\"/manage/v2/databases/\" + databaseKind + \"/properties\");\n-            assertTrue(indexConfig.contains(DATABASE_PROPERTY_1), \"Expected \" + DATABASE_PROPERTY_1 + \" to be in indexConfig: \" + indexConfig);\n-            assertTrue(indexConfig.contains(DATABASE_PROPERTY_2), \"Expected \" + DATABASE_PROPERTY_2 + \" to be in indexConfig: \" + indexConfig);\n-            assertTrue(indexConfig.contains(ENTITY_PROPERTY_1), \"Expected \" + ENTITY_PROPERTY_1 + \" to be in indexConfig: \" + indexConfig);\n-            assertTrue(indexConfig.contains(ENTITY_PROPERTY_2), \"Expected \" + ENTITY_PROPERTY_2 + \" to be in indexConfig: \" + indexConfig);\n+            verifyIndexes(databaseKind);\n         });\n     }\n \n+    private void verifyIndexes(String dbName) {\n+        String json = new DatabaseManager(getHubClient().getManageClient()).getPropertiesAsJson(dbName);\n+        Database db = new DefaultResourceMapper(new API(getHubClient().getManageClient())).readResource(json, Database.class);\n+\n+        List<PathNamespace> pathNamespaces = db.getPathNamespace();\n+        assertEquals(2, pathNamespaces.size());\n+        assertEquals(\"ex\", pathNamespaces.get(0).getPrefix(), \"The existing namespace is expected to be first, as the model-based \" +\n+            \"properties are expected to be merged on top of the existing properties\");\n+        assertEquals(\"http://example.org\", pathNamespaces.get(0).getNamespaceUri());\n+        assertEquals(\"es\", pathNamespaces.get(1).getPrefix());\n+        assertEquals(\"http://marklogic.com/entity-services\", pathNamespaces.get(1).getNamespaceUri());\n+\n+        List<ElementIndex> rangeIndexes = db.getRangeElementIndex();\n+        assertEquals(2, rangeIndexes.size());\n+        assertEquals(\"testRangeIndexForDHFPROD4704\", rangeIndexes.get(0).getLocalname());\n+        assertEquals(\"someProperty\", rangeIndexes.get(1).getLocalname());\n+\n+        List<PathIndex> pathIndexes = db.getRangePathIndex();\n+        assertEquals(2, pathIndexes.size());\n+        assertEquals(\"//*:instance/testPathIndexForDHFPROD4704\", pathIndexes.get(0).getPathExpression());\n+        assertEquals(\"//*:instance/Customer/someOtherProperty\", pathIndexes.get(1).getPathExpression());\n+    }\n+\n     private void loadUnrelatedIndexes() {\n         String indexConfig = \"{\\n\" +\n             \"   \\\"lang\\\":\\\"zxx\\\",\\n\" +\n"}}, {"oid": "da196c85281e73752f8f10bfd994508de7644daa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/da196c85281e73752f8f10bfd994508de7644daa", "message": "DHFPROD-4704: Deploy entity model configs after saving an entity", "committedDate": "2020-05-15T22:20:46Z", "type": "forcePushed"}, {"oid": "cbe12729dc9e0c6c31a4ffce5578d122277c9955", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cbe12729dc9e0c6c31a4ffce5578d122277c9955", "message": "Improving tests and logging\n\nUpgrading ml-gradle/ml-app-deployer based on a little fix in ml-app-deployer 4.0.1 to the Database class that allows for assertions on range path indexes.\n\nAlso did a little renaming in ModelController - introduced \"existingProperties\" and \"modelBasedProperties\" to make it crystal-clear what's merged into what.", "committedDate": "2020-05-18T15:37:54Z", "type": "forcePushed"}, {"oid": "c605f1b129d1024019398daed84b238f56c1ab34", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c605f1b129d1024019398daed84b238f56c1ab34", "message": "DHFPROD-4704: Deploy entity model configs after saving an entity\n\nImproving tests and logging\n\nUpgrading ml-gradle/ml-app-deployer based on a little fix in ml-app-deployer 4.0.1 to the Database class that allows for assertions on range path indexes.\n\nAlso did a little renaming in ModelController - introduced \"existingProperties\" and \"modelBasedProperties\" to make it crystal-clear what's merged into what.\n\nDHFPROD-4704: Use delete as there's a bug in deleteTaskWithPath", "committedDate": "2020-05-18T23:57:05Z", "type": "forcePushed"}, {"oid": "3774af794d5fb8072cfdbd6ecd8bdb0bfe3f9065", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3774af794d5fb8072cfdbd6ecd8bdb0bfe3f9065", "message": "DHFPROD-4704: Deploy entity model configs after saving an entity\n\nImproving tests and logging\n\nUpgrading ml-gradle/ml-app-deployer based on a little fix in ml-app-deployer 4.0.1 to the Database class that allows for assertions on range path indexes.\n\nAlso did a little renaming in ModelController - introduced \"existingProperties\" and \"modelBasedProperties\" to make it crystal-clear what's merged into what.\n\nDHFPROD-4704: Use delete as there's a bug in deleteTaskWithPath\n\nFix FlowManagerTest", "committedDate": "2020-05-19T14:29:47Z", "type": "commit"}, {"oid": "3774af794d5fb8072cfdbd6ecd8bdb0bfe3f9065", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3774af794d5fb8072cfdbd6ecd8bdb0bfe3f9065", "message": "DHFPROD-4704: Deploy entity model configs after saving an entity\n\nImproving tests and logging\n\nUpgrading ml-gradle/ml-app-deployer based on a little fix in ml-app-deployer 4.0.1 to the Database class that allows for assertions on range path indexes.\n\nAlso did a little renaming in ModelController - introduced \"existingProperties\" and \"modelBasedProperties\" to make it crystal-clear what's merged into what.\n\nDHFPROD-4704: Use delete as there's a bug in deleteTaskWithPath\n\nFix FlowManagerTest", "committedDate": "2020-05-19T14:29:47Z", "type": "forcePushed"}]}