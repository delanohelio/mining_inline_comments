{"pr_number": 3509, "pr_title": "DHFPROD-4095: Provide role information and better error output on login to UI", "pr_createdAt": "2020-01-27T18:33:43Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3509", "timeline": [{"oid": "f1305eb6fb34b989023422a53aca5523360ffaf7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f1305eb6fb34b989023422a53aca5523360ffaf7", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-27T18:36:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4NTExNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371485116", "bodyText": "This seems brittle - an \"instanceof\" check like below would be a lot better - more reliable and self-documenting. Can the custom code that creates this message throw a better exception for this class to catch?", "author": "rjrudin", "createdAt": "2020-01-27T21:13:02Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java", "diffHunk": "@@ -40,7 +41,13 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = new Gson().toJson(output);\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception.getMessage().contains(\"Cannot connect to MarkLogic\")) {", "originalCommit": "f1305eb6fb34b989023422a53aca5523360ffaf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk0NDU2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371944560", "bodyText": "changed to use instanceof BadRequestException", "author": "ryanjdew", "createdAt": "2020-01-28T17:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4NTExNg=="}], "type": "inlineReview", "revised_code": {"commit": "7211bf0fa27624a068a4078ae0f099d7dab5c7db", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java\nindex d7f7cbb3a..13645682f 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginFailureHandler.java\n\n@@ -41,7 +42,7 @@ public class LoginFailureHandler implements AuthenticationFailureHandler {\n         String json = new Gson().toJson(output);\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        if (exception.getMessage().contains(\"Cannot connect to MarkLogic\")) {\n+        if (exception instanceof BadRequestException) {\n             response.setStatus(HttpServletResponse.SC_BAD_REQUEST);\n         } else if (exception instanceof ForbiddenException) {\n             response.setStatus(HttpServletResponse.SC_FORBIDDEN);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5ODAwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371598001", "bodyText": "marklogic-data-hub/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n    \n    \n         Line 49\n      in\n      f1305eb\n    \n    \n    \n    \n\n        \n          \n           RolesService rolesService = RolesService.on(authenticationToken.getHubConfigSession().newStagingClient()); \n        \n    \n  \n\n\nSince we autowired the hubConfigSession, we do not need to access it through authentication token.", "author": "hao1st", "createdAt": "2020-01-28T03:48:07Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java", "diffHunk": "@@ -27,14 +33,24 @@\n import java.io.IOException;\n \n public class LoginLogoutHandler implements AuthenticationSuccessHandler, LogoutSuccessHandler {\n+    @Autowired\n+    HubConfigSession hubConfigSession;\n+\n+    ObjectMapper mapper = new ObjectMapper();\n \n     @Override\n     public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException {\n         ConnectionAuthenticationToken authenticationToken = (ConnectionAuthenticationToken)authentication;\n-\n+        ObjectNode output = mapper.createObjectNode();\n         clearAuthenticationAttributes(request);\n+        output.put(\"isInstalled\", authenticationToken.stagingIsAccessible());\n+        output.put(\"hasManagePrivileges\", authenticationToken.hasManagePrivileges());\n+        if (authenticationToken.stagingIsAccessible()) {\n+            RolesService rolesService = RolesService.on(authenticationToken.getHubConfigSession().newStagingClient());", "originalCommit": "f1305eb6fb34b989023422a53aca5523360ffaf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk0MzA5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371943093", "bodyText": "I should remove the autowired hubConfig. I was getting a null hubConfig when I tried to use the autowired version.", "author": "ryanjdew", "createdAt": "2020-01-28T17:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU5ODAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7211bf0fa27624a068a4078ae0f099d7dab5c7db", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\nindex 54a73e5fb..08b6c79f2 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n\n@@ -32,6 +33,7 @@ import javax.servlet.http.HttpServletResponse;\n import javax.servlet.http.HttpSession;\n import java.io.IOException;\n \n+@Component\n public class LoginLogoutHandler implements AuthenticationSuccessHandler, LogoutSuccessHandler {\n     @Autowired\n     HubConfigSession hubConfigSession;\n"}}, {"oid": "7211bf0fa27624a068a4078ae0f099d7dab5c7db", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7211bf0fa27624a068a4078ae0f099d7dab5c7db", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T06:18:20Z", "type": "forcePushed"}, {"oid": "f8eda555c809876d68372320bc9c6a473eca5007", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f8eda555c809876d68372320bc9c6a473eca5007", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T17:23:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk2MDEzMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r371960130", "bodyText": "I recommend tucking the original exception in here (as a 2nd argument to the constructor), just in case. It may be useful to at least see the message.", "author": "rjrudin", "createdAt": "2020-01-28T17:50:58Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -88,7 +90,7 @@ public Authentication authenticate(Authentication authentication) throws Authent\n             hasManagePrivileges = true;\n         }\n         catch(ResourceAccessException ex) {\n-            throw new BadCredentialsException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\");\n+            throw new BadRequestException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\");", "originalCommit": "f8eda555c809876d68372320bc9c6a473eca5007", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7ff6962cc96f783eb3ff01641359ba6e49e36d0b", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java\nindex cb6085fc4..74ccf48c4 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java\n\n@@ -90,7 +90,7 @@ public class MarkLogicAuthenticationManager implements AuthenticationProvider, A\n             hasManagePrivileges = true;\n         }\n         catch(ResourceAccessException ex) {\n-            throw new BadRequestException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\");\n+            throw new BadRequestException(\"Cannot connect to MarkLogic at \" + environmentInfo.mlHost + \". Are you sure MarkLogic is running?\", ex);\n         }\n         catch(HttpClientErrorException ex) {\n             if (HttpStatus.UNAUTHORIZED.equals(ex.getStatusCode())) {\n"}}, {"oid": "7ff6962cc96f783eb3ff01641359ba6e49e36d0b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7ff6962cc96f783eb3ff01641359ba6e49e36d0b", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T19:00:46Z", "type": "forcePushed"}, {"oid": "dd4d6e9beb39508bf111e3d7fdb7c3a6a1b6d8e2", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dd4d6e9beb39508bf111e3d7fdb7c3a6a1b6d8e2", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-28T22:59:21Z", "type": "forcePushed"}, {"oid": "16750b240901928335aca170799e27bb2e928a98", "url": "https://github.com/marklogic/marklogic-data-hub/commit/16750b240901928335aca170799e27bb2e928a98", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-29T05:21:19Z", "type": "commit"}, {"oid": "16750b240901928335aca170799e27bb2e928a98", "url": "https://github.com/marklogic/marklogic-data-hub/commit/16750b240901928335aca170799e27bb2e928a98", "message": "DHFPROD-4095: Provide role information on login to UI", "committedDate": "2020-01-29T05:21:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyODM0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r372228344", "bodyText": "i think we should not ignore the exception after checking the internal implementation of checkConnection().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Exception ignored) {\n          \n          \n            \n                DatabaseClient.ConnectionResult connResult;\n          \n          \n            \n                try {\n          \n          \n            \n                  connResult = dataServicesClient.checkConnection();\n          \n          \n            \n                } catch (Exception e) {\n          \n          \n            \n                  throw new BadRequestException(e.getMessage());\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                if (connResult != null && !connResult.isConnected()) {\n          \n          \n            \n                  if (connResult.getStatusCode() != null && connResult.getStatusCode() == 401) {\n          \n          \n            \n                    throw new BadCredentialsException(connResult.getErrorMessage());\n          \n          \n            \n                  } else {\n          \n          \n            \n                    throw new BadRequestException(connResult.getErrorMessage());\n          \n          \n            \n                  }\n          \n          \n            \n                }", "author": "hao1st", "createdAt": "2020-01-29T07:40:58Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -107,10 +109,13 @@ public Authentication authenticate(Authentication authentication) throws Authent\n         boolean stagingServerAccessible = false;\n         try {\n             stagingServerAccessible = dataServicesClient.checkConnection().isConnected();\n-        } catch (Exception e) {\n+        } catch (Exception ignored) {", "originalCommit": "16750b240901928335aca170799e27bb2e928a98", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIyOTMwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3509#discussion_r372229303", "bodyText": "we do not need to check stagingServerAccessible because it is a flag to indicate connection status.", "author": "hao1st", "createdAt": "2020-01-29T07:43:59Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -107,10 +109,13 @@ public Authentication authenticate(Authentication authentication) throws Authent\n         boolean stagingServerAccessible = false;\n         try {\n             stagingServerAccessible = dataServicesClient.checkConnection().isConnected();\n-        } catch (Exception e) {\n+        } catch (Exception ignored) {\n+        }\n+        if (!(hasManagePrivileges || stagingServerAccessible)) {", "originalCommit": "16750b240901928335aca170799e27bb2e928a98", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}