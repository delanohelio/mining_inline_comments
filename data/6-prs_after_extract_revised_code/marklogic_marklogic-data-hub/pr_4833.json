{"pr_number": 4833, "pr_title": "DHFPROD-6184:  Write records via URI Template using spark connector", "pr_createdAt": "2020-11-09T08:39:26Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4833", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5ODM4Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r519998382", "bodyText": "This test class already has too many scenarios in it - let's make a new \"WriteDataWithUriTemplateTest\" to capture all of these tests. Makes it easy to see all the test coverage for this feature.", "author": "rjrudin", "createdAt": "2020-11-09T17:41:28Z", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java", "diffHunk": "@@ -6,13 +6,102 @@\n import com.marklogic.hub.spark.sql.sources.v2.AbstractSparkConnectorTest;\n import org.junit.jupiter.api.Test;\n \n+import org.apache.spark.sql.sources.v2.writer.WriterCommitMessage;\n+\n import java.util.Set;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n \n+    @Test", "originalCommit": "61417d4a6e4f1f423494d530455c9b9c71f281bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3MDQwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520070401", "bodyText": "ready for commit", "author": "josvanroosmalen", "createdAt": "2020-11-09T19:35:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5ODM4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "56f76cac564e288a361ce479e4c24c482cf49cc2", "chunk": "diff --git a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\nindex d5c643abe..078693fc5 100644\n--- a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n+++ b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n\n@@ -16,92 +16,6 @@ import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n-\n-    @Test\n-    void testInvalidUriTemplate1() {\n-        String uriTemplate = \"{property1.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Unclosed token in uritemplate=[{property1.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate2() {\n-        String uriTemplate = \"property2}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Closing curly bracket found without opening bracket. uritemplate=[property2}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate3() {\n-        String uriTemplate = \"{{property1}property2}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Nested tokens in uritemplate=[{{property1}property2}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate4() {\n-        String uriTemplate = \"{{property1}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Nested tokens in uritemplate=[{{property1}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate5() {\n-        String uriTemplate = \"/a/b/c/{}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"UriTemplate has empty tokens. uritemplate=[/a/b/c/{}.json].\",msg);\n-         }\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplate() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}.json\"));\n-        writeRows(buildRow(\"pineapple\", \"green\"));\n-        String uri = getFruitUris()[0];\n-        assertEquals(\"/fruit/green/pineapple.json\",uri);\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplateNullInContent() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}.json\"));\n-        WriterCommitMessage response = writeRows(buildRow(\"pineapple\",null));\n-        assertNotNull(response);\n-        assertEquals(AtLeastOneWriteFailedMessage.class,response.getClass());\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplateUndefinedInContent() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}/{doesnotexist}.json\"));\n-        WriterCommitMessage response = writeRows(buildRow(\"pineapple\",null));\n-        assertNotNull(response);\n-        assertEquals(AtLeastOneWriteFailedMessage.class,response.getClass());\n-    }\n-\n-\n     @Test\n     void ingestDocsWithCollection() {\n         String collections = \"fruits,stuff\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5ODgxNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r519998814", "bodyText": "For consistency with other tests, do this:\nRuntimeException ex = assertThrows(RuntimeException.class, () -> initializeDataWriter....);\nassertEquals(\"...\", ex.getMessage());", "author": "rjrudin", "createdAt": "2020-11-09T17:42:07Z", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java", "diffHunk": "@@ -6,13 +6,102 @@\n import com.marklogic.hub.spark.sql.sources.v2.AbstractSparkConnectorTest;\n import org.junit.jupiter.api.Test;\n \n+import org.apache.spark.sql.sources.v2.writer.WriterCommitMessage;\n+\n import java.util.Set;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n \n public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n \n+    @Test\n+    void testInvalidUriTemplate1() {\n+        String uriTemplate = \"{property1.json\";\n+        try {", "originalCommit": "61417d4a6e4f1f423494d530455c9b9c71f281bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3NDM1Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520074356", "bodyText": "Ready for commit", "author": "josvanroosmalen", "createdAt": "2020-11-09T19:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5ODgxNA=="}], "type": "inlineReview", "revised_code": {"commit": "56f76cac564e288a361ce479e4c24c482cf49cc2", "chunk": "diff --git a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\nindex d5c643abe..078693fc5 100644\n--- a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n+++ b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n\n@@ -16,92 +16,6 @@ import static org.junit.jupiter.api.Assertions.assertTrue;\n import static org.junit.jupiter.api.Assertions.fail;\n \n public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n-\n-    @Test\n-    void testInvalidUriTemplate1() {\n-        String uriTemplate = \"{property1.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Unclosed token in uritemplate=[{property1.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate2() {\n-        String uriTemplate = \"property2}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Closing curly bracket found without opening bracket. uritemplate=[property2}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate3() {\n-        String uriTemplate = \"{{property1}property2}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Nested tokens in uritemplate=[{{property1}property2}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate4() {\n-        String uriTemplate = \"{{property1}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"Nested tokens in uritemplate=[{{property1}.json].\",msg);\n-        }\n-    }\n-\n-    @Test\n-    void testInvalidUriTemplate5() {\n-        String uriTemplate = \"/a/b/c/{}.json\";\n-        try {\n-            initializeDataWriter(newFruitOptions().withUriTemplate(uriTemplate));\n-            fail();\n-        } catch (RuntimeException e) {\n-            String msg = e.getMessage();\n-            assertEquals(\"UriTemplate has empty tokens. uritemplate=[/a/b/c/{}.json].\",msg);\n-         }\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplate() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}.json\"));\n-        writeRows(buildRow(\"pineapple\", \"green\"));\n-        String uri = getFruitUris()[0];\n-        assertEquals(\"/fruit/green/pineapple.json\",uri);\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplateNullInContent() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}.json\"));\n-        WriterCommitMessage response = writeRows(buildRow(\"pineapple\",null));\n-        assertNotNull(response);\n-        assertEquals(AtLeastOneWriteFailedMessage.class,response.getClass());\n-    }\n-\n-    @Test\n-    void ingestDocWithUriTemplateUndefinedInContent() {\n-        initializeDataWriter(newFruitOptions().withUriTemplate(\"/fruit/{fruitColor}/{fruitName}/{doesnotexist}.json\"));\n-        WriterCommitMessage response = writeRows(buildRow(\"pineapple\",null));\n-        assertNotNull(response);\n-        assertEquals(AtLeastOneWriteFailedMessage.class,response.getClass());\n-    }\n-\n-\n     @Test\n     void ingestDocsWithCollection() {\n         String collections = \"fruits,stuff\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwNDAzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520004039", "bodyText": "For consistency with my proposal for error messages in the DS endpoint, let's do a format of:\nthrow new IllegalArgumentException(\"Cannot apply uriTemplate: \" + uriTemplate + \"; closing curly bracket found without opening bracket\");\n\nIllegalArgumentException is a bit more descriptive than RuntimeException. And we don't have a precedent for using \"[\" and \"]\" to surround user-provided inputs (it's a nice pattern, we just don't do it elsewhere).", "author": "rjrudin", "createdAt": "2020-11-09T17:50:25Z", "path": "marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataSourceWriter.java", "diffHunk": "@@ -101,6 +100,48 @@ private boolean atLeastOneWriteFailed(WriterCommitMessage[] messages) {\n         return false;\n     }\n \n+    /**\n+     * Validate the URI template if present in the options.\n+     *\n+     * A valid URI template:\n+     * - Has no missing opening or closing curly brackets.\n+     * - Each token has >0 characters.\n+     * - Has no nested curcly brackets.\n+     */\n+    private void validateUriTemplateIfPresent() {\n+        String uriTemplate = options.get(\"uritemplate\");\n+        if ( uriTemplate == null ) {\n+            return;\n+        }\n+        boolean inToken = false;\n+        int tokenSize = 0;\n+        char[] chars = uriTemplate.toCharArray();\n+        for ( char ch : chars ) {\n+            if ( ch == '}' ) {\n+                if ( !inToken ) {\n+                    throw new RuntimeException(\"Closing curly bracket found without opening bracket. uritemplate=[\" + uriTemplate + \"].\");", "originalCommit": "61417d4a6e4f1f423494d530455c9b9c71f281bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA4MzMzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520083339", "bodyText": "ready for commit.", "author": "josvanroosmalen", "createdAt": "2020-11-09T19:58:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwNDAzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "56f76cac564e288a361ce479e4c24c482cf49cc2", "chunk": "diff --git a/marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataSourceWriter.java b/marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataSourceWriter.java\nindex 3bce5be30..64dd039ae 100644\n--- a/marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataSourceWriter.java\n+++ b/marklogic-data-hub-spark-connector/src/main/java/com/marklogic/hub/spark/sql/sources/v2/writer/HubDataSourceWriter.java\n\n@@ -119,15 +119,15 @@ public class HubDataSourceWriter extends LoggingObject implements StreamWriter {\n         for ( char ch : chars ) {\n             if ( ch == '}' ) {\n                 if ( !inToken ) {\n-                    throw new RuntimeException(\"Closing curly bracket found without opening bracket. uritemplate=[\" + uriTemplate + \"].\");\n+                    throw new IllegalArgumentException(\"Closing curly bracket found without opening bracket. uritemplate=\" + uriTemplate + \".\");\n                 }\n                 if ( tokenSize == 0 ) {\n-                    throw new RuntimeException(\"UriTemplate has empty tokens. uritemplate=[\" + uriTemplate + \"].\");\n+                    throw new IllegalArgumentException(\"UriTemplate has empty tokens. uritemplate=\" + uriTemplate + \".\");\n                 }\n                 inToken = false;\n             } else if ( ch == '{' ) {\n                 if ( inToken ) {\n-                    throw new RuntimeException(\"Nested tokens in uritemplate=[\" + uriTemplate + \"].\");\n+                    throw new IllegalArgumentException(\"Nested tokens in uritemplate=\" + uriTemplate + \".\");\n                 }\n                 inToken = true;\n                 tokenSize = 0;\n"}}, {"oid": "56f76cac564e288a361ce479e4c24c482cf49cc2", "url": "https://github.com/marklogic/marklogic-data-hub/commit/56f76cac564e288a361ce479e4c24c482cf49cc2", "message": "UriTemplate\n\nUri template\n\nDHFPROD-6184\n\nDHFPROD-6184", "committedDate": "2020-11-09T20:28:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEwNDY1OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520104658", "bodyText": "Just do a revert on this file so that there are no changes to it", "author": "rjrudin", "createdAt": "2020-11-09T20:37:37Z", "path": "marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java", "diffHunk": "@@ -6,13 +6,16 @@\n import com.marklogic.hub.spark.sql.sources.v2.AbstractSparkConnectorTest;\n import org.junit.jupiter.api.Test;\n \n+import org.apache.spark.sql.sources.v2.writer.WriterCommitMessage;", "originalCommit": "56f76cac564e288a361ce479e4c24c482cf49cc2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExOTA5Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4833#discussion_r520119093", "bodyText": "ready for commit", "author": "josvanroosmalen", "createdAt": "2020-11-09T21:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEwNDY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "90f5c228aecb94d79618e3c3ab9d9486a19364a8", "chunk": "diff --git a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\nindex 078693fc5..612231f73 100644\n--- a/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n+++ b/marklogic-data-hub-spark-connector/src/test/java/com/marklogic/hub/spark/sql/sources/v2/writer/WriteDataWithOptionsTest.java\n\n@@ -6,16 +6,13 @@ import com.marklogic.client.io.JacksonHandle;\n import com.marklogic.hub.spark.sql.sources.v2.AbstractSparkConnectorTest;\n import org.junit.jupiter.api.Test;\n \n-import org.apache.spark.sql.sources.v2.writer.WriterCommitMessage;\n-\n import java.util.Set;\n \n import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.junit.jupiter.api.Assertions.assertNotNull;\n import static org.junit.jupiter.api.Assertions.assertTrue;\n-import static org.junit.jupiter.api.Assertions.fail;\n \n public class WriteDataWithOptionsTest extends AbstractSparkConnectorTest {\n+\n     @Test\n     void ingestDocsWithCollection() {\n         String collections = \"fruits,stuff\";\n"}}, {"oid": "90f5c228aecb94d79618e3c3ab9d9486a19364a8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/90f5c228aecb94d79618e3c3ab9d9486a19364a8", "message": "DHFPROD-6184\n\nUriTemplate\n\nUri template\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nUriTemplate\n\nUri template\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184", "committedDate": "2020-11-09T21:38:52Z", "type": "commit"}, {"oid": "90f5c228aecb94d79618e3c3ab9d9486a19364a8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/90f5c228aecb94d79618e3c3ab9d9486a19364a8", "message": "DHFPROD-6184\n\nUriTemplate\n\nUri template\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nUriTemplate\n\nUri template\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184\n\nDHFPROD-6184", "committedDate": "2020-11-09T21:38:52Z", "type": "forcePushed"}]}