{"pr_number": 3504, "pr_title": "DHFPROD-4099: Support configurable session timeout (5 min as default)", "pr_createdAt": "2020-01-24T21:21:12Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3504", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MzE4NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r370853184", "bodyText": "Is there are more appropriate annotation to use here? Perhaps just \"Component\"? If that has the same effect, I think that'd be better because this class of course is not a controller.", "author": "rjrudin", "createdAt": "2020-01-24T21:36:11Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java", "diffHunk": "@@ -19,13 +19,15 @@\n import org.springframework.security.web.WebAttributes;\n import org.springframework.security.web.authentication.AuthenticationSuccessHandler;\n import org.springframework.security.web.authentication.logout.LogoutSuccessHandler;\n+import org.springframework.stereotype.Controller;\n \n import javax.servlet.ServletException;\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n import javax.servlet.http.HttpSession;\n import java.io.IOException;\n \n+@Controller", "originalCommit": "efa8d87b6c78092a1056eec19e66b73de3718a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg2MDYxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r370860613", "bodyText": "Actually, i think the handler should be a controller. It can be refactor into the com.marklogic.hub.oneui.controllers package to make it more clear.", "author": "hao1st", "createdAt": "2020-01-24T21:57:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MzE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ2NDY1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371464651", "bodyText": "I agree with @rjrudin . I think it should be a \"Component\" and not a \"Controller\".", "author": "srinathgit", "createdAt": "2020-01-27T20:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MzE4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4NjYyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371486629", "bodyText": "OK, i do not have strong opinion with which one we should use for the spring annotation. I will check it because of majority takes over.", "author": "hao1st", "createdAt": "2020-01-27T21:16:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1MzE4NA=="}], "type": "inlineReview", "revised_code": {"commit": "83cae1f8798a1be345e38752414a5912a9a5baf7", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\nindex 733fb928d..c9a391ab8 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java\n\n@@ -19,6 +19,7 @@ import org.springframework.security.core.Authentication;\n import org.springframework.security.web.WebAttributes;\n import org.springframework.security.web.authentication.AuthenticationSuccessHandler;\n import org.springframework.security.web.authentication.logout.LogoutSuccessHandler;\n+import org.springframework.stereotype.Component;\n import org.springframework.stereotype.Controller;\n \n import javax.servlet.ServletException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1Mzc1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r370853759", "bodyText": "There needs to be a test for this method. Otherwise, someone could add code that causes a null pointer exception or something similar, and we'd never know it.\nI think a suitable test would be to populate that map with two DatabaseClient objects, and then call destroy. Then verify that the map is empty (I can't think of a good way to verify that the clients were released). That's a decent smoke test.", "author": "rjrudin", "createdAt": "2020-01-24T21:37:55Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1002,4 +1008,19 @@ public void afterPropertiesSet() throws Exception {\n         hubConfigImpl.hydrateConfigs();\n         this.dataHub = new DataHubImpl(this);\n     }\n+\n+    @Override\n+    public void destroy() {", "originalCommit": "efa8d87b6c78092a1056eec19e66b73de3718a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg3NDI3OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r370874279", "bodyText": "@rjrudin A new test class was created for checking the function.", "author": "hao1st", "createdAt": "2020-01-24T22:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1Mzc1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ4OTg1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371489857", "bodyText": "Just a note - this logic is the sort of thing that should eventually move into a HubClient class, where it'd be a lot easier to test - i.e. create a HubClient with 3 DatabaseClients, then call destroy, then verify that each of the 3 DatabaseClients throws an error if you try to do something with it.", "author": "rjrudin", "createdAt": "2020-01-27T21:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg1Mzc1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java b/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\nindex f5dc390a1..c130b5f9a 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\n\n@@ -1023,4 +1023,9 @@ public class HubConfigSession implements HubConfig, InitializingBean, Disposable\n             clientsByKindAndDatabaseName.clear();\n         }\n     }\n+\n+    //only for test purpose\n+    public Map<DatabaseKind, Map<String, DatabaseClient>> getAllDatabaseClients() {\n+        return clientsByKindAndDatabaseName;\n+    }\n }\n"}}, {"oid": "37504eb0e777f7f5bfb15e78bf9367b674b97f01", "url": "https://github.com/marklogic/marklogic-data-hub/commit/37504eb0e777f7f5bfb15e78bf9367b674b97f01", "message": "DHFPROD-4099: Support configurable session timeout (5 min as default)", "committedDate": "2020-01-27T17:06:33Z", "type": "commit"}, {"oid": "7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "message": "DHFPROD-4099: add a new test class", "committedDate": "2020-01-27T17:06:33Z", "type": "commit"}, {"oid": "7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "message": "DHFPROD-4099: add a new test class", "committedDate": "2020-01-27T17:06:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNjgzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371426836", "bodyText": "I think using public class variables can be avoided. You can autowire HubConfigSession or use a getter if required", "author": "srinathgit", "createdAt": "2020-01-27T19:09:01Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "diffHunk": "@@ -23,7 +23,7 @@\n     public String dataHubDeveloperPassword;\n \n     @Autowired\n-    private HubConfigSession hubConfig;\n+    public HubConfigSession hubConfig;", "originalCommit": "7d39138bfbc00cad9c7a903b3c570a13aee1faaf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMTQ4MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371431481", "bodyText": "@srinathgit I just changed it based on your suggestion.", "author": "hao1st", "createdAt": "2020-01-27T19:18:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQyNjgzNg=="}], "type": "inlineReview", "revised_code": {"commit": "8cacc4da3a8fb1f05dd49911bbe855f74f9b3835", "chunk": "diff --git a/one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java b/one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java\nindex 72a375889..b6a9b8f92 100644\n--- a/one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java\n+++ b/one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java\n\n@@ -23,7 +23,7 @@ public class TestHelper {\n     public String dataHubDeveloperPassword;\n \n     @Autowired\n-    public HubConfigSession hubConfig;\n+    private HubConfigSession hubConfig;\n \n     public void authenticateSession() {\n        EnvironmentInfo environmentInfo = new EnvironmentInfo(mlHost, \"DIGEST\", 8000,\"DIGEST\", 8002,\"DIGEST\", 8010, \"DIGEST\", 8011);\n"}}, {"oid": "8cacc4da3a8fb1f05dd49911bbe855f74f9b3835", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8cacc4da3a8fb1f05dd49911bbe855f74f9b3835", "message": "DHFPROD-4099: Use autowired rather than object reference", "committedDate": "2020-01-27T19:17:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzNTUwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371435506", "bodyText": "This method can be \"protected\" and test can be added to same package", "author": "srinathgit", "createdAt": "2020-01-27T19:26:19Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java", "diffHunk": "@@ -1002,4 +1008,24 @@ public void afterPropertiesSet() throws Exception {\n         hubConfigImpl.hydrateConfigs();\n         this.dataHub = new DataHubImpl(this);\n     }\n+\n+    @Override\n+    public void destroy() {\n+        if (!clientsByKindAndDatabaseName.isEmpty()) {\n+            clientsByKindAndDatabaseName.values().stream()\n+                .flatMap(s -> s.values().stream().filter(Objects::nonNull))\n+                .forEach(\n+                    e -> {\n+                        logger.debug(String.format(\"release %s (%s)\", e.getDatabase(), e.toString()));\n+                        e.release();\n+                        e = null;\n+                    });\n+            clientsByKindAndDatabaseName.clear();\n+        }\n+    }\n+\n+    //only for test purpose\n+    public Map<DatabaseKind, Map<String, DatabaseClient>> getAllDatabaseClients() {", "originalCommit": "8cacc4da3a8fb1f05dd49911bbe855f74f9b3835", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NjQ0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3504#discussion_r371456447", "bodyText": "@srinathgit good suggestion...", "author": "hao1st", "createdAt": "2020-01-27T20:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzNTUwNg=="}], "type": "inlineReview", "revised_code": {"commit": "0ce401e56da9b1036fdf51a5fe935cd4db4a2dc5", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java b/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\nindex c130b5f9a..10a77048f 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/models/HubConfigSession.java\n\n@@ -1025,7 +1025,7 @@ public class HubConfigSession implements HubConfig, InitializingBean, Disposable\n     }\n \n     //only for test purpose\n-    public Map<DatabaseKind, Map<String, DatabaseClient>> getAllDatabaseClients() {\n+    protected Map<DatabaseKind, Map<String, DatabaseClient>> getAllDatabaseClients() {\n         return clientsByKindAndDatabaseName;\n     }\n }\n"}}, {"oid": "0ce401e56da9b1036fdf51a5fe935cd4db4a2dc5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0ce401e56da9b1036fdf51a5fe935cd4db4a2dc5", "message": "DHFPROD-4099: Refractor for a test class", "committedDate": "2020-01-27T20:07:56Z", "type": "commit"}, {"oid": "83cae1f8798a1be345e38752414a5912a9a5baf7", "url": "https://github.com/marklogic/marklogic-data-hub/commit/83cae1f8798a1be345e38752414a5912a9a5baf7", "message": "DHFPROD-4099: Replaced an annotation Controller with Component", "committedDate": "2020-01-27T21:52:55Z", "type": "commit"}]}