{"pr_number": 4537, "pr_title": "DHFPROD-5811: Hopefully fixing how schemas dbs are cleared in tests", "pr_createdAt": "2020-09-08T17:59:46Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4537", "timeline": [{"oid": "12725ced42f6b3c87a781f6900990d6c4c46dbbc", "url": "https://github.com/marklogic/marklogic-data-hub/commit/12725ced42f6b3c87a781f6900990d6c4c46dbbc", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build.", "committedDate": "2020-09-09T12:29:45Z", "type": "forcePushed"}, {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nAlso added some primitive retry support for resetDatabases. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build.", "committedDate": "2020-09-09T19:37:17Z", "type": "commit"}, {"oid": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "message": "DHFPROD-5811: Fixing failing tests\n\nThe use of newAppServicesDatabaseClient is failing intermittently. Since we don't need to retain any documents, we can use the Manage API to clear the database. \n\nAlso added some primitive retry support for resetDatabases. \n\nModified DeployUserAmpsTest to only run if nightly build has major version of 10. Also added a little unit test to verify that \"major\" is set if it's a nightly build.", "committedDate": "2020-09-09T19:37:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNjM5Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#discussion_r485906396", "bodyText": "Should we create our own no-arg/no-return functional interface to avoid confusion related to Runnable being related to threads?\nhttps://stackoverflow.com/a/23958916/4460877", "author": "akshaysonvane", "createdAt": "2020-09-09T20:35:24Z", "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/AbstractHubTest.java", "diffHunk": "@@ -100,15 +104,41 @@ protected void resetDatabases() {\n         runAsAdmin();\n         String xquery = \"cts:uris((), (), cts:not-query(cts:collection-query('hub-core-artifact'))) ! xdmp:document-delete(.)\";\n         HubClient hubClient = getHubClient();\n-        hubClient.getStagingClient().newServerEval().xquery(xquery).evalAs(String.class);\n-        hubClient.getFinalClient().newServerEval().xquery(xquery).evalAs(String.class);\n-        hubClient.getJobsClient().newServerEval().xquery(xquery).evalAs(String.class);\n-\n-        HubConfig hubConfig = getHubConfig();\n-        hubConfig.getAppConfig().newAppServicesDatabaseClient(hubConfig.getDbName(DatabaseKind.STAGING_SCHEMAS))\n-            .newServerEval().xquery(xquery).evalAs(String.class);\n-        hubConfig.getAppConfig().newAppServicesDatabaseClient(hubConfig.getDbName(DatabaseKind.FINAL_SCHEMAS))\n-            .newServerEval().xquery(xquery).evalAs(String.class);\n+        // Running these with primitive retry support, as if a connection cannot be made to ML, this is typically the\n+        // first thing that will fail\n+        retryIfNecessary(() -> hubClient.getStagingClient().newServerEval().xquery(xquery).evalAs(String.class));\n+        retryIfNecessary(() -> hubClient.getFinalClient().newServerEval().xquery(xquery).evalAs(String.class));\n+        retryIfNecessary(() -> hubClient.getJobsClient().newServerEval().xquery(xquery).evalAs(String.class));\n+\n+        DatabaseManager databaseManager = new DatabaseManager(hubClient.getManageClient());\n+        databaseManager.clearDatabase(hubClient.getDbName(DatabaseKind.STAGING_SCHEMAS));\n+        databaseManager.clearDatabase(hubClient.getDbName(DatabaseKind.FINAL_SCHEMAS));\n+    }\n+\n+    /**\n+     * Adding this to handle some intermittent connection failures that occur when Jenkins runs the tests.\n+     * @param r\n+     */\n+    protected void retryIfNecessary(Runnable r) {", "originalCommit": "7611534c0b07b7c2fa30ac36e6bfc0c04bfdc711", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwOTEyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#discussion_r485909120", "bodyText": "I'm hoping I can remove this soon - it's just here for now to see if it helps at all. ML app servers shouldn't be unavailable for stretches of time during the test suite run - this is just to see if it helps. Hopefully the real problem can be fixed.", "author": "rjrudin", "createdAt": "2020-09-09T20:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNjM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxMjIxMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4537#discussion_r485912210", "bodyText": "I see. If we do need to add this in, I think it would be worthwhile to add a comment explaining that Runnable is only being used as a no-arg/no-return functional interface and does not have anything to do with Threads.", "author": "akshaysonvane", "createdAt": "2020-09-09T20:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkwNjM5Ng=="}], "type": "inlineReview", "revised_code": null}]}