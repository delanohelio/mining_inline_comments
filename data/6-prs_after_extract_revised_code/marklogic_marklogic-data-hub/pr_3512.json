{"pr_number": 3512, "pr_title": "DHFPROD-3788:Download project", "pr_createdAt": "2020-01-27T22:53:00Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3512", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU0MjMyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3512#discussion_r371542325", "bodyText": "We can get this done in one write - instead of calling this method, add an overloaded method to HubProject - e.g. exportProject(OutputStream) - and then pass in response.getOutputStream. That method will wrap a ZipOutputStream around it and write the contents directly to the HTTP response. That avoids messing around with files.", "author": "rjrudin", "createdAt": "2020-01-27T23:35:38Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -114,6 +121,23 @@ public void onError(String commandName, Exception exception) {\n         return payload;\n     }\n \n+    @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n+    public void downloadProject(HttpServletRequest request, HttpServletResponse response) {\n+        HubProject project = hubConfig.getHubProject();\n+        File exportFile = project.getProjectDir().resolve(\"build\").resolve(\"datahub-project.zip\").toFile();\n+        project.exportProject(exportFile);", "originalCommit": "e5d528c373bfddc35c8a952fa61d9ec07ebe831a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cc0d2d47c0e16abc38d1440c5c61fea6433fb86c", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\nindex 6740703c5..e590dda2f 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n\n@@ -124,14 +123,12 @@ public class EnvironmentController {\n     @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n     public void downloadProject(HttpServletRequest request, HttpServletResponse response) {\n         HubProject project = hubConfig.getHubProject();\n-        File exportFile = project.getProjectDir().resolve(\"build\").resolve(\"datahub-project.zip\").toFile();\n-        project.exportProject(exportFile);\n-\n         response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n-        response.addHeader(\"Content-Disposition\", \"attachment; filename=\" + exportFile.getName());\n-        response.setContentLength((int) exportFile.length());\n+        response.addHeader(\"Content-Disposition\", \"attachment; filename=datahub-project.zip\");\n         try {\n-            Files.copy(exportFile.toPath(), response.getOutputStream());\n+            OutputStream out = response.getOutputStream();\n+            project.exportProject(out);\n+            out.close();\n             response.flushBuffer();\n         } catch (IOException e) {\n             throw new RuntimeException(\"Unable to download project;cause: \" + e.getMessage());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU0MjY1Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3512#discussion_r371542653", "bodyText": "Hmm - I see this, as I don't think this is necessary to call - at least I'm hoping it isn't, as it would force us to write the data out to a file first. But I'm pretty certain it doesn't need to be called, and thus shouldn't if we can write the zip directly to the response.", "author": "rjrudin", "createdAt": "2020-01-27T23:36:40Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -114,6 +121,23 @@ public void onError(String commandName, Exception exception) {\n         return payload;\n     }\n \n+    @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n+    public void downloadProject(HttpServletRequest request, HttpServletResponse response) {\n+        HubProject project = hubConfig.getHubProject();\n+        File exportFile = project.getProjectDir().resolve(\"build\").resolve(\"datahub-project.zip\").toFile();\n+        project.exportProject(exportFile);\n+\n+        response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n+        response.addHeader(\"Content-Disposition\", \"attachment; filename=\" + exportFile.getName());\n+        response.setContentLength((int) exportFile.length());", "originalCommit": "e5d528c373bfddc35c8a952fa61d9ec07ebe831a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cc0d2d47c0e16abc38d1440c5c61fea6433fb86c", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\nindex 6740703c5..e590dda2f 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n\n@@ -124,14 +123,12 @@ public class EnvironmentController {\n     @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n     public void downloadProject(HttpServletRequest request, HttpServletResponse response) {\n         HubProject project = hubConfig.getHubProject();\n-        File exportFile = project.getProjectDir().resolve(\"build\").resolve(\"datahub-project.zip\").toFile();\n-        project.exportProject(exportFile);\n-\n         response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n-        response.addHeader(\"Content-Disposition\", \"attachment; filename=\" + exportFile.getName());\n-        response.setContentLength((int) exportFile.length());\n+        response.addHeader(\"Content-Disposition\", \"attachment; filename=datahub-project.zip\");\n         try {\n-            Files.copy(exportFile.toPath(), response.getOutputStream());\n+            OutputStream out = response.getOutputStream();\n+            project.exportProject(out);\n+            out.close();\n             response.flushBuffer();\n         } catch (IOException e) {\n             throw new RuntimeException(\"Unable to download project;cause: \" + e.getMessage());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU0MzAxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3512#discussion_r371543013", "bodyText": "You can test this by using Spring's MockHttpServletRequest (which can be empty) and MockHttpServletResponse. After calling the method, you can get the response bytes from the Mock response. And you should be able to open a ZipInputStream on that and verify a couple entries (no need to verify every single entry - I think verifying 2 of them is enough of a test).", "author": "rjrudin", "createdAt": "2020-01-27T23:37:58Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -114,6 +121,23 @@ public void onError(String commandName, Exception exception) {\n         return payload;\n     }\n \n+    @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n+    public void downloadProject(HttpServletRequest request, HttpServletResponse response) {", "originalCommit": "e5d528c373bfddc35c8a952fa61d9ec07ebe831a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cc0d2d47c0e16abc38d1440c5c61fea6433fb86c", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\nindex 6740703c5..e590dda2f 100644\n--- a/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n+++ b/one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java\n\n@@ -124,14 +123,12 @@ public class EnvironmentController {\n     @RequestMapping(value = \"/project-download\", produces = \"application/zip\")\n     public void downloadProject(HttpServletRequest request, HttpServletResponse response) {\n         HubProject project = hubConfig.getHubProject();\n-        File exportFile = project.getProjectDir().resolve(\"build\").resolve(\"datahub-project.zip\").toFile();\n-        project.exportProject(exportFile);\n-\n         response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);\n-        response.addHeader(\"Content-Disposition\", \"attachment; filename=\" + exportFile.getName());\n-        response.setContentLength((int) exportFile.length());\n+        response.addHeader(\"Content-Disposition\", \"attachment; filename=datahub-project.zip\");\n         try {\n-            Files.copy(exportFile.toPath(), response.getOutputStream());\n+            OutputStream out = response.getOutputStream();\n+            project.exportProject(out);\n+            out.close();\n             response.flushBuffer();\n         } catch (IOException e) {\n             throw new RuntimeException(\"Unable to download project;cause: \" + e.getMessage());\n"}}, {"oid": "cc0d2d47c0e16abc38d1440c5c61fea6433fb86c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/cc0d2d47c0e16abc38d1440c5c61fea6433fb86c", "message": "DHFPROD-3788:Download project", "committedDate": "2020-01-28T05:31:22Z", "type": "forcePushed"}, {"oid": "a63ca28130fa36e6deb5a51d1ad48b364743553c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a63ca28130fa36e6deb5a51d1ad48b364743553c", "message": "DHFPROD-3788:Download project", "committedDate": "2020-01-28T05:36:24Z", "type": "forcePushed"}, {"oid": "7cebdbbd69c2b80f3e19c1b65635eece9458672a", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7cebdbbd69c2b80f3e19c1b65635eece9458672a", "message": "DHFPROD-3788:Download project", "committedDate": "2020-01-28T05:39:02Z", "type": "forcePushed"}, {"oid": "edea77141b7c02d5af0a026d4eb0e93f264ff899", "url": "https://github.com/marklogic/marklogic-data-hub/commit/edea77141b7c02d5af0a026d4eb0e93f264ff899", "message": "DHFPROD-3788:Download project", "committedDate": "2020-01-28T06:28:47Z", "type": "forcePushed"}, {"oid": "edea77141b7c02d5af0a026d4eb0e93f264ff899", "url": "https://github.com/marklogic/marklogic-data-hub/commit/edea77141b7c02d5af0a026d4eb0e93f264ff899", "message": "DHFPROD-3788:Download project", "committedDate": "2020-01-28T06:28:47Z", "type": "commit"}]}