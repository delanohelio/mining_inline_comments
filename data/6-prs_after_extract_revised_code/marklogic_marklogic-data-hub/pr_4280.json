{"pr_number": 4280, "pr_title": "DHFPROD-5460:Determine if DHF installer can be run against existing DHS instance", "pr_createdAt": "2020-07-27T06:56:44Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4280", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDAwMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460834001", "bodyText": "Since this class has a reference to HubConfig, I don't think it needs any inputs here, and it should do the work of using Versions to get the needed data. That will simplify what the subclass has to do.", "author": "rjrudin", "createdAt": "2020-07-27T11:48:39Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java", "diffHunk": "@@ -81,4 +84,21 @@ protected String getServerMajorVersion() {\n             return \"9\";\n         }\n     }\n+\n+    protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){", "originalCommit": "be1508beb14c3c9b1c89157f97fd92fa832672db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2MDA1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460960055", "bodyText": "The only reason I had the 2 parameters for this method is for using it in the CanInstallDhsCommandTest. Without the 2 params, I can't test this method for various inputs.", "author": "srinathgit", "createdAt": "2020-07-27T15:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDAwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2NTUwMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460965502", "bodyText": "Ah, that's a good reason. I think the way to go then is keep this method, and add a protected method above it that calls it and that the subclasses use. That eliminates the duplication in the subclasses.", "author": "rjrudin", "createdAt": "2020-07-27T15:14:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDAwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\nindex 7095606f2..d1f6e5249 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n\n@@ -85,19 +86,35 @@ public abstract class AbstractInstallerCommand extends LoggingObject implements\n         }\n     }\n \n+    protected ObjectNode canInstallDhs(){\n+        Versions versions = new Versions(hubConfig);\n+        String installedHubVersion = null;\n+        try{\n+            installedHubVersion = versions.getInstalledVersion();\n+        }\n+        catch (Exception e){\n+            logger.info(\"Data Hub is not installed yet\");\n+        }\n+\n+        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n+        return canInstallDhs(installedHubVersion, mlVersion);\n+    }\n+\n     protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){\n         ObjectMapper mapper = new ObjectMapper();\n         ObjectNode node = mapper.createObjectNode();\n-        if(Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n+        if(installedHubVersion != null && Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n             node.put(\"canBeInstalled\", false);\n             node.put(\"message\", \"DHF cannot be upgraded when the major version of the existing DHF instance is 4\");\n         }\n-        else if(mlVersion.getMajor().equals(9) || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() < 300)){\n-            node.put(\"canBeInstalled\", false);\n-            node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n-        }\n         else {\n-            node.put(\"canBeInstalled\", true);\n+            if(mlVersion.getMajor() > 10 || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() >= 300)){\n+                node.put(\"canBeInstalled\", true);\n+            }\n+            else {\n+                node.put(\"canBeInstalled\", false);\n+                node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n+            }\n         }\n         return node;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNDcwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460834707", "bodyText": "A scenario I forgot in the story is - DHF isn't installed yet. Thus, we should have a try/catch on getInstalledVersion(), so that if we get an exception, we know DHF isn't installed, and thus we don't need to check anything here.", "author": "rjrudin", "createdAt": "2020-07-27T11:50:03Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java", "diffHunk": "@@ -81,4 +84,21 @@ protected String getServerMajorVersion() {\n             return \"9\";\n         }\n     }\n+\n+    protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){\n+        ObjectMapper mapper = new ObjectMapper();\n+        ObjectNode node = mapper.createObjectNode();\n+        if(Character.getNumericValue(installedHubVersion.charAt(0)) < 5){", "originalCommit": "be1508beb14c3c9b1c89157f97fd92fa832672db", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\nindex 7095606f2..d1f6e5249 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n\n@@ -85,19 +86,35 @@ public abstract class AbstractInstallerCommand extends LoggingObject implements\n         }\n     }\n \n+    protected ObjectNode canInstallDhs(){\n+        Versions versions = new Versions(hubConfig);\n+        String installedHubVersion = null;\n+        try{\n+            installedHubVersion = versions.getInstalledVersion();\n+        }\n+        catch (Exception e){\n+            logger.info(\"Data Hub is not installed yet\");\n+        }\n+\n+        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n+        return canInstallDhs(installedHubVersion, mlVersion);\n+    }\n+\n     protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){\n         ObjectMapper mapper = new ObjectMapper();\n         ObjectNode node = mapper.createObjectNode();\n-        if(Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n+        if(installedHubVersion != null && Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n             node.put(\"canBeInstalled\", false);\n             node.put(\"message\", \"DHF cannot be upgraded when the major version of the existing DHF instance is 4\");\n         }\n-        else if(mlVersion.getMajor().equals(9) || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() < 300)){\n-            node.put(\"canBeInstalled\", false);\n-            node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n-        }\n         else {\n-            node.put(\"canBeInstalled\", true);\n+            if(mlVersion.getMajor() > 10 || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() >= 300)){\n+                node.put(\"canBeInstalled\", true);\n+            }\n+            else {\n+                node.put(\"canBeInstalled\", false);\n+                node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n+            }\n         }\n         return node;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNTgwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460835803", "bodyText": "I think a better way of implementing this to future-proof it is to say:\n\nIf major version is higher than 10, then can install\nIf major version is 10, and minor version is 3 or higher, then can install\nElse, cannot install", "author": "rjrudin", "createdAt": "2020-07-27T11:52:23Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java", "diffHunk": "@@ -81,4 +84,21 @@ protected String getServerMajorVersion() {\n             return \"9\";\n         }\n     }\n+\n+    protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){\n+        ObjectMapper mapper = new ObjectMapper();\n+        ObjectNode node = mapper.createObjectNode();\n+        if(Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n+            node.put(\"canBeInstalled\", false);\n+            node.put(\"message\", \"DHF cannot be upgraded when the major version of the existing DHF instance is 4\");\n+        }\n+        else if(mlVersion.getMajor().equals(9) || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() < 300)){", "originalCommit": "be1508beb14c3c9b1c89157f97fd92fa832672db", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\nindex 7095606f2..d1f6e5249 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/AbstractInstallerCommand.java\n\n@@ -85,19 +86,35 @@ public abstract class AbstractInstallerCommand extends LoggingObject implements\n         }\n     }\n \n+    protected ObjectNode canInstallDhs(){\n+        Versions versions = new Versions(hubConfig);\n+        String installedHubVersion = null;\n+        try{\n+            installedHubVersion = versions.getInstalledVersion();\n+        }\n+        catch (Exception e){\n+            logger.info(\"Data Hub is not installed yet\");\n+        }\n+\n+        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n+        return canInstallDhs(installedHubVersion, mlVersion);\n+    }\n+\n     protected ObjectNode canInstallDhs(String installedHubVersion, MarkLogicVersion mlVersion){\n         ObjectMapper mapper = new ObjectMapper();\n         ObjectNode node = mapper.createObjectNode();\n-        if(Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n+        if(installedHubVersion != null && Character.getNumericValue(installedHubVersion.charAt(0)) < 5){\n             node.put(\"canBeInstalled\", false);\n             node.put(\"message\", \"DHF cannot be upgraded when the major version of the existing DHF instance is 4\");\n         }\n-        else if(mlVersion.getMajor().equals(9) || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() < 300)){\n-            node.put(\"canBeInstalled\", false);\n-            node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n-        }\n         else {\n-            node.put(\"canBeInstalled\", true);\n+            if(mlVersion.getMajor() > 10 || (mlVersion.getMajor().equals(10) && mlVersion.getMinor() >= 300)){\n+                node.put(\"canBeInstalled\", true);\n+            }\n+            else {\n+                node.put(\"canBeInstalled\", false);\n+                node.put(\"message\", \"DHF 5.3.0 and higher require MarkLogic 10.0-3 or higher for the use of granular privileges\");\n+            }\n         }\n         return node;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNjE5OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460836199", "bodyText": "I think this message should be \"Unable to install \", as a failure hasn't occurred yet.", "author": "rjrudin", "createdAt": "2020-07-27T11:53:12Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/InstallIntoDhsCommand.java", "diffHunk": "@@ -29,22 +32,34 @@\n     public void run(ApplicationContext context, Options options) {\n         initializeProject(context, options, buildDefaultProjectProperties(options));\n \n-        logger.info(\"Installing DHF version \" + hubConfig.getJarVersion());\n+        Versions versions = new Versions(hubConfig);\n+        String installedHubVersion = versions.getInstalledVersion();\n+        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n \n-        HubAppDeployer deployer = new HubAppDeployer(hubConfig.getManageClient(), hubConfig.getAdminManager(), null, null);\n+        ObjectNode canInstall = canInstallDhs(installedHubVersion, mlVersion);\n+        if(canInstall.get(\"canBeInstalled\").asBoolean()){\n+            logger.info(\"Installing DHF version \" + hubConfig.getJarVersion());\n \n-        String groupName = \"Evaluator\";\n-        modifyHubConfigForDhs(groupName);\n-        deployer.setCommands(buildCommandsForDhs(options));\n-        deployer.deploy(hubConfig.getAppConfig());\n+            HubAppDeployer deployer = new HubAppDeployer(hubConfig.getManageClient(), hubConfig.getAdminManager(), null, null);\n \n-        // Update the servers in the Curator group\n-        groupName = \"Curator\";\n-        modifyHubConfigForDhs(groupName);\n-        DhsDeployServersCommand dhsDeployServersCommand = new DhsDeployServersCommand();\n-        dhsDeployServersCommand.setServerVersion(serverVersion);\n-        deployer.setCommands(Arrays.asList(dhsDeployServersCommand));\n-        deployer.deploy(hubConfig.getAppConfig());\n+            String groupName = \"Evaluator\";\n+            modifyHubConfigForDhs(groupName);\n+            deployer.setCommands(buildCommandsForDhs(options));\n+            deployer.deploy(hubConfig.getAppConfig());\n+\n+            // Update the servers in the Curator group\n+            groupName = \"Curator\";\n+            modifyHubConfigForDhs(groupName);\n+            DhsDeployServersCommand dhsDeployServersCommand = new DhsDeployServersCommand();\n+            dhsDeployServersCommand.setServerVersion(serverVersion);\n+            deployer.setCommands(Arrays.asList(dhsDeployServersCommand));\n+            deployer.deploy(hubConfig.getAppConfig());\n+        }\n+        else {\n+            logger.error(\"Failed to install DHF version \" + hubConfig.getJarVersion());", "originalCommit": "be1508beb14c3c9b1c89157f97fd92fa832672db", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/InstallIntoDhsCommand.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/InstallIntoDhsCommand.java\nindex 24cb143b2..90f05943c 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/InstallIntoDhsCommand.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/InstallIntoDhsCommand.java\n\n@@ -32,11 +30,7 @@ public class InstallIntoDhsCommand extends AbstractInstallerCommand {\n     public void run(ApplicationContext context, Options options) {\n         initializeProject(context, options, buildDefaultProjectProperties(options));\n \n-        Versions versions = new Versions(hubConfig);\n-        String installedHubVersion = versions.getInstalledVersion();\n-        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n-\n-        ObjectNode canInstall = canInstallDhs(installedHubVersion, mlVersion);\n+        ObjectNode canInstall = canInstallDhs();\n         if(canInstall.get(\"canBeInstalled\").asBoolean()){\n             logger.info(\"Installing DHF version \" + hubConfig.getJarVersion());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgzNjkzMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4280#discussion_r460836933", "bodyText": "As a sanity check, I think all of what this method does should be put into a try/catch. And if any exception occurs, when create an ObjectNode with canBeInstalled=false and message = ex.getMessage(), and write that to stdout (which you can do with just node.toString(), I don't think we need to worry about pretty-printing here - or at least, we should write it in a way that avoids the chance of a JsonProcessingException).", "author": "rjrudin", "createdAt": "2020-07-27T11:54:45Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/CanInstallDhsCommand.java", "diffHunk": "@@ -0,0 +1,35 @@\n+package com.marklogic.hub.dhs.installer.command;\n+\n+import com.beust.jcommander.Parameters;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.dhs.installer.Options;\n+import com.marklogic.hub.impl.Versions;\n+import com.marklogic.hub.impl.Versions.MarkLogicVersion;\n+import org.springframework.context.ApplicationContext;\n+\n+@Parameters(commandDescription = \"Verify if current version of DHF can be installed in a DHS environment\")\n+public class CanInstallDhsCommand extends AbstractInstallerCommand {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Override\n+    public void run(ApplicationContext context, Options options) {", "originalCommit": "be1508beb14c3c9b1c89157f97fd92fa832672db", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/CanInstallDhsCommand.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/CanInstallDhsCommand.java\nindex e30dc2b1b..ff4412196 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/CanInstallDhsCommand.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/dhs/installer/command/CanInstallDhsCommand.java\n\n@@ -16,20 +16,19 @@ public class CanInstallDhsCommand extends AbstractInstallerCommand {\n \n     @Override\n     public void run(ApplicationContext context, Options options) {\n-        initializeProject(context, options, new InstallIntoDhsCommand().buildDefaultProjectProperties(options));\n-        Versions versions = new Versions(hubConfig);\n-        String installedHubVersion = versions.getInstalledVersion();\n-        MarkLogicVersion mlVersion = versions.getMLVersion(serverVersion);\n-        ObjectNode node = canInstallDhs(installedHubVersion, mlVersion);\n-\n         try {\n+            initializeProject(context, options, new InstallIntoDhsCommand().buildDefaultProjectProperties(options));\n+            ObjectNode node = canInstallDhs();\n             System.out.println(mapper.writerWithDefaultPrettyPrinter().writeValueAsString(node));\n             if(! node.get(\"canBeInstalled\").booleanValue()){\n                 System.exit(1);\n             }\n \n-        } catch (JsonProcessingException e) {\n-            logger.error(\"Failed to write response\", e);\n+        } catch (Exception e) {\n+            ObjectNode node = mapper.createObjectNode();\n+            node.put(\"canBeInstalled\", false);\n+            node.put(\"message\", e.getMessage());\n+            System.out.println(node.toString());\n         }\n     }\n }\n"}}, {"oid": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8491a6aec6905a32599b1ec49b9bf225c17dcace", "message": "DHFPROD-5460:Determine if DHF installer can be run against existing DHS instance", "committedDate": "2020-07-27T22:44:38Z", "type": "commit"}, {"oid": "8491a6aec6905a32599b1ec49b9bf225c17dcace", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8491a6aec6905a32599b1ec49b9bf225c17dcace", "message": "DHFPROD-5460:Determine if DHF installer can be run against existing DHS instance", "committedDate": "2020-07-27T22:44:38Z", "type": "forcePushed"}]}