{"pr_number": 4416, "pr_title": "DHFPROD-5746: Migrating flows should be repeatable", "pr_createdAt": "2020-08-17T13:58:49Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4416", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwNjIxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471506212", "bodyText": "While I'd normally say it's good to add methods like this to Step, I want to get away from classes like Step, which are incomplete representations of JSON objects. For the purpose of FlowMigrator, just check the original ObjectNode to see if it only has one key, and if the name of that key is stepId.", "author": "rjrudin", "createdAt": "2020-08-17T14:11:42Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,10 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                if (step.getIsOnlyStepId()) {", "originalCommit": "73e8c6ec9278a4339e978a6f5c77c1b277882236", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NjI2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471546269", "bodyText": "There was no way to get to the JSON after getLocalFlow() executed, so I had to save a reference to the JsonNode in Step. (and hid it from serialization with an attribute)", "author": "fsnow", "createdAt": "2020-08-17T15:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwNjIxMg=="}], "type": "inlineReview", "revised_code": {"commit": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\nindex bf554d39b..83959499d 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\n\n@@ -149,7 +149,7 @@ public class FlowMigrator extends LoggingObject {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n-                if (step.getIsOnlyStepId()) {\n+                if (step.getStepId() != null) {\n                     newSteps.set(entry.getKey(), nodeFactory.objectNode().put(\"stepId\", step.getStepId()));\n                     continue;\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NDQ1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471574451", "bodyText": "Argh, sorry, I didn't realize the ObjectNode wasn't available. I think it's fine then to add stepId to the Step class. FlowMigrator can just say - if stepId is populated, then I don't need to migrate it. Then you don't need the stepJson JsonNode in Step.", "author": "rjrudin", "createdAt": "2020-08-17T15:52:21Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,11 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                JsonNode stepJson = step.getStepJson();\n+                if (stepJson.has(\"stepId\") && stepJson.size() == 1) {", "originalCommit": "b19a5419ee8be30bc07a72c933340d04aa5ec285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NTE1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471585157", "bodyText": "ok, I modified it to test for stepId not null.", "author": "fsnow", "createdAt": "2020-08-17T16:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NDQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\nindex 97e7d6ebf..83959499d 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java\n\n@@ -149,9 +149,8 @@ public class FlowMigrator extends LoggingObject {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n-                JsonNode stepJson = step.getStepJson();\n-                if (stepJson.has(\"stepId\") && stepJson.size() == 1) {\n-                    newSteps.set(entry.getKey(), nodeFactory.objectNode().put(\"stepId\", stepJson.get(\"stepId\").asText()));\n+                if (step.getStepId() != null) {\n+                    newSteps.set(entry.getKey(), nodeFactory.objectNode().put(\"stepId\", step.getStepId()));\n                     continue;\n                 }\n                 String stepId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTU0NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471629544", "bodyText": "The flow document is migrated and hence steps will already have  \"stepId\" . So, do we have to set \"stepId\" again in the flow ?", "author": "srinathgit", "createdAt": "2020-08-17T17:14:26Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/FlowMigrator.java", "diffHunk": "@@ -149,6 +149,10 @@ public void migrateFlows() {\n             ObjectNode newSteps = nodeFactory.objectNode();\n             for (Map.Entry<String, Step> entry : steps.entrySet()) {\n                 Step step = entry.getValue();\n+                if (step.getStepId() != null) {\n+                    newSteps.set(entry.getKey(), nodeFactory.objectNode().put(\"stepId\", step.getStepId()));", "originalCommit": "53762be987e768df3b1d88d16b24c1a6f83592b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYzNDQzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471634435", "bodyText": "I believe so, since \"newSteps\" is assigned to the flow.", "author": "rjrudin", "createdAt": "2020-08-17T17:18:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0MDYyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471640624", "bodyText": "But since the flow is already migrated, shouldn't it already have 'stepId' rather than inline steps ? so, we don't have to set 'stepId's in flow again right ?", "author": "srinathgit", "createdAt": "2020-08-17T17:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY1MTQzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4416#discussion_r471651434", "bodyText": "Yes, because it is building a new flow. You have to transfer the minimal {\"1\": \"stepId\"} to the new flow.", "author": "fsnow", "createdAt": "2020-08-17T17:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyOTU0NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/bc1e08e2548023e07bf2a34af65d6e1b9b3bba1c", "message": "DHFPROD-5746: Migrating flows should be repeatable\n\n\n\n\nmore", "committedDate": "2020-08-17T19:56:52Z", "type": "commit"}]}