{"pr_number": 4025, "pr_title": "DHFPROD-4967: Grant role to allow users to save queries", "pr_createdAt": "2020-05-29T20:18:57Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4025", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc0NDkwOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r432744909", "bodyText": "It's fine to do this, but I think soon, we should remove all of these assertions. If the roles/privileges weren't correctly written out, that \"bootstrap\" would fail and none of the tests would run. So these assertions are redundant and not adding any value. Fine to keep them for now, I'll look into removing all of them soon.", "author": "rjrudin", "createdAt": "2020-05-29T21:31:58Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java", "diffHunk": "@@ -92,8 +92,8 @@ public void testInit() throws IOException {\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-step-definition-writer.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-reader.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-writer.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-reader.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-saved-query-writer.json\").exists());\n+        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-saved-query-reader.json\").exists());", "originalCommit": "7e0c4648e4a3e659d731f52317375e3b0d74d2ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java\nindex 974339c4d..d261e684a 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/core/HubProjectTest.java\n\n@@ -92,8 +92,6 @@ public class HubProjectTest extends HubTestBase {\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-step-definition-writer.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-reader.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/data-hub-entity-model-writer.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-saved-query-reader.json\").exists());\n-        assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-saved-query-writer.json\").exists());\n         assertTrue(new File(projectPath, \"src/main/hub-internal-config/security/roles/hub-central-entity-exporter.json\").exists());\n \n \n"}}, {"oid": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "message": "DHFPROD-4967: Adding hub-central roles for saved query documents\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Running tests using hub-central-saved-query-writer", "committedDate": "2020-05-31T01:29:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNDE1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433234152", "bodyText": "No need to change, but you can do this in one method - loginAsTestUserWithRoles.", "author": "rjrudin", "createdAt": "2020-06-01T13:30:04Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -45,6 +45,9 @@ void testCRUDOnSavedQuery() throws Exception {\n             \"  }\\n\" +\n             \"}\";\n \n+        setTestUserRoles(\"hub-central-saved-query-writer\", \"hub-central-saved-query-reader\");\n+        loginAsTestUser();", "originalCommit": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\nindex 9e85883da..992259e9e 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n\n@@ -45,10 +46,8 @@ public class EntitySearchControllerTest extends AbstractMvcTest {\n             \"  }\\n\" +\n             \"}\";\n \n-        setTestUserRoles(\"hub-central-saved-query-writer\", \"hub-central-saved-query-reader\");\n-        loginAsTestUser();\n-\n         // testing save query document\n+        loginAsTestUserWithRoles(\"hub-central-saved-query-user\");\n         postJson(SAVED_QUERIES_PATH, json)\n             .andExpect(status().isCreated())\n             .andDo(result -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIzNTg2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4025#discussion_r433235865", "bodyText": "There's a helper method in AbstractMvcTest to make this a little easier, and it guarantees that the user's authenticated HttpSession is used - verifyRequestIsForbidden. Please use this instead.", "author": "rjrudin", "createdAt": "2020-06-01T13:33:18Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -94,6 +97,14 @@ void testCRUDOnSavedQuery() throws Exception {\n                 ObjectNode response = readJsonObject(result.getResponse().getContentAsString());\n                 assertTrue(response.isEmpty());\n             });\n+\n+        // Try save/update/delete without the required role \"hub-central-saved-query-writer\"\n+        setTestUserRoles(\"hub-central-saved-query-reader\");\n+        loginAsTestUser();\n+\n+        postJson(SAVED_QUERIES_PATH, json).andExpect(status().isForbidden());", "originalCommit": "e8f21701a512cffb6e79edad571dd8a5c27ba9aa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\nindex 9e85883da..992259e9e 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n\n@@ -98,13 +97,11 @@ public class EntitySearchControllerTest extends AbstractMvcTest {\n                 assertTrue(response.isEmpty());\n             });\n \n-        // Try save/update/delete without the required role \"hub-central-saved-query-writer\"\n-        setTestUserRoles(\"hub-central-saved-query-reader\");\n-        loginAsTestUser();\n-\n-        postJson(SAVED_QUERIES_PATH, json).andExpect(status().isForbidden());\n-        putJson(SAVED_QUERIES_PATH, savedQueryResponse.toString()).andExpect(status().isForbidden());\n-        delete(SAVED_QUERIES_PATH + \"/query\", params).andExpect(status().isForbidden());\n+        // Try saving queries without the required role \"hub-central-saved-query-user\"\n+        loginAsTestUserWithRoles(\"hub-central-user\");\n+        verifyRequestIsForbidden(buildJsonPost(SAVED_QUERIES_PATH, json));\n+        verifyRequestIsForbidden(buildJsonPut(SAVED_QUERIES_PATH, savedQueryResponse.toString()));\n+        verifyRequestIsForbidden(MockMvcRequestBuilders.delete(SAVED_QUERIES_PATH+ \"/query\").param(\"id\", \"some-id\"));\n     }\n \n \n"}}, {"oid": "b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b4fcc66f77b23a489a7fd1a5d8c89205ada6bf90", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes", "committedDate": "2020-06-02T17:55:37Z", "type": "forcePushed"}, {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role", "committedDate": "2020-06-02T20:08:45Z", "type": "commit"}, {"oid": "84eb181494d44b24f077eb8f7206bad9a4d046aa", "url": "https://github.com/marklogic/marklogic-data-hub/commit/84eb181494d44b24f077eb8f7206bad9a4d046aa", "message": "DHFPROD-4967: Grant role to allow users to save queries backend changes\n\nDHFPROD-4967: UI Changes\n\nDHFPROD-4967: Removing data-hub-common-writer role and adding required privileges to data-hub-saved-query-user role", "committedDate": "2020-06-02T20:08:45Z", "type": "forcePushed"}]}