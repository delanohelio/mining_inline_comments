{"pr_number": 3674, "pr_title": "DHFPROD-3922: Enable step running in Bench/Flows view", "pr_createdAt": "2020-03-09T22:32:47Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3674", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxOTY2Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390019666", "bodyText": "Should this be in a test file? Is this a stub for testing. Maybe some comments will help make it clear", "author": "bsrikan", "createdAt": "2020-03-09T23:40:32Z", "path": "one-ui/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java", "diffHunk": "@@ -163,13 +188,49 @@ void getFlow() throws IOException {\n             //DELETE flow\n             controller.deleteFlow(\"testFlow\");\n             try{\n-                controller.getFlow(\"testFlow\");\n-                Assertions.fail();\n+                Flow flow = (Flow) controller.getFlow(\"testFlow\").getBody();\n+                Assertions.assertNull(flow, \"Flow shouldn't exist anymore\");\n             }\n             catch (Exception e) {\n                 logger.info(\"Exception is expected as the flow being fetched has been deleted\");\n             }\n             loadDataController.deleteArtifact(\"validArtifact\");\n         }\n     }\n+\n+    @Test\n+    void runFlow() throws IOException {\n+        ObjectMapper mapper = new ObjectMapper();\n+        String hubProjectDir = hubConfig.getProjectDir();\n+        FileUtils.copyDirectory(testHelper.getResourceFile(\"input\"), Paths.get(hubProjectDir,\"input\").toFile());\n+        controller.createFlow(flowString);\n+        //PUT step\n+        controller.createStep(\"testFlow\", 1, stepString).getBody();\n+        //link artifact to step options\n+        loadDataController.updateArtifact(\"validArtifact\", validLoadDataConfig);\n+        controller.linkArtifact(\"testFlow\", \"e2e-json-ingestion\", \"loadData\", \"validArtifact\");\n+\n+        RunFlowResponse resp = (RunFlowResponse) controller.runFlow(\"testFlow\", Collections.singletonList(\"e2e-json-ingestion\"));\n+\n+        Assertions.assertEquals(\"testFlow\", resp.getFlowName(), \"Run flow response has correct flow name\");\n+        controller.getLastFlowRunner().awaitCompletion();\n+        JsonNode jobsDoc = jobsController.getJob(resp.getJobId());\n+        String jobStatus = jobsDoc.get(\"jobStatus\").asText();\n+        Assertions.assertEquals(\"finished\", jobStatus, \"Job status should be 'finished' once threads complete\");\n+    }\n+\n+    @Controller\n+    @RequestMapping(\"/api/test/flows\")\n+    static class FlowTestController extends FlowController {", "originalCommit": "e9e9ba83361a4235a03c1b7fb49bde8e661bada0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdecceac6369e9f29069dbceb6b084e115a1f1e6", "chunk": "diff --git a/one-ui/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java b/one-ui/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java\nindex c406ad23b..fe916222d 100644\n--- a/one-ui/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java\n+++ b/one-ui/src/test/java/com/marklogic/hub/curation/controllers/FlowControllerTest.java\n\n@@ -188,8 +172,8 @@ class FlowControllerTest {\n             //DELETE flow\n             controller.deleteFlow(\"testFlow\");\n             try{\n-                Flow flow = (Flow) controller.getFlow(\"testFlow\").getBody();\n-                Assertions.assertNull(flow, \"Flow shouldn't exist anymore\");\n+                controller.getFlow(\"testFlow\");\n+                Assertions.fail();\n             }\n             catch (Exception e) {\n                 logger.info(\"Exception is expected as the flow being fetched has been deleted\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMTAzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390021039", "bodyText": "Do we have tests for this controller?", "author": "bsrikan", "createdAt": "2020-03-09T23:45:36Z", "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/JobsController.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2012-2019 MarkLogic Corporation\n+ *\n+ *  Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *  you may not use this file except in compliance with the License.\n+ *  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+package com.marklogic.hub.curation.controllers;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.marklogic.hub.FlowManager;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.job.JobDocManager;\n+import com.marklogic.hub.oneui.managers.SearchableManager;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.http.MediaType;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.stereotype.Controller;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestMethod;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.ResponseBody;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+@Controller\n+@RequestMapping(value=\"/api/jobs\")", "originalCommit": "e9e9ba83361a4235a03c1b7fb49bde8e661bada0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyNDE3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390224177", "bodyText": "I don't think tests are needed when the controller method is just passing data through, but once we have any logic - like in getJobs and flattenJobsJson - tests are worthwhile.", "author": "rjrudin", "createdAt": "2020-03-10T10:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMTAzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "bdecceac6369e9f29069dbceb6b084e115a1f1e6", "chunk": "diff --git a/one-ui/src/main/java/com/marklogic/hub/curation/controllers/JobsController.java b/one-ui/src/main/java/com/marklogic/hub/curation/controllers/JobsController.java\ndeleted file mode 100644\nindex 7907d91f4..000000000\n--- a/one-ui/src/main/java/com/marklogic/hub/curation/controllers/JobsController.java\n+++ /dev/null\n\n@@ -1,110 +0,0 @@\n-/*\n- * Copyright 2012-2019 MarkLogic Corporation\n- *\n- *  Licensed under the Apache License, Version 2.0 (the \"License\");\n- *  you may not use this file except in compliance with the License.\n- *  You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- *  Unless required by applicable law or agreed to in writing, software\n- *  distributed under the License is distributed on an \"AS IS\" BASIS,\n- *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- *  See the License for the specific language governing permissions and\n- *  limitations under the License.\n- *\n- */\n-package com.marklogic.hub.curation.controllers;\n-\n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n-import com.fasterxml.jackson.databind.node.ArrayNode;\n-import com.marklogic.hub.FlowManager;\n-import com.marklogic.hub.impl.FlowManagerImpl;\n-import com.marklogic.hub.job.JobDocManager;\n-import com.marklogic.hub.oneui.managers.SearchableManager;\n-import com.marklogic.hub.oneui.models.HubConfigSession;\n-import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.http.HttpStatus;\n-import org.springframework.http.MediaType;\n-import org.springframework.http.ResponseEntity;\n-import org.springframework.stereotype.Controller;\n-import org.springframework.web.bind.annotation.PathVariable;\n-import org.springframework.web.bind.annotation.RequestMapping;\n-import org.springframework.web.bind.annotation.RequestMethod;\n-import org.springframework.web.bind.annotation.RequestParam;\n-import org.springframework.web.bind.annotation.ResponseBody;\n-\n-import java.util.Collections;\n-import java.util.List;\n-\n-@Controller\n-@RequestMapping(value=\"/api/jobs\")\n-public class JobsController extends SearchableManager {\n-    @Autowired\n-    private HubConfigSession hubConfig;\n-\n-\n-    @RequestMapping(method = RequestMethod.GET)\n-    @ResponseBody\n-    public ResponseEntity<?> getJobs(@RequestParam(value = \"flowName\", required = false) String flowName) {\n-        JobDocManager jobDocManager = getJobDocManager();\n-        ArrayNode jobsArray;\n-        if (flowName == null) {\n-            FlowManager flowManager = new FlowManagerImpl(hubConfig);\n-            List<String> flowNames = flowManager.getFlowNames();\n-            jobsArray = new ObjectMapper().createArrayNode();\n-            flowNames.forEach((name) -> {\n-                    jobsArray.addAll((ArrayNode) getJobs(jobDocManager, null, name));\n-            });\n-        } else {\n-            jobsArray = (ArrayNode) getJobs(jobDocManager, null, flowName);\n-        }\n-        return new ResponseEntity<>(flattenJobsJson(jobsArray), HttpStatus.OK);\n-    }\n-\n-    @RequestMapping(value = \"/{jobId}\", method = RequestMethod.GET)\n-    @ResponseBody\n-    public JsonNode getJob(@PathVariable String jobId) {\n-        JsonNode jobsObj = getJobs(getJobDocManager(), jobId, null);\n-        return flattenJobsJson(jobsObj);\n-    }\n-\n-    @RequestMapping(value = \"latest/{flowName}\", method = RequestMethod.GET, produces = {MediaType.APPLICATION_JSON_VALUE})\n-    @ResponseBody\n-    public JsonNode getLatestJobDocForFlow(@PathVariable String flowName) {\n-        return flattenJobsJson(getJobDocManager().getLatestJobDocumentForFlow(flowName));\n-    }\n-\n-    @RequestMapping(value = \"latest\", method = RequestMethod.GET, produces = {MediaType.APPLICATION_JSON_VALUE})\n-    @ResponseBody\n-    public JsonNode getLatestJobDocsPerFlow() {\n-        return flattenJobsJson(getJobDocManager().getLatestJobDocumentForFlows(Collections.emptyList()));\n-    }\n-\n-    private JsonNode getJobs(JobDocManager jobDocManager, String jobId, String flowName) {\n-        JsonNode jobsJson = jobDocManager.getJobDocument(jobId, flowName);\n-        if (jobsJson == null) {\n-            throw new RuntimeException(\"Unable to get job document\");\n-        }\n-        return flattenJobsJson(jobsJson);\n-    }\n-\n-    private JobDocManager getJobDocManager() {\n-        return new JobDocManager(hubConfig.newJobDbClient());\n-    }\n-\n-    private JsonNode flattenJobsJson(JsonNode jobJSON) {\n-        if (jobJSON.isArray()) {\n-            ArrayNode array = new ObjectMapper().createArrayNode();\n-            jobJSON.elements().forEachRemaining((json) -> {\n-                array.add(flattenJobsJson(json));\n-            });\n-            return array;\n-        } else if (jobJSON.has(\"job\")) {\n-            return jobJSON.get(\"job\");\n-        } else {\n-            return jobJSON;\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMTc3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390021773", "bodyText": "Do we have tests for these methods?", "author": "bsrikan", "createdAt": "2020-03-09T23:48:06Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/job/JobDocManager.java", "diffHunk": "@@ -99,6 +100,20 @@ public JsonNode getJobDocumentsForFlows(List<String> flowNames) {\n         return getJobDocuments(params);\n     }\n \n+    public JsonNode getLatestJobDocumentForFlow(String flowName) {\n+        RequestParameters params = new RequestParameters();", "originalCommit": "e9e9ba83361a4235a03c1b7fb49bde8e661bada0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIyMjc1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390222759", "bodyText": "Agree - only the controllers are invoking these methods, and there aren't any tests for these methods or for the controller methods (we don't need the latter, do need the former).\nWe just had a bug opened up in github for an issue with job counts. I think there's a significant lack of automated tests for everything that is written to the jobs database, which is why we have those bugs pop up.", "author": "rjrudin", "createdAt": "2020-03-10T10:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMTc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "bdecceac6369e9f29069dbceb6b084e115a1f1e6", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/job/JobDocManager.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/job/JobDocManager.java\nindex 026d31cff..76ad2a770 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/job/JobDocManager.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/job/JobDocManager.java\n\n@@ -100,20 +99,6 @@ public class JobDocManager extends ResourceManager {\n         return getJobDocuments(params);\n     }\n \n-    public JsonNode getLatestJobDocumentForFlow(String flowName) {\n-        RequestParameters params = new RequestParameters();\n-        params.add(\"flow-name\", flowName);\n-        params.put(\"latest\", \"true\");\n-        return getJobDocuments(params);\n-    }\n-\n-    public JsonNode getLatestJobDocumentForFlows(List<String> flowNames) {\n-        RequestParameters params = new RequestParameters();\n-        params.put(\"flowNames\", flowNames.toArray(new String[]{}));\n-        params.put(\"latest\", \"true\");\n-        return getJobDocuments(params);\n-    }\n-\n     /**\n      * Per DHFPROD-2842, the jobs endpoint no longer throws an error when no job documents are found. This was both\n      * causing a stacktrace to be dumped to the jobs app server log - suggesting an error when there really wasn't one -\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMjI0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3674#discussion_r390022248", "bodyText": "Do we have a test in place for all these *Runner to verify flowName in the job doc.", "author": "bsrikan", "createdAt": "2020-03-09T23:49:38Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -654,7 +654,7 @@ private RunStepResponse runIngester(RunStepResponse runStepResponse, Collection<\n             }\n             JsonNode jobDoc = null;\n             try {\n-                jobDoc = jobDocManager.postJobs(jobId, stepStatus, step, stepStatus.equalsIgnoreCase(JobStatus.COMPLETED_PREFIX + step) ? step : null, runStepResponse);\n+                jobDoc = jobDocManager.postJobs(jobId, stepStatus, flow.getName(), step, stepStatus.equalsIgnoreCase(JobStatus.COMPLETED_PREFIX + step) ? step : null, runStepResponse);\n             }", "originalCommit": "e9e9ba83361a4235a03c1b7fb49bde8e661bada0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bdecceac6369e9f29069dbceb6b084e115a1f1e6", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\nindex 4ffb79f6d..b6714b56b 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n\n@@ -654,7 +654,7 @@ public class WriteStepRunner implements StepRunner {\n             }\n             JsonNode jobDoc = null;\n             try {\n-                jobDoc = jobDocManager.postJobs(jobId, stepStatus, flow.getName(), step, stepStatus.equalsIgnoreCase(JobStatus.COMPLETED_PREFIX + step) ? step : null, runStepResponse);\n+                jobDoc = jobDocManager.postJobs(jobId, stepStatus, step, stepStatus.equalsIgnoreCase(JobStatus.COMPLETED_PREFIX + step) ? step : null, runStepResponse);\n             }\n             catch (Exception e) {\n                 logger.error(\"Unable to update job document, cause: \" + e.getMessage());\n"}}, {"oid": "bdecceac6369e9f29069dbceb6b084e115a1f1e6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/bdecceac6369e9f29069dbceb6b084e115a1f1e6", "message": "DHFPROD-3922: Move in flow run logic (#3578)", "committedDate": "2020-03-12T22:31:22Z", "type": "commit"}, {"oid": "723e7de281661c1aa8d6d496ab27ca831826394a", "url": "https://github.com/marklogic/marklogic-data-hub/commit/723e7de281661c1aa8d6d496ab27ca831826394a", "message": "DHFPROD-3922: Add Jobs APIs to One UI", "committedDate": "2020-03-12T22:34:55Z", "type": "commit"}, {"oid": "5f82e135d8eef8b0ddc80e77fd574998bf7dd374", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5f82e135d8eef8b0ddc80e77fd574998bf7dd374", "message": "DHFPROD-4544: Make FlowRunner compatible with session based HubConfig", "committedDate": "2020-03-12T22:34:55Z", "type": "commit"}, {"oid": "846606ecf3358a2fb66602c30caeb06e355cb803", "url": "https://github.com/marklogic/marklogic-data-hub/commit/846606ecf3358a2fb66602c30caeb06e355cb803", "message": "DHFPROD-3922: Enable step running in Bench/Flows view\n\nIncludes confirmation dialogs and status spinner.", "committedDate": "2020-03-12T22:34:55Z", "type": "commit"}, {"oid": "e0e58b4f500162442e4f8a27eac901bb7eed2a58", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0e58b4f500162442e4f8a27eac901bb7eed2a58", "message": "DHFPROD-3922: Ensure OneUI Flow Run changes don't break legacy code", "committedDate": "2020-03-12T22:34:56Z", "type": "commit"}, {"oid": "c12de9af1c33d7cf963fd3a2c29dc21873c77a36", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c12de9af1c33d7cf963fd3a2c29dc21873c77a36", "message": "DHFPROD-3922: Fix CSV run and logic for recording jobs (#3684)\n\n* DHFPROD-3922: Fix CSV run and logic for recording jobs\r\n\r\n* DHFPROD-3922: Fix jobs logic and add tests", "committedDate": "2020-03-12T22:36:41Z", "type": "commit"}, {"oid": "1cfaac8c67a62335cc1145735b3f8c53991b98e1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1cfaac8c67a62335cc1145735b3f8c53991b98e1", "message": "DHFPROD-3922: Fix ingest test using tab delimiter", "committedDate": "2020-03-12T22:36:42Z", "type": "commit"}, {"oid": "fbb8bb693c094b4bca0b6b99bd82fbc051034772", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fbb8bb693c094b4bca0b6b99bd82fbc051034772", "message": "DHFPROD-3922: Make ML Unit Test for mappings more resilient", "committedDate": "2020-03-12T22:38:08Z", "type": "commit"}, {"oid": "fbb8bb693c094b4bca0b6b99bd82fbc051034772", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fbb8bb693c094b4bca0b6b99bd82fbc051034772", "message": "DHFPROD-3922: Make ML Unit Test for mappings more resilient", "committedDate": "2020-03-12T22:38:08Z", "type": "forcePushed"}]}