{"pr_number": 4103, "pr_title": "DHFPROD-5139: User with hub-central-entity-exporter role can't export data", "pr_createdAt": "2020-06-16T17:34:16Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4103", "timeline": [{"oid": "5d72e2e6ea6300769e1982a42076f71fd215d80d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d72e2e6ea6300769e1982a42076f71fd215d80d", "message": "DHFPROD-5139: Allow hub-central-entity-exporter to export to CSV\n\nAlso correctly renamed a file in reference-entity-model", "committedDate": "2020-06-16T20:00:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyODAxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4103#discussion_r441128019", "bodyText": "Instead of adding an extra call to export, we can modify the existing tests to remove \"data-hub-operator\" and \"hub-central-saved-query-user\" roles for the first test where we export using query document.\nNext, we can add \"hub-central-saved-query-user\" for login when we test export using queryId which would require for a query to be saved.", "author": "akshaysonvane", "createdAt": "2020-06-16T20:39:01Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java", "diffHunk": "@@ -214,6 +214,22 @@ void testRowExport() throws Exception {\n                 assertRowsAndColumns(newLimit, totalColumns, response);\n                 assertTrue(actualRowSet.contains(getHashCode(customer1Info)) || actualRowSet.contains(getHashCode(customer2Info)));\n             });\n+\n+        // Log in as user with role \"hub-central-entity-exporter\" who is not a \"data-hub-operator\"\n+        loginAsTestUserWithRoles(\"hub-central-entity-exporter\");\n+\n+        // Export using query document\n+        postWithParams(EXPORT_PATH, getRequestParams(limit, json))\n+            .andExpect(request().asyncStarted())\n+            .andDo(MvcResult::getAsyncResult)\n+            .andExpect(status().isOk())\n+            .andDo(result -> {\n+                String response = result.getResponse().getContentAsString();\n+                Set<Integer> actualRowSet = calculateHash(response);\n+                assertRowsAndColumns(limit, totalColumns, response);\n+                assertTrue(actualRowSet.contains(getHashCode(customer1Info)));\n+                assertTrue(actualRowSet.contains(getHashCode(customer2Info)));\n+            });", "originalCommit": "5d72e2e6ea6300769e1982a42076f71fd215d80d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e47c155882f8aba04a417ee054fb04a0731d2c7c", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\nindex 792508d77..3616f44bf 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/EntitySearchControllerTest.java\n\n@@ -214,22 +218,6 @@ public class EntitySearchControllerTest extends AbstractMvcTest {\n                 assertRowsAndColumns(newLimit, totalColumns, response);\n                 assertTrue(actualRowSet.contains(getHashCode(customer1Info)) || actualRowSet.contains(getHashCode(customer2Info)));\n             });\n-\n-        // Log in as user with role \"hub-central-entity-exporter\" who is not a \"data-hub-operator\"\n-        loginAsTestUserWithRoles(\"hub-central-entity-exporter\");\n-\n-        // Export using query document\n-        postWithParams(EXPORT_PATH, getRequestParams(limit, json))\n-            .andExpect(request().asyncStarted())\n-            .andDo(MvcResult::getAsyncResult)\n-            .andExpect(status().isOk())\n-            .andDo(result -> {\n-                String response = result.getResponse().getContentAsString();\n-                Set<Integer> actualRowSet = calculateHash(response);\n-                assertRowsAndColumns(limit, totalColumns, response);\n-                assertTrue(actualRowSet.contains(getHashCode(customer1Info)));\n-                assertTrue(actualRowSet.contains(getHashCode(customer2Info)));\n-            });\n     }\n \n     private void assertRowsAndColumns(int limit, int totalColumns, String response) {\n"}}, {"oid": "e47c155882f8aba04a417ee054fb04a0731d2c7c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e47c155882f8aba04a417ee054fb04a0731d2c7c", "message": "DHFPROD-5139: Allow hub-central-entity-exporter to export to CSV\n\nAlso correctly renamed a file in reference-entity-model", "committedDate": "2020-06-16T21:23:20Z", "type": "commit"}, {"oid": "e47c155882f8aba04a417ee054fb04a0731d2c7c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e47c155882f8aba04a417ee054fb04a0731d2c7c", "message": "DHFPROD-5139: Allow hub-central-entity-exporter to export to CSV\n\nAlso correctly renamed a file in reference-entity-model", "committedDate": "2020-06-16T21:23:20Z", "type": "forcePushed"}]}