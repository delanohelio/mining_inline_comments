{"pr_number": 3984, "pr_title": "DHFPROD-4671: Add hub-central-load-reader role", "pr_createdAt": "2020-05-21T20:54:27Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3984", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4OTY3Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428989676", "bodyText": "No need to change, but just for future reference, you can do loginAsTestUserWithRoles(\"hub-central-load-reader\")", "author": "rjrudin", "createdAt": "2020-05-22T00:53:59Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\nindex 8c9176299..196340efb 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n\n@@ -59,13 +56,9 @@ public class IngestionStepControllerTest extends AbstractStepControllerTest {\n         installReferenceModelProject();\n         postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n \n-        setTestUserRoles(\"hub-central-load-reader\");\n-\n-        loginAsTestUser();\n+        loginAsTestUserWithRoles(\"hub-central-load-reader\");\n \n-        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")\n-                .contentType(MediaType.APPLICATION_JSON)\n-                .session(mockHttpSession))\n+        getJson(PATH + \"/firstStep\")\n                 .andDo(result -> {\n                     MockHttpServletResponse response = result.getResponse();\n                     assertEquals(HttpStatus.OK.value(), response.getStatus());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjEwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992107", "bodyText": "I think you can just do getJson here?", "author": "rjrudin", "createdAt": "2020-05-22T01:04:08Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();\n+\n+        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\nindex 8c9176299..196340efb 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n\n@@ -59,13 +56,9 @@ public class IngestionStepControllerTest extends AbstractStepControllerTest {\n         installReferenceModelProject();\n         postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n \n-        setTestUserRoles(\"hub-central-load-reader\");\n-\n-        loginAsTestUser();\n+        loginAsTestUserWithRoles(\"hub-central-load-reader\");\n \n-        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")\n-                .contentType(MediaType.APPLICATION_JSON)\n-                .session(mockHttpSession))\n+        getJson(PATH + \"/firstStep\")\n                 .andDo(result -> {\n                     MockHttpServletResponse response = result.getResponse();\n                     assertEquals(HttpStatus.OK.value(), response.getStatus());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjY1Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992652", "bodyText": "Just an FYI, there's a verifyRequestIsForbidden helper method coming in the 4820 PR. I'll see if I can get that merged into develop tomorrow so you can use it.", "author": "rjrudin", "createdAt": "2020-05-22T01:06:33Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java", "diffHunk": "@@ -46,4 +53,39 @@ void getIngestionSteps() throws Exception {\n                 assertEquals(\"secondStep\", array.get(1).get(\"name\").asText());\n             });\n     }\n+\n+    @Test\n+    void permittedReadUser() throws Exception {\n+        installReferenceModelProject();\n+        postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n+\n+        setTestUserRoles(\"hub-central-load-reader\");\n+\n+        loginAsTestUser();\n+\n+        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")\n+                .contentType(MediaType.APPLICATION_JSON)\n+                .session(mockHttpSession))\n+                .andDo(result -> {\n+                    MockHttpServletResponse response = result.getResponse();\n+                    assertEquals(HttpStatus.OK.value(), response.getStatus());\n+                });\n+    }\n+\n+    @Test\n+    void forbiddenReadUser() throws Exception {", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "chunk": "diff --git a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\nindex 8c9176299..196340efb 100644\n--- a/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n+++ b/marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/controllers/steps/IngestionStepControllerTest.java\n\n@@ -59,13 +56,9 @@ public class IngestionStepControllerTest extends AbstractStepControllerTest {\n         installReferenceModelProject();\n         postJson(PATH + \"/firstStep\", newDefaultIngestionStep(\"firstStep\"));\n \n-        setTestUserRoles(\"hub-central-load-reader\");\n-\n-        loginAsTestUser();\n+        loginAsTestUserWithRoles(\"hub-central-load-reader\");\n \n-        mockMvc.perform(get(PATH + \"/{stepName}\", \"firstStep\")\n-                .contentType(MediaType.APPLICATION_JSON)\n-                .session(mockHttpSession))\n+        getJson(PATH + \"/firstStep\")\n                 .andDo(result -> {\n                     MockHttpServletResponse response = result.getResponse();\n                     assertEquals(HttpStatus.OK.value(), response.getStatus());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk5MjgzMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3984#discussion_r428992831", "bodyText": "The 4820 PR will also do this automatically for you.", "author": "rjrudin", "createdAt": "2020-05-22T01:07:23Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java", "diffHunk": "@@ -369,15 +367,16 @@ public Path getCustomMappingFunctionsDir() {\n         writeRoleFile(rolesDir, \"data-hub-common.json\");\n         writeRoleFile(rolesDir, \"data-hub-common-writer.json\");\n         writeRoleFile(rolesDir, \"data-hub-security-internal.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-data-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-data-writer.json\");\n+        writeRoleFile(rolesDir, \"data-hub-load-reader.json\");", "originalCommit": "b3c8ddbd97a125c9dd41ba3761a387e32c7892bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\nindex f8716c3ae..71b16ac40 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\n\n@@ -324,107 +325,22 @@ public class HubProjectImpl implements HubProject {\n         Path userDatabaseFieldsDir = getUserConfigDir().resolve(\"database-fields\");\n         userDatabaseFieldsDir.toFile().mkdirs();\n         writeResourceFile(\"ml-config/database-fields/final-database.xml\", userDatabaseFieldsDir.resolve(\"final-database.xml\"), overwriteUserConfigFiles);\n-        // the following config has to do with ordering of initialization.\n-        // users and roles must be present to install the hub.\n-        // amps cannot be installed until after staging modules db exists.\n-        Path hubSecurityDir = getHubSecurityDir();\n-        Path userSecurityDir = getUserSecurityDir();\n-        Path rolesDir = hubSecurityDir.resolve(\"roles\");\n-        Path usersDir = hubSecurityDir.resolve(\"users\");\n-        Path ampsDir = hubSecurityDir.resolve(\"amps\");\n-        Path privilegesDir = hubSecurityDir.resolve(\"privileges\");\n-\n-        Path userRolesDir = userSecurityDir.resolve(\"roles\");\n-        Path userUsersDir = userSecurityDir.resolve(\"users\");\n-        Path userPrivilegesDir = userSecurityDir.resolve(\"privileges\");\n-\n-        rolesDir.toFile().mkdirs();\n-        usersDir.toFile().mkdirs();\n-        privilegesDir.toFile().mkdirs();\n-\n-        userRolesDir.toFile().mkdirs();\n-        userUsersDir.toFile().mkdirs();\n-        userPrivilegesDir.toFile().mkdirs();\n \n         PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();\n-\n-        // Ant-style path matching\n-        Resource[] resources = new Resource[0];\n-        InputStream is = null;\n         try {\n-            resources = resolver.getResources(\"classpath:hub-internal-config/security/amps/*.json\");\n-            for (Resource resource : resources) {\n-                is = resource.getInputStream();\n-                FileUtil.copy(is, ampsDir.resolve(resource.getFilename()).toFile());\n-            }\n+            writeResources(resolver, \"classpath:hub-internal-config/security/amps/*.json\", getHubSecurityDir().resolve(\"amps\"));\n+            writeResources(resolver, \"classpath:hub-internal-config/security/privileges/*.json\", getHubSecurityDir().resolve(\"privileges\"));\n+            writeResources(resolver, \"classpath:hub-internal-config/security/roles/*.json\", getHubSecurityDir().resolve(\"roles\"));\n+            writeResources(resolver, \"classpath:hub-internal-config/security/users/*.json\", getHubSecurityDir().resolve(\"users\"));\n+            writeResources(resolver, \"classpath:hub-internal-config/triggers/*.json\", getHubTriggersDir());\n         } catch (IOException e) {\n-            logger.error(\"Failed to load amp resource\", e);\n-        } finally {\n-            IOUtils.closeQuietly(is);\n+            throw new RuntimeException(\"Unable to write project resources to project filesystem; cause: \" + e.getMessage(), e);\n         }\n \n-        //New 5.3.0 roles\n-        writeRoleFile(rolesDir, \"data-hub-common.json\");\n-        writeRoleFile(rolesDir, \"data-hub-common-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-security-internal.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-load-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-saved-query-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-saved-query-writer.json\");\n-        writeRoleFile(rolesDir, \"hub-central-clear-user-data.json\");\n-        writeRoleFile(rolesDir, \"hub-central-downloader.json\");\n-        writeRoleFile(rolesDir, \"hub-central-entity-exporter.json\");\n-        writeRoleFile(rolesDir, \"hub-central-mapping-reader.json\");\n-        writeRoleFile(rolesDir, \"hub-central-mapping-writer.json\");\n-        writeRoleFile(rolesDir, \"hub-central-load-reader.json\");\n-        writeRoleFile(rolesDir, \"hub-central-user.json\");\n-\n-\n-        // New 5.2.0 roles\n-        writeRoleFile(rolesDir, \"data-hub-admin.json\");\n-        writeRoleFile(rolesDir, \"data-hub-developer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-environment-manager.json\");\n-        writeRoleFile(rolesDir, \"data-hub-job-internal.json\");\n-        writeRoleFile(rolesDir, \"data-hub-job-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-monitor.json\");\n-        writeRoleFile(rolesDir, \"data-hub-operator.json\");\n-        writeRoleFile(rolesDir, \"data-hub-portal-security-admin.json\");\n-        writeRoleFile(rolesDir, \"data-hub-security-admin.json\");\n-        writeRoleFile(rolesDir, \"data-hub-flow-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-flow-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-mapping-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-mapping-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-match-merge-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-match-merge-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-step-definition-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-step-definition-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-entity-model-writer.json\");\n-        writeRoleFile(rolesDir, \"data-hub-module-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-module-writer.json\");\n-\n-\n-        // New 5.1.0 roles\n-        writeRoleFile(rolesDir, \"data-hub-entity-model-reader.json\");\n-        writeRoleFile(rolesDir, \"data-hub-explorer-architect.json\");\n-\n-        // Legacy roles\n-        writeRoleFile(rolesDir, \"data-hub-admin-role.json\");\n-        writeRoleFile(rolesDir, \"flow-developer-role.json\");\n-        writeRoleFile(rolesDir, \"flow-operator-role.json\");\n-\n-        writeResourceFile(\"hub-internal-config/security/users/flow-developer-user.json\", usersDir.resolve(\"flow-developer-user.json\"), true);\n-        writeResourceFile(\"hub-internal-config/security/users/flow-operator-user.json\", usersDir.resolve(\"flow-operator-user.json\"), true);\n-\n-        // New 5.3.0 privileges\n-        writeResourceFile(\"hub-internal-config/security/privileges/data-hub-download-configuration-files.json\", privilegesDir.resolve(\"data-hub-download-configuration-files.json\"), true);\n-\n-        // New 5.2.0 privileges\n-        writeResourceFile(\"hub-internal-config/security/privileges/data-hub-create-custom-privilege.json\", privilegesDir.resolve(\"data-hub-create-custom-privilege.json\"), true);\n-\n-        writeResourceFile(\"hub-internal-config/security/privileges/dhf-internal-data-hub.json\", privilegesDir.resolve(\"dhf-internal-data-hub.json\"), true);\n-        writeResourceFile(\"hub-internal-config/security/privileges/dhf-internal-entities.json\", privilegesDir.resolve(\"dhf-internal-entities.json\"), true);\n-        writeResourceFile(\"hub-internal-config/security/privileges/dhf-internal-mappings.json\", privilegesDir.resolve(\"dhf-internal-mappings.json\"), true);\n-        writeResourceFile(\"hub-internal-config/security/privileges/dhf-internal-trace-ui.json\", privilegesDir.resolve(\"dhf-internal-trace-ui.json\"), true);\n+        Path userSecurityDir = getUserSecurityDir();\n+        userSecurityDir.resolve(\"roles\").toFile().mkdirs();\n+        userSecurityDir.resolve(\"users\").toFile().mkdirs();\n+        userSecurityDir.resolve(\"privileges\").toFile().mkdirs();\n \n         getUserServersDir().toFile().mkdirs();\n         getUserDatabaseDir().toFile().mkdirs();\n"}}, {"oid": "1a06dafa3532db6e74d93e5e1f8626712ad8551f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1a06dafa3532db6e74d93e5e1f8626712ad8551f", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T17:29:39Z", "type": "forcePushed"}, {"oid": "fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fd5b9dc7c5db7b0edfc7dd114ff294bf7ccee5c8", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T19:02:24Z", "type": "forcePushed"}, {"oid": "9689021f3ee50254dcd0930bd66d59682ac5ed2b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9689021f3ee50254dcd0930bd66d59682ac5ed2b", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T19:43:27Z", "type": "forcePushed"}, {"oid": "dae0f38d865ccaa14bac8858862d50f15b600db0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dae0f38d865ccaa14bac8858862d50f15b600db0", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T22:05:46Z", "type": "commit"}, {"oid": "dae0f38d865ccaa14bac8858862d50f15b600db0", "url": "https://github.com/marklogic/marklogic-data-hub/commit/dae0f38d865ccaa14bac8858862d50f15b600db0", "message": "DHFPROD-4671: Add hub-central-load-reader role", "committedDate": "2020-05-26T22:05:46Z", "type": "forcePushed"}]}