{"pr_number": 4007, "pr_title": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"OutputURI Replacement\" from HC", "pr_createdAt": "2020-05-27T20:22:38Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4007", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNzA5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431427090", "bodyText": "Won't WriteStepRunner throw this error? I think it's fine to just handle it in one place.", "author": "rjrudin", "createdAt": "2020-05-27T20:37:42Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java", "diffHunk": "@@ -111,10 +114,20 @@\n                 runFlowString.append(\"\\n\\t\\tInput File Path: \" + inputFilePath);\n                 fileLocations.put(\"inputFilePath\", inputFilePath);\n             }\n+\n+            if (outputURIPrefix != null) {\n+                if(outputURIReplacement != null){", "originalCommit": "e36705c2be4bb4ffa2f29036b4c69dc74eec84eb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5392094621773bbf2fb6b7f326295682c17528d4", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java\nindex 2d3e6ebbd..5578c64d2 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/cli/client/CommandLineFlowInputs.java\n\n@@ -116,9 +116,6 @@ public class CommandLineFlowInputs {\n             }\n \n             if (outputURIPrefix != null) {\n-                if(outputURIReplacement != null){\n-                    throw new IllegalArgumentException(\"'outputURIPrefix' and 'outputURIReplacement' cannot be set simultaneously\");\n-                }\n                 runFlowString.append(\"\\n\\t\\tOutput URI Prefix: \" + outputURIPrefix);\n                 fileLocations.put(\"outputURIPrefix\", outputURIPrefix);\n             }\n"}}, {"oid": "5392094621773bbf2fb6b7f326295682c17528d4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5392094621773bbf2fb6b7f326295682c17528d4", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC", "committedDate": "2020-05-27T23:27:14Z", "type": "forcePushed"}, {"oid": "5d0823de615442f93563e8cbb4f01f23a518e474", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5d0823de615442f93563e8cbb4f01f23a518e474", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC", "committedDate": "2020-05-28T00:54:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMTUzMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431811533", "bodyText": "I think it'd be good to change these checks to use a StringUtils method - e.g. hasText, isNotEmpty - because if one has a value and the other just has \"\", we're fine with that.", "author": "rjrudin", "createdAt": "2020-05-28T12:53:32Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -398,6 +400,10 @@ protected void loadStepRunnerParameters(){\n             this.withStopOnFailure(Boolean.parseBoolean(stepConfig.get(\"stopOnFailure\").toString()));\n         }\n \n+        if(outputURIPrefix != null && outputURIReplacement != null){", "originalCommit": "5d0823de615442f93563e8cbb4f01f23a518e474", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4509ef903c799d0fb291254215151147fc149da6", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\nindex 9757f916a..f1c800e24 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n\n@@ -400,7 +400,7 @@ public class WriteStepRunner implements StepRunner {\n             this.withStopOnFailure(Boolean.parseBoolean(stepConfig.get(\"stopOnFailure\").toString()));\n         }\n \n-        if(outputURIPrefix != null && outputURIReplacement != null){\n+        if(StringUtils.isNotEmpty(outputURIPrefix) && StringUtils.isNotEmpty(outputURIReplacement)){\n             throw new RuntimeException(\"'outputURIPrefix' and 'outputURIReplacement' cannot be set simultaneously\");\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMjg1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431812857", "bodyText": "I frequently like to put logic like this into a protected method so that it can easily unit-tested. You can even pass in the \"osName\" so you can verify the windows-specific code while not on windows. I didn't check the test coverage of all the conditions in here, but it'd be really easy to get 100% coverage of it with unit tests that will of course run very quickly too (i.e. put them in a class that doesn't extend anything, as you don't need any of the HubTestBase plumbing).", "author": "rjrudin", "createdAt": "2020-05-28T12:55:37Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java", "diffHunk": "@@ -652,14 +658,24 @@ private RunStepResponse runIngester(RunStepResponse runStepResponse, Collection<\n     }\n \n     private void processCsv(JacksonHandle jacksonHandle, File file) {\n-        String uri = file.getParent();\n-        if(SystemUtils.OS_NAME.toLowerCase().contains(\"windows\")){\n-            uri = \"/\" + FilenameUtils.separatorsToUnix(StringUtils.replaceOnce(uri, \":\", \"\"));\n+        String uri;", "originalCommit": "5d0823de615442f93563e8cbb4f01f23a518e474", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDk5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4007#discussion_r431970991", "bodyText": "Moved uri generation for csv to a protected method and added test in WriteTestBatcherTest class", "author": "srinathgit", "createdAt": "2020-05-28T16:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgxMjg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "4509ef903c799d0fb291254215151147fc149da6", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\nindex 9757f916a..f1c800e24 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/step/impl/WriteStepRunner.java\n\n@@ -658,8 +658,27 @@ public class WriteStepRunner implements StepRunner {\n     }\n \n     private void processCsv(JacksonHandle jacksonHandle, File file) {\n+        ObjectMapper mapper = jacksonHandle.getMapper();\n+        JsonNode originalContent = jacksonHandle.get();\n+        ObjectNode node = mapper.createObjectNode();\n+        node.set(\"content\",originalContent);\n+        node.put(\"file\", file.getAbsolutePath());\n+        jacksonHandle.set(node);\n+        try {\n+            writeBatcher.add(generateUriForCsv(file.getParent(), SystemUtils.OS_NAME.toLowerCase()), jacksonHandle);\n+        }\n+        catch (IllegalStateException e) {\n+            logger.error(\"WriteBatcher has been stopped\");\n+        }\n+        if (!file.getAbsolutePath().equalsIgnoreCase(currentCsvFile)) {\n+            currentCsvFile = file.getAbsolutePath();\n+            ++csvFilesProcessed;\n+        }\n+    }\n+\n+    protected String generateUriForCsv(String parentPath, String os){\n         String uri;\n-        if(outputURIPrefix != null){\n+        if(StringUtils.isNotEmpty(outputURIPrefix)){\n             try {\n                 uri = generateAndEncodeURI(outputURIPrefix).replace(\"%\", \"%%\");\n             } catch (URISyntaxException e) {\n"}}, {"oid": "4509ef903c799d0fb291254215151147fc149da6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4509ef903c799d0fb291254215151147fc149da6", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC", "committedDate": "2020-05-28T16:31:50Z", "type": "commit"}, {"oid": "4509ef903c799d0fb291254215151147fc149da6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4509ef903c799d0fb291254215151147fc149da6", "message": "DHFPROD-4932:Add 'outputURIPrefix' in ingestion step, replace \"Output URI Replacement\" from HC", "committedDate": "2020-05-28T16:31:50Z", "type": "forcePushed"}]}