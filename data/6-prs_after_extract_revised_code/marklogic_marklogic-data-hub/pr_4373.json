{"pr_number": 4373, "pr_title": "DHFPROD-5663: Migrate matching, merging, and mastering steps", "pr_createdAt": "2020-08-10T18:49:57Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4373", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4NDIxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468184218", "bodyText": "Can you include the value of type in here - e.g. \"Invalid step type: \" + type", "author": "rjrudin", "createdAt": "2020-08-10T21:02:47Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java", "diffHunk": "@@ -769,6 +769,43 @@ public Path getStepsPath() {\n         return this.projectDir.resolve(\"steps\");\n     }\n \n+    @Override\n+    public Path getStepsPath(StepDefinition.StepDefinitionType type) {\n+        Path path;\n+\n+        Path parent = this.getStepsPath();\n+\n+        if (type == null) {\n+            throw new DataHubProjectException(\"Invalid Step type\");\n+        }\n+        else {\n+            switch (type) {\n+                case CUSTOM:\n+                    path = parent.resolve(\"custom\");\n+                    break;\n+                case INGESTION:\n+                    path = parent.resolve(\"ingestion\");\n+                    break;\n+                case MAPPING:\n+                    path = parent.resolve(\"mapping\");\n+                    break;\n+                case MASTERING:\n+                    path = parent.resolve(\"mastering\");\n+                    break;\n+                case MATCHING:\n+                    path = parent.resolve(\"matching\");\n+                    break;\n+                case MERGING:\n+                    path = parent.resolve(\"merging\");\n+                    break;\n+                default:\n+                    throw new DataHubProjectException(\"Invalid Step type\");", "originalCommit": "d97735156910ba497cdc14be659627df2a4ea4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzNjYzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468236638", "bodyText": "Done", "author": "fsnow", "createdAt": "2020-08-10T23:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4NDIxOA=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java b/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\nindex 8ad709237..12f7c1e4f 100644\n--- a/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\n+++ b/marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java\n\n@@ -799,7 +799,7 @@ public class HubProjectImpl implements HubProject {\n                     path = parent.resolve(\"merging\");\n                     break;\n                 default:\n-                    throw new DataHubProjectException(\"Invalid Step type\");\n+                    throw new DataHubProjectException(\"Invalid Step type\" + type.toString());\n             }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4ODg3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468188878", "bodyText": "I think this should have \"@test\" on it?", "author": "rjrudin", "createdAt": "2020-08-10T21:12:51Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project\n+        try {\n+            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n+            HubProject hubProject = getHubConfig().getHubProject();\n+            File inputDir = new File(testProjectDir, \"input\");\n+            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n+            if (inputDir.exists()) {\n+                FileUtils.copyDirectory(inputDir, copyToDir);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Test\n+    void validateMigratedFlowsAndSteps() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+\n+        validateFullyReferencedFlowsAndSteps();\n+    }\n+\n+    @Test\n+    void migrateAndRunCompleteFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"CurateCustomerJSON\", \"1\", \"2\", \"3\", \"4\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse runStepResponse = flowResponse.getStepResponses().get(\"1\");\n+        assertTrue(runStepResponse.isSuccess(), \"Ingestion step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"2\");\n+        assertTrue(runStepResponse.isSuccess(), \"Mapping step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(runStepResponse.isSuccess(), \"Matching step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"4\");\n+        assertTrue(runStepResponse.isSuccess(), \"Merging step failed!\");\n+\n+        assertTrue(getFinalDocCount(\"merged-customer\") == 6,\"Expected 6 merged-customer docs\");\n+    }\n+\n+    void migrateAndRunMasteringFlow() {", "originalCommit": "d97735156910ba497cdc14be659627df2a4ea4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzODA3Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468238073", "bodyText": "I had intended to remove that. I will replace it with a mastering flow test that uses the small Customer dataset.", "author": "fsnow", "createdAt": "2020-08-10T23:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4ODg3OA=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 2e1f7966e..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTIzMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468189233", "bodyText": "There are unfortunately a lot of equality assertions in the DHF codebase that use assertTrue instead of assertEquals - this should be \"assertEquals(6, getFinalDocCount(...), \"message\").", "author": "rjrudin", "createdAt": "2020-08-10T21:13:31Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project\n+        try {\n+            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n+            HubProject hubProject = getHubConfig().getHubProject();\n+            File inputDir = new File(testProjectDir, \"input\");\n+            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n+            if (inputDir.exists()) {\n+                FileUtils.copyDirectory(inputDir, copyToDir);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Test\n+    void validateMigratedFlowsAndSteps() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+\n+        validateFullyReferencedFlowsAndSteps();\n+    }\n+\n+    @Test\n+    void migrateAndRunCompleteFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"CurateCustomerJSON\", \"1\", \"2\", \"3\", \"4\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse runStepResponse = flowResponse.getStepResponses().get(\"1\");\n+        assertTrue(runStepResponse.isSuccess(), \"Ingestion step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"2\");\n+        assertTrue(runStepResponse.isSuccess(), \"Mapping step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(runStepResponse.isSuccess(), \"Matching step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"4\");\n+        assertTrue(runStepResponse.isSuccess(), \"Merging step failed!\");\n+\n+        assertTrue(getFinalDocCount(\"merged-customer\") == 6,\"Expected 6 merged-customer docs\");", "originalCommit": "d97735156910ba497cdc14be659627df2a4ea4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzODE0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468238148", "bodyText": "Fixed", "author": "fsnow", "createdAt": "2020-08-10T23:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTIzMw=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 2e1f7966e..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTY3MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468189670", "bodyText": "installProjectInFolder will do this automatically for you, but the folder has to be named \"data\" instead of \"input\"", "author": "rjrudin", "createdAt": "2020-08-10T21:14:31Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project", "originalCommit": "d97735156910ba497cdc14be659627df2a4ea4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzODIyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468238224", "bodyText": "Renamed to \"data\"", "author": "fsnow", "createdAt": "2020-08-10T23:21:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMjU0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468732545", "bodyText": "I believe you can delete this whole try/catch block then, correct?", "author": "rjrudin", "createdAt": "2020-08-11T17:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczNzk2MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468737960", "bodyText": "Yes, I had intended to do that. Just pushed an update with it removed.", "author": "fsnow", "createdAt": "2020-08-11T17:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4OTY3MA=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 2e1f7966e..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MDQ1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468190457", "bodyText": "I think you should be able to run the mastering test on the same data that you used for the matching and merging test, which I highly recommend because we know there's exactly one match expected. We don't want to repeat the assertions from MasterTest, where we expect a very high count of documents, and when that count isn't met, it's nearly impossible to determine why not.", "author": "rjrudin", "createdAt": "2020-08-10T21:16:04Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project\n+        try {\n+            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n+            HubProject hubProject = getHubConfig().getHubProject();\n+            File inputDir = new File(testProjectDir, \"input\");\n+            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n+            if (inputDir.exists()) {\n+                FileUtils.copyDirectory(inputDir, copyToDir);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Test\n+    void validateMigratedFlowsAndSteps() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+\n+        validateFullyReferencedFlowsAndSteps();\n+    }\n+\n+    @Test\n+    void migrateAndRunCompleteFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"CurateCustomerJSON\", \"1\", \"2\", \"3\", \"4\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse runStepResponse = flowResponse.getStepResponses().get(\"1\");\n+        assertTrue(runStepResponse.isSuccess(), \"Ingestion step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"2\");\n+        assertTrue(runStepResponse.isSuccess(), \"Mapping step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(runStepResponse.isSuccess(), \"Matching step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"4\");\n+        assertTrue(runStepResponse.isSuccess(), \"Merging step failed!\");\n+\n+        assertTrue(getFinalDocCount(\"merged-customer\") == 6,\"Expected 6 merged-customer docs\");\n+    }\n+\n+    void migrateAndRunMasteringFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        // The following test was copied from MasterTest\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"myNewFlow\", \"1\",\"2\",\"3\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse masterJob = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(masterJob.isSuccess(), \"Mastering job failed!\");\n+        assertTrue(getFinalDocCount(\"sm-person-merged\") >= 10,\"At least 10 merges occur\");", "originalCommit": "d97735156910ba497cdc14be659627df2a4ea4e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODIzODMxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468238318", "bodyText": "Will do", "author": "fsnow", "createdAt": "2020-08-10T23:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE5MDQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 2e1f7966e..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDAwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468250006", "bodyText": "This same method exists in MasterTest. I think it can be moved to AbstractHubCoreTest and called in both the tests.", "author": "srinathgit", "createdAt": "2020-08-10T23:59:32Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project\n+        try {\n+            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n+            HubProject hubProject = getHubConfig().getHubProject();\n+            File inputDir = new File(testProjectDir, \"input\");\n+            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n+            if (inputDir.exists()) {\n+                FileUtils.copyDirectory(inputDir, copyToDir);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Test\n+    void validateMigratedFlowsAndSteps() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+\n+        validateFullyReferencedFlowsAndSteps();\n+    }\n+\n+    @Test\n+    void migrateAndRunCompleteFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"CurateCustomerJSON\", \"1\", \"2\", \"3\", \"4\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse runStepResponse = flowResponse.getStepResponses().get(\"1\");\n+        assertTrue(runStepResponse.isSuccess(), \"Ingestion step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"2\");\n+        assertTrue(runStepResponse.isSuccess(), \"Mapping step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(runStepResponse.isSuccess(), \"Matching step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"4\");\n+        assertTrue(runStepResponse.isSuccess(), \"Merging step failed!\");\n+\n+        assertEquals(6, getFinalDocCount(\"merged-customer\"),\"Expected 6 merged-customer docs\");\n+    }\n+\n+    void migrateAndRunMasteringFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        // The following test was copied from MasterTest\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"myNewFlow\", \"1\",\"2\",\"3\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse masterJob = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(masterJob.isSuccess(), \"Mastering job failed!\");\n+        assertTrue(getFinalDocCount(\"sm-person-merged\") >= 10,\"At least 10 merges occur\");\n+        assertTrue(getFinalDocCount(\"master\") > 0, \"Documents didn't receive master collection\");\n+\n+        // This occasionally fails both locally and in Jenkins with a result of 205. 208 was the original expected value.\n+        // More than half of the time, 208 will be the result. So the test seems to verify a mastering step, and the fact\n+        // that it fails sometimes is being ignored enough that there's no value in having Jenkins test runs fail solely\n+        // because this returns 205 instead of 208. The ideal solution is likely to narrow down the set of documents\n+        // that are expected to be merged together, as it's very difficult right now to know why only 205 are in the\n+        // collection and which 3 are \"missing\".\n+        int masteredCount = getFinalDocCount(\"sm-person-mastered\");\n+        assertTrue(masteredCount >= 205, \"Expecting at least 205 documents to be in the 'sm-person-mastered' collection, but only found: \"+ masteredCount);\n+\n+        // Setting this to 40 or greater as occasionally we get 41 in the pipeline. See bug https://project.marklogic.com/jira/browse/DHFPROD-3178\n+        assertTrue(getFinalDocCount(\"sm-person-notification\") >= 40, \"Not enough notifications are created\");\n+        // Check for JobReport for mastering with correct count\n+        String reportQueryText =\n+            \"cts:and-query((\" +\n+              \"cts:collection-query('JobReport'),\" +\n+              \"cts:json-property-value-query('jobID', '\"+ masterJob.getJobId() +\"'),\" +\n+              \"cts:json-property-value-query('count', \" + masteredCount + \")\" +\n+            \"))\";\n+        assertTrue(existsByQuery(reportQueryText, HubConfig.DEFAULT_JOB_NAME), \"Missing valid mastering job report!\");\n+    }\n+\n+    private Boolean existsByQuery(String query, String database) {", "originalCommit": "7404a8fecf3bf70acfc29a1fece947c64b04685f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwMTQ0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468701442", "bodyText": "I removed this test adapted from MasterTest and all of its helper methods.", "author": "fsnow", "createdAt": "2020-08-11T16:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDAwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 058551a32..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDcyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468250723", "bodyText": "There seems to be a lot of overlap (and duplication) between this test and FlowMigratorTest. I think it would be better to have one test  class in which a project can be migrated, the artifacts verified and then run.", "author": "srinathgit", "createdAt": "2020-08-11T00:02:04Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {", "originalCommit": "7404a8fecf3bf70acfc29a1fece947c64b04685f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODczMjM0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468732348", "bodyText": "I don't mind a separate test class, as long as we have separate scenarios (in fact, complex scenarios often warrant their own test class with a single test method). I agree that duplication of assertions on ingestions and mapping steps can be removed. But I don't mind a separate class.", "author": "rjrudin", "createdAt": "2020-08-11T17:05:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MDcyMw=="}], "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 058551a32..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODI1MjYwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4373#discussion_r468252607", "bodyText": "I think it would be good to have similar methods for mastering, matching and merging steps and make sure that the files are created and looks as expected.", "author": "srinathgit", "createdAt": "2020-08-11T00:08:35Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java", "diffHunk": "@@ -0,0 +1,429 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+//import com.marklogic.client.document.JSONDocumentManager;\n+import com.marklogic.client.eval.EvalResult;\n+import com.marklogic.client.eval.EvalResultIterator;\n+import com.marklogic.hub.*;\n+import com.marklogic.hub.dataservices.FlowService;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.FlowRunner;\n+import com.marklogic.hub.flow.RunFlowResponse;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.RunStepResponse;\n+import com.marklogic.hub.step.StepDefinition;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.core.io.ClassPathResource;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.*;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class AllStepsReferencedTest extends AbstractHubCoreTest {\n+\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    @Autowired\n+    FlowRunner flowRunner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        String folderInClasspath = \"test-projects/all-steps-referenced\";\n+        installProjectInFolder(folderInClasspath);\n+\n+        // copy input directory to ye-olde-project\n+        try {\n+            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n+            HubProject hubProject = getHubConfig().getHubProject();\n+            File inputDir = new File(testProjectDir, \"input\");\n+            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n+            if (inputDir.exists()) {\n+                FileUtils.copyDirectory(inputDir, copyToDir);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    @Test\n+    void validateMigratedFlowsAndSteps() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+\n+        validateFullyReferencedFlowsAndSteps();\n+    }\n+\n+    @Test\n+    void migrateAndRunCompleteFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"CurateCustomerJSON\", \"1\", \"2\", \"3\", \"4\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse runStepResponse = flowResponse.getStepResponses().get(\"1\");\n+        assertTrue(runStepResponse.isSuccess(), \"Ingestion step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"2\");\n+        assertTrue(runStepResponse.isSuccess(), \"Mapping step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(runStepResponse.isSuccess(), \"Matching step failed!\");\n+        runStepResponse = flowResponse.getStepResponses().get(\"4\");\n+        assertTrue(runStepResponse.isSuccess(), \"Merging step failed!\");\n+\n+        assertEquals(6, getFinalDocCount(\"merged-customer\"),\"Expected 6 merged-customer docs\");\n+    }\n+\n+    void migrateAndRunMasteringFlow() {\n+        HubConfig hubConfig = getHubConfig();\n+\n+        FlowMigrator flowMigrator = new FlowMigrator(hubConfig);\n+        flowMigrator.migrateFlows();\n+        installUserArtifacts();\n+\n+        // The following test was copied from MasterTest\n+\n+        RunFlowResponse flowResponse = flowRunner.runFlow(new FlowInputs(\"myNewFlow\", \"1\",\"2\",\"3\"));\n+        flowRunner.awaitCompletion();\n+        RunStepResponse masterJob = flowResponse.getStepResponses().get(\"3\");\n+        assertTrue(masterJob.isSuccess(), \"Mastering job failed!\");\n+        assertTrue(getFinalDocCount(\"sm-person-merged\") >= 10,\"At least 10 merges occur\");\n+        assertTrue(getFinalDocCount(\"master\") > 0, \"Documents didn't receive master collection\");\n+\n+        // This occasionally fails both locally and in Jenkins with a result of 205. 208 was the original expected value.\n+        // More than half of the time, 208 will be the result. So the test seems to verify a mastering step, and the fact\n+        // that it fails sometimes is being ignored enough that there's no value in having Jenkins test runs fail solely\n+        // because this returns 205 instead of 208. The ideal solution is likely to narrow down the set of documents\n+        // that are expected to be merged together, as it's very difficult right now to know why only 205 are in the\n+        // collection and which 3 are \"missing\".\n+        int masteredCount = getFinalDocCount(\"sm-person-mastered\");\n+        assertTrue(masteredCount >= 205, \"Expecting at least 205 documents to be in the 'sm-person-mastered' collection, but only found: \"+ masteredCount);\n+\n+        // Setting this to 40 or greater as occasionally we get 41 in the pipeline. See bug https://project.marklogic.com/jira/browse/DHFPROD-3178\n+        assertTrue(getFinalDocCount(\"sm-person-notification\") >= 40, \"Not enough notifications are created\");\n+        // Check for JobReport for mastering with correct count\n+        String reportQueryText =\n+            \"cts:and-query((\" +\n+              \"cts:collection-query('JobReport'),\" +\n+              \"cts:json-property-value-query('jobID', '\"+ masterJob.getJobId() +\"'),\" +\n+              \"cts:json-property-value-query('count', \" + masteredCount + \")\" +\n+            \"))\";\n+        assertTrue(existsByQuery(reportQueryText, HubConfig.DEFAULT_JOB_NAME), \"Missing valid mastering job report!\");\n+    }\n+\n+    private Boolean existsByQuery(String query, String database) {\n+        Boolean exists = Boolean.FALSE;\n+        EvalResultIterator resultItr = runInDatabase(\"xdmp:exists(cts:search(fn:doc(),\" + query + \"))\", database);\n+        if (resultItr == null || ! resultItr.hasNext()) {\n+            return exists;\n+        }\n+        EvalResult res = resultItr.next();\n+        exists = res.getBoolean();\n+        return exists;\n+    }\n+\n+    private void validateFullyReferencedFlowsAndSteps() {\n+        HubProject hubProject = getHubConfig().getHubProject();\n+\n+        ArrayList<StepDefinition.StepDefinitionType> stepDefTypes = StepDefinition.StepDefinitionType.getStepDefinitionTypes();\n+\n+        File[] flowFiles = hubProject.getFlowsDir().toFile().listFiles();\n+        assertEquals(flowFiles.length, 1);\n+\n+        for (File flowFile : flowFiles) {\n+            JsonNode flowNode = readJsonObject(flowFile);\n+            JsonNode stepsNode = flowNode.get(\"steps\");\n+            assertNotNull(stepsNode, \"The steps key should exist in the flow document\");\n+             Iterator<String> fieldNames = stepsNode.fieldNames();\n+            int stepNum = 1;\n+            while (fieldNames.hasNext()) {\n+                String fieldName = fieldNames.next();\n+                assertEquals(fieldName, Integer.toString(stepNum),\n+                    \"Step numbers should be sequential positive integers starting with one.\");\n+                JsonNode innerObj = stepsNode.get(fieldName);\n+                assertNotNull(innerObj);\n+\n+                String stepId = innerObj.get(\"stepId\").asText();\n+                assertNotNull(stepId, \"stepId should be not null\");\n+\n+                String[] stepIdParts = stepId.split(\"-\");\n+                assertTrue(stepIdParts.length > 1,\n+                    format(\"Step name should be consist of multiple hyphen-separated parts. (%s)\", stepId));\n+                // the last part of the step name is the step definition type\n+                String stepType = stepIdParts[stepIdParts.length - 1];\n+                assertNotNull(StepDefinition.StepDefinitionType.getStepDefinitionType(stepType),\n+                    \"The final part of the stepId should be a step definition type\");\n+\n+                Path stepsPath = hubProject.getStepsPath(StepDefinition.StepDefinitionType.getStepDefinitionType(stepType));\n+                // derive the step name by omitting the final hyphen and step definition type\n+                String stepName = String.join(\"-\", Arrays.copyOfRange(stepIdParts, 0, stepIdParts.length - 1));\n+                assertTrue(stepsPath.resolve(stepName + \".step.json\").toFile().exists(),\n+                    format(\"The step file should exist in the correct step directory. (name: %s, stepId: %s, stepDefinitionType: %s)\", stepName, stepId, stepType));\n+\n+                stepNum++;\n+            }\n+        }\n+\n+        /*\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+\n+        assertTrue(migratedFlows.toFile().exists());\n+        assertFalse(hubProject.getHubMappingsDir().toFile().exists());\n+\n+        assertTrue(migratedFlows.resolve(\"flows\").toFile().listFiles().length > 0);\n+        assertTrue(migratedFlows.resolve(\"mappings\").toFile().listFiles().length > 0);\n+\n+        verifyFlows(hubProject);\n+        verifyIngestionSteps(hubProject, flowMap);\n+        verifyMappingSteps(hubProject, mappingMap, flowMap);\n+        verifyCustomSteps(hubProject, flowMap);\n+\n+        // Deploy artifacts to server\n+        installUserArtifacts();\n+        FlowService flowService = FlowService.on(getHubClient().getStagingClient());\n+        JsonNode flows = flowService.getFlowsWithStepDetails();\n+        // Confirms that endpoint returns 4 flows.\n+        assertEquals(4, flows.size());\n+        for (JsonNode flow: flows){\n+            String flowName = flow.get(\"name\").asText();\n+            //Checks the number of steps is same in the original flow and the flow returned by the ds endpoint\n+            assertEquals(flowMap.get(flowName).getSteps().size(), flow.get(\"steps\").size());\n+        }\n+\n+         */\n+    }\n+\n+    private void verifyCustomSteps(HubProject hubProject, Map<String, Flow> flowMap) {\n+        Path customSteps = hubProject.getProjectDir().resolve(\"steps\").resolve(\"custom\");\n+        Flow customOnlyFlow = flowMap.get(\"custom_only-flow\");\n+        Flow customMasterFlow = flowMap.get(\"custom-master\");\n+\n+        JsonNode customStep1 = readJsonObject(customSteps.resolve(\"custom-mastering.step.json\").toFile());\n+        JsonNode customStep2 = readJsonObject(customSteps.resolve(\"generate-dictionary.step.json\").toFile());\n+        JsonNode customStep3 = readJsonObject(customSteps.resolve(\"custom-mapping-step.step.json\").toFile());\n+\n+        assertEquals(List.of(\"master-customer\", \"Customer\", \"custom-mastering\" ), getCollectionsAsList(customStep1));\n+        assertEquals(List.of(\"generate-dictionary\", \"Customer\"), getCollectionsAsList(customStep2));\n+        assertEquals(List.of(\"custom-mapping-step\" ), getCollectionsAsList(customStep3));\n+\n+        verifyOptions(customStep1, mapper.valueToTree(customMasterFlow.getStep(\"3\").getOptions()));\n+        verifyOptions(customStep2, mapper.valueToTree(customMasterFlow.getStep(\"1\").getOptions()));\n+        verifyOptions(customStep3, mapper.valueToTree(customOnlyFlow.getStep(\"1\").getOptions()));\n+\n+        assertEquals(\"custom-mastering\", customStep1.get(\"name\").asText());\n+        assertEquals(\"This is a custom mastering step\", customStep1.get(\"description\").asText());\n+        assertEquals(\"custom\", customStep1.get(\"stepDefinitionType\").asText().toLowerCase());\n+        assertEquals(\"Customer\", customStep1.get(\"targetEntityType\").asText());\n+        assertEquals(\"json\", customStep1.get(\"targetFormat\").asText());\n+        assertEquals(\"custom-mastering-custom\", customStep1.get(\"stepId\").asText());\n+\n+        assertEquals(\"generate-dictionary\", customStep2.get(\"name\").asText());\n+        assertEquals(\"Generate dictionary custom step\", customStep2.get(\"description\").asText());\n+        assertEquals(\"custom\", customStep2.get(\"stepDefinitionType\").asText().toLowerCase());\n+        assertEquals(\"Customer\", customStep2.get(\"targetEntityType\").asText());\n+        assertEquals(\"json\", customStep2.get(\"targetFormat\").asText());\n+        assertEquals(\"generate-dictionary-custom\", customStep2.get(\"stepId\").asText());\n+\n+        assertEquals(\"custom-mapping-step\", customStep3.get(\"name\").asText());\n+        assertEquals(\"maps and harmonizes XML docs to data-hub-FINAL\", customStep3.get(\"description\").asText());\n+        assertEquals(\"custom\", customStep3.get(\"stepDefinitionType\").asText().toLowerCase());\n+        assertEquals(\"xml\", customStep3.get(\"targetFormat\").asText());\n+        //\"mapping\" is copied over in case of custom mapping step with no valid mapping\n+        assertNotNull(customStep3.get(\"mapping\"));\n+        assertEquals(\"custom-mapping-step-custom\", customStep3.get(\"stepId\").asText());\n+    }\n+\n+    private List getCollectionsAsList(JsonNode customStep){\n+        JsonNode collectionsNode = customStep.get(\"collections\");\n+        List<String> collectionList = new ArrayList<>();\n+        for (JsonNode node : collectionsNode) {\n+            collectionList.add(node.asText());\n+        }\n+        return collectionList;\n+    }\n+\n+    private void verifyMappingSteps(HubProject hubProject, Map<String, Mapping> mappingMap, Map<String, Flow> flowMap) {", "originalCommit": "7404a8fecf3bf70acfc29a1fece947c64b04685f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "chunk": "diff --git a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\nindex 058551a32..894b21b3e 100644\n--- a/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n+++ b/marklogic-data-hub/src/test/java/com/marklogic/hub/hubcentral/migration/AllStepsReferencedTest.java\n\n@@ -41,19 +41,6 @@ class AllStepsReferencedTest extends AbstractHubCoreTest {\n     void setUp() {\n         String folderInClasspath = \"test-projects/all-steps-referenced\";\n         installProjectInFolder(folderInClasspath);\n-\n-        // copy input directory to ye-olde-project\n-        try {\n-            File testProjectDir = new ClassPathResource(folderInClasspath).getFile();\n-            HubProject hubProject = getHubConfig().getHubProject();\n-            File inputDir = new File(testProjectDir, \"input\");\n-            File copyToDir = new File(hubProject.getProjectDir().toFile(), \"input\");\n-            if (inputDir.exists()) {\n-                FileUtils.copyDirectory(inputDir, copyToDir);\n-            }\n-        } catch (IOException e) {\n-            throw new RuntimeException(\"Unable to load project files: \" + e.getMessage(), e);\n-        }\n     }\n \n     @Test\n"}}, {"oid": "e230c89e2c5e552976e0d54e792c184e324aaa3c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e230c89e2c5e552976e0d54e792c184e324aaa3c", "message": "DHFPROD-5663: Migrate matching, merging, and mastering steps", "committedDate": "2020-08-12T16:36:32Z", "type": "commit"}]}