{"pr_number": 6037, "pr_title": "#6031 Handle Schema Modification in Version", "pr_createdAt": "2020-01-14T12:28:13Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6037", "timeline": [{"oid": "2518a2de8c80d55d9895264aaa7b915e39cc6720", "url": "https://github.com/metasfresh/metasfresh/commit/2518a2de8c80d55d9895264aaa7b915e39cc6720", "message": "#6031 Handle Schema Modification in Version\n\nhttps://github.com/metasfresh/metasfresh/issues/6031", "committedDate": "2020-01-14T12:27:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM4OTYyMg==", "url": "https://github.com/metasfresh/metasfresh/pull/6037#discussion_r366389622", "bodyText": "doesn't this method return all lines?", "author": "metas-ts", "createdAt": "2020-01-14T15:04:31Z", "path": "de.metas.business/src/main/java/de/metas/phonecall/service/PhonecallSchemaRepository.java", "diffHunk": "@@ -290,4 +293,38 @@ else if (schemaVersionRecord.isMovePhonecallDay())\n \t\t\treturn null;\n \t\t}\n \t}\n+\n+\tpublic void updateLinesOnSchemaChanged(final PhonecallSchemaVersionId phonecallSchemaVersionId)\n+\t{\n+\t\tfinal int phonecallSchemaTableId = getTableId(I_C_Phonecall_Schema.class);\n+\n+\t\tfinal PhonecallSchemaId phonecallSchemaId = phonecallSchemaVersionId.getPhonecallSchemaId();\n+\t\tfinal List<I_C_Phonecall_Schema_Version_Line> linesWithDifferentSchema = retrieveLinesWithDifferentSchemas(phonecallSchemaVersionId);\n+\n+\t\tfinal ImmutableSet<Integer> schemasToInvalidate = linesWithDifferentSchema.stream()\n+\t\t\t\t.map(line -> line.getC_Phonecall_Schema_ID())\n+\t\t\t\t.collect(ImmutableSet.toImmutableSet());\n+\n+\t\tfor (final I_C_Phonecall_Schema_Version_Line line : linesWithDifferentSchema)\n+\t\t{\n+\t\t\tline.setC_Phonecall_Schema_ID(phonecallSchemaId.getRepoId());\n+\t\t\tsaveRecord(line);\n+\t\t}\n+\n+\t\tschemasToInvalidate.stream()\n+\t\t\t\t.forEach(schemaId -> schemas.resetForRecordId(TableRecordReference.of(phonecallSchemaTableId, schemaId)));\n+\n+\t\tschemas.resetForRecordId(TableRecordReference.of(phonecallSchemaTableId, phonecallSchemaId.getRepoId()));\n+\n+\t}\n+\n+\tprivate List<I_C_Phonecall_Schema_Version_Line> retrieveLinesWithDifferentSchemas(PhonecallSchemaVersionId phonecallSchemaVersionId)", "originalCommit": "2518a2de8c80d55d9895264aaa7b915e39cc6720", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}