{"pr_number": 6828, "pr_title": "Extend Invoice reversal API to return affected ICs", "pr_createdAt": "2020-06-11T15:40:25Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6828", "timeline": [{"oid": "33ed08604311dea0994a05fc18dcaca20dcbfe93", "url": "https://github.com/metasfresh/metasfresh/commit/33ed08604311dea0994a05fc18dcaca20dcbfe93", "message": "Extend Invoice reversal API to return affected ICs\nhttps://github.com/metasfresh/metasfresh/issues/6827", "committedDate": "2020-06-11T15:38:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI0NDc3Mw==", "url": "https://github.com/metasfresh/metasfresh/pull/6828#discussion_r439244773", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tList<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId);\n          \n          \n            \n            \tList<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull InvoiceId invoiceId);", "author": "metas-ts", "createdAt": "2020-06-12T07:06:16Z", "path": "backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/IInvoiceCandDAO.java", "diffHunk": "@@ -85,6 +85,8 @@\n \n \tList<I_C_Invoice_Candidate> retrieveIcForIl(I_C_InvoiceLine invoiceLine);\n \n+\tList<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId);", "originalCommit": "33ed08604311dea0994a05fc18dcaca20dcbfe93", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2cdfd09f3ceb3acf317b7a298bc3fb5ade3cad11", "chunk": "diff --git a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/IInvoiceCandDAO.java b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/IInvoiceCandDAO.java\nindex 2f36702f4f..3460c04a6d 100644\n--- a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/IInvoiceCandDAO.java\n+++ b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/IInvoiceCandDAO.java\n\n@@ -85,7 +85,7 @@ public interface IInvoiceCandDAO extends ISingletonService\n \n \tList<I_C_Invoice_Candidate> retrieveIcForIl(I_C_InvoiceLine invoiceLine);\n \n-\tList<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId);\n+\tList<I_C_Invoice_Candidate> retrieveInvoiceCandidates(InvoiceId invoiceId);\n \n \t/**\n \t * Returns those invoice candidates that have been tagged to be recomputed/updated by the given <code>recomputeTag</code>.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3MzgxMA==", "url": "https://github.com/metasfresh/metasfresh/pull/6828#discussion_r439273810", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tfinal I_C_Invoice invoice = load(invoiceId, I_C_Invoice.class);\n          \n          \n            \n            \n          \n          \n            \n            \t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n          \n          \n            \n            \t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n          \n          \n            \n            \t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoice.getC_Invoice_ID())\n          \n          \n            \n            \t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n          \n          \n            \n            \t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n          \n          \n            \n            \t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoiceId)\n          \n      \n    \n    \n  \n\n\nthe equals filter can handle RepoIdAwares\nwe don't need to pass the invoice a context provider; the query-builder can get the thread-local current transaction or create a \"local\" one on the fly", "author": "metas-ts", "createdAt": "2020-06-12T08:12:47Z", "path": "backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java", "diffHunk": "@@ -573,6 +572,30 @@ public boolean isAvoidRecreate(final I_C_Invoice_Candidate ic)\n \t\t\t\t.addColumn(I_C_Invoice_Candidate.COLUMN_C_Invoice_Candidate_ID);\n \n \t\treturn icQueryBuilder\n+\t\t\t\t.create()\n+\t\t\t\t.list();//\n+\t}\n+\n+\t@NonNull\n+\tpublic List<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId)\n+\t{\n+\t\tfinal I_C_Invoice invoice = load(invoiceId, I_C_Invoice.class);\n+\n+\t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n+\t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n+\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoice.getC_Invoice_ID())", "originalCommit": "33ed08604311dea0994a05fc18dcaca20dcbfe93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3OTcyMw==", "url": "https://github.com/metasfresh/metasfresh/pull/6828#discussion_r439279723", "bodyText": "I'll drop the loading of the invoice then, thx!", "author": "pvpurcarcosmin", "createdAt": "2020-06-12T08:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3MzgxMA=="}], "type": "inlineReview", "revised_code": {"commit": "2cdfd09f3ceb3acf317b7a298bc3fb5ade3cad11", "chunk": "diff --git a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\nindex b8973c351d..cae814f81a 100644\n--- a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\n+++ b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\n\n@@ -579,25 +577,16 @@ public class InvoiceCandDAO implements IInvoiceCandDAO\n \t@NonNull\n \tpublic List<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId)\n \t{\n-\t\tfinal I_C_Invoice invoice = load(invoiceId, I_C_Invoice.class);\n-\n-\t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n-\t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n-\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoice.getC_Invoice_ID())\n-\t\t\t\t\t\t//collect invoice line alloc\n+\t\treturn queryBL.createQueryBuilder(I_C_InvoiceLine.class)\n+\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoiceId)\n+\t\t\t\t\t\t//collect related invoice line alloc\n \t\t\t\t\t\t.andCollectChildren(I_C_Invoice_Line_Alloc.COLUMN_C_InvoiceLine_ID)\n \t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t\t\t.create();\n-\n-\t\treturn queryBL\n-\t\t\t\t.createQueryBuilder(I_C_Invoice_Candidate.class, invoice)\n-\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t.addInSubQueryFilter()\n-\t\t\t\t.subQuery(invoiceLineAllocQuery)\n-\t\t\t\t.matchingColumnNames(I_C_Invoice_Candidate.COLUMNNAME_C_Invoice_Candidate_ID, I_C_Invoice_Line_Alloc.COLUMNNAME_C_Invoice_Candidate_ID)\n-\t\t\t\t.end()\n-\t\t\t\t.create()\n-\t\t\t\t.list();\n+\t\t\t\t\t\t//collect related invoice candidates\n+\t\t\t\t        .andCollect(I_C_Invoice_Line_Alloc.COLUMN_C_Invoice_Candidate_ID)\n+\t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t\t\t.create()\n+\t\t\t\t        .list();\n \t}\n \n \t@Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3NDQ3NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6828#discussion_r439274475", "bodyText": "it's OK like this but you might (didn't check) also use andCollect to get from I_C_Invoice_Line_Alloc to I_C_Invoice_Candidate\nfor next time maybe..", "author": "metas-ts", "createdAt": "2020-06-12T08:14:12Z", "path": "backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java", "diffHunk": "@@ -573,6 +572,30 @@ public boolean isAvoidRecreate(final I_C_Invoice_Candidate ic)\n \t\t\t\t.addColumn(I_C_Invoice_Candidate.COLUMN_C_Invoice_Candidate_ID);\n \n \t\treturn icQueryBuilder\n+\t\t\t\t.create()\n+\t\t\t\t.list();//\n+\t}\n+\n+\t@NonNull\n+\tpublic List<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId)\n+\t{\n+\t\tfinal I_C_Invoice invoice = load(invoiceId, I_C_Invoice.class);\n+\n+\t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n+\t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n+\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoice.getC_Invoice_ID())\n+\t\t\t\t\t\t//collect invoice line alloc\n+\t\t\t\t\t\t.andCollectChildren(I_C_Invoice_Line_Alloc.COLUMN_C_InvoiceLine_ID)\n+\t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t\t\t.create();", "originalCommit": "33ed08604311dea0994a05fc18dcaca20dcbfe93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3OTM5OA==", "url": "https://github.com/metasfresh/metasfresh/pull/6828#discussion_r439279398", "bodyText": "Oh, just checked the method, that's pretty cool, I'll give it a try. thx!", "author": "pvpurcarcosmin", "createdAt": "2020-06-12T08:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI3NDQ3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "2cdfd09f3ceb3acf317b7a298bc3fb5ade3cad11", "chunk": "diff --git a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\nindex b8973c351d..cae814f81a 100644\n--- a/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\n+++ b/backend/de.metas.swat/de.metas.swat.base/src/main/java/de/metas/invoicecandidate/api/impl/InvoiceCandDAO.java\n\n@@ -579,25 +577,16 @@ public class InvoiceCandDAO implements IInvoiceCandDAO\n \t@NonNull\n \tpublic List<I_C_Invoice_Candidate> retrieveInvoiceCandidates(@NonNull final InvoiceId invoiceId)\n \t{\n-\t\tfinal I_C_Invoice invoice = load(invoiceId, I_C_Invoice.class);\n-\n-\t\tfinal IQuery<I_C_Invoice_Line_Alloc> invoiceLineAllocQuery =\n-\t\t\t\tqueryBL.createQueryBuilder(I_C_InvoiceLine.class, invoice)\n-\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoice.getC_Invoice_ID())\n-\t\t\t\t\t\t//collect invoice line alloc\n+\t\treturn queryBL.createQueryBuilder(I_C_InvoiceLine.class)\n+\t\t\t\t\t\t.addEqualsFilter(I_C_InvoiceLine.COLUMNNAME_C_Invoice_ID, invoiceId)\n+\t\t\t\t\t\t//collect related invoice line alloc\n \t\t\t\t\t\t.andCollectChildren(I_C_Invoice_Line_Alloc.COLUMN_C_InvoiceLine_ID)\n \t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t\t\t.create();\n-\n-\t\treturn queryBL\n-\t\t\t\t.createQueryBuilder(I_C_Invoice_Candidate.class, invoice)\n-\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t.addInSubQueryFilter()\n-\t\t\t\t.subQuery(invoiceLineAllocQuery)\n-\t\t\t\t.matchingColumnNames(I_C_Invoice_Candidate.COLUMNNAME_C_Invoice_Candidate_ID, I_C_Invoice_Line_Alloc.COLUMNNAME_C_Invoice_Candidate_ID)\n-\t\t\t\t.end()\n-\t\t\t\t.create()\n-\t\t\t\t.list();\n+\t\t\t\t\t\t//collect related invoice candidates\n+\t\t\t\t        .andCollect(I_C_Invoice_Line_Alloc.COLUMN_C_Invoice_Candidate_ID)\n+\t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t\t\t.create()\n+\t\t\t\t        .list();\n \t}\n \n \t@Override\n"}}, {"oid": "2cdfd09f3ceb3acf317b7a298bc3fb5ade3cad11", "url": "https://github.com/metasfresh/metasfresh/commit/2cdfd09f3ceb3acf317b7a298bc3fb5ade3cad11", "message": "req changes\nhttps://github.com/metasfresh/metasfresh/issues/6827", "committedDate": "2020-06-12T09:53:34Z", "type": "commit"}]}