{"pr_number": 7090, "pr_title": "Show in Main and Grid view that a Notice/Comment is available #7089", "pr_createdAt": "2020-08-04T06:26:12Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/7090", "timeline": [{"oid": "555772f43f73ce25ade9ecac667eeae1b335d437", "url": "https://github.com/metasfresh/metasfresh/commit/555772f43f73ce25ade9ecac667eeae1b335d437", "message": "Add field `JSONViewRow.HasComments`\n\nIf true this record has at least a comment\nIf false or missing this row does not have any comments\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:02:00Z", "type": "commit"}, {"oid": "5a3213856cdec8dd597f21ad8739631a835f3167", "url": "https://github.com/metasfresh/metasfresh/commit/5a3213856cdec8dd597f21ad8739631a835f3167", "message": "Add `CommentEntryRepository.hasComments`\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:02:00Z", "type": "commit"}, {"oid": "841965da61beb53237f036826400ab61297bbf78", "url": "https://github.com/metasfresh/metasfresh/commit/841965da61beb53237f036826400ab61297bbf78", "message": "Fix sql query for `CommentEntryRepository.hasComments`\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:02:00Z", "type": "commit"}, {"oid": "9ff7d8ad392f099ce87e019491767bb3ab9212e9", "url": "https://github.com/metasfresh/metasfresh/commit/9ff7d8ad392f099ce87e019491767bb3ab9212e9", "message": "Grid view: Add `JSONViewRow.hasComments` and set it using data from CommentsService\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:03:14Z", "type": "commit"}, {"oid": "b74e66de0cf38cf0347b0c9c3ff3e4d16990be47", "url": "https://github.com/metasfresh/metasfresh/commit/b74e66de0cf38cf0347b0c9c3ff3e4d16990be47", "message": "Single view: Add `JSONDocument.hasComments` and set it using data from CommentsService\n\nFor single view we are interested in RootDocuments only.\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:03:23Z", "type": "commit"}, {"oid": "6f92c0db3309c2c1a41d6fb507ba4d622296dd77", "url": "https://github.com/metasfresh/metasfresh/commit/6f92c0db3309c2c1a41d6fb507ba4d622296dd77", "message": "Fix warnings\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:03:23Z", "type": "commit"}, {"oid": "4e30b0b9305c8324ec19856d6878e1ac455baca3", "url": "https://github.com/metasfresh/metasfresh/commit/4e30b0b9305c8324ec19856d6878e1ac455baca3", "message": "Add unit test\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:03:23Z", "type": "commit"}, {"oid": "4e30b0b9305c8324ec19856d6878e1ac455baca3", "url": "https://github.com/metasfresh/metasfresh/commit/4e30b0b9305c8324ec19856d6878e1ac455baca3", "message": "Add unit test\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-04T13:03:23Z", "type": "forcePushed"}, {"oid": "421afa6b5f4aa8ec54e18c5a268007b36af11ef4", "url": "https://github.com/metasfresh/metasfresh/commit/421afa6b5f4aa8ec54e18c5a268007b36af11ef4", "message": "#7089 styling for the notification dot", "committedDate": "2020-08-04T14:20:19Z", "type": "commit"}, {"oid": "92a77b51f6dbedf0b99220cdfb1062903b2e6b61", "url": "https://github.com/metasfresh/metasfresh/commit/92a77b51f6dbedf0b99220cdfb1062903b2e6b61", "message": "#7089 show notifications dot", "committedDate": "2020-08-04T14:20:19Z", "type": "commit"}, {"oid": "3befd20da835ca8d0daf657e9f6f23e3158d7b7d", "url": "https://github.com/metasfresh/metasfresh/commit/3befd20da835ca8d0daf657e9f6f23e3158d7b7d", "message": "#7089 update unit tests", "committedDate": "2020-08-04T14:20:19Z", "type": "commit"}, {"oid": "2de7585badf3459fdc3418d4118e20ca562afe71", "url": "https://github.com/metasfresh/metasfresh/commit/2de7585badf3459fdc3418d4118e20ca562afe71", "message": "#7089 remove the notification dot from the header dropdown", "committedDate": "2020-08-05T09:13:18Z", "type": "commit"}, {"oid": "a69e918e9a0601e0777753fe9486af3f60fe40a2", "url": "https://github.com/metasfresh/metasfresh/commit/a69e918e9a0601e0777753fe9486af3f60fe40a2", "message": "#7089 fix setting `hasComments` value in the store on saving", "committedDate": "2020-08-05T09:13:36Z", "type": "commit"}, {"oid": "a63886754dc5995b07c77e8b70a50c9b5afb9048", "url": "https://github.com/metasfresh/metasfresh/commit/a63886754dc5995b07c77e8b70a50c9b5afb9048", "message": "`DocumentDescriptorFactory` throws error when creating TableRecordReference from String\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T08:57:11Z", "type": "commit"}, {"oid": "3fabe15a9bb0eba373523fd4022264171784767d", "url": "https://github.com/metasfresh/metasfresh/commit/3fabe15a9bb0eba373523fd4022264171784767d", "message": "`CommentsService` handle nulls and empty values\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T08:57:38Z", "type": "commit"}, {"oid": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "url": "https://github.com/metasfresh/metasfresh/commit/5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "message": "`CommentsService`: receive DocumentPath when creating or listing the Comments\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T09:11:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTg5MA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466319890", "bodyText": "pls use the return value of this function instead of stressing the cache for each value...", "author": "teosarca", "createdAt": "2020-08-06T10:32:39Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java", "diffHunk": "@@ -89,6 +108,17 @@ public void createCommentEntry(final @NonNull String characterData, @NonNull fin\n \t\t\t\t.collect(GuavaCollectors.toImmutableList());\n \t}\n \n+\t@NonNull\n+\tpublic Map<TableRecordReference, Boolean> hasComments(@NonNull final Collection<TableRecordReference> references)\n+\t{\n+\t\tfinal ImmutableMap.Builder<TableRecordReference, Boolean> result = ImmutableMap.builder();\n+\n+\t\treferenceHasCommentsCache.getAllOrLoad(references, this::checkReferenceHasComments);", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NDU1Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466374556", "bodyText": "getAllOrLoad returns a collection of booleans, and their order is not guaranteed.\nI can't really use the return value of the function call, because i cannot match the TRR with the respective result.", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTYxNg==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466419616", "bodyText": "clarified with teo. it's fine like this", "author": "TheBestPessimist", "createdAt": "2020-08-06T13:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNDEzMw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466904133", "bodyText": "no no, pls:\n\nintroduce ReferenceSummary private static class\nrename referenceHasCommentsCache to referenceSummaryCache\n\nthen u will be able to use it something like\nList<ReferenceComment> referenceSummaryList = referenceHasCommentsCache.getAllOrLoad(references, this::checkReferenceHasComments);\n\nreturn referenceSummaryList.stream()\n.collect(ImmutableMap.toImmutableMap(ReferenceComment::getRecordRef, ReferenceComment::hasComments));", "author": "teosarca", "createdAt": "2020-08-07T08:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMTk5OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466931999", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-07T09:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxOTg5MA=="}], "type": "inlineReview", "revised_code": {"commit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "chunk": "diff --git a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\nindex 7c3e922e43..59f3361581 100644\n--- a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n+++ b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n\n@@ -111,12 +112,13 @@ public class CommentEntryRepository\n \t@NonNull\n \tpublic Map<TableRecordReference, Boolean> hasComments(@NonNull final Collection<TableRecordReference> references)\n \t{\n-\t\tfinal ImmutableMap.Builder<TableRecordReference, Boolean> result = ImmutableMap.builder();\n+\t\t// Implementation detail: use a hash map to protect against duplicate keys\n+\t\tfinal HashMap<TableRecordReference, Boolean> result = new HashMap<>();\n \n \t\treferenceHasCommentsCache.getAllOrLoad(references, this::checkReferenceHasComments);\n \t\treferences.forEach(trr -> result.put(trr, referenceHasCommentsCache.get(trr, (Supplier<Boolean>)() -> Boolean.FALSE)));\n \n-\t\treturn result.build();\n+\t\treturn ImmutableMap.copyOf(result);\n \t}\n \n \t@NonNull\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMDIyMg==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466320222", "bodyText": "better just invalidate the cache for that tableRecordReference.\nkeep in mind that ur method is executed in trx...", "author": "teosarca", "createdAt": "2020-08-06T10:33:17Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java", "diffHunk": "@@ -67,6 +84,8 @@ public void createCommentEntry(final @NonNull String characterData, @NonNull fin\n \t\tchatEntry.setCharacterData(characterData);\n \t\tchatEntry.setChatEntryType(X_CM_ChatEntry.CHATENTRYTYPE_NoteFlat);\n \t\tInterfaceWrapperHelper.save(chatEntry);\n+\n+\t\treferenceHasCommentsCache.put(tableRecordReference, true);", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NTM2NA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466375364", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:27:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMDIyMg=="}], "type": "inlineReview", "revised_code": {"commit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "chunk": "diff --git a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\nindex 7c3e922e43..59f3361581 100644\n--- a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n+++ b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n\n@@ -85,7 +86,7 @@ public class CommentEntryRepository\n \t\tchatEntry.setChatEntryType(X_CM_ChatEntry.CHATENTRYTYPE_NoteFlat);\n \t\tInterfaceWrapperHelper.save(chatEntry);\n \n-\t\treferenceHasCommentsCache.put(tableRecordReference, true);\n+\t\treferenceHasCommentsCache.remove(tableRecordReference);\n \t}\n \n \t@NonNull\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMDM3NA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466320374", "bodyText": "that's a bit too much. IMHO 1000 would be sufficient.", "author": "teosarca", "createdAt": "2020-08-06T10:33:38Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java", "diffHunk": "@@ -57,6 +67,13 @@\n \tprivate final IQueryBL queryBL = Services.get(IQueryBL.class);\n \tprivate final IADTableDAO tableDAO = Services.get(IADTableDAO.class);\n \n+\tprivate final CCache<TableRecordReference, Boolean> referenceHasCommentsCache = CCache.<TableRecordReference, Boolean>builder()\n+\t\t\t.cacheName(\"referenceHasCommentsCache\")\n+\t\t\t.cacheMapType(CCache.CacheMapType.LRU)\n+\t\t\t.initialCapacity(10_000)", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NTUwNg==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466375506", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMDM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "chunk": "diff --git a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\nindex 7c3e922e43..59f3361581 100644\n--- a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n+++ b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n\n@@ -70,7 +71,7 @@ public class CommentEntryRepository\n \tprivate final CCache<TableRecordReference, Boolean> referenceHasCommentsCache = CCache.<TableRecordReference, Boolean>builder()\n \t\t\t.cacheName(\"referenceHasCommentsCache\")\n \t\t\t.cacheMapType(CCache.CacheMapType.LRU)\n-\t\t\t.initialCapacity(10_000)\n+\t\t\t.initialCapacity(1_000)\n \t\t\t.tableName(I_CM_Chat.Table_Name)\n \t\t\t.build();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTEyMw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466321123", "bodyText": "instead of tablesForRecords i would call it recordIdsByTableId", "author": "teosarca", "createdAt": "2020-08-06T10:35:05Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java", "diffHunk": "@@ -131,10 +161,45 @@ private CommentEntryParentId getOrCreateParent(final @NonNull TableRecordReferen\n \tprivate CommentEntryParentId getParentIdOrNull(final @NonNull TableRecordReference tableRecordReference)\n \t{\n \t\treturn queryBL.createQueryBuilder(I_CM_Chat.class)\n+\t\t\t\t.addOnlyActiveRecordsFilter()\n \t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableRecordReference.getAD_Table_ID())\n \t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_Record_ID, tableRecordReference.getRecord_ID())\n \t\t\t\t.orderBy(I_CM_Chat.COLUMNNAME_CM_Chat_ID)\n \t\t\t\t.create()\n \t\t\t\t.firstId(CommentEntryParentId::ofRepoIdOrNull);\n \t}\n+\n+\t@NonNull\n+\tprivate Map<TableRecordReference, Boolean> checkReferenceHasComments(@NonNull final Collection<TableRecordReference> referencesUnknownStatus)\n+\t{\n+\t\tfinal ImmutableListMultimap<Integer, Integer> tablesForRecords = referencesUnknownStatus.stream()", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NjE3OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466376179", "bodyText": "That's a better name. Done", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "chunk": "diff --git a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\nindex 7c3e922e43..59f3361581 100644\n--- a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n+++ b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n\n@@ -172,26 +174,22 @@ public class CommentEntryRepository\n \t@NonNull\n \tprivate Map<TableRecordReference, Boolean> checkReferenceHasComments(@NonNull final Collection<TableRecordReference> referencesUnknownStatus)\n \t{\n-\t\tfinal ImmutableListMultimap<Integer, Integer> tablesForRecords = referencesUnknownStatus.stream()\n+\t\tfinal ImmutableListMultimap<Integer, Integer> recordIdsByTableId = referencesUnknownStatus.stream()\n \t\t\t\t.collect(ImmutableListMultimap.toImmutableListMultimap(TableRecordReference::getAD_Table_ID, TableRecordReference::getRecord_ID));\n \n-\t\t// first query returns nothing. Rest of the queries return the correct data\n-\t\tfinal IQuery<I_CM_Chat> query = queryBL.createQueryBuilder(I_CM_Chat.class)\n-\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_CM_Chat_ID, -1)\n-\t\t\t\t.create();\n-\n-\t\tfor (final Integer tableId : tablesForRecords.keySet())\n-\t\t{\n-\t\t\tfinal ImmutableList<Integer> recordIds = tablesForRecords.get(tableId);\n-\n-\t\t\tfinal IQuery<I_CM_Chat> q = queryBL.createQueryBuilder(I_CM_Chat.class)\n-\t\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableId)\n-\t\t\t\t\t.addInArrayFilter(I_CM_Chat.COLUMNNAME_Record_ID, recordIds)\n-\t\t\t\t\t.create();\n-\n-\t\t\tquery.addUnion(q, true);\n-\t\t}\n+\t\t@SuppressWarnings(\"OptionalGetWithoutIsPresent\")\n+\t\tfinal IQuery<I_CM_Chat> query = recordIdsByTableId.keySet().stream()\n+\t\t\t\t.map(tableId -> {\n+\t\t\t\t\tfinal ImmutableList<Integer> recordIds = recordIdsByTableId.get(tableId);\n+\n+\t\t\t\t\treturn queryBL.createQueryBuilder(I_CM_Chat.class)\n+\t\t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableId)\n+\t\t\t\t\t\t\t.addInArrayFilter(I_CM_Chat.COLUMNNAME_Record_ID, recordIds)\n+\t\t\t\t\t\t\t.create();\n+\t\t\t\t})\n+\t\t\t\t.reduce(IQuery.unionDistict())\n+\t\t\t\t.get();\n \n \t\tfinal Set<TableRecordReference> comments = query.list()\n \t\t\t\t.stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTQ5MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466321491", "bodyText": "but why?", "author": "teosarca", "createdAt": "2020-08-06T10:35:53Z", "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java", "diffHunk": "@@ -131,10 +161,45 @@ private CommentEntryParentId getOrCreateParent(final @NonNull TableRecordReferen\n \tprivate CommentEntryParentId getParentIdOrNull(final @NonNull TableRecordReference tableRecordReference)\n \t{\n \t\treturn queryBL.createQueryBuilder(I_CM_Chat.class)\n+\t\t\t\t.addOnlyActiveRecordsFilter()\n \t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableRecordReference.getAD_Table_ID())\n \t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_Record_ID, tableRecordReference.getRecord_ID())\n \t\t\t\t.orderBy(I_CM_Chat.COLUMNNAME_CM_Chat_ID)\n \t\t\t\t.create()\n \t\t\t\t.firstId(CommentEntryParentId::ofRepoIdOrNull);\n \t}\n+\n+\t@NonNull\n+\tprivate Map<TableRecordReference, Boolean> checkReferenceHasComments(@NonNull final Collection<TableRecordReference> referencesUnknownStatus)\n+\t{\n+\t\tfinal ImmutableListMultimap<Integer, Integer> tablesForRecords = referencesUnknownStatus.stream()\n+\t\t\t\t.collect(ImmutableListMultimap.toImmutableListMultimap(TableRecordReference::getAD_Table_ID, TableRecordReference::getRecord_ID));\n+\n+\t\t// first query returns nothing. Rest of the queries return the correct data\n+\t\tfinal IQuery<I_CM_Chat> query = queryBL.createQueryBuilder(I_CM_Chat.class)\n+\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_CM_Chat_ID, -1)", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTU1OQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466321559", "bodyText": ":(((", "author": "teosarca", "createdAt": "2020-08-06T10:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyODA2Nw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466428067", "bodyText": "Teo suggested to use .reduce(IQuery.unionDistict()).\nTIL", "author": "TheBestPessimist", "createdAt": "2020-08-06T13:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMTQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "chunk": "diff --git a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\nindex 7c3e922e43..59f3361581 100644\n--- a/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n+++ b/backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/comments/CommentEntryRepository.java\n\n@@ -172,26 +174,22 @@ public class CommentEntryRepository\n \t@NonNull\n \tprivate Map<TableRecordReference, Boolean> checkReferenceHasComments(@NonNull final Collection<TableRecordReference> referencesUnknownStatus)\n \t{\n-\t\tfinal ImmutableListMultimap<Integer, Integer> tablesForRecords = referencesUnknownStatus.stream()\n+\t\tfinal ImmutableListMultimap<Integer, Integer> recordIdsByTableId = referencesUnknownStatus.stream()\n \t\t\t\t.collect(ImmutableListMultimap.toImmutableListMultimap(TableRecordReference::getAD_Table_ID, TableRecordReference::getRecord_ID));\n \n-\t\t// first query returns nothing. Rest of the queries return the correct data\n-\t\tfinal IQuery<I_CM_Chat> query = queryBL.createQueryBuilder(I_CM_Chat.class)\n-\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_CM_Chat_ID, -1)\n-\t\t\t\t.create();\n-\n-\t\tfor (final Integer tableId : tablesForRecords.keySet())\n-\t\t{\n-\t\t\tfinal ImmutableList<Integer> recordIds = tablesForRecords.get(tableId);\n-\n-\t\t\tfinal IQuery<I_CM_Chat> q = queryBL.createQueryBuilder(I_CM_Chat.class)\n-\t\t\t\t\t.addOnlyActiveRecordsFilter()\n-\t\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableId)\n-\t\t\t\t\t.addInArrayFilter(I_CM_Chat.COLUMNNAME_Record_ID, recordIds)\n-\t\t\t\t\t.create();\n-\n-\t\t\tquery.addUnion(q, true);\n-\t\t}\n+\t\t@SuppressWarnings(\"OptionalGetWithoutIsPresent\")\n+\t\tfinal IQuery<I_CM_Chat> query = recordIdsByTableId.keySet().stream()\n+\t\t\t\t.map(tableId -> {\n+\t\t\t\t\tfinal ImmutableList<Integer> recordIds = recordIdsByTableId.get(tableId);\n+\n+\t\t\t\t\treturn queryBL.createQueryBuilder(I_CM_Chat.class)\n+\t\t\t\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t\t\t\t.addEqualsFilter(I_CM_Chat.COLUMNNAME_AD_Table_ID, tableId)\n+\t\t\t\t\t\t\t.addInArrayFilter(I_CM_Chat.COLUMNNAME_Record_ID, recordIds)\n+\t\t\t\t\t\t\t.create();\n+\t\t\t\t})\n+\t\t\t\t.reduce(IQuery.unionDistict())\n+\t\t\t\t.get();\n \n \t\tfinal Set<TableRecordReference> comments = query.list()\n \t\t\t\t.stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMjg2OA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466322868", "bodyText": "avoid using mutable objects as constants", "author": "teosarca", "createdAt": "2020-08-06T10:38:51Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,104 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n+import javax.annotation.Nullable;\n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n+import java.util.IdentityHashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final IdentityHashMap<IViewRow, Boolean> NO_COMMENTS = new IdentityHashMap<>(0);", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyODEyMw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466328123", "bodyText": "for me now it becomes obvious that\n\ninstead of IdentityHashMap<IViewRow, Boolean> we shall introduce our ViewRowComments class\ninside ViewRowComments avoid, instead of indexing by IViewRow, indexing by row id's would be sufficient (DocumentId)\navoid indexing by fat objects by all means\nmake sure ViewRowComments it's immutable (i.e. use ImmutbleMap inside it)", "author": "teosarca", "createdAt": "2020-08-06T10:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMjg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5OTE0MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466399141", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-06T13:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMjg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "75871a890a7e518b2e0fb545caccb69d509af85d", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 241b42ab49..4d0635b660 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -29,6 +29,7 @@ import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMzEzNA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466323134", "bodyText": "why not @NonNull row?", "author": "teosarca", "createdAt": "2020-08-06T10:39:26Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,104 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n+import javax.annotation.Nullable;\n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n+import java.util.IdentityHashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final IdentityHashMap<IViewRow, Boolean> NO_COMMENTS = new IdentityHashMap<>(0);\n+\n+\tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n+\t\tthis.documentDescriptorFactory = documentDescriptorFactory;\n+\t}\n+\n+\t@NonNull\n+\tpublic final IdentityHashMap<IViewRow, Boolean> hasComments(@Nullable final IViewRow row)", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxOTc5NA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466419794", "bodyText": "at some point i got an error in a view, not sure where.", "author": "TheBestPessimist", "createdAt": "2020-08-06T13:40:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyMzEzNA=="}], "type": "inlineReview", "revised_code": {"commit": "75871a890a7e518b2e0fb545caccb69d509af85d", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 241b42ab49..4d0635b660 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -29,6 +29,7 @@ import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyNDEzMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466324131", "bodyText": "why Boolean object and not primitive boolean?", "author": "teosarca", "createdAt": "2020-08-06T10:41:22Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,104 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n+import javax.annotation.Nullable;\n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n+import java.util.IdentityHashMap;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final IdentityHashMap<IViewRow, Boolean> NO_COMMENTS = new IdentityHashMap<>(0);\n+\n+\tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n+\t\tthis.documentDescriptorFactory = documentDescriptorFactory;\n+\t}\n+\n+\t@NonNull\n+\tpublic final IdentityHashMap<IViewRow, Boolean> hasComments(@Nullable final IViewRow row)\n+\t{\n+\t\tif (row == null)\n+\t\t{\n+\t\t\treturn NO_COMMENTS;\n+\t\t}\n+\n+\t\treturn hasComments(Collections.singletonList(row));\n+\t}\n+\n+\t@NonNull\n+\tpublic final IdentityHashMap<IViewRow, Boolean> hasComments(@NonNull final Collection<? extends IViewRow> rows)\n+\t{\n+\t\tif (rows.isEmpty())\n+\t\t{\n+\t\t\treturn NO_COMMENTS;\n+\t\t}\n+\n+\t\tfinal ImmutableMap<IViewRow, TableRecordReference> rowsForReferences = rows.stream()\n+\t\t\t\t.flatMap(IViewRow::streamRecursive)\n+\t\t\t\t.flatMap(this::toStreamOfValidTableReferences)\n+\t\t\t\t.collect(GuavaCollectors.toImmutableMap());\n+\n+\t\tfinal Map<TableRecordReference, Boolean> referencesWithComments = commentEntryRepository.hasComments(rowsForReferences.values());\n+\n+\t\tfinal IdentityHashMap<IViewRow, Boolean> result = new IdentityHashMap<>();\n+\t\tfor (final IViewRow row : rows)\n+\t\t{\n+\t\t\tfinal TableRecordReference ref = rowsForReferences.get(row);\n+\t\t\tresult.put(row, referencesWithComments.getOrDefault(ref, false));\n+\t\t}\n+\n+\t\treturn result;\n \t}\n \n \t@NonNull\n-\tpublic List<JSONComment> getCommentsFor(@NonNull final TableRecordReference tableRecordReference, final ZoneId zoneId)\n+\tpublic Boolean hasComments(@NonNull final DocumentPath documentPath)", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MzAyMw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466383023", "bodyText": "mistake", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyNDEzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "75871a890a7e518b2e0fb545caccb69d509af85d", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 241b42ab49..4d0635b660 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -29,6 +29,7 @@ import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyNTA0OA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466325048", "bodyText": "use our formatting... i.e. space after comma", "author": "teosarca", "createdAt": "2020-08-06T10:43:08Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/view/ViewRestController.java", "diffHunk": "@@ -214,7 +229,12 @@ public JSONViewResult deleteStickyFilter(\n \n \t\tfinal IView newView = viewsRepo.deleteStickyFilter(viewId, filterId);\n \t\tfinal JSONOptions jsonOpts = newJSONOptions();\n-\t\treturn JSONViewResult.of(ViewResult.ofView(newView), ViewRowOverridesHelper.getViewRowOverrides(newView), jsonOpts);\n+\t\tfinal ViewResult viewResult = ViewResult.ofView(newView);\n+\n+\t\tfinal List<IViewRow> rows = viewResult.isPageLoaded() ? viewResult.getPage() : Collections.emptyList();\n+\t\tfinal IdentityHashMap<IViewRow, Boolean> documentsWithComments = commentsService.hasComments(rows);\n+\n+\t\treturn JSONViewResult.of(viewResult, ViewRowOverridesHelper.getViewRowOverrides(newView), jsonOpts,documentsWithComments);", "originalCommit": "5d4800cb54cf788e2c0ca09b04a937ad09acec2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MzQ4MA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466383480", "bodyText": "Forgot to indent.", "author": "TheBestPessimist", "createdAt": "2020-08-06T12:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMyNTA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "75871a890a7e518b2e0fb545caccb69d509af85d", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/view/ViewRestController.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/view/ViewRestController.java\nindex 1723bbba1c..822050ea76 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/view/ViewRestController.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/view/ViewRestController.java\n\n@@ -232,9 +232,9 @@ public class ViewRestController\n \t\tfinal ViewResult viewResult = ViewResult.ofView(newView);\n \n \t\tfinal List<IViewRow> rows = viewResult.isPageLoaded() ? viewResult.getPage() : Collections.emptyList();\n-\t\tfinal IdentityHashMap<IViewRow, Boolean> documentsWithComments = commentsService.hasComments(rows);\n+\t\tfinal ViewRowComments documentsWithComments = commentsService.hasComments(rows);\n \n-\t\treturn JSONViewResult.of(viewResult, ViewRowOverridesHelper.getViewRowOverrides(newView), jsonOpts,documentsWithComments);\n+\t\treturn JSONViewResult.of(viewResult, ViewRowOverridesHelper.getViewRowOverrides(newView), jsonOpts, documentsWithComments);\n \t}\n \n \t@DeleteMapping(\"/{viewId}\")\n"}}, {"oid": "75871a890a7e518b2e0fb545caccb69d509af85d", "url": "https://github.com/metasfresh/metasfresh/commit/75871a890a7e518b2e0fb545caccb69d509af85d", "message": "Introduce `ViewRowComments` which stores the list of rowIds and if they have comments or not.\n\nNo longer passing around a Map with this data, but using a proper object\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T13:53:38Z", "type": "commit"}, {"oid": "4cd09f5311f18a49c4cce2688eb27f5c6b06d939", "url": "https://github.com/metasfresh/metasfresh/commit/4cd09f5311f18a49c4cce2688eb27f5c6b06d939", "message": "`DocumentDescriptorFactory`: handle string window id\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T13:54:00Z", "type": "commit"}, {"oid": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "url": "https://github.com/metasfresh/metasfresh/commit/5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "message": "Refactor query\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-06T13:54:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNDY1MA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466904650", "bodyText": "awhy not getComments?", "author": "teosarca", "createdAt": "2020-08-07T08:40:17Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,97 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());\n+\n+\tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n+\t\tthis.documentDescriptorFactory = documentDescriptorFactory;\n+\t}\n+\n+\t@NonNull\n+\tpublic final ViewRowComments hasComments(@NonNull final IViewRow row)\n+\t{\n+\t\treturn hasComments(Collections.singletonList(row));\n \t}\n \n \t@NonNull\n-\tpublic List<JSONComment> getCommentsFor(@NonNull final TableRecordReference tableRecordReference, final ZoneId zoneId)\n+\tpublic final ViewRowComments hasComments(@NonNull final Collection<? extends IViewRow> rows)", "originalCommit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMjk3MQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466932971", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-07T09:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNDY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "d88c5572d6f6305bd788a6820e659bcd31fd10d0", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 4d0635b660..bce3686224 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -57,8 +57,6 @@ public class CommentsService\n \tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());\n-\n \tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNDczNw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466904737", "bodyText": "why not getComments?", "author": "teosarca", "createdAt": "2020-08-07T08:40:26Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,97 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());\n+\n+\tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n+\t\tthis.documentDescriptorFactory = documentDescriptorFactory;\n+\t}\n+\n+\t@NonNull\n+\tpublic final ViewRowComments hasComments(@NonNull final IViewRow row)", "originalCommit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMzAwOA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466933008", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-07T09:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNDczNw=="}], "type": "inlineReview", "revised_code": {"commit": "d88c5572d6f6305bd788a6820e659bcd31fd10d0", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 4d0635b660..bce3686224 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -57,8 +57,6 @@ public class CommentsService\n \tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());\n-\n \tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNTQ3Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466905476", "bodyText": "pls decide if u want @Value or @Data :)\ni would go with @Value", "author": "teosarca", "createdAt": "2020-08-07T08:41:51Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/ViewRowComments.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.comments;\n+\n+import com.google.common.collect.ImmutableMap;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import lombok.Data;\n+import lombok.NonNull;\n+import lombok.Value;\n+\n+import java.util.Map;\n+\n+@Value\n+@Data\n+public class ViewRowComments", "originalCommit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMzE5Nw==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466933197", "bodyText": "Value is correct", "author": "TheBestPessimist", "createdAt": "2020-08-07T09:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNTQ3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "d88c5572d6f6305bd788a6820e659bcd31fd10d0", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/ViewRowComments.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/ViewRowComments.java\nindex fb2f4b0eb3..24713c59e7 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/ViewRowComments.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/ViewRowComments.java\n\n@@ -24,18 +24,18 @@ package de.metas.ui.web.comments;\n \n import com.google.common.collect.ImmutableMap;\n import de.metas.ui.web.window.datatypes.DocumentId;\n-import lombok.Data;\n import lombok.NonNull;\n import lombok.Value;\n \n import java.util.Map;\n \n @Value\n-@Data\n public class ViewRowComments\n {\n \tImmutableMap<DocumentId, Boolean> documentsWithComments;\n \n+\tpublic static final ViewRowComments EMPTY = new ViewRowComments(ImmutableMap.of());\n+\n \tpublic static ViewRowComments of(@NonNull final Map<DocumentId, Boolean> documentsWithComments)\n \t{\n \t\treturn new ViewRowComments(ImmutableMap.copyOf(documentsWithComments));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNzk4NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466907985", "bodyText": "pls move it to ViewRowComments and call it EMPTY", "author": "teosarca", "createdAt": "2020-08-07T08:46:49Z", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java", "diffHunk": "@@ -22,37 +22,97 @@\n \n package de.metas.ui.web.comments;\n \n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n import de.metas.comments.CommentEntry;\n import de.metas.comments.CommentEntryRepository;\n import de.metas.ui.web.comments.json.JSONComment;\n import de.metas.ui.web.comments.json.JSONCommentCreateRequest;\n+import de.metas.ui.web.view.IViewRow;\n+import de.metas.ui.web.window.datatypes.DocumentId;\n+import de.metas.ui.web.window.datatypes.DocumentPath;\n import de.metas.ui.web.window.datatypes.json.DateTimeConverters;\n+import de.metas.ui.web.window.descriptor.factory.DocumentDescriptorFactory;\n import de.metas.user.api.IUserDAO;\n import de.metas.util.GuavaCollectors;\n+import de.metas.util.ImmutableMapEntry;\n import de.metas.util.Services;\n import lombok.NonNull;\n import org.adempiere.util.lang.impl.TableRecordReference;\n import org.springframework.stereotype.Service;\n \n import java.time.ZoneId;\n+import java.util.Collection;\n+import java.util.Collections;\n import java.util.Comparator;\n import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n \n @Service\n public class CommentsService\n {\n \tprivate final CommentEntryRepository commentEntryRepository;\n+\tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic CommentsService(final CommentEntryRepository commentEntryRepository)\n+\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());", "originalCommit": "5ca5b29a6bad32dbf89a63dadfe80f660d4435c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkzMzIzOA==", "url": "https://github.com/metasfresh/metasfresh/pull/7090#discussion_r466933238", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-07T09:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwNzk4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d88c5572d6f6305bd788a6820e659bcd31fd10d0", "chunk": "diff --git a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\nindex 4d0635b660..bce3686224 100644\n--- a/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n+++ b/backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/comments/CommentsService.java\n\n@@ -57,8 +57,6 @@ public class CommentsService\n \tprivate final DocumentDescriptorFactory documentDescriptorFactory;\n \tfinal IUserDAO userDAO = Services.get(IUserDAO.class);\n \n-\tpublic static final ViewRowComments NO_COMMENTS = ViewRowComments.of(ImmutableMap.of());\n-\n \tpublic CommentsService(final CommentEntryRepository commentEntryRepository, final DocumentDescriptorFactory documentDescriptorFactory)\n \t{\n \t\tthis.commentEntryRepository = commentEntryRepository;\n"}}, {"oid": "d88c5572d6f6305bd788a6820e659bcd31fd10d0", "url": "https://github.com/metasfresh/metasfresh/commit/d88c5572d6f6305bd788a6820e659bcd31fd10d0", "message": "Fixes and refactorings\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-07T09:40:16Z", "type": "commit"}, {"oid": "3333ef54f6a9929ddc1cdced59070190113d52b2", "url": "https://github.com/metasfresh/metasfresh/commit/3333ef54f6a9929ddc1cdced59070190113d52b2", "message": "Merge branch 'master' into gh7089-comment-is-available", "committedDate": "2020-08-07T11:43:15Z", "type": "commit"}, {"oid": "29474647bc3c231586c9e9f922c817ecd2a69259", "url": "https://github.com/metasfresh/metasfresh/commit/29474647bc3c231586c9e9f922c817ecd2a69259", "message": "QA", "committedDate": "2020-08-07T12:45:24Z", "type": "commit"}, {"oid": "a027dce53f47929caa05d70bb18895d77d35277c", "url": "https://github.com/metasfresh/metasfresh/commit/a027dce53f47929caa05d70bb18895d77d35277c", "message": "Fixes and refactorings\n\nhttps://github.com/metasfresh/metasfresh/issues/7089", "committedDate": "2020-08-10T05:31:11Z", "type": "commit"}]}