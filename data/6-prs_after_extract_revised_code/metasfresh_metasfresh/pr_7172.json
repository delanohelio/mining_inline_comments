{"pr_number": 7172, "pr_title": "Allow allocation of Prepay Sales Orders ", "pr_createdAt": "2020-08-20T12:57:29Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/7172", "timeline": [{"oid": "e470308cf16f3f85ed58c719fd26559e8cc00e35", "url": "https://github.com/metasfresh/metasfresh/commit/e470308cf16f3f85ed58c719fd26559e8cc00e35", "message": "Add method for retrieving Payment.ExternalOrderId\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-20T13:00:29Z", "type": "commit"}, {"oid": "c680aca7360c3d65ca685e13e4de71cbd0e0847a", "url": "https://github.com/metasfresh/metasfresh/commit/c680aca7360c3d65ca685e13e4de71cbd0e0847a", "message": "Allow allocation of Prepay Sales Orders\n\nWe already allow payment allocation of Sales Order with DocType Prepay.\nWe want to allow allocation for Sales Orders which are of DocType Sales Order and have a payment with matching external ID\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-20T13:00:42Z", "type": "commit"}, {"oid": "c680aca7360c3d65ca685e13e4de71cbd0e0847a", "url": "https://github.com/metasfresh/metasfresh/commit/c680aca7360c3d65ca685e13e4de71cbd0e0847a", "message": "Allow allocation of Prepay Sales Orders\n\nWe already allow payment allocation of Sales Order with DocType Prepay.\nWe want to allow allocation for Sales Orders which are of DocType Sales Order and have a payment with matching external ID\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-20T13:00:42Z", "type": "forcePushed"}, {"oid": "6dab36be660cdc4907361aecfa7e410bcd5fe61e", "url": "https://github.com/metasfresh/metasfresh/commit/6dab36be660cdc4907361aecfa7e410bcd5fe61e", "message": "Add unit test\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-21T11:52:49Z", "type": "commit"}, {"oid": "c469b4675e5c62add9a6a006eda8bc6875005b87", "url": "https://github.com/metasfresh/metasfresh/commit/c469b4675e5c62add9a6a006eda8bc6875005b87", "message": "Fix small derps\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-21T11:59:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NTUxNA==", "url": "https://github.com/metasfresh/metasfresh/pull/7172#discussion_r475345514", "bodyText": "not a critical request, but please extract Services.get(...) to a field, so that the services are all visible at the class beginning and not stashed away in the code", "author": "metas-ts", "createdAt": "2020-08-24T05:08:58Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -294,12 +297,34 @@ private void linkInvoiceToPaymentIfNeeded(final I_C_Invoice invoice)\n \t\t}\n \t}\n \n+\t@VisibleForTesting\n+\tstatic boolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n+\t{\n+\t\tif (order == null)\n+\t\t{\n+\t\t\treturn false;\n+\t\t}\n+\t\tif (order.getC_Payment_ID() <= 0)\n+\t\t{\n+\t\t\treturn false;\n+\t\t}\n+\n+\t\tfinal boolean isPrepayOrder = Services.get(IDocTypeBL.class).isPrepay(DocTypeId.ofRepoId(order.getC_DocType_ID()));", "originalCommit": "c469b4675e5c62add9a6a006eda8bc6875005b87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NTY1MA==", "url": "https://github.com/metasfresh/metasfresh/pull/7172#discussion_r475455650", "bodyText": "done", "author": "TheBestPessimist", "createdAt": "2020-08-24T09:20:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NTUxNA=="}], "type": "inlineReview", "revised_code": {"commit": "d79e1432a3c4bdba9b610a91dc7636e22d544daf", "chunk": "diff --git a/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java b/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\nindex 79998f486a..6ed2ad2434 100644\n--- a/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\n+++ b/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\n\n@@ -298,7 +298,7 @@ public class C_Invoice // 03771\n \t}\n \n \t@VisibleForTesting\n-\tstatic boolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n+\tboolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n \t{\n \t\tif (order == null)\n \t\t{\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NzI2NQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7172#discussion_r475347265", "bodyText": "\u2757 why do the external IDs have to match? Mark doesn't know, maybe you discussed this with @metasnw ?\nTo put it differently:\n\nyou have a sales order that reverences a payment.\nyou invoice this sales order\n=> why not allocate the sales order's payment to the invoice?\n\nIf you need to keep it like this, please add it to the documentation of C_Order.C_Payment_ID, 'C_Order.ExternalIdandC_Payment.ExternalOrderId`, because i think it's intuitive to \"forward\" the referenced payment from the order..but if it's only forwarded if the external-ids match, then this needs to be be documented.", "author": "metas-ts", "createdAt": "2020-08-24T05:15:24Z", "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -294,12 +297,34 @@ private void linkInvoiceToPaymentIfNeeded(final I_C_Invoice invoice)\n \t\t}\n \t}\n \n+\t@VisibleForTesting\n+\tstatic boolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n+\t{\n+\t\tif (order == null)\n+\t\t{\n+\t\t\treturn false;\n+\t\t}\n+\t\tif (order.getC_Payment_ID() <= 0)\n+\t\t{\n+\t\t\treturn false;\n+\t\t}\n+\n+\t\tfinal boolean isPrepayOrder = Services.get(IDocTypeBL.class).isPrepay(DocTypeId.ofRepoId(order.getC_DocType_ID()));\n+\t\tif (isPrepayOrder)\n+\t\t{\n+\t\t\treturn true;\n+\t\t}\n+\n+\t\tfinal ExternalId paymentExternalId = Services.get(IPaymentDAO.class).getExternalId(PaymentId.ofRepoId(order.getC_Payment_ID()));", "originalCommit": "c469b4675e5c62add9a6a006eda8bc6875005b87", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NjAwMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/7172#discussion_r475456001", "bodyText": "confirmed with torby: we allow any payment linked to the Sales Order, not just those with matching external ID.", "author": "TheBestPessimist", "createdAt": "2020-08-24T09:21:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM0NzI2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d79e1432a3c4bdba9b610a91dc7636e22d544daf", "chunk": "diff --git a/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java b/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\nindex 79998f486a..6ed2ad2434 100644\n--- a/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\n+++ b/backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java\n\n@@ -298,7 +298,7 @@ public class C_Invoice // 03771\n \t}\n \n \t@VisibleForTesting\n-\tstatic boolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n+\tboolean canAllocateOrderPaymentToInvoice(final I_C_Order order)\n \t{\n \t\tif (order == null)\n \t\t{\n"}}, {"oid": "d79e1432a3c4bdba9b610a91dc7636e22d544daf", "url": "https://github.com/metasfresh/metasfresh/commit/d79e1432a3c4bdba9b610a91dc7636e22d544daf", "message": "Allow allocation as long as there is a link c_Order <-> Payment and ignore `externalID` from checks\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-24T07:30:06Z", "type": "commit"}, {"oid": "d9145496acc65877ef8b84d3bd5ce81924c79e3b", "url": "https://github.com/metasfresh/metasfresh/commit/d9145496acc65877ef8b84d3bd5ce81924c79e3b", "message": "More cleanup + refactoring\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-24T07:30:24Z", "type": "commit"}, {"oid": "375a1adddbb0b94c9934c1ec10551ab783b80edc", "url": "https://github.com/metasfresh/metasfresh/commit/375a1adddbb0b94c9934c1ec10551ab783b80edc", "message": "Refine tests\n\nhttps://github.com/metasfresh/metasfresh/issues/7171", "committedDate": "2020-08-24T07:37:32Z", "type": "commit"}]}