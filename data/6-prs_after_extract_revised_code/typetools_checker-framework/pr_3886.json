{"pr_number": 3886, "pr_title": "Handle code that is not in a method; fixes #3884", "pr_createdAt": "2020-11-10T15:55:19Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3886", "timeline": [{"oid": "c77d331abdbf28286b6ce158ff29c74b15a5404c", "url": "https://github.com/typetools/checker-framework/commit/c77d331abdbf28286b6ce158ff29c74b15a5404c", "message": "Fix test for whether a tree has a receiver; fixes #3884", "committedDate": "2020-11-10T01:03:10Z", "type": "commit"}, {"oid": "b739b59bf56505ae08ad264fac367a3a199bdee8", "url": "https://github.com/typetools/checker-framework/commit/b739b59bf56505ae08ad264fac367a3a199bdee8", "message": "Handle synthetic trees", "committedDate": "2020-11-10T03:55:38Z", "type": "commit"}, {"oid": "65d5845522e05fc8344970f7821ec8637522bd8d", "url": "https://github.com/typetools/checker-framework/commit/65d5845522e05fc8344970f7821ec8637522bd8d", "message": "Merge ../checker-framework-branch-master into issue3884", "committedDate": "2020-11-10T15:53:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNDUzNg==", "url": "https://github.com/typetools/checker-framework/pull/3886#discussion_r520704536", "bodyText": "Shouldn't all code be within at least a class? Can we specify more clearly when this method can return null?\nIn the long term, we should probably think about checking for enclosing lambda's and field declarations and how to handle such trees.\nUpdate: TreeUtils.enclosingMethodOrLambda also seems relevant https://github.com/typetools/checker-framework/blob/master/javacutil/src/main/java/org/checkerframework/javacutil/TreeUtils.java#L330", "author": "wmdietl", "createdAt": "2020-11-10T16:37:22Z", "path": "framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java", "diffHunk": "@@ -1757,7 +1760,7 @@ public AnnotatedNullType getAnnotatedNullType(Set<? extends AnnotationMirror> an\n      * @param tree tree to whose inner most enclosing method or class is returned.\n      * @return the inner most enclosing method or class tree of {@code tree}\n      */\n-    protected Tree getEnclosingClassOrMethod(Tree tree) {\n+    protected @Nullable Tree getEnclosingClassOrMethod(Tree tree) {", "originalCommit": "65d5845522e05fc8344970f7821ec8637522bd8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNTYxNw==", "url": "https://github.com/typetools/checker-framework/pull/3886#discussion_r520705617", "bodyText": "You are right.  Thanks for catching my goof.  I will rework this.", "author": "mernst", "createdAt": "2020-11-10T16:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNDUzNg=="}], "type": "inlineReview", "revised_code": {"commit": "295a40d4019046d1e9c2ac6e821db6ee48c2984c", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java b/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\nindex 3d0286abd..28bc4cdcd 100644\n--- a/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\n+++ b/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\n\n@@ -1760,7 +1760,7 @@ public class AnnotatedTypeFactory implements AnnotationProvider {\n      * @param tree tree to whose inner most enclosing method or class is returned.\n      * @return the inner most enclosing method or class tree of {@code tree}\n      */\n-    protected @Nullable Tree getEnclosingClassOrMethod(Tree tree) {\n+    protected Tree getEnclosingClassOrMethod(Tree tree) {\n         TreePath path = getPath(tree);\n         Set<Tree.Kind> classAndMethodKinds = EnumSet.copyOf(TreeUtils.classTreeKinds());\n         classAndMethodKinds.add(Kind.METHOD);\n"}}, {"oid": "59772afe5c4750edfb6098f056bd6d74c4ac7fde", "url": "https://github.com/typetools/checker-framework/commit/59772afe5c4750edfb6098f056bd6d74c4ac7fde", "message": "Merge ../checker-framework-branch-master into issue3884", "committedDate": "2020-11-10T16:45:24Z", "type": "commit"}, {"oid": "295a40d4019046d1e9c2ac6e821db6ee48c2984c", "url": "https://github.com/typetools/checker-framework/commit/295a40d4019046d1e9c2ac6e821db6ee48c2984c", "message": "Don't return null from getEnclosingClassOrMethod", "committedDate": "2020-11-10T16:46:56Z", "type": "commit"}, {"oid": "78323cefd1a6b3eee265aae74f3172302d850df6", "url": "https://github.com/typetools/checker-framework/commit/78323cefd1a6b3eee265aae74f3172302d850df6", "message": "Correct fix.", "committedDate": "2020-11-10T18:13:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MDY0Nw==", "url": "https://github.com/typetools/checker-framework/pull/3886#discussion_r520770647", "bodyText": "I'm didn't see any easy way to mark them as static, but this could cause problems else where in the code.", "author": "smillst", "createdAt": "2020-11-10T18:14:58Z", "path": "javacutil/src/main/java/org/checkerframework/javacutil/ElementUtils.java", "diffHunk": "@@ -432,8 +432,11 @@ public static boolean hasReceiver(Element element) {\n             // A constructor can only have a receiver if the class it creates has an outer type.\n             TypeMirror t = element.getEnclosingElement().asType();\n             return TypesUtils.hasEnclosingType(t);\n-        } else if (element.getKind().isField()) {\n-            if (ElementUtils.isStatic(element)) {\n+        } else if (element.getKind() == ElementKind.FIELD) {\n+            if (ElementUtils.isStatic(element)\n+                    // Artificial fields in interfaces are not marked as static, so check that", "originalCommit": "78323cefd1a6b3eee265aae74f3172302d850df6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}