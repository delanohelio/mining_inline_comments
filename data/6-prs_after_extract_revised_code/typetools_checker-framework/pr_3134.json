{"pr_number": 3134, "pr_title": "Use `List<DiagMessage>` instead of `framework.source.Result`", "pr_createdAt": "2020-03-06T22:09:53Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3134", "timeline": [{"oid": "fabe38a5df70354361862b972dfb50fc26088ebc", "url": "https://github.com/typetools/checker-framework/commit/fabe38a5df70354361862b972dfb50fc26088ebc", "message": "Remove framework.source.Result class", "committedDate": "2020-03-06T21:53:05Z", "type": "commit"}, {"oid": "04d72fa06f6ea07a34de35ace1cbd0fc4148e3d5", "url": "https://github.com/typetools/checker-framework/commit/04d72fa06f6ea07a34de35ace1cbd0fc4148e3d5", "message": "Reduce differences from upstream", "committedDate": "2020-03-06T21:58:28Z", "type": "commit"}, {"oid": "9711608990e75d34658e1887bc88422d6868c8fa", "url": "https://github.com/typetools/checker-framework/commit/9711608990e75d34658e1887bc88422d6868c8fa", "message": "Extract DiagMessage from Result", "committedDate": "2020-03-06T22:06:15Z", "type": "commit"}, {"oid": "165b7a1f5ba6e5f5145c05d1b21c7b29841ffcc7", "url": "https://github.com/typetools/checker-framework/commit/165b7a1f5ba6e5f5145c05d1b21c7b29841ffcc7", "message": "Add changelog entry", "committedDate": "2020-03-06T22:09:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4MDQ5MQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389180491", "bodyText": "What do you think of introducing two methods reportError and reportWarning and discouraging the use of  the version with a javax.tools.Diagnostic.Kind dependency? That would make it easier to use the API, removing the need for many of the imports this PR adds.", "author": "wmdietl", "createdAt": "2020-03-06T22:46:17Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -879,71 +877,34 @@ public void typeProcess(TypeElement e, TreePath p) {\n     ///\n \n     /**\n-     * Reports a result. By default, it prints it to the screen via the compiler's internal messager\n-     * if the result is non-success; otherwise, the method returns with no side effects.\n+     * Reports a diagnostic message. By default, it prints it to the screen via the compiler's\n+     * internal messager; otherwise, the method returns with no side effects.\n      *\n-     * @param r the result to report\n-     * @param src the position object associated with the result; may be an Element, a Tree, or null\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param kind the type of message\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n      */\n-    public void report(final Result r, final Object src) {\n-        if (r.isSuccess()) {\n-            return;\n-        }\n+    public void report(", "originalCommit": "165b7a1f5ba6e5f5145c05d1b21c7b29841ffcc7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NjM2OQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389196369", "bodyText": "I considered that and thought this variant a bit cleaner.  But I'll change it to your suggestion.  You are right that it will limit the number of imports needed.", "author": "mernst", "createdAt": "2020-03-06T23:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4MDQ5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwMTU5OA==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389201598", "bodyText": "I have done this and I agree it's better.  Thanks for the suggestion.\nPlease go ahead and re-review.", "author": "mernst", "createdAt": "2020-03-07T00:13:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4MDQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "37eb34edefa53d8fd825fd988caa776afe850e64", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex 36d85d5a88..60724762e3 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -873,13 +874,40 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n     }\n \n     ///////////////////////////////////////////////////////////////////////////\n-    /// Reporting type-checking errors; the main entry point is report()\n+    /// Reporting type-checking errors; most clients use reportError() or reportWarning()\n     ///\n \n+    /**\n+     * Reports an error. By default, it prints it to the screen via the compiler's internal\n+     * messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n+     */\n+    public void reportError(Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, Diagnostic.Kind.ERROR, messageKey, args);\n+    }\n+\n+    /**\n+     * Reports a warning. By default, it prints it to the screen via the compiler's internal\n+     * messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n+     */\n+    public void reportWarning(\n+            Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, Diagnostic.Kind.MANDATORY_WARNING, messageKey, args);\n+    }\n+\n     /**\n      * Reports a diagnostic message. By default, it prints it to the screen via the compiler's\n      * internal messager; otherwise, the method returns with no side effects.\n      *\n+     * <p>Most clients should use {@link #reportError} or {@link #reportWarning}.\n+     *\n      * @param source the source position information; may be an Element, a Tree, or null\n      * @param kind the type of message\n      * @param messageKey the message key\n"}}, {"oid": "37eb34edefa53d8fd825fd988caa776afe850e64", "url": "https://github.com/typetools/checker-framework/commit/37eb34edefa53d8fd825fd988caa776afe850e64", "message": "Create reportError and createWarning methods", "committedDate": "2020-03-07T00:07:57Z", "type": "commit"}, {"oid": "e6da762308d012a2bdd3990bd57715e890f8fd76", "url": "https://github.com/typetools/checker-framework/commit/e6da762308d012a2bdd3990bd57715e890f8fd76", "message": "Make a method private", "committedDate": "2020-03-07T00:12:02Z", "type": "commit"}, {"oid": "ec9752b761aadde304f4af42f6dca88faf5ceb2f", "url": "https://github.com/typetools/checker-framework/commit/ec9752b761aadde304f4af42f6dca88faf5ceb2f", "message": "Change another use of report()", "committedDate": "2020-03-07T04:50:32Z", "type": "commit"}, {"oid": "dc8ed9c11976a55a52494709ec725d7849752bf4", "url": "https://github.com/typetools/checker-framework/commit/dc8ed9c11976a55a52494709ec725d7849752bf4", "message": "Remove import statements; will simplify a future refactoring", "committedDate": "2020-03-07T17:04:34Z", "type": "commit"}, {"oid": "460600352c4d8902a960a955c27242ee10fd1c86", "url": "https://github.com/typetools/checker-framework/commit/460600352c4d8902a960a955c27242ee10fd1c86", "message": "Merge ../checker-framework-branch-master into remove-result-class-2", "committedDate": "2020-03-09T04:23:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc0NDUwNg==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389744506", "bodyText": "I'm using the Result class in #2883 to collect multiple errors and report them once:\nhttps://github.com/typetools/checker-framework/pull/2883/files#diff-31033326203125d5a0af0323436d39f4R463\nSo, I would like to keep the class.\nI support changing the report methods so that you don't have to create a Result object only to pass it to this method.  I do think we should deprecate the previous methods though as this is a rather large breaking change.", "author": "smillst", "createdAt": "2020-03-09T14:56:28Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -875,75 +874,77 @@ public void typeProcess(TypeElement e, TreePath p) {\n     }\n \n     ///////////////////////////////////////////////////////////////////////////\n-    /// Reporting type-checking errors; the main entry point is report()\n+    /// Reporting type-checking errors; most clients use reportError() or reportWarning()\n     ///\n \n     /**\n-     * Reports a result. By default, it prints it to the screen via the compiler's internal messager\n-     * if the result is non-success; otherwise, the method returns with no side effects.\n+     * Reports an error. By default, prints it to the screen via the compiler's internal messager.\n      *\n-     * @param r the result to report\n-     * @param src the position object associated with the result; may be an Element, a Tree, or null\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n      */\n-    public void report(final Result r, final Object src) {\n-        if (r.isSuccess()) {\n-            return;\n-        }\n+    public void reportError(Object source, @CompilerMessageKey String messageKey, Object... args) {", "originalCommit": "460600352c4d8902a960a955c27242ee10fd1c86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg4NzQzNw==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389887437", "bodyText": "@smillst I deprecated the Result class instead of removing it.\nInstead of Result, use List<DiagMessage>.  (Currently a Result is essentially just a List<DiagMessage> plus some baggage.)\nThe refactoring is easy.  It's two commands in Emacs; I will make a pull request for you.  I'm happy to do it for any other branches or forks where people are concerned about merge conflicts.", "author": "mernst", "createdAt": "2020-03-09T18:41:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc0NDUwNg=="}], "type": "inlineReview", "revised_code": {"commit": "db7d3883bf1eaaab3f2418312499900d0ef6ebe5", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex 91572e270b..0a818d8042 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -877,6 +877,29 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n     /// Reporting type-checking errors; most clients use reportError() or reportWarning()\n     ///\n \n+    /**\n+     * Reports a result. By default, it prints it to the screen via the compiler's internal messager\n+     * if the result is non-success; otherwise, the method returns with no side effects.\n+     *\n+     * @param r the result to report\n+     * @param src the position object associated with the result; may be an Element, a Tree, or null\n+     * @deprecated use {@link #reportError} or {@link reportWarning} instead\n+     */\n+    @Deprecated // use {@link #reportError} or {@link reportWarning} instead\n+    public void report(final Result r, final Object src) {\n+        if (r.isSuccess()) {\n+            return;\n+        }\n+\n+        if (shouldSuppressWarnings(src, r.getMessageKeys().iterator().next())) {\n+            return;\n+        }\n+\n+        for (DiagMessage dmsg : r.getDiagMessages()) {\n+            report(src, dmsg);\n+        }\n+    }\n+\n     /**\n      * Reports an error. By default, prints it to the screen via the compiler's internal messager.\n      *\n"}}, {"oid": "441d06bbc162c8c7e9d1429e103c84d955b2f0ae", "url": "https://github.com/typetools/checker-framework/commit/441d06bbc162c8c7e9d1429e103c84d955b2f0ae", "message": "Add Javadoc", "committedDate": "2020-03-09T16:53:30Z", "type": "commit"}, {"oid": "26a1d41d1e1616839ee78fc41b77be260a31bf4b", "url": "https://github.com/typetools/checker-framework/commit/26a1d41d1e1616839ee78fc41b77be260a31bf4b", "message": "Fix Javadoc", "committedDate": "2020-03-09T17:15:54Z", "type": "commit"}, {"oid": "ce167674d64cf1ae5c201681debd99071c942b0e", "url": "https://github.com/typetools/checker-framework/commit/ce167674d64cf1ae5c201681debd99071c942b0e", "message": "Abstract out a method", "committedDate": "2020-03-09T17:20:54Z", "type": "commit"}, {"oid": "db7d3883bf1eaaab3f2418312499900d0ef6ebe5", "url": "https://github.com/typetools/checker-framework/commit/db7d3883bf1eaaab3f2418312499900d0ef6ebe5", "message": "Deprecate Result class rather than removing it", "committedDate": "2020-03-09T17:47:01Z", "type": "commit"}, {"oid": "a075693ab23b3ec1c2101ff912f42ee83808db32", "url": "https://github.com/typetools/checker-framework/commit/a075693ab23b3ec1c2101ff912f42ee83808db32", "message": "Javadoc fixes", "committedDate": "2020-03-09T21:00:20Z", "type": "commit"}, {"oid": "92ebe9e3037e22f30e0926f73a407fbb7cc2bdc0", "url": "https://github.com/typetools/checker-framework/commit/92ebe9e3037e22f30e0926f73a407fbb7cc2bdc0", "message": "Fix typo.", "committedDate": "2020-03-09T22:42:47Z", "type": "commit"}, {"oid": "fb367b2809394dd132762f763480c822ea1d0248", "url": "https://github.com/typetools/checker-framework/commit/fb367b2809394dd132762f763480c822ea1d0248", "message": "Fix typo.", "committedDate": "2020-03-09T22:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5NTkyNw==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389995927", "bodyText": "Shouldn't the uses of the deprecated Result be removed? Are these two methods at all useful?", "author": "wmdietl", "createdAt": "2020-03-09T22:27:37Z", "path": "checker/src/main/java/org/checkerframework/checker/formatter/FormatterTreeUtil.java", "diffHunk": "@@ -351,16 +351,26 @@ public Boolean visitNull(NullType t, Class<Void> p) {\n         }\n     }\n \n-    /** Reports an error. Takes a {@link Result} to report the location. */\n-    public final <E> void failure(Result<E> res, @CompilerMessageKey String msg, Object... args) {\n-        checker.report(\n-                org.checkerframework.framework.source.Result.failure(msg, args), res.location);\n+    /**", "originalCommit": "a075693ab23b3ec1c2101ff912f42ee83808db32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNDY3Mg==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390034672", "bodyText": "This class contains Result<E> which is a different Result than org.checkerframework.framework.source.Result.failure which has been removed.  (Yes, that's very confusing.)\nIn the future, maybe Result<E> should be refactored, but that is not a matter for this pull request.", "author": "mernst", "createdAt": "2020-03-10T00:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5NTkyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTk5NjgzNA==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r389996834", "bodyText": "Same comments as for FormatterTreeUtil above.", "author": "wmdietl", "createdAt": "2020-03-09T22:30:11Z", "path": "checker/src/main/java/org/checkerframework/checker/i18nformatter/I18nFormatterTreeUtil.java", "diffHunk": "@@ -151,16 +151,26 @@ public boolean isMakeFormatCall(MethodInvocationNode node, AnnotatedTypeFactory\n         return anno != null;\n     }\n \n-    /** Reports an error. Takes a {@link Result} to report the location. */\n-    public final <E> void failure(Result<E> res, @CompilerMessageKey String msg, Object... args) {\n-        checker.report(\n-                org.checkerframework.framework.source.Result.failure(msg, args), res.location);\n+    /**\n+     * Reports an error.\n+     *\n+     * @param res used for source location information\n+     * @param msgKey the diagnostic message key\n+     * @param args arguments to the diagnostic message\n+     */\n+    public final void failure(Result<?> res, @CompilerMessageKey String msgKey, Object... args) {", "originalCommit": "a075693ab23b3ec1c2101ff912f42ee83808db32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwMjMxMw==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390002313", "bodyText": "Here and above on line 146, instead of null shouldn't it \"an empty list\", bc the code does Collections.emptyList(); in the success case on line 176.", "author": "wmdietl", "createdAt": "2020-03-09T22:45:27Z", "path": "framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java", "diffHunk": "@@ -112,41 +118,48 @@ protected boolean shouldCheckTopLevelDeclaredType(AnnotatedTypeMirror type, Tree\n      *   <li>These properties should also hold recursively for component types of arrays, as wells\n      *       as bounds of type variables and wildcards.\n      * </ol>\n+     *\n+     * @param qualifierHierarchy the qualifier hierachy\n+     * @param type the type to test\n+     * @return list of reasons the type is invalid, or empty list if the type is valid\n      */\n-    protected Result isValidType(QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n-        SimpleAnnotatedTypeScanner<Result, Void> scanner =\n-                new SimpleAnnotatedTypeScanner<Result, Void>() {\n+    protected List<DiagMessage> isValidType(\n+            QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n+        SimpleAnnotatedTypeScanner<List<DiagMessage>, Void> scanner =\n+                new SimpleAnnotatedTypeScanner<List<DiagMessage>, Void>() {\n                     @Override\n-                    protected Result defaultAction(AnnotatedTypeMirror type, Void aVoid) {\n+                    protected List<DiagMessage> defaultAction(\n+                            AnnotatedTypeMirror type, Void aVoid) {\n                         return isTopLevelValidType(qualifierHierarchy, type);\n                     }\n \n                     @Override\n-                    protected Result reduce(Result r1, Result r2) {\n-                        if (r1 == null) {\n-                            if (r2 == null) {\n-                                return Result.SUCCESS;\n-                            }\n-                            return r2;\n-                        } else if (r2 == null) {\n-                            return r1;\n-                        }\n-                        return r1.merge(r2);\n+                    protected List<DiagMessage> reduce(List<DiagMessage> r1, List<DiagMessage> r2) {\n+                        return DiagMessage.mergeLists(r1, r2);\n                     }\n                 };\n         return scanner.visit(type);\n     }\n \n-    /** Checks every property listed in {@link #isValidType}, but only for the top level type. */\n-    protected Result isTopLevelValidType(\n+    /**\n+     * Checks every property listed in {@link #isValidType}, but only for the top level type. If\n+     * successful, returns null. If not successful, returns diagnostics.\n+     *\n+     * @param qualifierHierarchy the qualifier hierarchy\n+     * @param type the type to be checked\n+     * @return the diagnostics indicating failure, or null if successful", "originalCommit": "92ebe9e3037e22f30e0926f73a407fbb7cc2bdc0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a8779addaf5fa97dfff9a64f042c492130018f29", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java b/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\nindex 552d95d85a..c76ed4d2e2 100644\n--- a/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\n+++ b/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\n\n@@ -143,11 +143,11 @@ public class BaseTypeValidator extends AnnotatedTypeScanner<Void, Tree> implemen\n \n     /**\n      * Checks every property listed in {@link #isValidType}, but only for the top level type. If\n-     * successful, returns null. If not successful, returns diagnostics.\n+     * successful, returns an empty list. If not successful, returns diagnostics.\n      *\n      * @param qualifierHierarchy the qualifier hierarchy\n      * @param type the type to be checked\n-     * @return the diagnostics indicating failure, or null if successful\n+     * @return the diagnostics indicating failure, or an empty list if successful\n      */\n     protected List<DiagMessage> isTopLevelValidType(\n             QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNDUwOA==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390004508", "bodyText": "I'm not a big fan of static imports in general... for the single use here it seems unnecessary to change.", "author": "wmdietl", "createdAt": "2020-03-09T22:52:20Z", "path": "framework/src/main/java/org/checkerframework/framework/source/AggregateChecker.java", "diffHunk": "@@ -1,5 +1,7 @@\n package org.checkerframework.framework.source;\n \n+import static javax.tools.Diagnostic.Kind.ERROR;", "originalCommit": "92ebe9e3037e22f30e0926f73a407fbb7cc2bdc0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNjcxOQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390036719", "bodyText": "I'd prefer to keep this, if possible, because it makes all uses consistent throughout the codebase.\nUsing static imports was necessary in places because the codebase and its libraries contain multiple Diagnostic classes and multiple Kind classes, so only a static import would work.  So then I used it throughout.\nI'll change it in this class, though.", "author": "mernst", "createdAt": "2020-03-10T00:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNDUwOA=="}], "type": "inlineReview", "revised_code": {"commit": "ae756477f640f2492f1ded1df0694c7258fa2fd7", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/AggregateChecker.java b/framework/src/main/java/org/checkerframework/framework/source/AggregateChecker.java\nindex c9efb99d38..aead5541fb 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/AggregateChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/AggregateChecker.java\n\n@@ -1,7 +1,5 @@\n package org.checkerframework.framework.source;\n \n-import static javax.tools.Diagnostic.Kind.ERROR;\n-\n import com.sun.source.util.TreePath;\n import com.sun.tools.javac.processing.JavacProcessingEnvironment;\n import com.sun.tools.javac.util.Context;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNTM3Nw==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390005377", "bodyText": "Why the List part? For a single Result isn't a single DiagMessage the replacement?", "author": "wmdietl", "createdAt": "2020-03-09T22:55:04Z", "path": "framework/src/main/java/org/checkerframework/framework/source/Result.java", "diffHunk": "@@ -19,7 +20,9 @@\n  * compiler interface.\n  *\n  * @see SourceChecker#report\n+ * @deprecated use {@code List<DiagMessage>} instead", "originalCommit": "fb367b2809394dd132762f763480c822ea1d0248", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMzM1NQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390033355", "bodyText": "A Result contains a list of DiagMessage.  (Result.failure returns a Result that contains only a single DiagMessage, but other methods create non-singletons.)", "author": "mernst", "createdAt": "2020-03-10T00:31:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM1OTU1NQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390359555", "bodyText": "I found a single method org.checkerframework.common.basetype.BaseTypeValidator#isValidType that possibly returns a non-singleton list. The default suggestion should be to use a DiagMessage instead and exceptional places might use a List<DiagMessage>. It seems rather confusing to always suggest List<DiagMessage>.", "author": "wmdietl", "createdAt": "2020-03-10T14:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNTM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNDMyNA==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390404324", "bodyText": "I see your point.  I have made this change.", "author": "mernst", "createdAt": "2020-03-10T15:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNTM3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "157f1bdf61f1d810843789ed6ad170a187a93e6b", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/Result.java b/framework/src/main/java/org/checkerframework/framework/source/Result.java\nindex 3ea1831236..7ef0bfa556 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/Result.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/Result.java\n\n@@ -20,7 +20,7 @@ import org.checkerframework.javacutil.BugInCF;\n  * compiler interface.\n  *\n  * @see SourceChecker#report\n- * @deprecated use {@code List<DiagMessage>} instead\n+ * @deprecated use {@code ListDiagMessage>} instead\n  */\n @Deprecated // use {@code List<DiagMessage>} instead\n public final class Result {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwNzI2NQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390007265", "bodyText": "As this is a private method, no external clients can use this.\nSo maybe this comment is better on the public void report(Object source, DiagMessage d) above?", "author": "wmdietl", "createdAt": "2020-03-09T23:00:52Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -894,56 +895,79 @@ public void report(final Result r, final Object src) {\n             return;\n         }\n \n-        for (Result.DiagMessage msg : r.getDiagMessages()) {\n-            if (r.isFailure()) {\n-                this.message(\n-                        hasOption(\"warns\")\n-                                ? Diagnostic.Kind.MANDATORY_WARNING\n-                                : Diagnostic.Kind.ERROR,\n-                        src,\n-                        msg.getMessageKey(),\n-                        msg.getArgs());\n-            } else if (r.isWarning()) {\n-                this.message(\n-                        Diagnostic.Kind.MANDATORY_WARNING, src, msg.getMessageKey(), msg.getArgs());\n-            } else {\n-                this.message(Diagnostic.Kind.NOTE, src, msg.getMessageKey(), msg.getArgs());\n-            }\n+        for (DiagMessage dmsg : r.getDiagMessages()) {\n+            report(src, dmsg);\n         }\n     }\n \n     /**\n-     * Prints a message (error, warning, note, etc.) via JSR-269.\n+     * Reports an error. By default, prints it to the screen via the compiler's internal messager.\n      *\n-     * @param kind the type of message to print\n-     * @param source the object from which to obtain source position information; may be an Element,\n-     *     a Tree, or null\n-     * @param msgKey the message key to print\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n      * @param args arguments for interpolation in the string corresponding to the given message key\n-     * @see Diagnostic\n-     * @throws IllegalArgumentException if {@code source} is neither a {@link Tree} nor an {@link\n-     *     Element}\n-     */\n-    private void message(\n-            Diagnostic.Kind kind,\n-            @Nullable Object source,\n-            @CompilerMessageKey String msgKey,\n-            Object... args) {\n+     */\n+    public void reportError(Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, ERROR, messageKey, args);\n+    }\n+\n+    /**\n+     * Reports a warning. By default, prints it to the screen via the compiler's internal messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n+     */\n+    public void reportWarning(\n+            Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, MANDATORY_WARNING, messageKey, args);\n+    }\n \n+    /**\n+     * Reports a diagnostic message. By default, prints it to the screen via the compiler's internal\n+     * messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param d the diagnostic message\n+     */\n+    public void report(Object source, DiagMessage d) {\n+        report(source, d.getKind(), d.getMessageKey(), d.getArgs());\n+    }\n+\n+    /**\n+     * Reports a diagnostic message. By default, it prints it to the screen via the compiler's\n+     * internal messager; otherwise, the method returns with no side effects.\n+     *\n+     * <p>Most clients should use {@link #reportError} or {@link #reportWarning}.", "originalCommit": "fb367b2809394dd132762f763480c822ea1d0248", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "157f1bdf61f1d810843789ed6ad170a187a93e6b", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex 98fbc1a7e0..19f2817c04 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -927,6 +927,8 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n      * Reports a diagnostic message. By default, prints it to the screen via the compiler's internal\n      * messager.\n      *\n+     * <p>Most clients should use {@link #reportError} or {@link #reportWarning}.\n+     *\n      * @param source the source position information; may be an Element, a Tree, or null\n      * @param d the diagnostic message\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwODE2Mw==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390008163", "bodyText": "I'm a bit confused about the By default and otherwise text. This is a private method, so subclasses can't adapt it. How/when do I reach the otherwise case?", "author": "wmdietl", "createdAt": "2020-03-09T23:03:31Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -894,56 +895,79 @@ public void report(final Result r, final Object src) {\n             return;\n         }\n \n-        for (Result.DiagMessage msg : r.getDiagMessages()) {\n-            if (r.isFailure()) {\n-                this.message(\n-                        hasOption(\"warns\")\n-                                ? Diagnostic.Kind.MANDATORY_WARNING\n-                                : Diagnostic.Kind.ERROR,\n-                        src,\n-                        msg.getMessageKey(),\n-                        msg.getArgs());\n-            } else if (r.isWarning()) {\n-                this.message(\n-                        Diagnostic.Kind.MANDATORY_WARNING, src, msg.getMessageKey(), msg.getArgs());\n-            } else {\n-                this.message(Diagnostic.Kind.NOTE, src, msg.getMessageKey(), msg.getArgs());\n-            }\n+        for (DiagMessage dmsg : r.getDiagMessages()) {\n+            report(src, dmsg);\n         }\n     }\n \n     /**\n-     * Prints a message (error, warning, note, etc.) via JSR-269.\n+     * Reports an error. By default, prints it to the screen via the compiler's internal messager.\n      *\n-     * @param kind the type of message to print\n-     * @param source the object from which to obtain source position information; may be an Element,\n-     *     a Tree, or null\n-     * @param msgKey the message key to print\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n      * @param args arguments for interpolation in the string corresponding to the given message key\n-     * @see Diagnostic\n-     * @throws IllegalArgumentException if {@code source} is neither a {@link Tree} nor an {@link\n-     *     Element}\n-     */\n-    private void message(\n-            Diagnostic.Kind kind,\n-            @Nullable Object source,\n-            @CompilerMessageKey String msgKey,\n-            Object... args) {\n+     */\n+    public void reportError(Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, ERROR, messageKey, args);\n+    }\n+\n+    /**\n+     * Reports a warning. By default, prints it to the screen via the compiler's internal messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param messageKey the message key\n+     * @param args arguments for interpolation in the string corresponding to the given message key\n+     */\n+    public void reportWarning(\n+            Object source, @CompilerMessageKey String messageKey, Object... args) {\n+        report(source, MANDATORY_WARNING, messageKey, args);\n+    }\n \n+    /**\n+     * Reports a diagnostic message. By default, prints it to the screen via the compiler's internal\n+     * messager.\n+     *\n+     * @param source the source position information; may be an Element, a Tree, or null\n+     * @param d the diagnostic message\n+     */\n+    public void report(Object source, DiagMessage d) {\n+        report(source, d.getKind(), d.getMessageKey(), d.getArgs());\n+    }\n+\n+    /**\n+     * Reports a diagnostic message. By default, it prints it to the screen via the compiler's\n+     * internal messager; otherwise, the method returns with no side effects.", "originalCommit": "fb367b2809394dd132762f763480c822ea1d0248", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzMzAxMQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390033011", "bodyText": "Via printOrStoreMessage.  I'll clarify the comment.", "author": "mernst", "createdAt": "2020-03-10T00:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwODE2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "157f1bdf61f1d810843789ed6ad170a187a93e6b", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex 98fbc1a7e0..19f2817c04 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -927,6 +927,8 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n      * Reports a diagnostic message. By default, prints it to the screen via the compiler's internal\n      * messager.\n      *\n+     * <p>Most clients should use {@link #reportError} or {@link #reportWarning}.\n+     *\n      * @param source the source position information; may be an Element, a Tree, or null\n      * @param d the diagnostic message\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwODY5OQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390008699", "bodyText": "Am I missing where this is used in this file?", "author": "wmdietl", "createdAt": "2020-03-09T23:05:12Z", "path": "framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java", "diffHunk": "@@ -3,6 +3,8 @@\n // The imports from com.sun are all @jdk.Exported and therefore somewhat safe to use.\n // Try to avoid using non-@jdk.Exported classes.\n \n+import static javax.tools.Diagnostic.Kind.ERROR;", "originalCommit": "fb367b2809394dd132762f763480c822ea1d0248", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAzNzU5MQ==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390037591", "bodyText": "It's used in a switch statement where the import isn't needed.  Thanks for catching that.", "author": "mernst", "createdAt": "2020-03-10T00:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAwODY5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "ae756477f640f2492f1ded1df0694c7258fa2fd7", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java b/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\nindex 8794157d0e..41e5c69dc5 100644\n--- a/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\n+++ b/framework/src/main/java/org/checkerframework/framework/type/AnnotatedTypeFactory.java\n\n@@ -3,8 +3,6 @@ package org.checkerframework.framework.type;\n // The imports from com.sun are all @jdk.Exported and therefore somewhat safe to use.\n // Try to avoid using non-@jdk.Exported classes.\n \n-import static javax.tools.Diagnostic.Kind.ERROR;\n-\n import com.sun.source.tree.AnnotationTree;\n import com.sun.source.tree.AssignmentTree;\n import com.sun.source.tree.ClassTree;\n"}}, {"oid": "157f1bdf61f1d810843789ed6ad170a187a93e6b", "url": "https://github.com/typetools/checker-framework/commit/157f1bdf61f1d810843789ed6ad170a187a93e6b", "message": "Clarify documentation", "committedDate": "2020-03-10T00:32:03Z", "type": "commit"}, {"oid": "a8779addaf5fa97dfff9a64f042c492130018f29", "url": "https://github.com/typetools/checker-framework/commit/a8779addaf5fa97dfff9a64f042c492130018f29", "message": "Correct documentation", "committedDate": "2020-03-10T00:39:23Z", "type": "commit"}, {"oid": "ae756477f640f2492f1ded1df0694c7258fa2fd7", "url": "https://github.com/typetools/checker-framework/commit/ae756477f640f2492f1ded1df0694c7258fa2fd7", "message": "Undo static imports", "committedDate": "2020-03-10T00:47:08Z", "type": "commit"}, {"oid": "b4ddf371d307b3bc279093a5dc66420cd1d788f8", "url": "https://github.com/typetools/checker-framework/commit/b4ddf371d307b3bc279093a5dc66420cd1d788f8", "message": "Merge branch 'remove-result-class-2' of github.com:mernst/checker-framework into remove-result-class-2", "committedDate": "2020-03-10T00:47:44Z", "type": "commit"}, {"oid": "8057f49d8b65e9dd00d7fb8413a633f0827eb446", "url": "https://github.com/typetools/checker-framework/commit/8057f49d8b65e9dd00d7fb8413a633f0827eb446", "message": "Change reference to Javadoc URL", "committedDate": "2020-03-10T01:50:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM2MTE3Mg==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390361172", "bodyText": "This method either returns a singleton list or the empty list, right?\nIf so, I would rather model it like FieldInvariants.isSuperInvariant and return DiagMessage or null.\nThis makes the code and logic simpler, and the Result to DiagMessage transition more uniform.", "author": "wmdietl", "createdAt": "2020-03-10T14:37:18Z", "path": "framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java", "diffHunk": "@@ -112,41 +118,48 @@ protected boolean shouldCheckTopLevelDeclaredType(AnnotatedTypeMirror type, Tree\n      *   <li>These properties should also hold recursively for component types of arrays, as wells\n      *       as bounds of type variables and wildcards.\n      * </ol>\n+     *\n+     * @param qualifierHierarchy the qualifier hierachy\n+     * @param type the type to test\n+     * @return list of reasons the type is invalid, or empty list if the type is valid\n      */\n-    protected Result isValidType(QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n-        SimpleAnnotatedTypeScanner<Result, Void> scanner =\n-                new SimpleAnnotatedTypeScanner<Result, Void>() {\n+    protected List<DiagMessage> isValidType(\n+            QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n+        SimpleAnnotatedTypeScanner<List<DiagMessage>, Void> scanner =\n+                new SimpleAnnotatedTypeScanner<List<DiagMessage>, Void>() {\n                     @Override\n-                    protected Result defaultAction(AnnotatedTypeMirror type, Void aVoid) {\n+                    protected List<DiagMessage> defaultAction(\n+                            AnnotatedTypeMirror type, Void aVoid) {\n                         return isTopLevelValidType(qualifierHierarchy, type);\n                     }\n \n                     @Override\n-                    protected Result reduce(Result r1, Result r2) {\n-                        if (r1 == null) {\n-                            if (r2 == null) {\n-                                return Result.SUCCESS;\n-                            }\n-                            return r2;\n-                        } else if (r2 == null) {\n-                            return r1;\n-                        }\n-                        return r1.merge(r2);\n+                    protected List<DiagMessage> reduce(List<DiagMessage> r1, List<DiagMessage> r2) {\n+                        return DiagMessage.mergeLists(r1, r2);\n                     }\n                 };\n         return scanner.visit(type);\n     }\n \n-    /** Checks every property listed in {@link #isValidType}, but only for the top level type. */\n-    protected Result isTopLevelValidType(\n+    /**\n+     * Checks every property listed in {@link #isValidType}, but only for the top level type. If\n+     * successful, returns an empty list. If not successful, returns diagnostics.\n+     *\n+     * @param qualifierHierarchy the qualifier hierarchy\n+     * @param type the type to be checked\n+     * @return the diagnostics indicating failure, or an empty list if successful\n+     */\n+    protected List<DiagMessage> isTopLevelValidType(", "originalCommit": "8057f49d8b65e9dd00d7fb8413a633f0827eb446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNDIzMA==", "url": "https://github.com/typetools/checker-framework/pull/3134#discussion_r390404230", "bodyText": "Yes, you are right that the method returns a singleton list or the empty list.\nChanging its type would make it slightly simpler, but would complicate its caller isValidType, which would need to immediately convert the null or DiagMessage into a list.  Take a look and let me know if you agree.", "author": "mernst", "createdAt": "2020-03-10T15:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM2MTE3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e654d96ad54bc51e854185612134236ff9306462", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java b/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\nindex ffdde1ff0e..acfd95f566 100644\n--- a/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\n+++ b/framework/src/main/java/org/checkerframework/common/basetype/BaseTypeValidator.java\n\n@@ -149,6 +149,9 @@ public class BaseTypeValidator extends AnnotatedTypeScanner<Void, Tree> implemen\n      * @param type the type to be checked\n      * @return the diagnostics indicating failure, or an empty list if successful\n      */\n+    // This method returns a singleton or empyty list.  Its return type is List rather than\n+    // DiagMessage (with null indicting success) because it is used in a context that expects a\n+    // list.\n     protected List<DiagMessage> isTopLevelValidType(\n             QualifierHierarchy qualifierHierarchy, AnnotatedTypeMirror type) {\n         // multiple annotations from the same hierarchy\n"}}, {"oid": "c6f26a7d44475f17c58247b3afad127810c54300", "url": "https://github.com/typetools/checker-framework/commit/c6f26a7d44475f17c58247b3afad127810c54300", "message": "Recommend DiagMessage over List<DiagMessage>", "committedDate": "2020-03-10T15:23:54Z", "type": "commit"}, {"oid": "e654d96ad54bc51e854185612134236ff9306462", "url": "https://github.com/typetools/checker-framework/commit/e654d96ad54bc51e854185612134236ff9306462", "message": "Explain return type", "committedDate": "2020-03-10T15:28:14Z", "type": "commit"}, {"oid": "680a7b5428895c3e688961797fd4fabe1affad5e", "url": "https://github.com/typetools/checker-framework/commit/680a7b5428895c3e688961797fd4fabe1affad5e", "message": "Tweak comment", "committedDate": "2020-03-10T15:31:00Z", "type": "commit"}]}