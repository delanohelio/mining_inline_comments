{"pr_number": 3599, "pr_title": "Restore ability to use unannotated stub file to override annotations in bytecode", "pr_createdAt": "2020-08-17T21:54:08Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3599", "timeline": [{"oid": "02ad5e1c23cd1cfb199fe1ea26a3aefe8fa30637", "url": "https://github.com/typetools/checker-framework/commit/02ad5e1c23cd1cfb199fe1ea26a3aefe8fa30637", "message": "failing test", "committedDate": "2020-08-17T17:08:53Z", "type": "commit"}, {"oid": "adec24fd1004ff7aae6f197dcd5658321d1f4b44", "url": "https://github.com/typetools/checker-framework/commit/adec24fd1004ff7aae6f197dcd5658321d1f4b44", "message": "fix 3597", "committedDate": "2020-08-17T21:42:15Z", "type": "commit"}, {"oid": "a09b4d5b52aa887805f467b634bc7ebee9432298", "url": "https://github.com/typetools/checker-framework/commit/a09b4d5b52aa887805f467b634bc7ebee9432298", "message": "formatting", "committedDate": "2020-08-17T21:43:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2NzU3Mw==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472367573", "bodyText": "This should be moved into getAnnotation.  Or is there some reason it can't be?", "author": "smillst", "createdAt": "2020-08-18T17:35:08Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/StubParser.java", "diffHunk": "@@ -1204,6 +1185,18 @@ private void annotate(AnnotatedTypeMirror type, List<AnnotationExpr> annotations\n         }\n         for (AnnotationExpr annotation : annotations) {\n             AnnotationMirror annoMirror = getAnnotation(annotation, allStubAnnotations);\n+            if (annoMirror == null) {\n+                // If the annotation was not imported, then #getAllStubAnnotations does", "originalCommit": "a09b4d5b52aa887805f467b634bc7ebee9432298", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21dd6a71cf97e174afcc84e33e1a809e2108bf30", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\nindex 7ba2c234ee..6e015cd07a 100644\n--- a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n+++ b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n\n@@ -1185,18 +1187,6 @@ public class StubParser {\n         }\n         for (AnnotationExpr annotation : annotations) {\n             AnnotationMirror annoMirror = getAnnotation(annotation, allStubAnnotations);\n-            if (annoMirror == null) {\n-                // If the annotation was not imported, then #getAllStubAnnotations does\n-                // not add it to the allStubAnnotations field. This code compensates for\n-                // that deficiency by adding the annotation when it is encountered (i.e. here).\n-                TypeElement annoTypeElt = getTypeElement(annotation.getNameAsString());\n-                if (annoTypeElt != null) {\n-                    putAllNew(\n-                            allStubAnnotations,\n-                            createNameToAnnotationMap(Collections.singletonList(annoTypeElt)));\n-                    annoMirror = getAnnotation(annotation, allStubAnnotations);\n-                }\n-            }\n             if (annoMirror != null) {\n                 type.replaceAnnotation(annoMirror);\n             } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2OTAwMA==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472369000", "bodyText": "Just call TypeElement classElement = elements.getTypeElement(typeName); directly so that the more sensible warning will be issued below.  (Make sure to document why getTypeElement isn't called.)", "author": "smillst", "createdAt": "2020-08-18T17:37:41Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/StubParser.java", "diffHunk": "@@ -1204,6 +1185,18 @@ private void annotate(AnnotatedTypeMirror type, List<AnnotationExpr> annotations\n         }\n         for (AnnotationExpr annotation : annotations) {\n             AnnotationMirror annoMirror = getAnnotation(annotation, allStubAnnotations);\n+            if (annoMirror == null) {\n+                // If the annotation was not imported, then #getAllStubAnnotations does\n+                // not add it to the allStubAnnotations field. This code compensates for\n+                // that deficiency by adding the annotation when it is encountered (i.e. here).\n+                TypeElement annoTypeElt = getTypeElement(annotation.getNameAsString());", "originalCommit": "a09b4d5b52aa887805f467b634bc7ebee9432298", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21dd6a71cf97e174afcc84e33e1a809e2108bf30", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\nindex 7ba2c234ee..6e015cd07a 100644\n--- a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n+++ b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n\n@@ -1185,18 +1187,6 @@ public class StubParser {\n         }\n         for (AnnotationExpr annotation : annotations) {\n             AnnotationMirror annoMirror = getAnnotation(annotation, allStubAnnotations);\n-            if (annoMirror == null) {\n-                // If the annotation was not imported, then #getAllStubAnnotations does\n-                // not add it to the allStubAnnotations field. This code compensates for\n-                // that deficiency by adding the annotation when it is encountered (i.e. here).\n-                TypeElement annoTypeElt = getTypeElement(annotation.getNameAsString());\n-                if (annoTypeElt != null) {\n-                    putAllNew(\n-                            allStubAnnotations,\n-                            createNameToAnnotationMap(Collections.singletonList(annoTypeElt)));\n-                    annoMirror = getAnnotation(annotation, allStubAnnotations);\n-                }\n-            }\n             if (annoMirror != null) {\n                 type.replaceAnnotation(annoMirror);\n             } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3MTk2NQ==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472371965", "bodyText": "In several places you deleted simple, instead, could you please change it to both fully-qualified and simple names.  That's important information.", "author": "smillst", "createdAt": "2020-08-18T17:42:51Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/StubParser.java", "diffHunk": "@@ -142,9 +142,8 @@\n     private final Elements elements;\n \n     /**\n-     * The set of annotations found in the stub file. Keys are simple (unqualified) names. (This may\n-     * be a problem in the unlikely occurrence that a type-checker supports two annotations with the\n-     * same simple name.)\n+     * The set of annotations found in the stub file. Keys are names. There are two entries for each", "originalCommit": "a09b4d5b52aa887805f467b634bc7ebee9432298", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21dd6a71cf97e174afcc84e33e1a809e2108bf30", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\nindex 7ba2c234ee..6e015cd07a 100644\n--- a/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n+++ b/framework/src/main/java/org/checkerframework/framework/stub/StubParser.java\n\n@@ -142,8 +142,9 @@ public class StubParser {\n     private final Elements elements;\n \n     /**\n-     * The set of annotations found in the stub file. Keys are names. There are two entries for each\n-     * annotation: the annotation's simple name and its fully-qualified name.\n+     * The set of annotations found in the stub file. Keys are both fully-qualified and simple\n+     * names: there are two entries for each annotation: the annotation's simple name and its\n+     * fully-qualified name.\n      *\n      * @see #getAllStubAnnotations\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDk2Mg==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472374962", "bodyText": "The changes in this file should be merged to master in a separate commit. Can you open a separate PR with these changes?   I'll merge that PR first, so it's fine to leave these changes in this PR.  Also, can you add a test case for this that is unrelated to the other changes in this file?", "author": "smillst", "createdAt": "2020-08-18T17:48:00Z", "path": "framework/src/main/java/org/checkerframework/common/wholeprograminference/SceneToStubWriter.java", "diffHunk": "@@ -173,79 +173,29 @@ private static String formatAnnotations(Collection<? extends Annotation> annos)\n      * @return the type formatted to be written to Java source code, followed by a space character\n      */\n     private static String formatArrayType(ATypeElement scenelibRep, ArrayType javacRep) {\n-        int levels =", "originalCommit": "a09b4d5b52aa887805f467b634bc7ebee9432298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxODU3NA==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472418574", "bodyText": "The changes in this file should be merged to master in a separate commit\n\nI agree that would be cleaner. The reason I didn't do it is:\n\ncan you add a test case for this that is unrelated to the other changes in this file?\n\nI cannot. The error here only affects the order of the parts of the type that are contained in the javac representation. With respect to arrays, that means that the only parts that are incorrectly ordered are the []s - even the inferred annotations were ordered correctly before. The error only shows up when there are printable, but not inferred, annotations - which javac prints using fully-qualified names. So it's not possible to test these changes without the fix to the stub parser, but fixing the stub parser causes the existing tests to fail (because the algorithm is wrong).", "author": "kelloggm", "createdAt": "2020-08-18T19:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQxOTI4Nw==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472419287", "bodyText": "even the inferred annotations were ordered correctly before\n\nWhat I mean by this is that the sceneLibRep and its associated structures in the old code caused inferred annotations on the inner arrays types to be printed in the correct order, even though the array parts themselves (the []s and any annotations in the javac types) were printed in the wrong order.", "author": "kelloggm", "createdAt": "2020-08-18T19:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3NjU2Nw==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472476567", "bodyText": "Thanks for the explantation.  Now I understand why you can't add a test case (or rather why the existing test case didn't fail until the other bugs where fixed).   Could you still open a separate PR without a test case?  Then we can just merge that one first, then merge this one.", "author": "smillst", "createdAt": "2020-08-18T20:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4Nzk2MQ==", "url": "https://github.com/typetools/checker-framework/pull/3599#discussion_r472487961", "bodyText": "#3601 has these changes", "author": "kelloggm", "createdAt": "2020-08-18T20:55:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDk2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "21dd6a71cf97e174afcc84e33e1a809e2108bf30", "url": "https://github.com/typetools/checker-framework/commit/21dd6a71cf97e174afcc84e33e1a809e2108bf30", "message": "fixes from code review", "committedDate": "2020-08-18T19:01:52Z", "type": "commit"}, {"oid": "853e22cd7efbc17e34a293f169ebb57c35e085c3", "url": "https://github.com/typetools/checker-framework/commit/853e22cd7efbc17e34a293f169ebb57c35e085c3", "message": "Merge branch 'master' of github.com:typetools/checker-framework into stub-overwrite-bug", "committedDate": "2020-08-18T22:54:57Z", "type": "commit"}]}