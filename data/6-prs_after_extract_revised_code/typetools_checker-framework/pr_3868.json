{"pr_number": 3868, "pr_title": "Infer method declaration annotations", "pr_createdAt": "2020-11-06T22:54:21Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3868", "timeline": [{"oid": "3a9547d1a913c78d41a225d9d9785aed2697b884", "url": "https://github.com/typetools/checker-framework/commit/3a9547d1a913c78d41a225d9d9785aed2697b884", "message": "Infer method declaration annotations", "committedDate": "2020-11-04T22:12:52Z", "type": "commit"}, {"oid": "f79cc97b43b484daae881d14269f87f0990cb84c", "url": "https://github.com/typetools/checker-framework/commit/f79cc97b43b484daae881d14269f87f0990cb84c", "message": "Add field", "committedDate": "2020-11-04T22:45:16Z", "type": "commit"}, {"oid": "e4ac4f1a4d25ed6a6eb80ad8e676310cfe4c0f11", "url": "https://github.com/typetools/checker-framework/commit/e4ac4f1a4d25ed6a6eb80ad8e676310cfe4c0f11", "message": "Merge ../checker-framework-branch-master into infer-method-declaration-annotations", "committedDate": "2020-11-06T18:04:50Z", "type": "commit"}, {"oid": "64c43affbf3d08cb91d1b0ca57ac6a775f54dff1", "url": "https://github.com/typetools/checker-framework/commit/64c43affbf3d08cb91d1b0ca57ac6a775f54dff1", "message": "Merge ../checker-framework-branch-master into infer-method-declaration-annotations", "committedDate": "2020-11-06T21:56:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNTE5Mg==", "url": "https://github.com/typetools/checker-framework/pull/3868#discussion_r520025192", "bodyText": "This should be removed or commented out.", "author": "smillst", "createdAt": "2020-11-09T18:25:43Z", "path": "checker/src/main/java/org/checkerframework/checker/formatter/FormatterVisitor.java", "diffHunk": "@@ -126,6 +127,15 @@ public Void visitMethodInvocation(MethodInvocationTree node, Void p) {\n                         break;\n                 }\n             }\n+\n+            // Support -Ainfer command-line argument\n+            WholeProgramInference wpi = atypeFactory.getWholeProgramInference();\n+            if (wpi != null && forwardsArguments(node, enclosingMethod)) {\n+                System.out.printf(\"forwardsArguments: %s %s%n\", node, enclosingMethod);", "originalCommit": "64c43affbf3d08cb91d1b0ca57ac6a775f54dff1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2aeeed73d4687f216dd346df05314ad178e25c72", "chunk": "diff --git a/checker/src/main/java/org/checkerframework/checker/formatter/FormatterVisitor.java b/checker/src/main/java/org/checkerframework/checker/formatter/FormatterVisitor.java\nindex 77e65d4a3..ecc8f49a9 100644\n--- a/checker/src/main/java/org/checkerframework/checker/formatter/FormatterVisitor.java\n+++ b/checker/src/main/java/org/checkerframework/checker/formatter/FormatterVisitor.java\n\n@@ -131,7 +131,6 @@ public class FormatterVisitor extends BaseTypeVisitor<FormatterAnnotatedTypeFact\n             // Support -Ainfer command-line argument\n             WholeProgramInference wpi = atypeFactory.getWholeProgramInference();\n             if (wpi != null && forwardsArguments(node, enclosingMethod)) {\n-                System.out.printf(\"forwardsArguments: %s %s%n\", node, enclosingMethod);\n                 wpi.addMethodDeclarationAnnotation(\n                         TreeUtils.elementFromDeclaration(enclosingMethod),\n                         atypeFactory.FORMATMETHOD);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAyNTY0NQ==", "url": "https://github.com/typetools/checker-framework/pull/3868#discussion_r520025645", "bodyText": "This should probably be remove/commented out.", "author": "smillst", "createdAt": "2020-11-09T18:26:31Z", "path": "framework/src/main/java/org/checkerframework/common/wholeprograminference/WholeProgramInferenceScenes.java", "diffHunk": "@@ -440,6 +441,27 @@ public void updateFromReturn(\n         }\n     }\n \n+    @Override\n+    public void addMethodDeclarationAnnotation(ExecutableElement methodElt, AnnotationMirror anno) {\n+\n+        // do not infer types for code that isn't presented as source\n+        if (!ElementUtils.isElementFromSourceCode(methodElt)) {\n+            return;\n+        }\n+\n+        String className = getEnclosingClassName(methodElt);\n+        String jaifPath = storage.getJaifPath(className);\n+        AClass clazz =\n+                storage.getAClass(className, jaifPath, ((MethodSymbol) methodElt).enclClass());\n+        AMethod method = clazz.methods.getVivify(JVMNames.getJVMMethodSignature(methodElt));\n+\n+        scenelib.annotations.Annotation sceneAnno =\n+                AnnotationConverter.annotationMirrorToAnnotation(anno);\n+        method.tlAnnotationsHere.add(sceneAnno);\n+        System.out.printf(", "originalCommit": "64c43affbf3d08cb91d1b0ca57ac6a775f54dff1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2aeeed73d4687f216dd346df05314ad178e25c72", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/common/wholeprograminference/WholeProgramInferenceScenes.java b/framework/src/main/java/org/checkerframework/common/wholeprograminference/WholeProgramInferenceScenes.java\nindex 4a57bfe25..2f6e8435f 100644\n--- a/framework/src/main/java/org/checkerframework/common/wholeprograminference/WholeProgramInferenceScenes.java\n+++ b/framework/src/main/java/org/checkerframework/common/wholeprograminference/WholeProgramInferenceScenes.java\n\n@@ -458,8 +458,6 @@ public class WholeProgramInferenceScenes implements WholeProgramInference {\n         scenelib.annotations.Annotation sceneAnno =\n                 AnnotationConverter.annotationMirrorToAnnotation(anno);\n         method.tlAnnotationsHere.add(sceneAnno);\n-        System.out.printf(\n-                \"addMethodDeclarationAnnotation(%s) => %s%n\", methodElt, method.tlAnnotationsHere);\n     }\n \n     /** Write all modified scenes into .jaif files or stub files. */\n"}}, {"oid": "2aeeed73d4687f216dd346df05314ad178e25c72", "url": "https://github.com/typetools/checker-framework/commit/2aeeed73d4687f216dd346df05314ad178e25c72", "message": "Remove debugging output", "committedDate": "2020-11-09T18:50:31Z", "type": "commit"}, {"oid": "0cca9e6844bf3cadeceadf2e37b032f93fdf106d", "url": "https://github.com/typetools/checker-framework/commit/0cca9e6844bf3cadeceadf2e37b032f93fdf106d", "message": "Tweak comments", "committedDate": "2020-11-09T18:52:19Z", "type": "commit"}]}