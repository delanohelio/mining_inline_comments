{"pr_number": 3100, "pr_title": "Avoid the false \"cannot find stub file\" warnings.", "pr_createdAt": "2020-02-21T01:30:26Z", "pr_url": "https://github.com/typetools/checker-framework/pull/3100", "timeline": [{"oid": "52590bb93f305a6b9fa63d00ae09306339dc01f7", "url": "https://github.com/typetools/checker-framework/commit/52590bb93f305a6b9fa63d00ae09306339dc01f7", "message": "Also check ancestor checkers to avoid a false warning.", "committedDate": "2020-02-21T00:31:46Z", "type": "commit"}, {"oid": "d77aa81cc47fe8bdb03eb4bd5be3af0ae886a1cb", "url": "https://github.com/typetools/checker-framework/commit/d77aa81cc47fe8bdb03eb4bd5be3af0ae886a1cb", "message": "Tweaks.", "committedDate": "2020-02-21T01:27:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNDgzNw==", "url": "https://github.com/typetools/checker-framework/pull/3100#discussion_r382824837", "bodyText": "Instead of making this field public, please add a getter method next to the existing setter.", "author": "wmdietl", "createdAt": "2020-02-21T21:56:59Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -461,7 +461,7 @@\n      * in the case of a compound checker, the compound checker is the parent, not the checker that\n      * was run prior to this one by the compound checker.\n      */\n-    protected SourceChecker parentChecker;\n+    public SourceChecker parentChecker;", "originalCommit": "d77aa81cc47fe8bdb03eb4bd5be3af0ae886a1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "15a6206778ff7afd216d6160512b0e7132aedaa2", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex dea3d0b90..5e25b87e0 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -461,7 +461,7 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n      * in the case of a compound checker, the compound checker is the parent, not the checker that\n      * was run prior to this one by the compound checker.\n      */\n-    public SourceChecker parentChecker;\n+    protected SourceChecker parentChecker;\n \n     /** List of upstream checker names. Includes the current checker. */\n     protected List<String> upstreamCheckerNames;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgzMDM4NQ==", "url": "https://github.com/typetools/checker-framework/pull/3100#discussion_r382830385", "bodyText": "I think you should try to pull this check out before the first use of checker.getClass() on line 192 and simply perform the same logic for either the first checker or one of the parent checkers.\nThis would include checking for the topLevelResource for each possible checker.", "author": "wmdietl", "createdAt": "2020-02-21T22:11:44Z", "path": "framework/src/main/java/org/checkerframework/framework/stub/StubTypes.java", "diffHunk": "@@ -202,15 +202,31 @@ public void parseStubFiles() {\n                                         + \".class, but is at the top level of a jar file: \"\n                                         + topLevelResource);\n                     } else {\n-                        checker.message(\n-                                Kind.WARNING,\n-                                \"Did not find stub file \"\n-                                        + stubPath\n-                                        + \" on classpath or within directory \"\n-                                        + new File(stubPath).getAbsolutePath()\n-                                        + (stubPathFull.equals(stubPath)\n-                                                ? \"\"\n-                                                : (\" or at \" + stubPathFull)));\n+                        // When using a compound checker, the target stub file may be found by the\n+                        // current checker's parent checkers. Also check this to avoid a false\n+                        // warning.\n+                        SourceChecker parentChecker = checker.parentChecker;\n+                        boolean findByParentCheckers = false;\n+                        while (parentChecker != null) {", "originalCommit": "d77aa81cc47fe8bdb03eb4bd5be3af0ae886a1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "15a6206778ff7afd216d6160512b0e7132aedaa2", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/stub/StubTypes.java b/framework/src/main/java/org/checkerframework/framework/stub/StubTypes.java\nindex 45888383d..840bd0ba8 100644\n--- a/framework/src/main/java/org/checkerframework/framework/stub/StubTypes.java\n+++ b/framework/src/main/java/org/checkerframework/framework/stub/StubTypes.java\n\n@@ -190,45 +190,7 @@ public class StubTypes {\n                 // level directory of the jar that contains the checker.\n                 stubPath = stubPath.replace(\"checker.jar/\", \"/\");\n                 InputStream in = checker.getClass().getResourceAsStream(stubPath);\n-                if (in == null) {\n-                    // Didn't find the stub file.\n-                    URL topLevelResource = checker.getClass().getResource(\"/\" + stubPath);\n-                    if (topLevelResource != null) {\n-                        checker.message(\n-                                Kind.WARNING,\n-                                stubPath\n-                                        + \" should be in the same directory as \"\n-                                        + checker.getClass().getSimpleName()\n-                                        + \".class, but is at the top level of a jar file: \"\n-                                        + topLevelResource);\n-                    } else {\n-                        // When using a compound checker, the target stub file may be found by the\n-                        // current checker's parent checkers. Also check this to avoid a false\n-                        // warning.\n-                        SourceChecker parentChecker = checker.parentChecker;\n-                        boolean findByParentCheckers = false;\n-                        while (parentChecker != null) {\n-                            if (parentChecker.getClass().getResource(stubPath) != null) {\n-                                findByParentCheckers = true;\n-                                break;\n-                            }\n-                            parentChecker = parentChecker.parentChecker;\n-                        }\n-                        // If there exists one parent checker which can find this stub file, don't\n-                        // report an warning.\n-                        if (!findByParentCheckers) {\n-                            checker.message(\n-                                    Kind.WARNING,\n-                                    \"Did not find stub file \"\n-                                            + stubPath\n-                                            + \" on classpath or within directory \"\n-                                            + new File(stubPath).getAbsolutePath()\n-                                            + (stubPathFull.equals(stubPath)\n-                                                    ? \"\"\n-                                                    : (\" or at \" + stubPathFull)));\n-                        }\n-                    }\n-                } else {\n+                if (in != null) {\n                     StubParser.parse(\n                             stubPath,\n                             in,\n"}}, {"oid": "15a6206778ff7afd216d6160512b0e7132aedaa2", "url": "https://github.com/typetools/checker-framework/commit/15a6206778ff7afd216d6160512b0e7132aedaa2", "message": "Resolve comments.", "committedDate": "2020-02-21T23:22:21Z", "type": "commit"}, {"oid": "df03ab239efe7ecb18fe6ec00b4a47642521597a", "url": "https://github.com/typetools/checker-framework/commit/df03ab239efe7ecb18fe6ec00b4a47642521597a", "message": "Tweaks.", "committedDate": "2020-02-21T23:51:41Z", "type": "commit"}, {"oid": "a4a54d73fbd642e80b08e91051278b3b3de562d7", "url": "https://github.com/typetools/checker-framework/commit/a4a54d73fbd642e80b08e91051278b3b3de562d7", "message": "Tweaks.", "committedDate": "2020-02-22T00:29:02Z", "type": "commit"}, {"oid": "380f85ea2ec0609e7c19126379d4eb25d06d19c7", "url": "https://github.com/typetools/checker-framework/commit/380f85ea2ec0609e7c19126379d4eb25d06d19c7", "message": "Tweaks.", "committedDate": "2020-02-22T00:31:14Z", "type": "commit"}, {"oid": "737095340253ad59d6d362d9b136615c6ba9e411", "url": "https://github.com/typetools/checker-framework/commit/737095340253ad59d6d362d9b136615c6ba9e411", "message": "Resolve comments.", "committedDate": "2020-02-24T22:08:35Z", "type": "commit"}, {"oid": "3d6b1174a51f6f6f5deb9533daa63307f1d68f4a", "url": "https://github.com/typetools/checker-framework/commit/3d6b1174a51f6f6f5deb9533daa63307f1d68f4a", "message": "Merge remote-tracking branch 'typetools/master' into avoid-unecessary-cannot-find-stub-file-warning", "committedDate": "2020-02-24T22:08:53Z", "type": "commit"}, {"oid": "fa58aaf18901df6ed935c64684ae6f1112bd20ad", "url": "https://github.com/typetools/checker-framework/commit/fa58aaf18901df6ed935c64684ae6f1112bd20ad", "message": "Merge remote-tracking branch 'typetools/master' into avoid-unecessary-cannot-find-stub-file-warning", "committedDate": "2020-02-24T23:28:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk3NDc5NQ==", "url": "https://github.com/typetools/checker-framework/pull/3100#discussion_r383974795", "bodyText": "@xingweitian Can you add the missing @param to make the tests pass. You didn't touch that method, but it is \"close\" to what you added.", "author": "wmdietl", "createdAt": "2020-02-25T16:02:23Z", "path": "framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java", "diffHunk": "@@ -515,6 +515,11 @@ protected void setParentChecker(SourceChecker parentChecker) {\n         this.parentChecker = parentChecker;\n     }\n \n+    /** @return the parent checker of the current checker */\n+    public SourceChecker getParentChecker() {\n+        return this.parentChecker;\n+    }\n+\n     /** Invoked when the current compilation unit root changes. */", "originalCommit": "fa58aaf18901df6ed935c64684ae6f1112bd20ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5f33d1c90467390d5c1d357a98721367507815fb", "chunk": "diff --git a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\nindex fe57e2b1b..860b0d8d4 100644\n--- a/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n+++ b/framework/src/main/java/org/checkerframework/framework/source/SourceChecker.java\n\n@@ -520,7 +520,11 @@ public abstract class SourceChecker extends AbstractTypeProcessor\n         return this.parentChecker;\n     }\n \n-    /** Invoked when the current compilation unit root changes. */\n+    /**\n+     * Invoked when the current compilation unit root changes.\n+     *\n+     * @param newRoot the new compilation unit root\n+     */\n     protected void setRoot(CompilationUnitTree newRoot) {\n         this.currentRoot = newRoot;\n         visitor.setRoot(currentRoot);\n"}}, {"oid": "5f33d1c90467390d5c1d357a98721367507815fb", "url": "https://github.com/typetools/checker-framework/commit/5f33d1c90467390d5c1d357a98721367507815fb", "message": "Add Javadoc.", "committedDate": "2020-02-25T20:13:11Z", "type": "commit"}]}