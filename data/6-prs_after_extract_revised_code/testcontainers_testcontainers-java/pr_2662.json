{"pr_number": 2662, "pr_title": "couchbase: wait until query engine knows about bucket before creating\u2026", "pr_createdAt": "2020-05-05T13:09:16Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2662", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r421549899", "bodyText": "Just a thought: all these Response objects ought to be closed (here and elsewhere). Otherwise we'll potentially be holding connections open on the client and server side.\nThis is probably much more important inside a retryUntilTrue invocation, as the frequency of retries could be high.\nLombok's @Cleanup annotation would be a cheap and easy way to ensure that these response objects get cleaned up.", "author": "rnorth", "createdAt": "2020-05-07T14:29:47Z", "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "diffHunk": "@@ -353,6 +355,24 @@ private void createBuckets() {\n                 .forStatusCode(200)\n                 .waitUntilReady(this);\n \n+            if (enabledServices.contains(CouchbaseService.QUERY)) {\n+                // If the query service is enabled, make sure that we only proceed if the query engine also\n+                // knows about the bucket in its metadata configuration.\n+                Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n+                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()", "originalCommit": "b78068d7de91ff93a9312960d78efee8d498ac21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDI3NQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r424690275", "bodyText": "@daschl ping", "author": "bsideup", "createdAt": "2020-05-13T19:48:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0NDU5Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r431644592", "bodyText": "sorry that I've been slow on this. Working on it now, will update the PR", "author": "daschl", "createdAt": "2020-05-28T07:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "chunk": "diff --git a/modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java b/modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java\nindex 1f9cc592..92b35da3 100644\n--- a/modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java\n+++ b/modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java\n\n@@ -359,7 +360,7 @@ public class CouchbaseContainer extends GenericContainer<CouchbaseContainer> {\n                 // If the query service is enabled, make sure that we only proceed if the query engine also\n                 // knows about the bucket in its metadata configuration.\n                 Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n-                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()\n+                    @Cleanup Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()\n                         .add(\"statement\", \"SELECT COUNT(*) > 0 as present FROM system:keyspaces WHERE name = \\\"\" + bucket.getName() + \"\\\"\")\n                         .build(), true);\n \n"}}, {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "url": "https://github.com/testcontainers/testcontainers-java/commit/cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "message": "couchbase: wait until query engine knows about bucket before creating primary index\n\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\n\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout.", "committedDate": "2020-05-28T07:52:47Z", "type": "commit"}, {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "url": "https://github.com/testcontainers/testcontainers-java/commit/cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "message": "couchbase: wait until query engine knows about bucket before creating primary index\n\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\n\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout.", "committedDate": "2020-05-28T07:52:47Z", "type": "forcePushed"}]}