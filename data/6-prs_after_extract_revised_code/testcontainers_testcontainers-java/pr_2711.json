{"pr_number": 2711, "pr_title": "Method to enable functions worker in pulsar container", "pr_createdAt": "2020-05-11T22:36:00Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2711", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzA4Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2711#discussion_r424697082", "bodyText": "I'd be better to store it as a boolean flag and decide which command to use in configure. Also, I'd use a composite wait strategy that will wait for both Pulsar's readiness and that the Function worker has started", "author": "bsideup", "createdAt": "2020-05-13T20:00:46Z", "path": "modules/pulsar/src/main/java/org/testcontainers/containers/PulsarContainer.java", "diffHunk": "@@ -25,6 +25,11 @@ public PulsarContainer(String pulsarVersion) {\n         waitingFor(Wait.forHttp(METRICS_ENDPOINT).forStatusCode(200).forPort(BROKER_HTTP_PORT));\n     }\n \n+    public PulsarContainer withFunctionsWorker() {", "originalCommit": "c378c71cb93df4ad27bf8ba32af8312ae9edb7c9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b7ae72e4f7ac05c6563eb3b541ecf4b5916b295c", "chunk": "diff --git a/modules/pulsar/src/main/java/org/testcontainers/containers/PulsarContainer.java b/modules/pulsar/src/main/java/org/testcontainers/containers/PulsarContainer.java\nindex 4cc16992..45ee804c 100644\n--- a/modules/pulsar/src/main/java/org/testcontainers/containers/PulsarContainer.java\n+++ b/modules/pulsar/src/main/java/org/testcontainers/containers/PulsarContainer.java\n\n@@ -21,13 +24,28 @@ public class PulsarContainer extends GenericContainer<PulsarContainer> {\n     public PulsarContainer(String pulsarVersion) {\n         super(TestcontainersConfiguration.getInstance().getPulsarImage() + \":\" + pulsarVersion);\n         withExposedPorts(BROKER_PORT, BROKER_HTTP_PORT);\n-        withCommand(\"/pulsar/bin/pulsar\", \"standalone\", \"--no-functions-worker\", \"-nss\");\n-        waitingFor(Wait.forHttp(METRICS_ENDPOINT).forStatusCode(200).forPort(BROKER_HTTP_PORT));\n+    }\n+\n+    @Override\n+    protected void configure() {\n+        super.configure();\n+\n+        WaitAllStrategy wait = new WaitAllStrategy()\n+            .withStrategy(Wait.forHttp(METRICS_ENDPOINT).forStatusCode(200).forPort(BROKER_HTTP_PORT));\n+\n+        if (functionsWorkerEnabled) {\n+            withCommand(\"/pulsar/bin/pulsar\", \"standalone\");\n+            wait.withStrategy(Wait.forLogMessage(\".*Function worker service started.*\", 1));\n+        } else {\n+            withCommand(\"/pulsar/bin/pulsar\", \"standalone\", \"--no-functions-worker\", \"-nss\");\n+        }\n+\n+        waitingFor(wait);\n     }\n \n     public PulsarContainer withFunctionsWorker() {\n-        return withCommand(\"/pulsar/bin/pulsar\", \"standalone\")\n-            .waitingFor(Wait.forLogMessage(\".*Function worker service started.*\", 1));\n+        functionsWorkerEnabled = true;\n+        return this;\n     }\n \n     public String getPulsarBrokerUrl() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzU4NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2711#discussion_r424697584", "bodyText": "Is there anything we can assert to ensure that it actually works?\nOtherwise, this test will pass if I make withFunctionsWorker NO-OP \ud83d\ude05", "author": "bsideup", "createdAt": "2020-05-13T20:01:45Z", "path": "modules/pulsar/src/test/java/org/testcontainers/containers/PulsarContainerTest.java", "diffHunk": "@@ -23,6 +23,13 @@ public void testUsage() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void shouldWaitForFunctionsWorkerStarted() {", "originalCommit": "c378c71cb93df4ad27bf8ba32af8312ae9edb7c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5NjAwMw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2711#discussion_r425096003", "bodyText": "log output changes, so its more like a check for a waiter. I can check that log output really contains worker output, but that would duplicate the waiter. Uploading function would require admin dependency. I can do that too and just commit really simple jar with rudimentary function", "author": "lanwen", "createdAt": "2020-05-14T12:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEzMzM5Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2711#discussion_r425133392", "bodyText": "implemented with real function", "author": "lanwen", "createdAt": "2020-05-14T13:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEzNTc3NQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2711#discussion_r425135775", "bodyText": "Isn't there some flag to check or something?\nIf not, let's use java.util.Objects#requireNonNull as a function, to avoid having to have a jar file", "author": "bsideup", "createdAt": "2020-05-14T13:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5NzU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "b7ae72e4f7ac05c6563eb3b541ecf4b5916b295c", "chunk": "diff --git a/modules/pulsar/src/test/java/org/testcontainers/containers/PulsarContainerTest.java b/modules/pulsar/src/test/java/org/testcontainers/containers/PulsarContainerTest.java\nindex a545eb0b..e7488060 100644\n--- a/modules/pulsar/src/test/java/org/testcontainers/containers/PulsarContainerTest.java\n+++ b/modules/pulsar/src/test/java/org/testcontainers/containers/PulsarContainerTest.java\n\n@@ -24,9 +31,28 @@ public class PulsarContainerTest {\n     }\n \n     @Test\n-    public void shouldWaitForFunctionsWorkerStarted() {\n-        try (PulsarContainer pulsar = new PulsarContainer().withFunctionsWorker()) {\n+    public void shouldWaitForFunctionsWorkerStarted() throws PulsarClientException, PulsarAdminException {\n+        try (PulsarContainer pulsar = new PulsarContainer(\"2.3.1\")\n+            .withClasspathResourceMapping(\"functions.jar\", \"/functions.jar\", BindMode.READ_ONLY)\n+            .withFunctionsWorker()) {\n+\n             pulsar.start();\n+\n+            PulsarAdmin pulsarAdmin = PulsarAdmin.builder()\n+                .serviceHttpUrl(pulsar.getHttpServiceUrl())\n+                .build();\n+\n+            pulsarAdmin.functions().createFunctionWithUrl(\n+                FunctionConfig.builder()\n+                    .tenant(\"public\")\n+                    .namespace(\"default\")\n+                    .name(\"exclamation\")\n+                    .inputs(Collections.singletonList(TEST_TOPIC))\n+                    .output(TEST_OUTPUT_TOPIC)\n+                    .className(\"com.example.IdentityFunction\")\n+                    .runtime(FunctionConfig.Runtime.JAVA).build(),\n+                \"file:/functions.jar\"\n+            );\n         }\n     }\n \n"}}, {"oid": "144a6c858ba01b7db8cbe87ee1f2beee6046b1c9", "url": "https://github.com/testcontainers/testcontainers-java/commit/144a6c858ba01b7db8cbe87ee1f2beee6046b1c9", "message": "Method to enable functions worker in pulsar container\n\nThis change should simplify a bit pulsar functions development experience\nTried here: https://github.com/lanwen/pulsar-functions-example\n\nWithout waiter pulsar could return random 503, depending on how fast\nwas a call.", "committedDate": "2020-05-14T13:39:21Z", "type": "commit"}, {"oid": "b7ae72e4f7ac05c6563eb3b541ecf4b5916b295c", "url": "https://github.com/testcontainers/testcontainers-java/commit/b7ae72e4f7ac05c6563eb3b541ecf4b5916b295c", "message": "treat functions worker method as a flag to enable in configure\n\nreal functions upload test", "committedDate": "2020-05-14T13:39:37Z", "type": "commit"}, {"oid": "45fddfd5ee4e7746f5edfca84fd161b4dd9f9c30", "url": "https://github.com/testcontainers/testcontainers-java/commit/45fddfd5ee4e7746f5edfca84fd161b4dd9f9c30", "message": "upd pulsar to 2.5.1", "committedDate": "2020-05-14T13:39:44Z", "type": "commit"}, {"oid": "45fddfd5ee4e7746f5edfca84fd161b4dd9f9c30", "url": "https://github.com/testcontainers/testcontainers-java/commit/45fddfd5ee4e7746f5edfca84fd161b4dd9f9c30", "message": "upd pulsar to 2.5.1", "committedDate": "2020-05-14T13:39:44Z", "type": "forcePushed"}, {"oid": "1d4abd3699a2ce4e10c256a62ba6aefc21968af8", "url": "https://github.com/testcontainers/testcontainers-java/commit/1d4abd3699a2ce4e10c256a62ba6aefc21968af8", "message": "don't store jar", "committedDate": "2020-05-14T16:53:12Z", "type": "commit"}, {"oid": "0cacdf5a2d1a55ad29c8c0b583254aeef4151877", "url": "https://github.com/testcontainers/testcontainers-java/commit/0cacdf5a2d1a55ad29c8c0b583254aeef4151877", "message": "expect error for functions without worker", "committedDate": "2020-05-15T13:26:40Z", "type": "commit"}, {"oid": "a01abd10b50f5383154db8548e3694d52da86b32", "url": "https://github.com/testcontainers/testcontainers-java/commit/a01abd10b50f5383154db8548e3694d52da86b32", "message": "reduce the changeset", "committedDate": "2020-06-30T14:32:59Z", "type": "commit"}]}