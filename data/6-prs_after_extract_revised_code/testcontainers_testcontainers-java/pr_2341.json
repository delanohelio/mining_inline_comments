{"pr_number": 2341, "pr_title": "Show port mappings in HttpWaitStrategy", "pr_createdAt": "2020-02-10T22:24:50Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2341", "timeline": [{"oid": "5d6c7f59f824ae8504eb4b82aac1cc4a8c61fd09", "url": "https://github.com/testcontainers/testcontainers-java/commit/5d6c7f59f824ae8504eb4b82aac1cc4a8c61fd09", "message": "Show port mappings in HttpWaitStrategy", "committedDate": "2020-02-10T22:21:38Z", "type": "commit"}, {"oid": "96bd3e6d8d262d79c575344b7e4e0c6f1502f553", "url": "https://github.com/testcontainers/testcontainers-java/commit/96bd3e6d8d262d79c575344b7e4e0c6f1502f553", "message": "Merge branch 'master' into httpwait-port-logging", "committedDate": "2020-02-16T20:54:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTQ0MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r392165440", "bodyText": "nit: could also be replaced with a stream :)\nint originalPort = waitStrategyTarget.getExposedPorts().stream()\n            .filter(it -> rawUri.getPort() == waitStrategyTarget.getMappedPort(it))\n            .findAny()\n            .orElse(-1);", "author": "bsideup", "createdAt": "2020-03-13T11:10:59Z", "path": "core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java", "diffHunk": "@@ -150,8 +150,17 @@ protected void waitUntilReady() {\n         if (null == livenessCheckPort || -1 == livenessCheckPort) {\n             return;\n         }\n-        final String uri = buildLivenessUri(livenessCheckPort).toString();\n-        log.info(\"{}: Waiting for {} seconds for URL: {}\", containerName, startupTimeout.getSeconds(), uri);\n+        final URI rawUri = buildLivenessUri(livenessCheckPort);\n+        // Un-map the port for logging\n+        int originalPort = -1;\n+        for (Integer exposedPort : waitStrategyTarget.getExposedPorts()) {", "originalCommit": "96bd3e6d8d262d79c575344b7e4e0c6f1502f553", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ee4323fefcf1b5a96bd11a93c4731edaacf1646b", "chunk": "diff --git a/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java b/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\nindex d6748d35..9a590d8b 100644\n--- a/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\n+++ b/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\n\n@@ -151,16 +151,15 @@ public class HttpWaitStrategy extends AbstractWaitStrategy {\n             return;\n         }\n         final URI rawUri = buildLivenessUri(livenessCheckPort);\n+\n         // Un-map the port for logging\n-        int originalPort = -1;\n-        for (Integer exposedPort : waitStrategyTarget.getExposedPorts()) {\n-            if (rawUri.getPort() == waitStrategyTarget.getMappedPort(exposedPort)) {\n-                originalPort = exposedPort;\n-                break;\n-            }\n-        }\n+        int originalPort = waitStrategyTarget.getExposedPorts().stream()\n+            .filter(exposedPort -> rawUri.getPort() == waitStrategyTarget.getMappedPort(exposedPort))\n+            .findFirst()\n+            .orElse(-1);\n+\n         final String uri = rawUri.toString();\n-        log.info(\"{}: Waiting for {} seconds for URL: {} (where {}-->{})\", containerName, startupTimeout.getSeconds(), uri, rawUri.getPort(), originalPort);\n+        log.info(\"{}: Waiting for {} seconds for URL: {} (where port {} maps to container port {})\", containerName, startupTimeout.getSeconds(), uri, rawUri.getPort(), originalPort);\n \n         // try to connect to the URL\n         try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r392165800", "bodyText": "getMappedPort may throw, please make sure you handle it too", "author": "bsideup", "createdAt": "2020-03-13T11:11:49Z", "path": "core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java", "diffHunk": "@@ -150,8 +150,17 @@ protected void waitUntilReady() {\n         if (null == livenessCheckPort || -1 == livenessCheckPort) {\n             return;\n         }\n-        final String uri = buildLivenessUri(livenessCheckPort).toString();\n-        log.info(\"{}: Waiting for {} seconds for URL: {}\", containerName, startupTimeout.getSeconds(), uri);\n+        final URI rawUri = buildLivenessUri(livenessCheckPort);\n+        // Un-map the port for logging\n+        int originalPort = -1;\n+        for (Integer exposedPort : waitStrategyTarget.getExposedPorts()) {\n+            if (rawUri.getPort() == waitStrategyTarget.getMappedPort(exposedPort)) {", "originalCommit": "96bd3e6d8d262d79c575344b7e4e0c6f1502f553", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg4NTMwMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r453885301", "bodyText": "I'm struggling to think of a scenario where this could throw and we'd want to continue...\n\nIf the container isn't started, waiting for the port should not succeed and should fail fast\nIf the port that was configured to be exposed cannot be mapped, something has gone seriously wrong with Docker\n\nIsn't it therefore correct to just let any failure bubble up immediately? Or have I missed a scenario?", "author": "rnorth", "createdAt": "2020-07-13T19:36:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxOTU4MQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r453919581", "bodyText": "testcontainers-java/core/src/main/java/org/testcontainers/containers/ContainerState.java\n    \n    \n         Line 141\n      in\n      780b8e3\n    \n    \n    \n    \n\n        \n          \n           Preconditions.checkState(this.getContainerId() != null, \"Mapped port can only be obtained after the container is started\"); \n        \n    \n  \n\n and \n  \n    \n      testcontainers-java/core/src/main/java/org/testcontainers/containers/ContainerState.java\n    \n    \n         Line 152\n      in\n      780b8e3\n    \n    \n    \n    \n\n        \n          \n           throw new IllegalArgumentException(\"Requested port (\" + originalPort + \") is not mapped\");", "author": "bsideup", "createdAt": "2020-07-13T20:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkyMDU5NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r453920594", "bodyText": "A custom implementation may also be provided. So I would make a best-effort attempt at obtaining the port, but not fail the strategy if it throws", "author": "bsideup", "createdAt": "2020-07-13T20:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk5MzQ0Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r454993442", "bodyText": "Yeah, those are the two scenarios I was referencing. When I looked, I couldn't seen anything overridable (i.e. this only calls private methods), but maybe I missed something.\nI'll have another look.", "author": "rnorth", "createdAt": "2020-07-15T11:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM2Nzk1Mw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2341#discussion_r456367953", "bodyText": "I'm still not sure we strictly need it, but I've added a try/catch anyway.", "author": "rnorth", "createdAt": "2020-07-17T10:48:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NTgwMA=="}], "type": "inlineReview", "revised_code": {"commit": "ee4323fefcf1b5a96bd11a93c4731edaacf1646b", "chunk": "diff --git a/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java b/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\nindex d6748d35..9a590d8b 100644\n--- a/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\n+++ b/core/src/main/java/org/testcontainers/containers/wait/strategy/HttpWaitStrategy.java\n\n@@ -151,16 +151,15 @@ public class HttpWaitStrategy extends AbstractWaitStrategy {\n             return;\n         }\n         final URI rawUri = buildLivenessUri(livenessCheckPort);\n+\n         // Un-map the port for logging\n-        int originalPort = -1;\n-        for (Integer exposedPort : waitStrategyTarget.getExposedPorts()) {\n-            if (rawUri.getPort() == waitStrategyTarget.getMappedPort(exposedPort)) {\n-                originalPort = exposedPort;\n-                break;\n-            }\n-        }\n+        int originalPort = waitStrategyTarget.getExposedPorts().stream()\n+            .filter(exposedPort -> rawUri.getPort() == waitStrategyTarget.getMappedPort(exposedPort))\n+            .findFirst()\n+            .orElse(-1);\n+\n         final String uri = rawUri.toString();\n-        log.info(\"{}: Waiting for {} seconds for URL: {} (where {}-->{})\", containerName, startupTimeout.getSeconds(), uri, rawUri.getPort(), originalPort);\n+        log.info(\"{}: Waiting for {} seconds for URL: {} (where port {} maps to container port {})\", containerName, startupTimeout.getSeconds(), uri, rawUri.getPort(), originalPort);\n \n         // try to connect to the URL\n         try {\n"}}, {"oid": "ee4323fefcf1b5a96bd11a93c4731edaacf1646b", "url": "https://github.com/testcontainers/testcontainers-java/commit/ee4323fefcf1b5a96bd11a93c4731edaacf1646b", "message": "Use stream to un-map exposed port", "committedDate": "2020-07-13T19:36:42Z", "type": "commit"}, {"oid": "9b1e3820a66e4b02eca33420dd13c8fcf1388750", "url": "https://github.com/testcontainers/testcontainers-java/commit/9b1e3820a66e4b02eca33420dd13c8fcf1388750", "message": "Merge remote-tracking branch 'origin/master' into httpwait-port-logging", "committedDate": "2020-07-13T19:37:03Z", "type": "commit"}, {"oid": "78ae76cf0719ada4734fe22520b38a8c7428356a", "url": "https://github.com/testcontainers/testcontainers-java/commit/78ae76cf0719ada4734fe22520b38a8c7428356a", "message": "Catch and log failures when logging", "committedDate": "2020-07-16T10:48:43Z", "type": "commit"}]}