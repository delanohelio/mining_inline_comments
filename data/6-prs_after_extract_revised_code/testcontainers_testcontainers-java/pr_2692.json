{"pr_number": 2692, "pr_title": "#2431 Correction for an edge case in local image repos (duplicates tags)", "pr_createdAt": "2020-05-09T22:41:54Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2692", "timeline": [{"oid": "88c47c31d5795a3e2320960e5185bd0170d5d43d", "url": "https://github.com/testcontainers/testcontainers-java/commit/88c47c31d5795a3e2320960e5185bd0170d5d43d", "message": "#2431 Correction for an edge case in local image repos (duplicates repo tags) crashing the image pulling", "committedDate": "2020-05-09T22:36:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MzAzMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2692#discussion_r423743031", "bodyText": "alternatively, one can provide a 3rd argument to toMap that won't throw", "author": "bsideup", "createdAt": "2020-05-12T13:42:38Z", "path": "core/src/main/java/org/testcontainers/images/LocalImagesCache.java", "diffHunk": "@@ -79,7 +79,11 @@ private void populateFromList(List<Image> images) {\n             }\n \n             cache.putAll(\n-                Stream.of(repoTags).collect(Collectors.toMap(\n+                Stream.of(repoTags)\n+                    // Protection against some edge case where local image repository tags end up with duplicates\n+                    // making toMap crash at merge time.\n+                   .distinct()", "originalCommit": "88c47c31d5795a3e2320960e5185bd0170d5d43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MjEwOA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2692#discussion_r424072108", "bodyText": "Merge function like (u, u2) -> u ?\nWould do the same thing with slightly worse performance  (merge function would be applied after key and value computation), no ?\nUp to you, tell me what you prefer.", "author": "Choobz", "createdAt": "2020-05-12T22:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MzAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2MDQ5Mg==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2692#discussion_r424260492", "bodyText": "Ok, you're right, let's keep distinct() \ud83d\udc4d", "author": "bsideup", "createdAt": "2020-05-13T08:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MzAzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d77d62eefb660ce4a1e503abd215e5a667c15bff", "chunk": "diff --git a/core/src/main/java/org/testcontainers/images/LocalImagesCache.java b/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\nindex d923434c..5d9b59ef 100644\n--- a/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\n+++ b/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\n\n@@ -82,7 +82,7 @@ enum LocalImagesCache {\n                 Stream.of(repoTags)\n                     // Protection against some edge case where local image repository tags end up with duplicates\n                     // making toMap crash at merge time.\n-                   .distinct()\n+                    .distinct()\n                     .collect(Collectors.toMap(\n                     DockerImageName::new,\n                     it -> ImageData.from(image)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2MDg1NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2692#discussion_r424260854", "bodyText": "could you please fix the indentation?", "author": "bsideup", "createdAt": "2020-05-13T08:25:12Z", "path": "core/src/main/java/org/testcontainers/images/LocalImagesCache.java", "diffHunk": "@@ -79,7 +79,11 @@ private void populateFromList(List<Image> images) {\n             }\n \n             cache.putAll(\n-                Stream.of(repoTags).collect(Collectors.toMap(\n+                Stream.of(repoTags)\n+                    // Protection against some edge case where local image repository tags end up with duplicates\n+                    // making toMap crash at merge time.\n+                   .distinct()\n+                    .collect(Collectors.toMap(\n                     DockerImageName::new,", "originalCommit": "88c47c31d5795a3e2320960e5185bd0170d5d43d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU5OTMyMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2692#discussion_r424599321", "bodyText": "Done", "author": "Choobz", "createdAt": "2020-05-13T17:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI2MDg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "d77d62eefb660ce4a1e503abd215e5a667c15bff", "chunk": "diff --git a/core/src/main/java/org/testcontainers/images/LocalImagesCache.java b/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\nindex d923434c..5d9b59ef 100644\n--- a/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\n+++ b/core/src/main/java/org/testcontainers/images/LocalImagesCache.java\n\n@@ -82,7 +82,7 @@ enum LocalImagesCache {\n                 Stream.of(repoTags)\n                     // Protection against some edge case where local image repository tags end up with duplicates\n                     // making toMap crash at merge time.\n-                   .distinct()\n+                    .distinct()\n                     .collect(Collectors.toMap(\n                     DockerImageName::new,\n                     it -> ImageData.from(image)\n"}}, {"oid": "d77d62eefb660ce4a1e503abd215e5a667c15bff", "url": "https://github.com/testcontainers/testcontainers-java/commit/d77d62eefb660ce4a1e503abd215e5a667c15bff", "message": "Indentation correction", "committedDate": "2020-05-13T10:34:06Z", "type": "commit"}, {"oid": "630ef8802c190bf3ee79033bb71300cdbdae9145", "url": "https://github.com/testcontainers/testcontainers-java/commit/630ef8802c190bf3ee79033bb71300cdbdae9145", "message": "Indentation correction", "committedDate": "2020-05-13T10:35:35Z", "type": "commit"}]}