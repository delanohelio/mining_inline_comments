{"pr_number": 1350, "pr_title": "Cloudblobstore retries", "pr_createdAt": "2020-01-06T18:33:11Z", "pr_url": "https://github.com/linkedin/ambry/pull/1350", "timeline": [{"oid": "bdcbdfc4710eeb1691ed40df963557a34570e42c", "url": "https://github.com/linkedin/ambry/commit/bdcbdfc4710eeb1691ed40df963557a34570e42c", "message": "First cut at retries on cloud operations", "committedDate": "2019-12-21T02:02:48Z", "type": "commit"}, {"oid": "2f79317af1d7794e44b23bb567a924e03452b522", "url": "https://github.com/linkedin/ambry/commit/2f79317af1d7794e44b23bb567a924e03452b522", "message": "Added tests and retry metrics.\nCloudBlobStore now has isVcr property.", "committedDate": "2020-01-04T03:01:03Z", "type": "commit"}, {"oid": "c228ccc86cdf806c9f4a4912b68346e7b75491da", "url": "https://github.com/linkedin/ambry/commit/c228ccc86cdf806c9f4a4912b68346e7b75491da", "message": "Test fixes", "committedDate": "2020-01-06T18:28:12Z", "type": "commit"}, {"oid": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "url": "https://github.com/linkedin/ambry/commit/ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "message": "Added config properties cloudMaxAttempts, cloudDefaultRetryDelay", "committedDate": "2020-01-06T18:50:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM3NzYyMA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365377620", "bodyText": "Should we try using Callable instead of using ThrowingRunnable.", "author": "ankagrawal", "createdAt": "2020-01-10T18:48:19Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwNzE0Nw==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366507147", "bodyText": "I was trying to unify the logic.  The problem is that Callable cannot return void, that's why I added a second method with ThrowingRunnable.  If you or @cgtz know another way to combine the two methods, I'd be all for it.", "author": "lightningrob", "createdAt": "2020-01-14T18:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM3NzYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU1MDAzMA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366550030", "bodyText": "Never mind, Casey showed me the trick to make it work.  This version is gone now.", "author": "lightningrob", "createdAt": "2020-01-14T20:13:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM3NzYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM3OTU0Mg==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365379542", "bodyText": "It might be a good idea to create a RetryUtil in ambry.commons, with the three methods we define here for retying. That way it becomes a common util which can be use somewhere else too if needed. Maybe for a future PR.\nNote: we might need to lambda or someother way to do metrics etc.", "author": "ankagrawal", "createdAt": "2020-01-10T18:52:24Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        action.run();\n+        return;\n+      } catch (Throwable e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private Map<String, CloudBlobMetadata> doWithRetries(Callable<Map<String, CloudBlobMetadata>> action,\n+      String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        return action.call();\n+      } catch (Exception e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Utility to either throw the input exception or sleep for a specified retry delay.\n+   * @param e the input exception to check.\n+   * @param attempts the number of attempts made so far.\n+   * @throws CloudStorageException\n+   */", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUwODQ0MA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366508440", "bodyText": "The retry logic is currently specific to CloudStorageException so not easy to generalize.  I could add an exception interface like RetryableException and have CloudStorageException implement that, then the logic could move to a utility.  Can we punt that to a future PR?", "author": "lightningrob", "createdAt": "2020-01-14T18:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM3OTU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MDg3OA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365380878", "bodyText": "javadocs for return is missing.", "author": "ankagrawal", "createdAt": "2020-01-10T18:55:24Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        action.run();\n+        return;\n+      } catch (Throwable e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MTkxOQ==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365381919", "bodyText": "javadocs missing for actionName.", "author": "ankagrawal", "createdAt": "2020-01-10T18:57:33Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MjE0MA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365382140", "bodyText": "javadocs missing for actionName", "author": "ankagrawal", "createdAt": "2020-01-10T18:58:00Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        action.run();\n+        return;\n+      } catch (Throwable e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MjIzMg==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365382232", "bodyText": "javadocs missing for actionName", "author": "ankagrawal", "createdAt": "2020-01-10T18:58:09Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +526,72 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        action.run();\n+        return;\n+      } catch (Throwable e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the action to execute.\n+   * @throws CloudStorageException\n+   */\n+  private Map<String, CloudBlobMetadata> doWithRetries(Callable<Map<String, CloudBlobMetadata>> action,\n+      String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        return action.call();\n+      } catch (Exception e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Utility to either throw the input exception or sleep for a specified retry delay.\n+   * @param e the input exception to check.\n+   * @param attempts the number of attempts made so far.\n+   * @throws CloudStorageException", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex b3cefb99b..f01344bcd 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -528,7 +528,8 @@ class CloudBlobStore implements Store {\n \n   /**\n    * Execute an action up to the configured number of attempts.\n-   * @param action the action to execute.\n+   * @param action the {@link ThrowingRunnable} to run.\n+   * @param actionName the name of the action.\n    * @throws CloudStorageException\n    */\n   private void doWithRetries(ThrowingRunnable action, String actionName) throws CloudStorageException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MzQ4NQ==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r365383485", "bodyText": "we can define isRetryable here instead of above.", "author": "ankagrawal", "createdAt": "2020-01-10T19:01:08Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java", "diffHunk": "@@ -457,6 +458,28 @@ AzureBlobDataAccessor getAzureBlobDataAccessor() {\n     return azureBlobDataAccessor;\n   }\n \n+  /**\n+   * Construct a {@link CloudStorageException} from a root cause exception.\n+   * @param message the exception message.\n+   * @param e the root cause exception.\n+   * @return the {@link CloudStorageException}.\n+   */\n+  private static final CloudStorageException toCloudStorageException(String message, Exception e) {\n+    boolean isRetryable = false;\n+    Long retryDelayMs = null;\n+    int statusCode = -1;\n+    if (e instanceof BlobStorageException) {\n+      statusCode = ((BlobStorageException) e).getStatusCode();\n+    }\n+    else if (e instanceof DocumentClientException) {\n+      statusCode = ((DocumentClientException) e).getStatusCode();\n+      retryDelayMs = ((DocumentClientException) e).getRetryAfterInMilliseconds();\n+    }\n+    // Everything is retryable except NOT_FOUND\n+    isRetryable = (statusCode != HttpConstants.StatusCodes.NOTFOUND);", "originalCommit": "ed6d9f6f8c1268a53049e70e7bd184daae95d9b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUxMTU4MQ==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366511581", "bodyText": "Good point.  Is it okay to fix this in a follow up PR?  This class has work in progress for another ticket.", "author": "lightningrob", "createdAt": "2020-01-14T18:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4MzQ4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8c707bacfa7815574c71622b2cda308f7333570d", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\nindex 09adf2cc1..838c439e3 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\n\n@@ -470,8 +470,7 @@ class AzureCloudDestination implements CloudDestination {\n     int statusCode = -1;\n     if (e instanceof BlobStorageException) {\n       statusCode = ((BlobStorageException) e).getStatusCode();\n-    }\n-    else if (e instanceof DocumentClientException) {\n+    } else if (e instanceof DocumentClientException) {\n       statusCode = ((DocumentClientException) e).getStatusCode();\n       retryDelayMs = ((DocumentClientException) e).getRetryAfterInMilliseconds();\n     }\n"}}, {"oid": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "url": "https://github.com/linkedin/ambry/commit/bf038fd48e258b9cedf39cb26dbce6a729c935e8", "message": "Address Ankur's review comments.", "committedDate": "2020-01-14T18:53:48Z", "type": "commit"}, {"oid": "bf038fd48e258b9cedf39cb26dbce6a729c935e8", "url": "https://github.com/linkedin/ambry/commit/bf038fd48e258b9cedf39cb26dbce6a729c935e8", "message": "Address Ankur's review comments.", "committedDate": "2020-01-14T18:53:48Z", "type": "forcePushed"}, {"oid": "bb78130156ec55bbdaf68e0bc29db8102f6cc722", "url": "https://github.com/linkedin/ambry/commit/bb78130156ec55bbdaf68e0bc29db8102f6cc722", "message": "Revert test properties changes", "committedDate": "2020-01-14T22:54:38Z", "type": "commit"}, {"oid": "a39c28ca51aafcc51a7d9846fcaa5de05defdd59", "url": "https://github.com/linkedin/ambry/commit/a39c28ca51aafcc51a7d9846fcaa5de05defdd59", "message": "Revert unintentional changes", "committedDate": "2020-01-14T23:17:34Z", "type": "commit"}, {"oid": "a39c28ca51aafcc51a7d9846fcaa5de05defdd59", "url": "https://github.com/linkedin/ambry/commit/a39c28ca51aafcc51a7d9846fcaa5de05defdd59", "message": "Revert unintentional changes", "committedDate": "2020-01-14T23:17:34Z", "type": "forcePushed"}, {"oid": "ff07d562d960e99682dc28977fe38335af18a355", "url": "https://github.com/linkedin/ambry/commit/ff07d562d960e99682dc28977fe38335af18a355", "message": "More reversions", "committedDate": "2020-01-14T23:23:42Z", "type": "commit"}, {"oid": "35334a292fe64b20303b8eb6fb019ef67bc04346", "url": "https://github.com/linkedin/ambry/commit/35334a292fe64b20303b8eb6fb019ef67bc04346", "message": "Redo changes to retry utility", "committedDate": "2020-01-14T23:32:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzMTk1MA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366631950", "bodyText": "Can you save the last exception encountered and make it the cause of this exception?\n      } catch (Exception e) {\n        attempts++;\n        throwOrDelay(e, actionName, attempts);\n        lastException = e;\n      }\n    }\n    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\", lastException);", "author": "cgtz", "createdAt": "2020-01-14T23:46:40Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +530,55 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the {@link Callable} to call.\n+   * @param actionName the name of the action.\n+   * @return the return value of the action.\n+   * @throws CloudStorageException\n+   */\n+  private <T> T doWithRetries(Callable<T> action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        return action.call();\n+      } catch (Exception e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");", "originalCommit": "35334a292fe64b20303b8eb6fb019ef67bc04346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MjI5Mw==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366642293", "bodyText": "Actually, I guess this code may not be possible to reach with the implementation of throwOrDelay, since the method throws when attempts is exhausted.", "author": "cgtz", "createdAt": "2020-01-15T00:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzMTk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MDA0Ng==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r367040046", "bodyText": "Right.  I will add a comment that the last line shouldn't be reached.", "author": "lightningrob", "createdAt": "2020-01-15T18:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzMTk1MA=="}], "type": "inlineReview", "revised_code": {"commit": "8c707bacfa7815574c71622b2cda308f7333570d", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex 87d244f8f..97ee541a3 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -547,6 +547,7 @@ class CloudBlobStore implements Store {\n         throwOrDelay(e, actionName, attempts);\n       }\n     }\n+    // Line should never be reached\n     throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MDczMg==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366640732", "bodyText": "why not use the built in logger formatting?\nlogger.error(\"{} failed attempt {}, retrying after {} ms.\", actionName, attempts, delay);", "author": "cgtz", "createdAt": "2020-01-15T00:19:46Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java", "diffHunk": "@@ -503,6 +530,55 @@ private void checkStarted() throws StoreException {\n     }\n   }\n \n+  /**\n+   * Execute an action up to the configured number of attempts.\n+   * @param action the {@link Callable} to call.\n+   * @param actionName the name of the action.\n+   * @return the return value of the action.\n+   * @throws CloudStorageException\n+   */\n+  private <T> T doWithRetries(Callable<T> action, String actionName) throws CloudStorageException {\n+    int attempts = 0;\n+    while (attempts < maxAttempts) {\n+      try {\n+        return action.call();\n+      } catch (Exception e) {\n+        attempts++;\n+        throwOrDelay(e, actionName, attempts);\n+      }\n+    }\n+    throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n+  }\n+\n+  /**\n+   * Utility to either throw the input exception or sleep for a specified retry delay.\n+   * @param e the input exception to check.\n+   * @param actionName the name of the action that threw the exception.\n+   * @param attempts the number of attempts made so far.\n+   * @throws CloudStorageException\n+   */\n+  private void throwOrDelay(Throwable e, String actionName, int attempts) throws CloudStorageException {\n+    if (e instanceof CloudStorageException) {\n+      CloudStorageException cse = (CloudStorageException) e;\n+      if (cse.isRetryable() && attempts < maxAttempts) {\n+        long delay = (cse.getRetryDelayMs() > 0) ? cse.getRetryDelayMs() : defaultRetryDelay;\n+        logger.error(String.format(\"%s failed attempt %d, retrying after %d ms.\", actionName, attempts, delay));", "originalCommit": "35334a292fe64b20303b8eb6fb019ef67bc04346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0MDM2MA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r367040360", "bodyText": "I think I was using the string in an exception but switched to log message.  Will fix.", "author": "lightningrob", "createdAt": "2020-01-15T18:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MDczMg=="}], "type": "inlineReview", "revised_code": {"commit": "8c707bacfa7815574c71622b2cda308f7333570d", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\nindex 87d244f8f..97ee541a3 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/CloudBlobStore.java\n\n@@ -547,6 +547,7 @@ class CloudBlobStore implements Store {\n         throwOrDelay(e, actionName, attempts);\n       }\n     }\n+    // Line should never be reached\n     throw new CloudStorageException(actionName + \" failed \" + attempts + \" attempts\");\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0MzIyNA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366643224", "bodyText": "can you reformat this file?", "author": "cgtz", "createdAt": "2020-01-15T00:29:14Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java", "diffHunk": "@@ -457,6 +458,28 @@ AzureBlobDataAccessor getAzureBlobDataAccessor() {\n     return azureBlobDataAccessor;\n   }\n \n+  /**\n+   * Construct a {@link CloudStorageException} from a root cause exception.\n+   * @param message the exception message.\n+   * @param e the root cause exception.\n+   * @return the {@link CloudStorageException}.\n+   */\n+  private static final CloudStorageException toCloudStorageException(String message, Exception e) {\n+    boolean isRetryable = false;\n+    Long retryDelayMs = null;\n+    int statusCode = -1;\n+    if (e instanceof BlobStorageException) {\n+      statusCode = ((BlobStorageException) e).getStatusCode();\n+    }\n+    else if (e instanceof DocumentClientException) {", "originalCommit": "35334a292fe64b20303b8eb6fb019ef67bc04346", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8c707bacfa7815574c71622b2cda308f7333570d", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\nindex 09adf2cc1..838c439e3 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/azure/AzureCloudDestination.java\n\n@@ -470,8 +470,7 @@ class AzureCloudDestination implements CloudDestination {\n     int statusCode = -1;\n     if (e instanceof BlobStorageException) {\n       statusCode = ((BlobStorageException) e).getStatusCode();\n-    }\n-    else if (e instanceof DocumentClientException) {\n+    } else if (e instanceof DocumentClientException) {\n       statusCode = ((DocumentClientException) e).getStatusCode();\n       retryDelayMs = ((DocumentClientException) e).getRetryAfterInMilliseconds();\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NTM2OQ==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r366645369", "bodyText": "A Timer is actually a combination of a Meter (for rate tracking) and a Histogram of durations. Did you want to monitor specific percentiles of retry wait times, or are you more interested in the total time spent waiting? If it is the latter, you may want to consider either a Counter for this metric if you want a count/second, or a Gauge if you want to record the cumulative time spent waiting for one run of an ambry process.", "author": "cgtz", "createdAt": "2020-01-15T00:37:41Z", "path": "ambry-cloud/src/main/java/com.github.ambry.cloud/VcrMetrics.java", "diffHunk": "@@ -37,6 +37,11 @@\n   public final Counter addPartitionErrorCount;\n   public final Counter removePartitionErrorCount;\n   public final Counter tokenReloadWarnCount;\n+  // Retry metrics\n+  /** Number of times operation was retried */\n+  public final Counter retryCount;\n+  /** Cumulative time spent waiting before retries */", "originalCommit": "35334a292fe64b20303b8eb6fb019ef67bc04346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0Nzk3MQ==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r367047971", "bodyText": "Good question.  I've used Timers for all the timing metrics but don't care about the histogram in this case, just the amount of time the process spends waiting during call retries, relative to elapsed time.  So maybe Counter is better. Gauge seems less useful if you don't know how long the process has been up.", "author": "lightningrob", "createdAt": "2020-01-15T18:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA1MTc1OA==", "url": "https://github.com/linkedin/ambry/pull/1350#discussion_r367051758", "bodyText": "Yeah, I'd probably go with Counter in this case.  IMO, the name Timer is a little misleading for what it is", "author": "cgtz", "createdAt": "2020-01-15T19:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY0NTM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8c707bacfa7815574c71622b2cda308f7333570d", "chunk": "diff --git a/ambry-cloud/src/main/java/com.github.ambry.cloud/VcrMetrics.java b/ambry-cloud/src/main/java/com.github.ambry.cloud/VcrMetrics.java\nindex cb7194001..0402295b2 100644\n--- a/ambry-cloud/src/main/java/com.github.ambry.cloud/VcrMetrics.java\n+++ b/ambry-cloud/src/main/java/com.github.ambry.cloud/VcrMetrics.java\n\n@@ -40,8 +40,8 @@ public class VcrMetrics {\n   // Retry metrics\n   /** Number of times operation was retried */\n   public final Counter retryCount;\n-  /** Cumulative time spent waiting before retries */\n-  public final Timer retryWaitTime;\n+  /** Number of msec spent waiting between retries */\n+  public final Counter retryWaitTimeMsec;\n \n   public VcrMetrics(MetricRegistry registry) {\n     this.registry = registry;\n"}}, {"oid": "8c707bacfa7815574c71622b2cda308f7333570d", "url": "https://github.com/linkedin/ambry/commit/8c707bacfa7815574c71622b2cda308f7333570d", "message": "Address Casey's review comments, change retryWaitTime metric to counter.", "committedDate": "2020-01-15T19:01:09Z", "type": "commit"}]}