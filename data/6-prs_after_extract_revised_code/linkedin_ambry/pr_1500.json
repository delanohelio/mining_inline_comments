{"pr_number": 1500, "pr_title": "Account for replica state when randomly selecting writable partition", "pr_createdAt": "2020-05-04T16:38:22Z", "pr_url": "https://github.com/linkedin/ambry/pull/1500", "timeline": [{"oid": "9ba10b9763c7f44172acb6e36c4be855057e1b15", "url": "https://github.com/linkedin/ambry/commit/9ba10b9763c7f44172acb6e36c4be855057e1b15", "message": "Account for replica state when randomly selecting writable partition\n\nPreviously writable partition is selected based on 1. partition state(read-write)\n2.replicas of partition are up. This logic is correct in most cases but may have\ntwo minor issues: (1) replicas are up but not in a required state for PUT. (2)\nreplica is actually down but failure detector temporarily marks it up after backoff.\nThis PR introduces 3rd criterion that ensures alive replicas are in eligible states\nfor PUT operation. Together with previous two criteria, the partition selection logic\nis able to preclude some unsatisfied partitions.", "committedDate": "2020-05-04T16:25:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEyNzA3NQ==", "url": "https://github.com/linkedin/ambry/pull/1500#discussion_r421127075", "bodyText": "This is a nitpick. Feel free to ignore, if you don't feel like it.\nI would suggest that either we name both methods (getRandomWritablePartition, hasEnoughEligibleReplicasForPut) to one of these names\n\n(getRandomWritablePartition, hasEnoughEligibleWritableReplicas)\n(getRandomPartitionForPut, hasEnoughEligibleReplicasForPut)\n\nBut if we decide to take approach 2, then we should also rename these:\nClusterMap::getRandomWritablePartition to ClusterMap::getRandomPartitionForPut\nPartitionLayout::getRandomWritablePartition to PartitionLayout::getRandomPartitionForPut", "author": "ankagrawal", "createdAt": "2020-05-06T22:23:39Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -505,17 +506,19 @@ PartitionId getRandomWritablePartition(String partitionClass, List<PartitionId>\n     }\n \n     /**\n-     * Check whether the parition has has enough replicas up for write operations to try. Enough replicas is considered\n-     * to be all local replicas if such information is available. In case localDatacenterName is not available, all of\n-     * the partition's replicas should be up.\n+     * Check whether the partition has enough eligible replicas for write operations to try. Here, \"eligible\" means\n+     * replica is up and in required states for PUT request. Enough replicas is considered to be all local replicas if\n+     * such information is available. In case localDatacenterName is not available, all of the partition's replicas\n+     * should be up.\n      * @param partitionId the {@link PartitionId} to check.\n-     * @return true if enough replicas are up; false otherwise.\n+     * @return true if enough replicas are eligible; false otherwise.\n      */\n-    private boolean areEnoughReplicasForPartitionUp(PartitionId partitionId) {\n+    private boolean hasEnoughEligibleReplicasForPut(PartitionId partitionId) {", "originalCommit": "9ba10b9763c7f44172acb6e36c4be855057e1b15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEzNjY0MA==", "url": "https://github.com/linkedin/ambry/pull/1500#discussion_r421136640", "bodyText": "Option 1 sounds like a good name to me without requiring many public interface changes", "author": "cgtz", "createdAt": "2020-05-06T22:49:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEyNzA3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE2MDA1Mg==", "url": "https://github.com/linkedin/ambry/pull/1500#discussion_r421160052", "bodyText": "sure, let's take option 1", "author": "jsjtzyy", "createdAt": "2020-05-06T23:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEyNzA3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "bb51477987a4059a00242c1bb45a6a6f831d9f12", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\nindex c885eb2f4..eb5b9bde9 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n\n@@ -507,13 +507,13 @@ public class ClusterMapUtils {\n \n     /**\n      * Check whether the partition has enough eligible replicas for write operations to try. Here, \"eligible\" means\n-     * replica is up and in required states for PUT request. Enough replicas is considered to be all local replicas if\n-     * such information is available. In case localDatacenterName is not available, all of the partition's replicas\n-     * should be up.\n+     * replica is up and in required states for PUT request (i.e LEADER or STANDBY). Enough replicas is considered to be\n+     * all local replicas if such information is available. In case localDatacenterName is not available, all of the\n+     * partition's replicas should be up.\n      * @param partitionId the {@link PartitionId} to check.\n      * @return true if enough replicas are eligible; false otherwise.\n      */\n-    private boolean hasEnoughEligibleReplicasForPut(PartitionId partitionId) {\n+    private boolean hasEnoughEligibleWritableReplicas(PartitionId partitionId) {\n       if (localDatacenterName != null && !localDatacenterName.isEmpty()) {\n         return areAllLocalReplicasForPartitionUp(partitionId) && areAllReplicaStatesEligibleForPut(partitionId,\n             localDatacenterName);\n"}}, {"oid": "bb51477987a4059a00242c1bb45a6a6f831d9f12", "url": "https://github.com/linkedin/ambry/commit/bb51477987a4059a00242c1bb45a6a6f831d9f12", "message": "comments", "committedDate": "2020-05-07T00:06:47Z", "type": "commit"}]}