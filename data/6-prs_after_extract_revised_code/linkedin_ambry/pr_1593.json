{"pr_number": 1593, "pr_title": "Convert (and cache) remote keys in replication GET response for timed out standby replicas in leader-based replication", "pr_createdAt": "2020-07-21T00:42:32Z", "pr_url": "https://github.com/linkedin/ambry/pull/1593", "timeline": [{"oid": "8b69b7a9a61b4560a66f2981246ab708a9db2ee4", "url": "https://github.com/linkedin/ambry/commit/8b69b7a9a61b4560a66f2981246ab708a9db2ee4", "message": "During replication, as of part of legacy GDPR requirements, remote keys are converted (and cached) to local keys using StoreKeyConverter during metadata exchange. These converted/cached keys are used for validation and transformation after the missing blobs are fetched for them. In case of leader-based replication, when we are fetching missing blobs for standby replicas (timed out waiting for their keys to arrive from leaders), StoreKeyConverter would have cleared these keys from its cachewhile it is replicating with other replicas before time out happened. This fix is to re-convert remote keys and fill the cache when we fetch missing blobs for timed out standby replicas.", "committedDate": "2020-07-21T00:14:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNzI3OQ==", "url": "https://github.com/linkedin/ambry/pull/1593#discussion_r457827279", "bodyText": "If we move this to handling no progress replicas code block (line 438 ~470), we might be able to re-use batchConvertReplicaMetadataResponseKeys without creating a new method.\nIt seems the one minor change would suffice: change argument of batchConvertReplicaMetadataResponseKeys from ReplicaMetadataResponse to List<ExchangeMetadataResponse>", "author": "jsjtzyy", "createdAt": "2020-07-21T04:21:39Z", "path": "ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java", "diffHunk": "@@ -708,6 +708,13 @@ void fixMissingStoreKeys(ConnectedChannel connectedChannel, List<RemoteReplicaIn\n       GetResponse getResponse =\n           getMessagesForMissingKeys(connectedChannel, exchangeMetadataResponseList, replicasToReplicatePerNode,\n               remoteNode, remoteColoGetRequestForStandby);\n+      if (remoteColoGetRequestForStandby) {\n+        // If we are fetching missing keys for standby replicas (timed out waiting for their keys to arrive from leaders)\n+        // during leader-based replication, convert (and cache) received keys in the GET response. This is needed as the\n+        // StoreKeyConverter would have cleared these keys from its cache as it is replicating with other replicas before\n+        // time out happened for these standby replicas.\n+        batchConvertGetResponseKeys(getResponse);", "originalCommit": "8b69b7a9a61b4560a66f2981246ab708a9db2ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "612a3c88d9207f13f3ac7c07cc45035daaa22841", "chunk": "diff --git a/ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java b/ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java\nindex 7863e2388..8105e052c 100644\n--- a/ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java\n+++ b/ambry-replication/src/main/java/com/github/ambry/replication/ReplicaThread.java\n\n@@ -708,13 +718,6 @@ public class ReplicaThread implements Runnable {\n       GetResponse getResponse =\n           getMessagesForMissingKeys(connectedChannel, exchangeMetadataResponseList, replicasToReplicatePerNode,\n               remoteNode, remoteColoGetRequestForStandby);\n-      if (remoteColoGetRequestForStandby) {\n-        // If we are fetching missing keys for standby replicas (timed out waiting for their keys to arrive from leaders)\n-        // during leader-based replication, convert (and cache) received keys in the GET response. This is needed as the\n-        // StoreKeyConverter would have cleared these keys from its cache as it is replicating with other replicas before\n-        // time out happened for these standby replicas.\n-        batchConvertGetResponseKeys(getResponse);\n-      }\n       writeMessagesToLocalStoreAndAdvanceTokens(exchangeMetadataResponseList, getResponse, replicasToReplicatePerNode,\n           remoteNode, remoteColoGetRequestForStandby);\n     } finally {\n"}}, {"oid": "612a3c88d9207f13f3ac7c07cc45035daaa22841", "url": "https://github.com/linkedin/ambry/commit/612a3c88d9207f13f3ac7c07cc45035daaa22841", "message": "Re-use existing code in batchConvertReplicaMetadataResponseKeys to do key conversion while fetching keys for timed out standby replicas", "committedDate": "2020-07-21T17:20:52Z", "type": "commit"}, {"oid": "d95e2d389e49f82e93eb27926832c24bcffce551", "url": "https://github.com/linkedin/ambry/commit/d95e2d389e49f82e93eb27926832c24bcffce551", "message": "Minor change: change word 'Inactive' to 'blocked' while referencing timed out standby replicas", "committedDate": "2020-07-21T19:53:14Z", "type": "commit"}]}