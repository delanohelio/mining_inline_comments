{"pr_number": 1618, "pr_title": "Fix a NullPointerException in PutOperation's fillChunk method", "pr_createdAt": "2020-09-03T23:23:30Z", "pr_url": "https://github.com/linkedin/ambry/pull/1618", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyOTU5Mw==", "url": "https://github.com/linkedin/ambry/pull/1618#discussion_r483329593", "bodyText": "is there a unit test we could write to reproduce the NPE?", "author": "cgtz", "createdAt": "2020-09-04T01:01:54Z", "path": "ambry-router/src/main/java/com/github/ambry/router/PutOperation.java", "diffHunk": "@@ -590,7 +590,7 @@ void fillChunks() {\n         // the chunk above.\n         PutChunk lastChunk = getBuildingChunk();\n         if (lastChunk != null) {\n-          if (chunkCounter != 0 && lastChunk.buf.readableBytes() == 0) {\n+          if (chunkCounter != 0 && (lastChunk.buf == null || lastChunk.buf.readableBytes() == 0)) {", "originalCommit": "9a3b12776ea5cd1dabce316a2dd2b50de854258c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg4NDA3NQ==", "url": "https://github.com/linkedin/ambry/pull/1618#discussion_r483884075", "bodyText": "Unfortunately, I haven't figured out the root cause of this exception. But it keeps happening, so I want to push out a fix first.", "author": "justinlin-linkedin", "createdAt": "2020-09-04T23:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyOTU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODIwNzAxNA==", "url": "https://github.com/linkedin/ambry/pull/1618#discussion_r488207014", "bodyText": "In what scenario lastChunk != null but lastChunk == null ?", "author": "jsjtzyy", "createdAt": "2020-09-14T20:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyOTU5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg4NTkxNg==", "url": "https://github.com/linkedin/ambry/pull/1618#discussion_r497885916", "bodyText": "The root cause is found and the test cases added.", "author": "justinlin-linkedin", "createdAt": "2020-10-01T00:42:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzMyOTU5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "55985a7d995c54892ae97da176514ac0ed8c60de", "chunk": "diff --git a/ambry-router/src/main/java/com/github/ambry/router/PutOperation.java b/ambry-router/src/main/java/com/github/ambry/router/PutOperation.java\nindex 2c8c4c371..bdb5394c5 100644\n--- a/ambry-router/src/main/java/com/github/ambry/router/PutOperation.java\n+++ b/ambry-router/src/main/java/com/github/ambry/router/PutOperation.java\n\n@@ -590,8 +590,10 @@ class PutOperation {\n         // the chunk above.\n         PutChunk lastChunk = getBuildingChunk();\n         if (lastChunk != null) {\n-          if (chunkCounter != 0 && (lastChunk.buf == null || lastChunk.buf.readableBytes() == 0)) {\n+          if (chunkCounter != 0 && lastChunk.buf.readableBytes() == 0) {\n             logger.trace(\"The last buffer(s) received from chunkFillerChannel have no data, discarding them.\");\n+            lastChunk.releaseBlobContent();\n+            lastChunk.state = ChunkState.Free;\n           } else {\n             lastChunk.onFillComplete(true);\n             updateChunkFillerWaitTimeMetrics();\n"}}, {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de", "url": "https://github.com/linkedin/ambry/commit/55985a7d995c54892ae97da176514ac0ed8c60de", "message": "Fix a NPE in PutOperation ChunkFiller thread", "committedDate": "2020-10-01T00:31:35Z", "type": "commit"}, {"oid": "55985a7d995c54892ae97da176514ac0ed8c60de", "url": "https://github.com/linkedin/ambry/commit/55985a7d995c54892ae97da176514ac0ed8c60de", "message": "Fix a NPE in PutOperation ChunkFiller thread", "committedDate": "2020-10-01T00:31:35Z", "type": "forcePushed"}]}