{"pr_number": 1551, "pr_title": "Patches for Http2", "pr_createdAt": "2020-06-05T19:52:06Z", "pr_url": "https://github.com/linkedin/ambry/pull/1551", "timeline": [{"oid": "56ca277b0a5d63d9dd6663f742727c3749fa2d17", "url": "https://github.com/linkedin/ambry/commit/56ca277b0a5d63d9dd6663f742727c3749fa2d17", "message": "Patches", "committedDate": "2020-06-05T20:08:11Z", "type": "forcePushed"}, {"oid": "4de8d22b997e104a40850ebca040d63b0a415af0", "url": "https://github.com/linkedin/ambry/commit/4de8d22b997e104a40850ebca040d63b0a415af0", "message": "Patches", "committedDate": "2020-06-05T21:07:35Z", "type": "commit"}, {"oid": "4de8d22b997e104a40850ebca040d63b0a415af0", "url": "https://github.com/linkedin/ambry/commit/4de8d22b997e104a40850ebca040d63b0a415af0", "message": "Patches", "committedDate": "2020-06-05T21:07:35Z", "type": "forcePushed"}, {"oid": "a2262bc591c5eef8a215849a77c1c768088fda5d", "url": "https://github.com/linkedin/ambry/commit/a2262bc591c5eef8a215849a77c1c768088fda5d", "message": "share handlers as much as possible", "committedDate": "2020-06-05T22:51:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTYyOA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436201628", "bodyText": "Maybe make this handler a static class in Http2BlockingChannel (or its own file like the other handlers) since most of the logic is about how the netty pipeline interacts with that class", "author": "cgtz", "createdAt": "2020-06-05T23:09:49Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+package com.github.ambry.network.http2;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.handler.codec.http.FullHttpResponse;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http2.Http2StreamFrameToHttpObjectCodec;\n+import io.netty.util.concurrent.Promise;\n+\n+\n+/**\n+ * A ChannelInitializer used to setup stream channel pipeline once stream is created in {@link MultiplexedChannelRecord}.\n+ */\n+public class Http2BlockingChannelStreamChannelInitializer extends ChannelInitializer {\n+\n+  private final int http2MaxContentLength;\n+\n+  Http2BlockingChannelStreamChannelInitializer(int http2MaxContentLength) {\n+    this.http2MaxContentLength = http2MaxContentLength;\n+  }\n+\n+  @Override\n+  protected void initChannel(Channel ch) throws Exception {\n+    ChannelPipeline p = ch.pipeline();\n+    p.addLast(new Http2StreamFrameToHttpObjectCodec(false));\n+    p.addLast(new HttpObjectAggregator(http2MaxContentLength));\n+    p.addLast(new SimpleChannelInboundHandler<FullHttpResponse>() {", "originalCommit": "a2262bc591c5eef8a215849a77c1c768088fda5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg2NjA5MQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436866091", "bodyText": "Created its own file.", "author": "zzmao", "createdAt": "2020-06-08T17:16:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjIwMTYyOA=="}], "type": "inlineReview", "revised_code": {"commit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\nindex b16821012..608799898 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\n\n@@ -14,16 +14,11 @@\n  */\n package com.github.ambry.network.http2;\n \n-import io.netty.buffer.ByteBuf;\n import io.netty.channel.Channel;\n-import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.ChannelInitializer;\n import io.netty.channel.ChannelPipeline;\n-import io.netty.channel.SimpleChannelInboundHandler;\n-import io.netty.handler.codec.http.FullHttpResponse;\n import io.netty.handler.codec.http.HttpObjectAggregator;\n import io.netty.handler.codec.http2.Http2StreamFrameToHttpObjectCodec;\n-import io.netty.util.concurrent.Promise;\n \n \n /**\n"}}, {"oid": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "url": "https://github.com/linkedin/ambry/commit/35c68aa0205bfc84741e64a5595013a33ef6dc31", "message": "add Http2BlockingChannelResponseHandler", "committedDate": "2020-06-08T17:15:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3ODc5MQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436878791", "bodyText": "Could this be shareable?", "author": "cgtz", "createdAt": "2020-06-08T17:35:43Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+package com.github.ambry.network.http2;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.handler.codec.http.FullHttpResponse;\n+import io.netty.util.concurrent.Promise;\n+\n+\n+/**\n+ * Netty handler for {@link Http2BlockingChannel} to handle {@link FullHttpResponse}.\n+ */\n+public class Http2BlockingChannelResponseHandler extends SimpleChannelInboundHandler<FullHttpResponse> {", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f129615a23a33387b2868478c91e69b578245012", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\nindex 69ece4804..1297d996d 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\n\n@@ -15,6 +15,7 @@\n package com.github.ambry.network.http2;\n \n import io.netty.buffer.ByteBuf;\n+import io.netty.channel.ChannelHandler;\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.SimpleChannelInboundHandler;\n import io.netty.handler.codec.http.FullHttpResponse;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg3OTI3MQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436879271", "bodyText": "Looks like AmbrySendToHttp2Adaptor is marked shareable, but a new instance is being created for each channel", "author": "cgtz", "createdAt": "2020-06-08T17:36:32Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+package com.github.ambry.network.http2;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http2.Http2StreamFrameToHttpObjectCodec;\n+\n+\n+/**\n+ * A ChannelInitializer used to setup stream channel pipeline once stream is created in {@link MultiplexedChannelRecord}.\n+ */\n+public class Http2BlockingChannelStreamChannelInitializer extends ChannelInitializer {\n+\n+  private final int http2MaxContentLength;\n+\n+  Http2BlockingChannelStreamChannelInitializer(int http2MaxContentLength) {\n+    this.http2MaxContentLength = http2MaxContentLength;\n+  }\n+\n+  @Override\n+  protected void initChannel(Channel ch) throws Exception {\n+    ChannelPipeline p = ch.pipeline();\n+    p.addLast(new Http2StreamFrameToHttpObjectCodec(false));\n+    p.addLast(new HttpObjectAggregator(http2MaxContentLength));\n+    p.addLast(new Http2BlockingChannelResponseHandler());\n+    p.addLast(new AmbrySendToHttp2Adaptor());", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f129615a23a33387b2868478c91e69b578245012", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\nindex 608799898..be768d41e 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java\n\n@@ -25,8 +25,12 @@ import io.netty.handler.codec.http2.Http2StreamFrameToHttpObjectCodec;\n  * A ChannelInitializer used to setup stream channel pipeline once stream is created in {@link MultiplexedChannelRecord}.\n  */\n public class Http2BlockingChannelStreamChannelInitializer extends ChannelInitializer {\n-\n   private final int http2MaxContentLength;\n+  private static Http2StreamFrameToHttpObjectCodec http2StreamFrameToHttpObjectCodec =\n+      new Http2StreamFrameToHttpObjectCodec(false);\n+  private static Http2BlockingChannelResponseHandler http2BlockingChannelResponseHandler =\n+      new Http2BlockingChannelResponseHandler();\n+  private static AmbrySendToHttp2Adaptor ambrySendToHttp2Adaptor = new AmbrySendToHttp2Adaptor();\n \n   Http2BlockingChannelStreamChannelInitializer(int http2MaxContentLength) {\n     this.http2MaxContentLength = http2MaxContentLength;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MDgyOA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436880828", "bodyText": "why include the hashcode in this log message?", "author": "cgtz", "createdAt": "2020-06-08T17:39:27Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2ClientResponseHandler.java", "diffHunk": "@@ -66,16 +67,8 @@ protected void channelRead0(ChannelHandlerContext ctx, FullHttpResponse msg) {\n   @Override\n   public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n     http2ClientMetrics.http2StreamExceptionCount.inc();\n-    logger.info(\"Exception Caught from inbound.\", cause.getMessage());\n-    releaseAndCloseStreamChannel(ctx);\n-  }\n-\n-  private void releaseAndCloseStreamChannel(ChannelHandlerContext ctx) {\n-    logger.debug(\"Stream channel is being closed. Stream: {}, Parent: {}\", ctx.channel(), ctx.channel().parent());\n-    ctx.channel()\n-        .parent()\n-        .attr(Http2MultiplexedChannelPool.HTTP2_MULTIPLEXED_CHANNEL_POOL)\n-        .get()\n-        .release(ctx.channel());\n+    logger.info(\"Exception caught from in Http2ClientResponseHandler {} {}. Closing stream channel. Cause: \",\n+        ctx.channel().hashCode(), ctx.channel(), cause);", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxNzY4Ng==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436917686", "bodyText": "All stream channels use the same parent channel + H2 stream id as the output string, however, sometimes, H2 stream id is -1. If we want to track this kind of stream, we need a unique id, so I used hashCode().", "author": "zzmao", "createdAt": "2020-06-08T18:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MDgyOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4Mjg4Ng==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436882886", "bodyText": "why is the http2ClientConfig passed in from the constructor not used here?", "author": "cgtz", "createdAt": "2020-06-08T17:43:12Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2MultiplexedChannelPool.java", "diffHunk": "@@ -92,13 +94,16 @@\n    * @param eventLoopGroup The event loop group.\n    * @param http2ClientConfig http2 client configs.\n    * @param http2ClientMetrics http2 client metrics.\n+   * @param streamChannelInitializer {@link ChannelInitializer} to initilize a stream channel pipeline\n    */\n   public Http2MultiplexedChannelPool(InetSocketAddress inetSocketAddress, SSLFactory sslFactory,\n-      EventLoopGroup eventLoopGroup, Http2ClientConfig http2ClientConfig, Http2ClientMetrics http2ClientMetrics) {\n+      EventLoopGroup eventLoopGroup, Http2ClientConfig http2ClientConfig, Http2ClientMetrics http2ClientMetrics,\n+      ChannelInitializer streamChannelInitializer) {\n     this(new SimpleChannelPool(createBootStrap(eventLoopGroup, http2ClientConfig, inetSocketAddress),\n             new Http2ChannelPoolHandler(sslFactory, inetSocketAddress.getHostName(), inetSocketAddress.getPort(),\n                 http2ClientConfig)), eventLoopGroup, ConcurrentHashMap.newKeySet(), inetSocketAddress,\n-        new Http2ClientConfig(new VerifiableProperties(new Properties())), http2ClientMetrics);\n+        new Http2ClientConfig(new VerifiableProperties(new Properties())), http2ClientMetrics,", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxODAyOQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436918029", "bodyText": "good catch. http2ClientConfig should be used. I guess it was because refactor.", "author": "zzmao", "createdAt": "2020-06-08T18:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4Mjg4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f129615a23a33387b2868478c91e69b578245012", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2MultiplexedChannelPool.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2MultiplexedChannelPool.java\nindex 865fc1829..4b671ca52 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2MultiplexedChannelPool.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2MultiplexedChannelPool.java\n\n@@ -101,9 +101,8 @@ public class Http2MultiplexedChannelPool implements ChannelPool {\n       ChannelInitializer streamChannelInitializer) {\n     this(new SimpleChannelPool(createBootStrap(eventLoopGroup, http2ClientConfig, inetSocketAddress),\n             new Http2ChannelPoolHandler(sslFactory, inetSocketAddress.getHostName(), inetSocketAddress.getPort(),\n-                http2ClientConfig)), eventLoopGroup, ConcurrentHashMap.newKeySet(), inetSocketAddress,\n-        new Http2ClientConfig(new VerifiableProperties(new Properties())), http2ClientMetrics,\n-        streamChannelInitializer);\n+                http2ClientConfig)), eventLoopGroup, ConcurrentHashMap.newKeySet(), inetSocketAddress, http2ClientConfig,\n+        http2ClientMetrics, streamChannelInitializer);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4NzQxNA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436887414", "bodyText": "nit: you might be able to use releaseAndCloseStreamChannel in warmUpConnections too.", "author": "cgtz", "createdAt": "2020-06-08T17:51:04Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java", "diffHunk": "@@ -124,6 +133,10 @@ public void operationComplete(ChannelFuture future) throws Exception {\n     }\n     http2ClientMetrics.http2ClientSendTime.update(System.currentTimeMillis() - startTime);\n     // TODO: close stream channel for requestsToDrop. Need a hashmap from corelationId to streamChannel\n+    if (requestsToDrop.size() != 0) {\n+      logger.warn(\"Number of requestsToDrop: {}\", requestsToDrop.size());\n+      http2ClientMetrics.http2RequestsToDropCount.inc(requestsToDrop.size());\n+    }\n \n     http2ClientResponseHandler.getResponseInfoQueue().poll(readyResponseInfos, pollTimeoutMs);", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "f129615a23a33387b2868478c91e69b578245012", "url": "https://github.com/linkedin/ambry/commit/f129615a23a33387b2868478c91e69b578245012", "message": "address cgetz comments", "committedDate": "2020-06-08T18:47:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTAzMw==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436889033", "bodyText": "Not used.", "author": "justinlin-linkedin", "createdAt": "2020-06-08T17:53:48Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java", "diffHunk": "@@ -18,6 +18,7 @@\n import com.github.ambry.router.AsyncWritableChannel;\n import com.github.ambry.router.Callback;", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NjYzMg==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436976632", "bodyText": "removed", "author": "zzmao", "createdAt": "2020-06-08T20:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTAzMw=="}], "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java b/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\nindex 1cba3e0dd..400b91df7 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\n\n@@ -13,10 +13,7 @@\n  */\n package com.github.ambry.network.http2;\n \n-import com.github.ambry.commons.RetainingAsyncWritableChannel;\n import com.github.ambry.network.Send;\n-import com.github.ambry.router.AsyncWritableChannel;\n-import com.github.ambry.router.Callback;\n import com.github.ambry.utils.ByteBufChannel;\n import io.netty.channel.ChannelHandler;\n import io.netty.channel.ChannelHandlerContext;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTQ2NQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436889465", "bodyText": "logger is not used anywhere.", "author": "justinlin-linkedin", "createdAt": "2020-06-08T17:54:25Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java", "diffHunk": "@@ -34,6 +35,7 @@\n /**\n  * Translates Ambry {@link Send} to the HTTP/2 frame objects.\n  */\n+@ChannelHandler.Sharable\n public class AmbrySendToHttp2Adaptor extends ChannelOutboundHandlerAdapter {\n   private static final Logger logger = LoggerFactory.getLogger(AmbrySendToHttp2Adaptor.class);", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NjY5NA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436976694", "bodyText": "removed", "author": "zzmao", "createdAt": "2020-06-08T20:21:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4OTQ2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java b/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\nindex 1cba3e0dd..400b91df7 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/AmbrySendToHttp2Adaptor.java\n\n@@ -37,8 +34,6 @@ import org.slf4j.LoggerFactory;\n  */\n @ChannelHandler.Sharable\n public class AmbrySendToHttp2Adaptor extends ChannelOutboundHandlerAdapter {\n-  private static final Logger logger = LoggerFactory.getLogger(AmbrySendToHttp2Adaptor.class);\n-\n   public AmbrySendToHttp2Adaptor() {\n \n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MDI4MQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436890281", "bodyText": "not used anywhere.", "author": "justinlin-linkedin", "createdAt": "2020-06-08T17:55:47Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java", "diffHunk": "@@ -50,11 +44,11 @@\n  */\n public class Http2BlockingChannel implements ConnectedChannel {\n   private static final Logger logger = LoggerFactory.getLogger(Http2BlockingChannel.class);", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NjcyNw==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436976727", "bodyText": "removed", "author": "zzmao", "createdAt": "2020-06-08T20:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MDI4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\nindex 7ebd5e14d..7e8f3ea28 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\n\n@@ -47,12 +47,10 @@ public class Http2BlockingChannel implements ConnectedChannel {\n   private Promise<ByteBuf> responsePromise;\n   private final Http2MultiplexedChannelPool http2MultiplexedChannelPool;\n   private final Http2ClientConfig http2ClientConfig;\n-  private final Http2ClientMetrics http2ClientMetrics;\n   final static AttributeKey<Promise<ByteBuf>> RESPONSE_PROMISE = AttributeKey.newInstance(\"ResponsePromise\");\n \n   public Http2BlockingChannel(Http2MultiplexedChannelPool http2MultiplexedChannelPool) {\n     this.http2MultiplexedChannelPool = http2MultiplexedChannelPool;\n-    this.http2ClientMetrics = http2MultiplexedChannelPool.getHttp2ClientMetrics();\n     this.http2ClientConfig = http2MultiplexedChannelPool.getHttp2ClientConfig();\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTAzMQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436891031", "bodyText": "nit: since the http2ClientMetrics is not used in this class, we don't need to have a reference of this object in this class.", "author": "justinlin-linkedin", "createdAt": "2020-06-08T17:57:02Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java", "diffHunk": "@@ -78,7 +72,8 @@ public Http2BlockingChannel(String hostName, int port, SSLConfig sslConfig, Http\n     this.http2MultiplexedChannelPool =\n         new Http2MultiplexedChannelPool(new InetSocketAddress(hostName, port), nettySslHttp2Factory,\n             Epoll.isAvailable() ? new EpollEventLoopGroup() : new NioEventLoopGroup(), http2ClientConfig,\n-            http2ClientMetrics);\n+            http2ClientMetrics,", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NTA2NA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436975064", "bodyText": "good point.", "author": "zzmao", "createdAt": "2020-06-08T20:18:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MTAzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\nindex 7ebd5e14d..7e8f3ea28 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannel.java\n\n@@ -68,7 +66,6 @@ public class Http2BlockingChannel implements ConnectedChannel {\n       throw new IllegalStateException(\"Can't create NettySslHttp2Factory: \", e);\n     }\n     this.http2ClientConfig = http2ClientConfig;\n-    this.http2ClientMetrics = http2ClientMetrics;\n     this.http2MultiplexedChannelPool =\n         new Http2MultiplexedChannelPool(new InetSocketAddress(hostName, port), nettySslHttp2Factory,\n             Epoll.isAvailable() ? new EpollEventLoopGroup() : new NioEventLoopGroup(), http2ClientConfig,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxNDU1Ng==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436914556", "bodyText": "hmm, Do we have to add a responseInfo to the queue when writeAndFlush failed?", "author": "justinlin-linkedin", "createdAt": "2020-06-08T18:39:26Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java", "diffHunk": "@@ -106,14 +109,20 @@ public void operationComplete(ChannelFuture future) throws Exception {\n                     requestInfo.setStreamSendTime(System.currentTimeMillis());\n                   } else {\n                     http2ClientMetrics.http2StreamWriteAndFlushErrorCount.inc();\n-                    logger.warn(\"Stream writeAndFlush fail: {}\", future.cause());\n+                    logger.warn(\"Stream {} {} writeAndFlush fail. Cause: \", streamChannel.hashCode(), streamChannel,\n+                        future.cause());\n+                    // Set attribute null and close stream. It's possible that exception was fired on parent channel close\n+                    // and triggered releaseAndCloseStreamChannel before, but it's tolerable to call releaseAndCloseStreamChannel\n+                    // again as streamChannel close happen in event loop. No impact to main flow.\n+                    // For netty 4.1.42.Final, streamChannel can be close twice without any exception.\n+                    releaseAndCloseStreamChannel(streamChannel);", "originalCommit": "35c68aa0205bfc84741e64a5595013a33ef6dc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk3NDkwOQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436974909", "bodyText": "yes, we needed....", "author": "zzmao", "createdAt": "2020-06-08T20:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxNDU1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java\nindex 34ab1eb07..b37023e75 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2NetworkClient.java\n\n@@ -116,6 +116,8 @@ public class Http2NetworkClient implements NetworkClient {\n                     // again as streamChannel close happen in event loop. No impact to main flow.\n                     // For netty 4.1.42.Final, streamChannel can be close twice without any exception.\n                     releaseAndCloseStreamChannel(streamChannel);\n+                    http2ClientResponseHandler.getResponseInfoQueue()\n+                        .put(new ResponseInfo(requestInfo, NetworkClientErrorCode.NetworkError, null));\n                   }\n                   // release related bytebuf\n                   requestInfo.getRequest().release();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkyNDg0NA==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r436924844", "bodyText": "we should use getAndSet(null) here to release the reference as well.", "author": "justinlin-linkedin", "createdAt": "2020-06-08T18:58:22Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+package com.github.ambry.network.http2;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.ChannelHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.handler.codec.http.FullHttpResponse;\n+import io.netty.util.concurrent.Promise;\n+\n+\n+/**\n+ * Netty handler for {@link Http2BlockingChannel} to handle {@link FullHttpResponse}.\n+ */\n+@ChannelHandler.Sharable\n+public class Http2BlockingChannelResponseHandler extends SimpleChannelInboundHandler<FullHttpResponse> {\n+  @Override\n+  protected void channelRead0(ChannelHandlerContext ctx, FullHttpResponse msg) throws Exception {\n+    Promise<ByteBuf> promise = ctx.channel().attr(Http2BlockingChannel.RESPONSE_PROMISE).get();", "originalCommit": "f129615a23a33387b2868478c91e69b578245012", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3f1819af5afd75846ae8dacf6facc6719232a261", "chunk": "diff --git a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\nindex 1297d996d..ecace6bd0 100644\n--- a/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\n+++ b/ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelResponseHandler.java\n\n@@ -29,7 +29,7 @@ import io.netty.util.concurrent.Promise;\n public class Http2BlockingChannelResponseHandler extends SimpleChannelInboundHandler<FullHttpResponse> {\n   @Override\n   protected void channelRead0(ChannelHandlerContext ctx, FullHttpResponse msg) throws Exception {\n-    Promise<ByteBuf> promise = ctx.channel().attr(Http2BlockingChannel.RESPONSE_PROMISE).get();\n+    Promise<ByteBuf> promise = ctx.channel().attr(Http2BlockingChannel.RESPONSE_PROMISE).getAndSet(null);\n     if (promise != null) {\n       promise.setSuccess(msg.content().retainedDuplicate());\n       // Stream channel can't be reused. Release it here.\n"}}, {"oid": "3f1819af5afd75846ae8dacf6facc6719232a261", "url": "https://github.com/linkedin/ambry/commit/3f1819af5afd75846ae8dacf6facc6719232a261", "message": "address justin comments", "committedDate": "2020-06-08T20:20:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY1OTM4OQ==", "url": "https://github.com/linkedin/ambry/pull/1551#discussion_r437659389", "bodyText": "nit: final for these 3.", "author": "cgtz", "createdAt": "2020-06-09T19:14:02Z", "path": "ambry-network/src/main/java/com/github/ambry/network/http2/Http2BlockingChannelStreamChannelInitializer.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *\n+ */\n+package com.github.ambry.network.http2;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http2.Http2StreamFrameToHttpObjectCodec;\n+\n+\n+/**\n+ * A ChannelInitializer used to setup stream channel pipeline once stream is created in {@link MultiplexedChannelRecord}.\n+ */\n+public class Http2BlockingChannelStreamChannelInitializer extends ChannelInitializer {\n+  private final int http2MaxContentLength;\n+  private static Http2StreamFrameToHttpObjectCodec http2StreamFrameToHttpObjectCodec =", "originalCommit": "3f1819af5afd75846ae8dacf6facc6719232a261", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}