{"pr_number": 1617, "pr_title": "Add DumpCompactionLog tool and other minor change", "pr_createdAt": "2020-09-03T20:28:51Z", "pr_url": "https://github.com/linkedin/ambry/pull/1617", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODM5OQ==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r488108399", "bodyText": "I think you wanted StringBuilder here.", "author": "jsjtzyy", "createdAt": "2020-09-14T17:37:13Z", "path": "ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java", "diffHunk": "@@ -380,6 +385,35 @@ byte to indicate whether startOffsetOfLastIndexSegmentForDeleteCheck is present\n     }\n   }\n \n+  @Override\n+  public String toString() {\n+    StringBuffer buffer = new StringBuffer();", "originalCommit": "348626030a0bf973a42cfa43ed3a70b177cea142", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxMDU0OA==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r497810548", "bodyText": "That's right, string builder should be much faster.", "author": "justinlin-linkedin", "createdAt": "2020-09-30T21:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwODM5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "chunk": "diff --git a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\nindex b2c4e8a31..275bf2d5c 100644\n--- a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n+++ b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n\n@@ -387,8 +395,8 @@ class CompactionLog implements Closeable {\n \n   @Override\n   public String toString() {\n-    StringBuffer buffer = new StringBuffer();\n-    buffer.append(\"Version:\")\n+    StringBuilder sb = new StringBuilder();\n+    sb.append(\"Version:\")\n         .append(CURRENT_VERSION)\n         .append(\"\\n\")\n         .append(\"StartTime:\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTM1Mg==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r488111352", "bodyText": "Same here", "author": "jsjtzyy", "createdAt": "2020-09-14T17:42:45Z", "path": "ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java", "diffHunk": "@@ -479,5 +513,26 @@ safeToken if not null (see StoreFindToken#toBytes())\n       bufWrap.put(safeTokenBytes);\n       return buf;\n     }\n+\n+    @Override\n+    public String toString() {\n+      StringBuffer buffer = new StringBuffer();", "originalCommit": "348626030a0bf973a42cfa43ed3a70b177cea142", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgxMDg3MQ==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r497810871", "bodyText": "updated", "author": "justinlin-linkedin", "createdAt": "2020-09-30T21:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTM1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "chunk": "diff --git a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\nindex b2c4e8a31..275bf2d5c 100644\n--- a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n+++ b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n\n@@ -516,8 +524,8 @@ class CompactionLog implements Closeable {\n \n     @Override\n     public String toString() {\n-      StringBuffer buffer = new StringBuffer();\n-      buffer.append(\"CompactionDetal:\")\n+      StringBuilder sb = new StringBuilder();\n+      sb.append(\"CompactionDetails:\")\n           .append(compactionDetails.toString())\n           .append(\"\\n\")\n           .append(\"CopyStartTime:\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMTc3MA==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r488111770", "bodyText": "typo: CompactionDetails", "author": "jsjtzyy", "createdAt": "2020-09-14T17:43:28Z", "path": "ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java", "diffHunk": "@@ -479,5 +513,26 @@ safeToken if not null (see StoreFindToken#toBytes())\n       bufWrap.put(safeTokenBytes);\n       return buf;\n     }\n+\n+    @Override\n+    public String toString() {\n+      StringBuffer buffer = new StringBuffer();\n+      buffer.append(\"CompactionDetal:\")", "originalCommit": "348626030a0bf973a42cfa43ed3a70b177cea142", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "chunk": "diff --git a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\nindex b2c4e8a31..275bf2d5c 100644\n--- a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n+++ b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n\n@@ -516,8 +524,8 @@ class CompactionLog implements Closeable {\n \n     @Override\n     public String toString() {\n-      StringBuffer buffer = new StringBuffer();\n-      buffer.append(\"CompactionDetal:\")\n+      StringBuilder sb = new StringBuilder();\n+      sb.append(\"CompactionDetails:\")\n           .append(compactionDetails.toString())\n           .append(\"\\n\")\n           .append(\"CopyStartTime:\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExMzM1Mg==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r488113352", "bodyText": "Probably we also need to check if token exists and append it to string if present.", "author": "jsjtzyy", "createdAt": "2020-09-14T17:46:14Z", "path": "ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java", "diffHunk": "@@ -479,5 +513,26 @@ safeToken if not null (see StoreFindToken#toBytes())\n       bufWrap.put(safeTokenBytes);\n       return buf;\n     }\n+\n+    @Override\n+    public String toString() {\n+      StringBuffer buffer = new StringBuffer();\n+      buffer.append(\"CompactionDetal:\")\n+          .append(compactionDetails.toString())\n+          .append(\"\\n\")\n+          .append(\"CopyStartTime:\")\n+          .append(copyStartTime)\n+          .append(\"\\n\")\n+          .append(\"CommitStartTime:\")\n+          .append(commitStartTime)\n+          .append(\"\\n\")\n+          .append(\"CleanupStartTime:\")\n+          .append(cleanupStartTime)\n+          .append(\"\\n\")\n+          .append(\"CycleEndTime:\")\n+          .append(cycleEndTime)\n+          .append(\"\\n\");", "originalCommit": "348626030a0bf973a42cfa43ed3a70b177cea142", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "chunk": "diff --git a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\nindex b2c4e8a31..275bf2d5c 100644\n--- a/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n+++ b/ambry-store/src/main/java/com/github/ambry/store/CompactionLog.java\n\n@@ -516,8 +524,8 @@ class CompactionLog implements Closeable {\n \n     @Override\n     public String toString() {\n-      StringBuffer buffer = new StringBuffer();\n-      buffer.append(\"CompactionDetal:\")\n+      StringBuilder sb = new StringBuilder();\n+      sb.append(\"CompactionDetails:\")\n           .append(compactionDetails.toString())\n           .append(\"\\n\")\n           .append(\"CopyStartTime:\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODExNDIxNQ==", "url": "https://github.com/linkedin/ambry/pull/1617#discussion_r488114215", "bodyText": "nit: call this DumpCompactionLogTool", "author": "jsjtzyy", "createdAt": "2020-09-14T17:47:46Z", "path": "ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLog.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/**\n+ * Copyright 2020 LinkedIn Corp. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ */\n+package com.github.ambry.store;\n+\n+import com.github.ambry.clustermap.ClusterAgentsFactory;\n+import com.github.ambry.clustermap.ClusterMap;\n+import com.github.ambry.commons.BlobIdFactory;\n+import com.github.ambry.config.ClusterMapConfig;\n+import com.github.ambry.config.StoreConfig;\n+import com.github.ambry.config.VerifiableProperties;\n+import com.github.ambry.tools.util.ToolUtils;\n+import com.github.ambry.utils.SystemTime;\n+import com.github.ambry.utils.Time;\n+import com.github.ambry.utils.Utils;\n+import java.io.File;\n+\n+\n+public class DumpCompactionLog {", "originalCommit": "348626030a0bf973a42cfa43ed3a70b177cea142", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "chunk": "diff --git a/ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLog.java b/ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLogTool.java\nsimilarity index 95%\nrename from ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLog.java\nrename to ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLogTool.java\nindex b21570f23..f065bea30 100644\n--- a/ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLog.java\n+++ b/ambry-tools/src/main/java/com/github/ambry/store/DumpCompactionLogTool.java\n\n@@ -26,7 +26,10 @@ import com.github.ambry.utils.Utils;\n import java.io.File;\n \n \n-public class DumpCompactionLog {\n+/**\n+ * The tool to print out the compaction log details from a given compaction log file.\n+ */\n+public class DumpCompactionLogTool {\n \n   private static class DumpCompactionLogConfig {\n     final String hardwareLayoutFilePath;\n"}}, {"oid": "073810d73a6f4e7ce9a0d7839322afe97a18b5fe", "url": "https://github.com/linkedin/ambry/commit/073810d73a6f4e7ce9a0d7839322afe97a18b5fe", "message": "WIP", "committedDate": "2020-09-30T18:11:17Z", "type": "commit"}, {"oid": "ae8b9a8369703e5f31fadf42de923901aad67501", "url": "https://github.com/linkedin/ambry/commit/ae8b9a8369703e5f31fadf42de923901aad67501", "message": "WIP", "committedDate": "2020-09-30T18:11:17Z", "type": "commit"}, {"oid": "e553c742f92b09b5b5c95d61f1314d3545f57004", "url": "https://github.com/linkedin/ambry/commit/e553c742f92b09b5b5c95d61f1314d3545f57004", "message": "Add DumpCompactionLog", "committedDate": "2020-09-30T18:11:17Z", "type": "commit"}, {"oid": "619d5737ba0fa8e10a18644986974a8ab4e382aa", "url": "https://github.com/linkedin/ambry/commit/619d5737ba0fa8e10a18644986974a8ab4e382aa", "message": "Fix error", "committedDate": "2020-09-30T18:11:17Z", "type": "commit"}, {"oid": "619d5737ba0fa8e10a18644986974a8ab4e382aa", "url": "https://github.com/linkedin/ambry/commit/619d5737ba0fa8e10a18644986974a8ab4e382aa", "message": "Fix error", "committedDate": "2020-09-30T18:11:17Z", "type": "forcePushed"}, {"oid": "3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "url": "https://github.com/linkedin/ambry/commit/3ebc48203676f2a8dd94ef55ca9edd4ac2cef748", "message": "Address comments", "committedDate": "2020-09-30T21:33:18Z", "type": "commit"}]}