{"pr_number": 1682, "pr_title": "[BlobStoreCompaction] Add metric to record the duplicate puts", "pr_createdAt": "2020-11-02T21:58:31Z", "pr_url": "https://github.com/linkedin/ambry/pull/1682", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAyMTcwOQ==", "url": "https://github.com/linkedin/ambry/pull/1682#discussion_r517021709", "bodyText": "nit: maybe following is more readable:\nif ( recoveryStartToken == null || !recoveryStartToken.getOffset().equals(indexSegmentStartOffset))", "author": "jsjtzyy", "createdAt": "2020-11-03T23:50:09Z", "path": "ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java", "diffHunk": "@@ -631,6 +639,10 @@ private boolean isDuplicate(IndexEntry copyCandidate, FileSpan duplicateSearchSp\n         logger.trace(\"{} in segment with start offset {} in {} is a duplicate because it has already been copied\",\n             copyCandidate, indexSegmentStartOffset, storeId);\n         isDuplicate = true;\n+        if (!(recoveryStartToken != null && recoveryStartToken.getOffset().equals(indexSegmentStartOffset))) {", "originalCommit": "ca2ef13cb64319ac2eb40d7bae5e53645fec298c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ed261e45358eb6763b967a0ee92dab39ece122d", "chunk": "diff --git a/ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java b/ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java\nindex af65d8435..64d8e3fba 100644\n--- a/ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java\n+++ b/ambry-store/src/main/java/com/github/ambry/store/BlobStoreCompactor.java\n\n@@ -639,7 +648,7 @@ class BlobStoreCompactor {\n         logger.trace(\"{} in segment with start offset {} in {} is a duplicate because it has already been copied\",\n             copyCandidate, indexSegmentStartOffset, storeId);\n         isDuplicate = true;\n-        if (!(recoveryStartToken != null && recoveryStartToken.getOffset().equals(indexSegmentStartOffset))) {\n+        if (!isIndexSegmentUnderCopy(indexSegmentStartOffset)) {\n           // This is not for recovery purpose, then it must be due to always checking target index duplicate.\n           tgtMetrics.compactionTargetIndexDuplicateOnNonRecoveryCount.inc();\n         }\n"}}, {"oid": "d09fbe06ff61c8cc9e14be084de3d40bbed553cf", "url": "https://github.com/linkedin/ambry/commit/d09fbe06ff61c8cc9e14be084de3d40bbed553cf", "message": "[BlobStoreCompaction] Add metric to record the duplicate puts", "committedDate": "2020-11-04T19:20:33Z", "type": "commit"}, {"oid": "8ed261e45358eb6763b967a0ee92dab39ece122d", "url": "https://github.com/linkedin/ambry/commit/8ed261e45358eb6763b967a0ee92dab39ece122d", "message": "Address comments", "committedDate": "2020-11-04T21:55:47Z", "type": "commit"}, {"oid": "8ed261e45358eb6763b967a0ee92dab39ece122d", "url": "https://github.com/linkedin/ambry/commit/8ed261e45358eb6763b967a0ee92dab39ece122d", "message": "Address comments", "committedDate": "2020-11-04T21:55:47Z", "type": "forcePushed"}]}