{"pr_number": 1472, "pr_title": "Add basic support for multiple participants on server side", "pr_createdAt": "2020-04-13T05:13:45Z", "pr_url": "https://github.com/linkedin/ambry/pull/1472", "timeline": [{"oid": "9024da4aadb1c689ef193ce4305d8280f52f438c", "url": "https://github.com/linkedin/ambry/commit/9024da4aadb1c689ef193ce4305d8280f52f438c", "message": "Add basic support for multiple participants on server side\n\nIn some cases where single datanode has to parcipate into mulitiple clusters\nand it needs to update node info in these clusters separately. This requires\nmuptiple participants on same node and each of them is responsible for interacting\nwith corresponding cluster. With this feature, we are able to build a mirror cluster\nthat helps us perform some monitoring and adminstration operations (i.e. ZK migration).", "committedDate": "2020-04-13T05:06:49Z", "type": "commit"}, {"oid": "537c21f69e26dcd77295807edcb71bf9111fdc72", "url": "https://github.com/linkedin/ambry/commit/537c21f69e26dcd77295807edcb71bf9111fdc72", "message": "added unit tests", "committedDate": "2020-04-13T18:07:23Z", "type": "commit"}, {"oid": "b758face087dc960fd37f188dfeb4a58a35ffd92", "url": "https://github.com/linkedin/ambry/commit/b758face087dc960fd37f188dfeb4a58a35ffd92", "message": "fixed test failure", "committedDate": "2020-04-13T18:43:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3MDg3Ng==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408370876", "bodyText": "nit: In some special cases, might as well just point it out this is for zk migration.", "author": "justinlin-linkedin", "createdAt": "2020-04-14T19:08:29Z", "path": "ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java", "diffHunk": "@@ -29,9 +30,12 @@\n   ClusterMap getClusterMap() throws IOException;\n \n   /**\n-   * Construct and return the reference or return the reference to the previously constructed\n-   * {@link ClusterParticipant}\n+   * Construct and return the references or return the references to the previously constructed\n+   * {@link ClusterParticipant}(s). We extend this method to support multiple participants on same node. In some special", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwMjQ0OA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409702448", "bodyText": "sure, will add", "author": "jsjtzyy", "createdAt": "2020-04-16T16:47:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3MDg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "chunk": "diff --git a/ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java b/ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java\nindex 313e73e9b..952c5d87d 100644\n--- a/ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java\n+++ b/ambry-api/src/main/java/com/github/ambry/clustermap/ClusterAgentsFactory.java\n\n@@ -32,8 +32,8 @@ public interface ClusterAgentsFactory {\n   /**\n    * Construct and return the references or return the references to the previously constructed\n    * {@link ClusterParticipant}(s). We extend this method to support multiple participants on same node. In some special\n-   * cases we require a data node to participate into multiple clusters and each participant interacts with corresponding\n-   * cluster independently.\n+   * cases (i.e. migrating cluster to another Zookeeper), we require a data node to participate into multiple ZK clusters\n+   * and each participant interacts with corresponding ZK independently.\n    * @return a list of {@link ClusterParticipant}(s) on current node.\n    */\n   List<ClusterParticipant> getClusterParticipants() throws IOException;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NzgzNg==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408397836", "bodyText": "From the zk migration document, there will be no replica movement during the migration, why do those managers has to support multiple participants?", "author": "justinlin-linkedin", "createdAt": "2020-04-14T19:57:35Z", "path": "ambry-server/src/main/java/com/github/ambry/server/AmbryServer.java", "diffHunk": "@@ -165,9 +164,11 @@ public void startup() throws InstantiationException {\n       }\n \n       StoreKeyFactory storeKeyFactory = Utils.getObj(storeConfig.storeKeyFactory, clusterMap);\n+      // TODO make StorageManager, ReplicationManager, CloudToStoreReplicationManager and StatsManager support multiple participants\n+      // For now, we assume there is only one element in clusterParticipants list.", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxOTU3MQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409719571", "bodyText": "Good question. ReplicaitonManager may not need actions against multiple participants but StatsManager and StorageManager are supposed to interact with multiple participants to upload local info to multiple clusters (i.e sealing partition info and stats info)", "author": "jsjtzyy", "createdAt": "2020-04-16T17:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NzgzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNjkwOA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r408416908", "bodyText": "This comment is confusing to me. DatacenterInitializer is not part of the ClusterParticipant. It's used by HelixClusterManager to fetch the instance config and fill the clustermap. Why do we need to support multiple of them?", "author": "justinlin-linkedin", "createdAt": "2020-04-14T20:32:05Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java", "diffHunk": "@@ -158,7 +158,10 @@ private void onInitializationFailure(Exception e) {\n    * @throws Exception if something went wrong during startup\n    */\n   private DcInfo initializeHelixDatacenter() throws Exception {\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default for initialization.\n+    // If we really need multiple HelixClusterManagers on same node in the future, we can use separate zk connect str configs\n+    // for HelixClusterManager and HelixParticipant.", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNDM1MA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409724350", "bodyText": "True, we don't need support multiple HelixClusterManager(which is also spectator in the context of Helix). I added the comment to clarify that we have to pick one (and only one) ZK endpoint to connect, as clusterMapDcsZkConnectStrings contains several ZK endpoints in each dc to support multiple participants. I will remove the comment and make it clear.", "author": "jsjtzyy", "createdAt": "2020-04-16T17:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNjkwOA=="}], "type": "inlineReview", "revised_code": {"commit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java\nindex ce1e186c8..e54fe4284 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/DatacenterInitializer.java\n\n@@ -159,8 +159,7 @@ class DatacenterInitializer {\n    */\n   private DcInfo initializeHelixDatacenter() throws Exception {\n     // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default for initialization.\n-    // If we really need multiple HelixClusterManagers on same node in the future, we can use separate zk connect str configs\n-    // for HelixClusterManager and HelixParticipant.\n+    // Note that, Ambry currently doesn't support multiple spectators, because there should be only one source of truth.\n     String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);\n     HelixManager manager;\n     if (dcZkInfo.getDcName().equals(clusterMapConfig.clusterMapDatacenterName)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTMxOQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409721319", "bodyText": "this can result in a NPE, since we use optString for cloud backed replicas.\nInstead, you could do Utils.splitString(entry.optString(ZKCONNECT_STR, \"\"), ZKCONNECTSTR_DELIMITER)", "author": "cgtz", "createdAt": "2020-04-16T17:18:30Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -152,9 +155,10 @@ public static String getInstanceName(String host, Integer port) {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String zkConnectStr = (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR)\n-          : entry.optString(ZKCONNECTSTR_STR);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStr, replicaType);\n+      String[] zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)\n+              : entry.optString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER);", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNjI1OA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409726258", "bodyText": "Yeah, Utils.splitString is better. I previously used split with the impression that optString returns empty \"\" if not found, which doesn't cause NPE. Anyway, I will go with Utils.splitString.", "author": "jsjtzyy", "createdAt": "2020-04-16T17:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyOTMwNA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409729304", "bodyText": "Oh interesting, you are right about it returning empty string instead of null:\n    public String optString(String key) {\n        return this.optString(key, \"\");\n    }\n\nYou can ignore the comment about the NPE. Still it will be good to use Utils.splitString since it will filter out the empty string. i.e. return the list [] instead of [\"\"]", "author": "cgtz", "createdAt": "2020-04-16T17:31:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTMxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\nindex 452d168d1..1b11c4a93 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n\n@@ -155,10 +155,10 @@ public class ClusterMapUtils {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String[] zkConnectStrs =\n-          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)\n-              : entry.optString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, Arrays.asList(zkConnectStrs), replicaType);\n+      ArrayList<String> zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? Utils.splitString(entry.getString(ZKCONNECT_STR),\n+              ZKCONNECT_STR_DELIMITER) : Utils.splitString(entry.optString(ZKCONNECT_STR), ZKCONNECT_STR_DELIMITER);\n+      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStrs, replicaType);\n       dataCenterToZkAddress.put(dcZkInfo.dcName, dcZkInfo);\n     }\n     return dataCenterToZkAddress;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTQzMw==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409721433", "bodyText": "Use Utils.splitString here?", "author": "cgtz", "createdAt": "2020-04-16T17:18:42Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java", "diffHunk": "@@ -152,9 +155,10 @@ public static String getInstanceName(String host, Integer port) {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String zkConnectStr = (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR)\n-          : entry.optString(ZKCONNECTSTR_STR);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStr, replicaType);\n+      String[] zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyNjY2OA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409726668", "bodyText": "sure", "author": "jsjtzyy", "createdAt": "2020-04-16T17:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMTQzMw=="}], "type": "inlineReview", "revised_code": {"commit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\nindex 452d168d1..1b11c4a93 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/ClusterMapUtils.java\n\n@@ -155,10 +155,10 @@ public class ClusterMapUtils {\n       String name = entry.getString(DATACENTER_STR);\n       byte id = (byte) entry.getInt(DATACENTER_ID_STR);\n       ReplicaType replicaType = entry.optEnum(ReplicaType.class, REPLICA_TYPE_STR, ReplicaType.DISK_BACKED);\n-      String[] zkConnectStrs =\n-          (replicaType == ReplicaType.DISK_BACKED) ? entry.getString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER)\n-              : entry.optString(ZKCONNECTSTR_STR).split(ZKCONNECTSTR_DELIMITER);\n-      DcZkInfo dcZkInfo = new DcZkInfo(name, id, Arrays.asList(zkConnectStrs), replicaType);\n+      ArrayList<String> zkConnectStrs =\n+          (replicaType == ReplicaType.DISK_BACKED) ? Utils.splitString(entry.getString(ZKCONNECT_STR),\n+              ZKCONNECT_STR_DELIMITER) : Utils.splitString(entry.optString(ZKCONNECT_STR), ZKCONNECT_STR_DELIMITER);\n+      DcZkInfo dcZkInfo = new DcZkInfo(name, id, zkConnectStrs, replicaType);\n       dataCenterToZkAddress.put(dcZkInfo.dcName, dcZkInfo);\n     }\n     return dataCenterToZkAddress;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMjY0OQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409722649", "bodyText": "this needs to go below line 203 since CLOUD_BACKED replicas do not have a zk connect string", "author": "cgtz", "createdAt": "2020-04-16T17:20:35Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java", "diffHunk": "@@ -197,7 +197,9 @@ public HelixClusterManager(ClusterMapConfig clusterMapConfig, String instanceNam\n   private HelixManager initializeHelixManagerAndPropertyStoreInLocalDC(Map<String, DcZkInfo> dataCenterToZkAddress,\n       String instanceName, HelixFactory helixFactory) throws Exception {\n     DcZkInfo dcZkInfo = dataCenterToZkAddress.get(clusterMapConfig.clusterMapDatacenterName);\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n+    // this if we really need to initialize mulitiple HelixManager in local dc.\n+    String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);", "originalCommit": "b758face087dc960fd37f188dfeb4a58a35ffd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0MDAyOQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409740029", "bodyText": "good point", "author": "jsjtzyy", "createdAt": "2020-04-16T17:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMjY0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\nindex 7645fe269..6b2b7dbc8 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\n\n@@ -197,12 +197,12 @@ public class HelixClusterManager implements ClusterMap {\n   private HelixManager initializeHelixManagerAndPropertyStoreInLocalDC(Map<String, DcZkInfo> dataCenterToZkAddress,\n       String instanceName, HelixFactory helixFactory) throws Exception {\n     DcZkInfo dcZkInfo = dataCenterToZkAddress.get(clusterMapConfig.clusterMapDatacenterName);\n-    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n-    // this if we really need to initialize mulitiple HelixManager in local dc.\n-    String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);\n     if (dcZkInfo.getReplicaType() == ReplicaType.CLOUD_BACKED) {\n       return null;\n     }\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n+    // this if we really need to initialize multiple HelixManagers in local dc.\n+    String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);\n     HelixManager manager =\n         helixFactory.getZKHelixManager(clusterName, instanceName, InstanceType.SPECTATOR, zkConnectStr);\n     logger.info(\"Connecting to Helix manager in local zookeeper at {}\", zkConnectStr);\n"}}, {"oid": "605420e79699fb00c96ed5dcb7c65d23653f655e", "url": "https://github.com/linkedin/ambry/commit/605420e79699fb00c96ed5dcb7c65d23653f655e", "message": "address Justin's and Casey's comments", "committedDate": "2020-04-16T18:34:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwMzI4Mw==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409903283", "bodyText": "I don't think we need to support multiple helix instances here, maybe we should change the comments.", "author": "justinlin-linkedin", "createdAt": "2020-04-16T23:19:07Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java", "diffHunk": "@@ -197,10 +197,12 @@ public HelixClusterManager(ClusterMapConfig clusterMapConfig, String instanceNam\n   private HelixManager initializeHelixManagerAndPropertyStoreInLocalDC(Map<String, DcZkInfo> dataCenterToZkAddress,\n       String instanceName, HelixFactory helixFactory) throws Exception {\n     DcZkInfo dcZkInfo = dataCenterToZkAddress.get(clusterMapConfig.clusterMapDatacenterName);\n-    String zkConnectStr = dcZkInfo.getZkConnectStr();\n     if (dcZkInfo.getReplicaType() == ReplicaType.CLOUD_BACKED) {\n       return null;\n     }\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n+    // this if we really need to initialize multiple HelixManagers in local dc.", "originalCommit": "605420e79699fb00c96ed5dcb7c65d23653f655e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkyNTE0NA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r409925144", "bodyText": "hmm, I don't see any use cases for now, will remove the comment.", "author": "jsjtzyy", "createdAt": "2020-04-17T00:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkwMzI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3c63664179f7530057728d42ece47247bd9996b7", "chunk": "diff --git a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\nindex 6b2b7dbc8..4b3ae10f5 100644\n--- a/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\n+++ b/ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixClusterManager.java\n\n@@ -200,8 +200,8 @@ public class HelixClusterManager implements ClusterMap {\n     if (dcZkInfo.getReplicaType() == ReplicaType.CLOUD_BACKED) {\n       return null;\n     }\n-    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. We can update\n-    // this if we really need to initialize multiple HelixManagers in local dc.\n+    // For now, the first ZK endpoint (if there are more than one endpoints) will be adopted by default. Note that, Ambry\n+    // doesn't support multiple HelixClusterManagers(spectators) on same node.\n     String zkConnectStr = dcZkInfo.getZkConnectStrs().get(0);\n     HelixManager manager =\n         helixFactory.getZKHelixManager(clusterName, instanceName, InstanceType.SPECTATOR, zkConnectStr);\n"}}, {"oid": "3c63664179f7530057728d42ece47247bd9996b7", "url": "https://github.com/linkedin/ambry/commit/3c63664179f7530057728d42ece47247bd9996b7", "message": "comment", "committedDate": "2020-04-17T04:30:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTIwNg==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411825206", "bodyText": "Minor: my only concern here is that the metric names will look convoluted.  But I don't have a better suggestion either for making them distinct.", "author": "lightningrob", "createdAt": "2020-04-21T02:37:23Z", "path": "ambry-clustermap/src/main/java/com/github/ambry/clustermap/HelixParticipantMetrics.java", "diffHunk": "@@ -32,26 +32,27 @@\n   // no need to record exact number of \"dropped\" partition, a counter to track partition-dropped events would suffice\n   final Counter partitionDroppedCount;\n \n-  HelixParticipantMetrics(MetricRegistry metricRegistry) {\n+  HelixParticipantMetrics(MetricRegistry metricRegistry, String zkConnectStr) {", "originalCommit": "3c63664179f7530057728d42ece47247bd9996b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTc5NQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411825795", "bodyText": "Perhaps in the common case where there is only one participant, you can skip adding the zkConnectStr to the metrics (assuming the caller knows this).", "author": "lightningrob", "createdAt": "2020-04-21T02:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTIwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyOTE2NA==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411829164", "bodyText": "Good idea, will try to skip zkConnectStr if there is only one participant.", "author": "jsjtzyy", "createdAt": "2020-04-21T02:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTIwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNzMxMQ==", "url": "https://github.com/linkedin/ambry/pull/1472#discussion_r411827311", "bodyText": "Minor: It's generally better to let either the test constructor or @before method do this kind of initialization in case an exception happens in test case.", "author": "lightningrob", "createdAt": "2020-04-21T02:43:43Z", "path": "ambry-clustermap/src/test/java/com/github/ambry/clustermap/HelixParticipantTest.java", "diffHunk": "@@ -301,21 +307,45 @@ public void testBadCases() throws IOException {\n     props.setProperty(\"clustermap.dcs.zk.connect.strings\", \"\");\n     clusterMapConfig = new ClusterMapConfig(new VerifiableProperties(props));\n     try {\n-      new HelixParticipant(clusterMapConfig, helixManagerFactory, new MetricRegistry());\n+      new HelixClusterAgentsFactory(clusterMapConfig, new MetricRegistry()).getClusterParticipants();\n       fail(\"Instantiation should have failed\");\n     } catch (IOException e) {\n       // OK\n     }\n   }\n \n+  /**\n+   * Test instantiating multiple {@link HelixParticipant}(s) in {@link HelixClusterAgentsFactory}\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testMultiParticipants() throws Exception {\n+    JSONArray zkInfosJson = new JSONArray();\n+    // create a new zkJson which contains two zk endpoints in the same data center.\n+    JSONObject zkInfoJson = new JSONObject();\n+    zkInfoJson.put(ClusterMapUtils.DATACENTER_STR, \"DC0\");\n+    zkInfoJson.put(ClusterMapUtils.DATACENTER_ID_STR, (byte) 0);\n+    zkInfoJson.put(ClusterMapUtils.ZKCONNECT_STR, \"localhost:2199\" + ZKCONNECT_STR_DELIMITER + \"localhost:2299\");\n+    zkInfosJson.put(zkInfoJson);\n+    JSONObject jsonObject = new JSONObject().put(ClusterMapUtils.ZKINFO_STR, zkInfosJson);\n+    props.setProperty(\"clustermap.dcs.zk.connect.strings\", jsonObject.toString(2));\n+    ClusterMapConfig clusterMapConfig = new ClusterMapConfig(new VerifiableProperties(props));\n+    List<ClusterParticipant> participants =\n+        new HelixClusterAgentsFactory(clusterMapConfig, helixManagerFactory).getClusterParticipants();\n+    assertEquals(\"Number of participants is not expected\", 2, participants.size());\n+    // restore previous setup\n+    props.setProperty(\"clustermap.dcs.zk.connect.strings\", zkJson.toString(2));", "originalCommit": "3c63664179f7530057728d42ece47247bd9996b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}