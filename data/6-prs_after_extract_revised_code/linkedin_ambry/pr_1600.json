{"pr_number": 1600, "pr_title": "Mark container status inactive in Zk", "pr_createdAt": "2020-08-05T00:25:36Z", "pr_url": "https://github.com/linkedin/ambry/pull/1600", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NjczMw==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r465686733", "bodyText": "There can be some situations where this update will fail to persist if someone is making other account updates in Nuage concurrently. This is because the update will fail if the account's \"snapshotVersion\" field does not match. This field is used to make sure that the base account that was modified matches the current account stored in zookeeper so that one update does not erase someone else's change unexpectedly.\nI would suggest using a compareAndSet style loop (checking the return value of updateAccounts to see if the update went through):\n    if (inactiveContainerCandidateSet != null) {\n      boolean successful = false;\n      while (!successful) {\n        Map<Short, Account> accountToUpdateMap = new HashMap<>();\n        inactiveContainerCandidateSet.forEach(container -> {\n          // start by getting account, and then get container from account to make sure that we are editing the most\n          // recent snapshot\n          short accountId = container.getParentAccountId();\n          Account accountToEdit = accountToUpdateMap.computeIfAbsent(accountId, this::getAccountById);\n          Container containerToEdit = accountToEdit.getContainerById(container.getId());\n          Container editedContainer =\n              new ContainerBuilder(containerToEdit).setStatus(Container.ContainerStatus.INACTIVE).build();\n          accountToUpdateMap.put(accountId,\n              new AccountBuilder(accountToEdit).addOrUpdateContainer(editedContainer).build());\n        });\n        // Note that this assumes that unsuccessful updates are always retriable (like snapshot version violations).\n        // If there is something unrecoverable wrong, this method will get stuck in this loop. \n        // Limit on number of retries may be needed.\n        successful = updateAccounts(accountToUpdateMap.values());\n      }\n    }", "author": "cgtz", "createdAt": "2020-08-05T12:22:56Z", "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -382,8 +382,17 @@ public void selectInactiveContainersAndMarkInZK(StatsSnapshot statsSnapshot) {\n    * Mark the given {@link Container}s status to INACTIVE in zookeeper.\n    * @param inactiveContainerCandidateSet DELETE_IN_PROGRESS {@link Container} set which has been deleted successfully during compaction.\n    */\n-  private void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) {\n-    // TODO: mark the given containers status to INACTIVE in zookeeper.\n+  void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) {\n+    if (inactiveContainerCandidateSet != null) {\n+      Map<Short, Account> accountToUpdateMap = new HashMap<>();\n+      inactiveContainerCandidateSet.forEach(container -> {\n+        container = new ContainerBuilder(container).setStatus(Container.ContainerStatus.INACTIVE).build();\n+        short accountId = container.getParentAccountId();\n+        Account account = new AccountBuilder(accountToUpdateMap.getOrDefault(accountId, getAccountById(accountId))).addOrUpdateContainer(container).build();\n+        accountToUpdateMap.put(accountId, account);\n+      });\n+      updateAccounts(accountToUpdateMap.values());", "originalCommit": "43ee3bc2a2095fceb4f55fdf9b3b04a56c9748f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTAwMg==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466555002", "bodyText": "Thanks for the reminding. I've updated to resolve this concurrency issue.", "author": "SophieGuo410", "createdAt": "2020-08-06T17:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NjczMw=="}], "type": "inlineReview", "revised_code": {"commit": "43a52267e675a63403a4c1af3813d4176fb2ce1f", "chunk": "diff --git a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\nindex 5de9dbcfc..a6626949a 100644\n--- a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n+++ b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n\n@@ -375,23 +375,43 @@ public class HelixAccountService extends AbstractAccountService implements Accou\n    */\n   public void selectInactiveContainersAndMarkInZK(StatsSnapshot statsSnapshot) {\n     Set<Container> inactiveContainerCandidateSet = selectInactiveContainerCandidates(statsSnapshot);\n-    markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    try {\n+      markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    } catch (InterruptedException e) {\n+      logger.error(\"Mark inactive container in zookeeper is interrupted\", e);\n+    }\n   }\n \n   /**\n    * Mark the given {@link Container}s status to INACTIVE in zookeeper.\n    * @param inactiveContainerCandidateSet DELETE_IN_PROGRESS {@link Container} set which has been deleted successfully during compaction.\n    */\n-  void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) {\n+  void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) throws InterruptedException {\n     if (inactiveContainerCandidateSet != null) {\n-      Map<Short, Account> accountToUpdateMap = new HashMap<>();\n-      inactiveContainerCandidateSet.forEach(container -> {\n-        container = new ContainerBuilder(container).setStatus(Container.ContainerStatus.INACTIVE).build();\n-        short accountId = container.getParentAccountId();\n-        Account account = new AccountBuilder(accountToUpdateMap.getOrDefault(accountId, getAccountById(accountId))).addOrUpdateContainer(container).build();\n-        accountToUpdateMap.put(accountId, account);\n-      });\n-      updateAccounts(accountToUpdateMap.values());\n+      boolean successful = false;\n+      int retry = 0;\n+      while (!successful && retry < config.retryCount) {\n+        Map<Short, Account> accountToUpdateMap = new HashMap<>();\n+        inactiveContainerCandidateSet.forEach(container -> {\n+          // start by getting account, and then get container from account to make sure that we are editing the most\n+          // recent snapshot\n+          short accountId = container.getParentAccountId();\n+          Account accountToEdit = accountToUpdateMap.computeIfAbsent(accountId, this::getAccountById);\n+          Container containerToEdit = accountToEdit.getContainerById(container.getId());\n+          Container editedContainer =\n+                  new ContainerBuilder(containerToEdit).setStatus(Container.ContainerStatus.INACTIVE).build();\n+          accountToUpdateMap.put(accountId,\n+                  new AccountBuilder(accountToEdit).addOrUpdateContainer(editedContainer).build());\n+        });\n+        successful = updateAccounts(accountToUpdateMap.values());\n+        if (!successful) {\n+          retry ++;\n+          Thread.sleep(config.retryDelay);\n+        }\n+      }\n+      if (!successful) {\n+        logger.error(\"Container failed to be marked as INACTIVE in inactiveContainerCandidateSet : {}\", inactiveContainerCandidateSet);\n+      }\n     }\n   }\n \n"}}, {"oid": "43a52267e675a63403a4c1af3813d4176fb2ce1f", "url": "https://github.com/linkedin/ambry/commit/43a52267e675a63403a4c1af3813d4176fb2ce1f", "message": "Update status for inactive containers on zk", "committedDate": "2020-08-06T05:16:13Z", "type": "forcePushed"}, {"oid": "da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "url": "https://github.com/linkedin/ambry/commit/da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "message": "Update status for inactive containers on zk", "committedDate": "2020-08-06T05:25:03Z", "type": "commit"}, {"oid": "da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "url": "https://github.com/linkedin/ambry/commit/da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "message": "Update status for inactive containers on zk", "committedDate": "2020-08-06T05:25:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDIxMw==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466154213", "bodyText": "nit: can we call this maxRetryCountOnUpdateFailure ?", "author": "jsjtzyy", "createdAt": "2020-08-06T05:27:30Z", "path": "ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java", "diffHunk": "@@ -99,6 +100,20 @@\n   @Default(\"100\")\n   public final int totalNumberOfVersionToKeep;\n \n+  /**\n+   * The number of retry times when the update accounts fails by marking delete_in_progress container status to inactive;\n+   */\n+  @Config(RETRY_COUNT)\n+  @Default(\"10\")\n+  public final int retryCount;", "originalCommit": "da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTExNw==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466555117", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-08-06T17:01:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "chunk": "diff --git a/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java b/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\nindex 3e584db71..3e7c428e7 100644\n--- a/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\n+++ b/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\n\n@@ -103,16 +103,16 @@ public class HelixAccountServiceConfig {\n   /**\n    * The number of retry times when the update accounts fails by marking delete_in_progress container status to inactive;\n    */\n-  @Config(RETRY_COUNT)\n+  @Config(MAX_RETRY_COUNT_ON_UPDATE_FAILURE)\n   @Default(\"10\")\n-  public final int retryCount;\n+  public final int maxRetryCountOnUpdateFailure;\n \n   /**\n    * The sleep time between each retry action when the update accounts fails by marking delete_in_progress container status to inactive;\n    */\n-  @Config(RETRY_DELAY)\n+  @Config(RETRY_DELAY_MS)\n   @Default(\"1000\")\n-  public final long retryDelay;\n+  public final long retryDelayMs;\n \n   public HelixAccountServiceConfig(VerifiableProperties verifiableProperties) {\n     zkClientConnectString = verifiableProperties.getString(ZK_CLIENT_CONNECT_STRING_KEY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDUxMA==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466154510", "bodyText": "Can we add time unit into the name? Like retryDelaySeconds or retryDelayMs ?", "author": "jsjtzyy", "createdAt": "2020-08-06T05:28:29Z", "path": "ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java", "diffHunk": "@@ -99,6 +100,20 @@\n   @Default(\"100\")\n   public final int totalNumberOfVersionToKeep;\n \n+  /**\n+   * The number of retry times when the update accounts fails by marking delete_in_progress container status to inactive;\n+   */\n+  @Config(RETRY_COUNT)\n+  @Default(\"10\")\n+  public final int retryCount;\n+\n+  /**\n+   * The sleep time between each retry action when the update accounts fails by marking delete_in_progress container status to inactive;\n+   */\n+  @Config(RETRY_DELAY)\n+  @Default(\"1000\")\n+  public final long retryDelay;", "originalCommit": "da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTIxMw==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466555213", "bodyText": "Sure. Updated.", "author": "SophieGuo410", "createdAt": "2020-08-06T17:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDUxMA=="}], "type": "inlineReview", "revised_code": {"commit": "5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "chunk": "diff --git a/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java b/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\nindex 3e584db71..3e7c428e7 100644\n--- a/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\n+++ b/ambry-api/src/main/java/com/github/ambry/config/HelixAccountServiceConfig.java\n\n@@ -103,16 +103,16 @@ public class HelixAccountServiceConfig {\n   /**\n    * The number of retry times when the update accounts fails by marking delete_in_progress container status to inactive;\n    */\n-  @Config(RETRY_COUNT)\n+  @Config(MAX_RETRY_COUNT_ON_UPDATE_FAILURE)\n   @Default(\"10\")\n-  public final int retryCount;\n+  public final int maxRetryCountOnUpdateFailure;\n \n   /**\n    * The sleep time between each retry action when the update accounts fails by marking delete_in_progress container status to inactive;\n    */\n-  @Config(RETRY_DELAY)\n+  @Config(RETRY_DELAY_MS)\n   @Default(\"1000\")\n-  public final long retryDelay;\n+  public final long retryDelayMs;\n \n   public HelixAccountServiceConfig(VerifiableProperties verifiableProperties) {\n     zkClientConnectString = verifiableProperties.getString(ZK_CLIENT_CONNECT_STRING_KEY);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NTM4MA==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466155380", "bodyText": "logger.error(\"Failed to mark containers INACTIVE in set : {}  after {} retries\", inactiveContainerCandidateSet, config.retryCount);", "author": "jsjtzyy", "createdAt": "2020-08-06T05:31:14Z", "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -375,15 +375,44 @@ private void onAccountChangeMessage(String topic, String message) {\n    */\n   public void selectInactiveContainersAndMarkInZK(StatsSnapshot statsSnapshot) {\n     Set<Container> inactiveContainerCandidateSet = selectInactiveContainerCandidates(statsSnapshot);\n-    markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    try {\n+      markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    } catch (InterruptedException e) {\n+      logger.error(\"Mark inactive container in zookeeper is interrupted\", e);\n+    }\n   }\n \n   /**\n    * Mark the given {@link Container}s status to INACTIVE in zookeeper.\n    * @param inactiveContainerCandidateSet DELETE_IN_PROGRESS {@link Container} set which has been deleted successfully during compaction.\n    */\n-  private void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) {\n-    // TODO: mark the given containers status to INACTIVE in zookeeper.\n+  void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) throws InterruptedException {\n+    if (inactiveContainerCandidateSet != null) {\n+      boolean successful = false;\n+      int retry = 0;\n+      while (!successful && retry < config.retryCount) {\n+        Map<Short, Account> accountToUpdateMap = new HashMap<>();\n+        inactiveContainerCandidateSet.forEach(container -> {\n+          // start by getting account, and then get container from account to make sure that we are editing the most\n+          // recent snapshot\n+          short accountId = container.getParentAccountId();\n+          Account accountToEdit = accountToUpdateMap.computeIfAbsent(accountId, this::getAccountById);\n+          Container containerToEdit = accountToEdit.getContainerById(container.getId());\n+          Container editedContainer =\n+                  new ContainerBuilder(containerToEdit).setStatus(Container.ContainerStatus.INACTIVE).build();\n+          accountToUpdateMap.put(accountId,\n+                  new AccountBuilder(accountToEdit).addOrUpdateContainer(editedContainer).build());\n+        });\n+        successful = updateAccounts(accountToUpdateMap.values());\n+        if (!successful) {\n+          retry++;\n+          Thread.sleep(config.retryDelay);\n+        }\n+      }\n+      if (!successful) {\n+        logger.error(\"Container failed to be marked as INACTIVE in inactiveContainerCandidateSet : {}\", inactiveContainerCandidateSet);", "originalCommit": "da412b1a3fbb3879218de5f7c99ca23ef8dcb529", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NTU3MA==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466155570", "bodyText": "Also I am considering if we need a metric here for alerting purpose.", "author": "jsjtzyy", "createdAt": "2020-08-06T05:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NTM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTQ5NA==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466555494", "bodyText": "Updated and add the metric.", "author": "SophieGuo410", "createdAt": "2020-08-06T17:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NTM4MA=="}], "type": "inlineReview", "revised_code": {"commit": "5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "chunk": "diff --git a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\nindex 0bd1bd0f5..5d706a32d 100644\n--- a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n+++ b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n\n@@ -390,7 +390,7 @@ public class HelixAccountService extends AbstractAccountService implements Accou\n     if (inactiveContainerCandidateSet != null) {\n       boolean successful = false;\n       int retry = 0;\n-      while (!successful && retry < config.retryCount) {\n+      while (!successful && retry < config.maxRetryCountOnUpdateFailure) {\n         Map<Short, Account> accountToUpdateMap = new HashMap<>();\n         inactiveContainerCandidateSet.forEach(container -> {\n           // start by getting account, and then get container from account to make sure that we are editing the most\n"}}, {"oid": "5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "url": "https://github.com/linkedin/ambry/commit/5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "message": "address comments", "committedDate": "2020-08-06T16:22:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2NzIxOQ==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466567219", "bodyText": "minor:  rename to success ?", "author": "zzmao", "createdAt": "2020-08-06T17:21:26Z", "path": "ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java", "diffHunk": "@@ -375,15 +375,45 @@ private void onAccountChangeMessage(String topic, String message) {\n    */\n   public void selectInactiveContainersAndMarkInZK(StatsSnapshot statsSnapshot) {\n     Set<Container> inactiveContainerCandidateSet = selectInactiveContainerCandidates(statsSnapshot);\n-    markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    try {\n+      markContainerInactiveOnZk(inactiveContainerCandidateSet);\n+    } catch (InterruptedException e) {\n+      logger.error(\"Mark inactive container in zookeeper is interrupted\", e);\n+    }\n   }\n \n   /**\n    * Mark the given {@link Container}s status to INACTIVE in zookeeper.\n    * @param inactiveContainerCandidateSet DELETE_IN_PROGRESS {@link Container} set which has been deleted successfully during compaction.\n    */\n-  private void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) {\n-    // TODO: mark the given containers status to INACTIVE in zookeeper.\n+  void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) throws InterruptedException {\n+    if (inactiveContainerCandidateSet != null) {\n+      boolean successful = false;", "originalCommit": "5f862e9279ee77ae35614ef6f5ad68bf69b3662d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU5MDc1NA==", "url": "https://github.com/linkedin/ambry/pull/1600#discussion_r466590754", "bodyText": "Updated.", "author": "SophieGuo410", "createdAt": "2020-08-06T18:00:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU2NzIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "beb8a53b334b457c620a9641df9a294f60a6e369", "chunk": "diff --git a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\nindex 5d706a32d..859ade6f8 100644\n--- a/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n+++ b/ambry-account/src/main/java/com/github/ambry/account/HelixAccountService.java\n\n@@ -388,9 +388,9 @@ public class HelixAccountService extends AbstractAccountService implements Accou\n    */\n   void markContainerInactiveOnZk(Set<Container> inactiveContainerCandidateSet) throws InterruptedException {\n     if (inactiveContainerCandidateSet != null) {\n-      boolean successful = false;\n+      boolean success = false;\n       int retry = 0;\n-      while (!successful && retry < config.maxRetryCountOnUpdateFailure) {\n+      while (!success && retry < config.maxRetryCountOnUpdateFailure) {\n         Map<Short, Account> accountToUpdateMap = new HashMap<>();\n         inactiveContainerCandidateSet.forEach(container -> {\n           // start by getting account, and then get container from account to make sure that we are editing the most\n"}}, {"oid": "beb8a53b334b457c620a9641df9a294f60a6e369", "url": "https://github.com/linkedin/ambry/commit/beb8a53b334b457c620a9641df9a294f60a6e369", "message": "minor fix", "committedDate": "2020-08-06T17:49:50Z", "type": "commit"}]}