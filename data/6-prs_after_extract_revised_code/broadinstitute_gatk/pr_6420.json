{"pr_number": 6420, "pr_title": "wrote getPairOrientation method for GATKRead", "pr_createdAt": "2020-01-27T20:13:39Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6420", "timeline": [{"oid": "2b4e574d2c7973ada25a7f7d3f4ca1b82dfd6094", "url": "https://github.com/broadinstitute/gatk/commit/2b4e574d2c7973ada25a7f7d3f4ca1b82dfd6094", "message": "wrote getPairOrientation method for GATKRead", "committedDate": "2020-01-27T20:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyMDcyMw==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r380720723", "bodyText": "Do you mind moving this after the validation?", "author": "SHuang-Broad", "createdAt": "2020-02-18T14:52:29Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/read/GATKRead.java", "diffHunk": "@@ -600,6 +601,24 @@ default int numCigarElements(){\n      */\n     void setIsSupplementaryAlignment( final boolean isSupplementaryAlignment );\n \n+    /**\n+     * Computes the pair orientation\n+     * @throws IllegalArgumentException If the read is not paired, or if either read or mate is unmapped\n+     */\n+    default SamPairUtil.PairOrientation getPairOrientation() {\n+        final boolean readIsOnReverseStrand = isReverseStrand();", "originalCommit": "2b4e574d2c7973ada25a7f7d3f4ca1b82dfd6094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MTEyNA==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r381061124", "bodyText": "done", "author": "davidbenjamin", "createdAt": "2020-02-19T03:36:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyMDcyMw=="}], "type": "inlineReview", "revised_code": {"commit": "7af6dc2c7eb528cbaa76c55c03dd84e05aad34bd", "chunk": "diff --git a/src/main/java/org/broadinstitute/hellbender/utils/read/GATKRead.java b/src/main/java/org/broadinstitute/hellbender/utils/read/GATKRead.java\nindex cdc2b9b21..01385369e 100644\n--- a/src/main/java/org/broadinstitute/hellbender/utils/read/GATKRead.java\n+++ b/src/main/java/org/broadinstitute/hellbender/utils/read/GATKRead.java\n\n@@ -606,9 +606,9 @@ public interface GATKRead extends Locatable {\n      * @throws IllegalArgumentException If the read is not paired, or if either read or mate is unmapped\n      */\n     default SamPairUtil.PairOrientation getPairOrientation() {\n-        final boolean readIsOnReverseStrand = isReverseStrand();\n-\n         Utils.validateArg(isPaired() && !isUnmapped() && !mateIsUnmapped(), () -> \"Invalid read: \" + getName() + \". This requires paired reads with both reads aligned.\");\n+isProperlyPaired()\n+        final boolean readIsOnReverseStrand = isReverseStrand();\n \n         if(readIsOnReverseStrand == mateIsReverseStrand() )  {\n             return SamPairUtil.PairOrientation.TANDEM;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyNTQ1Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r380725453", "bodyText": "I believe it should 201, but meh...", "author": "SHuang-Broad", "createdAt": "2020-02-18T14:59:23Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java", "diffHunk": "@@ -1378,5 +1378,95 @@ public void testUnmappedUnpairedDistinctionmates(final GATKRead read, final bool\n         Assert.assertEquals(read.mateIsUnplaced(), true);\n \n         read.convertToSAMRecord(hg19Header).setReadUnmappedFlag(false); // have to unset unmapped to allow SAMRecord to show its underlying data\n-        Assert.assertEquals(read.convertToSAMRecord(hg19Header).getMateAlignmentStart(), SAMRecord.NO_ALIGNMENT_START); }\n+        Assert.assertEquals(read.convertToSAMRecord(hg19Header).getMateAlignmentStart(), SAMRecord.NO_ALIGNMENT_START);\n+    }\n+\n+    @DataProvider(name = \"pair_orientation_failures\")\n+    public Object[][] pairOrientationFailures() {\n+        final GATKRead unpairedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        unpairedRead.setIsPaired(false);\n+\n+        final GATKRead unmappedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        unmappedRead.setIsPaired(true);\n+        unmappedRead.setIsUnmapped();\n+\n+        final GATKRead mateUnmappedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        mateUnmappedRead.setIsPaired(true);\n+        mateUnmappedRead.setIsUnmapped();\n+\n+        return new Object[][]{\n+                {unpairedRead},\n+                {unmappedRead},\n+                {mateUnmappedRead},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"pair_orientation_failures\", expectedExceptions = IllegalArgumentException.class)\n+    public void testGetPairOrientationFailures(final GATKRead read) {\n+        final SamPairUtil.PairOrientation pairOrientation = read.getPairOrientation();\n+    }\n+\n+    @DataProvider(name = \"pair_orientation\")\n+    public Object[][] pairOrientation() {\n+        final GATKRead forwardStrandInnie = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        forwardStrandInnie.setIsPaired(true);\n+        forwardStrandInnie.setIsReverseStrand(false);\n+        forwardStrandInnie.setMateIsReverseStrand(true);\n+        forwardStrandInnie.setPosition(new SimpleInterval(\"1\", 100, 200));\n+        forwardStrandInnie.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n+        forwardStrandInnie.setFragmentLength(200);", "originalCommit": "2b4e574d2c7973ada25a7f7d3f4ca1b82dfd6094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA2MDcxMA==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r381060710", "bodyText": "fixed", "author": "davidbenjamin", "createdAt": "2020-02-19T03:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyNTQ1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7af6dc2c7eb528cbaa76c55c03dd84e05aad34bd", "chunk": "diff --git a/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java b/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\nindex 2d2ee527c..2d0ade210 100644\n--- a/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\n+++ b/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\n\n@@ -1414,7 +1414,7 @@ public class GATKReadAdaptersUnitTest extends GATKBaseTest {\n         forwardStrandInnie.setMateIsReverseStrand(true);\n         forwardStrandInnie.setPosition(new SimpleInterval(\"1\", 100, 200));\n         forwardStrandInnie.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n-        forwardStrandInnie.setFragmentLength(200);\n+        forwardStrandInnie.setFragmentLength(201);\n \n         final GATKRead reverseStrandInnie = ArtificialReadUtils.createArtificialRead(\"100M\");\n         reverseStrandInnie.setIsPaired(true);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDczMDEzOA==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r380730138", "bodyText": "May I also suggest adding test cases:\n\nmates mapped to different chromosomes\nOf course if you believe getting pair orientation from such mate pairs to be non-sense, then it should be move to the test cases expecting exceptions.", "author": "SHuang-Broad", "createdAt": "2020-02-18T15:06:19Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java", "diffHunk": "@@ -1378,5 +1378,95 @@ public void testUnmappedUnpairedDistinctionmates(final GATKRead read, final bool\n         Assert.assertEquals(read.mateIsUnplaced(), true);\n \n         read.convertToSAMRecord(hg19Header).setReadUnmappedFlag(false); // have to unset unmapped to allow SAMRecord to show its underlying data\n-        Assert.assertEquals(read.convertToSAMRecord(hg19Header).getMateAlignmentStart(), SAMRecord.NO_ALIGNMENT_START); }\n+        Assert.assertEquals(read.convertToSAMRecord(hg19Header).getMateAlignmentStart(), SAMRecord.NO_ALIGNMENT_START);\n+    }\n+\n+    @DataProvider(name = \"pair_orientation_failures\")\n+    public Object[][] pairOrientationFailures() {\n+        final GATKRead unpairedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        unpairedRead.setIsPaired(false);\n+\n+        final GATKRead unmappedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        unmappedRead.setIsPaired(true);\n+        unmappedRead.setIsUnmapped();\n+\n+        final GATKRead mateUnmappedRead = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        mateUnmappedRead.setIsPaired(true);\n+        mateUnmappedRead.setIsUnmapped();\n+\n+        return new Object[][]{\n+                {unpairedRead},\n+                {unmappedRead},\n+                {mateUnmappedRead},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"pair_orientation_failures\", expectedExceptions = IllegalArgumentException.class)\n+    public void testGetPairOrientationFailures(final GATKRead read) {\n+        final SamPairUtil.PairOrientation pairOrientation = read.getPairOrientation();\n+    }\n+\n+    @DataProvider(name = \"pair_orientation\")\n+    public Object[][] pairOrientation() {\n+        final GATKRead forwardStrandInnie = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        forwardStrandInnie.setIsPaired(true);\n+        forwardStrandInnie.setIsReverseStrand(false);\n+        forwardStrandInnie.setMateIsReverseStrand(true);\n+        forwardStrandInnie.setPosition(new SimpleInterval(\"1\", 100, 200));\n+        forwardStrandInnie.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n+        forwardStrandInnie.setFragmentLength(200);\n+\n+        final GATKRead reverseStrandInnie = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        reverseStrandInnie.setIsPaired(true);\n+        reverseStrandInnie.setIsReverseStrand(true);\n+        reverseStrandInnie.setMateIsReverseStrand(false);\n+        reverseStrandInnie.setPosition(new SimpleInterval(\"1\", 200, 300));\n+        reverseStrandInnie.setMatePosition(new SimpleInterval(\"1\", 100, 200));\n+        reverseStrandInnie.setFragmentLength(200);\n+\n+        final GATKRead forwardStrandOutie = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        forwardStrandOutie.setIsPaired(true);\n+        forwardStrandOutie.setIsReverseStrand(false);\n+        forwardStrandOutie.setMateIsReverseStrand(true);\n+        forwardStrandOutie.setPosition(new SimpleInterval(\"1\", 200, 300));\n+        forwardStrandOutie.setMatePosition(new SimpleInterval(\"1\", 100, 200));\n+        forwardStrandOutie.setFragmentLength(-200);\n+\n+        final GATKRead reverseStrandOutie = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        reverseStrandOutie.setIsPaired(true);\n+        reverseStrandOutie.setIsReverseStrand(true);\n+        reverseStrandOutie.setMateIsReverseStrand(false);\n+        reverseStrandOutie.setPosition(new SimpleInterval(\"1\", 100, 200));\n+        reverseStrandOutie.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n+        reverseStrandOutie.setFragmentLength(-200);\n+\n+        final GATKRead forwardStrandTandem = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        forwardStrandTandem.setIsPaired(true);\n+        forwardStrandTandem.setIsReverseStrand(false);\n+        forwardStrandTandem.setMateIsReverseStrand(false);\n+        forwardStrandTandem.setPosition(new SimpleInterval(\"1\", 100, 200));\n+        forwardStrandTandem.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n+\n+        final GATKRead reverseStrandTandem = ArtificialReadUtils.createArtificialRead(\"100M\");\n+        reverseStrandTandem.setIsPaired(true);\n+        reverseStrandTandem.setIsReverseStrand(true);\n+        reverseStrandTandem.setMateIsReverseStrand(true);\n+        reverseStrandTandem.setPosition(new SimpleInterval(\"1\", 100, 200));\n+        reverseStrandTandem.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n+", "originalCommit": "2b4e574d2c7973ada25a7f7d3f4ca1b82dfd6094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI3Mjg4NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6420#discussion_r381272885", "bodyText": "@SHuang-Broad What's your opinion?  It doesn't seem like any of the existing values of SamPairUtil.PairOrientation make sense.  If it weren't in htsjdk I would be tempted to add DIFFERENT_CHROMOSOMES to the enum.  I could imagine throwing an error and leaving it to the calling code to check.  I could also imagine having this method return an Optional<SamPairUtil.PairOrientation> and reserving an empty result for this case.", "author": "davidbenjamin", "createdAt": "2020-02-19T12:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDczMDEzOA=="}], "type": "inlineReview", "revised_code": {"commit": "7af6dc2c7eb528cbaa76c55c03dd84e05aad34bd", "chunk": "diff --git a/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java b/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\nindex 2d2ee527c..2d0ade210 100644\n--- a/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\n+++ b/src/test/java/org/broadinstitute/hellbender/utils/read/GATKReadAdaptersUnitTest.java\n\n@@ -1414,7 +1414,7 @@ public class GATKReadAdaptersUnitTest extends GATKBaseTest {\n         forwardStrandInnie.setMateIsReverseStrand(true);\n         forwardStrandInnie.setPosition(new SimpleInterval(\"1\", 100, 200));\n         forwardStrandInnie.setMatePosition(new SimpleInterval(\"1\", 200, 300));\n-        forwardStrandInnie.setFragmentLength(200);\n+        forwardStrandInnie.setFragmentLength(201);\n \n         final GATKRead reverseStrandInnie = ArtificialReadUtils.createArtificialRead(\"100M\");\n         reverseStrandInnie.setIsPaired(true);\n"}}, {"oid": "7af6dc2c7eb528cbaa76c55c03dd84e05aad34bd", "url": "https://github.com/broadinstitute/gatk/commit/7af6dc2c7eb528cbaa76c55c03dd84e05aad34bd", "message": "edits", "committedDate": "2020-02-19T04:11:57Z", "type": "commit"}, {"oid": "b9087ac6c637363ad3e0a4b7e6416e4be7d733fd", "url": "https://github.com/broadinstitute/gatk/commit/b9087ac6c637363ad3e0a4b7e6416e4be7d733fd", "message": "mate on different contig", "committedDate": "2020-02-25T14:29:04Z", "type": "commit"}]}