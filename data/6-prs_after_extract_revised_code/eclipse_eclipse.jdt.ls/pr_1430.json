{"pr_number": 1430, "pr_title": "Use default JVM when importing gradle project", "pr_createdAt": "2020-05-01T19:09:27Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1430", "timeline": [{"oid": "cdfcdf7215f417be9eba7416a54fd47ac6b76f94", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/cdfcdf7215f417be9eba7416a54fd47ac6b76f94", "message": "Use default JVM when importing gradle project\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-05T15:57:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2MDM5MA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1430#discussion_r420760390", "bodyText": "forcing resync on workspace build seems wrong. Moreover you should always decouple most of JDT.LS classes from build specific implementations.", "author": "fbricon", "createdAt": "2020-05-06T12:44:38Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java", "diffHunk": "@@ -789,7 +796,18 @@ public void projectConfigurationUpdate(TextDocumentIdentifier param) {\n \tpublic CompletableFuture<BuildWorkspaceStatus> buildWorkspace(boolean forceReBuild) {\n \t\tlogInfo(\">> java/buildWorkspace (\" + (forceReBuild ? \"full)\" : \"incremental)\"));\n \t\tBuildWorkspaceHandler handler = new BuildWorkspaceHandler(pm);\n-\t\treturn computeAsyncWithClientProgress((monitor) -> handler.buildWorkspace(forceReBuild, monitor));", "originalCommit": "cdfcdf7215f417be9eba7416a54fd47ac6b76f94", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "434e3ecfdb9947d25c9169b07076f1683684dc60", "chunk": "diff --git a/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java b/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\nindex 3900f373..34983a68 100644\n--- a/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\n+++ b/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\n\n@@ -798,12 +793,16 @@ public class JDTLanguageServer extends BaseJDTLanguageServer implements Language\n \t\tBuildWorkspaceHandler handler = new BuildWorkspaceHandler(pm);\n \t\treturn computeAsyncWithClientProgress((monitor) -> {\n \t\t\tif (forceReBuild) {\n-\t\t\t\tList<IProject> gradleProjects = ProjectUtils.getGradleProjects();\n-\t\t\t\tfor (IProject project : gradleProjects) {\n-\t\t\t\t\tString projectPath = project.getLocation().toFile().getAbsolutePath();\n-\t\t\t\t\tBuildConfiguration buildConfiguration = GradleProjectImporter.getBuildConfiguration(Paths.get(projectPath));\n-\t\t\t\t\tGradleBuild build = GradleCore.getWorkspace().createBuild(buildConfiguration);\n-\t\t\t\t\tbuild.synchronize(monitor);\n+\t\t\t\tProjectsManager projectsManager = JavaLanguageServerPlugin.getProjectsManager();\n+\t\t\t\tif (projectsManager != null) {\n+\t\t\t\t\tList<IProject> gradleProjects = ProjectUtils.getGradleProjects();\n+\t\t\t\t\tfor (IProject project : gradleProjects) {\n+\t\t\t\t\t\ttry {\n+\t\t\t\t\t\t\tprojectsManager.getBuildSupport(project).get().update(project, true, monitor);\n+\t\t\t\t\t\t} catch (CoreException e) {\n+\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n \t\t\treturn handler.buildWorkspace(forceReBuild, monitor);\n"}}, {"oid": "434e3ecfdb9947d25c9169b07076f1683684dc60", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/434e3ecfdb9947d25c9169b07076f1683684dc60", "message": "Use default JVM when importing gradle project\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-06T16:06:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3NDE4Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1430#discussion_r421574183", "bodyText": "Actually, I'd rather prefer we had a listener for when the default IVMInstall changes, that would take care of updating relevant gradle projects", "author": "fbricon", "createdAt": "2020-05-07T15:00:33Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java", "diffHunk": "@@ -789,7 +791,22 @@ public void projectConfigurationUpdate(TextDocumentIdentifier param) {\n \tpublic CompletableFuture<BuildWorkspaceStatus> buildWorkspace(boolean forceReBuild) {\n \t\tlogInfo(\">> java/buildWorkspace (\" + (forceReBuild ? \"full)\" : \"incremental)\"));\n \t\tBuildWorkspaceHandler handler = new BuildWorkspaceHandler(pm);\n-\t\treturn computeAsyncWithClientProgress((monitor) -> handler.buildWorkspace(forceReBuild, monitor));\n+\t\treturn computeAsyncWithClientProgress((monitor) -> {", "originalCommit": "434e3ecfdb9947d25c9169b07076f1683684dc60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTczMDM3NA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1430#discussion_r421730374", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-05-07T19:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU3NDE4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d122c81b8aec498ae27312d7fc228b3592ab48b2", "chunk": "diff --git a/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java b/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\nindex 34983a68..d731ee84 100644\n--- a/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\n+++ b/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/JDTLanguageServer.java\n\n@@ -791,22 +789,7 @@ public class JDTLanguageServer extends BaseJDTLanguageServer implements Language\n \tpublic CompletableFuture<BuildWorkspaceStatus> buildWorkspace(boolean forceReBuild) {\n \t\tlogInfo(\">> java/buildWorkspace (\" + (forceReBuild ? \"full)\" : \"incremental)\"));\n \t\tBuildWorkspaceHandler handler = new BuildWorkspaceHandler(pm);\n-\t\treturn computeAsyncWithClientProgress((monitor) -> {\n-\t\t\tif (forceReBuild) {\n-\t\t\t\tProjectsManager projectsManager = JavaLanguageServerPlugin.getProjectsManager();\n-\t\t\t\tif (projectsManager != null) {\n-\t\t\t\t\tList<IProject> gradleProjects = ProjectUtils.getGradleProjects();\n-\t\t\t\t\tfor (IProject project : gradleProjects) {\n-\t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\tprojectsManager.getBuildSupport(project).get().update(project, true, monitor);\n-\t\t\t\t\t\t} catch (CoreException e) {\n-\t\t\t\t\t\t\tJavaLanguageServerPlugin.logException(e.getMessage(), e);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\treturn handler.buildWorkspace(forceReBuild, monitor);\n-\t\t});\n+\t\treturn computeAsyncWithClientProgress((monitor) -> handler.buildWorkspace(forceReBuild, monitor));\n \t}\n \n \t/* (non-Javadoc)\n"}}, {"oid": "d122c81b8aec498ae27312d7fc228b3592ab48b2", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/d122c81b8aec498ae27312d7fc228b3592ab48b2", "message": "Use default JVM when importing gradle project\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-07T18:55:00Z", "type": "commit"}, {"oid": "d122c81b8aec498ae27312d7fc228b3592ab48b2", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/d122c81b8aec498ae27312d7fc228b3592ab48b2", "message": "Use default JVM when importing gradle project\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-05-07T18:55:00Z", "type": "forcePushed"}]}