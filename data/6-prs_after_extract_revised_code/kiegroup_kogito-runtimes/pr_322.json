{"pr_number": 322, "pr_title": "KOGITO-1217 - Event Based Subprocess Support - signal start event", "pr_createdAt": "2020-02-19T15:58:55Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/322", "timeline": [{"oid": "b605e08a53abab03eca9b6d4d1783037d22aa677", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b605e08a53abab03eca9b6d4d1783037d22aa677", "message": "KOGITO-1217 - Event Based Subprocess Support - signal start event", "committedDate": "2020-02-20T12:09:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNTY5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382705691", "bodyText": "Probably these constants could be unified with the ones used on StartEventHandler, wdyt?", "author": "tiagodolphine", "createdAt": "2020-02-21T17:19:31Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/StartNodeVisitor.java", "diffHunk": "@@ -17,17 +17,25 @@\n package org.jbpm.compiler.canonical;\n \n import java.util.Map;\n+import java.util.Map.Entry;\n \n+import org.jbpm.process.core.context.variable.Variable;\n import org.jbpm.process.core.context.variable.VariableScope;\n import org.jbpm.ruleflow.core.factory.StartNodeFactory;\n import org.jbpm.workflow.core.node.StartNode;\n import org.kie.api.definition.process.Node;\n \n+import com.github.javaparser.ast.expr.BooleanLiteralExpr;\n import com.github.javaparser.ast.expr.LongLiteralExpr;\n import com.github.javaparser.ast.expr.StringLiteralExpr;\n import com.github.javaparser.ast.stmt.BlockStmt;\n \n public class StartNodeVisitor extends AbstractVisitor {\n+    \n+    private static final String TRIGGER_REF = \"TriggerRef\";", "originalCommit": "b605e08a53abab03eca9b6d4d1783037d22aa677", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNjU1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382906552", "bodyText": "I kept them separate as they are across different modules so didn't want to make too much dependencies between them", "author": "mswiderski", "createdAt": "2020-02-22T11:35:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNTY5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0ODQ2OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r384448468", "bodyText": "Ok \ud83d\udc4d", "author": "tiagodolphine", "createdAt": "2020-02-26T12:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNTY5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNTE0NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382715144", "bodyText": "this block is being repeated, maybe it is better to unify on a method.", "author": "tiagodolphine", "createdAt": "2020-02-21T17:40:08Z", "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/ProcessCodegen.java", "diffHunk": "@@ -315,13 +315,15 @@ public ProcessCodegen withClassLoader(ClassLoader projectClassLoader) {\n \n                 for (TriggerMetaData trigger : metaData.getTriggers()) {\n \n-                    MessageDataEventGenerator msgDataEventGenerator = new MessageDataEventGenerator(workFlowProcess,\n-                                                            trigger)\n-                                                                  .withDependencyInjection(annotator);\n-                    mdegs.add(msgDataEventGenerator);\n+                    \n                     // generate message consumers for processes with message start events\n                     if (trigger.getType().equals(TriggerMetaData.TriggerType.ConsumeMessage)) {\n \n+                        MessageDataEventGenerator msgDataEventGenerator = new MessageDataEventGenerator(workFlowProcess,", "originalCommit": "b605e08a53abab03eca9b6d4d1783037d22aa677", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNjUyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382906520", "bodyText": "it is only two lines that are repeated so having this as method will not be of that big value in my opinion especially that the MessageDataEventGenerator  is referenced few lines below", "author": "mswiderski", "createdAt": "2020-02-22T11:34:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNTE0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0ODYzNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r384448635", "bodyText": "Ok \ud83d\udc4d", "author": "tiagodolphine", "createdAt": "2020-02-26T12:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNTE0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNjM4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382716380", "bodyText": "if filters can be null, maybe it is worth to check.", "author": "tiagodolphine", "createdAt": "2020-02-21T17:42:42Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/ruleflow/core/RuleFlowProcessFactory.java", "diffHunk": "@@ -286,5 +292,43 @@ protected Node findNodeByIdOrUniqueIdInMetadata(NodeContainer nodeContainer, fin\n         }\n         return node;\n     }\n+    \n+    private void postProcessNodes(RuleFlowProcess process, NodeContainer container) {\n+        \n+        for (Node node: container.getNodes()) {\n+            if (node instanceof NodeContainer) {\n+                // prepare event sub process\n+                if (node instanceof EventSubProcessNode) {\n+                    EventSubProcessNode eventSubProcessNode = (EventSubProcessNode) node;\n+\n+                    Node[] nodes = eventSubProcessNode.getNodes();\n+                    for (Node subNode : nodes) {\n+                        // avoids cyclomatic complexity\n+                        if (subNode instanceof StartNode) {\n+                         \n+                            processEventSubprocessStartNode(((StartNode) subNode), eventSubProcessNode);\n+                        }\n+                    }\n+                }\n+                postProcessNodes(process, (NodeContainer) node);\n+            } \n+        }     \n+    }\n+    \n+    private void processEventSubprocessStartNode(StartNode subNode, EventSubProcessNode eventSubProcessNode) {\n+        List<Trigger> triggers = subNode.getTriggers();\n+        if ( triggers != null ) {\n+                                   \n+            for ( Trigger trigger : triggers ) {\n+                if ( trigger instanceof EventTrigger ) {\n+                    final List<EventFilter> filters = ((EventTrigger) trigger).getEventFilters();\n+    \n+                    for ( EventFilter filter : filters ) {                        ", "originalCommit": "b605e08a53abab03eca9b6d4d1783037d22aa677", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNjIyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382906223", "bodyText": "I'd say it should not be null but an empty list in worse case, see that it is set to empty list in EventTrigger class", "author": "mswiderski", "createdAt": "2020-02-22T11:28:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNjM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ0ODc0Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r384448746", "bodyText": "Ok \ud83d\udc4d", "author": "tiagodolphine", "createdAt": "2020-02-26T12:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNjM4MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzE1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382717156", "bodyText": "there is always a TRIGGER_TYPE on metaData? otherwise, this can lead to a NPE... maybe using String.valueOf() instead of casting is an option.", "author": "tiagodolphine", "createdAt": "2020-02-21T17:44:18Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/StartNodeVisitor.java", "diffHunk": "@@ -36,24 +44,51 @@ public void visitNode(String factoryField, Node node, BlockStmt body, VariableSc\n         addFactoryMethodWithArgsWithAssignment(factoryField, body, StartNodeFactory.class, \"startNode\" + node.getId(), \"startNode\", new LongLiteralExpr(startNode.getId()));\n         addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"name\", new StringLiteralExpr(getOrDefault(startNode.getName(), \"Start\")));\n         \n+        addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"interrupting\", new BooleanLiteralExpr(startNode.isInterrupting()));\n+        \n         visitMetaData(startNode.getMetaData(), body, \"startNode\" + node.getId());\n         \n         addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"done\");\n         \n         if (startNode.getTriggers() != null && !startNode.getTriggers().isEmpty()) {\n             Map<String, Object> nodeMetaData = startNode.getMetaData();\n-            metadata.getTriggers().add(new TriggerMetaData((String)nodeMetaData.get(\"TriggerRef\"), \n-                                                           (String)nodeMetaData.get(\"TriggerType\"), \n-                                                           (String)nodeMetaData.get(\"MessageType\"), \n-                                                           (String)nodeMetaData.get(\"TriggerMapping\"),\n+            metadata.getTriggers().add(new TriggerMetaData((String)nodeMetaData.get(TRIGGER_REF), \n+                                                           (String)nodeMetaData.get(TRIGGER_TYPE), \n+                                                           (String)nodeMetaData.get(MESSAGE_TYPE), \n+                                                           (String)nodeMetaData.get(TRIGGER_MAPPING),\n                                                            String.valueOf(node.getId())).validate());\n             \n-            addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"trigger\", new StringLiteralExpr((String)nodeMetaData.get(\"TriggerRef\")),\n-                                                                                  new StringLiteralExpr(getOrDefault((String)nodeMetaData.get(\"TriggerMapping\"), \"\")));\n+            handleSignal(startNode, nodeMetaData, body, variableScope, metadata);\n+            \n+            addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"trigger\", new StringLiteralExpr((String)nodeMetaData.get(TRIGGER_REF)),\n+                                                                                  new StringLiteralExpr(getOrDefault((String)nodeMetaData.get(TRIGGER_MAPPING), \"\")));\n         } else {\n             // since there is start node without trigger then make sure it is startable\n             metadata.setStartable(true);\n         }\n         \n     }\n+    \n+    protected void handleSignal(StartNode startNode, Map<String, Object> nodeMetaData, BlockStmt body, VariableScope variableScope, ProcessMetaData metadata) {\n+        if (\"signal\".equalsIgnoreCase((String)startNode.getMetaData(TRIGGER_TYPE))) {", "originalCommit": "b605e08a53abab03eca9b6d4d1783037d22aa677", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNjE3NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382906175", "bodyText": "not sure what you mean as this\nObject test = null;\n \"\".equalsIgnoreCase((String) test);\n\ndoes not cause NP, so did you had something else in mind?", "author": "mswiderski", "createdAt": "2020-02-22T11:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1MDQ1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r384450454", "bodyText": "\ud83d\udc4d yeah, you are right I was thinking about the (String) test to be changed to String.valueOf() but indeed the cast does not throw NPE.", "author": "tiagodolphine", "createdAt": "2020-02-26T12:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzE1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzk1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382717954", "bodyText": "there is always a TRIGGER_TYPE,...,  on metaData? otherwise, this can lead to a NPE... maybe using String.valueOf() instead of casting is an option.", "author": "tiagodolphine", "createdAt": "2020-02-21T17:46:03Z", "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/StartNodeVisitor.java", "diffHunk": "@@ -36,24 +44,51 @@ public void visitNode(String factoryField, Node node, BlockStmt body, VariableSc\n         addFactoryMethodWithArgsWithAssignment(factoryField, body, StartNodeFactory.class, \"startNode\" + node.getId(), \"startNode\", new LongLiteralExpr(startNode.getId()));\n         addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"name\", new StringLiteralExpr(getOrDefault(startNode.getName(), \"Start\")));\n         \n+        addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"interrupting\", new BooleanLiteralExpr(startNode.isInterrupting()));\n+        \n         visitMetaData(startNode.getMetaData(), body, \"startNode\" + node.getId());\n         \n         addFactoryMethodWithArgs(body, \"startNode\" + node.getId(), \"done\");\n         \n         if (startNode.getTriggers() != null && !startNode.getTriggers().isEmpty()) {\n             Map<String, Object> nodeMetaData = startNode.getMetaData();\n-            metadata.getTriggers().add(new TriggerMetaData((String)nodeMetaData.get(\"TriggerRef\"), \n-                                                           (String)nodeMetaData.get(\"TriggerType\"), \n-                                                           (String)nodeMetaData.get(\"MessageType\"), \n-                                                           (String)nodeMetaData.get(\"TriggerMapping\"),\n+            metadata.getTriggers().add(new TriggerMetaData((String)nodeMetaData.get(TRIGGER_REF), ", "originalCommit": "b605e08a53abab03eca9b6d4d1783037d22aa677", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkwNjE4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r382906185", "bodyText": "same as above...", "author": "mswiderski", "createdAt": "2020-02-22T11:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzk1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1MDU1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r384450552", "bodyText": "\ud83d\udc4d", "author": "tiagodolphine", "createdAt": "2020-02-26T12:04:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcxNzk1NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "e2c74bd0248d3842c63a0ad8e1307b22099d679b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e2c74bd0248d3842c63a0ad8e1307b22099d679b", "message": "KOGITO-1217 - Event Based Subprocess Support - signal start event", "committedDate": "2020-02-24T10:48:46Z", "type": "commit"}, {"oid": "e2c74bd0248d3842c63a0ad8e1307b22099d679b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e2c74bd0248d3842c63a0ad8e1307b22099d679b", "message": "KOGITO-1217 - Event Based Subprocess Support - signal start event", "committedDate": "2020-02-24T10:48:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNTMwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r383905305", "bodyText": "back to the future? :D", "author": "cristianonicolai", "createdAt": "2020-02-25T14:17:32Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/ruleflow/core/factory/EventSubProcessNodeFactory.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates.", "originalCommit": "e2c74bd0248d3842c63a0ad8e1307b22099d679b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkxMDI0Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/322#discussion_r383910247", "bodyText": "yes, indeed at least the header is there :)", "author": "mswiderski", "createdAt": "2020-02-25T14:25:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkwNTMwNQ=="}], "type": "inlineReview", "revised_code": null}]}