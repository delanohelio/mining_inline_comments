{"pr_number": 439, "pr_title": "[0.9.x] KOGITO-1756 + KOGITO-1779 - Support for Parallel State and fix for SubFlow state support", "pr_createdAt": "2020-04-10T14:06:40Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/439", "timeline": [{"oid": "90e3153ebaf3dcb426d45706a8132e56ddf09abf", "url": "https://github.com/kiegroup/kogito-runtimes/commit/90e3153ebaf3dcb426d45706a8132e56ddf09abf", "message": "Fix for SubFlow data inputs/outputs + initial parallel state work", "committedDate": "2020-04-10T14:01:56Z", "type": "commit"}, {"oid": "88a4b5d3ad2cecc93a21d82ba68670bf7e2629d3", "url": "https://github.com/kiegroup/kogito-runtimes/commit/88a4b5d3ad2cecc93a21d82ba68670bf7e2629d3", "message": "KOGITO-1756 + KOGITO-1779 - Support for Parallel State and fix for SubFlow state support", "committedDate": "2020-04-10T14:02:12Z", "type": "commit"}, {"oid": "e350fc5ff5027f4b5592845852417fe3a824a2f2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/e350fc5ff5027f4b5592845852417fe3a824a2f2", "message": "removed unused method", "committedDate": "2020-04-10T14:02:26Z", "type": "commit"}, {"oid": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "url": "https://github.com/kiegroup/kogito-runtimes/commit/ea7f39e4962df245c6108ea06a56517e98f2ad53", "message": "sonar code smell fix", "committedDate": "2020-04-13T17:10:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNTMyMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408115323", "bodyText": "Please fix the formatting in the whole file, especially for if and for commands.", "author": "MarianMacik", "createdAt": "2020-04-14T12:58:41Z", "path": "jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/ServerlessWorkflowParser.java", "diffHunk": "@@ -199,28 +216,64 @@ public Process parseWorkFlow(Reader workflowFile) throws JsonProcessingException\n                     factory.connect(callActivityNode.getId(), workflowEndNodes.get(state.getName()).getId(), callActivityNode.getId() + \"_\" + workflowEndNodes.get(state.getName()).getId(), process);\n                 }\n \n-                nameToNodeId.put(state.getName(), callActivityNode.getId());\n+                Map<String, Long> startEndMap = new HashMap<>();\n+                startEndMap.put(NODETOID_START, callActivityNode.getId());\n+                startEndMap.put(NODETOID_END, callActivityNode.getId());\n+                nameToNodeId.put(state.getName(), startEndMap);\n             }\n \n             if(state.getType().equals(Type.SWITCH)) {\n                 SwitchState switchState = (SwitchState) state;\n \n-                Split splitNode = factory.xorSplitNode(idCounter.getAndIncrement(), switchState.getName(), process);\n+                Split splitNode = factory.splitNode(idCounter.getAndIncrement(), switchState.getName(), Split.TYPE_XOR, process);\n \n                 if(state.getStart() != null) {\n                     factory.connect(workflowStartNode.getId(), splitNode.getId(), workflowStartNode.getId() + \"_\" + splitNode.getId(), process);\n                 }\n                 // switch states cannot be end states\n-                nameToNodeId.put(state.getName(), splitNode.getId());\n+\n+                Map<String, Long> startEndMap = new HashMap<>();\n+                startEndMap.put(NODETOID_START, splitNode.getId());\n+                startEndMap.put(NODETOID_END, splitNode.getId());\n+                nameToNodeId.put(state.getName(), startEndMap);\n+            }\n+\n+            if(state.getType().equals(Type.PARALLEL)) {\n+                ParallelState parallelState = (ParallelState) state;\n+\n+                Split parallelSplit = factory.splitNode(idCounter.getAndIncrement(), parallelState.getName() + NODE_START_NAME, Split.TYPE_AND, process);\n+                Join parallelJoin = factory.joinNode(idCounter.getAndIncrement(), parallelState.getName() + NODE_END_NAME, Join.TYPE_AND, process);\n+\n+                for(Branch branch : parallelState.getBranches()) {\n+                    SubflowState subflowState = (SubflowState) branch.getStates().get(0);\n+                    SubProcessNode callActivityNode = factory.callActivity(idCounter.getAndIncrement(), subflowState.getName(), subflowState.getWorkflowId(), subflowState.isWaitForCompletion(), process);\n+\n+                    factory.connect(parallelSplit.getId(), callActivityNode.getId(), parallelSplit.getId() + \"_\" + callActivityNode.getId(), process);\n+                    factory.connect(callActivityNode.getId(), parallelJoin.getId(), callActivityNode.getId() + \"_\" + parallelJoin.getId(), process);\n+\n+                }\n+\n+                if(state.getStart() != null) {", "originalCommit": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjU0OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408206548", "bodyText": "fixed - thanks!", "author": "tsurdilo", "createdAt": "2020-04-14T14:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNTMyMw=="}], "type": "inlineReview", "revised_code": {"commit": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "chunk": "diff --git a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/ServerlessWorkflowParser.java b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/ServerlessWorkflowParser.java\nindex 38b59d3595..11a66a07a9 100644\n--- a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/ServerlessWorkflowParser.java\n+++ b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/ServerlessWorkflowParser.java\n\n@@ -203,16 +203,16 @@ public class ServerlessWorkflowParser {\n                 nameToNodeId.put(state.getName(), startEndMap);\n             }\n \n-            if(state.getType().equals(Type.SUBFLOW)) {\n+            if (state.getType().equals(Type.SUBFLOW)) {\n                 SubflowState subflowState = (SubflowState) state;\n \n                 SubProcessNode callActivityNode = factory.callActivity(idCounter.getAndIncrement(), subflowState.getName(), subflowState.getWorkflowId(), subflowState.isWaitForCompletion(), process);\n \n-                if(state.getStart() != null) {\n+                if (state.getStart() != null) {\n                     factory.connect(workflowStartNode.getId(), callActivityNode.getId(), workflowStartNode.getId() + \"_\" + callActivityNode.getId(), process);\n                 }\n \n-                if(state.getEnd() != null) {\n+                if (state.getEnd() != null) {\n                     factory.connect(callActivityNode.getId(), workflowEndNodes.get(state.getName()).getId(), callActivityNode.getId() + \"_\" + workflowEndNodes.get(state.getName()).getId(), process);\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNzkyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408117927", "bodyText": "Probably would be better to omit it as if the value of the DEFAULT_WORKFLOW_VAR is changed, this comment becomes misleading.", "author": "MarianMacik", "createdAt": "2020-04-14T13:02:41Z", "path": "jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java", "diffHunk": "@@ -174,6 +175,20 @@ public SubProcessNode callActivity(long id, String name, String calledId, boolea\n         subProcessNode.setName(name);\n         subProcessNode.setProcessId(calledId);\n         subProcessNode.setWaitForCompletion(waitForCompletion);\n+        subProcessNode.setIndependent(true);\n+\n+        VariableScope variableScope = new VariableScope();\n+        subProcessNode.addContext(variableScope);\n+        subProcessNode.setDefaultContext(variableScope);\n+\n+        Map<String, String> inputOtuputTypes = new HashMap<>();\n+        inputOtuputTypes.put(DEFAULT_WORKFLOW_VAR, JSON_NODE);\n+        subProcessNode.setMetaData(\"BPMN.InputTypes\", inputOtuputTypes);\n+        subProcessNode.setMetaData(\"BPMN.OutputTypes\", inputOtuputTypes);\n+\n+        // parent and sub processes have process var \"workflowdata\"", "originalCommit": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjY1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408206654", "bodyText": "good point - fixed", "author": "tsurdilo", "createdAt": "2020-04-14T15:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExNzkyNw=="}], "type": "inlineReview", "revised_code": {"commit": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "chunk": "diff --git a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\nindex 4445b19442..dcf4dbc668 100644\n--- a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n+++ b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n\n@@ -186,7 +186,6 @@ public class ServerlessWorkflowFactory {\n         subProcessNode.setMetaData(\"BPMN.InputTypes\", inputOtuputTypes);\n         subProcessNode.setMetaData(\"BPMN.OutputTypes\", inputOtuputTypes);\n \n-        // parent and sub processes have process var \"workflowdata\"\n         subProcessNode.addInMapping(DEFAULT_WORKFLOW_VAR, DEFAULT_WORKFLOW_VAR);\n         subProcessNode.addOutMapping(DEFAULT_WORKFLOW_VAR, DEFAULT_WORKFLOW_VAR);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExODU4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408118580", "bodyText": "Why do we need this here? Can we just put here a link to the documentation or name of the class where this is specified? This quickly can become obsolete once the code is changed.", "author": "MarianMacik", "createdAt": "2020-04-14T13:03:42Z", "path": "jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java", "diffHunk": "@@ -269,23 +284,45 @@ public CompositeContextNode subProcessNode(long id, String name, NodeContainer n\n         subProcessNode.addContext(variableScope);\n         subProcessNode.setDefaultContext(variableScope);\n         subProcessNode.setAutoComplete(true);\n-\n         nodeContainer.addNode(subProcessNode);\n \n         return subProcessNode;\n     }\n \n-    public Split xorSplitNode(long id, String name, NodeContainer nodeContainer) {\n+\n+    public Split splitNode(long id, String name, int type, NodeContainer nodeContainer) {\n+        // 0 = TYPE_UNDEFINED\n+        // 1 = TYPE_AND\n+        // 2 = TYPE_XOR\n+        // 3 = TYPE_OR\n+        // 4 = TYPE_XAND", "originalCommit": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjgxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408206813", "bodyText": "removed. thanks!", "author": "tsurdilo", "createdAt": "2020-04-14T15:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExODU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "chunk": "diff --git a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\nindex 4445b19442..dcf4dbc668 100644\n--- a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n+++ b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n\n@@ -291,11 +290,6 @@ public class ServerlessWorkflowFactory {\n \n \n     public Split splitNode(long id, String name, int type, NodeContainer nodeContainer) {\n-        // 0 = TYPE_UNDEFINED\n-        // 1 = TYPE_AND\n-        // 2 = TYPE_XOR\n-        // 3 = TYPE_OR\n-        // 4 = TYPE_XAND\n         Split split = new Split();\n         split.setId(id);\n         split.setName(name);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExODY1OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408118658", "bodyText": "Same here.", "author": "MarianMacik", "createdAt": "2020-04-14T13:03:51Z", "path": "jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java", "diffHunk": "@@ -269,23 +284,45 @@ public CompositeContextNode subProcessNode(long id, String name, NodeContainer n\n         subProcessNode.addContext(variableScope);\n         subProcessNode.setDefaultContext(variableScope);\n         subProcessNode.setAutoComplete(true);\n-\n         nodeContainer.addNode(subProcessNode);\n \n         return subProcessNode;\n     }\n \n-    public Split xorSplitNode(long id, String name, NodeContainer nodeContainer) {\n+\n+    public Split splitNode(long id, String name, int type, NodeContainer nodeContainer) {\n+        // 0 = TYPE_UNDEFINED\n+        // 1 = TYPE_AND\n+        // 2 = TYPE_XOR\n+        // 3 = TYPE_OR\n+        // 4 = TYPE_XAND\n         Split split = new Split();\n         split.setId(id);\n         split.setName(name);\n-        split.setType(2);\n-        split.setMetaData(\"UniqueId\", Long.toString(id));\n+        split.setType(type);\n+        split.setMetaData(UNIQUE_ID_PARAM, Long.toString(id));\n \n         nodeContainer.addNode(split);\n         return split;\n     }\n \n+    public Join joinNode(long id, String name, int type, NodeContainer nodeContainer) {\n+        // 0 = TYPE_UNDEFINED\n+        // 1 = TYPE_AND\n+        // 2 = TYPE_XOR\n+        // 3 = TYPE_DISCRIMINATOR\n+        // 4 = TYPE_N_OF_M\n+        // 5 = TYPE_OR", "originalCommit": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjg5OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408206898", "bodyText": "removed - thanks!", "author": "tsurdilo", "createdAt": "2020-04-14T15:00:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODExODY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "chunk": "diff --git a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\nindex 4445b19442..dcf4dbc668 100644\n--- a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n+++ b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/core/ServerlessWorkflowFactory.java\n\n@@ -291,11 +290,6 @@ public class ServerlessWorkflowFactory {\n \n \n     public Split splitNode(long id, String name, int type, NodeContainer nodeContainer) {\n-        // 0 = TYPE_UNDEFINED\n-        // 1 = TYPE_AND\n-        // 2 = TYPE_XOR\n-        // 3 = TYPE_OR\n-        // 4 = TYPE_XAND\n         Split split = new Split();\n         split.setId(id);\n         split.setName(name);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyMTg0Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408121843", "bodyText": "Can you please format this better and probably include a reason why it is not supported, i.e. just a subset of parallel states is supported etc.?", "author": "MarianMacik", "createdAt": "2020-04-14T13:08:40Z", "path": "jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/util/ServerlessWorkflowUtils.java", "diffHunk": "@@ -89,14 +92,39 @@ public static boolean includesSupportedStates(Workflow workflow) {\n                     && !state.getType().equals(DefaultState.Type.DELAY)\n                     && !state.getType().equals(DefaultState.Type.SUBFLOW)\n                     && !state.getType().equals(DefaultState.Type.RELAY)\n-                    && !state.getType().equals(DefaultState.Type.SWITCH)) {\n+                    && !state.getType().equals(DefaultState.Type.SWITCH)\n+                    && !state.getType().equals(DefaultState.Type.PARALLEL)) {\n                 return false;\n             }\n+\n+            if(state.getType().equals(DefaultState.Type.PARALLEL)) {\n+                if(!supportedParallelState((ParallelState) state)) {\n+                    LOGGER.warn(\"unsupported parallel state\");", "originalCommit": "ea7f39e4962df245c6108ea06a56517e98f2ad53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNzA4OA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/439#discussion_r408207088", "bodyText": "formatted and updated logger warn message. thanks", "author": "tsurdilo", "createdAt": "2020-04-14T15:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEyMTg0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "chunk": "diff --git a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/util/ServerlessWorkflowUtils.java b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/util/ServerlessWorkflowUtils.java\nindex c91f0479f0..dcba275340 100644\n--- a/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/util/ServerlessWorkflowUtils.java\n+++ b/jbpm/jbpm-serverless-workflow/src/main/java/org/jbpm/serverless/workflow/parser/util/ServerlessWorkflowUtils.java\n\n@@ -86,8 +87,8 @@ public class ServerlessWorkflowUtils {\n     }\n \n     public static boolean includesSupportedStates(Workflow workflow) {\n-        for(State state : workflow.getStates()) {\n-            if(!state.getType().equals(DefaultState.Type.EVENT)\n+        for (State state : workflow.getStates()) {\n+            if (!state.getType().equals(DefaultState.Type.EVENT)\n                     && !state.getType().equals(DefaultState.Type.OPERATION)\n                     && !state.getType().equals(DefaultState.Type.DELAY)\n                     && !state.getType().equals(DefaultState.Type.SUBFLOW)\n"}}, {"oid": "6f6ad51135b12f81db597ec822986b5a0aa6961f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/6f6ad51135b12f81db597ec822986b5a0aa6961f", "message": "formatting updates", "committedDate": "2020-04-14T14:59:34Z", "type": "commit"}]}