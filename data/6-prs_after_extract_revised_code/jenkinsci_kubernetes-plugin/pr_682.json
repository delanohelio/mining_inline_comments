{"pr_number": 682, "pr_title": "Separate authentication tokens", "pr_createdAt": "2020-01-13T08:57:55Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/682", "timeline": [{"oid": "30ca44dd5235ea6b0b4c9b7c3c62c35ef4f032fa", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/30ca44dd5235ea6b0b4c9b7c3c62c35ef4f032fa", "message": "enable support of AuthenticationTokens", "committedDate": "2019-08-29T09:16:55Z", "type": "commit"}, {"oid": "dcc3ce5be2c3061689115022c25a20bf28db5146", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/dcc3ce5be2c3061689115022c25a20bf28db5146", "message": "use incremental version of kubernetes-credentials", "committedDate": "2019-08-29T13:29:20Z", "type": "commit"}, {"oid": "4f948404c682e6e88ee05f6f4617170da0eeab7c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4f948404c682e6e88ee05f6f4617170da0eeab7c", "message": "code-review fixes", "committedDate": "2019-08-29T15:01:18Z", "type": "commit"}, {"oid": "084eb2f143e3728672ddc13a27aebca1311f74f0", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/084eb2f143e3728672ddc13a27aebca1311f74f0", "message": "use KubernetesAuth", "committedDate": "2019-09-02T12:08:01Z", "type": "commit"}, {"oid": "d2b13e5b38eb37e96b4b216d723f215fe59ce768", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/d2b13e5b38eb37e96b4b216d723f215fe59ce768", "message": "use KubernetesAuth.decorate(AuthInfoBuilder)", "committedDate": "2019-09-03T15:18:59Z", "type": "commit"}, {"oid": "69bd828109245b1728ba9a9bfd33b43a2851ac8a", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/69bd828109245b1728ba9a9bfd33b43a2851ac8a", "message": "code cleanup", "committedDate": "2019-09-03T15:45:57Z", "type": "commit"}, {"oid": "4869c2397951691350e2d53373a7b1e475a6b43c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4869c2397951691350e2d53373a7b1e475a6b43c", "message": "code review fixes", "committedDate": "2019-09-03T19:47:42Z", "type": "commit"}, {"oid": "318e574634d4a341aba5978754b7ff0f716627d5", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/318e574634d4a341aba5978754b7ff0f716627d5", "message": "code cleanup", "committedDate": "2019-09-04T09:42:14Z", "type": "commit"}, {"oid": "03c656789001293088cd16bcd1f9bace2e08b37b", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/03c656789001293088cd16bcd1f9bace2e08b37b", "message": "bump to latest kubernetes-credentials", "committedDate": "2019-09-04T10:20:16Z", "type": "commit"}, {"oid": "2d8b38f079339a9cd71ab464711ff033a2a1f53e", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2d8b38f079339a9cd71ab464711ff033a2a1f53e", "message": "move io.fabric8 deps to kubernetes-credentials plugin", "committedDate": "2019-09-04T11:18:19Z", "type": "commit"}, {"oid": "5129996a1ca75e6776738c0379354eb0c19920f0", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/5129996a1ca75e6776738c0379354eb0c19920f0", "message": "code-review fixes", "committedDate": "2019-09-06T13:54:43Z", "type": "commit"}, {"oid": "eb00a0367ca41900b02983d87137b86e8478e23a", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/eb00a0367ca41900b02983d87137b86e8478e23a", "message": "Adjust after changes to kubernetes-credentials", "committedDate": "2019-11-22T15:02:08Z", "type": "commit"}, {"oid": "3bf70b45d7e49e0cc8eafc2ad0415afc6e89d14d", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/3bf70b45d7e49e0cc8eafc2ad0415afc6e89d14d", "message": "Merge pull request #1 from Vlatombe/separate-authentication-tokens\n\nAdjust after changes to kubernetes-credentials", "committedDate": "2019-12-04T12:29:58Z", "type": "commit"}, {"oid": "6655bce239bd4432721477074e97f3f368fcbe16", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/6655bce239bd4432721477074e97f3f368fcbe16", "message": "Merge branch 'master' into separate-authentication-tokens", "committedDate": "2019-12-19T15:43:34Z", "type": "commit"}, {"oid": "96a110bc1efd9a3d3122d632701ddbfabd6a3381", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/96a110bc1efd9a3d3122d632701ddbfabd6a3381", "message": "Update kubernetes-credentials version", "committedDate": "2020-01-08T22:30:03Z", "type": "commit"}, {"oid": "4b30c4ef5a6bb44189153c68a9895c0bcf264d8c", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4b30c4ef5a6bb44189153c68a9895c0bcf264d8c", "message": "Merge branch 'master' into separate-authentication-tokens", "committedDate": "2020-01-09T08:26:31Z", "type": "commit"}, {"oid": "468bbd830386ac7ce64c012ae604e024e522c714", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/468bbd830386ac7ce64c012ae604e024e522c714", "message": "Fix reviews from Jesse", "committedDate": "2020-01-13T08:49:20Z", "type": "commit"}, {"oid": "3ee5f9a0f4e752a31c02daf8f0ee626fdf3a9924", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/3ee5f9a0f4e752a31c02daf8f0ee626fdf3a9924", "message": "Remove use of TokenProducer since KubernetesAuth is always used to do auth", "committedDate": "2020-01-13T08:55:36Z", "type": "commit"}, {"oid": "8d4312bffa89a68b2abc3db57ac68f482411d3fe", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/8d4312bffa89a68b2abc3db57ac68f482411d3fe", "message": "Merge branch 'master' into separate-authentication-tokens", "committedDate": "2020-01-13T10:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MjQ5OA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/682#discussion_r442852498", "bodyText": "JENKINS-61239: this is wrong, cannot work with agents. Use configFile.write().", "author": "jglick", "createdAt": "2020-06-19T13:50:53Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/KubectlBuildWrapper.java", "diffHunk": "@@ -87,132 +67,31 @@ public String getCaCertificate() {\n \n     @Override\n     public void setUp(Context context, Run<?, ?> build, FilePath workspace, Launcher launcher, TaskListener listener, EnvVars initialEnvironment) throws IOException, InterruptedException {\n-\n         FilePath configFile = workspace.createTempFile(\".kube\", \"config\");\n         Set<String> tempFiles = newHashSet(configFile.getRemote());\n \n         context.env(\"KUBECONFIG\", configFile.getRemote());\n         context.setDisposer(new CleanupDisposer(tempFiles));\n \n-        String tlsConfig;\n-        if (caCertificate != null && !caCertificate.isEmpty()) {\n-            FilePath caCrtFile = workspace.createTempFile(\"cert-auth\", \"crt\");\n-            String ca = caCertificate;\n-            if (!ca.startsWith(BEGIN_CERTIFICATE)) {\n-                ca = wrapWithMarker(BEGIN_CERTIFICATE, END_CERTIFICATE, ca);\n-            }\n-            caCrtFile.write(ca, null);\n-            tempFiles.add(caCrtFile.getRemote());\n-\n-            tlsConfig = \" --certificate-authority=\" + caCrtFile.getRemote();\n-        } else {\n-            tlsConfig = \" --insecure-skip-tls-verify=true\";\n-        }\n-\n-        int status = launcher.launch()\n-                .cmdAsSingleString(\"kubectl config --kubeconfig=\\\"\" + configFile.getRemote()\n-                        + \"\\\" set-cluster k8s --server=\" + serverUrl + tlsConfig)\n-                .join();\n-        if (status != 0) throw new IOException(\"Failed to run kubectl config \"+status);\n-\n-        final StandardCredentials c = getCredentials();\n-\n-        String login;\n-        if (c == null) {\n-            throw new AbortException(\"No credentials defined to setup Kubernetes CLI\");\n+        StandardCredentials credentials = CredentialsProvider.findCredentialById(credentialsId, StandardCredentials.class, build, Collections.emptyList());\n+        if (credentials == null) {\n+            throw new AbortException(\"No credentials found for id \\\"\" + credentialsId + \"\\\"\");\n         }\n-\n-        if (c instanceof FileCredentials) {\n-            try (InputStream in = ((FileCredentials) c).getContent(); OutputStream out = configFile.write()) {\n-                IOUtils.copy(in, out);\n-            }\n-            return;\n+        KubernetesAuth auth = AuthenticationTokens.convert(KubernetesAuth.class, credentials);\n+        if (auth == null) {\n+            throw new AbortException(\"Unsupported Credentials type \" + credentials.getClass().getName());\n         }\n-\n-        if (c instanceof StringCredentials) {\n-            login = \"--token=\" + ((StringCredentials) c).getSecret().getPlainText();\n-        } else if (c instanceof TokenProducer) {\n-            login = \"--token=\" + ((TokenProducer) c).getToken(serverUrl, null, true);\n-        } else if (c instanceof UsernamePasswordCredentials) {\n-            UsernamePasswordCredentials upc = (UsernamePasswordCredentials) c;\n-            login = \"--username=\" + upc.getUsername() + \" --password=\" + Secret.toString(upc.getPassword());\n-        } else if (c instanceof StandardCertificateCredentials) {\n-            StandardCertificateCredentials scc = (StandardCertificateCredentials) c;\n-            KeyStore keyStore = scc.getKeyStore();\n-            String alias;\n+        // create Kubeconfig\n+        try (Writer w = new OutputStreamWriter(new FileOutputStream(configFile.getRemote()), \"UTF-8\")) {", "originalCommit": "8d4312bffa89a68b2abc3db57ac68f482411d3fe", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}