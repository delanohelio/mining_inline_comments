{"pr_number": 906, "pr_title": "Pod decorator extension point", "pr_createdAt": "2020-11-23T13:42:26Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906", "timeline": [{"oid": "b755e72e3104b792f5126aaeeee121cf347dcc72", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b755e72e3104b792f5126aaeeee121cf347dcc72", "message": "Pod decorator extension point", "committedDate": "2020-11-23T13:41:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMDg0OQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r528720849", "bodyText": "Just inline.", "author": "jglick", "createdAt": "2020-11-23T13:57:56Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.csanchez.jenkins.plugins.kubernetes;\n+\n+import hudson.ExtensionList;\n+import hudson.ExtensionPoint;\n+import io.fabric8.kubernetes.api.model.PodBuilder;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Allows to alter a pod definition after it has been built from the yaml and DSL/GUI configuration.\n+ */\n+public abstract class PodDecorator implements ExtensionPoint {\n+    public static ExtensionList<PodDecorator> all() {", "originalCommit": "b755e72e3104b792f5126aaeeee121cf347dcc72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c362ab9394b747a403de25525fb63c31962599d", "chunk": "diff --git a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\nindex 0403f35e..114beb92 100644\n--- a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\n+++ b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\n\n@@ -9,19 +9,16 @@ import javax.annotation.Nonnull;\n /**\n  * Allows to alter a pod definition after it has been built from the yaml and DSL/GUI configuration.\n  */\n-public abstract class PodDecorator implements ExtensionPoint {\n-    public static ExtensionList<PodDecorator> all() {\n-        return ExtensionList.lookup(PodDecorator.class);\n-    }\n+public interface PodDecorator extends ExtensionPoint {\n \n     @Nonnull\n-    public static PodBuilder decorateAll(@Nonnull PodBuilder builder) {\n-        for (PodDecorator decorator : all()) {\n+    static PodBuilder decorateAll(@Nonnull PodBuilder builder) {\n+        for (PodDecorator decorator : ExtensionList.lookup(PodDecorator.class)) {\n             builder = decorator.decorate(builder);\n         }\n         return builder;\n     }\n \n     @Nonnull\n-    protected abstract PodBuilder decorate(@Nonnull PodBuilder builder);\n+    PodBuilder decorate(@Nonnull PodBuilder builder);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMDk5Mw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r528720993", "bodyText": "Could be an interface.", "author": "jglick", "createdAt": "2020-11-23T13:58:11Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package org.csanchez.jenkins.plugins.kubernetes;\n+\n+import hudson.ExtensionList;\n+import hudson.ExtensionPoint;\n+import io.fabric8.kubernetes.api.model.PodBuilder;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Allows to alter a pod definition after it has been built from the yaml and DSL/GUI configuration.\n+ */\n+public abstract class PodDecorator implements ExtensionPoint {", "originalCommit": "b755e72e3104b792f5126aaeeee121cf347dcc72", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5c362ab9394b747a403de25525fb63c31962599d", "chunk": "diff --git a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\nindex 0403f35e..114beb92 100644\n--- a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\n+++ b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodDecorator.java\n\n@@ -9,19 +9,16 @@ import javax.annotation.Nonnull;\n /**\n  * Allows to alter a pod definition after it has been built from the yaml and DSL/GUI configuration.\n  */\n-public abstract class PodDecorator implements ExtensionPoint {\n-    public static ExtensionList<PodDecorator> all() {\n-        return ExtensionList.lookup(PodDecorator.class);\n-    }\n+public interface PodDecorator extends ExtensionPoint {\n \n     @Nonnull\n-    public static PodBuilder decorateAll(@Nonnull PodBuilder builder) {\n-        for (PodDecorator decorator : all()) {\n+    static PodBuilder decorateAll(@Nonnull PodBuilder builder) {\n+        for (PodDecorator decorator : ExtensionList.lookup(PodDecorator.class)) {\n             builder = decorator.decorate(builder);\n         }\n         return builder;\n     }\n \n     @Nonnull\n-    protected abstract PodBuilder decorate(@Nonnull PodBuilder builder);\n+    PodBuilder decorate(@Nonnull PodBuilder builder);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTUzMw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r528721533", "bodyText": "Does this cost anything if the list is empty?", "author": "jglick", "createdAt": "2020-11-23T13:59:02Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -233,7 +233,7 @@ public Pod build() {\n         }\n \n         // merge with the yaml fragments\n-        Pod pod = combine(template.getYamlsPod(), builder.endSpec().build());\n+        Pod pod = PodDecorator.decorateAll(new PodBuilder(combine(template.getYamlsPod(), builder.endSpec().build()))).build();", "originalCommit": "b755e72e3104b792f5126aaeeee121cf347dcc72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc0MjA2Mw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r528742063", "bodyText": "It's pretty cheap but I refactored to avoid it.", "author": "Vlatombe", "createdAt": "2020-11-23T14:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyMTUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "dd56241214888daf2ed5e21291b6ec597c791140", "chunk": "diff --git a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java\nindex 8e741350..c21b0d91 100644\n--- a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java\n+++ b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java\n\n@@ -233,7 +233,7 @@ public class PodTemplateBuilder {\n         }\n \n         // merge with the yaml fragments\n-        Pod pod = PodDecorator.decorateAll(new PodBuilder(combine(template.getYamlsPod(), builder.endSpec().build()))).build();\n+        Pod pod = PodDecorator.decorateAll(combine(template.getYamlsPod(), builder.endSpec().build()));\n \n         // Apply defaults\n \n"}}, {"oid": "5c362ab9394b747a403de25525fb63c31962599d", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/5c362ab9394b747a403de25525fb63c31962599d", "message": "Fix reviews", "committedDate": "2020-11-23T14:26:21Z", "type": "commit"}, {"oid": "dd56241214888daf2ed5e21291b6ec597c791140", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/dd56241214888daf2ed5e21291b6ec597c791140", "message": "Optimize with 0 decorators", "committedDate": "2020-11-23T14:28:46Z", "type": "commit"}, {"oid": "595c21757fb34fcbf2d818129f0c4738c6ee2984", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/595c21757fb34fcbf2d818129f0c4738c6ee2984", "message": "Functional test + reference implementations\n\nExtension point only depends on Pod model, not on the builder. Some\nchanges are easier to implement only using the model, some others are\neasier using the builder.", "committedDate": "2020-11-24T09:50:16Z", "type": "commit"}, {"oid": "b66d80e9fa25469362708c039dbbb03f720b54b9", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b66d80e9fa25469362708c039dbbb03f720b54b9", "message": "Some comments", "committedDate": "2020-11-24T09:53:57Z", "type": "commit"}, {"oid": "34bf2fe51484244207fded1d91a546737ae4f1dc", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/34bf2fe51484244207fded1d91a546737ae4f1dc", "message": "Merge branch 'master' into poddecorator", "committedDate": "2020-11-24T16:24:04Z", "type": "commit"}, {"oid": "ac7b9d2b6974deaa6bccf611eee37375f9015b54", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/ac7b9d2b6974deaa6bccf611eee37375f9015b54", "message": "Add KubernetesCloud to signature", "committedDate": "2020-11-30T10:36:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTExNw==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r532721117", "bodyText": "https://github.com/jenkinsci/kubernetes-plugin/pull/906/checks?check_run_id=1473530018", "author": "jglick", "createdAt": "2020-11-30T16:19:41Z", "path": "src/test/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilderTest.java", "diffHunk": "@@ -301,6 +301,7 @@ private void validatePod(Pod pod, boolean directConnection) {\n \n     private void validatePod(Pod pod, boolean fromYaml, boolean directConnection) {\n         assertThat(pod.getMetadata().getLabels(), hasEntry(\"some-label\", \"some-label-value\"));\n+        assertEquals(\"Never\", pod.getSpec().getRestartPolicy());", "originalCommit": "ac7b9d2b6974deaa6bccf611eee37375f9015b54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTQ3Ng==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r532721476", "bodyText": "yeah, looking into it.", "author": "Vlatombe", "createdAt": "2020-11-30T16:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyMTExNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "4a0397cb58c1b203617649ce9acb76f18acc2315", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/4a0397cb58c1b203617649ce9acb76f18acc2315", "message": "Always set PodTemplateBuilder#slave", "committedDate": "2020-11-30T16:43:13Z", "type": "commit"}, {"oid": "b08a8b22222ce34c1dbc3fb85e04bf9d34dd8766", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/b08a8b22222ce34c1dbc3fb85e04bf9d34dd8766", "message": "Keep the old contructor as it may be used", "committedDate": "2020-11-30T16:46:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0MTU0MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r532741540", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    volumes.put(WORKSPACE_VOLUME_NAME, template.getWorkspaceVolume().buildVolume(WORKSPACE_VOLUME_NAME, agent != null ? agent.getPodName() : null));\n          \n          \n            \n                    volumes.put(WORKSPACE_VOLUME_NAME, template.getWorkspaceVolume().buildVolume(WORKSPACE_VOLUME_NAME, agent.getPodName()));\n          \n      \n    \n    \n  \n\nif it is really @Nonnull?", "author": "jglick", "createdAt": "2020-11-30T16:47:01Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -166,7 +168,7 @@ public Pod build() {\n             }\n         }\n \n-        volumes.put(WORKSPACE_VOLUME_NAME, template.getWorkspaceVolume().buildVolume(WORKSPACE_VOLUME_NAME, slave != null ? slave.getPodName() : null));\n+        volumes.put(WORKSPACE_VOLUME_NAME, template.getWorkspaceVolume().buildVolume(WORKSPACE_VOLUME_NAME, agent != null ? agent.getPodName() : null));", "originalCommit": "4a0397cb58c1b203617649ce9acb76f18acc2315", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0MzQzNA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r532743434", "bodyText": "The old constructor is used in other places so I have to keep it @CheckForNull", "author": "Vlatombe", "createdAt": "2020-11-30T16:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0MTU0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc0MTgxOQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/906#discussion_r532741819", "bodyText": "Ditto here, etc.?", "author": "jglick", "createdAt": "2020-11-30T16:47:24Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/PodTemplateBuilder.java", "diffHunk": "@@ -176,13 +178,13 @@ public Pod build() {\n         }\n \n         MetadataNested<PodBuilder> metadataBuilder = new PodBuilder().withNewMetadata();\n-        if (slave != null) {\n-            metadataBuilder.withName(slave.getPodName());\n+        if (agent != null) {", "originalCommit": "4a0397cb58c1b203617649ce9acb76f18acc2315", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a759929ae74ac5f6ac236a21dcd4dd4205632a63", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/a759929ae74ac5f6ac236a21dcd4dd4205632a63", "message": "Merge branch 'master' into poddecorator", "committedDate": "2020-12-03T15:51:40Z", "type": "commit"}, {"oid": "3a6f187771124af17dbae8f81f5755e0572589b5", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/3a6f187771124af17dbae8f81f5755e0572589b5", "message": "Fix broken tests", "committedDate": "2020-12-03T15:59:19Z", "type": "commit"}]}