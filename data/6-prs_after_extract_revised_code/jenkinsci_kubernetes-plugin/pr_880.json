{"pr_number": 880, "pr_title": "Resolve cloud when removing dynamic template", "pr_createdAt": "2020-11-04T14:18:22Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880", "timeline": [{"oid": "1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b", "message": "Resolve cloud when removing dynamic template", "committedDate": "2020-11-04T14:17:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwODc0NA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r517508744", "bodyText": "Will this fail the build if the cloud is not found? Is that the desired affect? I guess it would alert the user of an issue.", "author": "cwholmes", "createdAt": "2020-11-04T17:23:44Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java", "diffHunk": "@@ -253,21 +253,10 @@ private PodTemplateCallback(PodTemplate podTemplate) {\n          * Remove the template after step is done\n          */\n         protected void finished(StepContext context) throws Exception {\n-            Cloud cloud = Jenkins.get().getCloud(cloudName);\n-            if (cloud == null) {\n-                LOGGER.log(Level.FINE, \"Cloud {0} no longer exists, cannot delete pod template {1}\",\n-                        new Object[] { cloudName, podTemplate.getName() });\n-                return;\n-            }\n-            if (cloud instanceof KubernetesCloud) {\n-                LOGGER.log(Level.FINE, \"Removing pod template {1} from cloud {0}\",\n-                        new Object[] { cloud.name, podTemplate.getName() });\n-                KubernetesCloud kubernetesCloud = (KubernetesCloud) cloud;\n-                kubernetesCloud.removeDynamicTemplate(podTemplate);\n-            } else {\n-                LOGGER.log(Level.WARNING, \"Cloud is not a KubernetesCloud: {0} {1}\",\n-                        new String[] { cloud.name, cloud.getClass().getName() });\n-            }\n+            KubernetesCloud cloud = resolveCloud();", "originalCommit": "1cb6d4a7ea2a968af917ceff29e4cd94edd7a33b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxODc0OA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r518618748", "bodyText": "This would happen only if the cloud is removed while running the step. I guess it is highly unlikely to happen (unless you're actively changing the instance configuration, and in that case it wouldn't be unexpected to see some jobs failing as a result of removing the kubernetes cloud).", "author": "Vlatombe", "createdAt": "2020-11-06T09:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUwODc0NA=="}], "type": "inlineReview", "revised_code": {"commit": "e5fd2cca51270de2e9339cac0aba917f18b8dea4", "chunk": "diff --git a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\nindex 9ef92e58..6e24dccc 100755\n--- a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\n+++ b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\n\n@@ -253,10 +253,14 @@ public class PodTemplateStepExecution extends AbstractStepExecutionImpl {\n          * Remove the template after step is done\n          */\n         protected void finished(StepContext context) throws Exception {\n-            KubernetesCloud cloud = resolveCloud();\n-            LOGGER.log(Level.FINE, () -> \"Removing pod template \" + podTemplate.getName()\n-                    + \" from cloud \" + cloud.name);\n-            cloud.removeDynamicTemplate(podTemplate);\n+            try {\n+                KubernetesCloud cloud = resolveCloud();\n+                LOGGER.log(Level.FINE, () -> \"Removing pod template \" + podTemplate.getName()\n+                        + \" from cloud \" + cloud.name);\n+                cloud.removeDynamicTemplate(podTemplate);\n+            } catch (AbortException e) {\n+                LOGGER.log(Level.WARNING, () -> \"Unable to resolve cloud for \" + podTemplate.getName() + \". Maybe the cloud was removed while running the build?\");\n+            }\n         }\n     }\n }\n"}}, {"oid": "e5fd2cca51270de2e9339cac0aba917f18b8dea4", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/e5fd2cca51270de2e9339cac0aba917f18b8dea4", "message": "Don't fail the build, just print a warning if can't remove the cloud", "committedDate": "2020-11-06T09:48:31Z", "type": "commit"}, {"oid": "be75374190b83535094ab3a3d142f868619c4da3", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/be75374190b83535094ab3a3d142f868619c4da3", "message": "Add exception to log", "committedDate": "2020-11-06T13:23:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0ODg5NQ==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r518748895", "bodyText": "Is it a good idea to mute this exception?", "author": "twasyl", "createdAt": "2020-11-06T13:25:47Z", "path": "src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java", "diffHunk": "@@ -253,20 +253,13 @@ private PodTemplateCallback(PodTemplate podTemplate) {\n          * Remove the template after step is done\n          */\n         protected void finished(StepContext context) throws Exception {\n-            Cloud cloud = Jenkins.get().getCloud(cloudName);\n-            if (cloud == null) {\n-                LOGGER.log(Level.FINE, \"Cloud {0} no longer exists, cannot delete pod template {1}\",\n-                        new Object[] { cloudName, podTemplate.getName() });\n-                return;\n-            }\n-            if (cloud instanceof KubernetesCloud) {\n-                LOGGER.log(Level.FINE, \"Removing pod template {1} from cloud {0}\",\n-                        new Object[] { cloud.name, podTemplate.getName() });\n-                KubernetesCloud kubernetesCloud = (KubernetesCloud) cloud;\n-                kubernetesCloud.removeDynamicTemplate(podTemplate);\n-            } else {\n-                LOGGER.log(Level.WARNING, \"Cloud is not a KubernetesCloud: {0} {1}\",\n-                        new String[] { cloud.name, cloud.getClass().getName() });\n+            try {\n+                KubernetesCloud cloud = resolveCloud();\n+                LOGGER.log(Level.FINE, () -> \"Removing pod template \" + podTemplate.getName()\n+                        + \" from cloud \" + cloud.name);\n+                cloud.removeDynamicTemplate(podTemplate);\n+            } catch (AbortException e) {\n+                LOGGER.log(Level.WARNING, () -> \"Unable to resolve cloud for \" + podTemplate.getName() + \". Maybe the cloud was removed while running the build?\");", "originalCommit": "e5fd2cca51270de2e9339cac0aba917f18b8dea4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0OTY3MA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/880#discussion_r518749670", "bodyText": "Already updated in be75374", "author": "Vlatombe", "createdAt": "2020-11-06T13:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc0ODg5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "bb1aeeff42d274fc0846c691850cf957d3b2726f", "chunk": "diff --git a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\nindex 6e24dccc..756a7ebc 100755\n--- a/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\n+++ b/src/main/java/org/csanchez/jenkins/plugins/kubernetes/pipeline/PodTemplateStepExecution.java\n\n@@ -259,7 +259,7 @@ public class PodTemplateStepExecution extends AbstractStepExecutionImpl {\n                         + \" from cloud \" + cloud.name);\n                 cloud.removeDynamicTemplate(podTemplate);\n             } catch (AbortException e) {\n-                LOGGER.log(Level.WARNING, () -> \"Unable to resolve cloud for \" + podTemplate.getName() + \". Maybe the cloud was removed while running the build?\");\n+                LOGGER.log(Level.WARNING, e, () -> \"Unable to resolve cloud for \" + podTemplate.getName() + \". Maybe the cloud was removed while running the build?\");\n             }\n         }\n     }\n"}}, {"oid": "bb1aeeff42d274fc0846c691850cf957d3b2726f", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/bb1aeeff42d274fc0846c691850cf957d3b2726f", "message": "Check that the pod template is indeed removed", "committedDate": "2020-11-06T13:42:51Z", "type": "commit"}]}