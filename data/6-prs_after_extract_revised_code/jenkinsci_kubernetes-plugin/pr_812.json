{"pr_number": 812, "pr_title": "Suggest NodeProvisioner review after adding new pods", "pr_createdAt": "2020-08-03T12:50:24Z", "pr_url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812", "timeline": [{"oid": "631e45172b4fdada0ac62ce1ea990962e353e10b", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/631e45172b4fdada0ac62ce1ea990962e353e10b", "message": "suggest NodeProvisioner review after adding new pods", "committedDate": "2020-08-03T12:42:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTg2OA==", "url": "https://github.com/jenkinsci/kubernetes-plugin/pull/812#discussion_r467729868", "bodyText": "nodeProvisioner is always non-null if label is non-null.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        NodeProvisioner nodeProvisioner = label.nodeProvisioner;\n          \n          \n            \n                        if (availableCapacity > 0 && nodeProvisioner != null) {\n          \n          \n            \n                            LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n          \n          \n            \n                            Timer.get().schedule(nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n          \n          \n            \n                        }\n          \n          \n            \n                        if (availableCapacity > 0 && label != null) {\n          \n          \n            \n                            LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n          \n          \n            \n                            Timer.get().schedule(label.nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n          \n          \n            \n                        }\n          \n      \n    \n    \n  \n\navailableCapacity > 0 is not useful IMO. It would be more relevant to capture the number of nodes provisioned in the current round and check if it is >0.", "author": "Vlatombe", "createdAt": "2020-08-10T07:30:41Z", "path": "src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java", "diffHunk": "@@ -71,6 +73,11 @@\n             }\n         }\n         if (availableCapacity >= currentDemand) {\n+            NodeProvisioner nodeProvisioner = label.nodeProvisioner;\n+            if (availableCapacity > 0 && nodeProvisioner != null) {\n+                LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n+                Timer.get().schedule(nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n+            }", "originalCommit": "631e45172b4fdada0ac62ce1ea990962e353e10b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243", "chunk": "diff --git a/src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java b/src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java\nindex 33d3de69..7631bdb3 100644\n--- a/src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java\n+++ b/src/main/java/io/jenkins/plugins/kubernetes/NoDelayProvisionerStrategy.java\n\n@@ -72,12 +73,11 @@ public class NoDelayProvisionerStrategy extends NodeProvisioner.Strategy {\n                 break;\n             }\n         }\n+        if (availableCapacity > previousCapacity && label != null) {\n+            LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n+            Timer.get().schedule(label.nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n+        }\n         if (availableCapacity >= currentDemand) {\n-            NodeProvisioner nodeProvisioner = label.nodeProvisioner;\n-            if (availableCapacity > 0 && nodeProvisioner != null) {\n-                LOGGER.log(Level.FINE, \"Suggesting NodeProvisioner review\");\n-                Timer.get().schedule(nodeProvisioner::suggestReviewNow, 1L, TimeUnit.SECONDS);\n-            }\n             LOGGER.log(Level.FINE, \"Provisioning completed\");\n             return NodeProvisioner.StrategyDecision.PROVISIONING_COMPLETED;\n         } else {\n"}}, {"oid": "2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243", "url": "https://github.com/jenkinsci/kubernetes-plugin/commit/2a3d3d6d8ec0f078e0cb1911b8bf97ce3f0c0243", "message": "check if any nodes were provisioned in the current round", "committedDate": "2020-08-10T07:47:23Z", "type": "commit"}]}