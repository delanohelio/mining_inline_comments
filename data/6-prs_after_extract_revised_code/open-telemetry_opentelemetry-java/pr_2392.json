{"pr_number": 2392, "pr_title": "Add ability to create accumulation to the Aggregator", "pr_createdAt": "2020-12-22T20:29:38Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMTExMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547511110", "bodyText": "nit : collectAllAsyncInstruments  (lower-case the 's' in async)", "author": "jkwatson", "createdAt": "2020-12-22T21:16:26Z", "path": "sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java", "diffHunk": "@@ -0,0 +1,460 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.sdk.metrics;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.api.common.Labels;\n+import io.opentelemetry.api.metrics.DoubleCounter;\n+import io.opentelemetry.api.metrics.DoubleUpDownCounter;\n+import io.opentelemetry.api.metrics.DoubleValueRecorder;\n+import io.opentelemetry.api.metrics.LongCounter;\n+import io.opentelemetry.api.metrics.LongUpDownCounter;\n+import io.opentelemetry.api.metrics.LongValueRecorder;\n+import io.opentelemetry.sdk.common.InstrumentationLibraryInfo;\n+import io.opentelemetry.sdk.internal.TestClock;\n+import io.opentelemetry.sdk.metrics.aggregation.AggregationFactory;\n+import io.opentelemetry.sdk.metrics.common.InstrumentType;\n+import io.opentelemetry.sdk.metrics.data.MetricData;\n+import io.opentelemetry.sdk.metrics.view.AggregationConfiguration;\n+import io.opentelemetry.sdk.metrics.view.InstrumentSelector;\n+import io.opentelemetry.sdk.resources.Resource;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import org.junit.jupiter.api.Test;\n+\n+public class SdkMeterProviderTest {\n+  private static final Resource RESOURCE =\n+      Resource.create(Attributes.of(AttributeKey.stringKey(\"resource_key\"), \"resource_value\"));\n+  private static final InstrumentationLibraryInfo INSTRUMENTATION_LIBRARY_INFO =\n+      InstrumentationLibraryInfo.create(SdkMeterProviderTest.class.getName(), null);\n+  private final TestClock testClock = TestClock.create();\n+  private final SdkMeterProvider testMeterProvider =\n+      SdkMeterProvider.builder().setClock(testClock).setResource(RESOURCE).build();\n+  private final SdkMeter testSdk = testMeterProvider.get(SdkMeterProviderTest.class.getName());\n+\n+  @Test\n+  void collectAllSyncInstruments() {\n+    LongCounter longCounter = testSdk.longCounterBuilder(\"testLongCounter\").build();\n+    longCounter.add(10, Labels.empty());\n+    LongUpDownCounter longUpDownCounter =\n+        testSdk.longUpDownCounterBuilder(\"testLongUpDownCounter\").build();\n+    longUpDownCounter.add(-10, Labels.empty());\n+    LongValueRecorder longValueRecorder =\n+        testSdk.longValueRecorderBuilder(\"testLongValueRecorder\").build();\n+    longValueRecorder.record(10, Labels.empty());\n+    DoubleCounter doubleCounter = testSdk.doubleCounterBuilder(\"testDoubleCounter\").build();\n+    doubleCounter.add(10.1, Labels.empty());\n+    DoubleUpDownCounter doubleUpDownCounter =\n+        testSdk.doubleUpDownCounterBuilder(\"testDoubleUpDownCounter\").build();\n+    doubleUpDownCounter.add(-10.1, Labels.empty());\n+    DoubleValueRecorder doubleValueRecorder =\n+        testSdk.doubleValueRecorderBuilder(\"testDoubleValueRecorder\").build();\n+    doubleValueRecorder.record(10.1, Labels.empty());\n+\n+    assertThat(testSdk.collectAll())\n+        .containsExactlyInAnyOrder(\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10.1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10.1)))),\n+            MetricData.createDoubleSummary(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSummaryData.create(\n+                    Collections.singletonList(\n+                        MetricData.DoubleSummaryPoint.create(\n+                            testClock.now(),\n+                            testClock.now(),\n+                            Labels.empty(),\n+                            1,\n+                            10,\n+                            Arrays.asList(\n+                                MetricData.ValueAtPercentile.create(0, 10),\n+                                MetricData.ValueAtPercentile.create(100, 10)))))),\n+            MetricData.createDoubleSummary(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSummaryData.create(\n+                    Collections.singletonList(\n+                        MetricData.DoubleSummaryPoint.create(\n+                            testClock.now(),\n+                            testClock.now(),\n+                            Labels.empty(),\n+                            1,\n+                            10.1d,\n+                            Arrays.asList(\n+                                MetricData.ValueAtPercentile.create(0, 10.1d),\n+                                MetricData.ValueAtPercentile.create(100, 10.1d)))))));\n+  }\n+\n+  @Test\n+  void collectAllSyncInstruments_CustomAggregation() {\n+    registerViewForAllTypes(\n+        testMeterProvider,\n+        AggregationConfiguration.create(\n+            AggregationFactory.count(), MetricData.AggregationTemporality.CUMULATIVE));\n+    LongCounter longCounter = testSdk.longCounterBuilder(\"testLongCounter\").build();\n+    longCounter.add(10, Labels.empty());\n+    LongUpDownCounter longUpDownCounter =\n+        testSdk.longUpDownCounterBuilder(\"testLongUpDownCounter\").build();\n+    longUpDownCounter.add(-10, Labels.empty());\n+    LongValueRecorder longValueRecorder =\n+        testSdk.longValueRecorderBuilder(\"testLongValueRecorder\").build();\n+    longValueRecorder.record(10, Labels.empty());\n+    DoubleCounter doubleCounter = testSdk.doubleCounterBuilder(\"testDoubleCounter\").build();\n+    doubleCounter.add(10.1, Labels.empty());\n+    DoubleUpDownCounter doubleUpDownCounter =\n+        testSdk.doubleUpDownCounterBuilder(\"testDoubleUpDownCounter\").build();\n+    doubleUpDownCounter.add(-10.1, Labels.empty());\n+    DoubleValueRecorder doubleValueRecorder =\n+        testSdk.doubleValueRecorderBuilder(\"testDoubleValueRecorder\").build();\n+    doubleValueRecorder.record(10.1, Labels.empty());\n+\n+    assertThat(testSdk.collectAll())\n+        .containsExactlyInAnyOrder(\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))));\n+  }\n+\n+  @Test\n+  void collectAllASyncInstruments() {", "originalCommit": "6bb1a324683915b19fa60c20ea88927610fec2b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1ODg4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547558880", "bodyText": "Done.", "author": "bogdandrutu", "createdAt": "2020-12-22T23:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMTExMA=="}], "type": "inlineReview", "revised_code": {"commit": "c412507afe0815206280ac00a3c77a716f019d58", "chunk": "diff --git a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java b/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\nindex 9b7a8236b..940f9573c 100644\n--- a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\n+++ b/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\n\n@@ -243,7 +243,7 @@ public class SdkMeterProviderTest {\n   }\n \n   @Test\n-  void collectAllASyncInstruments() {\n+  void collectAllAsyncInstruments() {\n     testSdk\n         .longSumObserverBuilder(\"testLongSumObserver\")\n         .setUpdater(longResult -> longResult.observe(10, Labels.empty()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMTQ0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547511445", "bodyText": "same naming nit here", "author": "jkwatson", "createdAt": "2020-12-22T21:17:16Z", "path": "sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java", "diffHunk": "@@ -0,0 +1,460 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.sdk.metrics;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.api.common.Labels;\n+import io.opentelemetry.api.metrics.DoubleCounter;\n+import io.opentelemetry.api.metrics.DoubleUpDownCounter;\n+import io.opentelemetry.api.metrics.DoubleValueRecorder;\n+import io.opentelemetry.api.metrics.LongCounter;\n+import io.opentelemetry.api.metrics.LongUpDownCounter;\n+import io.opentelemetry.api.metrics.LongValueRecorder;\n+import io.opentelemetry.sdk.common.InstrumentationLibraryInfo;\n+import io.opentelemetry.sdk.internal.TestClock;\n+import io.opentelemetry.sdk.metrics.aggregation.AggregationFactory;\n+import io.opentelemetry.sdk.metrics.common.InstrumentType;\n+import io.opentelemetry.sdk.metrics.data.MetricData;\n+import io.opentelemetry.sdk.metrics.view.AggregationConfiguration;\n+import io.opentelemetry.sdk.metrics.view.InstrumentSelector;\n+import io.opentelemetry.sdk.resources.Resource;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import org.junit.jupiter.api.Test;\n+\n+public class SdkMeterProviderTest {\n+  private static final Resource RESOURCE =\n+      Resource.create(Attributes.of(AttributeKey.stringKey(\"resource_key\"), \"resource_value\"));\n+  private static final InstrumentationLibraryInfo INSTRUMENTATION_LIBRARY_INFO =\n+      InstrumentationLibraryInfo.create(SdkMeterProviderTest.class.getName(), null);\n+  private final TestClock testClock = TestClock.create();\n+  private final SdkMeterProvider testMeterProvider =\n+      SdkMeterProvider.builder().setClock(testClock).setResource(RESOURCE).build();\n+  private final SdkMeter testSdk = testMeterProvider.get(SdkMeterProviderTest.class.getName());\n+\n+  @Test\n+  void collectAllSyncInstruments() {\n+    LongCounter longCounter = testSdk.longCounterBuilder(\"testLongCounter\").build();\n+    longCounter.add(10, Labels.empty());\n+    LongUpDownCounter longUpDownCounter =\n+        testSdk.longUpDownCounterBuilder(\"testLongUpDownCounter\").build();\n+    longUpDownCounter.add(-10, Labels.empty());\n+    LongValueRecorder longValueRecorder =\n+        testSdk.longValueRecorderBuilder(\"testLongValueRecorder\").build();\n+    longValueRecorder.record(10, Labels.empty());\n+    DoubleCounter doubleCounter = testSdk.doubleCounterBuilder(\"testDoubleCounter\").build();\n+    doubleCounter.add(10.1, Labels.empty());\n+    DoubleUpDownCounter doubleUpDownCounter =\n+        testSdk.doubleUpDownCounterBuilder(\"testDoubleUpDownCounter\").build();\n+    doubleUpDownCounter.add(-10.1, Labels.empty());\n+    DoubleValueRecorder doubleValueRecorder =\n+        testSdk.doubleValueRecorderBuilder(\"testDoubleValueRecorder\").build();\n+    doubleValueRecorder.record(10.1, Labels.empty());\n+\n+    assertThat(testSdk.collectAll())\n+        .containsExactlyInAnyOrder(\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10.1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10.1)))),\n+            MetricData.createDoubleSummary(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSummaryData.create(\n+                    Collections.singletonList(\n+                        MetricData.DoubleSummaryPoint.create(\n+                            testClock.now(),\n+                            testClock.now(),\n+                            Labels.empty(),\n+                            1,\n+                            10,\n+                            Arrays.asList(\n+                                MetricData.ValueAtPercentile.create(0, 10),\n+                                MetricData.ValueAtPercentile.create(100, 10)))))),\n+            MetricData.createDoubleSummary(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSummaryData.create(\n+                    Collections.singletonList(\n+                        MetricData.DoubleSummaryPoint.create(\n+                            testClock.now(),\n+                            testClock.now(),\n+                            Labels.empty(),\n+                            1,\n+                            10.1d,\n+                            Arrays.asList(\n+                                MetricData.ValueAtPercentile.create(0, 10.1d),\n+                                MetricData.ValueAtPercentile.create(100, 10.1d)))))));\n+  }\n+\n+  @Test\n+  void collectAllSyncInstruments_CustomAggregation() {\n+    registerViewForAllTypes(\n+        testMeterProvider,\n+        AggregationConfiguration.create(\n+            AggregationFactory.count(), MetricData.AggregationTemporality.CUMULATIVE));\n+    LongCounter longCounter = testSdk.longCounterBuilder(\"testLongCounter\").build();\n+    longCounter.add(10, Labels.empty());\n+    LongUpDownCounter longUpDownCounter =\n+        testSdk.longUpDownCounterBuilder(\"testLongUpDownCounter\").build();\n+    longUpDownCounter.add(-10, Labels.empty());\n+    LongValueRecorder longValueRecorder =\n+        testSdk.longValueRecorderBuilder(\"testLongValueRecorder\").build();\n+    longValueRecorder.record(10, Labels.empty());\n+    DoubleCounter doubleCounter = testSdk.doubleCounterBuilder(\"testDoubleCounter\").build();\n+    doubleCounter.add(10.1, Labels.empty());\n+    DoubleUpDownCounter doubleUpDownCounter =\n+        testSdk.doubleUpDownCounterBuilder(\"testDoubleUpDownCounter\").build();\n+    doubleUpDownCounter.add(-10.1, Labels.empty());\n+    DoubleValueRecorder doubleValueRecorder =\n+        testSdk.doubleValueRecorderBuilder(\"testDoubleValueRecorder\").build();\n+    doubleValueRecorder.record(10.1, Labels.empty());\n+\n+    assertThat(testSdk.collectAll())\n+        .containsExactlyInAnyOrder(\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleUpDownCounter\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleValueRecorder\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 1)))));\n+  }\n+\n+  @Test\n+  void collectAllASyncInstruments() {\n+    testSdk\n+        .longSumObserverBuilder(\"testLongSumObserver\")\n+        .setUpdater(longResult -> longResult.observe(10, Labels.empty()))\n+        .build();\n+    testSdk\n+        .longUpDownSumObserverBuilder(\"testLongUpDownSumObserver\")\n+        .setUpdater(longResult -> longResult.observe(-10, Labels.empty()))\n+        .build();\n+    testSdk\n+        .longValueObserverBuilder(\"testLongValueObserver\")\n+        .setUpdater(longResult -> longResult.observe(10, Labels.empty()))\n+        .build();\n+\n+    testSdk\n+        .doubleSumObserverBuilder(\"testDoubleSumObserver\")\n+        .setUpdater(doubleResult -> doubleResult.observe(10.1, Labels.empty()))\n+        .build();\n+    testSdk\n+        .doubleUpDownSumObserverBuilder(\"testDoubleUpDownSumObserver\")\n+        .setUpdater(doubleResult -> doubleResult.observe(-10.1, Labels.empty()))\n+        .build();\n+    testSdk\n+        .doubleValueObserverBuilder(\"testDoubleValueObserver\")\n+        .setUpdater(doubleResult -> doubleResult.observe(10.1, Labels.empty()))\n+        .build();\n+\n+    assertThat(testSdk.collectAll())\n+        .containsExactlyInAnyOrder(\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongSumObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleSumObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ true,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10.1)))),\n+            MetricData.createLongSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongUpDownSumObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10)))),\n+            MetricData.createDoubleSum(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleUpDownSumObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleSumData.create(\n+                    /* isMonotonic= */ false,\n+                    MetricData.AggregationTemporality.CUMULATIVE,\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), -10.1)))),\n+            MetricData.createLongGauge(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testLongValueObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.LongGaugeData.create(\n+                    Collections.singletonList(\n+                        MetricData.LongPoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10)))),\n+            MetricData.createDoubleGauge(\n+                RESOURCE,\n+                INSTRUMENTATION_LIBRARY_INFO,\n+                \"testDoubleValueObserver\",\n+                \"\",\n+                \"1\",\n+                MetricData.DoubleGaugeData.create(\n+                    Collections.singletonList(\n+                        MetricData.DoublePoint.create(\n+                            testClock.now(), testClock.now(), Labels.empty(), 10.1)))));\n+  }\n+\n+  @Test\n+  void collectAllASyncInstruments_CustomAggregation() {", "originalCommit": "6bb1a324683915b19fa60c20ea88927610fec2b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1ODg0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547558845", "bodyText": "Done.", "author": "bogdandrutu", "createdAt": "2020-12-22T23:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzUxMTQ0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "c412507afe0815206280ac00a3c77a716f019d58", "chunk": "diff --git a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java b/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\nindex 9b7a8236b..940f9573c 100644\n--- a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\n+++ b/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java\n\n@@ -243,7 +243,7 @@ public class SdkMeterProviderTest {\n   }\n \n   @Test\n-  void collectAllASyncInstruments() {\n+  void collectAllAsyncInstruments() {\n     testSdk\n         .longSumObserverBuilder(\"testLongSumObserver\")\n         .setUpdater(longResult -> longResult.observe(10, Labels.empty()))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0NzYzOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547547639", "bodyText": "discussed offline that we should probably move these methods into the Aggregator. Not sure if this should be done in this PR or a follow-up.\nAlso, it might be nice to call it something like \"directAccumulate\" or something that makes it clear it should be used by async instruments.", "author": "jkwatson", "createdAt": "2020-12-22T23:00:39Z", "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/AggregatorFactory.java", "diffHunk": "@@ -5,16 +5,42 @@\n \n package io.opentelemetry.sdk.metrics.aggregator;\n \n+import io.opentelemetry.sdk.metrics.aggregation.Accumulation;\n import javax.annotation.concurrent.Immutable;\n \n /** Factory class for {@link Aggregator}. */\n @Immutable\n-public interface AggregatorFactory {\n+public abstract class AggregatorFactory {\n \n   /**\n-   * Returns a new {@link Aggregator}.\n+   * Returns a new {@link Aggregator}. This MUST by used by the synchronous to aggregate recorded\n+   * measurements during the collection cycle.\n    *\n    * @return a new {@link Aggregator}.\n    */\n-  Aggregator getAggregator();\n+  public abstract Aggregator getAggregator();\n+\n+  /**\n+   * Returns a new {@code Accumulation} for the given value. This MUST be used by the asynchronous\n+   * instruments to create {@code Accumulation} that are passed to the processor.\n+   *\n+   * @param value the given value to be used to create the {@code Accumulation}.\n+   * @return a new {@code Accumulation} for the given value.\n+   */\n+  public Accumulation accumulateLong(long value) {", "originalCommit": "6bb1a324683915b19fa60c20ea88927610fec2b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU1NjY4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547556681", "bodyText": "If you are ok I would do it in the next PR :)", "author": "bogdandrutu", "createdAt": "2020-12-22T23:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU0NzYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c412507afe0815206280ac00a3c77a716f019d58", "chunk": "diff --git a/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/AggregatorFactory.java b/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/AggregatorFactory.java\nindex 68a51336a..d56bb1f70 100644\n--- a/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/AggregatorFactory.java\n+++ b/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/AggregatorFactory.java\n\n@@ -10,7 +10,7 @@ import javax.annotation.concurrent.Immutable;\n \n /** Factory class for {@link Aggregator}. */\n @Immutable\n-public abstract class AggregatorFactory {\n+public abstract class AggregatorFactory<T extends Accumulation> {\n \n   /**\n    * Returns a new {@link Aggregator}. This MUST by used by the synchronous to aggregate recorded\n"}}, {"oid": "c412507afe0815206280ac00a3c77a716f019d58", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c412507afe0815206280ac00a3c77a716f019d58", "message": "Add ability to create accumulation to the Aggregator\n\nThis way the Accumulator will produce the right accumulations, for example in case of count. Added tests for all instrument types.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-22T23:40:17Z", "type": "commit"}, {"oid": "c412507afe0815206280ac00a3c77a716f019d58", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c412507afe0815206280ac00a3c77a716f019d58", "message": "Add ability to create accumulation to the Aggregator\n\nThis way the Accumulator will produce the right accumulations, for example in case of count. Added tests for all instrument types.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-22T23:40:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2NDk3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547564977", "bodyText": "excellent test. thanks!", "author": "jkwatson", "createdAt": "2020-12-23T00:03:15Z", "path": "sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/SdkMeterProviderTest.java", "diffHunk": "@@ -0,0 +1,460 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.sdk.metrics;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.api.common.Labels;\n+import io.opentelemetry.api.metrics.DoubleCounter;\n+import io.opentelemetry.api.metrics.DoubleUpDownCounter;\n+import io.opentelemetry.api.metrics.DoubleValueRecorder;\n+import io.opentelemetry.api.metrics.LongCounter;\n+import io.opentelemetry.api.metrics.LongUpDownCounter;\n+import io.opentelemetry.api.metrics.LongValueRecorder;\n+import io.opentelemetry.sdk.common.InstrumentationLibraryInfo;\n+import io.opentelemetry.sdk.internal.TestClock;\n+import io.opentelemetry.sdk.metrics.aggregation.AggregationFactory;\n+import io.opentelemetry.sdk.metrics.common.InstrumentType;\n+import io.opentelemetry.sdk.metrics.data.MetricData;\n+import io.opentelemetry.sdk.metrics.view.AggregationConfiguration;\n+import io.opentelemetry.sdk.metrics.view.InstrumentSelector;\n+import io.opentelemetry.sdk.resources.Resource;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import org.junit.jupiter.api.Test;\n+\n+public class SdkMeterProviderTest {", "originalCommit": "c412507afe0815206280ac00a3c77a716f019d58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2OTcyMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2392#discussion_r547569723", "bodyText": "Thanks", "author": "bogdandrutu", "createdAt": "2020-12-23T00:22:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2NDk3Nw=="}], "type": "inlineReview", "revised_code": null}]}