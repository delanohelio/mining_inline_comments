{"pr_number": 2353, "pr_title": "Fix flappy IntervalMetricReaderTest", "pr_createdAt": "2020-12-18T02:16:26Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2353", "timeline": [{"oid": "faf51bb9f71002de811d7d6a004cc89298353b80", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/faf51bb9f71002de811d7d6a004cc89298353b80", "message": "fix flappy test", "committedDate": "2020-12-18T02:13:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0Nzc5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2353#discussion_r545547792", "bodyText": "IIUC, the problem was that exportedMetrics could have more than the expected number of exports returned? Anyways, blockingqueue always better than monitors!", "author": "anuraaga", "createdAt": "2020-12-18T03:20:14Z", "path": "sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/export/IntervalMetricReaderTest.java", "diffHunk": "@@ -176,20 +173,12 @@ public CompletableResultCode shutdown() {\n      * metrics.\n      */\n     @Nullable\n-    List<List<MetricData>> waitForNumberOfExports(int numberOfExports) {\n-      List<List<MetricData>> result;\n-      synchronized (monitor) {\n-        while (exportedMetrics.size() < numberOfExports) {\n-          try {\n-            monitor.wait();\n-          } catch (InterruptedException e) {\n-            // Preserve the interruption status as per guidance.\n-            Thread.currentThread().interrupt();\n-            return null;\n-          }\n-        }\n-        result = exportedMetrics;", "originalCommit": "faf51bb9f71002de811d7d6a004cc89298353b80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk3MDI0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2353#discussion_r545970248", "bodyText": "Yeah, in some circumstances export() was entered a second time before the released wait() in the other thread could continue on with its work of adding to the result.  By the time it got around to doing that, there would occasionally be more data than expected.", "author": "breedx-splk", "createdAt": "2020-12-18T17:11:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0Nzc5Mg=="}], "type": "inlineReview", "revised_code": null}]}