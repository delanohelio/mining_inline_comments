{"pr_number": 1974, "pr_title": "Documents that ContextStorage.current can return null", "pr_createdAt": "2020-11-02T16:04:47Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974", "timeline": [{"oid": "cbf4b6cea99df0a7e85bca11f7c95439197a25cd", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/cbf4b6cea99df0a7e85bca11f7c95439197a25cd", "message": "Fixes ThreadLocalContextStorage to return root Context if not set on current thread", "committedDate": "2020-11-02T16:00:18Z", "type": "commit"}, {"oid": "1512fa1d754644b0c2de3f30a6039c848bfc1c03", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1512fa1d754644b0c2de3f30a6039c848bfc1c03", "message": "Kick CI", "committedDate": "2020-11-02T16:07:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516084876", "bodyText": "I think we can simply remove this line, we check for null in the Context and this is not necessarily.", "author": "bogdandrutu", "createdAt": "2020-11-02T16:15:02Z", "path": "context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java", "diffHunk": "@@ -45,7 +41,8 @@ public Scope attach(Context toAttach) {\n \n   @Override\n   public Context current() {\n-    return THREAD_LOCAL_STORAGE.get();\n+    Context threadContext = THREAD_LOCAL_STORAGE.get();\n+    return threadContext != null ? threadContext : Context.root();", "originalCommit": "1512fa1d754644b0c2de3f30a6039c848bfc1c03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5MjQ0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516092448", "bodyText": "And add to the javadoc this behavior.", "author": "bogdandrutu", "createdAt": "2020-11-02T16:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE0ODk4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516148985", "bodyText": "Ok, if it's expected that ContextStorage#current can return null it feels like I should also add the @Nullable annotation so that developers can expect this.", "author": "HaloFour", "createdAt": "2020-11-02T17:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE1OTMwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516159308", "bodyText": "Are you suggesting to change this Javadoc on ContextStorage#current?  It implies that this method will never return null:\n  /**\n   * Returns the current {@link DefaultContext}. If no {@link DefaultContext} has been attached yet,\n   * this will be the {@linkplain Context#root()} root context}.\n   */\n\nAlso feels weird that it calls out DefaultContext given that's a package-private class.", "author": "HaloFour", "createdAt": "2020-11-02T18:01:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4MTU4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516181580", "bodyText": "See here: https://github.com/HaloFour/opentelemetry-java/blob/1512fa1d754644b0c2de3f30a6039c848bfc1c03/context/src/main/java/io/opentelemetry/context/Context.java#L72", "author": "Oberon00", "createdAt": "2020-11-02T18:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NDAyOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516184029", "bodyText": "That's why I'm asking for clarity, because if it's expected that ContextStorage#current can return null then the Javadocs on that method should be updated to reflect this, and the method should be marked as @Nullable.", "author": "HaloFour", "createdAt": "2020-11-02T18:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NTIwNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516185204", "bodyText": "What is more\n\nThreadLocalContextStorage sets the ThreadLocal to Context.root() within the static constructor\n\nthis seems to be useless then and could be removed.\nCC @anuraaga", "author": "Oberon00", "createdAt": "2020-11-02T18:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE5MDc3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516190774", "bodyText": "I've committed the suggested changes, which more or less reverses what the PR was intended to do so I've changed the description of the PR (if that's ok).", "author": "HaloFour", "createdAt": "2020-11-02T18:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "077b1ce27f182adc2deac6d479e587a69eb30d6b", "chunk": "diff --git a/context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java b/context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java\nindex f1b1a0042..92f24849a 100644\n--- a/context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java\n+++ b/context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java\n\n@@ -40,9 +41,9 @@ enum ThreadLocalContextStorage implements ContextStorage {\n   }\n \n   @Override\n+  @Nullable\n   public Context current() {\n-    Context threadContext = THREAD_LOCAL_STORAGE.get();\n-    return threadContext != null ? threadContext : Context.root();\n+    return THREAD_LOCAL_STORAGE.get();\n   }\n \n   enum NoopScope implements Scope {\n"}}, {"oid": "077b1ce27f182adc2deac6d479e587a69eb30d6b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/077b1ce27f182adc2deac6d479e587a69eb30d6b", "message": "Change docs on ContextStorage.current to indicate that it can return null", "committedDate": "2020-11-02T18:55:27Z", "type": "commit"}, {"oid": "31f1dddab70a6a3d8f99ba32114edaf7e62df463", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/31f1dddab70a6a3d8f99ba32114edaf7e62df463", "message": "Kick CI", "committedDate": "2020-11-02T19:05:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ2NDQ0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516464445", "bodyText": "Thanks for fixing my silliness :)", "author": "anuraaga", "createdAt": "2020-11-03T07:24:24Z", "path": "context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java", "diffHunk": "@@ -15,10 +16,6 @@\n \n   private static final ThreadLocal<Context> THREAD_LOCAL_STORAGE = new ThreadLocal<>();\n \n-  static {\n-    THREAD_LOCAL_STORAGE.set(Context.root());", "originalCommit": "31f1dddab70a6a3d8f99ba32114edaf7e62df463", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}