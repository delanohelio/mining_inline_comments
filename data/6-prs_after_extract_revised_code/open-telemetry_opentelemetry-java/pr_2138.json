{"pr_number": 2138, "pr_title": "Convert TraceState to be an interface", "pr_createdAt": "2020-11-25T22:25:58Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzM2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530723369", "bodyText": "Move this to a package private field in ArrayBasedTraceState so it's not public", "author": "anuraaga", "createdAt": "2020-11-26T01:31:32Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceState.java", "diffHunk": "@@ -24,21 +21,40 @@\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n+ *\n+ * <p>Implementations of this interface that do not conform to the W3C specification risk\n+ * incompatibility with W3C-compatible implementations.\n+ *\n+ * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n+ * here via the {@link TraceStateBuilder}.\n  */\n @Immutable\n-@AutoValue\n-public abstract class TraceState {\n-  private static final TraceState DEFAULT = TraceState.builder().build();\n+public interface TraceState {\n+\n+  TraceState DEFAULT = new TraceStateBuilder().build();", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczMTk2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530731966", "bodyText": "I tried this, but it ended up breaking with a class loading issue like the other one. :(", "author": "jkwatson", "createdAt": "2020-11-26T02:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczNzUzMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530737530", "bodyText": "What if it's in the builder? I think one of the two is supposed to work ok (or otherwise I guess another package private class)", "author": "anuraaga", "createdAt": "2020-11-26T02:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkwNTI5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r532905293", "bodyText": "If I were to put this into a separate class, what would I call it? TraceStateDefaultHolder?", "author": "jkwatson", "createdAt": "2020-11-30T21:10:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMTQ0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r532921445", "bodyText": "I called it DefaultTraceState. Seems like an obvious enough name. :)", "author": "jkwatson", "createdAt": "2020-11-30T21:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzM2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\nindex fa92b5770..4b838cdef 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\n@@ -21,18 +20,7 @@ import javax.annotation.concurrent.Immutable;\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n- *\n- * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n- * equals/hashCode implementations. If an implementation does not strictly conform to these\n- * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n- *\n- * <p>Implementations of this interface that do not conform to the W3C specification risk\n- * incompatibility with W3C-compatible implementations.\n- *\n- * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n- * here via the {@link TraceStateBuilder}.\n  */\n-@Immutable\n public interface TraceState {\n \n   TraceState DEFAULT = new TraceStateBuilder().build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzUxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530723511", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              /**\n          \n          \n            \n               * Returns a {@code Builder} based on an empty {@code TraceState}.\n          \n          \n            \n               *\n          \n          \n            \n               * @return a {@code Builder} based on an empty {@code TraceState}.\n          \n          \n            \n               */\n          \n          \n            \n              /**\n          \n          \n            \n               * Returns an empty {@code TraceStateBuilder}.\n          \n          \n            \n               */", "author": "anuraaga", "createdAt": "2020-11-26T01:32:05Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceState.java", "diffHunk": "@@ -24,21 +21,40 @@\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n+ *\n+ * <p>Implementations of this interface that do not conform to the W3C specification risk\n+ * incompatibility with W3C-compatible implementations.\n+ *\n+ * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n+ * here via the {@link TraceStateBuilder}.\n  */\n @Immutable\n-@AutoValue\n-public abstract class TraceState {\n-  private static final TraceState DEFAULT = TraceState.builder().build();\n+public interface TraceState {\n+\n+  TraceState DEFAULT = new TraceStateBuilder().build();\n \n   /**\n    * Returns the default {@code TraceState} with no entries.\n    *\n    * @return the default {@code TraceState}.\n    */\n-  public static TraceState getDefault() {\n+  static TraceState getDefault() {\n     return DEFAULT;\n   }\n \n+  /**\n+   * Returns a {@code Builder} based on an empty {@code TraceState}.\n+   *\n+   * @return a {@code Builder} based on an empty {@code TraceState}.\n+   */", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\nindex fa92b5770..4b838cdef 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\n@@ -21,18 +20,7 @@ import javax.annotation.concurrent.Immutable;\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n- *\n- * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n- * equals/hashCode implementations. If an implementation does not strictly conform to these\n- * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n- *\n- * <p>Implementations of this interface that do not conform to the W3C specification risk\n- * incompatibility with W3C-compatible implementations.\n- *\n- * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n- * here via the {@link TraceStateBuilder}.\n  */\n-@Immutable\n public interface TraceState {\n \n   TraceState DEFAULT = new TraceStateBuilder().build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzU4Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530723587", "bodyText": "I pondered a bit on whether this needs to return an interface too - but since it's static guess not", "author": "anuraaga", "createdAt": "2020-11-26T01:32:23Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceState.java", "diffHunk": "@@ -24,21 +21,40 @@\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n+ *\n+ * <p>Implementations of this interface that do not conform to the W3C specification risk\n+ * incompatibility with W3C-compatible implementations.\n+ *\n+ * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n+ * here via the {@link TraceStateBuilder}.\n  */\n @Immutable\n-@AutoValue\n-public abstract class TraceState {\n-  private static final TraceState DEFAULT = TraceState.builder().build();\n+public interface TraceState {\n+\n+  TraceState DEFAULT = new TraceStateBuilder().build();\n \n   /**\n    * Returns the default {@code TraceState} with no entries.\n    *\n    * @return the default {@code TraceState}.\n    */\n-  public static TraceState getDefault() {\n+  static TraceState getDefault() {\n     return DEFAULT;\n   }\n \n+  /**\n+   * Returns a {@code Builder} based on an empty {@code TraceState}.\n+   *\n+   * @return a {@code Builder} based on an empty {@code TraceState}.\n+   */\n+  static TraceStateBuilder builder() {", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyOTA0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530729044", "bodyText": "@trask Actually can you check this - will we be able to do the interface interop if this doesn't return an interface? I guess we may intercept every method in TraceStateBuilder but not sure.", "author": "anuraaga", "createdAt": "2020-11-26T01:52:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc1OTUyNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530759526", "bodyText": "it's the toBuilder() method that hurts: https://github.com/open-telemetry/opentelemetry-java/pull/2134/files#r530758547\n@jkwatson sorry to ask, would you mind turning these builders into interfaces?", "author": "trask", "createdAt": "2020-11-26T03:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMTUzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r532921538", "bodyText": "done. please take a look", "author": "jkwatson", "createdAt": "2020-11-30T21:41:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzU4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\nindex fa92b5770..4b838cdef 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\n@@ -21,18 +20,7 @@ import javax.annotation.concurrent.Immutable;\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n- *\n- * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n- * equals/hashCode implementations. If an implementation does not strictly conform to these\n- * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n- *\n- * <p>Implementations of this interface that do not conform to the W3C specification risk\n- * incompatibility with W3C-compatible implementations.\n- *\n- * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n- * here via the {@link TraceStateBuilder}.\n  */\n-@Immutable\n public interface TraceState {\n \n   TraceState DEFAULT = new TraceStateBuilder().build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzY3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530723671", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * here via the {@link TraceStateBuilder}.\n          \n          \n            \n             * here via the {@link TraceState#builder}.", "author": "anuraaga", "createdAt": "2020-11-26T01:32:43Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceState.java", "diffHunk": "@@ -24,21 +21,40 @@\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n+ *\n+ * <p>Implementations of this interface that do not conform to the W3C specification risk\n+ * incompatibility with W3C-compatible implementations.\n+ *\n+ * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n+ * here via the {@link TraceStateBuilder}.", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\nindex fa92b5770..4b838cdef 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\n@@ -21,18 +20,7 @@ import javax.annotation.concurrent.Immutable;\n  *\n  * <p>Value is opaque string up to 256 characters printable ASCII RFC0020 characters (i.e., the\n  * range 0x20 to 0x7E) except comma , and =.\n- *\n- * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n- * equals/hashCode implementations. If an implementation does not strictly conform to these\n- * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n- *\n- * <p>Implementations of this interface that do not conform to the W3C specification risk\n- * incompatibility with W3C-compatible implementations.\n- *\n- * <p>For these reasons, it is strongly suggested that you use the implementation that is provided\n- * here via the {@link TraceStateBuilder}.\n  */\n-@Immutable\n public interface TraceState {\n \n   TraceState DEFAULT = new TraceStateBuilder().build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDExOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530724118", "bodyText": "Thinking about your question about w3c prefix, it's a bit weird. The w3c'ness is only in this builder, not the TraceState, not sure how best to deal with that. I wonder if we should remove the validation from this class and do it in the propagator?", "author": "anuraaga", "createdAt": "2020-11-26T01:34:43Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java", "diffHunk": "@@ -10,27 +10,31 @@\n import java.util.Objects;\n import javax.annotation.Nullable;\n \n-/** A builder of {@link TraceState}. */\n+/**\n+ * A builder of {@link TraceState}. This implementation does full validation of the keys and values", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczMzI4Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530733283", "bodyText": "yeah...it's a weird thing to be first-class in the APIs, and not constrained to be part of the propagator, TBH. I was pondering only making this class prefixed with W3C, and leaving the TraceState itself to be generic.", "author": "jkwatson", "createdAt": "2020-11-26T02:08:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczODA4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530738086", "bodyText": "I think I'd leave it as is then - the builder of TraceState being TraceStateBuilder seems clearer even with the w3c caveats.", "author": "anuraaga", "createdAt": "2020-11-26T02:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNDExOA=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\nindex 0cb44e05e..0e685b015 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n\n@@ -10,31 +10,27 @@ import java.util.Collections;\n import java.util.Objects;\n import javax.annotation.Nullable;\n \n-/**\n- * A builder of {@link TraceState}. This implementation does full validation of the keys and values\n- * in the entries, and will ignore any entries that do not conform to the W3C specification.\n- */\n+/** A builder of {@link TraceStateImpl}. */\n public final class TraceStateBuilder {\n   public static final int MAX_VENDOR_ID_SIZE = 13;\n \n   // Needs to be in this class to avoid initialization deadlock because super class depends on\n   // subclass (the auto-value generate class).\n-  private static final ArrayBasedTraceState EMPTY =\n-      ArrayBasedTraceState.create(Collections.emptyList());\n+  private static final TraceStateImpl EMPTY = TraceStateImpl.create(Collections.emptyList());\n \n   private static final int MAX_KEY_VALUE_PAIRS = 32;\n   private static final int KEY_MAX_SIZE = 256;\n   private static final int VALUE_MAX_SIZE = 256;\n   private static final int MAX_TENANT_ID_SIZE = 240;\n \n-  private final ArrayBasedTraceState parent;\n-  @Nullable private ArrayList<String> entries;\n+  private final TraceStateImpl parent;\n+  @Nullable private ArrayList<TraceStateImpl.Entry> entries;\n \n   TraceStateBuilder() {\n     parent = EMPTY;\n   }\n \n-  TraceStateBuilder(ArrayBasedTraceState parent) {\n+  TraceStateBuilder(TraceStateImpl parent) {\n     Objects.requireNonNull(parent, \"parent\");\n     this.parent = parent;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTUzMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530725531", "bodyText": "This loop has a lot of shadiness :) Relies on entries.size() being invoked on every loop iteration (true in every language, but not something people expect to matter I think), and two calls to the same entries.remove(i) ouch. Let's use ListIterator.remove instead.", "author": "anuraaga", "createdAt": "2020-11-26T01:39:52Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java", "diffHunk": "@@ -50,20 +54,21 @@ public TraceStateBuilder set(String key, String value) {\n       return this;\n     }\n     // Initially create the Entry to validate input.\n-    TraceState.Entry entry = TraceState.Entry.create(key, value);\n     if (entries == null) {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i++) {\n-      if (entries.get(i).getKey().equals(entry.getKey())) {\n+    for (int i = 0; i < entries.size(); i += 2) {\n+      if (entries.get(i).equals(key)) {\n+        entries.remove(i);", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczODI1MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530738251", "bodyText": "Thought a bit more and realized the suggestion doesn't make much sense. Hmm - let's at least add comments if nothing comes to mind to clean up in this PR.", "author": "anuraaga", "createdAt": "2020-11-26T02:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyMzkyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r532923921", "bodyText": "It doesn't actually rely on entries.size() being called each time, since we break as soon as we remove one. I'll extract out the size and add some comments.", "author": "jkwatson", "createdAt": "2020-11-30T21:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\nindex 0cb44e05e..0e685b015 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n\n@@ -54,21 +50,20 @@ public final class TraceStateBuilder {\n       return this;\n     }\n     // Initially create the Entry to validate input.\n+    TraceStateImpl.Entry entry = TraceStateImpl.Entry.create(key, value);\n     if (entries == null) {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i += 2) {\n-      if (entries.get(i).equals(key)) {\n-        entries.remove(i);\n+    for (int i = 0; i < entries.size(); i++) {\n+      if (entries.get(i).getKey().equals(entry.getKey())) {\n         entries.remove(i);\n         // Exit now because the entries list cannot contain duplicates.\n         break;\n       }\n     }\n     // Inserts the element at the front of this list.\n-    entries.add(0, key);\n-    entries.add(1, value);\n+    entries.add(0, entry);\n     return this;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjY0NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530726645", "bodyText": "Inserting at the head of ArrayList looks like lots of overhead for the standard case of having no dupes, etc. Can we instead build up in opposite order and Collections.reverse in build? We'd need to reverse when copying from parent.getEntries() but I guess that's just a couple more lines of code.", "author": "anuraaga", "createdAt": "2020-11-26T01:44:08Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java", "diffHunk": "@@ -50,20 +54,21 @@ public TraceStateBuilder set(String key, String value) {\n       return this;\n     }\n     // Initially create the Entry to validate input.\n-    TraceState.Entry entry = TraceState.Entry.create(key, value);\n     if (entries == null) {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i++) {\n-      if (entries.get(i).getKey().equals(entry.getKey())) {\n+    for (int i = 0; i < entries.size(); i += 2) {\n+      if (entries.get(i).equals(key)) {\n+        entries.remove(i);\n         entries.remove(i);\n         // Exit now because the entries list cannot contain duplicates.\n         break;\n       }\n     }\n     // Inserts the element at the front of this list.\n-    entries.add(0, entry);\n+    entries.add(0, key);", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczMzgxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530733810", "bodyText": "we could also consider just waiting until the final build to de-dupe. There are options here, for sure. Luckily, it's all internal, so we can make it better whenever.", "author": "jkwatson", "createdAt": "2020-11-26T02:10:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjY0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyODU5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r532928593", "bodyText": "we could put the working data into a LinkedList for easy insert efficiency, as well. there are definitely options here. Not sure how much I want to take on this PR, though.", "author": "jkwatson", "createdAt": "2020-11-30T21:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjY0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\nindex 0cb44e05e..0e685b015 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n\n@@ -54,21 +50,20 @@ public final class TraceStateBuilder {\n       return this;\n     }\n     // Initially create the Entry to validate input.\n+    TraceStateImpl.Entry entry = TraceStateImpl.Entry.create(key, value);\n     if (entries == null) {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i += 2) {\n-      if (entries.get(i).equals(key)) {\n-        entries.remove(i);\n+    for (int i = 0; i < entries.size(); i++) {\n+      if (entries.get(i).getKey().equals(entry.getKey())) {\n         entries.remove(i);\n         // Exit now because the entries list cannot contain duplicates.\n         break;\n       }\n     }\n     // Inserts the element at the front of this list.\n-    entries.add(0, key);\n-    entries.add(1, value);\n+    entries.add(0, entry);\n     return this;\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjY5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530726698", "bodyText": "Looks like we can extract a private doRemove type of method that's used in both set and remove", "author": "anuraaga", "createdAt": "2020-11-26T01:44:25Z", "path": "api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java", "diffHunk": "@@ -81,8 +86,9 @@ public TraceStateBuilder remove(String key) {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i++) {\n-      if (entries.get(i).getKey().equals(key)) {\n+    for (int i = 0; i < entries.size(); i += 2) {", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\nindex 0cb44e05e..0e685b015 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/TraceStateBuilder.java\n\n@@ -86,9 +81,8 @@ public final class TraceStateBuilder {\n       // Copy entries from the parent.\n       entries = new ArrayList<>(parent.getEntries());\n     }\n-    for (int i = 0; i < entries.size(); i += 2) {\n-      if (entries.get(i).equals(key)) {\n-        entries.remove(i);\n+    for (int i = 0; i < entries.size(); i++) {\n+      if (entries.get(i).getKey().equals(key)) {\n         entries.remove(i);\n         // Exit now because the entries list cannot contain duplicates.\n         break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjg5Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530726893", "bodyText": "Ok ok, let me get asMap in soon :P", "author": "anuraaga", "createdAt": "2020-11-26T01:45:07Z", "path": "api/src/test/java/io/opentelemetry/api/trace/TraceStateTest.java", "diffHunk": "@@ -217,11 +217,11 @@ void addAndUpdateEntry() {\n             firstTraceState.toBuilder()\n                 .set(FIRST_KEY, SECOND_VALUE) // update the existing entry\n                 .set(SECOND_KEY, FIRST_VALUE) // add a new entry\n-                .build()\n-                .getEntries())\n-        .containsExactly(\n-            TraceState.Entry.create(SECOND_KEY, FIRST_VALUE),\n-            TraceState.Entry.create(FIRST_KEY, SECOND_VALUE));\n+                .build())\n+        .asInstanceOf(type(ArrayBasedTraceState.class))\n+        .extracting(ArrayBasedTraceState::getEntries)", "originalCommit": "bac3d1b4109325b9c7ed378d1a62e9c3538c6034", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczMzkxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2138#discussion_r530733911", "bodyText": "hah!", "author": "jkwatson", "createdAt": "2020-11-26T02:11:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyNjg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e6b084f8d1401679d1949054d5eeea345fa17986", "chunk": "diff --git a/api/src/test/java/io/opentelemetry/api/trace/TraceStateTest.java b/api/src/test/java/io/opentelemetry/api/trace/TraceStateTest.java\nindex 7fe8ca251..2f039e220 100644\n--- a/api/src/test/java/io/opentelemetry/api/trace/TraceStateTest.java\n+++ b/api/src/test/java/io/opentelemetry/api/trace/TraceStateTest.java\n\n@@ -217,11 +217,11 @@ class TraceStateTest {\n             firstTraceState.toBuilder()\n                 .set(FIRST_KEY, SECOND_VALUE) // update the existing entry\n                 .set(SECOND_KEY, FIRST_VALUE) // add a new entry\n-                .build())\n-        .asInstanceOf(type(ArrayBasedTraceState.class))\n-        .extracting(ArrayBasedTraceState::getEntries)\n-        .asList()\n-        .containsExactly(SECOND_KEY, FIRST_VALUE, FIRST_KEY, SECOND_VALUE);\n+                .build()\n+                .getEntries())\n+        .containsExactly(\n+            TraceStateImpl.Entry.create(SECOND_KEY, FIRST_VALUE),\n+            TraceStateImpl.Entry.create(FIRST_KEY, SECOND_VALUE));\n   }\n \n   @Test\n"}}, {"oid": "e6b084f8d1401679d1949054d5eeea345fa17986", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e6b084f8d1401679d1949054d5eeea345fa17986", "message": "convert TraceState to an interface", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "3477bb322b0759d2223b4818f1f8572f418e7d65", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3477bb322b0759d2223b4818f1f8572f418e7d65", "message": "don't expose the impl", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "df182a80bbf84a3bab8802a6bd295a09e3df63c3", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/df182a80bbf84a3bab8802a6bd295a09e3df63c3", "message": "Remove the un-needed TraceState Entry objects.", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "b209649657de3600b2fc496daa45e01d9f57dd7f", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b209649657de3600b2fc496daa45e01d9f57dd7f", "message": "Add additional javadoc documenting requirements for interface implementors.", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "4d07f7c651c72fdddbba3c6f9f0f10059a1c155c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4d07f7c651c72fdddbba3c6f9f0f10059a1c155c", "message": "make the implementation non-public", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "a53cda2d52a5ae5fe67908b8e851412263344190", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a53cda2d52a5ae5fe67908b8e851412263344190", "message": "remove un-needed test docs", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "be8e3896d5a74705fd3ab6358036c40a5b511cb8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/be8e3896d5a74705fd3ab6358036c40a5b511cb8", "message": "Update api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\nCo-authored-by: Anuraag Agrawal <anuraaga@gmail.com>", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "25eed34a4ceccb0ed960af5a287b2a96bdce990d", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/25eed34a4ceccb0ed960af5a287b2a96bdce990d", "message": "Update api/src/main/java/io/opentelemetry/api/trace/TraceState.java\n\nCo-authored-by: Anuraag Agrawal <anuraaga@gmail.com>", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "dd996376fd66c081df0317bfd441fb650a1605ae", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/dd996376fd66c081df0317bfd441fb650a1605ae", "message": "formatting fix", "committedDate": "2020-11-30T20:42:35Z", "type": "commit"}, {"oid": "dd996376fd66c081df0317bfd441fb650a1605ae", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/dd996376fd66c081df0317bfd441fb650a1605ae", "message": "formatting fix", "committedDate": "2020-11-30T20:42:35Z", "type": "forcePushed"}, {"oid": "f4a00c6cfc33882c258ef969313e45a5a067a9e0", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/f4a00c6cfc33882c258ef969313e45a5a067a9e0", "message": "Convert the TraceStateBuilder into an interface.", "committedDate": "2020-11-30T21:14:49Z", "type": "commit"}, {"oid": "98108e6d17f8084ed408cabb25f4de506bb4d671", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/98108e6d17f8084ed408cabb25f4de506bb4d671", "message": "Introduce an intermediate class to get around classloading cycles.", "committedDate": "2020-11-30T21:40:35Z", "type": "commit"}, {"oid": "f86f96444c6a9bb2203c05b3f77bf9f3539145d1", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/f86f96444c6a9bb2203c05b3f77bf9f3539145d1", "message": "extract a method to remove an entry from the builder", "committedDate": "2020-11-30T22:07:46Z", "type": "commit"}, {"oid": "e457116728b0b0cce0963d6aacb8a8c11625fca6", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e457116728b0b0cce0963d6aacb8a8c11625fca6", "message": "add a comment about the possible inefficiency in the implementation", "committedDate": "2020-11-30T22:15:19Z", "type": "commit"}]}