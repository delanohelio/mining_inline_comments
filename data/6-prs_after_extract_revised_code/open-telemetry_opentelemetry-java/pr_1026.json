{"pr_number": 1026, "pr_title": "Revise null values for AttributeValue", "pr_createdAt": "2020-03-18T09:48:55Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026", "timeline": [{"oid": "876a238edef7119b13121eddbab3c857ee5bc433", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/876a238edef7119b13121eddbab3c857ee5bc433", "message": "Align null/empty AttributeValue to spec", "committedDate": "2020-03-18T07:48:44Z", "type": "commit"}, {"oid": "38932b1158fc1a1f5f5899d40f6e965e0b3b8966", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/38932b1158fc1a1f5f5899d40f6e965e0b3b8966", "message": "Refactoring", "committedDate": "2020-03-18T09:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxNjYxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394516612", "bodyText": "can you add parens around the boolean expression?", "author": "jkwatson", "createdAt": "2020-03-18T17:23:32Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,11 +167,24 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    boolean remove = true;\n+    if (value != null) {\n+      switch (value.getType()) {\n+        case STRING:\n+          remove = value.getStringValue() == null;", "originalCommit": "38932b1158fc1a1f5f5899d40f6e965e0b3b8966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY5NjA3NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395696075", "bodyText": "I do agree just returning is better. ;)", "author": "jkwatson", "createdAt": "2020-03-20T15:02:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxNjYxMg=="}], "type": "inlineReview", "revised_code": {"commit": "c50af9c5873ca8383859cf38f5e0c57ccb557fba", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 24e782648..e2d9ea68b 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -167,6 +167,15 @@ final class SpanBuilderSdk implements Span.Builder {\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n+    if (isToRemove(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n+    }\n+    return this;\n+  }\n+\n+  private static boolean isToRemove(AttributeValue value) {\n     boolean remove = true;\n     if (value != null) {\n       switch (value.getType()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODIwMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394518200", "bodyText": "let's extract this logic to determine remove into its own method.", "author": "jkwatson", "createdAt": "2020-03-18T17:25:54Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,11 +167,24 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    boolean remove = true;\n+    if (value != null) {\n+      switch (value.getType()) {\n+        case STRING:\n+          remove = value.getStringValue() == null;\n+          break;\n+        case BOOLEAN:\n+        case LONG:\n+        case DOUBLE:\n+          remove = false;\n+          break;\n+      }\n+    }", "originalCommit": "38932b1158fc1a1f5f5899d40f6e965e0b3b8966", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxOTI4MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394519280", "bodyText": "speaking of which, couldn't it just be reduced to\n(value != null) && (value.getType() == STRING) && (value.getStringValue() == null)\n?", "author": "jkwatson", "createdAt": "2020-03-18T17:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0OTU2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394549565", "bodyText": "Lets definitely extract the logic into its own method.", "author": "carlosalberto", "createdAt": "2020-03-18T18:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODIwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDgyMDUyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394820521", "bodyText": "speaking of which, couldn't it just be reduced to\n(value != null) && (value.getType() == STRING) && (value.getStringValue() == null)\n?\n\nIn vision of Array types, I prefer a switch statement.", "author": "thisthat", "createdAt": "2020-03-19T06:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODIwMA=="}], "type": "inlineReview", "revised_code": {"commit": "c50af9c5873ca8383859cf38f5e0c57ccb557fba", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 24e782648..e2d9ea68b 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -167,6 +167,15 @@ final class SpanBuilderSdk implements Span.Builder {\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n+    if (isToRemove(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n+    }\n+    return this;\n+  }\n+\n+  private static boolean isToRemove(AttributeValue value) {\n     boolean remove = true;\n     if (value != null) {\n       switch (value.getType()) {\n"}}, {"oid": "c50af9c5873ca8383859cf38f5e0c57ccb557fba", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c50af9c5873ca8383859cf38f5e0c57ccb557fba", "message": "Address feedback", "committedDate": "2020-03-19T07:01:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxMjY5Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r394912692", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static boolean isToRemove(AttributeValue value) {\n          \n          \n            \n              private static boolean isRemovedValue(AttributeValue value) {", "author": "Oberon00", "createdAt": "2020-03-19T10:03:45Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,14 +167,31 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    if (isToRemove(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n     }\n-    attributes.putAttribute(key, value);\n     return this;\n   }\n \n+  private static boolean isToRemove(AttributeValue value) {", "originalCommit": "c50af9c5873ca8383859cf38f5e0c57ccb557fba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex e2d9ea68b..79980d77a 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -167,7 +167,7 @@ final class SpanBuilderSdk implements Span.Builder {\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    if (isToRemove(value)) {\n+    if (isRemovedValue(value)) {\n       attributes.remove(key);\n     } else {\n       attributes.putAttribute(key, value);\n"}}, {"oid": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "message": "Rename method", "committedDate": "2020-03-20T06:52:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyOTI3OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395529279", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                boolean remove = true;\n          \n          \n            \n                if (value != null) {\n          \n          \n            \n                if (value == null) {\n          \n          \n            \n                  return true;\n          \n          \n            \n                }", "author": "Oberon00", "createdAt": "2020-03-20T09:47:41Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,14 +167,31 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    if (isRemovedValue(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n     }\n-    attributes.putAttribute(key, value);\n     return this;\n   }\n \n+  private static boolean isRemovedValue(AttributeValue value) {\n+    boolean remove = true;\n+    if (value != null) {", "originalCommit": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY5MzYyMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395693620", "bodyText": "I like this.", "author": "bogdandrutu", "createdAt": "2020-03-20T14:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyOTI3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 79980d77a..345cb3b7e 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -176,20 +176,18 @@ final class SpanBuilderSdk implements Span.Builder {\n   }\n \n   private static boolean isRemovedValue(AttributeValue value) {\n-    boolean remove = true;\n-    if (value != null) {\n-      switch (value.getType()) {\n-        case STRING:\n-          remove = value.getStringValue() == null;\n-          break;\n-        case BOOLEAN:\n-        case LONG:\n-        case DOUBLE:\n-          remove = false;\n-          break;\n-      }\n+    if (value == null) {\n+      return true;\n     }\n-    return remove;\n+    switch (value.getType()) {\n+      case STRING:\n+        return value.getStringValue() == null;\n+      case BOOLEAN:\n+      case LONG:\n+      case DOUBLE:\n+        return false;\n+    }\n+    return false;\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyOTU4OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395529588", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      remove = value.getStringValue() == null;\n          \n          \n            \n                      break;\n          \n          \n            \n                      return value.getStringValue() == null;", "author": "Oberon00", "createdAt": "2020-03-20T09:48:17Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,14 +167,31 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    if (isRemovedValue(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n     }\n-    attributes.putAttribute(key, value);\n     return this;\n   }\n \n+  private static boolean isRemovedValue(AttributeValue value) {\n+    boolean remove = true;\n+    if (value != null) {\n+      switch (value.getType()) {\n+        case STRING:\n+          remove = value.getStringValue() == null;\n+          break;", "originalCommit": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 79980d77a..345cb3b7e 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -176,20 +176,18 @@ final class SpanBuilderSdk implements Span.Builder {\n   }\n \n   private static boolean isRemovedValue(AttributeValue value) {\n-    boolean remove = true;\n-    if (value != null) {\n-      switch (value.getType()) {\n-        case STRING:\n-          remove = value.getStringValue() == null;\n-          break;\n-        case BOOLEAN:\n-        case LONG:\n-        case DOUBLE:\n-          remove = false;\n-          break;\n-      }\n+    if (value == null) {\n+      return true;\n     }\n-    return remove;\n+    switch (value.getType()) {\n+      case STRING:\n+        return value.getStringValue() == null;\n+      case BOOLEAN:\n+      case LONG:\n+      case DOUBLE:\n+        return false;\n+    }\n+    return false;\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyOTcwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395529703", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      remove = false;\n          \n          \n            \n                      break;\n          \n          \n            \n                      return false;", "author": "Oberon00", "createdAt": "2020-03-20T09:48:32Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,14 +167,31 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    if (isRemovedValue(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n     }\n-    attributes.putAttribute(key, value);\n     return this;\n   }\n \n+  private static boolean isRemovedValue(AttributeValue value) {\n+    boolean remove = true;\n+    if (value != null) {\n+      switch (value.getType()) {\n+        case STRING:\n+          remove = value.getStringValue() == null;\n+          break;\n+        case BOOLEAN:\n+        case LONG:\n+        case DOUBLE:\n+          remove = false;\n+          break;", "originalCommit": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 79980d77a..345cb3b7e 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -176,20 +176,18 @@ final class SpanBuilderSdk implements Span.Builder {\n   }\n \n   private static boolean isRemovedValue(AttributeValue value) {\n-    boolean remove = true;\n-    if (value != null) {\n-      switch (value.getType()) {\n-        case STRING:\n-          remove = value.getStringValue() == null;\n-          break;\n-        case BOOLEAN:\n-        case LONG:\n-        case DOUBLE:\n-          remove = false;\n-          break;\n-      }\n+    if (value == null) {\n+      return true;\n     }\n-    return remove;\n+    switch (value.getType()) {\n+      case STRING:\n+        return value.getStringValue() == null;\n+      case BOOLEAN:\n+      case LONG:\n+      case DOUBLE:\n+        return false;\n+    }\n+    return false;\n   }\n \n   @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTUyOTgwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1026#discussion_r395529805", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return remove;", "author": "Oberon00", "createdAt": "2020-03-20T09:48:41Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -169,14 +167,31 @@\n   @Override\n   public Span.Builder setAttribute(String key, AttributeValue value) {\n     Utils.checkNotNull(key, \"key\");\n-    Utils.checkNotNull(value, \"value\");\n-    if (value.getType() == Type.STRING && StringUtils.isNullOrEmpty(value.getStringValue())) {\n-      return this;\n+    if (isRemovedValue(value)) {\n+      attributes.remove(key);\n+    } else {\n+      attributes.putAttribute(key, value);\n     }\n-    attributes.putAttribute(key, value);\n     return this;\n   }\n \n+  private static boolean isRemovedValue(AttributeValue value) {\n+    boolean remove = true;\n+    if (value != null) {\n+      switch (value.getType()) {\n+        case STRING:\n+          remove = value.getStringValue() == null;\n+          break;\n+        case BOOLEAN:\n+        case LONG:\n+        case DOUBLE:\n+          remove = false;\n+          break;\n+      }\n+    }\n+    return remove;", "originalCommit": "efb9ea78a8e9aae308e0e221595ce251a05d3fd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\nindex 79980d77a..345cb3b7e 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java\n\n@@ -176,20 +176,18 @@ final class SpanBuilderSdk implements Span.Builder {\n   }\n \n   private static boolean isRemovedValue(AttributeValue value) {\n-    boolean remove = true;\n-    if (value != null) {\n-      switch (value.getType()) {\n-        case STRING:\n-          remove = value.getStringValue() == null;\n-          break;\n-        case BOOLEAN:\n-        case LONG:\n-        case DOUBLE:\n-          remove = false;\n-          break;\n-      }\n+    if (value == null) {\n+      return true;\n     }\n-    return remove;\n+    switch (value.getType()) {\n+      case STRING:\n+        return value.getStringValue() == null;\n+      case BOOLEAN:\n+      case LONG:\n+      case DOUBLE:\n+        return false;\n+    }\n+    return false;\n   }\n \n   @Override\n"}}, {"oid": "5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5ed0b0adbdb78cd9690c51f5590f35f4a0b82c83", "message": "Use return", "committedDate": "2020-03-20T15:08:48Z", "type": "commit"}]}