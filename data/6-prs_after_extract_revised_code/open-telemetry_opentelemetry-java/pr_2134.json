{"pr_number": 2134, "pr_title": "Convert Attributes to an interface", "pr_createdAt": "2020-11-25T16:05:45Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyODY3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r530728670", "bodyText": "This class is public - can you move it to a top level package private class?", "author": "anuraaga", "createdAt": "2020-11-26T01:51:20Z", "path": "api/src/main/java/io/opentelemetry/api/common/Attributes.java", "diffHunk": "@@ -20,16 +23,25 @@\n  * <p>Null keys will be silently dropped.\n  *\n  * <p>Note: The behavior of null-valued attributes is undefined, and hence strongly discouraged.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n+ *\n+ * <p>For this reason, it is strongly suggested that you use the implementation that is provided\n+ * here via the factory methods and the {@link AttributesBuilder}.\n  */\n @SuppressWarnings(\"rawtypes\")\n @Immutable\n-public abstract class Attributes extends ImmutableKeyValuePairs<AttributeKey, Object>\n-    implements ReadableAttributes {\n-  private static final Attributes EMPTY = Attributes.builder().build();\n+public interface Attributes extends ReadableAttributes {\n \n   @AutoValue\n   @Immutable\n-  abstract static class ArrayBackedAttributes extends Attributes {\n+  abstract class ArrayBackedAttributes extends ImmutableKeyValuePairs<AttributeKey, Object>", "originalCommit": "f3dfa203f76d4194d9e6ff80c1366163c14670f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczNDExMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r530734111", "bodyText": "ooh. good point. yes, will do so.", "author": "jkwatson", "createdAt": "2020-11-26T02:11:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyODY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyNTMzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r533625336", "bodyText": "done", "author": "jkwatson", "createdAt": "2020-12-01T18:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyODY3MA=="}], "type": "inlineReview", "revised_code": {"commit": "f19b5a5024cac8400f93955b4fd472b61113eb2b", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/common/Attributes.java b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\nindex b8a3b3f03..5253c7954 100644\n--- a/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n+++ b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n\n@@ -29,7 +28,7 @@ import javax.annotation.concurrent.Immutable;\n  * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n  *\n  * <p>For this reason, it is strongly suggested that you use the implementation that is provided\n- * here via the factory methods and the {@link AttributesBuilder}.\n+ * here via the factory methods and the {@link ArrayBackedAttributesBuilder}.\n  */\n @SuppressWarnings(\"rawtypes\")\n @Immutable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczNjkwOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r530736908", "bodyText": "By the way - must they be immutable? Actually one of the, completely unsupported but wild, use cases that came up for me for this interface is mutable attributes in resource. Docker cgroups come to mind, but I wouldn't be surprised if there are some good use cases for process-related information that is updatable at runtime.", "author": "anuraaga", "createdAt": "2020-11-26T02:22:17Z", "path": "api/src/main/java/io/opentelemetry/api/common/Attributes.java", "diffHunk": "@@ -20,16 +23,25 @@\n  * <p>Null keys will be silently dropped.\n  *\n  * <p>Note: The behavior of null-valued attributes is undefined, and hence strongly discouraged.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based", "originalCommit": "f3dfa203f76d4194d9e6ff80c1366163c14670f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc0NzkxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r530747916", "bodyText": "I'd much rather start by strongly suggesting immutability, then maybe relax it if we find it's ok for them to be mutable.", "author": "jkwatson", "createdAt": "2020-11-26T03:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDczNjkwOA=="}], "type": "inlineReview", "revised_code": {"commit": "f19b5a5024cac8400f93955b4fd472b61113eb2b", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/common/Attributes.java b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\nindex b8a3b3f03..5253c7954 100644\n--- a/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n+++ b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n\n@@ -29,7 +28,7 @@ import javax.annotation.concurrent.Immutable;\n  * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n  *\n  * <p>For this reason, it is strongly suggested that you use the implementation that is provided\n- * here via the factory methods and the {@link AttributesBuilder}.\n+ * here via the factory methods and the {@link ArrayBackedAttributesBuilder}.\n  */\n @SuppressWarnings(\"rawtypes\")\n @Immutable\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc1ODU0Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r530758547", "bodyText": "in order for the javaagent to provide a single implementation that satisfies both the shaded and unshaded interfaces, we need the return value here to be an interface, so that its implementation use a covariant return type that satisfies both, similar to the TraceState.getTraceState() example in #1946 (comment)", "author": "trask", "createdAt": "2020-11-26T03:50:54Z", "path": "api/src/main/java/io/opentelemetry/api/common/Attributes.java", "diffHunk": "@@ -39,47 +51,65 @@\n     public AttributesBuilder toBuilder() {", "originalCommit": "f3dfa203f76d4194d9e6ff80c1366163c14670f7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyNzY4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2134#discussion_r532827686", "bodyText": "done. please take a look", "author": "jkwatson", "createdAt": "2020-11-30T18:59:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDc1ODU0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f19b5a5024cac8400f93955b4fd472b61113eb2b", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/common/Attributes.java b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\nindex b8a3b3f03..5253c7954 100644\n--- a/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n+++ b/api/src/main/java/io/opentelemetry/api/common/Attributes.java\n\n@@ -49,7 +48,7 @@ public interface Attributes extends ReadableAttributes {\n \n     @Override\n     public AttributesBuilder toBuilder() {\n-      return new AttributesBuilder(new ArrayList<>(data()));\n+      return new ArrayBackedAttributesBuilder(new ArrayList<>(data()));\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"oid": "f19b5a5024cac8400f93955b4fd472b61113eb2b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/f19b5a5024cac8400f93955b4fd472b61113eb2b", "message": "Convert the AttributesBuilder into an interface.", "committedDate": "2020-11-30T18:58:49Z", "type": "forcePushed"}, {"oid": "0756bd7c777f2a86f853dfac3db813de10b4137c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0756bd7c777f2a86f853dfac3db813de10b4137c", "message": "Convert Attributes to an interface", "committedDate": "2020-12-01T16:59:10Z", "type": "commit"}, {"oid": "625bcc9282d9f4ff1ae7165748e0d1091695f7dd", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/625bcc9282d9f4ff1ae7165748e0d1091695f7dd", "message": "Add javadoc explaining Attributes implementation requirements.", "committedDate": "2020-12-01T16:59:13Z", "type": "commit"}, {"oid": "40ca7494a257e91b7e656ee76de625c3cd237de5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/40ca7494a257e91b7e656ee76de625c3cd237de5", "message": "Convert the AttributesBuilder into an interface.", "committedDate": "2020-12-01T16:59:13Z", "type": "commit"}, {"oid": "bf41f0923042fd024d32662e96697d424f5f0fd5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/bf41f0923042fd024d32662e96697d424f5f0fd5", "message": "update from upstream changes", "committedDate": "2020-12-01T17:12:22Z", "type": "commit"}, {"oid": "bf41f0923042fd024d32662e96697d424f5f0fd5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/bf41f0923042fd024d32662e96697d424f5f0fd5", "message": "update from upstream changes", "committedDate": "2020-12-01T17:12:22Z", "type": "forcePushed"}, {"oid": "8e44b96930ecc623b855aadac24d2149763dc688", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e44b96930ecc623b855aadac24d2149763dc688", "message": "move the implementation class out of the interface", "committedDate": "2020-12-01T18:11:06Z", "type": "commit"}, {"oid": "323b45730300807063fd6cd3afe97eca15f5a497", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/323b45730300807063fd6cd3afe97eca15f5a497", "message": "clean up some javadoc that referenced non-public classes", "committedDate": "2020-12-01T18:31:28Z", "type": "commit"}]}