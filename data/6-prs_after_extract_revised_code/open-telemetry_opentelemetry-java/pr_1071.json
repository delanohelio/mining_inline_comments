{"pr_number": 1071, "pr_title": "use a reentrant lock as the mutex for initializing/reading the global instance", "pr_createdAt": "2020-04-02T22:18:04Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071", "timeline": [{"oid": "1f312976af78bb5cbc541bf7844bac52496930fc", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1f312976af78bb5cbc541bf7844bac52496930fc", "message": "use a reentrant lock as the mutex for initializing/reading the global instance.", "committedDate": "2020-04-02T22:16:47Z", "type": "commit"}, {"oid": "2046715cc04ad177fd529849db87eadf4ca0531c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/2046715cc04ad177fd529849db87eadf4ca0531c", "message": "fix the guarded-by name", "committedDate": "2020-04-02T22:31:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDQyNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071#discussion_r403054424", "bodyText": "Any reason to remove the 'pre-check' without the lock?", "author": "carlosalberto", "createdAt": "2020-04-03T14:41:25Z", "path": "api/src/main/java/io/opentelemetry/OpenTelemetry.java", "diffHunk": "@@ -128,14 +133,16 @@ public static void setPropagators(ContextPropagators propagators) {\n \n   /** Lazy loads an instance. */\n   private static OpenTelemetry getInstance() {\n-    if (instance == null) {\n-      synchronized (OpenTelemetry.class) {\n-        if (instance == null) {\n-          instance = new OpenTelemetry();\n-        }\n+    mutex.lock();", "originalCommit": "2046715cc04ad177fd529849db87eadf4ca0531c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA2MzY4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071#discussion_r403063681", "bodyText": "unfortunately, errorprone will complain if you try to do this. I guess I could remove the @GuardedBy on the field?", "author": "jkwatson", "createdAt": "2020-04-03T14:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA4MTg3MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071#discussion_r403081870", "bodyText": "Another argument for the plain Object for locking I guess.", "author": "Oberon00", "createdAt": "2020-04-03T15:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwOTIwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071#discussion_r403109209", "bodyText": "errorprone will do the same complaining in that case as well.", "author": "jkwatson", "createdAt": "2020-04-03T16:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDQyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExNzQ2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1071#discussion_r403117465", "bodyText": "Ah, I see it does not understand double-checked locking!", "author": "Oberon00", "createdAt": "2020-04-03T16:14:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA1NDQyNA=="}], "type": "inlineReview", "revised_code": {"commit": "8e3ba55d679af3b48446189786c1bfa407b08b01", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/OpenTelemetry.java b/api/src/main/java/io/opentelemetry/OpenTelemetry.java\nindex b07619386..3cd04cace 100644\n--- a/api/src/main/java/io/opentelemetry/OpenTelemetry.java\n+++ b/api/src/main/java/io/opentelemetry/OpenTelemetry.java\n\n@@ -133,16 +129,14 @@ public final class OpenTelemetry {\n \n   /** Lazy loads an instance. */\n   private static OpenTelemetry getInstance() {\n-    mutex.lock();\n-    try {\n-      if (instance != null) {\n-        return instance;\n+    if (instance == null) {\n+      synchronized (mutex) {\n+        if (instance == null) {\n+          instance = new OpenTelemetry();\n+        }\n       }\n-      instance = new OpenTelemetry();\n-      return instance;\n-    } finally {\n-      mutex.unlock();\n     }\n+    return instance;\n   }\n \n   private OpenTelemetry() {\n"}}, {"oid": "8e3ba55d679af3b48446189786c1bfa407b08b01", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e3ba55d679af3b48446189786c1bfa407b08b01", "message": "switch back to a simple synchronized double-checked lock", "committedDate": "2020-04-03T19:49:38Z", "type": "commit"}]}