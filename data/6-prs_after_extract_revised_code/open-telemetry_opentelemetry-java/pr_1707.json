{"pr_number": 1707, "pr_title": "Change the Sampler interface to allow a SamplingResult to update the TraceState", "pr_createdAt": "2020-09-25T21:57:52Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495426757", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Note: if a null is returned, the TraceState will be reset to {@link\n          \n          \n            \n                 * <p>Note: if {@code null} is returned, the TraceState will be reset to {@link\n          \n      \n    \n    \n  \n\nOr I might remove this, this is not a nullable method so we don't want to indicate null is allowed. We just happen to have a default to prevent crashing in case that happens.", "author": "anuraaga", "createdAt": "2020-09-26T07:22:47Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -88,5 +89,14 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n+     * the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * <p>Note: if a null is returned, the TraceState will be reset to {@link", "originalCommit": "f23245425e088292de52b8e05773359bcf9080bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTA1OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495575058", "bodyText": "Indeed, should we require non-null return value?", "author": "iNikem", "createdAt": "2020-09-27T13:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNjM3MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495606371", "bodyText": "The spec explicitly specifies the behavior for the null return, but I wouldn't have a problem making this non-nullable. It's easy enough for samplers to explicitly return TraceState.getInvalid() if that's what they want.", "author": "jkwatson", "createdAt": "2020-09-27T19:26:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyMTIzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496021236", "bodyText": "Sorry..my comment above is wrong. I mis-read \"empty\" as \"null\" in the spec.", "author": "jkwatson", "createdAt": "2020-09-28T15:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "33ac2b472b0d5f966af47ccd6ada2c66d073f366", "chunk": "diff --git a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\nindex a594d9199..1ca58843e 100644\n--- a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\n+++ b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\n\n@@ -91,12 +81,12 @@ public interface Sampler {\n     Attributes getAttributes();\n \n     /**\n-     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n-     * the same {@link TraceState} that was provided originally, or an updated one.\n-     *\n-     * <p>Note: if a null is returned, the TraceState will be reset to {@link\n-     * TraceState#getDefault()}.\n+     * Return a function that may update the incoming parent {@link TraceState}. This may return the\n+     * same {@link TraceState} that was provided originally, or an updated one.\n      */\n-    TraceState getTraceState();\n+    @SuppressWarnings(\"NoFunctionalReturnType\")\n+    default Function<TraceState, TraceState> traceStateUpdate() {\n+      return Function.identity();\n+    }\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495445567", "bodyText": "If we use null (or some static final instance of TraceState) to indicate \"use parent tracestate\", we could keep the constant objects, conserving allocations.", "author": "Oberon00", "createdAt": "2020-09-26T11:04:40Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "originalCommit": "f23245425e088292de52b8e05773359bcf9080bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNjQzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495606433", "bodyText": "yeah, but the spec describes the behavior for null, which is to invalidate the tracestate. :(", "author": "jkwatson", "createdAt": "2020-09-27T19:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNzU2Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495607566", "bodyText": "OK, that was unintentional. But still, we could do private static final TraceState USE_PARENT = TraceState.builder.build()  and then check if the object identity of the contained tracestate == USE_PARENT.", "author": "Oberon00", "createdAt": "2020-09-27T19:38:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyOTU2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495729560", "bodyText": "I think the spec doesn't say anything about a null tracestate here, only an empty one: https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/sdk.md#shouldsample\n\n\nA Tracestate that will be associated with the Span through the new\nSpanContext.\nNote: If the sampler returns an empty Tracestate here, the Tracestate will be cleared,\nso samplers should normally return the passed-in Tracestate if they do not intend\nto change it.", "author": "Oberon00", "createdAt": "2020-09-28T07:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxOTUyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496019521", "bodyText": "You're right. I read that wrong. But, I don't think using null as a signal to use the parent is a great API. I'd rather have an explicit way for Samplers to signal that, rather than an implicit null.", "author": "jkwatson", "createdAt": "2020-09-28T15:08:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1MTAyMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496051022", "bodyText": "Agreed, null isn't a great API here. So maybe the sentinel object instance I mentioned above?", "author": "Oberon00", "createdAt": "2020-09-28T15:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTgxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496111816", "bodyText": "I'm not sure yet. My main concern is making sure that Sampler authors have a clear obvious way to do it. At the moment, the Sampler interface forces everyone to think about whether to modify the TraceState or not, and I think the most common use-case will be to not modify the TraceState, but just use the existing parent's.\n@Oberon00 do you think it's worth opening up a spec issue to make it easier to do the \"right thing\" in our SDK, or do you think the current spec is flexible enough to allow default-behavior to be implemented (using a sentinel value, or explicit boolean attribute)?", "author": "jkwatson", "createdAt": "2020-09-28T17:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTY5OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496161699", "bodyText": "I no one will complain that you violate the current spec if you make \"use parent\" the default somehow, but an editorial spec change / recommendation would make sense I think.", "author": "Oberon00", "createdAt": "2020-09-28T18:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODE1Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496188156", "bodyText": "I decided to start with an issue:  open-telemetry/opentelemetry-specification#1031", "author": "jkwatson", "createdAt": "2020-09-28T19:39:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "33ac2b472b0d5f966af47ccd6ada2c66d073f366", "chunk": "diff --git a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java\nindex aa35c3e34..87e88f19c 100644\n--- a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java\n+++ b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java\n\n@@ -92,20 +84,19 @@ public final class Samplers {\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n-   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n+  public static SamplingResult emptySamplingResult(Decision decision) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);\n+        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n       case RECORD_ONLY:\n-        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_ONLY, traceState);\n+        return EMPTY_RECORDED_SAMPLING_RESULT;\n       case DROP:\n-        return SamplingResultImpl.createWithoutAttributes(Decision.DROP, traceState);\n+        return EMPTY_NOT_SAMPLED_OR_RECORDED_SAMPLING_RESULT;\n     }\n     throw new AssertionError(\"unrecognised samplingResult\");\n   }\n"}}, {"oid": "33ac2b472b0d5f966af47ccd6ada2c66d073f366", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/33ac2b472b0d5f966af47ccd6ada2c66d073f366", "message": "Change the SamplingResult API to allow a Function that will update the TraceState.", "committedDate": "2020-10-09T16:48:24Z", "type": "forcePushed"}, {"oid": "4524a201f37fc575d84076e0342f335cad97f5ed", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4524a201f37fc575d84076e0342f335cad97f5ed", "message": "Change the Sampler interface to have the SamplingResult contain the TraceState to use.", "committedDate": "2020-10-12T16:59:51Z", "type": "commit"}, {"oid": "bf8747fe45a4d0f41ef4db36bc2692e48f5f446a", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/bf8747fe45a4d0f41ef4db36bc2692e48f5f446a", "message": "revert errant change from another PR", "committedDate": "2020-10-12T16:59:51Z", "type": "commit"}, {"oid": "ad4c85a0802f8cdd9bc4d5de147242c37d74d062", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/ad4c85a0802f8cdd9bc4d5de147242c37d74d062", "message": "Change the SamplingResult API to allow a Function that will update the TraceState.", "committedDate": "2020-10-12T16:59:51Z", "type": "commit"}, {"oid": "ba3b61f8fceedc8d1d0d9ce35a0279cc7644ce99", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/ba3b61f8fceedc8d1d0d9ce35a0279cc7644ce99", "message": "revert an odd change from a rebase", "committedDate": "2020-10-12T16:59:51Z", "type": "commit"}, {"oid": "55224f011bae0f37cdd106f3864ad2a525239fb5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/55224f011bae0f37cdd106f3864ad2a525239fb5", "message": "Change the SamplingResult to not have a functional response a concrete one.", "committedDate": "2020-10-12T17:07:15Z", "type": "commit"}, {"oid": "55224f011bae0f37cdd106f3864ad2a525239fb5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/55224f011bae0f37cdd106f3864ad2a525239fb5", "message": "Change the SamplingResult to not have a functional response a concrete one.", "committedDate": "2020-10-12T17:07:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyODcwMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503428703", "bodyText": "We could document here that this will always be the same instance as the one passed to ShouldSample before.", "author": "Oberon00", "createdAt": "2020-10-12T17:12:02Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,16 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from any parent span. Might be an empty TraceState, if", "originalCommit": "55224f011bae0f37cdd106f3864ad2a525239fb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDczOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503570738", "bodyText": "good idea. done!", "author": "jkwatson", "createdAt": "2020-10-12T22:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyODcwMw=="}], "type": "inlineReview", "revised_code": {"commit": "28a37ea61b00be48a2baa7cb2978ab93deb57c61", "chunk": "diff --git a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\nindex 4029a151b..c657e2bd7 100644\n--- a/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\n+++ b/sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java\n\n@@ -84,8 +84,10 @@ public interface Sampler {\n      * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n      * return the same {@link TraceState} that was provided originally, or an updated one.\n      *\n-     * @param parentTraceState The TraceState from any parent span. Might be an empty TraceState, if\n-     *     there is no parent.\n+     * @param parentTraceState The TraceState from the parent span. Might be an empty TraceState, if\n+     *     there is no parent. This will be the same TraceState that was passed in via the {@link\n+     *     SpanContext} parameter on the {@link #shouldSample(SpanContext, String, String, Kind,\n+     *     ReadableAttributes, List)} call.\n      */\n     default TraceState getUpdatedTraceState(TraceState parentTraceState) {\n       return parentTraceState;\n"}}, {"oid": "28a37ea61b00be48a2baa7cb2978ab93deb57c61", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/28a37ea61b00be48a2baa7cb2978ab93deb57c61", "message": "Add an additional bit of javadoc to the new method.", "committedDate": "2020-10-12T22:45:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503651519", "bodyText": "Thanks sorry for missing the allocation issue, got it. TBH this API still feels weird to me - having to call the sampler, and then the caller has to correctly call this method to get the trace state.\nI'm reading the discussion here\n#1707 (comment)\nand I'm personally not sure this functional style is that much better than null indicating a non-update, in a caller\nspan.traceState = result.getUpdatedTraceState() != null ? result.getUpdatedTraceState() : parentTraceState;\n\nseems more direct? It's true that there's no updated trace state, so use the non-updated one.\nOtherwise, another approach that is similar to this one but seems a bit nicer is having this sort of method on the Sampler, accepting the decision with the parent trace state. \"update trace state\" is a business logic operation, it's nice if that lives in the Sampler which has the logic, a result feels like it should be mostly constant.\nFinally, maybe we can just live with an extra allocation if it seems like a normal getTraceState() seems like a more intuitive API. Sampling result is very short lived, it may even be optimized away who knows.\nFood for thought, I don't really have a strong preference for any, but a small preference for eating the allocation.", "author": "anuraaga", "createdAt": "2020-10-13T03:51:36Z", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,18 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from the parent span. Might be an empty TraceState, if\n+     *     there is no parent. This will be the same TraceState that was passed in via the {@link\n+     *     SpanContext} parameter on the {@link #shouldSample(SpanContext, String, String, Kind,\n+     *     ReadableAttributes, List)} call.\n+     */\n+    default TraceState getUpdatedTraceState(TraceState parentTraceState) {", "originalCommit": "28a37ea61b00be48a2baa7cb2978ab93deb57c61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2NzUxMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503667511", "bodyText": "The other reason to avoid \"eating the allocation\" is that we really want to make it super easy for \"normal\" samplers to do the right thing (that is, not modify the TraceState). I really dislike using \"null\" as a meaningful business result, but if y'all prefer that as the API, then I can get on board. What if we had it return Optional<TraceState> so the \"normal\" samplers can just have a constant Optional.empty()?", "author": "jkwatson", "createdAt": "2020-10-13T04:59:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4MDUwOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503680509", "bodyText": "@anuraaga and I discussed offline and decided to stick with what we have right now; if someone actually uses this API and doesn't like how it works, we can definitely change it, since it's SDK-only functionality, and we can be a little more loose with making changes.", "author": "jkwatson", "createdAt": "2020-10-13T05:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ=="}], "type": "inlineReview", "revised_code": null}]}