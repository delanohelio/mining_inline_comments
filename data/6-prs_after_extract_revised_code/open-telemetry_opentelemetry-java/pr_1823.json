{"pr_number": 1823, "pr_title": "Fix using default context storage implemenation in LazyStorage", "pr_createdAt": "2020-10-17T16:42:54Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823", "timeline": [{"oid": "a93b791c633f5c3edd7c69c7e4a21d0be3587bd5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a93b791c633f5c3edd7c69c7e4a21d0be3587bd5", "message": "Fix using default context storage implemenation in LazyStorage", "committedDate": "2020-10-17T16:41:41Z", "type": "commit"}, {"oid": "71a80d94f56b77845994d8217c19aa7742d70d5d", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/71a80d94f56b77845994d8217c19aa7742d70d5d", "message": "Use the single implementation if providerClassName property is unset", "committedDate": "2020-10-18T04:12:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMjAzOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823#discussion_r507432039", "bodyText": "@dengliming Sorry if my suggestions weren't clear, thanks for bearing with me. We have these success cases\n\n1 provider, providerClassName empty - returns the 1 provider\n1 provider, providerClassName matches the provider - returns the 1 provider <- currently missing\nmultiple providers, providerClassName matches one of them - returns the provider that matches\n\nOtherwise log an error message and return default storage\nHope this makes it clear", "author": "anuraaga", "createdAt": "2020-10-19T04:09:03Z", "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -48,17 +48,11 @@ private static ContextStorage createStorage(AtomicReference<Throwable> deferredS\n       return DefaultContext.threadLocalStorage();\n     }\n \n-    if (providers.size() == 1) {\n-      ContextStorageProvider provider = providers.get(0);\n-      try {\n-        return provider.get();\n-      } catch (Throwable t) {\n-        deferredStorageFailure.set(t);\n-        return DefaultContext.threadLocalStorage();\n+    if (providerClassName.isEmpty()) {", "originalCommit": "71a80d94f56b77845994d8217c19aa7742d70d5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ1OTEyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823#discussion_r507459121", "bodyText": "yeah. a little confused. Can you also add the right return for each case\uff1f\n\n1 provider, providerClassName matches the provider <- currently missing\n\ndon't know what is missing. The following code should cover this case. is that correct?\nfor (ContextStorageProvider provider : providers) {\n      if (provider.getClass().getName().equals(providerClassName)) {\n        return provider.get();\n      }\n    }", "author": "dengliming", "createdAt": "2020-10-19T04:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMjAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQ4MDc4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823#discussion_r507480781", "bodyText": "Sure updated my comment, in every other case we log and return default storage.\nYeah starting with that, and than one more branch for if there's a single provider and empty providerClassName seems fine to me.", "author": "anuraaga", "createdAt": "2020-10-19T05:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMjAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5NTg3NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823#discussion_r507595874", "bodyText": "I think the current changes can satisfy all the cases. Just need log in some case. WDYT?", "author": "dengliming", "createdAt": "2020-10-19T09:17:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMjAzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5ODEzNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1823#discussion_r507598134", "bodyText": "Sorry got it! Yeah seems good, really needed to expand the diff", "author": "anuraaga", "createdAt": "2020-10-19T09:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzQzMjAzOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7b28707434870d20d205267db038643896c7330e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7b28707434870d20d205267db038643896c7330e", "message": "Add unit tests for LazyStorage", "committedDate": "2020-10-19T15:36:17Z", "type": "commit"}]}