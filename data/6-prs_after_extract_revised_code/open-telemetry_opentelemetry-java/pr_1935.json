{"pr_number": 1935, "pr_title": "Split SpanContext into interface / impl", "pr_createdAt": "2020-10-30T05:33:23Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935", "timeline": [{"oid": "8cab661e5681afb3117a72864ae3733b27a1bc77", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8cab661e5681afb3117a72864ae3733b27a1bc77", "message": "Split SpanContext into interface / impl", "committedDate": "2020-10-30T05:32:42Z", "type": "commit"}, {"oid": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "message": "Remove javadoc from impl to reduce drift change.", "committedDate": "2020-10-30T05:34:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMTE4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r514931182", "bodyText": "Since the interface is also annotated @Immutable  and according to the spec any SpanContext must be Immutable, this is maybe not the best name to distinguish it from possible other implementations which would also be Immutable. Maybe DefaultSpanContext?", "author": "Oberon00", "createdAt": "2020-10-30T08:14:17Z", "path": "api/src/main/java/io/opentelemetry/api/trace/ImmutableSpanContext.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.api.trace;\n+\n+import com.google.auto.value.AutoValue;\n+import com.google.auto.value.extension.memoized.Memoized;\n+import javax.annotation.concurrent.Immutable;\n+\n+@Immutable\n+@AutoValue\n+abstract class ImmutableSpanContext implements SpanContext {", "originalCommit": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzOTgxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r514939818", "bodyText": "Yeah I had the same impression - we have Immutable* as a pattern in many AutoValue implementations of interfaces currently. Renaming them all to Default seems fine to me, or even *Impl so the implementation orders next to the interface in the filetree.", "author": "anuraaga", "createdAt": "2020-10-30T08:32:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIxNjg5MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515216890", "bodyText": "No strong opinion. I'd keep this name for this PR, and we can always rename later, since this is an internal detail.", "author": "jkwatson", "createdAt": "2020-10-30T16:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMTE4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODgwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515238805", "bodyText": "Does this still make sense on an interface?", "author": "tylerbenson", "createdAt": "2020-10-30T16:54:14Z", "path": "api/src/main/java/io/opentelemetry/api/trace/SpanContext.java", "diffHunk": "@@ -17,23 +15,15 @@\n  * traceState} and the {@link boolean remote} flag.\n  */\n @Immutable", "originalCommit": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI0MzExOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515243119", "bodyText": "I think it does. It places an requirement on all implementers and offers guarantees to users.", "author": "Oberon00", "createdAt": "2020-10-30T17:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODgwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3MTI3Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515271277", "bodyText": "Obviously, it's a soft requirement, since it can't be enforced, but I still think it's a good thing to document.", "author": "jkwatson", "createdAt": "2020-10-30T17:39:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzODgwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3109e68c99b9bf426d439806af0cc2dc3197ebea", "chunk": "diff --git a/api/src/main/java/io/opentelemetry/api/trace/SpanContext.java b/api/src/main/java/io/opentelemetry/api/trace/SpanContext.java\nindex b99bb1620..a36d6bb06 100644\n--- a/api/src/main/java/io/opentelemetry/api/trace/SpanContext.java\n+++ b/api/src/main/java/io/opentelemetry/api/trace/SpanContext.java\n\n@@ -13,6 +13,10 @@ import javax.annotation.concurrent.Immutable;\n  * trace_id} and {@link SpanId span_id}) associated with the {@link Span} and a set of options\n  * (currently only whether the context is sampled or not), as well as the {@link TraceState\n  * traceState} and the {@link boolean remote} flag.\n+ *\n+ * <p>Implementations of this interface *must* be immutable and have well-defined value-based\n+ * equals/hashCode implementations. If an implementation does not strictly conform to these\n+ * requirements, behavior of the OpenTelemetry APIs and default SDK cannot be guaranteed.\n  */\n @Immutable\n public interface SpanContext {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwODY5MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515508690", "bodyText": "Not sure why this class is needed, if you just move the \"@autovalue\" annotation on the SpanContext you achieve the same thing, and just call directly the ctor of the AutoValue, am I missing something?", "author": "bogdandrutu", "createdAt": "2020-10-31T15:35:26Z", "path": "api/src/main/java/io/opentelemetry/api/trace/ImmutableSpanContext.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.api.trace;\n+\n+import com.google.auto.value.AutoValue;\n+import com.google.auto.value.extension.memoized.Memoized;\n+import javax.annotation.concurrent.Immutable;\n+\n+@Immutable\n+@AutoValue\n+abstract class ImmutableSpanContext implements SpanContext {", "originalCommit": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTU4Nzc4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r515587789", "bodyText": "As far as I know, AutoValue doesn't support interfaces still.", "author": "anuraaga", "createdAt": "2020-11-01T07:37:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwODY5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5MTA1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r530491057", "bodyText": "this will become more expensive after this change, we should calculate this only once since it is used couple of times per instance created.", "author": "bogdandrutu", "createdAt": "2020-11-25T16:14:16Z", "path": "api/src/main/java/io/opentelemetry/api/trace/SpanContext.java", "diffHunk": "@@ -128,22 +104,21 @@ public void copyTraceFlagsHexTo(char[] dest, int destOffset) {\n    *\n    * @return the {@code TraceState} associated with this {@code SpanContext}.\n    */\n-  public abstract TraceState getTraceState();\n+  TraceState getTraceState();\n \n   /**\n    * Returns {@code true} if this {@code SpanContext} is valid.\n    *\n    * @return {@code true} if this {@code SpanContext} is valid.\n    */\n-  @Memoized\n-  public boolean isValid() {\n-    return TraceId.isValid(getTraceIdHex()) && SpanId.isValid(getSpanIdHex());\n+  default boolean isValid() {\n+    return TraceId.isValid(getTraceIdAsHexString()) && SpanId.isValid(getSpanIdAsHexString());\n   }", "originalCommit": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYwMDI3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r530600276", "bodyText": "Also, see above...this is still memoized by the implementation.", "author": "jkwatson", "createdAt": "2020-11-25T19:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5MTA1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5MjA5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r530492096", "bodyText": "Why removing the ability to memoized this call? It may get expensive. I would suggest to not default this and any method that was memoized before.", "author": "bogdandrutu", "createdAt": "2020-11-25T16:15:42Z", "path": "api/src/main/java/io/opentelemetry/api/trace/SpanContext.java", "diffHunk": "@@ -66,60 +51,51 @@ private static SpanContext create(\n    * @param traceState the trace state for the span context.\n    * @return a new {@code SpanContext} with the given identifiers and options.\n    */\n-  public static SpanContext createFromRemoteParent(\n+  static SpanContext createFromRemoteParent(\n       String traceIdHex, String spanIdHex, byte traceFlags, TraceState traceState) {\n-    return create(traceIdHex, spanIdHex, traceFlags, traceState, /* remote=*/ true);\n+    return ImmutableSpanContext.create(\n+        traceIdHex, spanIdHex, traceFlags, traceState, /* remote=*/ true);\n   }\n \n-  abstract String getTraceIdHex();\n-\n-  abstract String getSpanIdHex();\n-\n   /**\n    * Returns the trace identifier associated with this {@code SpanContext}.\n    *\n    * @return the trace identifier associated with this {@code SpanContext}.\n    */\n-  public String getTraceIdAsHexString() {\n-    return getTraceIdHex();\n-  }\n+  String getTraceIdAsHexString();\n \n   /**\n    * Returns the byte[] representation of the trace identifier associated with this {@link\n    * SpanContext}.\n    */\n-  @Memoized\n-  public byte[] getTraceIdBytes() {\n-    return TraceId.bytesFromHex(getTraceIdHex(), 0);\n+  default byte[] getTraceIdBytes() {\n+    return TraceId.bytesFromHex(getTraceIdAsHexString(), 0);\n   }\n \n   /**\n    * Returns the span identifier associated with this {@code SpanContext}.\n    *\n    * @return the span identifier associated with this {@code SpanContext}.\n    */\n-  public String getSpanIdAsHexString() {\n-    return getSpanIdHex();\n-  }\n+  String getSpanIdAsHexString();\n \n   /**\n    * Returns the byte[] representation of the span identifier associated with this {@link\n    * SpanContext}.\n    */\n-  @Memoized\n-  public byte[] getSpanIdBytes() {\n-    return SpanId.bytesFromHex(getSpanIdHex(), 0);\n+  default byte[] getSpanIdBytes() {\n+    return SpanId.bytesFromHex(getSpanIdAsHexString(), 0);\n   }", "originalCommit": "8c2b64317feacd0d4c27d4f0c1701e5d5ba2fe81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDU5OTkzNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1935#discussion_r530599936", "bodyText": "This is still memoized by the autovalue implementation. See ImmutableSpanContext above.", "author": "jkwatson", "createdAt": "2020-11-25T19:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5MjA5Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "40b884bd2f98813ed77660306958e89b3d13f418", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/40b884bd2f98813ed77660306958e89b3d13f418", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into spancontext-interface", "committedDate": "2020-12-01T08:55:35Z", "type": "commit"}, {"oid": "3109e68c99b9bf426d439806af0cc2dc3197ebea", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3109e68c99b9bf426d439806af0cc2dc3197ebea", "message": "Add warning", "committedDate": "2020-12-01T08:56:48Z", "type": "commit"}, {"oid": "09df67d11a16326edc160519232804695c3b4872", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/09df67d11a16326edc160519232804695c3b4872", "message": "More", "committedDate": "2020-12-01T08:57:31Z", "type": "commit"}]}