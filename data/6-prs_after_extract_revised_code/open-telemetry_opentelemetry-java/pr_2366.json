{"pr_number": 2366, "pr_title": "Create a MANDATORY Resource instance containing mandatory attributes. Merge that into the default resource.", "pr_createdAt": "2020-12-18T22:22:13Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NjE0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546186148", "bodyText": "Think it's good if at least one of the tests has another attribute in it.", "author": "anuraaga", "createdAt": "2020-12-19T03:52:47Z", "path": "sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/spi/SdkMeterProviderFactoryTest.java", "diffHunk": "@@ -17,4 +20,26 @@\n   void testDefault() {\n     assertThat(GlobalMetricsProvider.get()).isInstanceOf(SdkMeterProvider.class);\n   }\n+\n+  @Test\n+  void builder_fallbackServiceName() {\n+    Resource resourceWithFallbacks =\n+        Resource.create(Attributes.of(ResourceAttributes.SERVICE_NAME, \"unknown_service:java\"));", "originalCommit": "18d6c9dbae073d9f1b114a5c7468663b102a8f10", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4e9eb103033ad22cf6c5a86df032c8293df33aee", "chunk": "diff --git a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/spi/SdkMeterProviderFactoryTest.java b/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/spi/SdkMeterProviderFactoryTest.java\ndeleted file mode 100644\nindex 8b9226968..000000000\n--- a/sdk/metrics/src/test/java/io/opentelemetry/sdk/metrics/spi/SdkMeterProviderFactoryTest.java\n+++ /dev/null\n\n@@ -1,45 +0,0 @@\n-/*\n- * Copyright The OpenTelemetry Authors\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package io.opentelemetry.sdk.metrics.spi;\n-\n-import static org.assertj.core.api.Assertions.assertThat;\n-\n-import io.opentelemetry.api.common.Attributes;\n-import io.opentelemetry.api.metrics.GlobalMetricsProvider;\n-import io.opentelemetry.sdk.metrics.SdkMeterProvider;\n-import io.opentelemetry.sdk.resources.Resource;\n-import io.opentelemetry.sdk.resources.ResourceAttributes;\n-import org.junit.jupiter.api.Test;\n-\n-/** Unit tests for {@link SdkMeterProviderFactory}. */\n-class SdkMeterProviderFactoryTest {\n-  @Test\n-  void testDefault() {\n-    assertThat(GlobalMetricsProvider.get()).isInstanceOf(SdkMeterProvider.class);\n-  }\n-\n-  @Test\n-  void builder_fallbackServiceName() {\n-    Resource resourceWithFallbacks =\n-        Resource.create(Attributes.of(ResourceAttributes.SERVICE_NAME, \"unknown_service:java\"));\n-    SdkMeterProvider meterProvider =\n-        SdkMeterProvider.builder().setResource(Resource.getEmpty()).build();\n-    assertThat(meterProvider)\n-        .extracting(\"sharedState\")\n-        .hasFieldOrPropertyWithValue(\"resource\", resourceWithFallbacks);\n-  }\n-\n-  @Test\n-  void builder_dontOverrideServiceName() {\n-    Resource providedResource =\n-        Resource.create(Attributes.of(ResourceAttributes.SERVICE_NAME, \"myGreatService\"));\n-    SdkMeterProvider meterProvider =\n-        SdkMeterProvider.builder().setResource(providedResource).build();\n-    assertThat(meterProvider)\n-        .extracting(\"sharedState\")\n-        .hasFieldOrPropertyWithValue(\"resource\", providedResource);\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NjIxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546186210", "bodyText": "Do we need this mock?", "author": "anuraaga", "createdAt": "2020-12-19T03:53:32Z", "path": "sdk/trace/src/test/java/io/opentelemetry/sdk/trace/SdkTracerProviderTest.java", "diffHunk": "@@ -42,15 +44,44 @@ void setUp() {\n   }\n \n   @Test\n-  void builder_HappyPath() {\n-    assertThat(\n-            SdkTracerProvider.builder()\n-                .setClock(mock(Clock.class))\n-                .setResource(mock(Resource.class))\n-                .setIdGenerator(mock(IdGenerator.class))\n-                .setTraceConfig(mock(TraceConfig.class))\n-                .build())\n-        .isNotNull();\n+  void builder_fallbackServiceName() {\n+    Resource resource = mock(Resource.class);", "originalCommit": "18d6c9dbae073d9f1b114a5c7468663b102a8f10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4Njk5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546186998", "bodyText": "probably not. Can just use Resource.getEmpty(), for sure.", "author": "jkwatson", "createdAt": "2020-12-19T04:01:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4NjIxMA=="}], "type": "inlineReview", "revised_code": {"commit": "4e9eb103033ad22cf6c5a86df032c8293df33aee", "chunk": "diff --git a/sdk/trace/src/test/java/io/opentelemetry/sdk/trace/SdkTracerProviderTest.java b/sdk/trace/src/test/java/io/opentelemetry/sdk/trace/SdkTracerProviderTest.java\nindex ef0190ddf..7b6fca738 100644\n--- a/sdk/trace/src/test/java/io/opentelemetry/sdk/trace/SdkTracerProviderTest.java\n+++ b/sdk/trace/src/test/java/io/opentelemetry/sdk/trace/SdkTracerProviderTest.java\n\n@@ -34,27 +34,25 @@ import org.mockito.quality.Strictness;\n @MockitoSettings(strictness = Strictness.LENIENT)\n class SdkTracerProviderTest {\n   @Mock private SpanProcessor spanProcessor;\n-  private final SdkTracerProvider tracerFactory = SdkTracerProvider.builder().build();\n+  private SdkTracerProvider tracerFactory;\n \n   @BeforeEach\n   void setUp() {\n+    tracerFactory = SdkTracerProvider.builder().addSpanProcessor(spanProcessor).build();\n     when(spanProcessor.forceFlush()).thenReturn(CompletableResultCode.ofSuccess());\n     when(spanProcessor.shutdown()).thenReturn(CompletableResultCode.ofSuccess());\n-    tracerFactory.addSpanProcessor(spanProcessor);\n   }\n \n   @Test\n-  void builder_fallbackServiceName() {\n+  void builder_defaultResource() {\n     Resource resource = mock(Resource.class);\n     when(resource.getAttributes()).thenReturn(Attributes.empty());\n \n-    Resource resourceWithDefaults =\n-        Resource.create(Attributes.of(ResourceAttributes.SERVICE_NAME, \"unknown_service:java\"));\n+    Resource resourceWithDefaults = Resource.getDefault();\n \n     SdkTracerProvider tracerProvider =\n         SdkTracerProvider.builder()\n             .setClock(mock(Clock.class))\n-            .setResource(resource)\n             .setIdGenerator(mock(IdGenerator.class))\n             .setTraceConfig(mock(TraceConfig.class))\n             .build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIyNjE4MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546226181", "bodyText": "This is how I initially proposed the spec PR, but not how I reworked it shortly after and how it got approved \ud83d\ude03\nNow the spec basically says that we should treat the service.name exactly the same as we already treat the telemetry.sdk.name: It's there by default, but if the user set's their own resource explicitly, they need to merge it in manually.\nSee open-telemetry/opentelemetry-specification#1294 (comment) and https://github.com/open-telemetry/opentelemetry-specification/blob/39fa82f0a7e58975782520c304768d63da0c7612/specification/resource/sdk.md (not yet merged).\nIf you think the first version of the PR was better, you should say so on the spec.\n@anuraaga @jkwatson You approved the spec PR after I made this change, but maybe you want to check again?", "author": "Oberon00", "createdAt": "2020-12-19T11:14:37Z", "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/SdkMeterProviderBuilder.java", "diffHunk": "@@ -52,6 +54,9 @@ public SdkMeterProviderBuilder setResource(@Nonnull Resource resource) {\n    * @return An initialized TracerSdkFactory.\n    */\n   public SdkMeterProvider build() {\n-    return new SdkMeterProvider(clock, resource);\n+    Resource resourceWithFallbacks =\n+        Resource.create(\n+            FALLBACK_MANDATORY_ATTRIBUTES.toBuilder().putAll(resource.getAttributes()).build());", "originalCommit": "18d6c9dbae073d9f1b114a5c7468663b102a8f10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI3MDM5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546270397", "bodyText": "I removed my approval, because I was mostly going on the PR description, which seems to match what I've implemented here. What's now written in the spec is no longer comprehensible to me. :(", "author": "jkwatson", "createdAt": "2020-12-19T18:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIyNjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjI3MjU1Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r546272553", "bodyText": "@jkwatson To really dismiss your approval you have to expand the box at the bottom of the PR and click the dots next to your approval there (or add a request-changes review). Adding a comment-only review does not remove the approval.", "author": "Oberon00", "createdAt": "2020-12-19T19:14:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIyNjE4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "4e9eb103033ad22cf6c5a86df032c8293df33aee", "chunk": "diff --git a/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/SdkMeterProviderBuilder.java b/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/SdkMeterProviderBuilder.java\nindex 65930b53e..b0d29aee6 100644\n--- a/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/SdkMeterProviderBuilder.java\n+++ b/sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/SdkMeterProviderBuilder.java\n\n@@ -49,14 +48,29 @@ public final class SdkMeterProviderBuilder {\n   }\n \n   /**\n-   * Create a new TracerSdkFactory instance.\n+   * Returns a new {@link SdkMeterProvider} built with the configuration of this {@link\n+   * SdkMeterProviderBuilder} and registers it as the global {@link\n+   * io.opentelemetry.api.metrics.MeterProvider}.\n+   *\n+   * @see GlobalMetricsProvider\n+   */\n+  public SdkMeterProvider buildAndRegisterGlobal() {\n+    SdkMeterProvider meterProvider = build();\n+    GlobalMetricsProvider.set(meterProvider);\n+    return meterProvider;\n+  }\n+\n+  /**\n+   * Returns a new {@link SdkMeterProvider} built with the configuration of this {@link\n+   * SdkMeterProviderBuilder}. This provider is not registered as the global {@link\n+   * io.opentelemetry.api.metrics.MeterProvider}. It is recommended that you register one provider\n+   * using {@link SdkMeterProviderBuilder#buildAndRegisterGlobal()} for use by instrumentation when\n+   * that requires access to a global instance of {@link\n+   * io.opentelemetry.api.metrics.MeterProvider}.\n    *\n-   * @return An initialized TracerSdkFactory.\n+   * @see GlobalMetricsProvider\n    */\n   public SdkMeterProvider build() {\n-    Resource resourceWithFallbacks =\n-        Resource.create(\n-            FALLBACK_MANDATORY_ATTRIBUTES.toBuilder().putAll(resource.getAttributes()).build());\n-    return new SdkMeterProvider(clock, resourceWithFallbacks);\n+    return new SdkMeterProvider(clock, resource);\n   }\n }\n"}}, {"oid": "4e9eb103033ad22cf6c5a86df032c8293df33aee", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4e9eb103033ad22cf6c5a86df032c8293df33aee", "message": "Add a MANDATORY resource that will contain all mandatory attributes.", "committedDate": "2021-01-15T21:58:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQxOTk5NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r559419995", "bodyText": "I don't think this needs to be separated from DEFAULT. Also, this would be the only public field in this class, the others are private and have getters.", "author": "Oberon00", "createdAt": "2021-01-18T09:21:56Z", "path": "sdk/common/src/main/java/io/opentelemetry/sdk/resources/Resource.java", "diffHunk": "@@ -52,9 +53,15 @@\n   private static final String ERROR_MESSAGE_INVALID_VALUE =\n       \" should be a ASCII string with a length not exceed \" + MAX_LENGTH + \" characters.\";\n   private static final Resource EMPTY = create(Attributes.empty());\n-\n   private static final Resource TELEMETRY_SDK;\n \n+  /**\n+   * The MANDATORY Resource instance contains the mandatory attributes that must be used if they are\n+   * not provided by the Resource that is given to an SDK signal provider.\n+   */\n+  public static final Resource MANDATORY =", "originalCommit": "e60588b6313266ac8c39aaf925bd6efc7c0b775b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMzMTQ1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r560331450", "bodyText": "I like having it be a separate thing in the code, but agree it should be private, and can be accessed via the default Resource.", "author": "jkwatson", "createdAt": "2021-01-19T16:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQxOTk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMzNTI2OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2366#discussion_r560335269", "bodyText": "done", "author": "jkwatson", "createdAt": "2021-01-19T17:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQxOTk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "eca7a6f8822e7e892736f9baa9a8e2cf617f0563", "chunk": "diff --git a/sdk/common/src/main/java/io/opentelemetry/sdk/resources/Resource.java b/sdk/common/src/main/java/io/opentelemetry/sdk/resources/Resource.java\nindex 3ebb2c51f..b3f972a01 100644\n--- a/sdk/common/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n+++ b/sdk/common/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n\n@@ -59,16 +59,16 @@ public abstract class Resource {\n    * The MANDATORY Resource instance contains the mandatory attributes that must be used if they are\n    * not provided by the Resource that is given to an SDK signal provider.\n    */\n-  public static final Resource MANDATORY =\n+  private static final Resource MANDATORY =\n       create(Attributes.of(SERVICE_NAME, \"unknown_service:java\"));\n \n   static {\n     TELEMETRY_SDK =\n         create(\n             Attributes.builder()\n-                .put(SDK_NAME, \"opentelemetry\")\n-                .put(SDK_LANGUAGE, \"java\")\n-                .put(SDK_VERSION, readVersion())\n+                .put(TELEMETRY_SDK_NAME, \"opentelemetry\")\n+                .put(TELEMETRY_SDK_LANGUAGE, \"java\")\n+                .put(TELEMETRY_SDK_VERSION, readVersion())\n                 .build());\n   }\n \n"}}, {"oid": "eca7a6f8822e7e892736f9baa9a8e2cf617f0563", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/eca7a6f8822e7e892736f9baa9a8e2cf617f0563", "message": "updates from ResourceAttributes changes", "committedDate": "2021-01-20T16:42:59Z", "type": "forcePushed"}, {"oid": "25f4d058de14a912332cca126db37d2bf1efd549", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/25f4d058de14a912332cca126db37d2bf1efd549", "message": "Assign a fallback service name to resources when building the signal Provider instances.", "committedDate": "2021-01-20T16:57:24Z", "type": "commit"}, {"oid": "a7cac8c2e06a0fd5ea0229718ece6957c0b577e5", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a7cac8c2e06a0fd5ea0229718ece6957c0b577e5", "message": "Add a MANDATORY resource that will contain all mandatory attributes.", "committedDate": "2021-01-20T16:57:24Z", "type": "commit"}, {"oid": "4bee2614b1285a7d053e1d326893386d1c9bbe56", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4bee2614b1285a7d053e1d326893386d1c9bbe56", "message": "some cleanups of leftover stuff", "committedDate": "2021-01-20T16:57:24Z", "type": "commit"}, {"oid": "5b15f659459e07b6259e7b2c0273ef543c23d1a9", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5b15f659459e07b6259e7b2c0273ef543c23d1a9", "message": "make the MANDATORY resource instance private", "committedDate": "2021-01-20T16:57:24Z", "type": "commit"}, {"oid": "5314c14695488d7622db25f1ee49f8748b61eaaf", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5314c14695488d7622db25f1ee49f8748b61eaaf", "message": "updates from ResourceAttributes changes", "committedDate": "2021-01-20T16:57:24Z", "type": "commit"}, {"oid": "5314c14695488d7622db25f1ee49f8748b61eaaf", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5314c14695488d7622db25f1ee49f8748b61eaaf", "message": "updates from ResourceAttributes changes", "committedDate": "2021-01-20T16:57:24Z", "type": "forcePushed"}, {"oid": "5a86d3cb602329b4cd239141e6984a093a5a636c", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5a86d3cb602329b4cd239141e6984a093a5a636c", "message": "be sure to set the service name in the jaeger tests", "committedDate": "2021-01-20T17:15:44Z", "type": "commit"}]}