{"pr_number": 1366, "pr_title": "Add SDK Telemetry resources", "pr_createdAt": "2020-06-22T05:20:15Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNDExNA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443324114", "bodyText": "I think FileInputStream only works when loading from the file system, e.g., IntelliJ and unit tests but not from a JAR. Instead\nResource.class.getResourceAsAstream(\"version.properties\") can handle both", "author": "anuraaga", "createdAt": "2020-06-22T05:28:48Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java", "diffHunk": "@@ -45,6 +47,26 @@\n   private static final String ERROR_MESSAGE_INVALID_VALUE =\n       \" should be a ASCII string with a length not exceed \" + MAX_LENGTH + \" characters.\";\n   private static final Resource EMPTY = create(Attributes.empty());\n+  private static final Resource TELEMETRY_SDK =\n+      create(\n+          Attributes.newBuilder()\n+              .setAttribute(\"telemetry.sdk.name\", \"opentelemetry\")\n+              .setAttribute(\"telemetry.sdk.language\", \"java\")\n+              .setAttribute(\"telemetry.sdk.version\", readVersion())\n+              .build());\n+\n+  @Nullable\n+  private static String readVersion() {\n+    Properties properties = new Properties();\n+    try {\n+      properties.load(\n+          new FileInputStream(Resource.class.getResource(\"version.properties\").getFile()));", "originalCommit": "f032e616294936c8f08d9f21df1508a0d66edc08", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java b/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\nindex 1646591f3..a7164d9c8 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n\n@@ -57,15 +56,16 @@ public abstract class Resource {\n \n   @Nullable\n   private static String readVersion() {\n+\n     Properties properties = new Properties();\n     try {\n       properties.load(\n-          new FileInputStream(Resource.class.getResource(\"version.properties\").getFile()));\n+          Resource.class.getResourceAsStream(\"/io/opentelemetry/sdk/version.properties\"));\n     } catch (Exception e) {\n       // we left the attribute empty\n       return null;\n     }\n-    return properties.getProperty(\"version\");\n+    return properties.getProperty(\"sdk.version\");\n   }\n \n   Resource() {}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNDU0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443324541", "bodyText": "So when a user wants to define their own Resource, they always have to merge the default one to get these values. I think this is OK, but it could also be good independently of this PR to think if Resource would make sense to have its own SPI, so that any ResourceProvider in the app are automatically registered without having to manually merge them all. Of course, there could be ordering problems with this, but it's probably still simpler than manual merging in many cases.", "author": "anuraaga", "createdAt": "2020-06-22T05:30:44Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/TracerSdkProvider.java", "diffHunk": "@@ -138,7 +138,7 @@ public void forceFlush() {\n \n     private Clock clock = MillisClock.getInstance();\n     private IdsGenerator idsGenerator = new RandomIdsGenerator();\n-    private Resource resource = EnvVarResource.getResource();\n+    private Resource resource = Resource.getTelemetrySdk().merge(EnvVarResource.getResource());", "originalCommit": "f032e616294936c8f08d9f21df1508a0d66edc08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1MDc0Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443650743", "bodyText": "Let's definitely address this case in another PR (we have meant to implement the Resource part you mention, in some way or another, for some time now, so hopefully we will have it soon).", "author": "carlosalberto", "createdAt": "2020-06-22T15:38:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNDU0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNTQ4NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443325485", "bodyText": "Think it's better to avoid the forEach\nassertThat(attributes.get(\"telemetry.sdk.name\")).isEqualTo(stringAttributeValue(\"opentelemetry\"));\nassertThat(attributes.get(\"telemetry.sdk.language\")).isEqualTo(stringAttributeValue(\"java\"));\nassertThat(attributes.get(\"telemetry.sdk.version\")).isNotNull();\n/cc PS @jkwatson Would love to have getString :D", "author": "anuraaga", "createdAt": "2020-06-22T05:35:04Z", "path": "sdk/src/test/java/io/opentelemetry/sdk/resource/ResourceTest.java", "diffHunk": "@@ -148,4 +150,15 @@ public void testMergeResources_Resource2_Null() {\n     Resource resource = DEFAULT_RESOURCE.merge(resource1).merge(null);\n     assertThat(resource.getAttributes()).isEqualTo(expectedAttributes);\n   }\n+\n+  @Test\n+  public void testSdkTelemetryResources() {\n+    Resource resource = Resource.getTelemetrySdk();\n+    ReadableAttributes attributes = resource.getAttributes();\n+    String[] keys = {\"telemetry.sdk.name\", \"telemetry.sdk.language\", \"telemetry.sdk.version\"};", "originalCommit": "f032e616294936c8f08d9f21df1508a0d66edc08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY1Mjg3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443652873", "bodyText": "I'be initially against adding too many public methods to Attributes, as this is in general a class expected to be used by the SDK processing, not by end users. get() IMHO is enough for this purpose (and having to write more code in our side won't kill us ;) )", "author": "carlosalberto", "createdAt": "2020-06-22T15:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNTQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNjY5MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443716691", "bodyText": "This test could be made simpler by just building the Attributes object you expect and asserting that what you get back is equal to it.", "author": "jkwatson", "createdAt": "2020-06-22T17:28:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNTQ4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "chunk": "diff --git a/sdk/src/test/java/io/opentelemetry/sdk/resource/ResourceTest.java b/sdk/src/test/java/io/opentelemetry/sdk/resources/ResourceTest.java\nsimilarity index 92%\nrename from sdk/src/test/java/io/opentelemetry/sdk/resource/ResourceTest.java\nrename to sdk/src/test/java/io/opentelemetry/sdk/resources/ResourceTest.java\nindex 9351f734d..66df0e307 100644\n--- a/sdk/src/test/java/io/opentelemetry/sdk/resource/ResourceTest.java\n+++ b/sdk/src/test/java/io/opentelemetry/sdk/resources/ResourceTest.java\n\n@@ -155,10 +153,10 @@ public class ResourceTest {\n   public void testSdkTelemetryResources() {\n     Resource resource = Resource.getTelemetrySdk();\n     ReadableAttributes attributes = resource.getAttributes();\n-    String[] keys = {\"telemetry.sdk.name\", \"telemetry.sdk.language\", \"telemetry.sdk.version\"};\n-    attributes.forEach((key, value) -> assertThat(Arrays.asList(keys).contains(key)).isTrue());\n-    assertThat(attributes.get(keys[0]))\n+    assertThat(attributes.get(\"telemetry.sdk.name\"))\n         .isEqualTo(AttributeValue.stringAttributeValue(\"opentelemetry\"));\n-    assertThat(attributes.get(keys[1])).isEqualTo(AttributeValue.stringAttributeValue(\"java\"));\n+    assertThat(attributes.get(\"telemetry.sdk.language\"))\n+        .isEqualTo(AttributeValue.stringAttributeValue(\"java\"));\n+    assertThat(attributes.get(\"telemetry.sdk.version\")).isNotNull();\n   }\n }\n"}}, {"oid": "4bc6a89b9f479d407170b0f8ae689a554723bb04", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4bc6a89b9f479d407170b0f8ae689a554723bb04", "message": "Add SDK Telemetry resources", "committedDate": "2020-06-23T06:40:43Z", "type": "commit"}, {"oid": "d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "message": "Address feedback", "committedDate": "2020-06-23T06:41:09Z", "type": "commit"}, {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "message": "Generate version.properties", "committedDate": "2020-06-23T06:46:58Z", "type": "commit"}, {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "message": "Generate version.properties", "committedDate": "2020-06-23T06:46:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443999841", "bodyText": "Just noticed null value is allowed - @jkwatson does that seem OK? Wouldn't be surprised if it causes a NPE during export.\nEither way, what about setting to unknown?", "author": "anuraaga", "createdAt": "2020-06-23T06:53:10Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java", "diffHunk": "@@ -45,6 +46,27 @@\n   private static final String ERROR_MESSAGE_INVALID_VALUE =\n       \" should be a ASCII string with a length not exceed \" + MAX_LENGTH + \" characters.\";\n   private static final Resource EMPTY = create(Attributes.empty());\n+  private static final Resource TELEMETRY_SDK =\n+      create(\n+          Attributes.newBuilder()\n+              .setAttribute(\"telemetry.sdk.name\", \"opentelemetry\")\n+              .setAttribute(\"telemetry.sdk.language\", \"java\")\n+              .setAttribute(\"telemetry.sdk.version\", readVersion())\n+              .build());\n+\n+  @Nullable\n+  private static String readVersion() {\n+\n+    Properties properties = new Properties();\n+    try {\n+      properties.load(\n+          Resource.class.getResourceAsStream(\"/io/opentelemetry/sdk/version.properties\"));\n+    } catch (Exception e) {\n+      // we left the attribute empty\n+      return null;", "originalCommit": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAwNTgwMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r444005801", "bodyText": "My choice is based on the following spec:\n\nAttribute values of null are considered to be not set and get discarded as if that SetAttribute call had never been made.\n\nHowever, I noticed that the value is currently not discarded and, instead, a StringAttribute with value null is created. I was about to investigate a bit before opening an issue \ud83d\ude09", "author": "thisthat", "createdAt": "2020-06-23T07:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIwOTUxMg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r444209512", "bodyText": "Related: to me, it sounds like the build itself should fail if the version is not properly detected.", "author": "carlosalberto", "createdAt": "2020-06-23T13:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIxNDMzOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r444214338", "bodyText": "The build will make sure there is a version in the jar, but due to shading or similar, it may not make it into a user's app. I've seen a similar setup in Armeria cause NPE for users because of not accounting for the possibility before ><", "author": "anuraaga", "createdAt": "2020-06-23T13:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2NzU1Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r445867557", "bodyText": "Yes, I would prefer \"unknown\" to be here, rather than possible nulls to confound an exporter that wasn't expecting it.", "author": "jkwatson", "createdAt": "2020-06-25T22:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njc4MTk2MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r446781960", "bodyText": "Done in 6f113c0", "author": "thisthat", "createdAt": "2020-06-29T05:35:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java b/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\nindex a7164d9c8..d5336fcc7 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java\n\n@@ -63,7 +63,7 @@ public abstract class Resource {\n           Resource.class.getResourceAsStream(\"/io/opentelemetry/sdk/version.properties\"));\n     } catch (Exception e) {\n       // we left the attribute empty\n-      return null;\n+      return \"unknown\";\n     }\n     return properties.getProperty(\"sdk.version\");\n   }\n"}}, {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8", "message": "Use unknown when version not available", "committedDate": "2020-06-29T05:35:03Z", "type": "commit"}]}