{"pr_number": 2285, "pr_title": "Make classes that can be shutdown Closeable", "pr_createdAt": "2020-12-14T04:48:51Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285", "timeline": [{"oid": "8620f0df551441d88022439e76c0f71317cf7d7e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8620f0df551441d88022439e76c0f71317cf7d7e", "message": "Make classes that can be shutdown Closeable", "committedDate": "2020-12-14T04:48:03Z", "type": "commit"}, {"oid": "dde44a9a3b6ec2e35a83119aad777b939d5059b9", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/dde44a9a3b6ec2e35a83119aad777b939d5059b9", "message": "Glad not my password", "committedDate": "2020-12-14T04:49:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4OTAzNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r542189037", "bodyText": "This seems a bit questionable. If we have a shutdown timeout, should it be hardcoded or configurable? If it is hardcoded, maybe use a constant?", "author": "Oberon00", "createdAt": "2020-12-14T08:18:44Z", "path": "sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SpanProcessor.java", "diffHunk": "@@ -99,4 +101,13 @@ default CompletableResultCode shutdown() {\n   default CompletableResultCode forceFlush() {\n     return CompletableResultCode.ofSuccess();\n   }\n+\n+  /**\n+   * Closes this {@link SpanProcessor} after processing any remaining spans, releasing any\n+   * resources.\n+   */\n+  @Override\n+  default void close() {\n+    shutdown().join(10, TimeUnit.SECONDS);", "originalCommit": "dde44a9a3b6ec2e35a83119aad777b939d5059b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4OTMxOA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r542189318", "bodyText": "Also, maybe it would be better to throw a timeout exception if the shutdown does not complete.", "author": "Oberon00", "createdAt": "2020-12-14T08:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4OTAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0MjUyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r543842525", "bodyText": "I think we expect this to finish relatively quickly, just finish things up. So maybe 10 seconds was too large, let me try 1 second. I'd prefer hard-coded just to keep things simpler, if extracting a constant are you thinking internal package?\n\nAlso, maybe it would be better to throw a timeout exception if the shutdown does not complete.\n\nI don't know if I've ever been able to handle an exception during shutdown so am ambivalent, but can add it. How useful does it seem?", "author": "anuraaga", "createdAt": "2020-12-16T02:31:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4OTAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk2NzE2Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r544967162", "bodyText": "I think we expect this to finish relatively quickly\n\nHmm, since shutdown includes flush, it will often make network requests.", "author": "Oberon00", "createdAt": "2020-12-17T10:11:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjE4OTAzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r542509619", "bodyText": "Do we need a shutdown and a close?", "author": "bogdandrutu", "createdAt": "2020-12-14T16:12:38Z", "path": "sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SpanProcessor.java", "diffHunk": "@@ -99,4 +101,13 @@ default CompletableResultCode shutdown() {\n   default CompletableResultCode forceFlush() {\n     return CompletableResultCode.ofSuccess();\n   }\n+\n+  /**\n+   * Closes this {@link SpanProcessor} after processing any remaining spans, releasing any\n+   * resources.\n+   */\n+  @Override\n+  default void close() {", "originalCommit": "dde44a9a3b6ec2e35a83119aad777b939d5059b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0MDQ1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r543840450", "bodyText": "I don't think so if the spec is ok with changing names.", "author": "anuraaga", "createdAt": "2020-12-16T02:28:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTIyNzIxMA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r545227210", "bodyText": "What was the outcome of the discussion of having the shutdown method be optional? Were people ok with using a language-appropriate idiom if one was available?", "author": "jkwatson", "createdAt": "2020-12-17T16:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1NjY2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r545256663", "bodyText": "I think using the name close instead of shutdown would still qualify as providing shutdown. But that aspect was not discussed as it was concluded that generally a shutdown functionality is not optional (see open-telemetry/opentelemetry-specification#1288).", "author": "Oberon00", "createdAt": "2020-12-17T17:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI2Mjg5OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r545262898", "bodyText": "hm. Is it worth adding a clarification to the spec, or do we think this is within our control as language experts?", "author": "jkwatson", "createdAt": "2020-12-17T17:20:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxMTMyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r545311321", "bodyText": "I think no one will complain about some SDK method name. But a general clarification in the spec (library-guidelines.md maybe) would be good like\n\nMethod/constant/... names defined in this specification SHOULD be adjusted to language naming conventions (snake_case, PascalCase, ...) but otherwise used as-is. As an exception, if a well-established name/naming pattern exists in a language for a particular functionality, it SHOULD be used instead. In general, the names should be choosen to adhere to the spec as closely as possible without being awkward or unnatural in the target language.", "author": "Oberon00", "createdAt": "2020-12-17T18:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjUwOTYxOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1312ee7fe21ec6b049f3d37a0ba3d054ad9b6d0b", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1312ee7fe21ec6b049f3d37a0ba3d054ad9b6d0b", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into closeable", "committedDate": "2020-12-16T02:28:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNzE2MQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r547417161", "bodyText": "can you create an issue to make the shutdown() return CompletableResultCode for consistency? Thanks!", "author": "jkwatson", "createdAt": "2020-12-22T17:53:41Z", "path": "sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SdkTracerManagement.java", "diffHunk": "@@ -70,4 +71,22 @@\n    * @see SpanProcessor#forceFlush()\n    */\n   CompletableResultCode forceFlush();\n+\n+  /**\n+   * Attempts to stop all the activity for this {@link Tracer}. Calls {@link\n+   * SpanProcessor#shutdown()} for all registered {@link SpanProcessor}s.\n+   *\n+   * <p>This operation may block until all the Spans are processed. Must be called before turning\n+   * off the main application to ensure all data are processed and exported.\n+   *\n+   * <p>After this is called, newly created {@code Span}s will be no-ops.\n+   *\n+   * <p>After this is called, further attempts at re-using or reconfiguring this instance will\n+   * result in undefined behavior. It should be considered a terminal operation for the SDK\n+   * implementation.\n+   */\n+  @Override\n+  default void close() {\n+    shutdown();", "originalCommit": "1312ee7fe21ec6b049f3d37a0ba3d054ad9b6d0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ4MTkzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2285#discussion_r551481935", "bodyText": "Note: #2422 implements this, so I don't know that we need an issue.", "author": "jkwatson", "createdAt": "2021-01-04T18:13:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQxNzE2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "893c467bd1933bf9b8407d7c88200a9fb5eb832f", "chunk": "diff --git a/sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SdkTracerManagement.java b/sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SdkTracerManagement.java\nindex f15bd3e5a..b9b4134d5 100644\n--- a/sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SdkTracerManagement.java\n+++ b/sdk/trace/src/main/java/io/opentelemetry/sdk/trace/SdkTracerManagement.java\n\n@@ -87,6 +98,6 @@ public interface SdkTracerManagement extends Closeable {\n    */\n   @Override\n   default void close() {\n-    shutdown();\n+    shutdown().join(10, TimeUnit.SECONDS);\n   }\n }\n"}}, {"oid": "812a4f85bd1abf58b0ae88981472fb060399aaaf", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/812a4f85bd1abf58b0ae88981472fb060399aaaf", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into closeable", "committedDate": "2021-01-06T05:17:04Z", "type": "commit"}, {"oid": "c0de2c4b10a18d4d652e59b427bb2b2879e94d26", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c0de2c4b10a18d4d652e59b427bb2b2879e94d26", "message": "Merge branch 'master' of github.com:open-telemetry/opentelemetry-java into closeable", "committedDate": "2021-01-13T04:47:24Z", "type": "commit"}, {"oid": "893c467bd1933bf9b8407d7c88200a9fb5eb832f", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/893c467bd1933bf9b8407d7c88200a9fb5eb832f", "message": "Drift", "committedDate": "2021-01-13T04:47:57Z", "type": "commit"}]}