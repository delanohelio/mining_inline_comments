{"pr_number": 2395, "pr_title": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator", "pr_createdAt": "2020-12-23T02:18:55Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395", "timeline": [{"oid": "e01e48dc67f6e700db41005e612afd85a6ed7c01", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e01e48dc67f6e700db41005e612afd85a6ed7c01", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-23T02:21:01Z", "type": "forcePushed"}, {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/551b47f25fc01caf4dd7588b74da0c47310f63af", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-23T03:22:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIyMTI0NA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548221244", "bodyText": "This comment is no longer correct.", "author": "jkwatson", "createdAt": "2020-12-23T20:43:42Z", "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregation/AggregationFactory.java", "diffHunk": "@@ -5,11 +5,11 @@\n \n package io.opentelemetry.sdk.metrics.aggregation;\n \n-import io.opentelemetry.sdk.metrics.aggregator.Aggregator;\n+import io.opentelemetry.sdk.metrics.aggregator.AggregatorHandle;\n import io.opentelemetry.sdk.metrics.common.InstrumentValueType;\n import javax.annotation.concurrent.Immutable;\n \n-/** Factory class for {@link Aggregator}. */\n+/** Factory class for {@link AggregatorHandle}. */", "originalCommit": "551b47f25fc01caf4dd7588b74da0c47310f63af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU3NjkyMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548576921", "bodyText": "Updated.", "author": "bogdandrutu", "createdAt": "2020-12-24T15:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIyMTI0NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIzMDQ5Nw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548230497", "bodyText": "If we're ok with not testing the exact type returned by the createHandle method, we could make these handle implementations private.", "author": "jkwatson", "createdAt": "2020-12-23T20:56:22Z", "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleMinMaxSumCountAggregator.java", "diffHunk": "@@ -11,77 +11,85 @@\n import javax.annotation.concurrent.ThreadSafe;\n \n @ThreadSafe\n-public final class DoubleMinMaxSumCountAggregator extends Aggregator<MinMaxSumCountAccumulation> {\n-  private static final AggregatorFactory<MinMaxSumCountAccumulation> AGGREGATOR_FACTORY =\n-      new AggregatorFactory<MinMaxSumCountAccumulation>() {\n-        @Override\n-        public Aggregator<MinMaxSumCountAccumulation> getAggregator() {\n-          return new DoubleMinMaxSumCountAggregator();\n-        }\n+public final class DoubleMinMaxSumCountAggregator\n+    implements Aggregator<MinMaxSumCountAccumulation> {\n+  private static final DoubleMinMaxSumCountAggregator INSTANCE =\n+      new DoubleMinMaxSumCountAggregator();\n \n-        @Override\n-        public MinMaxSumCountAccumulation accumulateDouble(double value) {\n-          return MinMaxSumCountAccumulation.create(1, value, value, value);\n-        }\n-      };\n-\n-  private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n-  // The current value. This controls its own internal thread-safety via method access. Don't\n-  // try to use its fields directly.\n-  @GuardedBy(\"lock\")\n-  private final DoubleState current = new DoubleState();\n-\n-  public static AggregatorFactory<MinMaxSumCountAccumulation> getFactory() {\n-    return AGGREGATOR_FACTORY;\n+  /**\n+   * Returns the instance of this {@link Aggregator}.\n+   *\n+   * @return the instance of this {@link Aggregator}.\n+   */\n+  public static Aggregator<MinMaxSumCountAccumulation> getInstance() {\n+    return INSTANCE;\n   }\n \n   private DoubleMinMaxSumCountAggregator() {}\n \n   @Override\n-  protected MinMaxSumCountAccumulation doAccumulateThenReset() {\n-    lock.writeLock().lock();\n-    try {\n-      MinMaxSumCountAccumulation toReturn =\n-          MinMaxSumCountAccumulation.create(current.count, current.sum, current.min, current.max);\n-      current.reset();\n-      return toReturn;\n-    } finally {\n-      lock.writeLock().unlock();\n-    }\n+  public AggregatorHandle<MinMaxSumCountAccumulation> createHandle() {\n+    return new Handle();\n   }\n \n   @Override\n-  protected void doRecordDouble(double value) {\n-    lock.writeLock().lock();\n-    try {\n-      current.record(value);\n-    } finally {\n-      lock.writeLock().unlock();\n-    }\n+  public MinMaxSumCountAccumulation accumulateDouble(double value) {\n+    return MinMaxSumCountAccumulation.create(1, value, value, value);\n   }\n \n-  private static final class DoubleState {\n-    private long count;\n-    private double sum;\n-    private double min;\n-    private double max;\n+  static final class Handle extends AggregatorHandle<MinMaxSumCountAccumulation> {", "originalCommit": "551b47f25fc01caf4dd7588b74da0c47310f63af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODU2NzU5Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548567596", "bodyText": "I had them initially private, then when I had to fix the tests I did this. We should follow up on this, for the moment I am keeping this way to not remove tests.", "author": "bogdandrutu", "createdAt": "2020-12-24T15:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIzMDQ5Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "483723c7974fc7187c731849abaeb162d00425e8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/483723c7974fc7187c731849abaeb162d00425e8", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-24T15:48:39Z", "type": "commit"}, {"oid": "d01b845c2b682d1404719ecda6919d1e6ed26c93", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d01b845c2b682d1404719ecda6919d1e6ed26c93", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-24T15:56:03Z", "type": "forcePushed"}, {"oid": "7004e805b70f16094d53e70c0b2f312808fb755e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7004e805b70f16094d53e70c0b2f312808fb755e", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-24T15:57:00Z", "type": "commit"}, {"oid": "7004e805b70f16094d53e70c0b2f312808fb755e", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7004e805b70f16094d53e70c0b2f312808fb755e", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-12-24T15:57:00Z", "type": "forcePushed"}]}