{"pr_number": 937, "pr_title": "Add a first implementation for LastValue aggregator for Observers", "pr_createdAt": "2020-02-26T23:26:04Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/937", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMDg1MA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384830850", "bodyText": "Are we willing to accept that we might be overwriting something that was recorded later than what we're currently holding onto? I'm thinking of the dimensionality reduction use-case for this.", "author": "jkwatson", "createdAt": "2020-02-26T23:32:10Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.metrics.aggregator;\n+\n+import com.google.common.util.concurrent.AtomicDouble;\n+import io.opentelemetry.sdk.metrics.data.MetricData.DoublePoint;\n+import io.opentelemetry.sdk.metrics.data.MetricData.Point;\n+import java.util.Map;\n+\n+public final class DoubleLastValueAggregator extends AbstractAggregator {\n+\n+  private static final double DEFAULT_VALUE = 0.0;\n+  private static final AggregatorFactory AGGREGATOR_FACTORY =\n+      new AggregatorFactory() {\n+        @Override\n+        public Aggregator getAggregator() {\n+          return new DoubleLastValueAggregator();\n+        }\n+      };\n+\n+  private final AtomicDouble current = new AtomicDouble(DEFAULT_VALUE);\n+\n+  public static AggregatorFactory getFactory() {\n+    return AGGREGATOR_FACTORY;\n+  }\n+\n+  @Override\n+  void doMergeAndReset(Aggregator aggregator) {\n+    DoubleLastValueAggregator other = (DoubleLastValueAggregator) aggregator;\n+    other.current.set(this.current.getAndSet(DEFAULT_VALUE));", "originalCommit": "977faa7990622cdc86c7211bb5fd2aa0c53207d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTQyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384831427", "bodyText": "This is use only for observer so all the events are recorded once in the callback execution, if we want to support this for CounterInstruments or MeasureInstruments then we need a time as well and preserver the ordering.", "author": "bogdandrutu", "createdAt": "2020-02-26T23:34:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMDg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMzE4Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384833186", "bodyText": "We should make that very clear in the documentation of this class, then, and perhaps in the class name. Can we just call the class ObserverLastValue ?", "author": "jkwatson", "createdAt": "2020-02-26T23:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMDg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NzYwNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384847605", "bodyText": "Documented in the description this limitation. For the moment I would not rename it since we most likely are going to fix this.", "author": "bogdandrutu", "createdAt": "2020-02-27T00:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMDg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "ec57de83f99fd50dc31d8ca5231dde454641e4c8", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\nindex eb40f4e7a..c7c831af6 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\n\n@@ -34,6 +34,11 @@ public final class DoubleLastValueAggregator extends AbstractAggregator {\n \n   private final AtomicDouble current = new AtomicDouble(DEFAULT_VALUE);\n \n+  /**\n+   * Returns an {@link AggregatorFactory} that produces {@link DoubleLastValueAggregator} instances.\n+   *\n+   * @return an {@link AggregatorFactory} that produces {@link DoubleLastValueAggregator} instances.\n+   */\n   public static AggregatorFactory getFactory() {\n     return AGGREGATOR_FACTORY;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTA2NQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384831065", "bodyText": "I don't think we want an adder for the last-value impl, do we?", "author": "jkwatson", "createdAt": "2020-02-26T23:32:52Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.metrics.aggregator;\n+\n+import io.opentelemetry.sdk.metrics.data.MetricData.LongPoint;\n+import io.opentelemetry.sdk.metrics.data.MetricData.Point;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public final class LongLastValueAggregator extends AbstractAggregator {\n+\n+  private static final long DEFAULT_VALUE = 0L;\n+  private static final AggregatorFactory AGGREGATOR_FACTORY =\n+      new AggregatorFactory() {\n+        @Override\n+        public Aggregator getAggregator() {\n+          return new LongLastValueAggregator();\n+        }\n+      };\n+\n+  // TODO: Change to use LongAdder when changed to java8.", "originalCommit": "977faa7990622cdc86c7211bb5fd2aa0c53207d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzODUyNw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384838527", "bodyText": "correct, fixed.", "author": "bogdandrutu", "createdAt": "2020-02-26T23:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTA2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ec57de83f99fd50dc31d8ca5231dde454641e4c8", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\nindex 478e8d558..503d8e46d 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\n\n@@ -32,9 +32,13 @@ public final class LongLastValueAggregator extends AbstractAggregator {\n         }\n       };\n \n-  // TODO: Change to use LongAdder when changed to java8.\n   private final AtomicLong current = new AtomicLong(DEFAULT_VALUE);\n \n+  /**\n+   * Returns an {@link AggregatorFactory} that produces {@link LongLastValueAggregator} instances.\n+   *\n+   * @return an {@link AggregatorFactory} that produces {@link LongLastValueAggregator} instances.\n+   */\n   public static AggregatorFactory getFactory() {\n     return AGGREGATOR_FACTORY;\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTQ0OA==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384831448", "bodyText": "I don't think this is a good default. I actually think we should return a null Point if nothing has been recorded, rather than returning a possibly misleading 0.", "author": "jkwatson", "createdAt": "2020-02-26T23:34:06Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.metrics.aggregator;\n+\n+import io.opentelemetry.sdk.metrics.data.MetricData.LongPoint;\n+import io.opentelemetry.sdk.metrics.data.MetricData.Point;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+public final class LongLastValueAggregator extends AbstractAggregator {\n+\n+  private static final long DEFAULT_VALUE = 0L;", "originalCommit": "977faa7990622cdc86c7211bb5fd2aa0c53207d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0NzY3Ng==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384847676", "bodyText": "Documented in the description this limitation.", "author": "bogdandrutu", "createdAt": "2020-02-27T00:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5MDExMQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384890111", "bodyText": "Done.", "author": "bogdandrutu", "createdAt": "2020-02-27T03:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMTQ0OA=="}], "type": "inlineReview", "revised_code": {"commit": "ec57de83f99fd50dc31d8ca5231dde454641e4c8", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\nindex 478e8d558..503d8e46d 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/LongLastValueAggregator.java\n\n@@ -32,9 +32,13 @@ public final class LongLastValueAggregator extends AbstractAggregator {\n         }\n       };\n \n-  // TODO: Change to use LongAdder when changed to java8.\n   private final AtomicLong current = new AtomicLong(DEFAULT_VALUE);\n \n+  /**\n+   * Returns an {@link AggregatorFactory} that produces {@link LongLastValueAggregator} instances.\n+   *\n+   * @return an {@link AggregatorFactory} that produces {@link LongLastValueAggregator} instances.\n+   */\n   public static AggregatorFactory getFactory() {\n     return AGGREGATOR_FACTORY;\n   }\n"}}, {"oid": "ec57de83f99fd50dc31d8ca5231dde454641e4c8", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/ec57de83f99fd50dc31d8ca5231dde454641e4c8", "message": "Add a first implementation for LastValue aggregator for Observers\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-26T23:57:44Z", "type": "forcePushed"}, {"oid": "a2ff87cd3eb2c1262bd896d62d7d96473d8e3d34", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a2ff87cd3eb2c1262bd896d62d7d96473d8e3d34", "message": "Add a first implementation for LastValue aggregator for Observers\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-27T00:24:10Z", "type": "commit"}, {"oid": "a2ff87cd3eb2c1262bd896d62d7d96473d8e3d34", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/a2ff87cd3eb2c1262bd896d62d7d96473d8e3d34", "message": "Add a first implementation for LastValue aggregator for Observers\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-27T00:24:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384848316", "bodyText": "Is it possible that an aggregator is asked to report data before the observer has had a chance to report, hence leading to a zero value recorded? The lifecycle in this is unclear to me. I'm also ok addressing this in a follow-up PR.", "author": "jkwatson", "createdAt": "2020-02-27T00:27:34Z", "path": "sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.metrics.aggregator;\n+\n+import com.google.common.util.concurrent.AtomicDouble;\n+import io.opentelemetry.sdk.metrics.data.MetricData.DoublePoint;\n+import io.opentelemetry.sdk.metrics.data.MetricData.Point;\n+import java.util.Map;\n+\n+/**\n+ * Aggregator that aggregates recorded values by storing the last recorded value.\n+ *\n+ * <p>Limitations:\n+ *\n+ * <ul>\n+ *   <li>The current implementation does not store a time when the value was recorded, so merging\n+ *       multiple LastValueAggregators will not preserve the ordering of records. This is not a\n+ *       problem because LastValueAggregator is currently only available for Observers which record\n+ *       all values once.\n+ *   <li>The current implementation does not properly reset the current value, it should use a\n+ *       {@code null} value instead of 0. This is not a problem because LastValueAggregator is\n+ *       currently only available for Observers which do not reuse reset instances.", "originalCommit": "a2ff87cd3eb2c1262bd896d62d7d96473d8e3d34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODcyNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384848725", "bodyText": "That behavior is not possible.", "author": "bogdandrutu", "createdAt": "2020-02-27T00:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0OTExOQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384849119", "bodyText": "A design doc that explains why this is true would be super helpful.  :)", "author": "jkwatson", "createdAt": "2020-02-27T00:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2MTE3Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384861173", "bodyText": "Not sure what to do now :) do you mind clarify what you want to see?", "author": "bogdandrutu", "createdAt": "2020-02-27T01:11:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg5MDA4OQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r384890089", "bodyText": "Done. No more chances :)", "author": "bogdandrutu", "createdAt": "2020-02-27T03:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyMTE2Mw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/937#discussion_r385221163", "bodyText": "cool. thanks. Still would love to see an overall design documentation about how this metrics system works, for future us. The code is pretty complex, and documentation will pay dividends in the long run.", "author": "jkwatson", "createdAt": "2020-02-27T16:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMxNg=="}], "type": "inlineReview", "revised_code": {"commit": "694eefaa30a4462c52da856060916071447377b0", "chunk": "diff --git a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\nindex 29a39e02a..69f733e2e 100644\n--- a/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\n+++ b/sdk/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleLastValueAggregator.java\n\n@@ -16,29 +16,23 @@\n \n package io.opentelemetry.sdk.metrics.aggregator;\n \n-import com.google.common.util.concurrent.AtomicDouble;\n import io.opentelemetry.sdk.metrics.data.MetricData.DoublePoint;\n import io.opentelemetry.sdk.metrics.data.MetricData.Point;\n import java.util.Map;\n+import java.util.concurrent.atomic.AtomicReference;\n+import javax.annotation.Nullable;\n \n /**\n  * Aggregator that aggregates recorded values by storing the last recorded value.\n  *\n- * <p>Limitations:\n- *\n- * <ul>\n- *   <li>The current implementation does not store a time when the value was recorded, so merging\n- *       multiple LastValueAggregators will not preserve the ordering of records. This is not a\n- *       problem because LastValueAggregator is currently only available for Observers which record\n- *       all values once.\n- *   <li>The current implementation does not properly reset the current value, it should use a\n- *       {@code null} value instead of 0. This is not a problem because LastValueAggregator is\n- *       currently only available for Observers which do not reuse reset instances.\n- * </ul>\n+ * <p>Limitation: The current implementation does not store a time when the value was recorded, so\n+ * merging multiple LastValueAggregators will not preserve the ordering of records. This is not a\n+ * problem because LastValueAggregator is currently only available for Observers which record all\n+ * values once.\n  */\n public final class DoubleLastValueAggregator extends AbstractAggregator {\n \n-  private static final double DEFAULT_VALUE = 0.0;\n+  @Nullable private static final Double DEFAULT_VALUE = null;\n   private static final AggregatorFactory AGGREGATOR_FACTORY =\n       new AggregatorFactory() {\n         @Override\n"}}, {"oid": "694eefaa30a4462c52da856060916071447377b0", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/694eefaa30a4462c52da856060916071447377b0", "message": "Fix issue when last value aggregation has no records.\n\nSigned-off-by: Bogdan Cristian Drutu <bogdandrutu@gmail.com>", "committedDate": "2020-02-27T03:03:12Z", "type": "commit"}]}