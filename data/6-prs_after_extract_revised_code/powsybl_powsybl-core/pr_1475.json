{"pr_number": 1475, "pr_title": "Fix AMPL conversion of ThreeWindingsTransformer", "pr_createdAt": "2020-09-18T13:29:31Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1475", "timeline": [{"oid": "fe75350ecbec84b789370401ca4509a3e9c630bb", "url": "https://github.com/powsybl/powsybl-core/commit/fe75350ecbec84b789370401ca4509a3e9c630bb", "message": "Fix AMPL reader and writer for ThreeWindingsTransformer.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-18T13:23:25Z", "type": "commit"}, {"oid": "fe75350ecbec84b789370401ca4509a3e9c630bb", "url": "https://github.com/powsybl/powsybl-core/commit/fe75350ecbec84b789370401ca4509a3e9c630bb", "message": "Fix AMPL reader and writer for ThreeWindingsTransformer.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-18T13:23:25Z", "type": "forcePushed"}, {"oid": "394d50619f81e83dcb570d2ee5b15a570441241a", "url": "https://github.com/powsybl/powsybl-core/commit/394d50619f81e83dcb570d2ee5b15a570441241a", "message": "Small fix.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-18T13:37:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTQ0Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r490971447", "bodyText": "2 times LEG3_SUFFIX. I bet the first one is LEG2_SUFFIX, else it is redundant.", "author": "nomont", "createdAt": "2020-09-18T14:02:55Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java", "diffHunk": "@@ -213,19 +213,20 @@ private Void readRatioTapChanger(String[] tokens) {\n         int num = Integer.parseInt(tokens[1]);\n         int tap = Integer.parseInt(tokens[2]);\n         String id = mapper.getId(AmplSubset.RATIO_TAP_CHANGER, num);\n-        if (id.endsWith(AmplConstants.LEG2_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n+        if (id.endsWith(AmplConstants.LEG1_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {", "originalCommit": "fe75350ecbec84b789370401ca4509a3e9c630bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyODc3MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r491028771", "bodyText": "same remark as @nomont", "author": "merkakcha", "createdAt": "2020-09-18T15:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTQ0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "0db2fc57fc4e8865e07f953c7208c66b19b9fc98", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\nindex 81c7ebcfc..cbabfb59c 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n\n@@ -213,7 +213,7 @@ public class AmplNetworkReader {\n         int num = Integer.parseInt(tokens[1]);\n         int tap = Integer.parseInt(tokens[2]);\n         String id = mapper.getId(AmplSubset.RATIO_TAP_CHANGER, num);\n-        if (id.endsWith(AmplConstants.LEG1_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n+        if (id.endsWith(AmplConstants.LEG1_SUFFIX) || id.endsWith(AmplConstants.LEG2_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n             ThreeWindingsTransformer twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG2_SUFFIX)));\n             if (twt == null) {\n                 throw new AmplException(\"Invalid three windings transformer id '\" + id + \"'\");\n"}}, {"oid": "0db2fc57fc4e8865e07f953c7208c66b19b9fc98", "url": "https://github.com/powsybl/powsybl-core/commit/0db2fc57fc4e8865e07f953c7208c66b19b9fc98", "message": "Fix network writer with new phase tap changer objects.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-18T14:29:54Z", "type": "commit"}, {"oid": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "url": "https://github.com/powsybl/powsybl-core/commit/b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "message": "Non linear shunt are considered as one section shunt.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-21T13:42:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzNjQyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492136426", "bodyText": "Maybe log that we only disconnect the shunt but don't do anything else", "author": "MioRtia", "createdAt": "2020-09-21T15:14:55Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java", "diffHunk": "@@ -279,9 +296,13 @@ private Void readShunt(String[] tokens) {\n         }\n \n         if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-            throw new PowsyblException(\"non linear shunt not supported yet\");\n+            // nothing.\n+            if (sections == 0) {\n+                sc.setSectionCount(sections);\n+            } // else nothing.\n+        } else {", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY3OTQ3OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492679478", "bodyText": "Yes okay. Indeed at that stage of the PR, I have converted a non linear shunt as a one section shunt. The AMPL tool has the options: use the shunt as it is or disconnect it. I think that we have to improve the conversion but I am not able to do it by myself.", "author": "annetill", "createdAt": "2020-09-22T12:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzNjQyNg=="}], "type": "inlineReview", "revised_code": {"commit": "af705f5435f9c70ab84fabe5b67ad8a394e7bf40", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\nindex a7916bfc5..926ae6740 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n\n@@ -296,10 +305,13 @@ public class AmplNetworkReader {\n         }\n \n         if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-            // nothing.\n+            // as non linear shunt are considered as one section shunt for the moment\n+            // we update nothing except if the sections is equal to zero. It seems that the\n+            // optimizer has decided to disconnect the shunt.\n+            // TODO improve non linear shunt update.\n             if (sections == 0) {\n                 sc.setSectionCount(sections);\n-            } // else nothing.\n+            }\n         } else {\n             sc.setSectionCount(Math.max(0, Math.min(sc.getMaximumSectionCount(), sections)));\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzNzUyMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492137521", "bodyText": "You can delete these lines (not comment them)", "author": "MioRtia", "createdAt": "2020-09-21T15:15:52Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java", "diffHunk": "@@ -1311,9 +1420,9 @@ private void writeShunts(AmplExportContext context) throws IOException {\n                      new Column(\"sections count\"))) {\n             List<String> skipped = new ArrayList<>();\n             for (ShuntCompensator sc : network.getShuntCompensators()) {\n-                if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n+/*                if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n                     throw new PowsyblException(\"Non linear shunt compensator not yet supported\");\n-                }\n+                }*/", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY3OTY1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492679652", "bodyText": "Ok!", "author": "annetill", "createdAt": "2020-09-22T12:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEzNzUyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "af705f5435f9c70ab84fabe5b67ad8a394e7bf40", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\nindex ef6aa39f7..2b964eba1 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n\n@@ -1420,9 +1420,6 @@ public class AmplNetworkWriter {\n                      new Column(\"sections count\"))) {\n             List<String> skipped = new ArrayList<>();\n             for (ShuntCompensator sc : network.getShuntCompensators()) {\n-/*                if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-                    throw new PowsyblException(\"Non linear shunt compensator not yet supported\");\n-                }*/\n                 Terminal t = sc.getTerminal();\n                 Bus bus = AmplUtil.getBus(t);\n                 String busId = null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5MDIyOA==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492190228", "bodyText": "I'm surprised by the end of this statement: what happen if id endsWith LEG1 or LEG3 ?", "author": "mathbagu", "createdAt": "2020-09-21T16:24:43Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java", "diffHunk": "@@ -249,12 +249,29 @@ private Void readPhaseTapChanger(String[] tokens) {\n         int num = Integer.parseInt(tokens[1]);\n         int tap = Integer.parseInt(tokens[2]);\n         String id = mapper.getId(AmplSubset.PHASE_TAP_CHANGER, num);\n-        TwoWindingsTransformer twt = network.getTwoWindingsTransformer(id);\n-        if (twt == null) {\n-            throw new AmplException(\"Invalid two windings transformer id '\" + id + \"'\");\n+        if (id.endsWith(AmplConstants.LEG1_SUFFIX) || id.endsWith(AmplConstants.LEG2_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n+            ThreeWindingsTransformer twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG2_SUFFIX)));", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MjQ4Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492682482", "bodyText": "I add a test and make a fix. Just tell me if it is okay for you.", "author": "annetill", "createdAt": "2020-09-22T12:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5MDIyOA=="}], "type": "inlineReview", "revised_code": {"commit": "d4c70d5774cc9e5b15568433d69f4a0565d48e8a", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\nindex a7916bfc5..388c7ed7c 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n\n@@ -250,19 +254,23 @@ public class AmplNetworkReader {\n         int tap = Integer.parseInt(tokens[2]);\n         String id = mapper.getId(AmplSubset.PHASE_TAP_CHANGER, num);\n         if (id.endsWith(AmplConstants.LEG1_SUFFIX) || id.endsWith(AmplConstants.LEG2_SUFFIX) || id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n-            ThreeWindingsTransformer twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG2_SUFFIX)));\n-            if (twt == null) {\n-                throw new AmplException(\"Invalid three windings transformer id '\" + id + \"'\");\n-            }\n+            ThreeWindingsTransformer twt = null;\n+            PhaseTapChanger ptc = null;\n             if (id.endsWith(AmplConstants.LEG1_SUFFIX)) {\n-                PhaseTapChanger ptc1 = twt.getLeg1().getPhaseTapChanger();\n-                ptc1.setTapPosition(ptc1.getLowTapPosition() + tap - 1);\n+                twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG1_SUFFIX)));\n+                ptc = twt.getLeg1().getPhaseTapChanger();\n             } else if (id.endsWith(AmplConstants.LEG2_SUFFIX)) {\n-                PhaseTapChanger ptc2 = twt.getLeg2().getPhaseTapChanger();\n-                ptc2.setTapPosition(ptc2.getLowTapPosition() + tap - 1);\n+                twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG2_SUFFIX)));\n+                ptc = twt.getLeg2().getPhaseTapChanger();\n             } else if (id.endsWith(AmplConstants.LEG3_SUFFIX)) {\n-                PhaseTapChanger ptc3 = twt.getLeg3().getPhaseTapChanger();\n-                ptc3.setTapPosition(ptc3.getLowTapPosition() + tap - 1);\n+                twt = network.getThreeWindingsTransformer(id.substring(0, id.indexOf(AmplConstants.LEG3_SUFFIX)));\n+                ptc = twt.getLeg3().getPhaseTapChanger();\n+            }\n+            if (twt == null) {\n+                throw new AmplException(\"Invalid three windings transformer id '\" + id + \"'\");\n+            }\n+            if (ptc != null) {\n+                ptc.setTapPosition(ptc.getLowTapPosition() + tap - 1);\n             }\n         } else {\n             TwoWindingsTransformer twt = network.getTwoWindingsTransformer(id);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5MjIxMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492192212", "bodyText": "Are the // nothing really useful?", "author": "mathbagu", "createdAt": "2020-09-21T16:27:46Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java", "diffHunk": "@@ -279,9 +296,13 @@ private Void readShunt(String[] tokens) {\n         }\n \n         if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-            throw new PowsyblException(\"non linear shunt not supported yet\");\n+            // nothing.\n+            if (sections == 0) {\n+                sc.setSectionCount(sections);\n+            } // else nothing.", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4MjkyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492682926", "bodyText": ":-) I have put a TODO instead. I need help to continue with non linear shunts!", "author": "annetill", "createdAt": "2020-09-22T12:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5MjIxMg=="}], "type": "inlineReview", "revised_code": {"commit": "af705f5435f9c70ab84fabe5b67ad8a394e7bf40", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\nindex a7916bfc5..926ae6740 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkReader.java\n\n@@ -296,10 +305,13 @@ public class AmplNetworkReader {\n         }\n \n         if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-            // nothing.\n+            // as non linear shunt are considered as one section shunt for the moment\n+            // we update nothing except if the sections is equal to zero. It seems that the\n+            // optimizer has decided to disconnect the shunt.\n+            // TODO improve non linear shunt update.\n             if (sections == 0) {\n                 sc.setSectionCount(sections);\n-            } // else nothing.\n+            }\n         } else {\n             sc.setSectionCount(Math.max(0, Math.min(sc.getMaximumSectionCount(), sections)));\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5ODAzMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492198032", "bodyText": "Are you sure that the g2/b2 (resp. g3/b3) are exported at the good side. Looking to the column names, we have: r, x, g1, g2, b1, b2.\nIt seems that the side1 is always a read end, and the side2 is the middleBus, so I agree with your implementation, but I'm not totally confident and want to be sure it's OK", "author": "mathbagu", "createdAt": "2020-09-21T16:36:50Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java", "diffHunk": "@@ -861,13 +877,13 @@ private void writeThreeWindingsTransformers(AmplExportContext context, TableForm\n                         .writeCell(middleVlNum)\n                         .writeCell(r2)\n                         .writeCell(x2)\n+                        .writeCell(g2)\n                         .writeCell(0.0)\n-                        .writeCell(0.0)\n-                        .writeCell(0.0)\n+                        .writeCell(b2)\n                         .writeCell(0.0)", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4NDg2Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492684866", "bodyText": "I think that 1 and 2 are respectively the left side of the serie impedance and the right side of the serie impedance. So, I put everything on the left side (=network side). It is okay for you ?", "author": "annetill", "createdAt": "2020-09-22T12:15:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5ODAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMTYyNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r494411626", "bodyText": "On tuesday, we discuss about it with @MioRtia: if the scheme of the website, I totally agree with your proposal", "author": "mathbagu", "createdAt": "2020-09-24T15:28:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5ODAzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5OTI3OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492199279", "bodyText": "I would move the initialization inside the if block.", "author": "mathbagu", "createdAt": "2020-09-21T16:39:00Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java", "diffHunk": "@@ -1339,12 +1448,23 @@ private void writeShunts(AmplExportContext context) throws IOException {\n                 int vlNum = mapper.getInt(AmplSubset.VOLTAGE_LEVEL, t.getVoltageLevel().getId());\n                 double vb = t.getVoltageLevel().getNominalV();\n                 double zb = vb * vb / AmplConstants.SB;\n-                double b1 = 0;\n-                double b2 = sc.getModel(ShuntCompensatorLinearModel.class).getBPerSection() * sc.getMaximumSectionCount() * zb;\n+                double b1;\n+                double b2;\n+                int points;\n+                int sectionCount = 1;", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4NTAwMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492685002", "bodyText": "Ok!", "author": "annetill", "createdAt": "2020-09-22T12:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE5OTI3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "0c790672825fd01e4187eeab061e19e6b3c2a347", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\nindex ef6aa39f7..0c1e6f97c 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n\n@@ -1448,12 +1448,14 @@ public class AmplNetworkWriter {\n                 int vlNum = mapper.getInt(AmplSubset.VOLTAGE_LEVEL, t.getVoltageLevel().getId());\n                 double vb = t.getVoltageLevel().getNominalV();\n                 double zb = vb * vb / AmplConstants.SB;\n-                double b1;\n+                double b1 = 0;\n                 double b2;\n                 int points;\n                 int sectionCount = 1;\n                 if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-                    b1 = sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections().get(sc.getSectionCount() - 1).getB() * zb;\n+                    if (sc.getSectionCount() > 1) {\n+                        b1 = sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections().get(sc.getSectionCount() - 1).getB() * zb;\n+                    }\n                     b2 = sc.getB() * zb;\n                     points = 0;\n                 } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwMDI1MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492200251", "bodyText": "Why the code is different for the two models: the getMaximumSectionCount is defined in the ShuntCompensator interface, so I guess that points should have the same value.", "author": "mathbagu", "createdAt": "2020-09-21T16:40:39Z", "path": "ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java", "diffHunk": "@@ -1339,12 +1448,23 @@ private void writeShunts(AmplExportContext context) throws IOException {\n                 int vlNum = mapper.getInt(AmplSubset.VOLTAGE_LEVEL, t.getVoltageLevel().getId());\n                 double vb = t.getVoltageLevel().getNominalV();\n                 double zb = vb * vb / AmplConstants.SB;\n-                double b1 = 0;\n-                double b2 = sc.getModel(ShuntCompensatorLinearModel.class).getBPerSection() * sc.getMaximumSectionCount() * zb;\n+                double b1;\n+                double b2;\n+                int points;\n+                int sectionCount = 1;\n+                if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n+                    b1 = sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections().get(sc.getSectionCount() - 1).getB() * zb;\n+                    b2 = sc.getB() * zb;\n+                    points = 0;", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4NTkzMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492685930", "bodyText": "Because at this stage, I am making an approximation for non linear shunts. We have to model non linear shunt as rtc and ptc and I think that we have to introduce a new format in the ampl converter. @MioRtia will help me for that but maybe later.", "author": "annetill", "createdAt": "2020-09-22T12:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwMDI1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "0c790672825fd01e4187eeab061e19e6b3c2a347", "chunk": "diff --git a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\nindex ef6aa39f7..0c1e6f97c 100644\n--- a/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n+++ b/ampl-converter/src/main/java/com/powsybl/ampl/converter/AmplNetworkWriter.java\n\n@@ -1448,12 +1448,14 @@ public class AmplNetworkWriter {\n                 int vlNum = mapper.getInt(AmplSubset.VOLTAGE_LEVEL, t.getVoltageLevel().getId());\n                 double vb = t.getVoltageLevel().getNominalV();\n                 double zb = vb * vb / AmplConstants.SB;\n-                double b1;\n+                double b1 = 0;\n                 double b2;\n                 int points;\n                 int sectionCount = 1;\n                 if (sc.getModelType() == ShuntCompensatorModelType.NON_LINEAR) {\n-                    b1 = sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections().get(sc.getSectionCount() - 1).getB() * zb;\n+                    if (sc.getSectionCount() > 1) {\n+                        b1 = sc.getModel(ShuntCompensatorNonLinearModel.class).getAllSections().get(sc.getSectionCount() - 1).getB() * zb;\n+                    }\n                     b2 = sc.getB() * zb;\n                     points = 0;\n                 } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwMDc5NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492200795", "bodyText": "Is this sufficient to test everything you change in this PR?", "author": "mathbagu", "createdAt": "2020-09-21T16:41:31Z", "path": "ampl-converter/src/test/java/com/powsybl/ampl/converter/AmplNetworkWriterTest.java", "diffHunk": "@@ -101,6 +111,19 @@ public void writeBattery() throws IOException {\n     @Test\n     public void writeThreeWindingsTransformer() throws IOException {\n         Network network = ThreeWindingsTransformerNetworkFactory.createWithCurrentLimits();\n+        network.getThreeWindingsTransformer(\"3WT\").getLeg1()\n+                .newPhaseTapChanger()\n+                .beginStep()\n+                .setRho(1)\n+                .setR(0.1)\n+                .setX(1.)\n+                .setB(0.)\n+                .setG(0.)\n+                .setAlpha(0)\n+                .endStep()\n+                .setTapPosition(0)\n+                .setLowTapPosition(0)\n+                .add();", "originalCommit": "b5fad5c6e060cc0c90eaa7f4f73328b0838cf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY4NjA0Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1475#discussion_r492686043", "bodyText": "no :-)", "author": "annetill", "createdAt": "2020-09-22T12:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwMDc5NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0c790672825fd01e4187eeab061e19e6b3c2a347", "url": "https://github.com/powsybl/powsybl-core/commit/0c790672825fd01e4187eeab061e19e6b3c2a347", "message": "Small fix.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-22T11:12:23Z", "type": "commit"}, {"oid": "af705f5435f9c70ab84fabe5b67ad8a394e7bf40", "url": "https://github.com/powsybl/powsybl-core/commit/af705f5435f9c70ab84fabe5b67ad8a394e7bf40", "message": "* Add unit test.\n* Fixes after review comments.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-22T12:18:59Z", "type": "commit"}, {"oid": "ae047779a7c3ab2bd6ac52b197896c6ba42438b8", "url": "https://github.com/powsybl/powsybl-core/commit/ae047779a7c3ab2bd6ac52b197896c6ba42438b8", "message": "Refactoring.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-23T10:53:16Z", "type": "commit"}, {"oid": "28d2a1d1d200b9632df73391ed5e6385d0221957", "url": "https://github.com/powsybl/powsybl-core/commit/28d2a1d1d200b9632df73391ed5e6385d0221957", "message": "* Add unit tests.\n* Section count is not updated for nonlinear shunt.\n* Fixes.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-24T09:58:00Z", "type": "commit"}, {"oid": "91aa2a40cd2d4c6de1af0a9e79400c777829d67d", "url": "https://github.com/powsybl/powsybl-core/commit/91aa2a40cd2d4c6de1af0a9e79400c777829d67d", "message": "Add methods to get all legs\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-09-24T12:47:12Z", "type": "commit"}, {"oid": "d4c70d5774cc9e5b15568433d69f4a0565d48e8a", "url": "https://github.com/powsybl/powsybl-core/commit/d4c70d5774cc9e5b15568433d69f4a0565d48e8a", "message": "Refactoring.\nSmall fix for current limit side of a three windings transformer.\n\nSigned-off-by: Anne Tilloy <anne.tilloy@rte-france.com>", "committedDate": "2020-09-24T14:38:39Z", "type": "commit"}, {"oid": "d179361d6035dd2b31863b159c8ee1975fb581f3", "url": "https://github.com/powsybl/powsybl-core/commit/d179361d6035dd2b31863b159c8ee1975fb581f3", "message": "Small refactoring\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-09-24T15:55:57Z", "type": "commit"}, {"oid": "318c84dfb992ecdbd5807cd4ca4e98ce12e4580a", "url": "https://github.com/powsybl/powsybl-core/commit/318c84dfb992ecdbd5807cd4ca4e98ce12e4580a", "message": "Increase code coverage\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-09-24T16:28:20Z", "type": "commit"}, {"oid": "9c53389aa332cdcebfdeeda5e585791decdc33a3", "url": "https://github.com/powsybl/powsybl-core/commit/9c53389aa332cdcebfdeeda5e585791decdc33a3", "message": "Refactoring\n\nSigned-off-by: Mathieu BAGUE <mathieu.bague@rte-france.com>", "committedDate": "2020-09-24T18:53:28Z", "type": "commit"}, {"oid": "811276712b88a237646d9fc755936db7b71c96de", "url": "https://github.com/powsybl/powsybl-core/commit/811276712b88a237646d9fc755936db7b71c96de", "message": "Merge branch 'master' into cgmes_switch_at_boundary_to_dangling_line_z0", "committedDate": "2020-09-25T12:57:34Z", "type": "commit"}]}