{"pr_number": 1491, "pr_title": "Prevent x of step to be undefined (NaN) during CGMES import for non tabular ptc", "pr_createdAt": "2020-09-28T14:15:08Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1491", "timeline": [{"oid": "b49590ca955e012aed11df7c79b1670d8ba0a8ef", "url": "https://github.com/powsybl/powsybl-core/commit/b49590ca955e012aed11df7c79b1670d8ba0a8ef", "message": "Prevent x of step to be undefined (NaN) during CGMES import for non tabular ptc\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-09-28T14:12:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTU1Nw==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496059557", "bodyText": "I think the problem is that the X of the transformer is zero. We should not allow transformers with zero reactance. I think is better to fix this problem in the class CgmesT2xModel (Line 35) for twoWindingsTransformer and in the class CgmesT3xModel (Line 43) for threeWindingsTransformers. We can write an invalid warning and fix the X to a residual value (0.0001 by example) or maybe we can throw an exception.", "author": "marqueslanauja", "createdAt": "2020-09-28T15:55:36Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java", "diffHunk": "@@ -142,8 +142,12 @@ private void addStepsAsymmetrical() {\n             return;\n         }\n         double alphaMax = tapChanger.getSteps().stream().map(TapChanger.Step::getAngle)\n-                .mapToDouble(Double::doubleValue).max().orElse(Double.NaN);\n+                .mapToDouble(Double::doubleValue).max().orElse(0);\n         tapChanger.getSteps().forEach(step -> {\n+            if (alphaMax == 0 || xtx == 0) {\n+                step.setX(0);\n+                return;\n+            }", "originalCommit": "b49590ca955e012aed11df7c79b1670d8ba0a8ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MjQ2MQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496062461", "bodyText": "Is it okay for you to put Double.MIN_VALUE? I would rather correct the value than throw an exception (the validation can be modified in another PR)", "author": "miovd", "createdAt": "2020-09-28T15:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MzA4Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496063083", "bodyText": "For clarification, I ran into this exception with alphaMax equals to 0.", "author": "miovd", "createdAt": "2020-09-28T16:00:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MjQxNw==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496092417", "bodyText": "Sorry, then my comment does not make sense. Maybe is better to check only alphaMax\nif (alphaMax == 0) {\n                step.setX(0);\n                return;\n            }", "author": "marqueslanauja", "createdAt": "2020-09-28T16:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTU1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjUzMTUyMA==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496531520", "bodyText": "I did what you suggested", "author": "miovd", "createdAt": "2020-09-29T08:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTU1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "ff2d0531a5fffe485bb0893bcc6e1637c8a6c212", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\nindex 507467a99e..f444b87460 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\n\n@@ -144,7 +144,7 @@ public class CgmesPhaseTapChangerBuilder extends AbstractCgmesTapChangerBuilder\n         double alphaMax = tapChanger.getSteps().stream().map(TapChanger.Step::getAngle)\n                 .mapToDouble(Double::doubleValue).max().orElse(0);\n         tapChanger.getSteps().forEach(step -> {\n-            if (alphaMax == 0 || xtx == 0) {\n+            if (alphaMax == 0) { // all angles are equal to 0: x is considered equal to 0\n                 step.setX(0);\n                 return;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1OTk0Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1491#discussion_r496059942", "bodyText": "Same comment", "author": "marqueslanauja", "createdAt": "2020-09-28T15:56:12Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java", "diffHunk": "@@ -190,8 +194,12 @@ private void stepXforLinearAndSymmetrical() {\n             return;\n         }\n         double alphaMax = tapChanger.getSteps().stream().map(TapChanger.Step::getAngle)\n-            .mapToDouble(Double::doubleValue).max().orElse(Double.NaN);\n+            .mapToDouble(Double::doubleValue).max().orElse(0);\n         tapChanger.getSteps().forEach(step -> {\n+            if (alphaMax == 0.0 || xtx == 0.0) {\n+                step.setX(0);\n+                return;\n+            }", "originalCommit": "b49590ca955e012aed11df7c79b1670d8ba0a8ef", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff2d0531a5fffe485bb0893bcc6e1637c8a6c212", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\nindex 507467a99e..f444b87460 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/transformers/CgmesPhaseTapChangerBuilder.java\n\n@@ -196,7 +196,7 @@ public class CgmesPhaseTapChangerBuilder extends AbstractCgmesTapChangerBuilder\n         double alphaMax = tapChanger.getSteps().stream().map(TapChanger.Step::getAngle)\n             .mapToDouble(Double::doubleValue).max().orElse(0);\n         tapChanger.getSteps().forEach(step -> {\n-            if (alphaMax == 0.0 || xtx == 0.0) {\n+            if (alphaMax == 0.0) { // all angles are equal to 0: x is considered equal to 0\n                 step.setX(0);\n                 return;\n             }\n"}}, {"oid": "ff2d0531a5fffe485bb0893bcc6e1637c8a6c212", "url": "https://github.com/powsybl/powsybl-core/commit/ff2d0531a5fffe485bb0893bcc6e1637c8a6c212", "message": "Only check alphaMax + add comments\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-09-29T08:31:30Z", "type": "commit"}]}