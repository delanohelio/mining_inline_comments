{"pr_number": 1263, "pr_title": "merging inconsistent tie-line element names", "pr_createdAt": "2020-04-06T15:31:23Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1263", "timeline": [{"oid": "d3e6b23c417b51bf1ea6c6b85da1e063416b84d9", "url": "https://github.com/powsybl/powsybl-core/commit/d3e6b23c417b51bf1ea6c6b85da1e063416b84d9", "message": "merging inconsistent tie-line element names\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-06T15:29:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MTc0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r404641746", "bodyText": "Replace String.format by a simple concatenation (performance issue)", "author": "mathbagu", "createdAt": "2020-04-07T08:47:17Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java", "diffHunk": "@@ -1013,7 +1015,11 @@ private void mergeProperties(DanglingLine dl1, DanglingLine dl2, Properties prop\n                 LOGGER.warn(\"Inconsistencies of property '{}' between both sides of merged line. Side 2 is empty, keeping side 1 value '{}'\", prop, dl1.getProperty(prop));\n                 properties.setProperty(prop, dl1.getProperty(prop));\n             } else {\n-                LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n+                if (!prop.equals(ELEMENT_NAME_PROPERTY)) {\n+                    LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n+                } else {\n+                    properties.setProperty(prop, String.format(\"%s,%s\", dl1.getProperty(prop), dl2.getProperty(prop)));", "originalCommit": "d3e6b23c417b51bf1ea6c6b85da1e063416b84d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68be4dbfdffc24aa5ae21dee029486b7b46ac0be", "chunk": "diff --git a/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java b/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\nindex 584ad09cf..1e7a57b4f 100644\n--- a/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\n+++ b/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\n\n@@ -1018,7 +1019,7 @@ class NetworkImpl extends AbstractIdentifiable<Network> implements Network, Vari\n                 if (!prop.equals(ELEMENT_NAME_PROPERTY)) {\n                     LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n                 } else {\n-                    properties.setProperty(prop, String.format(\"%s,%s\", dl1.getProperty(prop), dl2.getProperty(prop)));\n+                    properties.setProperty(prop, dl1.getProperty(prop) + PROPERTY_SEPARATOR + dl2.getProperty(prop));\n                 }\n             }\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MzI2OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r404643269", "bodyText": "I'm not sure we should make a specific case for element names. Maybe we should decide the strategy, and apply it to all properties.\n@murgeyseb What do you think?", "author": "mathbagu", "createdAt": "2020-04-07T08:49:42Z", "path": "iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java", "diffHunk": "@@ -1013,7 +1015,11 @@ private void mergeProperties(DanglingLine dl1, DanglingLine dl2, Properties prop\n                 LOGGER.warn(\"Inconsistencies of property '{}' between both sides of merged line. Side 2 is empty, keeping side 1 value '{}'\", prop, dl1.getProperty(prop));\n                 properties.setProperty(prop, dl1.getProperty(prop));\n             } else {\n-                LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n+                if (!prop.equals(ELEMENT_NAME_PROPERTY)) {\n+                    LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n+                } else {\n+                    properties.setProperty(prop, String.format(\"%s,%s\", dl1.getProperty(prop), dl2.getProperty(prop)));\n+                }", "originalCommit": "d3e6b23c417b51bf1ea6c6b85da1e063416b84d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIwNjA1MA==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r406206050", "bodyText": "Yes, I think we could keep the same behaviour for Element name, and change the parsing of the property in the exporter to create a unique element name if needed, using the same strategy as before (if equals use it, if one empty use the other, otherwise no element name)", "author": "murgeyseb", "createdAt": "2020-04-09T13:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MzI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIxNzQwMQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r406217401", "bodyText": "But if we don't make a specific case for element names this strategy of concatenating the two  side's property will impcact all types of property. for example the geographical name it will create other problems. Should i delete this condition here ? but make another one in exporter saying if geographival name contains the separator \",\" --> don't export it", "author": "benrejebmoh", "createdAt": "2020-04-09T13:48:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0MzI2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "68be4dbfdffc24aa5ae21dee029486b7b46ac0be", "chunk": "diff --git a/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java b/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\nindex 584ad09cf..1e7a57b4f 100644\n--- a/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\n+++ b/iidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java\n\n@@ -1018,7 +1019,7 @@ class NetworkImpl extends AbstractIdentifiable<Network> implements Network, Vari\n                 if (!prop.equals(ELEMENT_NAME_PROPERTY)) {\n                     LOGGER.error(\"Inconsistencies of property '{}' between both sides of merged line. '{}' on side 1 and '{}' on side 2. Removing the property of merged line\", prop, dl1.getProperty(prop), dl2.getProperty(prop));\n                 } else {\n-                    properties.setProperty(prop, String.format(\"%s,%s\", dl1.getProperty(prop), dl2.getProperty(prop)));\n+                    properties.setProperty(prop, dl1.getProperty(prop) + PROPERTY_SEPARATOR + dl2.getProperty(prop));\n                 }\n             }\n         });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY0Mzk1Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r404643952", "bodyText": "The property separator should be a constant, just in case this is not well chosen and we have to change it.", "author": "mathbagu", "createdAt": "2020-04-07T08:50:50Z", "path": "ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java", "diffHunk": "@@ -475,10 +475,17 @@ private static void convertTieLine(UcteNetwork ucteNetwork, TieLine tieLine, Uct\n         // FIXME(mathbagu) REAL or EQUIVALENT ?\n         UcteElementStatus status = tieLine.getTerminal1().isConnected() && tieLine.getTerminal2().isConnected() ? EQUIVALENT_ELEMENT_IN_OPERATION : EQUIVALENT_ELEMENT_OUT_OF_OPERATION;\n \n+        String elementName = tieLine.getProperty(ELEMENT_NAME_PROPERTY_KEY, null);\n+        String elementName1 = elementName;\n+        String elementName2 = elementName;\n+        if (elementName != null && elementName.contains(\",\")) {\n+            elementName1 = elementName.split(\",\")[0];\n+            elementName2 = elementName.split(\",\")[1];\n+        }", "originalCommit": "d3e6b23c417b51bf1ea6c6b85da1e063416b84d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68be4dbfdffc24aa5ae21dee029486b7b46ac0be", "chunk": "diff --git a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\nindex 46514b9e4..ca0a6467b 100644\n--- a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n+++ b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n\n@@ -479,8 +481,8 @@ public class UcteExporter implements Exporter {\n         String elementName1 = elementName;\n         String elementName2 = elementName;\n         if (elementName != null && elementName.contains(\",\")) {\n-            elementName1 = elementName.split(\",\")[0];\n-            elementName2 = elementName.split(\",\")[1];\n+            elementName1 = elementName.split(PROPERTY_SEPARATOR)[0];\n+            elementName2 = elementName.split(PROPERTY_SEPARATOR)[1];\n         }\n \n         // Create half line 1\n"}}, {"oid": "68be4dbfdffc24aa5ae21dee029486b7b46ac0be", "url": "https://github.com/powsybl/powsybl-core/commit/68be4dbfdffc24aa5ae21dee029486b7b46ac0be", "message": "using properties separator as constant and changing String.format by simple concatenation\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-07T13:21:09Z", "type": "commit"}, {"oid": "a2d059e1a6808e72c8106854eff4807b4aaa7894", "url": "https://github.com/powsybl/powsybl-core/commit/a2d059e1a6808e72c8106854eff4807b4aaa7894", "message": "changing strategy of mergingProperties\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-10T15:20:07Z", "type": "commit"}, {"oid": "8c55d37758cb8260e23bc24ae48a3dfb9a268165", "url": "https://github.com/powsybl/powsybl-core/commit/8c55d37758cb8260e23bc24ae48a3dfb9a268165", "message": "Merge branch 'master' into tieline-element-name\n\n# Conflicts:\n#\tiidm/iidm-impl/src/main/java/com/powsybl/iidm/network/impl/NetworkImpl.java", "committedDate": "2020-04-10T15:36:58Z", "type": "commit"}, {"oid": "7e93bcbea4a600cdc13028b64bf81242a2ae0802", "url": "https://github.com/powsybl/powsybl-core/commit/7e93bcbea4a600cdc13028b64bf81242a2ae0802", "message": "merging inconsistent tie-line element names\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-15T08:42:44Z", "type": "commit"}, {"oid": "abbd36291a19f83174edc5a051d96be49e4909f0", "url": "https://github.com/powsybl/powsybl-core/commit/abbd36291a19f83174edc5a051d96be49e4909f0", "message": "changing strategy of mergingProperties\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-15T08:44:29Z", "type": "commit"}, {"oid": "09c8428d5bacadb613df1d0b69a5b0ca69d03459", "url": "https://github.com/powsybl/powsybl-core/commit/09c8428d5bacadb613df1d0b69a5b0ca69d03459", "message": "Revert \"changing strategy of mergingProperties\"\n\nThis reverts commit abbd3629\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-15T08:56:30Z", "type": "commit"}, {"oid": "f55f9a636fa27160a97452d130ff5b72548d488a", "url": "https://github.com/powsybl/powsybl-core/commit/f55f9a636fa27160a97452d130ff5b72548d488a", "message": "changing strategy of mergingProperties after review\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-15T18:46:28Z", "type": "commit"}, {"oid": "bb4bdf1665a42eea6d8a544ea193c81e86f2ba9b", "url": "https://github.com/powsybl/powsybl-core/commit/bb4bdf1665a42eea6d8a544ea193c81e86f2ba9b", "message": "removing null default value when getting geographical name property\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-15T19:23:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1MDY3OQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r410050679", "bodyText": "Could you please complete the description of the PR and adapt the unit-test, to be sure this fix works properly. In the description, you mention you want to change the elementName of the tieLines, but you never mention the geographical name of the XNode.", "author": "mathbagu", "createdAt": "2020-04-17T07:47:51Z", "path": "ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java", "diffHunk": "@@ -307,8 +309,8 @@ private static void convertXNode(UcteNetwork ucteNetwork, MergedXnode mergedXnod\n      */\n     private static void convertXNode(UcteNetwork ucteNetwork, TieLine tieLine, UcteExporterContext context) {\n         UcteNodeCode xnodeCode = context.getNamingStrategy().getUcteNodeCode(tieLine.getUcteXnodeCode());\n+        mergeGeographicalNameProperties(tieLine);", "originalCommit": "bb4bdf1665a42eea6d8a544ea193c81e86f2ba9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd8099900989d4eb17b5e86e2c407f612520b3d6", "chunk": "diff --git a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\nindex 2cb39a77e..fa29640a3 100644\n--- a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n+++ b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n\n@@ -309,8 +307,8 @@ public class UcteExporter implements Exporter {\n      */\n     private static void convertXNode(UcteNetwork ucteNetwork, TieLine tieLine, UcteExporterContext context) {\n         UcteNodeCode xnodeCode = context.getNamingStrategy().getUcteNodeCode(tieLine.getUcteXnodeCode());\n-        mergeGeographicalNameProperties(tieLine);\n         String geographicalName = tieLine.getProperty(GEOGRAPHICAL_NAME_PROPERTY_KEY, \"\");\n+\n         convertXNode(ucteNetwork, xnodeCode, geographicalName);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1ODM4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1263#discussion_r410058386", "bodyText": "This is not necessary: empty is a good enough to be serialized.", "author": "mathbagu", "createdAt": "2020-04-17T08:03:07Z", "path": "ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java", "diffHunk": "@@ -478,10 +502,23 @@ private static void convertTieLine(UcteNetwork ucteNetwork, TieLine tieLine, Uct\n         // FIXME(mathbagu) REAL or EQUIVALENT ?\n         UcteElementStatus status = tieLine.getTerminal1().isConnected() && tieLine.getTerminal2().isConnected() ? EQUIVALENT_ELEMENT_IN_OPERATION : EQUIVALENT_ELEMENT_OUT_OF_OPERATION;\n \n+        String elementName = tieLine.getProperty(ELEMENT_NAME_PROPERTY_KEY, null);\n+        String elementName1 = elementName;\n+        String elementName2 = elementName;\n+        if (elementName != null && elementName.contains(PROPERTY_SEPARATOR)) {\n+            elementName1 = elementName.split(PROPERTY_SEPARATOR, -1)[0];\n+            if (elementName1.isEmpty()) {\n+                elementName1 = null;\n+            }", "originalCommit": "bb4bdf1665a42eea6d8a544ea193c81e86f2ba9b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bd8099900989d4eb17b5e86e2c407f612520b3d6", "chunk": "diff --git a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\nindex 2cb39a77e..fa29640a3 100644\n--- a/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n+++ b/ucte/ucte-converter/src/main/java/com/powsybl/ucte/converter/UcteExporter.java\n\n@@ -502,23 +478,10 @@ public class UcteExporter implements Exporter {\n         // FIXME(mathbagu) REAL or EQUIVALENT ?\n         UcteElementStatus status = tieLine.getTerminal1().isConnected() && tieLine.getTerminal2().isConnected() ? EQUIVALENT_ELEMENT_IN_OPERATION : EQUIVALENT_ELEMENT_OUT_OF_OPERATION;\n \n-        String elementName = tieLine.getProperty(ELEMENT_NAME_PROPERTY_KEY, null);\n-        String elementName1 = elementName;\n-        String elementName2 = elementName;\n-        if (elementName != null && elementName.contains(PROPERTY_SEPARATOR)) {\n-            elementName1 = elementName.split(PROPERTY_SEPARATOR, -1)[0];\n-            if (elementName1.isEmpty()) {\n-                elementName1 = null;\n-            }\n-            elementName2 = elementName.split(PROPERTY_SEPARATOR, -1)[1];\n-            if (elementName2.isEmpty()) {\n-                elementName2 = null;\n-            }\n-        }\n-\n         // Create half line 1\n         TieLine.HalfLine half1 = tieLine.getHalf1();\n         UcteElementId ucteElementId1 = context.getNamingStrategy().getUcteElementId(half1.getId());\n+        String elementName1 = tieLine.getProperty(ELEMENT_NAME_PROPERTY_KEY + \"_1\", null);\n         UcteLine ucteLine1 = new UcteLine(\n                 ucteElementId1,\n                 status,\n"}}, {"oid": "623469370990ae6b698e577f633e1c43fb2049c9", "url": "https://github.com/powsybl/powsybl-core/commit/623469370990ae6b698e577f633e1c43fb2049c9", "message": "Merge branch 'master' into tieline-element-name", "committedDate": "2020-04-21T11:18:08Z", "type": "commit"}, {"oid": "bd8099900989d4eb17b5e86e2c407f612520b3d6", "url": "https://github.com/powsybl/powsybl-core/commit/bd8099900989d4eb17b5e86e2c407f612520b3d6", "message": "adding tieline properties with suffix to be usied in ucte export, and adding test case illustration possible use cases\n\nSigned-off-by: benrejebmoh <mohamed.ben-rejeb@rte-france.com>", "committedDate": "2020-04-21T15:59:20Z", "type": "commit"}, {"oid": "370163b9d2eb23e9cdf02c13aabb047427538753", "url": "https://github.com/powsybl/powsybl-core/commit/370163b9d2eb23e9cdf02c13aabb047427538753", "message": "Merge branch 'master' into tieline-element-name", "committedDate": "2020-04-23T13:59:46Z", "type": "commit"}, {"oid": "715bc3dff87e4243a650e61dc3f30af6b9b84a41", "url": "https://github.com/powsybl/powsybl-core/commit/715bc3dff87e4243a650e61dc3f30af6b9b84a41", "message": "Merge branch 'master' into tieline-element-name", "committedDate": "2020-04-23T14:44:05Z", "type": "commit"}, {"oid": "eacbc2053bab986f66852d5850f2260927cf11c2", "url": "https://github.com/powsybl/powsybl-core/commit/eacbc2053bab986f66852d5850f2260927cf11c2", "message": "Merge branch 'master' into tieline-element-name", "committedDate": "2020-04-27T08:44:57Z", "type": "commit"}]}