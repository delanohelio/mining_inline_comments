{"pr_number": 1233, "pr_title": "Add nodeBreakerView.hasAttachedEquipment(node) method + Ensure an IIDM node number is valid before trying to use it in CGMES conversion", "pr_createdAt": "2020-03-18T17:33:27Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1233", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0NjAzNg==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r396346036", "bodyText": "Not related to this PR, but this TODO could be removed.", "author": "mathbagu", "createdAt": "2020-03-23T10:24:10Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java", "diffHunk": "@@ -68,34 +69,34 @@ private VoltageLevel newBoundarySubstationVoltageLevel() {\n         String substationName = \"boundary\";\n         String vlName = \"boundary\";\n         return context.network()\n-                .newSubstation()\n-                .setId(context.namingStrategy().getId(\"Substation\", substationId))\n-                .setName(substationName)\n-                // TODO(mathbagu): Country should be optional. This will be done in another PR.\n-                // A non-null country code must be set\n-                // This is an arbitrary country code, Bangladesh code BD also matches with\n-                // BounDary\n-                .setCountry(boundaryCountryCode())\n-                .add()\n-                .newVoltageLevel()\n-                .setId(context.namingStrategy().getId(\"VoltageLevel\", vlId))\n-                .setName(vlName)\n-                .setNominalV(nominalVoltage)\n-                .setTopologyKind(context.nodeBreaker() ? TopologyKind.NODE_BREAKER : TopologyKind.BUS_BREAKER)\n-                .add();\n+            .newSubstation()\n+            .setId(context.namingStrategy().getId(\"Substation\", substationId))\n+            .setName(substationName)\n+            // TODO(mathbagu): Country should be optional. This will be done in another PR.\n+            // A non-null country code must be set\n+            // This is an arbitrary country code, Bangladesh code BD also matches with\n+            // BounDary", "originalCommit": "78e566a1709c4d16801bfd9858b95cb2501e83a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "adea2815fde8320896fc6bd093d1c23b89f074ec", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\nindex 96daa8e0a..d4f4497ed 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n\n@@ -72,10 +71,6 @@ public class NodeConversion extends AbstractIdentifiedObjectConversion {\n             .newSubstation()\n             .setId(context.namingStrategy().getId(\"Substation\", substationId))\n             .setName(substationName)\n-            // TODO(mathbagu): Country should be optional. This will be done in another PR.\n-            // A non-null country code must be set\n-            // This is an arbitrary country code, Bangladesh code BD also matches with\n-            // BounDary\n             .setCountry(boundaryCountryCode())\n             .add()\n             .newVoltageLevel()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODIxOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r396348219", "bodyText": "Not related to this PR, but CalculatedBus and ConfiguredBus are implementation specific and should not appear in this message", "author": "mathbagu", "createdAt": "2020-03-23T10:27:47Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java", "diffHunk": "@@ -186,12 +191,19 @@ public void setVoltageAngleNodeBreaker() {\n                 return;\n             }\n             LOG.warn(\n-                    \"Can't find a calculated Bus to set Voltage, Angle, but found a configured Bus {}. Connectivity node {}\",\n-                    bus, id);\n+                \"Can't find a calculated Bus to set Voltage, Angle, but found a configured Bus {}. Connectivity node {}\",", "originalCommit": "78e566a1709c4d16801bfd9858b95cb2501e83a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyNTE3Mg==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r399125172", "bodyText": "What error message do you suggest?", "author": "miovd", "createdAt": "2020-03-27T09:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODIxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk3NjU2OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r399976568", "bodyText": "Somethink like that:\n\nCan't find a bus from the Bus View to set Voltage and Angle, we use the bus {} from the Bus/Breaker view. Connectivity node {}", "author": "mathbagu", "createdAt": "2020-03-30T07:23:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM0ODIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "adea2815fde8320896fc6bd093d1c23b89f074ec", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\nindex 96daa8e0a..d4f4497ed 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n\n@@ -197,13 +190,6 @@ public class NodeConversion extends AbstractIdentifiedObjectConversion {\n         setVoltageAngle(bus);\n     }\n \n-    private boolean iidmNodeIsValid(VoltageLevel.NodeBreakerView topo, int iidmNode) {\n-        // A node is valid only if it has some equipment attached\n-        // The list of valid nodes is obtained from the node-breaker view\n-        // We assume the returned list is sorted\n-        return Arrays.binarySearch(topo.getNodes(), iidmNode) >= 0;\n-    }\n-\n     private VoltageLevel voltageLevel() {\n         if (insideBoundary() && context.config().convertBoundary()) {\n             return context.network().getVoltageLevel(Context.boundaryVoltageLevelId(this.id));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM1MjIyMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r396352222", "bodyText": "Not sure we should assume that, or we should update the documentation.\nAnyway, is it the best way to check if a terminal is associated to this node: maybe we should add a convenient method to get an Optional<Terminal> from a node?", "author": "mathbagu", "createdAt": "2020-03-23T10:34:08Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java", "diffHunk": "@@ -186,12 +191,19 @@ public void setVoltageAngleNodeBreaker() {\n                 return;\n             }\n             LOG.warn(\n-                    \"Can't find a calculated Bus to set Voltage, Angle, but found a configured Bus {}. Connectivity node {}\",\n-                    bus, id);\n+                \"Can't find a calculated Bus to set Voltage, Angle, but found a configured Bus {}. Connectivity node {}\",\n+                bus, id);\n         }\n         setVoltageAngle(bus);\n     }\n \n+    private boolean iidmNodeIsValid(VoltageLevel.NodeBreakerView topo, int iidmNode) {\n+        // A node is valid only if it has some equipment attached\n+        // The list of valid nodes is obtained from the node-breaker view\n+        // We assume the returned list is sorted", "originalCommit": "78e566a1709c4d16801bfd9858b95cb2501e83a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyNTE0NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r399125145", "bodyText": "It is not enough because a node is still valid if an internal connection or a switch is attached to it (with no terminal)... I added a convenient method to check if there is any equipment attached to the node at NodeBreakerView level to delete this method.", "author": "miovd", "createdAt": "2020-03-27T09:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjM1MjIyMg=="}], "type": "inlineReview", "revised_code": {"commit": "adea2815fde8320896fc6bd093d1c23b89f074ec", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\nindex 96daa8e0a..d4f4497ed 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n\n@@ -197,13 +190,6 @@ public class NodeConversion extends AbstractIdentifiedObjectConversion {\n         setVoltageAngle(bus);\n     }\n \n-    private boolean iidmNodeIsValid(VoltageLevel.NodeBreakerView topo, int iidmNode) {\n-        // A node is valid only if it has some equipment attached\n-        // The list of valid nodes is obtained from the node-breaker view\n-        // We assume the returned list is sorted\n-        return Arrays.binarySearch(topo.getNodes(), iidmNode) >= 0;\n-    }\n-\n     private VoltageLevel voltageLevel() {\n         if (insideBoundary() && context.config().convertBoundary()) {\n             return context.network().getVoltageLevel(Context.boundaryVoltageLevelId(this.id));\n"}}, {"oid": "adea2815fde8320896fc6bd093d1c23b89f074ec", "url": "https://github.com/powsybl/powsybl-core/commit/adea2815fde8320896fc6bd093d1c23b89f074ec", "message": "Use hasAttachedEquipment for CGMES node conversion\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-27T09:11:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk3Njg4OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1233#discussion_r399976888", "bodyText": "@zamarrenolm you should configure your IDE to set to 8 spaces the continuous indentation.", "author": "mathbagu", "createdAt": "2020-03-30T07:24:32Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java", "diffHunk": "@@ -68,34 +68,30 @@ private VoltageLevel newBoundarySubstationVoltageLevel() {\n         String substationName = \"boundary\";\n         String vlName = \"boundary\";\n         return context.network()\n-                .newSubstation()\n-                .setId(context.namingStrategy().getId(\"Substation\", substationId))\n-                .setName(substationName)\n-                // TODO(mathbagu): Country should be optional. This will be done in another PR.\n-                // A non-null country code must be set\n-                // This is an arbitrary country code, Bangladesh code BD also matches with\n-                // BounDary\n-                .setCountry(boundaryCountryCode())\n-                .add()\n-                .newVoltageLevel()\n-                .setId(context.namingStrategy().getId(\"VoltageLevel\", vlId))\n-                .setName(vlName)\n-                .setNominalV(nominalVoltage)\n-                .setTopologyKind(context.nodeBreaker() ? TopologyKind.NODE_BREAKER : TopologyKind.BUS_BREAKER)\n-                .add();", "originalCommit": "adea2815fde8320896fc6bd093d1c23b89f074ec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "14f1f3d2576b02b8af7d3c6ec3cc1127cfd37522", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\nindex d4f4497ed..32a85ffc6 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/elements/NodeConversion.java\n\n@@ -71,6 +72,10 @@ public class NodeConversion extends AbstractIdentifiedObjectConversion {\n             .newSubstation()\n             .setId(context.namingStrategy().getId(\"Substation\", substationId))\n             .setName(substationName)\n+            // TODO(mathbagu): Country should be optional. This will be done in another PR.\n+            // A non-null country code must be set\n+            // This is an arbitrary country code, Bangladesh code BD also matches with\n+            // BounDary\n             .setCountry(boundaryCountryCode())\n             .add()\n             .newVoltageLevel()\n"}}, {"oid": "14f1f3d2576b02b8af7d3c6ec3cc1127cfd37522", "url": "https://github.com/powsybl/powsybl-core/commit/14f1f3d2576b02b8af7d3c6ec3cc1127cfd37522", "message": "Ensure an IIDM node number is valid before trying to use it\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2020-03-31T12:43:20Z", "type": "commit"}, {"oid": "ae0087d592267c31f811ce67ec4c22879014bee5", "url": "https://github.com/powsybl/powsybl-core/commit/ae0087d592267c31f811ce67ec4c22879014bee5", "message": "Add convenient method NodeBreakerView.hasAttachedEquipment() + implementations\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-31T12:43:20Z", "type": "commit"}, {"oid": "35b7dffe9d815ea43698f4843e33164ce720812d", "url": "https://github.com/powsybl/powsybl-core/commit/35b7dffe9d815ea43698f4843e33164ce720812d", "message": "Use hasAttachedEquipment for CGMES node conversion\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-31T12:43:20Z", "type": "commit"}, {"oid": "9ea56a5d33b386ede1703aad65d3bbc26d08e666", "url": "https://github.com/powsybl/powsybl-core/commit/9ea56a5d33b386ede1703aad65d3bbc26d08e666", "message": "Change log warning\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-31T12:43:20Z", "type": "commit"}, {"oid": "9ea56a5d33b386ede1703aad65d3bbc26d08e666", "url": "https://github.com/powsybl/powsybl-core/commit/9ea56a5d33b386ede1703aad65d3bbc26d08e666", "message": "Change log warning\n\nSigned-off-by: RALAMBOTIANA MIORA <miora.ralambotiana@rte-france.com>", "committedDate": "2020-03-31T12:43:20Z", "type": "forcePushed"}, {"oid": "baf815090993b6bc612cf44bedc5fe9303b14fc2", "url": "https://github.com/powsybl/powsybl-core/commit/baf815090993b6bc612cf44bedc5fe9303b14fc2", "message": "Merge branch 'master' into cgmes_conversion_ensure_valid_iidm_node", "committedDate": "2020-04-02T07:41:57Z", "type": "commit"}]}