{"pr_number": 1098, "pr_title": "Cgmes update simple update chlog index", "pr_createdAt": "2020-01-02T15:18:17Z", "pr_url": "https://github.com/powsybl/powsybl-core/pull/1098", "timeline": [{"oid": "39f6e27e906511c7ef3c5805103c3c654320021c", "url": "https://github.com/powsybl/powsybl-core/commit/39f6e27e906511c7ef3c5805103c3c654320021c", "message": "Add test for changes log right order\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-02T14:41:05Z", "type": "commit"}, {"oid": "834a2efbd25beea038ebdfc98c33b8158d685c29", "url": "https://github.com/powsybl/powsybl-core/commit/834a2efbd25beea038ebdfc98c33b8158d685c29", "message": "simplify verification that a list of changes is sorted\n\nSigned-off-by: Luma Zamarren\u0303o <zamarrenolm@aia.es>", "committedDate": "2020-01-02T15:00:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI2ODc3OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365268778", "bodyText": "If the order is important, maybe we should use a TreeSet, with a comparator on the index?", "author": "mathbagu", "createdAt": "2020-01-10T14:48:50Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/Changelog.java", "diffHunk": "@@ -80,11 +81,13 @@ public void onVariantCreated(String sourceVariantId, String targetVariantId) {\n \n     public List<IidmChange> getChangesForVariant(String variantId) {\n         if (!changesByVariant.containsKey(variantId)) {\n+            // If we only have baseChanges we assume they are already ordered\n             return Collections.unmodifiableList(baseChanges);\n         } else {\n             List<IidmChange> cs = new ArrayList<>(baseChanges.size() + changesByVariant.size());\n             cs.addAll(baseChanges);\n             cs.addAll(changesByVariant.get(variantId));\n+            cs.sort(Comparator.comparing(IidmChange::getIndex));", "originalCommit": "834a2efbd25beea038ebdfc98c33b8158d685c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDk1NQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365800955", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-01-13T13:24:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI2ODc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/Changelog.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/Changelog.java\nindex fd03026fc2..8bf2bd5487 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/Changelog.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/Changelog.java\n\n@@ -84,11 +86,11 @@ public class Changelog implements NetworkListener {\n             // If we only have baseChanges we assume they are already ordered\n             return Collections.unmodifiableList(baseChanges);\n         } else {\n-            List<IidmChange> cs = new ArrayList<>(baseChanges.size() + changesByVariant.size());\n-            cs.addAll(baseChanges);\n-            cs.addAll(changesByVariant.get(variantId));\n-            cs.sort(Comparator.comparing(IidmChange::getIndex));\n-            return Collections.unmodifiableList(cs);\n+            SortedSet<IidmChange> ss = Collections.synchronizedSortedSet(new TreeSet<>(\n+                Comparator.comparing(IidmChange::getIndex)));\n+            ss.addAll(baseChanges);\n+            ss.addAll(changesByVariant.get(variantId));\n+            return new ArrayList<IidmChange>(Collections.unmodifiableCollection(ss));\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI2ODk3Mw==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365268973", "bodyText": "Should be declared as final", "author": "mathbagu", "createdAt": "2020-01-10T14:49:14Z", "path": "cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/IidmChange.java", "diffHunk": "@@ -18,11 +19,18 @@\n \n     public IidmChange(Identifiable identifiable) {\n         this.identifiable = Objects.requireNonNull(identifiable);\n+        this.index = counter.getAndIncrement();\n     }\n \n     public Identifiable getIdentifiable() {\n         return identifiable;\n     }\n \n+    public int getIndex() {\n+        return index;\n+    }\n+\n     private final Identifiable identifiable;\n+    private final int index;\n+    private static AtomicInteger counter = new AtomicInteger();", "originalCommit": "834a2efbd25beea038ebdfc98c33b8158d685c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMjQ1OA==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365802458", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-01-13T13:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI2ODk3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "chunk": "diff --git a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/IidmChange.java b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/IidmChange.java\nindex 4e7ad512c7..426f00955c 100644\n--- a/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/IidmChange.java\n+++ b/cgmes/cgmes-conversion/src/main/java/com/powsybl/cgmes/conversion/update/IidmChange.java\n\n@@ -19,7 +19,7 @@ public class IidmChange {\n \n     public IidmChange(Identifiable identifiable) {\n         this.identifiable = Objects.requireNonNull(identifiable);\n-        this.index = counter.getAndIncrement();\n+        this.index = COUNTER.getAndIncrement();\n     }\n \n     public Identifiable getIdentifiable() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI3MDg3NA==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365270874", "bodyText": "Use a stream: it's more modern:\nreturn changes.stream().filter(IidmChangeRemoval.class::isInstance).collect(Collectors.toList());", "author": "mathbagu", "createdAt": "2020-01-10T14:53:11Z", "path": "cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogCreationRemovalTest.java", "diffHunk": "@@ -85,15 +86,15 @@ public void testChangelogRemove() {\n         return actual;\n     }\n \n-    private int sizeIgnoreUpdateOnRemoval(List<IidmChange> changes) {\n-        int count = 0;\n+    private List<IidmChange> ignoreUpdateOnRemoval(List<IidmChange> changes) {\n+        List<IidmChange> list = new ArrayList<>();\n         for (IidmChange i : changes) {\n             if (!(i instanceof IidmChangeRemoval)) {\n                 continue;\n             }\n-            count++;\n+            list.add(i);\n         }\n-        return count;\n+        return list;", "originalCommit": "834a2efbd25beea038ebdfc98c33b8158d685c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMTA0Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365801046", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-01-13T13:25:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI3MDg3NA=="}], "type": "inlineReview", "revised_code": {"commit": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "chunk": "diff --git a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogCreationRemovalTest.java b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogCreationRemovalTest.java\nindex 76dd7bd071..427aed0955 100644\n--- a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogCreationRemovalTest.java\n+++ b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogCreationRemovalTest.java\n\n@@ -86,18 +86,11 @@ public final class ChangelogCreationRemovalTest {\n         return actual;\n     }\n \n-    private List<IidmChange> ignoreUpdateOnRemoval(List<IidmChange> changes) {\n-        List<IidmChange> list = new ArrayList<>();\n-        for (IidmChange i : changes) {\n-            if (!(i instanceof IidmChangeRemoval)) {\n-                continue;\n-            }\n-            list.add(i);\n-        }\n-        return list;\n+    private static List<IidmChange> ignoreUpdateOnRemoval(List<IidmChange> changes) {\n+        return changes.stream().filter(IidmChangeRemoval.class::isInstance).collect(Collectors.toList());\n     }\n \n-    private void makeCreateChanges(Network network) {\n+    private static void makeCreateChanges(Network network) {\n         Substation substation = network.getSubstation(\"substation\");\n         substation.newTwoWindingsTransformer()\n             .setId(\"twt\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI3MTIwNQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365271205", "bodyText": "Do you wan simply to check if the list is empty?", "author": "mathbagu", "createdAt": "2020-01-10T14:53:55Z", "path": "cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java", "diffHunk": "@@ -104,6 +107,32 @@ public void testCloneVariantVariantSpecificChanges() {\n         assertTrue(changesVariant1b.size() == changesVariant1.size());\n     }\n \n+    @Test\n+    public void testChangesLogRightOrder() {\n+        String variant1 = network.getVariantManager().getWorkingVariantId();\n+        // Make changes, on Variant and base.\n+        makeNetworkChangesVariantSpecific(network);\n+        makeRemoveChanges(network);\n+        List<IidmChange> changes =  new ArrayList<>(changelog.getChangesForVariant(variant1));\n+        assertTrue(changes.size() > 1);", "originalCommit": "834a2efbd25beea038ebdfc98c33b8158d685c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMjMzMg==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365802332", "bodyText": "To test the right ordering, the list of changes should have multiple items.", "author": "kaltakovae", "createdAt": "2020-01-13T13:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI3MTIwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "chunk": "diff --git a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\nindex 70630ebdf7..c6217dfe47 100644\n--- a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\n+++ b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\n\n@@ -114,6 +114,7 @@ public final class ChangelogUpdateTest {\n         makeNetworkChangesVariantSpecific(network);\n         makeRemoveChanges(network);\n         List<IidmChange> changes =  new ArrayList<>(changelog.getChangesForVariant(variant1));\n+        // To test the right ordering, the list of changes should have multiple items\n         assertTrue(changes.size() > 1);\n         // Removal is base change, without sorting by index it would be first change in the list.\n         // Check the changes order is correct, and removal is last, as it was made last\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMwMDAwOQ==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365300009", "bodyText": "this method (and other utilitaries test methods) can be static", "author": "MioRtia", "createdAt": "2020-01-10T15:50:20Z", "path": "cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java", "diffHunk": "@@ -123,6 +152,10 @@ private void makeNetworkChangesVariantSpecific(Network network) {\n         load.setP0(newP).setQ0(newQ).getTerminal().setP(newP).setQ(newQ);\n     }\n \n+    private void makeRemoveChanges(Network network) {", "originalCommit": "834a2efbd25beea038ebdfc98c33b8158d685c29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMTE4Ng==", "url": "https://github.com/powsybl/powsybl-core/pull/1098#discussion_r365801186", "bodyText": "Done", "author": "kaltakovae", "createdAt": "2020-01-13T13:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMwMDAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "chunk": "diff --git a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\nindex 70630ebdf7..c6217dfe47 100644\n--- a/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\n+++ b/cgmes/cgmes-conversion/src/test/java/com/powsybl/cgmes/conversion/test/update/ChangelogUpdateTest.java\n\n@@ -152,11 +153,11 @@ public final class ChangelogUpdateTest {\n         load.setP0(newP).setQ0(newQ).getTerminal().setP(newP).setQ(newQ);\n     }\n \n-    private void makeRemoveChanges(Network network) {\n+    private static void makeRemoveChanges(Network network) {\n         network.getLoad(\"load\").remove();\n     }\n \n-    private boolean containsAny(List<IidmChange> changes, List<IidmChange> other) {\n+    private static boolean containsAny(List<IidmChange> changes, List<IidmChange> other) {\n         for (IidmChange c : other) {\n             if (changes.contains(c)) {\n                 return true;\n"}}, {"oid": "2f43a03a79e7b691b9a73992989a7a6fce593f21", "url": "https://github.com/powsybl/powsybl-core/commit/2f43a03a79e7b691b9a73992989a7a6fce593f21", "message": "Merge branch 'master' into cgmes_update_simple_update_chlog_index", "committedDate": "2020-01-13T00:21:04Z", "type": "commit"}, {"oid": "63713be0781bf98813b267be33a1a06fcef845f6", "url": "https://github.com/powsybl/powsybl-core/commit/63713be0781bf98813b267be33a1a06fcef845f6", "message": "Merge branch 'master' into cgmes_update_simple_update_chlog_index\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-13T10:02:52Z", "type": "commit"}, {"oid": "8243523916c8e962e39e2b0e0490a020a02a8a8e", "url": "https://github.com/powsybl/powsybl-core/commit/8243523916c8e962e39e2b0e0490a020a02a8a8e", "message": "Pull request fixes: use TreeSet with a comparator on the index; use stream; set utilitaries methods as static where possible\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-13T13:20:08Z", "type": "commit"}, {"oid": "b8c5a535989230cc711a6fc843ccf83529b005e4", "url": "https://github.com/powsybl/powsybl-core/commit/b8c5a535989230cc711a6fc843ccf83529b005e4", "message": "Merge branch 'cgmes_update_simple_update_chlog_index' of https://github.com/powsybl/powsybl-core into cgmes_update_simple_update_chlog_index", "committedDate": "2020-01-13T13:23:21Z", "type": "commit"}, {"oid": "bd45f61515bcc9196ad5540d17400ebee4de89f0", "url": "https://github.com/powsybl/powsybl-core/commit/bd45f61515bcc9196ad5540d17400ebee4de89f0", "message": "fix Code Smell found by Sonarcloud\n\nSigned-off-by: Elena Kaltakova <kaltakovae@aia.es>", "committedDate": "2020-01-13T13:55:56Z", "type": "commit"}]}