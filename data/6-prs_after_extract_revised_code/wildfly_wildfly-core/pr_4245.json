{"pr_number": 4245, "pr_title": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "pr_createdAt": "2020-06-22T14:28:09Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4245", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MjcyNA==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r443662724", "bodyText": "Just minor but would be good to add a comment here that the realm contains \"USER8\"", "author": "fjuma", "createdAt": "2020-06-22T15:56:36Z", "path": "elytron/src/test/java/org/wildfly/extension/elytron/DomainTestCase.java", "diffHunk": "@@ -109,6 +109,43 @@ private void init() throws Exception {\n         TestEnvironment.activateService(services, Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY, \"SubjectAltNameEvidenceDecoderDomain\");\n         TestEnvironment.activateService(services, Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY, \"SubjectEvidenceDecoderDomain\");\n         TestEnvironment.activateService(services, Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY, \"SourceAddressRoleDecoderDomain\");\n+        TestEnvironment.activateService(services, Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY, \"LowerCasePrincipalTransformerDomain\");\n+        TestEnvironment.activateService(services, Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY, \"UpperCasePrincipalTransformerDomain\");\n+\n+    }\n+\n+    @Test\n+    public void testCasePrincipalTransformerLowerCase() throws Exception {\n+        init();\n+        ServiceName serviceName = Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY.getCapabilityServiceName(\"LowerCasePrincipalTransformerDomain\");\n+        SecurityDomain domain = (SecurityDomain) services.getContainer().getService(serviceName).getValue();\n+        Assert.assertNotNull(domain);\n+\n+        ServerAuthenticationContext context = domain.createNewAuthenticationContext();\n+        context.setAuthenticationName(\"USER1\"); // the realm contains \"user1\"\n+        Assert.assertTrue(context.exists());\n+        context.authorize();\n+        context.succeed();\n+\n+        SecurityIdentity identity = context.getAuthorizedIdentity();\n+        Assert.assertEquals(\"user1\", identity.getPrincipal().getName()); // after pre-realm-name-rewriter only\n+    }\n+\n+    @Test\n+    public void testCasePrincipalTransformerUpperCase() throws Exception {\n+        init();\n+        ServiceName serviceName = Capabilities.SECURITY_DOMAIN_RUNTIME_CAPABILITY.getCapabilityServiceName(\"UpperCasePrincipalTransformerDomain\");\n+        SecurityDomain domain = (SecurityDomain) services.getContainer().getService(serviceName).getValue();\n+        Assert.assertNotNull(domain);\n+\n+        ServerAuthenticationContext context = domain.createNewAuthenticationContext();\n+        context.setAuthenticationName(\"user8\");", "originalCommit": "7e3b6898bdaba6ecd6dd90ced02ebc3db5336558", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzcxNTQzMQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r443715431", "bodyText": "fixed!", "author": "SoniaZaldana", "createdAt": "2020-06-22T17:25:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MjcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "3d1ce210d96bcf6b588c479ffe8f51797680581d", "chunk": "diff --git a/elytron/src/test/java/org/wildfly/extension/elytron/DomainTestCase.java b/elytron/src/test/java/org/wildfly/extension/elytron/DomainTestCase.java\nindex 70cc09bc2e..05ff0376a6 100644\n--- a/elytron/src/test/java/org/wildfly/extension/elytron/DomainTestCase.java\n+++ b/elytron/src/test/java/org/wildfly/extension/elytron/DomainTestCase.java\n\n@@ -139,7 +139,7 @@ public class DomainTestCase extends AbstractSubsystemTest {\n         Assert.assertNotNull(domain);\n \n         ServerAuthenticationContext context = domain.createNewAuthenticationContext();\n-        context.setAuthenticationName(\"user8\");\n+        context.setAuthenticationName(\"user8\"); // the realm contains \"USER8\"\n         Assert.assertTrue(context.exists());\n         context.authorize();\n         context.succeed();\n"}}, {"oid": "3d1ce210d96bcf6b588c479ffe8f51797680581d", "url": "https://github.com/wildfly/wildfly-core/commit/3d1ce210d96bcf6b588c479ffe8f51797680581d", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-06-22T17:25:44Z", "type": "forcePushed"}, {"oid": "c9980cedcd2099e6c49283d1178bf6988138d511", "url": "https://github.com/wildfly/wildfly-core/commit/c9980cedcd2099e6c49283d1178bf6988138d511", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-07-27T20:41:53Z", "type": "forcePushed"}, {"oid": "9a257d67ce6bf06b94e8477ae3430f62707a0e9d", "url": "https://github.com/wildfly/wildfly-core/commit/9a257d67ce6bf06b94e8477ae3430f62707a0e9d", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-08T15:40:18Z", "type": "forcePushed"}, {"oid": "122f322594b5d275486c524ba324c9df3f30aa68", "url": "https://github.com/wildfly/wildfly-core/commit/122f322594b5d275486c524ba324c9df3f30aa68", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-23T17:53:02Z", "type": "forcePushed"}, {"oid": "cb0eb71a1c61206a9c0a8e83eebe6d9b423e8532", "url": "https://github.com/wildfly/wildfly-core/commit/cb0eb71a1c61206a9c0a8e83eebe6d9b423e8532", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-23T18:06:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMzIyMw==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r493823223", "bodyText": "Before, you had updated ElytronSubsystemParser10_0.java (i.e., the previous parser), to update the return value to return new MapperParser(MapperParser.Version.VERSION_6_0).getParser();. That change should be removed from that file and added here instead (since now ElytronSubsystemParser11_0.java is the previous parser).", "author": "fjuma", "createdAt": "2020-09-23T18:56:08Z", "path": "elytron/src/main/java/org/wildfly/extension/elytron/ElytronSubsystemParser11_0.java", "diffHunk": "@@ -33,11 +33,6 @@ String getNameSpace() {\n         return ElytronExtension.NAMESPACE_11_0;\n     }\n \n-    @Override\n-    protected PersistentResourceXMLDescription getMapperParser() {\n-        return new MapperParser().getParser();", "originalCommit": "68ad4d8bd752e88c516c4394ca439b9b6615d822", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg0MzM1Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r493843352", "bodyText": "In that case, as ElytronSubsystemParser10_0 is also supposed to return version 6, I leave the return value as  new MapperParser(MapperParser.Version.VERSION_6_0).getParser() there too, right? Previously, that parser used to return the current version.", "author": "SoniaZaldana", "createdAt": "2020-09-23T19:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMzIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1NTg2MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r493855861", "bodyText": "Ah, just realized that the newly introduced MapperParser.Version.VERSION_6_0 corresponds to ElytronSubsystemParser10_0 and is also needed for ElytronSubsystemParser11_0. This means it is correct to specify this version in ElytronSubsystemParser10_0 and to remove the getMapperParser() method from ElytronSubsystemParser11_0.\nTo help make things clearer though, I think it would be good to rename MapperParser.CURRENT so that it references the actual version instead. That way, the next time we add a new version in MapperParser, we won't need to worry about updating an older version of the parser from CURRENT to the previous version.", "author": "fjuma", "createdAt": "2020-09-23T19:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMzIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1OTAxMw==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r493859013", "bodyText": "So just verify I understood correctly, you're suggesting we rename MapperParser.CURRENT to say MapperParser.VERSION_7_0 and then in the ElytronSubsystemParser12_0 class I instantiate the mapper parser with version 7, as opposed to leaving an empty constructor? That way in the future, we won't have to update ElytronSubsystemParser12_0.", "author": "SoniaZaldana", "createdAt": "2020-09-23T19:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMzIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2MDQ0NQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4245#discussion_r493860445", "bodyText": "Yes, exactly.", "author": "fjuma", "createdAt": "2020-09-23T20:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyMzIyMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "59fbe7f257f6387e200d64479543460f020f9a16", "url": "https://github.com/wildfly/wildfly-core/commit/59fbe7f257f6387e200d64479543460f020f9a16", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-23T20:29:37Z", "type": "forcePushed"}, {"oid": "d3300b433e7534b9e4b4d4a6f172180dd6d2673d", "url": "https://github.com/wildfly/wildfly-core/commit/d3300b433e7534b9e4b4d4a6f172180dd6d2673d", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-24T14:48:29Z", "type": "forcePushed"}, {"oid": "e57708b2e809bbff66e094981f352f348d3cbbc1", "url": "https://github.com/wildfly/wildfly-core/commit/e57708b2e809bbff66e094981f352f348d3cbbc1", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-09-24T14:56:13Z", "type": "forcePushed"}, {"oid": "f6876141d7dd7642bc2ca09728c65873b446ac90", "url": "https://github.com/wildfly/wildfly-core/commit/f6876141d7dd7642bc2ca09728c65873b446ac90", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-11-26T20:15:31Z", "type": "forcePushed"}, {"oid": "dff99099b45423a1dc5d5cf105c6e4bbaaade076", "url": "https://github.com/wildfly/wildfly-core/commit/dff99099b45423a1dc5d5cf105c6e4bbaaade076", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-12-04T14:08:06Z", "type": "commit"}, {"oid": "dff99099b45423a1dc5d5cf105c6e4bbaaade076", "url": "https://github.com/wildfly/wildfly-core/commit/dff99099b45423a1dc5d5cf105c6e4bbaaade076", "message": "[WFCORE-4994] Add the ability to adjust the case of a user name using an Elytron principal transformer", "committedDate": "2020-12-04T14:08:06Z", "type": "forcePushed"}]}