{"pr_number": 4173, "pr_title": "[WFCORE-4932] Reading of identity from security domain causes NPE", "pr_createdAt": "2020-04-21T10:24:00Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4173", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2NTQzNw==", "url": "https://github.com/wildfly/wildfly-core/pull/4173#discussion_r412065437", "bodyText": "@darranl @fjuma After fix for WFCORE-4407 security domain service was not started before attempting to read the identity which resulted in NPE.\nThis fix removes NPE but it is still not possible to read the identity and resulting message is \"Identity with name [myIdentity] not authorized.\" This is also invalid response as I should be able to read the identity I just added, right?", "author": "Skyllarr", "createdAt": "2020-04-21T10:27:50Z", "path": "testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package org.wildfly.test.security.common.elytron;\n+\n+import org.jboss.as.test.integration.management.util.CLIWrapper;\n+import org.junit.After;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.wildfly.core.testrunner.WildflyTestRunner;\n+\n+import static org.hamcrest.CoreMatchers.containsString;\n+\n+@RunWith(WildflyTestRunner.class)\n+public class SecurityDomainTest {\n+    CLIWrapper cli;\n+\n+    @Before\n+    public void setup() throws Exception {\n+        cli = new CLIWrapper(true);\n+        // add security-domain\n+        cli.sendLine(\"/subsystem=elytron/filesystem-realm=myFsRealm:add(path=my-fs-realm-users,relative-to=jboss.server.config.dir)\");\n+        cli.sendLine(\"/subsystem=elytron/filesystem-realm=myFsRealm:add-identity(identity=myIdentity)\");\n+        cli.sendLine(\"/subsystem=elytron/security-domain=mySD:add(realms=[{realm=myFsRealm}],default-realm=myFsRealm)\");\n+        cli.sendLine(\"reload\");\n+    }\n+\n+    @After\n+    public void cleanup() throws Exception {\n+        removeTestResources();\n+        cli.close();\n+    }\n+\n+    private void removeTestResources() {\n+        cli.sendLine(\"/subsystem=elytron/security-domain=mySD:remove\");\n+        cli.sendLine(\"/subsystem=elytron/filesystem-realm=myFsRealm:remove\");\n+        cli.sendLine(\"reload\");\n+    }\n+\n+    @Test\n+    public void testValidHostContextMapValue() {\n+        boolean success = cli.sendLine(\"/subsystem=elytron/security-domain=mySD:read-identity(name=myIdentity)\", true);\n+        Assert.assertFalse(success);\n+        Assert.assertThat(\"Wrong error message\", cli.readOutput(), containsString(\"Identity with name [myIdentity] not authorized.\"));", "originalCommit": "4f9ebdbde78e5c745d555fcfc5086384eb9a46d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4OTY5MA==", "url": "https://github.com/wildfly/wildfly-core/pull/4173#discussion_r412789690", "bodyText": "Just a clarification that the response Identity with name [myIdentity] not authorized. is unrelated to this NPE bug. This NPE bug is happening since wf-core 9.0.0.Beta7 and before that the response was also Identity with name [myIdentity] not authorized.", "author": "Skyllarr", "createdAt": "2020-04-22T08:42:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2NTQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg2Mjc2Nw==", "url": "https://github.com/wildfly/wildfly-core/pull/4173#discussion_r412862767", "bodyText": "update: when I add default-permission-mapper to the security domain I can read the identity without not authorized error. I have updated the test case in this PR", "author": "Skyllarr", "createdAt": "2020-04-22T10:27:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2NTQzNw=="}], "type": "inlineReview", "revised_code": {"commit": "68cade19e26d01ac923b1e9f4d47fe3ed253c238", "chunk": "diff --git a/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java b/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\nindex 998a279f96..0f07f3b1ea 100644\n--- a/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\n+++ b/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\n\n@@ -20,7 +20,7 @@ public class SecurityDomainTest {\n         // add security-domain\n         cli.sendLine(\"/subsystem=elytron/filesystem-realm=myFsRealm:add(path=my-fs-realm-users,relative-to=jboss.server.config.dir)\");\n         cli.sendLine(\"/subsystem=elytron/filesystem-realm=myFsRealm:add-identity(identity=myIdentity)\");\n-        cli.sendLine(\"/subsystem=elytron/security-domain=mySD:add(realms=[{realm=myFsRealm}],default-realm=myFsRealm)\");\n+        cli.sendLine(\"/subsystem=elytron/security-domain=mySD:add(realms=[{realm=myFsRealm}],default-realm=myFsRealm,permission-mapper=default-permission-mapper)\");\n         cli.sendLine(\"reload\");\n     }\n \n"}}, {"oid": "1c45a96594678b7c9c3b989c82f74bc7e2c9a1de", "url": "https://github.com/wildfly/wildfly-core/commit/1c45a96594678b7c9c3b989c82f74bc7e2c9a1de", "message": "[WFCORE-4932] Reading of identity from security domain causes NPE", "committedDate": "2020-04-21T10:34:02Z", "type": "forcePushed"}, {"oid": "68cade19e26d01ac923b1e9f4d47fe3ed253c238", "url": "https://github.com/wildfly/wildfly-core/commit/68cade19e26d01ac923b1e9f4d47fe3ed253c238", "message": "[WFCORE-4932] Reading of identity from security domain causes NPE", "committedDate": "2020-04-22T10:25:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU5OTU0MQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4173#discussion_r413599541", "bodyText": "Just missing a copyright header on this one.", "author": "darranl", "createdAt": "2020-04-23T08:02:33Z", "path": "testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package org.wildfly.test.security.common.elytron;", "originalCommit": "68cade19e26d01ac923b1e9f4d47fe3ed253c238", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66a81de033107d5f11d678b9e0e3de4d631b1c8c", "chunk": "diff --git a/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java b/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\nindex 0f07f3b1ea..136e262b5a 100644\n--- a/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\n+++ b/testsuite/elytron/src/test/java/org/wildfly/test/security/common/elytron/SecurityDomainTest.java\n\n@@ -1,3 +1,19 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n package org.wildfly.test.security.common.elytron;\n \n import org.jboss.as.test.integration.management.util.CLIWrapper;\n"}}, {"oid": "66a81de033107d5f11d678b9e0e3de4d631b1c8c", "url": "https://github.com/wildfly/wildfly-core/commit/66a81de033107d5f11d678b9e0e3de4d631b1c8c", "message": "[WFCORE-4932] Reading of identity from security domain causes NPE", "committedDate": "2020-04-23T08:56:16Z", "type": "commit"}, {"oid": "66a81de033107d5f11d678b9e0e3de4d631b1c8c", "url": "https://github.com/wildfly/wildfly-core/commit/66a81de033107d5f11d678b9e0e3de4d631b1c8c", "message": "[WFCORE-4932] Reading of identity from security domain causes NPE", "committedDate": "2020-04-23T08:56:16Z", "type": "forcePushed"}]}