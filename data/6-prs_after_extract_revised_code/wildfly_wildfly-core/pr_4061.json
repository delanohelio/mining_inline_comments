{"pr_number": 4061, "pr_title": "[WFCORE-4803] EJB Client authentication does not work using SASL DIGEST-MD5 and EXTERNAL mechanisms in Legacy security", "pr_createdAt": "2020-01-21T14:07:47Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4061", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387196860", "bodyText": "Just looking at the code, I think this line should likely have always been the line you are adding i.e. I am not sure if using 'mechanismName` was valid as that is a SASL mechanism name which would not match a realm name which is what this String is being used for.\nOverall I think if authMechanism is null maybe this mechanismName should be skipped and the loop continues.", "author": "darranl", "createdAt": "2020-03-03T18:02:42Z", "path": "domain-management/src/main/java/org/jboss/as/domain/management/security/SecurityRealmService.java", "diffHunk": "@@ -690,6 +690,8 @@ public SaslAuthenticationFactory getSaslAuthenticationFactory(final String[] mec\n                     String preferredMechanism;\n                     if(authMechanism == AuthMechanism.PLAIN && !registeredServices.containsKey(AuthMechanism.PLAIN) && registeredServices.containsKey(AuthMechanism.DIGEST)) {\n                         preferredMechanism = AuthMechanism.DIGEST.name();\n+                    } else if (authMechanism != null) {\n+                        preferredMechanism = authMechanism.name();\n                     } else {\n                         preferredMechanism = mechanismName;", "originalCommit": "8cfd8e002157641249f8fc986c736dfca3636213", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5MjY1OA==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387492658", "bodyText": "I thought initially the same, moreover when I saw that the previous lines throw an exception if there is an unknown mechanism (here). But that else is necessary because of the ANONYMOUS. Anonymous is not managed in the toAuthMechanism method and it's necessary. When I deleted that line (that can only be anonymous because of the previous check) the test associated in wildfly failed. So, that line is not completely bad, it was necessary for anonymous, but the conversion is necessary for the rest (digest for example). I can add a comment or similar if you want.\nThere is a second PR for wildfly with the modified test if you want to check it too: wildfly/wildfly#12936", "author": "rmartinc", "createdAt": "2020-03-04T07:40:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUwOTQ3OQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387509479", "bodyText": "Ok that makes sense, in that case maybe we should have an else if for anonymous and then continue the for loop for any remaining mechanisms?\nThere are other possible SASL mechanisms that would never match so if somehow they were activated at authentication time we likely do want them to fail quickly.", "author": "darranl", "createdAt": "2020-03-04T08:23:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUxODIyNw==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387518227", "bodyText": "If there is an unknown mechanism the method throws an exception before. I mean, the last else is only for anonymous (the var mechanismName cannot be any other thing at that time). Maybe a comment saying all this would be useful.", "author": "rmartinc", "createdAt": "2020-03-04T08:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyMTI3Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387521272", "bodyText": "+1 If you are happy the other cases are covered just a quick comment would likely be helpful.", "author": "darranl", "createdAt": "2020-03-04T08:48:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY5Njg5Mg==", "url": "https://github.com/wildfly/wildfly-core/pull/4061#discussion_r387696892", "bodyText": "Done! I have added a little comment saying that is anonymous. Just pushed.", "author": "rmartinc", "createdAt": "2020-03-04T14:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE5Njg2MA=="}], "type": "inlineReview", "revised_code": {"commit": "0cb0160da6154311aa5f1932f031eee5cad83dbc", "chunk": "diff --git a/domain-management/src/main/java/org/jboss/as/domain/management/security/SecurityRealmService.java b/domain-management/src/main/java/org/jboss/as/domain/management/security/SecurityRealmService.java\nindex b2f20b3bf3..d639606233 100644\n--- a/domain-management/src/main/java/org/jboss/as/domain/management/security/SecurityRealmService.java\n+++ b/domain-management/src/main/java/org/jboss/as/domain/management/security/SecurityRealmService.java\n\n@@ -693,6 +693,7 @@ public class SecurityRealmService implements Service<SecurityRealm>, SecurityRea\n                     } else if (authMechanism != null) {\n                         preferredMechanism = authMechanism.name();\n                     } else {\n+                        // mechanismName is ANONYMOUS\n                         preferredMechanism = mechanismName;\n                     }\n \n"}}, {"oid": "0cb0160da6154311aa5f1932f031eee5cad83dbc", "url": "https://github.com/wildfly/wildfly-core/commit/0cb0160da6154311aa5f1932f031eee5cad83dbc", "message": "[WFCORE-4803] EJB Client authentication does not work using SASL DIGEST-MD5 and EXTERNAL mechanisms in Legacy security", "committedDate": "2020-03-04T14:01:39Z", "type": "commit"}, {"oid": "0cb0160da6154311aa5f1932f031eee5cad83dbc", "url": "https://github.com/wildfly/wildfly-core/commit/0cb0160da6154311aa5f1932f031eee5cad83dbc", "message": "[WFCORE-4803] EJB Client authentication does not work using SASL DIGEST-MD5 and EXTERNAL mechanisms in Legacy security", "committedDate": "2020-03-04T14:01:39Z", "type": "forcePushed"}]}