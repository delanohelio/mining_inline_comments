{"pr_number": 4215, "pr_title": "[WFCORE-4982] Convert DeploymentUnitPhaseService to use a for loop instead of a stream to capture known subsystem names.", "pr_createdAt": "2020-05-23T11:04:54Z", "pr_url": "https://github.com/wildfly/wildfly-core/pull/4215", "timeline": [{"oid": "2f982b4eba368e5eb567bffdfef91ac71c679140", "url": "https://github.com/wildfly/wildfly-core/commit/2f982b4eba368e5eb567bffdfef91ac71c679140", "message": "[WFCORE-4982] Convert DeploymentUnitPhaseService to use a for loop instead of a stream to capture known subsystem names.", "committedDate": "2020-05-23T11:02:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2NTEyOQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4215#discussion_r430365129", "bodyText": "The code is correct but I find the new sequence hard to read: we instantiate the registeredSubSystems and put it as an attachment. And then, later we fill registeredSubSystems with the names of the subsystems...\nSet<String> registeredSubSystems = (phase == Phase.STRUCTURE) ? new HashSet<>() : deploymentUnit.getAttachment(Attachments.REGISTERED_SUBSYSTEMS);\nfor (...) {\n}\ndeploymentUnit.putAttachment(Attachments.REGISTERED_SUBSYSTEMS, registeredSubSystems);", "author": "jmesnil", "createdAt": "2020-05-26T12:12:28Z", "path": "server/src/main/java/org/jboss/as/server/deployment/DeploymentUnitPhaseService.java", "diffHunk": "@@ -141,10 +140,17 @@ public void handleEvent(final ServiceController<?> controller, final LifecycleEv\n             }\n         }\n \n-        Set<String> subSystemNames = list.stream().map(e -> e.getSubsystemName()).collect(Collectors.toSet());\n-        Set<String> registeredSubSystems = (phase == Phase.STRUCTURE) ? new HashSet<>() : deploymentUnit.getAttachment(Attachments.REGISTERED_SUBSYSTEMS);\n-        registeredSubSystems.addAll(subSystemNames);\n-        deploymentUnit.putAttachment(Attachments.REGISTERED_SUBSYSTEMS, registeredSubSystems);\n+        final Set<String> registeredSubSystems;\n+        if (phase == Phase.STRUCTURE) {\n+            registeredSubSystems = new HashSet<>();\n+            deploymentUnit.putAttachment(Attachments.REGISTERED_SUBSYSTEMS, registeredSubSystems);", "originalCommit": "2f982b4eba368e5eb567bffdfef91ac71c679140", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM5NDY4NQ==", "url": "https://github.com/wildfly/wildfly-core/pull/4215#discussion_r430394685", "bodyText": "That was to remove a redundant put which I believe will mean the underlying collection of attachments will need to compare the keys of the attachments present for every phase except for Structure for each deployment being deployed.\nAlternatively the if would need to be repeated just for the purpose of separating out the putAttachment to a later point.", "author": "darranl", "createdAt": "2020-05-26T13:02:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2NTEyOQ=="}], "type": "inlineReview", "revised_code": null}]}