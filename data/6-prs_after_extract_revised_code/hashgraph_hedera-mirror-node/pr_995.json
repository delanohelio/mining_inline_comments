{"pr_number": 995, "pr_title": "Composite entity listener", "pr_createdAt": "2020-08-28T17:54:30Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/995", "timeline": [{"oid": "393bb76cac8d28e7322c4bffaa4a9c34d043b4a4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/393bb76cac8d28e7322c4bffaa4a9c34d043b4a4", "message": "Notify topic messages via Redis Streams\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-30T16:41:43Z", "type": "commit"}, {"oid": "645c675fb4d3f25c963a0f62ca3c96abd66e3972", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/645c675fb4d3f25c963a0f62ca3c96abd66e3972", "message": "Add redis topic listener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-05T21:49:40Z", "type": "commit"}, {"oid": "5924da4fd02167582fbb4ca110dbd719591a70c0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/5924da4fd02167582fbb4ca110dbd719591a70c0", "message": "Merge remote-tracking branch 'origin/master' into redis-streams", "committedDate": "2020-08-25T19:48:13Z", "type": "commit"}, {"oid": "23408640abda2eb9559066b48d23a509fcea4350", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/23408640abda2eb9559066b48d23a509fcea4350", "message": "Remove redis\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-25T20:23:57Z", "type": "commit"}, {"oid": "111c5f4dd08c9f66fd63506f3d4e4f40f3f9f574", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/111c5f4dd08c9f66fd63506f3d4e4f40f3f9f574", "message": "Fix\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-25T20:26:23Z", "type": "commit"}, {"oid": "697c90750cb2ddebbbd2e09323a68a78196636d6", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/697c90750cb2ddebbbd2e09323a68a78196636d6", "message": "Add a RepositoryEntityListener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-26T21:09:19Z", "type": "commit"}, {"oid": "517bde0468c157d1071a66d19ee1ab0273dc9226", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/517bde0468c157d1071a66d19ee1ab0273dc9226", "message": "Merge remote-tracking branch 'origin/master' into composite-entity-listener", "committedDate": "2020-08-26T23:32:14Z", "type": "commit"}, {"oid": "381dd8e399b40d35af4878c82c6f1dbf51c12403", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/381dd8e399b40d35af4878c82c6f1dbf51c12403", "message": "Add a RepositoryEntityListener\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-28T17:40:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ3Nzk4MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r479477981", "bodyText": "Payer account already added to transfer list in buildTransactionRecord().", "author": "steven-sheehy", "createdAt": "2020-08-28T18:47:48Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListenerCryptoTest.java", "diffHunk": "@@ -59,8 +59,8 @@\n     private static final long INITIAL_BALANCE = 1000L;\n     private static final AccountID accountId = AccountID.newBuilder().setShardNum(0).setRealmNum(0).setAccountNum(1001)\n             .build();\n-    private static final long[] additionalTransfers = {5000, 6000, PAYER.getAccountNum()};\n-    private static final long[] additionalTransferAmounts = {1000, 1000, -2000};\n+    private static final long[] additionalTransfers = {5000, 6000};", "originalCommit": "381dd8e399b40d35af4878c82c6f1dbf51c12403", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "cf26f1586363cef78c8e0282404f2cf5788621f4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/cf26f1586363cef78c8e0282404f2cf5788621f4", "message": "Fix caching\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-28T21:19:59Z", "type": "commit"}, {"oid": "25f481d01ad9cb9d73321c1ca3e85c13a4bb76ad", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/25f481d01ad9cb9d73321c1ca3e85c13a4bb76ad", "message": "Fix performance test warmup\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-28T21:43:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NTIwMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r479575203", "bodyText": "You should add a comment here. Initially I thought this was a mistake and it should be !addressBoo. However, I get that you removed the fileData persistence from AddressBookService back to here\nAlso does this check need the addressBook boolean check, since 'entityId.getEntityNum() < 1000' will be true?", "author": "Nana-EC", "createdAt": "2020-08-28T23:39:04Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java", "diffHunk": "@@ -266,15 +267,15 @@ private void insertFileUpdate(long consensusTimestamp, FileUpdateTransactionBody\n     private void insertFileData(long consensusTimestamp, byte[] contents, FileID fileID, int transactionTypeEnum) {\n         EntityId entityId = EntityId.of(fileID);\n         FileData fileData = new FileData(consensusTimestamp, contents, entityId, transactionTypeEnum);\n+        boolean addressBook = addressBookService.isAddressBook(entityId);\n \n-        if (addressBookService.isAddressBook(entityId)) {\n-            // if address book allow immediate persistence instead of waiting for batch\n+        if (addressBook || entityProperties.getPersist().isFiles() ||", "originalCommit": "381dd8e399b40d35af4878c82c6f1dbf51c12403", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MDY1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r479580652", "bodyText": "I can add a comment. We need the check still since less than 1000 is behind a persist flag and we always want to persist address books.", "author": "steven-sheehy", "createdAt": "2020-08-29T00:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM5NDg2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/995#discussion_r481394863", "bodyText": "Added comment", "author": "steven-sheehy", "createdAt": "2020-09-01T19:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3NTIwMw=="}], "type": "inlineReview", "revised_code": {"commit": "2e95798309425244f8006410cfda706f6b0027ff", "chunk": "diff --git a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java\nindex a0824b75f..ac1717a54 100644\n--- a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java\n+++ b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/EntityRecordItemListener.java\n\n@@ -269,6 +269,7 @@ public class EntityRecordItemListener implements RecordItemListener {\n         FileData fileData = new FileData(consensusTimestamp, contents, entityId, transactionTypeEnum);\n         boolean addressBook = addressBookService.isAddressBook(entityId);\n \n+        // We always store file data for address books since they're used by the address book service\n         if (addressBook || entityProperties.getPersist().isFiles() ||\n                 (entityProperties.getPersist().isSystemFiles() && entityId.getEntityNum() < 1000)) {\n             entityListener.onFileData(fileData);\n"}}, {"oid": "93b5bf2b34d7f8cc1a258b9dd5b32b6a356e2f65", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/93b5bf2b34d7f8cc1a258b9dd5b32b6a356e2f65", "message": "Fix warmup in performance test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-31T17:21:46Z", "type": "commit"}, {"oid": "b9c45e98a066a1fcec9338b92dac2a173469c649", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b9c45e98a066a1fcec9338b92dac2a173469c649", "message": "Fix test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-08-31T22:56:37Z", "type": "commit"}, {"oid": "d57e70abdfd2a446cafa37c6a360e6918a01bb12", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d57e70abdfd2a446cafa37c6a360e6918a01bb12", "message": "Fix performance regression\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-09-01T19:49:43Z", "type": "commit"}, {"oid": "2e95798309425244f8006410cfda706f6b0027ff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2e95798309425244f8006410cfda706f6b0027ff", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-09-01T19:55:24Z", "type": "commit"}]}