{"pr_number": 552, "pr_title": "Specify Bounded Executor for NettyServerBuilder", "pr_createdAt": "2020-02-21T22:49:38Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/552", "timeline": [{"oid": "bd309fe6a00111571d41481f6429daf695434bff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bd309fe6a00111571d41481f6429daf695434bff", "message": "Specify Bounded Executor for NettyServerBuilder\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-21T22:46:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382849553", "bodyText": "Min should be 1.\n1k seems fine. Since every thread will\n\ndo 200-page-size query every 2 second in historical mode\nno db query in listening mode\nGiven we can have up to 100 connections to the db, we are good as long as those 200-page-size queries take <200ms (=2sec/(1000/100)) which seems reasonable. And not that all of them will be doing historical queries.", "author": "apeksharma", "createdAt": "2020-02-21T23:15:06Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java", "diffHunk": "@@ -38,4 +38,7 @@\n \n     @Min(8) // 1 kb\n     private int maxMetadataSize = 1024;\n+\n+    @Min(8)\n+    private int threadPoolThreadCount = 1000;", "originalCommit": "bd309fe6a00111571d41481f6429daf695434bff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1OTI1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382859254", "bodyText": "We should move this to grpc properties since it's used by grpc (ServerImpl class). It's not used by netty library. Sorry that it's confusing since we set it via NettyServerBuilder. :)\nAlso, specifying in name what the thread pool is about would be useful - grpcExecutorThread....", "author": "apeksharma", "createdAt": "2020-02-21T23:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MTk4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382861986", "bodyText": "It's actually used by the shaded netty that grpc uses, so the distinction is not really important. They are heavily intertwined. Also the GrpcProperties class is named such since it is for the hedera-mirror-grpc module, not because it contains gRPC specific properties. I think NettyProperties is appropriate for these.", "author": "steven-sheehy", "createdAt": "2020-02-22T00:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MjA5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382862093", "bodyText": "I can set min to 1. Also I updated the names to be clearer\nI'm unclear what you mean by Netty isn't utilized. It is Netty under the hood per my understanding, so these are Netty properties and thus appropriately named.\nLet me know if I'm missing something.", "author": "Nana-EC", "createdAt": "2020-02-22T00:14:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MzczNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382863737", "bodyText": "1k seems fine. Since every thread will\n\nThat's not really how it works. These threads aren't allocated to a specific subscriber nor are they necessarily the thread doing the querying. There is a separate netty thread pool r2dbc uses. Though which thread is doing what at any time is always mixed. I agree with the 1K max thread size though.", "author": "steven-sheehy", "createdAt": "2020-02-22T00:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MDkxOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382870919", "bodyText": "am so glad i put above comment, otherwise wouldn't have been corrected. Thanks for correcting! I'll read up more to better understand the internals.", "author": "apeksharma", "createdAt": "2020-02-22T01:12:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg0OTU1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "chunk": "diff --git a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java\nindex 59930196..6eee6612 100644\n--- a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java\n+++ b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/NettyProperties.java\n\n@@ -40,5 +41,11 @@ public class NettyProperties {\n     private int maxMetadataSize = 1024;\n \n     @Min(8)\n-    private int threadPoolThreadCount = 1000;\n+    private int executorThreadMinCount = 20;\n+\n+    @Max(10000)\n+    private int executorThreadMaxCount = 1000;\n+\n+    @Max(60)\n+    private long threadKeepAliveTime = 60;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODA3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382858071", "bodyText": "since the executor is agnostic to application logic, naming it based on application would be confusing when reading logs.  would suggest name like 'grpc-executor-%d'", "author": "apeksharma", "createdAt": "2020-02-21T23:53:02Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -54,7 +57,15 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n     @Bean\n     public GrpcServerConfigurer grpcServerConfigurer(GrpcProperties grpcProperties) {\n         NettyProperties nettyProperties = grpcProperties.getNetty();\n+        Executor executor = Executors.newFixedThreadPool(\n+                nettyProperties.getThreadPoolThreadCount(),\n+                new ThreadFactoryBuilder()\n+                        .setDaemon(true)\n+                        .setNameFormat(\"hcs-executor-%d\")", "originalCommit": "bd309fe6a00111571d41481f6429daf695434bff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MjEzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382862133", "bodyText": "Yeah removed the name. Thanks", "author": "Nana-EC", "createdAt": "2020-02-22T00:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODA3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "chunk": "diff --git a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\nindex 8abe756f..33a0562b 100644\n--- a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\n+++ b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\n\n@@ -57,12 +58,12 @@ public class GrpcConfiguration {\n     @Bean\n     public GrpcServerConfigurer grpcServerConfigurer(GrpcProperties grpcProperties) {\n         NettyProperties nettyProperties = grpcProperties.getNetty();\n-        Executor executor = Executors.newFixedThreadPool(\n-                nettyProperties.getThreadPoolThreadCount(),\n-                new ThreadFactoryBuilder()\n-                        .setDaemon(true)\n-                        .setNameFormat(\"hcs-executor-%d\")\n-                        .build());\n+        Executor executor = new ThreadPoolExecutor(\n+                nettyProperties.getExecutorThreadMinCount(),\n+                nettyProperties.getExecutorThreadMaxCount(),\n+                nettyProperties.getThreadKeepAliveTime(),\n+                TimeUnit.SECONDS,\n+                new SynchronousQueue<>());\n \n         return serverBuilder -> ((NettyServerBuilder) serverBuilder)\n                 .executor(executor)\n"}}, {"oid": "fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fde50fb6b87fabdb6eb93de7a55fbf7abffe6d0a", "message": "Utilize SynchronousQueue to reuse threads and kill after keep alive time. Added min and max thread count aswell\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-22T00:10:53Z", "type": "commit"}, {"oid": "c4d89a454fef3f6e63f6bf918e5439296f5fa347", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c4d89a454fef3f6e63f6bf918e5439296f5fa347", "message": "Set executorThreadMinCount to 1 and deafult to 10\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-22T00:16:51Z", "type": "commit"}, {"oid": "2f0855e38f5394e17ce85ef452accc5b1ab8ced4", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2f0855e38f5394e17ce85ef452accc5b1ab8ced4", "message": "Updating netty prop names to match properties in server builder\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-22T00:28:01Z", "type": "commit"}, {"oid": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/d8a0b6bf522fb81bae7788ba4554cb9b607b528f", "message": "Updated configuration docs and props names as a result\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-22T00:40:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382872473", "bodyText": "default grpc executor uses daemon threads. Without specifying a thread pool factory, the defaultThreadFactory will use non-daemon threads. Just want to confirm that's what we want?\nWith default thread factory, thread names would  be \"pool-X-thread-Y\" (where X may change if process restarts)\nWhen you posted this stack trace (https://app.zenhub.com/workspaces/hedera-mirror-node-5d6fc4fca9be420001e7d223/issues/hashgraph/hedera-mirror-node/486#issuecomment-581468326), the line was useful since it gave good context of the thread reporting the leak (grpc-default-executor-916).\nIn general too, thread names are indispensable when debugging some of the gnarly bugs. I'd like to request again to give it a name like 'grpc-executor-', please.", "author": "apeksharma", "createdAt": "2020-02-22T01:26:00Z", "path": "hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java", "diffHunk": "@@ -54,10 +58,18 @@ CompositeHealthContributor grpcServices(GrpcServiceDiscoverer grpcServiceDiscove\n     @Bean\n     public GrpcServerConfigurer grpcServerConfigurer(GrpcProperties grpcProperties) {\n         NettyProperties nettyProperties = grpcProperties.getNetty();\n+        Executor executor = new ThreadPoolExecutor(\n+                nettyProperties.getExecutorCoreThreadCount(),\n+                nettyProperties.getExecutorMaxThreadCount(),\n+                nettyProperties.getThreadKeepAliveTime(),\n+                TimeUnit.SECONDS,\n+                new SynchronousQueue<>());", "originalCommit": "d8a0b6bf522fb81bae7788ba4554cb9b607b528f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NDM4OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382874389", "bodyText": "I think we want user threads. Daemon threads are low priority threads for background tasks like garbage collection and are not suited for I/O. Plus we want the JVM to wait for netty threads to gracefully finish before shutting down and daemon threads do not provide that.", "author": "steven-sheehy", "createdAt": "2020-02-22T01:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3ODIxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382878215", "bodyText": "figuring this out on the go, so maybe wrong, but here's what i found so far:\n\nWe are setting grpc.internal.AbstractServerImplBuilder#executor which will set ServerImpl#executor (https://github.com/grpc/grpc-java/blob/master/core/src/main/java/io/grpc/internal/ServerImpl.java#L97).  ServerImpl class seems agnostic of InternalServer, which can be either NettyServer impl or InProcessServer impl (for testing).\nWe are not setting boss/worker ELGs. So the defaults here (https://github.com/grpc/grpc-java/blob/master/netty/src/main/java/io/grpc/netty/Utils.java#L82) would be used. Which means they'll be using their own thread factory and the threads will be daemon threads (https://github.com/grpc/grpc-java/blob/master/netty/src/main/java/io/grpc/netty/Utils.java#L404).\nNumber of threads will be 1 for boss ELG and 2 * number_of_processor_cores for worker ELG\n\nI'd be happy to keep them to those library's defaults (i.e. daemon threads), but if you guys are absolutely sure, please go ahead. I'd only request this much, when changing any property from its default value, please add some comments to the code explaining why we think new higher/lower/different value would be better for our system.\nFor eg. maxInboundMessageSize - For current set of grpc apis(ConsensusService), all request messages all very small and have bounded size of few ~100s of bytes. (Maybe that's the right reason, maybe not \ud83e\udd14)", "author": "apeksharma", "createdAt": "2020-02-22T02:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg5MDQxMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382890410", "bodyText": "Nana looked into boss/worker and decided the defaults were best.\nThinking further on daemon threads and taking into effect that the previous executor used daemon threads and reactor's scheduler threads are mainly daemon, maybe we should switch this to daemon after all.", "author": "steven-sheehy", "createdAt": "2020-02-22T06:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2NTIxNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382965216", "bodyText": "Okay. Sounds like my original commit that had the custom ThreadFactoryBuilder that used daemon thread and custom thread format is the way to go.\nIt looks like the default executor used does use daemon threads.\nNettyServerBuilder implements AbstrctServerImplBuilder, see it's default_executor_pool\nhttps://github.com/grpc/grpc-java/blob/master/core/src/main/java/io/grpc/internal/AbstractServerImplBuilder.java#L66\nthis utilizes the SHARED_CHANNEL_EXECUTOR here\nhttps://github.com/grpc/grpc-java/blob/ca56aa30d498c489180bf1969ea727a40e58937b/core/src/main/java/io/grpc/internal/GrpcUtil.java#L492\nthis uses Executors.newCachedThreadPool (this is where the issue of unbounded threads is since the MaxThreadCount is Int.MAX).\nIt calls a getThreadFacotry() which sets daemon true\nAs is my current PR status will utilize the Executors.defaultThreadFactory(), I'll update this", "author": "Nana-EC", "createdAt": "2020-02-23T05:17:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2NTM3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r382965375", "bodyText": "@apeksharma  I did look into the boss & worker ELG's, I actually have a branch that I pushed with a change to customize those but we wanted to go with the executor threads first since that handles the application logic of processing the HCS queries.\nHere's a good link that explains the 3 thread pools utilized and why executor is appropriate for addressing this ticket of unbounded thread\nhttps://groups.google.com/d/msg/grpc-io/LrnAbWFozb0/VYCVarkWBQAJ\nI can also explore that in a future PR and sprint to see what benefits we might get.", "author": "Nana-EC", "createdAt": "2020-02-23T05:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA1MjE5Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/552#discussion_r383052193", "bodyText": "Good link, thanks for sharing.\nYou're digging into this nice and deep, and i know you'll drive it home, 'how' it is done is up to you.", "author": "apeksharma", "createdAt": "2020-02-23T23:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3MjQ3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9", "chunk": "diff --git a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\nindex f888d494..fa0277bf 100644\n--- a/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\n+++ b/hedera-mirror-grpc/src/main/java/com/hedera/mirror/grpc/config/GrpcConfiguration.java\n\n@@ -63,7 +64,11 @@ public class GrpcConfiguration {\n                 nettyProperties.getExecutorMaxThreadCount(),\n                 nettyProperties.getThreadKeepAliveTime(),\n                 TimeUnit.SECONDS,\n-                new SynchronousQueue<>());\n+                new SynchronousQueue<>(),\n+                new ThreadFactoryBuilder()\n+                        .setDaemon(true)\n+                        .setNameFormat(\"grpc-executor-%d\")\n+                        .build());\n \n         return serverBuilder -> ((NettyServerBuilder) serverBuilder)\n                 .executor(executor)\n"}}, {"oid": "3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3f8ea58ef85b0f161eef84e3b543fbc5a7c03bb9", "message": "Use daemon threads for executor and provide custom name for easier debugging\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-24T00:03:13Z", "type": "commit"}]}