{"pr_number": 549, "pr_title": "Updated performance tests to use DbClient ", "pr_createdAt": "2020-02-21T00:41:13Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/549", "timeline": [{"oid": "8b6203f26d971f8fa12e2782997674d76dcbd2ef", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8b6203f26d971f8fa12e2782997674d76dcbd2ef", "message": "Updated performance tests to use DbClient and update feature scenarios text\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-21T00:34:44Z", "type": "commit"}, {"oid": "6749714f3ee4cc632eb32e1bc50c5305e466f0be", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6749714f3ee4cc632eb32e1bc50c5305e466f0be", "message": "Updated logging in connectionhandler\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-21T00:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODQ4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/549#discussion_r382398486", "bodyText": "You don't need to insert all fields, just the required ones (entity_num, entity_realm, entity_shared, fk_entity_type_id). Id is auto generated. This keeps it from being too coupled.", "author": "steven-sheehy", "createdAt": "2020-02-21T05:01:34Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java", "diffHunk": "@@ -66,9 +64,54 @@ private PostgresqlConnectionFactory getConnectionFactory() {\n         return connectionFactory;\n     }\n \n-    private PostgresqlConnection getConnection() {\n-        log.debug(\"Obtain PostgresqlConnection\");\n-        return getConnectionFactory().create().block(Duration.ofMillis(500));\n+    private DatabaseClient getClient() {\n+        return DatabaseClient.create(getConnectionFactory());\n+    }\n+\n+    public long createTopic() {\n+        long topicNum = getNextAvailableTopicID();\n+\n+        String entityInsertSql = \"insert into t_entities\"\n+                + \" (id, entity_num, entity_realm, entity_shard, fk_entity_type_id, key, ed25519_public_key_hex)\"", "originalCommit": "6749714f3ee4cc632eb32e1bc50c5305e466f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3NzUwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/549#discussion_r382777500", "bodyText": "Good point. I left out a few but I can drop more.", "author": "Nana-EC", "createdAt": "2020-02-21T19:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5ODQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "775271515c14271eda328d68eab4a52eb5bd6122", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\nindex 7291f9cf6..f94324726 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\n\n@@ -68,24 +68,26 @@ public class ConnectionHandler {\n         return DatabaseClient.create(getConnectionFactory());\n     }\n \n-    public long createTopic() {\n+    public long createNextTopic() {\n         long topicNum = getNextAvailableTopicID();\n \n+        createTopic(topicNum);\n+        return topicNum;\n+    }\n+\n+    public void createTopic(long topicNum) {\n         String entityInsertSql = \"insert into t_entities\"\n-                + \" (id, entity_num, entity_realm, entity_shard, fk_entity_type_id, key, ed25519_public_key_hex)\"\n-                + \" values ($1, $2, $3, $4, $5, $6, $7)\";\n+                + \" (entity_num, entity_realm, entity_shard, fk_entity_type_id)\"\n+                + \" values ($1, $2, $3, $4) on conflict do nothing\";\n         client.execute(entityInsertSql)\n                 .bind(\"$1\", topicNum)\n-                .bind(\"$2\", topicNum)\n+                .bind(\"$2\", 0)\n                 .bind(\"$3\", 0)\n-                .bind(\"$4\", 0)\n-                .bind(\"$5\", 4)\n-                .bind(\"$6\", new byte[] {55, 66, 77})\n-                .bind(\"$7\", \"4a5ad514f0957fa170a676210c9bdbddf3bc9519702cf915fa6767a40463b96f\")\n-                .then().block();\n+                .bind(\"$4\", 4)\n+                .then()\n+                .block();\n \n         log.trace(\"Created new Topic {}\", topicNum);\n-        return topicNum;\n     }\n \n     public boolean topicExists(long topicId) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5OTMwMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/549#discussion_r382399300", "bodyText": "These two can be combined with an INSERT ... ON CONFLICT DO NOTHING", "author": "steven-sheehy", "createdAt": "2020-02-21T05:05:07Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java", "diffHunk": "@@ -77,6 +120,10 @@ public void insertTopicMessage(int newTopicsMessageCount, long topicNum, Instant\n             return;\n         }\n \n+        if (!topicExists(topicNum)) {\n+            topicNum = createTopic();", "originalCommit": "6749714f3ee4cc632eb32e1bc50c5305e466f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgxMTAwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/549#discussion_r382811004", "bodyText": "Will do. Will also add a createNewTopic to utilize other logic", "author": "Nana-EC", "createdAt": "2020-02-21T21:20:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5OTMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "775271515c14271eda328d68eab4a52eb5bd6122", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\nindex 7291f9cf6..f94324726 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/ConnectionHandler.java\n\n@@ -120,9 +122,7 @@ public class ConnectionHandler {\n             return;\n         }\n \n-        if (!topicExists(topicNum)) {\n-            topicNum = createTopic();\n-        }\n+        createTopic(topicNum);\n \n         long nextSequenceNum = seqStart == -1 ? getNextAvailableSequenceNumber(topicNum) : seqStart;\n         log.info(\"Inserting {} topic messages starting from sequence number {}\", newTopicsMessageCount,\n"}}, {"oid": "f0c8bbf1abd790be8ff9c040afa1615285c6e0e9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f0c8bbf1abd790be8ff9c040afa1615285c6e0e9", "message": "Merge branch 'master' into integrationtestsfix\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-21T17:58:13Z", "type": "commit"}, {"oid": "775271515c14271eda328d68eab4a52eb5bd6122", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/775271515c14271eda328d68eab4a52eb5bd6122", "message": "Addressed feedback by minimizing logic in create\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-21T21:21:13Z", "type": "commit"}]}