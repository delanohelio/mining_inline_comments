{"pr_number": 646, "pr_title": "Add tests for TransactionHandler.getEntityId()", "pr_createdAt": "2020-04-03T18:56:46Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/646", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMTM2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r403301364", "bodyText": "the string should be a constant.\nAlternatively you can have \"record.receipt\" as the const and a method that take in the additional part and the method adds \"topicID\"", "author": "Nana-EC", "createdAt": "2020-04-03T20:18:00Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusCreateTopicTransactionHandlerTest.java", "diffHunk": "@@ -20,6 +20,18 @@\n  * \u200d\n  */\n \n+import java.util.Map;\n+\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+\n class ConsensusCreateTopicTransactionHandlerTest extends AbstractTransactionHandlerTest {\n+    @Override\n+    protected TransactionHandler getTransactionHandler() {\n+        return new ConsensusCreateTopicTransactionHandler();\n+    }\n \n+    @Override\n+    protected Map<String, Integer> getEntityIdFields() {\n+        return Map.of(\"record.receipt.topicID\", EntityTypeEnum.TOPIC.getId());", "originalCommit": "ad1a2f29843f65daf983e955c8d2976667390044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyODkwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r403328904", "bodyText": "will do the latter in the followup.", "author": "apeksharma", "createdAt": "2020-04-03T20:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMTM2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzMDY1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r406530656", "bodyText": "function got removed.", "author": "apeksharma", "createdAt": "2020-04-09T23:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMTM2NA=="}], "type": "inlineReview", "revised_code": {"commit": "36ac0bb871099bb84518e7331446e7cadf1a79c8", "chunk": "diff --git a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusCreateTopicTransactionHandlerTest.java b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusCreateTopicTransactionHandlerTest.java\nindex 4fd0c3d22..f5cebe4fb 100644\n--- a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusCreateTopicTransactionHandlerTest.java\n+++ b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusCreateTopicTransactionHandlerTest.java\n\n@@ -20,7 +20,9 @@ package com.hedera.mirror.importer.parser.record.transactionhandler;\n  * \u200d\n  */\n \n-import java.util.Map;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import com.hederahashgraph.api.proto.java.TransactionReceipt;\n+import com.hederahashgraph.api.proto.java.TransactionRecord;\n \n import com.hedera.mirror.importer.domain.EntityTypeEnum;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMjIxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r403302213", "bodyText": "Same thing with body.x.y. Would make the tests cleaner and easy to modify with a single method that returns the key for use here", "author": "Nana-EC", "createdAt": "2020-04-03T20:19:09Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusDeleteTopicTransactionHandlerTest.java", "diffHunk": "@@ -20,6 +20,18 @@\n  * \u200d\n  */\n \n+import java.util.Map;\n+\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n+\n class ConsensusDeleteTopicTransactionHandlerTest extends AbstractTransactionHandlerTest {\n+    @Override\n+    protected TransactionHandler getTransactionHandler() {\n+        return new ConsensusDeleteTopicTransactionHandler();\n+    }\n \n+    @Override\n+    protected Map<String, Integer> getEntityIdFields() {\n+        return Map.of(\"body.consensusDeleteTopic.topicID\", EntityTypeEnum.TOPIC.getId());", "originalCommit": "ad1a2f29843f65daf983e955c8d2976667390044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyODk0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r403328946", "bodyText": "same.", "author": "apeksharma", "createdAt": "2020-04-03T20:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMjIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzMDcxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r406530715", "bodyText": "function got removed.", "author": "apeksharma", "createdAt": "2020-04-09T23:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMwMjIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "36ac0bb871099bb84518e7331446e7cadf1a79c8", "chunk": "diff --git a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusDeleteTopicTransactionHandlerTest.java b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusDeleteTopicTransactionHandlerTest.java\nindex d2b8e6368..82d47b28d 100644\n--- a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusDeleteTopicTransactionHandlerTest.java\n+++ b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/ConsensusDeleteTopicTransactionHandlerTest.java\n\n@@ -20,7 +20,9 @@ package com.hedera.mirror.importer.parser.record.transactionhandler;\n  * \u200d\n  */\n \n-import java.util.Map;\n+import com.hederahashgraph.api.proto.java.ConsensusDeleteTopicTransactionBody;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import com.hederahashgraph.api.proto.java.TransactionBody;\n \n import com.hedera.mirror.importer.domain.EntityTypeEnum;\n \n"}}, {"oid": "f92c76e7537c37af354fe3273bfc500970bc88eb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/f92c76e7537c37af354fe3273bfc500970bc88eb", "message": "Add tests for TransactionHandler.getEntityId()\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-03T20:52:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMDgxNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r404410815", "bodyText": "This is a bit complex and adds yet another way to create these proto objects to our code. If there's a bug in this approach it would be hard to catch. Why not just add a default way to create a transactionBody and record for each sub-class?\n    protected abstract TransactionBody.Builder getTransactionBody();\n    protected abstract TransactionRecord.Builder getTransactionRecord();\nThen parent class can set any common defaults on those objects and wrap them in a RecordItem and call the generic tests in parent. For children classes, then can call getTransactionBody() and clear and set any additional fields per test case, then construct a recorditem:\ngetTransactionBody().getConsensusCreateTopicBuilder().clearMemo().setMemo(\"foo\").clearAdminKey();", "author": "steven-sheehy", "createdAt": "2020-04-06T21:52:16Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/AbstractTransactionHandlerTest.java", "diffHunk": "@@ -20,6 +20,114 @@\n  * \u200d\n  */\n \n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Fail.fail;\n+\n+import com.google.protobuf.Descriptors;\n+import com.google.protobuf.Message;\n+\n+import com.hederahashgraph.api.proto.java.AccountID;\n+import com.hederahashgraph.api.proto.java.ContractID;\n+import com.hederahashgraph.api.proto.java.FileID;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import com.hederahashgraph.api.proto.java.Transaction;\n+import com.hederahashgraph.api.proto.java.TransactionBody;\n+import com.hederahashgraph.api.proto.java.TransactionRecord;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.testcontainers.shaded.org.bouncycastle.util.Strings;\n+\n+import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.parser.domain.RecordItem;\n+\n+import java.util.Arrays;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n public abstract class AbstractTransactionHandlerTest {\n+    private static final Long DEFAULT_ENTITY_NUM = 100L;\n+\n+    private TransactionHandler transactionHandler;\n+\n+    protected abstract TransactionHandler getTransactionHandler();\n+    // Map from field name to entity type\n+    protected abstract Map<String, Integer> getEntityIdFields();\n+\n+    @BeforeEach\n+    void beforeEach(TestInfo testInfo) {\n+        System.out.println(\"Before test: \" + testInfo.getTestMethod().get().getName());\n+        transactionHandler = getTransactionHandler();\n+    }\n+\n+    @Test\n+    void testNullEntityId() {\n+        assertExpectedEntityId(TransactionBody.newBuilder(), TransactionRecord.newBuilder(), null);\n+    }\n+\n+    // Tests that TransactionHandler.getEntityId() returns expected entity id.\n+    // Entity id is set using protocol buffer reflection.\n+    @Test\n+    void testGetEntityId() {\n+        // given\n+        Message.Builder transactionBodyBuilder = TransactionBody.newBuilder();\n+        Message.Builder transactionRecordBuilder = TransactionRecord.newBuilder();\n+        Map<String, Integer> entityIdFields = getEntityIdFields();\n+        for (var entityIdField : entityIdFields.entrySet()) {\n+            Iterator<String> fields = Arrays.stream(Strings.split(entityIdField.getKey(), '.')).iterator();\n+            String fieldName = fields.next();\n+            if (fieldName.equals(\"body\")) {", "originalCommit": "f92c76e7537c37af354fe3273bfc500970bc88eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUyNDY1OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/646#discussion_r406524659", "bodyText": "Yeah it is indeed a bit complex.\nThe thing i don't like about common setups like those are, tests become coupled in weird and unexpected ways.\nCould have made reflection logic much simpler, but having plain java logic is more maintainable as a team.\nSo i'll go with your suggestion.", "author": "apeksharma", "createdAt": "2020-04-09T23:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMDgxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "36ac0bb871099bb84518e7331446e7cadf1a79c8", "chunk": "diff --git a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/AbstractTransactionHandlerTest.java b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/AbstractTransactionHandlerTest.java\nindex f24953af7..07df73be2 100644\n--- a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/AbstractTransactionHandlerTest.java\n+++ b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/transactionhandler/AbstractTransactionHandlerTest.java\n\n@@ -21,113 +21,63 @@ package com.hedera.mirror.importer.parser.record.transactionhandler;\n  */\n \n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.assertj.core.api.Fail.fail;\n \n-import com.google.protobuf.Descriptors;\n-import com.google.protobuf.Message;\n-\n-import com.hederahashgraph.api.proto.java.AccountID;\n-import com.hederahashgraph.api.proto.java.ContractID;\n-import com.hederahashgraph.api.proto.java.FileID;\n-import com.hederahashgraph.api.proto.java.TopicID;\n import com.hederahashgraph.api.proto.java.Transaction;\n import com.hederahashgraph.api.proto.java.TransactionBody;\n import com.hederahashgraph.api.proto.java.TransactionRecord;\n import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n import org.junit.jupiter.api.TestInfo;\n-import org.testcontainers.shaded.org.bouncycastle.util.Strings;\n \n import com.hedera.mirror.importer.domain.EntityId;\n+import com.hedera.mirror.importer.domain.EntityTypeEnum;\n import com.hedera.mirror.importer.parser.domain.RecordItem;\n \n-import java.util.Arrays;\n-import java.util.Iterator;\n-import java.util.Map;\n-\n public abstract class AbstractTransactionHandlerTest {\n-    private static final Long DEFAULT_ENTITY_NUM = 100L;\n+    protected static final Long DEFAULT_ENTITY_NUM = 100L;\n \n     private TransactionHandler transactionHandler;\n \n     protected abstract TransactionHandler getTransactionHandler();\n-    // Map from field name to entity type\n-    protected abstract Map<String, Integer> getEntityIdFields();\n+\n+    protected TransactionBody.Builder getDefaultTransactionBody() {\n+        return TransactionBody.newBuilder();\n+    }\n+\n+    protected TransactionRecord.Builder getDefaultTransactionRecord() {\n+        return TransactionRecord.newBuilder();\n+    }\n+\n+    // For testGetEntityId\n+    protected abstract EntityTypeEnum getExpectedEntityIdType();\n+\n+    protected TransactionBody transactionBody;\n+    protected TransactionRecord transactionRecord;\n \n     @BeforeEach\n     void beforeEach(TestInfo testInfo) {\n         System.out.println(\"Before test: \" + testInfo.getTestMethod().get().getName());\n         transactionHandler = getTransactionHandler();\n-    }\n \n-    @Test\n-    void testNullEntityId() {\n-        assertExpectedEntityId(TransactionBody.newBuilder(), TransactionRecord.newBuilder(), null);\n+        transactionBody = getDefaultTransactionBody().build();\n+        transactionRecord = getDefaultTransactionRecord().build();\n     }\n \n-    // Tests that TransactionHandler.getEntityId() returns expected entity id.\n-    // Entity id is set using protocol buffer reflection.\n     @Test\n     void testGetEntityId() {\n-        // given\n-        Message.Builder transactionBodyBuilder = TransactionBody.newBuilder();\n-        Message.Builder transactionRecordBuilder = TransactionRecord.newBuilder();\n-        Map<String, Integer> entityIdFields = getEntityIdFields();\n-        for (var entityIdField : entityIdFields.entrySet()) {\n-            Iterator<String> fields = Arrays.stream(Strings.split(entityIdField.getKey(), '.')).iterator();\n-            String fieldName = fields.next();\n-            if (fieldName.equals(\"body\")) {\n-                setFieldsRecursively(transactionBodyBuilder, fields);\n-            } else if (fieldName.equals(\"record\")) {\n-                setFieldsRecursively(transactionRecordBuilder, fields);\n-            } else {\n-                fail(\"Bad field name \" + fieldName);\n-            }\n-            EntityId expectedEntityId = new EntityId(null, 0L, 0L, DEFAULT_ENTITY_NUM, entityIdField.getValue());\n-\n-            // then\n-            assertExpectedEntityId(transactionBodyBuilder, transactionRecordBuilder, expectedEntityId);\n+        EntityId expectedEntityId = null;\n+        var entityType = getExpectedEntityIdType();\n+        if (entityType != null) {\n+            expectedEntityId = new EntityId(null, 0L, 0L, DEFAULT_ENTITY_NUM, entityType.getId());\n         }\n+        testGetEntityIdHelper(transactionBody, transactionRecord, expectedEntityId);\n     }\n \n-    // Recursively populates the next field in 'remainingFields'.\n-    // If no more fields are left in iterator, then current field has to be account/file/contract/topic id.\n-    private static void setFieldsRecursively(\n-            Message.Builder parentBuilder, Iterator<String> remainingFields) {\n-        if (!remainingFields.hasNext()) {\n-            // set entity num to non-zero value\n-            Descriptors.Descriptor descriptor = parentBuilder.getDescriptorForType();\n-            if (descriptor == AccountID.getDescriptor()) {\n-                ((AccountID.Builder) parentBuilder).setAccountNum(DEFAULT_ENTITY_NUM);\n-            } else if (descriptor == ContractID.getDescriptor()) {\n-                ((ContractID.Builder) parentBuilder).setContractNum(DEFAULT_ENTITY_NUM);\n-            } else if (descriptor == FileID.getDescriptor()) {\n-                ((FileID.Builder) parentBuilder).setFileNum(DEFAULT_ENTITY_NUM);\n-            } else if (descriptor == TopicID.getDescriptor()) {\n-                ((TopicID.Builder) parentBuilder).setTopicNum(DEFAULT_ENTITY_NUM);\n-            } else {\n-                fail(\"field is not of type account/contract/file/topic: \" + parentBuilder);\n-            }\n-        } else {\n-            Descriptors.FieldDescriptor fieldDescriptor =\n-                    parentBuilder.getDescriptorForType().findFieldByName(remainingFields.next());\n-            Message.Builder fieldBuilder = parentBuilder.newBuilderForField(fieldDescriptor);\n-            setFieldsRecursively(fieldBuilder, remainingFields);\n-            parentBuilder.setField(fieldDescriptor, fieldBuilder.build());\n-        }\n-    }\n-\n-    // Asserts that recordItem built using given transaction body and record will return 'expectedEntityId' on\n-    // TransactionHandler.getEntityId().\n-    private void assertExpectedEntityId(Message.Builder txBodyBuilder, Message.Builder txRecordBuilder,\n-                                        EntityId expectedEntityId) {\n+    protected void testGetEntityIdHelper(\n+            TransactionBody transactionBody, TransactionRecord transactionRecord, EntityId expectedEntity) {\n         RecordItem recordItem = new RecordItem(\n-                Transaction.newBuilder().setBodyBytes(txBodyBuilder.build().toByteString()).build(),\n-                (TransactionRecord) txRecordBuilder.build());\n-        if (expectedEntityId == null) {\n-            assertThat(transactionHandler.getEntityId(recordItem)).isNull();\n-        } else {\n-            assertThat(transactionHandler.getEntityId(recordItem)).isEqualTo(expectedEntityId);\n-        }\n+                Transaction.newBuilder().setBodyBytes(transactionBody.toByteString()).build(),\n+                transactionRecord);\n+        assertThat(transactionHandler.getEntityId(recordItem)).isEqualTo(expectedEntity);\n     }\n }\n"}}, {"oid": "36ac0bb871099bb84518e7331446e7cadf1a79c8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/36ac0bb871099bb84518e7331446e7cadf1a79c8", "message": "address review comment\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-09T23:51:22Z", "type": "forcePushed"}, {"oid": "98a1d77b6b983c0c1038470be944ccbdd7a2816d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/98a1d77b6b983c0c1038470be944ccbdd7a2816d", "message": "Add tests for TransactionHandler.getEntityId()\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-10T04:55:21Z", "type": "commit"}, {"oid": "31fa919cc4533cdd9e32e9edeb0975a78c3b06a8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/31fa919cc4533cdd9e32e9edeb0975a78c3b06a8", "message": "address review comment\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-10T04:55:22Z", "type": "commit"}, {"oid": "e82747e7ba41193e9273e9b2554524db4ffb7049", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/e82747e7ba41193e9273e9b2554524db4ffb7049", "message": "rebase\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-10T05:35:15Z", "type": "forcePushed"}, {"oid": "07709cca90863badcc177aa1e3a3bd04b5d804fe", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/07709cca90863badcc177aa1e3a3bd04b5d804fe", "message": "rebase\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-10T05:38:27Z", "type": "commit"}, {"oid": "07709cca90863badcc177aa1e3a3bd04b5d804fe", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/07709cca90863badcc177aa1e3a3bd04b5d804fe", "message": "rebase\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-04-10T05:38:27Z", "type": "forcePushed"}]}