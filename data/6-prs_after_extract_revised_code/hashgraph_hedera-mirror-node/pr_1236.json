{"pr_number": 1236, "pr_title": "Fix address book update always updating 102 file", "pr_createdAt": "2020-11-06T22:47:08Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236", "timeline": [{"oid": "fa51c55d0b5f2017fcdaacaeb556bbbf8b3491c8", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/fa51c55d0b5f2017fcdaacaeb556bbbf8b3491c8", "message": "Fix address book update always updating 102 file\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-06T22:45:22Z", "type": "commit"}, {"oid": "14f99940ac470f82d7efeca7a9037146af4a9920", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/14f99940ac470f82d7efeca7a9037146af4a9920", "message": "Add address book migration\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-09T20:51:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzcyNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520203727", "bodyText": "For complete coverage we could add a test case where both a 101 and 102 are updated, or where only one of them is updated. In either case it would verify the other addressBook entry isn't modified.", "author": "Nana-EC", "createdAt": "2020-11-10T00:16:36Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java", "diffHunk": "@@ -366,6 +367,32 @@ void verifyAddressBookEndPointsAreSet() {\n         assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n     }\n \n+    @Test\n+    void verify101AddressBookEndPointsAreSet() {\n+        byte[] addressBookBytes = UPDATED.toByteArray();\n+        update(addressBookBytes, 0L, false);\n+\n+        // assert current addressBook is updated\n+        AddressBook addressBook = addressBookRepository.findLatestAddressBook(1L, 101L).get();\n+        assertThat(addressBook.getEntries()).hasSize(UPDATED.getNodeAddressCount());\n+        assertThat(addressBook.getStartConsensusTimestamp()).isNotNull();\n+        assertThat(addressBook.getEndConsensusTimestamp()).isNull();\n+\n+        byte[] newAddressBookBytes = FINAL.toByteArray();\n+        update(newAddressBookBytes, 10L, false);\n+        AddressBook newAddressBook = addressBookRepository.findLatestAddressBook(11L, 101L).get();\n+        assertAddressBook(newAddressBook, FINAL);\n+        assertAddressBookData(newAddressBookBytes, 10);\n+\n+        assertEquals(2, addressBookRepository.count());\n+        assertEquals(UPDATED.getNodeAddressCount() + FINAL.getNodeAddressCount(), addressBookEntryRepository.count());\n+\n+        // verify end consensus timestamp was set for previous address book\n+        AddressBook prevAddressBook = addressBookRepository.findById(1L).get();\n+        assertThat(prevAddressBook.getStartConsensusTimestamp()).isNotNull();\n+        assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n+    }\n+", "originalCommit": "14f99940ac470f82d7efeca7a9037146af4a9920", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyNjg4MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1236#discussion_r520726880", "bodyText": "I added a verify101DoesntUpdate102 test case", "author": "steven-sheehy", "createdAt": "2020-11-10T17:08:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIwMzcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "9476ffaba33b906c37f995604d38707829359f3d", "chunk": "diff --git a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java\nindex 0a40c415..25ecb3fb 100644\n--- a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java\n+++ b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java\n\n@@ -342,55 +342,104 @@ class AddressBookServiceImplTest extends IntegrationTest {\n \n     @Test\n     void verify102AddressBookEndPointsAreSet() {\n+        long initialTimestamp = 0L;\n         byte[] addressBookBytes = UPDATED.toByteArray();\n-        update(addressBookBytes, 0L, true);\n-\n-        // assert current addressBook is updated\n-        AddressBook addressBook = addressBookService.getCurrent();\n-        assertThat(addressBook.getEntries()).hasSize(UPDATED.getNodeAddressCount());\n-        assertThat(addressBook.getStartConsensusTimestamp()).isNotNull();\n-        assertThat(addressBook.getEndConsensusTimestamp()).isNull();\n-\n+        update(addressBookBytes, initialTimestamp, true);\n+\n+        assertThat(addressBookRepository.findById(initialTimestamp + 1))\n+                .get()\n+                .returns(addressBookBytes, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_102_ENTITY_ID, AddressBook::getFileId)\n+                .returns(UPDATED.getNodeAddressCount(), AddressBook::getNodeCount)\n+                .returns(initialTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, UPDATED));\n+\n+        long newTimestamp = 10L;\n         byte[] newAddressBookBytes = FINAL.toByteArray();\n+        update(newAddressBookBytes, newTimestamp, true);\n \n-        update(newAddressBookBytes, 10L, true);\n-        AddressBook newAddressBook = addressBookService.getCurrent();\n-        assertAddressBook(newAddressBook, FINAL);\n-        assertAddressBookData(newAddressBookBytes, 10);\n+        assertThat(addressBookRepository.findById(newTimestamp + 1))\n+                .get()\n+                .returns(newAddressBookBytes, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_102_ENTITY_ID, AddressBook::getFileId)\n+                .returns(newTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, FINAL));\n \n         assertEquals(2, addressBookRepository.count());\n         assertEquals(UPDATED.getNodeAddressCount() + FINAL.getNodeAddressCount(), addressBookEntryRepository.count());\n \n         // verify end consensus timestamp was set for previous address book\n-        AddressBook prevAddressBook = addressBookRepository.findById(1L).get();\n-        assertThat(prevAddressBook.getStartConsensusTimestamp()).isNotNull();\n-        assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n+        assertThat(addressBookRepository.findById(1L))\n+                .get()\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_102_ENTITY_ID, AddressBook::getFileId)\n+                .returns(initialTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(newTimestamp, AddressBook::getEndConsensusTimestamp);\n     }\n \n     @Test\n     void verify101AddressBookEndPointsAreSet() {\n+        long initialTimestamp = 0L;\n         byte[] addressBookBytes = UPDATED.toByteArray();\n-        update(addressBookBytes, 0L, false);\n+        update(addressBookBytes, initialTimestamp, false);\n \n-        // assert current addressBook is updated\n-        AddressBook addressBook = addressBookRepository.findLatestAddressBook(1L, 101L).get();\n-        assertThat(addressBook.getEntries()).hasSize(UPDATED.getNodeAddressCount());\n-        assertThat(addressBook.getStartConsensusTimestamp()).isNotNull();\n-        assertThat(addressBook.getEndConsensusTimestamp()).isNull();\n+        assertThat(addressBookRepository.findById(initialTimestamp + 1))\n+                .get()\n+                .returns(addressBookBytes, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_101_ENTITY_ID, AddressBook::getFileId)\n+                .returns(initialTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, UPDATED));\n \n+        long newTimestamp = 10L;\n         byte[] newAddressBookBytes = FINAL.toByteArray();\n-        update(newAddressBookBytes, 10L, false);\n-        AddressBook newAddressBook = addressBookRepository.findLatestAddressBook(11L, 101L).get();\n-        assertAddressBook(newAddressBook, FINAL);\n-        assertAddressBookData(newAddressBookBytes, 10);\n+        update(newAddressBookBytes, newTimestamp, false);\n+\n+        assertThat(addressBookRepository.findById(newTimestamp + 1))\n+                .get()\n+                .returns(newAddressBookBytes, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_101_ENTITY_ID, AddressBook::getFileId)\n+                .returns(newTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, FINAL));\n \n         assertEquals(2, addressBookRepository.count());\n         assertEquals(UPDATED.getNodeAddressCount() + FINAL.getNodeAddressCount(), addressBookEntryRepository.count());\n \n         // verify end consensus timestamp was set for previous address book\n-        AddressBook prevAddressBook = addressBookRepository.findById(1L).get();\n-        assertThat(prevAddressBook.getStartConsensusTimestamp()).isNotNull();\n-        assertThat(prevAddressBook.getEndConsensusTimestamp()).isNotNull();\n+        assertThat(addressBookRepository.findById(initialTimestamp + 1))\n+                .get()\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_101_ENTITY_ID, AddressBook::getFileId)\n+                .returns(initialTimestamp + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(newTimestamp, AddressBook::getEndConsensusTimestamp);\n+    }\n+\n+    @Test\n+    void verify101DoesntUpdate102() {\n+        long timestamp102 = 1L;\n+        byte[] addressBookBytes102 = UPDATED.toByteArray();\n+        update(addressBookBytes102, timestamp102, true);\n+\n+        assertThat(addressBookRepository.findById(timestamp102 + 1))\n+                .get()\n+                .returns(addressBookBytes102, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_102_ENTITY_ID, AddressBook::getFileId)\n+                .returns(timestamp102 + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, UPDATED));\n+\n+        long timestamp101 = 10L;\n+        byte[] addressBookBytes101 = FINAL.toByteArray();\n+        update(addressBookBytes101, timestamp101, false);\n+\n+        assertThat(addressBookRepository.findById(timestamp101 + 1))\n+                .get()\n+                .returns(addressBookBytes101, AddressBook::getFileData)\n+                .returns(AddressBookServiceImpl.ADDRESS_BOOK_101_ENTITY_ID, AddressBook::getFileId)\n+                .returns(timestamp101 + 1, AddressBook::getStartConsensusTimestamp)\n+                .returns(null, AddressBook::getEndConsensusTimestamp)\n+                .satisfies(a -> assertAddressBook(a, FINAL));\n     }\n \n     @Test\n"}}, {"oid": "9476ffaba33b906c37f995604d38707829359f3d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/9476ffaba33b906c37f995604d38707829359f3d", "message": "Address review feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-11-10T17:05:10Z", "type": "commit"}]}