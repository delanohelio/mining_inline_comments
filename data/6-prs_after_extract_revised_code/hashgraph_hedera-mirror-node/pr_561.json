{"pr_number": 561, "pr_title": "Enable MAPI Subscribe JMeter Performance Tests", "pr_createdAt": "2020-02-26T22:18:57Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/561", "timeline": [{"oid": "57fa816ca3f69fbf9b3945b5ebf4161fe97549a0", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/57fa816ca3f69fbf9b3945b5ebf4161fe97549a0", "message": "Initial logic to utilize a sdk mirror client for perf\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-26T19:59:40Z", "type": "commit"}, {"oid": "275333283a9fa00a5bbc3d13b260988eb46e78ce", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/275333283a9fa00a5bbc3d13b260988eb46e78ce", "message": "Merge branch 'master' into mirror-client-performance\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-26T20:01:53Z", "type": "commit"}, {"oid": "2c83e0e1f15779ba9b260654930586afe6950108", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/2c83e0e1f15779ba9b260654930586afe6950108", "message": "Update default config\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-26T20:27:37Z", "type": "commit"}, {"oid": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "message": "Updated flow to use user properties all around\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-26T21:59:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODkwNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r384938904", "bodyText": "Did quick diff: https://www.diffchecker.com/syb1aEXH\nWe can easily share the code here.\npublic abstract class SamplerResult<T> {\n   ...\n  private T last;\n  ...\n  abstract Instant getConsensusTimestamp(T t);\n  abstract long getSequenceNumber(T t);\n}", "author": "apeksharma", "createdAt": "2020-02-27T06:45:12Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSMAPITopicSampler.java", "diffHunk": "@@ -0,0 +1,197 @@\n+package com.hedera.mirror.grpc.jmeter.sampler;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Stopwatch;\n+import com.google.protobuf.TextFormat;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import lombok.Data;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.hashgraph.sdk.consensus.ConsensusTopicId;\n+import com.hedera.hashgraph.sdk.mirror.MirrorClient;\n+import com.hedera.hashgraph.sdk.mirror.MirrorConsensusTopicQuery;\n+import com.hedera.hashgraph.sdk.mirror.MirrorConsensusTopicResponse;\n+import com.hedera.hashgraph.sdk.mirror.MirrorSubscriptionHandle;\n+import com.hedera.mirror.api.proto.ConsensusTopicQuery;\n+import com.hedera.mirror.grpc.jmeter.props.MessageListener;\n+import com.hedera.mirror.grpc.util.ProtoUtil;\n+\n+@Log4j2\n+public class HCSMAPITopicSampler implements HCSTopicSampler {\n+\n+    private final ConsensusTopicQuery request;\n+    private final MirrorClient mirrorClient;\n+    private final MirrorConsensusTopicQuery mirrorConsensusTopicQuery;\n+\n+    public HCSMAPITopicSampler(ConsensusTopicQuery request, String mirrorNodeAddress) {\n+        this.request = request;\n+        mirrorClient = new MirrorClient(Objects.requireNonNull(mirrorNodeAddress));\n+        log.info(\"Setup MirrorClient at {}} for request {}\", TextFormat.shortDebugString(request), mirrorNodeAddress);\n+\n+        TopicID topicID = request.getTopicID();\n+        mirrorConsensusTopicQuery = new MirrorConsensusTopicQuery()\n+                .setTopicId(new ConsensusTopicId(topicID.getShardNum(), topicID.getRealmNum(), topicID.getTopicNum()))\n+                .setStartTime(ProtoUtil.fromTimestamp(request.getConsensusStartTime()));\n+\n+        if (request.hasConsensusEndTime()) {\n+            mirrorConsensusTopicQuery.setEndTime(ProtoUtil.fromTimestamp(request.getConsensusEndTime()));\n+        }\n+\n+        if (request.getLimit() > 0) {\n+            mirrorConsensusTopicQuery.setLimit(request.getLimit());\n+        }\n+    }\n+\n+    /**\n+     * Runs single load test thread by calling gRPC Consensus service subscribeTopic endpoint. Success is dependant on\n+     * StreamObserver observing the expected count for historic and incoming messages in the allotted time Returns\n+     * SamplerResult to client\n+     *\n+     * @param messageListener listener properties\n+     * @return Sampler result representing success and observed message counts\n+     */\n+    @Override\n+    public HCSSamplerResult subscribeTopic(MessageListener messageListener) {\n+        log.info(\"Subscribing to topic using MAPI with {}, {}\", () -> TextFormat\n+                .shortDebugString(request), () -> messageListener);\n+\n+        CountDownLatch historicMessagesLatch = new CountDownLatch(messageListener.getHistoricMessagesCount());\n+        CountDownLatch incomingMessagesLatch = new CountDownLatch(messageListener.getFutureMessagesCount());\n+        TopicID topicId = request.getTopicID();\n+        SamplerResult result = new SamplerResult(topicId.getRealmNum(), topicId\n+                .getTopicNum());\n+\n+        SubscriptionResponse subscriptionResponse = new SubscriptionResponse();\n+        MirrorSubscriptionHandle subscription = null;\n+        List<MirrorConsensusTopicResponse> messages = new ArrayList<>();\n+\n+        try {\n+            subscription = mirrorConsensusTopicQuery\n+                    .subscribe(mirrorClient,\n+                            resp -> {\n+                                result.onNext(resp);\n+                                if (result.isHistorical()) {\n+                                    historicMessagesLatch.countDown();\n+                                } else {\n+                                    incomingMessagesLatch.countDown();\n+                                }\n+                            },\n+                            subscriptionResponse::handleThrowable);\n+\n+            subscriptionResponse.setSubscription(subscription);\n+\n+            // await some new messages\n+            if (!historicMessagesLatch.await(messageListener.getMessagesLatchWaitSeconds(), TimeUnit.SECONDS)) {\n+                log.error(\"Historic messages latch count is {}, did not reach zero\", historicMessagesLatch.getCount());\n+                result.setSuccess(false);\n+            }\n+\n+            log.info(\"{} Historic messages obtained in {} ({}/s)\", result.getHistoricalMessageCount(), result\n+                    .getStopwatch(), result.getMessageRate());\n+\n+            if (historicMessagesLatch.getCount() == 0 && !incomingMessagesLatch\n+                    .await(messageListener.getMessagesLatchWaitSeconds(), TimeUnit.SECONDS)) {\n+                log.error(\"incomingMessagesLatch count is {}, did not reach zero\", incomingMessagesLatch.getCount());\n+                result.setSuccess(false);\n+            }\n+\n+            log.info(\"Observed {} historic and {} incoming messages in {} ({}/s): {}\", result\n+                    .getHistoricalMessageCount(), result.getIncomingMessageCount(), result.getStopwatch(), result\n+                    .getMessageRate(), result.isSuccess() ? \"success\" : \"failed\");\n+        } catch (Exception ex) {\n+            log.error(\"Error subscribing to topic\", ex);\n+            throw ex;\n+        } finally {\n+            if (subscription != null) {\n+                subscription.unsubscribe();\n+                log.info(\"Unsubscribed from {}\", subscription);\n+            }\n+\n+            HCSSamplerResult.HCSSamplerResultBuilder builder = HCSSamplerResult.builder()\n+                    .historicalMessageCount(result.historicalMessageCount)\n+                    .incomingMessageCount(result.incomingMessageCount)\n+                    .realmNum(result.realmNum)\n+                    .success(result.success)\n+                    .topicNum(result.topicNum);\n+\n+            if (result.last != null) {\n+                builder.lastConcensusTimestamp(result.last.consensusTimestamp)\n+                        .lastSequenceNumber(result.last.sequenceNumber);\n+            }\n+\n+            return builder.build();\n+        }\n+    }\n+\n+    @Data\n+    public class SamplerResult {", "originalCommit": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU2NTM5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r385565398", "bodyText": "Yeah was thinking about how to share stuff better, hence being in WIP.\nThis is a good suggestions thanks", "author": "Nana-EC", "createdAt": "2020-02-28T08:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzODkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "193d61548924262abfe6c0a95beb5af4169aa244", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSMAPITopicSampler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSMAPITopicSampler.java\nindex 8bec743dc..5fd254304 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSMAPITopicSampler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSMAPITopicSampler.java\n\n@@ -23,6 +23,7 @@ package com.hedera.mirror.grpc.jmeter.sampler;\n import com.google.common.base.Stopwatch;\n import com.google.protobuf.TextFormat;\n import com.hederahashgraph.api.proto.java.TopicID;\n+import java.time.Instant;\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Objects;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDE2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r384940163", "bodyText": "duplicate comment. can be shared by moving to interface's method.", "author": "apeksharma", "createdAt": "2020-02-27T06:50:12Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.grpc.jmeter.sampler;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Stopwatch;\n+import com.google.protobuf.TextFormat;\n+import com.hederahashgraph.api.proto.java.Timestamp;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.stub.StreamObserver;\n+import java.time.Instant;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import lombok.Data;\n+import lombok.SneakyThrows;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.api.proto.ConsensusServiceGrpc;\n+import com.hedera.mirror.api.proto.ConsensusTopicQuery;\n+import com.hedera.mirror.api.proto.ConsensusTopicResponse;\n+import com.hedera.mirror.grpc.jmeter.props.MessageListener;\n+\n+/**\n+ * A test client that will make requests of the Consensus service from the Consensus server\n+ */\n+@Log4j2\n+public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n+\n+    private final ManagedChannel channel;\n+    private final ConsensusServiceGrpc.ConsensusServiceStub asyncStub;\n+    private final ConsensusTopicQuery request;\n+    private boolean canShutdownChannel = true;\n+\n+    public HCSDirectStubTopicSampler(String host, int port, ConsensusTopicQuery request) {\n+        this(ManagedChannelBuilder.forAddress(host, port).usePlaintext(), request);\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannelBuilder<?> channelBuilder, ConsensusTopicQuery request) {\n+        channel = channelBuilder.build();\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannel channel, ConsensusTopicQuery request) {\n+        // prevent channel shutdown in shared case\n+        canShutdownChannel = false;\n+        this.channel = channel;\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    /**", "originalCommit": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3MzIzMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r385573233", "bodyText": "Overloaded the constructor", "author": "Nana-EC", "createdAt": "2020-02-28T08:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MDE2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "193d61548924262abfe6c0a95beb5af4169aa244", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\nindex 91ff5043e..437d7e332 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n\n@@ -170,13 +170,19 @@ public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n         private final long realmNum;\n         private final long topicNum;\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n-\n+        private Instant incomingMessagesThreshold;\n         private long historicalMessageCount = 0L;\n         private long incomingMessageCount = 0L;\n         private boolean success = true;\n         private ConsensusTopicResponse last;\n         private boolean historical = true;\n \n+        public SamplerResult(long realmNum, long topicNum) {\n+            this.realmNum = realmNum;\n+            this.topicNum = topicNum;\n+            incomingMessagesThreshold = Instant.now();\n+        }\n+\n         public long getTotalMessageCount() {\n             return historicalMessageCount + incomingMessageCount;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MTM1Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r384941353", "bodyText": "duplicate. can be shared in SamplerResult#printStatus", "author": "apeksharma", "createdAt": "2020-02-27T06:54:33Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.grpc.jmeter.sampler;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Stopwatch;\n+import com.google.protobuf.TextFormat;\n+import com.hederahashgraph.api.proto.java.Timestamp;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.stub.StreamObserver;\n+import java.time.Instant;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import lombok.Data;\n+import lombok.SneakyThrows;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.api.proto.ConsensusServiceGrpc;\n+import com.hedera.mirror.api.proto.ConsensusTopicQuery;\n+import com.hedera.mirror.api.proto.ConsensusTopicResponse;\n+import com.hedera.mirror.grpc.jmeter.props.MessageListener;\n+\n+/**\n+ * A test client that will make requests of the Consensus service from the Consensus server\n+ */\n+@Log4j2\n+public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n+\n+    private final ManagedChannel channel;\n+    private final ConsensusServiceGrpc.ConsensusServiceStub asyncStub;\n+    private final ConsensusTopicQuery request;\n+    private boolean canShutdownChannel = true;\n+\n+    public HCSDirectStubTopicSampler(String host, int port, ConsensusTopicQuery request) {\n+        this(ManagedChannelBuilder.forAddress(host, port).usePlaintext(), request);\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannelBuilder<?> channelBuilder, ConsensusTopicQuery request) {\n+        channel = channelBuilder.build();\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannel channel, ConsensusTopicQuery request) {\n+        // prevent channel shutdown in shared case\n+        canShutdownChannel = false;\n+        this.channel = channel;\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    /**\n+     * Runs single load test thread by calling gRPC Consensus service subscribeTopic endpoint. Success is dependant on\n+     * StreamObserver observing the expected count for historic and incoming messages in the allotted time Returns\n+     * SamplerResult to client\n+     *\n+     * @param messageListener listener properties\n+     * @return Sampler result representing success and observed message counts\n+     */\n+    @Override\n+    public HCSSamplerResult subscribeTopic(MessageListener messageListener) throws InterruptedException {\n+        log.info(\"Subscribing to topic with {}, {}\", () -> TextFormat.shortDebugString(request), () -> messageListener);\n+\n+        CountDownLatch historicMessagesLatch = new CountDownLatch(messageListener.getHistoricMessagesCount());\n+        CountDownLatch incomingMessagesLatch = new CountDownLatch(messageListener.getFutureMessagesCount());\n+        TopicID topicId = request.getTopicID();\n+        SamplerResult result = new SamplerResult(topicId.getRealmNum(), topicId.getTopicNum());\n+        StreamObserver<ConsensusTopicResponse> responseObserver = new StreamObserver<>() {\n+\n+            @Override\n+            public void onNext(ConsensusTopicResponse response) {\n+                result.onNext(response);\n+\n+                if (result.isHistorical()) {\n+                    historicMessagesLatch.countDown();\n+                } else {\n+                    incomingMessagesLatch.countDown();\n+                }\n+            }\n+\n+            @SneakyThrows\n+            @Override\n+            public void onError(Throwable t) {\n+                log.error(\"Error in ConsensusTopicResponse StreamObserver\", t);\n+                throw t;\n+            }\n+\n+            @Override\n+            public void onCompleted() {\n+                log.info(\"Observed {} historic and {} incoming messages in {} ({}/s): {}\", result", "originalCommit": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NTMyNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r385575326", "bodyText": "Moved to abstract class", "author": "Nana-EC", "createdAt": "2020-02-28T08:56:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MTM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "193d61548924262abfe6c0a95beb5af4169aa244", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\nindex 91ff5043e..437d7e332 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n\n@@ -170,13 +170,19 @@ public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n         private final long realmNum;\n         private final long topicNum;\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n-\n+        private Instant incomingMessagesThreshold;\n         private long historicalMessageCount = 0L;\n         private long incomingMessageCount = 0L;\n         private boolean success = true;\n         private ConsensusTopicResponse last;\n         private boolean historical = true;\n \n+        public SamplerResult(long realmNum, long topicNum) {\n+            this.realmNum = realmNum;\n+            this.topicNum = topicNum;\n+            incomingMessagesThreshold = Instant.now();\n+        }\n+\n         public long getTotalMessageCount() {\n             return historicalMessageCount + incomingMessageCount;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MjIzMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r384942230", "bodyText": "from this line to 147, there is lot of common code. Please share code.", "author": "apeksharma", "createdAt": "2020-02-27T06:57:24Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java", "diffHunk": "@@ -0,0 +1,216 @@\n+package com.hedera.mirror.grpc.jmeter.sampler;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2019 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import com.google.common.base.Stopwatch;\n+import com.google.protobuf.TextFormat;\n+import com.hederahashgraph.api.proto.java.Timestamp;\n+import com.hederahashgraph.api.proto.java.TopicID;\n+import io.grpc.ManagedChannel;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.stub.StreamObserver;\n+import java.time.Instant;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n+import lombok.Data;\n+import lombok.SneakyThrows;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.api.proto.ConsensusServiceGrpc;\n+import com.hedera.mirror.api.proto.ConsensusTopicQuery;\n+import com.hedera.mirror.api.proto.ConsensusTopicResponse;\n+import com.hedera.mirror.grpc.jmeter.props.MessageListener;\n+\n+/**\n+ * A test client that will make requests of the Consensus service from the Consensus server\n+ */\n+@Log4j2\n+public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n+\n+    private final ManagedChannel channel;\n+    private final ConsensusServiceGrpc.ConsensusServiceStub asyncStub;\n+    private final ConsensusTopicQuery request;\n+    private boolean canShutdownChannel = true;\n+\n+    public HCSDirectStubTopicSampler(String host, int port, ConsensusTopicQuery request) {\n+        this(ManagedChannelBuilder.forAddress(host, port).usePlaintext(), request);\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannelBuilder<?> channelBuilder, ConsensusTopicQuery request) {\n+        channel = channelBuilder.build();\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    public HCSDirectStubTopicSampler(ManagedChannel channel, ConsensusTopicQuery request) {\n+        // prevent channel shutdown in shared case\n+        canShutdownChannel = false;\n+        this.channel = channel;\n+        asyncStub = ConsensusServiceGrpc.newStub(channel);\n+        this.request = request;\n+    }\n+\n+    /**\n+     * Runs single load test thread by calling gRPC Consensus service subscribeTopic endpoint. Success is dependant on\n+     * StreamObserver observing the expected count for historic and incoming messages in the allotted time Returns\n+     * SamplerResult to client\n+     *\n+     * @param messageListener listener properties\n+     * @return Sampler result representing success and observed message counts\n+     */\n+    @Override\n+    public HCSSamplerResult subscribeTopic(MessageListener messageListener) throws InterruptedException {\n+        log.info(\"Subscribing to topic with {}, {}\", () -> TextFormat.shortDebugString(request), () -> messageListener);\n+\n+        CountDownLatch historicMessagesLatch = new CountDownLatch(messageListener.getHistoricMessagesCount());\n+        CountDownLatch incomingMessagesLatch = new CountDownLatch(messageListener.getFutureMessagesCount());\n+        TopicID topicId = request.getTopicID();\n+        SamplerResult result = new SamplerResult(topicId.getRealmNum(), topicId.getTopicNum());\n+        StreamObserver<ConsensusTopicResponse> responseObserver = new StreamObserver<>() {\n+\n+            @Override\n+            public void onNext(ConsensusTopicResponse response) {\n+                result.onNext(response);\n+\n+                if (result.isHistorical()) {\n+                    historicMessagesLatch.countDown();\n+                } else {\n+                    incomingMessagesLatch.countDown();\n+                }\n+            }\n+\n+            @SneakyThrows\n+            @Override\n+            public void onError(Throwable t) {\n+                log.error(\"Error in ConsensusTopicResponse StreamObserver\", t);\n+                throw t;\n+            }\n+\n+            @Override\n+            public void onCompleted() {\n+                log.info(\"Observed {} historic and {} incoming messages in {} ({}/s): {}\", result\n+                        .getHistoricalMessageCount(), result.getIncomingMessageCount(), result.getStopwatch(), result\n+                        .getMessageRate(), result.isSuccess() ? \"success\" : \"failed\");\n+            }\n+        };\n+\n+        try {\n+            asyncStub.subscribeTopic(request, responseObserver);\n+\n+            // await some new messages\n+            if (!historicMessagesLatch.await(messageListener.getMessagesLatchWaitSeconds(), TimeUnit.SECONDS)) {", "originalCommit": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NTQzNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r385575435", "bodyText": "Done", "author": "Nana-EC", "createdAt": "2020-02-28T08:56:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0MjIzMA=="}], "type": "inlineReview", "revised_code": {"commit": "193d61548924262abfe6c0a95beb5af4169aa244", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\nindex 91ff5043e..437d7e332 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/sampler/HCSDirectStubTopicSampler.java\n\n@@ -170,13 +170,19 @@ public class HCSDirectStubTopicSampler implements HCSTopicSampler {\n         private final long realmNum;\n         private final long topicNum;\n         private final Stopwatch stopwatch = Stopwatch.createStarted();\n-\n+        private Instant incomingMessagesThreshold;\n         private long historicalMessageCount = 0L;\n         private long incomingMessageCount = 0L;\n         private boolean success = true;\n         private ConsensusTopicResponse last;\n         private boolean historical = true;\n \n+        public SamplerResult(long realmNum, long topicNum) {\n+            this.realmNum = realmNum;\n+            this.topicNum = topicNum;\n+            incomingMessagesThreshold = Instant.now();\n+        }\n+\n         public long getTotalMessageCount() {\n             return historicalMessageCount + incomingMessageCount;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0NDI4MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r384944281", "bodyText": "class comment on need of custom configuration parsing (probably dumb question since am new to these parts of code :) ). But also probably something anyone new would wonder \ud83e\udd14", "author": "apeksharma", "createdAt": "2020-02-27T07:04:28Z", "path": "hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/PropertiesHandler.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.hedera.mirror.grpc.jmeter.handler;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import lombok.extern.log4j.Log4j2;\n+import org.apache.jmeter.protocol.java.sampler.JavaSamplerContext;\n+\n+@Log4j2\n+public class PropertiesHandler {", "originalCommit": "ca62d3828020c5d7830c82c8eb3b1e488b36eb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NTQ5OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/561#discussion_r385575499", "bodyText": "Done", "author": "Nana-EC", "createdAt": "2020-02-28T08:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk0NDI4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "537dcce6e3265c1782301cb3d58d1ac0f898f671", "chunk": "diff --git a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/PropertiesHandler.java b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/PropertiesHandler.java\nindex 8371f811f..d7e32b638 100644\n--- a/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/PropertiesHandler.java\n+++ b/hedera-mirror-grpc/src/test/java/com/hedera/mirror/grpc/jmeter/handler/PropertiesHandler.java\n\n@@ -23,6 +23,10 @@ package com.hedera.mirror.grpc.jmeter.handler;\n import lombok.extern.log4j.Log4j2;\n import org.apache.jmeter.protocol.java.sampler.JavaSamplerContext;\n \n+/**\n+ * A utility class for easily retrieving jmeter user properties from a properties file Offers numerous method overloads\n+ * for cleaner code calls\n+ */\n @Log4j2\n public class PropertiesHandler {\n     private final String basePattern = \"%s.%s\";\n"}}, {"oid": "364598c69ff7222ed80cac8b5555c3db41c9fdf9", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/364598c69ff7222ed80cac8b5555c3db41c9fdf9", "message": "removed changes to E2E_Single_User_All_Messages.jmx\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-27T15:14:16Z", "type": "commit"}, {"oid": "193d61548924262abfe6c0a95beb5af4169aa244", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/193d61548924262abfe6c0a95beb5af4169aa244", "message": "Use PostgresqlBatch to speed up insert time for valid incoming message test scenarios\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-27T22:24:50Z", "type": "commit"}, {"oid": "537dcce6e3265c1782301cb3d58d1ac0f898f671", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/537dcce6e3265c1782301cb3d58d1ac0f898f671", "message": "Refactored for betting code sharing\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-28T08:46:02Z", "type": "commit"}, {"oid": "6282836e01ab112a52feec2dd722854e5cd2a080", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6282836e01ab112a52feec2dd722854e5cd2a080", "message": "Added batch insert logic to speed up inserts for incoming messages\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-28T08:50:36Z", "type": "commit"}, {"oid": "a71e998b0baaf9aa9ba7acbaa36073362ee53749", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a71e998b0baaf9aa9ba7acbaa36073362ee53749", "message": "Centralized on complete result log\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-28T08:57:57Z", "type": "commit"}, {"oid": "ee1d21d5189297f731d5b73be26c350222f350fe", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ee1d21d5189297f731d5b73be26c350222f350fe", "message": "Set result default to true in builder\n\nSigned-off-by: Nana-EC <56320167+Nana-EC@users.noreply.github.com>", "committedDate": "2020-02-28T21:09:32Z", "type": "commit"}]}