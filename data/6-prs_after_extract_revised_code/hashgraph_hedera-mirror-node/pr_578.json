{"pr_number": 578, "pr_title": "Postgres Writer #3 : Move transaction and batching", "pr_createdAt": "2020-03-02T20:49:23Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/578", "timeline": [{"oid": "3478de8e5e5407513c28b5e74b6965dd0f994e62", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3478de8e5e5407513c28b5e74b6965dd0f994e62", "message": "Postgres Writer #3 : Move transaction and batching\n\nFollowups from previous reviews:\n- Add NotImplementedException to methods missing logic\n- share code between two insertFile*() functions\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-02T20:47:40Z", "type": "commit"}, {"oid": "45cc912467eb3ff82f2e6b1060d2b04845169c05", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/45cc912467eb3ff82f2e6b1060d2b04845169c05", "message": "remove old test for batch size\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-02T20:56:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY1MTk0OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r386651948", "bodyText": "not needed now that there's test for batching in PostgresWritingRecordParserItemHandlerTest.\nEven before, it wasn't testing batching correctly.\nSince the test always commits explicitly by calling completeFile and then only checks for number of rows in the table, it would pass even if batching was not working correctly. Verified it locally on master branch by commenting call to executeBatches() that was there in RecordFileLogger.storeRecord().", "author": "apeksharma", "createdAt": "2020-03-02T21:10:46Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileLoggerCryptoTest.java", "diffHunk": "@@ -137,29 +137,6 @@ void cryptoCreate() throws Exception {\n         verifyRepoCryptoTransferList(record);\n     }\n \n-    @Test", "originalCommit": "45cc912467eb3ff82f2e6b1060d2b04845169c05", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "message": "close connection\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-02T21:30:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NDg4Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r386674883", "bodyText": "So my thought here was that if the PreparedStatement could be retrieved by test code then we could eventually down ingestion only tests for performance, and we'd avoid test code and product code getting out of sync.", "author": "Nana-EC", "createdAt": "2020-03-02T21:56:28Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -36,18 +37,31 @@\n import com.hedera.mirror.importer.exception.ImporterException;\n import com.hedera.mirror.importer.exception.ParserSQLException;\n \n+import org.apache.commons.lang3.NotImplementedException;\n+\n @Log4j2\n @Named\n+@RequiredArgsConstructor\n public class PostgresWritingRecordParsedItemHandler implements RecordParsedItemHandler {\n+    private long batch_count = 0;\n+    private PreparedStatement sqlInsertTransaction;\n     private PreparedStatement sqlInsertTransferList;\n     private PreparedStatement sqlInsertNonFeeTransfers;\n     private PreparedStatement sqlInsertFileData;\n     private PreparedStatement sqlInsertContractResult;\n     private PreparedStatement sqlInsertLiveHashes;\n     private PreparedStatement sqlInsertTopicMessage;\n+    private final PostgresWriterProperties properties;\n \n     void initSqlStatements(Connection connection) throws ParserSQLException {\n         try {\n+            sqlInsertTransaction = connection.prepareStatement(\"INSERT INTO t_transactions\"", "originalCommit": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcxNDE1Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r386714156", "bodyText": "Discussed with nana a bit, posting summary.\nThe goal here is, if these statements are repeating in our codebase in multiple places, then we want to modularize these. We'll discuss it again tomorrow, and can be done independently.", "author": "apeksharma", "createdAt": "2020-03-02T23:30:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NDg4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNDY5OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r387924699", "bodyText": "Why is this added here if it is a standalone bean used in a standalone fashion in the handler?", "author": "steven-sheehy", "createdAt": "2020-03-04T20:47:05Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordParserProperties.java", "diffHunk": "@@ -60,6 +60,8 @@\n     // bytes on the t_transaction table\n     private boolean persistTransactionBytes = false;\n \n+    private final PostgresWriterProperties postgresWriter;", "originalCommit": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTExMA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r387925110", "bodyText": "Needs @Min(1)", "author": "steven-sheehy", "createdAt": "2020-03-04T20:47:57Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWriterProperties.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.hedera.mirror.importer.parser.record;\n+\n+import lombok.Data;\n+import javax.inject.Named;\n+\n+@Data\n+@Named\n+public class PostgresWriterProperties {\n+    /**\n+     * PreparedStatement.executeBatch() is called after every batchSize number of transactions from record stream file.\n+     */\n+    private int batchSize = 100;", "originalCommit": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwODA0MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r388008040", "bodyText": "done on followup.", "author": "apeksharma", "createdAt": "2020-03-05T00:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTExMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNjAzOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r387926039", "bodyText": "Missing @ConfigurationProperties(\"hedera.mirror.parser.record.postgresql\") and @Validated. @Named can be removed as it's auto-scanned.", "author": "steven-sheehy", "createdAt": "2020-03-04T20:49:54Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWriterProperties.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.hedera.mirror.importer.parser.record;\n+\n+import lombok.Data;\n+import javax.inject.Named;\n+\n+@Data\n+@Named\n+public class PostgresWriterProperties {", "originalCommit": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwODA1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r388008057", "bodyText": "done on followup.", "author": "apeksharma", "createdAt": "2020-03-05T00:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNjAzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyODExOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r387928119", "bodyText": "Why was this check removed?", "author": "steven-sheehy", "createdAt": "2020-03-04T20:54:03Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/RecordFileLogger.java", "diffHunk": "@@ -740,28 +693,21 @@ private static void insertConsensusTopicMessage(ConsensusSubmitMessageTransactio\n         postgresWriter.onTopicMessage(topicMessage);\n     }\n \n-    private static void insertFileCreate(long consensusTimestamp, FileCreateTransactionBody transactionBody,\n-                                         TransactionRecord transactionRecord) {\n+    private static void insertFileData(long consensusTimestamp, byte[] contents, FileID fileID) {\n         if (parserProperties.isPersistFiles() ||\n-                (parserProperties.isPersistSystemFiles() && transactionRecord.getReceipt().getFileID()\n-                        .getFileNum() < 1000)) {\n-            byte[] contents = transactionBody.getContents().toByteArray();\n+                (parserProperties.isPersistSystemFiles() && fileID.getFileNum() < 1000)) {\n             postgresWriter.onFileData(new FileData(consensusTimestamp, contents));\n         }\n     }\n \n     private static void insertFileAppend(long consensusTimestamp, FileAppendTransactionBody transactionBody)\n             throws IOException {\n-        if (parserProperties.isPersistFiles() ||", "originalCommit": "6c14c40e71e67903d2967b2aea5961cdd3f5ca18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAwODk0OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/578#discussion_r388008949", "bodyText": "moved to insertFileData fn.\nnetworkAddressBook update happens out of the check now", "author": "apeksharma", "createdAt": "2020-03-05T00:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyODExOQ=="}], "type": "inlineReview", "revised_code": null}]}