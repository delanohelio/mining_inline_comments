{"pr_number": 869, "pr_title": "Improve topic message ingest rate", "pr_createdAt": "2020-07-15T22:35:58Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/869", "timeline": [{"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef2546fa7afdc737407d08f2cae02bd5810f144d", "message": "Remove notify trigger\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-15T22:45:28Z", "type": "commit"}, {"oid": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/ef2546fa7afdc737407d08f2cae02bd5810f144d", "message": "Remove notify trigger\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-15T22:45:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwNzUyMQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455407521", "bodyText": "nit: just do , topic notifications: {} as a standalone like the rest so it reads easier", "author": "Nana-EC", "createdAt": "2020-07-15T22:45:19Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java", "diffHunk": "@@ -190,10 +199,11 @@ private void executeBatches() {\n             var contractResult = executeBatch(sqlInsertContractResult);\n             var liveHashes = executeBatch(sqlInsertLiveHashes);\n             var topicMessages = executeBatch(sqlInsertTopicMessage);\n+            var topicMessageNotifications = executeBatch(sqlNotifyTopicMessage);\n             log.info(\"Inserted transactions: {}, entities: {}, transfer lists: {}, files: {}, contracts: {}, \" +\n-                            \"claims: {}, topic messages: {}, non-fee transfers: {}\",\n+                            \"claims: {}, topic messages: {}+({}ms), non-fee transfers: {}\",", "originalCommit": "de44afc65211482f7551f7771d8fcff8470ae5e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0NTE1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456145152", "bodyText": "Done", "author": "steven-sheehy", "createdAt": "2020-07-17T00:06:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwNzUyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4ffa551bb21bff2b16cb0014f17ce84521b0154d", "chunk": "diff --git a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\nindex 9522c882c..84c4b78f6 100644\n--- a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\n+++ b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\n\n@@ -201,9 +201,9 @@ public class SqlEntityListener implements EntityListener, RecordStreamFileListen\n             var topicMessages = executeBatch(sqlInsertTopicMessage);\n             var topicMessageNotifications = executeBatch(sqlNotifyTopicMessage);\n             log.info(\"Inserted transactions: {}, entities: {}, transfer lists: {}, files: {}, contracts: {}, \" +\n-                            \"claims: {}, topic messages: {}+({}ms), non-fee transfers: {}\",\n+                            \"claims: {}, topic messages: {}, topic notifications: {}, non-fee transfers: {}\",\n                     transactions, entityIds, transferLists, fileData, contractResult, liveHashes, topicMessages,\n-                    topicMessageNotifications.getTimeTakenInMs(), nonFeeTransfers);\n+                    topicMessageNotifications, nonFeeTransfers);\n         } catch (SQLException e) {\n             log.error(\"Error committing sql insert batch \", e);\n             throw new ParserSQLException(e);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwODM3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455408373", "bodyText": "I believe we current base64 encode the message and running hash. I think that logic is missing from here.", "author": "Nana-EC", "createdAt": "2020-07-15T22:47:50Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java", "diffHunk": "@@ -323,6 +333,18 @@ public void onTopicMessage(TopicMessage topicMessage) throws ImporterException {\n         } catch (SQLException e) {\n             throw new ParserSQLException(e);\n         }\n+\n+        try {\n+            if (properties.isNotifyTopicMessage()) {\n+                String json = OBJECT_MAPPER.writeValueAsString(topicMessage);", "originalCommit": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxODczMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455418732", "bodyText": "It's not, jackson automatically encodes bytes to base64 string by default.", "author": "steven-sheehy", "createdAt": "2020-07-15T23:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwODM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg2NTc5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455865798", "bodyText": "Ah good.", "author": "Nana-EC", "createdAt": "2020-07-16T15:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQwODM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "a6d72957d5a663d066ebf9cd48c6110135df828c", "chunk": "diff --git a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\nindex 9522c882c..578e9dc11 100644\n--- a/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\n+++ b/hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlEntityListener.java\n\n@@ -317,15 +317,18 @@ public class SqlEntityListener implements EntityListener, RecordStreamFileListen\n             if (topicMessage.getChunkNum() != null) {\n                 sqlInsertTopicMessage.setInt(F_TOPICMESSAGE.CHUNK_NUM.ordinal(), topicMessage.getChunkNum());\n                 sqlInsertTopicMessage.setInt(F_TOPICMESSAGE.CHUNK_TOTAL.ordinal(), topicMessage.getChunkTotal());\n-                sqlInsertTopicMessage\n-                        .setLong(F_TOPICMESSAGE.PAYER_ACCOUNT_ID.ordinal(), topicMessage.getPayerAccountId().getId());\n+                if (topicMessage.getPayerAccountId() != null) {\n+                    sqlInsertTopicMessage.setLong(F_TOPICMESSAGE.PAYER_ACCOUNT_ID.ordinal(),\n+                            topicMessage.getPayerAccountId().getId());\n+                } else {\n+                    sqlInsertTopicMessage.setObject(F_TOPICMESSAGE.PAYER_ACCOUNT_ID.ordinal(), null);\n+                }\n                 sqlInsertTopicMessage\n                         .setLong(F_TOPICMESSAGE.VALID_START_TIMESTAMP.ordinal(), topicMessage.getValidStartTimestamp());\n             } else {\n                 sqlInsertTopicMessage.setNull(F_TOPICMESSAGE.CHUNK_NUM.ordinal(), Types.SMALLINT);\n                 sqlInsertTopicMessage.setNull(F_TOPICMESSAGE.CHUNK_TOTAL.ordinal(), Types.SMALLINT);\n-                sqlInsertTopicMessage\n-                        .setObject(F_TOPICMESSAGE.PAYER_ACCOUNT_ID.ordinal(), null);\n+                sqlInsertTopicMessage.setObject(F_TOPICMESSAGE.PAYER_ACCOUNT_ID.ordinal(), null);\n                 sqlInsertTopicMessage.setNull(F_TOPICMESSAGE.VALID_START_TIMESTAMP.ordinal(), Types.BIGINT);\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxMzYwMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r455913602", "bodyText": "20 may be still low. the longest run I saw in CircleCI run is 27.x secs, so in other PRs it's set to 30.", "author": "xin-hedera", "createdAt": "2020-07-16T16:24:57Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java", "diffHunk": "@@ -69,7 +69,7 @@ void before() {\n         parserProperties.init();\n     }\n \n-    @Timeout(10)\n+    @Timeout(20)", "originalCommit": "ef2546fa7afdc737407d08f2cae02bd5810f144d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNTA1Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456015057", "bodyText": "Sure, will probably remove as it's covered by yours.", "author": "steven-sheehy", "createdAt": "2020-07-16T19:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxMzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNTQ0Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456015443", "bodyText": "The hope was that the performance improvements in this PR would make it 20, but it doesn't seem to be the case.", "author": "steven-sheehy", "createdAt": "2020-07-16T19:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxMzYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE0NTMwOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456145309", "bodyText": "Removed", "author": "steven-sheehy", "createdAt": "2020-07-17T00:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkxMzYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "4ffa551bb21bff2b16cb0014f17ce84521b0154d", "chunk": "diff --git a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java\nindex b0da16150..630e7de95 100644\n--- a/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java\n+++ b/hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/RecordFileParserPerformanceTest.java\n\n@@ -69,7 +69,7 @@ public class RecordFileParserPerformanceTest extends IntegrationTest {\n         parserProperties.init();\n     }\n \n-    @Timeout(20)\n+    @Timeout(10)\n     @Test\n     void parseAndIngestMultipleFiles60000Transactions() throws Exception {\n         parse(\"*.rcd\");\n"}}, {"oid": "a6d72957d5a663d066ebf9cd48c6110135df828c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a6d72957d5a663d066ebf9cd48c6110135df828c", "message": "Merge remote-tracking branch 'origin/release/0.15' into remove-notify-trigger", "committedDate": "2020-07-16T23:53:25Z", "type": "commit"}, {"oid": "4ffa551bb21bff2b16cb0014f17ce84521b0154d", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4ffa551bb21bff2b16cb0014f17ce84521b0154d", "message": "Fix tests and address feedback\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-17T00:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1OTg3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456159872", "bodyText": "nit: we can document this now right. But we can do it in master for v0.16", "author": "Nana-EC", "createdAt": "2020-07-17T00:59:43Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/entity/sql/SqlProperties.java", "diffHunk": "@@ -32,4 +32,7 @@\n      */\n     @Min(1)\n     private int batchSize = 2000;\n+\n+    // Not documenting this for now since it may be temporary pending further refactorings", "originalCommit": "4ffa551bb21bff2b16cb0014f17ce84521b0154d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE2MDU3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/869#discussion_r456160575", "bodyText": "I don't want to document because it will go away/change when we implement other publishers", "author": "steven-sheehy", "createdAt": "2020-07-17T01:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1OTg3Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "499f4aaf40a7380fe53786b3e198325d0aa2a094", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/499f4aaf40a7380fe53786b3e198325d0aa2a094", "message": "Fix bad merge causing failed test\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-17T03:33:43Z", "type": "commit"}, {"oid": "a39fc56cdddc3694060b1a9ec15bcedfb1d224a5", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a39fc56cdddc3694060b1a9ec15bcedfb1d224a5", "message": "Bump versions to 0.15.2-rc1\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-17T03:36:02Z", "type": "commit"}, {"oid": "c770b782e67411ef2d06a5838b425ff913206afb", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/c770b782e67411ef2d06a5838b425ff913206afb", "message": "Fix ConsensusControllerTest\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-17T14:40:18Z", "type": "commit"}, {"oid": "bfb238277f578423407fb1ffdffe406e0ca8aea7", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/bfb238277f578423407fb1ffdffe406e0ca8aea7", "message": "Bump version to 0.15.2\n\nSigned-off-by: Steven Sheehy <steven.sheehy@hedera.com>", "committedDate": "2020-07-17T15:18:53Z", "type": "commit"}]}