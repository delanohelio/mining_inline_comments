{"pr_number": 575, "pr_title": "Postgres Writer #1 : move ctl and non-fee transfers", "pr_createdAt": "2020-03-01T00:25:04Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/575", "timeline": [{"oid": "b11ca2a63822981d176016f2323104e02692b627", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b11ca2a63822981d176016f2323104e02692b627", "message": "PostgresWritingRecordParsedItemHandler#1 : move ctl and non-fee transfers\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-01T00:24:29Z", "type": "commit"}, {"oid": "b11ca2a63822981d176016f2323104e02692b627", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/b11ca2a63822981d176016f2323104e02692b627", "message": "PostgresWritingRecordParsedItemHandler#1 : move ctl and non-fee transfers\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-01T00:24:29Z", "type": "forcePushed"}, {"oid": "7434b17ae9068c350c64ee20872f1dd094943452", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7434b17ae9068c350c64ee20872f1dd094943452", "message": "add licenses\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-01T02:07:37Z", "type": "commit"}, {"oid": "657e15655f36fad8da6d5bb73e0597ee18dd3166", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/657e15655f36fad8da6d5bb73e0597ee18dd3166", "message": "setup generic testing\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-03-01T02:36:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4NjcyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/575#discussion_r386486725", "bodyText": "nit: always best to do a notimplementedexception here and in other places so there's no chance of missing it.", "author": "Nana-EC", "createdAt": "2020-03-02T16:05:35Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package com.hedera.mirror.importer.parser.record;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.ContractResult;\n+import com.hedera.mirror.importer.domain.CryptoTransfer;\n+import com.hedera.mirror.importer.domain.FileData;\n+import com.hedera.mirror.importer.domain.LiveHash;\n+import com.hedera.mirror.importer.domain.NonFeeTransfer;\n+import com.hedera.mirror.importer.domain.TopicMessage;\n+import com.hedera.mirror.importer.domain.Transaction;\n+import com.hedera.mirror.importer.exception.ImporterException;\n+import com.hedera.mirror.importer.exception.ParserSQLException;\n+\n+@Log4j2\n+@Named\n+public class PostgresWritingRecordParsedItemHandler implements RecordParsedItemHandler {\n+    private PreparedStatement sqlInsertTransferList;\n+    private PreparedStatement sqlInsertNonFeeTransfers;\n+\n+    void initSqlStatements(Connection connection) throws ParserSQLException {\n+        try {\n+            sqlInsertTransferList = connection.prepareStatement(\"INSERT INTO t_cryptotransferlists\"\n+                    + \" (consensus_timestamp, amount, realm_num, entity_num)\"\n+                    + \" VALUES (?, ?, ?, ?)\");\n+\n+            sqlInsertNonFeeTransfers = connection.prepareStatement(\"insert into non_fee_transfers\"\n+                    + \" (consensus_timestamp, amount, realm_num, entity_num)\"\n+                    + \" values (?, ?, ?, ?)\");\n+        } catch (SQLException e) {\n+            throw new ParserSQLException(\"Unable to prepare SQL statements\", e);\n+        }\n+    }\n+\n+    public void finish() {\n+        closeStatements();\n+    }\n+\n+    @Override\n+    public void onFileComplete() {\n+        executeBatches();\n+    }\n+\n+    private void closeStatements() {\n+        try {\n+            sqlInsertTransferList.close();\n+            sqlInsertNonFeeTransfers.close();\n+        } catch (SQLException e) {\n+            throw new ParserSQLException(\"Error closing connection\", e);\n+        }\n+    }\n+\n+    void executeBatches() {\n+        try {\n+            int[] transferLists = sqlInsertTransferList.executeBatch();\n+            int[] nonFeeTransfers = sqlInsertNonFeeTransfers.executeBatch();\n+            log.info(\"Inserted {} transfer lists, {} non-fee transfers\", transferLists.length, nonFeeTransfers.length);\n+        } catch (SQLException e) {\n+            log.error(\"Error committing sql insert batch \", e);\n+            throw new ParserSQLException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void onTransaction(Transaction transaction) throws ImporterException {\n+        // to be implemented in followup change", "originalCommit": "657e15655f36fad8da6d5bb73e0597ee18dd3166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0MTA5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/575#discussion_r386541090", "bodyText": "sure thing. In 'postgres writer 3', will change to notimplementedexception for any remaining functions.", "author": "apeksharma", "createdAt": "2020-03-02T17:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4NjcyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4ODA3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/575#discussion_r386488079", "bodyText": "q: what do you think about making a getter for the prepared statements? Might reduce code repetition and ensure statements used by tests modules are always the correct ones.\nNot sure if there's a downside to it", "author": "Nana-EC", "createdAt": "2020-03-02T16:07:40Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/parser/record/PostgresWritingRecordParsedItemHandler.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package com.hedera.mirror.importer.parser.record;\n+\n+/*-\n+ * \u200c\n+ * Hedera Mirror Node\n+ * \u200b\n+ * Copyright (C) 2020 Hedera Hashgraph, LLC\n+ * \u200b\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ * \u200d\n+ */\n+\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import javax.inject.Named;\n+import lombok.extern.log4j.Log4j2;\n+\n+import com.hedera.mirror.importer.domain.ContractResult;\n+import com.hedera.mirror.importer.domain.CryptoTransfer;\n+import com.hedera.mirror.importer.domain.FileData;\n+import com.hedera.mirror.importer.domain.LiveHash;\n+import com.hedera.mirror.importer.domain.NonFeeTransfer;\n+import com.hedera.mirror.importer.domain.TopicMessage;\n+import com.hedera.mirror.importer.domain.Transaction;\n+import com.hedera.mirror.importer.exception.ImporterException;\n+import com.hedera.mirror.importer.exception.ParserSQLException;\n+\n+@Log4j2\n+@Named\n+public class PostgresWritingRecordParsedItemHandler implements RecordParsedItemHandler {\n+    private PreparedStatement sqlInsertTransferList;\n+    private PreparedStatement sqlInsertNonFeeTransfers;\n+\n+    void initSqlStatements(Connection connection) throws ParserSQLException {\n+        try {\n+            sqlInsertTransferList = connection.prepareStatement(\"INSERT INTO t_cryptotransferlists\"", "originalCommit": "657e15655f36fad8da6d5bb73e0597ee18dd3166", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0NjM3OQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/575#discussion_r386546379", "bodyText": "Originally, i was planning to wait a bit until we figured if this code will use Repository or CopyManager or combination or something else.\nHowever, if you have something particular in mind, lemme know, will do in \"Postgres Writer 3\".", "author": "apeksharma", "createdAt": "2020-03-02T17:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4ODA3OQ=="}], "type": "inlineReview", "revised_code": null}]}