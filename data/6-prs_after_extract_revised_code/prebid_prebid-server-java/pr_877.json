{"pr_number": 877, "pr_title": "Log missing video size id for RubiconBidder", "pr_createdAt": "2020-08-26T10:28:12Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/877", "timeline": [{"oid": "f5621ba9a0301812667b4350920aa239f7459a90", "url": "https://github.com/prebid/prebid-server-java/commit/f5621ba9a0301812667b4350920aa239f7459a90", "message": "Log missing video size id for RubiconBidder", "committedDate": "2020-08-26T10:24:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxNDc2NA==", "url": "https://github.com/prebid/prebid-server-java/pull/877#discussion_r547314764", "bodyText": "Please consider passing whole imp and site to makeVideo and let this method pull out everything it needs from these objects.", "author": "schernysh", "createdAt": "2020-12-22T14:41:04Z", "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -331,7 +331,8 @@ private Imp makeImp(Imp imp, ExtImpPrebid extPrebid, ExtImpRubicon extRubicon,\n         if (isVideo(imp)) {\n             builder\n                     .banner(null)\n-                    .video(makeVideo(imp.getVideo(), extRubicon.getVideo(), extPrebid));\n+                    .video(makeVideo(imp.getVideo(), extRubicon.getVideo(), extPrebid,", "originalCommit": "f5621ba9a0301812667b4350920aa239f7459a90", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a0da7b96a8df8132b4b9cd9676f8093b558e96af", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java b/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\nindex c7fb6a964..e5839fd06 100644\n--- a/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\n\n@@ -322,11 +375,10 @@ public class RubiconBidder implements Bidder<BidRequest> {\n         return null;\n     }\n \n-    private Imp makeImp(Imp imp, ExtImpPrebid extPrebid, ExtImpRubicon extRubicon,\n-                        Site site, App app, boolean useFirstPartyData) {\n+    private Imp makeImp(Imp imp, ExtImpPrebid extPrebid, ExtImpRubicon extRubicon, Site site, App app) {\n         final Imp.ImpBuilder builder = imp.toBuilder()\n                 .metric(makeMetrics(imp))\n-                .ext(mapper.mapper().valueToTree(makeImpExt(imp, extRubicon, site, app, useFirstPartyData)));\n+                .ext(mapper.mapper().valueToTree(makeImpExt(imp, extRubicon, site, app)));\n \n         if (isVideo(imp)) {\n             builder\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzMxNjMyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/877#discussion_r547316328", "bodyText": "Please consider using \n  \n    \n      prebid-server-java/src/main/java/org/prebid/server/log/ConditionalLogger.java\n    \n    \n         Line 79\n      in\n      c6c4101\n    \n    \n    \n    \n\n        \n          \n           public void warn(String message, double samplingRate) { \n        \n    \n  \n\n or similar idea to implement logging.", "author": "schernysh", "createdAt": "2020-12-22T14:43:51Z", "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -509,6 +513,14 @@ private Video makeVideo(Video video, RubiconVideoParams rubiconVideoParams, ExtI\n                 .build();\n     }\n \n+    private void validateVideoSizeId(RubiconVideoParams rubiconVideoParams, String referer, String impId) {\n+        final Integer videoSizeId = rubiconVideoParams != null ? rubiconVideoParams.getSizeId() : null;\n+        // log only 1% of cases to monitor how often video impressions does not have size id\n+        if ((videoSizeId == null || videoSizeId == 0) && System.currentTimeMillis() % 100 == 0) {", "originalCommit": "f5621ba9a0301812667b4350920aa239f7459a90", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bcd17e3ae913dc778d2e1b4cec3caeab335b366d", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java b/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\nindex c7fb6a964..c97d4dc76 100644\n--- a/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java\n\n@@ -516,8 +678,15 @@ public class RubiconBidder implements Bidder<BidRequest> {\n     private void validateVideoSizeId(RubiconVideoParams rubiconVideoParams, String referer, String impId) {\n         final Integer videoSizeId = rubiconVideoParams != null ? rubiconVideoParams.getSizeId() : null;\n         // log only 1% of cases to monitor how often video impressions does not have size id\n-        if ((videoSizeId == null || videoSizeId == 0) && System.currentTimeMillis() % 100 == 0) {\n-            logger.warn(\"RP adapter: video request with no size_id. Referrer URL = %s, impId = %s\", referer, impId);\n+        if (videoSizeId == null || videoSizeId == 0) {\n+            warnWithSamplingRate(String.format(\"RP adapter: video request with no size_id. Referrer URL = %s,\"\n+                    + \" impId = %s\", referer, impId), 0.01d);\n+        }\n+    }\n+\n+    private static void warnWithSamplingRate(String message, double samplingRate) {\n+        if (ThreadLocalRandom.current().nextDouble() < samplingRate) {\n+            logger.warn(message);\n         }\n     }\n \n"}}, {"oid": "a0da7b96a8df8132b4b9cd9676f8093b558e96af", "url": "https://github.com/prebid/prebid-server-java/commit/a0da7b96a8df8132b4b9cd9676f8093b558e96af", "message": "Merge branch 'master' into log-zero-video-size-id", "committedDate": "2020-12-24T11:19:11Z", "type": "commit"}, {"oid": "bcd17e3ae913dc778d2e1b4cec3caeab335b366d", "url": "https://github.com/prebid/prebid-server-java/commit/bcd17e3ae913dc778d2e1b4cec3caeab335b366d", "message": "Update sampling logging way", "committedDate": "2020-12-24T11:36:56Z", "type": "commit"}, {"oid": "34ed0eba9543f91aabe3f48b7523b7b7b7866d52", "url": "https://github.com/prebid/prebid-server-java/commit/34ed0eba9543f91aabe3f48b7523b7b7b7866d52", "message": "Use conditional logger for conditional logging", "committedDate": "2021-01-05T12:00:31Z", "type": "commit"}, {"oid": "bca8d398a9bcaccae8a68832dd5cd901665cbedb", "url": "https://github.com/prebid/prebid-server-java/commit/bca8d398a9bcaccae8a68832dd5cd901665cbedb", "message": "Merge branch 'master' into log-zero-video-size-id", "committedDate": "2021-01-14T11:58:08Z", "type": "commit"}]}