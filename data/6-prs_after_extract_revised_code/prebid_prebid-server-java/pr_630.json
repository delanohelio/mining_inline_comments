{"pr_number": 630, "pr_title": "Add schain validation", "pr_createdAt": "2020-02-24T15:23:15Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/630", "timeline": [{"oid": "a7ad52ed587c94ffd88d8e47aa0276f0e844e119", "url": "https://github.com/prebid/prebid-server-java/commit/a7ad52ed587c94ffd88d8e47aa0276f0e844e119", "message": "Add schain validation", "committedDate": "2020-02-24T15:17:41Z", "type": "commit"}, {"oid": "d5c6e0d740f543bac1d4344bea6b77c43c34470b", "url": "https://github.com/prebid/prebid-server-java/commit/d5c6e0d740f543bac1d4344bea6b77c43c34470b", "message": "Change to test-auction-rubicon-appnexus-response.json", "committedDate": "2020-02-24T16:11:43Z", "type": "commit"}, {"oid": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "url": "https://github.com/prebid/prebid-server-java/commit/d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "message": "Change to ApplicationTest", "committedDate": "2020-02-24T16:16:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5NzAyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/630#discussion_r385697028", "bodyText": "schain.schains -> schain (and fix what below also)", "author": "DGarbar", "createdAt": "2020-02-28T13:33:50Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.prebid.server.proto.openrtb.ext.request;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.util.List;\n+\n+/**\n+ * Defines the contract for bidrequest.ext.prebid.schain.schain", "originalCommit": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "chunk": "diff --git a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\nindex 3e7289bc0..8abc2b4ea 100644\n--- a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n+++ b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n\n@@ -7,25 +7,25 @@ import lombok.Value;\n import java.util.List;\n \n /**\n- * Defines the contract for bidrequest.ext.prebid.schain.schain\n+ * Defines the contract for bidrequest.ext.prebid.schain\n  */\n @AllArgsConstructor(staticName = \"of\")\n @Value\n public class ExtRequestPrebidSchainSchain {\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.ver\n+     * Defines the contract for bidrequest.ext.prebid.schain.ver\n      */\n     String ver;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.complete\n+     * Defines the contract for bidrequest.ext.prebid.schain.complete\n      */\n-    Integer comlete;\n+    Integer complete;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.nodes\n      */\n     List<ExtRequestPrebidSchainSchainNode> nodes;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.ext\n      */\n     ObjectNode ext;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5NzA4NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/630#discussion_r385697085", "bodyText": "nodes -> ext", "author": "DGarbar", "createdAt": "2020-02-28T13:33:59Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.prebid.server.proto.openrtb.ext.request;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.util.List;\n+\n+/**\n+ * Defines the contract for bidrequest.ext.prebid.schain.schain\n+ */\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class ExtRequestPrebidSchainSchain {\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.ver\n+     */\n+    String ver;\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.complete\n+     */\n+    Integer comlete;\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     */\n+    List<ExtRequestPrebidSchainSchainNode> nodes;\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes", "originalCommit": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "chunk": "diff --git a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\nindex 3e7289bc0..8abc2b4ea 100644\n--- a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n+++ b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n\n@@ -7,25 +7,25 @@ import lombok.Value;\n import java.util.List;\n \n /**\n- * Defines the contract for bidrequest.ext.prebid.schain.schain\n+ * Defines the contract for bidrequest.ext.prebid.schain\n  */\n @AllArgsConstructor(staticName = \"of\")\n @Value\n public class ExtRequestPrebidSchainSchain {\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.ver\n+     * Defines the contract for bidrequest.ext.prebid.schain.ver\n      */\n     String ver;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.complete\n+     * Defines the contract for bidrequest.ext.prebid.schain.complete\n      */\n-    Integer comlete;\n+    Integer complete;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.nodes\n      */\n     List<ExtRequestPrebidSchainSchainNode> nodes;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.ext\n      */\n     ObjectNode ext;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY5OTQ0NA==", "url": "https://github.com/prebid/prebid-server-java/pull/630#discussion_r385699444", "bodyText": "complete", "author": "DGarbar", "createdAt": "2020-02-28T13:39:12Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package org.prebid.server.proto.openrtb.ext.request;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+import java.util.List;\n+\n+/**\n+ * Defines the contract for bidrequest.ext.prebid.schain.schain\n+ */\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class ExtRequestPrebidSchainSchain {\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.ver\n+     */\n+    String ver;\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.schain.schain.complete\n+     */\n+    Integer comlete;", "originalCommit": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "chunk": "diff --git a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\nindex 3e7289bc0..8abc2b4ea 100644\n--- a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n+++ b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchain.java\n\n@@ -7,25 +7,25 @@ import lombok.Value;\n import java.util.List;\n \n /**\n- * Defines the contract for bidrequest.ext.prebid.schain.schain\n+ * Defines the contract for bidrequest.ext.prebid.schain\n  */\n @AllArgsConstructor(staticName = \"of\")\n @Value\n public class ExtRequestPrebidSchainSchain {\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.ver\n+     * Defines the contract for bidrequest.ext.prebid.schain.ver\n      */\n     String ver;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.complete\n+     * Defines the contract for bidrequest.ext.prebid.schain.complete\n      */\n-    Integer comlete;\n+    Integer complete;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.nodes\n      */\n     List<ExtRequestPrebidSchainSchainNode> nodes;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+     * Defines the contract for bidrequest.ext.prebid.schain.ext\n      */\n     ObjectNode ext;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcwMTYyNg==", "url": "https://github.com/prebid/prebid-server-java/pull/630#discussion_r385701626", "bodyText": "schains", "author": "DGarbar", "createdAt": "2020-02-28T13:43:45Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchainNode.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.prebid.server.proto.openrtb.ext.request;\n+\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+/**\n+ * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes", "originalCommit": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "chunk": "diff --git a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchainNode.java b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchainNode.java\nindex 9c8a1a648..df5438fbe 100644\n--- a/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchainNode.java\n+++ b/src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidSchainSchainNode.java\n\n@@ -5,43 +5,43 @@ import lombok.AllArgsConstructor;\n import lombok.Value;\n \n /**\n- * Defines the contract for bidrequest.ext.prebid.schain.schain.nodes\n+ * Defines the contract for bidrequest.ext.prebid.schains\n  */\n @AllArgsConstructor(staticName = \"of\")\n @Value\n public class ExtRequestPrebidSchainSchainNode {\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.asi\n+     * Defines the contract for bidrequest.ext.prebid.schains.asi\n      */\n     String asi;\n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.sid\n+     * Defines the contract for bidrequest.ext.prebid.schains.sid\n      */\n \n     String sid;\n \n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.hp\n+     * Defines the contract for bidrequest.ext.prebid.schains.hp\n      */\n     Integer hp;\n \n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.rid\n+     * Defines the contract for bidrequest.ext.prebid.schains.rid\n      */\n     String rid;\n \n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.name\n+     * Defines the contract for bidrequest.ext.prebid.schains.name\n      */\n     String name;\n \n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.domain\n+     * Defines the contract for bidrequest.ext.prebid.schains.domain\n      */\n     String domain;\n \n     /**\n-     * Defines the contract for bidrequest.ext.prebid.schain.schain.ext\n+     * Defines the contract for bidrequest.ext.prebid.schains.ext\n      */\n     ObjectNode ext;\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMzQ5Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/630#discussion_r385723496", "bodyText": "Please. Prepare fixture like this\n        final ObjectNode schainExtObjectNode = mapper.createObjectNode().put(\"any\", \"any\");\n        final ExtRequestPrebidSchainSchainNode specificNodes = ExtRequestPrebidSchainSchainNode.of(\"asi\", \"sid\", 1, \"rid\", \"name\", \"domain\", schainExtObjectNode);\n        final ExtRequestPrebidSchainSchain specificSchain = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(specificNodes), schainExtObjectNode);\n        final ExtRequestPrebidSchain schainForBidders = ExtRequestPrebidSchain.of(Arrays.asList(bidder1Name, bidder2Name), specificSchain);\n\n        final ExtRequestPrebidSchainSchainNode generalNodes = ExtRequestPrebidSchainSchainNode.of(\"t\", null, 0, \"a\", null, \"ads\", null);\n        final ExtRequestPrebidSchainSchain generalSchain = ExtRequestPrebidSchainSchain.of(\"t\", 123, singletonList(generalNodes), null);\n        final ExtRequestPrebidSchain allSchain = ExtRequestPrebidSchain.of(singletonList(\"*\"), generalSchain);\n\nTo test real behavior.\nYou need to verify that there some changes for specified bidders, and there are different changes for rest of them.", "author": "DGarbar", "createdAt": "2020-02-28T14:26:31Z", "path": "src/test/java/org/prebid/server/auction/ExchangeServiceTest.java", "diffHunk": "@@ -387,8 +390,10 @@ public void shouldPassRequestWithInjectedSchainInSourceExt() {\n         givenBidder(bidder2Name, bidder2, givenEmptySeatBid());\n         givenBidder(bidder3Name, bidder3, givenEmptySeatBid());\n \n-        final ObjectNode schainObject = mapper.createObjectNode().put(\"var\", \"1\");\n-        final ObjectNode allSchainObject = mapper.createObjectNode().put(\"any\", \"any\");\n+        final ObjectNode objectNode = mapper.createObjectNode().put(\"any\", \"any\");\n+        final ExtRequestPrebidSchainSchainNode nodes = ExtRequestPrebidSchainSchainNode.of(\"asi\", \"sid\", 1, \"rid\", \"name\", \"domain\", objectNode);\n+        final ExtRequestPrebidSchainSchain schainObject = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(nodes), objectNode);\n+        final ExtRequestPrebidSchainSchain allSchainObject = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(nodes), objectNode);", "originalCommit": "d2ae80e25f96104c1bcecfa6f877f682cb16f7f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "chunk": "diff --git a/src/test/java/org/prebid/server/auction/ExchangeServiceTest.java b/src/test/java/org/prebid/server/auction/ExchangeServiceTest.java\nindex ae8dcd646..5ae87d2d6 100644\n--- a/src/test/java/org/prebid/server/auction/ExchangeServiceTest.java\n+++ b/src/test/java/org/prebid/server/auction/ExchangeServiceTest.java\n\n@@ -390,16 +390,18 @@ public class ExchangeServiceTest extends VertxTest {\n         givenBidder(bidder2Name, bidder2, givenEmptySeatBid());\n         givenBidder(bidder3Name, bidder3, givenEmptySeatBid());\n \n-        final ObjectNode objectNode = mapper.createObjectNode().put(\"any\", \"any\");\n-        final ExtRequestPrebidSchainSchainNode nodes = ExtRequestPrebidSchainSchainNode.of(\"asi\", \"sid\", 1, \"rid\", \"name\", \"domain\", objectNode);\n-        final ExtRequestPrebidSchainSchain schainObject = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(nodes), objectNode);\n-        final ExtRequestPrebidSchainSchain allSchainObject = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(nodes), objectNode);\n-        final ExtRequestPrebidSchain schain1 = ExtRequestPrebidSchain.of(Arrays.asList(bidder1Name, bidder2Name),\n-                schainObject);\n-        final ExtRequestPrebidSchain allSchain = ExtRequestPrebidSchain.of(singletonList(\"*\"), allSchainObject);\n+        final ObjectNode schainExtObjectNode = mapper.createObjectNode().put(\"any\", \"any\");\n+        final ExtRequestPrebidSchainSchainNode specificNodes = ExtRequestPrebidSchainSchainNode.of(\"asi\", \"sid\", 1, \"rid\", \"name\", \"domain\", schainExtObjectNode);\n+        final ExtRequestPrebidSchainSchain specificSchain  = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(specificNodes), schainExtObjectNode);\n+        final ExtRequestPrebidSchain schainForBidders = ExtRequestPrebidSchain.of(Arrays.asList(bidder1Name, bidder2Name),\n+                specificSchain);\n+        final ExtRequestPrebidSchainSchain allSchainObject = ExtRequestPrebidSchainSchain.of(\"ver\", 1, singletonList(specificNodes), schainExtObjectNode);\n+        final ExtRequestPrebidSchainSchainNode generalNodes = ExtRequestPrebidSchainSchainNode.of(\"t\", null, 0, \"a\", null, \"ads\", null);\n+        final ExtRequestPrebidSchainSchain generalSchain = ExtRequestPrebidSchainSchain.of(\"t\", 123, singletonList(generalNodes), null);\n+        final ExtRequestPrebidSchain allSchain = ExtRequestPrebidSchain.of(singletonList(\"*\"), generalSchain);\n         final ObjectNode ext = mapper.valueToTree(ExtBidRequest.of(\n                 ExtRequestPrebid.builder()\n-                        .schains(Arrays.asList(schain1, allSchain))\n+                        .schains(Arrays.asList(schainForBidders, allSchain))\n                         .build()));\n \n         final BidRequest bidRequest = givenBidRequest(asList(\n"}}, {"oid": "74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "url": "https://github.com/prebid/prebid-server-java/commit/74e9d5f8a722ddca867dcb9b2ef970f5b7f6def6", "message": "Change tests", "committedDate": "2020-03-03T14:04:16Z", "type": "commit"}, {"oid": "4fd2360e1c7233ec6d64ea0436b44d08901ed98f", "url": "https://github.com/prebid/prebid-server-java/commit/4fd2360e1c7233ec6d64ea0436b44d08901ed98f", "message": "Merge branch 'master' into add-schain-validation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/ExchangeService.java\n#\tsrc/test/java/org/prebid/server/auction/ExchangeServiceTest.java", "committedDate": "2020-05-13T12:58:17Z", "type": "commit"}, {"oid": "e7c2c92c404fe05a3dd92b039def2090d59eb5e1", "url": "https://github.com/prebid/prebid-server-java/commit/e7c2c92c404fe05a3dd92b039def2090d59eb5e1", "message": "Merge branch 'master' into add-schain-validation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/ExchangeService.java", "committedDate": "2020-06-04T07:56:30Z", "type": "commit"}, {"oid": "948a3c2964afa1cfd0a36f3f6ef4d1ea26d2cd14", "url": "https://github.com/prebid/prebid-server-java/commit/948a3c2964afa1cfd0a36f3f6ef4d1ea26d2cd14", "message": "Fixes after review", "committedDate": "2020-06-04T09:23:12Z", "type": "commit"}]}