{"pr_number": 866, "pr_title": "Add eids parameter to url of HttpRequest in AdformBidder", "pr_createdAt": "2020-08-14T14:35:33Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/866", "timeline": [{"oid": "db30a4b328cec4ab2745ff6714be875de79a1476", "url": "https://github.com/prebid/prebid-server-java/commit/db30a4b328cec4ab2745ff6714be875de79a1476", "message": "Add adType parameter to user ext and eids to url", "committedDate": "2020-08-14T14:32:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NzE4OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/866#discussion_r481147189", "bodyText": "change to\n            for (ExtUserEid eid : eids) {\n                final Map<String, Integer> uidMap = eidsMap.computeIfAbsent(eid.getSource(),\n                        ignored -> new HashMap<>());\n                for (ExtUserEidUid uid : eid.getUids()) {\n                    uidMap.put(uid.getId(), uid.getAtype());\n                }\n            }", "author": "DGarbar", "createdAt": "2020-09-01T13:42:50Z", "path": "src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java", "diffHunk": "@@ -47,4 +56,26 @@ AdformDigitrust getAdformDigitrust(ExtUser extUser) {\n                 AdformDigitrustPrivacy.of(extUserDigiTrust.getPref() != 0))\n                 : null;\n     }\n+\n+    /**\n+     * Retrieves eids from user.ext.eids and in case of any exception or invalid values return empty collection.\n+     */\n+    String getEids(ExtUser extUser, JacksonMapper mapper) {\n+        final List<ExtUserEid> eids = extUser != null ? extUser.getEids() : null;\n+        final Map<String, Map<String, Integer>> eidsMap = new HashMap<>();\n+        if (CollectionUtils.isNotEmpty(eids)) {\n+            for (ExtUserEid eid : eids) {", "originalCommit": "db30a4b328cec4ab2745ff6714be875de79a1476", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "195a47692515ca14c61f19115296b783ebd9806f", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java b/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\nindex ac40f147..335f6627 100644\n--- a/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\n+++ b/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\n\n@@ -65,13 +65,14 @@ class AdformRequestUtil {\n         final Map<String, Map<String, Integer>> eidsMap = new HashMap<>();\n         if (CollectionUtils.isNotEmpty(eids)) {\n             for (ExtUserEid eid : eids) {\n-                final Map<String, Integer> uidMap = new HashMap<>();\n+                final Map<String, Integer> uidMap = eidsMap.computeIfAbsent(eid.getSource(),\n+                        ignored -> new HashMap<>());\n                 for (ExtUserEidUid uid : eid.getUids()) {\n                     uidMap.put(uid.getId(), uid.getAtype());\n                 }\n-                eidsMap.put(eid.getSource(), uidMap);\n             }\n         }\n+\n         final String encodedEids = mapper.encode(eidsMap);\n \n         return ObjectUtils\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1MDEwMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/866#discussion_r481150101", "bodyText": "add Tests", "author": "DGarbar", "createdAt": "2020-09-01T13:47:03Z", "path": "src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java", "diffHunk": "@@ -47,4 +56,26 @@ AdformDigitrust getAdformDigitrust(ExtUser extUser) {\n                 AdformDigitrustPrivacy.of(extUserDigiTrust.getPref() != 0))\n                 : null;\n     }\n+\n+    /**\n+     * Retrieves eids from user.ext.eids and in case of any exception or invalid values return empty collection.\n+     */\n+    String getEids(ExtUser extUser, JacksonMapper mapper) {", "originalCommit": "db30a4b328cec4ab2745ff6714be875de79a1476", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "195a47692515ca14c61f19115296b783ebd9806f", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java b/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\nindex ac40f147..335f6627 100644\n--- a/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\n+++ b/src/main/java/org/prebid/server/bidder/adform/AdformRequestUtil.java\n\n@@ -65,13 +65,14 @@ class AdformRequestUtil {\n         final Map<String, Map<String, Integer>> eidsMap = new HashMap<>();\n         if (CollectionUtils.isNotEmpty(eids)) {\n             for (ExtUserEid eid : eids) {\n-                final Map<String, Integer> uidMap = new HashMap<>();\n+                final Map<String, Integer> uidMap = eidsMap.computeIfAbsent(eid.getSource(),\n+                        ignored -> new HashMap<>());\n                 for (ExtUserEidUid uid : eid.getUids()) {\n                     uidMap.put(uid.getId(), uid.getAtype());\n                 }\n-                eidsMap.put(eid.getSource(), uidMap);\n             }\n         }\n+\n         final String encodedEids = mapper.encode(eidsMap);\n \n         return ObjectUtils\n"}}, {"oid": "195a47692515ca14c61f19115296b783ebd9806f", "url": "https://github.com/prebid/prebid-server-java/commit/195a47692515ca14c61f19115296b783ebd9806f", "message": "Small refactoring and add tests for Eids", "committedDate": "2020-09-02T09:48:54Z", "type": "commit"}, {"oid": "38071fdc9f889e0b2eae4421ec716839fc78e094", "url": "https://github.com/prebid/prebid-server-java/commit/38071fdc9f889e0b2eae4421ec716839fc78e094", "message": "Merge branch 'master' into adform-update-request-ext", "committedDate": "2020-09-02T09:57:03Z", "type": "commit"}, {"oid": "b1937bcdc472b9c39a6d6204a847f3c73e7961a6", "url": "https://github.com/prebid/prebid-server-java/commit/b1937bcdc472b9c39a6d6204a847f3c73e7961a6", "message": "Merge changes into master branch", "committedDate": "2020-09-02T10:02:44Z", "type": "commit"}, {"oid": "8fb8cea433c3c3c9b6e37361ccf38dba6cb98ee8", "url": "https://github.com/prebid/prebid-server-java/commit/8fb8cea433c3c3c9b6e37361ccf38dba6cb98ee8", "message": "Merge branch 'master' into adform-update-request-ext", "committedDate": "2020-09-18T12:01:40Z", "type": "commit"}]}