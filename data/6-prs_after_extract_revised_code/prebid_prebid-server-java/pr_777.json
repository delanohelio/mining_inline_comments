{"pr_number": 777, "pr_title": "Add Adocean bidder", "pr_createdAt": "2020-06-26T20:18:53Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/777", "timeline": [{"oid": "3195fb74d14503602e38de2805951283ddc08e49", "url": "https://github.com/prebid/prebid-server-java/commit/3195fb74d14503602e38de2805951283ddc08e49", "message": "AdoceanBidder and tests", "committedDate": "2020-06-26T20:17:04Z", "type": "commit"}, {"oid": "78fdeee5f81cc0668b86502ba5a9bbfe8d70fdc9", "url": "https://github.com/prebid/prebid-server-java/commit/78fdeee5f81cc0668b86502ba5a9bbfe8d70fdc9", "message": "Merge branch 'master' into add-adocean-bidder", "committedDate": "2020-06-26T20:44:16Z", "type": "commit"}, {"oid": "ecabcef4b6cdaa03ba06f321e71a4315073f7e39", "url": "https://github.com/prebid/prebid-server-java/commit/ecabcef4b6cdaa03ba06f321e71a4315073f7e39", "message": "Add integration test", "committedDate": "2020-07-07T22:28:45Z", "type": "commit"}, {"oid": "2795b1959d50403ea8a4ff1a8dd7d856510743af", "url": "https://github.com/prebid/prebid-server-java/commit/2795b1959d50403ea8a4ff1a8dd7d856510743af", "message": "Fix types", "committedDate": "2020-07-07T22:46:39Z", "type": "commit"}, {"oid": "0c2f7edf6679fdcbf44dd63b9f2313b64b3d2e8d", "url": "https://github.com/prebid/prebid-server-java/commit/0c2f7edf6679fdcbf44dd63b9f2313b64b3d2e8d", "message": "Change extUser method", "committedDate": "2020-07-07T22:52:25Z", "type": "commit"}, {"oid": "f302200ed7ba71c18c38aaf8a4c124fe552157b2", "url": "https://github.com/prebid/prebid-server-java/commit/f302200ed7ba71c18c38aaf8a4c124fe552157b2", "message": "Change to test json", "committedDate": "2020-07-08T12:28:47Z", "type": "commit"}, {"oid": "8d84e19d1fc5a5c0e1406ed6d614381f5dcb9e87", "url": "https://github.com/prebid/prebid-server-java/commit/8d84e19d1fc5a5c0e1406ed6d614381f5dcb9e87", "message": "Merge branch 'master' into add-adocean-bidder", "committedDate": "2020-07-08T21:04:22Z", "type": "commit"}, {"oid": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "url": "https://github.com/prebid/prebid-server-java/commit/2673bb0c559fb39cbc370ffa5dc18e17416721f0", "message": "Resolve conflicts", "committedDate": "2020-07-08T21:15:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTMyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r470615328", "bodyText": "There is a bug in this version of bidder. They actually not returning error in case of duplicate. But lets keep it for now", "author": "DGarbar", "createdAt": "2020-08-14T13:13:21Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxNTUwNg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r470615506", "bodyText": "remove final and add", "author": "DGarbar", "createdAt": "2020-08-14T13:13:42Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYxOTU2MA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r470619560", "bodyText": "Try to avoid passing Collection in argument for which you adding result.", "author": "DGarbar", "createdAt": "2020-08-14T13:21:36Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYyMTUzOA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r470621538", "bodyText": "You don't need to throw an exception for this matter", "author": "DGarbar", "createdAt": "2020-08-14T13:25:16Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM5OTAwMg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471399002", "bodyText": "You can omit null parameters", "author": "DGarbar", "createdAt": "2020-08-17T10:52:28Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMjk5NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471412995", "bodyText": "NPE if test is null", "author": "DGarbar", "createdAt": "2020-08-17T11:23:08Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxNDY1OA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471414658", "bodyText": "you really need sorted ?\nJust use  String.join(\"&\", params)", "author": "DGarbar", "createdAt": "2020-08-17T11:26:36Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxNzM4OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471417389", "bodyText": "You can use URIBuilder for this stuff", "author": "DGarbar", "createdAt": "2020-08-17T11:32:33Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyMTkzNw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471421937", "bodyText": "You still can use\nfinal URIBuilder uriBuilder = new URIBuilder(uri);\nfinal List<NameValuePair> queryParams = uriBuilder.getQueryParams();", "author": "DGarbar", "createdAt": "2020-08-17T11:42:19Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyMzAxMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471423011", "bodyText": "If there are no method toBuilder(), you can't use builder().\nTry to gather all required information and then create normal HttpRequest from that, bc this code is not changing the uri in List", "author": "DGarbar", "createdAt": "2020-08-17T11:44:21Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyODQ1NA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471428454", "bodyText": "It can be constant and String", "author": "DGarbar", "createdAt": "2020-08-17T11:55:47Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));\n+        return String.format(\"%s?%s\", updateUrl, urlParams);\n+    }\n+\n+    private static MultiMap getHeaders(BidRequest request) {\n+        final MultiMap headers = HttpUtil.headers();\n+        if (request.getDevice() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n+                    request.getDevice().getUa());\n+\n+            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIp());\n+            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIpv6());\n+            }\n+        }\n+\n+        if (request.getSite() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.REFERER_HEADER, request.getSite().getPage());\n+        }\n+        return headers;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<Void> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        List<NameValuePair> params;\n+        try {\n+            params = URLEncodedUtils.parse(new URI(httpCall.getRequest().getUri()), StandardCharsets.UTF_8);\n+        } catch (URISyntaxException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final Map<String, String> auctionIds = params != null ? params.stream()\n+                .filter(param -> param.getName().equals(\"aid\"))\n+                .map(param -> param.getValue().split(\":\"))\n+                .collect(Collectors.toMap(name -> name[0], value -> value[1])) : null;\n+        List<AdoceanResponseAdUnit> adoceanResponses;\n+        try {\n+            adoceanResponses = getAdoceanResponseAdUnitList(httpCall.getResponse().getBody());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError\n+                    .badServerResponse(\"Failed to decode: No content to map due to end-of-input\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (final AdoceanResponseAdUnit adoceanResponse : adoceanResponses) {\n+            if (adoceanResponse.getError().equals(\"true\")) {\n+                continue;\n+            }\n+\n+            if (auctionIds != null && StringUtils.isNotBlank(auctionIds.get(adoceanResponse.getId()))) {\n+                final BigDecimal price = new BigDecimal(adoceanResponse.getPrice());\n+                final Integer width = Integer.valueOf(adoceanResponse.getWidth());\n+                final Integer height = Integer.valueOf(adoceanResponse.getHeight());\n+\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adoceanResponse.getId())\n+                        .impid(auctionIds.get(adoceanResponse.getId()))\n+                        .adm(getAdm(adoceanResponse))\n+                        .price(price)\n+                        .w(width)\n+                        .h(height)\n+                        .crid(adoceanResponse.getCrid())\n+                        .build();\n+\n+                final String bidCurrency = adoceanResponse.getCurrency() != null\n+                        ? adoceanResponse.getCurrency()\n+                        : DEFAULT_BID_CURRENCY;\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, bidCurrency);\n+                bidderBids.add(bidderBid);\n+            }\n+        }\n+        return Result.of(bidderBids, errors);\n+    }\n+\n+    private List<AdoceanResponseAdUnit> getAdoceanResponseAdUnitList(String responseBody) {\n+        try {\n+            return mapper.mapper().readValue(\n+                    responseBody,\n+                    mapper.mapper().getTypeFactory().constructCollectionType(List.class, AdoceanResponseAdUnit.class));\n+        } catch (IOException ex) {\n+            throw new PreBidException(ex.getMessage());\n+        }\n+    }\n+\n+    private String getAdm(AdoceanResponseAdUnit adoceanResponse) {\n+        final StringBuilder measurementCode = new StringBuilder();\n+        measurementCode.append(\" <script>\")\n+                .append(\" +function() {\")\n+                .append(\" var wu = \\\"%s\\\";\")\n+                .append(\" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\")\n+                .append(\" if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\")\n+                .append(\" (new Image(1,1)).src = wu\")\n+                .append(\" }\")\n+                .append(\" if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\")\n+                .append(\" (new Image(1,1)).src = su\")\n+                .append(\" }\")\n+                .append(\" }();\")\n+                .append(\" </script> \");\n+", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyODg0Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471428847", "bodyText": "just bid. Not updated", "author": "DGarbar", "createdAt": "2020-08-17T11:56:33Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));\n+        return String.format(\"%s?%s\", updateUrl, urlParams);\n+    }\n+\n+    private static MultiMap getHeaders(BidRequest request) {\n+        final MultiMap headers = HttpUtil.headers();\n+        if (request.getDevice() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n+                    request.getDevice().getUa());\n+\n+            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIp());\n+            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIpv6());\n+            }\n+        }\n+\n+        if (request.getSite() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.REFERER_HEADER, request.getSite().getPage());\n+        }\n+        return headers;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<Void> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        List<NameValuePair> params;\n+        try {\n+            params = URLEncodedUtils.parse(new URI(httpCall.getRequest().getUri()), StandardCharsets.UTF_8);\n+        } catch (URISyntaxException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final Map<String, String> auctionIds = params != null ? params.stream()\n+                .filter(param -> param.getName().equals(\"aid\"))\n+                .map(param -> param.getValue().split(\":\"))\n+                .collect(Collectors.toMap(name -> name[0], value -> value[1])) : null;\n+        List<AdoceanResponseAdUnit> adoceanResponses;\n+        try {\n+            adoceanResponses = getAdoceanResponseAdUnitList(httpCall.getResponse().getBody());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError\n+                    .badServerResponse(\"Failed to decode: No content to map due to end-of-input\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (final AdoceanResponseAdUnit adoceanResponse : adoceanResponses) {\n+            if (adoceanResponse.getError().equals(\"true\")) {\n+                continue;\n+            }\n+\n+            if (auctionIds != null && StringUtils.isNotBlank(auctionIds.get(adoceanResponse.getId()))) {\n+                final BigDecimal price = new BigDecimal(adoceanResponse.getPrice());\n+                final Integer width = Integer.valueOf(adoceanResponse.getWidth());\n+                final Integer height = Integer.valueOf(adoceanResponse.getHeight());\n+\n+                final Bid updatedBid = Bid.builder()", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQyOTY2MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471429661", "bodyText": "redundant", "author": "DGarbar", "createdAt": "2020-08-17T11:58:19Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));\n+        return String.format(\"%s?%s\", updateUrl, urlParams);\n+    }\n+\n+    private static MultiMap getHeaders(BidRequest request) {\n+        final MultiMap headers = HttpUtil.headers();\n+        if (request.getDevice() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n+                    request.getDevice().getUa());\n+\n+            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIp());\n+            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIpv6());\n+            }\n+        }\n+\n+        if (request.getSite() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.REFERER_HEADER, request.getSite().getPage());\n+        }\n+        return headers;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<Void> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        List<NameValuePair> params;\n+        try {\n+            params = URLEncodedUtils.parse(new URI(httpCall.getRequest().getUri()), StandardCharsets.UTF_8);\n+        } catch (URISyntaxException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final Map<String, String> auctionIds = params != null ? params.stream()\n+                .filter(param -> param.getName().equals(\"aid\"))\n+                .map(param -> param.getValue().split(\":\"))\n+                .collect(Collectors.toMap(name -> name[0], value -> value[1])) : null;\n+        List<AdoceanResponseAdUnit> adoceanResponses;\n+        try {\n+            adoceanResponses = getAdoceanResponseAdUnitList(httpCall.getResponse().getBody());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError\n+                    .badServerResponse(\"Failed to decode: No content to map due to end-of-input\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzMzU5OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471433599", "bodyText": "final List<BidderError> errors = new ArrayList<>();\n        final List<BidderBid> bidderBids = adoceanResponses.stream()\n                .filter(adoceanResponse -> !adoceanResponse.getError().equals(\"true\"))\n                .filter(adoceanResponse -> auctionIds != null\n                        && StringUtils.isNotBlank(auctionIds.get(adoceanResponse.getId())))\n                .map(adoceanResponse -> BidderBid.of(createBid(auctionIds, adoceanResponse), BidType.banner,\n                        getBidCurrency(adoceanResponse)))\n                .collect(Collectors.toList());\n\n        return Result.of(bidderBids, errors);\n    }\n\n    private static Bid createBid(Map<String, String> auctionIds, AdoceanResponseAdUnit adoceanResponse) {\n        return Bid.builder()\n                .id(adoceanResponse.getId())\n                .impid(auctionIds.get(adoceanResponse.getId()))\n                .adm(getAdm(adoceanResponse))\n                .price(new BigDecimal(adoceanResponse.getPrice()))\n                .w(Integer.valueOf(adoceanResponse.getWidth()))\n                .h(Integer.valueOf(adoceanResponse.getHeight()))\n                .crid(adoceanResponse.getCrid())\n                .build();\n    }\n\n    private static String getBidCurrency(AdoceanResponseAdUnit adoceanResponse) {\n        return adoceanResponse.getCurrency() != null\n                ? adoceanResponse.getCurrency()\n                : DEFAULT_BID_CURRENCY;\n    }", "author": "DGarbar", "createdAt": "2020-08-17T12:06:36Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                params.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    request.builder().uri(url);\n+                    return true;\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test == 1) {\n+            randomizedPart = 10000000;\n+        }\n+\n+        final String updateUrl = String.format(\"%s%s%s%s\", url, \"/_\", randomizedPart, \"/ad.json\");\n+\n+        final List<String> params = new ArrayList<>();\n+        params.add(\"pbsrv_v=\" + VERSION);\n+        params.add(\"id=\" + extImpAdocean.getMasterId());\n+        params.add(\"nc=1\");\n+        params.add(\"nosecure=1\");\n+        params.add(\"aid=\" + extImpAdocean.getSlaveId() + \":\" + impid);\n+\n+        if (StringUtils.isNotBlank(consentString)) {\n+            params.add(\"gdpr_consent=\" + consentString);\n+            params.add(\"gdpr=1\");\n+        }\n+        if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n+            params.add(\"hcuserid=\" + user.getBuyeruid());\n+        }\n+\n+        final String urlParams = params.stream().sorted().collect(Collectors.joining(\"&\"));\n+        return String.format(\"%s?%s\", updateUrl, urlParams);\n+    }\n+\n+    private static MultiMap getHeaders(BidRequest request) {\n+        final MultiMap headers = HttpUtil.headers();\n+        if (request.getDevice() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n+                    request.getDevice().getUa());\n+\n+            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIp());\n+            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n+                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n+                        request.getDevice().getIpv6());\n+            }\n+        }\n+\n+        if (request.getSite() != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.REFERER_HEADER, request.getSite().getPage());\n+        }\n+        return headers;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<Void> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        List<NameValuePair> params;\n+        try {\n+            params = URLEncodedUtils.parse(new URI(httpCall.getRequest().getUri()), StandardCharsets.UTF_8);\n+        } catch (URISyntaxException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final Map<String, String> auctionIds = params != null ? params.stream()\n+                .filter(param -> param.getName().equals(\"aid\"))\n+                .map(param -> param.getValue().split(\":\"))\n+                .collect(Collectors.toMap(name -> name[0], value -> value[1])) : null;\n+        List<AdoceanResponseAdUnit> adoceanResponses;\n+        try {\n+            adoceanResponses = getAdoceanResponseAdUnitList(httpCall.getResponse().getBody());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError\n+                    .badServerResponse(\"Failed to decode: No content to map due to end-of-input\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (final AdoceanResponseAdUnit adoceanResponse : adoceanResponses) {\n+            if (adoceanResponse.getError().equals(\"true\")) {\n+                continue;\n+            }\n+\n+            if (auctionIds != null && StringUtils.isNotBlank(auctionIds.get(adoceanResponse.getId()))) {\n+                final BigDecimal price = new BigDecimal(adoceanResponse.getPrice());\n+                final Integer width = Integer.valueOf(adoceanResponse.getWidth());\n+                final Integer height = Integer.valueOf(adoceanResponse.getHeight());\n+\n+                final Bid updatedBid = Bid.builder()\n+                        .id(adoceanResponse.getId())\n+                        .impid(auctionIds.get(adoceanResponse.getId()))\n+                        .adm(getAdm(adoceanResponse))\n+                        .price(price)\n+                        .w(width)\n+                        .h(height)\n+                        .crid(adoceanResponse.getCrid())\n+                        .build();\n+\n+                final String bidCurrency = adoceanResponse.getCurrency() != null\n+                        ? adoceanResponse.getCurrency()\n+                        : DEFAULT_BID_CURRENCY;\n+                final BidderBid bidderBid = BidderBid.of(updatedBid, BidType.banner, bidCurrency);\n+                bidderBids.add(bidderBid);\n+            }\n+        }\n+        return Result.of(bidderBids, errors);", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNDMyMQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471434321", "bodyText": "Set is redundant", "author": "DGarbar", "createdAt": "2020-08-17T12:08:09Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNTczNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471435735", "bodyText": "Does Banner and User is really necessary for this test ?\nAlso use codeStyle like this\n   Imp.builder()\n                                .id(\"ao-test\")\n                                .ext(mapper.valueToTree(ExtPrebid.of(null,\n                                        ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n                                                \"adoceanmyaozpniqis\"))))\n                                .build()))", "author": "DGarbar", "createdAt": "2020-08-17T12:11:10Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNjAyMA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471436020", "bodyText": "Same as above", "author": "DGarbar", "createdAt": "2020-08-17T12:11:45Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build(),\n+                        Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqis\")))).build()))\n+                .test(1)\n+\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Request already exists\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrl() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgA\"\n+                                        + \"AAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNjU3Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471436573", "bodyText": "Same as above", "author": "DGarbar", "createdAt": "2020-08-17T12:12:58Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build(),\n+                        Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqis\")))).build()))\n+                .test(1)\n+\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Request already exists\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrl() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgA\"\n+                                        + \"AAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(HttpRequest::getUri)\n+                .containsOnly(\"https://myao.adocean.pl/_10000000/ad.json?aid=adoceanmyaozpniqismex:ao-test&gdpr=1&gdpr_consent=COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw&id=tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7&nc=1&nosecure=1&pbsrv_v=1.0.0\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpIsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAg\"\n+                                        + \"AAAYQEAAAQmAgBC3ZAYzUw\").build())", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzNjY2Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471436662", "bodyText": "Same as above", "author": "DGarbar", "createdAt": "2020-08-17T12:13:11Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build(),\n+                        Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqis\")))).build()))\n+                .test(1)\n+\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Request already exists\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrl() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgA\"\n+                                        + \"AAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(HttpRequest::getUri)\n+                .containsOnly(\"https://myao.adocean.pl/_10000000/ad.json?aid=adoceanmyaozpniqismex:ao-test&gdpr=1&gdpr_consent=COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw&id=tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7&nc=1&nosecure=1&pbsrv_v=1.0.0\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpIsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAg\"\n+                                        + \"AAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build())\n+                                .ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .device(Device.builder().ip(\"192.168.1.1\").build())\n+                .site(Site.builder().page(\"http://www.example.com\").build())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()),\n+                        tuple(HttpUtil.X_FORWARDED_FOR_HEADER.toString(), \"192.168.1.1\"),\n+                        tuple(HttpUtil.REFERER_HEADER.toString(), \"http://www.example.com\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpv6IsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACA\"\n+                                        + \"IAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAA\"\n+                                        + \"AYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzODIzNw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471438237", "bodyText": "\":\" - is illegal parameter for URL (encode it)\nOr use URLBuilder", "author": "DGarbar", "createdAt": "2020-08-17T12:16:26Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,293 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                httpRequests.add(createSingleRequest(httpRequests, request, imp, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(List<HttpRequest<Void>> httpRequests, BidRequest request, Imp imp,\n+                                                  String consentString) {\n+        final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+\n+        if (isRequestAdded(httpRequests, extImpAdocean, imp.getId())) {\n+            throw new PreBidException(\"Request already exists\");\n+        }\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .body(null)\n+                .headers(getHeaders(request))\n+                .payload(null)\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequestAdded(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (final HttpRequest request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            try {\n+                params = URLEncodedUtils.parse(new URI(request.getUri()), StandardCharsets.UTF_8);\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final String masterId = params != null ? params.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null) : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = params.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 925d67ce..17f53a59 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -12,6 +12,7 @@ import io.vertx.core.http.HttpMethod;\n import org.apache.commons.collections4.CollectionUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n import org.apache.http.client.utils.URLEncodedUtils;\n import org.apache.http.message.BasicNameValuePair;\n import org.prebid.server.bidder.Bidder;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzODg3NA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471438874", "bodyText": "\\n", "author": "DGarbar", "createdAt": "2020-08-17T12:17:45Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build(),\n+                        Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqis\")))).build()))\n+                .test(1)\n+\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Request already exists\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrl() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgA\"\n+                                        + \"AAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(HttpRequest::getUri)\n+                .containsOnly(\"https://myao.adocean.pl/_10000000/ad.json?aid=adoceanmyaozpniqismex:ao-test&gdpr=1&gdpr_consent=COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw&id=tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7&nc=1&nosecure=1&pbsrv_v=1.0.0\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpIsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAg\"\n+                                        + \"AAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build())\n+                                .ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .device(Device.builder().ip(\"192.168.1.1\").build())\n+                .site(Site.builder().page(\"http://www.example.com\").build())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()),\n+                        tuple(HttpUtil.X_FORWARDED_FOR_HEADER.toString(), \"192.168.1.1\"),\n+                        tuple(HttpUtil.REFERER_HEADER.toString(), \"http://www.example.com\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpv6IsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACA\"\n+                                        + \"IAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAA\"\n+                                        + \"AYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .device(Device.builder().ipv6(\"2001:0db8:85a3:0000:0000:8a2e:0370:7334\").build())\n+                .site(Site.builder().page(\"http://www.example.com\").build())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()),\n+                        tuple(HttpUtil.X_FORWARDED_FOR_HEADER.toString(), \"2001:0db8:85a3:0000:0000:8a2e:0370:7334\"),\n+                        tuple(HttpUtil.REFERER_HEADER.toString(), \"http://www.example.com\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseWithNoContent() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(204, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseStatusIsNotOk() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(404, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Unexpected HTTP status 404.\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseStatusIsBadRequest() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(400, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Invalid request.\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<Void> httpCall = givenHttpCall(null, \"\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"Failed to decode: No content to map due to end-of-input\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnCorrectBidderBid() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"impId\")\n+                        .build()))\n+                .build();\n+\n+        final List<AdoceanResponseAdUnit> adoceanResponseAdUnit = asList(AdoceanResponseAdUnit.builder()", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQzOTM4Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r471439383", "bodyText": "Add test on .error(\"true\")", "author": "DGarbar", "createdAt": "2020-08-17T12:18:45Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -0,0 +1,380 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.smartrtb.SmartrtbBidder;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.math.BigDecimal;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static java.util.Arrays.asList;\n+\n+public class AdoceanBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://{{Host}}\";\n+\n+    private AdoceanBidder adoceanBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adoceanBidder = new AdoceanBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException()\n+                .isThrownBy(() -> new SmartrtbBidder(\"invalid_url\", jacksonMapper))\n+                .withMessage(\"URL supplied is not valid: invalid_url\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpressionListSizeIsZero() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(emptyList())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1)\n+                .containsOnly(BidderError.badInput(\"No impression in the bid request\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n+                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n+                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(asList(Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build(),\n+                        Imp.builder()\n+                                .id(\"ao-test\")\n+                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqis\")))).build()))\n+                .test(1)\n+\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Request already exists\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrl() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgA\"\n+                                        + \"AAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(HttpRequest::getUri)\n+                .containsOnly(\"https://myao.adocean.pl/_10000000/ad.json?aid=adoceanmyaozpniqismex:ao-test&gdpr=1&gdpr_consent=COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw&id=tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7&nc=1&nosecure=1&pbsrv_v=1.0.0\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpIsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAAC\"\n+                                        + \"AIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAg\"\n+                                        + \"AAAYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build())\n+                                .ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .device(Device.builder().ip(\"192.168.1.1\").build())\n+                .site(Site.builder().page(\"http://www.example.com\").build())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()),\n+                        tuple(HttpUtil.X_FORWARDED_FOR_HEADER.toString(), \"192.168.1.1\"),\n+                        tuple(HttpUtil.REFERER_HEADER.toString(), \"http://www.example.com\"));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedHeadersIfDeviceIpv6IsPresent() {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.IFoEUQQgAIQwgIwQABAEAAAAOIAACA\"\n+                                        + \"IAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAAAFAAECAAAgAAQARAEQAAAAAJAAIAAgAA\"\n+                                        + \"AYQEAAAQmAgBC3ZAYzUw\").build())\n+                        .build())\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"ao-test\")\n+                        .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n+                                .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n+                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n+                                        \"adoceanmyaozpniqismex\")))).build()))\n+                .test(1)\n+                .device(Device.builder().ipv6(\"2001:0db8:85a3:0000:0000:8a2e:0370:7334\").build())\n+                .site(Site.builder().page(\"http://www.example.com\").build())\n+                .build();\n+\n+        // when\n+        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()),\n+                        tuple(HttpUtil.X_FORWARDED_FOR_HEADER.toString(), \"2001:0db8:85a3:0000:0000:8a2e:0370:7334\"),\n+                        tuple(HttpUtil.REFERER_HEADER.toString(), \"http://www.example.com\"));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseWithNoContent() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(204, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseStatusIsNotOk() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(404, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Unexpected HTTP status 404.\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyResultWhenResponseStatusIsBadRequest() {\n+        // given\n+        final HttpCall<Void> httpCall = HttpCall\n+                .success(null, HttpResponse.of(400, null, null), null);\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Invalid request.\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<Void> httpCall = givenHttpCall(null, \"\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"Failed to decode: No content to map due to end-of-input\");\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnCorrectBidderBid() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"impId\")\n+                        .build()))\n+                .build();\n+\n+        final List<AdoceanResponseAdUnit> adoceanResponseAdUnit = asList(AdoceanResponseAdUnit.builder()\n+                .id(\"adoceanmyaozpniqismex\")\n+                .price(\"1\")\n+                .winUrl(\"https://win-url.com\")\n+                .statsUrl(\"https://stats-url.com\")\n+                .code(\" <!-- code 1 --> \")\n+                .currency(\"EUR\")\n+                .width(\"300\")\n+                .height(\"250\")\n+                .crid(\"0af345b42983cc4bc0\")\n+                .error(\"false\")\n+                .build(),\n+                AdoceanResponseAdUnit.builder()\n+                        .id(\"adoceanmyaozpniqis\")\n+                        .price(\"1\")\n+                        .winUrl(\"https://win-url.com\")\n+                        .statsUrl(\"https://stats-url.com\")\n+                        .code(\" <!-- code 1 --> \")\n+                        .currency(\"EUR\")\n+                        .width(\"300\")\n+                        .height(\"250\")\n+                        .crid(\"0af345b42983cc4bc0\")\n+                        .error(\"false\")\n+                        .build());\n+\n+        final HttpCall<Void> httpCall = givenHttpCall(null, mapper.writeValueAsString(adoceanResponseAdUnit));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        final StringBuilder admBuilder = new StringBuilder();\n+        admBuilder.append(\" <script>\")\n+                .append(\" +function() {\")\n+                .append(\" var wu = \\\"https://win-url.com\\\";\")\n+                .append(\" var su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\")\n+                .append(\" if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\")\n+                .append(\" (new Image(1,1)).src = wu\")\n+                .append(\" }\")\n+                .append(\" if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\")\n+                .append(\" (new Image(1,1)).src = su\")\n+                .append(\" }\")\n+                .append(\" }();\")\n+                .append(\" </script> \")\n+                .append(\" <!-- code 1 --> \");\n+        final String adm = admBuilder.toString();\n+\n+        final BidderBid expected = BidderBid.of(\n+                Bid.builder()\n+                        .id(\"adoceanmyaozpniqismex\")\n+                        .impid(\"ao-test\")\n+                        .adm(adm)\n+                        .price(BigDecimal.valueOf(1))\n+                        .crid(\"0af345b42983cc4bc0\")\n+                        .w(300)\n+                        .h(250)\n+                        .build(),\n+                BidType.banner, \"EUR\");\n+        assertThat(result.getValue().get(0).getBid().getAdm()).isEqualTo(adm);\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).doesNotContainNull().hasSize(1).element(0).isEqualTo(expected);\n+    }\n+", "originalCommit": "2673bb0c559fb39cbc370ffa5dc18e17416721f0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6248def17bb8c54cff52580baf0e43371a0181fa", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 2af5e18f..44172b58 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -28,6 +28,7 @@ import org.prebid.server.proto.openrtb.ext.response.BidType;\n import org.prebid.server.util.HttpUtil;\n \n import java.math.BigDecimal;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.function.Function;\n"}}, {"oid": "6248def17bb8c54cff52580baf0e43371a0181fa", "url": "https://github.com/prebid/prebid-server-java/commit/6248def17bb8c54cff52580baf0e43371a0181fa", "message": "Refactoring after review", "committedDate": "2020-08-18T16:29:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MzI4Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473043283", "bodyText": "you can remove all \\t and \\n and keep spaces that it was still syntactically correct. (You can check GO)", "author": "DGarbar", "createdAt": "2020-08-19T13:48:32Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0MzY1Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473243657", "bodyText": "This is Java. When we do \\n we create separate string. You can look such case in SharethroughMarkupUtil", "author": "AndriyPavlyuk", "createdAt": "2020-08-19T18:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MzI4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzczMDE4Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473730186", "bodyText": "So you are saying that this is perfectly valid JS script ? Pls check Go test case. They removing all the /n /t and set only \u0449ne space between code.", "author": "DGarbar", "createdAt": "2020-08-20T07:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MzI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0NjU5Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473046597", "bodyText": "replace name to addRequestAndCheckIfDuplicates", "author": "DGarbar", "createdAt": "2020-08-19T13:53:13Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+                if (isRequest(httpRequests, extImpAdocean, imp.getId())) {\n+                    continue;\n+                }\n+                httpRequests.add(createSingleRequest(request, imp, extImpAdocean, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(BidRequest request, Imp imp, ExtImpAdocean extImpAdocean,\n+                                                  String consentString) {\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .headers(getHeaders(request))\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequest(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0NzY5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473047693", "bodyText": "expand catch block to include depending code. (Put this into end of the method)\nThrow exception in case of an error, not just print it", "author": "DGarbar", "createdAt": "2020-08-19T13:54:50Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+                if (isRequest(httpRequests, extImpAdocean, imp.getId())) {\n+                    continue;\n+                }\n+                httpRequests.add(createSingleRequest(request, imp, extImpAdocean, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(BidRequest request, Imp imp, ExtImpAdocean extImpAdocean,\n+                                                  String consentString) {\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .headers(getHeaders(request))\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequest(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (HttpRequest<Void> request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            URIBuilder uriBuilder = null;\n+            try {\n+                uriBuilder = new URIBuilder(request.getUri());\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0OTQ5Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473049497", "bodyText": "Put methods by call ordering. (how they was called in code)", "author": "DGarbar", "createdAt": "2020-08-19T13:56:59Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+                if (isRequest(httpRequests, extImpAdocean, imp.getId())) {\n+                    continue;\n+                }\n+                httpRequests.add(createSingleRequest(request, imp, extImpAdocean, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(BidRequest request, Imp imp, ExtImpAdocean extImpAdocean,", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0OTgxNw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473049817", "bodyText": "You don't really need this", "author": "DGarbar", "createdAt": "2020-08-19T13:57:25Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1NTEzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473255130", "bodyText": "Why? In Go they collect errors", "author": "AndriyPavlyuk", "createdAt": "2020-08-19T19:02:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0OTgxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzcyODE5OA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473728198", "bodyText": "Bc you don't collecting them. This collection will have only 1 value", "author": "DGarbar", "createdAt": "2020-08-20T07:56:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0OTgxNw=="}], "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1MTc0Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473051743", "bodyText": "99999999 - 10000000 = 89999999", "author": "DGarbar", "createdAt": "2020-08-19T14:00:01Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+                if (isRequest(httpRequests, extImpAdocean, imp.getId())) {\n+                    continue;\n+                }\n+                httpRequests.add(createSingleRequest(request, imp, extImpAdocean, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(BidRequest request, Imp imp, ExtImpAdocean extImpAdocean,\n+                                                  String consentString) {\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .headers(getHeaders(request))\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequest(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (HttpRequest<Void> request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            URIBuilder uriBuilder = null;\n+            try {\n+                uriBuilder = new URIBuilder(request.getUri());\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final List<NameValuePair> queryParams = uriBuilder != null ? uriBuilder.getQueryParams() : null;\n+\n+            final String masterId = queryParams != null\n+                    ? queryParams.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null)\n+                    : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = queryParams.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    return true;\n+                }\n+                queryParams.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA1Mjg3NA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473052874", "bodyText": "you car replace this using ? :", "author": "DGarbar", "createdAt": "2020-08-19T14:01:36Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -0,0 +1,288 @@\n+package org.prebid.server.bidder.adocean;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.User;\n+import com.iab.openrtb.response.Bid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.http.NameValuePair;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.http.client.utils.URLEncodedUtils;\n+import org.apache.http.message.BasicNameValuePair;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adocean.model.AdoceanResponseAdUnit;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ExtUser;\n+import org.prebid.server.proto.openrtb.ext.request.adocean.ExtImpAdocean;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.io.IOException;\n+import java.math.BigDecimal;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class AdoceanBidder implements Bidder<Void> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdocean>> ADOCEAN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdocean>>() {\n+            };\n+    private static final String VERSION = \"1.0.0\";\n+    private static final int MAX_URI_LENGTH = 8000;\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n+            + \"\\t\\t+function() {\\n\"\n+            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n+            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\n\"\n+            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+            + \"\\t\\t\\t}\\n\"\n+            + \"\\t\\t}();\\n\"\n+            + \"\\t</script>\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdoceanBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<Void>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final User user = request.getUser();\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final String consent = extUser != null ? extUser.getConsent() : null;\n+        final String consentString = StringUtils.isNotBlank(consent) ? consent : \"\";\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<Void>> httpRequests = new ArrayList<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdocean extImpAdocean = parseImpExt(imp);\n+                if (isRequest(httpRequests, extImpAdocean, imp.getId())) {\n+                    continue;\n+                }\n+                httpRequests.add(createSingleRequest(request, imp, extImpAdocean, consentString));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+                return Result.of(Collections.emptyList(), errors);\n+            }\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private HttpRequest<Void> createSingleRequest(BidRequest request, Imp imp, ExtImpAdocean extImpAdocean,\n+                                                  String consentString) {\n+\n+        return HttpRequest.<Void>builder()\n+                .method(HttpMethod.GET)\n+                .uri(buildUrl(imp.getId(), extImpAdocean, consentString, request.getTest(), request.getUser()))\n+                .headers(getHeaders(request))\n+                .build();\n+    }\n+\n+    private ExtImpAdocean parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), ADOCEAN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private boolean isRequest(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+        for (HttpRequest<Void> request : httpRequests) {\n+            List<NameValuePair> params = null;\n+            URIBuilder uriBuilder = null;\n+            try {\n+                uriBuilder = new URIBuilder(request.getUri());\n+            } catch (URISyntaxException e) {\n+                e.printStackTrace();\n+            }\n+            final List<NameValuePair> queryParams = uriBuilder != null ? uriBuilder.getQueryParams() : null;\n+\n+            final String masterId = queryParams != null\n+                    ? queryParams.stream()\n+                    .filter(param -> param.getName().equals(\"id\"))\n+                    .findFirst()\n+                    .map(NameValuePair::getValue)\n+                    .orElse(null)\n+                    : null;\n+\n+            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n+                final String newSlaveId = queryParams.stream()\n+                        .filter(param -> param.getName().equals(\"aid\"))\n+                        .map(param -> param.getValue().split(\":\")[0])\n+                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                        .findFirst()\n+                        .orElse(null);\n+                if (StringUtils.isNotBlank(newSlaveId)) {\n+                    continue;\n+                }\n+\n+                final String url = HttpUtil.encodeUrl(String.valueOf(params));\n+                if (url.length() < MAX_URI_LENGTH) {\n+                    return true;\n+                }\n+                queryParams.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consentString, Integer test, User user) {\n+        final String url = endpointUrl.replace(\"{{Host}}\", extImpAdocean.getEmitterDomain());\n+        int randomizedPart = 10000000 + (int) (Math.random() * (99999999 - 10000000));\n+        if (test != null && test == 1) {\n+            randomizedPart = 10000000;\n+        }", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 17f53a59..9661fdde 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,20 +50,10 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA2MTEzNw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473061137", "bodyText": "This test is still cover use case. Just rename it to\nmakeHttpRequestsShouldSetReturnErrorIfRequestIsDuplicate", "author": "DGarbar", "createdAt": "2020-08-19T14:13:13Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -88,56 +89,19 @@ public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n         assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Cannot deserialize instance\");\n     }\n \n-    @Test\n-    public void makeHttpRequestsShouldSetReturnErrorIfRequestExists() {\n-        // given\n-        final BidRequest bidRequest = BidRequest.builder()\n-                .user(User.builder()\n-                        .ext(ExtUser.builder()\n-                                .consent(\"COwK6gaOwK6gaFmAAAENAPCAAAAAAAAAAAAAAAAAAAAA.\"\n-                                        + \"IFoEUQQgAIQwgIwQABAEAAAAOIAACAIAAAAQAIAgEAACEAAAAAgAQBAAAAAAAGBAAgAAAAAA\"\n-                                        + \"AFAAECAAAgAAQARAEQAAAAAJAAIAAgAAAYQEAAAQmAgBC3ZAYzUw\").build())\n-                        .build())\n-                .imp(asList(Imp.builder()\n-                                .id(\"ao-test\")\n-                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n-                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n-                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n-                                        \"adoceanmyaozpniqismex\")))).build(),\n-                        Imp.builder()\n-                                .id(\"ao-test\")\n-                                .banner(Banner.builder().format(singletonList(Format.builder().w(300).h(250).build()))\n-                                        .id(\"banner_id\").build()).ext(mapper.valueToTree(ExtPrebid.of(null,\n-                                ExtImpAdocean.of(\"myao.adocean.pl\", \"tmYF.DMl7ZBq.Nqt2Bq4FutQTJfTpxCOmtNPZoQUDcL.G7\",\n-                                        \"adoceanmyaozpniqis\")))).build()))\n-                .test(1)\n-\n-                .build();\n-\n-        // when\n-        final Result<List<HttpRequest<Void>>> result = adoceanBidder.makeHttpRequests(bidRequest);\n-\n-        // then\n-        assertThat(result.getErrors()).hasSize(1);", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1OTgxNw==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473259817", "bodyText": "You commented that we do not need to throw exception. In Go they do not add error in this case", "author": "AndriyPavlyuk", "createdAt": "2020-08-19T19:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA2MTEzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA2MjA0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473062046", "bodyText": "Redundant.\nPls check variables usage. If they are grey in IDE they are not used", "author": "DGarbar", "createdAt": "2020-08-19T14:14:27Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -347,6 +308,76 @@ public void makeBidsShouldReturnCorrectBidderBid() throws JsonProcessingExceptio\n         assertThat(result.getValue()).doesNotContainNull().hasSize(1).element(0).isEqualTo(expected);\n     }\n \n+    @Test\n+    public void makeBidsShouldReturnEmptyListOfBids() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder()\n+                        .id(\"impId\")\n+                        .build()))\n+                .build();\n+        final List<AdoceanResponseAdUnit> adoceanResponseAdUnit = asList(AdoceanResponseAdUnit.builder()\n+                        .id(\"ad\")\n+                        .price(\"1\")\n+                        .winUrl(\"https://win-url.com\")\n+                        .statsUrl(\"https://stats-url.com\")\n+                        .code(\" <!-- code 1 --> \")\n+                        .currency(\"EUR\")\n+                        .width(\"300\")\n+                        .height(\"250\")\n+                        .crid(\"0af345b42983cc4bc0\")\n+                        .error(\"true\")\n+                        .build(),\n+                AdoceanResponseAdUnit.builder()\n+                        .id(\"adoceanmyaozpniqis\")\n+                        .price(\"1\")\n+                        .winUrl(\"https://win-url.com\")\n+                        .statsUrl(\"https://stats-url.com\")\n+                        .code(\" <!-- code 1 --> \")\n+                        .currency(\"EUR\")\n+                        .width(\"300\")\n+                        .height(\"250\")\n+                        .crid(\"0af345b42983cc4bc0\")\n+                        .error(\"false\")\n+                        .build());\n+\n+        final HttpCall<Void> httpCall = givenHttpCall(null, mapper.writeValueAsString(adoceanResponseAdUnit));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        final String adm = \"<script>\\n\"\n+                + \"\\t\\t+function() {\\n\"\n+                + \"\\t\\t\\tvar wu = \\\"https://win-url.com\\\";\\n\"\n+                + \"\\t\\t\\tvar su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n+                + \"\\n\"\n+                + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n+                + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n+                + \"\\t\\t\\t}\\n\"\n+                + \"\\n\"\n+                + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n+                + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n+                + \"\\t\\t\\t}\\n\"\n+                + \"\\t\\t}();\\n\"\n+                + \"\\t</script> <!-- code 1 --> \";\n+\n+        final BidderBid expected = BidderBid.of(\n+                Bid.builder()\n+                        .id(\"ad\")\n+                        .impid(\"ao-test\")\n+                        .adm(adm)\n+                        .price(BigDecimal.valueOf(1))\n+                        .crid(\"0af345b42983cc4bc0\")\n+                        .w(300)\n+                        .h(250)\n+                        .build(),", "originalCommit": "6248def17bb8c54cff52580baf0e43371a0181fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 44172b58..712ee9d7 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -361,19 +348,6 @@ public class AdoceanBidderTest extends VertxTest {\n                 + \"\\t\\t\\t}\\n\"\n                 + \"\\t\\t}();\\n\"\n                 + \"\\t</script> <!-- code 1 --> \";\n-\n-        final BidderBid expected = BidderBid.of(\n-                Bid.builder()\n-                        .id(\"ad\")\n-                        .impid(\"ao-test\")\n-                        .adm(adm)\n-                        .price(BigDecimal.valueOf(1))\n-                        .crid(\"0af345b42983cc4bc0\")\n-                        .w(300)\n-                        .h(250)\n-                        .build(),\n-                BidType.banner, \"EUR\");\n-\n         assertThat(result.getErrors()).isEmpty();\n         assertThat(result.getValue()).isEqualTo(Collections.emptyList());\n     }\n"}}, {"oid": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "url": "https://github.com/prebid/prebid-server-java/commit/8ecf74d3dedfc88706bf24439de72c3195382f6a", "message": "Fix string constant and remove errors", "committedDate": "2020-08-20T11:05:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMTA4Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473931082", "bodyText": "Pls change this name to MEASUREMENT_CODE_TEMPLATE", "author": "DGarbar", "createdAt": "2020-08-20T12:26:47Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -50,20 +50,10 @@\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"", "originalCommit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13d2d47faace1950647d3191db6ac9ecd4302acb", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 9661fdde..f547a0fc 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,10 +50,12 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n-            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n-            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n-            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n+    private static final String MEASUREMENT_CODE_TEMPLATE = \" <script> +function() { \"\n+            + \"var wu = \\\"%s\\\"; \"\n+            + \"var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); \"\n+            + \"if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } \"\n+            + \"if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); \"\n+            + \"</script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkzMzgzOA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473933838", "bodyText": "queryParams cant be null", "author": "DGarbar", "createdAt": "2020-08-20T12:31:38Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -120,53 +98,60 @@ private ExtImpAdocean parseImpExt(Imp imp) {\n         }\n     }\n \n-    private boolean isRequest(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean, String impid) {\n+    private boolean addRequestAndCheckIfDuplicates(List<HttpRequest<Void>> httpRequests, ExtImpAdocean extImpAdocean,\n+                                                   String impid) {\n         for (HttpRequest<Void> request : httpRequests) {\n             List<NameValuePair> params = null;\n-            URIBuilder uriBuilder = null;\n             try {\n-                uriBuilder = new URIBuilder(request.getUri());\n-            } catch (URISyntaxException e) {\n-                e.printStackTrace();\n-            }\n-            final List<NameValuePair> queryParams = uriBuilder != null ? uriBuilder.getQueryParams() : null;\n-\n-            final String masterId = queryParams != null\n-                    ? queryParams.stream()\n-                    .filter(param -> param.getName().equals(\"id\"))\n-                    .findFirst()\n-                    .map(NameValuePair::getValue)\n-                    .orElse(null)\n-                    : null;\n-\n-            if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n-                final String newSlaveId = queryParams.stream()\n-                        .filter(param -> param.getName().equals(\"aid\"))\n-                        .map(param -> param.getValue().split(\":\")[0])\n-                        .filter(slaveId -> slaveId.equals(extImpAdocean.getSlaveId()))\n+                URIBuilder uriBuilder = new URIBuilder(request.getUri());\n+                final List<NameValuePair> queryParams = uriBuilder.getQueryParams();\n+\n+                final String masterId = queryParams != null", "originalCommit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13d2d47faace1950647d3191db6ac9ecd4302acb", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 9661fdde..f547a0fc 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -106,13 +108,11 @@ public class AdoceanBidder implements Bidder<Void> {\n                 URIBuilder uriBuilder = new URIBuilder(request.getUri());\n                 final List<NameValuePair> queryParams = uriBuilder.getQueryParams();\n \n-                final String masterId = queryParams != null\n-                        ? queryParams.stream()\n+                final String masterId = queryParams.stream()\n                         .filter(param -> param.getName().equals(\"id\"))\n                         .findFirst()\n                         .map(NameValuePair::getValue)\n-                        .orElse(null)\n-                        : null;\n+                        .orElse(null);\n \n                 if (masterId != null && masterId.equals(extImpAdocean.getMasterId())) {\n                     final String newSlaveId = queryParams.stream()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MDc3Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473940772", "bodyText": "you can refactor this like this\n        // then\n        final String adm = \" <script> +function() { \"\n                + \"var wu = \\\"https://win-url.com\\\"; \"\n                + \"var su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); \"\n                + \"if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } \"\n                + \"if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); \"\n                + \"</script>  <!-- code 1 --> \";", "author": "DGarbar", "createdAt": "2020-08-20T12:44:16Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -277,20 +277,7 @@ public void makeBidsShouldReturnCorrectBidderBid() throws JsonProcessingExceptio\n         final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, bidRequest);\n \n         // then\n-        final String adm = \"<script>\\n\"\n-                + \"\\t\\t+function() {\\n\"\n-                + \"\\t\\t\\tvar wu = \\\"https://win-url.com\\\";\\n\"\n-                + \"\\t\\t\\tvar su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-                + \"\\n\"\n-                + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-                + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-                + \"\\t\\t\\t}\\n\"\n-                + \"\\n\"\n-                + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-                + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-                + \"\\t\\t\\t}\\n\"\n-                + \"\\t\\t}();\\n\"\n-                + \"\\t</script> <!-- code 1 --> \";\n+        final String adm = \" <script> +function() { var wu = \\\"https://win-url.com\\\"; var su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script>  <!-- code 1 --> \";", "originalCommit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13d2d47faace1950647d3191db6ac9ecd4302acb", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 712ee9d7..c584b743 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -277,7 +277,12 @@ public class AdoceanBidderTest extends VertxTest {\n         final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, bidRequest);\n \n         // then\n-        final String adm = \" <script> +function() { var wu = \\\"https://win-url.com\\\"; var su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script>  <!-- code 1 --> \";\n+        final String adm = \" <script> +function() { \"\n+                + \"var wu = \\\"https://win-url.com\\\"; \"\n+                + \"var su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); \"\n+                + \"if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } \"\n+                + \"if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); \"\n+                + \"</script>  <!-- code 1 --> \";\n \n         final BidderBid expected = BidderBid.of(\n                 Bid.builder()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MTI3Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473941272", "bodyText": "adm redundant", "author": "DGarbar", "createdAt": "2020-08-20T12:45:11Z", "path": "src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java", "diffHunk": "@@ -361,19 +348,6 @@ public void makeBidsShouldReturnEmptyListOfBids() throws JsonProcessingException\n                 + \"\\t\\t\\t}\\n\"\n                 + \"\\t\\t}();\\n\"\n                 + \"\\t</script> <!-- code 1 --> \";\n-", "originalCommit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13d2d47faace1950647d3191db6ac9ecd4302acb", "chunk": "diff --git a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\nindex 712ee9d7..c584b743 100644\n--- a/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n+++ b/src/test/java/org/prebid/server/bidder/adocean/AdoceanBidderTest.java\n\n@@ -334,20 +339,6 @@ public class AdoceanBidderTest extends VertxTest {\n         final Result<List<BidderBid>> result = adoceanBidder.makeBids(httpCall, bidRequest);\n \n         // then\n-        final String adm = \"<script>\\n\"\n-                + \"\\t\\t+function() {\\n\"\n-                + \"\\t\\t\\tvar wu = \\\"https://win-url.com\\\";\\n\"\n-                + \"\\t\\t\\tvar su = \\\"https://stats-url.com\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-                + \"\\n\"\n-                + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-                + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-                + \"\\t\\t\\t}\\n\"\n-                + \"\\n\"\n-                + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-                + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-                + \"\\t\\t\\t}\\n\"\n-                + \"\\t\\t}();\\n\"\n-                + \"\\t</script> <!-- code 1 --> \";\n         assertThat(result.getErrors()).isEmpty();\n         assertThat(result.getValue()).isEqualTo(Collections.emptyList());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0MjE3NA==", "url": "https://github.com/prebid/prebid-server-java/pull/777#discussion_r473942174", "bodyText": "private static final String MEASUREMENT_CODE = \" <script> +function() { \" \n            + \"var wu = \\\"%s\\\"; \"\n            + \"var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); \" \n            + \"if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } \" \n            + \"if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); \" \n            + \"</script> \";", "author": "DGarbar", "createdAt": "2020-08-20T12:46:47Z", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -50,20 +50,10 @@\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \"<script>\\n\"\n-            + \"\\t\\t+function() {\\n\"\n-            + \"\\t\\t\\tvar wu = \\\"%s\\\";\\n\"\n-            + \"\\t\\t\\tvar su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now());\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = wu\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\n\"\n-            + \"\\t\\t\\tif (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) {\\n\"\n-            + \"\\t\\t\\t\\t(new Image(1,1)).src = su\\n\"\n-            + \"\\t\\t\\t}\\n\"\n-            + \"\\t\\t}();\\n\"\n-            + \"\\t</script>\";\n+    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n+            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n+            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";", "originalCommit": "8ecf74d3dedfc88706bf24439de72c3195382f6a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13d2d47faace1950647d3191db6ac9ecd4302acb", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\nindex 9661fdde..f547a0fc 100644\n--- a/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java\n\n@@ -50,10 +50,12 @@ public class AdoceanBidder implements Bidder<Void> {\n     private static final String VERSION = \"1.0.0\";\n     private static final int MAX_URI_LENGTH = 8000;\n     private static final String DEFAULT_BID_CURRENCY = \"USD\";\n-    private static final String MEASUREMENT_CODE = \" <script> +function() { var wu = \\\"%s\\\";\"\n-            + \" var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); if (wu && !(navigator.sendBeacon\"\n-            + \" && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } if (su && !(navigator.sendBeacon\"\n-            + \" && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); </script> \";\n+    private static final String MEASUREMENT_CODE_TEMPLATE = \" <script> +function() { \"\n+            + \"var wu = \\\"%s\\\"; \"\n+            + \"var su = \\\"%s\\\".replace(/\\\\[TIMESTAMP\\\\]/, Date.now()); \"\n+            + \"if (wu && !(navigator.sendBeacon && navigator.sendBeacon(wu))) { (new Image(1,1)).src = wu } \"\n+            + \"if (su && !(navigator.sendBeacon && navigator.sendBeacon(su))) { (new Image(1,1)).src = su } }(); \"\n+            + \"</script> \";\n \n     private final String endpointUrl;\n     private final JacksonMapper mapper;\n"}}, {"oid": "13d2d47faace1950647d3191db6ac9ecd4302acb", "url": "https://github.com/prebid/prebid-server-java/commit/13d2d47faace1950647d3191db6ac9ecd4302acb", "message": "Small refactoring string constant", "committedDate": "2020-08-20T13:01:10Z", "type": "commit"}, {"oid": "4992d0b30e12aaa0146b6bf2466f4372b8ae3a59", "url": "https://github.com/prebid/prebid-server-java/commit/4992d0b30e12aaa0146b6bf2466f4372b8ae3a59", "message": "Merge branch 'master' into add-adocean-bidder", "committedDate": "2020-09-07T08:57:43Z", "type": "commit"}, {"oid": "408ac85b0f8f6ec57eea2aa29d2252de15631f31", "url": "https://github.com/prebid/prebid-server-java/commit/408ac85b0f8f6ec57eea2aa29d2252de15631f31", "message": "Merge branch 'master' into add-adocean-bidder\n\n# Conflicts:\n#\tsrc/test/resources/org/prebid/server/it/test-application.properties", "committedDate": "2020-09-15T14:37:56Z", "type": "commit"}]}