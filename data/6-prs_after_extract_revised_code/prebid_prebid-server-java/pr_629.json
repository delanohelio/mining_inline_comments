{"pr_number": 629, "pr_title": "Add TimeoutBidder interface", "pr_createdAt": "2020-02-21T10:26:14Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/629", "timeline": [{"oid": "3359190e16088230a8b0e77bd7b9695d4ac00b86", "url": "https://github.com/prebid/prebid-server-java/commit/3359190e16088230a8b0e77bd7b9695d4ac00b86", "message": "TimeoutBidder interface added.\nFacebookBidder migrate from Bidder to TimeoutBidder", "committedDate": "2020-02-20T14:04:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyNTUzNA==", "url": "https://github.com/prebid/prebid-server-java/pull/629#discussion_r383925534", "bodyText": "Please extract separate method.\nAnd extract timeoutNotification.* into values.", "author": "DGarbar", "createdAt": "2020-02-25T14:49:36Z", "path": "src/main/java/org/prebid/server/bidder/HttpBidderRequester.java", "diffHunk": "@@ -128,6 +130,17 @@ public HttpBidderRequester(HttpClient httpClient,\n                         ? BidderError.Type.timeout\n                         : BidderError.Type.generic;\n \n+        if (errorType == BidderError.Type.timeout) {\n+            if (bidder instanceof TimeoutBidder) {\n+                final TimeoutBidder<T> timeoutBidder = (TimeoutBidder<T>) bidder;\n+                final HttpRequest<Void> timeoutNotification = timeoutBidder.makeTimeoutNotification(httpRequest);\n+                if (timeoutNotification != null) {\n+                    httpClient.request(timeoutNotification.getMethod(), timeoutNotification.getUri(),\n+                            timeoutNotification.getHeaders(), timeoutNotification.getBody(), NOTIFICATION_TIMEOUT_MS);\n+                }\n+            }\n+        }", "originalCommit": "3359190e16088230a8b0e77bd7b9695d4ac00b86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9aae091134958fbd8c94705bd37d7c126e611aa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\nindex 4b01bbf38..94a1a489d 100644\n--- a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n+++ b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n\n@@ -132,12 +134,7 @@ public class HttpBidderRequester {\n \n         if (errorType == BidderError.Type.timeout) {\n             if (bidder instanceof TimeoutBidder) {\n-                final TimeoutBidder<T> timeoutBidder = (TimeoutBidder<T>) bidder;\n-                final HttpRequest<Void> timeoutNotification = timeoutBidder.makeTimeoutNotification(httpRequest);\n-                if (timeoutNotification != null) {\n-                    httpClient.request(timeoutNotification.getMethod(), timeoutNotification.getUri(),\n-                            timeoutNotification.getHeaders(), timeoutNotification.getBody(), NOTIFICATION_TIMEOUT_MS);\n-                }\n+                doTimeoutNotificationRequest(httpRequest, bidder);\n             }\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyNTg2Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/629#discussion_r383925862", "bodyText": "in Go they have 200*time.Millisecond", "author": "DGarbar", "createdAt": "2020-02-25T14:50:06Z", "path": "src/main/java/org/prebid/server/bidder/HttpBidderRequester.java", "diffHunk": "@@ -43,6 +43,7 @@\n public class HttpBidderRequester {\n \n     private static final Logger logger = LoggerFactory.getLogger(HttpBidderRequester.class);\n+    private static final int NOTIFICATION_TIMEOUT_MS = 5_000;", "originalCommit": "3359190e16088230a8b0e77bd7b9695d4ac00b86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9aae091134958fbd8c94705bd37d7c126e611aa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\nindex 4b01bbf38..94a1a489d 100644\n--- a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n+++ b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n\n@@ -43,7 +45,7 @@ import java.util.stream.Stream;\n public class HttpBidderRequester {\n \n     private static final Logger logger = LoggerFactory.getLogger(HttpBidderRequester.class);\n-    private static final int NOTIFICATION_TIMEOUT_MS = 5_000;\n+    private static final int NOTIFICATION_TIMEOUT_MS = 200;\n \n     private final HttpClient httpClient;\n     private final BidderRequestCompletionTrackerFactory completionTrackerFactory;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyNjM4NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/629#discussion_r383926385", "bodyText": "Add javaDoc please.", "author": "DGarbar", "createdAt": "2020-02-25T14:50:54Z", "path": "src/main/java/org/prebid/server/bidder/TimeoutBidder.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package org.prebid.server.bidder;\n+\n+import org.prebid.server.bidder.model.HttpRequest;\n+\n+public interface TimeoutBidder<T> extends Bidder<T> {\n+", "originalCommit": "3359190e16088230a8b0e77bd7b9695d4ac00b86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9aae091134958fbd8c94705bd37d7c126e611aa", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/TimeoutBidder.java b/src/main/java/org/prebid/server/bidder/TimeoutBidder.java\nindex 6ce8f637d..3f8002ecf 100644\n--- a/src/main/java/org/prebid/server/bidder/TimeoutBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/TimeoutBidder.java\n\n@@ -2,8 +2,19 @@ package org.prebid.server.bidder;\n \n import org.prebid.server.bidder.model.HttpRequest;\n \n+/**\n+ * TimeoutBidder is used to identify bidders that support timeout notifications.\n+ */\n public interface TimeoutBidder<T> extends Bidder<T> {\n \n+    /**\n+     * makeTimeoutNotification method much the same as makeRequests, except it is fed the bidder request that timed out,\n+     * and expects that only one notification \"request\" will be generated. A use case for multiple timeout notifications\n+     * has not been anticipated.\n+     *\n+     * Do note that if makeRequests returns multiple requests, and more than one of these times out,\n+     * makeTimeoutNotification will be called once for each timed out request.\n+     */\n     HttpRequest<Void> makeTimeoutNotification(HttpRequest<T> httpRequest);\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzkyNzY4Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/629#discussion_r383927686", "bodyText": "Add tests for timeoutException please.", "author": "DGarbar", "createdAt": "2020-02-25T14:52:50Z", "path": "src/main/java/org/prebid/server/bidder/HttpBidderRequester.java", "diffHunk": "@@ -103,22 +104,23 @@ public HttpBidderRequester(HttpClient httpClient,\n     /**\n      * Makes an HTTP request and returns {@link Future} that will be eventually completed with success or error result.\n      */\n-    private <T> Future<HttpCall<T>> doRequest(HttpRequest<T> httpRequest, Timeout timeout) {\n+    private <T> Future<HttpCall<T>> doRequest(HttpRequest<T> httpRequest, Timeout timeout, Bidder<T> bidder) {", "originalCommit": "3359190e16088230a8b0e77bd7b9695d4ac00b86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a9de396f7ea2c4e245eeba2ef9d8d4b4bf21dae", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\nindex 4b01bbf38..d9bced6e7 100644\n--- a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n+++ b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n\n@@ -107,20 +108,20 @@ public class HttpBidderRequester {\n     private <T> Future<HttpCall<T>> doRequest(HttpRequest<T> httpRequest, Timeout timeout, Bidder<T> bidder) {\n         final long remainingTimeout = timeout.remaining();\n         if (remainingTimeout <= 0) {\n-            return failResponse(new TimeoutException(\"Timeout has been exceeded\"), httpRequest, bidder);\n+            return failResponse(new TimeoutException(\"Timeout has been exceeded\"), httpRequest);\n         }\n \n         return httpClient.request(httpRequest.getMethod(), httpRequest.getUri(), httpRequest.getHeaders(),\n                 httpRequest.getBody(), remainingTimeout)\n                 .compose(response -> processResponse(response, httpRequest))\n-                .recover(exception -> failResponse(exception, httpRequest, bidder));\n+                .recover(exception -> failResponse(exception, httpRequest))\n+                .map(httpCall -> notifyTimeoutBidder(bidder, httpCall));\n     }\n \n     /**\n      * Produces {@link Future} with {@link HttpCall} containing request and error description.\n      */\n-    private <T> Future<HttpCall<T>> failResponse(Throwable exception,\n-                                                 HttpRequest<T> httpRequest, Bidder<T> bidder) {\n+    private <T> Future<HttpCall<T>> failResponse(Throwable exception, HttpRequest<T> httpRequest) {\n         logger.warn(\"Error occurred while sending HTTP request to a bidder url: {0} with message: {1}\",\n                 httpRequest.getUri(), exception.getMessage());\n         logger.debug(\"Error occurred while sending HTTP request to a bidder url: {0}\", exception, httpRequest.getUri());\n"}}, {"oid": "d9aae091134958fbd8c94705bd37d7c126e611aa", "url": "https://github.com/prebid/prebid-server-java/commit/d9aae091134958fbd8c94705bd37d7c126e611aa", "message": "TimeoutBidder interface added.\nFacebookBidder migrate from Bidder to TimeoutBidder", "committedDate": "2020-02-27T10:20:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3ODE5Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/629#discussion_r385178196", "bodyText": "please add   if (bidder instanceof TimeoutBidder) { to this method, or perform\n  final TimeoutBidder<T> timeoutBidder = (TimeoutBidder<T>) bidder; near instanceOf and change method parameter from Bidder to TimeoutBidder.", "author": "DGarbar", "createdAt": "2020-02-27T15:17:33Z", "path": "src/main/java/org/prebid/server/bidder/HttpBidderRequester.java", "diffHunk": "@@ -132,19 +134,30 @@ public HttpBidderRequester(HttpClient httpClient,\n \n         if (errorType == BidderError.Type.timeout) {\n             if (bidder instanceof TimeoutBidder) {\n-                final TimeoutBidder<T> timeoutBidder = (TimeoutBidder<T>) bidder;\n-                final HttpRequest<Void> timeoutNotification = timeoutBidder.makeTimeoutNotification(httpRequest);\n-                if (timeoutNotification != null) {\n-                    httpClient.request(timeoutNotification.getMethod(), timeoutNotification.getUri(),\n-                            timeoutNotification.getHeaders(), timeoutNotification.getBody(), NOTIFICATION_TIMEOUT_MS);\n-                }\n+                doTimeoutNotificationRequest(httpRequest, bidder);\n             }\n         }\n \n         return Future.succeededFuture(\n                 HttpCall.failure(httpRequest, BidderError.create(exception.getMessage(), errorType)));\n     }\n \n+    /**\n+     *  doTimeoutNotificationRequest shoots on {@link TimeoutException} or {@link ConnectTimeoutException},\n+     *  if Bidder supports Timeout notifications\n+     */\n+    private <T> void doTimeoutNotificationRequest(HttpRequest<T> httpRequest, Bidder<T> bidder) {", "originalCommit": "d9aae091134958fbd8c94705bd37d7c126e611aa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "59422876de13820f70dd06d6d7651c76706a0a46", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\nindex 94a1a489d..2bdbdc8a9 100644\n--- a/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n+++ b/src/main/java/org/prebid/server/bidder/HttpBidderRequester.java\n\n@@ -134,7 +134,7 @@ public class HttpBidderRequester {\n \n         if (errorType == BidderError.Type.timeout) {\n             if (bidder instanceof TimeoutBidder) {\n-                doTimeoutNotificationRequest(httpRequest, bidder);\n+                doTimeoutNotificationRequest(httpRequest, ((TimeoutBidder<T>) bidder));\n             }\n         }\n \n"}}, {"oid": "59422876de13820f70dd06d6d7651c76706a0a46", "url": "https://github.com/prebid/prebid-server-java/commit/59422876de13820f70dd06d6d7651c76706a0a46", "message": "Added extra validation", "committedDate": "2020-02-27T15:48:52Z", "type": "commit"}, {"oid": "3cb6eebf2abc66089c4ee0cd0ac699e6a1ea8fd9", "url": "https://github.com/prebid/prebid-server-java/commit/3cb6eebf2abc66089c4ee0cd0ac699e6a1ea8fd9", "message": "cs fix", "committedDate": "2020-02-27T15:53:25Z", "type": "commit"}, {"oid": "0cb2e6f5d0def11e6c910290b2b3af625b04eb18", "url": "https://github.com/prebid/prebid-server-java/commit/0cb2e6f5d0def11e6c910290b2b3af625b04eb18", "message": "Merge branch 'master' into timeout-notification", "committedDate": "2020-05-13T12:50:19Z", "type": "commit"}, {"oid": "6a9de396f7ea2c4e245eeba2ef9d8d4b4bf21dae", "url": "https://github.com/prebid/prebid-server-java/commit/6a9de396f7ea2c4e245eeba2ef9d8d4b4bf21dae", "message": "Fixes after review", "committedDate": "2020-06-04T07:35:29Z", "type": "commit"}, {"oid": "43ab5d762a8772c91fc7f38d9672c18e035d0338", "url": "https://github.com/prebid/prebid-server-java/commit/43ab5d762a8772c91fc7f38d9672c18e035d0338", "message": "Fixes after review", "committedDate": "2020-06-04T07:38:20Z", "type": "commit"}]}