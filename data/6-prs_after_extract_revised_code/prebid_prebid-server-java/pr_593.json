{"pr_number": 593, "pr_title": "Fix Facebook adapter ignoring banner.format sizes", "pr_createdAt": "2020-01-17T13:14:49Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/593", "timeline": [{"oid": "2516847c483513c8c381e6cbb43f793fcaefacf0", "url": "https://github.com/prebid/prebid-server-java/commit/2516847c483513c8c381e6cbb43f793fcaefacf0", "message": "Fix audienceNetwork adapter ignoring banner.format sizes", "committedDate": "2020-01-17T13:07:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUwNDY3Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/593#discussion_r368504677", "bodyText": "This method can be transformed to list of supported sizes.", "author": "rpanchyk", "createdAt": "2020-01-20T11:42:43Z", "path": "src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java", "diffHunk": "@@ -207,14 +208,32 @@ private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n-        if (!Objects.equals(banner.getH(), 50) && !Objects.equals(banner.getH(), 250)) {\n+        if (banner.getH() == null) {\n+            for (int i = 0; i < banner.getFormat().size(); i++) {\n+                final Format format = banner.getFormat().get(i);\n+                if (format != null && isBannerHeightValid(format.getH())) {\n+                    return banner.toBuilder()\n+                            .w(0)\n+                            .h(format.getH())\n+                            .format(null)\n+                            .build();\n+                }\n+            }\n+            throw new PreBidException(String.format(\"imp #%s: banner height required\", imp.getId()));\n+        }\n+\n+        if (!isBannerHeightValid(banner.getH())) {\n             throw new PreBidException(String.format(\"imp #%s: only banner heights 50 and 250 are supported\",\n                     imp.getId()));\n         }\n \n         return banner.toBuilder().w(-1).format(null).build();\n     }\n \n+    private static boolean isBannerHeightValid(Integer h) {", "originalCommit": "2516847c483513c8c381e6cbb43f793fcaefacf0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86a631ea39cc8a476b03bd626ec72e5948e6326b", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\nindex 699f8dfe..ba244d4d 100644\n--- a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n\n@@ -204,13 +206,15 @@ public class FacebookBidder implements Bidder<BidRequest> {\n \n     private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n         final Banner banner = imp.getBanner();\n+        if (banner == null) {\n+            throw new PreBidException(String.format(\"imp #%s: Banner is null\", imp.getId()));\n+        }\n         if (impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n         if (banner.getH() == null) {\n-            for (int i = 0; i < banner.getFormat().size(); i++) {\n-                final Format format = banner.getFormat().get(i);\n+            for (final Format format : banner.getFormat()) {\n                 if (format != null && isBannerHeightValid(format.getH())) {\n                     return banner.toBuilder()\n                             .w(0)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUwNTAzNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/593#discussion_r368505035", "bodyText": "Can banner.getFormat() be null?\nCan we use foreach here for better readability?", "author": "rpanchyk", "createdAt": "2020-01-20T11:43:37Z", "path": "src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java", "diffHunk": "@@ -207,14 +208,32 @@ private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n-        if (!Objects.equals(banner.getH(), 50) && !Objects.equals(banner.getH(), 250)) {\n+        if (banner.getH() == null) {\n+            for (int i = 0; i < banner.getFormat().size(); i++) {", "originalCommit": "2516847c483513c8c381e6cbb43f793fcaefacf0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86a631ea39cc8a476b03bd626ec72e5948e6326b", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\nindex 699f8dfe..ba244d4d 100644\n--- a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n\n@@ -204,13 +206,15 @@ public class FacebookBidder implements Bidder<BidRequest> {\n \n     private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n         final Banner banner = imp.getBanner();\n+        if (banner == null) {\n+            throw new PreBidException(String.format(\"imp #%s: Banner is null\", imp.getId()));\n+        }\n         if (impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n         if (banner.getH() == null) {\n-            for (int i = 0; i < banner.getFormat().size(); i++) {\n-                final Format format = banner.getFormat().get(i);\n+            for (final Format format : banner.getFormat()) {\n                 if (format != null && isBannerHeightValid(format.getH())) {\n                     return banner.toBuilder()\n                             .w(0)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUwODI5MA==", "url": "https://github.com/prebid/prebid-server-java/pull/593#discussion_r368508290", "bodyText": "It is better to involve else if here, to prevent unnecessary code execution.", "author": "rpanchyk", "createdAt": "2020-01-20T11:51:57Z", "path": "src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java", "diffHunk": "@@ -207,14 +208,32 @@ private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n-        if (!Objects.equals(banner.getH(), 50) && !Objects.equals(banner.getH(), 250)) {\n+        if (banner.getH() == null) {\n+            for (int i = 0; i < banner.getFormat().size(); i++) {\n+                final Format format = banner.getFormat().get(i);\n+                if (format != null && isBannerHeightValid(format.getH())) {\n+                    return banner.toBuilder()\n+                            .w(0)\n+                            .h(format.getH())\n+                            .format(null)\n+                            .build();\n+                }\n+            }\n+            throw new PreBidException(String.format(\"imp #%s: banner height required\", imp.getId()));\n+        }\n+\n+        if (!isBannerHeightValid(banner.getH())) {", "originalCommit": "2516847c483513c8c381e6cbb43f793fcaefacf0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86a631ea39cc8a476b03bd626ec72e5948e6326b", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\nindex 699f8dfe..ba244d4d 100644\n--- a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n\n@@ -204,13 +206,15 @@ public class FacebookBidder implements Bidder<BidRequest> {\n \n     private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n         final Banner banner = imp.getBanner();\n+        if (banner == null) {\n+            throw new PreBidException(String.format(\"imp #%s: Banner is null\", imp.getId()));\n+        }\n         if (impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n         if (banner.getH() == null) {\n-            for (int i = 0; i < banner.getFormat().size(); i++) {\n-                final Format format = banner.getFormat().get(i);\n+            for (final Format format : banner.getFormat()) {\n                 if (format != null && isBannerHeightValid(format.getH())) {\n                     return banner.toBuilder()\n                             .w(0)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUwOTQ1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/593#discussion_r368509456", "bodyText": "Seems we have to set w = 0 according to formal implementation.", "author": "rpanchyk", "createdAt": "2020-01-20T11:54:59Z", "path": "src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java", "diffHunk": "@@ -207,14 +208,32 @@ private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n-        if (!Objects.equals(banner.getH(), 50) && !Objects.equals(banner.getH(), 250)) {\n+        if (banner.getH() == null) {\n+            for (int i = 0; i < banner.getFormat().size(); i++) {\n+                final Format format = banner.getFormat().get(i);\n+                if (format != null && isBannerHeightValid(format.getH())) {\n+                    return banner.toBuilder()\n+                            .w(0)\n+                            .h(format.getH())\n+                            .format(null)\n+                            .build();\n+                }\n+            }\n+            throw new PreBidException(String.format(\"imp #%s: banner height required\", imp.getId()));\n+        }\n+\n+        if (!isBannerHeightValid(banner.getH())) {\n             throw new PreBidException(String.format(\"imp #%s: only banner heights 50 and 250 are supported\",\n                     imp.getId()));\n         }\n \n         return banner.toBuilder().w(-1).format(null).build();", "originalCommit": "2516847c483513c8c381e6cbb43f793fcaefacf0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86a631ea39cc8a476b03bd626ec72e5948e6326b", "chunk": "diff --git a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\nindex 699f8dfe..ba244d4d 100644\n--- a/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n+++ b/src/main/java/org/prebid/server/bidder/facebook/FacebookBidder.java\n\n@@ -204,13 +206,15 @@ public class FacebookBidder implements Bidder<BidRequest> {\n \n     private static Banner modifyBanner(Imp imp, boolean impInstlEqOne) {\n         final Banner banner = imp.getBanner();\n+        if (banner == null) {\n+            throw new PreBidException(String.format(\"imp #%s: Banner is null\", imp.getId()));\n+        }\n         if (impInstlEqOne) {\n             return banner.toBuilder().w(0).h(0).format(null).build();\n         }\n \n         if (banner.getH() == null) {\n-            for (int i = 0; i < banner.getFormat().size(); i++) {\n-                final Format format = banner.getFormat().get(i);\n+            for (final Format format : banner.getFormat()) {\n                 if (format != null && isBannerHeightValid(format.getH())) {\n                     return banner.toBuilder()\n                             .w(0)\n"}}, {"oid": "86a631ea39cc8a476b03bd626ec72e5948e6326b", "url": "https://github.com/prebid/prebid-server-java/commit/86a631ea39cc8a476b03bd626ec72e5948e6326b", "message": "Fixed minor issues", "committedDate": "2020-01-20T12:56:35Z", "type": "commit"}, {"oid": "bf1ce421e63835ac539265e7aada647b1f59facd", "url": "https://github.com/prebid/prebid-server-java/commit/bf1ce421e63835ac539265e7aada647b1f59facd", "message": "Fixed minor issues", "committedDate": "2020-01-20T13:01:55Z", "type": "commit"}, {"oid": "4c79bfe1c92a382033a29a161c821e820ac8dc3f", "url": "https://github.com/prebid/prebid-server-java/commit/4c79bfe1c92a382033a29a161c821e820ac8dc3f", "message": "Rewarded Video code cleanup, test fix", "committedDate": "2020-01-21T16:06:11Z", "type": "commit"}]}