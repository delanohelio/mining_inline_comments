{"pr_number": 162, "pr_title": "Feature/extensions blockentity", "pr_createdAt": "2020-07-29T15:15:17Z", "pr_url": "https://github.com/PatchworkMC/patchwork-api/pull/162", "timeline": [{"oid": "aca5583672645fe09e50d996a1e3ce9bc98443ff", "url": "https://github.com/PatchworkMC/patchwork-api/commit/aca5583672645fe09e50d996a1e3ce9bc98443ff", "message": "Add extensions-blockentity module", "committedDate": "2020-07-29T08:10:48Z", "type": "commit"}, {"oid": "34175c42c6642f0c3c744caf017700ccdb7fd559", "url": "https://github.com/PatchworkMC/patchwork-api/commit/34175c42c6642f0c3c744caf017700ccdb7fd559", "message": "implements IForgeTileEntity.onLoad and onChunkUnloaded", "committedDate": "2020-07-29T12:43:06Z", "type": "commit"}, {"oid": "2b0118bbd7382f5e5e228294fec060ef13627169", "url": "https://github.com/PatchworkMC/patchwork-api/commit/2b0118bbd7382f5e5e228294fec060ef13627169", "message": "Impl IForgeTileEntity.getTileData()", "committedDate": "2020-07-29T12:59:10Z", "type": "commit"}, {"oid": "be9e4887e7d212d9050547b149d10e8f35ed9168", "url": "https://github.com/PatchworkMC/patchwork-api/commit/be9e4887e7d212d9050547b149d10e8f35ed9168", "message": "Implements IForgeTileEntity.getRenderBoundingBox and canRenderBreaking", "committedDate": "2020-07-29T14:25:03Z", "type": "commit"}, {"oid": "a688a7b758ab2e37e257423fe842b43948bd6627", "url": "https://github.com/PatchworkMC/patchwork-api/commit/a688a7b758ab2e37e257423fe842b43948bd6627", "message": "Add FastTESR support and Forge's BER registration method", "committedDate": "2020-07-29T14:58:03Z", "type": "commit"}, {"oid": "1c69c35b7e49064778cdcc7680b5913390b71ef9", "url": "https://github.com/PatchworkMC/patchwork-api/commit/1c69c35b7e49064778cdcc7680b5913390b71ef9", "message": "Add BlockEntityRender register method to the god class, Add readme", "committedDate": "2020-07-29T15:13:42Z", "type": "commit"}, {"oid": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "url": "https://github.com/PatchworkMC/patchwork-api/commit/b4ec5d04f092338e9a024f8f7b591239edf58e69", "message": "Fix potential ThreadLocal memory leakage", "committedDate": "2020-07-30T06:44:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNzY5OQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463117699", "bodyText": "why comment this out?", "author": "TheGlitch76", "createdAt": "2020-07-30T16:22:32Z", "path": "patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.extensions;\n+\n+import net.minecraftforge.common.capabilities.ICapabilitySerializable;\n+\n+import net.minecraft.block.AbstractSignBlock;\n+import net.minecraft.block.Block;\n+import net.minecraft.block.BlockState;\n+import net.minecraft.block.Blocks;\n+import net.minecraft.block.ChestBlock;\n+import net.minecraft.block.EnderChestBlock;\n+import net.minecraft.block.SkullBlock;\n+import net.minecraft.nbt.CompoundTag;\n+import net.minecraft.network.ClientConnection;\n+import net.minecraft.network.packet.s2c.play.BlockEntityUpdateS2CPacket;\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.util.math.Box;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.World;\n+\n+public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n+\t/**\n+\t * Sometimes default render bounding box: infinite in scope. Used to control rendering on {@link TileEntitySpecialRenderer}.\n+\t */\n+\tBox INFINITE_EXTENT_AABB = new net.minecraft.util.math.Box(Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY);\n+\n+\tdefault BlockEntity getTileEntity() {\n+\t\treturn (BlockEntity) this;\n+\t}\n+\n+\t@Override\n+\tdefault void deserializeNBT(CompoundTag nbt) {\n+\t\tgetTileEntity().fromTag(nbt);\n+\t}\n+\n+\t@Override\n+\tdefault CompoundTag serializeNBT() {\n+\t\tCompoundTag ret = new CompoundTag();\n+\t\tgetTileEntity().toTag(ret);\n+\t\treturn ret;\n+\t}\n+\n+\t/**\n+\t * Called when you receive a TileEntityData packet for the location this\n+\t * TileEntity is currently in. On the client, the NetworkManager will always\n+\t * be the remote server. On the server, it will be whomever is responsible for\n+\t * sending the packet.\n+\t *\n+\t * @param net The NetworkManager the packet originated from\n+\t * @param pkt The data packet\n+\t */\n+\tdefault void onDataPacket(ClientConnection net, BlockEntityUpdateS2CPacket pkt) {\n+\t}\n+\n+\t/**\n+\t * Called when the chunk's TE update tag, gotten from {@link #getUpdateTag()}, is received on the client.\n+\t *\n+\t * <p>Used to handle this tag in a special way. By default this simply calls {@link #readFromNBT(NBTTagCompound)}.\n+\t *\n+\t * @param tag The {@link NBTTagCompound} sent from {@link #getUpdateTag()}\n+\t */\n+\tdefault void handleUpdateTag(CompoundTag tag) {\n+\t\tgetTileEntity().fromTag(tag);\n+\t}\n+\n+\t/**\n+\t * Gets a {@link NBTTagCompound} that can be used to store custom data for this tile entity.\n+\t * It will be written, and read from disc, so it persists over world saves.\n+\t *\n+\t * @return A compound tag for custom data\n+\t */\n+\tCompoundTag getTileData();\n+\n+\tdefault void onChunkUnloaded() {\n+\t}\n+\n+\t/**\n+\t * Called when this is first added to the world (by {@link World#addTileEntity(TileEntity)}).\n+\t * Override instead of adding {@code if (firstTick)} stuff in update.\n+\t */\n+\tdefault void onLoad() {\n+\t\trequestModelDataUpdate();\n+\t}\n+\n+\t/**\n+\t * Return an {@link AxisAlignedBB} that controls the visible scope of a {@link TileEntitySpecialRenderer} associated with this {@link TileEntity}\n+\t * Defaults to the collision bounding box {@link Block#getCollisionBoundingBoxFromPool(World, int, int, int)} associated with the block\n+\t * at this location.\n+\t *\n+\t * @return an appropriately size {@link AxisAlignedBB} for the {@link TileEntity}\n+\t */\n+\t// @OnlyIn(Dist.CLIENT)", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwNjkxMQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463206911", "bodyText": "Do we have OnlyIn annotation?", "author": "rikka0w0", "createdAt": "2020-07-30T18:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNzY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIwODY5NQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463208695", "bodyText": "Fabric's @Environment?", "author": "famous1622", "createdAt": "2020-07-30T19:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNzY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxODg3NA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463218874", "bodyText": "does the patcher transform @onlyin to @Environment?", "author": "rikka0w0", "createdAt": "2020-07-30T19:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNzY5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxOTg0OQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463219849", "bodyText": "yes", "author": "TheGlitch76", "createdAt": "2020-07-30T19:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExNzY5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "69c9bc5e90bf3de23471078e19cebfa81ebd763b", "chunk": "diff --git a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\nindex 172f8f0a..14fb17d3 100644\n--- a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n+++ b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n\n@@ -128,7 +128,7 @@ public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n \t\t\t} catch (Exception e) {\n \t\t\t\t// We have to capture any exceptions that may occur here because BUKKIT servers like to send\n \t\t\t\t// the tile entity data BEFORE the chunk data, you know, the OPPOSITE of what vanilla does!\n-\t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...\n+\t\t\t\t// So we can not GUARANTEE that the world state is the real state for the block...\n \t\t\t\t// So, once again in the long line of US having to accommodate BUKKIT breaking things,\n \t\t\t\t// here it is, assume that the TE is only 1 cubic block. Problem with this is that it may\n \t\t\t\t// cause the TileEntity renderer to error further down the line! But alas, nothing we can do.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODI0NQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463118245", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...\n          \n          \n            \n            \t\t\t\t// So we can not GUARANTEE that the world state is the real state for the block...", "author": "TheGlitch76", "createdAt": "2020-07-30T16:23:26Z", "path": "patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.extensions;\n+\n+import net.minecraftforge.common.capabilities.ICapabilitySerializable;\n+\n+import net.minecraft.block.AbstractSignBlock;\n+import net.minecraft.block.Block;\n+import net.minecraft.block.BlockState;\n+import net.minecraft.block.Blocks;\n+import net.minecraft.block.ChestBlock;\n+import net.minecraft.block.EnderChestBlock;\n+import net.minecraft.block.SkullBlock;\n+import net.minecraft.nbt.CompoundTag;\n+import net.minecraft.network.ClientConnection;\n+import net.minecraft.network.packet.s2c.play.BlockEntityUpdateS2CPacket;\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.util.math.Box;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.World;\n+\n+public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n+\t/**\n+\t * Sometimes default render bounding box: infinite in scope. Used to control rendering on {@link TileEntitySpecialRenderer}.\n+\t */\n+\tBox INFINITE_EXTENT_AABB = new net.minecraft.util.math.Box(Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY);\n+\n+\tdefault BlockEntity getTileEntity() {\n+\t\treturn (BlockEntity) this;\n+\t}\n+\n+\t@Override\n+\tdefault void deserializeNBT(CompoundTag nbt) {\n+\t\tgetTileEntity().fromTag(nbt);\n+\t}\n+\n+\t@Override\n+\tdefault CompoundTag serializeNBT() {\n+\t\tCompoundTag ret = new CompoundTag();\n+\t\tgetTileEntity().toTag(ret);\n+\t\treturn ret;\n+\t}\n+\n+\t/**\n+\t * Called when you receive a TileEntityData packet for the location this\n+\t * TileEntity is currently in. On the client, the NetworkManager will always\n+\t * be the remote server. On the server, it will be whomever is responsible for\n+\t * sending the packet.\n+\t *\n+\t * @param net The NetworkManager the packet originated from\n+\t * @param pkt The data packet\n+\t */\n+\tdefault void onDataPacket(ClientConnection net, BlockEntityUpdateS2CPacket pkt) {\n+\t}\n+\n+\t/**\n+\t * Called when the chunk's TE update tag, gotten from {@link #getUpdateTag()}, is received on the client.\n+\t *\n+\t * <p>Used to handle this tag in a special way. By default this simply calls {@link #readFromNBT(NBTTagCompound)}.\n+\t *\n+\t * @param tag The {@link NBTTagCompound} sent from {@link #getUpdateTag()}\n+\t */\n+\tdefault void handleUpdateTag(CompoundTag tag) {\n+\t\tgetTileEntity().fromTag(tag);\n+\t}\n+\n+\t/**\n+\t * Gets a {@link NBTTagCompound} that can be used to store custom data for this tile entity.\n+\t * It will be written, and read from disc, so it persists over world saves.\n+\t *\n+\t * @return A compound tag for custom data\n+\t */\n+\tCompoundTag getTileData();\n+\n+\tdefault void onChunkUnloaded() {\n+\t}\n+\n+\t/**\n+\t * Called when this is first added to the world (by {@link World#addTileEntity(TileEntity)}).\n+\t * Override instead of adding {@code if (firstTick)} stuff in update.\n+\t */\n+\tdefault void onLoad() {\n+\t\trequestModelDataUpdate();\n+\t}\n+\n+\t/**\n+\t * Return an {@link AxisAlignedBB} that controls the visible scope of a {@link TileEntitySpecialRenderer} associated with this {@link TileEntity}\n+\t * Defaults to the collision bounding box {@link Block#getCollisionBoundingBoxFromPool(World, int, int, int)} associated with the block\n+\t * at this location.\n+\t *\n+\t * @return an appropriately size {@link AxisAlignedBB} for the {@link TileEntity}\n+\t */\n+\t// @OnlyIn(Dist.CLIENT)\n+\tdefault Box getRenderBoundingBox() {\n+\t\tBox bb = INFINITE_EXTENT_AABB;\n+\t\tBlockState state = getTileEntity().getCachedState();\n+\t\tBlock block = state.getBlock();\n+\t\tBlockPos pos = getTileEntity().getPos();\n+\n+\t\tif (block == Blocks.ENCHANTING_TABLE) {\n+\t\t\tbb = new Box(pos, pos.add(1, 1, 1));\n+\t\t} else if (block == Blocks.CHEST || block == Blocks.TRAPPED_CHEST) {\n+\t\t\tbb = new Box(pos.add(-1, 0, -1), pos.add(2, 2, 2));\n+\t\t} else if (block == Blocks.STRUCTURE_BLOCK) {\n+\t\t\tbb = INFINITE_EXTENT_AABB;\n+\t\t} else if (block != null && block != Blocks.BEACON) {\n+\t\t\tBox cbb = null;\n+\n+\t\t\ttry {\n+\t\t\t\tcbb = state.getCollisionShape(getTileEntity().getWorld(), pos).getBoundingBox().offset(pos);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\t// We have to capture any exceptions that may occur here because BUKKIT servers like to send\n+\t\t\t\t// the tile entity data BEFORE the chunk data, you know, the OPPOSITE of what vanilla does!\n+\t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "69c9bc5e90bf3de23471078e19cebfa81ebd763b", "chunk": "diff --git a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\nindex 172f8f0a..14fb17d3 100644\n--- a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n+++ b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n\n@@ -128,7 +128,7 @@ public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n \t\t\t} catch (Exception e) {\n \t\t\t\t// We have to capture any exceptions that may occur here because BUKKIT servers like to send\n \t\t\t\t// the tile entity data BEFORE the chunk data, you know, the OPPOSITE of what vanilla does!\n-\t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...\n+\t\t\t\t// So we can not GUARANTEE that the world state is the real state for the block...\n \t\t\t\t// So, once again in the long line of US having to accommodate BUKKIT breaking things,\n \t\t\t\t// here it is, assume that the TE is only 1 cubic block. Problem with this is that it may\n \t\t\t\t// cause the TileEntity renderer to error further down the line! But alas, nothing we can do.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODM0OQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463118349", "bodyText": "we're not writing patches", "author": "TheGlitch76", "createdAt": "2020-07-30T16:23:36Z", "path": "patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.minecraftforge.common.extensions;\n+\n+import net.minecraftforge.common.capabilities.ICapabilitySerializable;\n+\n+import net.minecraft.block.AbstractSignBlock;\n+import net.minecraft.block.Block;\n+import net.minecraft.block.BlockState;\n+import net.minecraft.block.Blocks;\n+import net.minecraft.block.ChestBlock;\n+import net.minecraft.block.EnderChestBlock;\n+import net.minecraft.block.SkullBlock;\n+import net.minecraft.nbt.CompoundTag;\n+import net.minecraft.network.ClientConnection;\n+import net.minecraft.network.packet.s2c.play.BlockEntityUpdateS2CPacket;\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.util.math.Box;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.world.World;\n+\n+public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n+\t/**\n+\t * Sometimes default render bounding box: infinite in scope. Used to control rendering on {@link TileEntitySpecialRenderer}.\n+\t */\n+\tBox INFINITE_EXTENT_AABB = new net.minecraft.util.math.Box(Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.NEGATIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY, Double.POSITIVE_INFINITY);\n+\n+\tdefault BlockEntity getTileEntity() {\n+\t\treturn (BlockEntity) this;\n+\t}\n+\n+\t@Override\n+\tdefault void deserializeNBT(CompoundTag nbt) {\n+\t\tgetTileEntity().fromTag(nbt);\n+\t}\n+\n+\t@Override\n+\tdefault CompoundTag serializeNBT() {\n+\t\tCompoundTag ret = new CompoundTag();\n+\t\tgetTileEntity().toTag(ret);\n+\t\treturn ret;\n+\t}\n+\n+\t/**\n+\t * Called when you receive a TileEntityData packet for the location this\n+\t * TileEntity is currently in. On the client, the NetworkManager will always\n+\t * be the remote server. On the server, it will be whomever is responsible for\n+\t * sending the packet.\n+\t *\n+\t * @param net The NetworkManager the packet originated from\n+\t * @param pkt The data packet\n+\t */\n+\tdefault void onDataPacket(ClientConnection net, BlockEntityUpdateS2CPacket pkt) {\n+\t}\n+\n+\t/**\n+\t * Called when the chunk's TE update tag, gotten from {@link #getUpdateTag()}, is received on the client.\n+\t *\n+\t * <p>Used to handle this tag in a special way. By default this simply calls {@link #readFromNBT(NBTTagCompound)}.\n+\t *\n+\t * @param tag The {@link NBTTagCompound} sent from {@link #getUpdateTag()}\n+\t */\n+\tdefault void handleUpdateTag(CompoundTag tag) {\n+\t\tgetTileEntity().fromTag(tag);\n+\t}\n+\n+\t/**\n+\t * Gets a {@link NBTTagCompound} that can be used to store custom data for this tile entity.\n+\t * It will be written, and read from disc, so it persists over world saves.\n+\t *\n+\t * @return A compound tag for custom data\n+\t */\n+\tCompoundTag getTileData();\n+\n+\tdefault void onChunkUnloaded() {\n+\t}\n+\n+\t/**\n+\t * Called when this is first added to the world (by {@link World#addTileEntity(TileEntity)}).\n+\t * Override instead of adding {@code if (firstTick)} stuff in update.\n+\t */\n+\tdefault void onLoad() {\n+\t\trequestModelDataUpdate();\n+\t}\n+\n+\t/**\n+\t * Return an {@link AxisAlignedBB} that controls the visible scope of a {@link TileEntitySpecialRenderer} associated with this {@link TileEntity}\n+\t * Defaults to the collision bounding box {@link Block#getCollisionBoundingBoxFromPool(World, int, int, int)} associated with the block\n+\t * at this location.\n+\t *\n+\t * @return an appropriately size {@link AxisAlignedBB} for the {@link TileEntity}\n+\t */\n+\t// @OnlyIn(Dist.CLIENT)\n+\tdefault Box getRenderBoundingBox() {\n+\t\tBox bb = INFINITE_EXTENT_AABB;\n+\t\tBlockState state = getTileEntity().getCachedState();\n+\t\tBlock block = state.getBlock();\n+\t\tBlockPos pos = getTileEntity().getPos();\n+\n+\t\tif (block == Blocks.ENCHANTING_TABLE) {\n+\t\t\tbb = new Box(pos, pos.add(1, 1, 1));\n+\t\t} else if (block == Blocks.CHEST || block == Blocks.TRAPPED_CHEST) {\n+\t\t\tbb = new Box(pos.add(-1, 0, -1), pos.add(2, 2, 2));\n+\t\t} else if (block == Blocks.STRUCTURE_BLOCK) {\n+\t\t\tbb = INFINITE_EXTENT_AABB;\n+\t\t} else if (block != null && block != Blocks.BEACON) {\n+\t\t\tBox cbb = null;\n+\n+\t\t\ttry {\n+\t\t\t\tcbb = state.getCollisionShape(getTileEntity().getWorld(), pos).getBoundingBox().offset(pos);\n+\t\t\t} catch (Exception e) {\n+\t\t\t\t// We have to capture any exceptions that may occur here because BUKKIT servers like to send\n+\t\t\t\t// the tile entity data BEFORE the chunk data, you know, the OPPOSITE of what vanilla does!\n+\t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...\n+\t\t\t\t// So, once again in the long line of US having to accommodate BUKKIT breaking things,\n+\t\t\t\t// here it is, assume that the TE is only 1 cubic block. Problem with this is that it may\n+\t\t\t\t// cause the TileEntity renderer to error further down the line! But alas, nothing we can do.\n+\t\t\t\tcbb = new net.minecraft.util.math.Box(pos.add(-1, 0, -1), pos.add(1, 1, 1));", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIyMjQ1Mg==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463222452", "bodyText": "=This does not change any vanilla rendering behavior. I would suggest we should keep this. Or simply set cbb to null, so that when an exception is captured, the BE renderer will always be invoked.", "author": "rikka0w0", "createdAt": "2020-07-30T19:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDAyNDIwOA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r464024208", "bodyText": "i meant import instead of net.minecraft.util.math", "author": "TheGlitch76", "createdAt": "2020-08-02T03:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODM0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0MDIxNA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r464740214", "bodyText": "fixed", "author": "rikka0w0", "createdAt": "2020-08-04T01:04:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODM0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "69c9bc5e90bf3de23471078e19cebfa81ebd763b", "chunk": "diff --git a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\nindex 172f8f0a..14fb17d3 100644\n--- a/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n+++ b/patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n\n@@ -128,7 +128,7 @@ public interface IForgeTileEntity extends ICapabilitySerializable<CompoundTag> {\n \t\t\t} catch (Exception e) {\n \t\t\t\t// We have to capture any exceptions that may occur here because BUKKIT servers like to send\n \t\t\t\t// the tile entity data BEFORE the chunk data, you know, the OPPOSITE of what vanilla does!\n-\t\t\t\t// So we can not GARENTEE that the world state is the real state for the block...\n+\t\t\t\t// So we can not GUARANTEE that the world state is the real state for the block...\n \t\t\t\t// So, once again in the long line of US having to accommodate BUKKIT breaking things,\n \t\t\t\t// here it is, assume that the TE is only 1 cubic block. Problem with this is that it may\n \t\t\t\t// cause the TileEntity renderer to error further down the line! But alas, nothing we can do.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODk1Ng==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463118956", "bodyText": "What needs to be done here?\nIf this is being done to work around a FAPI patch, could mixin priorities be used to apply over their patches?", "author": "TheGlitch76", "createdAt": "2020-07-30T16:24:37Z", "path": "patchwork-extensions-blockentity/src/main/java/net/patchworkmc/mixin/extensions/blockentity/MixinClientPlayNetworkHandler.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.patchworkmc.mixin.extensions.blockentity;\n+\n+import java.util.Iterator;\n+\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.At.Shift;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.asm.mixin.injection.callback.LocalCapture;\n+import net.minecraftforge.common.extensions.IForgeTileEntity;\n+\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.nbt.CompoundTag;\n+import net.minecraft.network.packet.s2c.play.BlockEntityUpdateS2CPacket;\n+import net.minecraft.network.packet.s2c.play.ChunkDataS2CPacket;\n+import net.minecraft.util.math.BlockPos;\n+\n+import net.fabricmc.fabric.api.block.entity.BlockEntityClientSerializable;\n+\n+/**\n+ * TODO: This Mixin can be less hacky if we can talk to the Fabric API team.", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxMzQ1Nw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463213457", "bodyText": "We need to insert our own hook here. We cannot reuse Fabric's BE sync, because Fabric API requires the BE to implement BlockEntityClientSerializable. We cannot make IForgeTileEntity extends BlockEntityClientSerializable, otherwise every single BlockEntity will implement BlockEntityClientSerializable....6000M!\nIdeally, we should let the Fabric's hook checks for BlockEntityClientSerializable, if the BE is not a BlockEntityClientSerializable, then it should call our hook. This part of logic is in Fabric API's mixin, so we cannot mixin it. What I would expect is that, Fabric API moves that logic from the mixin class to a separate normal class, so that we can mixin it.\nActually everything is working here and we don't need to set priority at all. I chose an Injection point so that our hook will be executed earlier than Fabric API's. We will then check if the BE implements BlockEntityClientSerializable, if that's the case, pass it to Fabric API, otherwise, we handle it and pass it to IForgeTileEntity. Vanilla BEs are handled in onChunkData, so they don't need this kind of callback.", "author": "rikka0w0", "createdAt": "2020-07-30T19:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzExODk1Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMTUxNg==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463121516", "bodyText": "This looks like a hack. Would a marker interface in Patcher be helpful?", "author": "TheGlitch76", "createdAt": "2020-07-30T16:28:24Z", "path": "patchwork-extensions-blockentity/src/main/java/net/patchworkmc/mixin/extensions/blockentity/MixinClientPlayNetworkHandler.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.patchworkmc.mixin.extensions.blockentity;\n+\n+import java.util.Iterator;\n+\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.At.Shift;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.asm.mixin.injection.callback.LocalCapture;\n+import net.minecraftforge.common.extensions.IForgeTileEntity;\n+\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.client.network.ClientPlayNetworkHandler;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.nbt.CompoundTag;\n+import net.minecraft.network.packet.s2c.play.BlockEntityUpdateS2CPacket;\n+import net.minecraft.network.packet.s2c.play.ChunkDataS2CPacket;\n+import net.minecraft.util.math.BlockPos;\n+\n+import net.fabricmc.fabric.api.block.entity.BlockEntityClientSerializable;\n+\n+/**\n+ * TODO: This Mixin can be less hacky if we can talk to the Fabric API team.\n+ *\n+ * <p>This Mixin implements {@link IForgeTileEntity#handleUpdateTag(CompoundTag)}\n+ * and {@link IForgeTileEntity#onDataPacket(net.minecraft.network.ClientConnection, BlockEntityUpdateS2CPacket)}.\n+ */\n+@Mixin(ClientPlayNetworkHandler.class)\n+public abstract class MixinClientPlayNetworkHandler {\n+\t///////////////////////////////////////////////////////////////\n+\t/// onChunkData -> IForgeTileEntity.handleUpdateTag\n+\t///////////////////////////////////////////////////////////////\n+\t@Unique\n+\tprivate static final ThreadLocal<CompoundTag> onChunkData_BETag = ThreadLocal.withInitial(() -> null);\n+\t@Unique\n+\tprivate static final String ClientWorld_getBlockEntity = \"net/minecraft/client/world/ClientWorld.getBlockEntity(Lnet/minecraft/util/math/BlockPos;)Lnet/minecraft/block/entity/BlockEntity;\";\n+\n+\t@Inject(method = \"onChunkData\", locals = LocalCapture.CAPTURE_FAILHARD,\n+\t\t\tat = @At(value = \"INVOKE\", shift = Shift.BEFORE, target = ClientWorld_getBlockEntity))\n+\tprivate void onChunkData_CollectBETag(ChunkDataS2CPacket packet, CallbackInfo ci,\n+\t\t\t@SuppressWarnings(\"rawtypes\") Iterator blockEntityTagListIterator, CompoundTag blockEntityTag, BlockPos blockPos) {\n+\t\tif (onBlockEntityUpdate_BlockEntity.get() != null) {\n+\t\t\tthrow new IllegalStateException(\"State of ClientPlayNetworkHandler.onChunkData() is not clean, incompatible Mixins might be the cause!\");\n+\t\t}\n+\n+\t\tonChunkData_BETag.set(blockEntityTag);\n+\t}\n+\n+\t@Redirect(method = \"onChunkData\", at = @At(value = \"INVOKE\", target = ClientWorld_getBlockEntity))\n+\tprivate BlockEntity onChunkData_world_getBlockEntity(ClientWorld clientWorld, BlockPos blockPos) {\n+\t\tCompoundTag blockEntityTag = onChunkData_BETag.get();\n+\t\tonChunkData_BETag.remove();\n+\n+\t\tClientPlayNetworkHandler me = (ClientPlayNetworkHandler) (Object) this;\n+\t\tBlockEntity blockEntity = me.getWorld().getBlockEntity(blockPos);\n+\n+\t\tif (blockEntity != null && !(blockEntity instanceof BlockEntityClientSerializable)) {", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxNDQ2Mw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463214463", "bodyText": "explained in the previous comment. A marker interface will not help, because IForgeTileEntity will be implemented by all BEs.", "author": "rikka0w0", "createdAt": "2020-07-30T19:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMTUxNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMjI0OA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463122248", "bodyText": "could this cause incompatibilities in fabric mods?", "author": "TheGlitch76", "createdAt": "2020-07-30T16:29:35Z", "path": "patchwork-extensions-blockentity/src/main/java/net/patchworkmc/mixin/extensions/blockentity/MixinWorld.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.patchworkmc.mixin.extensions.blockentity;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import org.objectweb.asm.Opcodes;\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.At.Shift;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;\n+import org.spongepowered.asm.mixin.injection.callback.LocalCapture;\n+import net.minecraftforge.common.extensions.IForgeTileEntity;\n+\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.util.Tickable;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.World;\n+import net.minecraft.world.chunk.WorldChunk;\n+\n+/**\n+ * This Mixin implements {@link IForgeTileEntity#onLoad()} and {@link IForgeTileEntity#onChunkUnloaded()}.\n+ */\n+@Mixin(World.class)\n+public class MixinWorld {\n+\t/////////////////////////////////////\n+\t/// addBlockEntity()\n+\t/////////////////////////////////////\n+\t@Inject(method = \"addBlockEntity\", at = @At(\"HEAD\"))\n+\tprivate void onAddBlockEntity(BlockEntity blockEntity, CallbackInfoReturnable<Boolean> ci) {\n+\t\tWorld me = (World) (Object) this;\n+\n+\t\tif (blockEntity.getWorld() != me) {\n+\t\t\t// Forge - set the world early as vanilla doesn't set it until next tick\n+\t\t\tblockEntity.setWorld(me);", "originalCommit": "b4ec5d04f092338e9a024f8f7b591239edf58e69", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIxNjA4Nw==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r463216087", "bodyText": "No, the world field will be set anyway. Fabric mods are made under the assumption that world is not available upon creation, so they will not attempt to access it that early. I think this modification should not cause trouble to fabric mods. But I'm sure that a lot of Forge mods need this.", "author": "rikka0w0", "createdAt": "2020-07-30T19:17:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzEyMjI0OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "69c9bc5e90bf3de23471078e19cebfa81ebd763b", "url": "https://github.com/PatchworkMC/patchwork-api/commit/69c9bc5e90bf3de23471078e19cebfa81ebd763b", "message": "Update patchwork-extensions-blockentity/src/main/java/net/minecraftforge/common/extensions/IForgeTileEntity.java\n\nCo-authored-by: Glitch <glitchieproductionsofficial@gmail.com>", "committedDate": "2020-07-30T19:19:22Z", "type": "commit"}, {"oid": "51886131bf789f3d37d36c546564dd49f3437440", "url": "https://github.com/PatchworkMC/patchwork-api/commit/51886131bf789f3d37d36c546564dd49f3437440", "message": "Apply suggestions", "committedDate": "2020-07-30T19:31:37Z", "type": "commit"}, {"oid": "1b49bcaf60a5315dd8e7d3a2f09044275987bbec", "url": "https://github.com/PatchworkMC/patchwork-api/commit/1b49bcaf60a5315dd8e7d3a2f09044275987bbec", "message": "Merge remote-tracking branch 'origin/master' into\nfeature/extensions-blockentity\n\nConflicts:\n\tpatchwork-god-classes/build.gradle", "committedDate": "2020-07-31T19:36:52Z", "type": "commit"}, {"oid": "77ea6745a2f858d1709c44a2d51ee7ef0b931765", "url": "https://github.com/PatchworkMC/patchwork-api/commit/77ea6745a2f858d1709c44a2d51ee7ef0b931765", "message": "Revert \"Apply suggestions\"\n\nThis reverts commit 51886131bf789f3d37d36c546564dd49f3437440.", "committedDate": "2020-08-04T01:02:04Z", "type": "commit"}, {"oid": "5656424e74bb367cab6a017fd93e48baceff822a", "url": "https://github.com/PatchworkMC/patchwork-api/commit/5656424e74bb367cab6a017fd93e48baceff822a", "message": "Apply suggestions", "committedDate": "2020-08-04T01:04:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyOTE1Mg==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r465429152", "bodyText": "I don't think this part of World is thread-safe. Maybe implement something like what I do in my BlockSnapshot PR?", "author": "TheGlitch76", "createdAt": "2020-08-05T02:05:21Z", "path": "patchwork-extensions-blockentity/src/main/java/net/patchworkmc/mixin/extensions/blockentity/MixinWorld.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.patchworkmc.mixin.extensions.blockentity;\n+\n+import java.util.Iterator;\n+import java.util.List;\n+\n+import org.objectweb.asm.Opcodes;\n+import org.spongepowered.asm.mixin.Final;\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.At.Shift;\n+import org.spongepowered.asm.mixin.injection.Inject;\n+import org.spongepowered.asm.mixin.injection.ModifyVariable;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;\n+import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;\n+import org.spongepowered.asm.mixin.injection.callback.LocalCapture;\n+import net.minecraftforge.common.extensions.IForgeTileEntity;\n+\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.util.Tickable;\n+import net.minecraft.util.math.BlockPos;\n+import net.minecraft.util.profiler.Profiler;\n+import net.minecraft.world.World;\n+import net.minecraft.world.chunk.WorldChunk;\n+\n+/**\n+ * This Mixin implements {@link IForgeTileEntity#onLoad()} and {@link IForgeTileEntity#onChunkUnloaded()}.\n+ */\n+@Mixin(World.class)\n+public class MixinWorld {\n+\t/////////////////////////////////////\n+\t/// addBlockEntity()\n+\t/////////////////////////////////////\n+\t@Inject(method = \"addBlockEntity\", at = @At(\"HEAD\"))\n+\tprivate void onAddBlockEntity(BlockEntity blockEntity, CallbackInfoReturnable<Boolean> ci) {\n+\t\tWorld me = (World) (Object) this;\n+\n+\t\tif (blockEntity.getWorld() != me) {\n+\t\t\t// Forge - set the world early as vanilla doesn't set it until next tick\n+\t\t\tblockEntity.setWorld(me);\n+\t\t}\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprotected List<BlockEntity> pendingBlockEntities;\n+\n+\t@Inject(method = \"addBlockEntity\", cancellable = true,\n+\t\t\tat = @At(value = \"INVOKE\", ordinal = 0, shift = Shift.AFTER, remap = false,\n+\t\t\ttarget = \"org/apache/logging/log4j/Logger.error(Ljava/lang/String;[Lorg/apache/logging/log4j/util/Supplier;)V\"))\n+\tprivate void onBlockEntityAdding(BlockEntity blockEntity, CallbackInfoReturnable<Boolean> cir) {\n+\t\t// Forge: wait to add new TE if we're currently processing existing ones\n+\t\tcir.setReturnValue(pendingBlockEntities.add(blockEntity));\n+\t}\n+\n+\t@Inject(method = \"addBlockEntity\", at = @At(value = \"FIELD\", ordinal = 0, shift = Shift.BEFORE,\n+\t\t\ttarget = \"net/minecraft/world/World.isClient:Z\", opcode = Opcodes.GETFIELD))\n+\tprivate void onBlockEntityAdded(BlockEntity blockEntity, CallbackInfoReturnable<Boolean> cir) {\n+\t\t// We cannot use Fabric events because Forge's onLoad() is also called on the client side.\n+\t\t((IForgeTileEntity) blockEntity).onLoad();\n+\t}\n+\n+\t/////////////////////////////////////\n+\t/// tickBlockEntities()\n+\t/////////////////////////////////////\n+\t@Shadow\n+\tprotected boolean iteratingTickingBlockEntities;\n+\n+\t@Inject(method = \"tickBlockEntities\", at = @At(value = \"INVOKE\", ordinal = 0, shift = Shift.AFTER,\n+\t\t\ttarget = \"net/minecraft/util/profiler/Profiler.push(Ljava/lang/String;)V\"))\n+\tprivate void onTickBlockEntitiesStart(CallbackInfo ci) {\n+\t\t// Forge: Move above remove to prevent CocurrentModificationException\n+\t\titeratingTickingBlockEntities = true;\n+\t}\n+\n+\t@Shadow\n+\t@Final\n+\tprotected List<BlockEntity> unloadedBlockEntities;\n+\n+\t@Inject(method = \"tickBlockEntities\", at = @At(value = \"INVOKE\", ordinal = 0, shift = Shift.BEFORE,\n+\t\t\ttarget = \"java/util/List.removeAll(Ljava/util/Collection;)Z\"))\n+\tprivate void onBlockEntitiesRemoved(CallbackInfo ci) {\n+\t\tfor (BlockEntity blockEntity: unloadedBlockEntities) {\n+\t\t\t((IForgeTileEntity) blockEntity).onChunkUnloaded();\n+\t\t}\n+\t}\n+\n+\t@Unique\n+\tprivate static final ThreadLocal<BlockEntity> onBlockEntitiesRemoved_BlockEntity = ThreadLocal.withInitial(() -> null);", "originalCommit": "5656424e74bb367cab6a017fd93e48baceff822a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5Mjg0MQ==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r465892841", "bodyText": "tickBlockEntities is supposed to be fired on either the main server thread or the main client thread?", "author": "rikka0w0", "createdAt": "2020-08-05T17:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyOTE1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyOTQ4MA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r465429480", "bodyText": "again, i'm 90% sure this is not thread safe", "author": "TheGlitch76", "createdAt": "2020-08-05T02:06:38Z", "path": "patchwork-extensions-blockentity/src/main/java/net/patchworkmc/mixin/extensions/blockentity/MixinWorldRenderer.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Minecraft Forge, Patchwork Project\n+ * Copyright (c) 2016-2020, 2019-2020\n+ *\n+ * This library is free software; you can redistribute it and/or\n+ * modify it under the terms of the GNU Lesser General Public\n+ * License as published by the Free Software Foundation version 2.1\n+ * of the License.\n+ *\n+ * This library is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this library; if not, write to the Free Software\n+ * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA\n+ */\n+\n+package net.patchworkmc.mixin.extensions.blockentity;\n+\n+import org.spongepowered.asm.mixin.Mixin;\n+import org.spongepowered.asm.mixin.Shadow;\n+import org.spongepowered.asm.mixin.Unique;\n+import org.spongepowered.asm.mixin.injection.At;\n+import org.spongepowered.asm.mixin.injection.Constant;\n+import org.spongepowered.asm.mixin.injection.ModifyConstant;\n+import org.spongepowered.asm.mixin.injection.Redirect;\n+import net.minecraftforge.common.extensions.IForgeTileEntity;\n+\n+import net.minecraft.block.ChestBlock;\n+import net.minecraft.block.entity.BlockEntity;\n+import net.minecraft.client.render.BlockBreakingInfo;\n+import net.minecraft.client.render.Camera;\n+import net.minecraft.client.render.VisibleRegion;\n+import net.minecraft.client.render.WorldRenderer;\n+import net.minecraft.client.render.block.entity.BlockEntityRenderDispatcher;\n+import net.minecraft.client.world.ClientWorld;\n+import net.minecraft.util.math.BlockPos;\n+\n+/**\n+ * Implements {@link IForgeTileEntity#getRenderBoundingBox()} and\n+ * {@link IForgeTileEntity#canRenderBreaking()}.\n+ */\n+@Mixin(WorldRenderer.class)\n+public class MixinWorldRenderer {\n+\t/////////////////////////////////////\n+\t/// renderEntities()\n+\t/////////////////////////////////////\n+\t// Redirect two calls.\n+\t@Redirect(method = \"renderEntities\", at = @At(value = \"INVOKE\",\n+\t\t\ttarget = \"net/minecraft/client/render/block/entity/BlockEntityRenderDispatcher.render(Lnet/minecraft/block/entity/BlockEntity;FI)V\"))\n+\tprivate void renderBlockEntityIfVisible(BlockEntityRenderDispatcher dispatcher, BlockEntity blockEntity, float tickDelta, int blockBreakStage,\n+\t\t\tCamera camera, VisibleRegion visibleRegion, float tickDeltaParam) {\n+\t\tIForgeTileEntity te = (IForgeTileEntity) blockEntity;\n+\n+\t\tif (visibleRegion.intersects(te.getRenderBoundingBox())) {\n+\t\t\tdispatcher.render(blockEntity, tickDeltaParam, blockBreakStage);\n+\t\t}\n+\t}\n+\n+\t/////////////////////////////////////\n+\t/// renderPartiallyBrokenBlocks()\n+\t/////////////////////////////////////\n+\t@Shadow\n+\tprivate ClientWorld world;\n+\t@Unique\n+\tprivate static final ThreadLocal<BlockPos> blockPosParam = ThreadLocal.withInitial(() -> null);", "originalCommit": "5656424e74bb367cab6a017fd93e48baceff822a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkwNDkxNA==", "url": "https://github.com/PatchworkMC/patchwork-api/pull/162#discussion_r465904914", "bodyText": "here I only collect the value of a local variable, there's no access to the internal state of other objects, I don't get why this is unsafe.", "author": "rikka0w0", "createdAt": "2020-08-05T17:57:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQyOTQ4MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "3938c9ba874fba7181b0fd4b5dd04b5ab830aa47", "url": "https://github.com/PatchworkMC/patchwork-api/commit/3938c9ba874fba7181b0fd4b5dd04b5ab830aa47", "message": "Resolve merge conflicts", "committedDate": "2020-08-17T11:04:43Z", "type": "commit"}]}