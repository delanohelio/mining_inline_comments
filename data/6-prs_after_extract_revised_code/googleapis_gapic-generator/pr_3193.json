{"pr_number": 3193, "pr_title": "fix: handle wildcard parent patterns", "pr_createdAt": "2020-05-11T20:43:22Z", "pr_url": "https://github.com/googleapis/gapic-generator/pull/3193", "timeline": [{"oid": "2719bcf7e4b40213458f743da4a2ae94036afa0d", "url": "https://github.com/googleapis/gapic-generator/commit/2719bcf7e4b40213458f743da4a2ae94036afa0d", "message": "fix: handle wildcard parent patterns", "committedDate": "2020-05-11T20:40:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODk2Mg==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423318962", "bodyText": "super not important: please format these (some have spaces after /* some don't)", "author": "vam-google", "createdAt": "2020-05-11T21:04:52Z", "path": "src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java", "diffHunk": "@@ -75,6 +76,19 @@\n   /** The entity name for the resource config. */\n   public abstract String getDerivedEntityName();\n \n+  public static ResourceDescriptorConfig getWildcardResource(ProtoFile protoFile) {\n+    return new AutoValue_ResourceDescriptorConfig(\n+        /* isDefinedAtMessageLevel= */ false,", "originalCommit": "2719bcf7e4b40213458f743da4a2ae94036afa0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1ODU3Ng==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423958576", "bodyText": "Done.", "author": "miraleung", "createdAt": "2020-05-12T18:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxODk2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "ca52a4ae8ad137db30bded47ae7f9d71c81f63f3", "chunk": "diff --git a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\nindex 763e9b8d4..c0218f292 100644\n--- a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n+++ b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n\n@@ -80,8 +80,8 @@ public abstract class ResourceDescriptorConfig {\n     return new AutoValue_ResourceDescriptorConfig(\n         /* isDefinedAtMessageLevel= */ false,\n         /* unifiedResourceType= */ \"\",\n-        /*patterns=*/ ImmutableList.of(\"*\"),\n-        /*nameField=*/ \"\",\n+        /* patterns= */ ImmutableList.of(\"*\"),\n+        /* nameField= */ \"\",\n         /* history= */ ResourceDescriptor.History.HISTORY_UNSPECIFIED,\n         /* requiresOneofConfig= */ false,\n         /* singlePattern= */ \"*\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNTgzOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423325838", "bodyText": "Is it a debug artifact?", "author": "vam-google", "createdAt": "2020-05-11T21:18:30Z", "path": "src/test/java/com/google/api/codegen/config/ResourceDescriptorConfigTest.java", "diffHunk": "@@ -294,6 +294,61 @@ public void testGetChildParentResourceMap_MultiParentsMultiPatterns() {\n     assertThat(childParentResourceMap.get(\"food.google.com/Sauce\")).containsExactly(veggie, meat);\n   }\n \n+  @Test\n+  public void testGetChildParentResourceMap_MultiParentsMultiPatternsWithWildcard() {\n+    ResourceDescriptorConfig sauce =\n+        ResourceDescriptorConfig.from(\n+            ResourceDescriptor.newBuilder()\n+                .setType(\"food.google.com/Sauce\")\n+                .addPattern(\"steaks/{steak}/sauces/{sauce}\")\n+                .addPattern(\"barbeques/{barbeque}/sauces/{sauce}\")\n+                .addPattern(\"tofus/{tofu}/sauces/{sauce}\")\n+                .addPattern(\"salads/{salad}/sauces/{sauce}\")\n+                .addPattern(\"*\")\n+                .build(),\n+            protoFile,\n+            true);\n+\n+    ResourceDescriptorConfig meat =\n+        ResourceDescriptorConfig.from(\n+            ResourceDescriptor.newBuilder()\n+                .setType(\"food.google.com/Meat\")\n+                .addPattern(\"steaks/{steak}\")\n+                .addPattern(\"barbeques/{barbeque}\")\n+                .build(),\n+            protoFile,\n+            true);\n+\n+    ResourceDescriptorConfig veggie =\n+        ResourceDescriptorConfig.from(\n+            ResourceDescriptor.newBuilder()\n+                .setType(\"food.google.com/Veggie\")\n+                .addPattern(\"tofus/{tofu}\")\n+                .addPattern(\"salads/{salad}\")\n+                .build(),\n+            protoFile,\n+            true);\n+\n+    ResourceDescriptorConfig wildcard =\n+        ResourceDescriptorConfig.from(\n+            ResourceDescriptor.newBuilder().addPattern(\"*\").build(), protoFile, false);\n+\n+    Map<String, ResourceDescriptorConfig> descriptorConfigMap =\n+        getDescriptorConfigMap(sauce, meat, veggie);\n+    Map<String, List<ResourceDescriptorConfig>> patternResourceDescriptorMap =\n+        ResourceDescriptorConfig.getPatternResourceMap(Arrays.asList(sauce, meat, veggie));\n+\n+    Map<String, List<ResourceDescriptorConfig>> childParentResourceMap =\n+        ResourceDescriptorConfig.getChildParentResourceMap(\n+            descriptorConfigMap, patternResourceDescriptorMap);\n+    System.out.println(", "originalCommit": "2719bcf7e4b40213458f743da4a2ae94036afa0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1ODU1NA==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423958554", "bodyText": "Removed.", "author": "miraleung", "createdAt": "2020-05-12T18:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNTgzOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzMTMyOQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423331329", "bodyText": "Are these intended, or are they the debug artifacts?", "author": "vam-google", "createdAt": "2020-05-11T21:30:02Z", "path": "src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java", "diffHunk": "@@ -218,7 +232,25 @@ private String getUnqualifiedTypeName() {\n         ImmutableList.copyOf(descriptorConfigMap.values());\n     for (Map.Entry<String, ResourceDescriptorConfig> entry : descriptorConfigMap.entrySet()) {\n       ResourceDescriptorConfig childResource = entry.getValue();\n+      System.out.println(\n+          \"DEL: Looking at entry \"", "originalCommit": "2719bcf7e4b40213458f743da4a2ae94036afa0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk1ODUyOA==", "url": "https://github.com/googleapis/gapic-generator/pull/3193#discussion_r423958528", "bodyText": "Removed.", "author": "miraleung", "createdAt": "2020-05-12T18:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMzMTMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "ca52a4ae8ad137db30bded47ae7f9d71c81f63f3", "chunk": "diff --git a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\nindex 763e9b8d4..c0218f292 100644\n--- a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n+++ b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n\n@@ -232,19 +232,8 @@ public abstract class ResourceDescriptorConfig {\n         ImmutableList.copyOf(descriptorConfigMap.values());\n     for (Map.Entry<String, ResourceDescriptorConfig> entry : descriptorConfigMap.entrySet()) {\n       ResourceDescriptorConfig childResource = entry.getValue();\n-      System.out.println(\n-          \"DEL: Looking at entry \"\n-              + entry.getKey()\n-              + \" : \"\n-              + entry.getValue()\n-              + \", getparent: \"\n-              + getParentPatternsMap(childResource));\n       for (int i = 0; i < allResources.size(); i++) {\n         if (childResource.getPatterns().contains(\"*\")) {\n-          System.out.println(\"DEL: Contains pattern wildcard\");\n-          System.out.println(\n-              \"DEL: Will use wildcard pattern \"\n-                  + getWildcardResource(childResource.getAssignedProtoFile()));\n           builder.put(\n               entry.getKey(),\n               Arrays.asList(getWildcardResource(childResource.getAssignedProtoFile())));\n"}}, {"oid": "ca52a4ae8ad137db30bded47ae7f9d71c81f63f3", "url": "https://github.com/googleapis/gapic-generator/commit/ca52a4ae8ad137db30bded47ae7f9d71c81f63f3", "message": "fix: cleanups for handling wildcard parent patterns", "committedDate": "2020-05-12T18:51:19Z", "type": "commit"}]}