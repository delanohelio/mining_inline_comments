{"pr_number": 3151, "pr_title": "feat: trace up only one level when calculating parent types with singleton resource names ", "pr_createdAt": "2020-03-28T00:21:49Z", "pr_url": "https://github.com/googleapis/gapic-generator/pull/3151", "timeline": [{"oid": "a1d3a42886ca0e89b511b1618aef3acbff939389", "url": "https://github.com/googleapis/gapic-generator/commit/a1d3a42886ca0e89b511b1618aef3acbff939389", "message": "baseline", "committedDate": "2020-03-28T00:18:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyMzU0Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399623547", "bodyText": "Is this method ever called for a pattern of \"\"? If so, it should return \"\" at that point.", "author": "jskeet", "createdAt": "2020-03-28T05:41:56Z", "path": "src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java", "diffHunk": "@@ -271,15 +271,16 @@ private String getUnqualifiedTypeName() {\n   @VisibleForTesting\n   static String getParentPattern(String pattern) {\n     List<String> segments = getSegments(pattern);\n-    int index = segments.size() - 2;\n-    while (index >= 0 && !isVariableBinding(segments.get(index))) {\n+    int index = segments.size() - 1;", "originalCommit": "a1d3a42886ca0e89b511b1618aef3acbff939389", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTI3Mg==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399625272", "bodyText": "That's a good point!", "author": "yihanzhen", "createdAt": "2020-03-28T06:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyMzU0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b08bf511a9d4b48b8120c31ce3f6cdc03b1012e1", "chunk": "diff --git a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\nindex f20ca0ac9..5ead26503 100644\n--- a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n+++ b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n\n@@ -272,14 +272,16 @@ public abstract class ResourceDescriptorConfig {\n   static String getParentPattern(String pattern) {\n     List<String> segments = getSegments(pattern);\n     int index = segments.size() - 1;\n+    if (index < 0) {\n+      return \"\";\n+    }\n     if (isVariableBinding(segments.get(index))) {\n       index -= 2;\n     } else {\n       index--;\n     }\n-    if (index < 0) {\n-      return \"\";\n-    }\n+    Preconditions.checkArgument(\n+        index >= -1, \"malformatted pattern, can't calculate parent: %s\", pattern);\n     return String.join(\"/\", segments.subList(0, index + 1));\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyMzU1OQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399623559", "bodyText": "Does this report an error?", "author": "jskeet", "createdAt": "2020-03-28T05:42:11Z", "path": "src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java", "diffHunk": "@@ -271,15 +271,16 @@ private String getUnqualifiedTypeName() {\n   @VisibleForTesting\n   static String getParentPattern(String pattern) {\n     List<String> segments = getSegments(pattern);\n-    int index = segments.size() - 2;\n-    while (index >= 0 && !isVariableBinding(segments.get(index))) {\n+    int index = segments.size() - 1;\n+    if (isVariableBinding(segments.get(index))) {\n+      index -= 2;\n+    } else {\n       index--;\n     }\n-    index++;\n-    if (index <= 0) {\n+    if (index < 0) {", "originalCommit": "a1d3a42886ca0e89b511b1618aef3acbff939389", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTI4MA==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399625280", "bodyText": "Done", "author": "yihanzhen", "createdAt": "2020-03-28T06:04:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyMzU1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b08bf511a9d4b48b8120c31ce3f6cdc03b1012e1", "chunk": "diff --git a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\nindex f20ca0ac9..5ead26503 100644\n--- a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n+++ b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n\n@@ -272,14 +272,16 @@ public abstract class ResourceDescriptorConfig {\n   static String getParentPattern(String pattern) {\n     List<String> segments = getSegments(pattern);\n     int index = segments.size() - 1;\n+    if (index < 0) {\n+      return \"\";\n+    }\n     if (isVariableBinding(segments.get(index))) {\n       index -= 2;\n     } else {\n       index--;\n     }\n-    if (index < 0) {\n-      return \"\";\n-    }\n+    Preconditions.checkArgument(\n+        index >= -1, \"malformatted pattern, can't calculate parent: %s\", pattern);\n     return String.join(\"/\", segments.subList(0, index + 1));\n   }\n \n"}}, {"oid": "b08bf511a9d4b48b8120c31ce3f6cdc03b1012e1", "url": "https://github.com/googleapis/gapic-generator/commit/b08bf511a9d4b48b8120c31ce3f6cdc03b1012e1", "message": "add error check", "committedDate": "2020-03-28T06:03:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399625416", "bodyText": "I suspect this should be index >= 0 - as otherwise we get an empty pattern, which still isn't a useful parent.\n(Basically, taking the parent of \"foo\" for \"foos/{foo}\" is invalid, I'd say. The empty pattern can't represent a resource name, so it's not useful.)", "author": "jskeet", "createdAt": "2020-03-28T06:06:32Z", "path": "src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java", "diffHunk": "@@ -272,14 +272,16 @@ private String getUnqualifiedTypeName() {\n   static String getParentPattern(String pattern) {\n     List<String> segments = getSegments(pattern);\n     int index = segments.size() - 1;\n+    if (index < 0) {\n+      return \"\";\n+    }\n     if (isVariableBinding(segments.get(index))) {\n       index -= 2;\n     } else {\n       index--;\n     }\n-    if (index < 0) {\n-      return \"\";\n-    }\n+    Preconditions.checkArgument(\n+        index >= -1, \"malformatted pattern, can't calculate parent: %s\", pattern);", "originalCommit": "b08bf511a9d4b48b8120c31ce3f6cdc03b1012e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNjA2Nw==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399626067", "bodyText": "That is correct from the public-facing point of view - but this is an internal method. We need to call this method on every resource pattern to find if it has a parent, if so, which resource does the parent belong to. Therefore we can't error if the calculated parent is empty (for instance projects/{project}). I guess we are sort of using an empty string as a way to express \"this pattern does not have a parent pattern\".", "author": "yihanzhen", "createdAt": "2020-03-28T06:14:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyOTA5NQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399629095", "bodyText": "Ah, okay - in C# I believe we only find parents when we're asked to :)", "author": "jskeet", "createdAt": "2020-03-28T06:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTcyNzM0Mg==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399727342", "bodyText": "Hi Jon, can you approve the PR if you don't think there are other issues?", "author": "yihanzhen", "createdAt": "2020-03-29T00:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc1ODExMQ==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r399758111", "bodyText": "There's still the matter of the parent - of \"*\" - which wasn't clear in my previous comment due to Markdown, unfortunately. Basically I'd like to see a test showing that if you pass in \"*\", you get \"*\" back - and code to make that work.", "author": "jskeet", "createdAt": "2020-03-29T07:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM1NzExMA==", "url": "https://github.com/googleapis/gapic-generator/pull/3151#discussion_r400357110", "bodyText": "Oh that solves all the puzzles now. I will fix \"*\" shortly.", "author": "yihanzhen", "createdAt": "2020-03-30T17:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTYyNTQxNg=="}], "type": "inlineReview", "revised_code": {"commit": "69551f73e130f36740a8d5ffd888e9d105b2a54d", "chunk": "diff --git a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\nindex 5ead26503..8a903004b 100644\n--- a/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n+++ b/src/main/java/com/google/api/codegen/config/ResourceDescriptorConfig.java\n\n@@ -270,16 +270,19 @@ public abstract class ResourceDescriptorConfig {\n \n   @VisibleForTesting\n   static String getParentPattern(String pattern) {\n+    Preconditions.checkArgument(!pattern.equals(\"\"), \"resource pattern can't be an empty string.\");\n+    if (pattern.equals(\"*\")) {\n+      return \"*\";\n+    }\n+\n     List<String> segments = getSegments(pattern);\n     int index = segments.size() - 1;\n-    if (index < 0) {\n-      return \"\";\n-    }\n     if (isVariableBinding(segments.get(index))) {\n       index -= 2;\n     } else {\n       index--;\n     }\n+\n     Preconditions.checkArgument(\n         index >= -1, \"malformatted pattern, can't calculate parent: %s\", pattern);\n     return String.join(\"/\", segments.subList(0, index + 1));\n"}}, {"oid": "69551f73e130f36740a8d5ffd888e9d105b2a54d", "url": "https://github.com/googleapis/gapic-generator/commit/69551f73e130f36740a8d5ffd888e9d105b2a54d", "message": "check *", "committedDate": "2020-03-30T20:00:59Z", "type": "commit"}, {"oid": "f2886352b9e454a3c25d43182a740399ba32a6cd", "url": "https://github.com/googleapis/gapic-generator/commit/f2886352b9e454a3c25d43182a740399ba32a6cd", "message": "Merge branch 'master' into dialogflow", "committedDate": "2020-03-30T20:32:11Z", "type": "commit"}, {"oid": "b44adfb095680f23510228569a88f4b827c5383b", "url": "https://github.com/googleapis/gapic-generator/commit/b44adfb095680f23510228569a88f4b827c5383b", "message": "regenerate baseline", "committedDate": "2020-03-30T21:04:39Z", "type": "commit"}]}