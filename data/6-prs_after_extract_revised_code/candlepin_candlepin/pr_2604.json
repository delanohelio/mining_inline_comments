{"pr_number": 2604, "pr_title": "[F] ENT-1686: Change the way Dev Pools are created", "pr_createdAt": "2020-02-10T11:19:28Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2604", "timeline": [{"oid": "746250b8acbb7a6182990c81c4a27727e0e01b27", "url": "https://github.com/candlepin/candlepin/commit/746250b8acbb7a6182990c81c4a27727e0e01b27", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku.", "committedDate": "2020-02-11T13:05:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MTI0MA==", "url": "https://github.com/candlepin/candlepin/pull/2604#discussion_r378941240", "bodyText": "This block is a bit dangerous, since we have no innate control over whether or not devProduct actually returns a non-null value or not. Plus, we can do some optimization here to avoid instantiating a new collection, since we already have one to populate:\n            Collection<? extends ProductInfo> provided = devProduct.getProvidedProducts();\n\n            if (provided != null) {\n                provided.forEach(product -> {\n                    if (product != null) {\n                        devProductIds.add(product.getId());\n                    }\n                });\n            }", "author": "Ceiu", "createdAt": "2020-02-13T15:40:56Z", "path": "server/src/main/java/org/candlepin/controller/Entitler.java", "diffHunk": "@@ -362,26 +362,38 @@ protected Pool assembleDevPool(Consumer consumer, Owner owner, String sku) {\n         return pool;\n     }\n \n-    private DeveloperProducts getDeveloperPoolProducts(Consumer consumer, Owner owner, String sku) {\n-        DeveloperProducts devProducts = getDevProductMap(consumer, owner, sku);\n-        verifyDevProducts(consumer, sku, devProducts);\n+    private DeveloperProducts getDeveloperPoolProducts(Owner owner, String sku) {\n+        DeveloperProducts devProducts = getDevProductMap(owner, sku);\n+        verifyDevProducts(sku, devProducts);\n         return devProducts;\n     }\n \n     /**\n-     * Looks up all Products matching the specified SKU and the consumer's\n-     * installed products.\n+     * Looks up all Products and their provided products\n+     * matching the specified SKU.\n      *\n-     * @param consumer the consumer to pull the installed product id list from.\n      * @param sku the product id of the SKU.\n      * @return a {@link DeveloperProducts} object that contains the Product objects\n      *         from the adapter.\n      */\n-    private DeveloperProducts getDevProductMap(Consumer consumer, Owner owner, String sku) {\n-        List<String> devProductIds = new ArrayList<>();\n-        devProductIds.add(sku);\n-        for (ConsumerInstalledProduct ip : consumer.getInstalledProducts()) {\n-            devProductIds.add(ip.getProductId());\n+    private DeveloperProducts getDevProductMap(Owner owner, String sku) {\n+\n+        Collection<? extends ProductInfo> productsByIds = this.productAdapter\n+            .getProductsByIds(owner.getKey(), Arrays.asList(sku));\n+\n+        Collection<String> devProductIds = new ArrayList<>();\n+        if (productsByIds.iterator().hasNext()) {\n+            ProductInfo devProduct = productsByIds.iterator().next();\n+            devProductIds.add(devProduct.getId());\n+\n+            if (!devProduct.getProvidedProducts().isEmpty()) {", "originalCommit": "746250b8acbb7a6182990c81c4a27727e0e01b27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI5MTgwNg==", "url": "https://github.com/candlepin/candlepin/pull/2604#discussion_r379291806", "bodyText": "Agreed, null objects needed to be filtered out. Updated as suggested.", "author": "sonalidhome", "createdAt": "2020-02-14T07:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MTI0MA=="}], "type": "inlineReview", "revised_code": {"commit": "0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "chunk": "diff --git a/server/src/main/java/org/candlepin/controller/Entitler.java b/server/src/main/java/org/candlepin/controller/Entitler.java\nindex ec771108d..920c7cd56 100644\n--- a/server/src/main/java/org/candlepin/controller/Entitler.java\n+++ b/server/src/main/java/org/candlepin/controller/Entitler.java\n\n@@ -386,13 +386,14 @@ public class Entitler {\n             ProductInfo devProduct = productsByIds.iterator().next();\n             devProductIds.add(devProduct.getId());\n \n-            if (!devProduct.getProvidedProducts().isEmpty()) {\n-                devProductIds.addAll(\n-                    devProduct.getProvidedProducts()\n-                    .stream()\n-                    .map(p -> p.getId())\n-                    .collect(Collectors.toList())\n-                );\n+            Collection<? extends ProductInfo> provided = devProduct.getProvidedProducts();\n+\n+            if (provided != null) {\n+                provided.forEach(product -> {\n+                    if (product != null) {\n+                        devProductIds.add(product.getId());\n+                    }\n+                });\n             }\n         }\n \n"}}, {"oid": "0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "url": "https://github.com/candlepin/candlepin/commit/0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku.", "committedDate": "2020-02-14T07:49:46Z", "type": "forcePushed"}, {"oid": "2020d4523ffc7af080ebfe414144603574c2af2b", "url": "https://github.com/candlepin/candlepin/commit/2020d4523ffc7af080ebfe414144603574c2af2b", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku.", "committedDate": "2020-02-14T07:59:18Z", "type": "commit"}, {"oid": "2020d4523ffc7af080ebfe414144603574c2af2b", "url": "https://github.com/candlepin/candlepin/commit/2020d4523ffc7af080ebfe414144603574c2af2b", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku.", "committedDate": "2020-02-14T07:59:18Z", "type": "forcePushed"}]}