{"pr_number": 2728, "pr_title": "[Bug 1844258]: Job Manager Logging Format Changes for Splunk (ENT-2480)", "pr_createdAt": "2020-06-18T10:41:25Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2728", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5ODg2OA==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442198868", "bodyText": "For the displayed value, we want to use snake case, so \"job_key\" here is more appropriate.", "author": "Ceiu", "createdAt": "2020-06-18T12:47:06Z", "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1293,6 +1295,9 @@ private void setupJobRuntimeEnvironment(AsyncJobStatus status) {\n         MDC.put(MDC_REQUEST_TYPE_KEY, \"job\");\n         MDC.put(MDC_REQUEST_UUID_KEY, status.getId());\n \n+        MDC.put(MDC_REQUEST_SUB_TYPE_KEY, \"jobKey\");", "originalCommit": "8ca73f3ee33fcf39c2f73d566184e2cd9dba0902", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxMTc0Ng==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442311746", "bodyText": "Dropped this key from here.", "author": "wolfdale", "createdAt": "2020-06-18T15:26:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5ODg2OA=="}], "type": "inlineReview", "revised_code": {"commit": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/JobManager.java b/server/src/main/java/org/candlepin/async/JobManager.java\nindex 12937cbba..d73600c9b 100644\n--- a/server/src/main/java/org/candlepin/async/JobManager.java\n+++ b/server/src/main/java/org/candlepin/async/JobManager.java\n\n@@ -1294,9 +1293,7 @@ public class JobManager implements ModeChangeListener {\n \n         MDC.put(MDC_REQUEST_TYPE_KEY, \"job\");\n         MDC.put(MDC_REQUEST_UUID_KEY, status.getId());\n-\n-        MDC.put(MDC_REQUEST_SUB_TYPE_KEY, \"jobKey\");\n-        MDC.put(MDC_REQUEST_NAME_KEY, status.getJobKey());\n+        MDC.put(MDC_REQUEST_JOB_KEY, status.getJobKey());\n \n         // Inject all of our metadata...\n         for (Map.Entry<String, String> entry : status.getMetadata().entrySet()) {\n"}}, {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "url": "https://github.com/candlepin/candlepin/commit/88e56a51bc860a9df97f1f868e4e2f0587ec2610", "message": "1844258: Job Manager Logging Format Changes for Splunk", "committedDate": "2020-06-18T15:18:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNjI5NQ==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442316295", "bodyText": "Looks like a refactor artifact here.", "author": "Ceiu", "createdAt": "2020-06-18T15:32:52Z", "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1197,7 +1198,7 @@ public AsyncJobStatus executeJob(JobMessage message) throws JobException {\n         // rather than failing directly. This would allow use of aliases and explicit job\n         // classes.\n         if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n+            String errmsg = String.format(\"No registered job class for jobKey=%s\", status.getJobKey());", "originalCommit": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyOTUzMQ==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442329531", "bodyText": "Changed it to job_key.", "author": "wolfdale", "createdAt": "2020-06-18T15:51:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNjI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/JobManager.java b/server/src/main/java/org/candlepin/async/JobManager.java\nindex d73600c9b..c77cab37b 100644\n--- a/server/src/main/java/org/candlepin/async/JobManager.java\n+++ b/server/src/main/java/org/candlepin/async/JobManager.java\n\n@@ -1198,7 +1198,7 @@ public class JobManager implements ModeChangeListener {\n         // rather than failing directly. This would allow use of aliases and explicit job\n         // classes.\n         if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for jobKey=%s\", status.getJobKey());\n+            String errmsg = String.format(\"No registered job class for job_key=%s\", status.getJobKey());\n \n             this.updateJobStatus(status, JobState.FAILED, errmsg);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxODAwNQ==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442318005", "bodyText": "MDC_JOB_KEY_KEY\nThe name sounds a bit silly and redundant, but it is the key for the job key.", "author": "Ceiu", "createdAt": "2020-06-18T15:35:14Z", "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -93,6 +93,7 @@\n \n     private static final String MDC_REQUEST_TYPE_KEY = \"requestType\";\n     private static final String MDC_REQUEST_UUID_KEY = \"requestUuid\";\n+    private static final String MDC_REQUEST_JOB_KEY = \"jobKey\";", "originalCommit": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMyOTYxOA==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442329618", "bodyText": "Done.", "author": "wolfdale", "createdAt": "2020-06-18T15:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxODAwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/JobManager.java b/server/src/main/java/org/candlepin/async/JobManager.java\nindex d73600c9b..c77cab37b 100644\n--- a/server/src/main/java/org/candlepin/async/JobManager.java\n+++ b/server/src/main/java/org/candlepin/async/JobManager.java\n\n@@ -93,7 +93,7 @@ public class JobManager implements ModeChangeListener {\n \n     private static final String MDC_REQUEST_TYPE_KEY = \"requestType\";\n     private static final String MDC_REQUEST_UUID_KEY = \"requestUuid\";\n-    private static final String MDC_REQUEST_JOB_KEY = \"jobKey\";\n+    private static final String MDC_JOB_KEY_KEY = \"jobKey\";\n     private static final String MDC_LOG_LEVEL_KEY = \"logLevel\";\n \n     private static final String QRTZ_GROUP_CONFIG = \"cp_async_config\";\n"}}, {"oid": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "url": "https://github.com/candlepin/candlepin/commit/cb27a0f8a23f5a85c286f1237546ae89b14b6565", "message": "1844258: Job Manager Logging Format Changes for Splunk", "committedDate": "2020-06-18T15:44:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTQwNw==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442335407", "bodyText": "I'm guessing the intent here is to make this particular line searchable as part of the same log query? If so, changing the message isn't the way to go here. This block can safely live in the try block below immediately following the setupJobRuntimeEnvironment call (with proper whitespace).\nI also noticed a bug unrelated to your code in the log message below regarding job instantiation. We can fix that here as well:\n        try {\n            this.setupJobRuntimeEnvironment(status);\n\n            // Maybe in this case it'd be better to attempt to use the job key as the job class\n            // rather than failing directly. This would allow use of aliases and explicit job\n            // classes.\n            Class<? extends AsyncJob> jobClass = getJobClass(status.getJobKey());\n            if (jobClass == null) {\n                String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n\n                this.updateJobStatus(status, JobState.FAILED, errmsg);\n\n                log.error(errmsg);\n                throw new JobInitializationException(errmsg, true);\n            }\n\n            EventSink eventSink = injector.getInstance(EventSink.class);\n            AsyncJob job = injector.getInstance(jobClass);\n\n            if (job == null) {\n                String errmsg = String.format(\"Unable to instantiate job class \\\"%s\\\" for job: %s\",\n                    jobClass.getName(), status.getJobKey());\n\n                log.error(errmsg);\n                throw new JobInitializationException(errmsg);\n            }", "author": "Ceiu", "createdAt": "2020-06-18T16:00:29Z", "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1197,7 +1198,7 @@ public AsyncJobStatus executeJob(JobMessage message) throws JobException {\n         // rather than failing directly. This would allow use of aliases and explicit job\n         // classes.\n         if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n+            String errmsg = String.format(\"No registered job class for job_key=%s\", status.getJobKey());", "originalCommit": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY0MjA4MA==", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442642080", "bodyText": "Done.", "author": "wolfdale", "createdAt": "2020-06-19T05:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTQwNw=="}], "type": "inlineReview", "revised_code": {"commit": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/JobManager.java b/server/src/main/java/org/candlepin/async/JobManager.java\nindex c77cab37b..49e766c0d 100644\n--- a/server/src/main/java/org/candlepin/async/JobManager.java\n+++ b/server/src/main/java/org/candlepin/async/JobManager.java\n\n@@ -1192,28 +1192,28 @@ public class JobManager implements ModeChangeListener {\n             return status;\n         }\n \n-        final Class<? extends AsyncJob> jobClass = getJobClass(status.getJobKey());\n+        try {\n+            this.setupJobRuntimeEnvironment(status);\n \n-        // Maybe in this case it'd be better to attempt to use the job key as the job class\n-        // rather than failing directly. This would allow use of aliases and explicit job\n-        // classes.\n-        if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for job_key=%s\", status.getJobKey());\n+            // Maybe in this case it'd be better to attempt to use the job key as the job class\n+            // rather than failing directly. This would allow use of aliases and explicit job\n+            // classes.\n+            Class<? extends AsyncJob> jobClass = getJobClass(status.getJobKey());\n \n-            this.updateJobStatus(status, JobState.FAILED, errmsg);\n+            if (jobClass == null) {\n+                String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n \n-            log.error(errmsg);\n-            throw new JobInitializationException(errmsg, true);\n-        }\n+                this.updateJobStatus(status, JobState.FAILED, errmsg);\n \n-        try {\n-            this.setupJobRuntimeEnvironment(status);\n+                log.error(errmsg);\n+                throw new JobInitializationException(errmsg, true);\n+            }\n \n             EventSink eventSink = injector.getInstance(EventSink.class);\n             AsyncJob job = injector.getInstance(jobClass);\n \n             if (job == null) {\n-                String errmsg = String.format(\"Unable to instantiate job class \\\"{}\\\" for job: {}\",\n+                String errmsg = String.format(\"Unable to instantiate job class \\\"%s\\\" for job: %s\",\n                     jobClass.getName(), status.getJobKey());\n \n                 log.error(errmsg);\n"}}, {"oid": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "url": "https://github.com/candlepin/candlepin/commit/942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "message": "1844258: Job Manager Logging Format Changes for Splunk", "committedDate": "2020-06-19T05:41:44Z", "type": "commit"}, {"oid": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "url": "https://github.com/candlepin/candlepin/commit/942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "message": "1844258: Job Manager Logging Format Changes for Splunk", "committedDate": "2020-06-19T05:41:44Z", "type": "forcePushed"}]}