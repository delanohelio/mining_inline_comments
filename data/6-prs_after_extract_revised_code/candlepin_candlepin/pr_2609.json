{"pr_number": 2609, "pr_title": "[M] ENT-2049: Use new hibernate session per job", "pr_createdAt": "2020-02-11T12:31:17Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2609", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MzEwMA==", "url": "https://github.com/candlepin/candlepin/pull/2609#discussion_r377683100", "bodyText": "We should set the owner to the merged owner here since we use it again later.", "author": "Ceiu", "createdAt": "2020-02-11T14:52:25Z", "path": "server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java", "diffHunk": "@@ -173,10 +173,12 @@ public Object execute(JobExecutionContext context) throws JobExecutionException\n         // Clear out upstream ID so owner can import from other distributors:\n         UpstreamConsumer uc = owner.getUpstreamConsumer();\n         owner.setUpstreamConsumer(null);\n+        this.ownerCurator.merge(owner);", "originalCommit": "31fa51218d5f233e084ae3316ecd5a5078af4cc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1Mjg5OQ==", "url": "https://github.com/candlepin/candlepin/pull/2609#discussion_r378852899", "bodyText": "Done", "author": "nikosmoum", "createdAt": "2020-02-13T13:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MzEwMA=="}], "type": "inlineReview", "revised_code": {"commit": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java b/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\nindex f0a153426..66478c062 100644\n--- a/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\n+++ b/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\n\n@@ -173,12 +173,12 @@ public class UndoImportsJob implements AsyncJob {\n         // Clear out upstream ID so owner can import from other distributors:\n         UpstreamConsumer uc = owner.getUpstreamConsumer();\n         owner.setUpstreamConsumer(null);\n-        this.ownerCurator.merge(owner);\n+        owner = this.ownerCurator.merge(owner);\n         this.ownerCurator.flush();\n \n         this.exportCurator.delete(metadata);\n         this.recordManifestDeletion(owner, principalName, uc);\n-        this.ownerCurator.evict(owner);\n+\n         return String.format(\"Imported pools removed for owner: %s\", displayName);\n     }\n \n"}}, {"oid": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "url": "https://github.com/candlepin/candlepin/commit/e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "message": "ENT-2049: Use new hibernate session per job\n\n- Use UnitOfWork to open/close a sessions when starting/stopping a\n  job. Currently hibernate sessions are staying open when artemis\n  jobs are running, which causes a lot of issues, one of them being\n  manifested as stale data when the same artemis thread happens to\n  execute the same job sequentially, resulting in intermittent\n  spec test failures in import_spec.rb", "committedDate": "2020-02-13T13:14:18Z", "type": "commit"}, {"oid": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "url": "https://github.com/candlepin/candlepin/commit/e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "message": "ENT-2049: Use new hibernate session per job\n\n- Use UnitOfWork to open/close a sessions when starting/stopping a\n  job. Currently hibernate sessions are staying open when artemis\n  jobs are running, which causes a lot of issues, one of them being\n  manifested as stale data when the same artemis thread happens to\n  execute the same job sequentially, resulting in intermittent\n  spec test failures in import_spec.rb", "committedDate": "2020-02-13T13:14:18Z", "type": "forcePushed"}]}