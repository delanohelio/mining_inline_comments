{"pr_number": 2663, "pr_title": "[F] ENT-2177: Use concrete method to locate ResourceLocator", "pr_createdAt": "2020-03-24T09:22:27Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2663", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MDYyNg==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r397160626", "bodyText": "It's not strictly critical to change for this PR, but in the future I would like to see these type of methods return a self-ref so we can do some chaining in the cases where our flow is to just instantiate and then initialize.", "author": "Ceiu", "createdAt": "2020-03-24T13:42:27Z", "path": "server/src/main/java/org/candlepin/resteasy/MethodLocator.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.resteasy;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.inject.Binding;\n+import com.google.inject.Injector;\n+\n+import org.jboss.resteasy.spi.metadata.ResourceBuilder;\n+import org.jboss.resteasy.spi.metadata.ResourceClass;\n+import org.jboss.resteasy.spi.metadata.ResourceLocator;\n+import org.jboss.resteasy.spi.metadata.ResourceMethod;\n+import org.jboss.resteasy.util.GetRestful;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.lang.reflect.Type;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.inject.Inject;\n+\n+/**\n+ * Holds a mapping of interface methods to concrete methods.\n+ * This map is populated during servlet initialization and then locked.\n+ */\n+public class MethodLocator {\n+    private static final Logger log = LoggerFactory.getLogger(MethodLocator.class);\n+\n+    private Map<Method, Method> internalMap;\n+    private boolean hasBeenInitialized = false;\n+\n+    private Injector injector;\n+\n+    @Inject\n+    public MethodLocator(Injector injector) {\n+        // Maintain the insertion order for nice output in debug statement\n+        internalMap = new LinkedHashMap<>();\n+        this.injector = injector;\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    public synchronized void init() {", "originalCommit": "d86ba3da42e443b1f2b7fab5cf6881c13abecc71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTg5Mw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r397571893", "bodyText": "Done.", "author": "abhiskum", "createdAt": "2020-03-25T02:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MDYyNg=="}], "type": "inlineReview", "revised_code": {"commit": "a3c0d0184f60555754a06e71fffd94581f606e5d", "chunk": "diff --git a/server/src/main/java/org/candlepin/resteasy/MethodLocator.java b/server/src/main/java/org/candlepin/resteasy/MethodLocator.java\nindex 3c825dd18..96baecc2e 100644\n--- a/server/src/main/java/org/candlepin/resteasy/MethodLocator.java\n+++ b/server/src/main/java/org/candlepin/resteasy/MethodLocator.java\n\n@@ -56,7 +56,7 @@ public class MethodLocator {\n     }\n \n     @SuppressWarnings(\"rawtypes\")\n-    public synchronized void init() {\n+    public synchronized MethodLocator init() {\n         if (hasBeenInitialized) {\n             throw new IllegalStateException(\"This map has already been initialized.\");\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzI4Nw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r397163287", "bodyText": "This ResourceLocatorMap instantiation is incorrect with the method locator being instantiated as it is below.", "author": "Ceiu", "createdAt": "2020-03-24T13:46:02Z", "path": "server/src/test/java/org/candlepin/test/DatabaseTestFixture.java", "diffHunk": "@@ -211,8 +213,9 @@ public void init(boolean beginTransaction) throws Exception {\n         locatorMap = this.injector.getInstance(ResourceLocatorMap.class);", "originalCommit": "d86ba3da42e443b1f2b7fab5cf6881c13abecc71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTc3Mw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r397571773", "bodyText": "Fixed.", "author": "abhiskum", "createdAt": "2020-03-25T02:18:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU3MTk4MA==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r397571980", "bodyText": "Fixed.", "author": "abhiskum", "createdAt": "2020-03-25T02:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU1MDQwNg==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r398550406", "bodyText": "This is still not going to work as expected. Because we're asking the injector for the ResourceLocator instance, it won't use the MethodLocator instantiated right above it; it'll get a difference instance that's managed by the injector. In this case, we want to create all three locator instances manually or inject all three instances, so that they're all built the same way and share the same instances.", "author": "Ceiu", "createdAt": "2020-03-26T12:57:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3MTI3Mw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r399071273", "bodyText": "Done.", "author": "abhiskum", "createdAt": "2020-03-27T07:09:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE2MzI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a3c0d0184f60555754a06e71fffd94581f606e5d", "chunk": "diff --git a/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java b/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\nindex e169b47f7..085c7a399 100755\n--- a/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\n+++ b/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\n\n@@ -210,11 +210,12 @@ public class DatabaseTestFixture {\n         this.injector = parentInjector.createChildInjector(\n             Modules.override(testingModule).with(getGuiceOverrideModule()));\n \n+        methodLocator = new MethodLocator(injector);\n+        methodLocator.init();\n+\n         locatorMap = this.injector.getInstance(ResourceLocatorMap.class);\n         locatorMap.init();\n \n-        methodLocator = new MethodLocator(injector);\n-        methodLocator.init();\n         annotationLocator = new AnnotationLocator(methodLocator);\n \n         securityInterceptor = this.injector.getInstance(TestingInterceptor.class);\n"}}, {"oid": "a3c0d0184f60555754a06e71fffd94581f606e5d", "url": "https://github.com/candlepin/candlepin/commit/a3c0d0184f60555754a06e71fffd94581f606e5d", "message": "ENT-2177: Use concrete method to locate ResourceLocator\n  - Added new class MethodLocator to hold interface method and concrete method mapping\n  - Updated ResourceLocatorMap class to use MethodLocator\n  - Update AnnotationLocator class to use MethodLocator instead of internal", "committedDate": "2020-03-25T02:15:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwNTEwNw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r398505107", "bodyText": "Why does this method need a new argument but it's not being used in the method?", "author": "nikosmoum", "createdAt": "2020-03-26T11:37:48Z", "path": "server/src/main/java/org/candlepin/resteasy/ResourceLocatorMap.java", "diffHunk": "@@ -284,7 +290,7 @@ protected void logLocators() {\n         }\n     }\n \n-    protected void registerLocators(ResourceClass resourceClass) {\n+    protected void registerLocators(ResourceClass resourceClass, Class<?> concreteClass) {", "originalCommit": "a3c0d0184f60555754a06e71fffd94581f606e5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTA3MTc3OQ==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r399071779", "bodyText": "@nikosmoum Initially I added method mapping in this class and then moved to separate class however forgot to remove this change.", "author": "abhiskum", "createdAt": "2020-03-27T07:11:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwNTEwNw=="}], "type": "inlineReview", "revised_code": {"commit": "39a298e0f7bf45a094c45072cfb7ce0686e8f99b", "chunk": "diff --git a/server/src/main/java/org/candlepin/resteasy/ResourceLocatorMap.java b/server/src/main/java/org/candlepin/resteasy/ResourceLocatorMap.java\nindex a403a2fd2..e8df086a2 100644\n--- a/server/src/main/java/org/candlepin/resteasy/ResourceLocatorMap.java\n+++ b/server/src/main/java/org/candlepin/resteasy/ResourceLocatorMap.java\n\n@@ -290,7 +290,7 @@ public class ResourceLocatorMap implements Map<Method, ResourceLocator> {\n         }\n     }\n \n-    protected void registerLocators(ResourceClass resourceClass, Class<?> concreteClass) {\n+    protected void registerLocators(ResourceClass resourceClass) {\n         for (ResourceMethod resourceMethod : resourceClass.getResourceMethods()) {\n             put(resourceMethod.getMethod(), resourceMethod);\n         }\n"}}, {"oid": "39a298e0f7bf45a094c45072cfb7ce0686e8f99b", "url": "https://github.com/candlepin/candlepin/commit/39a298e0f7bf45a094c45072cfb7ce0686e8f99b", "message": "ENT-2177: Use concrete method to locate ResourceLocator\n  - The problem is current code tries to locate the interface method from ResourceLocatorMap class instead of concrete method and finally return \u2018Method XXX not registered as RESTful\u2019 exception.\n  - Easily fix this issue by using the interface method vs concrete method mapping in the ResourceLocatorMap class.\n  - Added new class MethodLocator to hold interface method and concrete method mapping\n  - Updated ResourceLocatorMap class to use MethodLocator\n  - Update AnnotationLocator class to use MethodLocator instead of internal", "committedDate": "2020-03-27T06:58:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NjE4Mw==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r399356183", "bodyText": "The changes below are good, but mean that these should not be injected (since we create them ourselves during init).", "author": "Ceiu", "createdAt": "2020-03-27T15:40:00Z", "path": "server/src/test/java/org/candlepin/test/DatabaseTestFixture.java", "diffHunk": "@@ -157,6 +158,7 @@\n     @Inject protected PermissionFactory permissionFactory;\n \n     @Inject protected ResourceLocatorMap locatorMap;\n+    @Inject protected MethodLocator methodLocator;", "originalCommit": "39a298e0f7bf45a094c45072cfb7ce0686e8f99b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTUyNzAxMA==", "url": "https://github.com/candlepin/candlepin/pull/2663#discussion_r399527010", "bodyText": "Done.", "author": "abhiskum", "createdAt": "2020-03-27T20:41:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NjE4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5d7b6beb1e88801d320d7088d8e7e380a3958694", "chunk": "diff --git a/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java b/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\nindex f22295ca3..3cabf137f 100755\n--- a/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\n+++ b/server/src/test/java/org/candlepin/test/DatabaseTestFixture.java\n\n@@ -154,14 +154,13 @@ public class DatabaseTestFixture {\n     @Inject protected PoolCurator poolCurator;\n     @Inject protected RoleCurator roleCurator;\n     @Inject protected UserCurator userCurator;\n-\n     @Inject protected PermissionFactory permissionFactory;\n-\n-    @Inject protected ResourceLocatorMap locatorMap;\n-    @Inject protected MethodLocator methodLocator;\n-    @Inject protected AnnotationLocator annotationLocator;\n     @Inject protected ModelTranslator modelTranslator;\n \n+    protected ResourceLocatorMap locatorMap;\n+    protected MethodLocator methodLocator;\n+    protected AnnotationLocator annotationLocator;\n+\n     private static Injector parentInjector;\n     protected Injector injector;\n     private CandlepinRequestScope cpRequestScope;\n"}}, {"oid": "5d7b6beb1e88801d320d7088d8e7e380a3958694", "url": "https://github.com/candlepin/candlepin/commit/5d7b6beb1e88801d320d7088d8e7e380a3958694", "message": "ENT-2177: Use concrete method to locate ResourceLocator\n  - The problem is current code tries to locate the interface method from ResourceLocatorMap class instead of concrete method and finally return \u2018Method XXX not registered as RESTful\u2019 exception.\n  - Easily fix this issue by using the interface method vs concrete method mapping in the ResourceLocatorMap class.\n  - Added new class MethodLocator to hold interface method and concrete method mapping\n  - Updated ResourceLocatorMap class to use MethodLocator\n  - Update AnnotationLocator class to use MethodLocator instead of internal", "committedDate": "2020-03-27T20:40:11Z", "type": "commit"}, {"oid": "5d7b6beb1e88801d320d7088d8e7e380a3958694", "url": "https://github.com/candlepin/candlepin/commit/5d7b6beb1e88801d320d7088d8e7e380a3958694", "message": "ENT-2177: Use concrete method to locate ResourceLocator\n  - The problem is current code tries to locate the interface method from ResourceLocatorMap class instead of concrete method and finally return \u2018Method XXX not registered as RESTful\u2019 exception.\n  - Easily fix this issue by using the interface method vs concrete method mapping in the ResourceLocatorMap class.\n  - Added new class MethodLocator to hold interface method and concrete method mapping\n  - Updated ResourceLocatorMap class to use MethodLocator\n  - Update AnnotationLocator class to use MethodLocator instead of internal", "committedDate": "2020-03-27T20:40:11Z", "type": "forcePushed"}]}