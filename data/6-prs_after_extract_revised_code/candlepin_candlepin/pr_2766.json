{"pr_number": 2766, "pr_title": "[M] 1854221: Graceful shutdown of Artemis job threads; ENT-2586", "pr_createdAt": "2020-07-27T13:20:17Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2766", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTQzMg==", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460909432", "bodyText": "We should do this after the call to jobManager.shutdown", "author": "Ceiu", "createdAt": "2020-07-27T13:58:03Z", "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -259,6 +260,8 @@ public void contextDestroyed(ServletContextEvent event) {\n     }\n \n     private void destroySubsystems() throws Exception {\n+        this.waitForArtemisJobThreadsToFinish();", "originalCommit": "5af4464f01b4398c4dea62a036e9008ec8bd91d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxODY2OA==", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460918668", "bodyText": "It was deliberately added before the JobManager.shutdown, because that method calls into these:\n                this.dispatcher.shutdown();\n                this.receiver.shutdown();\n\nand the receiver.shutdown() is actually closing the sessions that these threads use.\nWe don't want to close sessions of threads that are still running, but first wait for the threads to finish", "author": "nikosmoum", "createdAt": "2020-07-27T14:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTQzMg=="}], "type": "inlineReview", "revised_code": {"commit": "de901c3e447bcb7a7186387334542430cfde0889", "chunk": "diff --git a/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java b/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\nindex a46764687..abb316d95 100644\n--- a/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\n+++ b/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\n\n@@ -260,7 +257,8 @@ public class CandlepinContextListener extends GuiceResteasyBootstrapServletConte\n     }\n \n     private void destroySubsystems() throws Exception {\n-        this.waitForArtemisJobThreadsToFinish();\n+        // Perform graceful shutdown operations before the job system's final destruction\n+        this.cpmContextListener.shutdown();\n \n         // Tear down the job system\n         this.jobManager.shutdown();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMjYyOQ==", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460912629", "bodyText": "If this is specifically for the job system, we should move this to somewhere that makes a bit more sense. Either in jobManager.shutdown or, and probably best in my opinion, ArtemisContextListener.shutdown (which gets hit automatically via cpmContextListener.shutdown above)", "author": "Ceiu", "createdAt": "2020-07-27T14:02:35Z", "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -291,6 +294,35 @@ private void destroySubsystems() throws Exception {\n         this.loggerListener.contextDestroyed();\n     }\n \n+    private void waitForArtemisJobThreadsToFinish() {", "originalCommit": "5af4464f01b4398c4dea62a036e9008ec8bd91d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxOTYxNQ==", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460919615", "bodyText": "Same as above answer, by the time we get to ArtemisContextListener.shutdown, the sessions are already closed. We want the sessions to keep open for the message commits to happen first", "author": "nikosmoum", "createdAt": "2020-07-27T14:12:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMjYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "de901c3e447bcb7a7186387334542430cfde0889", "chunk": "diff --git a/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java b/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\nindex a46764687..abb316d95 100644\n--- a/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\n+++ b/server/src/main/java/org/candlepin/guice/CandlepinContextListener.java\n\n@@ -294,35 +292,6 @@ public class CandlepinContextListener extends GuiceResteasyBootstrapServletConte\n         this.loggerListener.contextDestroyed();\n     }\n \n-    private void waitForArtemisJobThreadsToFinish() {\n-        TimeUnit unit = TimeUnit.SECONDS;\n-        long time = this.config.getInt(ASYNC_JOBS_THREAD_SHUTDOWN_TIMEOUT);\n-\n-        ActiveMQClient.getGlobalThreadPool().shutdown();\n-        try {\n-            if (!ActiveMQClient.getGlobalThreadPool().awaitTermination(time, unit)) {\n-                ActiveMQClient.getGlobalThreadPool().shutdownNow();\n-                log.warn(\"Could not shut down artemis client threads within {} {}. Forcing shutdown now.\",\n-                    time, unit);\n-            }\n-        }\n-        catch (InterruptedException e) {\n-            throw new ActiveMQInterruptedException(e);\n-        }\n-\n-        ActiveMQClient.getGlobalScheduledThreadPool().shutdown();\n-        try {\n-            if (!ActiveMQClient.getGlobalScheduledThreadPool().awaitTermination(time, unit)) {\n-                ActiveMQClient.getGlobalScheduledThreadPool().shutdownNow();\n-                log.warn(\"Could not shut down artemis client threads within {} {}. Forcing shutdown now.\",\n-                    time, unit);\n-            }\n-        }\n-        catch (InterruptedException e) {\n-            throw new ActiveMQInterruptedException(e);\n-        }\n-    }\n-\n     protected void setCapabilities(Configuration config) {\n         CandlepinCapabilities capabilities = new CandlepinCapabilities();\n \n"}}, {"oid": "de901c3e447bcb7a7186387334542430cfde0889", "url": "https://github.com/candlepin/candlepin/commit/de901c3e447bcb7a7186387334542430cfde0889", "message": "1854221: Graceful shutdown of Artemis job threads\n\nNow, when tomcat is shut down gracefully:\n- First wait for Artemis client threads to finish before\n  closing the sessions, to make sure that commits happen\n  instead of potentially finishing a job and the broker\n  not getting a commit back.\n- Don't use ActiveMQClient.clearThreadPools() to quiesce\n  the threads, because it:\n   * Waits only 10 seconds for jobs to finish before force\n   shutting them down.\n   * Uses ExecutorService.shutdownNow() which will interrupt\n   threads, causing an InterruptedException and not wait for\n   the jobs to finish.\n- Use ExecutorService.shutdown() which will gracefully wait\n  for the threads to finish their work.\n- Introduce new config \"candlepin.async.thread.shutdown.timeout\"\n  to specify how long (in seconds) to wait for job threads to\n  finish before forcefully shutting them down.", "committedDate": "2020-07-28T14:47:46Z", "type": "commit"}, {"oid": "de901c3e447bcb7a7186387334542430cfde0889", "url": "https://github.com/candlepin/candlepin/commit/de901c3e447bcb7a7186387334542430cfde0889", "message": "1854221: Graceful shutdown of Artemis job threads\n\nNow, when tomcat is shut down gracefully:\n- First wait for Artemis client threads to finish before\n  closing the sessions, to make sure that commits happen\n  instead of potentially finishing a job and the broker\n  not getting a commit back.\n- Don't use ActiveMQClient.clearThreadPools() to quiesce\n  the threads, because it:\n   * Waits only 10 seconds for jobs to finish before force\n   shutting them down.\n   * Uses ExecutorService.shutdownNow() which will interrupt\n   threads, causing an InterruptedException and not wait for\n   the jobs to finish.\n- Use ExecutorService.shutdown() which will gracefully wait\n  for the threads to finish their work.\n- Introduce new config \"candlepin.async.thread.shutdown.timeout\"\n  to specify how long (in seconds) to wait for job threads to\n  finish before forcefully shutting them down.", "committedDate": "2020-07-28T14:47:46Z", "type": "forcePushed"}]}