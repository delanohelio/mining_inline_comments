{"pr_number": 2707, "pr_title": "1836973 - Listing pools available for an activation_key lists pools", "pr_createdAt": "2020-05-22T05:41:25Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2707", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzQxNA==", "url": "https://github.com/candlepin/candlepin/pull/2707#discussion_r429147414", "bodyText": "The issue here was that a new piece of data (errorKeys) was added to ValidationResult in addition to errors, which is not taken into account by the isSuccessful method. This will work, but I think to future-proof the use of the isSuccessful method (which is used elsewhere, and in the future when we move more code from rules.js to Java, the same bug will appear there too), we should leave this check as it was and simply alter ValidationResult.isSuccessful to more correctly check both errors and errorKeys as such: return !hasErrors() && !hasErrorKeys();", "author": "nikosmoum", "createdAt": "2020-05-22T09:40:20Z", "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -2605,7 +2605,7 @@ public void updatePoolsFromStackWithoutDeletingStack(Consumer consumer, List<Poo\n         List<Pool> filteredPools = new LinkedList<>();\n         for (Pool p : pools) {\n             ValidationResult result = activationKeyRules.runPoolValidationForActivationKey(key, p, null);\n-            if (result.isSuccessful() && (!result.hasWarnings() || includeWarnings)) {\n+            if (!result.hasErrorKeys() && (!result.hasWarnings() || includeWarnings)) {", "originalCommit": "ea08f7c66a5621b8ad28bd2bb898c5855f34d04c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE4NjI5MA==", "url": "https://github.com/candlepin/candlepin/pull/2707#discussion_r429186290", "bodyText": "Done.", "author": "sonalidhome", "createdAt": "2020-05-22T11:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQzMzExNA==", "url": "https://github.com/candlepin/candlepin/pull/2707#discussion_r429433114", "bodyText": "Is there a reason we don't just fix isSuccessful and any places that break as a consequence of that fix? Seems like a trap to leave a method like that around that doesn't check what its name implies.", "author": "Ceiu", "createdAt": "2020-05-22T20:06:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzQxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3NTE5Mg==", "url": "https://github.com/candlepin/candlepin/pull/2707#discussion_r430175192", "bodyText": "The method isSuccessful() is being updated with return !hasErrors() && !hasErrorKeys();. Also the above change in CandlepinPoolManager.java is reverted. Is there anything else that needs to be done?", "author": "sonalidhome", "createdAt": "2020-05-26T06:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0NzQxNA=="}], "type": "inlineReview", "revised_code": {"commit": "f1f8295aaca48890d724b76fb4cd9cb24e5e0d34", "chunk": "diff --git a/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java b/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\nindex 5bea7f762..f4d9d69ef 100644\n--- a/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\n+++ b/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\n\n@@ -2605,7 +2605,7 @@ public class CandlepinPoolManager implements PoolManager {\n         List<Pool> filteredPools = new LinkedList<>();\n         for (Pool p : pools) {\n             ValidationResult result = activationKeyRules.runPoolValidationForActivationKey(key, p, null);\n-            if (!result.hasErrorKeys() && (!result.hasWarnings() || includeWarnings)) {\n+            if (result.isSuccessful() && (!result.hasWarnings() || includeWarnings)) {\n                 filteredPools.add(p);\n             }\n             else if (log.isDebugEnabled()) {\n"}}, {"oid": "f1f8295aaca48890d724b76fb4cd9cb24e5e0d34", "url": "https://github.com/candlepin/candlepin/commit/f1f8295aaca48890d724b76fb4cd9cb24e5e0d34", "message": "1836973 - Listing pools available for an activation_key lists\npools already in the key\n - Fixed the isSuccesful() condition to add pool into filtered pools\n - Added a spec test to validate the activation key filter is working", "committedDate": "2020-05-22T10:24:15Z", "type": "commit"}, {"oid": "f1f8295aaca48890d724b76fb4cd9cb24e5e0d34", "url": "https://github.com/candlepin/candlepin/commit/f1f8295aaca48890d724b76fb4cd9cb24e5e0d34", "message": "1836973 - Listing pools available for an activation_key lists\npools already in the key\n - Fixed the isSuccesful() condition to add pool into filtered pools\n - Added a spec test to validate the activation key filter is working", "committedDate": "2020-05-22T10:24:15Z", "type": "forcePushed"}]}