{"pr_number": 2814, "pr_title": "1841591: Manifest delete takes 24 hours or more in large environment", "pr_createdAt": "2020-09-25T13:09:17Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2814", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzNzY3OA==", "url": "https://github.com/candlepin/candlepin/pull/2814#discussion_r495037678", "bodyText": "As per our conversation, there's more things to discuss here. The ideal solution is to not fetch the entitlement objects into memory at all (they're 60k+ after all), but instead do a batch delete by entitlement IDs like is done elsewhere.\nTo do that though, we first have to make sure we do anything else that needs to be done (revokeEntitlements does a lot of stuff, and we need to find out if we even need to do most of those in this specific use case (UndoImportsJob)).", "author": "nikosmoum", "createdAt": "2020-09-25T14:44:38Z", "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -2114,9 +2114,13 @@ public void deletePool(Pool pool) {\n         Event event = eventFactory.poolDeleted(pool);\n \n         // Must do a full revoke for all entitlements:\n-        for (Entitlement e : poolCurator.entitlementsIn(pool)) {\n+        List<Entitlement> entitlements = poolCurator.entitlementsIn(pool);\n+        for (Entitlement e : entitlements) {\n             e.setDeletedFromPool(true);\n-            revokeEntitlement(e);\n+        }\n+\n+        for (List<Entitlement> partition : Iterables.partition(entitlements, 1000)) {\n+            revokeEntitlements(partition);", "originalCommit": "57dabf3e128f0ccbfe30499428b9b666ba618417", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f39e956aee83669ec3240d7c4defd71f63b4abca", "chunk": "diff --git a/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java b/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\nindex 0deb0e0d6..00a244b2a 100644\n--- a/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\n+++ b/server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java\n\n@@ -2114,13 +2114,9 @@ public class CandlepinPoolManager implements PoolManager {\n         Event event = eventFactory.poolDeleted(pool);\n \n         // Must do a full revoke for all entitlements:\n-        List<Entitlement> entitlements = poolCurator.entitlementsIn(pool);\n-        for (Entitlement e : entitlements) {\n+        for (Entitlement e : poolCurator.entitlementsIn(pool)) {\n             e.setDeletedFromPool(true);\n-        }\n-\n-        for (List<Entitlement> partition : Iterables.partition(entitlements, 1000)) {\n-            revokeEntitlements(partition);\n+            revokeEntitlement(e);\n         }\n \n         poolCurator.delete(pool);\n"}}, {"oid": "f39e956aee83669ec3240d7c4defd71f63b4abca", "url": "https://github.com/candlepin/candlepin/commit/f39e956aee83669ec3240d7c4defd71f63b4abca", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion.", "committedDate": "2020-09-30T13:30:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxOTUxMg==", "url": "https://github.com/candlepin/candlepin/pull/2814#discussion_r497519512", "bodyText": "No need to pass another argument here, the deletePools method has an overloaded version which only accepts a single list of pools. Other than that, this looks good", "author": "nikosmoum", "createdAt": "2020-09-30T13:42:53Z", "path": "server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java", "diffHunk": "@@ -164,11 +167,12 @@ public void execute(JobExecutionContext context) throws JobExecutionException {\n         log.info(\"Deleting all pools originating from manifests for owner/org: {}\", displayName);\n \n         List<Pool> pools = this.poolManager.listPoolsByOwner(owner).list();\n-        for (Pool pool : pools) {\n-            if (this.poolManager.isManaged(pool)) {\n-                this.poolManager.deletePool(pool);\n-            }\n-        }\n+        this.poolManager.deletePools(\n+            pools.stream()\n+                .filter(this.poolManager::isManaged)\n+                .collect(Collectors.toList()),\n+            new ArrayList<>()", "originalCommit": "f39e956aee83669ec3240d7c4defd71f63b4abca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU4MzIyMw==", "url": "https://github.com/candlepin/candlepin/pull/2814#discussion_r497583223", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-09-30T15:03:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxOTUxMg=="}], "type": "inlineReview", "revised_code": {"commit": "e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "chunk": "diff --git a/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java b/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\nindex 35e1f1745..0bd7d05f4 100644\n--- a/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\n+++ b/server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java\n\n@@ -169,9 +168,8 @@ public class UndoImportsJob implements AsyncJob {\n         List<Pool> pools = this.poolManager.listPoolsByOwner(owner).list();\n         this.poolManager.deletePools(\n             pools.stream()\n-                .filter(this.poolManager::isManaged)\n-                .collect(Collectors.toList()),\n-            new ArrayList<>()\n+            .filter(this.poolManager::isManaged)\n+            .collect(Collectors.toList())\n         );\n \n         // Clear out upstream ID so owner can import from other distributors:\n"}}, {"oid": "e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "url": "https://github.com/candlepin/candlepin/commit/e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion.", "committedDate": "2020-09-30T14:30:02Z", "type": "forcePushed"}, {"oid": "ba594a278789591f18621ce54ab31538d51b905a", "url": "https://github.com/candlepin/candlepin/commit/ba594a278789591f18621ce54ab31538d51b905a", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion.", "committedDate": "2020-09-30T15:09:26Z", "type": "commit"}, {"oid": "ba594a278789591f18621ce54ab31538d51b905a", "url": "https://github.com/candlepin/candlepin/commit/ba594a278789591f18621ce54ab31538d51b905a", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion.", "committedDate": "2020-09-30T15:09:26Z", "type": "forcePushed"}]}