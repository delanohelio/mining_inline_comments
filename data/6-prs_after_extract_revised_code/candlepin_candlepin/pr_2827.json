{"pr_number": 2827, "pr_title": "1884761: Candlepin presents a different number of certificates for a consumer based on accept header (ENT-3127)", "pr_createdAt": "2020-10-20T11:53:27Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2827", "timeline": [{"oid": "89b7492c0764996129e26cdda98b84a98ca6a0e9", "url": "https://github.com/candlepin/candlepin/commit/89b7492c0764996129e26cdda98b84a98ca6a0e9", "message": "1884761: Exporting content access certs for a consumer (ENT-3127)", "committedDate": "2020-10-21T08:28:20Z", "type": "forcePushed"}, {"oid": "2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "url": "https://github.com/candlepin/candlepin/commit/2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "message": "1884761: Exporting content access certs for a consumer (ENT-3127)", "committedDate": "2020-10-21T09:57:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExODY3Ng==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510118676", "bodyText": "You can use try-with-resources here to avoid having to close the writer manually.", "author": "Januson", "createdAt": "2020-10-22T12:26:33Z", "path": "server/src/main/java/org/candlepin/sync/Exporter.java", "diffHunk": "@@ -423,6 +433,48 @@ private void exportEntitlementsCerts(File baseDir, Consumer consumer,\n         }\n     }\n \n+    /**\n+     * Exports content access certificates for a consumer.\n+     * Consumer must belong to owner with SCA enabled.\n+     *\n+     * @param consumer\n+     *  Consumer for which content access certificates needs to be exported.\n+     *\n+     * @param baseDir\n+     *  Base directory path.\n+     *\n+     * @throws IOException\n+     *  Throws exception if unable to fetch content access certs for the consumer.\n+     */\n+    private void exportContentAccessCerts(File baseDir, Consumer consumer) throws IOException {\n+        try {\n+            ContentAccessCertificate contentAccessCert = this.contentAccessManager.getCertificate(consumer);\n+\n+            if (contentAccessCert != null) {\n+                File contentAccessCertDir = new File(baseDir.getCanonicalPath(),\n+                    \"content_access_certificates\");\n+                contentAccessCertDir.mkdir();\n+                log.debug(\"Exporting content access certificate: \" + contentAccessCert.getSerial());\n+                File file = new File(contentAccessCertDir.getCanonicalPath(),\n+                    contentAccessCert.getSerial().getId() + \".pem\");\n+                FileWriter writer = null;\n+\n+                try {", "originalCommit": "2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc5NDM1Ng==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510794356", "bodyText": "Changed.", "author": "wolfdale", "createdAt": "2020-10-23T10:38:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExODY3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "f2e9985adf56814f319acc8c2abd6f6417537cd9", "chunk": "diff --git a/server/src/main/java/org/candlepin/sync/Exporter.java b/server/src/main/java/org/candlepin/sync/Exporter.java\nindex 7643370b4..369234e6e 100644\n--- a/server/src/main/java/org/candlepin/sync/Exporter.java\n+++ b/server/src/main/java/org/candlepin/sync/Exporter.java\n\n@@ -419,16 +414,8 @@ public class Exporter {\n                 log.debug(\"Exporting entitlement certificate: \" + cert.getSerial());\n                 File file = new File(entCertDir.getCanonicalPath(),\n                     cert.getSerial().getId() + \".pem\");\n-                FileWriter writer = null;\n-                try {\n-                    writer = new FileWriter(file);\n-                    entCert.export(writer, cert);\n-                }\n-                finally {\n-                    if (writer != null) {\n-                        writer.close();\n-                    }\n-                }\n+                CertificateExporter crt = new CertificateExporter();\n+                crt.exportCertificate(cert, file);\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE4ODYxMQ==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510188611", "bodyText": "No need to create another exporter. Original on can be refactored to accept Certificate which both EntitlementCertificate and ContentAccessCertificate implement.\nOther thing is that it could open its own Writer since both exporters are writing to a file. That way we don't have to wrap it in try-with-resources on every use.", "author": "Januson", "createdAt": "2020-10-22T14:04:03Z", "path": "server/src/main/java/org/candlepin/sync/ContentAccessCertExporter.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.sync;\n+\n+import org.candlepin.model.ContentAccessCertificate;\n+\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+public class ContentAccessCertExporter {", "originalCommit": "2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc5NDMzOA==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510794338", "bodyText": "Sure, moved all the writer logic inside new certificate exporter class.", "author": "wolfdale", "createdAt": "2020-10-23T10:38:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE4ODYxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2e9985adf56814f319acc8c2abd6f6417537cd9", "chunk": "diff --git a/server/src/main/java/org/candlepin/sync/ContentAccessCertExporter.java b/server/src/main/java/org/candlepin/sync/ContentAccessCertExporter.java\ndeleted file mode 100644\nindex a55df38db..000000000\n--- a/server/src/main/java/org/candlepin/sync/ContentAccessCertExporter.java\n+++ /dev/null\n\n@@ -1,28 +0,0 @@\n-/**\n- * Copyright (c) 2009 - 2020 Red Hat, Inc.\n- *\n- * This software is licensed to you under the GNU General Public License,\n- * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n- * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n- * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n- * along with this software; if not, see\n- * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n- *\n- * Red Hat trademarks are not licensed under GPLv2. No permission is\n- * granted to use or replicate Red Hat trademarks that are incorporated\n- * in this software or its documentation.\n- */\n-package org.candlepin.sync;\n-\n-import org.candlepin.model.ContentAccessCertificate;\n-\n-import java.io.IOException;\n-import java.io.Writer;\n-\n-public class ContentAccessCertExporter {\n-    void export(Writer writer, ContentAccessCertificate cert)\n-        throws IOException {\n-        writer.write(cert.getCert());\n-        writer.write(cert.getKey());\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MTY1Mw==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510191653", "bodyText": "We don't have to to inject the exporter. It has no dependencies and arguments for the export are created here so we can just create a new instance when we need it for the export.", "author": "Januson", "createdAt": "2020-10-22T14:08:02Z", "path": "server/src/main/java/org/candlepin/sync/Exporter.java", "diffHunk": "@@ -120,7 +125,9 @@ public Exporter(ConsumerTypeCurator consumerTypeCurator, OwnerCurator ownerCurat\n         CdnExporter cdnExporter,\n         ProductCurator productCurator,\n         SyncUtils syncUtils, ExportExtensionAdapter extensionAdapter,\n-        ModelTranslator translator) {\n+        ModelTranslator translator,\n+        ContentAccessManager contentAccessManager,\n+        ContentAccessCertExporter contentAccessCertExporter) {", "originalCommit": "2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc5NDMyNg==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510794326", "bodyText": "Yes agreed.", "author": "wolfdale", "createdAt": "2020-10-23T10:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE5MTY1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "f2e9985adf56814f319acc8c2abd6f6417537cd9", "chunk": "diff --git a/server/src/main/java/org/candlepin/sync/Exporter.java b/server/src/main/java/org/candlepin/sync/Exporter.java\nindex 7643370b4..369234e6e 100644\n--- a/server/src/main/java/org/candlepin/sync/Exporter.java\n+++ b/server/src/main/java/org/candlepin/sync/Exporter.java\n\n@@ -126,8 +124,7 @@ public class Exporter {\n         ProductCurator productCurator,\n         SyncUtils syncUtils, ExportExtensionAdapter extensionAdapter,\n         ModelTranslator translator,\n-        ContentAccessManager contentAccessManager,\n-        ContentAccessCertExporter contentAccessCertExporter) {\n+        ContentAccessManager contentAccessManager) {\n \n         this.consumerTypeCurator = consumerTypeCurator;\n         this.ownerCurator = ownerCurator;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MzYwMg==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510663602", "bodyText": "It would be great to add some tests for the getEntitlementExport. All of the current tests are testing the getFullExport.", "author": "Januson", "createdAt": "2020-10-23T06:33:21Z", "path": "server/src/main/java/org/candlepin/sync/Exporter.java", "diffHunk": "@@ -197,6 +206,7 @@ public File getEntitlementExport(Consumer consumer, Set<Long> serials) throws Ex\n \n             exportMeta(baseDir, null);\n             exportEntitlementsCerts(baseDir, consumer, serials, false);\n+            exportContentAccessCerts(baseDir, consumer);", "originalCommit": "2cdd7ae1d943d9d855f3aeb8affc331744707a4a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc5NDMwNw==", "url": "https://github.com/candlepin/candlepin/pull/2827#discussion_r510794307", "bodyText": "Added a unit test for it.", "author": "wolfdale", "createdAt": "2020-10-23T10:38:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY2MzYwMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f2e9985adf56814f319acc8c2abd6f6417537cd9", "url": "https://github.com/candlepin/candlepin/commit/f2e9985adf56814f319acc8c2abd6f6417537cd9", "message": "1884761: Exporting content access certs for a consumer (ENT-3127)", "committedDate": "2020-10-23T10:34:57Z", "type": "commit"}, {"oid": "f2e9985adf56814f319acc8c2abd6f6417537cd9", "url": "https://github.com/candlepin/candlepin/commit/f2e9985adf56814f319acc8c2abd6f6417537cd9", "message": "1884761: Exporting content access certs for a consumer (ENT-3127)", "committedDate": "2020-10-23T10:34:57Z", "type": "forcePushed"}]}