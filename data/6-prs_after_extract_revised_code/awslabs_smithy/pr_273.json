{"pr_number": 273, "pr_title": "Make protocol and auth traits", "pr_createdAt": "2020-02-05T05:14:19Z", "pr_url": "https://github.com/awslabs/smithy/pull/273", "timeline": [{"oid": "a5e7f526f87e94fadc8366f681a689da5dd2abc9", "url": "https://github.com/awslabs/smithy/commit/a5e7f526f87e94fadc8366f681a689da5dd2abc9", "message": "Make protocol and auth into meta traits\n\nThis commit starts the process of converting protocol and auth\ndefinitinions into meta-traits that are attached to other traits. This\nchange leans into the idea of \"traits are just shapes\" and takes that a\nstep further by making auth and protocol applications into normal\ntraits. This removes the need for a custom model layer that we had\npreviously which required things like custom Smithy build transforms and\nlinters.", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "ed94e5d9b0ec3c0ed9f82ac2c501646b982298c9", "url": "https://github.com/awslabs/smithy/commit/ed94e5d9b0ec3c0ed9f82ac2c501646b982298c9", "message": "Remove no longer needed protocol linters", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "502454d4cf0257860d77eb1851a6e2cc1f840157", "url": "https://github.com/awslabs/smithy/commit/502454d4cf0257860d77eb1851a6e2cc1f840157", "message": "Remove no longer needed auth/protocol transforms\n\nThese were needed when protocol and auth applications weren't real\ntraits. Now that they're traits, they can be added and removed just like\nany other trait.", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "c7f3a3237270c15d4025d8580da53fa0f16dafba", "url": "https://github.com/awslabs/smithy/commit/c7f3a3237270c15d4025d8580da53fa0f16dafba", "message": "Remove no longer needed protocol/auth diff rule", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "b95b9666961c3a39d35f3635c122f4e277eb1783", "url": "https://github.com/awslabs/smithy/commit/b95b9666961c3a39d35f3635c122f4e277eb1783", "message": "Update docs to use more shape IDs", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "9f50617336a0a378e54c174835dc64bea9df96bb", "url": "https://github.com/awslabs/smithy/commit/9f50617336a0a378e54c174835dc64bea9df96bb", "message": "Fix spotbugs false positive", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "a7d61657706f2712228b9444429048b2539dae51", "url": "https://github.com/awslabs/smithy/commit/a7d61657706f2712228b9444429048b2539dae51", "message": "Migrate MQTT protocol to a trait", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "f33ce9d0285e23ff52e2d122959658d59e875ce2", "url": "https://github.com/awslabs/smithy/commit/f33ce9d0285e23ff52e2d122959658d59e875ce2", "message": "Add AWS auth and protocol traits", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "7318439f2c43ee3a4ae8275cbb6368ad7f9a3233", "url": "https://github.com/awslabs/smithy/commit/7318439f2c43ee3a4ae8275cbb6368ad7f9a3233", "message": "Update protocol test traits to use shape IDs\n\nThe auth and protocol settings for protocol tests now use shape IDs with\nidRef traits rather than raw strings. This provides more validation of\nprotocol test trait definitions.", "committedDate": "2020-02-05T05:06:32Z", "type": "commit"}, {"oid": "92b470c2bc0fbc2774e07467e178bbc623a3b527", "url": "https://github.com/awslabs/smithy/commit/92b470c2bc0fbc2774e07467e178bbc623a3b527", "message": "Update aws protocol tests", "committedDate": "2020-02-05T05:06:33Z", "type": "commit"}, {"oid": "b8290c4d58412ee8fe640266c66fe529357e9229", "url": "https://github.com/awslabs/smithy/commit/b8290c4d58412ee8fe640266c66fe529357e9229", "message": "Fix JSON schema protocol test", "committedDate": "2020-02-05T05:06:33Z", "type": "commit"}, {"oid": "175ef6dba6993bed0a25f2b1ea5bbdb4f8d1d639", "url": "https://github.com/awslabs/smithy/commit/175ef6dba6993bed0a25f2b1ea5bbdb4f8d1d639", "message": "Update openapi converters to use typed traits\n\nOpenAPI conversion now uses the protocol auth traits. Further, Context\nand security scheme converters are now generic over the protocol/auth\ntrait they convert, making them easier to implement.", "committedDate": "2020-02-05T05:06:33Z", "type": "commit"}, {"oid": "06138f6421c55652193a1e90fee3ec3c28891ca0", "url": "https://github.com/awslabs/smithy/commit/06138f6421c55652193a1e90fee3ec3c28891ca0", "message": "Update apigateway int. to protocol/auth traits", "committedDate": "2020-02-05T05:06:33Z", "type": "commit"}, {"oid": "943ed0989c8ba8f131453aeea2e7f89485742be8", "url": "https://github.com/awslabs/smithy/commit/943ed0989c8ba8f131453aeea2e7f89485742be8", "message": "Remove singleEncodeCanonicalPath from S3\n\nThis should really just be a known customization to implement when\nwriting an S3 client. It isn't really something I think any other team\nwould ever repeat.", "committedDate": "2020-02-06T00:18:12Z", "type": "commit"}, {"oid": "248a9a430ab78a30dc0bf7b5b3cce285c1e65ea2", "url": "https://github.com/awslabs/smithy/commit/248a9a430ab78a30dc0bf7b5b3cce285c1e65ea2", "message": "Remove cookie support (at least for now)", "committedDate": "2020-02-06T00:51:22Z", "type": "commit"}, {"oid": "2afe42ac8a7c70b7b6a87a0f0c744f0f760ec725", "url": "https://github.com/awslabs/smithy/commit/2afe42ac8a7c70b7b6a87a0f0c744f0f760ec725", "message": "Update auth traits so they can only apply to services", "committedDate": "2020-02-06T00:51:47Z", "type": "commit"}, {"oid": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "url": "https://github.com/awslabs/smithy/commit/cfcbdf41e1824ef317b7e93535257cd99f910ac0", "message": "Update documentation for auth and protocol traits", "committedDate": "2020-02-06T01:09:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4Mzg1OQ==", "url": "https://github.com/awslabs/smithy/pull/273#discussion_r375983859", "bodyText": "Note: the Context that's passed around is now generic over the protocol trait being converted. For things where this doesn't matter, we use <? extends Trait>.\nThe other thing to keep in mind: the changes to the OpenAPI converters and API Gateway converters should result in almost identical OpenAPI schemas (the only thing that changes is the arbitrary names given to auth schemes)", "author": "mtdowling", "createdAt": "2020-02-06T17:42:39Z", "path": "smithy-aws-apigateway-openapi/src/main/java/software/amazon/smithy/aws/apigateway/openapi/AddApiKeySource.java", "diffHunk": "@@ -26,7 +27,7 @@\n     private static final Logger LOGGER = Logger.getLogger(AddApiKeySource.class.getName());\n \n     @Override\n-    public OpenApi after(Context context, OpenApi openApi) {\n+    public OpenApi after(Context<? extends Trait> context, OpenApi openApi) {", "originalCommit": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NTA1Mg==", "url": "https://github.com/awslabs/smithy/pull/273#discussion_r375985052", "bodyText": "Note: this became an auth trait, cognitoUserPools, and removes the need for a separate configuration trait.", "author": "mtdowling", "createdAt": "2020-02-06T17:44:59Z", "path": "smithy-aws-apigateway-openapi/src/main/java/software/amazon/smithy/aws/apigateway/openapi/CognitoUserPoolsConverter.java", "diffHunk": "@@ -28,32 +28,24 @@\n /**\n  * An authentication scheme converter that adds Cognito User Pool based\n  * authentication ({@code cognito_user_pools} to an OpenAPI model when the\n- * {@code aws.cognito-user-pools} authentication scheme is found on", "originalCommit": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NTQzOQ==", "url": "https://github.com/awslabs/smithy/pull/273#discussion_r375985439", "bodyText": "This is handled by normal trait validation now", "author": "mtdowling", "createdAt": "2020-02-06T17:45:47Z", "path": "smithy-aws-apigateway-openapi/src/test/java/software/amazon/smithy/aws/apigateway/openapi/CognitoUserPoolsConverterTest.java", "diffHunk": "@@ -27,15 +27,13 @@ public void addsAwsV4() {\n \n     @Test\n     public void requiresProviderArns() {\n-        Exception thrown = Assertions.assertThrows(OpenApiException.class, () -> {\n+        Assertions.assertThrows(ValidatedResultException.class, () -> {\n             Model model = Model.assembler(getClass().getClassLoader())\n                     .discoverModels(getClass().getClassLoader())\n                     .addImport(getClass().getResource(\"invalid-cognito-user-pools-security.json\"))\n                     .assemble()\n                     .unwrap();\n             OpenApiConverter.create().convert(model, ShapeId.from(\"smithy.example#Service\"));\n         });\n-\n-        Assertions.assertTrue(thrown.getMessage().contains(\"Missing required\"));", "originalCommit": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4NzQ3Nw==", "url": "https://github.com/awslabs/smithy/pull/273#discussion_r375987477", "bodyText": "Authorizers now reference auth scheme shape IDs rather than arbitrary names", "author": "mtdowling", "createdAt": "2020-02-06T17:49:46Z", "path": "smithy-aws-traits/src/main/java/software/amazon/smithy/aws/traits/apigateway/AuthorizerDefinition.java", "diffHunk": "@@ -47,7 +49,7 @@\n             SCHEME_KEY, TYPE_KEY, AUTH_TYPE_KEY, URI_KEY, CREDENTIALS_KEY, IDENTITY_SOURCE_KEY,\n             IDENTITY_VALIDATION_EXPRESSION_KEY, RESULT_TTL_IN_SECONDS);\n \n-    private final String scheme;\n+    private final ShapeId scheme;", "originalCommit": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4ODk0Ng==", "url": "https://github.com/awslabs/smithy/pull/273#discussion_r375988946", "bodyText": "Since we're using dependencies now in tests, we need to use model discovery.", "author": "mtdowling", "createdAt": "2020-02-06T17:52:30Z", "path": "smithy-openapi/src/test/java/software/amazon/smithy/openapi/fromsmithy/security/HttpDigestTest.java", "diffHunk": "@@ -13,6 +13,7 @@\n     public void addsHttpDigestAuth() {\n         Model model = Model.assembler()\n                 .addImport(getClass().getResource(\"http-digest-security.json\"))\n+                .discoverModels()", "originalCommit": "cfcbdf41e1824ef317b7e93535257cd99f910ac0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "0cdc69a8f7e4e0bded958375913d7f3e3a80c283", "url": "https://github.com/awslabs/smithy/commit/0cdc69a8f7e4e0bded958375913d7f3e3a80c283", "message": "Address minor PR issues", "committedDate": "2020-02-06T18:06:02Z", "type": "commit"}, {"oid": "4410be0d1f54b8aaa436d61ad347795f818359ab", "url": "https://github.com/awslabs/smithy/commit/4410be0d1f54b8aaa436d61ad347795f818359ab", "message": "Rename protocol tests to match new names", "committedDate": "2020-02-07T21:53:11Z", "type": "commit"}, {"oid": "2bcad8b2f463dd095402061773f1e7f736930b7c", "url": "https://github.com/awslabs/smithy/commit/2bcad8b2f463dd095402061773f1e7f736930b7c", "message": "Update docs to address feedback", "committedDate": "2020-02-07T22:06:11Z", "type": "commit"}]}