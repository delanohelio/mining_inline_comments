{"pr_number": 561, "pr_title": "Emit events when traits are changed", "pr_createdAt": "2020-09-11T00:31:52Z", "pr_url": "https://github.com/awslabs/smithy/pull/561", "timeline": [{"oid": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "url": "https://github.com/awslabs/smithy/commit/19bb6d91da4d6b9cb3360388ae15b25ef851978c", "message": "Emit events when traits are changed\n\nSmithy-diff previously did not emit validation events when a trait was\nadded, removed, or changed unless the trait was marked with one of a few\nspecial tags. This commit updates smithy-diff to emit a NOTE when a\ntrait is added or changed and a WARNING when a trait is removed. This\nhelps ensure that all trait changes are caught by smithy-diff, while\nstill allowing more granular control through the tags.", "committedDate": "2020-09-11T00:29:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMDY5Nw==", "url": "https://github.com/awslabs/smithy/pull/561#discussion_r487120697", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"The `%s` trait was added to the `%s` %s shape: %s\",\n          \n          \n            \n                                        \"The `%s` trait was added to the `%s` %s shape with the value: %s\",", "author": "kstich", "createdAt": "2020-09-11T15:26:36Z", "path": "smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java", "diffHunk": "@@ -101,6 +101,29 @@\n                             changedShape.getNewShape().getType(),\n                             Node.prettyPrintJson(oldTrait.toNode()),\n                             Node.prettyPrintJson(newTrait.toNode()))));\n+                } else if (oldTrait == null) {\n+                    events.add(note(changedShape.getNewShape(), newTrait, String.format(\n+                            \"The `%s` trait was added to the `%s` %s shape: %s\",", "originalCommit": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5e82477ebcbca25140687d8a2ff82b932443776c", "chunk": "diff --git a/smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java b/smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java\nindex dc9896021..33455e40c 100644\n--- a/smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java\n+++ b/smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java\n\n@@ -103,7 +103,7 @@ public final class ModifiedTrait extends AbstractDiffEvaluator {\n                             Node.prettyPrintJson(newTrait.toNode()))));\n                 } else if (oldTrait == null) {\n                     events.add(note(changedShape.getNewShape(), newTrait, String.format(\n-                            \"The `%s` trait was added to the `%s` %s shape: %s\",\n+                            \"The `%s` trait was added to the `%s` %s shape with the value: %s\",\n                             traitName,\n                             changedShape.getNewShape().getId(),\n                             changedShape.getNewShape().getType(),\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMDkyMQ==", "url": "https://github.com/awslabs/smithy/pull/561#discussion_r487120921", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: \\\"foo\\\"\"));\n          \n          \n            \n                    assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape with the value: \\\"foo\\\"\"));", "author": "kstich", "createdAt": "2020-09-11T15:26:54Z", "path": "smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java", "diffHunk": "@@ -98,4 +103,28 @@ private static Shape createDefinition(String tag) {\n                 .addTrait(TraitDefinition.builder().build())\n                 .build();\n     }\n+\n+    @Test\n+    public void modifiedShapeNoTag() {\n+        Model modelA = Model.assembler()\n+                .addImport(getClass().getResource(\"trait-test-a.smithy\"))\n+                .assemble()\n+                .unwrap();\n+        Model modelB = Model.assembler()\n+                .addImport(getClass().getResource(\"trait-test-b.smithy\"))\n+                .assemble()\n+                .unwrap();\n+        List<ValidationEvent> events = TestHelper.findEvents(ModelDiff.compare(modelA, modelB), \"ModifiedTrait\");\n+        List<String> messages = events.stream()\n+                .map(ValidationEvent::getMessage)\n+                .collect(Collectors.toList());\n+\n+        assertThat(events, hasSize(3));\n+        assertThat(events.stream().filter(e -> e.getSeverity() == Severity.WARNING).count(), equalTo(1L));\n+        assertThat(events.stream().filter(e -> e.getSeverity() == Severity.NOTE).count(), equalTo(2L));\n+\n+        assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: \\\"foo\\\"\"));", "originalCommit": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "facd957842ffbf96efb4d3e68eb4bd4a7af85a5b", "chunk": "diff --git a/smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java b/smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java\nindex c02b5bbb7..9d8111608 100644\n--- a/smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java\n+++ b/smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java\n\n@@ -123,7 +123,7 @@ public class ModifiedTraitTest {\n         assertThat(events.stream().filter(e -> e.getSeverity() == Severity.WARNING).count(), equalTo(1L));\n         assertThat(events.stream().filter(e -> e.getSeverity() == Severity.NOTE).count(), equalTo(2L));\n \n-        assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: \\\"foo\\\"\"));\n+        assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape with the value: \\\"foo\\\"\"));\n         assertThat(messages, hasItem(\"The `smithy.example#a` trait was removed from the `smithy.example#Foo` string shape. The removed trait value was: {}\"));\n         assertThat(messages, hasItem(\"The `smithy.example#b` trait was changed on the `smithy.example#Foo` string shape. The old trait value was: \\\"hello\\\". The new trait value is: \\\"hello!\\\"\"));\n     }\n"}}, {"oid": "5e82477ebcbca25140687d8a2ff82b932443776c", "url": "https://github.com/awslabs/smithy/commit/5e82477ebcbca25140687d8a2ff82b932443776c", "message": "Update smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java\n\nCo-authored-by: Kevin Stich <stickevi@amazon.com>", "committedDate": "2020-09-11T19:32:50Z", "type": "commit"}, {"oid": "facd957842ffbf96efb4d3e68eb4bd4a7af85a5b", "url": "https://github.com/awslabs/smithy/commit/facd957842ffbf96efb4d3e68eb4bd4a7af85a5b", "message": "Update smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java\n\nCo-authored-by: Kevin Stich <stickevi@amazon.com>", "committedDate": "2020-09-11T19:32:55Z", "type": "commit"}]}