{"pr_number": 2399, "pr_title": "s3 select improvements", "pr_createdAt": "2020-01-03T11:28:07Z", "pr_url": "https://github.com/trinodb/trino/pull/2399", "timeline": [{"oid": "d9a444f65315fa3f7c1c08253a73e33200b35d06", "url": "https://github.com/trinodb/trino/commit/d9a444f65315fa3f7c1c08253a73e33200b35d06", "message": "Refactor choosing compression type", "committedDate": "2020-01-04T23:07:51Z", "type": "forcePushed"}, {"oid": "34485dce1fa8f89fb4aae32ba5a4cebcdc8f3df3", "url": "https://github.com/trinodb/trino/commit/34485dce1fa8f89fb4aae32ba5a4cebcdc8f3df3", "message": "Refactor choosing compression type", "committedDate": "2020-01-08T16:15:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwODM3NQ==", "url": "https://github.com/trinodb/trino/pull/2399#discussion_r364508375", "bodyText": "Maybe shorten to \"for gzip files\"\n// S3 Select supports skipping one line of headers, but it was returning incorrect results for gzip files\nOr just the file name test_table_with_header.csv.gz", "author": "electrum", "createdAt": "2020-01-09T00:22:13Z", "path": "presto-hive/src/main/java/io/prestosql/plugin/hive/s3select/S3SelectPushdown.java", "diffHunk": "@@ -85,7 +87,20 @@ private static boolean isSerdeSupported(Properties schema)\n     private static boolean isInputFormatSupported(Properties schema)\n     {\n         String inputFormat = getInputFormatName(schema);\n-        return SUPPORTED_INPUT_FORMATS.contains(inputFormat);\n+\n+        if (TextInputFormat.class.getName().equals(inputFormat)) {\n+            if (!Objects.equals(schema.getProperty(SKIP_HEADER_COUNT_KEY, \"0\"), \"0\")) {\n+                // S3 Select supports skipping one line of headers, but it was returning incorrect results for presto-hive-hadoop2/conf/files/test_table_with_header.csv.gz", "originalCommit": "875ea00766535855f18b461182d52fc664eeb914", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMDc5Mg==", "url": "https://github.com/trinodb/trino/pull/2399#discussion_r365530792", "bodyText": "I want to refer to an exact file. I checked that it works correctly some some .gz files, so it looks data-dependent.\nI will leave this as-is, and will add a TODO + link to the issue.", "author": "findepi", "createdAt": "2020-01-11T16:47:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwODM3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMDgxNg==", "url": "https://github.com/trinodb/trino/pull/2399#discussion_r365530816", "bodyText": "I will leave this as-is,\n\n(primarily because i missed this comment earlier)", "author": "findepi", "createdAt": "2020-01-11T16:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwODM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b748d44d3e72839e9b65132e92e21f53d13f6abb", "chunk": "diff --git a/presto-hive/src/main/java/io/prestosql/plugin/hive/s3select/S3SelectPushdown.java b/presto-hive/src/main/java/io/prestosql/plugin/hive/s3select/S3SelectPushdown.java\nindex 61d6bfec7e..5200edc630 100644\n--- a/presto-hive/src/main/java/io/prestosql/plugin/hive/s3select/S3SelectPushdown.java\n+++ b/presto-hive/src/main/java/io/prestosql/plugin/hive/s3select/S3SelectPushdown.java\n\n@@ -87,20 +85,7 @@ public final class S3SelectPushdown\n     private static boolean isInputFormatSupported(Properties schema)\n     {\n         String inputFormat = getInputFormatName(schema);\n-\n-        if (TextInputFormat.class.getName().equals(inputFormat)) {\n-            if (!Objects.equals(schema.getProperty(SKIP_HEADER_COUNT_KEY, \"0\"), \"0\")) {\n-                // S3 Select supports skipping one line of headers, but it was returning incorrect results for presto-hive-hadoop2/conf/files/test_table_with_header.csv.gz\n-                return false;\n-            }\n-            if (!Objects.equals(schema.getProperty(SKIP_FOOTER_COUNT_KEY, \"0\"), \"0\")) {\n-                // S3 Select does not support skipping footers\n-                return false;\n-            }\n-            return true;\n-        }\n-\n-        return false;\n+        return SUPPORTED_INPUT_FORMATS.contains(inputFormat);\n     }\n \n     public static boolean isCompressionCodecSupported(InputFormat<?, ?> inputFormat, Path path)\n"}}, {"oid": "812a87a55c17aea39651c3493b52195e807fd439", "url": "https://github.com/trinodb/trino/commit/812a87a55c17aea39651c3493b52195e807fd439", "message": "Refactor choosing compression type", "committedDate": "2020-01-10T17:58:46Z", "type": "forcePushed"}, {"oid": "b748d44d3e72839e9b65132e92e21f53d13f6abb", "url": "https://github.com/trinodb/trino/commit/b748d44d3e72839e9b65132e92e21f53d13f6abb", "message": "Assert expected data exactly", "committedDate": "2020-01-11T16:38:53Z", "type": "commit"}, {"oid": "90e3b4e47e61df1bde0728e89039ca1a83f4a392", "url": "https://github.com/trinodb/trino/commit/90e3b4e47e61df1bde0728e89039ca1a83f4a392", "message": "Disable S3 Select when skip header/footer is set\n\nS3 Select does not support skipping footer\n\nS3 Select supports skipping one line of header, but it not always was\nreturning correct results.", "committedDate": "2020-01-11T16:38:53Z", "type": "commit"}, {"oid": "9ca471404ca4df0f57f2a414351dcb64c75c63da", "url": "https://github.com/trinodb/trino/commit/9ca471404ca4df0f57f2a414351dcb64c75c63da", "message": "Refactor choosing compression type", "committedDate": "2020-01-11T16:38:53Z", "type": "commit"}, {"oid": "9ca471404ca4df0f57f2a414351dcb64c75c63da", "url": "https://github.com/trinodb/trino/commit/9ca471404ca4df0f57f2a414351dcb64c75c63da", "message": "Refactor choosing compression type", "committedDate": "2020-01-11T16:38:53Z", "type": "forcePushed"}, {"oid": "9ca471404ca4df0f57f2a414351dcb64c75c63da", "url": "https://github.com/trinodb/trino/commit/9ca471404ca4df0f57f2a414351dcb64c75c63da", "message": "Refactor choosing compression type", "committedDate": "2020-01-11T16:38:53Z", "type": "forcePushed"}]}