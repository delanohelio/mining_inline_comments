{"pr_number": 4873, "pr_title": "Override getCompletedBytes method in KafkaPageSink", "pr_createdAt": "2020-08-18T15:13:08Z", "pr_url": "https://github.com/trinodb/trino/pull/4873", "timeline": [{"oid": "a3370a519dae0cc8ef2dc7102644c1985bf5e071", "url": "https://github.com/trinodb/trino/commit/a3370a519dae0cc8ef2dc7102644c1985bf5e071", "message": "Override getCompletedBytes method in KafkaPageSink", "committedDate": "2020-08-18T15:11:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMxNzU4MA==", "url": "https://github.com/trinodb/trino/pull/4873#discussion_r472317580", "bodyText": "We originally used AtomicLong for errorCounter but it looks like the callback is not called concurrently from multiple threads.\nPlease add a commit which changes errorCounter to just long, like you did with writtenBytes.", "author": "losipiuk", "createdAt": "2020-08-18T16:16:27Z", "path": "presto-kafka/src/main/java/io/prestosql/plugin/kafka/KafkaPageSink.java", "diffHunk": "@@ -59,17 +61,20 @@ public KafkaPageSink(\n         this.messageEncoder = requireNonNull(messageEncoder, \"messageEncoder is null\");\n         requireNonNull(producerFactory, \"producerFactory is null\");\n         this.producer = producerFactory.create();\n-        this.errorCounter = new ErrorCountingCallback();\n+        this.producerCallback = new ProducerCallback();\n+        this.expectedWrittenBytes = 0;\n     }\n \n-    private static class ErrorCountingCallback\n+    private static class ProducerCallback\n             implements Callback\n     {\n         private final AtomicLong errorCounter;", "originalCommit": "a3370a519dae0cc8ef2dc7102644c1985bf5e071", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "564e43191d3a3ed66a2af0dc28fe8975c6f895d0", "chunk": "diff --git a/presto-kafka/src/main/java/io/prestosql/plugin/kafka/KafkaPageSink.java b/presto-kafka/src/main/java/io/prestosql/plugin/kafka/KafkaPageSink.java\nindex 023261eeed..38c351348a 100644\n--- a/presto-kafka/src/main/java/io/prestosql/plugin/kafka/KafkaPageSink.java\n+++ b/presto-kafka/src/main/java/io/prestosql/plugin/kafka/KafkaPageSink.java\n\n@@ -68,12 +67,12 @@ public class KafkaPageSink\n     private static class ProducerCallback\n             implements Callback\n     {\n-        private final AtomicLong errorCounter;\n+        private long errorCount;\n         private long writtenBytes;\n \n         public ProducerCallback()\n         {\n-            this.errorCounter = new AtomicLong(0);\n+            this.errorCount = 0;\n             this.writtenBytes = 0;\n         }\n \n"}}, {"oid": "564e43191d3a3ed66a2af0dc28fe8975c6f895d0", "url": "https://github.com/trinodb/trino/commit/564e43191d3a3ed66a2af0dc28fe8975c6f895d0", "message": "Change type of errorCount in Kafka Callback", "committedDate": "2020-08-18T16:36:37Z", "type": "commit"}]}