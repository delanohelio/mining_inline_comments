{"pr_number": 5186, "pr_title": "Fix flaky TestSqlTask tests", "pr_createdAt": "2020-09-16T10:35:32Z", "pr_url": "https://github.com/trinodb/trino/pull/5186", "timeline": [{"oid": "8a29aa496a2103add830768d8dea6373418b21e8", "url": "https://github.com/trinodb/trino/commit/8a29aa496a2103add830768d8dea6373418b21e8", "message": "Fix flaky TestSqlTask#testDynamicFilters\n\nPrevent race condition between dynamic filter\nupdate and task entering FLUSHING state (due to\nnoMoreSplits set to true)", "committedDate": "2020-09-16T10:21:20Z", "type": "commit"}, {"oid": "ff814df88f08c7f47dc83c21762fb3e41498fede", "url": "https://github.com/trinodb/trino/commit/ff814df88f08c7f47dc83c21762fb3e41498fede", "message": "Remove flaky assertion\n\nTask status future will be immediately\ndone when final task status is set. Therefore\nassertion that status version has changed is\nflaky (status version increment is executed\nin different thread).", "committedDate": "2020-09-16T10:30:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489345281", "bodyText": "This was failing with\nAssertionError: expected [1] but found [0]\n\nhow possible is that we could transition to FINISHED without changing the version field?\nwhat's the mechanics here?", "author": "findepi", "createdAt": "2020-09-16T10:51:11Z", "path": "presto-main/src/test/java/io/prestosql/execution/TestSqlTask.java", "diffHunk": "@@ -139,7 +139,6 @@ public void testEmptyQuery()\n \n         taskInfo = sqlTask.getTaskInfo(STARTING_VERSION).get();\n         assertEquals(taskInfo.getTaskStatus().getState(), TaskState.FINISHED);\n-        assertEquals(taskInfo.getTaskStatus().getVersion(), STARTING_VERSION + 1);", "originalCommit": "ff814df88f08c7f47dc83c21762fb3e41498fede", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0ODk3OA==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489348978", "bodyText": "how possible is that we could transition to FINISHED without changing the version field?\nwhat's the mechanics here?\n\n\nfinal task status was set (thread 1)\ngetTaskInfo returned immediately, which is expected (test thread 2)\nassertion fails (test thread 2)\nversion was bumped (after final task status was set) and notification was sent (thread 1)\n\nDepending when getTaskInfo is called, version might be incremented or not. In both cases future completes, which is correct behavior.", "author": "sopel39", "createdAt": "2020-09-16T10:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MTA3Ng==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489351076", "bodyText": "Should \"final task status was set\" and \"version was bumped\" be synchronized?", "author": "findepi", "createdAt": "2020-09-16T11:02:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1Mjg3Mg==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489352872", "bodyText": "Should \"final task status was set\" and \"version was bumped\" be synchronized?\n\nThey don't need to be (and they shouldn't as action like \"getting final task status\" might be long). The only invariant is that status version is incremented eventually after action.", "author": "sopel39", "createdAt": "2020-09-16T11:05:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1ODgxOA==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489358818", "bodyText": "does bumping version involve more than incrementing a number?", "author": "findepi", "createdAt": "2020-09-16T11:18:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxMzUzMg==", "url": "https://github.com/trinodb/trino/pull/5186#discussion_r489413532", "bodyText": "There is io.prestosql.execution.SqlTask#notifyStatusChanged, which increments version and triggers current listeners.\nIt's synchronized so that current listeners list is obtained atomically with version increment.", "author": "sopel39", "createdAt": "2020-09-16T12:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM0NTI4MQ=="}], "type": "inlineReview", "revised_code": null}]}