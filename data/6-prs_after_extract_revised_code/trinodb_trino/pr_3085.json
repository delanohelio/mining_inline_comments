{"pr_number": 3085, "pr_title": "Use compute() to merge the operator stats into the operator summary", "pr_createdAt": "2020-03-12T15:25:35Z", "pr_url": "https://github.com/trinodb/trino/pull/3085", "timeline": [{"oid": "217ddbdcb8355bddd08fbdcc1327df3d87047bb4", "url": "https://github.com/trinodb/trino/commit/217ddbdcb8355bddd08fbdcc1327df3d87047bb4", "message": "Use compute() to merge the operator stats into the operator summary", "committedDate": "2020-03-12T15:20:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxMDgwNg==", "url": "https://github.com/trinodb/trino/pull/3085#discussion_r391910806", "bodyText": "You should use https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#merge-K-V-java.util.function.BiFunction- instead", "author": "sopel39", "createdAt": "2020-03-12T21:35:19Z", "path": "presto-main/src/main/java/io/prestosql/operator/PipelineContext.java", "diffHunk": "@@ -197,19 +197,7 @@ public void driverFinished(DriverContext driverContext)\n         // merge the operator stats into the operator summary\n         List<OperatorStats> operators = driverStats.getOperatorStats();\n         for (OperatorStats operator : operators) {\n-            // TODO: replace with ConcurrentMap.compute() when we migrate to java 8\n-            OperatorStats updated;\n-            OperatorStats current;\n-            do {\n-                current = operatorSummaries.get(operator.getOperatorId());\n-                if (current != null) {\n-                    updated = current.add(operator);\n-                }\n-                else {\n-                    updated = operator;\n-                }\n-            }\n-            while (!compareAndSet(operatorSummaries, operator.getOperatorId(), current, updated));\n+            operatorSummaries.compute(operator.getOperatorId(), (k, v) -> v == null ? operator : v.add(operator));", "originalCommit": "217ddbdcb8355bddd08fbdcc1327df3d87047bb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5NDgxNw==", "url": "https://github.com/trinodb/trino/pull/3085#discussion_r392094817", "bodyText": "Done", "author": "sanchitkashyap", "createdAt": "2020-03-13T08:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTkxMDgwNg=="}], "type": "inlineReview", "revised_code": {"commit": "895eff5bcc1343a2ce8408843a3bb4b5f3644a6d", "chunk": "diff --git a/presto-main/src/main/java/io/prestosql/operator/PipelineContext.java b/presto-main/src/main/java/io/prestosql/operator/PipelineContext.java\nindex 5bd61c3124..d0fd0c5a7b 100644\n--- a/presto-main/src/main/java/io/prestosql/operator/PipelineContext.java\n+++ b/presto-main/src/main/java/io/prestosql/operator/PipelineContext.java\n\n@@ -197,7 +197,7 @@ public class PipelineContext\n         // merge the operator stats into the operator summary\n         List<OperatorStats> operators = driverStats.getOperatorStats();\n         for (OperatorStats operator : operators) {\n-            operatorSummaries.compute(operator.getOperatorId(), (k, v) -> v == null ? operator : v.add(operator));\n+            operatorSummaries.merge(operator.getOperatorId(), operator, (left, right) -> left.add(right));\n         }\n \n         physicalInputDataSize.update(driverStats.getPhysicalInputDataSize().toBytes());\n"}}, {"oid": "895eff5bcc1343a2ce8408843a3bb4b5f3644a6d", "url": "https://github.com/trinodb/trino/commit/895eff5bcc1343a2ce8408843a3bb4b5f3644a6d", "message": "use Map merge()", "committedDate": "2020-03-13T08:38:56Z", "type": "commit"}]}