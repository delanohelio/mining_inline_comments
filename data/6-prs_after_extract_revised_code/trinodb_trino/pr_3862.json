{"pr_number": 3862, "pr_title": "Make TestRubixCaching tests more resilient", "pr_createdAt": "2020-05-27T09:15:12Z", "pr_url": "https://github.com/trinodb/trino/pull/3862", "timeline": [{"oid": "cc04a3d5916b0c505593cdc1924c576b9e4b7233", "url": "https://github.com/trinodb/trino/commit/cc04a3d5916b0c505593cdc1924c576b9e4b7233", "message": "Assert remote read stats after file is fully cached\n\nThis ensures no pending remote reads are still in progress", "committedDate": "2020-05-27T09:14:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r430975938", "bodyText": "why is getAsyncDownloadedMb be guaranteed to go up from beforeAsyncDownloadedMb to beforeAsyncDownloadedMb + 1?", "author": "findepi", "createdAt": "2020-05-27T09:17:46Z", "path": "presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java", "diffHunk": "@@ -291,6 +291,13 @@ public void testCacheRead(ReadMode readMode)\n \n         assertEquals(readFile(cachingFileSystem.open(file)), randomData);\n \n+        if (readMode == ASYNC) {\n+            // wait for async Rubix requests to complete\n+            assertEventually(\n+                    new Duration(10, SECONDS),\n+                    () -> assertEquals(getAsyncDownloadedMb(readMode), beforeAsyncDownloadedMb + 1));", "originalCommit": "cc04a3d5916b0c505593cdc1924c576b9e4b7233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3OTY0Mg==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r430979642", "bodyText": "why is getAsyncDownloadedMb be guaranteed to go up from beforeAsyncDownloadedMb to beforeAsyncDownloadedMb + 1\n\ntest file has exactly 1MB, so the counter should increase by this much", "author": "sopel39", "createdAt": "2020-05-27T09:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI0NDU4MA==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r431244580", "bodyText": "Isn't it possible that counter would flip before whole file is downloaded? (not sure if that matters very much)", "author": "losipiuk", "createdAt": "2020-05-27T15:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwMDQxNw==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r431400417", "bodyText": "Isn't it possible that counter would flip before whole file is downloaded?\n\nIt shouldn't happen. In each test we assert that whole file gets downloaded asynchronously before continuing, so there should be no pending counter updates.", "author": "sopel39", "createdAt": "2020-05-27T19:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NzkyMw==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r431677923", "bodyText": "The observed counter increase can still be from the time when file was still being downloaded. Right?", "author": "losipiuk", "createdAt": "2020-05-28T08:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY5NTE5OQ==", "url": "https://github.com/trinodb/trino/pull/3862#discussion_r431695199", "bodyText": "The observed counter increase can still be from the time when file was still being downloaded. Right?\n\nSince the file is 1MB, then when the counter bumps, then file should already be downloaded.", "author": "sopel39", "createdAt": "2020-05-28T09:14:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3NTkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "bc69890b3b6f007aa7163bff3f3027ad1b800c1d", "chunk": "diff --git a/presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java b/presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java\nindex fab7a6d241..3fd69ad24b 100644\n--- a/presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java\n+++ b/presto-hive/src/test/java/io/prestosql/plugin/hive/rubix/TestRubixCaching.java\n\n@@ -289,7 +289,7 @@ public class TestRubixCaching\n         long beforeCachedReadsCount = getCachedReadsCount();\n         long beforeAsyncDownloadedMb = getAsyncDownloadedMb(readMode);\n \n-        assertEquals(readFile(cachingFileSystem.open(file)), randomData);\n+        assertEquals(readFile(cachingFileSystem, file), randomData);\n \n         if (readMode == ASYNC) {\n             // wait for async Rubix requests to complete\n"}}, {"oid": "bc69890b3b6f007aa7163bff3f3027ad1b800c1d", "url": "https://github.com/trinodb/trino/commit/bc69890b3b6f007aa7163bff3f3027ad1b800c1d", "message": "Assert cached reads eventually", "committedDate": "2020-05-27T09:26:58Z", "type": "commit"}]}