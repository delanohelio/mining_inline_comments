{"pr_number": 747, "pr_title": "feat: include User agent", "pr_createdAt": "2020-12-15T03:14:19Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/747", "timeline": [{"oid": "3d549ed3a14728aba43a1df3a62922c1b52bce61", "url": "https://github.com/googleapis/java-spanner/commit/3d549ed3a14728aba43a1df3a62922c1b52bce61", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T18:50:27Z", "type": "commit"}, {"oid": "7a356675cce4ea69c503bf01523f9e49581f4971", "url": "https://github.com/googleapis/java-spanner/commit/7a356675cce4ea69c503bf01523f9e49581f4971", "message": "Merge branch 'dp-branch'", "committedDate": "2020-12-03T01:15:06Z", "type": "commit"}, {"oid": "9851996a54d4d25f23496c22baeef58b6fb798c9", "url": "https://github.com/googleapis/java-spanner/commit/9851996a54d4d25f23496c22baeef58b6fb798c9", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-12-15T02:50:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAxNDAyMA==", "url": "https://github.com/googleapis/java-spanner/pull/747#discussion_r543014020", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          options.getSpannerStubSettings().toBuilder()\n          \n          \n            \n                              .setTransportChannelProvider(channelProvider)\n          \n          \n            \n                          options\n          \n          \n            \n                              .getSpannerStubSettings()\n          \n          \n            \n                              .toBuilder()\n          \n          \n            \n                      options\n          \n          \n            \n                          .getSpannerStubSettings()\n          \n          \n            \n                          .executeSqlSettings()\n          \n          \n            \n                          .getRetrySettings()\n          \n          \n            \n                          .toBuilder()", "author": "yoshi-code-bot", "createdAt": "2020-12-15T03:16:29Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -367,19 +381,13 @@ public GapicSpannerRpc(final SpannerOptions options) {\n     try {\n       this.spannerStub =\n           GrpcSpannerStub.create(\n-              options\n-                  .getSpannerStubSettings()\n-                  .toBuilder()\n+              options.getSpannerStubSettings().toBuilder()\n                   .setTransportChannelProvider(channelProvider)", "originalCommit": "a6d4e7cd35491e39de40ab5790ceee85606ce615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\nindex 0ae2556c..6f1b77fd 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n\n@@ -381,13 +381,19 @@ public class GapicSpannerRpc implements SpannerRpc {\n     try {\n       this.spannerStub =\n           GrpcSpannerStub.create(\n-              options.getSpannerStubSettings().toBuilder()\n+              options\n+                  .getSpannerStubSettings()\n+                  .toBuilder()\n                   .setTransportChannelProvider(channelProvider)\n                   .setCredentialsProvider(credentialsProvider)\n                   .setStreamWatchdogProvider(watchdogProvider)\n                   .build());\n       partitionedDmlRetrySettings =\n-          options.getSpannerStubSettings().executeSqlSettings().getRetrySettings().toBuilder()\n+          options\n+              .getSpannerStubSettings()\n+              .executeSqlSettings()\n+              .getRetrySettings()\n+              .toBuilder()\n               .setInitialRpcTimeout(options.getPartitionedDmlTimeout())\n               .setMaxRpcTimeout(options.getPartitionedDmlTimeout())\n               .setTotalTimeout(options.getPartitionedDmlTimeout())\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAxNDAyMw==", "url": "https://github.com/googleapis/java-spanner/pull/747#discussion_r543014023", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          options.getInstanceAdminStubSettings().toBuilder()\n          \n          \n            \n                              .setTransportChannelProvider(channelProvider)\n          \n          \n            \n                          options\n          \n          \n            \n                              .getInstanceAdminStubSettings()\n          \n          \n            \n                              .toBuilder()\n          \n          \n            \n                      options\n          \n          \n            \n                          .getDatabaseAdminStubSettings()\n          \n          \n            \n                          .toBuilder()", "author": "yoshi-code-bot", "createdAt": "2020-12-15T03:16:29Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -412,18 +420,14 @@ public GapicSpannerRpc(final SpannerOptions options) {\n \n       this.instanceAdminStub =\n           GrpcInstanceAdminStub.create(\n-              options\n-                  .getInstanceAdminStubSettings()\n-                  .toBuilder()\n+              options.getInstanceAdminStubSettings().toBuilder()\n                   .setTransportChannelProvider(channelProvider)", "originalCommit": "a6d4e7cd35491e39de40ab5790ceee85606ce615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\nindex 0ae2556c..6f1b77fd 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n\n@@ -420,14 +426,18 @@ public class GapicSpannerRpc implements SpannerRpc {\n \n       this.instanceAdminStub =\n           GrpcInstanceAdminStub.create(\n-              options.getInstanceAdminStubSettings().toBuilder()\n+              options\n+                  .getInstanceAdminStubSettings()\n+                  .toBuilder()\n                   .setTransportChannelProvider(channelProvider)\n                   .setCredentialsProvider(credentialsProvider)\n                   .setStreamWatchdogProvider(watchdogProvider)\n                   .build());\n \n       this.databaseAdminStubSettings =\n-          options.getDatabaseAdminStubSettings().toBuilder()\n+          options\n+              .getDatabaseAdminStubSettings()\n+              .toBuilder()\n               .setTransportChannelProvider(channelProvider)\n               .setCredentialsProvider(credentialsProvider)\n               .setStreamWatchdogProvider(watchdogProvider)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAxNDAyNg==", "url": "https://github.com/googleapis/java-spanner/pull/747#discussion_r543014026", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        options.getInstanceAdminStubSettings().toBuilder()\n          \n          \n            \n                        options\n          \n          \n            \n                            .getInstanceAdminStubSettings()\n          \n          \n            \n                            .toBuilder()", "author": "yoshi-code-bot", "createdAt": "2020-12-15T03:16:29Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -458,9 +462,7 @@ private static void checkEmulatorConnection(\n       // Do a quick check to see if the emulator is actually running.\n       try {\n         InstanceAdminStubSettings.Builder testEmulatorSettings =\n-            options\n-                .getInstanceAdminStubSettings()\n-                .toBuilder()\n+            options.getInstanceAdminStubSettings().toBuilder()", "originalCommit": "a6d4e7cd35491e39de40ab5790ceee85606ce615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\nindex 0ae2556c..6f1b77fd 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n\n@@ -462,7 +472,9 @@ public class GapicSpannerRpc implements SpannerRpc {\n       // Do a quick check to see if the emulator is actually running.\n       try {\n         InstanceAdminStubSettings.Builder testEmulatorSettings =\n-            options.getInstanceAdminStubSettings().toBuilder()\n+            options\n+                .getInstanceAdminStubSettings()\n+                .toBuilder()\n                 .setTransportChannelProvider(channelProvider)\n                 .setCredentialsProvider(credentialsProvider);\n         testEmulatorSettings\n"}}, {"oid": "6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "url": "https://github.com/googleapis/java-spanner/commit/6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "message": "feat: include User agent", "committedDate": "2020-12-15T03:43:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAzNTE5NQ==", "url": "https://github.com/googleapis/java-spanner/pull/747#discussion_r543035195", "bodyText": "We are overriding the header provider here, instead of adding to it. We have to manually construct a new provider that will encapsulate the existing one the the new one:\nprivate static final String USER_AGENT_KEY = \"user-agent\";\nprivate static final String CLIENT_LIBRARY_LANGUAGE = \"spanner-java\";\n\nMap<String, String> headersWithUserAgent = ImmutableMap.<String, String>builder()\n    .put(USER_AGENT_KEY, CLIENT_LIBRARY_LANGUAGE + \"/\" + GaxProperties.getLibraryVersion(GapicSpannerRpc.class)))\n    .putAll(mergedHeaderProvider.getHeaders())\n    .build();\nfinal HeaderProvider headerProviderWithUserAgent = FixedHeaderProvider.create(headersWithUserAgent);\n\n...\n.setHeaderProvider(headerProviderWithUserAgent);", "author": "thiagotnunes", "createdAt": "2020-12-15T04:22:07Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -338,7 +339,20 @@ public GapicSpannerRpc(final SpannerOptions options) {\n                             options.getInterceptorProvider(),\n                             SpannerInterceptorProvider.createDefault()))\n                     .withEncoding(compressorName))\n-            .setHeaderProvider(mergedHeaderProvider);\n+            .setHeaderProvider(mergedHeaderProvider)\n+\n+            // Inject client library version to `user-agent`\n+            .setHeaderProvider(", "originalCommit": "6a41e9af7cd7689a661cbb08038f17dc93e0d6af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA2MjMyMQ==", "url": "https://github.com/googleapis/java-spanner/pull/747#discussion_r543062321", "bodyText": "Fixed. Thanks!", "author": "mohanli-ml", "createdAt": "2020-12-15T05:42:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzAzNTE5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a075cff6bbb93a85b8823119058ce5f25b8b188d", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\nindex 6f1b77fd..d1455fcd 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java\n\n@@ -339,20 +353,7 @@ public class GapicSpannerRpc implements SpannerRpc {\n                             options.getInterceptorProvider(),\n                             SpannerInterceptorProvider.createDefault()))\n                     .withEncoding(compressorName))\n-            .setHeaderProvider(mergedHeaderProvider)\n-\n-            // Inject client library version to `user-agent`\n-            .setHeaderProvider(\n-                new HeaderProvider() {\n-                  @Override\n-                  public Map<String, String> getHeaders() {\n-                    final HashMap<String, String> headers = new HashMap<>();\n-                    headers.put(\n-                        \"user-agent\",\n-                        \"spanner-java/\" + GaxProperties.getLibraryVersion(GapicSpannerRpc.class));\n-                    return headers;\n-                  }\n-                });\n+            .setHeaderProvider(headerProviderWithUserAgent);\n \n     // TODO(weiranf): Set to true by default once DirectPath goes to public beta.\n     if (shouldAttemptDirectPath()) {\n"}}, {"oid": "a075cff6bbb93a85b8823119058ce5f25b8b188d", "url": "https://github.com/googleapis/java-spanner/commit/a075cff6bbb93a85b8823119058ce5f25b8b188d", "message": "feat: include User agent", "committedDate": "2020-12-15T05:42:16Z", "type": "commit"}, {"oid": "a075cff6bbb93a85b8823119058ce5f25b8b188d", "url": "https://github.com/googleapis/java-spanner/commit/a075cff6bbb93a85b8823119058ce5f25b8b188d", "message": "feat: include User agent", "committedDate": "2020-12-15T05:42:16Z", "type": "forcePushed"}]}