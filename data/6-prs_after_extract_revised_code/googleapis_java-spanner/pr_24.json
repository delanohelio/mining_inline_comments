{"pr_number": 24, "pr_title": "perf: close sessions async", "pr_createdAt": "2020-01-09T13:56:10Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/24", "timeline": [{"oid": "023939384ad81ee11adcfe1f663acb88c483fa35", "url": "https://github.com/googleapis/java-spanner/commit/023939384ad81ee11adcfe1f663acb88c483fa35", "message": "perf: close sessions async\n\nSessions should be closed using an async gRPC call in order\nto speed up the closing of a large session pool. Instead of\nusing its own executor, which is limited to 8 worker threads,\nto execute asynchronous delete session calls, the session pool\nshould use the asynchronous call option in gRPC. This allows a\nlarger number of asynchronous delete session calls to be executed\nin parallel and speeds up closing a session pool with a large\nnumber of sessions.\n\nTesting against a real Cloud Spanner database with a session pool\ncontaining 1,000 sessions shows the following performance for\nclosing the session pool:\n\nBefore (3 runs):\n6603ms\n8169ms\n8367ms\n\nAfter (3 runs):\n1297ms\n1710ms\n1851ms\n\nFixes #19.", "committedDate": "2020-01-14T15:24:16Z", "type": "commit"}, {"oid": "5b1ee9ca071c4dc1059b03c52e17519535443609", "url": "https://github.com/googleapis/java-spanner/commit/5b1ee9ca071c4dc1059b03c52e17519535443609", "message": "fix: wait for test servers to terminate", "committedDate": "2020-01-14T15:24:16Z", "type": "commit"}, {"oid": "426ab82ffad8909f7d24b1e76fa99bb0a84476a2", "url": "https://github.com/googleapis/java-spanner/commit/426ab82ffad8909f7d24b1e76fa99bb0a84476a2", "message": "remove tracing for async call", "committedDate": "2020-01-14T15:24:16Z", "type": "commit"}, {"oid": "d2ed3bcad2fe7efe1bad8af7ec5f966a99b9dfce", "url": "https://github.com/googleapis/java-spanner/commit/d2ed3bcad2fe7efe1bad8af7ec5f966a99b9dfce", "message": "do not use directExecutor which could be a gRPC thread", "committedDate": "2020-01-14T15:24:16Z", "type": "commit"}, {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1", "url": "https://github.com/googleapis/java-spanner/commit/a2be79274a40363c63fc4a016bf8a360a3507fb1", "message": "fix: return failed future instead of throwing exception", "committedDate": "2020-01-14T15:49:01Z", "type": "commit"}, {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1", "url": "https://github.com/googleapis/java-spanner/commit/a2be79274a40363c63fc4a016bf8a360a3507fb1", "message": "fix: return failed future instead of throwing exception", "committedDate": "2020-01-14T15:49:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwNDA3MQ==", "url": "https://github.com/googleapis/java-spanner/pull/24#discussion_r367204071", "bodyText": "Why is this commented out?", "author": "skuruppu", "createdAt": "2020-01-16T02:29:03Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java", "diffHunk": "@@ -139,6 +142,8 @@ public Void answer(InvocationOnMock invocation) throws Throwable {\n   private void setupSession(final Session session) {\n     ReadContext mockContext = mock(ReadContext.class);\n     final ResultSet mockResult = mock(ResultSet.class);\n+    //\n+    // when(session.asyncClose()).thenReturn(ApiFutures.immediateFuture(Empty.getDefaultInstance()));", "originalCommit": "a2be79274a40363c63fc4a016bf8a360a3507fb1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU5MjE0Nw==", "url": "https://github.com/googleapis/java-spanner/pull/24#discussion_r367592147", "bodyText": "The commented code has now been removed. It was erroneously added in the first place and caused this test to fail sometimes. While searching for the reason, it was commented out and never removed.", "author": "olavloite", "createdAt": "2020-01-16T18:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwNDA3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712", "chunk": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java\nindex 3f3bed9c..beb2e35c 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java\n\n@@ -142,8 +142,6 @@ public class SessionPoolStressTest extends BaseSessionPoolTest {\n   private void setupSession(final Session session) {\n     ReadContext mockContext = mock(ReadContext.class);\n     final ResultSet mockResult = mock(ResultSet.class);\n-    //\n-    // when(session.asyncClose()).thenReturn(ApiFutures.immediateFuture(Empty.getDefaultInstance()));\n     when(session.singleUse(any(TimestampBound.class))).thenReturn(mockContext);\n     when(mockContext.executeQuery(any(Statement.class)))\n         .thenAnswer(\n"}}, {"oid": "8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712", "url": "https://github.com/googleapis/java-spanner/commit/8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712", "message": "fix: remove commented code", "committedDate": "2020-01-16T18:51:27Z", "type": "commit"}]}