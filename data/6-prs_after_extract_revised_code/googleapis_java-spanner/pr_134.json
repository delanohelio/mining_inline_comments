{"pr_number": 134, "pr_title": "perf: increase sessions in the pool in batches", "pr_createdAt": "2020-03-28T19:54:41Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/134", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDg3Mg==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r401954872", "bodyText": "Why do we name this from distributeOverChannels to initialization? initialization seems not to have a clear meaning.", "author": "hengfengli", "createdAt": "2020-04-01T22:49:04Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1794,7 +1795,7 @@ private boolean canCreateSession() {\n     }\n   }\n \n-  private void createSessions(final int sessionCount) {\n+  private void createSessions(final int sessionCount, boolean initialization) {", "originalCommit": "d4cdee90cbb96010e8b6105436a0ec6aaac01cb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NTgyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r402085825", "bodyText": "Good point, changed. I had named it initialization because the session pool only calls this with true during initialization, but naming it by what it actually does instead of when it's called, is a lot more helpful.", "author": "olavloite", "createdAt": "2020-04-02T06:46:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NDg3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "e3ac294373a4bc9b3db4a45f48e7ca451c849fcd", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex d6b2838d..0582f4b1 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n\n@@ -1795,7 +1795,7 @@ final class SessionPool {\n     }\n   }\n \n-  private void createSessions(final int sessionCount, boolean initialization) {\n+  private void createSessions(final int sessionCount, boolean distributeOverChannels) {\n     logger.log(Level.FINE, String.format(\"Creating %d sessions\", sessionCount));\n     synchronized (lock) {\n       numSessionsBeingCreated += sessionCount;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzU2Nw==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r401967567", "bodyText": "So does this mean only when we initialize the pool, we will distribute requests across different channels? For the rest, we don't.", "author": "hengfengli", "createdAt": "2020-04-01T23:26:41Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1077,7 +1077,7 @@ private void replenishPool() {\n         // If we have gone below min pool size, create that many sessions.\n         int sessionCount = options.getMinSessions() - (totalSessions() + numSessionsBeingCreated);\n         if (sessionCount > 0) {\n-          createSessions(getAllowedCreateSessions(sessionCount));\n+          createSessions(getAllowedCreateSessions(sessionCount), false);", "originalCommit": "d4cdee90cbb96010e8b6105436a0ec6aaac01cb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4NzU4NA==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r402087584", "bodyText": "Yes, that is correct. The SessionClient will automatically make sure that consecutive requests will be executed on different channels round robin, so that the distribution over channels will still be maintained if the session pool continues to request additional sessions.\nThis means that the pool initialization will distribute the MinSessions sessions over all available channels. Each time the pool increases the number of sessions, that batch of new sessions will all be bound to one channel, but each new batch will be bound to a different channel. So in the end the sessions will still be distributed over all available channels.", "author": "olavloite", "createdAt": "2020-04-02T06:50:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzU2Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTAyNg==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r401969026", "bodyText": "Do we need to allow users to configure this? I mean we add a new parameter to let users to configure, which can add cognitive load to them.", "author": "hengfengli", "createdAt": "2020-04-01T23:31:16Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPoolOptions.java", "diffHunk": "@@ -40,6 +42,7 @@ private SessionPoolOptions(Builder builder) {\n     // maxSessions value is less than the default for minSessions.\n     this.minSessions = Math.min(builder.minSessions, builder.maxSessions);\n     this.maxSessions = builder.maxSessions;\n+    this.incStep = builder.incStep;", "originalCommit": "d4cdee90cbb96010e8b6105436a0ec6aaac01cb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA4ODA4NQ==", "url": "https://github.com/googleapis/java-spanner/pull/134#discussion_r402088085", "bodyText": "No, the configuration parameter is package-private, meaning that it can only be configured internally by the client library and its tests. Users can't see this configuration, unless they browse the source code of the client library.\nIt needs to be configurable for the benchmarks to be able to test different scenarios.", "author": "olavloite", "createdAt": "2020-04-02T06:51:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTAyNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b9722e3012bab4f153516798cccd148c83fe2780", "url": "https://github.com/googleapis/java-spanner/commit/b9722e3012bab4f153516798cccd148c83fe2780", "message": "perf: increase sessions in the pool in batches\n\nWhen more sessions are requested by the user application than are available in the session pool,\nthe session pool will now create new sessions in batches instead of in steps of 1. This reduces\nthe number of RPCs needed to serve a burst of requests.\n\nA benchmark for the session pool has also been added to be able to compare performance and the\nnumber of RPCs needed before and after this change. This benchmark can also be used for future\nchanges to verify that the change does not deteriorate performance or increase the number of\nRPCs needed.", "committedDate": "2020-04-04T15:08:32Z", "type": "commit"}, {"oid": "6ef0deaea886186fe4d318e5ba7ec74e5ee91ce6", "url": "https://github.com/googleapis/java-spanner/commit/6ef0deaea886186fe4d318e5ba7ec74e5ee91ce6", "message": "fix: remove unused code", "committedDate": "2020-04-04T15:08:32Z", "type": "commit"}, {"oid": "c61ecee9b7db7444778ba6ef11e9d1a65d0e7fa0", "url": "https://github.com/googleapis/java-spanner/commit/c61ecee9b7db7444778ba6ef11e9d1a65d0e7fa0", "message": "fix: include num rpcs and sessions in benchmark results", "committedDate": "2020-04-04T15:09:54Z", "type": "commit"}, {"oid": "0db75dfbdb3f66a87238bf840cadc3c0776f62f6", "url": "https://github.com/googleapis/java-spanner/commit/0db75dfbdb3f66a87238bf840cadc3c0776f62f6", "message": "fix: remove commented code", "committedDate": "2020-04-04T15:09:54Z", "type": "commit"}, {"oid": "e3ac294373a4bc9b3db4a45f48e7ca451c849fcd", "url": "https://github.com/googleapis/java-spanner/commit/e3ac294373a4bc9b3db4a45f48e7ca451c849fcd", "message": "fix: rename parameter", "committedDate": "2020-04-04T15:09:54Z", "type": "commit"}, {"oid": "e3ac294373a4bc9b3db4a45f48e7ca451c849fcd", "url": "https://github.com/googleapis/java-spanner/commit/e3ac294373a4bc9b3db4a45f48e7ca451c849fcd", "message": "fix: rename parameter", "committedDate": "2020-04-04T15:09:54Z", "type": "forcePushed"}]}