{"pr_number": 665, "pr_title": "feat: add support for instance processing units", "pr_createdAt": "2020-11-19T19:00:51Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/665", "timeline": [{"oid": "674643592939187b0541c1f9c76a475ef74e4d3e", "url": "https://github.com/googleapis/java-spanner/commit/674643592939187b0541c1f9c76a475ef74e4d3e", "message": "chore: fix formatting", "committedDate": "2021-05-06T04:52:23Z", "type": "forcePushed"}, {"oid": "6269b7b227a11076604e924aff3c7a300142698b", "url": "https://github.com/googleapis/java-spanner/commit/6269b7b227a11076604e924aff3c7a300142698b", "message": "chore: fix formatting", "committedDate": "2021-02-08T13:57:13Z", "type": "forcePushed"}, {"oid": "be69e3665de110b5791423861b33c4787bb36ae9", "url": "https://github.com/googleapis/java-spanner/commit/be69e3665de110b5791423861b33c4787bb36ae9", "message": "feat: add support for instance processing units", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "52555eac3d74b02eb229bccd994179f23a43daa6", "url": "https://github.com/googleapis/java-spanner/commit/52555eac3d74b02eb229bccd994179f23a43daa6", "message": "docs: add sample for instance processing units", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "74707480aca872592fa97c5c55121aaaa243db4b", "url": "https://github.com/googleapis/java-spanner/commit/74707480aca872592fa97c5c55121aaaa243db4b", "message": "fix: remove commented code + use junit asserts", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "a8e64c8c14f98d1a0234aa4f04c08dfdb746c3fe", "url": "https://github.com/googleapis/java-spanner/commit/a8e64c8c14f98d1a0234aa4f04c08dfdb746c3fe", "message": "fix: remove Spanner snapshot reference", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "98b5f58a488f5cb0741839e0e948689ada160596", "url": "https://github.com/googleapis/java-spanner/commit/98b5f58a488f5cb0741839e0e948689ada160596", "message": "test: add tests for InstanceInfo", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "0c9e26e4bab532d06667f1b0591833218ee5fad7", "url": "https://github.com/googleapis/java-spanner/commit/0c9e26e4bab532d06667f1b0591833218ee5fad7", "message": "cleanup: fix formatting + tests", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "b4e4c390ecdb08a65219ccdb44e07eaaa22dc485", "url": "https://github.com/googleapis/java-spanner/commit/b4e4c390ecdb08a65219ccdb44e07eaaa22dc485", "message": "chore: fix formatting", "committedDate": "2021-05-06T06:13:18Z", "type": "commit"}, {"oid": "b4e4c390ecdb08a65219ccdb44e07eaaa22dc485", "url": "https://github.com/googleapis/java-spanner/commit/b4e4c390ecdb08a65219ccdb44e07eaaa22dc485", "message": "chore: fix formatting", "committedDate": "2021-05-06T06:13:18Z", "type": "forcePushed"}, {"oid": "c11c844a389a29c2ccca4de43a17b762606db2c5", "url": "https://github.com/googleapis/java-spanner/commit/c11c844a389a29c2ccca4de43a17b762606db2c5", "message": "Merge branch 'master' of github.com:googleapis/java-spanner into processing-units", "committedDate": "2021-05-06T06:23:13Z", "type": "commit"}, {"oid": "187c33c336872631f057f6810983830539afee14", "url": "https://github.com/googleapis/java-spanner/commit/187c33c336872631f057f6810983830539afee14", "message": "chore:regen", "committedDate": "2021-05-06T06:25:04Z", "type": "forcePushed"}, {"oid": "4a3f44b5ce66c1af3fa15d6a3fb61e4f16d22fca", "url": "https://github.com/googleapis/java-spanner/commit/4a3f44b5ce66c1af3fa15d6a3fb61e4f16d22fca", "message": "test: fixes instanceinfo test\n\nDue to master merge the compilation was failing. Fixes the builder\nconstruction here.", "committedDate": "2021-06-15T23:49:03Z", "type": "commit"}, {"oid": "1ecd9f65ce5e510d0112fc4be33f92de919bf66f", "url": "https://github.com/googleapis/java-spanner/commit/1ecd9f65ce5e510d0112fc4be33f92de919bf66f", "message": "Merge branch 'master' of github.com:googleapis/java-spanner into processing-units", "committedDate": "2021-06-15T23:49:14Z", "type": "commit"}, {"oid": "657f210a71dac6fcfba9b8badb88614dbd2eff23", "url": "https://github.com/googleapis/java-spanner/commit/657f210a71dac6fcfba9b8badb88614dbd2eff23", "message": "refactor: adds default impl for processing units\n\nAdds default implementation for the InstanceInfo set processing units in\norder to avoid a breaking change.", "committedDate": "2021-06-15T23:50:33Z", "type": "commit"}, {"oid": "dc178921927d28ceb54ba49f195752c44ce45f82", "url": "https://github.com/googleapis/java-spanner/commit/dc178921927d28ceb54ba49f195752c44ce45f82", "message": "samples: remove LCI samples for now\n\nRemoves the LCI samples for now, because they won't compile. We will\nre-add them once the main implementation is released.", "committedDate": "2021-06-15T23:52:01Z", "type": "commit"}, {"oid": "dc178921927d28ceb54ba49f195752c44ce45f82", "url": "https://github.com/googleapis/java-spanner/commit/dc178921927d28ceb54ba49f195752c44ce45f82", "message": "samples: remove LCI samples for now\n\nRemoves the LCI samples for now, because they won't compile. We will\nre-add them once the main implementation is released.", "committedDate": "2021-06-15T23:52:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDE4OQ==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r652574189", "bodyText": "This field is superfluous and adds an unnecessary indirection. Inline it. In general, do not use named constants for user visible strings.", "author": "elharo", "createdAt": "2021-06-16T10:49:36Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceAdminClientImpl.java", "diffHunk": "@@ -47,6 +47,8 @@ protected Policy fromPb(com.google.iam.v1.Policy policyPb) {\n     }\n   }\n \n+  static final String NOT_BOTH_NODE_COUNT_AND_PROCESSING_UNITS =", "originalCommit": "dc178921927d28ceb54ba49f195752c44ce45f82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3NzMzMw==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r654077333", "bodyText": "Inlined it.", "author": "thiagotnunes", "createdAt": "2021-06-18T01:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDE4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceAdminClientImpl.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceAdminClientImpl.java\nindex 5db757ab..142540af 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceAdminClientImpl.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceAdminClientImpl.java\n\n@@ -47,8 +47,6 @@ class InstanceAdminClientImpl implements InstanceAdminClient {\n     }\n   }\n \n-  static final String NOT_BOTH_NODE_COUNT_AND_PROCESSING_UNITS =\n-      \"Only one of nodeCount and processingUnits can be set when creating a new instance\";\n   private static final PathTemplate PROJECT_NAME_TEMPLATE =\n       PathTemplate.create(\"projects/{project}\");\n   private final DatabaseAdminClient dbClient;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDY5MA==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r652574690", "bodyText": "Must or can? If must, then \"Exactly one of\"", "author": "elharo", "createdAt": "2021-06-16T10:50:27Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java", "diffHunk": "@@ -68,8 +77,22 @@ static FieldMask toFieldMask(InstanceField... fields) {\n \n     public abstract Builder setDisplayName(String displayName);\n \n+    /**\n+     * Sets the number of nodes for the instance. Only one of processing units or node count must be", "originalCommit": "dc178921927d28ceb54ba49f195752c44ce45f82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3NzM5OQ==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r654077399", "bodyText": "Must, changed the wording to \"Exactly one of\"", "author": "thiagotnunes", "createdAt": "2021-06-18T01:11:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDY5MA=="}], "type": "inlineReview", "revised_code": {"commit": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\nindex 3bbd86e0..fe47973b 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n\n@@ -78,16 +78,16 @@ public class InstanceInfo {\n     public abstract Builder setDisplayName(String displayName);\n \n     /**\n-     * Sets the number of nodes for the instance. Only one of processing units or node count must be\n-     * set when creating a new instance.\n+     * Sets the number of nodes for the instance. Exactly one of processing units or node count must\n+     * be set when creating a new instance.\n      */\n     public abstract Builder setNodeCount(int nodeCount);\n \n     /**\n-     * Sets the number of processing units for the instance. Only one of processing units or node\n+     * Sets the number of processing units for the instance. Exactly one of processing units or node\n      * count must be set when creating a new instance. Processing units must be between 1 and 999\n      * (inclusive) when creating a new instance with node count = 0. Processing units from 1000 and\n-     * up must always be a multiple of 1000 (i.e. equal to an integer number of nodes).\n+     * up must always be a multiple of 1000 (that is equal to an integer number of nodes).\n      */\n     public Builder setProcessingUnits(int processingUnits) {\n       throw new UnsupportedOperationException(\"Unimplemented\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDc4Ng==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r652574786", "bodyText": "ditto", "author": "elharo", "createdAt": "2021-06-16T10:50:36Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java", "diffHunk": "@@ -68,8 +77,22 @@ static FieldMask toFieldMask(InstanceField... fields) {\n \n     public abstract Builder setDisplayName(String displayName);\n \n+    /**\n+     * Sets the number of nodes for the instance. Only one of processing units or node count must be\n+     * set when creating a new instance.\n+     */\n     public abstract Builder setNodeCount(int nodeCount);\n \n+    /**\n+     * Sets the number of processing units for the instance. Only one of processing units or node", "originalCommit": "dc178921927d28ceb54ba49f195752c44ce45f82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3NzQyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r654077425", "bodyText": "Must, changed the wording to \"Exactly one of\"", "author": "thiagotnunes", "createdAt": "2021-06-18T01:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NDc4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\nindex 3bbd86e0..fe47973b 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n\n@@ -78,16 +78,16 @@ public class InstanceInfo {\n     public abstract Builder setDisplayName(String displayName);\n \n     /**\n-     * Sets the number of nodes for the instance. Only one of processing units or node count must be\n-     * set when creating a new instance.\n+     * Sets the number of nodes for the instance. Exactly one of processing units or node count must\n+     * be set when creating a new instance.\n      */\n     public abstract Builder setNodeCount(int nodeCount);\n \n     /**\n-     * Sets the number of processing units for the instance. Only one of processing units or node\n+     * Sets the number of processing units for the instance. Exactly one of processing units or node\n      * count must be set when creating a new instance. Processing units must be between 1 and 999\n      * (inclusive) when creating a new instance with node count = 0. Processing units from 1000 and\n-     * up must always be a multiple of 1000 (i.e. equal to an integer number of nodes).\n+     * up must always be a multiple of 1000 (that is equal to an integer number of nodes).\n      */\n     public Builder setProcessingUnits(int processingUnits) {\n       throw new UnsupportedOperationException(\"Unimplemented\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NTE3Ng==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r652575176", "bodyText": "i.e. --> \"That is\" per google tech writing style guide", "author": "elharo", "createdAt": "2021-06-16T10:51:12Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java", "diffHunk": "@@ -68,8 +77,22 @@ static FieldMask toFieldMask(InstanceField... fields) {\n \n     public abstract Builder setDisplayName(String displayName);\n \n+    /**\n+     * Sets the number of nodes for the instance. Only one of processing units or node count must be\n+     * set when creating a new instance.\n+     */\n     public abstract Builder setNodeCount(int nodeCount);\n \n+    /**\n+     * Sets the number of processing units for the instance. Only one of processing units or node\n+     * count must be set when creating a new instance. Processing units must be between 1 and 999\n+     * (inclusive) when creating a new instance with node count = 0. Processing units from 1000 and\n+     * up must always be a multiple of 1000 (i.e. equal to an integer number of nodes).", "originalCommit": "dc178921927d28ceb54ba49f195752c44ce45f82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3NzUxNA==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r654077514", "bodyText": "Changed the wording to \"that is\" instead of \"i.e.\"", "author": "thiagotnunes", "createdAt": "2021-06-18T01:11:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NTE3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\nindex 3bbd86e0..fe47973b 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/InstanceInfo.java\n\n@@ -78,16 +78,16 @@ public class InstanceInfo {\n     public abstract Builder setDisplayName(String displayName);\n \n     /**\n-     * Sets the number of nodes for the instance. Only one of processing units or node count must be\n-     * set when creating a new instance.\n+     * Sets the number of nodes for the instance. Exactly one of processing units or node count must\n+     * be set when creating a new instance.\n      */\n     public abstract Builder setNodeCount(int nodeCount);\n \n     /**\n-     * Sets the number of processing units for the instance. Only one of processing units or node\n+     * Sets the number of processing units for the instance. Exactly one of processing units or node\n      * count must be set when creating a new instance. Processing units must be between 1 and 999\n      * (inclusive) when creating a new instance with node count = 0. Processing units from 1000 and\n-     * up must always be a multiple of 1000 (i.e. equal to an integer number of nodes).\n+     * up must always be a multiple of 1000 (that is equal to an integer number of nodes).\n      */\n     public Builder setProcessingUnits(int processingUnits) {\n       throw new UnsupportedOperationException(\"Unimplemented\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NTgyMw==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r652575823", "bodyText": "in tests compare against the expected literal value, not a constant from the model code, so the test catches mistakes in constant definitions.", "author": "elharo", "createdAt": "2021-06-16T10:52:06Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/InstanceAdminClientImplTest.java", "diffHunk": "@@ -128,9 +144,49 @@ public void createInstance() throws Exception {\n   }\n \n   @Test\n-  public void getInstance() {\n+  public void testCreateInstanceWithProcessingUnits() throws Exception {\n+    OperationFuture<com.google.spanner.admin.instance.v1.Instance, CreateInstanceMetadata>\n+        rawOperationFuture =\n+            OperationFutureUtil.immediateOperationFuture(\n+                \"createInstance\",\n+                getInstanceProtoWithProcessingUnits(),\n+                CreateInstanceMetadata.getDefaultInstance());\n+    when(rpc.createInstance(\n+            \"projects/\" + PROJECT_ID, INSTANCE_ID, getInstanceProtoWithProcessingUnits()))\n+        .thenReturn(rawOperationFuture);\n+    OperationFuture<Instance, CreateInstanceMetadata> operation =\n+        client.createInstance(\n+            InstanceInfo.newBuilder(InstanceId.of(PROJECT_ID, INSTANCE_ID))\n+                .setInstanceConfigId(InstanceConfigId.of(PROJECT_ID, CONFIG_ID))\n+                .setProcessingUnits(10)\n+                .build());\n+    assertTrue(operation.isDone());\n+    assertEquals(INSTANCE_NAME, operation.get().getId().getName());\n+  }\n+\n+  @Test\n+  public void testCreateInstanceWithBothNodeCountAndProcessingUnits() throws Exception {\n+    try {\n+      client.createInstance(\n+          InstanceInfo.newBuilder(InstanceId.of(PROJECT_ID, INSTANCE_ID))\n+              .setInstanceConfigId(InstanceConfigId.of(PROJECT_ID, CONFIG_ID))\n+              .setNodeCount(1)\n+              .setProcessingUnits(100)\n+              .build());\n+      fail(\"missing expected exception\");\n+    } catch (IllegalArgumentException e) {\n+      assertTrue(\n+          e.getMessage()\n+              .contains(InstanceAdminClientImpl.NOT_BOTH_NODE_COUNT_AND_PROCESSING_UNITS));", "originalCommit": "dc178921927d28ceb54ba49f195752c44ce45f82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3NzYwMA==", "url": "https://github.com/googleapis/java-spanner/pull/665#discussion_r654077600", "bodyText": "Comparing against literal value now.", "author": "thiagotnunes", "createdAt": "2021-06-18T01:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjU3NTgyMw=="}], "type": "inlineReview", "revised_code": {"commit": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "chunk": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/InstanceAdminClientImplTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/InstanceAdminClientImplTest.java\nindex 96500f8e..0df869de 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/InstanceAdminClientImplTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/InstanceAdminClientImplTest.java\n\n@@ -177,7 +177,8 @@ public class InstanceAdminClientImplTest {\n     } catch (IllegalArgumentException e) {\n       assertTrue(\n           e.getMessage()\n-              .contains(InstanceAdminClientImpl.NOT_BOTH_NODE_COUNT_AND_PROCESSING_UNITS));\n+              .contains(\n+                  \"Only one of nodeCount and processingUnits can be set when creating a new instance\"));\n     }\n   }\n \n"}}, {"oid": "5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "url": "https://github.com/googleapis/java-spanner/commit/5c462aeffcf3b1b171f6d03b7eb7c7a3bd2828d2", "message": "fix: addresses PR comments", "committedDate": "2021-06-18T01:10:03Z", "type": "commit"}]}