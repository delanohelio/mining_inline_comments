{"pr_number": 707, "pr_title": "docs: add sample for timeout for one RPC", "pr_createdAt": "2020-12-10T13:15:12Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/707", "timeline": [{"oid": "562dfe50ca54834c098f3d011eeb1beaaa2fbaaa", "url": "https://github.com/googleapis/java-spanner/commit/562dfe50ca54834c098f3d011eeb1beaaa2fbaaa", "message": "docs: add sample for timeout for one RPC\n\nAdds a sample for setting a timeout for a single RPC.\n\nFixes https://github.com/GoogleCloudPlatform/java-docs-samples/issues/3805", "committedDate": "2020-12-10T13:13:37Z", "type": "commit"}, {"oid": "927fb4ab4ac567275d9d36b3be281e57764e97bc", "url": "https://github.com/googleapis/java-spanner/commit/927fb4ab4ac567275d9d36b3be281e57764e97bc", "message": "fix: fix import order", "committedDate": "2020-12-10T13:24:20Z", "type": "commit"}, {"oid": "e54321269e594202e25d7b0910ed1f4f6be3bfc3", "url": "https://github.com/googleapis/java-spanner/commit/e54321269e594202e25d7b0910ed1f4f6be3bfc3", "message": "fix: format code with the correct formatter plugin", "committedDate": "2020-12-10T13:27:43Z", "type": "commit"}, {"oid": "f794dd43665b618e51002204b651049ea5aa013b", "url": "https://github.com/googleapis/java-spanner/commit/f794dd43665b618e51002204b651049ea5aa013b", "message": "fix: delete test data after each test", "committedDate": "2020-12-10T15:49:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4OTc5MA==", "url": "https://github.com/googleapis/java-spanner/pull/707#discussion_r540589790", "bodyText": "How does this work in a multiprocessing environment when several processes are trying to test this at the same time?", "author": "lesv", "createdAt": "2020-12-10T23:59:53Z", "path": "samples/snippets/src/main/java/com/example/spanner/StatementTimeoutExample.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner;\n+\n+import com.google.api.gax.grpc.GrpcCallContext;\n+import com.google.api.gax.rpc.ApiCallContext;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.Spanner;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.SpannerOptions.CallContextConfigurator;\n+import com.google.cloud.spanner.Statement;\n+import com.google.cloud.spanner.TransactionContext;\n+import com.google.cloud.spanner.TransactionRunner.TransactionCallable;\n+import com.google.spanner.v1.SpannerGrpc;\n+import io.grpc.CallOptions;\n+import io.grpc.Context;\n+import io.grpc.MethodDescriptor;\n+import java.util.concurrent.TimeUnit;\n+\n+class StatementTimeoutExample {\n+\n+  static void executeSqlWithTimeout() {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+\n+    try (Spanner spanner =\n+        SpannerOptions.newBuilder().setProjectId(projectId).build().getService()) {\n+      DatabaseClient client =\n+          spanner.getDatabaseClient(DatabaseId.of(projectId, instanceId, databaseId));\n+      executeSqlWithTimeout(client);\n+    }\n+  }\n+\n+  static void executeSqlWithTimeout(DatabaseClient client) {\n+    CallContextConfigurator configurator = new CallContextConfigurator() {\n+      public <ReqT, RespT> ApiCallContext configure(ApiCallContext context, ReqT request,\n+          MethodDescriptor<ReqT, RespT> method) {\n+        // DML uses the ExecuteSql RPC.\n+        if (method == SpannerGrpc.getExecuteSqlMethod()) {\n+          return GrpcCallContext.createDefault()\n+              .withCallOptions(CallOptions.DEFAULT.withDeadlineAfter(60L, TimeUnit.SECONDS));\n+        }\n+        // Return null to indicate that the default should be used for other methods.\n+        return null;\n+      }\n+    };\n+    // Create a context that uses the custom call configuration.\n+    Context context =\n+        Context.current().withValue(SpannerOptions.CALL_CONTEXT_CONFIGURATOR_KEY, configurator);\n+    // Run the transaction in the custom context.\n+    context.run(new Runnable() {\n+      public void run() {\n+        client.readWriteTransaction().run(new TransactionCallable<long[]>() {\n+          public long[] run(TransactionContext transaction) throws Exception {\n+            String sql = \"INSERT Singers (SingerId, FirstName, LastName)\\n\"\n+                + \"VALUES (20, 'George', 'Washington')\";\n+            long rowCount = transaction.executeUpdate(Statement.of(sql));", "originalCommit": "f794dd43665b618e51002204b651049ea5aa013b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5NjQ1Mg==", "url": "https://github.com/googleapis/java-spanner/pull/707#discussion_r540696452", "bodyText": "Each test run always creates a database that is only used for that test run:\n\n  \n    \n      java-spanner/samples/snippets/src/test/java/com/example/spanner/SpannerStandaloneExamplesIT.java\n    \n    \n        Lines 80 to 95\n      in\n      f794dd4\n    \n    \n    \n    \n\n        \n          \n           dbClient \n        \n\n        \n          \n               .createDatabase( \n        \n\n        \n          \n                   instanceId, \n        \n\n        \n          \n                   databaseId, \n        \n\n        \n          \n                   ImmutableList.of( \n        \n\n        \n          \n                       \"CREATE TABLE Singers (\" \n        \n\n        \n          \n                           + \"  SingerId   INT64 NOT NULL,\" \n        \n\n        \n          \n                           + \"  FirstName  STRING(1024),\" \n        \n\n        \n          \n                           + \"  LastName   STRING(1024),\" \n        \n\n        \n          \n                           + \"  SingerInfo BYTES(MAX)\" \n        \n\n        \n          \n                           + \") PRIMARY KEY (SingerId)\", \n        \n\n        \n          \n                       \"CREATE TABLE Venues (\" \n        \n\n        \n          \n                           + \"VenueId INT64 NOT NULL,\" \n        \n\n        \n          \n                           + \"Revenue NUMERIC\" \n        \n\n        \n          \n                           + \") PRIMARY KEY (VenueId)\")) \n        \n\n        \n          \n               .get();", "author": "olavloite", "createdAt": "2020-12-11T05:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4OTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc3MzcwNw==", "url": "https://github.com/googleapis/java-spanner/pull/707#discussion_r543773707", "bodyText": "Should work to create and drop db before and after each test, but dbs need be unique so they don't overlap. Will dbs be unique with current use of instanceid/databseId?", "author": "eaball35", "createdAt": "2020-12-15T23:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4OTc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4MDMwNA==", "url": "https://github.com/googleapis/java-spanner/pull/707#discussion_r543780304", "bodyText": "Yes, the databaseId is uniquely generated for each test run by taking the system property as a base id and appending a UUID:\n\nGetting the base databaseId: \n  \n    \n      java-spanner/samples/snippets/src/test/java/com/example/spanner/SpannerStandaloneExamplesIT.java\n    \n    \n         Line 52\n      in\n      e6a34d9\n    \n    \n    \n    \n\n        \n          \n           private static String databaseId = SpannerSampleIT.formatForTest(baseDatabaseId); \n        \n    \n  \n\n\nAppending a UUID: \n  \n    \n      java-spanner/samples/snippets/src/test/java/com/example/spanner/SpannerSampleIT.java\n    \n    \n        Lines 439 to 441\n      in\n      2b3775a\n    \n    \n    \n    \n\n        \n          \n           static String formatForTest(String name) { \n        \n\n        \n          \n             return name + \"-\" + UUID.randomUUID().toString().substring(0, DBID_LENGTH); \n        \n\n        \n          \n           }", "author": "olavloite", "createdAt": "2020-12-16T00:11:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4OTc5MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2a03b05473c3b3500b7d744732717b17611415dc", "url": "https://github.com/googleapis/java-spanner/commit/2a03b05473c3b3500b7d744732717b17611415dc", "message": "fix: auto-throttle admin requests", "committedDate": "2020-12-11T06:57:38Z", "type": "commit"}, {"oid": "e6a34d924dff94e2f238eec63b9e62366d3cb506", "url": "https://github.com/googleapis/java-spanner/commit/e6a34d924dff94e2f238eec63b9e62366d3cb506", "message": "Merge branch 'master' into add-sample-for-timeout", "committedDate": "2020-12-14T10:47:51Z", "type": "commit"}]}