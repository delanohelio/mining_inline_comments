{"pr_number": 524, "pr_title": "test: remove explicit CreateInstance timeout", "pr_createdAt": "2020-10-19T23:30:12Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/524", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyMTI3OA==", "url": "https://github.com/googleapis/java-spanner/pull/524#discussion_r508121278", "bodyText": "This is to fix the flakiness on the internal runs of these integration tests.\nI do wonder if this timeout is even necessary. @olavloite do you know if these long-running operation settings are respected by the OperationFuture?\nhttps://github.com/googleapis/googleapis/blob/master/google/spanner/admin/instance/v1/spanner_admin_instance_gapic.yaml#L23-L27", "author": "skuruppu", "createdAt": "2020-10-19T23:33:40Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/IntegrationTestEnv.java", "diffHunk": "@@ -126,7 +126,7 @@ private void initializeInstance(InstanceId instanceId) {\n         instanceAdminClient.createInstance(instance);\n     Instance createdInstance;\n     try {\n-      createdInstance = op.get(30000L, TimeUnit.MILLISECONDS);\n+      createdInstance = op.get(3600000L, TimeUnit.MILLISECONDS);", "originalCommit": "e3fe89f2fb2e1d85b776cc157f8e8d162a905708", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0MzM5NQ==", "url": "https://github.com/googleapis/java-spanner/pull/524#discussion_r508143395", "bodyText": "Won't we have to wait 1 hour if the test hang for some reason (or do you think this should not happen)? Maybe a few minutes could be enough?", "author": "thiagotnunes", "createdAt": "2020-10-20T00:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyMTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE0Nzk2Ng==", "url": "https://github.com/googleapis/java-spanner/pull/524#discussion_r508147966", "bodyText": "Yeah I agree, there may be other test timeouts that get triggered if we make it so long. I will check with the team on what they think is an appropriate value.", "author": "skuruppu", "createdAt": "2020-10-20T01:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyMTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM5MDY2NQ==", "url": "https://github.com/googleapis/java-spanner/pull/524#discussion_r508390665", "bodyText": "I do wonder if this timeout is even necessary. @olavloite do you know if these long-running operation settings are respected by the OperationFuture?\n\nYes, as far as I can remember they are. The total timeout in the config is however 24 hours, so it will take a very long time before it actually times out with the default settings.", "author": "olavloite", "createdAt": "2020-10-20T10:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyMTI3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODg4NDkxNg==", "url": "https://github.com/googleapis/java-spanner/pull/524#discussion_r508884916", "bodyText": "Yup, I think it is set here:\n\n  \n    \n      java-spanner/google-cloud-spanner/src/main/java/com/google/cloud/spanner/admin/instance/v1/stub/InstanceAdminStubSettings.java\n    \n    \n        Lines 626 to 636\n      in\n      60dd9fb\n    \n    \n    \n    \n\n        \n          \n           .setPollingAlgorithm( \n        \n\n        \n          \n               OperationTimedPollAlgorithm.create( \n        \n\n        \n          \n                   RetrySettings.newBuilder() \n        \n\n        \n          \n                       .setInitialRetryDelay(Duration.ofMillis(20000L)) \n        \n\n        \n          \n                       .setRetryDelayMultiplier(1.5) \n        \n\n        \n          \n                       .setMaxRetryDelay(Duration.ofMillis(45000L)) \n        \n\n        \n          \n                       .setInitialRpcTimeout(Duration.ZERO) // ignored \n        \n\n        \n          \n                       .setRpcTimeoutMultiplier(1.0) // ignored \n        \n\n        \n          \n                       .setMaxRpcTimeout(Duration.ZERO) // ignored \n        \n\n        \n          \n                       .setTotalTimeout(Duration.ofMillis(86400000L)) \n        \n\n        \n          \n                       .build())); \n        \n    \n  \n\n\nSo I will remove this timeout altogether :)\nI think this makes sense given that's how we do op.get() in tests for backups and databases. We use the default settings from the config.", "author": "skuruppu", "createdAt": "2020-10-20T22:48:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyMTI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "32b15a76568d0aca181b493777da52dc56c8ef39", "chunk": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/IntegrationTestEnv.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/IntegrationTestEnv.java\nindex 89761e95..70702f5c 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/IntegrationTestEnv.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/IntegrationTestEnv.java\n\n@@ -126,7 +126,7 @@ public class IntegrationTestEnv extends ExternalResource {\n         instanceAdminClient.createInstance(instance);\n     Instance createdInstance;\n     try {\n-      createdInstance = op.get(3600000L, TimeUnit.MILLISECONDS);\n+      createdInstance = op.get();\n     } catch (Exception e) {\n       boolean cancelled = false;\n       try {\n"}}, {"oid": "32b15a76568d0aca181b493777da52dc56c8ef39", "url": "https://github.com/googleapis/java-spanner/commit/32b15a76568d0aca181b493777da52dc56c8ef39", "message": "test: remove explicit CreateInstance timeout\n\nUse the default settings for polling long-running operations instead.\nThis change is made to prevent test flakiness from having too short of a\ntimeout.", "committedDate": "2020-10-20T22:49:53Z", "type": "forcePushed"}, {"oid": "c2f8a4eb9d8bb47863129610144b2aa6eb4f970b", "url": "https://github.com/googleapis/java-spanner/commit/c2f8a4eb9d8bb47863129610144b2aa6eb4f970b", "message": "test: remove explicit CreateInstance timeout\n\nUse the default settings for polling long-running operations instead.\nThis change is made to prevent test flakiness from having too short of a\ntimeout.", "committedDate": "2020-10-21T00:56:18Z", "type": "commit"}, {"oid": "c2f8a4eb9d8bb47863129610144b2aa6eb4f970b", "url": "https://github.com/googleapis/java-spanner/commit/c2f8a4eb9d8bb47863129610144b2aa6eb4f970b", "message": "test: remove explicit CreateInstance timeout\n\nUse the default settings for polling long-running operations instead.\nThis change is made to prevent test flakiness from having too short of a\ntimeout.", "committedDate": "2020-10-21T00:56:18Z", "type": "forcePushed"}]}