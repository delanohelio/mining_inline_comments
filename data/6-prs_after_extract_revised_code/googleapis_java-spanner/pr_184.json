{"pr_number": 184, "pr_title": "tests: Attempt to fix random timeouts in ITBackup", "pr_createdAt": "2020-04-25T16:48:39Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/184", "timeline": [{"oid": "ddb81cf4a076d91e4815608e8e3622b3fa0c6d4d", "url": "https://github.com/googleapis/java-spanner/commit/ddb81cf4a076d91e4815608e8e3622b3fa0c6d4d", "message": "tests: attempt to fix timeouts of ITBackup", "committedDate": "2020-04-28T07:06:33Z", "type": "commit"}, {"oid": "492463a7f2f83383b21bf3f7fb1a0853e5a5851d", "url": "https://github.com/googleapis/java-spanner/commit/492463a7f2f83383b21bf3f7fb1a0853e5a5851d", "message": "fix: fix second timeout", "committedDate": "2020-04-28T07:06:33Z", "type": "commit"}, {"oid": "04a3629ad44c454eda310ff88e5e7801cf628f5b", "url": "https://github.com/googleapis/java-spanner/commit/04a3629ad44c454eda310ff88e5e7801cf628f5b", "message": "tests: add operation name to log", "committedDate": "2020-04-28T07:06:33Z", "type": "commit"}, {"oid": "be3c6b9c1fe46671bf2ea5ea96a4dcd34820e116", "url": "https://github.com/googleapis/java-spanner/commit/be3c6b9c1fe46671bf2ea5ea96a4dcd34820e116", "message": "tests: add additional logging to ITBackup", "committedDate": "2020-04-28T07:06:33Z", "type": "commit"}, {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f", "url": "https://github.com/googleapis/java-spanner/commit/c26d86cf71091a5a208bdb20b7f48716de78776f", "message": "tests: cancel long-running backup operations before test", "committedDate": "2020-04-28T07:06:33Z", "type": "commit"}, {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f", "url": "https://github.com/googleapis/java-spanner/commit/c26d86cf71091a5a208bdb20b7f48716de78776f", "message": "tests: cancel long-running backup operations before test", "committedDate": "2020-04-28T07:06:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwODEwOQ==", "url": "https://github.com/googleapis/java-spanner/pull/184#discussion_r416508109", "bodyText": "If for any reason in the future, the cancelling still doesn't work, your other option may be to just call delete on those backups. AFAIK, backups in the process of being created can be deleted.", "author": "skuruppu", "createdAt": "2020-04-28T10:34:08Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITBackupTest.java", "diffHunk": "@@ -93,6 +100,40 @@ public void setUp() throws Exception {\n     instanceAdminClient = testHelper.getClient().getInstanceAdminClient();\n     instance = instanceAdminClient.getInstance(testHelper.getInstanceId().getInstance());\n     logger.info(\"Finished setup\");\n+\n+    // Cancel any backup operation that has been started by this integration test if it has been\n+    // running for at least 6 hours.\n+    logger.info(\"Cancelling long-running test backup operations\");\n+    Pattern pattern = Pattern.compile(\".*/backups/testbck_\\\\d{6}_\\\\d{4}_bck\\\\d/operations/.*\");\n+    try {\n+      for (Operation operation :\n+          dbAdminClient.listBackupOperations(instance.getId().getInstance()).iterateAll()) {\n+        Matcher matcher = pattern.matcher(operation.getName());\n+        if (matcher.matches()) {\n+          if (!operation.getDone()) {\n+            Timestamp currentTime = Timestamp.now();\n+            Timestamp startTime =\n+                Timestamp.fromProto(\n+                    operation\n+                        .getMetadata()\n+                        .unpack(CreateBackupMetadata.class)\n+                        .getProgress()\n+                        .getStartTime());\n+            long diffSeconds = currentTime.getSeconds() - startTime.getSeconds();\n+            if (TimeUnit.HOURS.convert(diffSeconds, TimeUnit.SECONDS) >= 6L) {\n+              logger.warning(\n+                  String.format(\n+                      \"Cancelling test backup operation %s that was started at %s\",\n+                      operation.getName(), startTime.toString()));\n+              dbAdminClient.cancelOperation(operation.getName());", "originalCommit": "c26d86cf71091a5a208bdb20b7f48716de78776f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}