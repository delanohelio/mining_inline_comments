{"pr_number": 623, "pr_title": "feat: add support for tagging to Connection API", "pr_createdAt": "2020-11-13T17:20:08Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/623", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NjkxMw==", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r523856913", "bodyText": "How will this behave if the user never set a transaction tag?", "author": "thiagotnunes", "createdAt": "2020-11-16T01:55:17Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -959,6 +1034,7 @@ private UnitOfWork createNewUnitOfWork() {\n               .setReadOnlyStaleness(readOnlyStaleness)\n               .setStatementTimeout(statementTimeout)\n               .withStatementExecutor(statementExecutor)\n+              .setTransactionTag(transactionTag)", "originalCommit": "6fcbdd022d9bf610a437f237814e4147cf1106db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NjgxMA==", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524076810", "bodyText": "It is nullable, so that is not a problem. It is verified by this test case.", "author": "olavloite", "createdAt": "2020-11-16T10:17:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NjkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "a87dfdf0a66936504c50a8fd239891b8c544ab3a", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\nindex eb4fe96b..9f870302 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\n\n@@ -1040,6 +1105,7 @@ class ConnectionImpl implements Connection {\n           return ReadWriteTransaction.newBuilder()\n               .setDatabaseClient(dbClient)\n               .setRetryAbortsInternally(retryAbortsInternally)\n+              .setReturnCommitStats(returnCommitStats)\n               .setTransactionRetryListeners(transactionRetryListeners)\n               .setStatementTimeout(statementTimeout)\n               .withStatementExecutor(statementExecutor)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ==", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r523857065", "bodyText": "Out of curiosity, could we prevent the calling of this for a COMMIT? The user should not be able to do a statement tag in that case.", "author": "thiagotnunes", "createdAt": "2020-11-16T01:56:07Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -476,6 +482,42 @@ public void setTransactionMode(TransactionMode transactionMode) {\n     this.unitOfWorkType = UnitOfWorkType.of(transactionMode);\n   }\n \n+  @Override\n+  public String getTransactionTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return transactionTag;\n+  }\n+\n+  @Override\n+  public void setTransactionTag(String tag) {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Cannot set transaction tag while in a batch\");\n+    ConnectionPreconditions.checkState(isInTransaction(), \"This connection has no transaction\");\n+    ConnectionPreconditions.checkState(\n+        !isTransactionStarted(),\n+        \"The transaction tag cannot be set after the transaction has started\");\n+\n+    this.transactionBeginMarked = true;\n+    this.transactionTag = tag;\n+  }\n+\n+  @Override\n+  public String getStatementTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return statementTag;\n+  }\n+\n+  @Override\n+  public void setStatementTag(String tag) {", "originalCommit": "6fcbdd022d9bf610a437f237814e4147cf1106db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3OTUwNw==", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524079507", "bodyText": "Good question. We can't prevent it before the COMMIT, but we can throw an exception if COMMIT is called after a statement tag has been set, and I think that makes sense as we are quite strict in checking the order of other statements (e.g. you are only allowed to get a commit timestamp if you actually committed etc.).", "author": "olavloite", "createdAt": "2020-11-16T10:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1ODk0OQ==", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524258949", "bodyText": "I've changed the implementation to check for this, and to throw an error if the application tries to set a statement tag for a COMMIT or ROLLBACK statement. This change also adds a change relating to DML batches: DML batches can only include one statement tag, as the statements are sent as one ExecuteBatchDmlRequest, which only allows one statement tag. This statement tag must be set before calling START BATCH DML, e.g.\nSET STATEMENT_TAG = 'tag-1';\nSTART BATCH DML;\nINSERT INTO Singers (SingerId, Name) VALUES (1, 'Morrison');\nINSERT INTO Singers (SingerId, Name) VALUES (2, 'Pieterson');\nRUN BATCH;", "author": "olavloite", "createdAt": "2020-11-16T13:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "6c1416442b526fafa0481240fd0e21570f4772f8", "chunk": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\nindex eb4fe96b..ce339040 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java\n\n@@ -506,14 +545,16 @@ class ConnectionImpl implements Connection {\n   @Override\n   public String getStatementTag() {\n     ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n-    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Statement tags are not allowed inside a batch\");\n     return statementTag;\n   }\n \n   @Override\n   public void setStatementTag(String tag) {\n     ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n-    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Statement tags are not allowed inside a batch\");\n \n     this.statementTag = tag;\n   }\n"}}, {"oid": "a87dfdf0a66936504c50a8fd239891b8c544ab3a", "url": "https://github.com/googleapis/java-spanner/commit/a87dfdf0a66936504c50a8fd239891b8c544ab3a", "message": "feat: add support for tagging in Connection API", "committedDate": "2021-04-13T15:34:22Z", "type": "commit"}, {"oid": "6c1416442b526fafa0481240fd0e21570f4772f8", "url": "https://github.com/googleapis/java-spanner/commit/6c1416442b526fafa0481240fd0e21570f4772f8", "message": "fix: disallow statement tags for commit/rollback/run", "committedDate": "2021-04-13T15:34:24Z", "type": "commit"}, {"oid": "510fdb3a40deb15ab7cbff30d763ddde0fa47223", "url": "https://github.com/googleapis/java-spanner/commit/510fdb3a40deb15ab7cbff30d763ddde0fa47223", "message": "chore: cleanup after rebase", "committedDate": "2021-04-13T16:18:03Z", "type": "commit"}, {"oid": "510fdb3a40deb15ab7cbff30d763ddde0fa47223", "url": "https://github.com/googleapis/java-spanner/commit/510fdb3a40deb15ab7cbff30d763ddde0fa47223", "message": "chore: cleanup after rebase", "committedDate": "2021-04-13T16:18:03Z", "type": "forcePushed"}, {"oid": "d9f9ca872339187140a7e06917f6694f6ccc7b86", "url": "https://github.com/googleapis/java-spanner/commit/d9f9ca872339187140a7e06917f6694f6ccc7b86", "message": "test: add generated tests + cleanup", "committedDate": "2021-04-13T18:16:20Z", "type": "commit"}, {"oid": "2a6c635e5f154ca66051fcffd128ad8013af479d", "url": "https://github.com/googleapis/java-spanner/commit/2a6c635e5f154ca66051fcffd128ad8013af479d", "message": "build: add new methods to clirr", "committedDate": "2021-04-13T18:20:46Z", "type": "commit"}, {"oid": "0868a050d07e261f4b1a21575b53834071f0f4c7", "url": "https://github.com/googleapis/java-spanner/commit/0868a050d07e261f4b1a21575b53834071f0f4c7", "message": "fix: add default implementations for new methods", "committedDate": "2021-04-14T08:47:30Z", "type": "commit"}, {"oid": "df0b11d5229988ec25e61b377a9f8ef2a7dba900", "url": "https://github.com/googleapis/java-spanner/commit/df0b11d5229988ec25e61b377a9f8ef2a7dba900", "message": "Merge branch 'master' into connection-api-tagging", "committedDate": "2021-07-05T07:56:01Z", "type": "commit"}]}