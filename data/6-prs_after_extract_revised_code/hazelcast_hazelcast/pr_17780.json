{"pr_number": 17780, "pr_title": "Additional SQL expression tests [IMDG-144]", "pr_createdAt": "2020-10-28T11:31:20Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17780", "timeline": [{"oid": "4ddfc53a701753f3665317e8f9d7e8646c6f7854", "url": "https://github.com/hazelcast/hazelcast/commit/4ddfc53a701753f3665317e8f9d7e8646c6f7854", "message": "WIP", "committedDate": "2020-10-28T10:05:50Z", "type": "commit"}, {"oid": "574a396caecb809c66295d806ba443db2704f656", "url": "https://github.com/hazelcast/hazelcast/commit/574a396caecb809c66295d806ba443db2704f656", "message": "WIP", "committedDate": "2020-10-28T10:14:23Z", "type": "commit"}, {"oid": "c889c456aa09af15ade177c413183d7ee525e795", "url": "https://github.com/hazelcast/hazelcast/commit/c889c456aa09af15ade177c413183d7ee525e795", "message": "ABS", "committedDate": "2020-10-28T10:16:32Z", "type": "commit"}, {"oid": "95160fb990cdf973c56e435e524e798d094628df", "url": "https://github.com/hazelcast/hazelcast/commit/95160fb990cdf973c56e435e524e798d094628df", "message": "Double funcs", "committedDate": "2020-10-28T10:19:34Z", "type": "commit"}, {"oid": "b427b996a8cccc5abf8aa499397e7695d13e1223", "url": "https://github.com/hazelcast/hazelcast/commit/b427b996a8cccc5abf8aa499397e7695d13e1223", "message": "RAND", "committedDate": "2020-10-28T10:23:20Z", "type": "commit"}, {"oid": "88f092cea7eab4d8d9498c09e852ecc1e2788390", "url": "https://github.com/hazelcast/hazelcast/commit/88f092cea7eab4d8d9498c09e852ecc1e2788390", "message": "SIGN", "committedDate": "2020-10-28T11:13:36Z", "type": "commit"}, {"oid": "9c8479ec04bf58f05bfb50987a2df3b7eedd74b7", "url": "https://github.com/hazelcast/hazelcast/commit/9c8479ec04bf58f05bfb50987a2df3b7eedd74b7", "message": "Done", "committedDate": "2020-10-28T11:29:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NDQyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17780#discussion_r519774427", "bodyText": "What about naming this MockCatalogReader?", "author": "viliam-durina", "createdAt": "2020-11-09T12:35:46Z", "path": "hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/InferTypesTestSupport.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.calcite.validate.types;\n+\n+import com.hazelcast.sql.impl.calcite.validate.HazelcastSqlConformance;\n+import com.hazelcast.sql.impl.calcite.validate.HazelcastSqlValidator;\n+import com.hazelcast.sql.impl.calcite.validate.operators.HazelcastSqlTrimFunction;\n+import org.apache.calcite.config.CalciteConnectionConfig;\n+import org.apache.calcite.jdbc.CalciteSchema;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.rel.type.RelDataTypeField;\n+import org.apache.calcite.sql.SqlBasicCall;\n+import org.apache.calcite.sql.SqlCall;\n+import org.apache.calcite.sql.SqlCallBinding;\n+import org.apache.calcite.sql.SqlIdentifier;\n+import org.apache.calcite.sql.SqlNode;\n+import org.apache.calcite.sql.parser.SqlParserPos;\n+import org.apache.calcite.sql.type.SqlTypeName;\n+import org.apache.calcite.sql.validate.SqlMoniker;\n+import org.apache.calcite.sql.validate.SqlNameMatcher;\n+import org.apache.calcite.sql.validate.SqlNameMatchers;\n+import org.apache.calcite.sql.validate.SqlValidatorCatalogReader;\n+import org.apache.calcite.sql.validate.SqlValidatorTable;\n+\n+import java.util.List;\n+\n+public class InferTypesTestSupport {\n+    protected static RelDataType type(SqlTypeName typeName) {\n+        return HazelcastTypeFactory.INSTANCE.createSqlType(typeName);\n+    }\n+\n+    protected static RelDataType typeUnknown() {\n+        return HazelcastTypeFactory.INSTANCE.createUnknownType();\n+    }\n+\n+    protected static SqlCallBinding createBinding() {\n+        SqlParserPos parserPos = new SqlParserPos(0, 0);\n+        SqlCall call = new SqlBasicCall(new HazelcastSqlTrimFunction(), new SqlNode[0], parserPos);\n+\n+        HazelcastSqlValidator validator = new HazelcastSqlValidator(\n+            new CatalogReader(),\n+            HazelcastTypeFactory.INSTANCE,\n+            HazelcastSqlConformance.INSTANCE\n+        );\n+\n+        return new SqlCallBinding(validator, null, call);\n+    }\n+\n+    private static class CatalogReader implements SqlValidatorCatalogReader {", "originalCommit": "9c8479ec04bf58f05bfb50987a2df3b7eedd74b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc5ODg2MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17780#discussion_r519798860", "bodyText": "Renamed", "author": "devozerov", "createdAt": "2020-11-09T13:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NDQyNw=="}], "type": "inlineReview", "revised_code": {"commit": "059aef5eece8cee24b93ce1922d646a9aa5f41ce", "chunk": "diff --git a/hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/InferTypesTestSupport.java b/hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/InferTypesTestSupport.java\nindex 633431b790..0121741ea2 100644\n--- a/hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/InferTypesTestSupport.java\n+++ b/hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/InferTypesTestSupport.java\n\n@@ -52,7 +52,7 @@ public class InferTypesTestSupport {\n         SqlCall call = new SqlBasicCall(new HazelcastSqlTrimFunction(), new SqlNode[0], parserPos);\n \n         HazelcastSqlValidator validator = new HazelcastSqlValidator(\n-            new CatalogReader(),\n+            new MockCatalogReader(),\n             HazelcastTypeFactory.INSTANCE,\n             HazelcastSqlConformance.INSTANCE\n         );\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NTQ4MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17780#discussion_r519775481", "bodyText": "Might be better to use InferTypesTestSupport as a utility rather than as a superclass.", "author": "viliam-durina", "createdAt": "2020-11-09T12:37:39Z", "path": "hazelcast-sql/src/test/java/com/hazelcast/sql/impl/calcite/validate/types/ReplaceUnknownOperandTypeInferenceTest.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.sql.impl.calcite.validate.types;\n+\n+import com.hazelcast.test.HazelcastParallelClassRunner;\n+import com.hazelcast.test.annotation.ParallelJVMTest;\n+import com.hazelcast.test.annotation.QuickTest;\n+import org.apache.calcite.rel.type.RelDataType;\n+import org.apache.calcite.sql.SqlCallBinding;\n+import org.apache.calcite.sql.type.SqlTypeName;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+\n+import static junit.framework.TestCase.assertEquals;\n+\n+@RunWith(HazelcastParallelClassRunner.class)\n+@Category({QuickTest.class, ParallelJVMTest.class})\n+public class ReplaceUnknownOperandTypeInferenceTest extends InferTypesTestSupport {", "originalCommit": "9c8479ec04bf58f05bfb50987a2df3b7eedd74b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTgwMDgxNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17780#discussion_r519800816", "bodyText": "This is a common pattern that we use throughout IMDG - define \"*Support\" class and then extend it. I think both approaches are roughly equal - no big win, no big harm wrt each other.", "author": "devozerov", "createdAt": "2020-11-09T13:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NTQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM1NzA1MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17780#discussion_r520357051", "bodyText": "It will show if you try to use a method from another support class. Utility classes are more flexible.", "author": "viliam-durina", "createdAt": "2020-11-10T07:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc3NTQ4MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "059aef5eece8cee24b93ce1922d646a9aa5f41ce", "url": "https://github.com/hazelcast/hazelcast/commit/059aef5eece8cee24b93ce1922d646a9aa5f41ce", "message": "Rename catalog reader", "committedDate": "2020-11-09T13:10:10Z", "type": "commit"}]}