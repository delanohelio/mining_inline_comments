{"pr_number": 17364, "pr_title": "Add metric to check cloud used for deployment", "pr_createdAt": "2020-08-17T12:20:19Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17364", "timeline": [{"oid": "1c9463ee62e9e29dd4e93261ce5b3b4ed10d9752", "url": "https://github.com/hazelcast/hazelcast/commit/1c9463ee62e9e29dd4e93261ce5b3b4ed10d9752", "message": "Add metric to check cloud used for deployment", "committedDate": "2020-08-17T12:18:45Z", "type": "commit"}, {"oid": "ea12bc931589bf934396d79e5d287d0c444afb74", "url": "https://github.com/hazelcast/hazelcast/commit/ea12bc931589bf934396d79e5d287d0c444afb74", "message": "Used Path Interface for Hard Coded Paths", "committedDate": "2020-08-18T07:42:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MzQyMg==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472053422", "bodyText": "I think we can get by here without calling toFile() so that you don't have to go into that cumbersome mocking with PowerMockito. Path has a toRealPath() method which throws an IOException if the file doesn't exist. You can catch and use that exception.\nSame for the DOCKER_FILE_PATH existence check.", "author": "erosb", "createdAt": "2020-08-18T09:44:49Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.io.File;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.hazelcast.internal.util.EmptyStatement.ignore;\n+\n+public class CloudInfoCollector implements MetricsCollector {\n+    private static final int TIMEOUT = 1000;\n+    private static final int RESPONSE_OK = 200;\n+\n+    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n+    private String awsEndPoint;\n+    private String azureEndPoint;\n+    private String gcpEndPoint;\n+\n+    public CloudInfoCollector(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n+        awsEndPoint = awsEndpoint;\n+        azureEndPoint = azureEndpoint;\n+        gcpEndPoint = gcpEndpoint;\n+    }\n+\n+    public void modifyEndPoints(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n+        awsEndPoint = awsEndpoint;\n+        azureEndPoint = azureEndpoint;\n+        gcpEndPoint = gcpEndpoint;\n+    }\n+\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+\n+        Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+\n+        if (check(awsEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"A\");\n+        } else if (check(azureEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"Z\");\n+        } else if (check(gcpEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"G\");\n+        } else {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"-1\");\n+        }\n+\n+\n+        File dockerFile =DOCKER_FILE_PATH.toFile();\n+        if (dockerFile.exists()) {\n+            File kubernetesToken = KUBERNETES_TOKEN_PATH.toFile();", "originalCommit": "ea12bc931589bf934396d79e5d287d0c444afb74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "698a87984f7c8b02ae2ec68af906464373d19471", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex 87680d2cc7..700b00952f 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -17,25 +17,19 @@ package com.hazelcast.internal.util.phonehome;\n \n import com.hazelcast.instance.impl.Node;\n \n-import java.io.File;\n-import java.net.HttpURLConnection;\n-import java.net.URL;\n+import java.io.IOException;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.HashMap;\n import java.util.Map;\n \n-import static com.hazelcast.internal.util.EmptyStatement.ignore;\n-\n public class CloudInfoCollector implements MetricsCollector {\n-    private static final int TIMEOUT = 1000;\n-    private static final int RESPONSE_OK = 200;\n+    private final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n \n-    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n-    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n-    private String awsEndPoint;\n-    private String azureEndPoint;\n-    private String gcpEndPoint;\n+    private final String awsEndPoint;\n+    private final String azureEndPoint;\n+    private final String gcpEndPoint;\n \n     public CloudInfoCollector(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n         awsEndPoint = awsEndpoint;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1NTQ0NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472055445", "bodyText": "It would make more sense to define TIMEOUT as 2000 instead of multiplying 1000 at two places. Also, isn't it a duplicate of PhoneHome#fetchWebService() ? Please resolve the duplication, it isn't complicated in this case.", "author": "erosb", "createdAt": "2020-08-18T09:48:16Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+\n+import java.io.File;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.hazelcast.internal.util.EmptyStatement.ignore;\n+\n+public class CloudInfoCollector implements MetricsCollector {\n+    private static final int TIMEOUT = 1000;\n+    private static final int RESPONSE_OK = 200;\n+\n+    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n+    private String awsEndPoint;\n+    private String azureEndPoint;\n+    private String gcpEndPoint;\n+\n+    public CloudInfoCollector(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n+        awsEndPoint = awsEndpoint;\n+        azureEndPoint = azureEndpoint;\n+        gcpEndPoint = gcpEndpoint;\n+    }\n+\n+    public void modifyEndPoints(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n+        awsEndPoint = awsEndpoint;\n+        azureEndPoint = azureEndpoint;\n+        gcpEndPoint = gcpEndpoint;\n+    }\n+\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+\n+        Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+\n+        if (check(awsEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"A\");\n+        } else if (check(azureEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"Z\");\n+        } else if (check(gcpEndPoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"G\");\n+        } else {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"-1\");\n+        }\n+\n+\n+        File dockerFile =DOCKER_FILE_PATH.toFile();\n+        if (dockerFile.exists()) {\n+            File kubernetesToken = KUBERNETES_TOKEN_PATH.toFile();\n+            if (kubernetesToken.exists() && !kubernetesToken.isDirectory()) {\n+                environmentInfo.put(PhoneHomeMetrics.DOCKER, \"K\");\n+            } else {\n+                environmentInfo.put(PhoneHomeMetrics.DOCKER, \"D\");\n+            }\n+        } else {\n+            environmentInfo.put(PhoneHomeMetrics.DOCKER, \"N\");\n+        }\n+        return environmentInfo;\n+    }\n+\n+    private boolean check(String urlStr) {\n+        HttpURLConnection conn = null;\n+        boolean response;\n+        try {\n+            URL url = new URL(urlStr);\n+            conn = (HttpURLConnection) url.openConnection();\n+            conn.setConnectTimeout(TIMEOUT * 2);", "originalCommit": "ea12bc931589bf934396d79e5d287d0c444afb74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "698a87984f7c8b02ae2ec68af906464373d19471", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex 87680d2cc7..700b00952f 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -17,25 +17,19 @@ package com.hazelcast.internal.util.phonehome;\n \n import com.hazelcast.instance.impl.Node;\n \n-import java.io.File;\n-import java.net.HttpURLConnection;\n-import java.net.URL;\n+import java.io.IOException;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.HashMap;\n import java.util.Map;\n \n-import static com.hazelcast.internal.util.EmptyStatement.ignore;\n-\n public class CloudInfoCollector implements MetricsCollector {\n-    private static final int TIMEOUT = 1000;\n-    private static final int RESPONSE_OK = 200;\n+    private final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n \n-    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n-    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n-    private String awsEndPoint;\n-    private String azureEndPoint;\n-    private String gcpEndPoint;\n+    private final String awsEndPoint;\n+    private final String azureEndPoint;\n+    private final String gcpEndPoint;\n \n     public CloudInfoCollector(String awsEndpoint, String azureEndpoint, String gcpEndpoint) {\n         awsEndPoint = awsEndpoint;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1NzIwMw==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472057203", "bodyText": "Are you sure about the 400 status code? Can we somehow stub a \"connection refused\" scenario with wiremock? if we need to return a status code, it should be 404 anyway. But it would be better to cover the network error and the 4xx status code scenarios separately.", "author": "erosb", "createdAt": "2020-08-18T09:51:22Z", "path": "hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java", "diffHunk": "@@ -87,10 +108,7 @@ public void testMapMetrics() {\n         node.getConfig().getMapConfig(\"hazelcast\").getEvictionConfig().setEvictionPolicy(EvictionPolicy.LRU);\n         node.getConfig().getMapConfig(\"hazelcast\").setInMemoryFormat(InMemoryFormat.NATIVE);\n \n-        stubFor(get(urlPathEqualTo(\"/ping\"))\n-                .willReturn(aResponse()\n-                        .withStatus(200)));\n-\n+        stubUrls(200, 400, 400, 400);", "originalCommit": "ea12bc931589bf934396d79e5d287d0c444afb74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "698a87984f7c8b02ae2ec68af906464373d19471", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java b/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\nindex f6cb582281..5171b0f51d 100644\n--- a/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\n+++ b/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\n\n@@ -108,7 +113,7 @@ public class PhoneHomeIntegrationTest extends HazelcastTestSupport {\n         node.getConfig().getMapConfig(\"hazelcast\").getEvictionConfig().setEvictionPolicy(EvictionPolicy.LRU);\n         node.getConfig().getMapConfig(\"hazelcast\").setInMemoryFormat(InMemoryFormat.NATIVE);\n \n-        stubUrls(200, 400, 400, 400);\n+        stubUrls(\"200\", \"4XX\", \"4XX\", \"4XX\");\n         phoneHome.phoneHome(false);\n \n         verify(1, getRequestedFor(urlPathEqualTo(\"/ping\"))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1ODY0Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472058643", "bodyText": "Can we please avoid making the collector mutable? It would be one step better if we would not add it to the initial list (I mean line 56), but we would instantiate CloudInfoCollector only here, and add it to the metricsCollectorList.", "author": "erosb", "createdAt": "2020-08-18T09:53:54Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java", "diffHunk": "@@ -43,24 +43,29 @@\n \n     private static final String FALSE = \"false\";\n     private static final String DEFAULT_BASE_PHONE_HOME_URL = \"http://phonehome.hazelcast.com/ping\";\n+    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n+    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n+    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n \n     volatile ScheduledFuture<?> phoneHomeFuture;\n     private final ILogger logger;\n     private final String basePhoneHomeUrl;\n \n     private final Node hazelcastNode;\n+    private final CloudInfoCollector cloudInfoCollector = new CloudInfoCollector(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT);\n     private final List<MetricsCollector> metricsCollectorList = Arrays.asList(new BuildInfoCollector(),\n             new ClusterInfoCollector(), new ClientInfoCollector(), new MapInfoCollector(),\n-            new OSInfoCollector(), new DistributedObjectCounterCollector(), new CacheInfoCollector());\n+            new OSInfoCollector(), new DistributedObjectCounterCollector(), new CacheInfoCollector(), cloudInfoCollector);\n \n     public PhoneHome(Node node) {\n-        this(node, DEFAULT_BASE_PHONE_HOME_URL);\n+        this(node, DEFAULT_BASE_PHONE_HOME_URL, AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT);\n     }\n \n-    PhoneHome(Node node, String baseurl) {\n+    PhoneHome(Node node, String baseUrl, String awsEndPoint, String azureEndPoint, String gcpEndPoint) {\n         hazelcastNode = node;\n         logger = hazelcastNode.getLogger(com.hazelcast.internal.util.phonehome.PhoneHome.class);\n-        basePhoneHomeUrl = baseurl;\n+        basePhoneHomeUrl = baseUrl;\n+        cloudInfoCollector.modifyEndPoints(awsEndPoint, azureEndPoint, gcpEndPoint);", "originalCommit": "ea12bc931589bf934396d79e5d287d0c444afb74", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "698a87984f7c8b02ae2ec68af906464373d19471", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\nindex 4802b54bcb..18c5dab2bc 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\n\n@@ -52,10 +47,9 @@ public class PhoneHome {\n     private final String basePhoneHomeUrl;\n \n     private final Node hazelcastNode;\n-    private final CloudInfoCollector cloudInfoCollector = new CloudInfoCollector(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT);\n-    private final List<MetricsCollector> metricsCollectorList = Arrays.asList(new BuildInfoCollector(),\n-            new ClusterInfoCollector(), new ClientInfoCollector(), new MapInfoCollector(),\n-            new OSInfoCollector(), new DistributedObjectCounterCollector(), new CacheInfoCollector(), cloudInfoCollector);\n+    private final List<MetricsCollector> metricsCollectorList = new ArrayList<>(Arrays.asList(new BuildInfoCollector(),\n+            new ClusterInfoCollector(), new ClientInfoCollector(), new MapInfoCollector(), new OSInfoCollector(),\n+            new DistributedObjectCounterCollector(), new CacheInfoCollector()));\n \n     public PhoneHome(Node node) {\n         this(node, DEFAULT_BASE_PHONE_HOME_URL, AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT);\n"}}, {"oid": "698a87984f7c8b02ae2ec68af906464373d19471", "url": "https://github.com/hazelcast/hazelcast/commit/698a87984f7c8b02ae2ec68af906464373d19471", "message": "Improve the methods:", "committedDate": "2020-08-19T05:19:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NTM4MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472865380", "bodyText": "One design smell here is that awsEndPoint, azureEndPoint and gcpEndPoint are not exactly the dependencies of PhoneHome. They are dependencies of the CloudInfoCollector. So instead of passing these 3 arguments, a MetricsCollector ...additionalCollectors would be better (mind the varargs), so you pass a CloudInfoCollector instance directly. And that instance can be instantiated by the test and pass the testing endpoints. Also, once you make this change, you don't have to use PowerMockito magic to mock the Path instances: just parameterize the CloudInfoCollector, add 2 more Path parameters to its constructor, and then you can pass whatever Path mock you want from your test. Please let me know if it is unclear.", "author": "erosb", "createdAt": "2020-08-19T08:45:04Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java", "diffHunk": "@@ -43,24 +38,29 @@\n \n     private static final String FALSE = \"false\";\n     private static final String DEFAULT_BASE_PHONE_HOME_URL = \"http://phonehome.hazelcast.com/ping\";\n+    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n+    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n+    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n \n     volatile ScheduledFuture<?> phoneHomeFuture;\n     private final ILogger logger;\n     private final String basePhoneHomeUrl;\n \n     private final Node hazelcastNode;\n-    private final List<MetricsCollector> metricsCollectorList = Arrays.asList(new BuildInfoCollector(),\n-            new ClusterInfoCollector(), new ClientInfoCollector(), new MapInfoCollector(),\n-            new OSInfoCollector(), new DistributedObjectCounterCollector(), new CacheInfoCollector());\n+    private final List<MetricsCollector> metricsCollectorList = new ArrayList<>(Arrays.asList(new BuildInfoCollector(),\n+            new ClusterInfoCollector(), new ClientInfoCollector(), new MapInfoCollector(), new OSInfoCollector(),\n+            new DistributedObjectCounterCollector(), new CacheInfoCollector()));\n \n     public PhoneHome(Node node) {\n-        this(node, DEFAULT_BASE_PHONE_HOME_URL);\n+        this(node, DEFAULT_BASE_PHONE_HOME_URL, AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT);\n     }\n \n-    PhoneHome(Node node, String baseurl) {\n+    PhoneHome(Node node, String baseUrl, String awsEndPoint, String azureEndPoint, String gcpEndPoint) {", "originalCommit": "698a87984f7c8b02ae2ec68af906464373d19471", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e05d219a214d241b10357a12288e22d5aeb6495", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\nindex 18c5dab2bc..1ac4136bf2 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHome.java\n\n@@ -38,9 +38,7 @@ public class PhoneHome {\n \n     private static final String FALSE = \"false\";\n     private static final String DEFAULT_BASE_PHONE_HOME_URL = \"http://phonehome.hazelcast.com/ping\";\n-    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n-    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n-    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n+    private static final MetricsCollector CLOUD_INFO_COLLECTOR = new CloudInfoCollector();\n \n     volatile ScheduledFuture<?> phoneHomeFuture;\n     private final ILogger logger;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NjQxNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472866417", "bodyText": "Please document in javadoc what possible values (under what conditions) these metrics can take.", "author": "erosb", "createdAt": "2020-08-19T08:46:43Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHomeMetrics.java", "diffHunk": "@@ -74,7 +74,11 @@\n     COUNT_OF_REPLICATED_MAPS(\"rpct\"),\n     COUNT_OF_CARDINALITY_ESTIMATORS(\"cect\"),\n     COUNT_OF_PN_COUNTERS(\"pncct\"),\n-    COUNT_OF_FLAKE_ID_GENERATORS(\"figct\");\n+    COUNT_OF_FLAKE_ID_GENERATORS(\"figct\"),\n+\n+    //CLOUD METRICS\n+    CLOUD(\"cld\"),\n+    DOCKER(\"dck\");", "originalCommit": "698a87984f7c8b02ae2ec68af906464373d19471", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e05d219a214d241b10357a12288e22d5aeb6495", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHomeMetrics.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHomeMetrics.java\nindex 4c8e501544..d6c805ceeb 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHomeMetrics.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/PhoneHomeMetrics.java\n\n@@ -77,7 +77,16 @@ public enum PhoneHomeMetrics {\n     COUNT_OF_FLAKE_ID_GENERATORS(\"figct\"),\n \n     //CLOUD METRICS\n+    /*\n+     *  it is a notation of the cloud env, if its G means it mean GCP , A means AWS , Z means Azure\n+     */\n     CLOUD(\"cld\"),\n+    /*\n+     *  it is a notation of the docker container env, if its\n+     *   K means the member runs in Kubernetes,\n+     *   D means it runs in docker but not on kubernetes ,\n+     *   N means it doesn't run in docker\n+     */\n     DOCKER(\"dck\");\n \n     private final String query;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg4NDgxOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r472884819", "bodyText": "Please resolve these duplicate conditionals. Also, the method is called at 6 places, at 5 of them the parameter lists are the same - this is an other code smell. Please think about how to resolve these.", "author": "erosb", "createdAt": "2020-08-19T09:16:11Z", "path": "hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java", "diffHunk": "@@ -70,7 +71,32 @@\n     public void initialise() {\n         HazelcastInstance hz = createHazelcastInstance();\n         node = getNode(hz);\n-        phoneHome = new PhoneHome(node, \"http://localhost:8080/ping\");\n+        phoneHome = new PhoneHome(node,\n+                \"http://localhost:8080/ping\",\n+                \"http://localhost:8080/latest/meta-data\",\n+                \"http://localhost:8080/metadata/instance/compute?api-version=2018-02-01\",\n+                \"http://localhost:8080/metadata.google.internal\");\n+    }\n+\n+    public void stubUrls(String phoneHomeStatus, String awsStatus, String azureStatus, String gcpStatus) {\n+\n+        stubFor(get(urlPathEqualTo(\"/ping\"))\n+                .willReturn(phoneHomeStatus.equals(\"200\")\n+                        ? aResponse().withStatus(200)\n+                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+        stubFor(get(urlPathEqualTo(\"/latest/meta-data\"))\n+                .willReturn(awsStatus.equals(\"200\")\n+                        ? aResponse().withStatus(200)\n+                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+        stubFor(get(urlPathEqualTo(\"/metadata/instance/compute\"))\n+                .withQueryParam(\"api-version\", equalTo(\"2018-02-01\"))\n+                .willReturn(azureStatus.equals(\"200\")\n+                        ? aResponse().withStatus(200)\n+                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+        stubFor(get(urlPathEqualTo(\"/metadata.google.internal\"))\n+                .willReturn(gcpStatus.equals(\"200\")\n+                        ? aResponse().withStatus(200)\n+                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));", "originalCommit": "698a87984f7c8b02ae2ec68af906464373d19471", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e05d219a214d241b10357a12288e22d5aeb6495", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java b/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\nindex 5171b0f51d..384c007678 100644\n--- a/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\n+++ b/hazelcast/src/test/java/com/hazelcast/internal/util/phonehome/PhoneHomeIntegrationTest.java\n\n@@ -67,53 +64,60 @@ public class PhoneHomeIntegrationTest extends HazelcastTestSupport {\n     private Node node;\n     private PhoneHome phoneHome;\n \n+    @Mock\n+    private Path kubernetesTokenPath;\n+\n+    @Mock\n+    private Path dockerPath;\n+\n     @Before\n-    public void initialise() {\n+    public void initialise() throws IOException {\n+        MockitoAnnotations.initMocks(this);\n         HazelcastInstance hz = createHazelcastInstance();\n         node = getNode(hz);\n-        phoneHome = new PhoneHome(node,\n-                \"http://localhost:8080/ping\",\n-                \"http://localhost:8080/latest/meta-data\",\n+\n+        when(dockerPath.toRealPath()).thenReturn(Paths.get(System.getProperty(\"user.dir\")));\n+        when(kubernetesTokenPath.toRealPath()).thenReturn(Paths.get(System.getProperty(\"user.dir\")));\n+\n+        MetricsCollector cloudInfoCollector = new CloudInfoCollector(\"http://localhost:8080/latest/meta-data\",\n                 \"http://localhost:8080/metadata/instance/compute?api-version=2018-02-01\",\n-                \"http://localhost:8080/metadata.google.internal\");\n+                \"http://localhost:8080/metadata.google.internal\", kubernetesTokenPath, dockerPath);\n+\n+        phoneHome = new PhoneHome(node, \"http://localhost:8080/ping\", cloudInfoCollector);\n+        stubUrls(\"200\", \"4XX\", \"4XX\", \"4XX\");\n     }\n \n     public void stubUrls(String phoneHomeStatus, String awsStatus, String azureStatus, String gcpStatus) {\n-\n         stubFor(get(urlPathEqualTo(\"/ping\"))\n-                .willReturn(phoneHomeStatus.equals(\"200\")\n-                        ? aResponse().withStatus(200)\n-                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+                .willReturn(checkStatusConditional(phoneHomeStatus.equals(\"200\"))));\n         stubFor(get(urlPathEqualTo(\"/latest/meta-data\"))\n-                .willReturn(awsStatus.equals(\"200\")\n-                        ? aResponse().withStatus(200)\n-                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+                .willReturn(checkStatusConditional(awsStatus.equals(\"200\"))));\n         stubFor(get(urlPathEqualTo(\"/metadata/instance/compute\"))\n                 .withQueryParam(\"api-version\", equalTo(\"2018-02-01\"))\n-                .willReturn(azureStatus.equals(\"200\")\n-                        ? aResponse().withStatus(200)\n-                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+                .willReturn(checkStatusConditional(azureStatus.equals(\"200\"))));\n         stubFor(get(urlPathEqualTo(\"/metadata.google.internal\"))\n-                .willReturn(gcpStatus.equals(\"200\")\n-                        ? aResponse().withStatus(200)\n-                        : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER)));\n+                .willReturn(checkStatusConditional(gcpStatus.equals(\"200\"))));\n+    }\n+\n+    private ResponseDefinitionBuilder checkStatusConditional(boolean condition) {\n+        return condition ? aResponse().withStatus(200) : aResponse().withFault(Fault.CONNECTION_RESET_BY_PEER);\n     }\n \n     @Test()\n     public void testMapMetrics() {\n-        IMap<String, String> map1 = node.hazelcastInstance.getMap(\"hazelcast\");\n-        IMap<String, String> map2 = node.hazelcastInstance.getMap(\"phonehome\");\n-        node.getConfig().getMapConfig(\"hazelcast\").setReadBackupData(true);\n-        node.getConfig().getMapConfig(\"phonehome\").getMapStoreConfig().setClassName(DelayMapStore.class.getName()).setEnabled(true);\n-        node.getConfig().getMapConfig(\"hazelcast\").addQueryCacheConfig(new QueryCacheConfig(\"queryconfig\"));\n-        node.getConfig().getMapConfig(\"hazelcast\").getHotRestartConfig().setEnabled(true);\n-        node.getConfig().getMapConfig(\"hazelcast\").getIndexConfigs().add(new IndexConfig().setName(\"index\"));\n-        node.getConfig().getMapConfig(\"hazelcast\").setWanReplicationRef(new WanReplicationRef().setName(\"wan\"));\n-        node.getConfig().getMapConfig(\"hazelcast\").getAttributeConfigs().add(new AttributeConfig(\"hz\", AttributeExtractor.class.getName()));\n-        node.getConfig().getMapConfig(\"hazelcast\").getEvictionConfig().setEvictionPolicy(EvictionPolicy.LRU);\n-        node.getConfig().getMapConfig(\"hazelcast\").setInMemoryFormat(InMemoryFormat.NATIVE);\n+        node.hazelcastInstance.getMap(\"hazelcast\");\n+        node.hazelcastInstance.getMap(\"phonehome\");\n+        MapConfig config = node.getConfig().getMapConfig(\"hazelcast\");\n+        config.setReadBackupData(true);\n+        config.getMapStoreConfig().setClassName(DelayMapStore.class.getName()).setEnabled(true);\n+        config.addQueryCacheConfig(new QueryCacheConfig(\"queryconfig\"));\n+        config.getHotRestartConfig().setEnabled(true);\n+        config.getIndexConfigs().add(new IndexConfig().setName(\"index\"));\n+        config.setWanReplicationRef(new WanReplicationRef().setName(\"wan\"));\n+        config.getAttributeConfigs().add(new AttributeConfig(\"hz\", AttributeExtractor.class.getName()));\n+        config.getEvictionConfig().setEvictionPolicy(EvictionPolicy.LRU);\n+        config.setInMemoryFormat(InMemoryFormat.NATIVE);\n \n-        stubUrls(\"200\", \"4XX\", \"4XX\", \"4XX\");\n         phoneHome.phoneHome(false);\n \n         verify(1, getRequestedFor(urlPathEqualTo(\"/ping\"))\n"}}, {"oid": "8e05d219a214d241b10357a12288e22d5aeb6495", "url": "https://github.com/hazelcast/hazelcast/commit/8e05d219a214d241b10357a12288e22d5aeb6495", "message": "Improve the methods using metric collector object", "committedDate": "2020-08-19T12:30:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAwMDA3Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r473000073", "bodyText": "Let's denote the no-cloud case with N , please, so that it is in sync with the notation of dck below.", "author": "erosb", "createdAt": "2020-08-19T12:44:58Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+@SuppressFBWarnings\n+public class CloudInfoCollector implements MetricsCollector {\n+\n+    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n+    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n+    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n+    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n+\n+    private final String awsEndpoint;\n+    private final String azureEndpoint;\n+    private final String gcpEndpoint;\n+    private final Path kubernetesTokenPath;\n+    private final Path dockerFilePath;\n+\n+    public CloudInfoCollector() {\n+        this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n+    }\n+\n+    public CloudInfoCollector(String awsEndPoint, String azureEndPoint, String gcpEndPoint, Path kubernetesTokenpath,\n+                              Path dockerFilepath) {\n+        awsEndpoint = awsEndPoint;\n+        azureEndpoint = azureEndPoint;\n+        gcpEndpoint = gcpEndPoint;\n+        kubernetesTokenPath = kubernetesTokenpath;\n+        dockerFilePath = dockerFilepath;\n+    }\n+\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+\n+        Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+        if (MetricsCollector.fetchWebService(awsEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"A\");\n+        } else if (MetricsCollector.fetchWebService(azureEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"Z\");\n+        } else if (MetricsCollector.fetchWebService(gcpEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"G\");\n+        } else {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"-1\");", "originalCommit": "8e05d219a214d241b10357a12288e22d5aeb6495", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a20efcba4c1a317f8739e654a060627304f27f3c", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex 0a98073d48..15b13f9209 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -39,6 +39,8 @@ public class CloudInfoCollector implements MetricsCollector {\n     private final Path kubernetesTokenPath;\n     private final Path dockerFilePath;\n \n+    private final Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+\n     public CloudInfoCollector() {\n         this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAwNTgxNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r473005814", "bodyText": "It would be good to improve this class so that it determines the environment only once. I mean, once a node is started, I think we can assume that it always runs in the same environment. That means there is no need to call these HTTP endpoints every time when the phonehome service runs (which means once per day). It is sufficient to determine this metric only once, and return the same value when the service is called next time. Can you please add this memoization as an improvement?", "author": "erosb", "createdAt": "2020-08-19T12:54:21Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+@SuppressFBWarnings\n+public class CloudInfoCollector implements MetricsCollector {\n+\n+    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n+    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n+    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n+    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n+\n+    private final String awsEndpoint;\n+    private final String azureEndpoint;\n+    private final String gcpEndpoint;\n+    private final Path kubernetesTokenPath;\n+    private final Path dockerFilePath;\n+\n+    public CloudInfoCollector() {\n+        this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n+    }\n+\n+    public CloudInfoCollector(String awsEndPoint, String azureEndPoint, String gcpEndPoint, Path kubernetesTokenpath,\n+                              Path dockerFilepath) {\n+        awsEndpoint = awsEndPoint;\n+        azureEndpoint = azureEndPoint;\n+        gcpEndpoint = gcpEndPoint;\n+        kubernetesTokenPath = kubernetesTokenpath;\n+        dockerFilePath = dockerFilepath;\n+    }\n+\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+\n+        Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+        if (MetricsCollector.fetchWebService(awsEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"A\");\n+        } else if (MetricsCollector.fetchWebService(azureEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"Z\");\n+        } else if (MetricsCollector.fetchWebService(gcpEndpoint)) {\n+            environmentInfo.put(PhoneHomeMetrics.CLOUD, \"G\");", "originalCommit": "8e05d219a214d241b10357a12288e22d5aeb6495", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a20efcba4c1a317f8739e654a060627304f27f3c", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex 0a98073d48..15b13f9209 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -39,6 +39,8 @@ public class CloudInfoCollector implements MetricsCollector {\n     private final Path kubernetesTokenPath;\n     private final Path dockerFilePath;\n \n+    private final Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+\n     public CloudInfoCollector() {\n         this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n     }\n"}}, {"oid": "a20efcba4c1a317f8739e654a060627304f27f3c", "url": "https://github.com/hazelcast/hazelcast/commit/a20efcba4c1a317f8739e654a060627304f27f3c", "message": "Improve the environment info using memoisation", "committedDate": "2020-08-19T14:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEzMjU5OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r473132599", "bodyText": "Please make this class package-private (including its constructors). Also please double-check if all Collector implementations are package-private", "author": "erosb", "createdAt": "2020-08-19T15:50:33Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+@SuppressFBWarnings\n+public class CloudInfoCollector implements MetricsCollector {", "originalCommit": "a20efcba4c1a317f8739e654a060627304f27f3c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "01cef8c9c8d4bce404993f25f4429746b59e81f5", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex 15b13f9209..d27246939f 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -25,7 +25,7 @@ import java.util.HashMap;\n import java.util.Map;\n \n @SuppressFBWarnings\n-public class CloudInfoCollector implements MetricsCollector {\n+class CloudInfoCollector implements MetricsCollector {\n \n     private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n     private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n"}}, {"oid": "01cef8c9c8d4bce404993f25f4429746b59e81f5", "url": "https://github.com/hazelcast/hazelcast/commit/01cef8c9c8d4bce404993f25f4429746b59e81f5", "message": "Make collector implementations package private", "committedDate": "2020-08-19T15:54:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE0MzIwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17364#discussion_r473143204", "bodyText": "This is overcomplicated. It would be much simpler if the environmentInfo would be null on intialization, so you would only have to do a null check here, and assign a value to the field only after this check.", "author": "erosb", "createdAt": "2020-08-19T16:06:46Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.hazelcast.internal.util.phonehome;\n+\n+import com.hazelcast.instance.impl.Node;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+@SuppressFBWarnings\n+class CloudInfoCollector implements MetricsCollector {\n+\n+    private static final String AWS_ENDPOINT = \"http://169.254.169.254/latest/meta-data\";\n+    private static final String AZURE_ENDPOINT = \" http://169.254.169.254/metadata/instance/compute?api-version=2018-02-01\";\n+    private static final String GCP_ENDPOINT = \" http://metadata.google.internal\";\n+    private static final Path KUBERNETES_TOKEN_PATH = Paths.get(\"/var/run/secrets/kubernetes.io/serviceaccount/token\");\n+    private static final Path DOCKER_FILE_PATH = Paths.get(\"/.dockerenv\");\n+\n+    private final String awsEndpoint;\n+    private final String azureEndpoint;\n+    private final String gcpEndpoint;\n+    private final Path kubernetesTokenPath;\n+    private final Path dockerFilePath;\n+\n+    private final Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+\n+    public CloudInfoCollector() {\n+        this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n+    }\n+\n+    public CloudInfoCollector(String awsEndPoint, String azureEndPoint, String gcpEndPoint, Path kubernetesTokenpath,\n+                              Path dockerFilepath) {\n+        awsEndpoint = awsEndPoint;\n+        azureEndpoint = azureEndPoint;\n+        gcpEndpoint = gcpEndPoint;\n+        kubernetesTokenPath = kubernetesTokenpath;\n+        dockerFilePath = dockerFilepath;\n+    }\n+\n+    public Map<PhoneHomeMetrics, String> computeMetrics(Node hazelcastNode) {\n+\n+        if (environmentInfo.containsKey(PhoneHomeMetrics.CLOUD) && environmentInfo.containsKey(PhoneHomeMetrics.DOCKER)) {", "originalCommit": "01cef8c9c8d4bce404993f25f4429746b59e81f5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "08c5019a9b28e842ea1a4ce4af3e8a02d71ba2b6", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\nindex d27246939f..98bdf12fa7 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/phonehome/CloudInfoCollector.java\n\n@@ -39,7 +39,7 @@ class CloudInfoCollector implements MetricsCollector {\n     private final Path kubernetesTokenPath;\n     private final Path dockerFilePath;\n \n-    private final Map<PhoneHomeMetrics, String> environmentInfo = new HashMap<>();\n+    private Map<PhoneHomeMetrics, String> environmentInfo;\n \n     public CloudInfoCollector() {\n         this(AWS_ENDPOINT, AZURE_ENDPOINT, GCP_ENDPOINT, KUBERNETES_TOKEN_PATH, DOCKER_FILE_PATH);\n"}}, {"oid": "08c5019a9b28e842ea1a4ce4af3e8a02d71ba2b6", "url": "https://github.com/hazelcast/hazelcast/commit/08c5019a9b28e842ea1a4ce4af3e8a02d71ba2b6", "message": "Add null initialisation to map\n\ncorrected the initialisation", "committedDate": "2020-08-19T18:33:25Z", "type": "commit"}, {"oid": "08c5019a9b28e842ea1a4ce4af3e8a02d71ba2b6", "url": "https://github.com/hazelcast/hazelcast/commit/08c5019a9b28e842ea1a4ce4af3e8a02d71ba2b6", "message": "Add null initialisation to map\n\ncorrected the initialisation", "committedDate": "2020-08-19T18:33:25Z", "type": "forcePushed"}, {"oid": "9c02f6104d626dcc2885d353352b439ecca03811", "url": "https://github.com/hazelcast/hazelcast/commit/9c02f6104d626dcc2885d353352b439ecca03811", "message": "Removed thread and concurrency issues along with code refacor", "committedDate": "2020-08-24T16:14:35Z", "type": "commit"}, {"oid": "fc3e9b4e8d832b261d8f82a882f93a8f5fc78545", "url": "https://github.com/hazelcast/hazelcast/commit/fc3e9b4e8d832b261d8f82a882f93a8f5fc78545", "message": "Made global map to be volatile for synchronistaion", "committedDate": "2020-08-24T17:42:17Z", "type": "commit"}, {"oid": "414369dc464eae47d05b675ab99a25dcbb346359", "url": "https://github.com/hazelcast/hazelcast/commit/414369dc464eae47d05b675ab99a25dcbb346359", "message": "Removed empty lines from methods", "committedDate": "2020-08-24T18:28:11Z", "type": "commit"}, {"oid": "71a15ee5ce3327043d851c29d5e15fd22ecb7b6f", "url": "https://github.com/hazelcast/hazelcast/commit/71a15ee5ce3327043d851c29d5e15fd22ecb7b6f", "message": "Used varargs in constructor of Phonehome", "committedDate": "2020-08-25T03:41:37Z", "type": "commit"}]}