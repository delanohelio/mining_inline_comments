{"pr_number": 18024, "pr_title": "Fix testOperationsContinueWhenClientDisconnected", "pr_createdAt": "2020-12-30T13:11:35Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/18024", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQ5MTYwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/18024#discussion_r550491604", "bodyText": "We can use the getConnection(UUID uuid) here instead of iterating over the active connections. Also, there is a possible leftover System.out.println below", "author": "mdumandag", "createdAt": "2020-12-31T14:15:08Z", "path": "hazelcast/src/test/java/com/hazelcast/client/test/ClientTestSupport.java", "diffHunk": "@@ -82,6 +85,18 @@ protected HazelcastClientInstanceImpl getHazelcastClientInstanceImpl(HazelcastIn\n         return clientProxy.client;\n     }\n \n+    protected void makeSureDisconnectedFromServer(final HazelcastInstance client, UUID memberUUID) {\n+        assertTrueEventually(() -> {\n+            ClientConnectionManager connectionManager = getHazelcastClientInstanceImpl(client).getConnectionManager();", "originalCommit": "1590ad322ccf9153cfd7bc3ac77985b4757f9bc5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f16f0c989cc44d7e3c20e0bd0f5035b4ca8c36a3", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/client/test/ClientTestSupport.java b/hazelcast/src/test/java/com/hazelcast/client/test/ClientTestSupport.java\nindex e85d0cc4b3a..c077c57b7fa 100644\n--- a/hazelcast/src/test/java/com/hazelcast/client/test/ClientTestSupport.java\n+++ b/hazelcast/src/test/java/com/hazelcast/client/test/ClientTestSupport.java\n\n@@ -88,12 +87,7 @@ public class ClientTestSupport extends HazelcastTestSupport {\n     protected void makeSureDisconnectedFromServer(final HazelcastInstance client, UUID memberUUID) {\n         assertTrueEventually(() -> {\n             ClientConnectionManager connectionManager = getHazelcastClientInstanceImpl(client).getConnectionManager();\n-            for (ClientConnection activeConnection : connectionManager.getActiveConnections()) {\n-                TcpClientConnection tcpClientConnection = (TcpClientConnection) activeConnection;\n-                UUID remoteUuid = tcpClientConnection.getRemoteUuid();\n-                System.out.println(remoteUuid + \" == \" + memberUUID);\n-                assertNotEquals(remoteUuid, memberUUID);\n-            }\n+            assertNull(connectionManager.getConnection(memberUUID));\n         });\n     }\n \n"}}, {"oid": "f16f0c989cc44d7e3c20e0bd0f5035b4ca8c36a3", "url": "https://github.com/hazelcast/hazelcast/commit/f16f0c989cc44d7e3c20e0bd0f5035b4ca8c36a3", "message": "Fix testOperationsContinueWhenClientDisconnected\n\nI have found one way that this test can fail.\nHere the scenario:\n1. Client is about to do a put after first instance is closed.\n2. Partition table is not set yet. Client retries the operations\non random connections.\n3. The connection to the first instance is not closed on the\nclient side yet.\n\nWhen all the planets aligned, it is possible for this test to fail.\nThe logs on the failed issue does not disprove this, though\nwe are not sure if this is the real scenario.\n\nI have added a fix to test to make sure the client will not fail\nbecause of the found scenario.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17841", "committedDate": "2021-01-04T06:57:56Z", "type": "commit"}, {"oid": "f16f0c989cc44d7e3c20e0bd0f5035b4ca8c36a3", "url": "https://github.com/hazelcast/hazelcast/commit/f16f0c989cc44d7e3c20e0bd0f5035b4ca8c36a3", "message": "Fix testOperationsContinueWhenClientDisconnected\n\nI have found one way that this test can fail.\nHere the scenario:\n1. Client is about to do a put after first instance is closed.\n2. Partition table is not set yet. Client retries the operations\non random connections.\n3. The connection to the first instance is not closed on the\nclient side yet.\n\nWhen all the planets aligned, it is possible for this test to fail.\nThe logs on the failed issue does not disprove this, though\nwe are not sure if this is the real scenario.\n\nI have added a fix to test to make sure the client will not fail\nbecause of the found scenario.\n\nfixes https://github.com/hazelcast/hazelcast/issues/17841", "committedDate": "2021-01-04T06:57:56Z", "type": "forcePushed"}]}