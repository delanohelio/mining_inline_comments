{"pr_number": 16682, "pr_title": "Remove OAHashSet from merkle trees", "pr_createdAt": "2020-02-24T14:55:52Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16682", "timeline": [{"oid": "c2dd2d1f8942d050360be9ef98f1f11533c965f6", "url": "https://github.com/hazelcast/hazelcast/commit/c2dd2d1f8942d050360be9ef98f1f11533c965f6", "message": "Remove OAHashSet", "committedDate": "2020-05-24T14:31:59Z", "type": "forcePushed"}, {"oid": "d7ea324d0dc118d0b4c578b2258d167847ba98a4", "url": "https://github.com/hazelcast/hazelcast/commit/d7ea324d0dc118d0b4c578b2258d167847ba98a4", "message": "Remove OAHashSet", "committedDate": "2020-06-29T13:47:34Z", "type": "forcePushed"}, {"oid": "c009f562c566d61c0d0cc9756ffad49b165bc48a", "url": "https://github.com/hazelcast/hazelcast/commit/c009f562c566d61c0d0cc9756ffad49b165bc48a", "message": "Address review comments", "committedDate": "2020-07-01T15:40:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1NzUzMw==", "url": "https://github.com/hazelcast/hazelcast/pull/16682#discussion_r448457533", "bodyText": "It was really nice seeing the footprint no longer increases with entry count.", "author": "mmedenjak", "createdAt": "2020-07-01T15:49:53Z", "path": "hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java", "diffHunk": "@@ -67,11 +60,11 @@ public void testFootprint() {\n             merkleTree2.updateAdd(i, i);\n         }\n \n-        assertTrue(merkleTree2.footprint() > merkleTree1.footprint());\n+        assertEquals(merkleTree2.footprint(), merkleTree1.footprint());", "originalCommit": "c009f562c566d61c0d0cc9756ffad49b165bc48a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "13e98001813a4b4429c3b5fc93a0605e1e6968a6", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java b/hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java\nindex 96f3907a1fd..917e520c5d5 100644\n--- a/hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java\n+++ b/hazelcast/src/test/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTreeTest.java\n\n@@ -60,11 +61,11 @@ public class ArrayMerkleTreeTest {\n             merkleTree2.updateAdd(i, i);\n         }\n \n-        assertEquals(merkleTree2.footprint(), merkleTree1.footprint());\n+        assertTrue(merkleTree2.footprint() > merkleTree1.footprint());\n     }\n \n     @Test\n-    public void testFootprintDoesNotChange() {\n+    public void testFootprintChanges() {\n         MerkleTree merkleTree = new ArrayMerkleTree(3);\n \n         long footprintBeforeAdd = merkleTree.footprint();\n"}}, {"oid": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "url": "https://github.com/hazelcast/hazelcast/commit/8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "message": "Checkstyle", "committedDate": "2020-07-03T14:56:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Mzc3Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/16682#discussion_r450873776", "bodyText": "I think we don't have this anymore since leafKeys is removed", "author": "blazember", "createdAt": "2020-07-07T13:42:40Z", "path": "hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java", "diffHunk": "@@ -81,32 +80,29 @@\n  * {@link MerkleTreeUtil#sumHash(int, int)}\n  */\n public class ArrayMerkleTree extends AbstractMerkleTreeView implements MerkleTree {\n-    private final OAHashSet<Object>[] leafKeys;\n     private final int leafLevel;\n \n     /**\n-     * Footprint holds the total memory footprint of the Merkle tree and\n-     * the leaf data blocks.\n-     * <p>\n-     * Note that this field leverages a single-writer and a non-atomic\n-     * operation is executed on the field. See {@link #adjustFootprintWithLeafKeySetChange}\n+     * Footprint holds the total memory footprint of the Merkle tree.\n      */\n-    private volatile long footprint;\n+    private final long footprint;\n \n-    @SuppressWarnings(\"unchecked\")\n     public ArrayMerkleTree(int depth) {\n         super(depth);\n-\n         this.leafLevel = depth - 1;\n-\n-        final int leaves = MerkleTreeUtil.getNodesOnLevel(leafLevel);\n-\n-        leafKeys = new OAHashSet[leaves];\n-        for (int i = 0; i < leaves; i++) {\n-            leafKeys[i] = new OAHashSet<Object>(1);\n-        }\n-\n-        initializeFootprint();\n+        this.footprint = INT_SIZE_IN_BYTES * tree.length\n+                // reference to the tree\n+                + REFERENCE_COST_IN_BYTES\n+                // reference to leafKeys array", "originalCommit": "8ee677389d9a21defcaec3dfa05e0b1bd69a5cae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjExNDgzNA==", "url": "https://github.com/hazelcast/hazelcast/pull/16682#discussion_r452114834", "bodyText": "Removed.", "author": "mmedenjak", "createdAt": "2020-07-09T10:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg3Mzc3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "13e98001813a4b4429c3b5fc93a0605e1e6968a6", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java b/hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java\nindex a6a68c2cd45..126ea29b0cc 100644\n--- a/hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java\n+++ b/hazelcast/src/main/java/com/hazelcast/wan/impl/merkletree/ArrayMerkleTree.java\n\n@@ -91,18 +92,12 @@ public class ArrayMerkleTree extends AbstractMerkleTreeView implements MerkleTre\n         super(depth);\n         this.leafLevel = depth - 1;\n         this.footprint = INT_SIZE_IN_BYTES * tree.length\n-                // reference to the tree\n-                + REFERENCE_COST_IN_BYTES\n-                // reference to leafKeys array\n-                + REFERENCE_COST_IN_BYTES\n-                // depth\n-                + INT_SIZE_IN_BYTES\n-                // leafLevelOrder\n-                + INT_SIZE_IN_BYTES\n-                // leafLevel\n-                + INT_SIZE_IN_BYTES\n-                // footprint;\n-                + LONG_SIZE_IN_BYTES;\n+                + REFERENCE_COST_IN_BYTES // reference to the tree\n+                + REFERENCE_COST_IN_BYTES // reference to leafKeys array\n+                + INT_SIZE_IN_BYTES // depth\n+                + INT_SIZE_IN_BYTES // leafLevelOrder\n+                + INT_SIZE_IN_BYTES // leafLevel\n+                + LONG_SIZE_IN_BYTES; // footprint;\n     }\n \n     @Override\n"}}, {"oid": "13e98001813a4b4429c3b5fc93a0605e1e6968a6", "url": "https://github.com/hazelcast/hazelcast/commit/13e98001813a4b4429c3b5fc93a0605e1e6968a6", "message": "Remove OAHashSet", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "8a2c4b1b73db592e61c495c984d002ee86637dcd", "url": "https://github.com/hazelcast/hazelcast/commit/8a2c4b1b73db592e61c495c984d002ee86637dcd", "message": "Remove OAHashSet", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "81703254b918f8346ad8fd4ebfd247c38bffc7f8", "url": "https://github.com/hazelcast/hazelcast/commit/81703254b918f8346ad8fd4ebfd247c38bffc7f8", "message": "Fix compile error", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "e5e5d573843ba742f0d414022ae0bb301b51a9dd", "url": "https://github.com/hazelcast/hazelcast/commit/e5e5d573843ba742f0d414022ae0bb301b51a9dd", "message": "Checkstyle", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "31005b4298b4fcbe1e5025e2ebecd8ef6dfe2635", "url": "https://github.com/hazelcast/hazelcast/commit/31005b4298b4fcbe1e5025e2ebecd8ef6dfe2635", "message": "Address review comments", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "7ba131aa542893dd126455019c33e5f6ceb2c4a4", "url": "https://github.com/hazelcast/hazelcast/commit/7ba131aa542893dd126455019c33e5f6ceb2c4a4", "message": "Checkstyle", "committedDate": "2020-07-09T09:03:23Z", "type": "commit"}, {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a", "url": "https://github.com/hazelcast/hazelcast/commit/5750448f8666c08e55af8ae659ef494c5f2e735a", "message": "Address review comment", "committedDate": "2020-07-09T09:18:48Z", "type": "commit"}, {"oid": "5750448f8666c08e55af8ae659ef494c5f2e735a", "url": "https://github.com/hazelcast/hazelcast/commit/5750448f8666c08e55af8ae659ef494c5f2e735a", "message": "Address review comment", "committedDate": "2020-07-09T09:18:48Z", "type": "forcePushed"}, {"oid": "095da92329f7cf9356692b92fd125c18289dacae", "url": "https://github.com/hazelcast/hazelcast/commit/095da92329f7cf9356692b92fd125c18289dacae", "message": "Merge branch 'master' into 4.0-wan-remove-oahashset", "committedDate": "2020-07-21T11:11:23Z", "type": "commit"}]}