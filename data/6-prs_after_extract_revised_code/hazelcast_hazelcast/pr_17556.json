{"pr_number": 17556, "pr_title": "Try load custom exceptions via class loader on client", "pr_createdAt": "2020-09-16T12:24:12Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17556", "timeline": [{"oid": "a61792f02d527e8cdcd3ddb02187067b6286eaa7", "url": "https://github.com/hazelcast/hazelcast/commit/a61792f02d527e8cdcd3ddb02187067b6286eaa7", "message": "Add assert to check if exception is defined in the protocol\n\nWhen classLoading is introduced it is possible for us to forget\nto put the exception in the protocol, because it will not longer\nthrow UndefinedErrorCodeException but it will be loaded\nautomatically.\nAssertion is added to check and warn us.", "committedDate": "2020-09-17T08:29:58Z", "type": "forcePushed"}, {"oid": "18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "url": "https://github.com/hazelcast/hazelcast/commit/18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "message": "Try load custom exceptions via class loader on client\n\nWe are throwing UndefinedErrorCodeException if an exception is\nnot on the protocol list.\n\nThis causes poor experience as the behaviour is different between\nthe client and the member.\n\nsee  https://github.com/hazelcast/hazelcast/issues/9753\n\nThis pr does not introduce an ExceptionFactory API as discussed\non the issue.\nThe value of an ExceptionFactory API is debetable and left out\nfor now. If the client has the expcetion class on the classpath,\nthe client will create it. If it is not available on the classpath,\nit is not clear what can a user do with ExceptionFactory API.\nIn that case, we are throwing UndefinedErrorCodeException as before.\nThe main problem seems to be the case where the client have the\nexact same class on the classpath, so this fix should cover\nmost of the use cases.\n\nAlso added  assert to check if exception is defined in the protocol\nWhen classLoading is introduced it is possible for us to forget\nto put the exception in the protocol, because it will not longer\nthrow UndefinedErrorCodeException but it will be loaded\nautomatically.\nAssertion is added to check and warn us.\n\nfixes https://github.com/hazelcast/hazelcast/issues/9753", "committedDate": "2020-09-24T14:21:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MDUzNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498670536", "bodyText": "Question: should we create a test that would verify that each error code is registered in both ClientExceptions and ClientExceptionFactory? The process of adding a new code seems to be error-prone and leads to missing registrations like this one.", "author": "puzpuzpuz", "createdAt": "2020-10-02T07:59:49Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/ClientExceptions.java", "diffHunk": "@@ -209,6 +209,11 @@ public ClientExceptions(boolean jcacheAvailable) {\n         register(ClientProtocolErrorCodes.STALE_APPEND_REQUEST_EXCEPTION, StaleAppendRequestException.class);\n         register(ClientProtocolErrorCodes.NOT_LEADER_EXCEPTION, NotLeaderException.class);\n         register(ClientProtocolErrorCodes.VERSION_MISMATCH_EXCEPTION, VersionMismatchException.class);\n+        register(ClientProtocolErrorCodes.NO_SUCH_METHOD_ERROR, NoSuchMethodError.class);", "originalCommit": "18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MzcwOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498683709", "bodyText": "Actually, I have better refactoring in my head that I keep postponing. CleintExceptions and ClientExceptionFactory are two separate classes because we had a separate client module before. We can simply merge them so that there can not be a problem like this again. Let me work on that on this pr.", "author": "sancar", "createdAt": "2020-10-02T08:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MDUzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2NTc1Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498765753", "bodyText": "Merging these classes in a separate PR would be awesome. I'm marking this one as resolved then.", "author": "puzpuzpuz", "createdAt": "2020-10-02T11:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MDUzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3Mjc1MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498672751", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return null if can not find a constructor as described above, otherwise return newly constructed expcetion\n          \n          \n            \n                 * @return {@code null} if can not find a constructor as described above, otherwise returns newly constructed exception", "author": "puzpuzpuz", "createdAt": "2020-10-02T08:04:38Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java", "diffHunk": "@@ -194,4 +208,49 @@ public static RuntimeException rethrowAllowInterrupted(final Throwable t) throws\n             }\n         };\n     }\n+\n+    /**\n+     * Tries to create the exception with appropriate constructor in the following order.\n+     * In all cases the cause is set(via constructor or via initCause)\n+     * new Throwable(String message, Throwable cause)\n+     * new Throwable(Throwable cause)\n+     * new Throwable(String message)\n+     * new Throwable()\n+     *\n+     * @param exceptionClass class of the exception\n+     * @param message        message to be pass to constructor of the exception\n+     * @param cause          cause to be set to the exception\n+     * @return null if can not find a constructor as described above, otherwise return newly constructed expcetion", "originalCommit": "18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7e0bac82c0b562e741480be7b7ba388700bdcfe2", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java b/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\nindex a3956c3541..41500e9563 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\n\n@@ -253,4 +254,30 @@ public final class ExceptionUtil {\n         }\n         return null;\n     }\n+\n+    /**\n+     * @param original exception to be cloned with fixed stack trace\n+     * @param <T>      type of the original exception\n+     * @return a cloned exception with the current stacktrace is added on top of the original exceptions stack-trace\n+     * the cloned exception has the same cause and the message as the original exception\n+     */\n+    public static <T extends Throwable> T cloneExceptionWithFixedAsyncStackTrace(T original) {\n+        StackTraceElement[] fixedStackTrace = getFixedStackTrace(original, Thread.currentThread().getStackTrace());\n+        Class<? extends Throwable> exceptionClass = original.getClass();\n+        Throwable clone = tryCreateExceptionWithMessageAndCause(exceptionClass, original.getMessage(), original.getCause());\n+        if (clone != null) {\n+            clone.setStackTrace(fixedStackTrace);\n+            return (T) clone;\n+        }\n+        return null;\n+    }\n+\n+    private static StackTraceElement[] getFixedStackTrace(Throwable throwable, StackTraceElement[] localSideStackTrace) {\n+        StackTraceElement[] remoteStackTrace = throwable.getStackTrace();\n+        StackTraceElement[] newStackTrace = new StackTraceElement[localSideStackTrace.length + remoteStackTrace.length];\n+        System.arraycopy(remoteStackTrace, 0, newStackTrace, 0, remoteStackTrace.length);\n+        newStackTrace[remoteStackTrace.length] = new StackTraceElement(EXCEPTION_SEPARATOR, \"\", \"\", -1);\n+        System.arraycopy(localSideStackTrace, 1, newStackTrace, remoteStackTrace.length + 1, localSideStackTrace.length - 1);\n+        return newStackTrace;\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MzMwOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498673308", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * In all cases the cause is set(via constructor or via initCause)\n          \n          \n            \n                 * In all cases the cause is set (via constructor or via {@code initCause})", "author": "puzpuzpuz", "createdAt": "2020-10-02T08:05:50Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java", "diffHunk": "@@ -194,4 +208,49 @@ public static RuntimeException rethrowAllowInterrupted(final Throwable t) throws\n             }\n         };\n     }\n+\n+    /**\n+     * Tries to create the exception with appropriate constructor in the following order.\n+     * In all cases the cause is set(via constructor or via initCause)", "originalCommit": "18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7e0bac82c0b562e741480be7b7ba388700bdcfe2", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java b/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\nindex a3956c3541..41500e9563 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/util/ExceptionUtil.java\n\n@@ -253,4 +254,30 @@ public final class ExceptionUtil {\n         }\n         return null;\n     }\n+\n+    /**\n+     * @param original exception to be cloned with fixed stack trace\n+     * @param <T>      type of the original exception\n+     * @return a cloned exception with the current stacktrace is added on top of the original exceptions stack-trace\n+     * the cloned exception has the same cause and the message as the original exception\n+     */\n+    public static <T extends Throwable> T cloneExceptionWithFixedAsyncStackTrace(T original) {\n+        StackTraceElement[] fixedStackTrace = getFixedStackTrace(original, Thread.currentThread().getStackTrace());\n+        Class<? extends Throwable> exceptionClass = original.getClass();\n+        Throwable clone = tryCreateExceptionWithMessageAndCause(exceptionClass, original.getMessage(), original.getCause());\n+        if (clone != null) {\n+            clone.setStackTrace(fixedStackTrace);\n+            return (T) clone;\n+        }\n+        return null;\n+    }\n+\n+    private static StackTraceElement[] getFixedStackTrace(Throwable throwable, StackTraceElement[] localSideStackTrace) {\n+        StackTraceElement[] remoteStackTrace = throwable.getStackTrace();\n+        StackTraceElement[] newStackTrace = new StackTraceElement[localSideStackTrace.length + remoteStackTrace.length];\n+        System.arraycopy(remoteStackTrace, 0, newStackTrace, 0, remoteStackTrace.length);\n+        newStackTrace[remoteStackTrace.length] = new StackTraceElement(EXCEPTION_SEPARATOR, \"\", \"\", -1);\n+        System.arraycopy(localSideStackTrace, 1, newStackTrace, remoteStackTrace.length + 1, localSideStackTrace.length - 1);\n+        return newStackTrace;\n+    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3Nzc0Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498677742", "bodyText": "Probably it makes sense to add an exception class with non-matching signature and check that it leads to a UndefinedErrorCodeException. Or we could simply keep ClientProtocolErrorCodesTest#testUndefinedException (and modify it slightly). WDYT?", "author": "puzpuzpuz", "createdAt": "2020-10-02T08:15:08Z", "path": "hazelcast/src/test/java/testsubjects/CustomExceptions.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package testsubjects;\n+\n+public class CustomExceptions {", "originalCommit": "18dd1ddac9db67a1cfe6d044166b7e61b55ccb20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwOTY3NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498709674", "bodyText": "testUndefinedException does not work anymore.\nWhen you put it this way, I have just realized that the meaning of UndefinedErrorCodeException has changed also. The Javadoc says\nThis exception is thrown when an exception that is coming from the server is not recognized by the protocol.\n * Class name of the original exception is included in the exception\n\nwhich is not correct anymore.\nI will change to\n * This exception is thrown when an exception that is coming from server is not recognized by the protocol and\n * it can not be constructed by the client via reflection.\n * For the client to be able to recreate original exception it should be available on the classpath and\n * it should have one of the following constructors publicly.\n * new Throwable(String message, Throwable cause)\n * new Throwable(Throwable cause)\n * new Throwable(String message)\n * new Throwable()\n * <p>\n * Class name of the original exception is included in the exception.\n\nAnd I can add an exception class with a non-matching signature as you suggested to verify the behavior.", "author": "sancar", "createdAt": "2020-10-02T09:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3Nzc0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "0a8111398f442c2a20d3efeb2e86dd0753f08203", "chunk": "diff --git a/hazelcast/src/test/java/testsubjects/CustomExceptions.java b/hazelcast/src/test/java/testsubjects/CustomExceptions.java\nindex cd5b285ec8..47ddf9463d 100644\n--- a/hazelcast/src/test/java/testsubjects/CustomExceptions.java\n+++ b/hazelcast/src/test/java/testsubjects/CustomExceptions.java\n\n@@ -41,4 +41,10 @@ public class CustomExceptions {\n             super(cause);\n         }\n     }\n+\n+    public static class CustomExceptionNonStandardSignature extends Exception {\n+        public CustomExceptionNonStandardSignature(int x) {\n+            super();\n+        }\n+    }\n }\n"}}, {"oid": "7e0bac82c0b562e741480be7b7ba388700bdcfe2", "url": "https://github.com/hazelcast/hazelcast/commit/7e0bac82c0b562e741480be7b7ba388700bdcfe2", "message": "Try load custom exceptions via class loader on client\n\nWe are throwing UndefinedErrorCodeException if an exception is\nnot on the protocol list.\n\nThis causes poor experience as the behaviour is different between\nthe client and the member.\n\nsee  https://github.com/hazelcast/hazelcast/issues/9753\n\nThis pr does not introduce an ExceptionFactory API as discussed\non the issue.\nThe value of an ExceptionFactory API is debetable and left out\nfor now. If the client has the expcetion class on the classpath,\nthe client will create it. If it is not available on the classpath,\nit is not clear what can a user do with ExceptionFactory API.\nIn that case, we are throwing UndefinedErrorCodeException as before.\nThe main problem seems to be the case where the client have the\nexact same class on the classpath, so this fix should cover\nmost of the use cases.\n\nAlso added  assert to check if exception is defined in the protocol\nWhen classLoading is introduced it is possible for us to forget\nto put the exception in the protocol, because it will not longer\nthrow UndefinedErrorCodeException but it will be loaded\nautomatically.\nAssertion is added to check and warn us.\n\nfixes https://github.com/hazelcast/hazelcast/issues/9753", "committedDate": "2020-10-02T12:34:50Z", "type": "commit"}, {"oid": "0a8111398f442c2a20d3efeb2e86dd0753f08203", "url": "https://github.com/hazelcast/hazelcast/commit/0a8111398f442c2a20d3efeb2e86dd0753f08203", "message": "addressing review comments", "committedDate": "2020-10-02T12:34:50Z", "type": "commit"}, {"oid": "0a8111398f442c2a20d3efeb2e86dd0753f08203", "url": "https://github.com/hazelcast/hazelcast/commit/0a8111398f442c2a20d3efeb2e86dd0753f08203", "message": "addressing review comments", "committedDate": "2020-10-02T12:34:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxNTE4OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17556#discussion_r498815188", "bodyText": "nit: a list (ul/li) + code blocks could be used here to make this part of the javadoc more readable", "author": "puzpuzpuz", "createdAt": "2020-10-02T13:18:10Z", "path": "hazelcast/src/main/java/com/hazelcast/client/UndefinedErrorCodeException.java", "diffHunk": "@@ -20,8 +20,16 @@\n import com.hazelcast.spi.impl.operationservice.WrappableException;\n \n /**\n- * This exception is thrown when an exception that is coming from server is not recognized by the protocol.\n- * Class name of the original exception is included in the exception\n+ * This exception is thrown when an exception that is coming from server is not recognized by the protocol and\n+ * it can not be constructed by the client via reflection.\n+ * For the client to be able to recreate original exception it should be available on the classpath and\n+ * it should have one of the following constructors publicly.\n+ * new Throwable(String message, Throwable cause)", "originalCommit": "0a8111398f442c2a20d3efeb2e86dd0753f08203", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "06332af6f661e3664e81f68015d013ee7493a7f0", "url": "https://github.com/hazelcast/hazelcast/commit/06332af6f661e3664e81f68015d013ee7493a7f0", "message": "fix for NullPointerException when exception is with a non-matching signature", "committedDate": "2020-10-05T07:29:59Z", "type": "commit"}]}