{"pr_number": 16864, "pr_title": "Add public API to load configuration files", "pr_createdAt": "2020-04-08T13:27:23Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16864", "timeline": [{"oid": "9669e929fa5747c85d0b7c787a45eed4b5140366", "url": "https://github.com/hazelcast/hazelcast/commit/9669e929fa5747c85d0b7c787a45eed4b5140366", "message": "Factory to populate Config object from well-known locations\n\nIt allows to load config from an external file and then customize\nit programmatically. This is useful when embedding Hazelcast into\nmanaged environments: When a runtime container wants to create an\ninstance as if it was created via `Hazelcast.newHazelcastInstance()`,\nbut it wants to inject an instance of `ManagedContext` into Hazelcast\nconfiguration.\n\nWithout this capability all containers have to duplicate the `Config`\nlocation strategy: \"First try this, then that, etc.\"\n\nRelated to https://github.com/spring-projects/spring-boot/issues/19487\n\nTODO: Tests", "committedDate": "2020-01-01T12:58:02Z", "type": "commit"}, {"oid": "045fa0f584d9a02c4ff145f91a716ec27b30514b", "url": "https://github.com/hazelcast/hazelcast/commit/045fa0f584d9a02c4ff145f91a716ec27b30514b", "message": "Merge branch 'master' of https://github.com/hazelcast/hazelcast into experiments/populate-config-from-default", "committedDate": "2020-04-07T12:32:58Z", "type": "commit"}, {"oid": "7e87221aba0bb4f1c0783cc58dc4bb292d9501de", "url": "https://github.com/hazelcast/hazelcast/commit/7e87221aba0bb4f1c0783cc58dc4bb292d9501de", "message": "Fix after code review", "committedDate": "2020-04-07T15:19:21Z", "type": "commit"}, {"oid": "30f2748676dce15cb19c582da6067e76325c6112", "url": "https://github.com/hazelcast/hazelcast/commit/30f2748676dce15cb19c582da6067e76325c6112", "message": "Add ClientConfig.load()", "committedDate": "2020-04-07T15:47:49Z", "type": "commit"}, {"oid": "079e4dd900a8df959b9913c275892635596db23a", "url": "https://github.com/hazelcast/hazelcast/commit/079e4dd900a8df959b9913c275892635596db23a", "message": "Fix FailoverConfigTest", "committedDate": "2020-04-07T15:50:05Z", "type": "commit"}, {"oid": "eb27d3a3aebe819b074575abc1c5b1fe692b0f59", "url": "https://github.com/hazelcast/hazelcast/commit/eb27d3a3aebe819b074575abc1c5b1fe692b0f59", "message": "Add unit tests", "committedDate": "2020-04-08T11:26:02Z", "type": "commit"}, {"oid": "53ac17632e6f6911827caf094e3363ed13e2c3ac", "url": "https://github.com/hazelcast/hazelcast/commit/53ac17632e6f6911827caf094e3363ed13e2c3ac", "message": "Add ClientFailoverConfig.load() and unit tests", "committedDate": "2020-04-08T12:39:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjI5MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16864#discussion_r409492291", "bodyText": "100% flavor comment. Why not return immediately from the function? Now you need to go to the end of the method to determine what is returned.", "author": "pveentjer", "createdAt": "2020-04-16T11:46:12Z", "path": "hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java", "diffHunk": "@@ -168,6 +172,45 @@ public ClientConfig(ClientConfig config) {\n         metricsConfig = new ClientMetricsConfig(config.metricsConfig);\n     }\n \n+    /**\n+     * Populates Hazelcast {@link ClientConfig} object from an external configuration file.\n+     * <p>\n+     * It tries to load Hazelcast Client configuration from a list of well-known locations.\n+     * When no location contains Hazelcast Client configuration then it returns default.\n+     * <p>\n+     * Note that the same mechanism is used when calling\n+     * {@link com.hazelcast.client.HazelcastClient#newHazelcastClient()}.\n+     *\n+     * @return ClientConfig created from a file when exists, otherwise default.\n+     */\n+    public static ClientConfig load() {\n+        validateSuffixInSystemProperty(SYSPROP_CLIENT_CONFIG);\n+\n+        XmlClientConfigLocator xmlConfigLocator = new XmlClientConfigLocator();\n+        YamlClientConfigLocator yamlConfigLocator = new YamlClientConfigLocator();\n+\n+        ClientConfig config;\n+        if (xmlConfigLocator.locateFromSystemProperty()) {\n+            // 1. Try loading XML config from the configuration provided in system property\n+            config = new XmlClientConfigBuilder(xmlConfigLocator).build();", "originalCommit": "53ac17632e6f6911827caf094e3363ed13e2c3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA1MDAyOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16864#discussion_r410050029", "bodyText": "Good idea! Changed.", "author": "leszko", "createdAt": "2020-04-17T07:46:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjI5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8716fd258ab90b913755e7b698fc8744528b49b6", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java b/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\nindex 473ae122692..3cbb591f1dd 100644\n--- a/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\n\n@@ -189,26 +189,23 @@ public class ClientConfig {\n         XmlClientConfigLocator xmlConfigLocator = new XmlClientConfigLocator();\n         YamlClientConfigLocator yamlConfigLocator = new YamlClientConfigLocator();\n \n-        ClientConfig config;\n         if (xmlConfigLocator.locateFromSystemProperty()) {\n             // 1. Try loading XML config from the configuration provided in system property\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         } else if (yamlConfigLocator.locateFromSystemProperty()) {\n             // 2. Try loading YAML config from the configuration provided in system property\n-            config = new YamlClientConfigBuilder(yamlConfigLocator).build();\n+            return new YamlClientConfigBuilder(yamlConfigLocator).build();\n         } else if (xmlConfigLocator.locateInWorkDirOrOnClasspath()) {\n             // 3. Try loading XML config from the working directory or from the classpath\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         } else if (yamlConfigLocator.locateInWorkDirOrOnClasspath()) {\n             // 4. Try loading YAML config from the working directory or from the classpath\n-            config = new YamlClientConfigBuilder(yamlConfigLocator).build();\n+            return new YamlClientConfigBuilder(yamlConfigLocator).build();\n         } else {\n             // 5. Loading the default XML configuration file\n             xmlConfigLocator.locateDefault();\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         }\n-\n-        return config;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MzYwMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16864#discussion_r409493600", "bodyText": "Do we log which file got loaded? So that at least from the logging it is obvious which file is being used. It can be extremely annoying if you are fighting an configuration issue and then you finally determine that your file didn't get loaded in the first place.\nI had that problem a few times with simulator and every time I wanted to smack my head into my desk.", "author": "pveentjer", "createdAt": "2020-04-16T11:48:39Z", "path": "hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java", "diffHunk": "@@ -168,6 +172,45 @@ public ClientConfig(ClientConfig config) {\n         metricsConfig = new ClientMetricsConfig(config.metricsConfig);", "originalCommit": "53ac17632e6f6911827caf094e3363ed13e2c3ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA0OTE1NA==", "url": "https://github.com/hazelcast/hazelcast/pull/16864#discussion_r410049154", "bodyText": "I think that we do log it. At least I see something like this in the logs:\nINFO: Loading configuration '/opt/hazelcast/hazelcast.yaml' from System property 'hazelcast.config'", "author": "leszko", "createdAt": "2020-04-17T07:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MzYwMA=="}], "type": "inlineReview", "revised_code": {"commit": "8716fd258ab90b913755e7b698fc8744528b49b6", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java b/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\nindex 473ae122692..3cbb591f1dd 100644\n--- a/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/client/config/ClientConfig.java\n\n@@ -189,26 +189,23 @@ public class ClientConfig {\n         XmlClientConfigLocator xmlConfigLocator = new XmlClientConfigLocator();\n         YamlClientConfigLocator yamlConfigLocator = new YamlClientConfigLocator();\n \n-        ClientConfig config;\n         if (xmlConfigLocator.locateFromSystemProperty()) {\n             // 1. Try loading XML config from the configuration provided in system property\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         } else if (yamlConfigLocator.locateFromSystemProperty()) {\n             // 2. Try loading YAML config from the configuration provided in system property\n-            config = new YamlClientConfigBuilder(yamlConfigLocator).build();\n+            return new YamlClientConfigBuilder(yamlConfigLocator).build();\n         } else if (xmlConfigLocator.locateInWorkDirOrOnClasspath()) {\n             // 3. Try loading XML config from the working directory or from the classpath\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         } else if (yamlConfigLocator.locateInWorkDirOrOnClasspath()) {\n             // 4. Try loading YAML config from the working directory or from the classpath\n-            config = new YamlClientConfigBuilder(yamlConfigLocator).build();\n+            return new YamlClientConfigBuilder(yamlConfigLocator).build();\n         } else {\n             // 5. Loading the default XML configuration file\n             xmlConfigLocator.locateDefault();\n-            config = new XmlClientConfigBuilder(xmlConfigLocator).build();\n+            return new XmlClientConfigBuilder(xmlConfigLocator).build();\n         }\n-\n-        return config;\n     }\n \n     /**\n"}}, {"oid": "8716fd258ab90b913755e7b698fc8744528b49b6", "url": "https://github.com/hazelcast/hazelcast/commit/8716fd258ab90b913755e7b698fc8744528b49b6", "message": "Change after code review", "committedDate": "2020-04-17T07:46:00Z", "type": "commit"}, {"oid": "59f9633e49fecadff836b0ce90e669be4bfd84f7", "url": "https://github.com/hazelcast/hazelcast/commit/59f9633e49fecadff836b0ce90e669be4bfd84f7", "message": "Merge master in", "committedDate": "2020-04-17T07:49:46Z", "type": "commit"}, {"oid": "e63202cfe213077275ae543b6dfb1baf30570f56", "url": "https://github.com/hazelcast/hazelcast/commit/e63202cfe213077275ae543b6dfb1baf30570f56", "message": "Change after code review", "committedDate": "2020-04-17T07:50:42Z", "type": "commit"}]}