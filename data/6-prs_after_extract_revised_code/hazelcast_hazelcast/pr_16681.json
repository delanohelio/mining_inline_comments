{"pr_number": 16681, "pr_title": "Decrease preallocated partition container sizes", "pr_createdAt": "2020-02-24T11:17:52Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16681", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODg5MA==", "url": "https://github.com/hazelcast/hazelcast/pull/16681#discussion_r383238890", "bodyText": "Can't we initialize this with the number of DSs defined in the static config? Then we can grow on-demand if new ones created dynamically.", "author": "blazember", "createdAt": "2020-02-24T12:33:05Z", "path": "hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java", "diffHunk": "@@ -103,7 +104,7 @@\n     private static final Object NULL_OBJECT = new Object();\n \n     private final ConcurrentMap<String, QueueContainer> containerMap = new ConcurrentHashMap<>();\n-    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap = new ConcurrentHashMap<>(1000);\n+    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap = MapUtil.createConcurrentHashMap(10);", "originalCommit": "967b2bd60a80bb7600a780fd1d277824eb3619f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzOTkyMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16681#discussion_r383239921", "bodyText": "yes, this was also an idea, have to see how (un)intrusive it is to get the config in the constructor and iterate through it.", "author": "mmedenjak", "createdAt": "2020-02-24T12:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0MDE2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/16681#discussion_r383240168", "bodyText": "wildcard configs and configs based on default are a gotcha but I think it's fine to work with best-effort approach here.", "author": "mmedenjak", "createdAt": "2020-02-24T12:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2ODIzMg==", "url": "https://github.com/hazelcast/hazelcast/pull/16681#discussion_r429768232", "bodyText": "Addressed this comment, also on other places. The approach is pretty simple, I just take the number of configs, which means wildcard and default also count as one. PTAL", "author": "mmedenjak", "createdAt": "2020-05-25T07:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODg5MA=="}], "type": "inlineReview", "revised_code": {"commit": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java b/hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java\nindex c1cfe223d6e..41d0b9e96db 100644\n--- a/hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java\n+++ b/hazelcast/src/main/java/com/hazelcast/collection/impl/queue/QueueService.java\n\n@@ -104,7 +104,7 @@ public class QueueService implements ManagedService, MigrationAwareService, Tran\n     private static final Object NULL_OBJECT = new Object();\n \n     private final ConcurrentMap<String, QueueContainer> containerMap = new ConcurrentHashMap<>();\n-    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap = MapUtil.createConcurrentHashMap(10);\n+    private final ConcurrentMap<String, LocalQueueStatsImpl> statsMap;\n     private final ConstructorFunction<String, LocalQueueStatsImpl> localQueueStatsConstructorFunction =\n         key -> new LocalQueueStatsImpl();\n \n"}}, {"oid": "1488b8ba06254730d4940f8053e006c217b7baba", "url": "https://github.com/hazelcast/hazelcast/commit/1488b8ba06254730d4940f8053e006c217b7baba", "message": "Decrease preallocated partition container sizes", "committedDate": "2020-04-06T11:12:53Z", "type": "forcePushed"}, {"oid": "de17efa417219ce601265e81c8e66b6cfa46e53b", "url": "https://github.com/hazelcast/hazelcast/commit/de17efa417219ce601265e81c8e66b6cfa46e53b", "message": "Decrease preallocated partition container sizes", "committedDate": "2020-05-24T14:13:01Z", "type": "commit"}, {"oid": "1c6c49c2dd538401bc7d09f6e0fcf2a915fc1cc2", "url": "https://github.com/hazelcast/hazelcast/commit/1c6c49c2dd538401bc7d09f6e0fcf2a915fc1cc2", "message": "Fix compilation issue", "committedDate": "2020-05-24T14:13:01Z", "type": "commit"}, {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "url": "https://github.com/hazelcast/hazelcast/commit/f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "message": "Address review comments", "committedDate": "2020-05-24T14:21:11Z", "type": "commit"}, {"oid": "f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "url": "https://github.com/hazelcast/hazelcast/commit/f1ee883fe5d5337e8c562ad18557cb104ecab2b1", "message": "Address review comments", "committedDate": "2020-05-24T14:21:11Z", "type": "forcePushed"}]}