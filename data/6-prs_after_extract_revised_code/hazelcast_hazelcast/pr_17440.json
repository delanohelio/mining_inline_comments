{"pr_number": 17440, "pr_title": "Rewrite anti-entropy task sending in unblocking fashion", "pr_createdAt": "2020-08-31T16:30:50Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17440", "timeline": [{"oid": "6d4a6f41491f66d1154b8fe97a936cf28e6e0bff", "url": "https://github.com/hazelcast/hazelcast/commit/6d4a6f41491f66d1154b8fe97a936cf28e6e0bff", "message": "Rewrite anti-entropy task sending in unblocking fashion", "committedDate": "2020-08-31T22:03:00Z", "type": "forcePushed"}, {"oid": "3c7a48484cea07a57357a818289978fd370d35f7", "url": "https://github.com/hazelcast/hazelcast/commit/3c7a48484cea07a57357a818289978fd370d35f7", "message": "Add Mehmet's fix", "committedDate": "2020-09-02T11:37:27Z", "type": "forcePushed"}, {"oid": "b46f480c0fccab6f6f615fe75fb63c8709ade070", "url": "https://github.com/hazelcast/hazelcast/commit/b46f480c0fccab6f6f615fe75fb63c8709ade070", "message": "Add Mehmet's fix", "committedDate": "2020-09-02T11:39:51Z", "type": "forcePushed"}, {"oid": "2df7f277d18fcf6ac3fd44113722f4c7a6f61b94", "url": "https://github.com/hazelcast/hazelcast/commit/2df7f277d18fcf6ac3fd44113722f4c7a6f61b94", "message": "Add Mehmet's fix", "committedDate": "2020-09-02T11:40:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAzMjE5Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17440#discussion_r482032196", "bodyText": "Shouldn't afterRun.run() be called inside a finally block? What if this method returns before executing afterRun?", "author": "mdogan", "createdAt": "2020-09-02T12:34:12Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionPrimaryReplicaAntiEntropyTask.java", "diffHunk": "@@ -46,6 +49,10 @@ public void run() {\n                 invokePartitionBackupReplicaAntiEntropyOp(index, replica, namespaces, null);\n             }\n         }\n+\n+        if (afterRun != null) {\n+            afterRun.run();", "originalCommit": "2df7f277d18fcf6ac3fd44113722f4c7a6f61b94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA0Njc0Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17440#discussion_r482046743", "bodyText": "fixed", "author": "ahmetmircik", "createdAt": "2020-09-02T12:56:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAzMjE5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "5631b847cf8593dca7ac16f3c4a6959875f27ef1", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionPrimaryReplicaAntiEntropyTask.java b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionPrimaryReplicaAntiEntropyTask.java\nindex 3bce223fbb..4a26f42cc2 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionPrimaryReplicaAntiEntropyTask.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionPrimaryReplicaAntiEntropyTask.java\n\n@@ -36,23 +36,24 @@ final class PartitionPrimaryReplicaAntiEntropyTask extends AbstractPartitionPrim\n \n     @Override\n     public void run() {\n-        InternalPartition partition = partitionService.getPartition(partitionId, false);\n-        if (!partition.isLocal() || partition.isMigrating()) {\n-            return;\n-        }\n+        try {\n+            InternalPartition partition = partitionService.getPartition(partitionId, false);\n+            if (!partition.isLocal() || partition.isMigrating()) {\n+                return;\n+            }\n \n-        Collection<ServiceNamespace> namespaces = retainAndGetNamespaces();\n+            Collection<ServiceNamespace> namespaces = retainAndGetNamespaces();\n \n-        for (int index = 1; index < MAX_REPLICA_COUNT; index++) {\n-            PartitionReplica replica = partition.getReplica(index);\n-            if (replica != null) {\n-                invokePartitionBackupReplicaAntiEntropyOp(index, replica, namespaces, null);\n+            for (int index = 1; index < MAX_REPLICA_COUNT; index++) {\n+                PartitionReplica replica = partition.getReplica(index);\n+                if (replica != null) {\n+                    invokePartitionBackupReplicaAntiEntropyOp(index, replica, namespaces, null);\n+                }\n+            }\n+        } finally {\n+            if (afterRun != null) {\n+                afterRun.run();\n             }\n-        }\n-\n-        if (afterRun != null) {\n-            afterRun.run();\n         }\n     }\n-\n }\n"}}, {"oid": "5631b847cf8593dca7ac16f3c4a6959875f27ef1", "url": "https://github.com/hazelcast/hazelcast/commit/5631b847cf8593dca7ac16f3c4a6959875f27ef1", "message": "Address Mehmets commnets", "committedDate": "2020-09-02T14:03:01Z", "type": "forcePushed"}, {"oid": "dd64dd5aaea31aca3e5419a9f429953c53a5ec1c", "url": "https://github.com/hazelcast/hazelcast/commit/dd64dd5aaea31aca3e5419a9f429953c53a5ec1c", "message": "Rewrite anti-entropy task sending in unblocking fashion", "committedDate": "2020-09-02T16:12:38Z", "type": "commit"}, {"oid": "d20b26a12764b31557c6e093fef4057557dc199b", "url": "https://github.com/hazelcast/hazelcast/commit/d20b26a12764b31557c6e093fef4057557dc199b", "message": "Add Mehmet's fix", "committedDate": "2020-09-02T16:12:38Z", "type": "commit"}, {"oid": "2bbbacb4f45556449c431aef5a415a9d32d7b44c", "url": "https://github.com/hazelcast/hazelcast/commit/2bbbacb4f45556449c431aef5a415a9d32d7b44c", "message": "Address Mehmets commnets", "committedDate": "2020-09-02T16:12:38Z", "type": "commit"}, {"oid": "2bbbacb4f45556449c431aef5a415a9d32d7b44c", "url": "https://github.com/hazelcast/hazelcast/commit/2bbbacb4f45556449c431aef5a415a9d32d7b44c", "message": "Address Mehmets commnets", "committedDate": "2020-09-02T16:12:38Z", "type": "forcePushed"}]}