{"pr_number": 17948, "pr_title": "Cleanup rolling-upgrade support code", "pr_createdAt": "2020-12-08T16:26:31Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17948", "timeline": [{"oid": "eed22a1a76aae0b1a32392ad503eb354d656840c", "url": "https://github.com/hazelcast/hazelcast/commit/eed22a1a76aae0b1a32392ad503eb354d656840c", "message": "Removes stale RU compat code for 4.0", "committedDate": "2020-12-08T16:13:27Z", "type": "commit"}, {"oid": "a922faa304be9fa847d0e49b579973fccaa56b15", "url": "https://github.com/hazelcast/hazelcast/commit/a922faa304be9fa847d0e49b579973fccaa56b15", "message": "Removes stale RU compat code for 4.0\n\nRemoves partition & migration related\ncode for RU from 4.0 -> 4.1.", "committedDate": "2020-12-08T16:13:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI1NDk5OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17948#discussion_r539254999", "bodyText": "could this version comparison be removed  also?--> newVersion.isEqualTo(Versions.V4_1)", "author": "ahmetmircik", "createdAt": "2020-12-09T12:12:10Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionStateManager.java", "diffHunk": "@@ -464,18 +428,13 @@ int replaceMember(Member oldMember, Member newMember) {\n     }\n \n     PartitionTableView getPartitionTable() {\n-        int version = 0;\n-        if (node.getClusterService().getClusterVersion().isUnknownOrLessOrEqual(Versions.V4_0)) {\n-            //RU_COMPAT_4_0\n-            version = getVersion();\n-        }\n-        return new PartitionTableView(getPartitionsCopy(true), version);\n+        return new PartitionTableView(getPartitionsCopy(true));\n     }\n \n     @Override\n     public void onClusterVersionChange(Version newVersion) {\n         if (newVersion.isEqualTo(Versions.V4_1) && initialized) {", "originalCommit": "a922faa304be9fa847d0e49b579973fccaa56b15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM5Mzk0Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17948#discussion_r539393946", "bodyText": "good catch, PartitionStateManager and InternalPartitionServiceImpl listened for cluster version changes in order to initialize partition versions on transition from 4.0 to 4.1 cluster version. This is no longer necessary as 4.2 members can only partitipate in 4.1 / 4.2 clusters -> partition version is already initialized before a 4.2 member can join the cluster.", "author": "vbekiaris", "createdAt": "2020-12-09T15:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI1NDk5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "08c4bba7bb9cfd41c2707bb3db96c8f063f48c9a", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionStateManager.java b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionStateManager.java\nindex fa7c0acd19e..5d74845ccf1 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionStateManager.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionStateManager.java\n\n@@ -430,15 +427,4 @@ public class PartitionStateManager implements ClusterVersionListener {\n     PartitionTableView getPartitionTable() {\n         return new PartitionTableView(getPartitionsCopy(true));\n     }\n-\n-    @Override\n-    public void onClusterVersionChange(Version newVersion) {\n-        if (newVersion.isEqualTo(Versions.V4_1) && initialized) {\n-            int version = 0;\n-            for (InternalPartitionImpl partition : partitions) {\n-                partition.setVersion(version);\n-            }\n-            updateStamp();\n-        }\n-    }\n }\n"}}, {"oid": "08c4bba7bb9cfd41c2707bb3db96c8f063f48c9a", "url": "https://github.com/hazelcast/hazelcast/commit/08c4bba7bb9cfd41c2707bb3db96c8f063f48c9a", "message": "PartitionStateManager no longer needs to listen for cluster version changes", "committedDate": "2020-12-09T15:05:21Z", "type": "commit"}, {"oid": "08c4bba7bb9cfd41c2707bb3db96c8f063f48c9a", "url": "https://github.com/hazelcast/hazelcast/commit/08c4bba7bb9cfd41c2707bb3db96c8f063f48c9a", "message": "PartitionStateManager no longer needs to listen for cluster version changes", "committedDate": "2020-12-09T15:05:21Z", "type": "forcePushed"}]}