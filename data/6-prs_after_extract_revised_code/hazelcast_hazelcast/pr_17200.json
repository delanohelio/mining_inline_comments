{"pr_number": 17200, "pr_title": "Add instance tracking via files created on node startup", "pr_createdAt": "2020-07-10T06:39:28Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17200", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTE2OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r452821168", "bodyText": "Minor: I think we can move this to AbstractDomConfigProcessor as this is common for clients and members.", "author": "blazember", "createdAt": "2020-07-10T12:47:53Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java", "diffHunk": "@@ -2927,6 +2931,23 @@ private void handleMetricsJmx(Node node) {\n         }\n     }\n \n+    private void handleInstanceTracking(Node node) {\n+        InstanceTrackingConfig trackingConfig = config.getInstanceTrackingConfig();\n+\n+        Node attrEnabled = node.getAttributes().getNamedItem(\"enabled\");\n+        boolean enabled = getBooleanValue(getTextContent(attrEnabled));\n+        trackingConfig.setEnabled(enabled);\n+\n+        for (Node n : childElements(node)) {\n+            final String name = cleanNodeName(n);\n+            if (\"file-name\".equals(name)) {\n+                trackingConfig.setFileName(getTextContent(n));\n+            } else if (\"format-pattern\".equals(name)) {\n+                trackingConfig.setFormatPattern(getTextContent(n));\n+            }\n+        }\n+    }\n+", "originalCommit": "1182921f3815d6f3b274a456ae2e803372f694a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk1NjM5MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r452956391", "bodyText": "Done.", "author": "mmedenjak", "createdAt": "2020-07-10T16:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyMTE2OA=="}], "type": "inlineReview", "revised_code": {"commit": "eef2adcdee59c94f6919812a448a606c28804596", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java b/hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java\nindex f7c099f2c7..9b235ec25c 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/config/MemberDomConfigProcessor.java\n\n@@ -2931,23 +2930,6 @@ public class MemberDomConfigProcessor extends AbstractDomConfigProcessor {\n         }\n     }\n \n-    private void handleInstanceTracking(Node node) {\n-        InstanceTrackingConfig trackingConfig = config.getInstanceTrackingConfig();\n-\n-        Node attrEnabled = node.getAttributes().getNamedItem(\"enabled\");\n-        boolean enabled = getBooleanValue(getTextContent(attrEnabled));\n-        trackingConfig.setEnabled(enabled);\n-\n-        for (Node n : childElements(node)) {\n-            final String name = cleanNodeName(n);\n-            if (\"file-name\".equals(name)) {\n-                trackingConfig.setFileName(getTextContent(n));\n-            } else if (\"format-pattern\".equals(name)) {\n-                trackingConfig.setFormatPattern(getTextContent(n));\n-            }\n-        }\n-    }\n-\n     private void handleSql(Node node) {\n         SqlConfig sqlConfig = config.getSqlConfig();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyNzczNg==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r452827736", "bodyText": "\ud83d\udc4d", "author": "blazember", "createdAt": "2020-07-10T13:00:36Z", "path": "hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java", "diffHunk": "@@ -129,6 +129,12 @@ static boolean isCompatible(Config c1, Config c2) {\n         checkCompatibleConfigs(\"cp subsystem\", c1, c2, singletonMap(\"\", c1.getCPSubsystemConfig()),\n                 singletonMap(\"\", c2.getCPSubsystemConfig()), new CPSubsystemConfigChecker());\n \n+        checkCompatibleConfigs(\"metrics\", c1.getMetricsConfig(), c2.getMetricsConfig(), new MetricsConfigChecker());", "originalCommit": "1182921f3815d6f3b274a456ae2e803372f694a6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODY1Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r452828653", "bodyText": "Since it is disabled by default, I would test with true.", "author": "blazember", "createdAt": "2020-07-10T13:02:23Z", "path": "hazelcast/src/test/java/com/hazelcast/config/YamlConfigBuilderTest.java", "diffHunk": "@@ -3458,6 +3458,23 @@ public void testMetricsConfig() {\n         assertEquals(11, metricsMcConfig.getRetentionSeconds());\n     }\n \n+    @Override\n+    @Test\n+    public void testInstanceTrackingConfig() {\n+        String yaml = \"\"\n+                + \"hazelcast:\\n\"\n+                + \"  instance-tracking:\\n\"\n+                + \"    enabled: false\\n\"", "originalCommit": "1182921f3815d6f3b274a456ae2e803372f694a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjk1NzE0Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r452957147", "bodyText": "Changed to true. Actually I intentionally set it to false because I was afraid it would create files that weren't being cleaned up. But hopefully writing to /dummy/file will fail :) If you have some ideas for file names that will definitely fail and throw an exception, we can change it to that.", "author": "mmedenjak", "createdAt": "2020-07-10T16:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAyODcyNw==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453028727", "bodyText": "I think it's fine here, we don't start an instance with the created config, we test only the parser.", "author": "blazember", "createdAt": "2020-07-10T19:05:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODY1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAzODA5OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453038098", "bodyText": "Ah. I changed it on all places where we were testing some config, including where we start an instance (I think Spring?) so maybe I can revert there.", "author": "mmedenjak", "createdAt": "2020-07-10T19:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyODY1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "eef2adcdee59c94f6919812a448a606c28804596", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/config/YamlConfigBuilderTest.java b/hazelcast/src/test/java/com/hazelcast/config/YamlConfigBuilderTest.java\nindex 2802f13008..c8b98722b7 100644\n--- a/hazelcast/src/test/java/com/hazelcast/config/YamlConfigBuilderTest.java\n+++ b/hazelcast/src/test/java/com/hazelcast/config/YamlConfigBuilderTest.java\n\n@@ -3464,12 +3464,12 @@ public class YamlConfigBuilderTest extends AbstractConfigBuilderTest {\n         String yaml = \"\"\n                 + \"hazelcast:\\n\"\n                 + \"  instance-tracking:\\n\"\n-                + \"    enabled: false\\n\"\n+                + \"    enabled: true\\n\"\n                 + \"    file-name: /dummy/file\\n\"\n                 + \"    format-pattern: dummy-pattern with $HZ_INSTANCE_TRACKING{placeholder} and $RND{placeholder}\";\n         Config config = new InMemoryYamlConfig(yaml);\n         InstanceTrackingConfig trackingConfig = config.getInstanceTrackingConfig();\n-        assertFalse(trackingConfig.isEnabled());\n+        assertTrue(trackingConfig.isEnabled());\n         assertEquals(\"/dummy/file\", trackingConfig.getFileName());\n         assertEquals(\"dummy-pattern with $HZ_INSTANCE_TRACKING{placeholder} and $RND{placeholder}\",\n                 trackingConfig.getFormatPattern());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTcxMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453585711", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n          \n          \n            \n                 * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for", "author": "kwart", "createdAt": "2020-07-13T11:33:32Z", "path": "hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Objects;\n+\n+/**\n+ * Configures tracking of a running Hazelcast instance. For now, this is\n+ * limited to writing information about the Hazelcast instance to a file\n+ * while the instance is starting.\n+ * <p>\n+ * The file is overwritten on every start of the Hazelcast instance and if\n+ * multiple instance share the same file system, every instance will\n+ * overwrite the tracking file of a previously started instance.\n+ * <p>\n+ * If this instance is unable to write the file, the exception is logged and\n+ * the instance is allowed to start.\n+ *\n+ * @since 4.1\n+ */\n+public class InstanceTrackingConfig {\n+\n+    /**\n+     * Default file to which the instance metadata will be written.\n+     */\n+    public static final Path DEFAULT_FILE = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"Hazelcast.process\");\n+\n+    /**\n+     * Namespace for the placeholders in the file name and format pattern to\n+     * distinguish between different types of placeholders.\n+     */\n+    public static final String PLACEHOLDER_NAMESPACE = \"HZ_INSTANCE_TRACKING\";\n+\n+    private boolean enabled;\n+    private String fileName;\n+    private String formatPattern;\n+\n+    public InstanceTrackingConfig() {\n+        super();\n+    }\n+\n+    public InstanceTrackingConfig(InstanceTrackingConfig other) {\n+        this.enabled = other.enabled;\n+        this.fileName = other.fileName;\n+        this.formatPattern = other.formatPattern;\n+    }\n+\n+    /**\n+     * Returns {@code true} if instance tracking is enabled.\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables or disables instance tracking.\n+     *\n+     * @param enabled {@code true} if instance tracking should be enabled\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the name of the file which will contain the tracking metadata. If\n+     * {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     */\n+    public String getFileName() {\n+        return fileName;\n+    }\n+\n+    /**\n+     * Sets the name of the file which will contain the tracking metadata. If set\n+     * to {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     *\n+     * @param fileName the name of the file to contain the tracking metadata\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setFileName(String fileName) {\n+        this.fileName = fileName;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for", "originalCommit": "8dd78001fa58ce794198c7b3d8973393cf8433cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0599504e0fd4580a851138711b87c8369057d09", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\nindex 8c80ca123b..f807fa26d6 100644\n--- a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n\n@@ -109,9 +109,9 @@ public class InstanceTrackingConfig {\n      * Returns the pattern used to render the contents of the instance tracking file.\n      * It may contain placeholders for properties listed in the\n      * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n-     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for\n      * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n-     * would be $&#123;start_timestamp&#125;.\n+     * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.\n      * <p>\n      * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n      * is ignored and only the known properties are resolved, placeholders for\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NTg5Ng==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453585896", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * would be $&#123;start_timestamp&#125;.\n          \n          \n            \n                 * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.", "author": "kwart", "createdAt": "2020-07-13T11:33:54Z", "path": "hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Objects;\n+\n+/**\n+ * Configures tracking of a running Hazelcast instance. For now, this is\n+ * limited to writing information about the Hazelcast instance to a file\n+ * while the instance is starting.\n+ * <p>\n+ * The file is overwritten on every start of the Hazelcast instance and if\n+ * multiple instance share the same file system, every instance will\n+ * overwrite the tracking file of a previously started instance.\n+ * <p>\n+ * If this instance is unable to write the file, the exception is logged and\n+ * the instance is allowed to start.\n+ *\n+ * @since 4.1\n+ */\n+public class InstanceTrackingConfig {\n+\n+    /**\n+     * Default file to which the instance metadata will be written.\n+     */\n+    public static final Path DEFAULT_FILE = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"Hazelcast.process\");\n+\n+    /**\n+     * Namespace for the placeholders in the file name and format pattern to\n+     * distinguish between different types of placeholders.\n+     */\n+    public static final String PLACEHOLDER_NAMESPACE = \"HZ_INSTANCE_TRACKING\";\n+\n+    private boolean enabled;\n+    private String fileName;\n+    private String formatPattern;\n+\n+    public InstanceTrackingConfig() {\n+        super();\n+    }\n+\n+    public InstanceTrackingConfig(InstanceTrackingConfig other) {\n+        this.enabled = other.enabled;\n+        this.fileName = other.fileName;\n+        this.formatPattern = other.formatPattern;\n+    }\n+\n+    /**\n+     * Returns {@code true} if instance tracking is enabled.\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables or disables instance tracking.\n+     *\n+     * @param enabled {@code true} if instance tracking should be enabled\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the name of the file which will contain the tracking metadata. If\n+     * {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     */\n+    public String getFileName() {\n+        return fileName;\n+    }\n+\n+    /**\n+     * Sets the name of the file which will contain the tracking metadata. If set\n+     * to {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     *\n+     * @param fileName the name of the file to contain the tracking metadata\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setFileName(String fileName) {\n+        this.fileName = fileName;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n+     * would be $&#123;start_timestamp&#125;.", "originalCommit": "8dd78001fa58ce794198c7b3d8973393cf8433cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0599504e0fd4580a851138711b87c8369057d09", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\nindex 8c80ca123b..f807fa26d6 100644\n--- a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n\n@@ -109,9 +109,9 @@ public class InstanceTrackingConfig {\n      * Returns the pattern used to render the contents of the instance tracking file.\n      * It may contain placeholders for properties listed in the\n      * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n-     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for\n      * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n-     * would be $&#123;start_timestamp&#125;.\n+     * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.\n      * <p>\n      * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n      * is ignored and only the known properties are resolved, placeholders for\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NjkyOA==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453586928", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * a $&#123; prefix and followed by &#125;. For instance, a placeholder for\n          \n          \n            \n                 * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for", "author": "kwart", "createdAt": "2020-07-13T11:35:50Z", "path": "hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Objects;\n+\n+/**\n+ * Configures tracking of a running Hazelcast instance. For now, this is\n+ * limited to writing information about the Hazelcast instance to a file\n+ * while the instance is starting.\n+ * <p>\n+ * The file is overwritten on every start of the Hazelcast instance and if\n+ * multiple instance share the same file system, every instance will\n+ * overwrite the tracking file of a previously started instance.\n+ * <p>\n+ * If this instance is unable to write the file, the exception is logged and\n+ * the instance is allowed to start.\n+ *\n+ * @since 4.1\n+ */\n+public class InstanceTrackingConfig {\n+\n+    /**\n+     * Default file to which the instance metadata will be written.\n+     */\n+    public static final Path DEFAULT_FILE = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"Hazelcast.process\");\n+\n+    /**\n+     * Namespace for the placeholders in the file name and format pattern to\n+     * distinguish between different types of placeholders.\n+     */\n+    public static final String PLACEHOLDER_NAMESPACE = \"HZ_INSTANCE_TRACKING\";\n+\n+    private boolean enabled;\n+    private String fileName;\n+    private String formatPattern;\n+\n+    public InstanceTrackingConfig() {\n+        super();\n+    }\n+\n+    public InstanceTrackingConfig(InstanceTrackingConfig other) {\n+        this.enabled = other.enabled;\n+        this.fileName = other.fileName;\n+        this.formatPattern = other.formatPattern;\n+    }\n+\n+    /**\n+     * Returns {@code true} if instance tracking is enabled.\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables or disables instance tracking.\n+     *\n+     * @param enabled {@code true} if instance tracking should be enabled\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the name of the file which will contain the tracking metadata. If\n+     * {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     */\n+    public String getFileName() {\n+        return fileName;\n+    }\n+\n+    /**\n+     * Sets the name of the file which will contain the tracking metadata. If set\n+     * to {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     *\n+     * @param fileName the name of the file to contain the tracking metadata\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setFileName(String fileName) {\n+        this.fileName = fileName;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n+     * would be $&#123;start_timestamp&#125;.\n+     * <p>\n+     * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n+     * is ignored and only the known properties are resolved, placeholders for\n+     * any parameters which do not have defined values will be ignored. This also\n+     * means that if there is a missing closing bracket in one of the placeholders,\n+     * the property name will be resolved as anything from the opening bracket\n+     * to the next closing bracket, which might contain additional opening brackets.\n+     * <p>\n+     * If set to {@code null}, a JSON formatted output will be used.\n+     *\n+     * @return the pattern for the instance tracking file\n+     * @see InstanceTrackingProperties\n+     */\n+    public String getFormatPattern() {\n+        return formatPattern;\n+    }\n+\n+    /**\n+     * Sets the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $&#123; prefix and followed by &#125;. For instance, a placeholder for", "originalCommit": "8dd78001fa58ce794198c7b3d8973393cf8433cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0599504e0fd4580a851138711b87c8369057d09", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\nindex 8c80ca123b..f807fa26d6 100644\n--- a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n\n@@ -109,9 +109,9 @@ public class InstanceTrackingConfig {\n      * Returns the pattern used to render the contents of the instance tracking file.\n      * It may contain placeholders for properties listed in the\n      * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n-     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for\n      * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n-     * would be $&#123;start_timestamp&#125;.\n+     * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.\n      * <p>\n      * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n      * is ignored and only the known properties are resolved, placeholders for\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU4NzA1Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453587052", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * would be $&#123;start_timestamp&#125;.\n          \n          \n            \n                 * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.", "author": "kwart", "createdAt": "2020-07-13T11:36:06Z", "path": "hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java", "diffHunk": "@@ -0,0 +1,306 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.config;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Objects;\n+\n+/**\n+ * Configures tracking of a running Hazelcast instance. For now, this is\n+ * limited to writing information about the Hazelcast instance to a file\n+ * while the instance is starting.\n+ * <p>\n+ * The file is overwritten on every start of the Hazelcast instance and if\n+ * multiple instance share the same file system, every instance will\n+ * overwrite the tracking file of a previously started instance.\n+ * <p>\n+ * If this instance is unable to write the file, the exception is logged and\n+ * the instance is allowed to start.\n+ *\n+ * @since 4.1\n+ */\n+public class InstanceTrackingConfig {\n+\n+    /**\n+     * Default file to which the instance metadata will be written.\n+     */\n+    public static final Path DEFAULT_FILE = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"Hazelcast.process\");\n+\n+    /**\n+     * Namespace for the placeholders in the file name and format pattern to\n+     * distinguish between different types of placeholders.\n+     */\n+    public static final String PLACEHOLDER_NAMESPACE = \"HZ_INSTANCE_TRACKING\";\n+\n+    private boolean enabled;\n+    private String fileName;\n+    private String formatPattern;\n+\n+    public InstanceTrackingConfig() {\n+        super();\n+    }\n+\n+    public InstanceTrackingConfig(InstanceTrackingConfig other) {\n+        this.enabled = other.enabled;\n+        this.fileName = other.fileName;\n+        this.formatPattern = other.formatPattern;\n+    }\n+\n+    /**\n+     * Returns {@code true} if instance tracking is enabled.\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * Enables or disables instance tracking.\n+     *\n+     * @param enabled {@code true} if instance tracking should be enabled\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setEnabled(boolean enabled) {\n+        this.enabled = enabled;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the name of the file which will contain the tracking metadata. If\n+     * {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     */\n+    public String getFileName() {\n+        return fileName;\n+    }\n+\n+    /**\n+     * Sets the name of the file which will contain the tracking metadata. If set\n+     * to {@code null}, {@link InstanceTrackingConfig#DEFAULT_FILE} is used instead.\n+     * <p>\n+     * The filename can contain placeholders that will be resolved in the same way\n+     * as placeholders for the format pattern (see {@link #setFormatPattern(String)}).\n+     *\n+     * @param fileName the name of the file to contain the tracking metadata\n+     * @return this configuration\n+     */\n+    public InstanceTrackingConfig setFileName(String fileName) {\n+        this.fileName = fileName;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n+     * would be $&#123;start_timestamp&#125;.\n+     * <p>\n+     * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n+     * is ignored and only the known properties are resolved, placeholders for\n+     * any parameters which do not have defined values will be ignored. This also\n+     * means that if there is a missing closing bracket in one of the placeholders,\n+     * the property name will be resolved as anything from the opening bracket\n+     * to the next closing bracket, which might contain additional opening brackets.\n+     * <p>\n+     * If set to {@code null}, a JSON formatted output will be used.\n+     *\n+     * @return the pattern for the instance tracking file\n+     * @see InstanceTrackingProperties\n+     */\n+    public String getFormatPattern() {\n+        return formatPattern;\n+    }\n+\n+    /**\n+     * Sets the pattern used to render the contents of the instance tracking file.\n+     * It may contain placeholders for properties listed in the\n+     * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n+     * a $&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n+     * would be $&#123;start_timestamp&#125;.", "originalCommit": "8dd78001fa58ce794198c7b3d8973393cf8433cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0599504e0fd4580a851138711b87c8369057d09", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\nindex 8c80ca123b..f807fa26d6 100644\n--- a/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n+++ b/hazelcast/src/main/java/com/hazelcast/config/InstanceTrackingConfig.java\n\n@@ -109,9 +109,9 @@ public class InstanceTrackingConfig {\n      * Returns the pattern used to render the contents of the instance tracking file.\n      * It may contain placeholders for properties listed in the\n      * {@link InstanceTrackingProperties} enum. The placeholders are defined by\n-     * a $HZ_IT&#123; prefix and followed by &#125;. For instance, a placeholder for\n+     * a $HZ_INSTANCE_TRACKING&#123; prefix and followed by &#125;. For instance, a placeholder for\n      * the {@link InstanceTrackingProperties#START_TIMESTAMP}\n-     * would be $&#123;start_timestamp&#125;.\n+     * would be $HZ_INSTANCE_TRACKING&#123;start_timestamp&#125;.\n      * <p>\n      * The placeholders are resolved in a fail-safe manner. Any incorrect syntax\n      * is ignored and only the known properties are resolved, placeholders for\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzYwODc1NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17200#discussion_r453608755", "bodyText": "The same expression as on the previous line...", "author": "kwart", "createdAt": "2020-07-13T12:20:08Z", "path": "hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java", "diffHunk": "@@ -775,6 +781,51 @@ MetricsConfig getDefault(Config c) {\n         }\n     }\n \n+    public static class SqlConfigChecker extends ConfigChecker<SqlConfig> {\n+\n+        @Override\n+        boolean check(SqlConfig c1, SqlConfig c2) {\n+            if (c1 == c2) {\n+                return true;\n+            }\n+            if (c1 == null || c2 == null) {\n+                return false;\n+            }\n+\n+            return c1.getExecutorPoolSize() == c2.getExecutorPoolSize()\n+                    && c1.getOperationPoolSize() == c2.getOperationPoolSize()\n+                    && c1.getOperationPoolSize() == c2.getOperationPoolSize()", "originalCommit": "8dd78001fa58ce794198c7b3d8973393cf8433cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c0599504e0fd4580a851138711b87c8369057d09", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java b/hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java\nindex 3b05b0b1dc..a68728d0b6 100644\n--- a/hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java\n+++ b/hazelcast/src/test/java/com/hazelcast/config/ConfigCompatibilityChecker.java\n\n@@ -793,7 +793,6 @@ public class ConfigCompatibilityChecker {\n             }\n \n             return c1.getExecutorPoolSize() == c2.getExecutorPoolSize()\n-                    && c1.getOperationPoolSize() == c2.getOperationPoolSize()\n                     && c1.getOperationPoolSize() == c2.getOperationPoolSize()\n                     && c1.getQueryTimeoutMillis() == c2.getQueryTimeoutMillis();\n         }\n"}}, {"oid": "60ed40c47c911bc6696a068141f52297c2cd1b92", "url": "https://github.com/hazelcast/hazelcast/commit/60ed40c47c911bc6696a068141f52297c2cd1b92", "message": "Add instance tracking via files created on node startup\n\nAdds instance tracking which is basically a file created at node startup\nwhich contains some metadata about the instance such as version, product\nname, PID etc.\n\nThe file name and the pattern for the file are configurable and may\ncontain placeholders. The placeholders have a prefix to be able to\ndistinguish between a placeholder for the instance tracking feature as\nopposed to some other placeholder like XML placeholders. We use the same\nstyle as the EncryptionReplacer by adding a \"namespace\" to the\nplaceholder prefix. For example, $HZ_INSTANCE_TRACKING{start_timestamp}.\n\nThe feature supports both OS and EE members and clients, is disabled by\ndefault and uses a JVM argument to distinguish if the instance was\nstarted using start.sh/bat or inside another application by invoking\nHazelcast.newHazelcastInstance().\n\nThe file overwrites any existing file with the same name. Placeholders\nin the file name can be used to create a new file each time. Failing to\nwrite the file will only generate a warning and the instance is allowed\nto start.", "committedDate": "2020-07-23T12:02:29Z", "type": "commit"}, {"oid": "eef2adcdee59c94f6919812a448a606c28804596", "url": "https://github.com/hazelcast/hazelcast/commit/eef2adcdee59c94f6919812a448a606c28804596", "message": "Address review comments", "committedDate": "2020-07-23T12:02:29Z", "type": "commit"}, {"oid": "c0599504e0fd4580a851138711b87c8369057d09", "url": "https://github.com/hazelcast/hazelcast/commit/c0599504e0fd4580a851138711b87c8369057d09", "message": "Address review comments", "committedDate": "2020-07-23T12:02:29Z", "type": "commit"}, {"oid": "c0599504e0fd4580a851138711b87c8369057d09", "url": "https://github.com/hazelcast/hazelcast/commit/c0599504e0fd4580a851138711b87c8369057d09", "message": "Address review comments", "committedDate": "2020-07-23T12:02:29Z", "type": "forcePushed"}]}