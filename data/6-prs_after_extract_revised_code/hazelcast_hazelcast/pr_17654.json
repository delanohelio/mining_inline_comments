{"pr_number": 17654, "pr_title": "Adding clientname tag to client metrics", "pr_createdAt": "2020-09-30T18:59:05Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17654", "timeline": [{"oid": "e1564777f960b3b325bf2c77c68544961245b740", "url": "https://github.com/hazelcast/hazelcast/commit/e1564777f960b3b325bf2c77c68544961245b740", "message": "adding clientname tag to client metrics", "committedDate": "2020-09-30T18:36:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NzIyOQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498067229", "bodyText": "nit: this comment does not mention client name, so it's better to change it to smth like we add some tags for MC", "author": "puzpuzpuz", "createdAt": "2020-10-01T08:22:02Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java", "diffHunk": "@@ -307,6 +308,7 @@ private MetricDescriptor enhanceDescriptor(MetricDescriptor descriptor, long tim\n                             .withIncludedTarget(MANAGEMENT_CENTER)\n                             // we add \"client\" and \"timestamp\" tags for MC", "originalCommit": "e1564777f960b3b325bf2c77c68544961245b740", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1faa88486999fad4c8f53b13a1e456da9e8a9ec3", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java b/hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java\nindex 1f100b8cb9b..c246aaa9f6d 100644\n--- a/hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java\n+++ b/hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java\n\n@@ -306,7 +306,7 @@ public final class ClientEndpointImpl implements ClientEndpoint {\n                             // since we want to send the client-side metrics only to MC\n                             .withExcludedTargets(MetricTarget.ALL_TARGETS)\n                             .withIncludedTarget(MANAGEMENT_CENTER)\n-                            // we add \"client\" and \"timestamp\" tags for MC\n+                            // we add \"client\", \"clientname\" and \"timestamp\" tags for MC\n                             .withTag(METRICS_TAG_CLIENT, getUuid().toString())\n                             .withTag(METRICS_TAG_CLIENTNAME, clientName)\n                             .withTag(METRICS_TAG_TIMESTAMP, Long.toString(timestamp));\n"}}, {"oid": "1faa88486999fad4c8f53b13a1e456da9e8a9ec3", "url": "https://github.com/hazelcast/hazelcast/commit/1faa88486999fad4c8f53b13a1e456da9e8a9ec3", "message": "fixing failing tests & addressing nit-comment", "committedDate": "2020-10-01T09:04:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498095005", "bodyText": "Shouldn't we make either of METRICS_TAG_CLIENT or METRICS_TAG_CLIENTNAME a discriminator? Discriminators are used to adding extra info to the metrics definition that it captures the \"entity\" provided the given metric. It's basically a distinguished tag. It can make processing the metric easier. I think it should have been done in the initial implementation with METRICS_TAG_CLIENT, but now we can choose between the two mentioned tags. WDYT @emre-aydin?", "author": "blazember", "createdAt": "2020-10-01T09:07:36Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/ClientEndpointImpl.java", "diffHunk": "@@ -307,6 +308,7 @@ private MetricDescriptor enhanceDescriptor(MetricDescriptor descriptor, long tim\n                             .withIncludedTarget(MANAGEMENT_CENTER)\n                             // we add \"client\" and \"timestamp\" tags for MC\n                             .withTag(METRICS_TAG_CLIENT, getUuid().toString())\n+                            .withTag(METRICS_TAG_CLIENTNAME, clientName)", "originalCommit": "e1564777f960b3b325bf2c77c68544961245b740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODExOTk0OQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498119949", "bodyText": "I didn't know about the discriminator tag. In this case, I think making the UUID is a better choice. AFAIK clients can have the same name.", "author": "emre-aydin", "createdAt": "2020-10-01T09:49:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEyMjA4Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498122083", "bodyText": "A small note here. METRICS_TAG_CLIENTNAME are not unique and there may be multiple clients with the same name, so METRICS_TAG_CLIENT should be used as a discriminator.", "author": "puzpuzpuz", "createdAt": "2020-10-01T09:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQyMDQ1Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498420457", "bodyText": "Hello, I tried it out and in the prometheus exporter we don't print the discriminator key-value as a metric label. So we can\na) set the clientUuid both as a tag and a discriminator, not sure if such duplication is ok\nb) set the clientUuid only as a discriminator, but not as a regular tag - it would be a BC-breaking change, and also the UUID wouldn't be usable by Prometheus clients anymore\nOne more concern: as far as I understand this #enchanceDescriptor() method adds additional tags to an already existing metric, sent from the client. So what happens if the client already set a discriminator for the metric? Isn't it a problem that we override it here, by using the clientUuid as the discriminator? It doesn't look like a future-proof approach for me, so maybe it is better to leave this as-is and not populate the discriminator? WDYT?", "author": "erosb", "createdAt": "2020-10-01T17:55:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1NjgxMw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498456813", "bodyText": "Hello, I tried it out and in the prometheus exporter we don't print the discriminator key-value as a metric label. So we can\n\nSo, it totally ignores the discriminator? If so, it sounds wrong, as other parts of MC treat discriminator as a tag.", "author": "puzpuzpuz", "createdAt": "2020-10-01T19:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ1NzY2Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498457663", "bodyText": "As for the collision problem, I agree that it might be a problem. Even if clients don't use discriminator now, nothing stops them from doing that in future.", "author": "puzpuzpuz", "createdAt": "2020-10-01T19:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NDcxMw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498464713", "bodyText": "You're right with the potential override. We do set the discriminator on the client side btw. For example, we set the data structures names in that field. This change is good as is then, sorry for the noise.\nOn the other hand, ignoring the discriminator doesn't sound good indeed. How a map metric looks like then? If MC converts the discriminator to regular tags, it should be present as a tag name=<ds_name> in the Prometheus export.", "author": "blazember", "createdAt": "2020-10-01T19:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY0MDc5Nw==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498640797", "bodyText": "So, it totally ignores the discriminator? If so, it sounds wrong, as other parts of MC treat discriminator as a tag.\n\nI've checked Prometheus exporter impl and it consumes MC's internal data point representation, which has the discriminator merged into tags. So, we should be safe here.", "author": "puzpuzpuz", "createdAt": "2020-10-02T06:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczMTIyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498731224", "bodyText": "Re-tested, we do expose discriminators as tags in Prometheus metrics (the discriminator is added to the tag list internally in MC).", "author": "erosb", "createdAt": "2020-10-02T10:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODczNjQ0NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17654#discussion_r498736445", "bodyText": "Thanks for confirming this @erosb @puzpuzpuz \ud83d\udc4d", "author": "blazember", "createdAt": "2020-10-02T10:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA5NTAwNQ=="}], "type": "inlineReview", "revised_code": null}]}