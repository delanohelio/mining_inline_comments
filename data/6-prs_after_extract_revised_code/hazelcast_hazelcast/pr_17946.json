{"pr_number": 17946, "pr_title": "Ensure List/Set/Map/MultiMap/ReplicatedMap/Queue configs are not overwritten when parsing", "pr_createdAt": "2020-12-07T18:01:08Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17946", "timeline": [{"oid": "0e25421038615df6e31e466425c939c9287e0706", "url": "https://github.com/hazelcast/hazelcast/commit/0e25421038615df6e31e466425c939c9287e0706", "message": "Ensure List/Set/Map/MultiMap/ReplicatedMap/Queue config is not overwritten when parsing", "committedDate": "2020-12-07T18:00:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzE1Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17946#discussion_r538067153", "bodyText": "@blazember\nLooks like we might have a conflict of interest here (or at least a grey area).\nIt turns out that replacing the existing config is actually desired according to #14451. If I understand correctly, XML replaces the whole config sections when importing them, and YAML merges them instead", "author": "pivovarit", "createdAt": "2020-12-08T06:26:21Z", "path": "hazelcast/src/test/java/com/hazelcast/config/XmlConfigImportVariableReplacementTest.java", "diffHunk": "@@ -411,7 +411,7 @@ public void testImportOverlappingMapConfigFromFile() throws Exception {\n         // YAML recursively merges the two files\n         assertEquals(1, myMapConfig.getBackupCount());\n         MapStoreConfig myMapStoreConfig = myMapConfig.getMapStoreConfig();\n-        assertEquals(0, myMapStoreConfig.getWriteDelaySeconds());\n+        assertEquals(10, myMapStoreConfig.getWriteDelaySeconds());", "originalCommit": "797d869d2d099a7721a41749dcd280a6543b668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMwNjM2Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/17946#discussion_r538306363", "bodyText": "@pivovarit You're right, XML replaces the import node with the content of the imported file right in the DOM, while in the case of YAML, the two config files (actually the DOMs built from the two files) need to be merged. The reason for this need is that YAML defines mappings, therefore, it does not allow duplicates, while XML does allow it. The consequence is that the resulting Config may be different for the XML and the YAML case if the main and the imported documents have the \"same\" config (map with the same name for example). There is an ambiguity check though, so actual (scalar) config entries with different values result in failing fast with an InvalidConfigurationException. It can be argued though if spreading the \"same\" configuration across files is a good practice. I think it is not.\nI don't see though how this behavior change impacts config override. We first build a single DOM, then we process it where the overrides can be applied. Is there anything I miss here?", "author": "blazember", "createdAt": "2020-12-08T12:22:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM0MDM0NA==", "url": "https://github.com/hazelcast/hazelcast/pull/17946#discussion_r538340344", "bodyText": "Simply put, the test started failing after I introduced the required changes in the parser, and I don't possess enough context to figure out if I'm doing something wrong, or if the test is wrong. However, I'm leaning towards the latter now.", "author": "pivovarit", "createdAt": "2020-12-08T13:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM2ODQwMQ==", "url": "https://github.com/hazelcast/hazelcast/pull/17946#discussion_r538368401", "bodyText": "I think I see the situation now. So since you changed from new MapConfig() to config.getMapConfig() in the processor, you get a MapConfig with the previously set attributes. So technically, instead of replacing the MapConfig, with your change, we start merging in XML too, just like we do with YAML. If I get this right, I agree, the test needs to be modified since we introduce a behavioral change here, which is also a behavioral unification. I wouldn't worry about this since I hardly believe anybody defined the same configuration in two XML files.", "author": "blazember", "createdAt": "2020-12-08T13:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzE1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ4MDE1MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17946#discussion_r538480150", "bodyText": "In such case, we should be ready to go here.", "author": "pivovarit", "createdAt": "2020-12-08T15:11:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA2NzE1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2fd281fa69977160445cfd6f05cacba86baca9a2", "chunk": "diff --git a/hazelcast/src/test/java/com/hazelcast/config/XmlConfigImportVariableReplacementTest.java b/hazelcast/src/test/java/com/hazelcast/config/XmlConfigImportVariableReplacementTest.java\nindex 1af6abad47..5da594ab21 100644\n--- a/hazelcast/src/test/java/com/hazelcast/config/XmlConfigImportVariableReplacementTest.java\n+++ b/hazelcast/src/test/java/com/hazelcast/config/XmlConfigImportVariableReplacementTest.java\n\n@@ -404,16 +405,11 @@ public class XmlConfigImportVariableReplacementTest extends AbstractConfigImport\n         assertEquals(\"mymap\", myMapConfig.getName());\n         assertEquals(10, myMapConfig.getTimeToLiveSeconds());\n \n-        // these are the defaults here not overridden with the content of\n-        // the imported document\n-        // this is a difference between importing overlapping XML and YAML\n-        // configuration\n-        // YAML recursively merges the two files\n         assertEquals(1, myMapConfig.getBackupCount());\n         MapStoreConfig myMapStoreConfig = myMapConfig.getMapStoreConfig();\n-        assertEquals(10, myMapStoreConfig.getWriteDelaySeconds());\n-        assertEquals(1, myMapStoreConfig.getWriteBatchSize());\n-        assertNull(myMapStoreConfig.getClassName());\n+        assertEquals(mapStoreWriteDelaySeconds, myMapStoreConfig.getWriteDelaySeconds());\n+        assertEquals(mapStoreWriteBatchSize, myMapStoreConfig.getWriteBatchSize());\n+        assertEquals(mapStoreClassName, myMapStoreConfig.getClassName());\n     }\n \n     @Override\n"}}, {"oid": "2fd281fa69977160445cfd6f05cacba86baca9a2", "url": "https://github.com/hazelcast/hazelcast/commit/2fd281fa69977160445cfd6f05cacba86baca9a2", "message": "Fix wrong assertion in XmlConfigImportVariableReplacementTest", "committedDate": "2020-12-08T14:20:38Z", "type": "commit"}, {"oid": "2fd281fa69977160445cfd6f05cacba86baca9a2", "url": "https://github.com/hazelcast/hazelcast/commit/2fd281fa69977160445cfd6f05cacba86baca9a2", "message": "Fix wrong assertion in XmlConfigImportVariableReplacementTest", "committedDate": "2020-12-08T14:20:38Z", "type": "forcePushed"}, {"oid": "9b03c54b2f3a3eab3395c21bcaa6a8bbcc27efb9", "url": "https://github.com/hazelcast/hazelcast/commit/9b03c54b2f3a3eab3395c21bcaa6a8bbcc27efb9", "message": "Merge branch 'master' of github.com:hazelcast/hazelcast into parser-fix-part-10", "committedDate": "2020-12-08T14:29:18Z", "type": "commit"}]}