{"pr_number": 16759, "pr_title": "Allow to protect management operations on client protocol", "pr_createdAt": "2020-03-16T14:50:38Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16759", "timeline": [{"oid": "f9e59b616c0090b64427b5bf4f64114998dd4a4e", "url": "https://github.com/hazelcast/hazelcast/commit/f9e59b616c0090b64427b5bf4f64114998dd4a4e", "message": "Allow to protect management operations on client protocol. The protection is based on client connection source IP address.", "committedDate": "2020-03-16T14:48:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU0NzA2MQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r393547061", "bodyText": "nit: typo - Child classes which implements should be Child classes which implement", "author": "puzpuzpuz", "createdAt": "2020-03-17T09:32:34Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AbstractMessageTask.java", "diffHunk": "@@ -336,4 +343,15 @@ protected Throwable peelIfNeeded(Throwable t) {\n \n         return peel(t);\n     }\n+\n+\n+    /**\n+     * The default implementation returns false. Child classes which implements a logic related to a management operation should", "originalCommit": "f9e59b616c0090b64427b5bf4f64114998dd4a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c08f24480e0aa15617b33997ca5d35bf2ad2e26e", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AbstractMessageTask.java b/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AbstractMessageTask.java\nindex b0a5ea193c..ae0b5d72b1 100644\n--- a/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AbstractMessageTask.java\n+++ b/hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/AbstractMessageTask.java\n\n@@ -346,7 +346,7 @@ public abstract class AbstractMessageTask<P> implements MessageTask, SecureReque\n \n \n     /**\n-     * The default implementation returns false. Child classes which implements a logic related to a management operation should\n+     * The default implementation returns false. Child classes which implement a logic related to a management operation should\n      * override it and return true so the proper access control mechanism is used.\n      */\n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r393566810", "bodyText": "I'm not sure if we need to mark \"read metrics\" task as an MC operation and restrict the access to it when trusted interfaces config option is in use. Potentially, we may use it elsewhere, say, build a Jet source that reads IMDG metrics.\n@emre-aydin @blazember WDYT?", "author": "puzpuzpuz", "createdAt": "2020-03-17T10:06:05Z", "path": "hazelcast/src/main/java/com/hazelcast/client/impl/protocol/task/metrics/ReadMetricsMessageTask.java", "diffHunk": "@@ -97,5 +97,11 @@ public String getMethodName() {\n     public Object[] getParameters() {\n         return new Object[] {parameters.uuid, parameters.fromSequence};\n     }\n+\n+    @Override\n+    public boolean isManagementTask() {", "originalCommit": "f9e59b616c0090b64427b5bf4f64114998dd4a4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYwOTk4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r393609982", "bodyText": "I think we should be able to change it if we do use it elsewhere later but currently it is used by MC only and I don't see a reason to make it a non-management task. Just my 2c. I wouldn't object to making it a non-management task either.", "author": "emre-aydin", "createdAt": "2020-03-17T11:26:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxOTkwNA==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r394019904", "bodyText": "It could be that my understanding of the requirements is wrong, but isn't the differentiation between the connections and the private APIs in the requirements is to treat this task differently than the other MC tasks? (read: shouldn't this method return false?)", "author": "blazember", "createdAt": "2020-03-17T23:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE1MjQzMw==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r394152433", "bodyText": "The thing is that MC connection (the one with MCJVM connection type) is not not reliable marker for security restrictions. That's why this PR implements restrictions on per operation basis.\nAs for marking \"read metrics\" task as a non-MC one (thus, removing the whitelist restriction), I don't see this clearly stated in requirements. But as it may make some sense in future, I decided to start this discussion.", "author": "puzpuzpuz", "createdAt": "2020-03-18T07:37:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNDk4Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r395024982", "bodyText": "I think, we can split it in the future when the need comes. For now, I would leave the metrics-reading as a management task as it's not available in our official clients.", "author": "kwart", "createdAt": "2020-03-19T13:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA1MjE2Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r395052162", "bodyText": "Sounds good. Marking this one as resolved.", "author": "puzpuzpuz", "createdAt": "2020-03-19T14:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NjgxMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2NzM2NQ==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r393567365", "bodyText": "nit: write a javadoc instead of this empty stub.", "author": "puzpuzpuz", "createdAt": "2020-03-17T10:07:11Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/cluster/AddressChecker.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.internal.cluster;\n+\n+import com.hazelcast.cluster.Address;\n+\n+/**\n+ *", "originalCommit": "f9e59b616c0090b64427b5bf4f64114998dd4a4e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c08f24480e0aa15617b33997ca5d35bf2ad2e26e", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/cluster/AddressChecker.java b/hazelcast/src/main/java/com/hazelcast/internal/cluster/AddressChecker.java\nindex caddf571ba..6ad7333f07 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/cluster/AddressChecker.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/cluster/AddressChecker.java\n\n@@ -19,9 +19,15 @@ package com.hazelcast.internal.cluster;\n import com.hazelcast.cluster.Address;\n \n /**\n- *\n+ * Interface for trust checks based on source {@link Address}.\n  */\n public interface AddressChecker {\n \n+    /**\n+     * Returns {@code true} if the code is trusted.\n+     *\n+     * @param address The {@link Address} to be checked.\n+     * @return {@code true} when trusted; false otherwise\n+     */\n     boolean isTrusted(Address address);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU3MjEyMw==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r393572123", "bodyText": "Is this change related with the purpose of the PR? Probably, it's used somewhere, but I'd like to double check.", "author": "puzpuzpuz", "createdAt": "2020-03-17T10:15:52Z", "path": "hazelcast/src/main/java/com/hazelcast/security/ICredentialsFactory.java", "diffHunk": "@@ -50,6 +51,16 @@ default void init(Properties properties) {\n      */\n     Credentials newCredentials();\n \n+    /**\n+     * Creates new {@link Credentials} object for given target {@link Address}.\n+     *\n+     * @param address Target {@link Address} (may be {@code null})\n+     * @return\n+     */\n+    default Credentials newCredentials(Address address) {", "originalCommit": "f9e59b616c0090b64427b5bf4f64114998dd4a4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAzOTg0OA==", "url": "https://github.com/hazelcast/hazelcast/pull/16759#discussion_r395039848", "bodyText": "Ah, nice catch. This change probably sneaked in from my Kerberos related work.", "author": "kwart", "createdAt": "2020-03-19T13:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU3MjEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "c08f24480e0aa15617b33997ca5d35bf2ad2e26e", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/security/ICredentialsFactory.java b/hazelcast/src/main/java/com/hazelcast/security/ICredentialsFactory.java\nindex 3be51ca1c3..2f194ed4c3 100644\n--- a/hazelcast/src/main/java/com/hazelcast/security/ICredentialsFactory.java\n+++ b/hazelcast/src/main/java/com/hazelcast/security/ICredentialsFactory.java\n\n@@ -51,16 +49,6 @@ public interface ICredentialsFactory {\n      */\n     Credentials newCredentials();\n \n-    /**\n-     * Creates new {@link Credentials} object for given target {@link Address}.\n-     *\n-     * @param address Target {@link Address} (may be {@code null})\n-     * @return\n-     */\n-    default Credentials newCredentials(Address address) {\n-        return newCredentials();\n-    }\n-\n     /**\n      * Destroys {@link ICredentialsFactory}.\n      */\n"}}, {"oid": "c08f24480e0aa15617b33997ca5d35bf2ad2e26e", "url": "https://github.com/hazelcast/hazelcast/commit/c08f24480e0aa15617b33997ca5d35bf2ad2e26e", "message": "cover comments", "committedDate": "2020-03-19T14:09:31Z", "type": "commit"}, {"oid": "79036a96da9e558386db339ecb280e7a0d2b3fe3", "url": "https://github.com/hazelcast/hazelcast/commit/79036a96da9e558386db339ecb280e7a0d2b3fe3", "message": "AuthenticationException->AccessControlException", "committedDate": "2020-03-20T07:36:26Z", "type": "commit"}]}