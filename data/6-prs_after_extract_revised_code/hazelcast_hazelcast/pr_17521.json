{"pr_number": 17521, "pr_title": "Add logging for test: testPostJoinMapOperation_mapWithIndex", "pr_createdAt": "2020-09-10T16:20:11Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/17521", "timeline": [{"oid": "2b0288efb4f4573a3eb7c58b578a0f338aaba0f0", "url": "https://github.com/hazelcast/hazelcast/commit/2b0288efb4f4573a3eb7c58b578a0f338aaba0f0", "message": "Remove reloadOwnedPartitions method", "committedDate": "2020-09-17T07:41:00Z", "type": "forcePushed"}, {"oid": "1d98332357f92b9497cf8e3b41bd53eb1d3b4bf3", "url": "https://github.com/hazelcast/hazelcast/commit/1d98332357f92b9497cf8e3b41bd53eb1d3b4bf3", "message": "Remove reloadOwnedPartitions method", "committedDate": "2020-09-17T08:49:26Z", "type": "forcePushed"}, {"oid": "1823cb3e24c6a33cdf3e96aa89368fd1b54673fa", "url": "https://github.com/hazelcast/hazelcast/commit/1823cb3e24c6a33cdf3e96aa89368fd1b54673fa", "message": "Add trace logging for indexing to MapMigrationService", "committedDate": "2020-09-21T08:20:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NTc0OA==", "url": "https://github.com/hazelcast/hazelcast/pull/17521#discussion_r492585748", "bodyText": "Can you initialise the logger in the constructor?", "author": "mmedenjak", "createdAt": "2020-09-22T09:10:59Z", "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapMigrationAwareService.java", "diffHunk": "@@ -323,6 +330,11 @@ private void depopulateIndexes(PartitionMigrationEvent event) {\n \n             Indexes.markPartitionAsUnindexed(event.getPartitionId(), indexesSnapshot);\n         }\n+\n+        ILogger logger = mapServiceContext.getNodeEngine().getLogger(getClass());", "originalCommit": "1823cb3e24c6a33cdf3e96aa89368fd1b54673fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjYwOTgzMw==", "url": "https://github.com/hazelcast/hazelcast/pull/17521#discussion_r492609833", "bodyText": "done", "author": "ahmetmircik", "createdAt": "2020-09-22T09:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NTc0OA=="}], "type": "inlineReview", "revised_code": {"commit": "9b0dca5a655474dadacce77ad89ff8d7ff298701", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/map/impl/MapMigrationAwareService.java b/hazelcast/src/main/java/com/hazelcast/map/impl/MapMigrationAwareService.java\nindex 90542dc28ce..3fa6b589009 100644\n--- a/hazelcast/src/main/java/com/hazelcast/map/impl/MapMigrationAwareService.java\n+++ b/hazelcast/src/main/java/com/hazelcast/map/impl/MapMigrationAwareService.java\n\n@@ -331,7 +332,6 @@ class MapMigrationAwareService implements FragmentedMigrationAwareService {\n             Indexes.markPartitionAsUnindexed(event.getPartitionId(), indexesSnapshot);\n         }\n \n-        ILogger logger = mapServiceContext.getNodeEngine().getLogger(getClass());\n         if (logger.isFinestEnabled()) {\n             logger.finest(String.format(\"Depopulated indexes at step `%s`:[%s]\", stepName, event));\n         }\n"}}, {"oid": "9b0dca5a655474dadacce77ad89ff8d7ff298701", "url": "https://github.com/hazelcast/hazelcast/commit/9b0dca5a655474dadacce77ad89ff8d7ff298701", "message": "Address Matko's comment", "committedDate": "2020-09-22T09:51:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc5OTc0MA==", "url": "https://github.com/hazelcast/hazelcast/pull/17521#discussion_r495799740", "bodyText": "No need for AtomicReference anymore, you can convert ownedPartitions to a volatile field.", "author": "mdogan", "createdAt": "2020-09-28T09:17:00Z", "path": "hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java", "diffHunk": "@@ -484,34 +484,23 @@ public RecordStore getExistingRecordStore(int partitionId, String mapName) {\n     }\n \n     @Override\n-    public PartitionIdSet getOwnedPartitions() {\n-        PartitionIdSet partitions = ownedPartitions.get();\n-        if (partitions == null) {\n-            do {\n-                reloadOwnedPartitions();\n-                partitions = ownedPartitions.get();\n-            } while (partitions == null);\n+    public PartitionIdSet getOrInitCachedMemberPartitions() {\n+        PartitionIdSet ownedPartitionIdSet = ownedPartitions.get();", "originalCommit": "9b0dca5a655474dadacce77ad89ff8d7ff298701", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNDMyNA==", "url": "https://github.com/hazelcast/hazelcast/pull/17521#discussion_r495814324", "bodyText": "fixed.", "author": "ahmetmircik", "createdAt": "2020-09-28T09:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc5OTc0MA=="}], "type": "inlineReview", "revised_code": {"commit": "880d440f49aa68c569828591683daa4f8229194e", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java b/hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java\nindex d85184fb738..2ae351b2ce4 100644\n--- a/hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java\n+++ b/hazelcast/src/main/java/com/hazelcast/map/impl/MapServiceContextImpl.java\n\n@@ -484,23 +484,34 @@ class MapServiceContextImpl implements MapServiceContext {\n     }\n \n     @Override\n-    public PartitionIdSet getOrInitCachedMemberPartitions() {\n-        PartitionIdSet ownedPartitionIdSet = ownedPartitions.get();\n-        if (ownedPartitionIdSet != null) {\n-            return ownedPartitionIdSet;\n+    public PartitionIdSet getOwnedPartitions() {\n+        PartitionIdSet partitions = ownedPartitions.get();\n+        if (partitions == null) {\n+            do {\n+                reloadOwnedPartitions();\n+                partitions = ownedPartitions.get();\n+            } while (partitions == null);\n         }\n+        return partitions;\n+    }\n \n-        synchronized (this) {\n-            ownedPartitionIdSet = ownedPartitions.get();\n-            if (ownedPartitionIdSet != null) {\n-                return ownedPartitionIdSet;\n-            }\n-            IPartitionService partitionService = nodeEngine.getPartitionService();\n+    /**\n+     * {@inheritDoc}\n+     * <p>\n+     * The method will set the owned partition set in a CAS loop because\n+     * this method can be called concurrently.\n+     */\n+    @Override\n+    public void reloadOwnedPartitions() {\n+        IPartitionService partitionService = nodeEngine.getPartitionService();\n+        for (; ; ) {\n+            PartitionIdSet expected = ownedPartitions.get();\n             Collection<Integer> partitions = partitionService.getMemberPartitions(nodeEngine.getThisAddress());\n-            ownedPartitionIdSet = immutablePartitionIdSet(partitionService.getPartitionCount(), partitions);\n-            ownedPartitions.set(ownedPartitionIdSet);\n+            PartitionIdSet newSet = immutablePartitionIdSet(partitionService.getPartitionCount(), partitions);\n+            if (ownedPartitions.compareAndSet(expected, newSet)) {\n+                return;\n+            }\n         }\n-        return ownedPartitionIdSet;\n     }\n \n     @Override\n"}}, {"oid": "880d440f49aa68c569828591683daa4f8229194e", "url": "https://github.com/hazelcast/hazelcast/commit/880d440f49aa68c569828591683daa4f8229194e", "message": "Polish PostJoinMapOperationTest", "committedDate": "2020-09-28T09:39:29Z", "type": "commit"}, {"oid": "4c70d44cdb98c8da50b2f7871cc7ff45a74d71de", "url": "https://github.com/hazelcast/hazelcast/commit/4c70d44cdb98c8da50b2f7871cc7ff45a74d71de", "message": "Remove reloadOwnedPartitions method", "committedDate": "2020-09-28T09:39:29Z", "type": "commit"}, {"oid": "d8699c5beb26a37fd13725ec6e4dd98815a500ee", "url": "https://github.com/hazelcast/hazelcast/commit/d8699c5beb26a37fd13725ec6e4dd98815a500ee", "message": "Add trace logging for indexing to MapMigrationService", "committedDate": "2020-09-28T09:39:29Z", "type": "commit"}, {"oid": "fdcd4b3ef21235aa015b0b1f7db7faca7b278c6c", "url": "https://github.com/hazelcast/hazelcast/commit/fdcd4b3ef21235aa015b0b1f7db7faca7b278c6c", "message": "Address Matko's comment", "committedDate": "2020-09-28T09:39:29Z", "type": "commit"}, {"oid": "f708d6652c8fd77c49744935393cae92621bc74b", "url": "https://github.com/hazelcast/hazelcast/commit/f708d6652c8fd77c49744935393cae92621bc74b", "message": "Address Mehmet's review comment", "committedDate": "2020-09-28T09:41:20Z", "type": "commit"}, {"oid": "f708d6652c8fd77c49744935393cae92621bc74b", "url": "https://github.com/hazelcast/hazelcast/commit/f708d6652c8fd77c49744935393cae92621bc74b", "message": "Address Mehmet's review comment", "committedDate": "2020-09-28T09:41:20Z", "type": "forcePushed"}]}