{"pr_number": 16872, "pr_title": "Remove assert and log instead ", "pr_createdAt": "2020-04-09T13:08:14Z", "pr_url": "https://github.com/hazelcast/hazelcast/pull/16872", "timeline": [{"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a", "url": "https://github.com/hazelcast/hazelcast/commit/d451733e6fb726af7f8063f9eec651c7bfd5d26a", "message": "Remove assert and log instead", "committedDate": "2020-04-09T13:14:47Z", "type": "commit"}, {"oid": "d451733e6fb726af7f8063f9eec651c7bfd5d26a", "url": "https://github.com/hazelcast/hazelcast/commit/d451733e6fb726af7f8063f9eec651c7bfd5d26a", "message": "Remove assert and log instead", "committedDate": "2020-04-09T13:14:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg==", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406635662", "bodyText": "I'm not fully understanding the logic so I'm not sure how bad the situation actually is when you would run into this assert failure. But if we log it to finest, it is effectively the same as removing the checking completely because it will be lost.\nIsn't it better to throw an exception?", "author": "pveentjer", "createdAt": "2020-04-10T07:16:03Z", "path": "hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java", "diffHunk": "@@ -409,13 +413,21 @@ public int tryAcquireReplicaSyncPermits(int requestedPermits) {\n      */\n     public void releaseReplicaSyncPermits(int permits) {\n         assert permits > 0 : \"Invalid permits: \" + permits;\n+\n         replicaSyncSemaphore.release(permits);\n+\n         if (logger.isFinestEnabled()) {\n-            logger.finest(\"Released \" + permits + \" replica sync permits. Available permits: \"\n-                        + replicaSyncSemaphore.availablePermits());\n+            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+\n+            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n+                    permits, availableReplicaSyncPermits));\n+\n+            if (availableReplicaSyncPermits <= maxParallelReplications) {\n+                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n+                        availableReplicaSyncPermits, maxParallelReplications));\n+\n+            }\n         }", "originalCommit": "d451733e6fb726af7f8063f9eec651c7bfd5d26a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDM1Mw==", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406660353", "bodyText": "I think we should log this as warning. I don't prefer throwing an exception because this might happen when split-brain merge happens concurrently with replica anti-entropy synchronization. But it's a very rare case and when happens, should not cause any significant effect.", "author": "mdogan", "createdAt": "2020-04-10T08:29:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY2MDYyOA==", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406660628", "bodyText": "If we see it happening more frequently, then we can handle it more gracefully.", "author": "mdogan", "createdAt": "2020-04-10T08:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcwMzA4OA==", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406703088", "bodyText": "changed log level to warning.", "author": "ahmetmircik", "createdAt": "2020-04-10T10:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc0MzMwMA==", "url": "https://github.com/hazelcast/hazelcast/pull/16872#discussion_r406743300", "bodyText": "Ok. Warning sounds like a good compromise.", "author": "pveentjer", "createdAt": "2020-04-10T12:50:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYzNTY2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4c6850412a216437d07d3c53c16ef7a02c15f89c", "chunk": "diff --git a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java\nindex b031f7a675..006dd80ef8 100644\n--- a/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java\n+++ b/hazelcast/src/main/java/com/hazelcast/internal/partition/impl/PartitionReplicaManager.java\n\n@@ -409,24 +409,32 @@ public class PartitionReplicaManager implements PartitionReplicaVersionManager {\n     /**\n      * Releases the previously acquired permits.\n      *\n-     * @param permits number of permits\n+     * @param permitsToRelease number of permits\n      */\n-    public void releaseReplicaSyncPermits(int permits) {\n-        assert permits > 0 : \"Invalid permits: \" + permits;\n+    public void releaseReplicaSyncPermits(int permitsToRelease) {\n+        assert permitsToRelease > 0 : \"Invalid permits: \" + permitsToRelease;\n \n-        replicaSyncSemaphore.release(permits);\n+        int availablePermits = availableReplicaSyncPermits();\n+        int acquiredPermits = maxParallelReplications - availablePermits;\n \n-        if (logger.isFinestEnabled()) {\n-            int availableReplicaSyncPermits = availableReplicaSyncPermits();\n+        if (logger.isWarningEnabled() && acquiredPermits < permitsToRelease) {\n+            logger.warning(format(\"Found more replica sync permits than configured max number!\"\n+                            + \" (acquired: %d, available: %d, max: %d)\",\n+                    acquiredPermits, availablePermits, maxParallelReplications));\n+        }\n \n-            logger.finest(format(\"Released %d replica sync permits. Available permits: %d\",\n-                    permits, availableReplicaSyncPermits));\n+        int permits = Math.min(acquiredPermits, permitsToRelease);\n+        if (permits <= 0) {\n+            return;\n+        }\n \n-            if (availableReplicaSyncPermits <= maxParallelReplications) {\n-                logger.finest(format(\"Replica sync permits exceeded the configured number! (available: %d, max: %d)\",\n-                        availableReplicaSyncPermits, maxParallelReplications));\n+        replicaSyncSemaphore.release(permits);\n \n-            }\n+        if (logger.isFinestEnabled()) {\n+            int currentAvailable = availableReplicaSyncPermits();\n+            logger.finest(format(\"Released %d replica sync permits. (acquired: %d, available: %d, max: %d)\",\n+                    permits, maxParallelReplications - currentAvailable,\n+                    currentAvailable, maxParallelReplications));\n         }\n     }\n \n"}}, {"oid": "4c6850412a216437d07d3c53c16ef7a02c15f89c", "url": "https://github.com/hazelcast/hazelcast/commit/4c6850412a216437d07d3c53c16ef7a02c15f89c", "message": "Address review comments", "committedDate": "2020-04-10T10:38:55Z", "type": "commit"}, {"oid": "4c6850412a216437d07d3c53c16ef7a02c15f89c", "url": "https://github.com/hazelcast/hazelcast/commit/4c6850412a216437d07d3c53c16ef7a02c15f89c", "message": "Address review comments", "committedDate": "2020-04-10T10:38:55Z", "type": "forcePushed"}, {"oid": "76046825d3c5d87f522f601298d61726f7a1cc07", "url": "https://github.com/hazelcast/hazelcast/commit/76046825d3c5d87f522f601298d61726f7a1cc07", "message": "Address review comments: pertmitsToRelease", "committedDate": "2020-04-10T10:48:01Z", "type": "commit"}]}