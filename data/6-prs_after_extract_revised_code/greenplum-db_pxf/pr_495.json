{"pr_number": 495, "pr_title": "Hive profile names now split \"protocol\" and \"format\"", "pr_createdAt": "2020-11-17T10:44:46Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/495", "timeline": [{"oid": "2c1ff2d720969018fd1ecdec70372ee00a68bc79", "url": "https://github.com/greenplum-db/pxf/commit/2c1ff2d720969018fd1ecdec70372ee00a68bc79", "message": "changed profile names", "committedDate": "2020-12-16T06:46:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDE5NzgyOQ==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r544197829", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    exTable.setProfile(\"hbaase\");\n          \n          \n            \n                    exTable.setProfile(\"hbase\");", "author": "frankgh", "createdAt": "2020-12-16T10:49:11Z", "path": "automation/src/main/java/org/greenplum/pxf/automation/structures/tables/utils/TableFactory.java", "diffHunk": "@@ -159,7 +159,7 @@ public static ReadableExternalTable getPxfHBaseReadableTable(String tableName,\n                                                                  HBaseTable hbaseTable) {\n         ReadableExternalTable exTable = new ReadableExternalTable(tableName,\n                 fields, hbaseTable.getName(), \"CUSTOM\");\n-        exTable.setProfile(\"HBase\");\n+        exTable.setProfile(\"hbaase\");", "originalCommit": "c434509c665bcfa130c0c90f44effba2b3436d54", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "chunk": "diff --git a/automation/src/main/java/org/greenplum/pxf/automation/structures/tables/utils/TableFactory.java b/automation/src/main/java/org/greenplum/pxf/automation/structures/tables/utils/TableFactory.java\nindex 34d18df7..de7a8168 100755\n--- a/automation/src/main/java/org/greenplum/pxf/automation/structures/tables/utils/TableFactory.java\n+++ b/automation/src/main/java/org/greenplum/pxf/automation/structures/tables/utils/TableFactory.java\n\n@@ -159,7 +159,7 @@ public abstract class TableFactory {\n                                                                  HBaseTable hbaseTable) {\n         ReadableExternalTable exTable = new ReadableExternalTable(tableName,\n                 fields, hbaseTable.getName(), \"CUSTOM\");\n-        exTable.setProfile(\"hbaase\");\n+        exTable.setProfile(\"HBase\");\n         exTable.setFormatter(\"pxfwritable_import\");\n         return exTable;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NzI5NQ==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r545857295", "bodyText": "should we do a case insensitive check here? or are we always lowercasing the profiles?", "author": "frankgh", "createdAt": "2020-12-18T14:16:05Z", "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandler.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.greenplum.pxf.plugins.hive;\n+\n+import org.greenplum.pxf.api.model.ProtocolHandler;\n+import org.greenplum.pxf.api.model.RequestContext;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Implementation of ProtocolHandler for \"hive\" protocol.\n+ */\n+public class HiveProtocolHandler implements ProtocolHandler {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(HiveProtocolHandler.class);\n+    private static final String HIVE_VECTORIZED_ORC_ACCESSOR = HiveORCVectorizedAccessor.class.getName();\n+    private static final String HIVE_VECTORIZED_ORC_RESOLVER = HiveORCVectorizedResolver.class.getName();\n+    private static final String OPTION_VECTORIZE = \"VECTORIZE\";\n+\n+    @Override\n+    public String getFragmenterClassName(RequestContext context) {\n+        return context.getFragmenter(); // default to fragmenter defined by the profile\n+    }\n+\n+    @Override\n+    public String getAccessorClassName(RequestContext context) {\n+        // default to accessor defined by the profile, switch to vectorized if requested by the user\n+        String accessor = useHiveVectorizedORC(context) ? HIVE_VECTORIZED_ORC_ACCESSOR : context.getAccessor();\n+        LOG.debug(\"Determined to use {} accessor\", accessor);\n+        return accessor;\n+    }\n+\n+    @Override\n+    public String getResolverClassName(RequestContext context) {\n+        // default to resolver defined by the profile, switch to vectorized if requested by the user\n+        String resolver = useHiveVectorizedORC(context) ? HIVE_VECTORIZED_ORC_RESOLVER : context.getResolver();\n+        LOG.debug(\"Determined to use {} resolver\", resolver);\n+        return resolver;\n+    }\n+\n+    /**\n+     * Determines whether the user has requested to use vectorized ORC accessor / resolver\n+     * @param context request context\n+     * @return true if vectorized ORC accessor and resolver will need to be used\n+     */\n+    private boolean useHiveVectorizedORC(RequestContext context) {\n+        return (\"hive:orc\".equals(context.getProfile()) && context.getOption(OPTION_VECTORIZE, false));", "originalCommit": "75a7eb2e3dbde1d8b2e3b26dd8e54aca6dabe9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzNDYyNw==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r546034627", "bodyText": "we always lowercase the profile now and options are stored in a case-insensitive map", "author": "denalex", "createdAt": "2020-12-18T19:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg1NzI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "chunk": "diff --git a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandler.java b/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandler.java\ndeleted file mode 100644\nindex 96014aec..00000000\n--- a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandler.java\n+++ /dev/null\n\n@@ -1,48 +0,0 @@\n-package org.greenplum.pxf.plugins.hive;\n-\n-import org.greenplum.pxf.api.model.ProtocolHandler;\n-import org.greenplum.pxf.api.model.RequestContext;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-/**\n- * Implementation of ProtocolHandler for \"hive\" protocol.\n- */\n-public class HiveProtocolHandler implements ProtocolHandler {\n-\n-    private static final Logger LOG = LoggerFactory.getLogger(HiveProtocolHandler.class);\n-    private static final String HIVE_VECTORIZED_ORC_ACCESSOR = HiveORCVectorizedAccessor.class.getName();\n-    private static final String HIVE_VECTORIZED_ORC_RESOLVER = HiveORCVectorizedResolver.class.getName();\n-    private static final String OPTION_VECTORIZE = \"VECTORIZE\";\n-\n-    @Override\n-    public String getFragmenterClassName(RequestContext context) {\n-        return context.getFragmenter(); // default to fragmenter defined by the profile\n-    }\n-\n-    @Override\n-    public String getAccessorClassName(RequestContext context) {\n-        // default to accessor defined by the profile, switch to vectorized if requested by the user\n-        String accessor = useHiveVectorizedORC(context) ? HIVE_VECTORIZED_ORC_ACCESSOR : context.getAccessor();\n-        LOG.debug(\"Determined to use {} accessor\", accessor);\n-        return accessor;\n-    }\n-\n-    @Override\n-    public String getResolverClassName(RequestContext context) {\n-        // default to resolver defined by the profile, switch to vectorized if requested by the user\n-        String resolver = useHiveVectorizedORC(context) ? HIVE_VECTORIZED_ORC_RESOLVER : context.getResolver();\n-        LOG.debug(\"Determined to use {} resolver\", resolver);\n-        return resolver;\n-    }\n-\n-    /**\n-     * Determines whether the user has requested to use vectorized ORC accessor / resolver\n-     * @param context request context\n-     * @return true if vectorized ORC accessor and resolver will need to be used\n-     */\n-    private boolean useHiveVectorizedORC(RequestContext context) {\n-        return (\"hive:orc\".equals(context.getProfile()) && context.getOption(OPTION_VECTORIZE, false));\n-    }\n-\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDIxMA==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r545860210", "bodyText": "we can use a real RequestContext, any reason why not instantiate an object for the test?", "author": "frankgh", "createdAt": "2020-12-18T14:20:57Z", "path": "server/pxf-hive/src/test/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandlerTest.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package org.greenplum.pxf.plugins.hive;\n+\n+import org.greenplum.pxf.api.model.RequestContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class HiveProtocolHandlerTest {\n+\n+    @Mock\n+    RequestContext context;", "originalCommit": "75a7eb2e3dbde1d8b2e3b26dd8e54aca6dabe9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzNTIxNA==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r546035214", "bodyText": "we can (and do in many places), but using mocks for RequestContext is the proper unit testing technique that does not rely on internal implementation of the RequestContext.", "author": "denalex", "createdAt": "2020-12-18T19:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDIxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzNzU3Mw==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r546037573", "bodyText": "either way it's fine, but since RequestContext is a pojo, we should be able to use it a real object.", "author": "frankgh", "createdAt": "2020-12-18T19:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2MDIxMA=="}], "type": "inlineReview", "revised_code": {"commit": "80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "chunk": "diff --git a/server/pxf-hive/src/test/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandlerTest.java b/server/pxf-hive/src/test/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandlerTest.java\ndeleted file mode 100644\nindex 911f6374..00000000\n--- a/server/pxf-hive/src/test/java/org/greenplum/pxf/plugins/hive/HiveProtocolHandlerTest.java\n+++ /dev/null\n\n@@ -1,64 +0,0 @@\n-package org.greenplum.pxf.plugins.hive;\n-\n-import org.greenplum.pxf.api.model.RequestContext;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.ExtendWith;\n-import org.mockito.Mock;\n-import org.mockito.Mockito;\n-import org.mockito.junit.jupiter.MockitoExtension;\n-\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-import static org.mockito.Mockito.when;\n-\n-@ExtendWith(MockitoExtension.class)\n-public class HiveProtocolHandlerTest {\n-\n-    @Mock\n-    RequestContext context;\n-\n-    private HiveProtocolHandler handler;\n-\n-    @BeforeEach\n-    public void setup() {\n-        handler = new HiveProtocolHandler();\n-        when(context.getFragmenter()).thenReturn(\"fragmenter-from-context\");\n-        Mockito.lenient().when(context.getAccessor()).thenReturn(\"accessor-from-context\");\n-        Mockito.lenient().when(context.getResolver()).thenReturn(\"resolver-from-context\");\n-    }\n-\n-    @Test\n-    public void testVectorizedChosenForOrc() {\n-        when(context.getProfile()).thenReturn(\"hive:orc\");\n-        when(context.getOption(\"VECTORIZE\", false)).thenReturn(true);\n-        assertEquals(\"fragmenter-from-context\", handler.getFragmenterClassName(context));\n-        assertEquals(\"org.greenplum.pxf.plugins.hive.HiveORCVectorizedAccessor\", handler.getAccessorClassName(context));\n-        assertEquals(\"org.greenplum.pxf.plugins.hive.HiveORCVectorizedResolver\", handler.getResolverClassName(context));\n-    }\n-\n-    @Test\n-    public void testVectorizedNotChosenForOrc_VectorizedOptionMissing() {\n-        when(context.getProfile()).thenReturn(\"hive:orc\");\n-        assertEquals(\"fragmenter-from-context\", handler.getFragmenterClassName(context));\n-        assertEquals(\"accessor-from-context\", handler.getAccessorClassName(context));\n-        assertEquals(\"resolver-from-context\", handler.getResolverClassName(context));\n-    }\n-\n-    @Test\n-    public void testVectorizedNotChosenForOrc_VectorizedOptionSetFalse() {\n-        when(context.getProfile()).thenReturn(\"hive:orc\");\n-        when(context.getOption(\"VECTORIZE\", false)).thenReturn(false);\n-        assertEquals(\"fragmenter-from-context\", handler.getFragmenterClassName(context));\n-        assertEquals(\"accessor-from-context\", handler.getAccessorClassName(context));\n-        assertEquals(\"resolver-from-context\", handler.getResolverClassName(context));\n-    }\n-\n-    @Test\n-    public void testVectorizedNotChosenForOther() {\n-        when(context.getProfile()).thenReturn(\"hive:other\");\n-        Mockito.lenient().when(context.getOption(\"VECTORIZE\", false)).thenReturn(true);\n-        assertEquals(\"fragmenter-from-context\", handler.getFragmenterClassName(context));\n-        assertEquals(\"accessor-from-context\", handler.getAccessorClassName(context));\n-        assertEquals(\"resolver-from-context\", handler.getResolverClassName(context));\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2NDYwMg==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r545864602", "bodyText": "i see that we always lowercase the profile", "author": "frankgh", "createdAt": "2020-12-18T14:28:12Z", "path": "server/pxf-service/src/test/java/org/greenplum/pxf/service/HttpRequestParserTest.java", "diffHunk": "@@ -432,7 +431,25 @@ public void protocolIsSetWhenProfileIsSpecified() {\n         RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n \n         assertEquals(\"test-protocol\", context.getProfileScheme());\n+    }\n+\n+    @Test\n+    public void protocolIsSetWhenProfileIsSpecifiedInMixedCase() {\n+        parameters.add(\"X-GP-OPTIONS-PROFILE\", \"teST-pROFile\");\n+        when(mockPluginConf.getProtocol(\"test-profile\")).thenReturn(\"test-protocol\");\n+\n+        RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n+\n+        assertEquals(\"test-protocol\", context.getProfileScheme());\n+    }\n+\n+    @Test\n+    public void profileIsSetInLowerCase() {\n+        parameters.add(\"X-GP-OPTIONS-PROFILE\", \"teST-pROFile\");\n+\n+        RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n \n+        assertEquals(\"test-profile\", context.getProfile());", "originalCommit": "75a7eb2e3dbde1d8b2e3b26dd8e54aca6dabe9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzNDI1OQ==", "url": "https://github.com/greenplum-db/pxf/pull/495#discussion_r546034259", "bodyText": "yes, we do now", "author": "denalex", "createdAt": "2020-12-18T19:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg2NDYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "chunk": "diff --git a/server/pxf-service/src/test/java/org/greenplum/pxf/service/HttpRequestParserTest.java b/server/pxf-service/src/test/java/org/greenplum/pxf/service/HttpRequestParserTest.java\nindex a81b4bd1..34fd6a1c 100644\n--- a/server/pxf-service/src/test/java/org/greenplum/pxf/service/HttpRequestParserTest.java\n+++ b/server/pxf-service/src/test/java/org/greenplum/pxf/service/HttpRequestParserTest.java\n\n@@ -431,25 +432,7 @@ public class HttpRequestParserTest {\n         RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n \n         assertEquals(\"test-protocol\", context.getProfileScheme());\n-    }\n-\n-    @Test\n-    public void protocolIsSetWhenProfileIsSpecifiedInMixedCase() {\n-        parameters.add(\"X-GP-OPTIONS-PROFILE\", \"teST-pROFile\");\n-        when(mockPluginConf.getProtocol(\"test-profile\")).thenReturn(\"test-protocol\");\n-\n-        RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n-\n-        assertEquals(\"test-protocol\", context.getProfileScheme());\n-    }\n-\n-    @Test\n-    public void profileIsSetInLowerCase() {\n-        parameters.add(\"X-GP-OPTIONS-PROFILE\", \"teST-pROFile\");\n-\n-        RequestContext context = parser.parseRequest(parameters, RequestType.FRAGMENTER);\n \n-        assertEquals(\"test-profile\", context.getProfile());\n     }\n \n     @Test\n"}}, {"oid": "80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "url": "https://github.com/greenplum-db/pxf/commit/80e3bc6ed44b9ef0e4928b79e9318f1ac59db1ba", "message": "Hive profile names now split \"protocol\" and \"format\"\n\nThe hive profile names do not follow the \"protocol\":\"format\" naming\nconvention introduced for HCFS profiles. This commit adds Hive profile\nnames with the new format. For example, `HiveORC` becomes `hive:orc`.", "committedDate": "2020-12-18T19:22:01Z", "type": "commit"}, {"oid": "ab5df2bcb4969ab2642443843367ca2c53dcbac6", "url": "https://github.com/greenplum-db/pxf/commit/ab5df2bcb4969ab2642443843367ca2c53dcbac6", "message": "changed profile names", "committedDate": "2020-12-18T19:31:44Z", "type": "commit"}, {"oid": "5d1ce1b6216ec4546bf89ec4cd8a02bcecb3517e", "url": "https://github.com/greenplum-db/pxf/commit/5d1ce1b6216ec4546bf89ec4cd8a02bcecb3517e", "message": "fixed unit test", "committedDate": "2020-12-18T19:31:44Z", "type": "commit"}, {"oid": "576857c7aeab2779d05224bc97b0047df365aa29", "url": "https://github.com/greenplum-db/pxf/commit/576857c7aeab2779d05224bc97b0047df365aa29", "message": "fix hbase, change jdbc", "committedDate": "2020-12-18T19:31:44Z", "type": "commit"}, {"oid": "c9f49dece37cfe0fe6c2a5b95d446e49855b189a", "url": "https://github.com/greenplum-db/pxf/commit/c9f49dece37cfe0fe6c2a5b95d446e49855b189a", "message": "introduced HiveProtocolHandler", "committedDate": "2020-12-18T19:31:44Z", "type": "commit"}, {"oid": "4b69170bf57bf619beeaa2a6550288823a968c10", "url": "https://github.com/greenplum-db/pxf/commit/4b69170bf57bf619beeaa2a6550288823a968c10", "message": "updated system profiles header", "committedDate": "2020-12-18T19:34:45Z", "type": "commit"}, {"oid": "4b69170bf57bf619beeaa2a6550288823a968c10", "url": "https://github.com/greenplum-db/pxf/commit/4b69170bf57bf619beeaa2a6550288823a968c10", "message": "updated system profiles header", "committedDate": "2020-12-18T19:34:45Z", "type": "forcePushed"}]}