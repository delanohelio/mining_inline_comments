{"pr_number": 486, "pr_title": "Serialize Fragment metadata using Kryo", "pr_createdAt": "2020-11-11T17:05:49Z", "pr_url": "https://github.com/greenplum-db/pxf/pull/486", "timeline": [{"oid": "3e592c124d00034950ca98978830fce53fc5e73c", "url": "https://github.com/greenplum-db/pxf/commit/3e592c124d00034950ca98978830fce53fc5e73c", "message": "Serialize Fragment metadata using Kryo\n\nIn PXF 5.16.0, we introduced Kryo to serialize Fragment's userData for\nHive profiles. The original version of boot, combines Fragment metadata\nand userData into metadata. It also serializes metadata into a escaped\nJSON, that is then deserialized by the HttpRequestParser during the\nbridge call. This introduces a regression in the Hive metadata\noptimization. To reduce the payload size, we now serialize metadata\nusing kryo instead of JSON. This commit fixes the regression introduced\nby the original version of boot.", "committedDate": "2020-11-11T19:23:27Z", "type": "commit"}, {"oid": "3e592c124d00034950ca98978830fce53fc5e73c", "url": "https://github.com/greenplum-db/pxf/commit/3e592c124d00034950ca98978830fce53fc5e73c", "message": "Serialize Fragment metadata using Kryo\n\nIn PXF 5.16.0, we introduced Kryo to serialize Fragment's userData for\nHive profiles. The original version of boot, combines Fragment metadata\nand userData into metadata. It also serializes metadata into a escaped\nJSON, that is then deserialized by the HttpRequestParser during the\nbridge call. This introduces a regression in the Hive metadata\noptimization. To reduce the payload size, we now serialize metadata\nusing kryo instead of JSON. This commit fixes the regression introduced\nby the original version of boot.", "committedDate": "2020-11-11T19:23:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyMzk4Mw==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526323983", "bodyText": "if this becomes a marker interface only, do we still need it ?", "author": "denalex", "createdAt": "2020-11-18T18:26:19Z", "path": "server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/FragmentMetadata.java", "diffHunk": "@@ -19,16 +19,9 @@\n \n package org.greenplum.pxf.api.utilities;\n \n-import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n-\n /**\n  * Interface that represents Fragment metadata. Each profile can implement it's\n  * own metadata object\n  */\n-@JsonIgnoreProperties(value={ \"className\" }, allowGetters=true)\n public interface FragmentMetadata {", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0NjAxMg==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526346012", "bodyText": "yeah, this is the type we use in  RequestContext for fragment metadata", "author": "frankgh", "createdAt": "2020-11-18T19:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyMzk4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyNzM1Mw==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526327353", "bodyText": "let's mention the soft references ensure the instances in the queue should get deleted when there's a GC memory pressure", "author": "denalex", "createdAt": "2020-11-18T18:31:33Z", "path": "server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.greenplum.pxf.api.utilities;\n+\n+import com.esotericsoftware.kryo.Kryo;\n+import com.esotericsoftware.kryo.pool.KryoFactory;\n+import com.esotericsoftware.kryo.pool.KryoPool;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class SerializationService {\n+\n+    private final KryoPool kryoPool;\n+\n+    public SerializationService() {\n+        // A simple factory that creates kryo objects\n+        KryoFactory factory = Kryo::new;\n+        kryoPool = new KryoPool.Builder(factory).softReferences().build();\n+    }\n+\n+    /**\n+     * By default, kryo pool uses ConcurrentLinkedQueue which is unbounded. To facilitate reuse of\n+     * kryo object call releaseKryo() after done using the kryo instance. The class loader for the\n+     * kryo instance will be set to current thread's context class loader.", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "chunk": "diff --git a/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java b/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\nindex 73fa778b..fb350900 100644\n--- a/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\n+++ b/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\n\n@@ -5,6 +5,10 @@ import com.esotericsoftware.kryo.pool.KryoFactory;\n import com.esotericsoftware.kryo.pool.KryoPool;\n import org.springframework.stereotype.Service;\n \n+/**\n+ * The SerializationService class provides {@link Kryo} instances from a\n+ * {@link KryoPool} for serialization/deserialization of objects.\n+ */\n @Service\n public class SerializationService {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyODM3MQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526328371", "bodyText": "are we sure we don't need to reset the classloader back to what it was before ?", "author": "denalex", "createdAt": "2020-11-18T18:33:21Z", "path": "server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.greenplum.pxf.api.utilities;\n+\n+import com.esotericsoftware.kryo.Kryo;\n+import com.esotericsoftware.kryo.pool.KryoFactory;\n+import com.esotericsoftware.kryo.pool.KryoPool;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class SerializationService {\n+\n+    private final KryoPool kryoPool;\n+\n+    public SerializationService() {\n+        // A simple factory that creates kryo objects\n+        KryoFactory factory = Kryo::new;\n+        kryoPool = new KryoPool.Builder(factory).softReferences().build();\n+    }\n+\n+    /**\n+     * By default, kryo pool uses ConcurrentLinkedQueue which is unbounded. To facilitate reuse of\n+     * kryo object call releaseKryo() after done using the kryo instance. The class loader for the\n+     * kryo instance will be set to current thread's context class loader.\n+     *\n+     * @return kryo instance\n+     */\n+    public Kryo borrowKryo() {\n+        Kryo kryo = kryoPool.borrow();\n+        kryo.setClassLoader(Thread.currentThread().getContextClassLoader());\n+        return kryo;\n+    }\n+\n+    /**\n+     * Release kryo instance back to the pool.\n+     *\n+     * @param kryo - kryo instance to be released\n+     */\n+    public void releaseKryo(Kryo kryo) {\n+        kryoPool.release(kryo);", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM0OTk3OA==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526349978", "bodyText": "It's not necessary, the classloader will always be set when we borrow the kryo object. No need to have the kryo classloader set when they are in the pool waiting to be consumed", "author": "frankgh", "createdAt": "2020-11-18T19:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NzM3Mg==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526367372", "bodyText": "yea, I guess it would be needed if we were to unload the web app so that they can be GC-ed, but probably not that important for Boot, and maybe even setting the class loader in the first place is not necessary as all the class loaders will be the same, no ?", "author": "denalex", "createdAt": "2020-11-18T19:36:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyODM3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2ODMzMw==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526368333", "bodyText": "maybe, but I think it's okay to keep it as is", "author": "frankgh", "createdAt": "2020-11-18T19:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyODM3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "chunk": "diff --git a/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java b/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\nindex 73fa778b..fb350900 100644\n--- a/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\n+++ b/server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/SerializationService.java\n\n@@ -5,6 +5,10 @@ import com.esotericsoftware.kryo.pool.KryoFactory;\n import com.esotericsoftware.kryo.pool.KryoPool;\n import org.springframework.stereotype.Service;\n \n+/**\n+ * The SerializationService class provides {@link Kryo} instances from a\n+ * {@link KryoPool} for serialization/deserialization of objects.\n+ */\n @Service\n public class SerializationService {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMyOTAxNA==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526329014", "bodyText": "this is no longer a JSON (variable name) :)", "author": "denalex", "createdAt": "2020-11-18T18:34:17Z", "path": "server/pxf-api/src/test/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDeTest.java", "diffHunk": "@@ -36,60 +35,48 @@ public void testSerialize() throws JsonProcessingException {\n         mapper.registerModule(module);\n \n         DemoFragmentMetadata metadata = new DemoFragmentMetadata(\"abc\");\n-        assertEquals(\"\\\"{\\\\\\\"path\\\\\\\":\\\\\\\"abc\\\\\\\",\\\\\\\"className\\\\\\\":\\\\\\\"org.greenplum.pxf.api.examples.DemoFragmentMetadata\\\\\\\"}\\\"\", mapper.writeValueAsString(metadata));\n+        assertEquals(\"\\\"AQBvcmcuZ3JlZW5wbHVtLnB4Zi5hcGkuZXhhbXBsZXMuRGVtb0ZyYWdtZW50TWV0YWRhdOEBAWFi4w==\\\"\",\n+                mapper.writeValueAsString(metadata));\n \n         TestFragmentMetadata testMetadata = new TestFragmentMetadata(\"test\", 5, 10, new Date(1590649200000L), \"foo\".getBytes(StandardCharsets.UTF_8));\n-        assertEquals(\"\\\"{\\\\\\\"a\\\\\\\":\\\\\\\"test\\\\\\\",\\\\\\\"b\\\\\\\":5,\\\\\\\"c\\\\\\\":10,\\\\\\\"d\\\\\\\":1590649200000,\\\\\\\"e\\\\\\\":\\\\\\\"Zm9v\\\\\\\",\\\\\\\"className\\\\\\\":\\\\\\\"org.greenplum.pxf.api.utilities.FragmentMetadataSerDeTest$TestFragmentMetadata\\\\\\\"}\\\"\",\n+        assertEquals(\"\\\"AQDPAW9yZy5ncmVlbnBsdW0ucHhmLmFwaS51dGlsaXRpZXMuRnJhZ21lbnRNZXRhZGF0YVNlckRlVGVzdCRUZXN0RnJhZ21lbnRNZXRhZGF0YQEBdGVz9AoUAQFqYXZhLnNxbC5EYXTlAYC70tClLgEEZm9v\\\"\",\n                 mapper.writeValueAsString(testMetadata));\n     }\n \n     @Test\n-    public void testDeserialize() throws JsonProcessingException {\n+    public void testDeserialize() {\n \n-        String metadataJson = \"{\\\"path\\\": \\\"deserialize me\\\", \\\"className\\\": \\\"org.greenplum.pxf.api.examples.DemoFragmentMetadata\\\" }\";\n+        String metadataJson = \"\\\"AQBvcmcuZ3JlZW5wbHVtLnB4Zi5hcGkuZXhhbXBsZXMuRGVtb0ZyYWdtZW50TWV0YWRhdOEBAWFi4w==\\\"\";", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "chunk": "diff --git a/server/pxf-api/src/test/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDeTest.java b/server/pxf-api/src/test/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDeTest.java\nindex 01db9868..8797bc4c 100644\n--- a/server/pxf-api/src/test/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDeTest.java\n+++ b/server/pxf-api/src/test/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDeTest.java\n\n@@ -46,16 +46,16 @@ class FragmentMetadataSerDeTest {\n     @Test\n     public void testDeserialize() {\n \n-        String metadataJson = \"\\\"AQBvcmcuZ3JlZW5wbHVtLnB4Zi5hcGkuZXhhbXBsZXMuRGVtb0ZyYWdtZW50TWV0YWRhdOEBAWFi4w==\\\"\";\n+        String metadataString = \"\\\"AQBvcmcuZ3JlZW5wbHVtLnB4Zi5hcGkuZXhhbXBsZXMuRGVtb0ZyYWdtZW50TWV0YWRhdOEBAWFi4w==\\\"\";\n \n-        FragmentMetadata metadata = metadataSerDe.deserialize(metadataJson);\n+        FragmentMetadata metadata = metadataSerDe.deserialize(metadataString);\n         assertNotNull(metadata);\n         assertTrue(metadata instanceof DemoFragmentMetadata);\n         assertEquals(\"abc\", ((DemoFragmentMetadata) metadata).getPath());\n \n-        String testMetadataJson = \"\\\"AQDPAW9yZy5ncmVlbnBsdW0ucHhmLmFwaS51dGlsaXRpZXMuRnJhZ21lbnRNZXRhZGF0YVNlckRlVGVzdCRUZXN0RnJhZ21lbnRNZXRhZGF0YQEBdGVz9AoUAQFqYXZhLnNxbC5EYXTlAYC70tClLgEEZm9v\\\"\";\n+        String testMetadataString = \"\\\"AQDPAW9yZy5ncmVlbnBsdW0ucHhmLmFwaS51dGlsaXRpZXMuRnJhZ21lbnRNZXRhZGF0YVNlckRlVGVzdCRUZXN0RnJhZ21lbnRNZXRhZGF0YQEBdGVz9AoUAQFqYXZhLnNxbC5EYXTlAYC70tClLgEEZm9v\\\"\";\n \n-        FragmentMetadata testMetadata = metadataSerDe.deserialize(testMetadataJson);\n+        FragmentMetadata testMetadata = metadataSerDe.deserialize(testMetadataString);\n         assertNotNull(testMetadata);\n         assertTrue(testMetadata instanceof TestFragmentMetadata);\n         TestFragmentMetadata testFragmentMetadata = (TestFragmentMetadata) testMetadata;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzMTg5OQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526331899", "bodyText": "do we need to release kryo here ?", "author": "denalex", "createdAt": "2020-11-18T18:38:57Z", "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveAccessor.java", "diffHunk": "@@ -657,9 +656,17 @@ JobConf getJobConf() {\n         return jobConf;\n     }\n \n-    protected Properties getSerdeProperties(byte[] userData) {\n-        if (userData == null)\n-            throw new IllegalArgumentException(\"propsString is mandatory to initialize serde.\");\n-        return hiveUtilities.getKryo().readObject(new Input(userData), Properties.class);\n+\n+    /**\n+     * Serializes an object into a Base64 encoded String using Kryo serialization\n+     *\n+     * @param object the object to serialize\n+     * @return the serialized object as a String\n+     */\n+    private String toKryoString(Object object) {\n+        Output out = new Output(4 * 1024, 10 * 1024 * 1024);\n+        hiveUtilities.getKryo().writeObject(out, object);\n+        out.close();", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2ODU5MA==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526368590", "bodyText": "done", "author": "frankgh", "createdAt": "2020-11-18T19:38:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzMTg5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "chunk": "diff --git a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveAccessor.java b/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveAccessor.java\nindex 8ab2877d..77aa2d2f 100644\n--- a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveAccessor.java\n+++ b/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/HiveAccessor.java\n\n@@ -665,7 +667,13 @@ public class HiveAccessor extends HdfsSplittableDataAccessor {\n      */\n     private String toKryoString(Object object) {\n         Output out = new Output(4 * 1024, 10 * 1024 * 1024);\n-        hiveUtilities.getKryo().writeObject(out, object);\n+\n+        Kryo kryo = serializationService.borrowKryo();\n+        try {\n+            kryo.writeObject(out, object);\n+        } finally {\n+            serializationService.releaseKryo(kryo);\n+        }\n         out.close();\n         return Base64.encodeBase64String(out.toBytes());\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNTY2Ng==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526335666", "bodyText": "are we still using thread locals ? I thought we now use KryoPool ?", "author": "denalex", "createdAt": "2020-11-18T18:45:01Z", "path": "server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java", "diffHunk": "@@ -57,7 +56,6 @@\n     // serializer is thread safe.\n     private final ThreadLocal<Kryo> kryo = ThreadLocal.withInitial(() -> {", "originalCommit": "3e592c124d00034950ca98978830fce53fc5e73c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM1MDM3Nw==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526350377", "bodyText": "we should use Kryo from the pool here, I'll fix it", "author": "frankgh", "createdAt": "2020-11-18T19:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNTY2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "chunk": "diff --git a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java b/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java\nindex dd4aac79..4cdbfd0e 100644\n--- a/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java\n+++ b/server/pxf-hive/src/main/java/org/greenplum/pxf/plugins/hive/utilities/HiveUtilities.java\n\n@@ -51,14 +49,6 @@ public class HiveUtilities {\n \n     private static final int DEFAULT_DELIMITER_CODE = 44;\n \n-    // The Kryo instance is not thread safe, and quite expensive to build,\n-    // storing it on a ThreadLocal is a recommended way to make sure that the\n-    // serializer is thread safe.\n-    private final ThreadLocal<Kryo> kryo = ThreadLocal.withInitial(() -> {\n-        Kryo k = new Kryo();\n-        return k;\n-    });\n-\n     /**\n      * Checks if hive type is supported, and if so return its matching GPDB\n      * type. Unsupported types will result in an exception. <br>\n"}}, {"oid": "7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "url": "https://github.com/greenplum-db/pxf/commit/7d263597736bf2e048ee2ac153d54f2d1cb0d0ed", "message": "Address PR Feedback", "committedDate": "2020-11-18T19:21:03Z", "type": "commit"}, {"oid": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "url": "https://github.com/greenplum-db/pxf/commit/a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "message": "address PR feedback", "committedDate": "2020-11-18T19:23:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NTQ0OQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526365449", "bodyText": "Should we use named constants here? I am assuming this is 4kb and 10MB but I could be wrong.", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:33:22Z", "path": "server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDe.java", "diffHunk": "@@ -1,55 +1,56 @@\n package org.greenplum.pxf.api.utilities;\n \n+import com.esotericsoftware.kryo.Kryo;\n+import com.esotericsoftware.kryo.io.Input;\n+import com.esotericsoftware.kryo.io.Output;\n import com.fasterxml.jackson.core.JsonGenerator;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.SerializerProvider;\n import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+import org.apache.commons.codec.binary.Base64;\n import org.springframework.stereotype.Component;\n \n import java.io.IOException;\n \n /**\n- * This class serializes and deserializes {@link FragmentMetadata} objects into\n- * JSON.\n+ * This class serializes and deserializes {@link FragmentMetadata} objects.\n  */\n @Component\n public class FragmentMetadataSerDe extends StdSerializer<FragmentMetadata> {\n \n     private static final long serialVersionUID = 123173996615107417L;\n-    private static final String CLASSNAME = \"className\";\n-\n-    private final ObjectMapper mapper;\n+    private final SerializationService serializationService;\n \n     /**\n      * Private constructor to prevent initialization\n      */\n-    public FragmentMetadataSerDe() {\n+    public FragmentMetadataSerDe(SerializationService serializationService) {\n         super(FragmentMetadata.class);\n-        mapper = new ObjectMapper();\n+        this.serializationService = serializationService;\n     }\n \n     @Override\n-    public void serialize(FragmentMetadata value, JsonGenerator gen, SerializerProvider provider) throws IOException {\n-        gen.writeString(mapper.writeValueAsString(value));\n-    }\n-\n-    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n-    public FragmentMetadata deserialize(String json) throws JsonProcessingException {\n-        JsonNode node = mapper.readTree(json);\n-        String className = node.get(CLASSNAME).textValue();\n-\n-        Class klass = getObjectClass(className);\n-        return (FragmentMetadata) mapper.readValue(json, klass);\n+    public void serialize(FragmentMetadata value, JsonGenerator gen, SerializerProvider provider)\n+            throws IOException {\n+        Output out = new Output(4 * 1024, 10 * 1024 * 1024);", "originalCommit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NTI4OQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526455289", "bodyText": "I think we were using named constants, not sure at what point that changed", "author": "frankgh", "createdAt": "2020-11-18T22:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2NTQ0OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2OTM2MQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526369361", "bodyText": "Is the encoding done by the writeClassAndObject() call or the writeBinary() call? It seems odd that serialize doesn't have an explicit call to encode to Base64 but that deserialize does have a call to decode.", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:39:32Z", "path": "server/pxf-api/src/main/java/org/greenplum/pxf/api/utilities/FragmentMetadataSerDe.java", "diffHunk": "@@ -1,55 +1,56 @@\n package org.greenplum.pxf.api.utilities;\n \n+import com.esotericsoftware.kryo.Kryo;\n+import com.esotericsoftware.kryo.io.Input;\n+import com.esotericsoftware.kryo.io.Output;\n import com.fasterxml.jackson.core.JsonGenerator;\n-import com.fasterxml.jackson.core.JsonProcessingException;\n-import com.fasterxml.jackson.databind.JsonNode;\n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.fasterxml.jackson.databind.SerializerProvider;\n import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+import org.apache.commons.codec.binary.Base64;\n import org.springframework.stereotype.Component;\n \n import java.io.IOException;\n \n /**\n- * This class serializes and deserializes {@link FragmentMetadata} objects into\n- * JSON.\n+ * This class serializes and deserializes {@link FragmentMetadata} objects.\n  */\n @Component\n public class FragmentMetadataSerDe extends StdSerializer<FragmentMetadata> {\n \n     private static final long serialVersionUID = 123173996615107417L;\n-    private static final String CLASSNAME = \"className\";\n-\n-    private final ObjectMapper mapper;\n+    private final SerializationService serializationService;\n \n     /**\n      * Private constructor to prevent initialization\n      */\n-    public FragmentMetadataSerDe() {\n+    public FragmentMetadataSerDe(SerializationService serializationService) {\n         super(FragmentMetadata.class);\n-        mapper = new ObjectMapper();\n+        this.serializationService = serializationService;\n     }\n \n     @Override\n-    public void serialize(FragmentMetadata value, JsonGenerator gen, SerializerProvider provider) throws IOException {\n-        gen.writeString(mapper.writeValueAsString(value));\n-    }\n-\n-    @SuppressWarnings({\"unchecked\", \"rawtypes\"})\n-    public FragmentMetadata deserialize(String json) throws JsonProcessingException {\n-        JsonNode node = mapper.readTree(json);\n-        String className = node.get(CLASSNAME).textValue();\n-\n-        Class klass = getObjectClass(className);\n-        return (FragmentMetadata) mapper.readValue(json, klass);\n+    public void serialize(FragmentMetadata value, JsonGenerator gen, SerializerProvider provider)\n+            throws IOException {\n+        Output out = new Output(4 * 1024, 10 * 1024 * 1024);\n+        Kryo kryo = serializationService.borrowKryo();\n+        try {\n+            kryo.writeClassAndObject(out, value);\n+            out.close();\n+            // Serialized fragment metadata is base64 encoded", "originalCommit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NjU1Mw==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526456553", "bodyText": "encoding is done by jackson, so that means it's done in writeBinary", "author": "frankgh", "createdAt": "2020-11-18T22:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM2OTM2MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MTgyMg==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526371822", "bodyText": "It doesn't look like the class as setters generated. Did we need to remove the final modifiers because of how kyro does serialization and deserialization?", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:43:43Z", "path": "server/pxf-hbase/src/main/java/org/greenplum/pxf/plugins/hbase/HBaseFragmentMetadata.java", "diffHunk": "@@ -12,23 +11,20 @@\n  * Fragment metadata for HBase profiles\n  */\n @Getter\n+@NoArgsConstructor\n public class HBaseFragmentMetadata implements FragmentMetadata {\n \n-    private final byte[] startKey;\n+    private byte[] startKey;", "originalCommit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NTg4NQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526455885", "bodyText": "we need to remove final because of the @NoArgsConstructor which is required by kryo", "author": "frankgh", "createdAt": "2020-11-18T22:09:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MTgyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MjQzNg==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526372436", "bodyText": "Echoing my comment from HBaseFragmentMetadata above.", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:44:43Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/HcfsFragmentMetadata.java", "diffHunk": "@@ -1,27 +1,24 @@\n package org.greenplum.pxf.plugins.hdfs;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.fasterxml.jackson.annotation.JsonProperty;\n import lombok.Getter;\n+import lombok.NoArgsConstructor;\n import org.apache.hadoop.mapred.FileSplit;\n import org.greenplum.pxf.api.utilities.FragmentMetadata;\n \n+@NoArgsConstructor\n public class HcfsFragmentMetadata implements FragmentMetadata {\n \n     @Getter\n-    private final long start;\n+    protected long start;", "originalCommit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzUyOQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526457529", "bodyText": "again, we need it for the constructor with no arguments", "author": "frankgh", "createdAt": "2020-11-18T22:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3MjQzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3NDA3OQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526374079", "bodyText": "Context question: did some other code change require a change in this methods signature?", "author": "bradfordb-vmware", "createdAt": "2020-11-18T19:47:23Z", "path": "server/pxf-hdfs/src/main/java/org/greenplum/pxf/plugins/hdfs/utilities/HdfsUtilities.java", "diffHunk": "@@ -53,18 +44,16 @@\n      * fragment metadata is null, a {@link FileSplit} with zero start and length\n      * is returned.\n      *\n-     * @param context request input data\n+     * @param file     the file name for the split\n+     * @param metadata the fragment metadataa\n      * @return FileSplit with fragment metadata\n      */\n-    public static FileSplit parseFileSplit(RequestContext context) {\n-        HcfsFragmentMetadata metadata = context.getFragmentMetadata();\n-\n+    public static FileSplit parseFileSplit(String file, HcfsFragmentMetadata metadata) {", "originalCommit": "a77ced854baa435bbcb6827dfa9d8f7d8f23b2eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQ1NzI5OQ==", "url": "https://github.com/greenplum-db/pxf/pull/486#discussion_r526457299", "bodyText": "we only need two pieces of information from the RequestContext to build the FileSplit, so we just pass what we need.", "author": "frankgh", "createdAt": "2020-11-18T22:12:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM3NDA3OQ=="}], "type": "inlineReview", "revised_code": null}]}