{"pr_number": 453, "pr_title": "[E2E Integration] Fix Multiple Issues in E2E Integration", "pr_createdAt": "2020-10-28T21:31:56Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/453", "timeline": [{"oid": "24b9b76ae349f277ac55f1cc11e81636d1569b6d", "url": "https://github.com/futurewei-cloud/alcor/commit/24b9b76ae349f277ac55f1cc11e81636d1569b6d", "message": "commit message", "committedDate": "2020-10-07T21:49:22Z", "type": "commit"}, {"oid": "08ec421662ef56559a388e6c7308aa47cfd07a6b", "url": "https://github.com/futurewei-cloud/alcor/commit/08ec421662ef56559a388e6c7308aa47cfd07a6b", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-07T22:00:25Z", "type": "commit"}, {"oid": "2507b8fc44a4ca94da310b73c11453cec9f2504b", "url": "https://github.com/futurewei-cloud/alcor/commit/2507b8fc44a4ca94da310b73c11453cec9f2504b", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-15T17:12:49Z", "type": "commit"}, {"oid": "8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "url": "https://github.com/futurewei-cloud/alcor/commit/8cab6bfa9573926c29b9f8dbbeab732a9de1da7e", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-15T23:33:06Z", "type": "commit"}, {"oid": "d9d2a5822429286e2b01ce0842f16cb70dc5168f", "url": "https://github.com/futurewei-cloud/alcor/commit/d9d2a5822429286e2b01ce0842f16cb70dc5168f", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-16T16:57:50Z", "type": "commit"}, {"oid": "daba98ee8949b91b2b77f74c6fbb30529355ee51", "url": "https://github.com/futurewei-cloud/alcor/commit/daba98ee8949b91b2b77f74c6fbb30529355ee51", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-20T00:03:13Z", "type": "commit"}, {"oid": "b813735c5032b70928a2304007875824f5ccedca", "url": "https://github.com/futurewei-cloud/alcor/commit/b813735c5032b70928a2304007875824f5ccedca", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-22T17:43:05Z", "type": "commit"}, {"oid": "fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "url": "https://github.com/futurewei-cloud/alcor/commit/fd9a9847b0f42c5a7fd089ea09fa6f24233d008e", "message": "Merge branch 'master' of https://github.com/futurewei-cloud/alcor into new_master", "committedDate": "2020-10-28T19:40:54Z", "type": "commit"}, {"oid": "e8d7b4aa3ed8aa33cb514d0c8e469c26f5e5117d", "url": "https://github.com/futurewei-cloud/alcor/commit/e8d7b4aa3ed8aa33cb514d0c8e469c26f5e5117d", "message": "fix multiple issues", "committedDate": "2020-10-28T21:30:04Z", "type": "commit"}, {"oid": "b590cad0fcbb1a04c1e31136541df562f1303a92", "url": "https://github.com/futurewei-cloud/alcor/commit/b590cad0fcbb1a04c1e31136541df562f1303a92", "message": "update", "committedDate": "2020-10-28T21:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513792549", "bodyText": "In order to grant deletion, we will need to make sure the following two conditions are met:\n\nNo ports are under this subnet\nThe subnet is not attached to any router", "author": "xieus", "createdAt": "2020-10-28T22:11:18Z", "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java", "diffHunk": "@@ -449,7 +449,7 @@ public ResponseId deleteSubnetState(@PathVariable String projectId, @PathVariabl\n                 return new ResponseId();\n             }\n \n-            //RestPreconditionsUtil.verifyParameterEqual(subnetEntity.getProjectId(), projectId);\n+            this.subnetDatabaseService.deleteSubnet(subnetId);", "originalCommit": "b590cad0fcbb1a04c1e31136541df562f1303a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgxMzQzNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513813434", "bodyText": "sure", "author": "kevin-zhonghao", "createdAt": "2020-10-28T23:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTk2MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825960", "bodyText": "Very good improvement and thanks.", "author": "xieus", "createdAt": "2020-10-28T23:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MjU0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1b47088ce7d376fd679e497df6eefb5a33f9d4c5", "chunk": "diff --git a/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java b/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java\nindex 5005b8b0..fd334e29 100644\n--- a/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java\n+++ b/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/controller/SubnetController.java\n\n@@ -449,6 +449,26 @@ public class SubnetController {\n                 return new ResponseId();\n             }\n \n+            // check if there is any port in this subnet\n+            String rangeId = null;\n+            String ipV4RangeId = subnetEntity.getIpV4RangeId();\n+            String ipV6RangeId = subnetEntity.getIpV6RangeId();\n+            if (ipV4RangeId != null) {\n+                rangeId = ipV4RangeId;\n+            } else {\n+                rangeId = ipV6RangeId;\n+            }\n+            Boolean checkIfAnyPortInSubnet = this.subnetService.checkIfAnyPortInSubnet(rangeId);\n+            if (checkIfAnyPortInSubnet) {\n+                throw new HavePortInSubnet();\n+            }\n+\n+            // check if subnet bind any routes\n+            Boolean checkIfSubnetBindAnyRoutes = this.subnetService.checkIfSubnetBindAnyRoutes(subnetEntity);\n+            if (checkIfSubnetBindAnyRoutes) {\n+                throw new SubnetBindRoutes();\n+            }\n+\n             this.subnetDatabaseService.deleteSubnet(subnetId);\n \n             // delete subnet id in vpc\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MzA4Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513793082", "bodyText": "Recommend to\n\nrename it to RouterUnavailable or RouterNotExist\nprint router id in the exception message", "author": "xieus", "createdAt": "2020-10-28T22:12:38Z", "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "diffHunk": "@@ -159,6 +159,11 @@ else if (portId == null && subnetId != null) {\n         } else {\n             return new RouterInterfaceResponse();\n         }\n+        Router router = this.routerDatabaseService.getByRouterId(routerId);\n+        if (router == null) {\n+            throw new CanNotFindRouter();", "originalCommit": "b590cad0fcbb1a04c1e31136541df562f1303a92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgxNjM5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513816393", "bodyText": "Done", "author": "kevin-zhonghao", "createdAt": "2020-10-28T23:14:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc5MzA4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "chunk": "diff --git a/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java b/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\nindex cf1d13e8..203dc460 100644\n--- a/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\n+++ b/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\n\n@@ -161,7 +161,7 @@ public class NeutronRouterServiceImpl implements NeutronRouterService {\n         }\n         Router router = this.routerDatabaseService.getByRouterId(routerId);\n         if (router == null) {\n-            throw new CanNotFindRouter();\n+            throw new RouterUnavailable(routerId);\n         }\n \n         projectId = subnet.getProjectId();\n"}}, {"oid": "1b47088ce7d376fd679e497df6eefb5a33f9d4c5", "url": "https://github.com/futurewei-cloud/alcor/commit/1b47088ce7d376fd679e497df6eefb5a33f9d4c5", "message": "update", "committedDate": "2020-10-28T22:57:01Z", "type": "commit"}, {"oid": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "url": "https://github.com/futurewei-cloud/alcor/commit/83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "message": "update", "committedDate": "2020-10-28T23:08:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTgyOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513825828", "bodyText": "Minor comment:\nif (attachedRouterId == null || attachedRouterId.equals(\"\")){\nreturn false;\n}\nreturn true;", "author": "xieus", "createdAt": "2020-10-28T23:42:20Z", "path": "services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java", "diffHunk": "@@ -362,6 +360,37 @@ public void deleteSubnetIdInVpc(String subnetId, String projectId, String vpcId)\n         restTemplate.put(vpcManagerServiceUrl, VpcWebJson.class);\n     }\n \n+    @Override\n+    public boolean checkIfAnyPortInSubnet(String rangeId) throws RangeIdIsNullOrEmpty {\n+        if (rangeId == null) {\n+            throw new RangeIdIsNullOrEmpty();\n+        }\n+        String ipManagerServiceUrl = ipUrl + rangeId;\n+        IpAddrRangeRequest ipAddrRangeRequest = restTemplate.getForObject(ipManagerServiceUrl, IpAddrRangeRequest.class);\n+        if (ipAddrRangeRequest == null) {\n+            return false;\n+        }\n+\n+        // check usedIps\n+        long usedIps = ipAddrRangeRequest.getUsedIps();\n+        if (usedIps > ConstantsConfig.UsedIpThreshold) {\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean checkIfSubnetBindAnyRoutes(SubnetEntity subnetEntity) {\n+\n+        String attachedRouterId = subnetEntity.getAttachedRouterId();\n+        if (attachedRouterId != null && !attachedRouterId.equals(\"\")){", "originalCommit": "83b8b15c444f3d6180cb2a5e7788df3c66bc3f6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgzNjIxOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/453#discussion_r513836218", "bodyText": "Done", "author": "kevin-zhonghao", "createdAt": "2020-10-29T00:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzgyNTgyOA=="}], "type": "inlineReview", "revised_code": {"commit": "15e765d162ebd3cdf61c4b6dcab87f813ee6fb97", "chunk": "diff --git a/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java b/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java\nindex a8e65d2a..94655525 100644\n--- a/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java\n+++ b/services/subnet_manager/src/main/java/com/futurewei/alcor/subnet/service/implement/SubnetServiceImp.java\n\n@@ -365,7 +365,7 @@ public class SubnetServiceImp implements SubnetService {\n         if (rangeId == null) {\n             throw new RangeIdIsNullOrEmpty();\n         }\n-        String ipManagerServiceUrl = ipUrl + rangeId;\n+        String ipManagerServiceUrl = ipUrl + \"range/\" + rangeId;\n         IpAddrRangeRequest ipAddrRangeRequest = restTemplate.getForObject(ipManagerServiceUrl, IpAddrRangeRequest.class);\n         if (ipAddrRangeRequest == null) {\n             return false;\n"}}, {"oid": "15e765d162ebd3cdf61c4b6dcab87f813ee6fb97", "url": "https://github.com/futurewei-cloud/alcor/commit/15e765d162ebd3cdf61c4b6dcab87f813ee6fb97", "message": "update", "committedDate": "2020-10-29T00:09:42Z", "type": "commit"}, {"oid": "5668e17e2cfbc13a6a039bdd3b20586a5e6d52ff", "url": "https://github.com/futurewei-cloud/alcor/commit/5668e17e2cfbc13a6a039bdd3b20586a5e6d52ff", "message": "update", "committedDate": "2020-10-29T00:12:44Z", "type": "commit"}]}