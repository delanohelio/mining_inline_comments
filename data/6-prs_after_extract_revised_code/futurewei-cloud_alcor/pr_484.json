{"pr_number": 484, "pr_title": "[Contract] Update Contract for DNS/Router, Resolve Discrepancy", "pr_createdAt": "2020-11-19T23:26:09Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/484", "timeline": [{"oid": "041240295614e54c59015b1aa6ec5bc8dc047cd7", "url": "https://github.com/futurewei-cloud/alcor/commit/041240295614e54c59015b1aa6ec5bc8dc047cd7", "message": "update contract per discussion, also address some point on #386", "committedDate": "2020-11-19T23:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyOTMxMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527329311", "bodyText": "Instead of \"!!!\", let us use //TODO to remind us for real.", "author": "xieus", "createdAt": "2020-11-20T01:07:49Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java", "diffHunk": "@@ -266,10 +252,8 @@ private void buildPortState(NetworkConfiguration networkConfig, List<InternalPor\n \n     private NeighborState buildNeighborState(NeighborEntry neighborEntry, NeighborInfo neighborInfo, OperationType operationType) {\n         NeighborConfiguration.Builder neighborConfigBuilder = NeighborConfiguration.newBuilder();\n-        neighborConfigBuilder.setFormatVersion(FORMAT_REVISION_NUMBER);\n         neighborConfigBuilder.setRevisionNumber(FORMAT_REVISION_NUMBER);\n-        //neighborConfigBuilder.setId();\n-        //neighborConfigBuilder.setProjectId();\n+        //neighborConfigBuilder.setId(); // !!!We are going to need this per latest ACA change!!!", "originalCommit": "041240295614e54c59015b1aa6ec5bc8dc047cd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyOTQ3Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527329476", "bodyText": "@kevin-zhonghao can help to add this in next DPM change.", "author": "xieus", "createdAt": "2020-11-20T01:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyOTMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzNDAxMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527334013", "bodyText": "Fixed. I like to use !!! to get people's attention. :)", "author": "er1cthe0ne", "createdAt": "2020-11-20T01:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyOTMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c77c84a312f0a0a6be9548f1faaf0cf122577cd4", "chunk": "diff --git a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\nindex e3ef3820..cedeb7bc 100644\n--- a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n+++ b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n\n@@ -253,7 +253,7 @@ public class DataPlaneServiceImpl implements DataPlaneService {\n     private NeighborState buildNeighborState(NeighborEntry neighborEntry, NeighborInfo neighborInfo, OperationType operationType) {\n         NeighborConfiguration.Builder neighborConfigBuilder = NeighborConfiguration.newBuilder();\n         neighborConfigBuilder.setRevisionNumber(FORMAT_REVISION_NUMBER);\n-        //neighborConfigBuilder.setId(); // !!!We are going to need this per latest ACA change!!!\n+        //neighborConfigBuilder.setId(); // TODO: We are going to need this per latest ACA change\n         neighborConfigBuilder.setVpcId(neighborInfo.getVpcId());\n         //neighborConfigBuilder.setName();\n         neighborConfigBuilder.setMacAddress(neighborInfo.getPortMac());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527330042", "bodyText": "sorry what is this about?", "author": "xieus", "createdAt": "2020-11-20T01:10:01Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/utils/GoalStateManager.java", "diffHunk": "@@ -32,6 +32,7 @@\n \n @Component\n public class GoalStateManager {\n+  public static final int GOAL_STATE_MESSAGE_FORMAT_VERSION = 101;", "originalCommit": "041240295614e54c59015b1aa6ec5bc8dc047cd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzNTYzOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527335639", "bodyText": "see end of number 4 of #386. The idea is DPM will stamp a version number (101), and then ACA will look at it to ensure compability, this will enable ACA to print a meaningful error message. And it will save us to trouble trying to figure out incompatability goalstate message.", "author": "er1cthe0ne", "createdAt": "2020-11-20T01:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM1NjI4MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527356280", "bodyText": "Okay this top-level format version may increase in the future therefore we would likely need to make it configurable.\nAlso, GoalStateManager is used by v1.0 so we would need to make a similar change to v2.0.", "author": "xieus", "createdAt": "2020-11-20T02:36:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM5NjM5Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527396393", "bodyText": "okay, let me know if I should make the configurable change (please give me some pointer to do it).\nI made the v2.0 change in DataPlanceServiceImpl.java and updated the PR.", "author": "er1cthe0ne", "createdAt": "2020-11-20T04:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQzNTcyNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527435726", "bodyText": "Sure. Here are three steps to make the change:\n(1) Define a configuration in application.properties with default value\nhttps://github.com/futurewei-cloud/alcor/blob/master/services/data_plane_manager/src/main/resources/application.properties\n(2) \"Autowire\" the configuration to a java config class\nhttps://github.com/futurewei-cloud/alcor/blob/master/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/config/Config.java\n(3) Assign the config value in the code to a local variable, for example,\n\n  \n    \n      alcor/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/client/grpc/DataPlaneClientImpl.java\n    \n    \n         Line 49\n      in\n      ff19c6b\n    \n    \n    \n    \n\n        \n          \n           public DataPlaneClientImpl(Config globalConfig) {", "author": "xieus", "createdAt": "2020-11-20T05:56:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAwMDQ0NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r528000444", "bodyText": "Added for the v2.0 path.", "author": "er1cthe0ne", "createdAt": "2020-11-20T22:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDA0Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDI1OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527330259", "bodyText": "Let us add //TODO to remind us we need to set DNS based on latest contract.", "author": "xieus", "createdAt": "2020-11-20T01:10:39Z", "path": "services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java", "diffHunk": "@@ -443,13 +441,6 @@ private void buildSubnetState(NetworkConfiguration networkConfig, Goalstate.Goal\n             if (subnetEntity.getAvailabilityZone() != null) {\n                 subnetConfigBuilder.setAvailabilityZone(subnetEntity.getAvailabilityZone());\n             }\n-            if (subnetEntity.getPrimaryDns() != null) {\n-                subnetConfigBuilder.setPrimaryDns(subnetEntity.getPrimaryDns());\n-            }\n-\n-            if (subnetEntity.getSecondaryDns() != null) {\n-                subnetConfigBuilder.setSecondaryDns(subnetEntity.getSecondaryDns());\n-            }", "originalCommit": "041240295614e54c59015b1aa6ec5bc8dc047cd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzNzA0Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527337043", "bodyText": "done", "author": "er1cthe0ne", "createdAt": "2020-11-20T01:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMDI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c77c84a312f0a0a6be9548f1faaf0cf122577cd4", "chunk": "diff --git a/services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java b/services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java\nindex 5ddcc01e..d42172e7 100644\n--- a/services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java\n+++ b/services/data_plane_manager/src/test/java/com/futurewei/alcor/dataplane/utils/DataPlaneManagerUtil.java\n\n@@ -438,6 +438,8 @@ public class DataPlaneManagerUtil {\n             gatewayBuilder.setMacAddress(subnetEntity.getGatewayMacAddress());\n             subnetConfigBuilder.setGateway(gatewayBuilder.build());\n             subnetConfigBuilder.setDhcpEnable(subnetEntity.getDhcpEnable());\n+\n+            // TODO: need to set DNS based on latest contract\n             if (subnetEntity.getAvailabilityZone() != null) {\n                 subnetConfigBuilder.setAvailabilityZone(subnetEntity.getAvailabilityZone());\n             }\n"}}, {"oid": "c77c84a312f0a0a6be9548f1faaf0cf122577cd4", "url": "https://github.com/futurewei-cloud/alcor/commit/c77c84a312f0a0a6be9548f1faaf0cf122577cd4", "message": "update per PR feedback", "committedDate": "2020-11-20T01:49:59Z", "type": "commit"}, {"oid": "fdbd9410369d947caf314a0223e92db8bc0c72b1", "url": "https://github.com/futurewei-cloud/alcor/commit/fdbd9410369d947caf314a0223e92db8bc0c72b1", "message": "update per PR feedback", "committedDate": "2020-11-20T04:52:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQyNjAzOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527426038", "bodyText": "Please add //TODO comment as well as this is the v2.0 implementation.", "author": "xieus", "createdAt": "2020-11-20T05:46:09Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java", "diffHunk": "@@ -191,14 +189,6 @@ private void buildSubnetStates(NetworkConfiguration networkConfig, UnicastGoalSt\n                 subnetConfigBuilder.setAvailabilityZone(subnetEntity.getAvailabilityZone());\n             }\n \n-            if (subnetEntity.getPrimaryDns() != null) {", "originalCommit": "fdbd9410369d947caf314a0223e92db8bc0c72b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzk5OTk3Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/484#discussion_r527999977", "bodyText": "added.", "author": "er1cthe0ne", "createdAt": "2020-11-20T22:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQyNjAzOA=="}], "type": "inlineReview", "revised_code": {"commit": "687fd215e66ac9765ce0ceaa0e3d17799ded35e3", "chunk": "diff --git a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\nindex 933f2c08..16f6057f 100644\n--- a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n+++ b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n\n@@ -185,6 +191,8 @@ public class DataPlaneServiceImpl implements DataPlaneService {\n                 subnetConfigBuilder.setDhcpEnable(subnetEntity.getDhcpEnable());\n             }\n \n+            // TODO: need to set DNS based on latest contract\n+            \n             if (subnetEntity.getAvailabilityZone() != null) {\n                 subnetConfigBuilder.setAvailabilityZone(subnetEntity.getAvailabilityZone());\n             }\n"}}, {"oid": "687fd215e66ac9765ce0ceaa0e3d17799ded35e3", "url": "https://github.com/futurewei-cloud/alcor/commit/687fd215e66ac9765ce0ceaa0e3d17799ded35e3", "message": "update per PR feedback", "committedDate": "2020-11-20T22:18:46Z", "type": "commit"}, {"oid": "1ad136b5ba6f6d873968674be96540b8312500c8", "url": "https://github.com/futurewei-cloud/alcor/commit/1ad136b5ba6f6d873968674be96540b8312500c8", "message": "change MessageType to UpdateType in all proto files", "committedDate": "2020-11-20T23:39:41Z", "type": "commit"}]}