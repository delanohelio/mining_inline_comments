{"pr_number": 472, "pr_title": "[Microservice] Data Plane Mgr v2.0 Implementation", "pr_createdAt": "2020-11-11T07:11:21Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/472", "timeline": [{"oid": "219da6f9e4e36675175b82d034de2ccf5430a4f3", "url": "https://github.com/futurewei-cloud/alcor/commit/219da6f9e4e36675175b82d034de2ccf5430a4f3", "message": "Routing information configuration", "committedDate": "2020-11-11T10:04:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3MTQwMg==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r523071402", "bodyText": "Next step, we might consider to change InternalDPMResultList as well. DPM client (RM or PM) would need to process the response of DPM in a near future, and in the scenario of large VPC, the current form of response is inefficient due to a list member.\nAlso, as we discussed last time on the Slack channel, DPM would need to aggregate the response on the level of resource that DPM receives from the client, for example,\n\nPM => DPM is per port, therefore, the response DPM => PM is on the same port, which is not the case right now.", "author": "xieus", "createdAt": "2020-11-13T16:43:20Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/DataPlaneService.java", "diffHunk": "@@ -16,10 +16,34 @@\n package com.futurewei.alcor.dataplane.service;\n \n import com.futurewei.alcor.web.entity.dataplane.InternalDPMResultList;\n-import com.futurewei.alcor.web.entity.dataplane.NetworkConfiguration;\n+import com.futurewei.alcor.web.entity.dataplane.v2.NetworkConfiguration;\n \n public interface DataPlaneService {\n+\n+    /**\n+     * process create network configuration message and send to ACA nodes\n+     *\n+     * @param networkConfiguration network configuration details\n+     * @return InternalDPMResultList result list\n+     * @throws Exception throw any Exception\n+     */\n     InternalDPMResultList createNetworkConfiguration(NetworkConfiguration networkConfiguration) throws Exception;", "originalCommit": "219da6f9e4e36675175b82d034de2ccf5430a4f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTcwNTExNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525705115", "bodyText": "ok, I will consider optimizing this later.", "author": "chenpiaoping", "createdAt": "2020-11-18T03:08:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc1MDA4Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525750087", "bodyText": "Sounds good. This could wait.\nMeanwhile I will create a new feature request so that won't forget :-)", "author": "xieus", "createdAt": "2020-11-18T03:46:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3MTQwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc1NTc0OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525755748", "bodyText": "Tracking issue #480 created.", "author": "xieus", "createdAt": "2020-11-18T03:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3MTQwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3Mzg5Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r523073892", "bodyText": "What do you think of the coding style of more conventional for-loop vs. stream?", "author": "xieus", "createdAt": "2020-11-13T16:47:15Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java", "diffHunk": "@@ -78,37 +92,47 @@ private VpcEntity getVpcEntity(NetworkConfiguration networkConfig, String vpcId)\n         return result;\n     }\n \n-    private void buildVpcState(NetworkConfiguration networkConfig, GoalState.Builder goalStateBuilder) throws Exception {\n-        List<PortState> portStates = goalStateBuilder.getPortStatesList();\n+    private void buildVpcStates(NetworkConfiguration networkConfig, UnicastGoalState unicastGoalState) throws Exception {\n+        List<PortState> portStates = unicastGoalState.getGoalStateBuilder().getPortStatesList();\n         if (portStates == null || portStates.size() == 0) {\n             return;\n         }\n \n         for (PortState portState: portStates) {\n             VpcEntity vpcEntity = getVpcEntity(networkConfig, portState.getConfiguration().getVpcId());\n             VpcConfiguration.Builder vpcConfigBuilder = VpcConfiguration.newBuilder();\n+            vpcConfigBuilder.setFormatVersion(FORMAT_REVISION_NUMBER);\n+            vpcConfigBuilder.setRevisionNumber(FORMAT_REVISION_NUMBER);\n             vpcConfigBuilder.setId(vpcEntity.getId());\n             vpcConfigBuilder.setProjectId(vpcEntity.getProjectId());\n-            vpcConfigBuilder.setName(vpcEntity.getName());\n-            vpcConfigBuilder.setCidr(vpcEntity.getCidr());\n-            vpcConfigBuilder.setTunnelId(Long.parseLong(vpcEntity.getSegmentationId() + \"\"));\n-\n-            networkConfig.getSubnets().stream()\n-                    .filter(s -> s.getVpcId().equals(vpcEntity.getId()))\n-                    .map(InternalSubnetEntity::getId)\n-                    .forEach(id -> {\n-                        SubnetId.Builder subnetIdBuilder = SubnetId.newBuilder();\n-                        subnetIdBuilder.setId(id);\n-                        vpcConfigBuilder.addSubnetIds(subnetIdBuilder.build());\n-                    });\n \n+            if (vpcEntity.getName() != null) {\n+                vpcConfigBuilder.setName(vpcEntity.getName());\n+            }\n+\n+            if (vpcEntity.getCidr() != null) {\n+                vpcConfigBuilder.setCidr(vpcEntity.getCidr());\n+            }\n+\n+            //vpcConfigBuilder.setTunnelId();\n+\n+            if (networkConfig.getSubnets() != null) {\n+                networkConfig.getSubnets().stream()\n+                        .filter(s -> s.getVpcId().equals(vpcEntity.getId()))\n+                        .map(InternalSubnetEntity::getId)\n+                        .forEach(id -> {\n+                            SubnetId.Builder subnetIdBuilder = SubnetId.newBuilder();\n+                            subnetIdBuilder.setId(id);\n+                            vpcConfigBuilder.addSubnetIds(subnetIdBuilder.build());\n+                        });", "originalCommit": "219da6f9e4e36675175b82d034de2ccf5430a4f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTcwMzUyMw==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525703523", "bodyText": "I think that if stream is used properly, it can bring the benefits of performance improvement and code simplicity, so I recommend using stream when necessary.", "author": "chenpiaoping", "createdAt": "2020-11-18T03:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3Mzg5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "4bc164190bb3f8c36bca3921cb4bdce2f4c72d8c", "chunk": "diff --git a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\nindex 1702ee6e..b9aeb786 100644\n--- a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n+++ b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/service/ovs/DataPlaneServiceImpl.java\n\n@@ -101,8 +89,6 @@ public class DataPlaneServiceImpl implements DataPlaneService {\n         for (PortState portState: portStates) {\n             VpcEntity vpcEntity = getVpcEntity(networkConfig, portState.getConfiguration().getVpcId());\n             VpcConfiguration.Builder vpcConfigBuilder = VpcConfiguration.newBuilder();\n-            vpcConfigBuilder.setFormatVersion(FORMAT_REVISION_NUMBER);\n-            vpcConfigBuilder.setRevisionNumber(FORMAT_REVISION_NUMBER);\n             vpcConfigBuilder.setId(vpcEntity.getId());\n             vpcConfigBuilder.setProjectId(vpcEntity.getProjectId());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3OTA5MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r523079090", "bodyText": "@chenpiaoping As UnicastGoalState and MulticastGoalState are two key entity classes in the DPM v2.0 implementation, can you add a brief comment in the file to explain what they are etc., so that others could get the idea easily?", "author": "xieus", "createdAt": "2020-11-13T16:55:26Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/UnicastGoalState.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.dataplane.entity;\n+\n+import com.futurewei.alcor.schema.Goalstate.GoalState;\n+\n+public class UnicastGoalState {", "originalCommit": "219da6f9e4e36675175b82d034de2ccf5430a4f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA4MTE3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r523081170", "bodyText": "You can use a reference to Issue #369 or update the MQ design doc https://github.com/futurewei-cloud/alcor/blob/master/docs/modules/ROOT/pages/mq_services/message_queue_system.adoc (better option).", "author": "xieus", "createdAt": "2020-11-13T16:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3OTA5MA=="}], "type": "inlineReview", "revised_code": {"commit": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "chunk": "diff --git a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/UnicastGoalState.java b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/UnicastGoalState.java\nindex 9b27f442..e0d8b2ae 100644\n--- a/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/UnicastGoalState.java\n+++ b/services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/UnicastGoalState.java\n\n@@ -17,6 +17,13 @@ package com.futurewei.alcor.dataplane.entity;\n \n import com.futurewei.alcor.schema.Goalstate.GoalState;\n \n+/**\n+ * UnicastGoalState contains a goalState object and the destination host ip address hostIp,\n+ * to which the GoalState object is sent. In order to support the hierarchical topic of pulsar,\n+ * it also contains the nextTopic field, which is used by pulsar to determine which topic to\n+ * send the goalState to. The field goalStateBuilder is a temporary object that is used to\n+ * construct a goalState object that must be cleared before the UnicastGoalState is sent.\n+ */\n public class UnicastGoalState {\n     private String hostIp;\n     private String nextTopic;\n"}}, {"oid": "4bc164190bb3f8c36bca3921cb4bdce2f4c72d8c", "url": "https://github.com/futurewei-cloud/alcor/commit/4bc164190bb3f8c36bca3921cb4bdce2f4c72d8c", "message": "dpm-v2.0", "committedDate": "2020-11-18T02:56:00Z", "type": "commit"}, {"oid": "cf159a9af7da67f5ab2e6f16d4937fcd2d651be0", "url": "https://github.com/futurewei-cloud/alcor/commit/cf159a9af7da67f5ab2e6f16d4937fcd2d651be0", "message": "add revision number", "committedDate": "2020-11-18T02:56:03Z", "type": "commit"}, {"oid": "85ae57dce4fe9fc50f70cd8eea2b47d28c6e5cac", "url": "https://github.com/futurewei-cloud/alcor/commit/85ae57dce4fe9fc50f70cd8eea2b47d28c6e5cac", "message": "Routing information configuration", "committedDate": "2020-11-18T02:56:05Z", "type": "commit"}, {"oid": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "url": "https://github.com/futurewei-cloud/alcor/commit/92d0f0e8cf1f31bb161c86150776922b77e308b7", "message": "rebase from master", "committedDate": "2020-11-18T03:40:35Z", "type": "commit"}, {"oid": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "url": "https://github.com/futurewei-cloud/alcor/commit/92d0f0e8cf1f31bb161c86150776922b77e308b7", "message": "rebase from master", "committedDate": "2020-11-18T03:40:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc1NjgzNQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525756835", "bodyText": "This is very nice comment. Thanks!", "author": "xieus", "createdAt": "2020-11-18T03:53:56Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/MulticastGoalState.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.dataplane.entity;\n+\n+import com.futurewei.alcor.schema.Goalstate.GoalState;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * MulticastGoalState represents the GoalState that needs to be sent by multicast,\n+ * that is the same GoalState message needs to be sent to multiple host, MulticastGoalState\n+ * including a goalState object and multiple destination host ip addresses to which\n+ * the GoalState object is sent. It also contains a nextTopics field to support\n+ * the hierarchical topic of pulsar, which is used by pulsar to decide which topics to\n+ * send goalState to. The field goalStateBuilder is a temporary object that is used to\n+ * construct a goalState object that must be cleared before the MulticastGoalState is sent.\n+ */", "originalCommit": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2MDY1OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525760659", "bodyText": "@chenpiaoping Consider to use some design pattern for this field later.", "author": "xieus", "createdAt": "2020-11-18T03:57:57Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/entity/MulticastGoalState.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+Copyright 2019 The Alcor Authors.\n+\n+Licensed under the Apache License, Version 2.0 (the \"License\");\n+        you may not use this file except in compliance with the License.\n+        You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+        Unless required by applicable law or agreed to in writing, software\n+        distributed under the License is distributed on an \"AS IS\" BASIS,\n+        WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+        See the License for the specific language governing permissions and\n+        limitations under the License.\n+*/\n+package com.futurewei.alcor.dataplane.entity;\n+\n+import com.futurewei.alcor.schema.Goalstate.GoalState;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * MulticastGoalState represents the GoalState that needs to be sent by multicast,\n+ * that is the same GoalState message needs to be sent to multiple host, MulticastGoalState\n+ * including a goalState object and multiple destination host ip addresses to which\n+ * the GoalState object is sent. It also contains a nextTopics field to support\n+ * the hierarchical topic of pulsar, which is used by pulsar to decide which topics to\n+ * send goalState to. The field goalStateBuilder is a temporary object that is used to\n+ * construct a goalState object that must be cleared before the MulticastGoalState is sent.\n+ */\n+public class MulticastGoalState {\n+    private List<String> hostIps;\n+    private List<String> nextTopics;\n+    private GoalState goalState;\n+    private GoalState.Builder goalStateBuilder;", "originalCommit": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2MjU4Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/472#discussion_r525762587", "bodyText": "Agreed. This new URL makes more sense.", "author": "xieus", "createdAt": "2020-11-18T03:59:53Z", "path": "services/data_plane_manager/src/main/java/com/futurewei/alcor/dataplane/controller/DataPlaneController.java", "diffHunk": "@@ -16,34 +16,42 @@\n package com.futurewei.alcor.dataplane.controller;\n \n import com.futurewei.alcor.common.stats.DurationStatistics;\n-import com.futurewei.alcor.dataplane.service.DataPlaneServiceNew;\n+import com.futurewei.alcor.dataplane.service.DataPlaneService;\n import com.futurewei.alcor.web.entity.dataplane.InternalDPMResultList;\n import com.futurewei.alcor.web.entity.dataplane.v2.NetworkConfiguration;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.ComponentScan;\n import org.springframework.http.HttpStatus;\n import org.springframework.web.bind.annotation.*;\n \n+import static com.futurewei.alcor.dataplane.utils.RestParameterValidator.checkNetworkConfiguration;\n+\n+@RestController\n+@ComponentScan(value = \"com.futurewei.alcor.common.stats\")\n public class DataPlaneController {\n \n     @Autowired\n-    private DataPlaneServiceNew dataPlaneService;\n+    private DataPlaneService dataPlaneService;\n \n-    @PostMapping({\"/port/\", \"v4/port/\"})\n+    @PostMapping({\"/network-configuration\", \"v4/network-configuration\"})", "originalCommit": "92d0f0e8cf1f31bb161c86150776922b77e308b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}