{"pr_number": 333, "pr_title": "[API GW] Differentiate Handling of Tokens in Admin & User Role", "pr_createdAt": "2020-07-30T11:42:21Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/333", "timeline": [{"oid": "8fd7ce7792fa3b8ef83c2229ca42be0301e852c6", "url": "https://github.com/futurewei-cloud/alcor/commit/8fd7ce7792fa3b8ef83c2229ca42be0301e852c6", "message": "add token role handle", "committedDate": "2020-07-30T11:22:46Z", "type": "commit"}, {"oid": "fd010f6936a659b7cb2f050fe5427a340f8d01af", "url": "https://github.com/futurewei-cloud/alcor/commit/fd010f6936a659b7cb2f050fe5427a340f8d01af", "message": "fix toJson problem", "committedDate": "2020-07-30T11:40:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0MzE5NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463043194", "bodyText": "This is a very good refactor \ud83d\udc4d", "author": "xieus", "createdAt": "2020-07-30T14:35:45Z", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "diffHunk": "@@ -192,13 +190,13 @@ private void getLocalToken() throws IOException{\n      *\n      * @see <a href=\"https://docs.openstack.org/api-ref/identity/v3/index.html?expanded=password-authentication-with-scoped-authorization-detail#identity-api-operations\">Keystone api operations</a>\n      */\n-    public String verifyToken(String token){\n+    public Optional<TokenEntity> verifyToken(String token){", "originalCommit": "fd010f6936a659b7cb2f050fe5427a340f8d01af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA0NzU0OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463047548", "bodyText": "Recommend to add a Log.debug if a token is expired.", "author": "xieus", "createdAt": "2020-07-30T14:41:41Z", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/client/KeystoneClient.java", "diffHunk": "@@ -192,13 +190,13 @@ private void getLocalToken() throws IOException{\n      *\n      * @see <a href=\"https://docs.openstack.org/api-ref/identity/v3/index.html?expanded=password-authentication-with-scoped-authorization-detail#identity-api-operations\">Keystone api operations</a>\n      */\n-    public String verifyToken(String token){\n+    public Optional<TokenEntity> verifyToken(String token){\n         try {\n \n             TokenEntity tokenEntity = cache.get(token);\n             if(tokenEntity != null){\n                 LOG.debug(\"fetch the token from cache {}\", tokenEntity);\n-                return tokenEntity.isExpired() ? \"\" : tokenEntity.getProjectId();\n+                return tokenEntity.isExpired() ? Optional.empty() : Optional.of(tokenEntity);", "originalCommit": "fd010f6936a659b7cb2f050fe5427a340f8d01af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA1NDA0NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/333#discussion_r463054045", "bodyText": "This appears to overwrite the header fields. Pls make sure that other header fields (if useful) will not be removed. @Gzure", "author": "xieus", "createdAt": "2020-07-30T14:50:21Z", "path": "services/api_gateway/src/main/java/com/futurewei/alcor/apigateway/filter/KeystoneAuthGwFilter.java", "diffHunk": "@@ -54,21 +61,27 @@\n             exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);\n             return exchange.getResponse().setComplete();\n         }\n-        String projectId = keystoneClient.verifyToken(token);\n-        if(\"\".equals(projectId)){\n+        Optional<TokenEntity> tokenEntityOptional = keystoneClient.verifyToken(token);\n+        if(tokenEntityOptional.isEmpty()){\n             LOG.warn(\"parsed token {} project id failed\", token);\n             exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);\n             return exchange.getResponse().setComplete();\n         }\n+\n+        TokenEntity tokenEntity = tokenEntityOptional.get();\n+        String projectId = tokenEntity.getProjectId();\n         LOG.debug(\"parsed token {} project id success, project id:[{}]\", token, projectId);\n+\n         // rewrite uri path include project id\n         ServerHttpRequest req = exchange.getRequest();\n         ServerWebExchangeUtils.addOriginalRequestUrl(exchange, req.getURI());\n         String path = req.getURI().getRawPath();\n         path = path.replaceAll(neutronUrlPrefix, \"/project/\" + projectId);\n         path = path.replaceAll(VPC_REPLACE_NAME, VPC_NAME);\n-        ServerHttpRequest request = req.mutate().path(path).build();\n+\n+        ServerHttpRequest request = req.mutate().path(path).header(TOKEN_INFO_HEADER, tokenEntity.toJson()).build();", "originalCommit": "fd010f6936a659b7cb2f050fe5427a340f8d01af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}