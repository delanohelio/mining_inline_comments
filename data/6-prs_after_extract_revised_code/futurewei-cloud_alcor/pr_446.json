{"pr_number": 446, "pr_title": "[Microservice] Port Mgr Support L3 Routing with Routing Rules", "pr_createdAt": "2020-10-23T23:31:05Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/446", "timeline": [{"oid": "faec46d23a7a6897f218f4becb4341da02e0e008", "url": "https://github.com/futurewei-cloud/alcor/commit/faec46d23a7a6897f218f4becb4341da02e0e008", "message": "Validate VpcTunnelId in PM v1.0", "committedDate": "2020-10-22T18:20:12Z", "type": "commit"}, {"oid": "56195d6356562b975475b33c221936488604983c", "url": "https://github.com/futurewei-cloud/alcor/commit/56195d6356562b975475b33c221936488604983c", "message": "Update comment in NetworkConfigurationUtil", "committedDate": "2020-10-22T18:25:42Z", "type": "commit"}, {"oid": "c88c118aab7b78f7d887d0488981610917e57d6e", "url": "https://github.com/futurewei-cloud/alcor/commit/c88c118aab7b78f7d887d0488981610917e57d6e", "message": "Add comments to v1 implementation emphasizing it is deplicated", "committedDate": "2020-10-22T18:56:00Z", "type": "commit"}, {"oid": "2b27c3bc9001601dbe88c5a8c69b6a486d2ea969", "url": "https://github.com/futurewei-cloud/alcor/commit/2b27c3bc9001601dbe88c5a8c69b6a486d2ea969", "message": "PM support L3 routing and user-defined rules", "committedDate": "2020-10-23T23:28:17Z", "type": "commit"}, {"oid": "f786c2c5f43bd060344b4e66c5fe743ad261f2a4", "url": "https://github.com/futurewei-cloud/alcor/commit/f786c2c5f43bd060344b4e66c5fe743ad261f2a4", "message": "Merge branch 'master' into feature/router/pm", "committedDate": "2020-10-24T00:36:17Z", "type": "commit"}, {"oid": "9ea1d1bec68def5cd03d64db406809914ab7b2b6", "url": "https://github.com/futurewei-cloud/alcor/commit/9ea1d1bec68def5cd03d64db406809914ab7b2b6", "message": "Use latest RM contract for InternalRouterInfo", "committedDate": "2020-10-24T00:58:08Z", "type": "commit"}, {"oid": "80ee1f899e9a2ba311cf43b4eab6349a185b2ec1", "url": "https://github.com/futurewei-cloud/alcor/commit/80ee1f899e9a2ba311cf43b4eab6349a185b2ec1", "message": "RM GetConnectedSubnet API refactor", "committedDate": "2020-10-24T02:36:44Z", "type": "commit"}, {"oid": "19a2b88ee223db9e1d8c71e31b3c7e4801ef2873", "url": "https://github.com/futurewei-cloud/alcor/commit/19a2b88ee223db9e1d8c71e31b3c7e4801ef2873", "message": "Fix PM UT failure related to router", "committedDate": "2020-10-24T03:03:31Z", "type": "commit"}, {"oid": "da4a6d5a78f2b4d08a5a259c4d66ae656eb8e5ed", "url": "https://github.com/futurewei-cloud/alcor/commit/da4a6d5a78f2b4d08a5a259c4d66ae656eb8e5ed", "message": "Fix RM GetConnectedSubnet API bugs", "committedDate": "2020-10-24T03:37:26Z", "type": "commit"}, {"oid": "5b5e095b1ac1e593b99334def574dfc513c7cddf", "url": "https://github.com/futurewei-cloud/alcor/commit/5b5e095b1ac1e593b99334def574dfc513c7cddf", "message": "Use neutronRouteTable in GetConnecteSubnet API", "committedDate": "2020-10-24T05:43:20Z", "type": "commit"}, {"oid": "6beb289a6b271783ffb2decba7ae54962aac3940", "url": "https://github.com/futurewei-cloud/alcor/commit/6beb289a6b271783ffb2decba7ae54962aac3940", "message": "Fix NeighborIP issue in Neighbor Table", "committedDate": "2020-10-24T23:29:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1NDkwMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/446#discussion_r512154900", "bodyText": "Should we take \"neutron_router\" as the constants format value?", "author": "kevin-zhonghao", "createdAt": "2020-10-26T17:48:23Z", "path": "services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java", "diffHunk": "@@ -425,83 +425,131 @@ public RoutesToNeutronWebResponse removeRoutesToNeutronRouter(String routerid, R\n     }\n \n     @Override\n-    public ConnectedSubnetsWebResponse getConnectedSubnets(String projectId, String vpcId, String subnetId) throws ResourceNotFoundException, ResourcePersistenceException, SubnetNotBindUniquePortId {\n+    public ConnectedSubnetsWebResponse getConnectedSubnets(String projectId, String vpcId, String subnetId) throws ResourceNotFoundException, ResourcePersistenceException, SubnetNotBindUniquePortId, UnsupportedOperationException {\n         List<String> subnetIds = new ArrayList<>();\n-        ConnectedSubnetsWebResponse connectedSubnetsWebResponse = new ConnectedSubnetsWebResponse();\n+        InternalRouterInfo internalRouterInfo = new InternalRouterInfo();\n+        ConnectedSubnetsWebResponse connectedSubnetsWebResponse = new ConnectedSubnetsWebResponse(internalRouterInfo, subnetIds);\n+\n+        SubnetWebJson subnetWebJson = this.routerToSubnetService.getSubnet(projectId, subnetId);\n+        if (!this.ValidateSubnetAndConnectedRouter(subnetWebJson, subnetId)) {\n+            logger.log(Level.WARNING, \"Validation failed for SubnetAndConnectedRouter | subnet id:\" + subnetId);\n+            return connectedSubnetsWebResponse;\n+        }\n+\n+        Router router = this.routerDatabaseService.getByRouterId(subnetWebJson.getSubnet().getAttachedRouterId());\n+        if (!this.ValidateRouter(router)) {\n+            logger.log(Level.WARNING, \"Validation failed for router | router :\" + router);\n+            return connectedSubnetsWebResponse;\n+        }\n+\n+        String routeTableType = router.getNeutronRouteTable().getRouteTableType();\n+        Map<String, String> gwPortToSubnetIdMap = new HashMap<>();\n+        if (routeTableType.equals(\"neutron_router\")) {", "originalCommit": "6beb289a6b271783ffb2decba7ae54962aac3940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3MzgwOQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/446#discussion_r512173809", "bodyText": "Yes. This was a bug found through debugging.", "author": "xieus", "createdAt": "2020-10-26T18:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE1NDkwMA=="}], "type": "inlineReview", "revised_code": {"commit": "a6ca6c876cde36bff5733044817fcd5442f75d87", "chunk": "diff --git a/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java b/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\nindex 034988df..3a389d7f 100644\n--- a/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\n+++ b/services/route_manager/src/main/java/com/futurewei/alcor/route/service/Impl/NeutronRouterServiceImpl.java\n\n@@ -426,9 +426,9 @@ public class NeutronRouterServiceImpl implements NeutronRouterService {\n \n     @Override\n     public ConnectedSubnetsWebResponse getConnectedSubnets(String projectId, String vpcId, String subnetId) throws ResourceNotFoundException, ResourcePersistenceException, SubnetNotBindUniquePortId, UnsupportedOperationException {\n-        List<String> subnetIds = new ArrayList<>();\n+        List<SubnetEntity> subnetEntities = new ArrayList<>();\n         InternalRouterInfo internalRouterInfo = new InternalRouterInfo();\n-        ConnectedSubnetsWebResponse connectedSubnetsWebResponse = new ConnectedSubnetsWebResponse(internalRouterInfo, subnetIds);\n+        ConnectedSubnetsWebResponse connectedSubnetsWebResponse = new ConnectedSubnetsWebResponse(internalRouterInfo, subnetEntities);\n \n         SubnetWebJson subnetWebJson = this.routerToSubnetService.getSubnet(projectId, subnetId);\n         if (!this.ValidateSubnetAndConnectedRouter(subnetWebJson, subnetId)) {\n"}}, {"oid": "a6ca6c876cde36bff5733044817fcd5442f75d87", "url": "https://github.com/futurewei-cloud/alcor/commit/a6ca6c876cde36bff5733044817fcd5442f75d87", "message": "Return SubnetEntity list in RM GetConnectedSubnets API", "committedDate": "2020-10-26T22:03:35Z", "type": "commit"}]}