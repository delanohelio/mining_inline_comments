{"pr_number": 352, "pr_title": "[Rbac] Alcor Rbac Support", "pr_createdAt": "2020-08-12T06:08:40Z", "pr_url": "https://github.com/futurewei-cloud/alcor/pull/352", "timeline": [{"oid": "81ea6d8c92fcdd7b852484bbcba34f918aaa5744", "url": "https://github.com/futurewei-cloud/alcor/commit/81ea6d8c92fcdd7b852484bbcba34f918aaa5744", "message": "add request attr null handle", "committedDate": "2020-08-12T06:12:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MjM4Mg==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r469452382", "bodyText": "@Gzure is this an typo \"@\"?", "author": "xieus", "createdAt": "2020-08-12T18:18:59Z", "path": "web/src/main/java/com/futurewei/alcor/web/rbac/aspect/Rbac.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.web.rbac.aspect;\n+\n+import java.lang.annotation.*;\n+\n+@Target(ElementType.METHOD)\n+@Retention(RetentionPolicy.RUNTIME)\n+@Documented\n+public @interface Rbac {", "originalCommit": "81ea6d8c92fcdd7b852484bbcba34f918aaa5744", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1MTkyMQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470351921", "bodyText": "Yes, It's an annotation.", "author": "Gzure", "createdAt": "2020-08-14T01:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MjM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNzQwOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470417408", "bodyText": "Can you document this new annotation in the design doc? This is good staff.", "author": "xieus", "createdAt": "2020-08-14T05:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ1MjM4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "04a0101347190c1d9f2725ed627f1302215b108d", "chunk": "diff --git a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/Rbac.java b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/Rbac.java\nindex 26dd350be..a554c4f6b 100644\n--- a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/Rbac.java\n+++ b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/Rbac.java\n\n@@ -25,6 +25,6 @@ import java.lang.annotation.*;\n @Documented\n public @interface Rbac {\n \n-    String resourceName() default \"\";\n+    String resource() default \"\";\n \n }\n"}}, {"oid": "f9078319e1f0e6244851454324e5affcfc702ff7", "url": "https://github.com/futurewei-cloud/alcor/commit/f9078319e1f0e6244851454324e5affcfc702ff7", "message": "add rbac_design.adoc", "committedDate": "2020-08-14T02:43:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQwODkyNg==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470408926", "bodyText": "Pretty important interface. Could you add comments to its methods?", "author": "xieus", "createdAt": "2020-08-14T04:51:46Z", "path": "lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManger.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.rbac;\n+\n+import com.futurewei.alcor.common.entity.TokenEntity;\n+import com.futurewei.alcor.common.exception.ParseObjectException;\n+import com.futurewei.alcor.common.exception.ResourceNotFoundException;\n+import com.futurewei.alcor.common.exception.ResourceNotValidException;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+public interface RbacManger {", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f42572cc00f8b5eadedb032c62f65a582f40b529", "chunk": "diff --git a/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManger.java b/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManger.java\nindex a55d21fee..2be6cf3ad 100644\n--- a/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManger.java\n+++ b/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManger.java\n\n@@ -26,20 +26,75 @@ import com.futurewei.alcor.common.exception.ResourceNotValidException;\n import java.util.List;\n import java.util.Map;\n \n+/**\n+ *  A Rbac decide whether user token can operate the resource\n+ *  if check failed ,throw a exception\n+ */\n public interface RbacManger {\n \n-    void checkUpdate(String resourceName, TokenEntity tokenEntity, List<String> bodyFields, OwnerChecker ownerChecker) throws Exception;\n+    /**\n+     * check user whether have the permission to update the resource\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param bodyFields http put request body fields\n+     * @param ownerChecker a checker which check whether user is owner of the resource\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void checkUpdate(String resource, TokenEntity tokenEntity, List<String> bodyFields, OwnerChecker ownerChecker) throws Exception;\n \n-    void checkGet(String resourceName, TokenEntity tokenEntity, String[] getFields, OwnerChecker ownerChecker) throws Exception;\n+    /**\n+     * check user whether have the permission to get the resource and resource fields.\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param getFields http get request url  fields\n+     * @param ownerChecker a checker which check whether user is owner of the resouce\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void checkGet(String resource, TokenEntity tokenEntity, String[] getFields, OwnerChecker ownerChecker) throws Exception;\n \n-    void processGetExcludeFields(String resourceName, TokenEntity tokenEntity, OwnerChecker ownerChecker, Object obj) throws Exception;\n+    /**\n+     * remove resource fields that user have no permission to see.\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param ownerChecker a checker which check whether user is owner of the resource\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void processGetExcludeFields(String resource, TokenEntity tokenEntity, OwnerChecker ownerChecker, Object obj) throws Exception;\n \n-    void processListExcludeFields(String resourceName, TokenEntity tokenEntity, OwnerChecker ownerChecker, List<Object> objList) throws Exception;\n+    /**\n+     * remove resource fields that user have no permission to see.\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param ownerChecker a checker which check whether user is owner of the resource\n+     * @param objList http response objects\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void processListExcludeFields(String resource, TokenEntity tokenEntity, OwnerChecker ownerChecker, List<Object> objList) throws Exception;\n \n-    boolean isAdmin(String resourceName, TokenEntity tokenEntity);\n+    /**\n+     * check user whether is admin user.\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     */\n+    boolean isAdmin(String resource, TokenEntity tokenEntity);\n \n-    void checkDelete(String resourceName, TokenEntity tokenEntity, OwnerChecker ownerChecker) throws Exception;\n+    /**\n+     * check user whether have the permission to delete the resource\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param ownerChecker a checker which check whether user is owner of the resouce\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void checkDelete(String resource, TokenEntity tokenEntity, OwnerChecker ownerChecker) throws Exception;\n \n-    void checkCreate(String resourceName, TokenEntity tokenEntity, List<String> bodyFields, OwnerChecker ownerChecker) throws Exception;\n+    /**\n+     * check user whether have the permission to create the resource\n+     * @param resource the resource name\n+     * @param tokenEntity the user token info\n+     * @param bodyFields http put request body fields\n+     * @param ownerChecker a checker which check whether user is owner of the resouce\n+     * @throws Exception if check failed, throw a exception\n+     */\n+    void checkCreate(String resource, TokenEntity tokenEntity, List<String> bodyFields, OwnerChecker ownerChecker) throws Exception;\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNDkzOA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470414938", "bodyText": "What other rbacType do we plan to support?", "author": "xieus", "createdAt": "2020-08-14T05:18:00Z", "path": "lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManagerConfiguration.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.rbac;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+import java.io.IOException;\n+\n+@Configuration\n+public class RbacManagerConfiguration {\n+\n+    @Value(\"${rbac.policy.type: strict}\")\n+    private String rbacType;", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyODUwNA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470428504", "bodyText": "There are two rbacType Ignore or strict. Ignore rbac let all requestes access.", "author": "Gzure", "createdAt": "2020-08-14T06:08:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQyNjg3OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r474426879", "bodyText": "Okay thanks. In this case, we would suggest to name the rbacType as Ignore and Enforced.", "author": "xieus", "createdAt": "2020-08-21T06:06:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNDkzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxNTkyMA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r474615920", "bodyText": "One more minor suggestion: rbacType should be \"ignored\" and \"enforced\".\nPlease also update the class name as well.", "author": "xieus", "createdAt": "2020-08-21T10:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNDkzOA=="}], "type": "inlineReview", "revised_code": {"commit": "c1dd2a50b483a2924b8124d315e0b634ff64cc5d", "chunk": "diff --git a/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManagerConfiguration.java b/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManagerConfiguration.java\ndeleted file mode 100644\nindex 7ba012a5f..000000000\n--- a/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacManagerConfiguration.java\n+++ /dev/null\n\n@@ -1,40 +0,0 @@\n-/*\n- *\n- * Copyright 2019 The Alcor Authors.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- *         you may not use this file except in compliance with the License.\n- *         You may obtain a copy of the License at\n- *\n- *         http://www.apache.org/licenses/LICENSE-2.0\n- *\n- *         Unless required by applicable law or agreed to in writing, software\n- *         distributed under the License is distributed on an \"AS IS\" BASIS,\n- *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- *         See the License for the specific language governing permissions and\n- *         limitations under the License.\n- * /\n- */\n-\n-package com.futurewei.alcor.common.rbac;\n-\n-import org.springframework.beans.factory.annotation.Value;\n-import org.springframework.context.annotation.Bean;\n-import org.springframework.context.annotation.Configuration;\n-\n-import java.io.IOException;\n-\n-@Configuration\n-public class RbacManagerConfiguration {\n-\n-    @Value(\"${rbac.policy.type: strict}\")\n-    private String rbacType;\n-\n-    @Bean\n-    public RbacManger rbacManger() throws IOException {\n-        if (rbacType.equals(\"ignore\")) {\n-            return new IgnoreRbacManager();\n-        }\n-        return new StrictRbacManager();\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNTY3OQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470415679", "bodyText": "We have also a Alcor logger under common lib. do you find anything missing compared to slf4j? If not, maybe a good idea to switch to our own logger :-)", "author": "xieus", "createdAt": "2020-08-14T05:20:55Z", "path": "lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.rbac;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.futurewei.alcor.common.entity.*;\n+import com.futurewei.alcor.common.exception.*;\n+import com.futurewei.alcor.common.utils.ControllerUtil;\n+import com.futurewei.alcor.common.utils.JsonUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.stereotype.Component;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.lang.reflect.Field;\n+import java.util.*;\n+\n+public class StrictRbacManager implements RbacManger {\n+    private static final Logger LOG = LoggerFactory.getLogger(StrictRbacManager.class);", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyODY0Ng==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470428646", "bodyText": "ok", "author": "Gzure", "createdAt": "2020-08-14T06:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNTY3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzOTQ1Nw==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r472139457", "bodyText": "We have also a Alcor logger under common lib. do you find anything missing compared to slf4j? If not, maybe a good idea to switch to our own logger :-)\n\nSlf4j is a strong log frame. All our own logger features can supported by Slf4j.", "author": "Gzure", "createdAt": "2020-08-18T12:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNTY3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "04a0101347190c1d9f2725ed627f1302215b108d", "chunk": "diff --git a/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java b/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\nindex 91085f26b..2e3e3f564 100644\n--- a/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\n+++ b/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\n\n@@ -47,10 +47,10 @@ public class StrictRbacManager implements RbacManger {\n     private ServiceRbacRule serviceRbacRule;\n \n     public StrictRbacManager() throws IOException {\n-        initServiceRbacRule();\n+        initServiceRbacRules();\n     }\n \n-    private void initServiceRbacRule() throws IOException {\n+    private void initServiceRbacRules() throws IOException {\n         InputStream is = ClassLoader.getSystemResourceAsStream(SERVICE_RBAC_FILE_PATH);\n         if (is == null) {\n             is = ClassLoader.getSystemResourceAsStream(DEFAULT_RBAC_FILE_PATH);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjA2NA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470416064", "bodyText": "initServiceRbacRules", "author": "xieus", "createdAt": "2020-08-14T05:22:21Z", "path": "lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.common.rbac;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.futurewei.alcor.common.entity.*;\n+import com.futurewei.alcor.common.exception.*;\n+import com.futurewei.alcor.common.utils.ControllerUtil;\n+import com.futurewei.alcor.common.utils.JsonUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.stereotype.Component;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.lang.reflect.Field;\n+import java.util.*;\n+\n+public class StrictRbacManager implements RbacManger {\n+    private static final Logger LOG = LoggerFactory.getLogger(StrictRbacManager.class);\n+\n+    private static final String DEFAULT_RBAC_FILE_PATH = \"config/rbac_policy.json\";\n+    private static final String SERVICE_RBAC_FILE_PATH = \"rbac_policy.json\";\n+\n+    private static final String ADMIN_ROLE_NAME = \"admin\";\n+    private static final String ADVSVC_ROLE_NAME = \"advsvc\";\n+\n+    private ServiceRbacRule serviceRbacRule;\n+\n+    public StrictRbacManager() throws IOException {\n+        initServiceRbacRule();\n+    }\n+\n+    private void initServiceRbacRule() throws IOException {", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04a0101347190c1d9f2725ed627f1302215b108d", "chunk": "diff --git a/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java b/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\nindex 91085f26b..2e3e3f564 100644\n--- a/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\n+++ b/lib/src/main/java/com/futurewei/alcor/common/rbac/StrictRbacManager.java\n\n@@ -47,10 +47,10 @@ public class StrictRbacManager implements RbacManger {\n     private ServiceRbacRule serviceRbacRule;\n \n     public StrictRbacManager() throws IOException {\n-        initServiceRbacRule();\n+        initServiceRbacRules();\n     }\n \n-    private void initServiceRbacRule() throws IOException {\n+    private void initServiceRbacRules() throws IOException {\n         InputStream is = ClassLoader.getSystemResourceAsStream(SERVICE_RBAC_FILE_PATH);\n         if (is == null) {\n             is = ClassLoader.getSystemResourceAsStream(DEFAULT_RBAC_FILE_PATH);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjU2OA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470416568", "bodyText": "Do we plan to have some fun with RbacConfiguration? It is empty for now. :-)", "author": "xieus", "createdAt": "2020-08-14T05:24:29Z", "path": "web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacConfiguration.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.web.rbac.aspect;\n+\n+import org.springframework.context.annotation.ComponentScan;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+@ComponentScan(value = {\"com.futurewei.alcor.common.rbac\", \"com.futurewei.alcor.web.rbac.aspect\"})\n+public class RbacConfiguration {\n+}", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQyODg4NQ==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470428885", "bodyText": "This file is config @componentscan Only, So it have empty body.", "author": "Gzure", "createdAt": "2020-08-14T06:10:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjU2OA=="}], "type": "inlineReview", "revised_code": {"commit": "c1dd2a50b483a2924b8124d315e0b634ff64cc5d", "chunk": "diff --git a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacConfiguration.java b/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacConfiguration.java\nsimilarity index 85%\nrename from web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacConfiguration.java\nrename to lib/src/main/java/com/futurewei/alcor/common/rbac/RbacConfiguration.java\nindex d9689a8c4..a5e26b23f 100644\n--- a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacConfiguration.java\n+++ b/lib/src/main/java/com/futurewei/alcor/common/rbac/RbacConfiguration.java\n\n@@ -16,12 +16,12 @@\n  * /\n  */\n \n-package com.futurewei.alcor.web.rbac.aspect;\n+package com.futurewei.alcor.common.rbac;\n \n import org.springframework.context.annotation.ComponentScan;\n import org.springframework.context.annotation.Configuration;\n \n @Configuration\n-@ComponentScan(value = {\"com.futurewei.alcor.common.rbac\", \"com.futurewei.alcor.web.rbac.aspect\"})\n+@ComponentScan(value = \"com.futurewei.alcor.common.rbac\")\n public class RbacConfiguration {\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxODE3MA==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470418170", "bodyText": "Pretty important class. Some more comments would be helpful.", "author": "xieus", "createdAt": "2020-08-14T05:30:44Z", "path": "web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.web.rbac.aspect;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.futurewei.alcor.common.entity.TokenEntity;\n+import com.futurewei.alcor.common.exception.PolicyNotAuthorizedException;\n+import com.futurewei.alcor.common.exception.ResourceNotFoundException;\n+import com.futurewei.alcor.common.rbac.RbacManger;\n+import com.futurewei.alcor.common.utils.ControllerUtil;\n+import com.futurewei.alcor.web.exception.NotAuthorizedException;\n+import com.futurewei.alcor.web.exception.NotFoundException;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.aspectj.lang.reflect.MethodSignature;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.bind.annotation.RequestBody;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.util.*;\n+\n+import static com.futurewei.alcor.common.constants.CommonConstants.*;\n+\n+@Aspect\n+@Component\n+public class RbacAspect {", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04a0101347190c1d9f2725ed627f1302215b108d", "chunk": "diff --git a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\nindex 9b79d8e73..906d2a047 100644\n--- a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\n+++ b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\n\n@@ -34,12 +34,10 @@ import org.aspectj.lang.reflect.MethodSignature;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.http.HttpStatus;\n import org.springframework.stereotype.Component;\n import org.springframework.web.bind.annotation.RequestBody;\n \n import javax.servlet.http.HttpServletRequest;\n-import javax.servlet.http.HttpServletResponse;\n import java.io.IOException;\n import java.lang.annotation.Annotation;\n import java.lang.reflect.Field;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxODQ1Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r470418453", "bodyText": "Could ms be possibly NULL or guaranteed to have value?", "author": "xieus", "createdAt": "2020-08-14T05:31:47Z", "path": "web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ *\n+ * Copyright 2019 The Alcor Authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ *         you may not use this file except in compliance with the License.\n+ *         You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *         Unless required by applicable law or agreed to in writing, software\n+ *         distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *         WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *         See the License for the specific language governing permissions and\n+ *         limitations under the License.\n+ * /\n+ */\n+\n+package com.futurewei.alcor.web.rbac.aspect;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.futurewei.alcor.common.entity.TokenEntity;\n+import com.futurewei.alcor.common.exception.PolicyNotAuthorizedException;\n+import com.futurewei.alcor.common.exception.ResourceNotFoundException;\n+import com.futurewei.alcor.common.rbac.RbacManger;\n+import com.futurewei.alcor.common.utils.ControllerUtil;\n+import com.futurewei.alcor.web.exception.NotAuthorizedException;\n+import com.futurewei.alcor.web.exception.NotFoundException;\n+import org.aspectj.lang.ProceedingJoinPoint;\n+import org.aspectj.lang.annotation.Around;\n+import org.aspectj.lang.annotation.Aspect;\n+import org.aspectj.lang.annotation.Pointcut;\n+import org.aspectj.lang.reflect.MethodSignature;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+import org.springframework.web.bind.annotation.RequestBody;\n+\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.lang.annotation.Annotation;\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+import java.util.*;\n+\n+import static com.futurewei.alcor.common.constants.CommonConstants.*;\n+\n+@Aspect\n+@Component\n+public class RbacAspect {\n+    private static final Logger LOG = LoggerFactory.getLogger(RbacAspect.class);\n+\n+    private static final String POST_METHOD_NAME = \"POST\";\n+    private static final String PUT_METHDO_NAME = \"PUT\";\n+    private static final String DELETE_METHDO_NAME = \"DELETE\";\n+    private static final String GET_METHDO_NAME = \"GET\";\n+\n+    @Autowired\n+    private OwnerCheckerSupplier ownerCheckerSupplier;\n+\n+    @Autowired\n+    private HttpServletRequest request;\n+\n+    @Autowired\n+    private RbacManger rbacManger;\n+\n+    @Pointcut(\"@annotation(com.futurewei.alcor.web.rbac.aspect.Rbac)\")\n+    public void annotationPointCut(){}\n+\n+    @Around(\"annotationPointCut()\")\n+    public Object checkRbac(ProceedingJoinPoint pjp) throws Throwable {\n+\n+        String methodType = request.getMethod().toUpperCase();\n+        String tokenInfo = request.getHeader(TOKEN_INFO_HEADER);\n+        MethodSignature ms = (MethodSignature)pjp.getSignature();", "originalCommit": "f9078319e1f0e6244851454324e5affcfc702ff7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NzI3Mw==", "url": "https://github.com/futurewei-cloud/alcor/pull/352#discussion_r471957273", "bodyText": "Could ms be possibly NULL or guaranteed to have value?\nMs could not be null.", "author": "Gzure", "createdAt": "2020-08-18T07:01:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxODQ1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "04a0101347190c1d9f2725ed627f1302215b108d", "chunk": "diff --git a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\nindex 9b79d8e73..906d2a047 100644\n--- a/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\n+++ b/web/src/main/java/com/futurewei/alcor/web/rbac/aspect/RbacAspect.java\n\n@@ -34,12 +34,10 @@ import org.aspectj.lang.reflect.MethodSignature;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.http.HttpStatus;\n import org.springframework.stereotype.Component;\n import org.springframework.web.bind.annotation.RequestBody;\n \n import javax.servlet.http.HttpServletRequest;\n-import javax.servlet.http.HttpServletResponse;\n import java.io.IOException;\n import java.lang.annotation.Annotation;\n import java.lang.reflect.Field;\n"}}, {"oid": "04a0101347190c1d9f2725ed627f1302215b108d", "url": "https://github.com/futurewei-cloud/alcor/commit/04a0101347190c1d9f2725ed627f1302215b108d", "message": "add some comments", "committedDate": "2020-08-18T12:46:59Z", "type": "forcePushed"}, {"oid": "f42572cc00f8b5eadedb032c62f65a582f40b529", "url": "https://github.com/futurewei-cloud/alcor/commit/f42572cc00f8b5eadedb032c62f65a582f40b529", "message": "merge with master", "committedDate": "2020-08-20T09:43:54Z", "type": "forcePushed"}, {"oid": "70febdb0b2e0ac6b55214ddb58ae85fbf3bca923", "url": "https://github.com/futurewei-cloud/alcor/commit/70febdb0b2e0ac6b55214ddb58ae85fbf3bca923", "message": "merge with master", "committedDate": "2020-08-21T06:27:00Z", "type": "forcePushed"}, {"oid": "c1dd2a50b483a2924b8124d315e0b634ff64cc5d", "url": "https://github.com/futurewei-cloud/alcor/commit/c1dd2a50b483a2924b8124d315e0b634ff64cc5d", "message": "add rbac support", "committedDate": "2020-08-21T07:55:10Z", "type": "commit"}, {"oid": "4b6303fff9008dd90be8cf3c9691fe0ac01997b7", "url": "https://github.com/futurewei-cloud/alcor/commit/4b6303fff9008dd90be8cf3c9691fe0ac01997b7", "message": "add policy json files", "committedDate": "2020-08-21T07:55:10Z", "type": "commit"}, {"oid": "07e9063ead9ecc48965cca064b488d2600a4a3d3", "url": "https://github.com/futurewei-cloud/alcor/commit/07e9063ead9ecc48965cca064b488d2600a4a3d3", "message": "add rbac in config file", "committedDate": "2020-08-21T07:55:10Z", "type": "commit"}, {"oid": "9266a8ece0d73b071d63771b74085fe3a223da24", "url": "https://github.com/futurewei-cloud/alcor/commit/9266a8ece0d73b071d63771b74085fe3a223da24", "message": "add rbac in config file", "committedDate": "2020-08-21T07:55:10Z", "type": "commit"}, {"oid": "8f3410719b6c5f114a058c9f8f8b3eeb1900347b", "url": "https://github.com/futurewei-cloud/alcor/commit/8f3410719b6c5f114a058c9f8f8b3eeb1900347b", "message": "add some new exceptions", "committedDate": "2020-08-21T07:55:10Z", "type": "commit"}, {"oid": "2f0da9487a4bd3b686d95ecbd7f18264a0e2819a", "url": "https://github.com/futurewei-cloud/alcor/commit/2f0da9487a4bd3b686d95ecbd7f18264a0e2819a", "message": "change isAdmin impl", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "22ac6646216cc132d6250e74cf9ab26ebf306b63", "url": "https://github.com/futurewei-cloud/alcor/commit/22ac6646216cc132d6250e74cf9ab26ebf306b63", "message": "add request attr null handle", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "f83cbfea3bf10225a1976b5807413227b89aff66", "url": "https://github.com/futurewei-cloud/alcor/commit/f83cbfea3bf10225a1976b5807413227b89aff66", "message": "fix a spell error", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "ba6a3baf8db614467693922abf9f0296d37266a0", "url": "https://github.com/futurewei-cloud/alcor/commit/ba6a3baf8db614467693922abf9f0296d37266a0", "message": "add rbac_design.adoc", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "5e2c9d2f6726ffdd37335e62393472b90206e5aa", "url": "https://github.com/futurewei-cloud/alcor/commit/5e2c9d2f6726ffdd37335e62393472b90206e5aa", "message": "add more details in rbac_design.adoc", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "32120afb7697cb97b30d4543b4a7e0789f896ed9", "url": "https://github.com/futurewei-cloud/alcor/commit/32120afb7697cb97b30d4543b4a7e0789f896ed9", "message": "add some comments", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "6ffbc105106a7e5b5cef3e3bdafac0c384add1b6", "url": "https://github.com/futurewei-cloud/alcor/commit/6ffbc105106a7e5b5cef3e3bdafac0c384add1b6", "message": "add RbacManager UT", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "24e229b19cb017d31fff2c332f7e21d1d2c2ff4b", "url": "https://github.com/futurewei-cloud/alcor/commit/24e229b19cb017d31fff2c332f7e21d1d2c2ff4b", "message": "add RbacManager UT", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "6916746d5b3478421041f3a355a4bc9499489abc", "url": "https://github.com/futurewei-cloud/alcor/commit/6916746d5b3478421041f3a355a4bc9499489abc", "message": "merge with master", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "1e6a68171a09bdae1744dea5d7c9086ba6ed9ae1", "url": "https://github.com/futurewei-cloud/alcor/commit/1e6a68171a09bdae1744dea5d7c9086ba6ed9ae1", "message": "rename strict to Enforced", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "a438008e7a39c5ced222da74d245aa113d7a0679", "url": "https://github.com/futurewei-cloud/alcor/commit/a438008e7a39c5ced222da74d245aa113d7a0679", "message": "remove admin_or_owner roles", "committedDate": "2020-08-21T07:55:11Z", "type": "commit"}, {"oid": "a438008e7a39c5ced222da74d245aa113d7a0679", "url": "https://github.com/futurewei-cloud/alcor/commit/a438008e7a39c5ced222da74d245aa113d7a0679", "message": "remove admin_or_owner roles", "committedDate": "2020-08-21T07:55:11Z", "type": "forcePushed"}]}