{"pr_number": 5066, "pr_title": "Use existing devtools for bazel in panel and remove opening devtools for tests", "pr_createdAt": "2020-11-19T22:03:17Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/5066", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMTc0MA==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r527911740", "bodyText": "why is there a 15 second timeout?", "author": "jacob314", "createdAt": "2020-11-20T19:01:21Z", "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -237,23 +194,27 @@ public void openBrowserIntoPanel(String uri, ContentManager contentManager, Stri\n       devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n     }\n     else {\n-      @Nullable final OSProcessHandler handler =\n-        isBazel(project) ? getProcessHandlerForBazel() : getProcessHandlerForPub();\n+      if (isBazel(project)) {\n+        try {\n+          devToolsInstance = getDevToolsInstance().get(15, TimeUnit.SECONDS);", "originalCommit": "ba53f0d4a331270eca7d0306600b01962b37ea73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5NTk1OQ==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r529095959", "bodyText": "I can't remember what we decided on this - keep it? Otherwise it could wait indefinitely without raising an exception.", "author": "helin24", "createdAt": "2020-11-24T01:05:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxMTc0MA=="}], "type": "inlineReview", "revised_code": {"commit": "cc21bbb4d52cf130d422289069cf98f3b2820ccc", "chunk": "diff --git a/src/io/flutter/devtools/DevToolsManager.java b/src/io/flutter/devtools/DevToolsManager.java\nindex e33aba6c..d50786ae 100644\n--- a/src/io/flutter/devtools/DevToolsManager.java\n+++ b/src/io/flutter/devtools/DevToolsManager.java\n\n@@ -190,18 +190,19 @@ public class DevToolsManager {\n   public void openBrowserIntoPanel(String uri, ContentManager contentManager, String tabName, String pageName) {\n     final String screen = null;\n \n-    if (devToolsInstance != null) {\n-      devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+    if (isBazel(project)) {\n+      try {\n+        getDevToolsInstance().get(15, TimeUnit.SECONDS).openPanel(project, uri, contentManager, tabName, pageName);\n+      }\n+      catch (Exception e) {\n+        LOG.info(\"Failed to get existing devToolsInstance\");\n+      }\n     }\n     else {\n-      if (isBazel(project)) {\n-        try {\n-          devToolsInstance = getDevToolsInstance().get(15, TimeUnit.SECONDS);\n-          devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n-        } catch (Exception e) {\n-          LOG.info(\"Failed to get existing devToolsInstance\");\n-        }\n-      } else {\n+      if (devToolsInstance != null) {\n+        devToolsInstance.openPanel(project, uri, contentManager, tabName, pageName);\n+      }\n+      else {\n         @Nullable final OSProcessHandler handler = getProcessHandlerForPub();\n \n         if (handler != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxNDEyMA==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r527914120", "bodyText": "discussing offline if there is a more robust way to achieve the same result. I worry about all the extra edge cases this could introduce.", "author": "jacob314", "createdAt": "2020-11-20T19:06:07Z", "path": "src/io/flutter/devtools/DevToolsManager.java", "diffHunk": "@@ -298,6 +242,36 @@ private void openBrowserImpl(String uri, String screen) {\n     }\n   }\n \n+  private CompletableFuture<DevToolsInstance> getDevToolsInstance() {\n+    final CompletableFuture<DevToolsInstance> instance = new CompletableFuture<>();\n+    final Optional<FlutterApp> appsOptional =\n+      FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();", "originalCommit": "ba53f0d4a331270eca7d0306600b01962b37ea73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA5NzE5Mg==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r529097192", "bodyText": "I tried passing an app through to this function, but it's kind of complicated. There are a couple issues:\n\nApp has to be found this way when opening devtools from the run/debug tab, and this function is used from that workflow\nApp doesn't exist when a test is running, but I think we still want to be able to open devtools for bazel projects during tests? I'm not sure about the best way to make requests to the daemon from a test.", "author": "helin24", "createdAt": "2020-11-24T01:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkxNDEyMA=="}], "type": "inlineReview", "revised_code": {"commit": "dd334e4481e03d2221fbb2464f599d5381d22220", "chunk": "diff --git a/src/io/flutter/devtools/DevToolsManager.java b/src/io/flutter/devtools/DevToolsManager.java\nindex e33aba6c..91fe7b2a 100644\n--- a/src/io/flutter/devtools/DevToolsManager.java\n+++ b/src/io/flutter/devtools/DevToolsManager.java\n\n@@ -247,7 +247,7 @@ public class DevToolsManager {\n     final Optional<FlutterApp> appsOptional =\n       FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();\n \n-    if (!appsOptional.isPresent()) {\n+    if (appsOptional.isEmpty()) {\n       LOG.error(\"DevTools cannot be opened because the app has been closed\");\n       instance.complete(null);\n       return instance;\n"}}, {"oid": "dd334e4481e03d2221fbb2464f599d5381d22220", "url": "https://github.com/flutter/flutter-intellij/commit/dd334e4481e03d2221fbb2464f599d5381d22220", "message": "Use existing devtools for bazel in panel", "committedDate": "2020-11-24T01:03:27Z", "type": "commit"}, {"oid": "53c710d794f1d872fd38e561ffa7a8417eac73ad", "url": "https://github.com/flutter/flutter-intellij/commit/53c710d794f1d872fd38e561ffa7a8417eac73ad", "message": "Use isPresent instead of isEmpty for java 8", "committedDate": "2020-11-24T01:03:27Z", "type": "commit"}, {"oid": "cc21bbb4d52cf130d422289069cf98f3b2820ccc", "url": "https://github.com/flutter/flutter-intellij/commit/cc21bbb4d52cf130d422289069cf98f3b2820ccc", "message": "Get server each time app is restarted", "committedDate": "2020-11-24T01:03:27Z", "type": "commit"}, {"oid": "4eab1df493a049421a6bbdf7ce26f54cdaeda610", "url": "https://github.com/flutter/flutter-intellij/commit/4eab1df493a049421a6bbdf7ce26f54cdaeda610", "message": "Pass app to devtools", "committedDate": "2020-11-24T01:04:09Z", "type": "commit"}, {"oid": "4eab1df493a049421a6bbdf7ce26f54cdaeda610", "url": "https://github.com/flutter/flutter-intellij/commit/4eab1df493a049421a6bbdf7ce26f54cdaeda610", "message": "Pass app to devtools", "committedDate": "2020-11-24T01:04:09Z", "type": "forcePushed"}, {"oid": "fb29b043025f899a69e40aa4abb03402b991362a", "url": "https://github.com/flutter/flutter-intellij/commit/fb29b043025f899a69e40aa4abb03402b991362a", "message": "Notes", "committedDate": "2020-11-30T20:05:23Z", "type": "commit"}, {"oid": "5c0f37bb7fb02a8c4274ed134d22414110ac03a8", "url": "https://github.com/flutter/flutter-intellij/commit/5c0f37bb7fb02a8c4274ed134d22414110ac03a8", "message": "Remove devtools action form tests", "committedDate": "2020-11-30T20:41:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNDIyNg==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r532914226", "bodyText": "This code still has the problem that we are finding all FlutterApps for the project and picking one rather than usinig the app for the app being debugged. Can we pick the right app?", "author": "jacob314", "createdAt": "2020-11-30T21:26:38Z", "path": "src/io/flutter/run/OpenDevToolsAction.java", "diffHunk": "@@ -50,21 +51,29 @@ public void update(@NotNull final AnActionEvent e) {\n   public void actionPerformed(@NotNull final AnActionEvent event) {\n     FlutterInitializer.sendAnalyticsAction(this);\n \n-    if (event.getProject() == null) {\n+    Project project = event.getProject();\n+    if (project == null) {\n       return;\n     }\n \n-    final DevToolsManager devToolsManager = DevToolsManager.getInstance(event.getProject());\n+    final DevToolsManager devToolsManager = DevToolsManager.getInstance(project);\n \n-    final Optional<FlutterApp> appOptional = FlutterUtils.findFlutterAppFromProject(event.getProject());\n+    final Optional<FlutterApp> appOptional =\n+      FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();", "originalCommit": "5c0f37bb7fb02a8c4274ed134d22414110ac03a8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkyNjc3Nw==", "url": "https://github.com/flutter/flutter-intellij/pull/5066#discussion_r532926777", "bodyText": "Ah yeah, I can pass the app from where OpenDevToolsAction is created.", "author": "helin24", "createdAt": "2020-11-30T21:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjkxNDIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "811266c035ab048939f460b8f5087195c633549a", "chunk": "diff --git a/src/io/flutter/run/OpenDevToolsAction.java b/src/io/flutter/run/OpenDevToolsAction.java\nindex 5eeba7ce..f0a82e01 100644\n--- a/src/io/flutter/run/OpenDevToolsAction.java\n+++ b/src/io/flutter/run/OpenDevToolsAction.java\n\n@@ -58,22 +59,13 @@ public class OpenDevToolsAction extends DumbAwareAction {\n \n     final DevToolsManager devToolsManager = DevToolsManager.getInstance(project);\n \n-    final Optional<FlutterApp> appOptional =\n-      FlutterApp.allFromProjectProcess(project).stream().filter((FlutterApp app) -> app.getProject() == project).findFirst();\n-\n-    if (!appOptional.isPresent()) {\n-      Logger.getInstance(OpenDevToolsAction.class).error(\"DevTools cannot be opened because the app has been closed\");\n-      return;\n-    }\n-    final FlutterApp app = appOptional.get();\n-\n     if (myConnector == null) {\n       if (devToolsManager.hasInstalledDevTools()) {\n-        devToolsManager.openBrowser(app);\n+        devToolsManager.openBrowser(myApp);\n       }\n       else {\n         final CompletableFuture<Boolean> result = devToolsManager.installDevTools();\n-        result.thenAccept(o -> devToolsManager.openBrowser(app));\n+        result.thenAccept(o -> devToolsManager.openBrowser(myApp));\n       }\n     }\n     else {\n"}}, {"oid": "811266c035ab048939f460b8f5087195c633549a", "url": "https://github.com/flutter/flutter-intellij/commit/811266c035ab048939f460b8f5087195c633549a", "message": "Set app for OpenDevToolsAction", "committedDate": "2020-11-30T21:50:51Z", "type": "commit"}]}