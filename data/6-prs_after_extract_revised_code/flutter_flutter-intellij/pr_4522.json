{"pr_number": 4522, "pr_title": "Prevent drawing child lines through other chars (https://github.com/flutter/flutter-intellij/issues/4297)", "pr_createdAt": "2020-04-29T17:25:27Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/4522", "timeline": [{"oid": "6d2ef504ef2cf928d62e4b3eb1be4644425e672d", "url": "https://github.com/flutter/flutter-intellij/commit/6d2ef504ef2cf928d62e4b3eb1be4644425e672d", "message": "Prevent drawing child lines through other chars", "committedDate": "2020-04-29T16:56:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzOTYwNw==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r418239607", "bodyText": "nit. Here and elsewhere, abbreviations so write\nstartIndex rather than startIdx.", "author": "jacob314", "createdAt": "2020-04-30T19:28:53Z", "path": "src/io/flutter/editor/WidgetIndentsHighlightingPass.java", "diffHunk": "@@ -336,7 +336,17 @@ public void paint(@NotNull Editor editor, @NotNull RangeHighlighter highlighter,\n             // Draw horizontal line to the child.\n             final VisualPosition widgetVisualPosition = editor.offsetToVisualPosition(childLine.getGuideOffset());\n             final Point widgetPoint = editor.visualPositionToXY(widgetVisualPosition);\n-            final int deltaX = widgetPoint.x - start.x;\n+\n+            final int startIdx = doc.getLineStartOffset(childLine.getLine());", "originalCommit": "6d2ef504ef2cf928d62e4b3eb1be4644425e672d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0NTg5OA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r418245898", "bodyText": "add a comment explaining why this code is needed as well as tracking widgetPoint. You could reference the bug and talk about when the code has changed but we don't yet have a new outline.\nthere is an additional issues that we are just working around that there seems to be a race condition that @devoncarew is able to reproduce where the invalid offsets sometimes stay around even after a new outline is sent.", "author": "jacob314", "createdAt": "2020-04-30T19:41:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzOTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0OTQxMA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r418349410", "bodyText": "Should I remove referring to #4297 for this change? Because this change is related but it doesn't address getting invalid offsets in the new outline.", "author": "helin24", "createdAt": "2020-04-30T23:43:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzOTYwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYwNTA1NA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r419605054", "bodyText": "you can leave the reference. this mitigates the issue even if it doesn't fully fix it.", "author": "jacob314", "createdAt": "2020-05-04T17:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzOTYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "2c3012b87b48df12bb6708795a7a10d0c5bd2f37", "chunk": "diff --git a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\nindex 3595fe33..6b3f2758 100644\n--- a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n+++ b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n\n@@ -337,10 +337,13 @@ public class WidgetIndentsHighlightingPass {\n             final VisualPosition widgetVisualPosition = editor.offsetToVisualPosition(childLine.getGuideOffset());\n             final Point widgetPoint = editor.visualPositionToXY(widgetVisualPosition);\n \n-            final int startIdx = doc.getLineStartOffset(childLine.getLine());\n-            final int endIdx = doc.getLineEndOffset(childLine.getLine());\n+            // This additional point is computed because sometimes there are other characters on a line before the widget, e.g. if a\n+            // widget has been moved to a line with other code but the new outline has not been received yet (see issue #4297)\n+            // We want to compute the earliest position to avoid drawing a line through any characters before the widget if they're present.\n+            final int startIndex = doc.getLineStartOffset(childLine.getLine());\n+            final int endIndex = doc.getLineEndOffset(childLine.getLine());\n             int firstCharPosition = 0;\n-            while (startIdx + firstCharPosition < endIdx && Character.isWhitespace(chars.charAt(startIdx + firstCharPosition))) {\n+            while (startIndex + firstCharPosition < endIndex && Character.isWhitespace(chars.charAt(startIndex + firstCharPosition))) {\n               firstCharPosition += 1;\n             }\n             final Point firstCharPoint = editor.visualPositionToXY(new VisualPosition(childLine.getLine(), firstCharPosition));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTExMg==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r418241112", "bodyText": "Also update the edge case where we draw a line backward (starts at line 364). A reasonable option would be to just omit drawing the line backward if widgetLineStartX != widgetPoint.x as the backwards lines are distracting so drawing them for a case where we aren't confident that something strange has happened would be a bad thing.", "author": "jacob314", "createdAt": "2020-04-30T19:31:58Z", "path": "src/io/flutter/editor/WidgetIndentsHighlightingPass.java", "diffHunk": "@@ -347,7 +357,7 @@ public void paint(@NotNull Editor editor, @NotNull RangeHighlighter highlighter,\n                 start.x + 2,\n                 newY + lineHeight * 0.5,\n                 //start.x + charWidth  * childIndent - padding,\n-                widgetPoint.x - padding,\n+                widgetLineStartX - padding,", "originalCommit": "6d2ef504ef2cf928d62e4b3eb1be4644425e672d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODYyNTUxOQ==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r418625519", "bodyText": "I'm unclear on the backwards lines - the original situation would cause a loop to be drawn from the parent element to the beginning of the widget (before any outline update):\n\nThis seems okay? But is it confusing because maybe the loop should be drawn to before child:?\nWith this change, then there would be no backwards line in this case:", "author": "helin24", "createdAt": "2020-05-01T16:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMDE2MA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r419700160", "bodyText": "some background: the backwards lines don't really provide much value as they look pretty bad so that is why we should stop showing them if there is a risk we are showing a misleading line. The main reasons we show them at all is because it is easy to show them and because that explains why we don't draw a line in cases where the user's code isn't indented nicely.\nin the case you are dealing with where the outline doesn't match the current source code, it is safer to just not show the line.", "author": "jacob314", "createdAt": "2020-05-04T20:14:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwMTQ1Ng==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r419701456", "bodyText": "the blue lines from the row to its children also look bad in this case so it is a good thing if we don't show them when given bad data like this. In this case they are on the wrong side of the lines for their parents so the guides are hard to read so distract more than add value.", "author": "jacob314", "createdAt": "2020-05-04T20:16:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTExMg=="}], "type": "inlineReview", "revised_code": {"commit": "6170015f709a7a5ca7bd183dbb16b6f24fb8f592", "chunk": "diff --git a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\nindex 3595fe33..151bf91a 100644\n--- a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n+++ b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n\n@@ -362,6 +365,10 @@ public class WidgetIndentsHighlightingPass {\n               );\n             }\n             else {\n+              // If there are other characters on the same line as the widget, avoid drawing a backwards line\n+              if (widgetLineStartX != widgetPoint.x) {\n+                return;\n+              }\n               // Edge case where we draw a backwards line to clarify\n               // that the node is still a child even though the line is in\n               // the wrong direction. This is mainly for debugging but could help\n"}}, {"oid": "2c3012b87b48df12bb6708795a7a10d0c5bd2f37", "url": "https://github.com/flutter/flutter-intellij/commit/2c3012b87b48df12bb6708795a7a10d0c5bd2f37", "message": "Replace abbreviations and add comment", "committedDate": "2020-04-30T23:45:00Z", "type": "commit"}, {"oid": "6170015f709a7a5ca7bd183dbb16b6f24fb8f592", "url": "https://github.com/flutter/flutter-intellij/commit/6170015f709a7a5ca7bd183dbb16b6f24fb8f592", "message": "Skip drawing backwards line if start and widget start don't match", "committedDate": "2020-05-01T00:05:34Z", "type": "commit"}, {"oid": "af7278e318872201c2a9e81ba938557bf89ad60c", "url": "https://github.com/flutter/flutter-intellij/commit/af7278e318872201c2a9e81ba938557bf89ad60c", "message": "Move finding guideline start to helper function", "committedDate": "2020-05-05T20:58:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3MTE2OA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r420871168", "bodyText": "nit: prefer to wrap comment lines at 80 chars.", "author": "jacob314", "createdAt": "2020-05-06T15:12:41Z", "path": "src/io/flutter/editor/WidgetIndentsHighlightingPass.java", "diffHunk": "@@ -426,6 +432,38 @@ public void paint(@NotNull Editor editor, @NotNull RangeHighlighter highlighter,\n       }\n       g2d.dispose();\n     }\n+\n+    private static class GuidelineOffsetDetail {\n+      // This is the offset of the widget.\n+      final int offset;\n+      // This is the offset of the start of text in the line of the widget (which may differ from offset).\n+      final int textStartOffset;\n+\n+      GuidelineOffsetDetail(int offset, int textStartOffset) {\n+        this.offset = offset;\n+        this.textStartOffset = textStartOffset;\n+      }\n+    }\n+\n+    private GuidelineOffsetDetail getGuidelineOffsetDetail(OutlineLocation childLine,\n+                                                           Editor editor,\n+                                                           Document doc,\n+                                                           CharSequence chars) {\n+      // This additional point is computed because sometimes there are other characters on a line before the widget, e.g. if a", "originalCommit": "af7278e318872201c2a9e81ba938557bf89ad60c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a72847b422fc66ed58e3f30862e25cd7955b9e25", "chunk": "diff --git a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\nindex d3c19226..b20100d5 100644\n--- a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n+++ b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n\n@@ -449,9 +450,12 @@ public class WidgetIndentsHighlightingPass {\n                                                            Editor editor,\n                                                            Document doc,\n                                                            CharSequence chars) {\n-      // This additional point is computed because sometimes there are other characters on a line before the widget, e.g. if a\n-      // widget has been moved to a line with other code but the new outline has not been received yet (see issue #4297)\n-      // We want to compute the earliest position to avoid drawing a line through any characters before the widget if they're present.\n+      // This additional point is computed because sometimes there are other\n+      // characters on a line before the widget, e.g. if a widget has been moved\n+      // to a line with other code but the new outline has not been received yet\n+      // (see issue #4297). We want to compute the earliest position to avoid\n+      // drawing a line through any characters before the widget if they're\n+      // present.\n       final int startIndex = doc.getLineStartOffset(childLine.getLine());\n       final int endIndex = doc.getLineEndOffset(childLine.getLine());\n       int firstCharPosition = 0;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3MzM1MA==", "url": "https://github.com/flutter/flutter-intellij/pull/4522#discussion_r420873350", "bodyText": "end all comments with a period.", "author": "jacob314", "createdAt": "2020-05-06T15:15:24Z", "path": "src/io/flutter/editor/WidgetIndentsHighlightingPass.java", "diffHunk": "@@ -352,6 +354,10 @@ public void paint(@NotNull Editor editor, @NotNull RangeHighlighter highlighter,\n               );\n             }\n             else {\n+              // If there are other characters on the same line as the widget, avoid drawing a backwards line", "originalCommit": "af7278e318872201c2a9e81ba938557bf89ad60c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a72847b422fc66ed58e3f30862e25cd7955b9e25", "chunk": "diff --git a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\nindex d3c19226..b20100d5 100644\n--- a/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n+++ b/src/io/flutter/editor/WidgetIndentsHighlightingPass.java\n\n@@ -354,7 +354,8 @@ public class WidgetIndentsHighlightingPass {\n               );\n             }\n             else {\n-              // If there are other characters on the same line as the widget, avoid drawing a backwards line\n+              // If there are other characters on the same line as the widget,\n+              // avoid drawing a backwards line.\n               if (guidelineOffsetDetail.textStartOffset != guidelineOffsetDetail.offset) {\n                 return;\n               }\n"}}, {"oid": "a72847b422fc66ed58e3f30862e25cd7955b9e25", "url": "https://github.com/flutter/flutter-intellij/commit/a72847b422fc66ed58e3f30862e25cd7955b9e25", "message": "Fix comment formatting", "committedDate": "2020-05-06T16:11:21Z", "type": "commit"}]}