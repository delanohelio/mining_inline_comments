{"pr_number": 4373, "pr_title": "Fix crash caused by getting flutter view id with .join()", "pr_createdAt": "2020-02-11T16:41:47Z", "pr_url": "https://github.com/flutter/flutter-intellij/pull/4373", "timeline": [{"oid": "edb7617cccf699691fb9243fe09f39eab09e481c", "url": "https://github.com/flutter/flutter-intellij/commit/edb7617cccf699691fb9243fe09f39eab09e481c", "message": "Fix crash caused by getting flutter view id with .join()", "committedDate": "2020-02-11T16:40:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MDQ0NA==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r378350444", "bodyText": "It looks like get() may also block the thread until the value is ready?\nI believe the underlying issue here is that we're using clocking calls and this code path can be called from the event thread. I suspect what we need to do is to move to a non-blocking call (which may be something like .whenComplete()?), and then use that to determine the display refresh rate, and return the value as a future.\n(Java futures definitely have a much larger API surface area than the Dart variant)", "author": "devoncarew", "createdAt": "2020-02-12T16:06:42Z", "path": "src/io/flutter/vmService/DisplayRefreshRateManager.java", "diffHunk": "@@ -80,18 +80,18 @@ public Double getCurrentDisplayRefreshRateRaw() {\n   private CompletableFuture<Double> getDisplayRefreshRate() {\n     final double unknownRefreshRate = 0.0;\n \n-    final String flutterViewId = vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n-      // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n-      LOG.warn(exception.getMessage());\n-      return null;\n-    }).join();\n-\n-    if (flutterViewId == null) {\n+    try {\n+      final String flutterViewId = vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n+        // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n+        LOG.warn(exception.getMessage());\n+        return null;\n+      }).get();", "originalCommit": "edb7617cccf699691fb9243fe09f39eab09e481c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MjMwMQ==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r378352301", "bodyText": "The issue with whenComplete is that it returns a CompletableFuture<T> . In this case T is a String because that is the value we expect from getFlutterViewId. However, we need to return CompletableFuture<Double> for displayRefreshRate.", "author": "kenzieschmoll", "createdAt": "2020-02-12T16:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MDQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1NTM3Mg==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r378355372", "bodyText": "You may try creating a CompletableFuture<Double> foo at the start of the method, starting the future work to get the flutterViewId, and return the foo completable future. When you have the flutter view ID, you can then request the display rate. Once you have a value for that you should be able to call foo.complete(displayRefreshRate).", "author": "devoncarew", "createdAt": "2020-02-12T16:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MDQ0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2NjM2Mw==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r378366363", "bodyText": "I think I found a way around this by returning outside of whenComplete. PTAL.", "author": "kenzieschmoll", "createdAt": "2020-02-12T16:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1MDQ0NA=="}], "type": "inlineReview", "revised_code": {"commit": "af70d9122749885a7441fd5977306ee6502bc1b5", "chunk": "diff --git a/src/io/flutter/vmService/DisplayRefreshRateManager.java b/src/io/flutter/vmService/DisplayRefreshRateManager.java\nindex b14647b5..09a47ae8 100644\n--- a/src/io/flutter/vmService/DisplayRefreshRateManager.java\n+++ b/src/io/flutter/vmService/DisplayRefreshRateManager.java\n\n@@ -80,18 +80,22 @@ public class DisplayRefreshRateManager {\n   private CompletableFuture<Double> getDisplayRefreshRate() {\n     final double unknownRefreshRate = 0.0;\n \n-    try {\n-      final String flutterViewId = vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n-        // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n-        LOG.warn(exception.getMessage());\n-        return null;\n-      }).get();\n-      return invokeGetDisplayRefreshRate(flutterViewId);\n-    } catch (Exception e) {\n-      LOG.warn(e.getMessage());\n-      // Fail gracefully by returning the default.\n-      return CompletableFuture.completedFuture(defaultRefreshRate);\n-    }\n+    final CompletableFuture<Double> displayRefreshRate = new CompletableFuture<Double>();\n+    vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n+      // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n+      LOG.warn(exception.getMessage());\n+      return null;\n+    }).whenComplete((String id, Throwable throwable) -> {\n+      if (id == null) {\n+        // Fail gracefully by returning the default.\n+        displayRefreshRate.complete(defaultRefreshRate);\n+      } else {\n+        invokeGetDisplayRefreshRate(id).whenComplete((Double refreshRate, Throwable t) -> {\n+          displayRefreshRate.complete(refreshRate);\n+        });\n+      }\n+    });\n+    return displayRefreshRate;\n   }\n \n   private CompletableFuture<Double> invokeGetDisplayRefreshRate(String flutterViewId) {\n"}}, {"oid": "af70d9122749885a7441fd5977306ee6502bc1b5", "url": "https://github.com/flutter/flutter-intellij/commit/af70d9122749885a7441fd5977306ee6502bc1b5", "message": "Use whenComplete", "committedDate": "2020-02-12T16:30:15Z", "type": "commit"}, {"oid": "8bd71e5b4deb15ec0e81f8d58742a4236b625af7", "url": "https://github.com/flutter/flutter-intellij/commit/8bd71e5b4deb15ec0e81f8d58742a4236b625af7", "message": "remove unused var", "committedDate": "2020-02-12T16:31:33Z", "type": "commit"}, {"oid": "e0a5ead136fcc38509fe62561d849ee113c18a3b", "url": "https://github.com/flutter/flutter-intellij/commit/e0a5ead136fcc38509fe62561d849ee113c18a3b", "message": "Merge branch 'master' of github.com:flutter/flutter-intellij into flutterViewId", "committedDate": "2020-02-12T17:08:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5OTk0Mg==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r378999942", "bodyText": "If t is not null here, should we instead complete displayRefreshRate with the defaultRefreshRate?", "author": "devoncarew", "createdAt": "2020-02-13T17:11:32Z", "path": "src/io/flutter/vmService/DisplayRefreshRateManager.java", "diffHunk": "@@ -78,20 +78,22 @@ public Double getCurrentDisplayRefreshRateRaw() {\n   }\n \n   private CompletableFuture<Double> getDisplayRefreshRate() {\n-    final double unknownRefreshRate = 0.0;\n-\n-    final String flutterViewId = vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n+    final CompletableFuture<Double> displayRefreshRate = new CompletableFuture<Double>();\n+    vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n       // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n       LOG.warn(exception.getMessage());\n       return null;\n-    }).join();\n-\n-    if (flutterViewId == null) {\n-      // Fail gracefully by returning the default.\n-      return CompletableFuture.completedFuture(defaultRefreshRate);\n-    }\n-\n-    return invokeGetDisplayRefreshRate(flutterViewId);\n+    }).whenComplete((String id, Throwable throwable) -> {\n+      if (id == null) {\n+        // Fail gracefully by returning the default.\n+        displayRefreshRate.complete(defaultRefreshRate);\n+      } else {\n+        invokeGetDisplayRefreshRate(id).whenComplete((Double refreshRate, Throwable t) -> {\n+          displayRefreshRate.complete(refreshRate);", "originalCommit": "8bd71e5b4deb15ec0e81f8d58742a4236b625af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwNjE2NA==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r379006164", "bodyText": "Added exception handling via exceptionally()", "author": "kenzieschmoll", "createdAt": "2020-02-13T17:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5OTk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAwODgyMA==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r379008820", "bodyText": "I think you either want to use thenApplyAsync() and exceptionally(), or use whenComplete(). It looks like whenComplete gives you both the value, if it completes nornally or the exception if it fails.", "author": "devoncarew", "createdAt": "2020-02-13T17:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5OTk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxMTA3OQ==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r379011079", "bodyText": "done.", "author": "kenzieschmoll", "createdAt": "2020-02-13T17:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk5OTk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "26354e4bacfee039842e4175a8820ae175e4e447", "chunk": "diff --git a/src/io/flutter/vmService/DisplayRefreshRateManager.java b/src/io/flutter/vmService/DisplayRefreshRateManager.java\nindex 4913be48..a3ea35cb 100644\n--- a/src/io/flutter/vmService/DisplayRefreshRateManager.java\n+++ b/src/io/flutter/vmService/DisplayRefreshRateManager.java\n\n@@ -88,7 +88,11 @@ public class DisplayRefreshRateManager {\n         // Fail gracefully by returning the default.\n         displayRefreshRate.complete(defaultRefreshRate);\n       } else {\n-        invokeGetDisplayRefreshRate(id).whenComplete((Double refreshRate, Throwable t) -> {\n+        invokeGetDisplayRefreshRate(id).exceptionally(exception -> {\n+          LOG.warn(exception.getMessage());\n+          // Fail gracefully by returning the default.\n+          return defaultRefreshRate;\n+        }).whenComplete((Double refreshRate, Throwable t) -> {\n           displayRefreshRate.complete(refreshRate);\n         });\n       }\n"}}, {"oid": "26354e4bacfee039842e4175a8820ae175e4e447", "url": "https://github.com/flutter/flutter-intellij/commit/26354e4bacfee039842e4175a8820ae175e4e447", "message": "Handle exception from invokeGetDisplayRefreshRate", "committedDate": "2020-02-13T17:22:08Z", "type": "commit"}, {"oid": "19ba420f6ee7302fe3a38e29fc76e2110905d8e8", "url": "https://github.com/flutter/flutter-intellij/commit/19ba420f6ee7302fe3a38e29fc76e2110905d8e8", "message": "Removed both uses of exceptionally in favor of whenComplete throwable.", "committedDate": "2020-02-13T17:31:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzMzg1Mw==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r379033853", "bodyText": "This needs an else statement, otherwise when t != null we'll call displayRefreshRate.complete() twice.", "author": "devoncarew", "createdAt": "2020-02-13T18:16:08Z", "path": "src/io/flutter/vmService/DisplayRefreshRateManager.java", "diffHunk": "@@ -78,20 +78,25 @@ public Double getCurrentDisplayRefreshRateRaw() {\n   }\n \n   private CompletableFuture<Double> getDisplayRefreshRate() {\n-    final double unknownRefreshRate = 0.0;\n-\n-    final String flutterViewId = vmServiceManager.getFlutterViewId().exceptionally(exception -> {\n-      // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n-      LOG.warn(exception.getMessage());\n-      return null;\n-    }).join();\n-\n-    if (flutterViewId == null) {\n-      // Fail gracefully by returning the default.\n-      return CompletableFuture.completedFuture(defaultRefreshRate);\n-    }\n-\n-    return invokeGetDisplayRefreshRate(flutterViewId);\n+    final CompletableFuture<Double> displayRefreshRate = new CompletableFuture<Double>();\n+    vmServiceManager.getFlutterViewId().whenComplete((String id, Throwable throwable) -> {\n+      if (throwable != null) {\n+        // We often see \"java.lang.RuntimeException: Method not found\" from here; perhaps a race condition?\n+        LOG.warn(throwable.getMessage());\n+        // Fail gracefully by returning the default.\n+        displayRefreshRate.complete(defaultRefreshRate);\n+      } else {\n+        invokeGetDisplayRefreshRate(id).whenComplete((Double refreshRate, Throwable t) -> {\n+          if (t != null) {\n+            LOG.warn(t.getMessage());\n+            // Fail gracefully by returning the default.\n+            displayRefreshRate.complete(defaultRefreshRate);\n+          }", "originalCommit": "19ba420f6ee7302fe3a38e29fc76e2110905d8e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNTU4OA==", "url": "https://github.com/flutter/flutter-intellij/pull/4373#discussion_r379035588", "bodyText": "whoops. thanks for catching. fixed.", "author": "kenzieschmoll", "createdAt": "2020-02-13T18:19:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzMzg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "25ac44ec44a29cd596330d632ea85e17dbf9ad62", "chunk": "diff --git a/src/io/flutter/vmService/DisplayRefreshRateManager.java b/src/io/flutter/vmService/DisplayRefreshRateManager.java\nindex f2912d07..bcdbee8b 100644\n--- a/src/io/flutter/vmService/DisplayRefreshRateManager.java\n+++ b/src/io/flutter/vmService/DisplayRefreshRateManager.java\n\n@@ -91,8 +91,9 @@ public class DisplayRefreshRateManager {\n             LOG.warn(t.getMessage());\n             // Fail gracefully by returning the default.\n             displayRefreshRate.complete(defaultRefreshRate);\n+          } else {\n+            displayRefreshRate.complete(refreshRate);\n           }\n-          displayRefreshRate.complete(refreshRate);\n         });\n       }\n     });\n"}}, {"oid": "25ac44ec44a29cd596330d632ea85e17dbf9ad62", "url": "https://github.com/flutter/flutter-intellij/commit/25ac44ec44a29cd596330d632ea85e17dbf9ad62", "message": "fix if / else bug", "committedDate": "2020-02-13T18:18:59Z", "type": "commit"}]}