{"pr_number": 3677, "pr_title": "CAMEL-14780 camel-undertow: Enhance SPI API for HttpHandler change", "pr_createdAt": "2020-03-25T10:12:44Z", "pr_url": "https://github.com/apache/camel/pull/3677", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MTk2MA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397741960", "bodyText": "Add @metadata with security label.", "author": "davsclaus", "createdAt": "2020-03-25T10:15:47Z", "path": "components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java", "diffHunk": "@@ -78,6 +87,7 @@\n     @Metadata(label = \"security\")\n     private String allowedRoles;\n \n+    private UndertowSecurityProvider securityProvider;", "originalCommit": "54a3cbecb78f140ef1591da3a4aa428ec0736ea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0OTAwMA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397749000", "bodyText": "@davsclaus this is not parameter which comes from configuration, it is just private variable that is used by component when SPI implementation is searched for. From my POV there should be annotation like @nometadata in tis case.", "author": "JiriOndrusek", "createdAt": "2020-03-25T10:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MTk2MA=="}], "type": "inlineReview", "revised_code": {"commit": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "chunk": "diff --git a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\nindex a8c1bc52d39..00c6b93384c 100644\n--- a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n+++ b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n\n@@ -86,7 +86,7 @@ public class UndertowComponent extends DefaultComponent implements RestConsumerF\n     private Object securityConfiguration;\n     @Metadata(label = \"security\")\n     private String allowedRoles;\n-\n+    @Metadata(label = \"security\")\n     private UndertowSecurityProvider securityProvider;\n \n     public UndertowComponent() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjA5NA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397742094", "bodyText": "Add setter so you can set this explicit", "author": "davsclaus", "createdAt": "2020-03-25T10:16:04Z", "path": "components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java", "diffHunk": "@@ -435,4 +476,8 @@ public String getAllowedRoles() {\n     public void setAllowedRoles(String allowedRoles) {\n         this.allowedRoles = allowedRoles;\n     }\n+\n+    public UndertowSecurityProvider getSecurityProvider() {", "originalCommit": "54a3cbecb78f140ef1591da3a4aa428ec0736ea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0OTg4NA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397749884", "bodyText": "I can do it also this way, in that case please ignore my previous comment", "author": "JiriOndrusek", "createdAt": "2020-03-25T10:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjA5NA=="}], "type": "inlineReview", "revised_code": {"commit": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "chunk": "diff --git a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\nindex a8c1bc52d39..00c6b93384c 100644\n--- a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n+++ b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n\n@@ -477,6 +479,14 @@ public class UndertowComponent extends DefaultComponent implements RestConsumerF\n         this.allowedRoles = allowedRoles;\n     }\n \n+    /**\n+     * Security provider allows plug in the provider, which will be used to secure requests.\n+     * SPI approach could be used too (component then finds security provider using SPI).\n+     */\n+    public void setSecurityProvider(UndertowSecurityProvider securityProvider) {\n+        this.securityProvider = securityProvider;\n+    }\n+\n     public UndertowSecurityProvider getSecurityProvider() {\n         return securityProvider;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjIwMA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397742200", "bodyText": "Only init if the security provider is null", "author": "davsclaus", "createdAt": "2020-03-25T10:16:17Z", "path": "components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java", "diffHunk": "@@ -306,6 +339,8 @@ public Producer createProducer(CamelContext camelContext, String host,\n     protected void doStart() throws Exception {\n         super.doStart();\n \n+        initSecurityProvider();", "originalCommit": "54a3cbecb78f140ef1591da3a4aa428ec0736ea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc1MDY5NA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397750694", "bodyText": "I'll change it", "author": "JiriOndrusek", "createdAt": "2020-03-25T10:30:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjIwMA=="}], "type": "inlineReview", "revised_code": {"commit": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "chunk": "diff --git a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\nindex a8c1bc52d39..00c6b93384c 100644\n--- a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n+++ b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowComponent.java\n\n@@ -339,7 +339,9 @@ public class UndertowComponent extends DefaultComponent implements RestConsumerF\n     protected void doStart() throws Exception {\n         super.doStart();\n \n-        initSecurityProvider();\n+        if (this.securityProvider == null) {\n+            initSecurityProvider();\n+        }\n \n         RestConfiguration config = CamelContextHelper.getRestConfiguration(getCamelContext(), getComponentName());\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjYyMA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397742620", "bodyText": "getter/setters should be plain, not these tricks. Instead when creating the endpoint in the component, then set the security provider on the endpoint correctly", "author": "davsclaus", "createdAt": "2020-03-25T10:16:56Z", "path": "components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java", "diffHunk": "@@ -147,7 +147,11 @@ public UndertowComponent getComponent() {\n     }\n \n     public UndertowSecurityProvider getSecurityProvider() {\n-        return securityProvider;\n+        if (this.securityProvider == null) {", "originalCommit": "54a3cbecb78f140ef1591da3a4aa428ec0736ea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc1MDM2MQ==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397750361", "bodyText": "ok, I'll do it, thanks for explanation", "author": "JiriOndrusek", "createdAt": "2020-03-25T10:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "chunk": "diff --git a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\nindex 456f8c73089..4ccfe9f1702 100644\n--- a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\n+++ b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\n\n@@ -147,13 +148,13 @@ public class UndertowEndpoint extends DefaultEndpoint implements AsyncEndpoint,\n     }\n \n     public UndertowSecurityProvider getSecurityProvider() {\n-        if (this.securityProvider == null) {\n-            return getComponent().getSecurityProvider();\n-        }\n-\n         return this.securityProvider;\n     }\n \n+    public void setSecurityProvider(UndertowSecurityProvider securityProvider) {\n+        this.securityProvider = securityProvider;\n+    }\n+\n     @Override\n     public Producer createProducer() throws Exception {\n         return new UndertowProducer(this, optionMap);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjgwMA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397742800", "bodyText": "See prev comment, getter/setter should be plain", "author": "davsclaus", "createdAt": "2020-03-25T10:17:15Z", "path": "components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java", "diffHunk": "@@ -454,14 +458,13 @@ public boolean isPreserveHostHeader() {\n     }\n \n     public Object getSecurityConfiguration() {\n-        return this.securityConfiguration == null ? getComponent().getSecurityConfiguration() : this.securityConfiguration;\n+        return this.securityConfiguration;\n     }\n \n     public void setSecurityConfiguration(Object securityConfiguration) {\n         this.securityConfiguration = securityConfiguration;\n     }\n \n-\n     public String getAllowedRoles() {\n         return allowedRoles == null ? getComponent().getAllowedRoles() : allowedRoles;", "originalCommit": "54a3cbecb78f140ef1591da3a4aa428ec0736ea0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc1MDU0MA==", "url": "https://github.com/apache/camel/pull/3677#discussion_r397750540", "bodyText": "I'll change it", "author": "JiriOndrusek", "createdAt": "2020-03-25T10:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc0MjgwMA=="}], "type": "inlineReview", "revised_code": {"commit": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "chunk": "diff --git a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\nindex 456f8c73089..4ccfe9f1702 100644\n--- a/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\n+++ b/components/camel-undertow/src/main/java/org/apache/camel/component/undertow/UndertowEndpoint.java\n\n@@ -466,7 +467,7 @@ public class UndertowEndpoint extends DefaultEndpoint implements AsyncEndpoint,\n     }\n \n     public String getAllowedRoles() {\n-        return allowedRoles == null ? getComponent().getAllowedRoles() : allowedRoles;\n+        return allowedRoles;\n     }\n \n     public void setAllowedRoles(String allowedRoles) {\n"}}, {"oid": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "url": "https://github.com/apache/camel/commit/a77ee789aad3cf2093e54db901a1400c93b17fe6", "message": "CAMEL-14780 camel-undertow: UndertowSecurityProvider SPI API misses a method to change HttpHandler", "committedDate": "2020-03-25T11:06:38Z", "type": "commit"}, {"oid": "a77ee789aad3cf2093e54db901a1400c93b17fe6", "url": "https://github.com/apache/camel/commit/a77ee789aad3cf2093e54db901a1400c93b17fe6", "message": "CAMEL-14780 camel-undertow: UndertowSecurityProvider SPI API misses a method to change HttpHandler", "committedDate": "2020-03-25T11:06:38Z", "type": "forcePushed"}]}