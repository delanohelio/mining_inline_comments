{"pr_number": 3473, "pr_title": "CAMEL-14387 - fix NPE when client error", "pr_createdAt": "2020-01-10T07:47:01Z", "pr_url": "https://github.com/apache/camel/pull/3473", "timeline": [{"oid": "38af6c7f99b00995ad13915138150a4768e0bcd1", "url": "https://github.com/apache/camel/commit/38af6c7f99b00995ad13915138150a4768e0bcd1", "message": "fix NPE when client error", "committedDate": "2020-01-10T07:44:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEwOTEzMA==", "url": "https://github.com/apache/camel/pull/3473#discussion_r365109130", "bodyText": "Please run the build with the sourcecheck profile enabled, the static part must be at the end of the imports listing.", "author": "oscerd", "createdAt": "2020-01-10T07:57:48Z", "path": "components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java", "diffHunk": "@@ -16,6 +16,16 @@\n  */\n package org.apache.camel.component.salesforce.internal.streaming;\n \n+import static java.util.concurrent.TimeUnit.MILLISECONDS;", "originalCommit": "38af6c7f99b00995ad13915138150a4768e0bcd1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "998807e0b4dae8002fcb62bb0a9eaacc8a680ea7", "chunk": "diff --git a/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java b/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\nindex e8fc7f636f5..3960ef10fea 100644\n--- a/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\n+++ b/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\n\n@@ -16,16 +16,6 @@\n  */\n package org.apache.camel.component.salesforce.internal.streaming;\n \n-import static java.util.concurrent.TimeUnit.MILLISECONDS;\n-import static java.util.concurrent.TimeUnit.SECONDS;\n-import static org.cometd.bayeux.Channel.META_CONNECT;\n-import static org.cometd.bayeux.Channel.META_DISCONNECT;\n-import static org.cometd.bayeux.Channel.META_HANDSHAKE;\n-import static org.cometd.bayeux.Channel.META_SUBSCRIBE;\n-import static org.cometd.bayeux.Channel.META_UNSUBSCRIBE;\n-import static org.cometd.bayeux.Message.ERROR_FIELD;\n-import static org.cometd.bayeux.Message.SUBSCRIPTION_FIELD;\n-\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Objects;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NjM5Nw==", "url": "https://github.com/apache/camel/pull/3473#discussion_r365146397", "bodyText": "What is the reason to add SubscriptionHelper.this for these properties? IMHO it makes the code a bit chaotic, same goes for this.", "author": "omarsmak", "createdAt": "2020-01-10T09:39:16Z", "path": "components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java", "diffHunk": "@@ -99,50 +99,51 @@ public SubscriptionHelper(final SalesforceComponent component) throws Salesforce\n \n         this.listenerMap = new ConcurrentHashMap<>();\n \n-        restartBackoff = new AtomicLong(0);\n-        backoffIncrement = component.getConfig().getBackoffIncrement();\n-        maxBackoff = component.getConfig().getMaxBackoff();\n+        this.restartBackoff = new AtomicLong(0);\n+        this.backoffIncrement = component.getConfig().getBackoffIncrement();\n+        this.maxBackoff = component.getConfig().getMaxBackoff();\n     }\n \n     @Override\n     protected void doStart() throws Exception {\n \n         // create CometD client\n-        this.client = createClient(component);\n+        this.client = createClient(this.component);\n \n         // reset all error conditions\n-        handshakeError = null;\n-        handshakeException = null;\n-        connectError = null;\n-        connectException = null;\n+        this.handshakeError = null;\n+        this.handshakeException = null;\n+        this.connectError = null;\n+        this.connectException = null;\n \n         // listener for handshake error or exception\n-        if (handshakeListener == null) {\n+        if (this.handshakeListener == null) {\n             // first start\n-            handshakeListener = new ClientSessionChannel.MessageListener() {\n-                public void onMessage(ClientSessionChannel channel, Message message) {\n+            this.handshakeListener = new ClientSessionChannel.MessageListener() {\n+                @Override\n+                public void onMessage(final ClientSessionChannel channel, final Message message) {\n                     LOG.debug(\"[CHANNEL:META_HANDSHAKE]: {}\", message);\n \n                     if (!message.isSuccessful()) {\n                         LOG.warn(\"Handshake failure: {}\", message);\n-                        handshakeError = (String)message.get(ERROR_FIELD);\n-                        handshakeException = getFailure(message);\n+                        SubscriptionHelper.this.handshakeError = (String)message.get(ERROR_FIELD);", "originalCommit": "38af6c7f99b00995ad13915138150a4768e0bcd1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1MTYyNQ==", "url": "https://github.com/apache/camel/pull/3473#discussion_r365151625", "bodyText": "Sorry is my mistake... (default configuration of my IDE). I fix this.", "author": "jbdefard", "createdAt": "2020-01-10T09:50:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NjM5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE1NDk4Ng==", "url": "https://github.com/apache/camel/pull/3473#discussion_r365154986", "bodyText": "I commited a more correct patch", "author": "jbdefard", "createdAt": "2020-01-10T09:57:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NjM5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "998807e0b4dae8002fcb62bb0a9eaacc8a680ea7", "chunk": "diff --git a/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java b/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\nindex e8fc7f636f5..3960ef10fea 100644\n--- a/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\n+++ b/components/camel-salesforce/camel-salesforce-component/src/main/java/org/apache/camel/component/salesforce/internal/streaming/SubscriptionHelper.java\n\n@@ -99,51 +99,50 @@ public class SubscriptionHelper extends ServiceSupport {\n \n         this.listenerMap = new ConcurrentHashMap<>();\n \n-        this.restartBackoff = new AtomicLong(0);\n-        this.backoffIncrement = component.getConfig().getBackoffIncrement();\n-        this.maxBackoff = component.getConfig().getMaxBackoff();\n+        restartBackoff = new AtomicLong(0);\n+        backoffIncrement = component.getConfig().getBackoffIncrement();\n+        maxBackoff = component.getConfig().getMaxBackoff();\n     }\n \n     @Override\n     protected void doStart() throws Exception {\n \n         // create CometD client\n-        this.client = createClient(this.component);\n+        this.client = createClient(component);\n \n         // reset all error conditions\n-        this.handshakeError = null;\n-        this.handshakeException = null;\n-        this.connectError = null;\n-        this.connectException = null;\n+        handshakeError = null;\n+        handshakeException = null;\n+        connectError = null;\n+        connectException = null;\n \n         // listener for handshake error or exception\n-        if (this.handshakeListener == null) {\n+        if (handshakeListener == null) {\n             // first start\n-            this.handshakeListener = new ClientSessionChannel.MessageListener() {\n-                @Override\n-                public void onMessage(final ClientSessionChannel channel, final Message message) {\n+            handshakeListener = new ClientSessionChannel.MessageListener() {\n+                public void onMessage(ClientSessionChannel channel, Message message) {\n                     LOG.debug(\"[CHANNEL:META_HANDSHAKE]: {}\", message);\n \n                     if (!message.isSuccessful()) {\n                         LOG.warn(\"Handshake failure: {}\", message);\n-                        SubscriptionHelper.this.handshakeError = (String)message.get(ERROR_FIELD);\n-                        SubscriptionHelper.this.handshakeException = getFailure(message);\n+                        handshakeError = (String)message.get(ERROR_FIELD);\n+                        handshakeException = getFailure(message);\n \n-                        if (SubscriptionHelper.this.handshakeError != null) {\n+                        if (handshakeError != null) {\n                             // refresh oauth token, if it's a 401 error\n-                            if (SubscriptionHelper.this.handshakeError.startsWith(\"401::\")) {\n+                            if (handshakeError.startsWith(\"401::\")) {\n                                 try {\n                                     LOG.info(\"Refreshing OAuth token...\");\n-                                    SubscriptionHelper.this.session.login(SubscriptionHelper.this.session.getAccessToken());\n+                                    session.login(session.getAccessToken());\n                                     LOG.info(\"Refreshed OAuth token for re-handshake\");\n                                 } catch (SalesforceException e) {\n                                     LOG.warn(\"Error renewing OAuth token on 401 error: \" + e.getMessage(), e);\n                                 }\n                             }\n-                            if (SubscriptionHelper.this.handshakeError.startsWith(\"403::\")) {\n+                            if (handshakeError.startsWith(\"403::\")) {\n                                 try {\n                                     LOG.info(\"Cleaning session (logout) from SalesforceSession before restarting client\");\n-                                    SubscriptionHelper.this.session.logout();\n+                                    session.logout();\n                                 } catch (SalesforceException e) {\n                                     LOG.warn(\"Error while cleaning session: \" + e.getMessage(), e);\n                                 }\n"}}, {"oid": "998807e0b4dae8002fcb62bb0a9eaacc8a680ea7", "url": "https://github.com/apache/camel/commit/998807e0b4dae8002fcb62bb0a9eaacc8a680ea7", "message": "CAMEL-14387 - fix NPE when client error", "committedDate": "2020-01-10T09:53:38Z", "type": "commit"}]}