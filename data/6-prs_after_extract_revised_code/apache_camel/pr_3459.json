{"pr_number": 3459, "pr_title": "CAMEL-14360 - Allow overriding of message key and partition key for ggregated kafka messages", "pr_createdAt": "2020-01-06T09:26:31Z", "pr_url": "https://github.com/apache/camel/pull/3459", "timeline": [{"oid": "4b83f836f7709cdf2916e29cae42f0d747b26759", "url": "https://github.com/apache/camel/commit/4b83f836f7709cdf2916e29cae42f0d747b26759", "message": "CAMEL-14360 - Allow overriding of message key and partition key for aggregated kafka messages", "committedDate": "2020-01-06T09:23:53Z", "type": "commit"}, {"oid": "78eacbbb3011f6a1962f6eb0fd65cb36cf517819", "url": "https://github.com/apache/camel/commit/78eacbbb3011f6a1962f6eb0fd65cb36cf517819", "message": "CAMEL-14362 - Set metadata for each aggregated kafka message separately", "committedDate": "2020-01-06T09:35:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI2ODY5OQ==", "url": "https://github.com/apache/camel/pull/3459#discussion_r363268699", "bodyText": "Sorry, I am bit confused here, was there a logical reason to use pair with the message body?", "author": "omarsmak", "createdAt": "2020-01-06T12:09:58Z", "path": "components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java", "diffHunk": "@@ -181,34 +171,67 @@ protected void doStop() throws Exception {\n         if (iterator != null) {\n             final Iterator<Object> msgList = iterator;\n             final String msgTopic = topic;\n-            return new Iterator<ProducerRecord>() {\n+            return new Iterator<Pair<Object, ProducerRecord>>() {\n                 @Override\n                 public boolean hasNext() {\n                     return msgList.hasNext();\n                 }\n \n                 @Override\n-                public ProducerRecord next() {\n+                public Pair<Object, ProducerRecord> next() {", "originalCommit": "78eacbbb3011f6a1962f6eb0fd65cb36cf517819", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI3MDgxNg==", "url": "https://github.com/apache/camel/pull/3459#discussion_r363270816", "bodyText": "If the left of pair is instance of Message or Exchange it will then be used to set metadata on this Exchange/Message instance. If this is instance of something else, no metadata will be set at all.\nIf we return only the ProducerRecord, we loose information to what Message/Exchange it refers to and we cannot set metadata returned by Kafka producer.", "author": "rgala", "createdAt": "2020-01-06T12:17:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI2ODY5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3cf11994c53e64a21fcc47d8091405a759ad0390", "chunk": "diff --git a/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java b/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\nindex e8a22d8ecd3..8a7b5f814aa 100644\n--- a/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\n+++ b/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\n\n@@ -171,14 +171,14 @@ public class KafkaProducer extends DefaultAsyncProducer {\n         if (iterator != null) {\n             final Iterator<Object> msgList = iterator;\n             final String msgTopic = topic;\n-            return new Iterator<Pair<Object, ProducerRecord>>() {\n+            return new Iterator<KeyValueHolder<Object, ProducerRecord>>() {\n                 @Override\n                 public boolean hasNext() {\n                     return msgList.hasNext();\n                 }\n \n                 @Override\n-                public Pair<Object, ProducerRecord> next() {\n+                public KeyValueHolder<Object, ProducerRecord> next() {\n                     // must convert each entry of the iterator into the value according to the serializer\n                     Object next = msgList.next();\n                     String innerTopic = msgTopic;\n"}}, {"oid": "3cf11994c53e64a21fcc47d8091405a759ad0390", "url": "https://github.com/apache/camel/commit/3cf11994c53e64a21fcc47d8091405a759ad0390", "message": "CAMEL-14362 - Use KeyValueHolder instead of Pair", "committedDate": "2020-01-07T06:52:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0OTYzOQ==", "url": "https://github.com/apache/camel/pull/3459#discussion_r364649639", "bodyText": "I wonder if you should also check for instanceof Message here, and if its a message, you can use message -> getExchange to get that to set the exception.", "author": "davsclaus", "createdAt": "2020-01-09T09:59:20Z", "path": "components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java", "diffHunk": "@@ -365,7 +468,9 @@ boolean allSent() {\n         @Override\n         public void onCompletion(RecordMetadata recordMetadata, Exception e) {\n             if (e != null) {\n-                exchange.setException(e);\n+                if(body instanceof Exchange) {", "originalCommit": "3cf11994c53e64a21fcc47d8091405a759ad0390", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3Mzc4OQ==", "url": "https://github.com/apache/camel/pull/3459#discussion_r364673789", "bodyText": "Added as requested. I also wonder if checking of null result of getExchange would not be a good idea.", "author": "rgala", "createdAt": "2020-01-09T10:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0OTYzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY3NzQ3Nw==", "url": "https://github.com/apache/camel/pull/3459#discussion_r364677477", "bodyText": "Yeah you can do that", "author": "davsclaus", "createdAt": "2020-01-09T10:58:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0OTYzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "1bdd508f107ab8398d87512592b478d72e9d56f3", "chunk": "diff --git a/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java b/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\nindex 8a7b5f814aa..5d4c6eb076b 100644\n--- a/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\n+++ b/components/camel-kafka/src/main/java/org/apache/camel/component/kafka/KafkaProducer.java\n\n@@ -468,9 +468,12 @@ public class KafkaProducer extends DefaultAsyncProducer {\n         @Override\n         public void onCompletion(RecordMetadata recordMetadata, Exception e) {\n             if (e != null) {\n-                if(body instanceof Exchange) {\n+                if (body instanceof Exchange) {\n                     ((Exchange)body).setException(e);\n                 }\n+                if (body instanceof Message) {\n+                    ((Message)body).getExchange().setException(e);\n+                }\n             }\n \n             recordMetadatas.add(recordMetadata);\n"}}, {"oid": "1bdd508f107ab8398d87512592b478d72e9d56f3", "url": "https://github.com/apache/camel/commit/1bdd508f107ab8398d87512592b478d72e9d56f3", "message": "CMAEL-14362 - Code formatting changes and Exchange retrieval from Message instance", "committedDate": "2020-01-09T10:40:49Z", "type": "commit"}, {"oid": "fba2855d064994f8b53da760f98a55643c8ecccc", "url": "https://github.com/apache/camel/commit/fba2855d064994f8b53da760f98a55643c8ecccc", "message": "CAMEL-14362 - Additional check for null return value of getExchange", "committedDate": "2020-01-09T11:05:26Z", "type": "commit"}]}