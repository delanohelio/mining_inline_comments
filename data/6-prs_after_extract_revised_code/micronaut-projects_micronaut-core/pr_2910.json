{"pr_number": 2910, "pr_title": "Initial Support for HTTP/2", "pr_createdAt": "2020-03-11T12:27:43Z", "pr_url": "https://github.com/micronaut-projects/micronaut-core/pull/2910", "timeline": [{"oid": "04887037f3c95786c62d8b511fbcc87b0dec7ea5", "url": "https://github.com/micronaut-projects/micronaut-core/commit/04887037f3c95786c62d8b511fbcc87b0dec7ea5", "message": "Initial work to support HTTP/2", "committedDate": "2020-03-10T15:53:41Z", "type": "commit"}, {"oid": "bf63a2ca46a50f2765a4af67a8abb54414eef0a2", "url": "https://github.com/micronaut-projects/micronaut-core/commit/bf63a2ca46a50f2765a4af67a8abb54414eef0a2", "message": "HTTP/2 plaintext upgrade fixes", "committedDate": "2020-03-11T10:13:48Z", "type": "commit"}, {"oid": "2d7106e984ee576c7024ecabba96ca457789ab44", "url": "https://github.com/micronaut-projects/micronaut-core/commit/2d7106e984ee576c7024ecabba96ca457789ab44", "message": "Disable test for the moment", "committedDate": "2020-03-11T10:28:27Z", "type": "commit"}, {"oid": "312056fb93383ebd04fe7ee29d58f27559c5fc88", "url": "https://github.com/micronaut-projects/micronaut-core/commit/312056fb93383ebd04fe7ee29d58f27559c5fc88", "message": "Fix handling of HTTP/1 requests when HTTP/2 is active", "committedDate": "2020-03-11T11:08:38Z", "type": "commit"}, {"oid": "ed4a2f617ae5882d574d27a5c98141fa8616fff0", "url": "https://github.com/micronaut-projects/micronaut-core/commit/ed4a2f617ae5882d574d27a5c98141fa8616fff0", "message": "Checkstyle", "committedDate": "2020-03-11T11:45:54Z", "type": "commit"}, {"oid": "ff5df1729a0fd3cf73b9a19977e15f40b1c95eb7", "url": "https://github.com/micronaut-projects/micronaut-core/commit/ff5df1729a0fd3cf73b9a19977e15f40b1c95eb7", "message": "Add json stream test", "committedDate": "2020-03-11T12:03:54Z", "type": "commit"}, {"oid": "fe3c8dd145c60b7535226ba6d52ae664a45e8867", "url": "https://github.com/micronaut-projects/micronaut-core/commit/fe3c8dd145c60b7535226ba6d52ae664a45e8867", "message": "Introduce constants / Debug CI", "committedDate": "2020-03-11T12:41:56Z", "type": "commit"}, {"oid": "41f3719198bcaaf91df13e73436200809a84e524", "url": "https://github.com/micronaut-projects/micronaut-core/commit/41f3719198bcaaf91df13e73436200809a84e524", "message": "Limit build to just http/2 tests", "committedDate": "2020-03-11T12:52:17Z", "type": "commit"}, {"oid": "3afbc559635bb18755b85646d5d8d4e6864f0bd1", "url": "https://github.com/micronaut-projects/micronaut-core/commit/3afbc559635bb18755b85646d5d8d4e6864f0bd1", "message": "More debug output", "committedDate": "2020-03-11T12:56:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyMTA3Ng==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2910#discussion_r391021076", "bodyText": "Don't you need to use serverConfiguration.isValidateHeaders() here?", "author": "croudet", "createdAt": "2020-03-11T14:41:53Z", "path": "http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java", "diffHunk": "@@ -657,4 +604,221 @@ public ChannelGroup getChannelGroup() {\n     public WebSocketSessionRepository getWebSocketSessionRepository() {\n         return this;\n     }\n+\n+    private HttpToHttp2ConnectionHandler newHttpToHttp2ConnectionHandler() {\n+        Http2Connection connection = new DefaultHttp2Connection(true);\n+        final InboundHttp2ToHttpAdapter http2ToHttpAdapter = new InboundHttp2ToHttpAdapterBuilder(connection)\n+                .validateHttpHeaders(true)", "originalCommit": "ba95be15ecd62a6089f544db4b33c9a6bc98bd14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzMzc0MQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2910#discussion_r391133741", "bodyText": "Good catch", "author": "graemerocher", "createdAt": "2020-03-11T17:18:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyMTA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "167f2f505c8fe78cc4a1d5927d1992eb84df7482", "chunk": "diff --git a/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java b/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\nindex 845f5f391..11c1e8779 100644\n--- a/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\n+++ b/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\n\n@@ -766,15 +766,19 @@ public class NettyHttpServer implements EmbeddedServer, WebSocketSessionReposito\n                     final HttpToHttp2ConnectionHandler connectionHandler = newHttpToHttp2ConnectionHandler();\n                     final String fallbackHandlerName = \"http1-fallback-handler\";\n                     HttpServerUpgradeHandler.UpgradeCodecFactory upgradeCodecFactory = protocol -> {\n+                        System.out.println(\"UPGRADE protocol = \" + protocol);\n                         if (AsciiString.contentEquals(Http2CodecUtil.HTTP_UPGRADE_PROTOCOL_NAME, protocol)) {\n \n                             return new Http2ServerUpgradeCodec(HTTP2_HANDLER, connectionHandler) {\n                                 @Override\n                                 public void upgradeTo(ChannelHandlerContext ctx, FullHttpRequest upgradeRequest) {\n                                     final ChannelPipeline p = ctx.pipeline();\n+                                    System.out.println(\"Removing fallback handler\");\n                                     p.remove(fallbackHandlerName);\n+                                    System.out.println(\"Configuring Micronaut Handlers\");\n                                     http2OrHttpHandler.getHandlerForProtocol(null)\n                                             .forEach(p::addLast);\n+                                    System.out.println(\"Upgrading request\");\n                                     super.upgradeTo(ctx, upgradeRequest);\n                                 }\n                             };\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyNTc3Mw==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2910#discussion_r391025773", "bodyText": "HttpRequestCertificateHandler and RoutingInBoundHandler are @Sharable. Same instance can be used in all channels.", "author": "croudet", "createdAt": "2020-03-11T14:47:55Z", "path": "http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java", "diffHunk": "@@ -657,4 +604,221 @@ public ChannelGroup getChannelGroup() {\n     public WebSocketSessionRepository getWebSocketSessionRepository() {\n         return this;\n     }\n+\n+    private HttpToHttp2ConnectionHandler newHttpToHttp2ConnectionHandler() {\n+        Http2Connection connection = new DefaultHttp2Connection(true);\n+        final InboundHttp2ToHttpAdapter http2ToHttpAdapter = new InboundHttp2ToHttpAdapterBuilder(connection)\n+                .validateHttpHeaders(true)\n+                .maxContentLength((int) serverConfiguration.getMaxRequestSize())\n+                .build();\n+\n+        final HttpToHttp2ConnectionHandlerBuilder builder = new HttpToHttp2ConnectionHandlerBuilder()\n+                .frameListener(http2ToHttpAdapter);\n+\n+        serverConfiguration.getLogLevel().ifPresent(logLevel ->\n+                builder.frameLogger(new Http2FrameLogger(logLevel, NettyHttpServer.class))\n+        );\n+        return builder.connection(connection).build();\n+    }\n+\n+    /**\n+     * Negotiates with the browser if HTTP2 or HTTP is going to be used. Once decided, the Netty\n+     * pipeline is setup with the correct handlers for the selected protocol.\n+     */\n+    private final class Http2OrHttpHandler extends ApplicationProtocolNegotiationHandler {\n+\n+        private final SslContext sslContext;\n+\n+        /**\n+         * Default constructor.\n+         * @param sslContext The SSL context\n+         * @param fallbackProtocol The fallback protocol\n+         */\n+        Http2OrHttpHandler(SslContext sslContext, String fallbackProtocol) {\n+            super(fallbackProtocol);\n+            this.sslContext = sslContext;\n+        }\n+\n+        @Override\n+        public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+            if (evt instanceof SslHandshakeCompletionEvent) {\n+                SslHandshakeCompletionEvent event = (SslHandshakeCompletionEvent) evt;\n+                if (!event.isSuccess()) {\n+                    final Throwable cause = event.cause();\n+                    if (!(cause instanceof ClosedChannelException)) {\n+                        super.userEventTriggered(ctx, evt);\n+                    } else {\n+                        return;\n+                    }\n+                }\n+            }\n+            super.userEventTriggered(ctx, evt);\n+        }\n+\n+        @Override\n+        protected void configurePipeline(ChannelHandlerContext ctx, String protocol) {\n+            final ChannelPipeline pipeline = ctx.pipeline();\n+            configurePipeline(protocol, pipeline);\n+        }\n+\n+        private void configurePipeline(String protocol, ChannelPipeline pipeline) {\n+            Map<String, ChannelHandler> handlers = getHandlerForProtocol(protocol);\n+            handlers.forEach(pipeline::addLast);\n+        }\n+\n+        @NotNull\n+        private Map<String, ChannelHandler> getHandlerForProtocol(@Nullable String protocol) {\n+            final HttpRequestDecoder requestDecoder = new HttpRequestDecoder(NettyHttpServer.this, environment, serverConfiguration);\n+            final HttpRequestCertificateHandler requestCertificateHandler = new HttpRequestCertificateHandler();\n+            final HttpResponseEncoder responseDecoder = new HttpResponseEncoder(mediaTypeCodecRegistry, serverConfiguration);\n+            final RoutingInBoundHandler routingHandler = new RoutingInBoundHandler(", "originalCommit": "ba95be15ecd62a6089f544db4b33c9a6bc98bd14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEzNDQzNg==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2910#discussion_r391134436", "bodyText": "Will look at this thanks", "author": "graemerocher", "createdAt": "2020-03-11T17:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTAyNTc3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "167f2f505c8fe78cc4a1d5927d1992eb84df7482", "chunk": "diff --git a/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java b/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\nindex 845f5f391..11c1e8779 100644\n--- a/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\n+++ b/http-server-netty/src/main/java/io/micronaut/http/server/netty/NettyHttpServer.java\n\n@@ -766,15 +766,19 @@ public class NettyHttpServer implements EmbeddedServer, WebSocketSessionReposito\n                     final HttpToHttp2ConnectionHandler connectionHandler = newHttpToHttp2ConnectionHandler();\n                     final String fallbackHandlerName = \"http1-fallback-handler\";\n                     HttpServerUpgradeHandler.UpgradeCodecFactory upgradeCodecFactory = protocol -> {\n+                        System.out.println(\"UPGRADE protocol = \" + protocol);\n                         if (AsciiString.contentEquals(Http2CodecUtil.HTTP_UPGRADE_PROTOCOL_NAME, protocol)) {\n \n                             return new Http2ServerUpgradeCodec(HTTP2_HANDLER, connectionHandler) {\n                                 @Override\n                                 public void upgradeTo(ChannelHandlerContext ctx, FullHttpRequest upgradeRequest) {\n                                     final ChannelPipeline p = ctx.pipeline();\n+                                    System.out.println(\"Removing fallback handler\");\n                                     p.remove(fallbackHandlerName);\n+                                    System.out.println(\"Configuring Micronaut Handlers\");\n                                     http2OrHttpHandler.getHandlerForProtocol(null)\n                                             .forEach(p::addLast);\n+                                    System.out.println(\"Upgrading request\");\n                                     super.upgradeTo(ctx, upgradeRequest);\n                                 }\n                             };\n"}}, {"oid": "c0f92f94d1c46faf092b3b832288509a82686cbc", "url": "https://github.com/micronaut-projects/micronaut-core/commit/c0f92f94d1c46faf092b3b832288509a82686cbc", "message": "Reconfigure the pipeline before calling upgradeTo", "committedDate": "2020-03-11T14:53:15Z", "type": "commit"}, {"oid": "c0f92f94d1c46faf092b3b832288509a82686cbc", "url": "https://github.com/micronaut-projects/micronaut-core/commit/c0f92f94d1c46faf092b3b832288509a82686cbc", "message": "Reconfigure the pipeline before calling upgradeTo", "committedDate": "2020-03-11T14:53:15Z", "type": "forcePushed"}, {"oid": "167f2f505c8fe78cc4a1d5927d1992eb84df7482", "url": "https://github.com/micronaut-projects/micronaut-core/commit/167f2f505c8fe78cc4a1d5927d1992eb84df7482", "message": "Add debug output", "committedDate": "2020-03-11T15:19:00Z", "type": "commit"}, {"oid": "0c2d6052784c44d9c7752879502f2cad3df32f0c", "url": "https://github.com/micronaut-projects/micronaut-core/commit/0c2d6052784c44d9c7752879502f2cad3df32f0c", "message": "Add debug output", "committedDate": "2020-03-11T15:33:19Z", "type": "commit"}, {"oid": "32c2431952e93ae077f62f1377056c1e7640a23c", "url": "https://github.com/micronaut-projects/micronaut-core/commit/32c2431952e93ae077f62f1377056c1e7640a23c", "message": "Simplify Github Actions / fix bug", "committedDate": "2020-03-11T15:41:43Z", "type": "commit"}, {"oid": "7e4b2fce415538519da0ec44800584105f4821af", "url": "https://github.com/micronaut-projects/micronaut-core/commit/7e4b2fce415538519da0ec44800584105f4821af", "message": "Simplify Github Actions / fix bug", "committedDate": "2020-03-11T15:42:25Z", "type": "commit"}, {"oid": "22539e01d41114a27d1ee24a0c0cb02945c008f4", "url": "https://github.com/micronaut-projects/micronaut-core/commit/22539e01d41114a27d1ee24a0c0cb02945c008f4", "message": "Add settings handler before sending upgrade request", "committedDate": "2020-03-11T15:48:22Z", "type": "commit"}, {"oid": "0f3a174e9271a59d246a3e6c9d0f7bf6d327e781", "url": "https://github.com/micronaut-projects/micronaut-core/commit/0f3a174e9271a59d246a3e6c9d0f7bf6d327e781", "message": "Use listener on upgrade promise", "committedDate": "2020-03-11T16:12:28Z", "type": "commit"}, {"oid": "fceb81a6503c8f48d28684a56d35f14ead1ea79b", "url": "https://github.com/micronaut-projects/micronaut-core/commit/fceb81a6503c8f48d28684a56d35f14ead1ea79b", "message": "More debug output", "committedDate": "2020-03-11T16:43:20Z", "type": "commit"}, {"oid": "fceb81a6503c8f48d28684a56d35f14ead1ea79b", "url": "https://github.com/micronaut-projects/micronaut-core/commit/fceb81a6503c8f48d28684a56d35f14ead1ea79b", "message": "More debug output", "committedDate": "2020-03-11T16:43:20Z", "type": "forcePushed"}, {"oid": "c293b93a442f7c8ddc64369643e3c470b438a565", "url": "https://github.com/micronaut-projects/micronaut-core/commit/c293b93a442f7c8ddc64369643e3c470b438a565", "message": "Attempt to re-order establishing settings handle", "committedDate": "2020-03-11T16:53:47Z", "type": "commit"}, {"oid": "9f5740d53500b4af73bb8ad1635e58be9a6950e2", "url": "https://github.com/micronaut-projects/micronaut-core/commit/9f5740d53500b4af73bb8ad1635e58be9a6950e2", "message": "Cleanup", "committedDate": "2020-03-11T17:03:29Z", "type": "commit"}, {"oid": "9d69c9af8ad65b402387baceaa61e43f95ccad32", "url": "https://github.com/micronaut-projects/micronaut-core/commit/9d69c9af8ad65b402387baceaa61e43f95ccad32", "message": "Documentation", "committedDate": "2020-03-12T08:23:14Z", "type": "commit"}, {"oid": "7673e8c35d440a2a7cefe9a868b3f04f0893b371", "url": "https://github.com/micronaut-projects/micronaut-core/commit/7673e8c35d440a2a7cefe9a868b3f04f0893b371", "message": "Address feedback", "committedDate": "2020-03-12T08:46:43Z", "type": "commit"}, {"oid": "ecaf9e3cb758a48fa5e98b4160ab99e239bc95e2", "url": "https://github.com/micronaut-projects/micronaut-core/commit/ecaf9e3cb758a48fa5e98b4160ab99e239bc95e2", "message": "Fix compilation error", "committedDate": "2020-03-12T09:02:33Z", "type": "commit"}, {"oid": "fe936d8c6fc1d1f6828f2c4de688a13402616ebf", "url": "https://github.com/micronaut-projects/micronaut-core/commit/fe936d8c6fc1d1f6828f2c4de688a13402616ebf", "message": "Cleanup close handling", "committedDate": "2020-03-12T10:54:42Z", "type": "commit"}, {"oid": "66e91931c3e683eb8d670a794a9ff83a4af114c7", "url": "https://github.com/micronaut-projects/micronaut-core/commit/66e91931c3e683eb8d670a794a9ff83a4af114c7", "message": "Fix read timeout handler addition", "committedDate": "2020-03-12T13:03:14Z", "type": "commit"}, {"oid": "f464a7d21c2e1664a91a4737250c720c1f20c837", "url": "https://github.com/micronaut-projects/micronaut-core/commit/f464a7d21c2e1664a91a4737250c720c1f20c837", "message": "Support for streaming data in HTTP/2", "committedDate": "2020-03-13T09:14:10Z", "type": "commit"}, {"oid": "04a7cf066ce44630d9f42ae1afb667a411bbf75d", "url": "https://github.com/micronaut-projects/micronaut-core/commit/04a7cf066ce44630d9f42ae1afb667a411bbf75d", "message": "Fixes and tests for SSE event streaming", "committedDate": "2020-03-13T10:16:36Z", "type": "commit"}, {"oid": "f3849237318aa25e2e93d0d3f4ba2b716749c0fe", "url": "https://github.com/micronaut-projects/micronaut-core/commit/f3849237318aa25e2e93d0d3f4ba2b716749c0fe", "message": "Ignore dropped connections", "committedDate": "2020-03-13T11:45:58Z", "type": "commit"}, {"oid": "6cb00daa7fb508f64151c14641dde3fe4a0a86ce", "url": "https://github.com/micronaut-projects/micronaut-core/commit/6cb00daa7fb508f64151c14641dde3fe4a0a86ce", "message": "GraalVM native image support", "committedDate": "2020-03-13T12:24:19Z", "type": "commit"}, {"oid": "43e5ce0cf019a81fe555a65dc3138fe9d28ffe0f", "url": "https://github.com/micronaut-projects/micronaut-core/commit/43e5ce0cf019a81fe555a65dc3138fe9d28ffe0f", "message": "Use Unpooled.EMPTY_BUFFER", "committedDate": "2020-03-13T13:28:15Z", "type": "commit"}, {"oid": "cef19b9bad5f19665f2e376c2a92cecb413622fa", "url": "https://github.com/micronaut-projects/micronaut-core/commit/cef19b9bad5f19665f2e376c2a92cecb413622fa", "message": "Ensure connection cleanup for stream requests", "committedDate": "2020-03-13T14:20:09Z", "type": "commit"}, {"oid": "3079fa0ae5b59e62ead7290eaf4ee07b8951051a", "url": "https://github.com/micronaut-projects/micronaut-core/commit/3079fa0ae5b59e62ead7290eaf4ee07b8951051a", "message": "Checkstyle", "committedDate": "2020-03-13T14:42:21Z", "type": "commit"}, {"oid": "a373c8a449573e498d45f396190ae0c95b7a1329", "url": "https://github.com/micronaut-projects/micronaut-core/commit/a373c8a449573e498d45f396190ae0c95b7a1329", "message": "Enable test logging", "committedDate": "2020-03-13T15:21:02Z", "type": "commit"}, {"oid": "1f370c4678116197d2f095f1b707ebff604acdb7", "url": "https://github.com/micronaut-projects/micronaut-core/commit/1f370c4678116197d2f095f1b707ebff604acdb7", "message": "Simplify addition and removal of ReadTimeoutHandler", "committedDate": "2020-03-13T15:47:42Z", "type": "commit"}, {"oid": "2dfa8396c8243019bc4dc81901ecdf4c30b5ca11", "url": "https://github.com/micronaut-projects/micronaut-core/commit/2dfa8396c8243019bc4dc81901ecdf4c30b5ca11", "message": "Fix memory leak", "committedDate": "2020-03-16T09:00:27Z", "type": "commit"}, {"oid": "cda30229ff6b5d0aa983485c39d0003b7480eb4d", "url": "https://github.com/micronaut-projects/micronaut-core/commit/cda30229ff6b5d0aa983485c39d0003b7480eb4d", "message": "Fix memory leak", "committedDate": "2020-03-16T09:18:31Z", "type": "commit"}]}