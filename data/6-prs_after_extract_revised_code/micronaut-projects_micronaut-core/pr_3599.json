{"pr_number": 3599, "pr_title": "Clean-up inject code.", "pr_createdAt": "2020-06-29T17:44:42Z", "pr_url": "https://github.com/micronaut-projects/micronaut-core/pull/3599", "timeline": [{"oid": "6a79ab4b45567aec6cc9cbf6e8ab365d294eb071", "url": "https://github.com/micronaut-projects/micronaut-core/commit/6a79ab4b45567aec6cc9cbf6e8ab365d294eb071", "message": "Clean-up inject code.", "committedDate": "2020-06-29T17:54:07Z", "type": "forcePushed"}, {"oid": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "url": "https://github.com/micronaut-projects/micronaut-core/commit/a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "message": "Clean-up inject code.", "committedDate": "2020-06-29T18:15:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMjYwMQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447822601", "bodyText": "This doesn't seem correct", "author": "jameskleeh", "createdAt": "2020-06-30T16:34:25Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/visitor/AbstractJavaElement.java", "diffHunk": "@@ -211,30 +211,23 @@ public String toString() {\n                 return mirrorToClassElement(bound, visitorContext, genericsInfo);\n             } else {\n \n-                ClassElement classElement = mirrorToClassElement(upperBound, visitorContext, genericsInfo);\n-                if (classElement != null) {\n-                    return classElement;\n-                } else {\n-                    return mirrorToClassElement(tv.getLowerBound(), visitorContext, genericsInfo);\n-                }\n+                return mirrorToClassElement(upperBound, visitorContext, genericsInfo);", "originalCommit": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMDQ2NA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447830464", "bodyText": "mirrorToClassElement never returns null.", "author": "croudet", "createdAt": "2020-06-30T16:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMjYwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMzYxNQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447823615", "bodyText": "Removing this check doesn't seem correct. The previous calls mirrorToClassElement could have returned null", "author": "jameskleeh", "createdAt": "2020-06-30T16:35:45Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/visitor/JavaClassElement.java", "diffHunk": "@@ -211,37 +211,31 @@ protected void accept(DeclaredType declaringType, javax.lang.model.element.Eleme\n                         getterReturnType = mirrorToClassElement(returnType, visitorContext, JavaClassElement.this.genericTypeInfo);\n                     }\n \n-                    if (getterReturnType != null) {", "originalCommit": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyMzkzNg==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447823936", "bodyText": "Removing this check doesn't seem correct. The previous call to mirrorToClassElement could have returned null", "author": "jameskleeh", "createdAt": "2020-06-30T16:36:09Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/visitor/JavaClassElement.java", "diffHunk": "@@ -211,37 +211,31 @@ protected void accept(DeclaredType declaringType, javax.lang.model.element.Eleme\n                         getterReturnType = mirrorToClassElement(returnType, visitorContext, JavaClassElement.this.genericTypeInfo);\n                     }\n \n-                    if (getterReturnType != null) {\n-\n-                        BeanPropertyData beanPropertyData = props.computeIfAbsent(propertyName, BeanPropertyData::new);\n-                        configureDeclaringType(declaringTypeElement, beanPropertyData);\n-                        beanPropertyData.type = getterReturnType;\n-                        beanPropertyData.getter = executableElement;\n-                        if (beanPropertyData.setter != null) {\n-                            TypeMirror typeMirror = beanPropertyData.setter.getParameters().get(0).asType();\n-                            ClassElement setterParameterType = mirrorToClassElement(typeMirror, visitorContext, JavaClassElement.this.genericTypeInfo);\n-                            if (setterParameterType == null || !setterParameterType.getName().equals(getterReturnType.getName())) {\n-                                beanPropertyData.setter = null; // not a compatible setter\n-                            }\n+                    BeanPropertyData beanPropertyData = props.computeIfAbsent(propertyName, BeanPropertyData::new);\n+                    configureDeclaringType(declaringTypeElement, beanPropertyData);\n+                    beanPropertyData.type = getterReturnType;\n+                    beanPropertyData.getter = executableElement;\n+                    if (beanPropertyData.setter != null) {\n+                        TypeMirror typeMirror = beanPropertyData.setter.getParameters().get(0).asType();\n+                        ClassElement setterParameterType = mirrorToClassElement(typeMirror, visitorContext, JavaClassElement.this.genericTypeInfo);\n+                        if (!setterParameterType.getName().equals(getterReturnType.getName())) {\n+                            beanPropertyData.setter = null; // not a compatible setter\n                         }\n                     }\n                 } else if (NameUtils.isSetterName(methodName) && executableElement.getParameters().size() == 1) {\n                     String propertyName = NameUtils.getPropertyNameForSetter(methodName);\n                     TypeMirror typeMirror = executableElement.getParameters().get(0).asType();\n                     ClassElement setterParameterType = mirrorToClassElement(typeMirror, visitorContext, JavaClassElement.this.genericTypeInfo);\n \n-                    if (setterParameterType != null) {", "originalCommit": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTIxMQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447825211", "bodyText": "This also doesn't make sense to me. If the call returns null it shouldn't be put into the map with a null value", "author": "jameskleeh", "createdAt": "2020-06-30T16:38:00Z", "path": "inject-java/src/main/java/io/micronaut/annotation/processing/visitor/JavaClassElement.java", "diffHunk": "@@ -415,9 +404,7 @@ public AnnotationMetadata getAnnotationMetadata() {\n         while (tpi.hasNext()) {\n             TypeParameterElement tpe = tpi.next();\n             ClassElement classElement = mirrorToClassElement(tpe.asType(), visitorContext, this.genericTypeInfo);\n-            if (classElement != null) {\n-                map.put(tpe.toString(), classElement);\n-            }\n+            map.put(tpe.toString(), classElement);", "originalCommit": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTk2NA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447825964", "bodyText": "What is the reasoning for this change?", "author": "jameskleeh", "createdAt": "2020-06-30T16:39:08Z", "path": "inject/src/main/java/io/micronaut/context/AbstractBeanDefinition.java", "diffHunk": "@@ -128,7 +128,7 @@ protected AbstractBeanDefinition(Class<T> producedType,\n                                      boolean requiresReflection,\n                                      Argument... arguments) {\n \n-        AnnotationMetadata beanAnnotationMetadata = getAnnotationMetadata();\n+        getAnnotationMetadata();", "originalCommit": "a03a856f1d7fb5c4925e30fd3e62ad64fa913632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMDk0OA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447830948", "bodyText": "beanAnnotationMetadata  is not used.\nIs the call mandatory?", "author": "croudet", "createdAt": "2020-06-30T16:46:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMzk3NQ==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447833975", "bodyText": "The only thing it will do is initialize the annotation metadata, which should not need done at that point in time. You can try removing the call and see if the build passes", "author": "jameskleeh", "createdAt": "2020-06-30T16:51:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTk2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg1NDM5MA==", "url": "https://github.com/micronaut-projects/micronaut-core/pull/3599#discussion_r447854390", "bodyText": "Call removed.", "author": "croudet", "createdAt": "2020-06-30T17:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgyNTk2NA=="}], "type": "inlineReview", "revised_code": {"commit": "26e9ccc5f0b6473f1626eceefd627d99943fb9d0", "chunk": "diff --git a/inject/src/main/java/io/micronaut/context/AbstractBeanDefinition.java b/inject/src/main/java/io/micronaut/context/AbstractBeanDefinition.java\nindex eb910b661..4461a5125 100644\n--- a/inject/src/main/java/io/micronaut/context/AbstractBeanDefinition.java\n+++ b/inject/src/main/java/io/micronaut/context/AbstractBeanDefinition.java\n\n@@ -127,8 +127,6 @@ public class AbstractBeanDefinition<T> extends AbstractBeanContextConditional im\n                                      AnnotationMetadata methodMetadata,\n                                      boolean requiresReflection,\n                                      Argument... arguments) {\n-\n-        getAnnotationMetadata();\n         this.type = producedType;\n         this.isAbstract = false; // factory beans are never abstract\n         this.declaringType = declaringType;\n"}}, {"oid": "26e9ccc5f0b6473f1626eceefd627d99943fb9d0", "url": "https://github.com/micronaut-projects/micronaut-core/commit/26e9ccc5f0b6473f1626eceefd627d99943fb9d0", "message": "Clean-up inject code.", "committedDate": "2020-06-30T17:22:34Z", "type": "commit"}, {"oid": "26e9ccc5f0b6473f1626eceefd627d99943fb9d0", "url": "https://github.com/micronaut-projects/micronaut-core/commit/26e9ccc5f0b6473f1626eceefd627d99943fb9d0", "message": "Clean-up inject code.", "committedDate": "2020-06-30T17:22:34Z", "type": "forcePushed"}]}