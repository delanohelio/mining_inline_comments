{"pr_number": 104, "pr_title": "[issue #102] aksk logic change / and rename ssl to aksk ", "pr_createdAt": "2020-01-02T15:09:18Z", "pr_url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104", "timeline": [{"oid": "8a144cdcb19b509ecba18e58d343871f55710f9d", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/8a144cdcb19b509ecba18e58d343871f55710f9d", "message": "add tLSConfig and add DefaultHttpTransport(TLSConfig)", "committedDate": "2020-01-02T10:05:17Z", "type": "commit"}, {"oid": "d92860c02bcbac485326d18796bbb2f2ddd3c249", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/d92860c02bcbac485326d18796bbb2f2ddd3c249", "message": "refactory SSLConfig to AkSkConfig", "committedDate": "2020-01-02T11:08:34Z", "type": "commit"}, {"oid": "2736214a5bbf792cbdd8271fc529539bff03de36", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/2736214a5bbf792cbdd8271fc529539bff03de36", "message": "delete redundant logic", "committedDate": "2020-01-02T14:50:17Z", "type": "commit"}, {"oid": "10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e", "message": "rename ServiceCombSSLProperties to ServiceCombAkSkProperties", "committedDate": "2020-01-02T14:53:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4MzI3OA==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104#discussion_r362683278", "bodyText": "ShaAKSKCipher can be a constant in AkSkConfig", "author": "liubao68", "createdAt": "2020-01-03T01:06:26Z", "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java", "diffHunk": "@@ -59,35 +60,29 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(DealHeaderUtil.class);\n \n   public static void addAKSKHeader(HttpUriRequest httpRequest,\n-      SSLConfig sslConfig) {\n+      AkSkConfig akSkConfig) {\n     AuthHeaderUtils authHeaderUtils = AuthHeaderUtils.getInstance();\n     Map<String, String> headerMap = authHeaderUtils.genAuthHeaders();\n-    for (Map.Entry<String, String> entry : headerMap.entrySet()) {\n-      httpRequest.addHeader(entry.getKey(), entry.getValue());\n+    if (akSkConfig.isAkSkEmpty() && !CollectionUtils.isEmpty(headerMap)) {\n+      httpRequest.addHeader(X_SERVICE_AK, headerMap.get(X_SERVICE_AK));\n+      httpRequest.addHeader(X_SERVICE_SHA_AKSK, headerMap.get(X_SERVICE_SHA_AKSK));\n+    } else {\n+      httpRequest.addHeader(X_SERVICE_AK, akSkConfig.getAccessKey());\n+      httpRequest.addHeader(X_SERVICE_SHA_AKSK, encode(akSkConfig));\n     }\n-    if (isHeaderMapEmpty(headerMap) && isSSLConfigNotEmpty(sslConfig)) {\n-      httpRequest.addHeader(X_SERVICE_AK, sslConfig.getAccessKey());\n-      httpRequest.addHeader(X_SERVICE_SHA_AKSK,\n-          encode(sslConfig));\n-      httpRequest.addHeader(X_SERVICE_PROJECT, sslConfig.getProject());\n+    if (akSkConfig.isProjectEmpty() && !CollectionUtils.isEmpty(headerMap)) {\n+      httpRequest.addHeader(X_SERVICE_PROJECT, headerMap.get(X_SERVICE_PROJECT));\n+    } else {\n+      httpRequest.addHeader(X_SERVICE_PROJECT, akSkConfig.getProject());\n     }\n   }\n \n-  public static boolean isHeaderMapEmpty(Map<String, String> headerMap) {\n-    return headerMap == null || headerMap.size() == 0;\n-  }\n-\n-  public static boolean isSSLConfigNotEmpty(SSLConfig sslConfig) {\n-    return sslConfig.getAccessKey() != null && sslConfig.getSecretKey() != null && sslConfig.getProject() != null;\n-  }\n-\n-  private static String encode(SSLConfig sslConfig) {\n-\n-    if (\"ShaAKSKCipher\".equalsIgnoreCase(sslConfig.getAkskCustomCipher())) {\n-      return sslConfig.getSecretKey();\n+  private static String encode(AkSkConfig akSkConfig) {\n+    if (\"ShaAKSKCipher\".equalsIgnoreCase(akSkConfig.getAkskCustomCipher())) {", "originalCommit": "10dcc0cfaf5efab805e44e6b53f0ef8ecdab811e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4OTQzNw==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/104#discussion_r362689437", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-01-03T01:58:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY4MzI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "e4b88e34f72a83d67a42646f0a12e8da16435e3a", "chunk": "diff --git a/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java b/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java\nindex 65dc8bc..48be5b7 100644\n--- a/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java\n+++ b/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DealHeaderUtil.java\n\n@@ -70,7 +70,7 @@ public class DealHeaderUtil {\n       httpRequest.addHeader(X_SERVICE_AK, akSkConfig.getAccessKey());\n       httpRequest.addHeader(X_SERVICE_SHA_AKSK, encode(akSkConfig));\n     }\n-    if (akSkConfig.isProjectEmpty() && !CollectionUtils.isEmpty(headerMap)) {\n+    if (!CollectionUtils.isEmpty(headerMap)) {\n       httpRequest.addHeader(X_SERVICE_PROJECT, headerMap.get(X_SERVICE_PROJECT));\n     } else {\n       httpRequest.addHeader(X_SERVICE_PROJECT, akSkConfig.getProject());\n"}}, {"oid": "e4b88e34f72a83d67a42646f0a12e8da16435e3a", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/e4b88e34f72a83d67a42646f0a12e8da16435e3a", "message": "read project name from env first / use final string", "committedDate": "2020-01-03T01:12:02Z", "type": "commit"}, {"oid": "b1019bfc4512fe99b76733f4136377917a490f6c", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/b1019bfc4512fe99b76733f4136377917a490f6c", "message": "delete DealHeaderUtil.encode() ,move logic to akSkConfig.getSecretKey()", "committedDate": "2020-01-03T01:58:03Z", "type": "commit"}, {"oid": "9fd7b4d64d0281df9acd891a65555deb136cc8b0", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/9fd7b4d64d0281df9acd891a65555deb136cc8b0", "message": "Merge remote-tracking branch 'remotes/upstream/master' into tsl\n\n# Conflicts:\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/AkSkConfig.java\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/ServiceCombAkSkProperties.java\n#\tspring-cloud-huawei-common/src/main/java/com/huaweicloud/common/util/SecretUtil.java", "committedDate": "2020-01-03T02:17:51Z", "type": "commit"}]}