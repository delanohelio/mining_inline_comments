{"pr_number": 269, "pr_title": "[#268 ] RABC authentication feature ", "pr_createdAt": "2020-10-15T07:05:40Z", "pr_url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269", "timeline": [{"oid": "0f673af00cb9a997203a9f67880265e87e4c7c87", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/0f673af00cb9a997203a9f67880265e87e4c7c87", "message": "add rbac", "committedDate": "2020-10-15T07:06:59Z", "type": "forcePushed"}, {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "message": "add rbac", "committedDate": "2020-10-15T07:08:13Z", "type": "commit"}, {"oid": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "message": "add rbac", "committedDate": "2020-10-15T07:08:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDAwNQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984005", "bodyText": "TokenCache.getToken().getToken()\u5199\u6cd5\u4e0d\u592a\u597d\uff0c\u6982\u5ff5\u91cd\u53e0", "author": "tianxiaoliang", "createdAt": "2020-10-16T02:08:42Z", "path": "spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java", "diffHunk": "@@ -138,6 +142,9 @@ public void checkServerTrusted(X509Certificate[] chain,\n   private WebSocketClient buildClient() {\n     Map<String, String> signedHeader = new HashMap<>();\n     signedHeader.put(\"x-domain-name\", ServiceRegistryConfig.DEFAULT_PROJECT);\n+    if (TokenCache.getToken() != null) {\n+      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken().getToken());", "originalCommit": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzQ1MQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r508193451", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-10-20T03:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDAwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "chunk": "diff --git a/spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java b/spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java\nindex 16430f2..6d0477f 100644\n--- a/spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java\n+++ b/spring-cloud-huawei-servicecomb-discovery/src/main/java/com/huaweicloud/servicecomb/discovery/registry/ServiceCombWatcher.java\n\n@@ -142,8 +143,8 @@ public class ServiceCombWatcher {\n   private WebSocketClient buildClient() {\n     Map<String, String> signedHeader = new HashMap<>();\n     signedHeader.put(\"x-domain-name\", ServiceRegistryConfig.DEFAULT_PROJECT);\n-    if (TokenCache.getToken() != null) {\n-      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken().getToken());\n+    if (StringUtils.isEmpty(TokenCache.getToken())) {\n+      signedHeader.put(\"Authorization\", \"Bearer \" + TokenCache.getToken());\n     }\n     WebSocketClient webSocketClient;\n     try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDgyNQ==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r505984825", "bodyText": "200 \u80fd\u5426\u7528\u5e38\u91cf", "author": "tianxiaoliang", "createdAt": "2020-10-16T02:10:33Z", "path": "spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java", "diffHunk": "@@ -51,12 +62,59 @@\n  **/\n public class DefaultHttpTransport implements HttpTransport {\n \n+  private static final Logger LOGGER = LoggerFactory.getLogger(DefaultHttpTransport.class);\n+\n   private volatile static DefaultHttpTransport DEFAULT_HTTP_TRANSPORT;\n \n   private ServiceCombAkSkProperties serviceCombAkSkProperties;\n \n   private HttpClient httpClient;\n \n+  public void setRBACToken(ServiceCombRBACProperties serviceCombRBACProperties,\n+      String urls) {\n+    if (StringUtils.isEmpty(serviceCombRBACProperties.getName()) ||\n+        StringUtils.isEmpty(serviceCombRBACProperties.getPassword())) {\n+      return;\n+    }\n+    List<String> urlList = URLUtil.dealMultiUrl(urls);\n+    getToken(serviceCombRBACProperties, urlList);\n+  }\n+\n+  private void getToken(ServiceCombRBACProperties serviceCombRBACProperties, List<String> urlList) {\n+    Response response = null;\n+    String url;\n+    for (String s : urlList) {\n+      url = s;\n+      try {\n+        StringEntity stringEntity = new StringEntity(\n+            JsonUtils.OBJ_MAPPER.writeValueAsString(serviceCombRBACProperties), \"utf-8\");\n+        response = this.sendPostRequest(url + \"/v4/token\", stringEntity);\n+        if (response.getStatusCode() == 200) {", "originalCommit": "92dd85a0b62c4a6d3f5b6f29d37aed28cfd4ebbc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MzQ3Mg==", "url": "https://github.com/huaweicloud/spring-cloud-huawei/pull/269#discussion_r508193472", "bodyText": "done", "author": "GuoYL123", "createdAt": "2020-10-20T03:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTk4NDgyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "chunk": "diff --git a/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java b/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java\nindex b9113d9..5f07b0c 100644\n--- a/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java\n+++ b/spring-cloud-huawei-common/src/main/java/com/huaweicloud/common/transport/DefaultHttpTransport.java\n\n@@ -89,11 +90,11 @@ public class DefaultHttpTransport implements HttpTransport {\n         StringEntity stringEntity = new StringEntity(\n             JsonUtils.OBJ_MAPPER.writeValueAsString(serviceCombRBACProperties), \"utf-8\");\n         response = this.sendPostRequest(url + \"/v4/token\", stringEntity);\n-        if (response.getStatusCode() == 200) {\n+        if (response.getStatusCode() == HttpStatus.SC_OK) {\n           RBACToken token = JsonUtils.OBJ_MAPPER\n               .readValue(response.getContent(), RBACToken.class);\n           LOGGER.info(\"get token success.\");\n-          TokenCache.setToken(token);\n+          TokenCache.setToken(token.getToken());\n           break;\n         } else {\n           LOGGER.error(\"response failed. status:\" + response.getStatusCode() + \"; message:\" + response\n"}}, {"oid": "e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "url": "https://github.com/huaweicloud/spring-cloud-huawei/commit/e3d4fb37fa6444c2de3e375f3c7eebc90de752bb", "message": "modify as comment", "committedDate": "2020-10-20T03:52:13Z", "type": "commit"}]}