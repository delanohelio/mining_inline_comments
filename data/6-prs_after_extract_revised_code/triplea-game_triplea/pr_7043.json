{"pr_number": 7043, "pr_title": "NPE fix for 2.1.20365: ResourceLoader#loadImage:311 - NullPointerException #7039", "pr_createdAt": "2020-07-04T20:16:26Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7043", "timeline": [{"oid": "272362f21ec8b42cf9fc1eb55955e0c6a9621f3e", "url": "https://github.com/triplea-game/triplea/commit/272362f21ec8b42cf9fc1eb55955e0c6a9621f3e", "message": "NPE fix for #7039\n\nNPE fix for 2.1.20365: ResourceLoader#loadImage:311 - NullPointerException #7039", "committedDate": "2020-07-04T20:12:57Z", "type": "commit"}, {"oid": "005e775b95c9cf400a37203882baae0901e062e8", "url": "https://github.com/triplea-game/triplea/commit/005e775b95c9cf400a37203882baae0901e062e8", "message": "Merge pull request #1 from tjrbrom/hotfix/ResourceLoader-loadImage-NPE-fix\n\nNPE fix for #7039", "committedDate": "2020-07-04T20:14:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwNzAxNA==", "url": "https://github.com/triplea-game/triplea/pull/7043#discussion_r449807014", "bodyText": "Hmm I'd suggest logging some kind of error message if ImageIO.read returns null.\nOtherwise map makers might not realize that an invalid image was attempted to get loaded", "author": "RoiEXLab", "createdAt": "2020-07-04T21:30:42Z", "path": "game-core/src/main/java/games/strategy/triplea/ResourceLoader.java", "diffHunk": "@@ -308,7 +308,7 @@ public boolean hasPath(final String path) {\n       return Optional.empty();\n     }\n     try {\n-      return Optional.of(ImageIO.read(url));\n+      return Optional.ofNullable(ImageIO.read(url));", "originalCommit": "005e775b95c9cf400a37203882baae0901e062e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwODQ4Mg==", "url": "https://github.com/triplea-game/triplea/pull/7043#discussion_r449808482", "bodyText": "Hello, that's my first PR so i'm not entirely sure how to proceed from here :)\nAbout the logs, I guess you are right, the caller should handle the null but an error log should indicate exactly what happened (maybe that image was invalid?).", "author": "tjrbrom", "createdAt": "2020-07-04T21:56:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwNzAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwODU2NQ==", "url": "https://github.com/triplea-game/triplea/pull/7043#discussion_r449808565", "bodyText": "I confess I really don't know exactly in what circumstances this null might occur.\nGoing deeper into the library, we can see that ImageIO.read() method can return null, if \"bi = read(stream)\" results in null (line 1420)", "author": "tjrbrom", "createdAt": "2020-07-04T21:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwNzAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNTYzMA==", "url": "https://github.com/triplea-game/triplea/pull/7043#discussion_r449815630", "bodyText": "From the javadocs of ImageIO#read:\n\nIf no registered ImageReader claims to be able to read the resulting stream, null is returned.\n\nThis seems to be the case if the provided Image format is not supported.\nSo my suggestion would be to add an if-check that checks for null, and in case it is actually null the logger is called something like this:\nlog.severe(\"Unsupported Image Format: \" + url);\nMaybe you can come up with a better wording for the error message", "author": "RoiEXLab", "createdAt": "2020-07-05T00:05:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwNzAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "b733bc368c64cab06df65400ab915835ca039e4f", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/ResourceLoader.java b/game-core/src/main/java/games/strategy/triplea/ResourceLoader.java\nindex 37bc092e0..4720ffb2f 100644\n--- a/game-core/src/main/java/games/strategy/triplea/ResourceLoader.java\n+++ b/game-core/src/main/java/games/strategy/triplea/ResourceLoader.java\n\n@@ -308,7 +308,11 @@ public class ResourceLoader implements Closeable {\n       return Optional.empty();\n     }\n     try {\n-      return Optional.ofNullable(ImageIO.read(url));\n+      BufferedImage bi = ImageIO.read(url);\n+      if(bi == null) {\n+        log.severe(\"Unsupported Image Format: \" + url);\n+      }\n+      return Optional.ofNullable(bi);\n     } catch (final IOException e) {\n       log.log(Level.SEVERE, \"Image loading failed: \" + imageName, e);\n       return Optional.empty();\n"}}, {"oid": "b733bc368c64cab06df65400ab915835ca039e4f", "url": "https://github.com/triplea-game/triplea/commit/b733bc368c64cab06df65400ab915835ca039e4f", "message": "Log an error when reading the image URL resource from ImageIO returns null.", "committedDate": "2020-07-05T05:54:15Z", "type": "commit"}, {"oid": "4fe4b233377da1573babc3a7ffeb19398a677f26", "url": "https://github.com/triplea-game/triplea/commit/4fe4b233377da1573babc3a7ffeb19398a677f26", "message": "imported java.awt.image.BufferedImage", "committedDate": "2020-07-05T06:12:52Z", "type": "commit"}, {"oid": "4cd855a88d90a31352f9aef3402867553f281b9e", "url": "https://github.com/triplea-game/triplea/commit/4cd855a88d90a31352f9aef3402867553f281b9e", "message": "format violations", "committedDate": "2020-07-05T06:31:15Z", "type": "commit"}, {"oid": "0f4bd19bd09bdacb31114d0219d41719b6138114", "url": "https://github.com/triplea-game/triplea/commit/0f4bd19bd09bdacb31114d0219d41719b6138114", "message": "NPE fix for 2.1.20365: ResourceLoader#loadImage:311 - NullPointerException #7039", "committedDate": "2020-07-07T06:30:25Z", "type": "commit"}]}