{"pr_number": 6491, "pr_title": "Add lobby_user FK to access_log", "pr_createdAt": "2020-05-19T05:39:28Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6491", "timeline": [{"oid": "485d7433583706166c759813f4e4428900c08aff", "url": "https://github.com/triplea-game/triplea/commit/485d7433583706166c759813f4e4428900c08aff", "message": "Update access_log table, replace registered column with FK to lobby_user\n\nInstead of adding a 'true/false' value to a registered column\nin access_log, we can use a nullable foreign key to the lobby_user\ntable. We'll insert a null FK value if the user is anonymous,\notherwise we'll insert into the access_log table their lobby_user.id", "committedDate": "2020-05-19T05:04:59Z", "type": "commit"}, {"oid": "3df952b9a5e2837300e1dacb9084dca081f875f8", "url": "https://github.com/triplea-game/triplea/commit/3df952b9a5e2837300e1dacb9084dca081f875f8", "message": "Drop last_login from lobby_user and replace with access_log.access_time\n\n- The value in lobby_user is buggy and is not being updated.\n- Access log table now has a FK to the lobby_user table which\n  give us the last login time. To know the last login time of a user\n  we can join lobby_user with access_log and select the max\n  access_time to know their last login.", "committedDate": "2020-05-19T05:31:38Z", "type": "commit"}, {"oid": "ebc7ef96421fb7fc1210faa76ab7793100848bc5", "url": "https://github.com/triplea-game/triplea/commit/ebc7ef96421fb7fc1210faa76ab7793100848bc5", "message": "Update AccessLogDao.java", "committedDate": "2020-05-19T06:03:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTE4Mw==", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049183", "bodyText": "These two constants were left-over from previous cleanups, not used.", "author": "DanVanAtta", "createdAt": "2020-05-19T06:03:39Z", "path": "http-server/src/main/java/org/triplea/db/dao/moderator/ModeratorUserDaoData.java", "diffHunk": "@@ -14,9 +14,6 @@\n @NoArgsConstructor\n @Getter\n public class ModeratorUserDaoData {\n-  public static final String USERNAME_COLUMN = \"username\";\n-  public static final String LAST_LOGIN_COLUMN = \"last_login\";", "originalCommit": "ebc7ef96421fb7fc1210faa76ab7793100848bc5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTUzOQ==", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049539", "bodyText": "Nothing called this update method, it can be freely removed. It's a bug that we never invoked it. The fix here is a deeper one to get this same value from the access_log table rather than maintaining the last login in two places.", "author": "DanVanAtta", "createdAt": "2020-05-19T06:04:50Z", "path": "http-server/src/main/java/org/triplea/db/dao/user/UserJdbiDao.java", "diffHunk": "@@ -15,9 +15,6 @@\n   @SqlQuery(\"select bcrypt_password from lobby_user where username = :username\")\n   Optional<String> getPassword(@Bind(\"username\") String username);\n \n-  @SqlUpdate(\"update lobby_user set last_login = now() where username = :username\")\n-  int updateLastLoginTime(@Bind(\"username\") String username);", "originalCommit": "ebc7ef96421fb7fc1210faa76ab7793100848bc5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA0OTc4MQ==", "url": "https://github.com/triplea-game/triplea/pull/6491#discussion_r427049781", "bodyText": "insertUserAccessRecord can now figure out on its own if a user is registered or not by selecting from the lobby_user table.", "author": "DanVanAtta", "createdAt": "2020-05-19T06:05:31Z", "path": "http-server/src/main/java/org/triplea/modules/user/account/login/AccessLogUpdater.java", "diffHunk": "@@ -21,15 +21,10 @@ public static AccessLogUpdater build(final Jdbi jdbi) {\n   @Override\n   public void accept(final LoginRecord loginRecord) {\n     final int updateCount =\n-        loginRecord.isRegistered()\n-            ? accessLogDao.insertRegisteredUserRecord(\n-                loginRecord.getUserName().getValue(),\n-                loginRecord.getIp(),\n-                loginRecord.getSystemId().getValue())\n-            : accessLogDao.insertAnonymousUserRecord(\n-                loginRecord.getUserName().getValue(),\n-                loginRecord.getIp(),\n-                loginRecord.getSystemId().getValue());\n+        accessLogDao.insertUserAccessRecord(", "originalCommit": "ebc7ef96421fb7fc1210faa76ab7793100848bc5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}