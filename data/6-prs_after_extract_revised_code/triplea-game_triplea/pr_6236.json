{"pr_number": 6236, "pr_title": "Add distinct callback for websocket terminated", "pr_createdAt": "2020-04-13T20:18:27Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6236", "timeline": [{"oid": "61c204e21cd7f601918b8afb192f85de288d05ad", "url": "https://github.com/triplea-game/triplea/commit/61c204e21cd7f601918b8afb192f85de288d05ad", "message": "Add distinct callback for websocket terminated\n\nCurrently we have only one callback whenever a websocket\nis closed. This update creates a distinction between\nwhen a websocket is 'terminated' (closed by server)\nvs 'closed' (standard close by client).\n\nThe 'closed' callback remains just a runnable and continues\nto be just for client side cleanup. The 'terminated' callback\nis invoked with the disconnect error reason, which for the\ncase of bans will be the ban message from the server.\n\nIf the server gives no message, then we default that message\nto a generic \"the server disconnected\" message.\n\nAfter this update users are given a notification when they\nare disconnected due to ban, before they were given no notification.", "committedDate": "2020-04-13T20:07:44Z", "type": "commit"}, {"oid": "61c204e21cd7f601918b8afb192f85de288d05ad", "url": "https://github.com/triplea-game/triplea/commit/61c204e21cd7f601918b8afb192f85de288d05ad", "message": "Add distinct callback for websocket terminated\n\nCurrently we have only one callback whenever a websocket\nis closed. This update creates a distinction between\nwhen a websocket is 'terminated' (closed by server)\nvs 'closed' (standard close by client).\n\nThe 'closed' callback remains just a runnable and continues\nto be just for client side cleanup. The 'terminated' callback\nis invoked with the disconnect error reason, which for the\ncase of bans will be the ban message from the server.\n\nIf the server gives no message, then we default that message\nto a generic \"the server disconnected\" message.\n\nAfter this update users are given a notification when they\nare disconnected due to ban, before they were given no notification.", "committedDate": "2020-04-13T20:07:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MjE4Mw==", "url": "https://github.com/triplea-game/triplea/pull/6236#discussion_r407742183", "bodyText": "I don't know what the server side of the websocket implementation is capable of, but I think it would be a better idea to use a custom status code  for closing (it looks like codes 4000 - 4999 are reserved for application use) and make decisions based on that.", "author": "RoiEXLab", "createdAt": "2020-04-13T21:50:40Z", "path": "http-clients/src/main/java/org/triplea/http/client/web/socket/WebSocketConnection.java", "diffHunk": "@@ -205,7 +205,11 @@ public void onOpen(final WebSocket webSocket) {\n     public CompletionStage<?> onClose(\n         final WebSocket webSocket, final int statusCode, final String reason) {\n       pingSender.cancel();\n-      listener.connectionClosed(reason);\n+      if (reason.equals(WebSocketConnection.CLIENT_DISCONNECT_MESSAGE)) {\n+        listener.connectionClosed();\n+      } else {\n+        listener.connectionTerminated(reason.isBlank() ? \"Server disconnected\" : reason);\n+      }", "originalCommit": "61c204e21cd7f601918b8afb192f85de288d05ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgwMjEwNA==", "url": "https://github.com/triplea-game/triplea/pull/6236#discussion_r407802104", "bodyText": "Why better?\nstatus code for http calls can certainly give more information. There are cases where the payload of a 200 is an error message, ie: the message and service are all okay, everything happened as expected, but something resulted in an error.\nIn this case though, the message string is quite exact, keeps it quite simple. (For example, a close from server very well could be a 200, which would look like the same if the client closed)", "author": "DanVanAtta", "createdAt": "2020-04-14T00:51:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MjE4Mw=="}], "type": "inlineReview", "revised_code": null}]}