{"pr_number": 6943, "pr_title": "Save the owner of the new units in case another action changes the ownership", "pr_createdAt": "2020-06-30T05:43:34Z", "pr_url": "https://github.com/triplea-game/triplea/pull/6943", "timeline": [{"oid": "a6694619150956c90d875824d1448cc43b23b00d", "url": "https://github.com/triplea-game/triplea/commit/a6694619150956c90d875824d1448cc43b23b00d", "message": "Save the owner of the new units in case another action changes the ownership", "committedDate": "2020-06-30T05:33:25Z", "type": "commit"}, {"oid": "db68d72778490664400c527d55e8399ed6d4ce74", "url": "https://github.com/triplea-game/triplea/commit/db68d72778490664400c527d55e8399ed6d4ce74", "message": "Handle case where unit isn't in the gameData yet", "committedDate": "2020-06-30T14:39:43Z", "type": "commit"}, {"oid": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "url": "https://github.com/triplea-game/triplea/commit/59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "message": "Merge remote-tracking branch 'upstream/master' into player-owner-change-error", "committedDate": "2020-06-30T15:25:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448603982", "bodyText": "nit: 'get' methods usually are just 'getters'. If computation is done a different verb could be easier for future maintainers. Perhaps rewording this to buildUnitPlayerMap would help that. WDYT @trevan ?", "author": "DanVanAtta", "createdAt": "2020-07-01T20:39:08Z", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,26 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  private Map<UUID, String> unitPlayerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitPlayerMap = getUnitPlayerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {", "originalCommit": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTUyMw==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605523", "bodyText": "This could be a moot comment if it turns out we do not need a map.", "author": "DanVanAtta", "createdAt": "2020-07-01T20:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwMzk4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "chunk": "diff --git a/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java b/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\nindex 25bdadaec..8fc410677 100644\n--- a/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\n+++ b/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\n\n@@ -20,23 +20,28 @@ public class AddUnits extends Change {\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n-  private Map<UUID, String> unitPlayerMap;\n+  /**\n+   * The unit's owner can be modified sometime after this Change is created but before it is\n+   * performed. To ensure that the newly created units have the correct ownership, their original\n+   * owners are stored in this separate map.\n+   */\n+  private Map<UUID, String> unitOwnerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n     this.units = units;\n-    unitPlayerMap = getUnitPlayerMap(units);\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n     this.units = units;\n-    unitPlayerMap = getUnitPlayerMap(units);\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n-  private Map<UUID, String> getUnitPlayerMap(final Collection<Unit> units) {\n+  private Map<UUID, String> buildUnitOwnerMap(final Collection<Unit> units) {\n     return units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit.getOwner().getName()));\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448605417", "bodyText": "If we're iterating over the entry set of the unitPlayerMap, why do we need a map for this? Can we not just iterate over the set of units and avoid the map data structure altogether?", "author": "DanVanAtta", "createdAt": "2020-07-01T20:42:19Z", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +48,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n+  }\n+\n+  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+    final Map<UUID, Unit> uuidToUnits =\n+        units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n+    return unitPlayerMap.entrySet().stream()", "originalCommit": "59b252e3450e35fb03d2cfdf6d33cf2ff03f9720", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNzk5Mw==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448607993", "bodyText": "The original code just iterated over the set of units.  That's the problem.  We need to store the map of unit -> owner outside of the units so that when the owner changes in the unit, it doesn't change the map here.", "author": "trevan", "createdAt": "2020-07-01T20:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDQ5OA==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448630498", "bodyText": "Cool, I think that probably should be called out to make it clear & obvious. Perhaps a javadoc comment on the map property would do the trick. WDYT?", "author": "DanVanAtta", "createdAt": "2020-07-01T21:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNTk5MQ==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448635991", "bodyText": "I added some documentation and changed the method names.  WDYT?", "author": "trevan", "createdAt": "2020-07-01T21:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYwNTQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "chunk": "diff --git a/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java b/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\nindex 25bdadaec..8fc410677 100644\n--- a/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\n+++ b/game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java\n\n@@ -48,14 +53,14 @@ public class AddUnits extends Change {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    final Collection<Unit> unitsWithCorrectOwner = getUnitsWithOwner(data);\n+    final Collection<Unit> unitsWithCorrectOwner = buildUnitsWithOwner(data);\n     holder.getUnitCollection().addAll(unitsWithCorrectOwner);\n   }\n \n-  private Collection<Unit> getUnitsWithOwner(final GameData data) {\n+  private Collection<Unit> buildUnitsWithOwner(final GameData data) {\n     final Map<UUID, Unit> uuidToUnits =\n         units.stream().collect(Collectors.toMap(Unit::getId, unit -> unit));\n-    return unitPlayerMap.entrySet().stream()\n+    return unitOwnerMap.entrySet().stream()\n         .map(\n             entry -> {\n               Unit unit = data.getUnits().get(entry.getKey());\n"}}, {"oid": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "url": "https://github.com/triplea-game/triplea/commit/9d9e114af825a5d249f7bbf885ec0055ebd62238", "message": "Improve naming and add documentation for the unit-owner map", "committedDate": "2020-07-01T21:52:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzM4Ng==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637386", "bodyText": "side-note / big nit, this method could be static. I think we need to try and see if we can share a config that turns on the static analysis warning that methods can be marked as static.\nFor me it's really helpful as I watch for private methods being static. If they are, I know they do not interact with the class state. If they are not static, I assume they cannot be static and hence interact with class state.", "author": "DanVanAtta", "createdAt": "2020-07-01T21:57:12Z", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -15,19 +20,31 @@\n   private final String name;\n   private final Collection<Unit> units;\n   private final String type;\n+  /**\n+   * The unit's owner can be modified sometime after this Change is created but before it is\n+   * performed. To ensure that the newly created units have the correct ownership, their original\n+   * owners are stored in this separate map.\n+   */\n+  private Map<UUID, String> unitOwnerMap;\n \n   AddUnits(final UnitCollection collection, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     name = collection.getHolder().getName();\n     type = collection.getHolder().getType();\n   }\n \n   AddUnits(final String name, final String type, final Collection<Unit> units) {\n-    this.units = new ArrayList<>(units);\n+    this.units = units;\n+    unitOwnerMap = buildUnitOwnerMap(units);\n     this.type = type;\n     this.name = name;\n   }\n \n+  private Map<UUID, String> buildUnitOwnerMap(final Collection<Unit> units) {", "originalCommit": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzNzgzOA==", "url": "https://github.com/triplea-game/triplea/pull/6943#discussion_r448637838", "bodyText": "A test of some sort to verify the right functionality would be a good thing to have. If we change & break this, we'll have the extra safety net. Testing is really good for ensuring correctness, which is a further safety net that would be good to have as well.", "author": "DanVanAtta", "createdAt": "2020-07-01T21:58:22Z", "path": "game-core/src/main/java/games/strategy/engine/data/changefactory/AddUnits.java", "diffHunk": "@@ -36,11 +53,36 @@ public Change invert() {\n   @Override\n   protected void perform(final GameData data) {\n     final UnitHolder holder = data.getUnitHolder(name, type);\n-    holder.getUnitCollection().addAll(units);\n+    final Collection<Unit> unitsWithCorrectOwner = buildUnitsWithOwner(data);\n+    holder.getUnitCollection().addAll(unitsWithCorrectOwner);", "originalCommit": "9d9e114af825a5d249f7bbf885ec0055ebd62238", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}