{"pr_number": 8098, "pr_title": "Pass in a TotalPowerAndTotalRolls instance to UnitBattleComparator", "pr_createdAt": "2020-11-05T05:03:20Z", "pr_url": "https://github.com/triplea-game/triplea/pull/8098", "timeline": [{"oid": "f1a3a02e3327b380d3c9e9ed12781841fd464816", "url": "https://github.com/triplea-game/triplea/commit/f1a3a02e3327b380d3c9e9ed12781841fd464816", "message": "Pass in a TotalPowerAndTotalRolls instance to UnitBattleComparator\n\nThis removes the duplicate power calculation from UnitBattleComparator.", "committedDate": "2020-11-05T04:58:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NDQ2Nw==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517794467", "bodyText": "The names for these two methods (buildWithNoUnitSupports and buildOppositeCombatValue) could probably be better.  And maybe there's a way to not need them but I couldn't figure one out.", "author": "trevan", "createdAt": "2020-11-05T05:04:32Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java", "diffHunk": "@@ -17,19 +18,21 @@\n \n   boolean isDefending();\n \n-  Collection<TerritoryEffect> getTerritoryEffects();\n-\n   GameData getGameData();\n \n   Collection<Unit> getFriendUnits();\n \n   Collection<Unit> getEnemyUnits();\n \n+  CombatValue buildWithNoUnitSupports();\n+\n+  CombatValue buildOppositeCombatValue();", "originalCommit": "f1a3a02e3327b380d3c9e9ed12781841fd464816", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ca4cf88266b119271e54baa93d58987ae760ee42", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\nindex 4c7296d4d..7e2e95a6c 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\n\n@@ -14,10 +14,17 @@ public interface CombatValue {\n \n   StrengthCalculator getStrength();\n \n+  default PowerCalculator getPower() {\n+    return new PowerCalculator(\n+        getGameData(), getStrength(), getRoll(), this::chooseBestRoll, this::getDiceSides);\n+  }\n+\n   int getDiceSides(Unit unit);\n \n   boolean isDefending();\n \n+  boolean chooseBestRoll(Unit unit);\n+\n   GameData getGameData();\n \n   Collection<Unit> getFriendUnits();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NTEyOA==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517795128", "bodyText": "I added this because the buildMainCombatValue requires a territory and some places this is called doesn't have a territory.  And I didn't want to pass in null to buildMainCombatValue for territory.  With the bombard combat value change (#8097) removes the territory parameter so I could wait for that to merge and then redo this piece.", "author": "trevan", "createdAt": "2020-11-05T05:07:07Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java", "diffHunk": "@@ -91,24 +94,49 @@ static CombatValue buildAaCombatValue(\n         AvailableSupports.getSortedSupport(\n             new SupportCalculator(\n                 allEnemyUnitsAliveOrWaitingToDie, //\n-                data.getUnitTypeList().getSupportAaRules(),\n+                gameData.getUnitTypeList().getSupportAaRules(),\n                 !defending,\n                 false));\n \n     return defending\n         ? AaDefenseCombatValue.builder()\n-            .gameData(data)\n+            .gameData(gameData)\n             .supportFromFriends(supportFromFriends)\n             .supportFromEnemies(supportFromEnemies)\n             .friendUnits(allFriendlyUnitsAliveOrWaitingToDie)\n             .enemyUnits(allEnemyUnitsAliveOrWaitingToDie)\n             .build()\n         : AaOffenseCombatValue.builder()\n-            .gameData(data)\n+            .gameData(gameData)\n             .supportFromFriends(supportFromFriends)\n             .supportFromEnemies(supportFromEnemies)\n             .friendUnits(allFriendlyUnitsAliveOrWaitingToDie)\n             .enemyUnits(allEnemyUnitsAliveOrWaitingToDie)\n             .build();\n   }\n+\n+  static CombatValue buildNoSupportCombatValue(", "originalCommit": "f1a3a02e3327b380d3c9e9ed12781841fd464816", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1af46171f442a5beffc1060ccfaffbe7fe3541b1", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\nindex 4c7296d4d..7c32acc45 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/CombatValue.java\n\n@@ -139,4 +142,38 @@ public interface CombatValue {\n             .territoryIsLand(false)\n             .build();\n   }\n+\n+  static CombatValue buildBombardmentCombatValue(\n+      final Collection<Unit> allEnemyUnitsAliveOrWaitingToDie,\n+      final Collection<Unit> allFriendlyUnitsAliveOrWaitingToDie,\n+      final GameData gameData,\n+      final Collection<TerritoryEffect> territoryEffects) {\n+\n+    // Get all friendly supports\n+    final AvailableSupports supportFromFriends =\n+        AvailableSupports.getSortedSupport(\n+            new SupportCalculator(\n+                allFriendlyUnitsAliveOrWaitingToDie,\n+                gameData.getUnitTypeList().getSupportRules(),\n+                false,\n+                true));\n+\n+    // Get all enemy supports\n+    final AvailableSupports supportFromEnemies =\n+        AvailableSupports.getSortedSupport(\n+            new SupportCalculator(\n+                allEnemyUnitsAliveOrWaitingToDie,\n+                gameData.getUnitTypeList().getSupportRules(),\n+                true,\n+                false));\n+\n+    return BombardmentCombatValue.builder()\n+        .gameData(gameData)\n+        .supportFromFriends(supportFromFriends)\n+        .supportFromEnemies(supportFromEnemies)\n+        .friendUnits(allFriendlyUnitsAliveOrWaitingToDie)\n+        .enemyUnits(allEnemyUnitsAliveOrWaitingToDie)\n+        .territoryEffects(territoryEffects)\n+        .build();\n+  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5NTYwMQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r517795601", "bodyText": "Since the unit is ordered differently, this new PowerStrengthAndRolls will not be as optimized.  But the only use of buildOpposite is when the combat value has no unit support so it won't actually be affected.  Should I add a comment about that?  Or maybe change this method to always create a non-supported combat value?", "author": "trevan", "createdAt": "2020-11-05T05:08:59Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java", "diffHunk": "@@ -124,4 +124,15 @@ public int getStrength(final Unit unit) {\n   public int getRolls(final Unit unit) {\n     return totalStrengthAndTotalRollsByUnit.get(unit).getRolls();\n   }\n+\n+  @Override\n+  public int calculatePower(final Unit unit) {\n+    return totalStrengthAndTotalRollsByUnit.get(unit).calculatePower();\n+  }\n+\n+  @Override\n+  public TotalPowerAndTotalRolls buildOpposite() {\n+    return PowerStrengthAndRolls.build(\n+        totalStrengthAndTotalRollsByUnit.keySet(), calculator.buildOppositeCombatValue());", "originalCommit": "f1a3a02e3327b380d3c9e9ed12781841fd464816", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ca4cf88266b119271e54baa93d58987ae760ee42", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java\nindex 7a26b3faa..49d3aa9ca 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerStrengthAndRolls.java\n\n@@ -126,13 +129,7 @@ public class PowerStrengthAndRolls implements TotalPowerAndTotalRolls {\n   }\n \n   @Override\n-  public int calculatePower(final Unit unit) {\n-    return totalStrengthAndTotalRollsByUnit.get(unit).calculatePower();\n-  }\n-\n-  @Override\n-  public TotalPowerAndTotalRolls buildOpposite() {\n-    return PowerStrengthAndRolls.build(\n-        totalStrengthAndTotalRollsByUnit.keySet(), calculator.buildOppositeCombatValue());\n+  public int getPower(final Unit unit) {\n+    return totalStrengthAndTotalRollsByUnit.get(unit).getPower();\n   }\n }\n"}}, {"oid": "ca4cf88266b119271e54baa93d58987ae760ee42", "url": "https://github.com/triplea-game/triplea/commit/ca4cf88266b119271e54baa93d58987ae760ee42", "message": "Create a power calculator and use that instead of UnitPowerStrengthAndRolls", "committedDate": "2020-11-05T17:50:55Z", "type": "commit"}, {"oid": "abc0279d9132bcc961f7c39bb6b56fac12a7276a", "url": "https://github.com/triplea-game/triplea/commit/abc0279d9132bcc961f7c39bb6b56fac12a7276a", "message": "Don't change an input parameter", "committedDate": "2020-11-05T21:39:00Z", "type": "commit"}, {"oid": "234956204d81305c7a1e4b666808458c311e3ab4", "url": "https://github.com/triplea-game/triplea/commit/234956204d81305c7a1e4b666808458c311e3ab4", "message": "Remove another unused variable", "committedDate": "2020-11-05T22:29:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNTgyNw==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519215827", "bodyText": "Any objection to java-doc'ing this class to give an overview of what it does?", "author": "DanVanAtta", "createdAt": "2020-11-07T20:35:32Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package games.strategy.triplea.delegate.power.calculator;\n+\n+import games.strategy.engine.data.GameData;\n+import games.strategy.engine.data.Unit;\n+import java.util.function.Function;\n+import lombok.AccessLevel;\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import lombok.Value;\n+\n+@Value\n+@Getter(AccessLevel.NONE)\n+@AllArgsConstructor\n+public class PowerCalculator {", "originalCommit": "234956204d81305c7a1e4b666808458c311e3ab4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2e562390ee371f0cf82037e89e3dbcf308cfce30", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java\nindex 6d6682b18..97938f6b7 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/power/calculator/PowerCalculator.java\n\n@@ -8,6 +8,12 @@ import lombok.AllArgsConstructor;\n import lombok.Getter;\n import lombok.Value;\n \n+/**\n+ * Calculates the power of a unit\n+ *\n+ * <p>The power is defined as rolls * strength unless `chooseBestRoll` or `LHTR Bombers` are\n+ * enabled. If those are enabled, then it is strength + (rolls - 1) * (diceSides / 6)\n+ */\n @Value\n @Getter(AccessLevel.NONE)\n @AllArgsConstructor\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519216638", "bodyText": "Drilling into this method, I see: .defending(false) , which implies this is offense. @trevan can you comment? Am I missing something?", "author": "DanVanAtta", "createdAt": "2020-11-07T20:43:59Z", "path": "game-core/src/test/java/games/strategy/triplea/delegate/battle/casualty/CasualtyOrderOfLossesTestOnGlobal.java", "diffHunk": "@@ -367,9 +360,9 @@ void improvedArtillery() {\n         CasualtyOrderOfLosses.sortUnitsForCasualtiesWithSupport(amphibAssault(attackingUnits));", "originalCommit": "234956204d81305c7a1e4b666808458c311e3ab4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNDgxNQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519224815", "bodyText": "@DanVanAtta , in UnitBattleComparator#compare, it uses both the offense power and the defense power for comparing.  It will first compare the wanted direction (in this case offense) and if they are equal, it will then compare the other direction.  The marine has an offense of 2 (1 + marine bonus) and the artillery has an offense of 2 so they are equal.  It then compares the defense and before this change, the marine would have a defense of 3 (2 + marine bonus) and the artillery would only have a defense of 2.  The artillery would be considered worse and so would be the first in the list.  Now, they are considered identical (compare returns 0) so I think the behavior is that they get sorted according to how they previously exist in the list.  But it is possible the result could be non-deterministic.\nI think maybe who ever wrote this test expects the artillery to support the marines but they only support infantry and mech_infantry.  So the marines get no support from them.", "author": "trevan", "createdAt": "2020-11-07T22:03:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNTg5MQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519225891", "bodyText": "Yeah, it looks like it is based on initial order of the list.  If I add the marines to attackingUnits before the artillery, then the resulting order is different.", "author": "trevan", "createdAt": "2020-11-07T22:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNzMwOA==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519227308", "bodyText": "This ordering should be deterministic. Attack power, when on attack, should be the overriding attribute above any.\nIf we have a marine, on attack, with amphib, it has an attack power of 3. The artillery though has an attack power of 2. If choosing between marine (attack 3) and artillery (attack 2), the choice should always be artillery first. The ordering previously asserted in the test looks consistent with that.", "author": "DanVanAtta", "createdAt": "2020-11-07T22:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNzQ1MQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519227451", "bodyText": "A marine on attack with amphib is only 2.  Why do you think it should be 3?", "author": "trevan", "createdAt": "2020-11-07T22:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNzgyOQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519227829", "bodyText": "Marine has a base of '2'.\nThe amphib assault bonus gives '+1', -> 3", "author": "DanVanAtta", "createdAt": "2020-11-07T22:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyNzg4NA==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519227884", "bodyText": "Does global have marines at a power of '1' on attack as base?", "author": "DanVanAtta", "createdAt": "2020-11-07T22:33:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyODA0NA==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519228044", "bodyText": "Marines only have strength of 1 in global.", "author": "trevan", "createdAt": "2020-11-07T22:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIyODIwOQ==", "url": "https://github.com/triplea-game/triplea/pull/8098#discussion_r519228209", "bodyText": "Ah, yup, global has marines at '1', I was thinking big world v3 stats.", "author": "DanVanAtta", "createdAt": "2020-11-07T22:36:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIxNjYzOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1af46171f442a5beffc1060ccfaffbe7fe3541b1", "url": "https://github.com/triplea-game/triplea/commit/1af46171f442a5beffc1060ccfaffbe7fe3541b1", "message": "Merge branch 'master' into remove-getUnitPowerForSorting", "committedDate": "2020-11-07T21:26:57Z", "type": "commit"}, {"oid": "2e562390ee371f0cf82037e89e3dbcf308cfce30", "url": "https://github.com/triplea-game/triplea/commit/2e562390ee371f0cf82037e89e3dbcf308cfce30", "message": "Add java-doc, fix merge issues, replace buildNoSupportCombatValue", "committedDate": "2020-11-07T22:08:51Z", "type": "commit"}]}