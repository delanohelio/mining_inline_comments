{"pr_number": 7876, "pr_title": "Update: Require newer save loads to upgrade engine", "pr_createdAt": "2020-10-11T21:29:12Z", "pr_url": "https://github.com/triplea-game/triplea/pull/7876", "timeline": [{"oid": "12e854966a3bff255267a4dee510fd9d51fec68c", "url": "https://github.com/triplea-game/triplea/commit/12e854966a3bff255267a4dee510fd9d51fec68c", "message": "Remove unnecessary null check, new input stream will thrown NPE on the next line", "committedDate": "2020-10-11T18:51:31Z", "type": "commit"}, {"oid": "0e134e518b5b564951d135ec4fb6c5ad897ab179", "url": "https://github.com/triplea-game/triplea/commit/0e134e518b5b564951d135ec4fb6c5ad897ab179", "message": "Return an optional instead of throwing an exception on game load\n\nRather than control-flow-by-exception, we return an optional and have\nthe lower layers take care of error handling and notifications.", "committedDate": "2020-10-11T20:20:58Z", "type": "commit"}, {"oid": "9c0967c0c31f15ceb519001b76928ddd4e9c5c2f", "url": "https://github.com/triplea-game/triplea/commit/9c0967c0c31f15ceb519001b76928ddd4e9c5c2f", "message": "Finish converting game loading to return an optional and handle thrown errors", "committedDate": "2020-10-11T20:59:16Z", "type": "commit"}, {"oid": "64a8c1d435b3cba6e1d0c3a94dfe936c93c896ae", "url": "https://github.com/triplea-game/triplea/commit/64a8c1d435b3cba6e1d0c3a94dfe936c93c896ae", "message": "Do not load future save game versions, only prompt user to upgrade their engine\n\nThere are subtle risks with playing a *maybe* forward compatible version of TripleA\nwith a new save. To help ensure rule integrity, this update removes a yes/no prompt\nfor users to continue in such situations and instead instructs them to download\na newer game engine.", "committedDate": "2020-10-11T21:04:27Z", "type": "commit"}, {"oid": "98ef72ef32de73df9026c9bc51b30c5b5c400a6c", "url": "https://github.com/triplea-game/triplea/commit/98ef72ef32de73df9026c9bc51b30c5b5c400a6c", "message": "Fix html formatting of load newer save game message", "committedDate": "2020-10-11T21:21:25Z", "type": "commit"}, {"oid": "0b5dd59d7da6b5236e5bfbb5658d9e3963a24308", "url": "https://github.com/triplea-game/triplea/commit/0b5dd59d7da6b5236e5bfbb5658d9e3963a24308", "message": "Remove unused @Log annotation", "committedDate": "2020-10-11T21:26:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MTQ4Nw==", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r502971487", "bodyText": "Should a log.error be added here as well?", "author": "trevan", "createdAt": "2020-10-11T22:02:13Z", "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -93,39 +94,28 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 version,\n                 UrlConstants.DOWNLOAD_WEBSITE,\n                 UrlConstants.DOWNLOAD_WEBSITE));\n+        return Optional.empty();\n       } else if (!HeadlessGameServer.headless()\n           && ((Version) version).isGreaterThan(ClientContext.engineVersion())) {\n-        // we can still load it because our engine is compatible, however this save was made by a\n-        // newer engine, so prompt the user to upgrade\n-        promptToLoadNewerSaveGame();\n+        // Prompt the user to upgrade\n+        log.warn(\n+            \"This save was made by a newer version of TripleA.<br>\"\n+                + \"To load this save, download the latest version of TripleA: \"\n+                + \"<a href=\\\"{}\\\">{}</a>\",\n+            UrlConstants.DOWNLOAD_WEBSITE,\n+            UrlConstants.DOWNLOAD_WEBSITE);\n+        return Optional.empty();\n+      } else {\n+        final GameData data = (GameData) input.readObject();\n+        data.postDeSerialize();\n+        loadDelegates(input, data);\n+        return Optional.of(data);\n       }\n-\n-      final GameData data = (GameData) input.readObject();\n-      data.postDeSerialize();\n-      loadDelegates(input, data);\n-      return data;\n     } catch (final ClassNotFoundException cnfe) {\n-      throw new IOException(cnfe.getMessage());\n-    }\n-  }\n-\n-  private static void promptToLoadNewerSaveGame() throws IOException {\n-    // this is needed because a newer client might depend on variables that are part of the new\n-    // save but will be stripped by the old client. When the old client re-saves the data, the\n-    // new client will load the save game and be in odd state.\n-    final String messageString =\n-        \"This save was made by a newer version of TripleA.\"\n-            + \"\\nPlaying newer saves with an older engine can lead to unpredictable problems. \"\n-            + \"It is recommended that you upgrade to the latest version of TripleA before playing \"\n-            + \"this save game. To download the latest version of TripleA, Please visit \"\n-            + UrlConstants.DOWNLOAD_WEBSITE\n-            + \".\\n\"\n-            + \"\\n\\nDo you wish to continue and open this save with your current 'old' version?;\";\n-    final int answer =\n-        JOptionPane.showConfirmDialog(\n-            null, messageString, \"Open Newer Save Game?\", JOptionPane.YES_NO_OPTION);\n-    if (answer != JOptionPane.YES_OPTION) {\n-      throw new IOException(\"Loading the save game was aborted\");\n+      log.error(\"Error loading game data\", cnfe);\n+      return Optional.empty();\n+    } catch (final IOException e) {\n+      return Optional.empty();", "originalCommit": "0b5dd59d7da6b5236e5bfbb5658d9e3963a24308", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3NzA0Ng==", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r502977046", "bodyText": "Yes, an error of omission on my part. That was something I had intended to come back to, updated in: c7ae2ca", "author": "DanVanAtta", "createdAt": "2020-10-11T22:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjk3MTQ4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c7ae2cac366a66c8721f3616145a6b74e5cb140b", "chunk": "diff --git a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\nindex 4520a3a7d..e9f69064f 100644\n--- a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n+++ b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n\n@@ -111,10 +111,8 @@ public final class GameDataManager {\n         loadDelegates(input, data);\n         return Optional.of(data);\n       }\n-    } catch (final ClassNotFoundException cnfe) {\n-      log.error(\"Error loading game data\", cnfe);\n-      return Optional.empty();\n-    } catch (final IOException e) {\n+    } catch (final ClassNotFoundException | IOException e) {\n+      log.error(\"Error loading game data\", e);\n       return Optional.empty();\n     }\n   }\n"}}, {"oid": "c7ae2cac366a66c8721f3616145a6b74e5cb140b", "url": "https://github.com/triplea-game/triplea/commit/c7ae2cac366a66c8721f3616145a6b74e5cb140b", "message": "Log IOException on game data load", "committedDate": "2020-10-11T22:53:40Z", "type": "commit"}, {"oid": "53e697119819508c407656bd17fc08cd9962a477", "url": "https://github.com/triplea-game/triplea/commit/53e697119819508c407656bd17fc08cd9962a477", "message": "Restore replacement of newlines with html line breaks", "committedDate": "2020-10-12T01:51:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNDIzNw==", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r503004237", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-10-12T02:09:32Z", "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -77,13 +77,14 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 ((games.strategy.util.Version) version).getExactVersion(),\n                 UrlConstants.OLD_DOWNLOADS_WEBSITE,\n                 UrlConstants.OLD_DOWNLOADS_WEBSITE));\n-\n+        return Optional.empty();", "originalCommit": "53e697119819508c407656bd17fc08cd9962a477", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "chunk": "diff --git a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\nindex e9f69064f..12bc4d5a7 100644\n--- a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n+++ b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n\n@@ -83,7 +83,7 @@ public final class GameDataManager {\n             \"Incompatible engine version with save game, \"\n                 + \"unable to determine version of the save game\");\n         return Optional.empty();\n-      } else if (!ClientContext.engineVersion().isCompatibleWithEngineVersion((Version) version)) {\n+      } else if (ClientContext.engineVersion().getMajor() != ((Version) version).getMajor()) {\n         log.warn(\n             String.format(\n                 \"Incompatible engine versions. We are: %s<br>\"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAwNDI0MA==", "url": "https://github.com/triplea-game/triplea/pull/7876#discussion_r503004240", "bodyText": "Avoid too many return statements within this method.", "author": "codeclimate", "createdAt": "2020-10-12T02:09:33Z", "path": "game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java", "diffHunk": "@@ -93,39 +94,26 @@ public static GameData loadGame(final InputStream is) throws IOException {\n                 version,\n                 UrlConstants.DOWNLOAD_WEBSITE,\n                 UrlConstants.DOWNLOAD_WEBSITE));\n+        return Optional.empty();\n       } else if (!HeadlessGameServer.headless()\n           && ((Version) version).isGreaterThan(ClientContext.engineVersion())) {\n-        // we can still load it because our engine is compatible, however this save was made by a\n-        // newer engine, so prompt the user to upgrade\n-        promptToLoadNewerSaveGame();\n+        // Prompt the user to upgrade\n+        log.warn(\n+            \"This save was made by a newer version of TripleA.<br>\"\n+                + \"To load this save, download the latest version of TripleA: \"\n+                + \"<a href=\\\"{}\\\">{}</a>\",\n+            UrlConstants.DOWNLOAD_WEBSITE,\n+            UrlConstants.DOWNLOAD_WEBSITE);\n+        return Optional.empty();\n+      } else {\n+        final GameData data = (GameData) input.readObject();\n+        data.postDeSerialize();\n+        loadDelegates(input, data);\n+        return Optional.of(data);\n       }\n-\n-      final GameData data = (GameData) input.readObject();\n-      data.postDeSerialize();\n-      loadDelegates(input, data);\n-      return data;\n-    } catch (final ClassNotFoundException cnfe) {\n-      throw new IOException(cnfe.getMessage());\n-    }\n-  }\n-\n-  private static void promptToLoadNewerSaveGame() throws IOException {\n-    // this is needed because a newer client might depend on variables that are part of the new\n-    // save but will be stripped by the old client. When the old client re-saves the data, the\n-    // new client will load the save game and be in odd state.\n-    final String messageString =\n-        \"This save was made by a newer version of TripleA.\"\n-            + \"\\nPlaying newer saves with an older engine can lead to unpredictable problems. \"\n-            + \"It is recommended that you upgrade to the latest version of TripleA before playing \"\n-            + \"this save game. To download the latest version of TripleA, Please visit \"\n-            + UrlConstants.DOWNLOAD_WEBSITE\n-            + \".\\n\"\n-            + \"\\n\\nDo you wish to continue and open this save with your current 'old' version?;\";\n-    final int answer =\n-        JOptionPane.showConfirmDialog(\n-            null, messageString, \"Open Newer Save Game?\", JOptionPane.YES_NO_OPTION);\n-    if (answer != JOptionPane.YES_OPTION) {\n-      throw new IOException(\"Loading the save game was aborted\");\n+    } catch (final ClassNotFoundException | IOException e) {\n+      log.error(\"Error loading game data\", e);\n+      return Optional.empty();", "originalCommit": "53e697119819508c407656bd17fc08cd9962a477", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "chunk": "diff --git a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\nindex e9f69064f..12bc4d5a7 100644\n--- a/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n+++ b/game-core/src/main/java/games/strategy/engine/framework/GameDataManager.java\n\n@@ -96,7 +96,7 @@ public final class GameDataManager {\n                 UrlConstants.DOWNLOAD_WEBSITE));\n         return Optional.empty();\n       } else if (!HeadlessGameServer.headless()\n-          && ((Version) version).isGreaterThan(ClientContext.engineVersion())) {\n+          && ((Version) version).getMinor() > ClientContext.engineVersion().getMinor()) {\n         // Prompt the user to upgrade\n         log.warn(\n             \"This save was made by a newer version of TripleA.<br>\"\n"}}, {"oid": "21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "url": "https://github.com/triplea-game/triplea/commit/21ab1cf0687bdb1bdf71562c87bbbb3eb1a26335", "message": "Update version matching to ignore point when comparing save game compatibility", "committedDate": "2020-10-12T23:57:00Z", "type": "commit"}]}