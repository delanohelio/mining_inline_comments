{"pr_number": 8307, "pr_title": "Inline special sbr/fly over dice roll method", "pr_createdAt": "2020-11-28T18:10:50Z", "pr_url": "https://github.com/triplea-game/triplea/pull/8307", "timeline": [{"oid": "4c5c540b94ed3de193e252e76ea249d93fdc717a", "url": "https://github.com/triplea-game/triplea/commit/4c5c540b94ed3de193e252e76ea249d93fdc717a", "message": "Remove special sbr/fly over dice roll method", "committedDate": "2020-11-28T18:06:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNDcxMg==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532124712", "bodyText": "nit, you can make the API nicer here by defaulting enemyUnits to an empty list, then you won't need to specify it in the builder.", "author": "DanVanAtta", "createdAt": "2020-11-29T00:45:33Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java", "diffHunk": "@@ -116,13 +116,20 @@ public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n               // get rid of units already killed, so we don't target them twice\n               validTargetedUnitsForThisRoll.removeAll(casualties);\n               if (!validTargetedUnitsForThisRoll.isEmpty()) {\n+                // Fly over AA currently doesn't take into account support\n                 dice.set(\n-                    DiceRoll.rollSbrOrFlyOverAa(\n+                    DiceRoll.rollAa(\n                         validTargetedUnitsForThisRoll,\n                         currentPossibleAa,\n                         AaInMoveUtil.this.bridge,\n                         territory,\n-                        BattleState.Side.DEFENSE));\n+                        CombatValueBuilder.aaCombatValue()\n+                            .enemyUnits(List.of())", "originalCommit": "4c5c540b94ed3de193e252e76ea249d93fdc717a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNjgxMA==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532126810", "bodyText": "I prefer that it is explicit.  Generally, the enemy list shouldn't be empty.  The only reason it is empty here is because support for AA guns during sbr or fly over isn't implemented (or maybe it isn't wanted).", "author": "trevan", "createdAt": "2020-11-29T01:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNDcxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzEyNg==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532127126", "bodyText": "Okay.\nside-note:  in that case take caution for a potential interface-segregation-principle violation here.", "author": "DanVanAtta", "createdAt": "2020-11-29T01:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNDcxMg=="}], "type": "inlineReview", "revised_code": {"commit": "8cba31dd8f78e7b4611ff6887a9ba805cc25797c", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java b/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\nindex 7837441bc..41d203922 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\n\n@@ -116,7 +116,8 @@ class AaInMoveUtil implements Serializable {\n               // get rid of units already killed, so we don't target them twice\n               validTargetedUnitsForThisRoll.removeAll(casualties);\n               if (!validTargetedUnitsForThisRoll.isEmpty()) {\n-                // Fly over AA currently doesn't take into account support\n+                // Fly over AA currently doesn't take into account support so don't pass in\n+                // the enemyUnits or friendlyUnits\n                 dice.set(\n                     DiceRoll.rollAa(\n                         validTargetedUnitsForThisRoll,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532127221", "bodyText": "Is this comment calling out a bug? A TODO item - Should the comment be on the method itself?  I'm not sure how knowing that rollAa does not take into support really helps to understand the method call. To another extent, it is confusing as the support rules are passed to the next method, which raises questions (are they used?)", "author": "DanVanAtta", "createdAt": "2020-11-29T01:19:30Z", "path": "game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java", "diffHunk": "@@ -116,13 +116,20 @@ public void execute(final ExecutionStack stack, final IDelegateBridge bridge) {\n               // get rid of units already killed, so we don't target them twice\n               validTargetedUnitsForThisRoll.removeAll(casualties);\n               if (!validTargetedUnitsForThisRoll.isEmpty()) {\n+                // Fly over AA currently doesn't take into account support", "originalCommit": "4c5c540b94ed3de193e252e76ea249d93fdc717a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyOTE3OA==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532129178", "bodyText": "It was in the original function so it got inlined here.  rollA does take into account support but you have to give it support knowledge.  This method doesn't pass in support knowledge to rollAa so it doesn't take into account support.  As for why fly-overs don't include support, I don't know.  I think it might be because it was just never done but there might have been a reason why it was excluded.  I can't find any evidence of why in the git history.", "author": "trevan", "createdAt": "2020-11-29T01:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEzMjI4OQ==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532132289", "bodyText": "I suspect because the fly-over shot is \"mis-implemented\" and should occur at the end of the move phase instead of immediate. For example, if you move units one by one, they'll get AA shots one-by-one when in actuality the rules treat movements as all happening concurrently at the end of the move phase. Hence, if you move a second unit along the same path, the two units shared path.\nNow, we can probably split hairs here as there are implications for capturing unoccuppied territories and the fly-over that is allowed because of that. I can't recall if that is technically a mis-implementation or a special case of the rules somehow, or if the interpretation of concurrent moves is otherwise flawed.\nIMO, we should remove this comment or move it somewhere else. A technical debt tracker somewhere else might make more sense. I'm concerned a bit about the value of the comment, it raises more questions than it does add clarity", "author": "DanVanAtta", "createdAt": "2020-11-29T02:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE1MDIwNQ==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532150205", "bodyText": "I think the comment fits here.  Someone looking at this code would wonder why the friendlyUnits and the enemyUnits are set to List.of().  This comment explains why.", "author": "trevan", "createdAt": "2020-11-29T03:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE1MjcyNA==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532152724", "bodyText": "I don't think I agree. If you have a lot of context to the implementation of the invoked method, then yes, but that is after the fact. The friendlyUnits and enemyUnits being empty is not seemingly directly related to supports. To determine that, you need to look at the implementation.", "author": "DanVanAtta", "createdAt": "2020-11-29T04:17:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjE1MzE1MA==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532153150", "bodyText": "Maybe I need to rename friendlyUnits and enemyUnits to make it obvious that they are directly related to supports.  But I don't want remove the comment.  It is helpful to me in understanding why the support is not being provided.", "author": "trevan", "createdAt": "2020-11-29T04:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI1ODg2MA==", "url": "https://github.com/triplea-game/triplea/pull/8307#discussion_r532258860", "bodyText": "Really getting into the details on this one. I'm sorry to be nitpicking over a comment, there are lots of similar comments in the code that don't really help or were made were excessive context, I think this is one of them as it did not make sense to me (and a reviewer I think is just someone simulating how the code reads when you have less context, perhaps because you yourself are updating this a few months from now).\nOkay with that apology out of the way, I think we can do one or two things:\n\nClarify the comment, perhaps just say in the comment \"The attacker and defender lists are empty because we are not yet calculating support for fly-over AA shots\"\nCreate a special CombatValueBuilder that makes the lack of support clear (and perhaps removes the empty list args and secondly maybe makes the comment redundant), eg: CombatValueBuilder.aaCombatValueWithoutSupports()\n\n(2) is maybe tricky to name right, but the general gist is to clarify the comment to add that missing context and/or update the code to bake that context into the method calls.", "author": "DanVanAtta", "createdAt": "2020-11-29T20:05:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEyNzIyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "8cba31dd8f78e7b4611ff6887a9ba805cc25797c", "chunk": "diff --git a/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java b/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\nindex 7837441bc..41d203922 100644\n--- a/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\n+++ b/game-core/src/main/java/games/strategy/triplea/delegate/AaInMoveUtil.java\n\n@@ -116,7 +116,8 @@ class AaInMoveUtil implements Serializable {\n               // get rid of units already killed, so we don't target them twice\n               validTargetedUnitsForThisRoll.removeAll(casualties);\n               if (!validTargetedUnitsForThisRoll.isEmpty()) {\n-                // Fly over AA currently doesn't take into account support\n+                // Fly over AA currently doesn't take into account support so don't pass in\n+                // the enemyUnits or friendlyUnits\n                 dice.set(\n                     DiceRoll.rollAa(\n                         validTargetedUnitsForThisRoll,\n"}}, {"oid": "8cba31dd8f78e7b4611ff6887a9ba805cc25797c", "url": "https://github.com/triplea-game/triplea/commit/8cba31dd8f78e7b4611ff6887a9ba805cc25797c", "message": "Update the comments to be more helpful", "committedDate": "2020-11-30T00:10:12Z", "type": "commit"}]}