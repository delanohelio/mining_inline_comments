{"pr_number": 6709, "pr_title": "[KEYCLOAK-12168] Various setup TOTP screen usability improvements", "pr_createdAt": "2020-01-30T18:03:21Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6709", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMTQ1OA==", "url": "https://github.com/keycloak/keycloak/pull/6709#discussion_r373411458", "bodyText": "Is it possible to keep the \"this.enabled = session.userCredentialManager().isConfiguredFor(realm, user, OTPCredentialModel.TYPE);\" ? Using of \"userCredentialManager\" instead of directly using OTPProvider is preferred way due the case when userStorage is used - some details in https://issues.redhat.com/browse/KEYCLOAK-12386", "author": "mposolda", "createdAt": "2020-01-31T10:28:25Z", "path": "services/src/main/java/org/keycloak/forms/login/freemarker/model/TotpBean.java", "diffHunk": "@@ -39,11 +44,17 @@\n     private final String totpSecretQrCode;\n     private final boolean enabled;\n     private UriBuilder uriBuilder;\n+    private final List<CredentialModel> otpCredentials;\n \n     public TotpBean(KeycloakSession session, RealmModel realm, UserModel user, UriBuilder uriBuilder) {\n         this.realm = realm;\n         this.uriBuilder = uriBuilder;\n-        this.enabled = session.userCredentialManager().isConfiguredFor(realm, user, OTPCredentialModel.TYPE);\n+        this.enabled = ((OTPCredentialProvider)session.getProvider(CredentialProvider.class, \"keycloak-otp\")).isConfiguredFor(realm, user);", "originalCommit": "dfcf3764cc0287743a552134aa982f6b091407d0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxOTU3MQ==", "url": "https://github.com/keycloak/keycloak/pull/6709#discussion_r373419571", "bodyText": "Sure, thanks for catching this! Will change to the previous form (tested the result of both variants previously, and it seemed to be identical (maybe just in my particular testing case?), so changed it to the form it has had in the initial MFA change, KEYCLOAK-11745 one on some related place). But will change it to the original form too.", "author": "iankko", "createdAt": "2020-01-31T10:47:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYxMDQzMQ==", "url": "https://github.com/keycloak/keycloak/pull/6709#discussion_r373610431", "bodyText": "@mposolda\nFixed in the 2nd commit (intentionally kept it separate, so the changes from the original version are better visible). Will squash them into one, once the change is OK.", "author": "iankko", "createdAt": "2020-01-31T18:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQxMTQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "5f5269b5087ce2ab9935b9e890cfba86991aad0b", "chunk": "diff --git a/services/src/main/java/org/keycloak/forms/login/freemarker/model/TotpBean.java b/services/src/main/java/org/keycloak/forms/login/freemarker/model/TotpBean.java\nindex f4438cafb6..82c8eabd1d 100755\n--- a/services/src/main/java/org/keycloak/forms/login/freemarker/model/TotpBean.java\n+++ b/services/src/main/java/org/keycloak/forms/login/freemarker/model/TotpBean.java\n\n@@ -49,7 +47,7 @@ public class TotpBean {\n     public TotpBean(KeycloakSession session, RealmModel realm, UserModel user, UriBuilder uriBuilder) {\n         this.realm = realm;\n         this.uriBuilder = uriBuilder;\n-        this.enabled = ((OTPCredentialProvider)session.getProvider(CredentialProvider.class, \"keycloak-otp\")).isConfiguredFor(realm, user);\n+        this.enabled = session.userCredentialManager().isConfiguredFor(realm, user, OTPCredentialModel.TYPE);\n         if (enabled) {\n             otpCredentials = session.userCredentialManager().getStoredCredentialsByType(realm, user, OTPCredentialModel.TYPE);\n         } else {\n"}}, {"oid": "5f5269b5087ce2ab9935b9e890cfba86991aad0b", "url": "https://github.com/keycloak/keycloak/commit/5f5269b5087ce2ab9935b9e890cfba86991aad0b", "message": "[KEYCLOAK-12168] Address issues pointed out by mposolda's review. Thanks, Marek!\n\nSigned-off-by: Jan Lieskovsky <jlieskov@redhat.com>", "committedDate": "2020-01-31T17:28:38Z", "type": "forcePushed"}, {"oid": "ba594b81508e708f3ab9271bcdbd07013bc38a56", "url": "https://github.com/keycloak/keycloak/commit/ba594b81508e708f3ab9271bcdbd07013bc38a56", "message": "[KEYCLOAK-12168] Various setup TOTP screen usability improvements\n\nOn both the TOTP account and TOTP login screens perform the following:\n* Make the \"Device name\" label optional if user registers the first\n  TOTP credential. Make it mandatory otherwise,\n* Denote the \"Authenticator code\" with asterisk, so it's clear it's\n  required field (always),\n* Add sentence to Step 3 of configuring TOTP credential explaining\n  the user to provide device name label,\n\nAlso perform other CSS & locale / messages file changes, so the UX is\nidentical when creating OTP credentials on both of these pages\n\nAdd a corresponding testcase\n\nAlso address issues pointed out by mposolda's review. Thanks, Marek!\n\nSigned-off-by: Jan Lieskovsky <jlieskov@redhat.com>", "committedDate": "2020-01-31T19:17:25Z", "type": "forcePushed"}, {"oid": "f4047af8ff3e8c3c6bbac789423f30c5fc88fc80", "url": "https://github.com/keycloak/keycloak/commit/f4047af8ff3e8c3c6bbac789423f30c5fc88fc80", "message": "[KEYCLOAK-12168] Various setup TOTP screen usability improvements\n\nOn both the TOTP account and TOTP login screens perform the following:\n* Make the \"Device name\" label optional if user registers the first\n  TOTP credential. Make it mandatory otherwise,\n* Denote the \"Authenticator code\" with asterisk, so it's clear it's\n  required field (always),\n* Add sentence to Step 3 of configuring TOTP credential explaining\n  the user to provide device name label,\n\nAlso perform other CSS & locale / messages file changes, so the UX is\nidentical when creating OTP credentials on both of these pages\n\nAdd a corresponding testcase\n\nAlso address issues pointed out by mposolda's review. Thanks, Marek!\n\nSigned-off-by: Jan Lieskovsky <jlieskov@redhat.com>", "committedDate": "2020-02-03T14:29:08Z", "type": "commit"}, {"oid": "f4047af8ff3e8c3c6bbac789423f30c5fc88fc80", "url": "https://github.com/keycloak/keycloak/commit/f4047af8ff3e8c3c6bbac789423f30c5fc88fc80", "message": "[KEYCLOAK-12168] Various setup TOTP screen usability improvements\n\nOn both the TOTP account and TOTP login screens perform the following:\n* Make the \"Device name\" label optional if user registers the first\n  TOTP credential. Make it mandatory otherwise,\n* Denote the \"Authenticator code\" with asterisk, so it's clear it's\n  required field (always),\n* Add sentence to Step 3 of configuring TOTP credential explaining\n  the user to provide device name label,\n\nAlso perform other CSS & locale / messages file changes, so the UX is\nidentical when creating OTP credentials on both of these pages\n\nAdd a corresponding testcase\n\nAlso address issues pointed out by mposolda's review. Thanks, Marek!\n\nSigned-off-by: Jan Lieskovsky <jlieskov@redhat.com>", "committedDate": "2020-02-03T14:29:08Z", "type": "forcePushed"}]}