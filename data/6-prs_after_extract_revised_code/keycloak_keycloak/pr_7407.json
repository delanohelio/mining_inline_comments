{"pr_number": 7407, "pr_title": "KEYCLOAK-14952 - Unit test failure in keycloak-saml-core on Java 11", "pr_createdAt": "2020-09-10T14:26:12Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7407", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMTU5OA==", "url": "https://github.com/keycloak/keycloak/pull/7407#discussion_r486831598", "bodyText": "I'd rather suggest keeping TransformerUtil as is and including the xml declaration if necessary due to encoding difference. This is few bytes difference yet that can be helpful in redirect binding.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                transformer.setOutputProperty(OutputKeys.ENCODING, xmlEncoding);\n          \n          \n            \n                                transformer.setOutputProperty(OutputKeys.ENCODING, xmlEncoding);\n          \n          \n            \n                                transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, \"no\");", "author": "hmlnarik", "createdAt": "2020-09-11T07:38:54Z", "path": "saml-core/src/main/java/org/keycloak/saml/common/util/DocumentUtil.java", "diffHunk": "@@ -304,6 +305,16 @@ public static InputStream getSourceAsStream(Source source) throws ConfigurationE\n         Result streamResult = new StreamResult(baos);\n         // Write the DOM document to the stream\n         Transformer transformer = TransformerUtil.getTransformer();\n+\n+        if (DOMSource.class.isInstance(source)) {\n+            Node node = ((DOMSource) source).getNode();\n+            if (Document.class.isInstance(node)) {\n+                String xmlEncoding = ((Document) node).getXmlEncoding();\n+                if (xmlEncoding != null)\n+                    transformer.setOutputProperty(OutputKeys.ENCODING, xmlEncoding);", "originalCommit": "fcd08483e7d9ff1394c0857242a19f3c2d1831e1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA0MTA2Mg==", "url": "https://github.com/keycloak/keycloak/pull/7407#discussion_r487041062", "bodyText": "done", "author": "dteleguin", "createdAt": "2020-09-11T13:22:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzMTU5OA=="}], "type": "inlineReview", "revised_code": {"commit": "9e825c615a16c466b4df16ba8467efd806776c31", "chunk": "diff --git a/saml-core/src/main/java/org/keycloak/saml/common/util/DocumentUtil.java b/saml-core/src/main/java/org/keycloak/saml/common/util/DocumentUtil.java\nindex 54fc509aa0..6b4cc5fee7 100755\n--- a/saml-core/src/main/java/org/keycloak/saml/common/util/DocumentUtil.java\n+++ b/saml-core/src/main/java/org/keycloak/saml/common/util/DocumentUtil.java\n\n@@ -310,8 +310,10 @@ public class DocumentUtil {\n             Node node = ((DOMSource) source).getNode();\n             if (Document.class.isInstance(node)) {\n                 String xmlEncoding = ((Document) node).getXmlEncoding();\n-                if (xmlEncoding != null)\n+                if (xmlEncoding != null) {\n                     transformer.setOutputProperty(OutputKeys.ENCODING, xmlEncoding);\n+                    transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, \"no\");\n+                }\n             }\n         }\n \n"}}, {"oid": "9e825c615a16c466b4df16ba8467efd806776c31", "url": "https://github.com/keycloak/keycloak/commit/9e825c615a16c466b4df16ba8467efd806776c31", "message": "KEYCLOAK-14952 - Unit test failure in keycloak-saml-core on Java 11", "committedDate": "2020-09-11T13:20:22Z", "type": "commit"}, {"oid": "9e825c615a16c466b4df16ba8467efd806776c31", "url": "https://github.com/keycloak/keycloak/commit/9e825c615a16c466b4df16ba8467efd806776c31", "message": "KEYCLOAK-14952 - Unit test failure in keycloak-saml-core on Java 11", "committedDate": "2020-09-11T13:20:22Z", "type": "forcePushed"}]}