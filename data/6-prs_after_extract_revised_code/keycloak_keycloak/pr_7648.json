{"pr_number": 7648, "pr_title": "KEYCLOAK-15264 Import realm IGNORE_EXISTING causes NPE", "pr_createdAt": "2020-11-30T10:25:35Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7648", "timeline": [{"oid": "ebcd3152858961f5ee6f3206704b52c7eb3536da", "url": "https://github.com/keycloak/keycloak/commit/ebcd3152858961f5ee6f3206704b52c7eb3536da", "message": "KEYCLOAK-15264 Import realm using directory provider twice with IGNORE_EXISTING will cause NPE for clientId", "committedDate": "2020-11-30T11:36:00Z", "type": "forcePushed"}, {"oid": "ef97ad3d85008652ebd950e5766971904ae7531b", "url": "https://github.com/keycloak/keycloak/commit/ef97ad3d85008652ebd950e5766971904ae7531b", "message": "KEYCLOAK-15264 Import realm using directory provider twice with IGNORE_EXISTING will cause NPE for clientId", "committedDate": "2020-12-07T20:22:08Z", "type": "forcePushed"}, {"oid": "ea53e5fee3e03691ffc8912ce52cf4d95ee42d7b", "url": "https://github.com/keycloak/keycloak/commit/ea53e5fee3e03691ffc8912ce52cf4d95ee42d7b", "message": "KEYCLOAK-15264 Import realm using directory provider twice with IGNORE_EXISTING will cause NPE for clientId", "committedDate": "2020-12-07T20:23:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA4NjAwOQ==", "url": "https://github.com/keycloak/keycloak/pull/7648#discussion_r538086009", "bodyText": "Prefer orElseGet, otherwise the lookup by getClientByClientId is always performed, even when client can be found by id.", "author": "hmlnarik", "createdAt": "2020-12-08T07:07:26Z", "path": "services/src/main/java/org/keycloak/services/managers/RealmManager.java", "diffHunk": "@@ -719,7 +720,15 @@ public void setupClientServiceAccountsAndAuthorizationOnImport(RealmRepresentati\n             ClientManager clientManager = new ClientManager(this);\n \n             for (ClientRepresentation client : clients) {\n-                ClientModel clientModel = this.getRealmByName(rep.getRealm()).getClientById(client.getId());\n+                RealmModel realmModel = this.getRealmByName(rep.getRealm());\n+\n+                ClientModel clientModel = Optional.ofNullable(client.getId())\n+                        .map(realmModel::getClientById)\n+                        .orElse(realmModel.getClientByClientId(client.getClientId()));", "originalCommit": "ea53e5fee3e03691ffc8912ce52cf4d95ee42d7b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA4NzI1OQ==", "url": "https://github.com/keycloak/keycloak/pull/7648#discussion_r538087259", "bodyText": "@hmlnarik You're right. Thanks!", "author": "mabartos", "createdAt": "2020-12-08T07:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA4NjAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d7e80acead53f71396b9585bf295da930979c989", "chunk": "diff --git a/services/src/main/java/org/keycloak/services/managers/RealmManager.java b/services/src/main/java/org/keycloak/services/managers/RealmManager.java\nindex 90e35707cd..781d84db41 100755\n--- a/services/src/main/java/org/keycloak/services/managers/RealmManager.java\n+++ b/services/src/main/java/org/keycloak/services/managers/RealmManager.java\n\n@@ -724,7 +724,7 @@ public class RealmManager {\n \n                 ClientModel clientModel = Optional.ofNullable(client.getId())\n                         .map(realmModel::getClientById)\n-                        .orElse(realmModel.getClientByClientId(client.getClientId()));\n+                        .orElseGet(() -> realmModel.getClientByClientId(client.getClientId()));\n                 \n                 if (clientModel == null) {\n                     throw new RuntimeException(\"Cannot find provided client by dir import.\");\n"}}, {"oid": "d7e80acead53f71396b9585bf295da930979c989", "url": "https://github.com/keycloak/keycloak/commit/d7e80acead53f71396b9585bf295da930979c989", "message": "KEYCLOAK-15264 Import realm using directory provider twice with IGNORE_EXISTING will cause NPE for clientId", "committedDate": "2020-12-08T07:23:22Z", "type": "commit"}, {"oid": "d7e80acead53f71396b9585bf295da930979c989", "url": "https://github.com/keycloak/keycloak/commit/d7e80acead53f71396b9585bf295da930979c989", "message": "KEYCLOAK-15264 Import realm using directory provider twice with IGNORE_EXISTING will cause NPE for clientId", "committedDate": "2020-12-08T07:23:22Z", "type": "forcePushed"}]}