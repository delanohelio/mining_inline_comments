{"pr_number": 7643, "pr_title": "KEYCLOAK-15015 Extend KeyWrapper to add whole certificate chain in x5c parameter", "pr_createdAt": "2020-11-26T11:22:10Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7643", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzE4MjYxMA==", "url": "https://github.com/keycloak/keycloak/pull/7643#discussion_r573182610", "bodyText": "This should be better orElseGet(Collections::emptyList).", "author": "pedroigor", "createdAt": "2021-02-09T19:38:05Z", "path": "services/src/main/java/org/keycloak/keys/JavaKeystoreKeyProvider.java", "diffHunk": "@@ -62,7 +59,12 @@ protected KeyWrapper loadKey(RealmModel realm, ComponentModel model) {\n                 certificate = CertificateUtils.generateV1SelfSignedCertificate(keyPair, realm.getName());\n             }\n \n-            return createKeyWrapper(keyPair, certificate);\n+            final List<X509Certificate> certificateChain = Optional.ofNullable(keyStore.getCertificateChain(model.get(JavaKeystoreKeyProviderFactory.KEY_ALIAS_KEY)))\n+                    .map(certificates -> (X509Certificate[]) certificates)\n+                    .map(Arrays::asList)\n+                    .orElseGet(ArrayList::new);", "originalCommit": "e951172f656cb0d926e1a32a67f59fc19271c30d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ea19c1980a3882c1cb5d709f62c44eabb8cd5fb", "chunk": "diff --git a/services/src/main/java/org/keycloak/keys/JavaKeystoreKeyProvider.java b/services/src/main/java/org/keycloak/keys/JavaKeystoreKeyProvider.java\nindex 9a32cc9cdf..6c81e285fd 100644\n--- a/services/src/main/java/org/keycloak/keys/JavaKeystoreKeyProvider.java\n+++ b/services/src/main/java/org/keycloak/keys/JavaKeystoreKeyProvider.java\n\n@@ -60,9 +57,9 @@ public class JavaKeystoreKeyProvider extends AbstractRsaKeyProvider {\n             }\n \n             final List<X509Certificate> certificateChain = Optional.ofNullable(keyStore.getCertificateChain(model.get(JavaKeystoreKeyProviderFactory.KEY_ALIAS_KEY)))\n-                    .map(certificates -> (X509Certificate[]) certificates)\n+                    .map(X509Certificate[].class::cast)\n                     .map(Arrays::asList)\n-                    .orElseGet(ArrayList::new);\n+                    .orElseGet(Collections::emptyList);\n \n             return createKeyWrapper(keyPair, certificate, certificateChain);\n         } catch (KeyStoreException kse) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzE4ODY2NQ==", "url": "https://github.com/keycloak/keycloak/pull/7643#discussion_r573188665", "bodyText": "Use Collections.emptyList().", "author": "pedroigor", "createdAt": "2021-02-09T19:47:41Z", "path": "services/src/main/java/org/keycloak/keys/AbstractRsaKeyProvider.java", "diffHunk": "@@ -66,6 +62,10 @@ public AbstractRsaKeyProvider(RealmModel realm, ComponentModel model) {\n     }\n \n     protected KeyWrapper createKeyWrapper(KeyPair keyPair, X509Certificate certificate) {\n+        return createKeyWrapper(keyPair, certificate, new ArrayList<>());", "originalCommit": "e951172f656cb0d926e1a32a67f59fc19271c30d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3ea19c1980a3882c1cb5d709f62c44eabb8cd5fb", "chunk": "diff --git a/services/src/main/java/org/keycloak/keys/AbstractRsaKeyProvider.java b/services/src/main/java/org/keycloak/keys/AbstractRsaKeyProvider.java\nindex a17d05e33b..c26fbe546a 100644\n--- a/services/src/main/java/org/keycloak/keys/AbstractRsaKeyProvider.java\n+++ b/services/src/main/java/org/keycloak/keys/AbstractRsaKeyProvider.java\n\n@@ -62,7 +62,7 @@ public abstract class AbstractRsaKeyProvider implements KeyProvider {\n     }\n \n     protected KeyWrapper createKeyWrapper(KeyPair keyPair, X509Certificate certificate) {\n-        return createKeyWrapper(keyPair, certificate, new ArrayList<>());\n+        return createKeyWrapper(keyPair, certificate, Collections.emptyList());\n     }\n \n     protected KeyWrapper createKeyWrapper(KeyPair keyPair, X509Certificate certificate, List<X509Certificate> certificateChain) {\n"}}, {"oid": "e951172f656cb0d926e1a32a67f59fc19271c30d", "url": "https://github.com/keycloak/keycloak/commit/e951172f656cb0d926e1a32a67f59fc19271c30d", "message": "KEYCLOAK-15015 Implement certificate chain loading", "committedDate": "2021-02-04T12:27:18Z", "type": "forcePushed"}, {"oid": "3ea19c1980a3882c1cb5d709f62c44eabb8cd5fb", "url": "https://github.com/keycloak/keycloak/commit/3ea19c1980a3882c1cb5d709f62c44eabb8cd5fb", "message": "KEYCLOAK-15015 Extend column to enable storing 5 pem encoded certificates for certificate chain", "committedDate": "2021-03-01T16:18:31Z", "type": "forcePushed"}, {"oid": "6a7b9983032fa73fc4d03bfb0ea688913cab8bee", "url": "https://github.com/keycloak/keycloak/commit/6a7b9983032fa73fc4d03bfb0ea688913cab8bee", "message": "KEYCLOAK-15015 Extend KeyWrapper to add whole certificate chain in x5c parameter and validate certificate chain against truststore.", "committedDate": "2021-03-17T14:10:43Z", "type": "forcePushed"}, {"oid": "0898e08436f10e6241e5688396aefa826525ca2a", "url": "https://github.com/keycloak/keycloak/commit/0898e08436f10e6241e5688396aefa826525ca2a", "message": "KEYCLOAK-15015 Extend KeyWrapper to add whole certificate chain in x5c parameter and validate certificate chain against truststore.", "committedDate": "2021-03-22T11:25:51Z", "type": "forcePushed"}, {"oid": "6a7b9983032fa73fc4d03bfb0ea688913cab8bee", "url": "https://github.com/keycloak/keycloak/commit/6a7b9983032fa73fc4d03bfb0ea688913cab8bee", "message": "KEYCLOAK-15015 Extend KeyWrapper to add whole certificate chain in x5c parameter and validate certificate chain against truststore.", "committedDate": "2021-03-17T14:10:43Z", "type": "forcePushed"}, {"oid": "d7741b5c7692ccca1756a663c743bcc7168eccf9", "url": "https://github.com/keycloak/keycloak/commit/d7741b5c7692ccca1756a663c743bcc7168eccf9", "message": "[KEYCLOAK-15015] - Publishing the x5c for JWK", "committedDate": "2021-03-22T15:06:31Z", "type": "forcePushed"}, {"oid": "555509fb1248f741f2c708024c97f47cbe0f4183", "url": "https://github.com/keycloak/keycloak/commit/555509fb1248f741f2c708024c97f47cbe0f4183", "message": "KEYCLOAK-15015 Extend KeyWrapper to add whole certificate chain in x5c parameter and validate certificate chain against truststore.", "committedDate": "2021-03-22T15:24:54Z", "type": "commit"}, {"oid": "d41178c89c8aac3592ba9cbabbf090a6cdc533e1", "url": "https://github.com/keycloak/keycloak/commit/d41178c89c8aac3592ba9cbabbf090a6cdc533e1", "message": "[KEYCLOAK-15015] - Publishing the x5c for JWK", "committedDate": "2021-03-22T15:25:23Z", "type": "commit"}, {"oid": "d41178c89c8aac3592ba9cbabbf090a6cdc533e1", "url": "https://github.com/keycloak/keycloak/commit/d41178c89c8aac3592ba9cbabbf090a6cdc533e1", "message": "[KEYCLOAK-15015] - Publishing the x5c for JWK", "committedDate": "2021-03-22T15:25:23Z", "type": "forcePushed"}]}