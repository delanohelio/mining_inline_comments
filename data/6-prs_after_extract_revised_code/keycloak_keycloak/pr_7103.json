{"pr_number": 7103, "pr_title": "KEYCLOAK-12729 Add password policy not-email", "pr_createdAt": "2020-05-23T23:44:06Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7103", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcyODAxNw==", "url": "https://github.com/keycloak/keycloak/pull/7103#discussion_r442728017", "bodyText": "@thomasdarimont As you pointed, you are missing cleanup of those things after the test method.", "author": "mposolda", "createdAt": "2020-06-19T09:19:02Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/RegisterTest.java", "diffHunk": "@@ -491,6 +491,28 @@ public void registerUserNotUsernamePasswordPolicy() {\n         assertEquals(\"Please specify username.\", registerPage.getError());\n     }\n \n+    // KEYCLOAK-12729\n+    @Test\n+    public void registerUserNotEmailPasswordPolicy() {\n+\n+        RealmRepresentation notEmailRealm = RealmBuilder.create().passwordPolicy(\"notEmail\").build();\n+        notEmailRealm.setRegistrationEmailAsUsername(true);", "originalCommit": "43e98ebf09d96146111396f9693870e401b6b686", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3MDgyNA==", "url": "https://github.com/keycloak/keycloak/pull/7103#discussion_r474570824", "bodyText": "Added the missing cleanup", "author": "thomasdarimont", "createdAt": "2020-08-21T09:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcyODAxNw=="}], "type": "inlineReview", "revised_code": {"commit": "90e0afcbb84c99dce0973fe32a31c3091717d105", "chunk": "diff --git a/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/RegisterTest.java b/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/RegisterTest.java\nindex 2793c93437..4925f9f660 100644\n--- a/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/RegisterTest.java\n+++ b/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/forms/RegisterTest.java\n\n@@ -497,20 +497,23 @@ public class RegisterTest extends AbstractTestRealmKeycloakTest {\n \n         RealmRepresentation notEmailRealm = RealmBuilder.create().passwordPolicy(\"notEmail\").build();\n         notEmailRealm.setRegistrationEmailAsUsername(true);\n+        try {\n+            adminClient.realm(\"test\").update(notEmailRealm);\n \n-        adminClient.realm(\"test\").update(notEmailRealm);\n+            loginPage.open();\n \n-        loginPage.open();\n+            assertTrue(loginPage.isCurrent());\n \n-        assertTrue(loginPage.isCurrent());\n-\n-        loginPage.clickRegister();\n-        registerPage.assertCurrent();\n+            loginPage.clickRegister();\n+            registerPage.assertCurrent();\n \n-        registerPage.registerWithEmailAsUsername(\"firstName\", \"lastName\", \"registerUserNotEmail@email\", \"registerUserNotEmail@email\", \"registerUserNotEmail@email\");\n+            registerPage.registerWithEmailAsUsername(\"firstName\", \"lastName\", \"registerUserNotEmail@email\", \"registerUserNotEmail@email\", \"registerUserNotEmail@email\");\n \n-        assertTrue(registerPage.isCurrent());\n-        assertEquals(\"Invalid password: must not be equal to the email.\", registerPage.getError());\n+            assertTrue(registerPage.isCurrent());\n+            assertEquals(\"Invalid password: must not be equal to the email.\", registerPage.getError());\n+        } finally {\n+            configureRealmRegistrationEmailAsUsername(false);\n+        }\n     }\n \n     protected UserRepresentation getUser(String userId) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcyODIyNg==", "url": "https://github.com/keycloak/keycloak/pull/7103#discussion_r442728226", "bodyText": "I guess this probably worth cleanup as well.", "author": "mposolda", "createdAt": "2020-06-19T09:19:31Z", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java", "diffHunk": "@@ -412,6 +413,23 @@ public void changePasswordWithNotUsernamePolicy() {\n         events.expectAccount(EventType.UPDATE_PASSWORD).assertEvent();\n     }\n \n+    @Test\n+    public void changePasswordWithNotEmailPolicy() {\n+        setPasswordPolicy(\"notEmail(1)\");", "originalCommit": "43e98ebf09d96146111396f9693870e401b6b686", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3MDY1Ng==", "url": "https://github.com/keycloak/keycloak/pull/7103#discussion_r474570656", "bodyText": "Another test changed the email to something else... I now reset the email of the user in before to ensure, that we always start from the same state.", "author": "thomasdarimont", "createdAt": "2020-08-21T09:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcyODIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "90e0afcbb84c99dce0973fe32a31c3091717d105", "chunk": "diff --git a/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java b/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java\nold mode 100755\nnew mode 100644\nindex 476554bdf7..935970abb6\n--- a/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java\n+++ b/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/account/AccountFormServiceTest.java\n\n@@ -413,6 +419,7 @@ public class AccountFormServiceTest extends AbstractTestRealmKeycloakTest {\n         events.expectAccount(EventType.UPDATE_PASSWORD).assertEvent();\n     }\n \n+    // KEYCLOAK-12729\n     @Test\n     public void changePasswordWithNotEmailPolicy() {\n         setPasswordPolicy(\"notEmail(1)\");\n"}}, {"oid": "7e54d71632e9bf1b9d2bb822017cf72abce6a4cc", "url": "https://github.com/keycloak/keycloak/commit/7e54d71632e9bf1b9d2bb822017cf72abce6a4cc", "message": "KEYCLOAK-12729 Add password policy not-email\n\nAdded test cases and initial translations", "committedDate": "2020-08-21T08:40:40Z", "type": "commit"}, {"oid": "90e0afcbb84c99dce0973fe32a31c3091717d105", "url": "https://github.com/keycloak/keycloak/commit/90e0afcbb84c99dce0973fe32a31c3091717d105", "message": "KEYCLOAK-12729 Revise password policy not-email tests\n\n- Added missing cleanup to RegisterTest\n- Revised test-setup for AccountFormServiceTest", "committedDate": "2020-08-21T09:16:28Z", "type": "forcePushed"}, {"oid": "7bd379f3e3cf49ee9c6a7f48ee8ef57e5ec2f9cf", "url": "https://github.com/keycloak/keycloak/commit/7bd379f3e3cf49ee9c6a7f48ee8ef57e5ec2f9cf", "message": "KEYCLOAK-12729 Revise password policy not-email tests\n\n- Added missing cleanup to RegisterTest\n- Revised test-setup for AccountFormServiceTest", "committedDate": "2020-08-21T09:22:51Z", "type": "commit"}, {"oid": "7bd379f3e3cf49ee9c6a7f48ee8ef57e5ec2f9cf", "url": "https://github.com/keycloak/keycloak/commit/7bd379f3e3cf49ee9c6a7f48ee8ef57e5ec2f9cf", "message": "KEYCLOAK-12729 Revise password policy not-email tests\n\n- Added missing cleanup to RegisterTest\n- Revised test-setup for AccountFormServiceTest", "committedDate": "2020-08-21T09:22:51Z", "type": "forcePushed"}]}