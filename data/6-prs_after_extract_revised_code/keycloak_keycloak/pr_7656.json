{"pr_number": 7656, "pr_title": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "pr_createdAt": "2020-12-02T17:18:34Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7656", "timeline": [{"oid": "24f6d5f1d63c4508f1666d380c1c48034bd09c38", "url": "https://github.com/keycloak/keycloak/commit/24f6d5f1d63c4508f1666d380c1c48034bd09c38", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2020-12-02T18:22:36Z", "type": "forcePushed"}, {"oid": "88b7ee8d0069abcd14d106574835977040c7c6fd", "url": "https://github.com/keycloak/keycloak/commit/88b7ee8d0069abcd14d106574835977040c7c6fd", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2020-12-03T15:07:32Z", "type": "forcePushed"}, {"oid": "7db39fadc928a34bbc058a7fd98ff9325c045c6e", "url": "https://github.com/keycloak/keycloak/commit/7db39fadc928a34bbc058a7fd98ff9325c045c6e", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2020-12-03T16:24:08Z", "type": "forcePushed"}, {"oid": "b8a76e38455437b1dc10ef90f8ec00e2254ddaad", "url": "https://github.com/keycloak/keycloak/commit/b8a76e38455437b1dc10ef90f8ec00e2254ddaad", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-01-13T14:22:47Z", "type": "forcePushed"}, {"oid": "98d9b60fa7f072a09dc7cf2ddab97bba41cdf0d4", "url": "https://github.com/keycloak/keycloak/commit/98d9b60fa7f072a09dc7cf2ddab97bba41cdf0d4", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-06-23T07:12:35Z", "type": "forcePushed"}, {"oid": "ecfc0b9cb61a93979979a65a6ec3c0143de29d15", "url": "https://github.com/keycloak/keycloak/commit/ecfc0b9cb61a93979979a65a6ec3c0143de29d15", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-09-13T14:02:02Z", "type": "forcePushed"}, {"id": "PRRC_kwDOAKnDVc4qSoyt", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r709528749", "bodyText": "Perhaps we should mention here the possibility to provide a comma-separated list of OIDs?", "author": "pedroigor", "createdAt": "2021-09-15T19:56:15Z", "path": "services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java", "diffHunk": "@@ -201,6 +206,22 @@\n         extendedKeyUsage.setLabel(\"Validate Extended Key Usage\");\n         extendedKeyUsage.setHelpText(\"Validates the extended purposes of the certificate's key using certificate's Extended Key Usage extension. Leaving the field blank will disable Extended Key Usage validation. See RFC 5280 for a detailed definition of X509 Extended Key Usage extension.\");\n \n+        ProviderConfigProperty certificatePolicy = new ProviderConfigProperty();\n+        certificatePolicy.setType(STRING_TYPE);\n+        certificatePolicy.setName(CERTIFICATE_POLICY);\n+        certificatePolicy.setLabel(\"Validate Certificate Policy\");\n+        certificatePolicy.setHelpText(\"Validates the certificate policies of the certificate's key using certificate's Policy extension. Leaving the field blank will disable Certificate Policies validation. See RFC 5280 for a detailed definition of X509 Certificate Policy extension.\");", "originalCommit": "ecfc0b9cb61a93979979a65a6ec3c0143de29d15", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOAKnDVc4qS6cE", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r709601028", "bodyText": "Sure! I will add \"Multiple policies should be separated using a comma.\", just like in the documentation PR.", "author": "lscorcia", "createdAt": "2021-09-15T21:52:07Z", "replyToReviewId": "PRRC_kwDOAKnDVc4qSoyt"}], "type": "inlineReview", "revised_code": {"commit": "3477bc47573c6702c3ef3436834a936da75a461c", "chunk": "diff --git a/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java b/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\nindex 7285459f0b..6173eacf48 100644\n--- a/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\n+++ b/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\n\n@@ -210,16 +210,16 @@ public abstract class AbstractX509ClientCertificateAuthenticatorFactory implemen\n         certificatePolicy.setType(STRING_TYPE);\n         certificatePolicy.setName(CERTIFICATE_POLICY);\n         certificatePolicy.setLabel(\"Validate Certificate Policy\");\n-        certificatePolicy.setHelpText(\"Validates the certificate policies of the certificate's key using certificate's Policy extension. Leaving the field blank will disable Certificate Policies validation. See RFC 5280 for a detailed definition of X509 Certificate Policy extension.\");\n+        certificatePolicy.setHelpText(\"Validates the certificate policies of the certificate's key using certificate's Policy extension. Leaving the field blank will disable Certificate Policies validation. Multiple policies should be separated using a comma. See RFC 5280 for a detailed definition of X509 Certificate Policy extension.\");\n \n         List<String> certificatePolicyModesOptions = new LinkedList<>();\n-        Collections.addAll(certificatePolicyModesOptions, certificatePolicyModes);\n+        Collections.addAll(certificatePolicyModesOptions, CERTIFICATE_POLICY_MODE);\n         ProviderConfigProperty certificatePolicyMode = new ProviderConfigProperty();\n         certificatePolicyMode.setType(ProviderConfigProperty.LIST_TYPE);\n         certificatePolicyMode.setName(CERTIFICATE_POLICY_MODE);\n         certificatePolicyMode.setLabel(\"Certificate Policy Validation Mode\");\n         certificatePolicyMode.setHelpText(\"If Certificate Policy validation is specified, indicates whether it should match all or at least one of the specified policies.\");\n-        certificatePolicyMode.setDefaultValue(certificatePolicyModes[0]);\n+        certificatePolicyMode.setDefaultValue(CERTIFICATE_POLICY_MODES[0]);\n         certificatePolicyMode.setOptions(certificatePolicyModesOptions);\n \n         ProviderConfigProperty identityConfirmationPageDisallowed = new ProviderConfigProperty();\n"}}, {"id": "PRRC_kwDOAKnDVc4qSo2w", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r709529008", "bodyText": "Could you please use upper-case in constant names as you did for others?", "author": "pedroigor", "createdAt": "2021-09-15T19:56:41Z", "path": "services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java", "diffHunk": "@@ -87,6 +87,11 @@\n             USERNAME_EMAIL_MAPPER\n     };\n \n+    private static final String[] certificatePolicyModes = {", "originalCommit": "ecfc0b9cb61a93979979a65a6ec3c0143de29d15", "replyToReviewId": null, "replies": [{"id": "PRRC_kwDOAKnDVc4qS66c", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r709602972", "bodyText": "I'm sorry, I don't understand your suggestion: the constant names are already uppercase (CERTIFICATE_POLICY_MODE_ALL, CERTIFICATE_POLICY_MODE_ANY). Are you talking about the constant values ('Any', 'All')? If that's the case then, sure, no problem!", "author": "lscorcia", "createdAt": "2021-09-15T21:55:59Z", "replyToReviewId": "PRRC_kwDOAKnDVc4qSo2w"}, {"id": "PRRC_kwDOAKnDVc4qb4Hw", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r711950832", "bodyText": "I think Pedro meant to use the uppercase for the constant name itself? Probably something like:\nprivate static final String[] CERTIFICATE_POLICY_MODES = {", "author": "mposolda", "createdAt": "2021-09-20T08:02:33Z", "replyToReviewId": "PRRC_kwDOAKnDVc4qSo2w"}, {"id": "PRRC_kwDOAKnDVc4qcYnn", "url": "https://github.com/keycloak/keycloak/pull/7656#discussion_r712083943", "bodyText": "Oh, sure! I didn't think about it because it was consistent with constant definitions at the lines above, but I will change it. Thanks!", "author": "lscorcia", "createdAt": "2021-09-20T11:32:41Z", "replyToReviewId": "PRRC_kwDOAKnDVc4qSo2w"}], "type": "inlineReview", "revised_code": {"commit": "3477bc47573c6702c3ef3436834a936da75a461c", "chunk": "diff --git a/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java b/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\nindex 7285459f0b..6173eacf48 100644\n--- a/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\n+++ b/services/src/main/java/org/keycloak/authentication/authenticators/x509/AbstractX509ClientCertificateAuthenticatorFactory.java\n\n@@ -87,7 +87,7 @@ public abstract class AbstractX509ClientCertificateAuthenticatorFactory implemen\n             USERNAME_EMAIL_MAPPER\n     };\n \n-    private static final String[] certificatePolicyModes = {\n+    private static final String[] CERTIFICATE_POLICY_MODES = {\n             CERTIFICATE_POLICY_MODE_ALL,\n             CERTIFICATE_POLICY_MODE_ANY\n     };\n"}}, {"oid": "3477bc47573c6702c3ef3436834a936da75a461c", "url": "https://github.com/keycloak/keycloak/commit/3477bc47573c6702c3ef3436834a936da75a461c", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-09-20T11:50:59Z", "type": "forcePushed"}, {"oid": "098bc7556b46e0b20f0e0ebf919716c560f07ff9", "url": "https://github.com/keycloak/keycloak/commit/098bc7556b46e0b20f0e0ebf919716c560f07ff9", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-09-20T11:55:52Z", "type": "commit"}, {"oid": "098bc7556b46e0b20f0e0ebf919716c560f07ff9", "url": "https://github.com/keycloak/keycloak/commit/098bc7556b46e0b20f0e0ebf919716c560f07ff9", "message": "KEYCLOAK-16520 X509 Auth: Add option to verify certificate policy", "committedDate": "2021-09-20T11:55:52Z", "type": "forcePushed"}]}