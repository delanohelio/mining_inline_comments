{"pr_number": 7004, "pr_title": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "pr_createdAt": "2020-04-24T12:23:40Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7004", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ0MDkxNg==", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r416440916", "bodyText": "Is there some input validation / escaping required here after reading loginHint from the request parameters?", "author": "thomasdarimont", "createdAt": "2020-04-28T08:47:43Z", "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -91,13 +93,15 @@ public Response performLogin(AuthenticationRequest request) {\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n+            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);\n             SAML2AuthnRequestBuilder authnRequestBuilder = new SAML2AuthnRequestBuilder()", "originalCommit": "b819b7b4d046c846c86071bd32c256288fd3c7e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ0ODE2NA==", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r416448164", "bodyText": "This value is sanitized in the subject method of SAML2AuthnRequestBuilder. It is also escaped using Stax when it is written in the SAML request. Do you think something else is required?", "author": "looorent", "createdAt": "2020-04-28T08:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ0MDkxNg=="}], "type": "inlineReview", "revised_code": {"commit": "9865b410106720fd6b3046894d7019ba2faf7ec9", "chunk": "diff --git a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\nindex cd3631777c..aebbdf807b 100755\n--- a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n+++ b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n\n@@ -93,7 +93,7 @@ public class SAMLIdentityProvider extends AbstractIdentityProvider<SAMLIdentityP\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n-            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);\n+            String loginHint = getConfig().isLoginHint() ? request.getAuthenticationSession().getClientNote(OIDCLoginProtocol.LOGIN_HINT_PARAM) : null;\n             SAML2AuthnRequestBuilder authnRequestBuilder = new SAML2AuthnRequestBuilder()\n                     .assertionConsumerUrl(assertionConsumerServiceUrl)\n                     .destination(destinationUrl)\n"}}, {"oid": "e4c119b22082371de461067bed1d6d2b4dd789f1", "url": "https://github.com/keycloak/keycloak/commit/e4c119b22082371de461067bed1d6d2b4dd789f1", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-05-05T06:45:49Z", "type": "forcePushed"}, {"oid": "56bb48a352abed44773114f0b66902321d51e71c", "url": "https://github.com/keycloak/keycloak/commit/56bb48a352abed44773114f0b66902321d51e71c", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests\n\nKEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-05-05T07:22:34Z", "type": "forcePushed"}, {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054", "url": "https://github.com/keycloak/keycloak/commit/2856461b721bb10312e70d9f5795f0bf3ed32054", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-07-03T14:25:19Z", "type": "commit"}, {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054", "url": "https://github.com/keycloak/keycloak/commit/2856461b721bb10312e70d9f5795f0bf3ed32054", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-07-03T14:25:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA4MDE4NQ==", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r452080185", "bodyText": "This needs to be guarded by a configuration that mimics OIDC identity provider loginHint configuration which will be disabled by default:\n\nMove OAuth2IdentityProviderConfig's isLoginHint and setLoginHint to IdentityProviderModel\nAdd a QueryParam(OIDCLoginProtocol.LOGIN_HINT_PARAM) to authentication session in IdentityBrokerService.performLogin similarly to https://github.com/keycloak/keycloak/blob/master/services/src/main/java/org/keycloak/protocol/oidc/endpoints/AuthorizationEndpoint.java#L445\nIn this place, only use request.getAuthenticationSession().getClientNote(OIDCLoginProtocol.LOGIN_HINT_PARAM)\n\nAlso update realm-identity-provider-saml.html to configure loginHint similarly to realm-identity-provider-oidc.html, and ensure that the label and label hint are properly adjusted to SAML terms.\nThe tests need to check that the settings of the loginHint configuration in SAML identity provider respect the settings.", "author": "hmlnarik", "createdAt": "2020-07-09T09:17:29Z", "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -91,13 +93,15 @@ public Response performLogin(AuthenticationRequest request) {\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n+            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);", "originalCommit": "2856461b721bb10312e70d9f5795f0bf3ed32054", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9865b410106720fd6b3046894d7019ba2faf7ec9", "chunk": "diff --git a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\nindex cd3631777c..aebbdf807b 100755\n--- a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n+++ b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n\n@@ -93,7 +93,7 @@ public class SAMLIdentityProvider extends AbstractIdentityProvider<SAMLIdentityP\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n-            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);\n+            String loginHint = getConfig().isLoginHint() ? request.getAuthenticationSession().getClientNote(OIDCLoginProtocol.LOGIN_HINT_PARAM) : null;\n             SAML2AuthnRequestBuilder authnRequestBuilder = new SAML2AuthnRequestBuilder()\n                     .assertionConsumerUrl(assertionConsumerServiceUrl)\n                     .destination(destinationUrl)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA4MDM1NA==", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r452080354", "bodyText": "Please remove, use existing constant instead (see below)", "author": "hmlnarik", "createdAt": "2020-07-09T09:17:46Z", "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -59,6 +59,8 @@\n  */\n public class SAMLIdentityProvider extends AbstractIdentityProvider<SAMLIdentityProviderConfig> {\n     protected static final Logger logger = Logger.getLogger(SAMLIdentityProvider.class);\n+    private static final String LOGIN_HINT_QUERY_PARAMETER = \"login_hint\";", "originalCommit": "2856461b721bb10312e70d9f5795f0bf3ed32054", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9865b410106720fd6b3046894d7019ba2faf7ec9", "chunk": "diff --git a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\nindex cd3631777c..aebbdf807b 100755\n--- a/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n+++ b/services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java\n\n@@ -59,7 +60,6 @@ import java.util.TreeSet;\n  */\n public class SAMLIdentityProvider extends AbstractIdentityProvider<SAMLIdentityProviderConfig> {\n     protected static final Logger logger = Logger.getLogger(SAMLIdentityProvider.class);\n-    private static final String LOGIN_HINT_QUERY_PARAMETER = \"login_hint\";\n \n     private final DestinationValidator destinationValidator;\n     public SAMLIdentityProvider(KeycloakSession session, SAMLIdentityProviderConfig config, DestinationValidator destinationValidator) {\n"}}, {"oid": "9865b410106720fd6b3046894d7019ba2faf7ec9", "url": "https://github.com/keycloak/keycloak/commit/9865b410106720fd6b3046894d7019ba2faf7ec9", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-07-09T16:59:08Z", "type": "commit"}, {"oid": "b32ba313c272272e817f6400b863e8cf302c861d", "url": "https://github.com/keycloak/keycloak/commit/b32ba313c272272e817f6400b863e8cf302c861d", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "committedDate": "2020-07-09T19:26:53Z", "type": "commit"}]}