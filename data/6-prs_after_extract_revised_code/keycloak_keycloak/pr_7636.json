{"pr_number": 7636, "pr_title": "KEYCLOAK-14846 default roles processing", "pr_createdAt": "2020-11-23T12:00:45Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7636", "timeline": [{"oid": "b6b8f607f5ec34a60fd66967a13c30361366b236", "url": "https://github.com/keycloak/keycloak/commit/b6b8f607f5ec34a60fd66967a13c30361366b236", "message": "KEYCLOAK-14846 remove DefaultRoles.java", "committedDate": "2020-11-25T11:03:05Z", "type": "forcePushed"}, {"oid": "db0b243bb7631d08f634198a7cf4895730c92787", "url": "https://github.com/keycloak/keycloak/commit/db0b243bb7631d08f634198a7cf4895730c92787", "message": "KEYCLOAK-14846 remove DefaultRoles.java", "committedDate": "2020-11-25T11:09:59Z", "type": "forcePushed"}, {"oid": "237f043cf5e091e3d1e8e5f28b2b1f148e8561da", "url": "https://github.com/keycloak/keycloak/commit/237f043cf5e091e3d1e8e5f28b2b1f148e8561da", "message": "KEYCLOAK-14846 fix import", "committedDate": "2020-11-25T13:20:10Z", "type": "forcePushed"}, {"oid": "a26736834ff9f09383d9377ecebc79c0586138b1", "url": "https://github.com/keycloak/keycloak/commit/a26736834ff9f09383d9377ecebc79c0586138b1", "message": "KEYCLOAK-14846 fix import", "committedDate": "2020-11-25T16:13:50Z", "type": "forcePushed"}, {"oid": "2362cb45dd4f9865ddcd29254351fbb4a480e816", "url": "https://github.com/keycloak/keycloak/commit/2362cb45dd4f9865ddcd29254351fbb4a480e816", "message": "KEYCLOAK-14846 rebase", "committedDate": "2020-11-30T20:18:45Z", "type": "forcePushed"}, {"oid": "a239d0c998f1cd6e4b03745c8e95f8404a2a1c86", "url": "https://github.com/keycloak/keycloak/commit/a239d0c998f1cd6e4b03745c8e95f8404a2a1c86", "message": "KEYCLOAK-14846 fix tests", "committedDate": "2020-12-01T21:21:46Z", "type": "forcePushed"}, {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d", "url": "https://github.com/keycloak/keycloak/commit/b77443f88b2cb572c1d9cd4332c2c50625ec326d", "message": "KEYCLOAK-14846 SQL migrate default roles", "committedDate": "2020-12-02T23:39:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODE4NQ==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r535938185", "bodyText": "Is this flush call needed?", "author": "hmlnarik", "createdAt": "2020-12-04T08:57:50Z", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java", "diffHunk": "@@ -1204,6 +1159,20 @@ public void setMasterAdminClient(ClientModel client) {\n         em.flush();\n     }\n \n+    @Override\n+    public void setDefaultRole(RoleModel role) {\n+        realm.setDefaultRoleId(role.getId());\n+        em.flush();", "originalCommit": "b77443f88b2cb572c1d9cd4332c2c50625ec326d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwNzAwNQ==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537107005", "bodyText": "no, it isn't, thank you", "author": "vramik", "createdAt": "2020-12-06T19:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODE4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b33672f629e6437ec5d0235323bd51b3713421a9", "chunk": "diff --git a/model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java b/model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java\nindex 3d73b10d1d..43837b55bc 100755\n--- a/model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java\n+++ b/model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java\n\n@@ -1162,7 +1194,6 @@ public class RealmAdapter implements RealmModel, JpaModel<RealmEntity> {\n     @Override\n     public void setDefaultRole(RoleModel role) {\n         realm.setDefaultRoleId(role.getId());\n-        em.flush();\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzODM2NA==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537438364", "bodyText": "Should be this commented block removed? If no should we add some comment why it is there?", "author": "mhajas", "createdAt": "2020-12-07T11:37:56Z", "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java", "diffHunk": "@@ -724,29 +724,39 @@ public void removeDefaultGroup(GroupModel group) {\n \n     }\n \n-    @Override\n-    public Stream<String> getDefaultRolesStream() {\n-        if (isUpdated()) return updated.getDefaultRolesStream();\n-        return cached.getDefaultRoles().stream();\n-    }\n-\n-    @Override\n-    public void addDefaultRole(String name) {\n-        getDelegateForUpdate();\n-        updated.addDefaultRole(name);\n-    }\n-\n-    @Override\n-    public void updateDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.updateDefaultRoles(defaultRoles);\n-    }\n-\n-    @Override\n-    public void removeDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.removeDefaultRoles(defaultRoles);\n-\n+//    @Override", "originalCommit": "5314d629274ceb03556244c15f0dfefaeb6d71d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDcwNQ==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220705", "bodyText": "done", "author": "vramik", "createdAt": "2020-12-08T10:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzODM2NA=="}], "type": "inlineReview", "revised_code": {"commit": "b33672f629e6437ec5d0235323bd51b3713421a9", "chunk": "diff --git a/model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java b/model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java\nindex fc2e13cea3..65e8396a7a 100755\n--- a/model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java\n+++ b/model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java\n\n@@ -724,34 +724,31 @@ public class RealmAdapter implements CachedRealmModel {\n \n     }\n \n-//    @Override\n-//    public Stream<String> getDefaultRolesStream() {\n-//        if (isUpdated()) return updated.getDefaultRolesStream();\n-//        return getDefaultRole().getCompositesStream().filter(this::isRealmRole).map(RoleModel::getName);\n-//    }\n-//\n-//    private boolean isRealmRole(RoleModel role) {\n-//        return ! role.isClientRole();\n-//    }\n-//\n-//    @Override\n-//    public void addDefaultRole(String name) {\n-//        getDelegateForUpdate();\n-//        updated.addDefaultRole(name);\n-//    }\n-//\n-//    @Override\n-//    public void updateDefaultRoles(String... defaultRoles) {\n-//        getDelegateForUpdate();\n-//        updated.updateDefaultRoles(defaultRoles);\n-//    }\n-//\n-//    @Override\n-//    public void removeDefaultRoles(String... defaultRoles) {\n-//        getDelegateForUpdate();\n-//        updated.removeDefaultRoles(defaultRoles);\n-//\n-//    }\n+    @Override\n+    @Deprecated\n+    public Stream<String> getDefaultRolesStream() {\n+        if (isUpdated()) return updated.getDefaultRolesStream();\n+        return getDefaultRole().getCompositesStream().filter(this::isRealmRole).map(RoleModel::getName);\n+    }\n+\n+    private boolean isRealmRole(RoleModel role) {\n+        return ! role.isClientRole();\n+    }\n+\n+    @Override\n+    @Deprecated\n+    public void addDefaultRole(String name) {\n+        getDelegateForUpdate();\n+        updated.addDefaultRole(name);\n+    }\n+\n+    @Override\n+    @Deprecated\n+    public void removeDefaultRoles(String... defaultRoles) {\n+        getDelegateForUpdate();\n+        updated.removeDefaultRoles(defaultRoles);\n+\n+    }\n \n     @Override\n     public void addToDefaultRoles(RoleModel role) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MjY1OQ==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537442659", "bodyText": "If I understand this correctly, this interface will basically stop working in newer versions. Should we provide an implementation of this that uses the composite default role in the background to stay backward compatible?", "author": "mhajas", "createdAt": "2020-12-07T11:45:24Z", "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -71,60 +67,40 @@\n     Stream<RoleModel> searchForRolesStream(String search, Integer first, Integer max);\n \n     /**\n-     * Returns all the default role names of this object.\n-     * @return List of the default role names of this object. Never returns {@code null}.\n-     * @deprecated use the stream variant instead\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n      */\n     @Deprecated\n     default List<String> getDefaultRoles() {", "originalCommit": "5314d629274ceb03556244c15f0dfefaeb6d71d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDg2OA==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220868", "bodyText": "Yes, you're right. It started by the fact that I've relialized we don't need to have possibility to manage default roles of each client separately so I've sent a mail to keycloak-dev about that and got confirmation I can remove the possibility from clients. Then we decided we should add RoleModel RealmModel.getDefaultRole() and it basically means all these methods could be potentionaly removed. But in the end it ended up like this. I've introduced those implementations you've asked for in separate commit for better re-review.", "author": "vramik", "createdAt": "2020-12-08T10:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MjY1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b33672f629e6437ec5d0235323bd51b3713421a9", "chunk": "diff --git a/server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java b/server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java\nindex dfd3e61fa9..282306e5da 100755\n--- a/server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java\n+++ b/server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java\n\n@@ -67,40 +71,54 @@ public interface RoleContainerModel {\n     Stream<RoleModel> searchForRolesStream(String search, Integer first, Integer max);\n \n     /**\n-     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}. This method will be removed.\n      */\n     @Deprecated\n     default List<String> getDefaultRoles() {\n-        return null;\n+        return getDefaultRolesStream().collect(Collectors.toList());\n     }\n \n     /**\n-     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}. This method will be removed.\n      */\n     @Deprecated\n-    default Stream<String> getDefaultRolesStream() {\n-        return null;\n-    }\n+    Stream<String> getDefaultRolesStream();\n \n     /**\n-     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}. This method will be removed.\n      */\n     @Deprecated\n-    default void addDefaultRole(String name) {\n-    }\n+    void addDefaultRole(String name);\n \n     /**\n-     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}. This method will be removed.\n      */\n     @Deprecated\n     default void updateDefaultRoles(String... defaultRoles) {\n+        List<String> defaultRolesArray = Arrays.asList(defaultRoles);\n+        Collection<String> entities = getDefaultRolesStream().collect(Collectors.toList());\n+        Set<String> already = new HashSet<>();\n+        ArrayList<String> remove = new ArrayList<>();\n+        for (String rel : entities) {\n+            if (! defaultRolesArray.contains(rel)) {\n+                remove.add(rel);\n+            } else {\n+                already.add(rel);\n+            }\n+        }\n+        removeDefaultRoles(remove.toArray(new String[] {}));\n+\n+        for (String roleName : defaultRoles) {\n+            if (!already.contains(roleName)) {\n+                addDefaultRole(roleName);\n+            }\n+        }\n     }\n \n     /**\n-     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}. This method will be removed.\n      */\n     @Deprecated\n-    default void removeDefaultRoles(String... defaultRoles) {\n-    }\n+    void removeDefaultRoles(String... defaultRoles);\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537457382", "bodyText": "Is it possible that defaultRole is null? Or we can be sure default role always exists?", "author": "mhajas", "createdAt": "2020-12-07T12:09:23Z", "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "originalCommit": "5314d629274ceb03556244c15f0dfefaeb6d71d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMjM5Mw==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538212393", "bodyText": "The default role should always exist, in case it doesn't the server is in illegal state. But I get your point.\nNot sure if it'll be better to handle null possibility here rather than later face NPE or rely on the fact the role has to exist. wdyt?\nAnd if the former the question is what would be correct way to handle it. I lean towards to do nothing: if (realm.getDefaultRole == null) return; wdyt?", "author": "vramik", "createdAt": "2020-12-08T10:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDY1NA==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220654", "bodyText": "I'd say the right way is to log a warning if the default role does not exist, and then return.", "author": "hmlnarik", "createdAt": "2020-12-08T10:30:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMzk2NA==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538223964", "bodyText": "@hmlnarik sounds good, thank you", "author": "vramik", "createdAt": "2020-12-08T10:34:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NjA3NQ==", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538246075", "bodyText": "Thinking about it a bit deeper, I wonder whether we should not just allow deleting the role in case there is no default role defined. Yes, log a warning, but preventing to delete any role when default role is not set on realm seems too much on the second thought. WDYT?", "author": "hmlnarik", "createdAt": "2020-12-08T11:03:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "b33672f629e6437ec5d0235323bd51b3713421a9", "chunk": "diff --git a/services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java b/services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java\nindex 2ac5602cee..ecb9736b72 100755\n--- a/services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java\n+++ b/services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java\n\n@@ -106,6 +106,10 @@ public class RoleByIdResource extends RoleResource {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole() == null) {\n+            logger.warnf(\"Default role for realm with id '%s' doesn't exist.\", realm.getId());\n+            return;\n+        }\n         if (realm.getDefaultRole().getId().equals(id)) {\n             throw new ErrorResponseException(ErrorResponse.error(realm.getDefaultRole().getName() + \" is default role of the realm and cannot be removed.\", \n                     Response.Status.BAD_REQUEST));\n"}}, {"oid": "b33672f629e6437ec5d0235323bd51b3713421a9", "url": "https://github.com/keycloak/keycloak/commit/b33672f629e6437ec5d0235323bd51b3713421a9", "message": "KEYCLOAK-14846 rebase", "committedDate": "2020-12-08T11:04:51Z", "type": "forcePushed"}, {"oid": "d7056927e2d5877bdf7826b6ee318b8328e571a7", "url": "https://github.com/keycloak/keycloak/commit/d7056927e2d5877bdf7826b6ee318b8328e571a7", "message": "KEYCLOAK-14846 rebase", "committedDate": "2020-12-10T18:20:30Z", "type": "forcePushed"}, {"oid": "1f4c838079a40c2317502ac479d604f5e4343251", "url": "https://github.com/keycloak/keycloak/commit/1f4c838079a40c2317502ac479d604f5e4343251", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2020-12-10T22:47:01Z", "type": "forcePushed"}, {"oid": "05e8936d415f2727ee47c8ebe1a667b26fe9bcec", "url": "https://github.com/keycloak/keycloak/commit/05e8936d415f2727ee47c8ebe1a667b26fe9bcec", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2020-12-16T22:53:32Z", "type": "forcePushed"}, {"oid": "2d7bc6b059d1ff9537f488987ffe0e8f21bd3246", "url": "https://github.com/keycloak/keycloak/commit/2d7bc6b059d1ff9537f488987ffe0e8f21bd3246", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2020-12-17T22:10:46Z", "type": "forcePushed"}, {"oid": "d51a2ee917395fabf9d575eb65e698058c067b96", "url": "https://github.com/keycloak/keycloak/commit/d51a2ee917395fabf9d575eb65e698058c067b96", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2020-12-18T00:18:53Z", "type": "forcePushed"}, {"oid": "fb9950abab067dd52a9a99025dd3c0a34ccff567", "url": "https://github.com/keycloak/keycloak/commit/fb9950abab067dd52a9a99025dd3c0a34ccff567", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2020-12-18T08:43:16Z", "type": "forcePushed"}, {"oid": "486478996664412dc2b6997bad7b27664be45db4", "url": "https://github.com/keycloak/keycloak/commit/486478996664412dc2b6997bad7b27664be45db4", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2021-01-05T10:07:27Z", "type": "forcePushed"}, {"oid": "7905645920a337ad0e57ff752b469d8d86b285e5", "url": "https://github.com/keycloak/keycloak/commit/7905645920a337ad0e57ff752b469d8d86b285e5", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2021-01-05T19:06:56Z", "type": "forcePushed"}, {"oid": "79874296348dc3e1c9f56052b9513c215a4698c0", "url": "https://github.com/keycloak/keycloak/commit/79874296348dc3e1c9f56052b9513c215a4698c0", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2021-01-06T00:02:25Z", "type": "forcePushed"}, {"oid": "43f58a354fd61e04241b87ce95eac3805b981dde", "url": "https://github.com/keycloak/keycloak/commit/43f58a354fd61e04241b87ce95eac3805b981dde", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2021-01-06T10:53:12Z", "type": "commit"}, {"oid": "43f58a354fd61e04241b87ce95eac3805b981dde", "url": "https://github.com/keycloak/keycloak/commit/43f58a354fd61e04241b87ce95eac3805b981dde", "message": "KEYCLOAK-14846 Default roles processing", "committedDate": "2021-01-06T10:53:12Z", "type": "forcePushed"}]}