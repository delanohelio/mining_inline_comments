{"pr_number": 6997, "pr_title": "[KEYCLOAK-13927] Allow deleting permission tickets with the Authz client", "pr_createdAt": "2020-04-22T14:13:44Z", "pr_url": "https://github.com/keycloak/keycloak/pull/6997", "timeline": [{"oid": "f4a809854db30c05b5d889fe6a1ce2ab768d440f", "url": "https://github.com/keycloak/keycloak/commit/f4a809854db30c05b5d889fe6a1ce2ab768d440f", "message": "[KEYCLOAK-13927] Allow deleting permission tickets with the Authz client", "committedDate": "2020-04-22T14:11:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI0NzAyMg==", "url": "https://github.com/keycloak/keycloak/pull/6997#discussion_r413247022", "bodyText": "Instead of passing the ticket representation we can just use the ID (String) as the argument for this method.", "author": "pedroigor", "createdAt": "2020-04-22T19:08:22Z", "path": "authz/client/src/main/java/org/keycloak/authorization/client/resource/PermissionResource.java", "diffHunk": "@@ -237,13 +237,43 @@ public void update(final PermissionTicketRepresentation ticket) {\n         if (ticket.getId() == null) {\n             throw new IllegalArgumentException(\"Permission ticket must have an id\");\n         }\n-        Callable callable = new Callable() {\n+        Callable<Void> callable = new Callable<Void>() {\n             @Override\n-            public Object call() throws Exception {\n-                http.<List>put(serverConfiguration.getPermissionEndpoint()+\"/ticket\")\n+            public Void call() throws Exception {\n+                http.<Void>put(serverConfiguration.getPermissionEndpoint()+\"/ticket\")\n                         .json(JsonSerialization.writeValueAsBytes(ticket))\n                         .authorizationBearer(pat.call())\n-                        .response().json(List.class).execute();\n+                        .response()\n+                        .execute();\n+                return null;\n+            }\n+        };\n+        try {\n+            callable.call();\n+        } catch (Exception cause) {\n+            Throwables.retryAndWrapExceptionIfNecessary(callable, pat, \"Error updating permission ticket\", cause);\n+        }\n+    }\n+\n+    /**\n+     * Deletes a permission ticket.\n+     *\n+     * @param ticket the permission ticket\n+     */\n+    public void delete(final PermissionTicketRepresentation ticket) {", "originalCommit": "f4a809854db30c05b5d889fe6a1ce2ab768d440f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzU1ODM4NA==", "url": "https://github.com/keycloak/keycloak/pull/6997#discussion_r413558384", "bodyText": "Thanks for the fast feedback, it is fixed now.", "author": "bartmentech", "createdAt": "2020-04-23T06:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI0NzAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "508af04aa4ed758ea3a2309bd7e1f1756915a8fe", "chunk": "diff --git a/authz/client/src/main/java/org/keycloak/authorization/client/resource/PermissionResource.java b/authz/client/src/main/java/org/keycloak/authorization/client/resource/PermissionResource.java\nindex 300f09fd84..26d013b52e 100644\n--- a/authz/client/src/main/java/org/keycloak/authorization/client/resource/PermissionResource.java\n+++ b/authz/client/src/main/java/org/keycloak/authorization/client/resource/PermissionResource.java\n\n@@ -256,21 +256,17 @@ public class PermissionResource {\n     }\n \n     /**\n-     * Deletes a permission ticket.\n-     *\n-     * @param ticket the permission ticket\n+     * Deletes a permission ticket by ID.\n+     * @param ticketId the permission ticket ID\n      */\n-    public void delete(final PermissionTicketRepresentation ticket) {\n-        if (ticket == null) {\n-            throw new IllegalArgumentException(\"Permission ticket must not be null or empty\");\n-        }\n-        if (ticket.getId() == null) {\n-            throw new IllegalArgumentException(\"Permission ticket must have an id\");\n+    public void delete(final String ticketId) {\n+        if (ticketId == null || ticketId.trim().isEmpty()) {\n+            throw new IllegalArgumentException(\"Permission ticket ID must not be null or empty\");\n         }\n         Callable<Void> callable = new Callable<Void>() {\n             @Override\n             public Void call() throws Exception {\n-                http.<Void>delete(serverConfiguration.getPermissionEndpoint() + \"/ticket/\" + ticket.getId())\n+                http.<Void>delete(serverConfiguration.getPermissionEndpoint() + \"/ticket/\" + ticketId)\n                         .authorizationBearer(pat.call())\n                         .response()\n                         .execute();\n"}}, {"oid": "4ffc43a9ad74c3b8e789d8d29d91d2f98af02458", "url": "https://github.com/keycloak/keycloak/commit/4ffc43a9ad74c3b8e789d8d29d91d2f98af02458", "message": "[KEYCLOAK-13927] Fix java doc @param name in PermissionResource", "committedDate": "2020-04-23T06:46:12Z", "type": "commit"}, {"oid": "508af04aa4ed758ea3a2309bd7e1f1756915a8fe", "url": "https://github.com/keycloak/keycloak/commit/508af04aa4ed758ea3a2309bd7e1f1756915a8fe", "message": "[KEYCLOAK-13927] Accept only ticketId instead of the PermissionTicketRepresentation for delete in PermissionResource", "committedDate": "2020-04-23T06:54:29Z", "type": "commit"}]}