{"pr_number": 298, "pr_title": "Redesign: Set Default Currency [NMA-243]", "pr_createdAt": "2020-01-09T21:09:20Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/298", "timeline": [{"oid": "07c2fb5442cda549b29db9867dad759bc30cad8d", "url": "https://github.com/dashevo/dash-wallet/commit/07c2fb5442cda549b29db9867dad759bc30cad8d", "message": "Add logs for locale detection exception", "committedDate": "2020-01-06T23:38:28Z", "type": "commit"}, {"oid": "f7bdc15f1e7ffce09b818c04a8861f9fc10e46e1", "url": "https://github.com/dashevo/dash-wallet/commit/f7bdc15f1e7ffce09b818c04a8861f9fc10e46e1", "message": "Add CurrencyInfo class to handle obsolete and non ISO 4217 currencies", "committedDate": "2020-01-09T20:47:01Z", "type": "commit"}, {"oid": "5da791fe590e460c77a3b2c518ded21e044696b4", "url": "https://github.com/dashevo/dash-wallet/commit/5da791fe590e460c77a3b2c518ded21e044696b4", "message": "Handle the case of exchangeRate==null when displaying the tx confirm dlg", "committedDate": "2020-01-09T20:48:02Z", "type": "commit"}, {"oid": "d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd", "url": "https://github.com/dashevo/dash-wallet/commit/d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd", "message": "Add more logging, set default currency based on locale for devices that\ndon't have sim cards.\n\nThis does not handle the case where a currency does not exist in the\nprice source list, but the previous commit prevents the crash.", "committedDate": "2020-01-09T20:49:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r365119740", "bodyText": "Should we put USDC here as well?", "author": "dn-l", "createdAt": "2020-01-10T08:33:25Z", "path": "common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java", "diffHunk": "@@ -0,0 +1,125 @@\n+/*\n+ * Copyright 2019 Dash Core Group\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.dash.wallet.common.data;\n+\n+import android.annotation.TargetApi;\n+import android.os.Build;\n+\n+import java.util.Currency;\n+import java.util.HashMap;\n+\n+/**\n+    @author: Eric Britten\n+ */\n+\n+public class CurrencyInfo {\n+\n+    /*\n+        Older android devices will have obsolete currency codes\n+        that do not match what the prices sources currently used.\n+\n+        e.g. in Belarus (BY), the currency changed from BYR to BYN\n+        at the end of 2016.  Older phones have BYR.\n+\n+        This app will read BYR from the device and then query BYN\n+        in the exchange rates list, but must get the name of BYR\n+        from the device.\n+     */\n+    private static HashMap<String, String> obsoleteCurrencyMap;\n+\n+    /*\n+        These currencies are listed in the price data, but are not\n+        ISO 4217 currency codes.  This will map those codes to the\n+        currency names.\n+     */\n+    private static HashMap<String, String> otherCurrencyMap;\n+\n+    /*\n+        These currencies are listed in the price data and have the\n+        same name as a different currency.  This differs from\n+        obsoleteCurrencyMap because both of these codes exist in the", "originalCommit": "d508ac5b4565acd38ff2d6b0bcff4429dc4d5ecd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyNDQzOA==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r365124438", "bodyText": "It's in the bitpay response", "author": "dn-l", "createdAt": "2020-01-10T08:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTIzMjMyNA==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r365232324", "bodyText": "Yes, good idea.", "author": "HashEngineering", "createdAt": "2020-01-10T13:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5ODA5MQ==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r365998091", "bodyText": "this was added", "author": "HashEngineering", "createdAt": "2020-01-13T19:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE3NjQxMw==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r367176413", "bodyText": "There are other currencies to add text for that come from BtcPay, so I will add those also.", "author": "HashEngineering", "createdAt": "2020-01-16T00:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExOTc0MA=="}], "type": "inlineReview", "revised_code": {"commit": "0bbe2883f06ee72dad74873aef5f4f3a692211fd", "chunk": "diff --git a/common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java b/common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java\nindex 9ffe2c006..5d3d97bf8 100644\n--- a/common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java\n+++ b/common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java\n\n@@ -67,6 +67,8 @@ public class CurrencyInfo {\n         otherCurrencyMap.put(\"GGP\", \"Guernsey Pound\");\n         otherCurrencyMap.put(\"JEP\", \"Jersey Pound\");\n         otherCurrencyMap.put(\"IMP\", \"Isle of Man Pound\");\n+        otherCurrencyMap.put(\"USDC\", \"USD Coin\");\n+\n \n         useOtherNameMap = new HashMap<>();\n         useOtherNameMap.put(\"CNH\", \"CNY\");\n"}}, {"oid": "0bbe2883f06ee72dad74873aef5f4f3a692211fd", "url": "https://github.com/dashevo/dash-wallet/commit/0bbe2883f06ee72dad74873aef5f4f3a692211fd", "message": "Add name for USDC from bitpay", "committedDate": "2020-01-13T19:53:55Z", "type": "commit"}, {"oid": "afc6bd3719960f8810489950a47e0c3b0026e5ec", "url": "https://github.com/dashevo/dash-wallet/commit/afc6bd3719960f8810489950a47e0c3b0026e5ec", "message": "Add other currency names.  Prevent crash on 4 digit code.  Handle MRO->MRU", "committedDate": "2020-01-16T01:23:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI2MjMzNQ==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r367262335", "bodyText": "Will not be used I suppose? afc6bd3#diff-d59db2bdbe7841e4cb222c288bc4e156R76", "author": "dn-l", "createdAt": "2020-01-16T07:16:35Z", "path": "common/src/main/java/org/dash/wallet/common/data/CurrencyInfo.java", "diffHunk": "@@ -60,15 +60,20 @@\n \n     static {\n         obsoleteCurrencyMap = new HashMap<>();\n-        obsoleteCurrencyMap.put(\"BYR\", \"BYN\");\n+        obsoleteCurrencyMap.put(\"BYR\", \"BYN\"); // Belarus Ruble, changed in 2016\n+        obsoleteCurrencyMap.put(\"MRO\", \"MRU\"); // Mauritania Ouguiya, changed in 2018\n \n         otherCurrencyMap = new HashMap<>();\n         otherCurrencyMap.put(\"VES\", \"Venezuelan Bol\u00edvar\");\n         otherCurrencyMap.put(\"GGP\", \"Guernsey Pound\");\n         otherCurrencyMap.put(\"JEP\", \"Jersey Pound\");\n         otherCurrencyMap.put(\"IMP\", \"Isle of Man Pound\");\n         otherCurrencyMap.put(\"USDC\", \"USD Coin\");\n-\n+        otherCurrencyMap.put(\"LTC\", \"Litecoin\");\n+        otherCurrencyMap.put(\"ETH\", \"Etherium\");\n+        otherCurrencyMap.put(\"BTC\", \"Bitcoin\");\n+        otherCurrencyMap.put(\"PAX\", \"Paxos Standard\");\n+        otherCurrencyMap.put(\"GUSD\", \"Gemini Dollar\");", "originalCommit": "afc6bd3719960f8810489950a47e0c3b0026e5ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2ODg5Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r368568896", "bodyText": "There is one currency, USDT, that will be 4 letters long.  This check will prevent the exception that occurs for currency codes that are not 3 letters.", "author": "HashEngineering", "createdAt": "2020-01-20T14:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI2MjMzNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwMDQ1Ng==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r369200456", "bodyText": "Please remove empty spaces.", "author": "sambarboza", "createdAt": "2020-01-21T19:32:50Z", "path": "wallet/src/de/schildbach/wallet/ui/WalletActivity.java", "diffHunk": "@@ -1080,24 +1082,70 @@ private void detectUserCountry() {\n         try {\n             final TelephonyManager tm = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);\n             final String simCountry = tm.getSimCountryIso();\n+\n+            log.info(\"Detecting currency based on device, mobile network or locale:\");\n             if (simCountry != null && simCountry.length() == 2) { // SIM country code is available\n+                log.info(\"Device Sim Country: \" + simCountry);\n                 updateCurrencyExchange(simCountry.toUpperCase());\n             } else if (tm.getPhoneType() != TelephonyManager.PHONE_TYPE_CDMA) { // device is not 3G (would be unreliable)\n                 String networkCountry = tm.getNetworkCountryIso();\n+                log.info(\"Network Country: \" + simCountry);\n                 if (networkCountry != null && networkCountry.length() == 2) { // network country code is available\n                     updateCurrencyExchange(networkCountry.toUpperCase());\n                 } else {\n                     //Couldn't obtain country code - Use Default\n                     if (config.getExchangeCurrencyCode() == null)\n-                        config.setExchangeCurrencyCode(Constants.DEFAULT_EXCHANGE_CURRENCY);\n+                        setDefaultCurrency();\n                 }\n             } else {\n                 //No cellular network - Wifi Only\n                 if (config.getExchangeCurrencyCode() == null)\n-                    config.setExchangeCurrencyCode(Constants.DEFAULT_EXCHANGE_CURRENCY);\n+                    setDefaultCurrency();\n             }\n         } catch (Exception e) {\n             //fail safe\n+            log.info(\"NMA-243:  Exception thrown obtaining Locale information: \", e);\n+            if (config.getExchangeCurrencyCode() == null)\n+                setDefaultCurrency();\n+        }\n+    }\n+", "originalCommit": "afc6bd3719960f8810489950a47e0c3b0026e5ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1MDYxMw==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r369250613", "bodyText": "This will be done before merging.", "author": "HashEngineering", "createdAt": "2020-01-21T21:24:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwMDQ1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2NTAzNg==", "url": "https://github.com/dashevo/dash-wallet/pull/298#discussion_r369265036", "bodyText": "This has been fixed.", "author": "HashEngineering", "createdAt": "2020-01-21T21:57:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIwMDQ1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "65f1ab46d0780799f2c6e15d126e4cf02e4df594", "chunk": "diff --git a/wallet/src/de/schildbach/wallet/ui/WalletActivity.java b/wallet/src/de/schildbach/wallet/ui/WalletActivity.java\nindex 48455cc9e..dd6ba44d6 100644\n--- a/wallet/src/de/schildbach/wallet/ui/WalletActivity.java\n+++ b/wallet/src/de/schildbach/wallet/ui/WalletActivity.java\n\n@@ -1110,8 +1110,6 @@ public final class WalletActivity extends AbstractBindServiceActivity\n         }\n     }\n \n-\n-\n     private void setDefaultCurrency() {\n         String countryCode = getCurrentCountry();\n         log.info(\"Setting default currency:\");\n"}}, {"oid": "65f1ab46d0780799f2c6e15d126e4cf02e4df594", "url": "https://github.com/dashevo/dash-wallet/commit/65f1ab46d0780799f2c6e15d126e4cf02e4df594", "message": "remove extra spaces", "committedDate": "2020-01-21T21:54:52Z", "type": "commit"}]}