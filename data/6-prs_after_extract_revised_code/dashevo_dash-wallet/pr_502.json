{"pr_number": 502, "pr_title": "BIP70 | Broadcast Transaction After Server Ack", "pr_createdAt": "2020-09-02T15:57:58Z", "pr_url": "https://github.com/dashevo/dash-wallet/pull/502", "timeline": [{"oid": "f6ce2d6adebba2d040747dc096831c0760e033d1", "url": "https://github.com/dashevo/dash-wallet/commit/f6ce2d6adebba2d040747dc096831c0760e033d1", "message": "Removed obsolete test code.", "committedDate": "2020-09-02T11:37:10Z", "type": "commit"}, {"oid": "9eff79428068a436912b13f724086d61ef85a4f1", "url": "https://github.com/dashevo/dash-wallet/commit/9eff79428068a436912b13f724086d61ef85a4f1", "message": "Avoid broadcast BIP70 transaction is server did not acknowledge first", "committedDate": "2020-09-02T15:17:12Z", "type": "commit"}, {"oid": "214d78410f79dcdc4c788648c5e98f40c1fe43bd", "url": "https://github.com/dashevo/dash-wallet/commit/214d78410f79dcdc4c788648c5e98f40c1fe43bd", "message": "Changed the BIP70 payment error message", "committedDate": "2020-09-02T15:56:06Z", "type": "commit"}, {"oid": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "url": "https://github.com/dashevo/dash-wallet/commit/af444fa05fec1e0f6e56b242a7f5394f0707b94a", "message": "Fixed the issue with Electrum based BIP70 servers that doesn't provide PaymentUrl", "committedDate": "2020-09-02T16:12:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjQ1NjYxMA==", "url": "https://github.com/dashevo/dash-wallet/pull/502#discussion_r482456610", "bodyText": "Where does the value of txAlreadyComplete come from? The logic here seems to be that if the tx is completed (wallet.completeTx was called) then it only needs to be committed, otherwise wallet.sendCoinsOffline will complete and commit the transaction.  I suppose this makes sense, so this relates to a comment above about how the value of txAlreadyComplete is set.", "author": "HashEngineering", "createdAt": "2020-09-02T20:56:11Z", "path": "wallet/src/de/schildbach/wallet/ui/send/SendCoinsOfflineTask.java", "diffHunk": "@@ -51,14 +51,23 @@ public SendCoinsOfflineTask(final Wallet wallet, final Handler backgroundHandler\n     }\n \n     public final void sendCoinsOffline(final SendRequest sendRequest) {\n+        sendCoinsOffline(sendRequest, false);\n+    }\n+\n+    public final void sendCoinsOffline(final SendRequest sendRequest, final boolean txAlreadyCompleted) {\n         backgroundHandler.post(new Runnable() {\n             @Override\n             public void run() {\n                 org.bitcoinj.core.Context.propagate(Constants.CONTEXT);\n \n                 try {\n                     log.info(\"sending: {}\", sendRequest);\n-                    final Transaction transaction = wallet.sendCoinsOffline(sendRequest); // can take long\n+                    if (txAlreadyCompleted) {\n+                        wallet.commitTx(sendRequest.tx);\n+                    } else {\n+                        wallet.sendCoinsOffline(sendRequest);\n+                    }", "originalCommit": "af444fa05fec1e0f6e56b242a7f5394f0707b94a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "293ae42855fab56cccdbe1c703c28138dd535050", "url": "https://github.com/dashevo/dash-wallet/commit/293ae42855fab56cccdbe1c703c28138dd535050", "message": "Checking expiration date once again just before performing payment", "committedDate": "2020-09-08T17:23:15Z", "type": "commit"}]}