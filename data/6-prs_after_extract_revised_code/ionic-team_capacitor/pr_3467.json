{"pr_number": 3467, "pr_title": "chore: remove Geolocation plugin", "pr_createdAt": "2020-08-25T17:45:15Z", "pr_url": "https://github.com/ionic-team/capacitor/pull/3467", "timeline": [{"oid": "3203f0a1cc132fc8999e6fd9cdb4388cfc509a6b", "url": "https://github.com/ionic-team/capacitor/commit/3203f0a1cc132fc8999e6fd9cdb4388cfc509a6b", "message": "Removed android", "committedDate": "2020-08-13T20:53:38Z", "type": "commit"}, {"oid": "d675b812f0dd5eaf61359134aec8a5a9b037fc4e", "url": "https://github.com/ionic-team/capacitor/commit/d675b812f0dd5eaf61359134aec8a5a9b037fc4e", "message": "Merged in main", "committedDate": "2020-08-24T19:59:43Z", "type": "commit"}, {"oid": "b551235bc732e5d0975af3603f11584d5397570f", "url": "https://github.com/ionic-team/capacitor/commit/b551235bc732e5d0975af3603f11584d5397570f", "message": "Removed more", "committedDate": "2020-08-24T22:29:32Z", "type": "commit"}, {"oid": "45b246cb8dfd6773e0ac47faf688e5184f25ae44", "url": "https://github.com/ionic-team/capacitor/commit/45b246cb8dfd6773e0ac47faf688e5184f25ae44", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-08-25T18:32:26Z", "type": "commit"}, {"oid": "0ba5cd846eafcc14a76fbae51d88d913195b5606", "url": "https://github.com/ionic-team/capacitor/commit/0ba5cd846eafcc14a76fbae51d88d913195b5606", "message": "Added registration mechanism for a geolocation plugin to hook on to permission requst from browser", "committedDate": "2020-09-08T20:54:58Z", "type": "commit"}, {"oid": "8b1503894dc3ab4a706afaf6d7feb9277161d64b", "url": "https://github.com/ionic-team/capacitor/commit/8b1503894dc3ab4a706afaf6d7feb9277161d64b", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-09-08T20:55:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NDQzOQ==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r485194439", "bodyText": "@dwieeb I added this method to the bridge so that it's possible to provide a Geolocation plugin for the onGeolocationPermissionsShowPrompt method in BridgeWebChromeClient to use. I'm unsure if we want to leave it at this, or make this method available on the Plugin class instead so that plugins don't need to touch the Bridge to do this. Thoughts?", "author": "carlpoole", "createdAt": "2020-09-08T21:02:42Z", "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -883,4 +883,8 @@ public BridgeWebViewClient getWebViewClient() {\n     public void setWebViewClient(BridgeWebViewClient client) {\n         this.webViewClient = client;\n     }\n+\n+    public void registerGeolocationPlugin(Plugin geolocationPlugin) {", "originalCommit": "8b1503894dc3ab4a706afaf6d7feb9277161d64b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NzI0Ng==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r485267246", "bodyText": "Would it make more sense to have it be more of an event-based design?", "author": "imhoffd", "createdAt": "2020-09-09T00:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NDQzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "550356795c2f2e22428288fee35a549da516c571", "chunk": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\nindex b394b264..ffe7b8aa 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n\n@@ -884,7 +885,7 @@ public class Bridge {\n         this.webViewClient = client;\n     }\n \n-    public void registerGeolocationPlugin(Plugin geolocationPlugin) {\n-        this.webChromeClient.registerGeolocationPlugin(geolocationPlugin);\n+    public void registerGeolocationPlugin(GeolocationPromptListener listener) {\n+        this.webChromeClient.registerGeolocationPromptListener(listener);\n     }\n }\n"}}, {"oid": "befcd420e2a83ee6d831eb41b279a53e0b6a481c", "url": "https://github.com/ionic-team/capacitor/commit/befcd420e2a83ee6d831eb41b279a53e0b6a481c", "message": "import cleanup/fix", "committedDate": "2020-09-08T21:09:26Z", "type": "commit"}, {"oid": "813288c13d34c42dfa96e717cbd0fbc53453d16c", "url": "https://github.com/ionic-team/capacitor/commit/813288c13d34c42dfa96e717cbd0fbc53453d16c", "message": "prettier", "committedDate": "2020-09-08T21:09:44Z", "type": "commit"}, {"oid": "6b4ad70099f27dd2449173cbc01381ff1221dcb4", "url": "https://github.com/ionic-team/capacitor/commit/6b4ad70099f27dd2449173cbc01381ff1221dcb4", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-09-08T21:10:01Z", "type": "commit"}, {"oid": "550356795c2f2e22428288fee35a549da516c571", "url": "https://github.com/ionic-team/capacitor/commit/550356795c2f2e22428288fee35a549da516c571", "message": "Changed to use an interface", "committedDate": "2020-09-10T17:53:30Z", "type": "commit"}, {"oid": "082e1a04884b13025aa3b435a3333677ff72faab", "url": "https://github.com/ionic-team/capacitor/commit/082e1a04884b13025aa3b435a3333677ff72faab", "message": "mistaken removal", "committedDate": "2020-09-10T17:59:06Z", "type": "commit"}, {"oid": "b1c8816c338ed52646466b4573fd803f36293c51", "url": "https://github.com/ionic-team/capacitor/commit/b1c8816c338ed52646466b4573fd803f36293c51", "message": "add method on Plugin class", "committedDate": "2020-09-10T18:17:13Z", "type": "commit"}, {"oid": "a30defdd10122577b0ae4bba7dcce7bf61a4a310", "url": "https://github.com/ionic-team/capacitor/commit/a30defdd10122577b0ae4bba7dcce7bf61a4a310", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-09-23T21:39:21Z", "type": "commit"}, {"oid": "14593727040c7f1d5727c3d17748598807813735", "url": "https://github.com/ionic-team/capacitor/commit/14593727040c7f1d5727c3d17748598807813735", "message": "undoing permission work so it can be handled in core", "committedDate": "2020-09-23T21:48:27Z", "type": "commit"}, {"oid": "5d7b444c73539b5a57a1d7449e96bd630bb35300", "url": "https://github.com/ionic-team/capacitor/commit/5d7b444c73539b5a57a1d7449e96bd630bb35300", "message": "Added new methods for checking permissions in the WebChromeClient", "committedDate": "2020-09-23T21:59:49Z", "type": "commit"}, {"oid": "3db9216ca273e44a831e9d153375b3db14e89468", "url": "https://github.com/ionic-team/capacitor/commit/3db9216ca273e44a831e9d153375b3db14e89468", "message": "putting this back...", "committedDate": "2020-09-23T22:02:54Z", "type": "commit"}, {"oid": "0ce95e78a7bff4884fe942c719568cabafd1f7a6", "url": "https://github.com/ionic-team/capacitor/commit/0ce95e78a7bff4884fe942c719568cabafd1f7a6", "message": "Replacing removed import statements that were necessary", "committedDate": "2020-09-23T22:25:17Z", "type": "commit"}, {"oid": "66cae3fffa3f00492b7695b7c4ff4919fc6e2a58", "url": "https://github.com/ionic-team/capacitor/commit/66cae3fffa3f00492b7695b7c4ff4919fc6e2a58", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-09-24T12:17:34Z", "type": "commit"}, {"oid": "2aa0d43db2c248bc2d5ba16a24d64f1c3593f7aa", "url": "https://github.com/ionic-team/capacitor/commit/2aa0d43db2c248bc2d5ba16a24d64f1c3593f7aa", "message": "fmt", "committedDate": "2020-09-24T12:30:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0NDIyNA==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r494344224", "bodyText": "Shouldn't use the same request code that is used on Geolocation plugin, the codes are used to identify who called the permission prompt, so if the Geolocation plugin is installed it could cause an undesired callback.", "author": "jcesarmobile", "createdAt": "2020-09-24T14:00:26Z", "path": "android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java", "diffHunk": "@@ -37,12 +38,14 @@\n  * WebView instance.\n  */\n public class BridgeWebChromeClient extends WebChromeClient {\n-    private Bridge bridge;\n     static final int FILE_CHOOSER = PluginRequestCodes.FILE_CHOOSER;\n     static final int FILE_CHOOSER_IMAGE_CAPTURE = PluginRequestCodes.FILE_CHOOSER_IMAGE_CAPTURE;\n     static final int FILE_CHOOSER_VIDEO_CAPTURE = PluginRequestCodes.FILE_CHOOSER_VIDEO_CAPTURE;\n     static final int FILE_CHOOSER_CAMERA_PERMISSION = PluginRequestCodes.FILE_CHOOSER_CAMERA_PERMISSION;\n     static final int GET_USER_MEDIA_PERMISSIONS = PluginRequestCodes.GET_USER_MEDIA_PERMISSIONS;\n+    static final int GEOLOCATION_REQUEST_PERMISSIONS = PluginRequestCodes.GEOLOCATION_REQUEST_PERMISSIONS;", "originalCommit": "2aa0d43db2c248bc2d5ba16a24d64f1c3593f7aa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2bc83aa50d5799f455901e1527b0a5bf46bdf22c", "chunk": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java b/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\nindex 5faaab23..e4d52b7d 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\n\n@@ -38,6 +38,7 @@ import org.json.JSONException;\n  * WebView instance.\n  */\n public class BridgeWebChromeClient extends WebChromeClient {\n+\n     static final int FILE_CHOOSER = PluginRequestCodes.FILE_CHOOSER;\n     static final int FILE_CHOOSER_IMAGE_CAPTURE = PluginRequestCodes.FILE_CHOOSER_IMAGE_CAPTURE;\n     static final int FILE_CHOOSER_VIDEO_CAPTURE = PluginRequestCodes.FILE_CHOOSER_VIDEO_CAPTURE;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0ODUwMQ==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r494348501", "bodyText": "This should only be called with the second param as true if the permissions are accepted, otherwise it should prompt for the permission and this shouldn't be called until the user accept (and pass true) or deny (and pass false).", "author": "jcesarmobile", "createdAt": "2020-09-24T14:06:03Z", "path": "android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java", "diffHunk": "@@ -261,11 +264,11 @@ public void onGeolocationPermissionsShowPrompt(String origin, GeolocationPermiss\n         // Set that we want geolocation perms for this origin\n         callback.invoke(origin, true, false);", "originalCommit": "2aa0d43db2c248bc2d5ba16a24d64f1c3593f7aa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyODIxMQ==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r494628211", "bodyText": "thanks nice catch. I think this was always just saying true regardless \ud83d\ude43", "author": "carlpoole", "createdAt": "2020-09-24T21:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0ODUwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a973f6ca2337fa8058bed9b29584cf8d42d2a13", "chunk": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java b/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\nindex 5faaab23..b32ea3b0 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/BridgeWebChromeClient.java\n\n@@ -261,17 +266,43 @@ public class BridgeWebChromeClient extends WebChromeClient {\n         super.onGeolocationPermissionsShowPrompt(origin, callback);\n         Logger.debug(\"onGeolocationPermissionsShowPrompt: DOING IT HERE FOR ORIGIN: \" + origin);\n \n-        // Set that we want geolocation perms for this origin\n-        callback.invoke(origin, true, false);\n-\n-        String[] geoPermissions = { Manifest.permission.ACCESS_COARSE_LOCATION, Manifest.permission.ACCESS_FINE_LOCATION };\n         if (!hasPermissions(geoPermissions)) {\n+            // save the callback and prompt for permissions\n+            geoLocationCallback = callback;\n+            geolocationRequestOrigin = origin;\n             requestPermissions(geoPermissions, GEOLOCATION_REQUEST_PERMISSIONS);\n         } else {\n+            // permission is already granted\n+            callback.invoke(origin, true, false);\n             Logger.debug(\"onGeolocationPermissionsShowPrompt: has required permission\");\n         }\n     }\n \n+    /**\n+     * Handle the browser geolocation permission prompt results\n+     * @param permissions\n+     * @param grantResults\n+     */\n+    @TargetApi(Build.VERSION_CODES.ECLAIR)\n+    public void onGeolocationPermissionsResult(String[] permissions, int[] grantResults) {\n+        List<String> list = Arrays.asList(permissions);\n+\n+        if (list.contains(geoPermissions[0]) || list.contains(geoPermissions[1])) {\n+            if (grantResults.length >= 1 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {\n+                if (geoLocationCallback != null && geolocationRequestOrigin != null) {\n+                    geoLocationCallback.invoke(geolocationRequestOrigin, true, false);\n+                }\n+            } else {\n+                if (geoLocationCallback != null) {\n+                    geoLocationCallback.invoke(geolocationRequestOrigin, false, false);\n+                }\n+            }\n+\n+            geoLocationCallback = null;\n+            geolocationRequestOrigin = null;\n+        }\n+    }\n+\n     @Override\n     public boolean onShowFileChooser(\n         WebView webView,\n"}}, {"oid": "6f3cf572b3867c3b89b4f4327aec70092c0346ff", "url": "https://github.com/ionic-team/capacitor/commit/6f3cf572b3867c3b89b4f4327aec70092c0346ff", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-09-24T21:44:53Z", "type": "commit"}, {"oid": "2bc83aa50d5799f455901e1527b0a5bf46bdf22c", "url": "https://github.com/ionic-team/capacitor/commit/2bc83aa50d5799f455901e1527b0a5bf46bdf22c", "message": "Merge in main", "committedDate": "2020-10-15T19:50:44Z", "type": "commit"}, {"oid": "836895cef6a9278aeb11ae5cf17154d8a1ab2a2b", "url": "https://github.com/ionic-team/capacitor/commit/836895cef6a9278aeb11ae5cf17154d8a1ab2a2b", "message": "Removed iOS Geolocation code", "committedDate": "2020-10-15T20:11:50Z", "type": "commit"}, {"oid": "4a973f6ca2337fa8058bed9b29584cf8d42d2a13", "url": "https://github.com/ionic-team/capacitor/commit/4a973f6ca2337fa8058bed9b29584cf8d42d2a13", "message": "Added proper request callback for web browser permission requests", "committedDate": "2020-10-16T15:25:20Z", "type": "commit"}, {"oid": "318aa519e6ef4ff611da6b8173bf8e96f0904556", "url": "https://github.com/ionic-team/capacitor/commit/318aa519e6ef4ff611da6b8173bf8e96f0904556", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-10-16T15:33:11Z", "type": "commit"}, {"oid": "fdfe9257dc875de96b589fc920daa22d03f2ea53", "url": "https://github.com/ionic-team/capacitor/commit/fdfe9257dc875de96b589fc920daa22d03f2ea53", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-10-19T16:06:15Z", "type": "commit"}, {"oid": "cd4c97d31bfa2b9c61aadd14c3e34f2f8a12df3a", "url": "https://github.com/ionic-team/capacitor/commit/cd4c97d31bfa2b9c61aadd14c3e34f2f8a12df3a", "message": "Merged in main", "committedDate": "2020-10-19T17:43:47Z", "type": "commit"}, {"oid": "1d411ebc94b46e6dc0d26e592207ae767e4791f3", "url": "https://github.com/ionic-team/capacitor/commit/1d411ebc94b46e6dc0d26e592207ae767e4791f3", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-10-19T22:59:47Z", "type": "commit"}, {"oid": "8ce7e7db0c93142e6403ec642fae527d0aef0928", "url": "https://github.com/ionic-team/capacitor/commit/8ce7e7db0c93142e6403ec642fae527d0aef0928", "message": "Merge branch 'main' into remove-geolocation", "committedDate": "2020-10-20T14:48:11Z", "type": "commit"}, {"oid": "a3ceaddcea9e979d31515c1b05ec3d56372f868c", "url": "https://github.com/ionic-team/capacitor/commit/a3ceaddcea9e979d31515c1b05ec3d56372f868c", "message": "fmt", "committedDate": "2020-10-20T17:21:55Z", "type": "commit"}, {"oid": "5bfb989da96b07d94d382b30ae679c58f2cdbbfe", "url": "https://github.com/ionic-team/capacitor/commit/5bfb989da96b07d94d382b30ae679c58f2cdbbfe", "message": "remove unused import", "committedDate": "2020-10-20T17:49:44Z", "type": "commit"}, {"oid": "fec082403aa44acf137613105903840503b17702", "url": "https://github.com/ionic-team/capacitor/commit/fec082403aa44acf137613105903840503b17702", "message": "remove ECLAIR check", "committedDate": "2020-10-20T18:08:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczNjcyMg==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r508736722", "bodyText": "the code should be unique, if you use the same on the geolocation plugin then only one of them will receive the response", "author": "jcesarmobile", "createdAt": "2020-10-20T18:11:10Z", "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -687,6 +687,11 @@ public void startActivityForPluginWithResult(PluginCall call, Intent intent, int\n      */\n \n     public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {\n+        if (requestCode == BridgeWebChromeClient.GEOLOCATION_REQUEST_PERMISSIONS) {", "originalCommit": "fec082403aa44acf137613105903840503b17702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczNzg5MA==", "url": "https://github.com/ionic-team/capacitor/pull/3467#discussion_r508737890", "bodyText": "Yeah. Will make sure it is different", "author": "carlpoole", "createdAt": "2020-10-20T18:12:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODczNjcyMg=="}], "type": "inlineReview", "revised_code": {"commit": "05dd7301242dc2ea296654070cef5cae5213b909", "chunk": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\nindex 4b4d7a92..de4ace53 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n\n@@ -687,11 +685,6 @@ public class Bridge {\n      */\n \n     public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {\n-        if (requestCode == BridgeWebChromeClient.GEOLOCATION_REQUEST_PERMISSIONS) {\n-            webChromeClient.onGeolocationPermissionsResult(permissions, grantResults);\n-            return;\n-        }\n-\n         PluginHandle plugin = getPluginWithRequestCode(requestCode);\n \n         if (plugin == null) {\n"}}, {"oid": "05dd7301242dc2ea296654070cef5cae5213b909", "url": "https://github.com/ionic-team/capacitor/commit/05dd7301242dc2ea296654070cef5cae5213b909", "message": "Switched to cordova plugin method", "committedDate": "2020-10-20T20:13:07Z", "type": "commit"}]}