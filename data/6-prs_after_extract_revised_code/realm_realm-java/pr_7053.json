{"pr_number": 7053, "pr_title": "Fix retrieval of null valued primitive property from dynamic realm", "pr_createdAt": "2020-08-24T08:28:41Z", "pr_url": "https://github.com/realm/realm-java/pull/7053", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzI5MA==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475437290", "bodyText": "You don't need to call refresh. It should be up to date when opened.", "author": "cmelchior", "createdAt": "2020-08-24T08:49:55Z", "path": "realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java", "diffHunk": "@@ -1727,4 +1727,23 @@ public void run() {\n         thread.start();\n         TestHelper.awaitOrFail(threadFinished);\n     }\n+\n+    @Test\n+    public void getNullableBoolean() {\n+        realm.executeTransaction(realm -> {\n+            AllJavaTypes object = realm.createObject(AllJavaTypes.class, 1000L);\n+            object.setFieldBoolean(null);\n+\n+            assertNull(object.isFieldBoolean());\n+        });\n+        realm.close();\n+\n+        DynamicRealm dynamicRealm = DynamicRealm.getInstance(realm.configuration);\n+        dynamicRealm.refresh();", "originalCommit": "a8fb00cf7c586ad9d7e89d0c302b8267d5243799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMDA4MQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475520081", "bodyText": "It does not work without it. Maybe symptom of another issue. The below sequence runs without asserting\nDynamicRealm dynamicRealm = DynamicRealm.getInstance(realm.configuration);\nassertEquals(1, dynamicRealm.where(\"AllJavaTypes\").count());\ndynamicRealm.refresh();\nassertEquals(2, dynamicRealm.where(\"AllJavaTypes\").count());", "author": "rorbech", "createdAt": "2020-08-24T10:59:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyMjAwNQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475522005", "bodyText": "Hmm, I don't like that. The underlying read transactions should not be shared between Realm and DynamicRealm. It indicates a bigger problem we need to look into. Probably some caching going wrong somewhere \ud83d\ude15", "author": "cmelchior", "createdAt": "2020-08-24T11:04:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUyNzc0Nw==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475527747", "bodyText": "Yes. A dynamic realm with the same configuration was already setup. Sorry.", "author": "rorbech", "createdAt": "2020-08-24T11:16:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzNzI5MA=="}], "type": "inlineReview", "revised_code": {"commit": "587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "chunk": "diff --git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\nindex 6844ce5ce..d4d584d6c 100644\n--- a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\n+++ b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\n\n@@ -1729,21 +1633,93 @@ public class DynamicRealmObjectTests {\n     }\n \n     @Test\n-    public void getNullableBoolean() {\n+    public void getNullableFields() {\n         realm.executeTransaction(realm -> {\n-            AllJavaTypes object = realm.createObject(AllJavaTypes.class, 1000L);\n-            object.setFieldBoolean(null);\n-\n-            assertNull(object.isFieldBoolean());\n+            NullablePrimitiveFields primitiveNullables = realm.createObject(NullablePrimitiveFields.class);\n+            primitiveNullables.setFieldBoolean(null);\n+\n+            assertNull(primitiveNullables.getFieldBoolean());\n+            assertNull(primitiveNullables.getFieldInt());\n+            assertNull(primitiveNullables.getFieldFloat());\n+            assertNull(primitiveNullables.getFieldDouble());\n+            assertNull(primitiveNullables.getFieldString());\n+            assertNull(primitiveNullables.getFieldBinary());\n+            assertNull(primitiveNullables.getFieldDate());\n+\n+            realm.delete(AllJavaTypes.class);\n+            AllJavaTypes allJavaTypes = realm.createObject(AllJavaTypes.class, UUID.randomUUID().getLeastSignificantBits());\n+\n+            assertNull(allJavaTypes.getFieldObject());\n+            allJavaTypes.getFieldBooleanList().add(null);\n+            allJavaTypes.getFieldIntegerList().add(null);\n+            allJavaTypes.getFieldFloatList().add(null);\n+            allJavaTypes.getFieldDoubleList().add(null);\n+            allJavaTypes.getFieldStringList().add(null);\n+            allJavaTypes.getFieldBinaryList().add(null);\n+            allJavaTypes.getFieldDateList().add(null);\n         });\n         realm.close();\n-\n-        DynamicRealm dynamicRealm = DynamicRealm.getInstance(realm.configuration);\n         dynamicRealm.refresh();\n-        DynamicRealmObject object = dynamicRealm.where(\"AllJavaTypes\").isNull(\"fieldBoolean\").findFirst();\n \n-        assertNull(object.get(\"fieldBoolean\"));\n+        DynamicRealmObject primitiveNullables = dynamicRealm.where(NullablePrimitiveFields.CLASS_NAME).findFirst();\n+        DynamicRealmObject allJavaTypes = dynamicRealm.where(AllJavaTypes.CLASS_NAME).findFirst();\n \n+        for (RealmFieldType value : RealmFieldType.values()) {\n+            switch (value) {\n+                case INTEGER:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_INT));\n+                    break;\n+                case BOOLEAN:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_BOOLEAN));\n+                    break;\n+                case STRING:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_STRING));\n+                    break;\n+                case BINARY:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_BINARY));\n+                    break;\n+                case DATE:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_DATE));\n+                    break;\n+                case FLOAT:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_FLOAT));\n+                    break;\n+                case DOUBLE:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_DOUBLE));\n+                    break;\n+                case OBJECT:\n+                    assertNull(allJavaTypes.get(AllJavaTypes.FIELD_OBJECT));\n+                    break;\n+                case INTEGER_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_INTEGER_LIST, Integer.class).get(0));\n+                    break;\n+                case BOOLEAN_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_BOOLEAN_LIST, Boolean.class).get(0));\n+                    break;\n+                case STRING_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_STRING_LIST, String.class).get(0));\n+                    break;\n+                case BINARY_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_BINARY_LIST, byte[].class).get(0));\n+                    break;\n+                case DATE_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_DATE_LIST, Date.class).get(0));\n+                    break;\n+                case FLOAT_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_FLOAT_LIST, Float.class).get(0));\n+                    break;\n+                case DOUBLE_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_DOUBLE_LIST, Double.class).get(0));\n+                    break;\n+                case LIST:\n+                case LINKING_OBJECTS:\n+                    // Realm lists and back links cannot be null\n+                    break;\n+                default:\n+                    fail(\"Not testing all types\");\n+            }\n+        }\n         dynamicRealm.close();\n     }\n+\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzODMxMQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475438311", "bodyText": "This seems to impact more than just null values, so we should have unit tests for all the data types.", "author": "cmelchior", "createdAt": "2020-08-24T08:51:40Z", "path": "realm/realm-library/src/main/java/io/realm/DynamicRealmObject.java", "diffHunk": "@@ -97,6 +97,9 @@ public DynamicRealmObject(RealmModel obj) {\n         proxyState.getRealm$realm().checkIfValid();\n \n         long columnKey = proxyState.getRow$realm().getColumnKey(fieldName);\n+        if (proxyState.getRow$realm().isNull(columnKey)) {", "originalCommit": "a8fb00cf7c586ad9d7e89d0c302b8267d5243799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNTQ1MQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r478425451", "bodyText": "Implemented tests for null values for all types, but I would assume all-non null values to be sufficiently test by existing tests. Or what are you missing specifically?", "author": "rorbech", "createdAt": "2020-08-27T13:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzODMxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMzI4MQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r482923281", "bodyText": "No, those tests should be fine", "author": "cmelchior", "createdAt": "2020-09-03T11:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzODMxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQzODU5NA==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r475438594", "bodyText": "The fix seems to indicate the bug impacted all primitive types. We should have tests for all of them instead of just boolean.", "author": "cmelchior", "createdAt": "2020-08-24T08:52:11Z", "path": "realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java", "diffHunk": "@@ -1727,4 +1727,23 @@ public void run() {\n         thread.start();\n         TestHelper.awaitOrFail(threadFinished);\n     }\n+\n+    @Test\n+    public void getNullableBoolean() {", "originalCommit": "a8fb00cf7c586ad9d7e89d0c302b8267d5243799", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "chunk": "diff --git a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\nindex 6844ce5ce..d4d584d6c 100644\n--- a/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\n+++ b/realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java\n\n@@ -1729,21 +1633,93 @@ public class DynamicRealmObjectTests {\n     }\n \n     @Test\n-    public void getNullableBoolean() {\n+    public void getNullableFields() {\n         realm.executeTransaction(realm -> {\n-            AllJavaTypes object = realm.createObject(AllJavaTypes.class, 1000L);\n-            object.setFieldBoolean(null);\n-\n-            assertNull(object.isFieldBoolean());\n+            NullablePrimitiveFields primitiveNullables = realm.createObject(NullablePrimitiveFields.class);\n+            primitiveNullables.setFieldBoolean(null);\n+\n+            assertNull(primitiveNullables.getFieldBoolean());\n+            assertNull(primitiveNullables.getFieldInt());\n+            assertNull(primitiveNullables.getFieldFloat());\n+            assertNull(primitiveNullables.getFieldDouble());\n+            assertNull(primitiveNullables.getFieldString());\n+            assertNull(primitiveNullables.getFieldBinary());\n+            assertNull(primitiveNullables.getFieldDate());\n+\n+            realm.delete(AllJavaTypes.class);\n+            AllJavaTypes allJavaTypes = realm.createObject(AllJavaTypes.class, UUID.randomUUID().getLeastSignificantBits());\n+\n+            assertNull(allJavaTypes.getFieldObject());\n+            allJavaTypes.getFieldBooleanList().add(null);\n+            allJavaTypes.getFieldIntegerList().add(null);\n+            allJavaTypes.getFieldFloatList().add(null);\n+            allJavaTypes.getFieldDoubleList().add(null);\n+            allJavaTypes.getFieldStringList().add(null);\n+            allJavaTypes.getFieldBinaryList().add(null);\n+            allJavaTypes.getFieldDateList().add(null);\n         });\n         realm.close();\n-\n-        DynamicRealm dynamicRealm = DynamicRealm.getInstance(realm.configuration);\n         dynamicRealm.refresh();\n-        DynamicRealmObject object = dynamicRealm.where(\"AllJavaTypes\").isNull(\"fieldBoolean\").findFirst();\n \n-        assertNull(object.get(\"fieldBoolean\"));\n+        DynamicRealmObject primitiveNullables = dynamicRealm.where(NullablePrimitiveFields.CLASS_NAME).findFirst();\n+        DynamicRealmObject allJavaTypes = dynamicRealm.where(AllJavaTypes.CLASS_NAME).findFirst();\n \n+        for (RealmFieldType value : RealmFieldType.values()) {\n+            switch (value) {\n+                case INTEGER:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_INT));\n+                    break;\n+                case BOOLEAN:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_BOOLEAN));\n+                    break;\n+                case STRING:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_STRING));\n+                    break;\n+                case BINARY:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_BINARY));\n+                    break;\n+                case DATE:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_DATE));\n+                    break;\n+                case FLOAT:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_FLOAT));\n+                    break;\n+                case DOUBLE:\n+                    assertNull(primitiveNullables.get(NullablePrimitiveFields.FIELD_DOUBLE));\n+                    break;\n+                case OBJECT:\n+                    assertNull(allJavaTypes.get(AllJavaTypes.FIELD_OBJECT));\n+                    break;\n+                case INTEGER_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_INTEGER_LIST, Integer.class).get(0));\n+                    break;\n+                case BOOLEAN_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_BOOLEAN_LIST, Boolean.class).get(0));\n+                    break;\n+                case STRING_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_STRING_LIST, String.class).get(0));\n+                    break;\n+                case BINARY_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_BINARY_LIST, byte[].class).get(0));\n+                    break;\n+                case DATE_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_DATE_LIST, Date.class).get(0));\n+                    break;\n+                case FLOAT_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_FLOAT_LIST, Float.class).get(0));\n+                    break;\n+                case DOUBLE_LIST:\n+                    assertNull(allJavaTypes.getList(AllJavaTypes.FIELD_DOUBLE_LIST, Double.class).get(0));\n+                    break;\n+                case LIST:\n+                case LINKING_OBJECTS:\n+                    // Realm lists and back links cannot be null\n+                    break;\n+                default:\n+                    fail(\"Not testing all types\");\n+            }\n+        }\n         dynamicRealm.close();\n     }\n+\n }\n"}}, {"oid": "8cc0cb4dc44335bab0aaf61670497dfe4fbdfe0b", "url": "https://github.com/realm/realm-java/commit/8cc0cb4dc44335bab0aaf61670497dfe4fbdfe0b", "message": "Fix retrieval of null valued primitive property from dynamic realm", "committedDate": "2020-08-24T10:41:12Z", "type": "commit"}, {"oid": "8cc0cb4dc44335bab0aaf61670497dfe4fbdfe0b", "url": "https://github.com/realm/realm-java/commit/8cc0cb4dc44335bab0aaf61670497dfe4fbdfe0b", "message": "Fix retrieval of null valued primitive property from dynamic realm", "committedDate": "2020-08-24T10:41:12Z", "type": "forcePushed"}, {"oid": "587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "url": "https://github.com/realm/realm-java/commit/587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "message": "Testing retrieval of null values for all types", "committedDate": "2020-08-27T13:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMTM4NQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r482921385", "bodyText": "These tests do not seem related in a test named getNullableFields Lists can never be null and I hope that adding null is tested elsewhere, if not, it should probably be in its own test?", "author": "cmelchior", "createdAt": "2020-09-03T11:56:30Z", "path": "realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java", "diffHunk": "@@ -1629,4 +1631,95 @@ public void run() {\n         thread.start();\n         TestHelper.awaitOrFail(threadFinished);\n     }\n+\n+    @Test\n+    public void getNullableFields() {\n+        realm.executeTransaction(realm -> {\n+            NullablePrimitiveFields primitiveNullables = realm.createObject(NullablePrimitiveFields.class);\n+            primitiveNullables.setFieldBoolean(null);\n+\n+            assertNull(primitiveNullables.getFieldBoolean());\n+            assertNull(primitiveNullables.getFieldInt());\n+            assertNull(primitiveNullables.getFieldFloat());\n+            assertNull(primitiveNullables.getFieldDouble());\n+            assertNull(primitiveNullables.getFieldString());\n+            assertNull(primitiveNullables.getFieldBinary());\n+            assertNull(primitiveNullables.getFieldDate());\n+\n+            realm.delete(AllJavaTypes.class);\n+            AllJavaTypes allJavaTypes = realm.createObject(AllJavaTypes.class, UUID.randomUUID().getLeastSignificantBits());\n+\n+            assertNull(allJavaTypes.getFieldObject());\n+            allJavaTypes.getFieldBooleanList().add(null);", "originalCommit": "587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ3NDQxMQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r484474411", "bodyText": "The issue was that we could not return null values for nullable fields from a dynamic realm. I thought it would be safest to also included a check of retrieving a null value from a list from a dynamic realm. I could try to find another place for the test...or update the name of the test to getNullForNullables ... ?", "author": "rorbech", "createdAt": "2020-09-07T14:46:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMTM4NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMjY1NA==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r482922654", "bodyText": "all of these should be tested below?", "author": "cmelchior", "createdAt": "2020-09-03T11:58:48Z", "path": "realm/realm-library/src/androidTest/java/io/realm/DynamicRealmObjectTests.java", "diffHunk": "@@ -1629,4 +1631,95 @@ public void run() {\n         thread.start();\n         TestHelper.awaitOrFail(threadFinished);\n     }\n+\n+    @Test\n+    public void getNullableFields() {\n+        realm.executeTransaction(realm -> {\n+            NullablePrimitiveFields primitiveNullables = realm.createObject(NullablePrimitiveFields.class);\n+            primitiveNullables.setFieldBoolean(null);\n+\n+            assertNull(primitiveNullables.getFieldBoolean());", "originalCommit": "587a7a4b7597393b0a68ca1bfff03e8f5029f2f9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ3NTA4MQ==", "url": "https://github.com/realm/realm-java/pull/7053#discussion_r484475081", "bodyText": "Yes. I was just asserting that they were actually null when retrieved from the typed realm.", "author": "rorbech", "createdAt": "2020-09-07T14:47:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyMjY1NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bbd78cb5a0d977bc612d493b2209390cce0a4499", "url": "https://github.com/realm/realm-java/commit/bbd78cb5a0d977bc612d493b2209390cce0a4499", "message": "Update CHANGELOG.md\n\nCo-authored-by: Christian Melchior <christian@ilios.dk>", "committedDate": "2020-09-03T13:16:20Z", "type": "commit"}]}