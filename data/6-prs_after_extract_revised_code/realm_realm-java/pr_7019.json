{"pr_number": 7019, "pr_title": "Correctly refresh Java connections", "pr_createdAt": "2020-08-06T14:45:11Z", "pr_url": "https://github.com/realm/realm-java/pull/7019", "timeline": [{"oid": "6ae3c2be3e09e783d9576f6931c92f0cd23999da", "url": "https://github.com/realm/realm-java/commit/6ae3c2be3e09e783d9576f6931c92f0cd23999da", "message": "SyncManager.refreshConnections() should also refresh Java network requests.", "committedDate": "2020-08-06T14:40:12Z", "type": "commit"}, {"oid": "c4cf7c2203eb39c22350719e2b337d478bde2774", "url": "https://github.com/realm/realm-java/commit/c4cf7c2203eb39c22350719e2b337d478bde2774", "message": "Add missing file", "committedDate": "2020-08-06T15:12:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjEwNw==", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r466526107", "bodyText": "Shouldn't this be  synchronized on the SyncSession instance? Is it not reachable from user code through SyncManager.refreshConnection?", "author": "rorbech", "createdAt": "2020-08-06T16:12:15Z", "path": "realm/realm-library/src/objectServer/java/io/realm/SyncSession.java", "diffHunk": "@@ -888,26 +896,43 @@ protected void onSuccess(AuthenticateResponse response) {\n                             scheduleRefreshAccessToken(authServer, response.getAccessToken().expiresMs());\n                         }\n                     }\n+                    refreshTokenNetworkRequest = null;\n                 }\n             }\n \n             @Override\n             protected void onError(AuthenticateResponse response) {\n                 if (!isClosed && !Thread.currentThread().isInterrupted()) {\n                     onGoingAccessTokenQuery.set(false);\n-                    RealmLog.error(\"Unrecoverable error, while refreshing the access Token (\" + response.getError().toString() + \") reschedule will not happen\");\n+                    RealmLog.debug(\"Session[%s]: Unrecoverable error, while refreshing the access Token. Reschedule will not happen. %s\", configuration.getPath(), response.getError());\n                 }\n+                refreshTokenNetworkRequest = null;\n+            }\n+\n+            @Override\n+            protected String getName() {\n+                return taskName;\n             }\n-        });\n-        refreshTokenNetworkRequest = new RealmAsyncTaskImpl(task, SyncManager.NETWORK_POOL_EXECUTOR);\n+        }, SyncManager.NETWORK_POOL_EXECUTOR);\n+    }\n+\n+    void refreshConnection() {", "originalCommit": "c4cf7c2203eb39c22350719e2b337d478bde2774", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkwODE3MA==", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r466908170", "bodyText": "Yup. Good catch", "author": "cmelchior", "createdAt": "2020-08-07T08:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNjEwNw=="}], "type": "inlineReview", "revised_code": {"commit": "192624bac054dc7d94b953f68de88e36d2d3d323", "chunk": "diff --git a/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java b/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java\nindex 12037bd32..1ec529dc7 100644\n--- a/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java\n+++ b/realm/realm-library/src/objectServer/java/io/realm/SyncSession.java\n\n@@ -916,7 +916,7 @@ public class SyncSession {\n         }, SyncManager.NETWORK_POOL_EXECUTOR);\n     }\n \n-    void refreshConnection() {\n+    synchronized void refreshConnection() {\n         if (networkRequest != null) {\n             networkRequest.resetTask();\n         }\n"}}, {"oid": "192624bac054dc7d94b953f68de88e36d2d3d323", "url": "https://github.com/realm/realm-java/commit/192624bac054dc7d94b953f68de88e36d2d3d323", "message": "Correctly synchronize access to Session", "committedDate": "2020-08-07T08:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMjcyNQ==", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r466922725", "bodyText": "Not sure that I have the full overview of all execution paths, but seems like refreshTokenNetworkRequest could have been cleared in the meantime, so should be checked for null?", "author": "rorbech", "createdAt": "2020-08-07T09:15:52Z", "path": "realm/realm-library/src/objectServer/java/io/realm/SyncSession.java", "diffHunk": "@@ -873,7 +881,7 @@ protected AuthenticateResponse execute() {\n             protected void onSuccess(AuthenticateResponse response) {\n                 synchronized (SyncSession.this) {\n                     if (!isClosed && !Thread.currentThread().isInterrupted() && !refreshTokenNetworkRequest.isCancelled()) {", "originalCommit": "192624bac054dc7d94b953f68de88e36d2d3d323", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk5MDk1Mw==", "url": "https://github.com/realm/realm-java/pull/7019#discussion_r469990953", "bodyText": "Looking into it. This should be covered by isClosed which is set to true before setting the refreshTokenNetworkRequest to null. So it should be safe.", "author": "cmelchior", "createdAt": "2020-08-13T14:24:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkyMjcyNQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "bd30507c718c7754495ca1bcc5cd395fa3e77983", "url": "https://github.com/realm/realm-java/commit/bd30507c718c7754495ca1bcc5cd395fa3e77983", "message": "Backport CI changes to master/releases branch in order to use emulators", "committedDate": "2020-08-07T13:33:16Z", "type": "commit"}, {"oid": "afd777208aa864a3d9a4f05c439f504cb0e3fb20", "url": "https://github.com/realm/realm-java/commit/afd777208aa864a3d9a4f05c439f504cb0e3fb20", "message": "Downgrade android version to match", "committedDate": "2020-08-07T13:59:54Z", "type": "commit"}, {"oid": "8cf7c500d3ae74ba52c10f3404ff5d8ed1be6c84", "url": "https://github.com/realm/realm-java/commit/8cf7c500d3ae74ba52c10f3404ff5d8ed1be6c84", "message": "Set NDK version correctly", "committedDate": "2020-08-07T16:56:48Z", "type": "commit"}, {"oid": "65da5b5dc357889b09b490fd4e93744a1385a9b9", "url": "https://github.com/realm/realm-java/commit/65da5b5dc357889b09b490fd4e93744a1385a9b9", "message": "Update dependencies", "committedDate": "2020-08-10T07:55:20Z", "type": "commit"}, {"oid": "6ce75ca159e15d372e97caa9018a538fb61b4882", "url": "https://github.com/realm/realm-java/commit/6ce75ca159e15d372e97caa9018a538fb61b4882", "message": "Remove NDK check", "committedDate": "2020-08-10T08:29:54Z", "type": "commit"}, {"oid": "9b06ba47806b07debae0e98e57c59bffe3f3234b", "url": "https://github.com/realm/realm-java/commit/9b06ba47806b07debae0e98e57c59bffe3f3234b", "message": "Add CMake changes", "committedDate": "2020-08-10T12:50:45Z", "type": "commit"}, {"oid": "c1bb0c72e281f0f80f4a2d648a6e7f2bd0915af1", "url": "https://github.com/realm/realm-java/commit/c1bb0c72e281f0f80f4a2d648a6e7f2bd0915af1", "message": "Fix source code ref", "committedDate": "2020-08-10T12:58:03Z", "type": "commit"}, {"oid": "7dec2224f4201f995f9aa86e08a3ec831d604b1d", "url": "https://github.com/realm/realm-java/commit/7dec2224f4201f995f9aa86e08a3ec831d604b1d", "message": "Fix Gradle Plugin tests", "committedDate": "2020-08-10T13:46:31Z", "type": "commit"}, {"oid": "c1225ae52f19f008cce9cbc5824913f1e779de46", "url": "https://github.com/realm/realm-java/commit/c1225ae52f19f008cce9cbc5824913f1e779de46", "message": "Disable unit test example", "committedDate": "2020-08-10T13:51:39Z", "type": "commit"}, {"oid": "3e52535700c7d20ab712cfa273638ed84cbcbf7c", "url": "https://github.com/realm/realm-java/commit/3e52535700c7d20ab712cfa273638ed84cbcbf7c", "message": "Fix annotation processor tests", "committedDate": "2020-08-10T14:36:05Z", "type": "commit"}, {"oid": "6e55ce376953583f052a1b128827e968470b3e03", "url": "https://github.com/realm/realm-java/commit/6e55ce376953583f052a1b128827e968470b3e03", "message": "Disable test classes for FindBugs", "committedDate": "2020-08-10T15:01:35Z", "type": "commit"}, {"oid": "5b37492ee8b26e0dc5e580a663e2b6f8f75a94e8", "url": "https://github.com/realm/realm-java/commit/5b37492ee8b26e0dc5e580a663e2b6f8f75a94e8", "message": "Ignore proxy classes", "committedDate": "2020-08-10T15:15:25Z", "type": "commit"}, {"oid": "6455297b05bdc9843e1fa40f2c33a6edcafb20bb", "url": "https://github.com/realm/realm-java/commit/6455297b05bdc9843e1fa40f2c33a6edcafb20bb", "message": "Ignore test model classes", "committedDate": "2020-08-10T15:28:17Z", "type": "commit"}, {"oid": "5fd06889dc057dd1bae3612795f96675cf7a95f2", "url": "https://github.com/realm/realm-java/commit/5fd06889dc057dd1bae3612795f96675cf7a95f2", "message": "Fix Findbugs warnings", "committedDate": "2020-08-11T11:42:09Z", "type": "commit"}, {"oid": "3153c672f44b1cb0cfc90dae20c1f65a37038ae4", "url": "https://github.com/realm/realm-java/commit/3153c672f44b1cb0cfc90dae20c1f65a37038ae4", "message": "Delete unused class", "committedDate": "2020-08-11T12:11:17Z", "type": "commit"}, {"oid": "c846d1941064a3d5aeff830df3555a4e3b6fa4b1", "url": "https://github.com/realm/realm-java/commit/c846d1941064a3d5aeff830df3555a4e3b6fa4b1", "message": "Disable PMD", "committedDate": "2020-08-12T11:14:48Z", "type": "commit"}, {"oid": "3afeb5d76310fb63725eb5450ab7a265e0310d66", "url": "https://github.com/realm/realm-java/commit/3afeb5d76310fb63725eb5450ab7a265e0310d66", "message": "Disable PMD file upload", "committedDate": "2020-08-12T14:30:44Z", "type": "commit"}, {"oid": "f9719698d0d9cd3917d5fb858827072031866f89", "url": "https://github.com/realm/realm-java/commit/f9719698d0d9cd3917d5fb858827072031866f89", "message": "Fix storing server logs", "committedDate": "2020-08-13T08:16:26Z", "type": "commit"}]}