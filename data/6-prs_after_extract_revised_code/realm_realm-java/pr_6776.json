{"pr_number": 6776, "pr_title": "Fix ProgressListeners for Core 6", "pr_createdAt": "2020-03-14T13:46:05Z", "pr_url": "https://github.com/realm/realm-java/pull/6776", "timeline": [{"oid": "97f17c0bfa763ad4334ea53e2958d2db28452120", "url": "https://github.com/realm/realm-java/commit/97f17c0bfa763ad4334ea53e2958d2db28452120", "message": "Fix progress listeners", "committedDate": "2020-03-14T13:44:57Z", "type": "commit"}, {"oid": "ce64f7b6210f89410f4af181240145b446c1ff36", "url": "https://github.com/realm/realm-java/commit/ce64f7b6210f89410f4af181240145b446c1ff36", "message": "Add debug logging to tests", "committedDate": "2020-03-14T18:38:28Z", "type": "commit"}, {"oid": "c78abec9fc915afbfdb9c6e29224b33ad5d5a556", "url": "https://github.com/realm/realm-java/commit/c78abec9fc915afbfdb9c6e29224b33ad5d5a556", "message": "More logs", "committedDate": "2020-03-14T18:40:39Z", "type": "commit"}, {"oid": "59336dbab8ce2a02704b80529ddc211f62905ae8", "url": "https://github.com/realm/realm-java/commit/59336dbab8ce2a02704b80529ddc211f62905ae8", "message": "More logs", "committedDate": "2020-03-14T20:02:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxODg2Mw==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r392618863", "bodyText": "Should be local", "author": "Zhuinden", "createdAt": "2020-03-14T21:00:27Z", "path": "realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java", "diffHunk": "@@ -99,6 +99,8 @@ private void disposeSuccessfulTest(BaseRealm testRealm) {\n                 @Override\n                 public void run() {\n                     // Wait for Subscription to dispose of external resources\n+                    RealmLog.error(\"Global: \" + Realm.getGlobalInstanceCount(testRealm.getConfiguration()));\n+                    RealmLog.error(\"Local: \" + Realm.getGlobalInstanceCount(testRealm.getConfiguration()));", "originalCommit": "ce64f7b6210f89410f4af181240145b446c1ff36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxOTExMQ==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r392619111", "bodyText": "Yeah, I already fixed it. Trying to locate a bug that only manifest on CI. 20 minute roundtrip times when debugging is fun...or something \ud83d\ude06", "author": "cmelchior", "createdAt": "2020-03-14T21:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjYxODg2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3749ae993b82eca082338f175e51b811376616d8", "chunk": "diff --git a/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java b/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\nindex f4b7ef39d..ee6d247b0 100644\n--- a/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\n+++ b/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\n\n@@ -99,8 +99,8 @@ public class RxJavaTests {\n                 @Override\n                 public void run() {\n                     // Wait for Subscription to dispose of external resources\n-                    RealmLog.error(\"Global: \" + Realm.getGlobalInstanceCount(testRealm.getConfiguration()));\n-                    RealmLog.error(\"Local: \" + Realm.getGlobalInstanceCount(testRealm.getConfiguration()));\n+                    RealmLog.error(\"CloseTest-Global: \" + Realm.getGlobalInstanceCount(testRealm.getConfiguration()));\n+                    RealmLog.error(\"CloseTest-Local: \" + Realm.getLocalInstanceCount(testRealm.getConfiguration()));\n                     if (Realm.getGlobalInstanceCount(testRealm.getConfiguration()) == 0) {\n                         looperThread.testComplete();\n                     } else {\n"}}, {"oid": "3749ae993b82eca082338f175e51b811376616d8", "url": "https://github.com/realm/realm-java/commit/3749ae993b82eca082338f175e51b811376616d8", "message": "More debug logs", "committedDate": "2020-03-14T21:23:58Z", "type": "commit"}, {"oid": "78314cd858b1992ac5c3da709b1e00e71b504810", "url": "https://github.com/realm/realm-java/commit/78314cd858b1992ac5c3da709b1e00e71b504810", "message": "Fix wrong object test. PendingRows are invalid. Check Realm instead.", "committedDate": "2020-03-14T22:44:48Z", "type": "commit"}, {"oid": "f9c36d153bb70bd6ed67e138cc2e67c8bd49c579", "url": "https://github.com/realm/realm-java/commit/f9c36d153bb70bd6ed67e138cc2e67c8bd49c579", "message": "Fix broken unit test", "committedDate": "2020-03-15T10:53:34Z", "type": "commit"}, {"oid": "7432181d8f2dbf81617d05cd5fdb9d51a9a42ddd", "url": "https://github.com/realm/realm-java/commit/7432181d8f2dbf81617d05cd5fdb9d51a9a42ddd", "message": "Fix test", "committedDate": "2020-03-15T13:09:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3Mjk2OQ==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r392672969", "bodyText": "Is it not possible to use Realm.refresh() here?", "author": "Zhuinden", "createdAt": "2020-03-15T13:17:38Z", "path": "realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java", "diffHunk": "@@ -247,8 +247,17 @@ public void findFirstAsync_emittedOnSubscribe() {\n         final AllTypes asyncObj = realm.where(AllTypes.class).findFirstAsync();\n         subscription = asyncObj.<AllTypes>asFlowable().subscribe(rxObject -> {\n             assertTrue(rxObject.isFrozen());\n+            // Because the subscription is run asynchronously. There is a chance\n+            // the query resolved before the subscription triggers.\n+            // This means it is not deterministic what state is first emitted here.\n+            // It can either be a fully loaded object or one that is still loading.\n             assertFalse(rxObject.isValid());\n-            assertFalse(rxObject.isLoaded());\n+            if (rxObject.isLoaded()) {", "originalCommit": "7432181d8f2dbf81617d05cd5fdb9d51a9a42ddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3MzE3MA==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r392673170", "bodyText": "Yes, that would actually also have worked. Might make for a cleaner test \ud83d\udc4d", "author": "cmelchior", "createdAt": "2020-03-15T13:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3Mjk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTMzMg==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r392679332", "bodyText": "Ups, to fast there. refresh() doesn't work on frozen objects which we emit as the default now.", "author": "cmelchior", "createdAt": "2020-03-15T14:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3Mjk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMjM0Ng==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r394032346", "bodyText": "Maybe realmObject.load()? \ud83e\udd14", "author": "Zhuinden", "createdAt": "2020-03-17T23:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3Mjk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0MjYzNw==", "url": "https://github.com/realm/realm-java/pull/6776#discussion_r394242637", "bodyText": "No, that doesn't work either. It isn't possible to change the state of frozen objects.\nThe only thing we can do is not emitting unloaded objects, which has to be filtered in the RealmObservableFactory.\nThe issue is that both findFirstAsync and subscribe are now asynchronous. Previously, subscribe was synchronous so you always knew that the first emission was an unloaded object.", "author": "cmelchior", "createdAt": "2020-03-18T10:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3Mjk2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cb40a6ee040a8ac91e509617936b8363aa08b2b8", "chunk": "diff --git a/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java b/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\nindex 006f8d878..c761c382a 100644\n--- a/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\n+++ b/realm/realm-library/src/androidTest/java/io/realm/RxJavaTests.java\n\n@@ -251,7 +251,6 @@ public class RxJavaTests {\n             // the query resolved before the subscription triggers.\n             // This means it is not deterministic what state is first emitted here.\n             // It can either be a fully loaded object or one that is still loading.\n-            assertFalse(rxObject.isValid());\n             if (rxObject.isLoaded()) {\n                 assertTrue(rxObject.isValid());\n                 assertEquals(42, rxObject.getColumnLong());\n"}}, {"oid": "cb40a6ee040a8ac91e509617936b8363aa08b2b8", "url": "https://github.com/realm/realm-java/commit/cb40a6ee040a8ac91e509617936b8363aa08b2b8", "message": "Ups, forgot to remove assert", "committedDate": "2020-03-15T13:55:43Z", "type": "commit"}, {"oid": "1ed83c9deea35502e8a4624674c38b0e8e998648", "url": "https://github.com/realm/realm-java/commit/1ed83c9deea35502e8a4624674c38b0e8e998648", "message": "Other test fixes", "committedDate": "2020-03-15T14:27:22Z", "type": "commit"}, {"oid": "272c64f9f0e003dda375310c4618e5135612aa9f", "url": "https://github.com/realm/realm-java/commit/272c64f9f0e003dda375310c4618e5135612aa9f", "message": "Fix stupid", "committedDate": "2020-03-15T17:17:26Z", "type": "commit"}, {"oid": "7bbab5037db30fc71154139c7a4c3413f31118c3", "url": "https://github.com/realm/realm-java/commit/7bbab5037db30fc71154139c7a4c3413f31118c3", "message": "Bump test timeouts", "committedDate": "2020-03-17T19:27:41Z", "type": "commit"}, {"oid": "438e6ed68428cd0985413c43aa03f1464b47b475", "url": "https://github.com/realm/realm-java/commit/438e6ed68428cd0985413c43aa03f1464b47b475", "message": "Use async transaction", "committedDate": "2020-03-18T07:22:37Z", "type": "commit"}, {"oid": "1d36760408c28c10a5fe27d644769c3f064da318", "url": "https://github.com/realm/realm-java/commit/1d36760408c28c10a5fe27d644769c3f064da318", "message": "Disable tests", "committedDate": "2020-03-18T10:18:24Z", "type": "commit"}, {"oid": "6e814a0c1cd145f20c43b113d0bb04fd10c9f445", "url": "https://github.com/realm/realm-java/commit/6e814a0c1cd145f20c43b113d0bb04fd10c9f445", "message": "Fix ROS not starting", "committedDate": "2020-03-19T10:26:59Z", "type": "commit"}, {"oid": "b996c13be5b0f0b20eaa50445aed2b08144396a8", "url": "https://github.com/realm/realm-java/commit/b996c13be5b0f0b20eaa50445aed2b08144396a8", "message": "Fix test", "committedDate": "2020-03-19T11:38:20Z", "type": "commit"}, {"oid": "53c54136b83433e127e8ef1f28201eb7d1f3297a", "url": "https://github.com/realm/realm-java/commit/53c54136b83433e127e8ef1f28201eb7d1f3297a", "message": "Update build tools used by Docker on Jenkins", "committedDate": "2020-03-19T12:23:37Z", "type": "commit"}, {"oid": "6325f73ca536d54d786beb93d1d655675c3cd150", "url": "https://github.com/realm/realm-java/commit/6325f73ca536d54d786beb93d1d655675c3cd150", "message": "Fix Jenkins", "committedDate": "2020-03-19T12:30:26Z", "type": "commit"}, {"oid": "f0e4ac1757de1d0dbe0a45d8b475420a89edaf40", "url": "https://github.com/realm/realm-java/commit/f0e4ac1757de1d0dbe0a45d8b475420a89edaf40", "message": "Use Android-29", "committedDate": "2020-03-19T12:32:33Z", "type": "commit"}]}