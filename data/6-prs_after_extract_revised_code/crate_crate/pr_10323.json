{"pr_number": 10323, "pr_title": "Expose retention leases in sys.shards ", "pr_createdAt": "2020-08-07T12:35:42Z", "pr_url": "https://github.com/crate/crate/pull/10323", "timeline": [{"oid": "c88c40eb5368055352d4bdee279e27ff20e02834", "url": "https://github.com/crate/crate/commit/c88c40eb5368055352d4bdee279e27ff20e02834", "message": "bp: Expose retention leases in shard stats\n\nhttps://github.com/elastic/elasticsearch/commit/6500b0cbd78a0e3968ecb54a33b59a2325059ff9", "committedDate": "2020-08-07T12:25:19Z", "type": "commit"}, {"oid": "f57a5483aa9d70710883cca3b3f74114fd5f8578", "url": "https://github.com/crate/crate/commit/f57a5483aa9d70710883cca3b3f74114fd5f8578", "message": "WIP: bp: Introduce retention lease actions\n\nhttps://github.com/elastic/elasticsearch/commit/bbe990f86275ed6d696681afc636d940ddf49d26", "committedDate": "2020-08-10T07:51:11Z", "type": "forcePushed"}, {"oid": "7456efd8b1c6d89ed35c36fedf26e2ff1dbf29a9", "url": "https://github.com/crate/crate/commit/7456efd8b1c6d89ed35c36fedf26e2ff1dbf29a9", "message": "bp: Introduce retention lease actions\n\nhttps://github.com/elastic/elasticsearch/commit/bbe990f86275ed6d696681afc636d940ddf49d26\n\nThis only contains the `IndexShard` and `RecoverySourceHandler` changes,\nnot the actual actions because they're \"only\" used for CCR in ES.", "committedDate": "2020-08-10T08:04:52Z", "type": "forcePushed"}, {"oid": "69a0be7a02517107146b776518ff638c3052ce58", "url": "https://github.com/crate/crate/commit/69a0be7a02517107146b776518ff638c3052ce58", "message": "Expose retention leases in sys.shards", "committedDate": "2020-08-10T08:26:00Z", "type": "commit"}, {"oid": "19877ee56f0706c013e8f9e37a8813ebcfb0d920", "url": "https://github.com/crate/crate/commit/19877ee56f0706c013e8f9e37a8813ebcfb0d920", "message": "bp: Introduce retention lease actions\n\nhttps://github.com/elastic/elasticsearch/commit/bbe990f86275ed6d696681afc636d940ddf49d26\n\nThis only contains the `IndexShard` and `RecoverySourceHandler` changes,\nnot the actual actions because they're \"only\" used for CCR in ES.", "committedDate": "2020-08-10T08:26:03Z", "type": "commit"}, {"oid": "19877ee56f0706c013e8f9e37a8813ebcfb0d920", "url": "https://github.com/crate/crate/commit/19877ee56f0706c013e8f9e37a8813ebcfb0d920", "message": "bp: Introduce retention lease actions\n\nhttps://github.com/elastic/elasticsearch/commit/bbe990f86275ed6d696681afc636d940ddf49d26\n\nThis only contains the `IndexShard` and `RecoverySourceHandler` changes,\nnot the actual actions because they're \"only\" used for CCR in ES.", "committedDate": "2020-08-10T08:26:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MTQ1Mg==", "url": "https://github.com/crate/crate/pull/10323#discussion_r467761452", "bodyText": "getRetentionLeaseStats can return null is it safe to use it like this?", "author": "kovrus", "createdAt": "2020-08-10T08:39:51Z", "path": "server/src/main/java/io/crate/expression/reference/sys/shard/ShardRowContext.java", "diffHunk": "@@ -349,4 +353,28 @@ public Float recoveryFilesPercent() {\n             ? null\n             : recoveryState.getIndex().recoveredFilesPercent();\n     }\n+\n+    public Long retentionLeasesPrimaryTerm() {\n+        try {\n+            return indexShard.getRetentionLeaseStats().leases().primaryTerm();", "originalCommit": "69a0be7a02517107146b776518ff638c3052ce58", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2NDY1Mg==", "url": "https://github.com/crate/crate/pull/10323#discussion_r467764652", "bodyText": "Currently the expression implementations in SystemTable catch npe's, so yes it is safe. But maybe worth handling here to avoid unnecessary stacktrace generations.\nI'll adapt it", "author": "mfussenegger", "createdAt": "2020-08-10T08:46:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MTQ1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2ODQ0MA==", "url": "https://github.com/crate/crate/pull/10323#discussion_r467768440", "bodyText": "From the code IndexShard.getRetentionLeaseStats() will never return null (compared to ShardStats.getRetentionLeaseStats() which can return null) or do I miss anything?", "author": "seut", "createdAt": "2020-08-10T08:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MTQ1Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "60f984fc102ff5d98073f41da96e266f5f2981e0", "url": "https://github.com/crate/crate/commit/60f984fc102ff5d98073f41da96e266f5f2981e0", "message": "Merge branch 'master' into j/retention-lease-stats", "committedDate": "2020-08-10T09:31:10Z", "type": "commit"}]}