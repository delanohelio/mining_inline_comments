{"pr_number": 10598, "pr_title": "Fix integer overflow at the reservoir sampling", "pr_createdAt": "2020-09-25T13:47:54Z", "pr_url": "https://github.com/crate/crate/pull/10598", "timeline": [{"oid": "17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7", "url": "https://github.com/crate/crate/commit/17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7", "message": "Fix integer overflow at the reservoir sampling\n\nAs the Reservoir sampling implementation is shared across shards and\npartitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that\nthe defined maximum samples to the list (this limit is also in the\ninteger range and such supporting sample sizes > integer is not needed).\n\nThe integer overflow results in bypassing the maximum samples boundary\nand can lead to node crashes due to OutOfMemory exceptions.", "committedDate": "2020-09-25T13:58:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDQ4NQ==", "url": "https://github.com/crate/crate/pull/10598#discussion_r495010485", "bodyText": "I think I'd just make itemsSeen package private to avoid the reflection, but no strong opinion.", "author": "mfussenegger", "createdAt": "2020-09-25T14:04:24Z", "path": "server/src/test/java/io/crate/statistics/ReservoirTest.java", "diffHunk": "@@ -40,4 +42,18 @@ public void test_sampling() {\n         }\n         assertThat(samples.samples(), contains(83, 50, 13, 18, 38));\n     }\n+\n+    @Test\n+    public void test_reservoir_is_protected_against_integer_overflow() throws Exception {\n+        Random random = new Random(42);\n+\n+        Reservoir<Long> samples = new Reservoir<>(5, random);\n+        Field f1 = samples.getClass().getDeclaredField(\"itemsSeen\");", "originalCommit": "17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAyMTIxMg==", "url": "https://github.com/crate/crate/pull/10598#discussion_r495021212", "bodyText": "I'd prefer not to make it public because it would only be needed for testing.", "author": "seut", "createdAt": "2020-09-25T14:19:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDQ4NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "64e50938c14de1ea3dca5036d125718d92a8878a", "url": "https://github.com/crate/crate/commit/64e50938c14de1ea3dca5036d125718d92a8878a", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached.", "committedDate": "2020-09-25T17:24:47Z", "type": "forcePushed"}, {"oid": "8c1daa6b79e011057e8d206dbce471aaaa5e883f", "url": "https://github.com/crate/crate/commit/8c1daa6b79e011057e8d206dbce471aaaa5e883f", "message": "Fix integer overflow at the reservoir sampling\n\nAs the Reservoir sampling implementation is shared across shards and\npartitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that\nthe defined maximum samples to the list (this limit is also in the\ninteger range and such supporting sample sizes > integer is not needed).\n\nThe integer overflow results in bypassing the maximum samples boundary\nand can lead to node crashes due to OutOfMemory exceptions.", "committedDate": "2020-09-28T07:44:52Z", "type": "commit"}, {"oid": "90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "url": "https://github.com/crate/crate/commit/90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached.", "committedDate": "2020-09-28T07:44:52Z", "type": "commit"}, {"oid": "90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "url": "https://github.com/crate/crate/commit/90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached.", "committedDate": "2020-09-28T07:44:52Z", "type": "forcePushed"}]}