{"pr_number": 10514, "pr_title": "Fix the join condition hash symbols ordering in the HashJoin.", "pr_createdAt": "2020-09-09T14:37:15Z", "pr_url": "https://github.com/crate/crate/pull/10514", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY3OTQ0Mw==", "url": "https://github.com/crate/crate/pull/10514#discussion_r485679443", "bodyText": "Is this change necessary? I don't understand how this helps, ArrayList also keeps the insertion order", "author": "mfussenegger", "createdAt": "2020-09-09T14:56:48Z", "path": "server/src/main/java/io/crate/planner/operators/HashJoinConditionSymbolsExtractor.java", "diffHunk": "@@ -92,7 +92,7 @@ public Void visitFunction(Function function, Context context) {\n                     int duplicatePos = 0;\n                     for (Symbol arg : function.arguments()) {\n                         var relation = arg.accept(RELATION_EXTRACTOR, null);\n-                        List<Symbol> symbols = context.symbolsPerRelation.computeIfAbsent(relation, k -> new ArrayList<>());\n+                        List<Symbol> symbols = context.symbolsPerRelation.computeIfAbsent(relation, k -> new LinkedList<>());", "originalCommit": "bfb3b4adde1510c296956fbec1632c4a45cf469b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY4MTQwNw==", "url": "https://github.com/crate/crate/pull/10514#discussion_r485681407", "bodyText": "it slipped in, it is not needed.", "author": "kovrus", "createdAt": "2020-09-09T14:59:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY3OTQ0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "393c9b06c6f9693184357894f9f6058d81a9b729", "chunk": "diff --git a/server/src/main/java/io/crate/planner/operators/HashJoinConditionSymbolsExtractor.java b/server/src/main/java/io/crate/planner/operators/HashJoinConditionSymbolsExtractor.java\nindex 2ccaa36c21..c1a20e9e09 100644\n--- a/server/src/main/java/io/crate/planner/operators/HashJoinConditionSymbolsExtractor.java\n+++ b/server/src/main/java/io/crate/planner/operators/HashJoinConditionSymbolsExtractor.java\n\n@@ -92,7 +92,7 @@ public final class HashJoinConditionSymbolsExtractor {\n                     int duplicatePos = 0;\n                     for (Symbol arg : function.arguments()) {\n                         var relation = arg.accept(RELATION_EXTRACTOR, null);\n-                        List<Symbol> symbols = context.symbolsPerRelation.computeIfAbsent(relation, k -> new LinkedList<>());\n+                        List<Symbol> symbols = context.symbolsPerRelation.computeIfAbsent(relation, k -> new ArrayList<>());\n                         if (symbols.contains(arg)) {\n                             // duplicate detected, use the current size as the position of the other relation symbol we\n                             // want to remove (if any)\n"}}, {"oid": "393c9b06c6f9693184357894f9f6058d81a9b729", "url": "https://github.com/crate/crate/commit/393c9b06c6f9693184357894f9f6058d81a9b729", "message": "Fix the join condition hash symbols ordering in the HashJoin.\n\nIt could have happened that joining more than 2 tables using hash join\nwon't return the joined tuples despite that the join condition is satisfied.\nThat could happen due to the non-deterministic ordering of the join condition\nsymbols (hash join symbols) which would lead to the wrong calculation of the\nhash code for the join condition values on either join side. This change fixes\nthe ordering of the join condition symbols.", "committedDate": "2020-09-09T15:00:48Z", "type": "commit"}, {"oid": "393c9b06c6f9693184357894f9f6058d81a9b729", "url": "https://github.com/crate/crate/commit/393c9b06c6f9693184357894f9f6058d81a9b729", "message": "Fix the join condition hash symbols ordering in the HashJoin.\n\nIt could have happened that joining more than 2 tables using hash join\nwon't return the joined tuples despite that the join condition is satisfied.\nThat could happen due to the non-deterministic ordering of the join condition\nsymbols (hash join symbols) which would lead to the wrong calculation of the\nhash code for the join condition values on either join side. This change fixes\nthe ordering of the join condition symbols.", "committedDate": "2020-09-09T15:00:48Z", "type": "forcePushed"}]}