{"pr_number": 10599, "pr_title": "Fix searcher double-release race condition", "pr_createdAt": "2020-09-25T13:55:52Z", "pr_url": "https://github.com/crate/crate/pull/10599", "timeline": [{"oid": "3ebda4b77f030ba8c55ed1ce931cdd3539855cde", "url": "https://github.com/crate/crate/commit/3ebda4b77f030ba8c55ed1ce931cdd3539855cde", "message": "Fix searcher double-release race condition\n\nThe incRef/release-on-zero pattern in the RefCountedItem didn't protect\nsufficently against double releases, because an already closed\nRefCountedItem could gain new refs and that would cause it to be closed\nmultiple times.\n\nA scenario where that can happen is a union or a join where the same\ntable is used more than one time.\n\nIf the table is small or the operation is fast, the close on the first\nuse of table A can happen before the second use of table A.\n\nThis fix here makes sure that a release happens only once, by discarding\nthe item and re-acquiring it if the refs reach zero.\n\nNote that this circumvents part of the motivation for the\nSharedShardContext - that is to re-use the same searchers across\noperations. We'd have to re-introduce a prepare/start split or similar\nto guarantee that all reference increments happen before the first close\ncan happen to ensure that searchers are truly shared.\n\nThis fixes flaky tests. An example that failed occassionally is:\n\n    ./gradlew :server:test -Dtests.seed=50DCF5AD232E645D -Dtests.class=io.crate.integrationtests.UnionIntegrationTest -Dtests.method=\"testUnionAllArrayAndObjectColumns\" -Dtests.locale=brx-IN -Dtests.timezone=America/Argentina/Rio_Gallegos -Dtests.iters=20 --fail-fast", "committedDate": "2020-09-25T13:57:42Z", "type": "commit"}, {"oid": "3ebda4b77f030ba8c55ed1ce931cdd3539855cde", "url": "https://github.com/crate/crate/commit/3ebda4b77f030ba8c55ed1ce931cdd3539855cde", "message": "Fix searcher double-release race condition\n\nThe incRef/release-on-zero pattern in the RefCountedItem didn't protect\nsufficently against double releases, because an already closed\nRefCountedItem could gain new refs and that would cause it to be closed\nmultiple times.\n\nA scenario where that can happen is a union or a join where the same\ntable is used more than one time.\n\nIf the table is small or the operation is fast, the close on the first\nuse of table A can happen before the second use of table A.\n\nThis fix here makes sure that a release happens only once, by discarding\nthe item and re-acquiring it if the refs reach zero.\n\nNote that this circumvents part of the motivation for the\nSharedShardContext - that is to re-use the same searchers across\noperations. We'd have to re-introduce a prepare/start split or similar\nto guarantee that all reference increments happen before the first close\ncan happen to ensure that searchers are truly shared.\n\nThis fixes flaky tests. An example that failed occassionally is:\n\n    ./gradlew :server:test -Dtests.seed=50DCF5AD232E645D -Dtests.class=io.crate.integrationtests.UnionIntegrationTest -Dtests.method=\"testUnionAllArrayAndObjectColumns\" -Dtests.locale=brx-IN -Dtests.timezone=America/Argentina/Rio_Gallegos -Dtests.iters=20 --fail-fast", "committedDate": "2020-09-25T13:57:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzMjYyOQ==", "url": "https://github.com/crate/crate/pull/10599#discussion_r495032629", "bodyText": "do we need to clean it on close?", "author": "kovrus", "createdAt": "2020-09-25T14:36:45Z", "path": "server/src/main/java/io/crate/common/collections/RefCountedItem.java", "diffHunk": "@@ -21,33 +21,56 @@\n \n package io.crate.common.collections;\n \n-import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.ArrayList;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n \n public class RefCountedItem<T> implements AutoCloseable {\n \n-    private final T item;\n-    private final Runnable onClose;\n-    private final AtomicInteger refs = new AtomicInteger(1);\n+    private final Function<String, T> itemFactory;\n+    private final Consumer<T> closeItem;\n+    private final ArrayList<String> sources = new ArrayList<>();", "originalCommit": "3ebda4b77f030ba8c55ed1ce931cdd3539855cde", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzNjM3Nw==", "url": "https://github.com/crate/crate/pull/10599#discussion_r495036377", "bodyText": "Wasn't sure about that. It's not really required - the life-time of the RefCountedItem is for a single query, so it should never grow large and it may be interesting for debugging to track all acquisition calls.", "author": "mfussenegger", "createdAt": "2020-09-25T14:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzMjYyOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f00eb2255f00b1432415cd936d0e9ec6bc101068", "url": "https://github.com/crate/crate/commit/f00eb2255f00b1432415cd936d0e9ec6bc101068", "message": "Merge branch 'master' into j/acquire-searcher", "committedDate": "2020-09-25T15:31:45Z", "type": "commit"}]}