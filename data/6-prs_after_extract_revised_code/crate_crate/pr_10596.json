{"pr_number": 10596, "pr_title": "Port over TransportVerifyShardBeforeCloseActionTests and missing \"advance checkpoints only after persisting ops\" logic in TransportVerifyShardBeforeCloseActionT", "pr_createdAt": "2020-09-25T10:24:13Z", "pr_url": "https://github.com/crate/crate/pull/10596", "timeline": [{"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741", "url": "https://github.com/crate/crate/commit/5ae6cb27d9b7c7c64180229942ca21d11c310741", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-25T10:25:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjQ1Mg==", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932452", "bodyText": "The transport and request is new in 4.3 and wasn't present in 4.2 so the check here can be removed.\nThere is logic in place to avoid using the transport if not all nodes are on 4.3", "author": "mfussenegger", "createdAt": "2020-09-25T11:45:12Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {", "originalCommit": "5ae6cb27d9b7c7c64180229942ca21d11c310741", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "178601049ae5d9e3a61d207c4234c1b3cb099425", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java b/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\nindex 42c17b06e3..323a055fde 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\n\n@@ -166,11 +166,7 @@ public class TransportVerifyShardBeforeCloseAction extends TransportReplicationA\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n-            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n-                phase1 = in.readBoolean();\n-            } else {\n-                phase1 = false;\n-            }\n+            phase1 = in.readBoolean();\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjcwMQ==", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932701", "bodyText": "There is no production code call-site where phase1 is set to true, is that intentional?", "author": "mfussenegger", "createdAt": "2020-09-25T11:45:43Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n+                phase1 = in.readBoolean();\n+            } else {\n+                phase1 = false;\n+            }\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n-        public ShardRequest(ShardId shardId, ClusterBlock clusterBlock) {\n+        public ShardRequest(ShardId shardId, boolean phase1, ClusterBlock clusterBlock) {", "originalCommit": "5ae6cb27d9b7c7c64180229942ca21d11c310741", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MzE4NA==", "url": "https://github.com/crate/crate/pull/10596#discussion_r494953184", "bodyText": "seems like https://github.com/crate/crate/pull/10596/files/5ae6cb27d9b7c7c64180229942ca21d11c310741#diff-191de78233c863150a9abf36a805ea7cL555 had to be done in two steps, first sending requests with phase1 and once the (persisted) local checkpoint is advanced we send another request with phase1 false. See https://github.com/elastic/elasticsearch/pull/43205/files#diff-6f976d9c43872a6dcd26e027a1667aaaR396-R411\nI'll update it then", "author": "kovrus", "createdAt": "2020-09-25T12:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjcwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "178601049ae5d9e3a61d207c4234c1b3cb099425", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java b/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\nindex 42c17b06e3..323a055fde 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java\n\n@@ -166,11 +166,7 @@ public class TransportVerifyShardBeforeCloseAction extends TransportReplicationA\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n-            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n-                phase1 = in.readBoolean();\n-            } else {\n-                phase1 = false;\n-            }\n+            phase1 = in.readBoolean();\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n"}}, {"oid": "178601049ae5d9e3a61d207c4234c1b3cb099425", "url": "https://github.com/crate/crate/commit/178601049ae5d9e3a61d207c4234c1b3cb099425", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-25T12:34:30Z", "type": "forcePushed"}, {"oid": "199aca0f1adc35f456422280df22eadc84c655a1", "url": "https://github.com/crate/crate/commit/199aca0f1adc35f456422280df22eadc84c655a1", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-25T14:37:40Z", "type": "forcePushed"}, {"oid": "40efd99820eaa470e4dd67f18bc4a374a793504f", "url": "https://github.com/crate/crate/commit/40efd99820eaa470e4dd67f18bc4a374a793504f", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-26T11:47:39Z", "type": "forcePushed"}, {"oid": "01c5e4d1f353416accad7af03ff741c77ec853f0", "url": "https://github.com/crate/crate/commit/01c5e4d1f353416accad7af03ff741c77ec853f0", "message": "Reflect advance checkpoints only after persisting ops in TransportVerifyShardBeforeCloseAction\n\nhttps://github.com/crate/crate/pull/9309/ ports over https://github.com/elastic/elasticsearch/pull/43205\nbut at that point TransportVerifyShardBeforeCloseAction was not present\nin our code base.", "committedDate": "2020-09-28T08:32:49Z", "type": "commit"}, {"oid": "f232196ff4021ee13457589e79aaabd6af15cee6", "url": "https://github.com/crate/crate/commit/f232196ff4021ee13457589e79aaabd6af15cee6", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-28T08:32:49Z", "type": "commit"}, {"oid": "f232196ff4021ee13457589e79aaabd6af15cee6", "url": "https://github.com/crate/crate/commit/f232196ff4021ee13457589e79aaabd6af15cee6", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c", "committedDate": "2020-09-28T08:32:49Z", "type": "forcePushed"}]}