{"pr_number": 10057, "pr_title": "Remove guava some guava multi and immutable maps.", "pr_createdAt": "2020-06-08T09:35:55Z", "pr_url": "https://github.com/crate/crate/pull/10057", "timeline": [{"oid": "748f06be47b7c1622cbb4dd166a14035fe06f2c4", "url": "https://github.com/crate/crate/commit/748f06be47b7c1622cbb4dd166a14035fe06f2c4", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-27T12:36:32Z", "type": "forcePushed"}, {"oid": "00312edd13bbeffb74c170437fc320422b43909f", "url": "https://github.com/crate/crate/commit/00312edd13bbeffb74c170437fc320422b43909f", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-27T14:51:00Z", "type": "forcePushed"}, {"oid": "0bd9a6833e02e86b439c724cab0f393d82700548", "url": "https://github.com/crate/crate/commit/0bd9a6833e02e86b439c724cab0f393d82700548", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-27T15:34:15Z", "type": "forcePushed"}, {"oid": "46238d9373d11277d4ea6c2be100dfae468dbe5c", "url": "https://github.com/crate/crate/commit/46238d9373d11277d4ea6c2be100dfae468dbe5c", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-27T15:47:15Z", "type": "forcePushed"}, {"oid": "c0dd2982502f6b681b038292d582506f40d4f98f", "url": "https://github.com/crate/crate/commit/c0dd2982502f6b681b038292d582506f40d4f98f", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-27T21:10:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3OTQ0MA==", "url": "https://github.com/crate/crate/pull/10057#discussion_r461379440", "bodyText": "This always creates the new ArrayList even if it's not required.", "author": "mfussenegger", "createdAt": "2020-07-28T07:37:44Z", "path": "server/src/main/java/io/crate/analyze/GeneratedColumnExpander.java", "diffHunk": "@@ -152,7 +149,8 @@ public Symbol visitFunction(Function function, Context context) {\n \n \n         private Symbol addComparison(Function function, Reference reference, Symbol comparedAgainst, Context context) {\n-            Collection<GeneratedReference> genColInfos = context.referencedRefsToGeneratedColumn.get(reference);\n+            ArrayList<GeneratedReference> genColInfos = context.referencedRefsToGeneratedColumn\n+                .getOrDefault(reference, new ArrayList<>());", "originalCommit": "c0dd2982502f6b681b038292d582506f40d4f98f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQwMDA3NQ==", "url": "https://github.com/crate/crate/pull/10057#discussion_r461400075", "bodyText": "i probably could change ArrayList<GeneratedReference> to List<..> and then use List.of() in getOrDefault, but computeIfAbsent should be ok as well, not sure what is better", "author": "kovrus", "createdAt": "2020-07-28T08:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3OTQ0MA=="}], "type": "inlineReview", "revised_code": {"commit": "98b2f6d6877e15949405a8126cf861d98d027563", "chunk": "diff --git a/server/src/main/java/io/crate/analyze/GeneratedColumnExpander.java b/server/src/main/java/io/crate/analyze/GeneratedColumnExpander.java\nindex ec8faba0aa..e7fedebb7a 100644\n--- a/server/src/main/java/io/crate/analyze/GeneratedColumnExpander.java\n+++ b/server/src/main/java/io/crate/analyze/GeneratedColumnExpander.java\n\n@@ -150,7 +150,7 @@ public final class GeneratedColumnExpander {\n \n         private Symbol addComparison(Function function, Reference reference, Symbol comparedAgainst, Context context) {\n             ArrayList<GeneratedReference> genColInfos = context.referencedRefsToGeneratedColumn\n-                .getOrDefault(reference, new ArrayList<>());\n+                .computeIfAbsent(reference, (k) -> new ArrayList<>());\n             List<Function> comparisonsToAdd = new ArrayList<>(genColInfos.size());\n             comparisonsToAdd.add(function);\n             for (GeneratedReference genColInfo : genColInfos) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDIwMA==", "url": "https://github.com/crate/crate/pull/10057#discussion_r461380200", "bodyText": "I think we could extend the MapBuilder with a putAll and keep this as it was before.", "author": "mfussenegger", "createdAt": "2020-07-28T07:39:11Z", "path": "server/src/main/java/io/crate/metadata/doc/DocIndexMetadata.java", "diffHunk": "@@ -692,21 +692,26 @@ public Settings tableParameters() {\n                 || (columnDataType.id() == ArrayType.ID\n                     && ((ArrayType) columnDataType).innerType().id() == ObjectType.ID)) {\n                 if (columnProperties.get(\"properties\") != null) {\n-                    builder.putAll(getAnalyzers(newIdent, (Map<String, Object>) columnProperties.get(\"properties\")));", "originalCommit": "c0dd2982502f6b681b038292d582506f40d4f98f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98b2f6d6877e15949405a8126cf861d98d027563", "chunk": "diff --git a/server/src/main/java/io/crate/metadata/doc/DocIndexMetadata.java b/server/src/main/java/io/crate/metadata/doc/DocIndexMetadata.java\nindex 5b5851e030..b637d0c0e8 100644\n--- a/server/src/main/java/io/crate/metadata/doc/DocIndexMetadata.java\n+++ b/server/src/main/java/io/crate/metadata/doc/DocIndexMetadata.java\n\n@@ -692,12 +692,7 @@ public class DocIndexMetadata {\n                 || (columnDataType.id() == ArrayType.ID\n                     && ((ArrayType) columnDataType).innerType().id() == ObjectType.ID)) {\n                 if (columnProperties.get(\"properties\") != null) {\n-                    for (var analyzer : getAnalyzers(\n-                        newIdent,\n-                        (Map<String, Object>) columnProperties.get(\"properties\")).entrySet()\n-                    ) {\n-                        builder.put(analyzer.getKey(), analyzer.getValue());\n-                    }\n+                    builder.putAll(getAnalyzers(newIdent, (Map<String, Object>) columnProperties.get(\"properties\")));\n                 }\n             }\n             String analyzer = (String) columnProperties.get(\"analyzer\");\n"}}, {"oid": "98b2f6d6877e15949405a8126cf861d98d027563", "url": "https://github.com/crate/crate/commit/98b2f6d6877e15949405a8126cf861d98d027563", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-28T08:33:38Z", "type": "commit"}, {"oid": "98b2f6d6877e15949405a8126cf861d98d027563", "url": "https://github.com/crate/crate/commit/98b2f6d6877e15949405a8126cf861d98d027563", "message": "Remove guava some guava multi and immutable maps.", "committedDate": "2020-07-28T08:33:38Z", "type": "forcePushed"}]}