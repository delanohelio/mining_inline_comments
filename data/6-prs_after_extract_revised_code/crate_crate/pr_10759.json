{"pr_number": 10759, "pr_title": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY ", "pr_createdAt": "2020-11-10T14:52:11Z", "pr_url": "https://github.com/crate/crate/pull/10759", "timeline": [{"oid": "3256ead051616ae1157430cbc7dc54664539210a", "url": "https://github.com/crate/crate/commit/3256ead051616ae1157430cbc7dc54664539210a", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement.", "committedDate": "2020-11-10T16:21:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5ODgzMw==", "url": "https://github.com/crate/crate/pull/10759#discussion_r520698833", "bodyText": "I don't really understand why we have the special case for subscript functions. Shouldn't we be able to support all kinds of functions if subscripts work - or why are they special?", "author": "mfussenegger", "createdAt": "2020-11-10T16:29:32Z", "path": "server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java", "diffHunk": "@@ -34,23 +36,26 @@\n     private static final InnerValidator INNER_VALIDATOR = new InnerValidator();\n \n     public static void validate(Symbol symbol) throws IllegalArgumentException, UnsupportedOperationException {\n-        symbol.accept(INNER_VALIDATOR, \"Cannot GROUP BY '%s': invalid data type '%s'\");\n+        symbol.accept(INNER_VALIDATOR, false);\n     }\n \n-    private static class InnerValidator extends SymbolVisitor<String, Void> {\n+    private static class InnerValidator extends SymbolVisitor<Boolean, Void> {\n \n         @Override\n-        public Void visitFunction(Function function, String errorMsgTemplate) {\n+        public Void visitFunction(Function function, Boolean insideSubscriptFunction) {\n             switch (function.type()) {\n                 case SCALAR:\n                     for (Symbol argument : function.arguments()) {\n-                        argument.accept(this, errorMsgTemplate);\n+                        argument.accept(this, function.name().equals(SubscriptFunction.NAME));", "originalCommit": "3256ead051616ae1157430cbc7dc54664539210a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIwMzM0Nw==", "url": "https://github.com/crate/crate/pull/10759#discussion_r521203347", "bodyText": "actually you're right, pushed a fixup.", "author": "seut", "createdAt": "2020-11-11T08:47:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5ODgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "773ff63bfefbb2bdebabd9c54d33583ab10e91de", "chunk": "diff --git a/server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java b/server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java\nindex 7c2f7f1581..3828c400f5 100644\n--- a/server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java\n+++ b/server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java\n\n@@ -42,17 +41,17 @@ public class GroupBySymbolValidator {\n     private static class InnerValidator extends SymbolVisitor<Boolean, Void> {\n \n         @Override\n-        public Void visitFunction(Function function, Boolean insideSubscriptFunction) {\n+        public Void visitFunction(Function function, Boolean insideScalar) {\n             switch (function.type()) {\n                 case SCALAR:\n                     for (Symbol argument : function.arguments()) {\n-                        argument.accept(this, function.name().equals(SubscriptFunction.NAME));\n+                        argument.accept(this, true);\n                     }\n                     break;\n                 case AGGREGATE:\n                     throw new IllegalArgumentException(\"Aggregate functions are not allowed in GROUP BY\");\n                 case TABLE:\n-                    if (insideSubscriptFunction == false) {\n+                    if (insideScalar == false) {\n                         throw new IllegalArgumentException(\"Table functions are not allowed in GROUP BY\");\n                     }\n                     break;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIxMTkxMw==", "url": "https://github.com/crate/crate/pull/10759#discussion_r521211913", "bodyText": "Should we also add a logical planner test for this case? Otherwise the new ProjectSet creation change is not tested, or am I missing something?", "author": "mfussenegger", "createdAt": "2020-11-11T09:03:03Z", "path": "server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java", "diffHunk": "@@ -2604,4 +2614,12 @@ public void test_match_with_geo_shape_is_streamed_as_text_type_to_4_1_8_nodes()\n         Function serializedTo41 = new Function(in);\n         assertThat(serializedTo41.info().ident().argumentTypes().get(1), is(DataTypes.STRING));\n     }\n+\n+    @Test\n+    public void test_table_function_wrapped_inside_scalar_can_be_used_inside_group_by() {\n+        var executor = SQLExecutor.builder(clusterService)\n+            .build();\n+        AnalyzedRelation rel = executor.analyze(\"select regexp_matches('foo', '.*')[1] from sys.cluster group by 1\");", "originalCommit": "24d7c1f76466a1bde45cd485fb35ba20c8be91f7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "71af41d94bc7470d08cbd7855482179ec887343d", "chunk": "diff --git a/server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java b/server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java\nindex f5f55448ac..85ab7f6b86 100644\n--- a/server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java\n+++ b/server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java\n\n@@ -2614,12 +2614,4 @@ public class SelectStatementAnalyzerTest extends CrateDummyClusterServiceUnitTes\n         Function serializedTo41 = new Function(in);\n         assertThat(serializedTo41.info().ident().argumentTypes().get(1), is(DataTypes.STRING));\n     }\n-\n-    @Test\n-    public void test_table_function_wrapped_inside_scalar_can_be_used_inside_group_by() {\n-        var executor = SQLExecutor.builder(clusterService)\n-            .build();\n-        AnalyzedRelation rel = executor.analyze(\"select regexp_matches('foo', '.*')[1] from sys.cluster group by 1\");\n-        assertThat(rel.outputs().get(0).valueType().getName(), is(\"text\"));\n-    }\n }\n"}}, {"oid": "773ff63bfefbb2bdebabd9c54d33583ab10e91de", "url": "https://github.com/crate/crate/commit/773ff63bfefbb2bdebabd9c54d33583ab10e91de", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement.", "committedDate": "2020-11-11T09:56:25Z", "type": "forcePushed"}, {"oid": "71af41d94bc7470d08cbd7855482179ec887343d", "url": "https://github.com/crate/crate/commit/71af41d94bc7470d08cbd7855482179ec887343d", "message": "Fix validation of GROUP BY expressions when wrapped inside an alias\n\nIf a column aliased is used inside the GROUP BY symbols the validation\ndid not worked as `AliasedSymbol`s were not processed.", "committedDate": "2020-11-11T10:19:17Z", "type": "commit"}, {"oid": "498031f6e500f23fcc85641d0239f205556a73e6", "url": "https://github.com/crate/crate/commit/498031f6e500f23fcc85641d0239f205556a73e6", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement.", "committedDate": "2020-11-11T10:19:17Z", "type": "commit"}, {"oid": "498031f6e500f23fcc85641d0239f205556a73e6", "url": "https://github.com/crate/crate/commit/498031f6e500f23fcc85641d0239f205556a73e6", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement.", "committedDate": "2020-11-11T10:19:17Z", "type": "forcePushed"}]}