{"pr_number": 10525, "pr_title": "Do not close index searchers outside of the CollectTask.", "pr_createdAt": "2020-09-11T13:32:41Z", "pr_url": "https://github.com/crate/crate/pull/10525", "timeline": [{"oid": "86e25f827bbdf93d57904826e260d157cf0d29df", "url": "https://github.com/crate/crate/commit/86e25f827bbdf93d57904826e260d157cf0d29df", "message": "Do not close index searchers outside the CollectTask.\n\nIn the doc values group by and aggregation optimizations\n(GroupByOptimizedIterator, DocValuesGroupByOptimizedIterator,\nDocValuesAggregates) index searchers are added explicitly to the\ncollect task and their closing, in case of failure, is managed as\nwell by the above-mentioned classes. That is redundant. The collect\ntask manages closing of the added index searcher itself. See\n`CollectTask#innerKill` or `CollectTask#close/innerClose`.", "committedDate": "2020-09-11T13:30:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ==", "url": "https://github.com/crate/crate/pull/10525#discussion_r487060195", "bodyText": "I think the indexService() call could fail, in which case the searcher wouldn't be released because it hasn't been added to the collectTask yet.\nMakes me wonder if we should remove the lazy indexService initialization within SharedShardContext and do it eagerly. Then it couldn't fail here anymore.", "author": "mfussenegger", "createdAt": "2020-09-11T13:53:10Z", "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "diffHunk": "@@ -100,42 +100,37 @@\n         ShardId shardId = indexShard.shardId();\n         SharedShardContext shardContext = collectTask.sharedShardContexts().getOrCreateContext(shardId);\n         Searcher searcher = shardContext.acquireSearcher(LuceneShardCollectorProvider.formatSource(phase));\n-        try {\n-            QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();\n-            collectTask.addSearcher(shardContext.readerId(), searcher);\n-            LuceneQueryBuilder.Context queryContext = luceneQueryBuilder.convert(\n-                phase.where(),\n-                collectTask.txnCtx(),\n-                indexShard.mapperService(),\n-                indexShard.shardId().getIndexName(),\n-                queryShardContext,\n-                table,\n-                shardContext.indexService().cache()\n-            );\n+        QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();", "originalCommit": "86e25f827bbdf93d57904826e260d157cf0d29df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3NjQ4MA==", "url": "https://github.com/crate/crate/pull/10525#discussion_r487076480", "bodyText": "Engine.Searcher searcher = sharedShardContext.acquireSearcher(formatSource(collectPhase));\n        QueryShardContext queryShardContext = sharedShardContext.indexService().newQueryShardContext();\n\nacquireSearcher call here preseeds the indexService() call and acquireSearcher calls indexShard() that call indexService(), so if indexService() fails the searcher won't even be created, right?", "author": "kovrus", "createdAt": "2020-09-11T14:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4Mzk2MA==", "url": "https://github.com/crate/crate/pull/10525#discussion_r487083960", "bodyText": "Ah you're right \ud83d\udc4d", "author": "mfussenegger", "createdAt": "2020-09-11T14:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ=="}], "type": "inlineReview", "revised_code": null}]}