{"pr_number": 10703, "pr_title": "Allow super users to drop corrupted tables", "pr_createdAt": "2020-10-26T09:24:49Z", "pr_url": "https://github.com/crate/crate/pull/10703", "timeline": [{"oid": "84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "url": "https://github.com/crate/crate/commit/84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted.", "committedDate": "2020-10-26T09:35:01Z", "type": "forcePushed"}, {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665", "url": "https://github.com/crate/crate/commit/8ad545b18c41ef88575d544e955a6b736c5c3665", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted.", "committedDate": "2020-10-27T08:12:33Z", "type": "commit"}, {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665", "url": "https://github.com/crate/crate/commit/8ad545b18c41ef88575d544e955a6b736c5c3665", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted.", "committedDate": "2020-10-27T08:12:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5OTAwMA==", "url": "https://github.com/crate/crate/pull/10703#discussion_r512499000", "bodyText": "I'd turn this into debug as I think this is not relevant for the user. The table is dropped afterwards anyway so its not possible to do anything after seeing this log. Any other reason why informing the user is helpful here?", "author": "seut", "createdAt": "2020-10-27T08:32:32Z", "path": "server/src/main/java/io/crate/analyze/DropTableAnalyzer.java", "diffHunk": "@@ -63,16 +70,35 @@\n                                                                boolean dropIfExists,\n                                                                SessionContext sessionContext) {\n         T tableInfo;\n+        RelationName tableName;\n+        boolean maybeCorrupt = false;\n         try {\n             //noinspection unchecked\n             tableInfo = (T) schemas.resolveTableInfo(name, Operation.DROP, sessionContext.sessionUser(), sessionContext.searchPath());\n+            tableName = tableInfo.ident();\n         } catch (SchemaUnknownException | RelationUnknown e) {\n             if (dropIfExists) {\n                 tableInfo = null;\n+                tableName = RelationName.of(name, sessionContext.searchPath().currentSchema());\n             } else {\n                 throw e;\n             }\n+        } catch (OperationOnInaccessibleRelationException e) {\n+            throw e;\n+        } catch (Throwable t) {\n+            if (!sessionContext.sessionUser().isSuperUser()) {\n+                throw t;\n+            }\n+            tableInfo = null;\n+            maybeCorrupt = true;\n+            tableName = RelationName.of(name, sessionContext.searchPath().currentSchema());\n+            LOGGER.info(", "originalCommit": "8ad545b18c41ef88575d544e955a6b736c5c3665", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUxODU1OA==", "url": "https://github.com/crate/crate/pull/10703#discussion_r512518558", "bodyText": "Any other reason why informing the user is helpful here\n\nBecause the cluster was in a weird state that caused the error. May be helpful for us to have that in the logs by default", "author": "mfussenegger", "createdAt": "2020-10-27T09:03:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5OTAwMA=="}], "type": "inlineReview", "revised_code": null}]}