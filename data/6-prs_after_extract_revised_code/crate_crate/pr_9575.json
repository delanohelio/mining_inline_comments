{"pr_number": 9575, "pr_title": "Improve BwC for returning clause for update", "pr_createdAt": "2020-01-28T10:58:13Z", "pr_url": "https://github.com/crate/crate/pull/9575", "timeline": [{"oid": "80234c3e2978572a26989f158563217b73f317b7", "url": "https://github.com/crate/crate/commit/80234c3e2978572a26989f158563217b73f317b7", "message": "Remove allOn4_2 version flag from Upsert related classes", "committedDate": "2020-01-28T11:06:13Z", "type": "forcePushed"}, {"oid": "16e2bd4f13587306578fffdc5790729fe235c2d9", "url": "https://github.com/crate/crate/commit/16e2bd4f13587306578fffdc5790729fe235c2d9", "message": "Add test for node compatibility for returning clause", "committedDate": "2020-01-29T07:29:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzNjU0MA==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372336540", "bodyText": "Which version are we aiming here ? 4.2 or something like 4.1.x ?", "author": "mkleen", "createdAt": "2020-01-29T11:46:42Z", "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "originalCommit": "bfcded18b84b1fd173500aa3bc86b47972477be3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NTk0NA==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372375944", "bodyText": "4.2 \ud83d\udc4d", "author": "mfussenegger", "createdAt": "2020-01-29T13:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzNjU0MA=="}], "type": "inlineReview", "revised_code": {"commit": "a24417a70dc6634112a423d814701ebfdc4d1118", "chunk": "diff --git a/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java b/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\nindex 37e2665301..a361813fb1 100644\n--- a/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\n+++ b/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\n\n@@ -94,10 +94,9 @@ public final class UpdatePlanner {\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n \n-        if (!update.returnValues().isEmpty()) {\n-            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {\n-                throw new UnsupportedFeatureException(RETURNING_VERSION_ERROR_MSG);\n-            }\n+        if (!update.returnValues().isEmpty() &&\n+            !plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {\n+            throw new UnsupportedFeatureException(RETURNING_VERSION_ERROR_MSG);\n         }\n \n         AbstractTableRelation table = update.table();\n"}}, {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "url": "https://github.com/crate/crate/commit/83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "message": "Add test for node compatibility for returning clause", "committedDate": "2020-01-29T12:07:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376502", "bodyText": "Maybe also inline this, I think there is only a single use.", "author": "mfussenegger", "createdAt": "2020-01-29T13:19:39Z", "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "diffHunk": "@@ -225,6 +213,8 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         sessionSettings.writeTo(out);\n \n+        boolean allOn4_2 = out.getVersion().onOrAfter(Version.V_4_2_0);", "originalCommit": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3Nzg3Mw==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372377873", "bodyText": "It is used for the serialization of all the items.", "author": "mkleen", "createdAt": "2020-01-29T13:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3ODY1NQ==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372378655", "bodyText": "Ah right, I missed that.", "author": "mfussenegger", "createdAt": "2020-01-29T13:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3Njg3MA==", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376870", "bodyText": "Could merge this into the previous if condition.", "author": "mfussenegger", "createdAt": "2020-01-29T13:20:25Z", "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "originalCommit": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a24417a70dc6634112a423d814701ebfdc4d1118", "chunk": "diff --git a/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java b/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\nindex 37e2665301..a361813fb1 100644\n--- a/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\n+++ b/sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java\n\n@@ -94,10 +94,9 @@ public final class UpdatePlanner {\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n \n-        if (!update.returnValues().isEmpty()) {\n-            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {\n-                throw new UnsupportedFeatureException(RETURNING_VERSION_ERROR_MSG);\n-            }\n+        if (!update.returnValues().isEmpty() &&\n+            !plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {\n+            throw new UnsupportedFeatureException(RETURNING_VERSION_ERROR_MSG);\n         }\n \n         AbstractTableRelation table = update.table();\n"}}, {"oid": "a24417a70dc6634112a423d814701ebfdc4d1118", "url": "https://github.com/crate/crate/commit/a24417a70dc6634112a423d814701ebfdc4d1118", "message": "Improve bwc for returning clause for update\n\nThis change simplifies the serialisation for upsert-related\nclasses and makes it less error prone. It also adds a\nspecific version check for all nodes in the cluster when\na returning clause occurs in an update query.", "committedDate": "2020-01-29T14:46:59Z", "type": "commit"}, {"oid": "a24417a70dc6634112a423d814701ebfdc4d1118", "url": "https://github.com/crate/crate/commit/a24417a70dc6634112a423d814701ebfdc4d1118", "message": "Improve bwc for returning clause for update\n\nThis change simplifies the serialisation for upsert-related\nclasses and makes it less error prone. It also adds a\nspecific version check for all nodes in the cluster when\na returning clause occurs in an update query.", "committedDate": "2020-01-29T14:46:59Z", "type": "forcePushed"}, {"oid": "bb402c6caaf36564a2bce757b7072fde36b63530", "url": "https://github.com/crate/crate/commit/bb402c6caaf36564a2bce757b7072fde36b63530", "message": "Merge branch 'master' into mkleen/remove_version_flag", "committedDate": "2020-01-29T15:20:34Z", "type": "commit"}]}