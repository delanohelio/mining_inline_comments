{"pr_number": 10118, "pr_title": "Improve unknown function error for operators", "pr_createdAt": "2020-06-22T17:58:04Z", "pr_url": "https://github.com/crate/crate/pull/10118", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAxNjg4Mg==", "url": "https://github.com/crate/crate/pull/10118#discussion_r444016882", "bodyText": "Did you consider to create a Function symbol to be able to delegate the formatting to the toString implementation of Function?", "author": "mfussenegger", "createdAt": "2020-06-23T07:27:51Z", "path": "server/src/main/java/io/crate/metadata/Functions.java", "diffHunk": "@@ -331,12 +335,50 @@ public FunctionImplementation getQualified(Signature signature,\n     private static UnsupportedOperationException raiseUnknownFunction(@Nullable String suppliedSchema,\n                                                                       String name,\n                                                                       List<? extends Symbol> arguments) {\n-        StringJoiner joiner = new StringJoiner(\", \");\n-        for (var arg : arguments) {\n-            joiner.add(arg.valueType().toString());\n+        String functionString = formatPossibleOperators(suppliedSchema, name, arguments);", "originalCommit": "913d200348f64cce4bf16d0aa25c25c324be09d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3OTMwNQ==", "url": "https://github.com/crate/crate/pull/10118#discussion_r444079305", "bodyText": "Did consider, but forget somehow. Pushed a fixup, thanks for the heads up.", "author": "seut", "createdAt": "2020-06-23T09:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAxNjg4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "471804ccbadd93c632f0723bf1d95a33e4b265db", "chunk": "diff --git a/server/src/main/java/io/crate/metadata/Functions.java b/server/src/main/java/io/crate/metadata/Functions.java\nindex 3322225e03..016ef3e504 100644\n--- a/server/src/main/java/io/crate/metadata/Functions.java\n+++ b/server/src/main/java/io/crate/metadata/Functions.java\n\n@@ -334,51 +330,23 @@ public class Functions {\n \n     private static UnsupportedOperationException raiseUnknownFunction(@Nullable String suppliedSchema,\n                                                                       String name,\n-                                                                      List<? extends Symbol> arguments) {\n-        String functionString = formatPossibleOperators(suppliedSchema, name, arguments);\n-\n-        if (functionString == null) {\n-            StringJoiner joiner = new StringJoiner(\", \");\n-            for (var arg : arguments) {\n-                joiner.add(arg.valueType().toString());\n-            }\n-            String prefix = suppliedSchema == null ? \"\" : suppliedSchema + '.';\n-            functionString = prefix + name + '(' + joiner.toString() + ')';\n-        }\n-\n-        throw new UnsupportedOperationException(\"unknown function: \" + functionString);\n-    }\n-\n-    @Nullable\n-    private static String formatPossibleOperators(@Nullable String suppliedSchema,\n-                                                  String name,\n-                                                  List<? extends Symbol> arguments) {\n-        if (suppliedSchema != null) {\n-            return null;\n-        }\n-\n-        if (name.startsWith(AnyOperator.OPERATOR_PREFIX)) {\n-            return arguments.get(0).valueType() + \" \" +\n-                   name.replace(AnyOperator.OPERATOR_PREFIX, \"\") + \" ANY\" +\n-                   \"(\" +\n-                   arguments.get(1).valueType() +\n-                   \")\";\n-        } else if (name.startsWith(AllOperator.OPERATOR_PREFIX)) {\n-            return arguments.get(0).valueType() + \" \" +\n-                   name.replace(AllOperator.OPERATOR_PREFIX, \"\") + \" ALL\" +\n-                   \"(\" +\n-                   arguments.get(1).valueType() +\n-                   \")\";\n-        } else if (name.startsWith(Operator.PREFIX)) {\n-            if (name.equalsIgnoreCase(NotPredicate.NAME)) {\n-                return \"NOT \" + arguments.get(0).valueType();\n-            }\n-            return arguments.get(0).valueType() + \" \" +\n-                   name.replace(Operator.PREFIX, \"\") + \" \" +\n-                   arguments.get(1).valueType();\n-        }\n+                                                                      List<Symbol> arguments) {\n+        List<DataType> argumentTypes = Symbols.typeView(arguments);\n+        var function = new io.crate.expression.symbol.Function(\n+            new FunctionInfo(\n+                new FunctionIdent(suppliedSchema, name, argumentTypes),\n+                DataTypes.UNDEFINED\n+            ),\n+            Signature.builder()\n+                .name(new FunctionName(suppliedSchema, name))\n+                .argumentTypes(Lists2.map(argumentTypes, DataType::getTypeSignature))\n+                .returnType(DataTypes.UNDEFINED.getTypeSignature())\n+                .kind(FunctionInfo.Type.SCALAR)\n+                .build(),\n+            arguments\n+        );\n \n-        return null;\n+        throw new UnsupportedOperationException(\"unknown function: \" + function.toString(Style.TYPE_VIEW));\n     }\n \n     private static List<ApplicableFunction> selectMostSpecificFunctions(List<ApplicableFunction> applicableFunctions,\n"}}, {"oid": "471804ccbadd93c632f0723bf1d95a33e4b265db", "url": "https://github.com/crate/crate/commit/471804ccbadd93c632f0723bf1d95a33e4b265db", "message": "fixup! Improve unknown function error for operators", "committedDate": "2020-06-23T09:12:54Z", "type": "forcePushed"}, {"oid": "3cd70df81073bbee9470fba03da7d87fa9dc83ef", "url": "https://github.com/crate/crate/commit/3cd70df81073bbee9470fba03da7d87fa9dc83ef", "message": "Improve unknown function error for operators\n\nFormat the unknown operator in operator style, not function style.\nExample:\n  `unknown function: bool = ANY(integer)`", "committedDate": "2020-06-23T14:18:36Z", "type": "commit"}, {"oid": "3cd70df81073bbee9470fba03da7d87fa9dc83ef", "url": "https://github.com/crate/crate/commit/3cd70df81073bbee9470fba03da7d87fa9dc83ef", "message": "Improve unknown function error for operators\n\nFormat the unknown operator in operator style, not function style.\nExample:\n  `unknown function: bool = ANY(integer)`", "committedDate": "2020-06-23T14:18:36Z", "type": "forcePushed"}]}