{"pr_number": 10369, "pr_title": "Add doc-values aggregator for the count(v) aggregation.", "pr_createdAt": "2020-08-13T13:24:25Z", "pr_url": "https://github.com/crate/crate/pull/10369", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NDkxMw==", "url": "https://github.com/crate/crate/pull/10369#discussion_r469984913", "bodyText": "Could we also optimize the string type case?", "author": "mfussenegger", "createdAt": "2020-08-13T14:16:15Z", "path": "server/src/main/java/io/crate/execution/engine/aggregation/impl/CountAggregation.java", "diffHunk": "@@ -261,4 +284,51 @@ public LongState removeFromAggregatedState(RamAccounting ramAccounting,\n         }\n         return previousAggState;\n     }\n+\n+    @Override\n+    public DocValueAggregator<?> getDocValueAggregator(List<DataType<?>> argumentTypes,\n+                                                       List<MappedFieldType> fieldTypes) {", "originalCommit": "24ad1614a65c3a52f7b5e565ba662dfe595b0ad5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk5MDM3NQ==", "url": "https://github.com/crate/crate/pull/10369#discussion_r469990375", "bodyText": "Yes, I was looking into it because of the rest StringAgg, ArrayAgg and CollectAgg, I was planning to do it as a separate step, but can add it here as well.", "author": "kovrus", "createdAt": "2020-08-13T14:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NDkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk5MjkyNg==", "url": "https://github.com/crate/crate/pull/10369#discussion_r469992926", "bodyText": "Also fine to follow up on it later.", "author": "mfussenegger", "createdAt": "2020-08-13T14:26:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk4NDkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "b25b3f81cef65c06ade594867f3590da510cebc9", "chunk": "diff --git a/server/src/main/java/io/crate/execution/engine/aggregation/impl/CountAggregation.java b/server/src/main/java/io/crate/execution/engine/aggregation/impl/CountAggregation.java\nindex 611c4fb974..8a944f0505 100644\n--- a/server/src/main/java/io/crate/execution/engine/aggregation/impl/CountAggregation.java\n+++ b/server/src/main/java/io/crate/execution/engine/aggregation/impl/CountAggregation.java\n\n@@ -289,22 +302,34 @@ public class CountAggregation extends AggregationFunction<CountAggregation.LongS\n     public DocValueAggregator<?> getDocValueAggregator(List<DataType<?>> argumentTypes,\n                                                        List<MappedFieldType> fieldTypes) {\n         if (argumentTypes.size() == 1) {\n-            var dataType = argumentTypes.get(0);\n-            if (DataTypes.isNumericPrimitive(dataType)\n-                || dataType.id() == DataTypes.TIMESTAMPZ.id()\n-                || dataType.id() == DataTypes.TIMESTAMP.id()) {\n-                return new CountDocValueAggregator(fieldTypes.get(0).name());\n+            switch (argumentTypes.get(0).id()) {\n+                case ByteType.ID:\n+                case ShortType.ID:\n+                case IntegerType.ID:\n+                case LongType.ID:\n+                case TimestampType.ID_WITH_TZ:\n+                case TimestampType.ID_WITHOUT_TZ:\n+                case FloatType.ID:\n+                case DoubleType.ID:\n+                case GeoPointType.ID:\n+                    return new CountNumericDocValueAggregator(fieldTypes.get(0).name());\n+                case IpType.ID:\n+                case StringType.ID:\n+                    return new CountBinaryDocValueAggregator(fieldTypes.get(0).name());\n+\n+                default:\n+                    return null;\n             }\n         }\n         return null;\n     }\n \n-    private static class CountDocValueAggregator implements DocValueAggregator<LongState> {\n+    private static class CountNumericDocValueAggregator implements DocValueAggregator<LongState> {\n \n         private final String columnName;\n         private SortedNumericDocValues values;\n \n-        public CountDocValueAggregator(String columnName) {\n+        public CountNumericDocValueAggregator(String columnName) {\n             this.columnName = columnName;\n         }\n \n"}}, {"oid": "b25b3f81cef65c06ade594867f3590da510cebc9", "url": "https://github.com/crate/crate/commit/b25b3f81cef65c06ade594867f3590da510cebc9", "message": "fixup! Add doc-values aggregator for the count(v) aggregation.", "committedDate": "2020-08-13T14:51:51Z", "type": "forcePushed"}, {"oid": "d95d300c6c528ec3f030f14035daea7b846a936d", "url": "https://github.com/crate/crate/commit/d95d300c6c528ec3f030f14035daea7b846a936d", "message": "Add doc-values aggregator for the count(v) aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information", "committedDate": "2020-08-13T15:19:06Z", "type": "commit"}, {"oid": "d95d300c6c528ec3f030f14035daea7b846a936d", "url": "https://github.com/crate/crate/commit/d95d300c6c528ec3f030f14035daea7b846a936d", "message": "Add doc-values aggregator for the count(v) aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information", "committedDate": "2020-08-13T15:19:06Z", "type": "forcePushed"}, {"oid": "886235bdf4e89608ab599c8884be98f50d82dc79", "url": "https://github.com/crate/crate/commit/886235bdf4e89608ab599c8884be98f50d82dc79", "message": "Merge branch 'master' into r/count-doc-values-aggregator", "committedDate": "2020-08-13T16:16:01Z", "type": "commit"}]}