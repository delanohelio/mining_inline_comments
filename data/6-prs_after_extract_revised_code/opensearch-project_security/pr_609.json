{"pr_number": 609, "pr_title": "Refactor opendistro_security_action_trace logger", "pr_createdAt": "2020-07-31T04:14:36Z", "pr_url": "https://github.com/opensearch-project/security/pull/609", "timeline": [{"oid": "c60dff4ea1ddf3e09440ea802a918d11f5f05040", "url": "https://github.com/opensearch-project/security/commit/c60dff4ea1ddf3e09440ea802a918d11f5f05040", "message": "Refactor opendistro_security_action_trace logger", "committedDate": "2020-07-31T04:04:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQyMDA3Mg==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r463420072", "bodyText": "Should you check here if trace is enabled ?", "author": "dinusX", "createdAt": "2020-07-31T05:59:25Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/privileges/PrivilegesEvaluator.java", "diffHunk": "@@ -526,8 +527,8 @@ public String kibanaOpendistroRole() {\n             additionalPermissionsRequired.addAll(ConfigConstants.OPENDISTRO_SECURITY_SNAPSHOT_RESTORE_NEEDED_WRITE_PRIVILEGES);\n         }\n \n-        if(actionTrace.isTraceEnabled() && additionalPermissionsRequired.size() > 1) {\n-            actionTrace.trace((\"Additional permissions required: \"+additionalPermissionsRequired));\n+        if (additionalPermissionsRequired.size() > 1) {", "originalCommit": "c60dff4ea1ddf3e09440ea802a918d11f5f05040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNzYyMw==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r463437623", "bodyText": "No, that will break encapsulation and will not give any performance benefit.", "author": "vrozov", "createdAt": "2020-07-31T06:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQyMDA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxODI5MQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r464618291", "bodyText": "Just trying to understand this.\nIs it not possible to check via the static method import you have done for other classes ?\nThis is executed for every request and computing the logging string will add to performance degradation ?", "author": "sujithvm", "createdAt": "2020-08-03T19:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQyMDA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MjYxOQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r464682619", "bodyText": "I changed logging to smart logging format that avoids formatting log output unless the corresponding level (in this case trace) is enabled. Adding call to isActionTraceEnabled() will actually cause performance degradation when trace is enabled (due to extra call) and will not improve performance when it is disabled.", "author": "vrozov", "createdAt": "2020-08-03T21:54:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQyMDA3Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r464612067", "bodyText": "Why not move to a separate class to fully encapsulate the logic ?", "author": "sujithvm", "createdAt": "2020-08-03T19:16:47Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/OpenDistroSecurityPlugin.java", "diffHunk": "@@ -189,6 +194,18 @@\n     private volatile DlsFlsRequestValve dlsFlsValve = null;\n     private volatile Salt salt;\n \n+    public static boolean isActionTraceEnabled() {", "originalCommit": "c60dff4ea1ddf3e09440ea802a918d11f5f05040", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM0MTkxNA==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r465341914", "bodyText": "The functionality is too small to justify for a separate class, IMO.", "author": "vrozov", "createdAt": "2020-08-04T21:31:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYxNTQ5Ng==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r466615496", "bodyText": "I agree these 3 functions may be small but I dont think OpenDistroSecurityPlugin is the right place for this.", "author": "sujithvm", "createdAt": "2020-08-06T18:46:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY1NDYxOA==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r466654618", "bodyText": "Please suggest which class will be a better place to move those methods (new class is not an option).", "author": "vrozov", "createdAt": "2020-08-06T20:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY2MDU2MQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r466660561", "bodyText": "Curious as to why new class is not an option?", "author": "sujithvm", "createdAt": "2020-08-06T20:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3NDE5OQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r466674199", "bodyText": "The number of new lines of code that will be necessary to introduce with a new class (class declaration and private constructor) would be comparable to number of lines introduced in these 3 methods.\nIt helps to avoid using more memory in JVM metaspace (not a big deal)", "author": "vrozov", "createdAt": "2020-08-06T20:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwNjg4OQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r467206889", "bodyText": "IMO different functionality should warrant a separate class even if it is small and should not be comparing the number of lines changed.\nIsn't the goal of this PR to encapsulate the logic for action tracer ?\nJust curious to know how much more memory we are talking about", "author": "sujithvm", "createdAt": "2020-08-07T18:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2NTIxOQ==", "url": "https://github.com/opensearch-project/security/pull/609#discussion_r467965219", "bodyText": "The functionality is embedded into the Logger actionTrace member variable, there is no need to have a separate class for it.\nThe primary goal of the PR is to avoid excessive calls to LogManager.getLogger() in various places and especially every time OpenDistroSecurityRequestHandler instance is created.\n\nJust curious to know how much more memory we are talking about\n\nNot much, but we can leave this memory to other classes where a separate class is better justified.", "author": "vrozov", "createdAt": "2020-08-10T14:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYxMjA2Nw=="}], "type": "inlineReview", "revised_code": null}]}