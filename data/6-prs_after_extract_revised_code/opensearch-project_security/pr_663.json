{"pr_number": 663, "pr_title": "Close AuditLog while closing OpenDistroSecurityPlugin and unregister shutdown hook when closing AuditLogImpl.", "pr_createdAt": "2020-08-26T05:05:13Z", "pr_url": "https://github.com/opensearch-project/security/pull/663", "timeline": [{"oid": "bafac8ec2239871edbac10d487b62566bab5d8e7", "url": "https://github.com/opensearch-project/security/commit/bafac8ec2239871edbac10d487b62566bab5d8e7", "message": "Close AuditLog while closing OpenDistroSecurityPlugin and unregister shutdown hook when closing AuditLogImpl.", "committedDate": "2020-08-26T04:51:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2NTkyMA==", "url": "https://github.com/opensearch-project/security/pull/663#discussion_r477465920", "bodyText": "Shouldn't this be this.close() instead of messageRouter.close() ?", "author": "dinusX", "createdAt": "2020-08-26T17:24:24Z", "path": "src/main/java/com/amazon/opendistroforelasticsearch/security/auditlog/impl/AuditLogImpl.java", "diffHunk": "@@ -85,23 +86,11 @@ public AuditLogImpl(final Settings settings,\n \t\t\tsm.checkPermission(new SpecialPermission());\n \t\t}\n \n-\t\tAccessController.doPrivileged(new PrivilegedAction<Object>() {\n-\t\t\t@Override\n-\t\t\tpublic Object run() {\n-\t\t\t\tRuntime.getRuntime().addShutdownHook(new Thread() {\n-\n-\t\t\t\t\t@Override\n-\t\t\t\t\tpublic void run() {\n-\t\t\t\t\t\ttry {\n-\t\t\t\t\t\t\tclose();\n-\t\t\t\t\t\t} catch (final IOException e) {\n-\t\t\t\t\t\t\tlog.warn(\"Exception while shutting down message router\", e);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t});\n-\t\t\t\tlog.debug(\"Shutdown Hook registered\");\n-\t\t\t\treturn null;\n-\t\t\t}\n+\t\tshutdownHook = new Thread(() -> messageRouter.close());", "originalCommit": "bafac8ec2239871edbac10d487b62566bab5d8e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5MzU5Mg==", "url": "https://github.com/opensearch-project/security/pull/663#discussion_r477593592", "bodyText": "We can't call this.close() from the shutdown hook as it calls removeShutdownHook() while shutdown is in process.", "author": "vrozov", "createdAt": "2020-08-26T21:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ2NTkyMA=="}], "type": "inlineReview", "revised_code": null}]}