{"pr_number": 91, "pr_title": "Query Verification: Support for multiple table schema and ddl", "pr_createdAt": "2020-07-10T21:59:32Z", "pr_url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91", "timeline": [{"oid": "f7bb4528b90ac411e235814d080eddbb6d8f1e34", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/f7bb4528b90ac411e235814d080eddbb6d8f1e34", "message": "Support for multiple table schema and ddl", "committedDate": "2020-07-10T21:44:52Z", "type": "commit"}, {"oid": "d7d94d31034dbb467452d99aa485a5734aaea1b7", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/d7d94d31034dbb467452d99aa485a5734aaea1b7", "message": "improved error handling in reading json schema", "committedDate": "2020-07-13T16:07:09Z", "type": "commit"}, {"oid": "ee6b9e02c9e658b8a50cff0e329fd76f65a22077", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/ee6b9e02c9e658b8a50cff0e329fd76f65a22077", "message": "Merge branch 'master' into multipleTables", "committedDate": "2020-07-13T16:11:04Z", "type": "commit"}, {"oid": "4a598f2ff68f5940299fd1743c82133db5d06eb8", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/4a598f2ff68f5940299fd1743c82133db5d06eb8", "message": "fix test", "committedDate": "2020-07-13T19:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r453951357", "bodyText": "Does the schema job not return information about the table created that we can use here instead of reparsing the mgiratedSchema?", "author": "Luminarys", "createdAt": "2020-07-13T21:44:27Z", "path": "tools/query_verification/src/main/java/com/google/bigquery/QueryVerifier.java", "diffHunk": "@@ -51,26 +51,38 @@ public void verifyDataFree() {\n         // Create tables based on schema\n         if (migratedSchema != null) {\n             if (migratedSchema.isInJsonFormat()) {\n-                TableInfo tableInfo = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n-                if (tableInfo != null) {\n-                    Table table = bigQuery.create(tableInfo);\n-                    tables.add(table);\n-                } else {\n-                    System.out.println(migratedSchema.path() + \" is not correctly formatted.\");\n+                // Schema is JSON\n+                List<TableInfo> tableInfos = QueryVerifier.getTableInfoFromJsonSchema(migratedSchema);\n+                if (tableInfos != null) {\n+                    for (TableInfo tableInfo : tableInfos) {\n+                        Table table = bigQuery.create(tableInfo);\n+                        tables.add(table);\n+                    }\n                 }\n             } else {\n-                // TODO Load schema from DDL\n+                // Schema is DDL\n+                JobInfo jobInfo = configureJob(migratedSchema.schema(), false);\n+                Job schemaJob = bigQuery.create(jobInfo);\n+                try {\n+                    schemaJob.waitFor();\n+                } catch (InterruptedException e) {\n+                    System.out.println(e.getMessage());\n+                }\n+\n+                List<TableId> tableIds = QueryVerifier.getTableIdsFromDdlSchema(migratedSchema);", "originalCommit": "4a598f2ff68f5940299fd1743c82133db5d06eb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU0MTkwNw==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454541907", "bodyText": "I wasn't able to find that. I think the only table information it returns are the query results, which is empty in this case.", "author": "krishsuchdev", "createdAt": "2020-07-14T17:59:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYzNzAwOQ==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454637009", "bodyText": "Testing with the BQ UI it seems like this api is used which returns the table schema. Can you see if it's possible to use this?", "author": "Luminarys", "createdAt": "2020-07-14T20:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4MzQxMg==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454683412", "bodyText": "It looks like getQueryResults just returns null for ddl, so it doesnt return a schema for me.", "author": "krishsuchdev", "createdAt": "2020-07-14T22:33:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY5MzcwNA==", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/pull/91#discussion_r454693704", "bodyText": "Interesting. If it doesn't work then I guess this is fine. Thanks for checking!", "author": "Luminarys", "createdAt": "2020-07-14T23:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk1MTM1Nw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5c714bb89a6835c5d97a4ef46383370f6bdde00f", "url": "https://github.com/GoogleCloudPlatform/bigquery-utils/commit/5c714bb89a6835c5d97a4ef46383370f6bdde00f", "message": "Merge branch 'master' into multipleTables", "committedDate": "2020-07-15T13:09:11Z", "type": "commit"}]}