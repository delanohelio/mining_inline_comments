{"pr_number": 2379, "pr_title": "Enable support for HTTP compression in the webserver", "pr_createdAt": "2020-09-21T18:37:41Z", "pr_url": "https://github.com/oracle/helidon/pull/2379", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MTIyNg==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r493781226", "bodyText": "Main class/method is no longer needed for MP.\nYou can start the application using io.helidon.microprofile.cdi.Main", "author": "tomas-langer", "createdAt": "2020-09-23T17:54:14Z", "path": "tests/functional/mp-compression/src/main/java/io/helidon/tests/functional/mpcompression/Main.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*", "originalCommit": "08fb8035198b7939e3c2ea4fd3e293c7d276e6e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04467bdfcc14b47ccd56090e1300818562a5ecd0", "chunk": "diff --git a/tests/functional/mp-compression/src/main/java/io/helidon/tests/functional/mpcompression/Main.java b/tests/functional/mp-compression/src/main/java/io/helidon/tests/functional/mpcompression/Main.java\ndeleted file mode 100644\nindex ef8288768..000000000\n--- a/tests/functional/mp-compression/src/main/java/io/helidon/tests/functional/mpcompression/Main.java\n+++ /dev/null\n\n@@ -1,36 +0,0 @@\n-/*\n- * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package io.helidon.tests.functional.mpcompression;\n-\n-import io.helidon.microprofile.server.Server;\n-\n-public final class Main {\n-\n-    private static Server server;\n-\n-    private Main() {\n-    }\n-\n-    public static void main(String[] args) {\n-        server = Server.builder()\n-                .build()\n-                .start();\n-    }\n-\n-    static Server server() {\n-        return server;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MjgxNQ==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r493782815", "bodyText": "Please switch to @HelidonTest\n\nyou can inject WebTarget that will be configured to the port (that will be random) of the server\nthe test would automatically start and stop the CDI in the background for you\n\nDeclaration of fields:\n@Inject\nprivate WebTarget baseTarget;", "author": "tomas-langer", "createdAt": "2020-09-23T17:56:40Z", "path": "tests/functional/mp-compression/src/test/java/io/helidon/tests/functional/mpcompression/MpCompressionTest.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.tests.functional.mpcompression;\n+\n+import java.io.IOException;\n+import java.util.logging.LogManager;\n+\n+import javax.ws.rs.client.Client;\n+import javax.ws.rs.client.ClientBuilder;\n+import javax.ws.rs.client.WebTarget;\n+import javax.ws.rs.core.Response;\n+\n+import io.helidon.microprofile.server.Server;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+class MpCompressionTest {", "originalCommit": "08fb8035198b7939e3c2ea4fd3e293c7d276e6e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MzQxOA==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r493783418", "bodyText": "logging.properties is also automatically loaded by Helidon MP, so no need to add it manually", "author": "tomas-langer", "createdAt": "2020-09-23T17:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4MjgxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "04467bdfcc14b47ccd56090e1300818562a5ecd0", "chunk": "diff --git a/tests/functional/mp-compression/src/test/java/io/helidon/tests/functional/mpcompression/MpCompressionTest.java b/tests/functional/mp-compression/src/test/java/io/helidon/tests/functional/mpcompression/MpCompressionTest.java\ndeleted file mode 100644\nindex 048b38f5f..000000000\n--- a/tests/functional/mp-compression/src/test/java/io/helidon/tests/functional/mpcompression/MpCompressionTest.java\n+++ /dev/null\n\n@@ -1,73 +0,0 @@\n-/*\n- * Copyright (c) 2020 Oracle and/or its affiliates.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package io.helidon.tests.functional.mpcompression;\n-\n-import java.io.IOException;\n-import java.util.logging.LogManager;\n-\n-import javax.ws.rs.client.Client;\n-import javax.ws.rs.client.ClientBuilder;\n-import javax.ws.rs.client.WebTarget;\n-import javax.ws.rs.core.Response;\n-\n-import io.helidon.microprofile.server.Server;\n-\n-import org.junit.jupiter.api.AfterAll;\n-import org.junit.jupiter.api.BeforeAll;\n-import org.junit.jupiter.api.Test;\n-\n-import static org.hamcrest.CoreMatchers.is;\n-import static org.hamcrest.MatcherAssert.assertThat;\n-\n-class MpCompressionTest {\n-    private static Client client;\n-    private static Server server;\n-    private static WebTarget baseTarget;\n-\n-    @BeforeAll\n-    static void initClass() throws IOException {\n-        LogManager.getLogManager().readConfiguration(MpCompressionTest.class.getResourceAsStream(\"/logging.properties\"));\n-        Main.main(new String[0]);\n-        server = Main.server();\n-        client = ClientBuilder.newClient();\n-        baseTarget = client.target(\"http://localhost:\" + server.port());\n-    }\n-\n-    @AfterAll\n-    static void destroyClass() {\n-        server.stop();\n-    }\n-\n-    @Test\n-    void testGzip() throws Exception {\n-        WebTarget target = baseTarget.path(\"/compressed\");\n-        Response response = target.request().header(\"accept-encoding\", \"gzip\").get();\n-        assertOk(response, \"Hello World\");\n-    }\n-\n-    @Test\n-    void testDeflate() throws Exception {\n-        WebTarget target = baseTarget.path(\"/compressed\");\n-        Response response = target.request().header(\"accept-encoding\", \"deflate\").get();\n-        assertOk(response, \"Hello World\");\n-    }\n-\n-    private void assertOk(Response response, String expectedMessage) {\n-        assertThat(response.getStatus(), is(200));\n-        assertThat(response.readEntity(String.class), is(expectedMessage));\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4NDI2Nw==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r493784267", "bodyText": "Please change such statements to use Hamcrest assertion.\nThis should be assertThat(new String(...), is(\"{...\") - that is the common approach we have accros Helidon tests", "author": "tomas-langer", "createdAt": "2020-09-23T17:58:48Z", "path": "webserver/jersey/src/test/java/io/helidon/webserver/jersey/JerseySupportTest.java", "diffHunk": "@@ -311,8 +311,8 @@ public void streamingOutput() throws IOException {\n         try (InputStream is = response.readEntity(InputStream.class)) {\n             byte[] buffer = new byte[32];\n             int n = is.read(buffer);        // should read only first chunk\n-            assertEquals(new String(buffer, 0, n), \"{ value: \\\"first\\\" }\\n\");\n-            while ((n = is.read(buffer)) > 0) {\n+            assertEquals(\"{ value: \\\"first\\\" }\\n\", new String(buffer, 0, n));", "originalCommit": "08fb8035198b7939e3c2ea4fd3e293c7d276e6e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04467bdfcc14b47ccd56090e1300818562a5ecd0", "chunk": "diff --git a/webserver/jersey/src/test/java/io/helidon/webserver/jersey/JerseySupportTest.java b/webserver/jersey/src/test/java/io/helidon/webserver/jersey/JerseySupportTest.java\nindex 0cb60b582..4dba96bb9 100644\n--- a/webserver/jersey/src/test/java/io/helidon/webserver/jersey/JerseySupportTest.java\n+++ b/webserver/jersey/src/test/java/io/helidon/webserver/jersey/JerseySupportTest.java\n\n@@ -311,8 +311,8 @@ public class JerseySupportTest {\n         try (InputStream is = response.readEntity(InputStream.class)) {\n             byte[] buffer = new byte[32];\n             int n = is.read(buffer);        // should read only first chunk\n-            assertEquals(\"{ value: \\\"first\\\" }\\n\", new String(buffer, 0, n));\n-            while (is.read(buffer) > 0) {\n+            assertEquals(new String(buffer, 0, n), \"{ value: \\\"first\\\" }\\n\");\n+            while ((n = is.read(buffer)) > 0) {\n                 // consume rest of stream\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc4NTE4MQ==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r493785181", "bodyText": "This should maybe say \"for default socket\", as this is socket specific, if I understood this PR correctly", "author": "tomas-langer", "createdAt": "2020-09-23T18:00:18Z", "path": "webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java", "diffHunk": "@@ -751,6 +751,17 @@ public Builder workersCount(int workers) {\n             return this;\n         }\n \n+        /**\n+         * Configure whether to enable content negotiation for compression.", "originalCommit": "08fb8035198b7939e3c2ea4fd3e293c7d276e6e7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04467bdfcc14b47ccd56090e1300818562a5ecd0", "chunk": "diff --git a/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java b/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\nindex 3b575759f..a949f6a27 100644\n--- a/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\n+++ b/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\n\n@@ -751,17 +751,6 @@ public interface WebServer {\n             return this;\n         }\n \n-        /**\n-         * Configure whether to enable content negotiation for compression.\n-         *\n-         * @param value compression flag\n-         * @return updated builder instance\n-         */\n-        public Builder enableCompression(boolean value) {\n-            configurationBuilder.enableCompression(value);\n-            return this;\n-        }\n-\n         /**\n          * Set to {@code true} to print detailed feature information on startup.\n          *\n"}}, {"oid": "04467bdfcc14b47ccd56090e1300818562a5ecd0", "url": "https://github.com/oracle/helidon/commit/04467bdfcc14b47ccd56090e1300818562a5ecd0", "message": "Enable support for HTTP compression in the webserver. Netty provides support for gzip and deflate encodings. Some new tests to show how it works.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:44:49Z", "type": "commit"}, {"oid": "8fbfbcfd703de4b1ea9ed444a90993ac44fa3ab2", "url": "https://github.com/oracle/helidon/commit/8fbfbcfd703de4b1ea9ed444a90993ac44fa3ab2", "message": "Support for enable-compression flag, set to false by default. Test updated.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:44:49Z", "type": "commit"}, {"oid": "416ebe8d496c3afd6d7cf0116130992e2a03c50b", "url": "https://github.com/oracle/helidon/commit/416ebe8d496c3afd6d7cf0116130992e2a03c50b", "message": "New functional test for HTTP compression in MP. Restored old Jersey test.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:44:49Z", "type": "commit"}, {"oid": "41c5a2a27692617f1aedb4362f39bc75c5f7f81e", "url": "https://github.com/oracle/helidon/commit/41c5a2a27692617f1aedb4362f39bc75c5f7f81e", "message": "Some cleanup of pom and test files.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:44:49Z", "type": "commit"}, {"oid": "41c5a2a27692617f1aedb4362f39bc75c5f7f81e", "url": "https://github.com/oracle/helidon/commit/41c5a2a27692617f1aedb4362f39bc75c5f7f81e", "message": "Some cleanup of pom and test files.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:44:49Z", "type": "forcePushed"}, {"oid": "c2fc3c7e4be1d05158bf1d01bd605138e91b9cfb", "url": "https://github.com/oracle/helidon/commit/c2fc3c7e4be1d05158bf1d01bd605138e91b9cfb", "message": "2334 webserver compression (#2)\n\n* Enable support for HTTP compression in the webserver. Netty provides support for gzip and deflate encodings. Some new tests to show how it works.\r\n\r\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>\r\n\r\n* Support for enable-compression flag, set to false by default. Test updated.\r\n\r\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>\r\n\r\n* New functional test for HTTP compression in MP. Restored old Jersey test.\r\n\r\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>\r\n\r\n* Some cleanup of pom and test files.\r\n\r\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>\r\n\r\n* Changes for new test support.\r\n\r\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>\r\n\r\nCo-authored-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T18:52:35Z", "type": "commit"}, {"oid": "20a4edb9ce50df4baa751211b58974b4a0d833b7", "url": "https://github.com/oracle/helidon/commit/20a4edb9ce50df4baa751211b58974b4a0d833b7", "message": "Fixing some problems after a merge.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T19:40:57Z", "type": "commit"}, {"oid": "524d634ccea6388bfde67de9aa21cc28ab0c2fe6", "url": "https://github.com/oracle/helidon/commit/524d634ccea6388bfde67de9aa21cc28ab0c2fe6", "message": "Fixing some problems after a merge.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-23T19:41:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMyNzE1Mw==", "url": "https://github.com/oracle/helidon/pull/2379#discussion_r494327153", "bodyText": "This method should be annotated with @Override and the javadoc is not necessary. If the javadoc is there, please add \"negotiation for compression for the default socket\"", "author": "tomas-langer", "createdAt": "2020-09-24T13:42:43Z", "path": "webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java", "diffHunk": "@@ -751,6 +751,17 @@ public Builder workersCount(int workers) {\n             return this;\n         }\n \n+        /**\n+         * Configure whether to enable content negotiation for compression.\n+         *\n+         * @param value compression flag\n+         * @return updated builder instance\n+         */\n+        public Builder enableCompression(boolean value) {", "originalCommit": "524d634ccea6388bfde67de9aa21cc28ab0c2fe6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "673eb04d9a1d6da2443710dbe419b250d643c79b", "chunk": "diff --git a/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java b/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\nindex 470371b7b..925ffa56d 100644\n--- a/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\n+++ b/webserver/webserver/src/main/java/io/helidon/webserver/WebServer.java\n\n@@ -751,17 +757,6 @@ public interface WebServer {\n             return this;\n         }\n \n-        /**\n-         * Configure whether to enable content negotiation for compression.\n-         *\n-         * @param value compression flag\n-         * @return updated builder instance\n-         */\n-        public Builder enableCompression(boolean value) {\n-            configurationBuilder.enableCompression(value);\n-            return this;\n-        }\n-\n         /**\n          * Set to {@code true} to print detailed feature information on startup.\n          *\n"}}, {"oid": "673eb04d9a1d6da2443710dbe419b250d643c79b", "url": "https://github.com/oracle/helidon/commit/673eb04d9a1d6da2443710dbe419b250d643c79b", "message": "Fixed location and annotations on enableCompression method in builder.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>", "committedDate": "2020-09-24T13:51:40Z", "type": "commit"}]}