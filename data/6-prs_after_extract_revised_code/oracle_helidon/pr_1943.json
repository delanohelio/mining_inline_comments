{"pr_number": 1943, "pr_title": "MultiFromOutputStream blocking close refactor", "pr_createdAt": "2020-06-08T10:02:03Z", "pr_url": "https://github.com/oracle/helidon/pull/1943", "timeline": [{"oid": "c708f2462d5de4882e4bd443f4cbaabc66000759", "url": "https://github.com/oracle/helidon/commit/c708f2462d5de4882e4bd443f4cbaabc66000759", "message": "MultiFromOutputStream cs swap removal\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-08T10:00:20Z", "type": "commit"}, {"oid": "06c45a0e10b93dd5d27d32564ef624628bedf360", "url": "https://github.com/oracle/helidon/commit/06c45a0e10b93dd5d27d32564ef624628bedf360", "message": "Don't wait for close\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-08T15:44:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxMjA1NQ==", "url": "https://github.com/oracle/helidon/pull/1943#discussion_r436812055", "bodyText": "@romain-grecourt Is this still actual? There is no exception downstream can propagate to upstream except NPO, also is blocking of close still neccessary? Only proper way to complete is from upstream's side or maybe wait for cancel from downstream, but in such case we cant complete from upstream with close which is blocked by waiting for cancel.", "author": "danielkec", "createdAt": "2020-06-08T15:51:45Z", "path": "common/reactive/src/main/java/io/helidon/common/reactive/MultiFromOutputStream.java", "diffHunk": "@@ -116,48 +102,6 @@ public void write(int b) throws IOException {\n     @Override\n     public void close() throws IOException {\n         complete();\n-\n-        if (!written.get() && !completionResult.isCompletedExceptionally()) {\n-            // no need to wait for\n-            return;\n-        }\n-        try {\n-            completionResult.get(timeout, TimeUnit.MILLISECONDS);\n-        } catch (CancellationException e) {\n-            throw new IOException(e);\n-        } catch (InterruptedException e) {\n-            Thread.currentThread().interrupt();\n-            throw new IOException(e);\n-        } catch (ExecutionException e) {\n-            throw new IOException(e.getCause());\n-        } catch (TimeoutException e) {\n-            throw new IOException(\"Timed out while waiting for subscriber to read data\", e);\n-        }\n-    }\n-\n-    /**\n-     * Signals this publishing output stream that it can safely return from otherwise blocking invocation\n-     * to it's {@link #close()} method.\n-     * Subsequent multiple invocations of this method are allowed, but have no effect on this publishing output stream.\n-     * <p>\n-     * When the {@link #close()} method on this output stream is invoked, it will block waiting for a signal to complete.\n-     * This is useful in cases, when the receiving side needs to synchronize it's completion with the publisher, e.g. to\n-     * ensure that any resources used by the subscribing party are not released prematurely due to a premature exit from\n-     * publishing output stream {@code close()} method.\n-     * <p>\n-     * Additionally, this mechanism can be used to propagate any downstream completion exceptions back to this publisher\n-     * and up it's call stack. When a non-null {@code throwable} parameter is passed into the method, it will be wrapped\n-     * in an {@link IOException} and thrown from the {@code close()} method when it is invoked.\n-     *\n-     * @param throwable represents a completion error condition that should be thrown when a {@code close()} method is invoked\n-     *                  on this publishing output stream. If set to {@code null}, the {@code close()} method will exit normally.\n-     */\n-    void signalCloseComplete(Throwable throwable) {", "originalCommit": "06c45a0e10b93dd5d27d32564ef624628bedf360", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU5ODQxNw==", "url": "https://github.com/oracle/helidon/pull/1943#discussion_r437598417", "bodyText": "Not sure why you are asking me, did I write this code ? :D", "author": "romain-grecourt", "createdAt": "2020-06-09T17:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxMjA1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzYwMzE4MQ==", "url": "https://github.com/oracle/helidon/pull/1943#discussion_r437603181", "bodyText": "Sorry I was following the blame \ud83d\udd75\ufe0f . Next one to ask is @tomas-langer who modified the file last, WDYT Tomas?", "author": "danielkec", "createdAt": "2020-06-09T17:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxMjA1NQ=="}], "type": "inlineReview", "revised_code": null}]}