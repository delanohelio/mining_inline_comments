{"pr_number": 1921, "pr_title": "Media lazy accepted types parsing", "pr_createdAt": "2020-06-02T12:27:12Z", "pr_url": "https://github.com/oracle/helidon/pull/1921", "timeline": [{"oid": "99319f90d78b6ab9b5f23208e5040f5a1660a251", "url": "https://github.com/oracle/helidon/commit/99319f90d78b6ab9b5f23208e5040f5a1660a251", "message": "Lazy parsing of acceptedTypes\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T09:37:09Z", "type": "commit"}, {"oid": "2bc1d971c1a0f97e37db13163311909c997de2b0", "url": "https://github.com/oracle/helidon/commit/2bc1d971c1a0f97e37db13163311909c997de2b0", "message": "Lockless LazyValueImpl\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T10:33:30Z", "type": "commit"}, {"oid": "328e5ff7cbf3c7ee0821a34e025a541d1c6afb46", "url": "https://github.com/oracle/helidon/commit/328e5ff7cbf3c7ee0821a34e025a541d1c6afb46", "message": "Copyright fix\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T13:06:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkwMDM0NA==", "url": "https://github.com/oracle/helidon/pull/1921#discussion_r433900344", "bodyText": "This constructor is good.", "author": "tomas-langer", "createdAt": "2020-06-02T14:02:45Z", "path": "common/common/src/main/java/io/helidon/common/LazyValue.java", "diffHunk": "@@ -47,7 +47,7 @@\n      * @return a lazy value that will always return the value provided\n      */\n     static <T> LazyValue<T> create(T value) {\n-        return () -> value;\n+        return new LazyValueImpl<>(value);", "originalCommit": "328e5ff7cbf3c7ee0821a34e025a541d1c6afb46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MjE2Mg==", "url": "https://github.com/oracle/helidon/pull/1921#discussion_r434052162", "bodyText": "Deffered to #1924", "author": "danielkec", "createdAt": "2020-06-02T17:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkwMDM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "7fee4d17ca5b3c34efaaa3925fc0f4cb07ab3ebc", "chunk": "diff --git a/common/common/src/main/java/io/helidon/common/LazyValue.java b/common/common/src/main/java/io/helidon/common/LazyValue.java\nindex 827b854e0..d8f2a6b87 100644\n--- a/common/common/src/main/java/io/helidon/common/LazyValue.java\n+++ b/common/common/src/main/java/io/helidon/common/LazyValue.java\n\n@@ -47,7 +47,7 @@ public interface LazyValue<T> extends Supplier<T> {\n      * @return a lazy value that will always return the value provided\n      */\n     static <T> LazyValue<T> create(T value) {\n-        return new LazyValueImpl<>(value);\n+        return () -> value;\n     }\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkwMTYxOA==", "url": "https://github.com/oracle/helidon/pull/1921#discussion_r433901618", "bodyText": "Please revert the state to original implementation + add the new constructor that sets the value and sets loaded to true.", "author": "tomas-langer", "createdAt": "2020-06-02T14:04:02Z", "path": "common/common/src/main/java/io/helidon/common/LazyValueImpl.java", "diffHunk": "@@ -16,42 +16,28 @@\n \n package io.helidon.common;\n \n-import java.util.concurrent.locks.Lock;\n-import java.util.concurrent.locks.ReentrantLock;\n+import java.util.concurrent.atomic.AtomicReference;", "originalCommit": "328e5ff7cbf3c7ee0821a34e025a541d1c6afb46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MjM1MQ==", "url": "https://github.com/oracle/helidon/pull/1921#discussion_r434052351", "bodyText": "reverted", "author": "danielkec", "createdAt": "2020-06-02T17:33:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkwMTYxOA=="}], "type": "inlineReview", "revised_code": {"commit": "7fee4d17ca5b3c34efaaa3925fc0f4cb07ab3ebc", "chunk": "diff --git a/common/common/src/main/java/io/helidon/common/LazyValueImpl.java b/common/common/src/main/java/io/helidon/common/LazyValueImpl.java\nindex 14f9a4114..9920a0e9f 100644\n--- a/common/common/src/main/java/io/helidon/common/LazyValueImpl.java\n+++ b/common/common/src/main/java/io/helidon/common/LazyValueImpl.java\n\n@@ -16,28 +16,42 @@\n \n package io.helidon.common;\n \n-import java.util.concurrent.atomic.AtomicReference;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n import java.util.function.Supplier;\n \n class LazyValueImpl<T> implements LazyValue<T> {\n+    private final Lock theLock = new ReentrantLock();\n+\n+    private T value;\n \n-    private final AtomicReference<T> value = new AtomicReference<>();\n-    private T rawValue;\n     private Supplier<T> delegate;\n+    private volatile boolean loaded;\n \n     LazyValueImpl(Supplier<T> supplier) {\n         this.delegate = supplier;\n     }\n \n-    LazyValueImpl(T value) {\n-        this.rawValue = value;\n-    }\n-\n     @Override\n     public T get() {\n-        if (rawValue == null) {\n-            rawValue = value.updateAndGet(t -> t != null ? t : delegate.get());\n+        if (loaded) {\n+            return value;\n         }\n-        return rawValue;\n+\n+        // not loaded (probably)\n+        theLock.lock();\n+\n+        try {\n+            if (loaded) {\n+                return value;\n+            }\n+            value = delegate.get();\n+            loaded = true;\n+            delegate = null;\n+        } finally {\n+            theLock.unlock();\n+        }\n+\n+        return value;\n     }\n }\n"}}, {"oid": "7fee4d17ca5b3c34efaaa3925fc0f4cb07ab3ebc", "url": "https://github.com/oracle/helidon/commit/7fee4d17ca5b3c34efaaa3925fc0f4cb07ab3ebc", "message": "Revert LazyValue changes\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T17:32:58Z", "type": "commit"}, {"oid": "e5060e882660003ec0cdbce3d520514a86bf54c6", "url": "https://github.com/oracle/helidon/commit/e5060e882660003ec0cdbce3d520514a86bf54c6", "message": "Revert LazyValue copyright\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T17:34:49Z", "type": "commit"}, {"oid": "1c1a8a635cbee0e4577f3bd27ba5fdf30a9fd7ec", "url": "https://github.com/oracle/helidon/commit/1c1a8a635cbee0e4577f3bd27ba5fdf30a9fd7ec", "message": "LazyValue pre resolved value\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>", "committedDate": "2020-06-02T18:28:53Z", "type": "commit"}]}