{"pr_number": 1809, "pr_title": "Health check fixed", "pr_createdAt": "2020-05-15T17:46:47Z", "pr_url": "https://github.com/oracle/helidon/pull/1809", "timeline": [{"oid": "10438b99f6a4dd7c19054a731e3d3618114205c1", "url": "https://github.com/oracle/helidon/commit/10438b99f6a4dd7c19054a731e3d3618114205c1", "message": "Health check fixed for native image.\nAlso fixed for hotspot (used Set instead of List)\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-05-15T17:45:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2MDk1NQ==", "url": "https://github.com/oracle/helidon/pull/1809#discussion_r425960955", "bodyText": "Just double-checking.  Repeatable semantics here are OK?", "author": "ljnelson", "createdAt": "2020-05-15T17:57:27Z", "path": "health/health/src/main/java/io/helidon/health/HealthSupport.java", "diffHunk": "@@ -260,9 +259,9 @@ public static HealthSupport create(Config config) {\n      * Fluent API builder for {@link io.helidon.health.HealthSupport}.\n      */\n     public static final class Builder implements io.helidon.common.Builder<HealthSupport> {\n-        private final Set<HealthCheck> allChecks = new LinkedHashSet<>();\n-        private final Set<HealthCheck> livenessChecks = new LinkedHashSet<>();\n-        private final Set<HealthCheck> readinessChecks = new LinkedHashSet<>();\n+        private final List<HealthCheck> allChecks = new LinkedList<>();", "originalCommit": "10438b99f6a4dd7c19054a731e3d3618114205c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NTk1Nw==", "url": "https://github.com/oracle/helidon/pull/1809#discussion_r425965957", "bodyText": "It would be called twice. There was a problem that some of our health checks just disappeared (we ended up with 2 out of 6 in a test). Some quirk most likely caused by Weld proxies and their equals/hashCode methods.", "author": "tomas-langer", "createdAt": "2020-05-15T18:07:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2MDk1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NzEyNw==", "url": "https://github.com/oracle/helidon/pull/1809#discussion_r425967127", "bodyText": "I did consider using an identity set to at least prevent the same instances. Yet in MP, we register this from selected beans (so it should be unique), and in SE the user registers checks by hand (so they have full control).", "author": "tomas-langer", "createdAt": "2020-05-15T18:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2MDk1NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2MTUxMA==", "url": "https://github.com/oracle/helidon/pull/1809#discussion_r425961510", "bodyText": "typo", "author": "ljnelson", "createdAt": "2020-05-15T17:58:29Z", "path": "tests/integration/native-image/mp-1/src/main/java/io/helidon/tests/integration/nativeimage/mp1/Mp1Main.java", "diffHunk": "@@ -427,8 +429,13 @@ private static void validateHealth(Errors.Collector collector, WebTarget target)\n                 .get(JsonObject.class);\n \n         JsonArray checks = health.getJsonArray(\"checks\");\n-        if (checks.size() < 1) {\n-            collector.fatal(\"There should be at least one readiness healtcheck provided by this app\");\n+        if (checks.size() != 1) {\n+            collector.fatal(\"There should be a readiness healtcheck provided by this app\");", "originalCommit": "10438b99f6a4dd7c19054a731e3d3618114205c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2NjU3Mw==", "url": "https://github.com/oracle/helidon/pull/1809#discussion_r425966573", "bodyText": "Fixed.", "author": "tomas-langer", "createdAt": "2020-05-15T18:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk2MTUxMA=="}], "type": "inlineReview", "revised_code": {"commit": "ec1d10c208a23da71d1551fcfa1f09b863ee86d7", "chunk": "diff --git a/tests/integration/native-image/mp-1/src/main/java/io/helidon/tests/integration/nativeimage/mp1/Mp1Main.java b/tests/integration/native-image/mp-1/src/main/java/io/helidon/tests/integration/nativeimage/mp1/Mp1Main.java\nindex e96bc34375..564baf59c8 100644\n--- a/tests/integration/native-image/mp-1/src/main/java/io/helidon/tests/integration/nativeimage/mp1/Mp1Main.java\n+++ b/tests/integration/native-image/mp-1/src/main/java/io/helidon/tests/integration/nativeimage/mp1/Mp1Main.java\n\n@@ -430,7 +430,7 @@ public final class Mp1Main {\n \n         JsonArray checks = health.getJsonArray(\"checks\");\n         if (checks.size() != 1) {\n-            collector.fatal(\"There should be a readiness healtcheck provided by this app\");\n+            collector.fatal(\"There should be a readiness health check provided by this app\");\n         } else {\n             JsonObject check = checks.getJsonObject(0);\n             if (!\"mp1-ready\".equals(check.getString(\"name\"))) {\n"}}, {"oid": "ec1d10c208a23da71d1551fcfa1f09b863ee86d7", "url": "https://github.com/oracle/helidon/commit/ec1d10c208a23da71d1551fcfa1f09b863ee86d7", "message": "Typo fix.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-05-15T18:08:31Z", "type": "commit"}, {"oid": "962cc5938e734bb1cde8fcf8e426e33b149b67e6", "url": "https://github.com/oracle/helidon/commit/962cc5938e734bb1cde8fcf8e426e33b149b67e6", "message": "Using correct config node.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>", "committedDate": "2020-05-15T21:05:31Z", "type": "commit"}]}