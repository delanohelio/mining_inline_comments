{"pr_number": 4219, "pr_title": "iscsi session cleanup now configurable, filters iscsi partitions", "pr_createdAt": "2020-07-20T20:51:41Z", "pr_url": "https://github.com/apache/cloudstack/pull/4219", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4ODM3OA==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457788378", "bodyText": "To be honest, I am not 100% sure on this one, but I think that (boolean)params.get(\"config\") does not handle null parameters (e.g. when commented or removed from configurations).\nCan you please take a look and run a few tests considering those cases where the parameter is not on the configuration file?\nOne approach that I know it would work is Boolean.parseBoolean; parseBoolean handles null values (value = \"null->false\", pure = true).\nExample:\nBoolean _iscsiCleanUpEnabled = Boolean.parseBoolean((String)params.get(\"iscsi.session.cleanup.enabled\"));\n        \nif (BooleanUtils.isTrue(_iscsiCleanUpEnabled)) {", "author": "GabrielBrascher", "createdAt": "2020-07-21T01:50:51Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {", "originalCommit": "91648e4011a87dacecb404499daf70d088e5030a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NDE5Ng==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458874196", "bodyText": "Thanks for pointing this out. I used your approach.", "author": "skattoju4", "createdAt": "2020-07-22T15:20:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4ODM3OA=="}], "type": "inlineReview", "revised_code": {"commit": "a668d042633885cf398a514af78303c26e6523ac", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\nindex 8c0d88bae9..adefa90cb5 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\n\n@@ -1156,14 +1088,14 @@ public class LibvirtComputingResource extends ServerResourceBase implements Serv\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+        Boolean _iscsiCleanUpEnabled = Boolean.parseBoolean((String)params.get(\"iscsi.session.cleanup.enabled\"));\n \n-        if (_iscsiCleanUpEnabled) {\n+        if (BooleanUtils.isTrue(_iscsiCleanUpEnabled)) {\n             IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n             final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n             cleanupMonitor.start();\n         } else {\n-            s_logger.info(\"iscsi session clean up is disabled\")\n+            s_logger.info(\"iscsi session clean up is disabled\");\n         }\n \n         return true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk0MTkyOA==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457941928", "bodyText": "Can you please extract \"part\" to a constant?\nAdding some details/documentation on why it is important to have this constant checked might be a plus as well.", "author": "GabrielBrascher", "createdAt": "2020-07-21T08:54:23Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -114,7 +114,7 @@ private void updateDiskStatusMapWithInactiveIscsiSessions(Connect conn){\n \n                     //check the volume map. If an entry exists change the status to True\n                     for (final LibvirtVMDef.DiskDef disk : disks) {\n-                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())&&!disk.getDiskPath().contains(\"part\")) {", "originalCommit": "91648e4011a87dacecb404499daf70d088e5030a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NjA5Nw==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458876097", "bodyText": "@svenvogel @skattoju4 The commit from PR #3819 was added on 4.13, right? This PR should then be also aimed at branch 4.13.\n\nwould you know whats the best way to rebase it to 4.13 is ?", "author": "skattoju4", "createdAt": "2020-07-22T15:23:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk0MTkyOA=="}], "type": "inlineReview", "revised_code": {"commit": "a668d042633885cf398a514af78303c26e6523ac", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\nindex 89ce993818..e5ce6bbd9a 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n\n@@ -114,7 +114,7 @@ public class IscsiStorageCleanupMonitor implements Runnable{\n \n                     //check the volume map. If an entry exists change the status to True\n                     for (final LibvirtVMDef.DiskDef disk : disks) {\n-                        if (diskStatusMap.containsKey(disk.getDiskPath())&&!disk.getDiskPath().contains(\"part\")) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n                             diskStatusMap.put(disk.getDiskPath(), true);\n                             s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n                         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjE5OQ==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458216199", "bodyText": "I believe you have forgotten the ';' on here.", "author": "RodrigoDLopez", "createdAt": "2020-07-21T16:07:58Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {\n+            IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n+            final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n+            cleanupMonitor.start();\n+        } else {\n+            s_logger.info(\"iscsi session clean up is disabled\")", "originalCommit": "91648e4011a87dacecb404499daf70d088e5030a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NTEwMA==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458875100", "bodyText": "fixed", "author": "skattoju4", "createdAt": "2020-07-22T15:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjE5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a668d042633885cf398a514af78303c26e6523ac", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\nindex 8c0d88bae9..adefa90cb5 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java\n\n@@ -1156,14 +1088,14 @@ public class LibvirtComputingResource extends ServerResourceBase implements Serv\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+        Boolean _iscsiCleanUpEnabled = Boolean.parseBoolean((String)params.get(\"iscsi.session.cleanup.enabled\"));\n \n-        if (_iscsiCleanUpEnabled) {\n+        if (BooleanUtils.isTrue(_iscsiCleanUpEnabled)) {\n             IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n             final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n             cleanupMonitor.start();\n         } else {\n-            s_logger.info(\"iscsi session clean up is disabled\")\n+            s_logger.info(\"iscsi session clean up is disabled\");\n         }\n \n         return true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjYyOQ==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936629", "bodyText": "Is this constant used anywhere?", "author": "mike-tutkowski", "createdAt": "2020-07-22T16:46:53Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";", "originalCommit": "18ad7c7b9726ef5530733bbef00f012e67585ca0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5MDQzNw==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r459690437", "bodyText": "removed it", "author": "skattoju4", "createdAt": "2020-07-23T19:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a668d042633885cf398a514af78303c26e6523ac", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\nindex 5042acf7c6..e5ce6bbd9a 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n\n@@ -38,8 +38,6 @@ public class IscsiStorageCleanupMonitor implements Runnable{\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n-    private static final String KEYWORD_PART = \"part\";\n-    private static final String REGEX_PART = \"\\\\S+part\\\\d+$\";\n \n     private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjk5NQ==", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936995", "bodyText": "Perhaps we want to use KEYWORD_PART here instead of \"part\"?", "author": "mike-tutkowski", "createdAt": "2020-07-22T16:47:32Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";\n+    private static final String REGEX_PART = \"\\\\S+part\\\\d+$\";", "originalCommit": "18ad7c7b9726ef5530733bbef00f012e67585ca0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a668d042633885cf398a514af78303c26e6523ac", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\nindex 5042acf7c6..e5ce6bbd9a 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java\n\n@@ -38,8 +38,6 @@ public class IscsiStorageCleanupMonitor implements Runnable{\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n-    private static final String KEYWORD_PART = \"part\";\n-    private static final String REGEX_PART = \"\\\\S+part\\\\d+$\";\n \n     private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n \n"}}, {"oid": "a668d042633885cf398a514af78303c26e6523ac", "url": "https://github.com/apache/cloudstack/commit/a668d042633885cf398a514af78303c26e6523ac", "message": "resolved conflict", "committedDate": "2020-08-14T16:17:21Z", "type": "commit"}, {"oid": "e0c68643c3b4aaeb0b04da24d98695dc583a3ed1", "url": "https://github.com/apache/cloudstack/commit/e0c68643c3b4aaeb0b04da24d98695dc583a3ed1", "message": "resolved conflict in clean up monitor", "committedDate": "2020-08-14T16:19:05Z", "type": "commit"}, {"oid": "64bf2aaa8cea0f55ed8421dde3623e90cb57d753", "url": "https://github.com/apache/cloudstack/commit/64bf2aaa8cea0f55ed8421dde3623e90cb57d753", "message": "resolved conflict in agent properties", "committedDate": "2020-08-14T16:20:39Z", "type": "commit"}, {"oid": "b0e75cf2212cb6a5b719008f395796352b9aba16", "url": "https://github.com/apache/cloudstack/commit/b0e75cf2212cb6a5b719008f395796352b9aba16", "message": "use regex instead of contains", "committedDate": "2020-08-14T16:20:52Z", "type": "commit"}, {"oid": "9a36abdbe05cef812573a140b515731aaddf56c0", "url": "https://github.com/apache/cloudstack/commit/9a36abdbe05cef812573a140b515731aaddf56c0", "message": "remove excess \\", "committedDate": "2020-08-14T16:20:52Z", "type": "commit"}, {"oid": "c4011dfd6b1f69840be4fec8c239ae1764d9cdc2", "url": "https://github.com/apache/cloudstack/commit/c4011dfd6b1f69840be4fec8c239ae1764d9cdc2", "message": "Revert \"remove excess \\\"\n\nThis reverts commit 26776adde6b9818031b2d3e1785dbab05547b7da.", "committedDate": "2020-08-14T16:20:52Z", "type": "commit"}, {"oid": "7f34c9ed1850abd462388bdafa3f88faa062f921", "url": "https://github.com/apache/cloudstack/commit/7f34c9ed1850abd462388bdafa3f88faa062f921", "message": "import BooleanUtils removed unused constant", "committedDate": "2020-08-14T16:20:52Z", "type": "commit"}, {"oid": "7f34c9ed1850abd462388bdafa3f88faa062f921", "url": "https://github.com/apache/cloudstack/commit/7f34c9ed1850abd462388bdafa3f88faa062f921", "message": "import BooleanUtils removed unused constant", "committedDate": "2020-08-14T16:20:52Z", "type": "forcePushed"}]}