{"pr_number": 3844, "pr_title": "ISSUE-3838: Wrong SSVM behavior causes redownloading for all the templates", "pr_createdAt": "2020-01-28T04:16:13Z", "pr_url": "https://github.com/apache/cloudstack/pull/3844", "timeline": [{"oid": "ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "url": "https://github.com/apache/cloudstack/commit/ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "message": "Fixes #3838", "committedDate": "2020-01-28T04:47:57Z", "type": "forcePushed"}, {"oid": "b49a435cadf1828acf390062e8b1068eadad077e", "url": "https://github.com/apache/cloudstack/commit/b49a435cadf1828acf390062e8b1068eadad077e", "message": "Fixes #3838", "committedDate": "2020-01-28T04:50:27Z", "type": "forcePushed"}, {"oid": "241ecb9577e56bce95a23fa19f7c41def3477f9b", "url": "https://github.com/apache/cloudstack/commit/241ecb9577e56bce95a23fa19f7c41def3477f9b", "message": "Fixes #3838", "committedDate": "2020-01-28T05:02:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2MzQwNQ==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373463405", "bodyText": "moving away from the naming convention, (also i think it is not declared like this)", "author": "DaanHoogland", "createdAt": "2020-01-31T12:49:08Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -596,54 +594,54 @@ public String downloadPublicTemplate(long id, String url, String name, ImageForm\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-                    if (file.exists()) {\n-                        if(! file.delete()) {\n-                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                        }\n-                    }\n+            if (file.exists()) {\n+                if(! file.delete()) {\n+                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -594,54 +595,54 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-            if (file.exists()) {\n-                if(! file.delete()) {\n-                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                }\n-            }\n-\n-            if (!file.createNewFile()) {\n-                s_logger.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n-                return \"Unable to create new file: \" + file.getAbsolutePath();\n-            }\n+                    if (file.exists()) {\n+                        if(! file.delete()) {\n+                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n+                        }\n+                    }\n \n-            URI uri;\n-            try {\n-                uri = new URI(url);\n-            } catch (URISyntaxException e) {\n-                throw new CloudRuntimeException(\"URI is incorrect: \" + url);\n-            }\n-            TemplateDownloader td;\n-            if ((uri != null) && (uri.getScheme() != null)) {\n-                if (uri.getPath().endsWith(\".metalink\")) {\n-                    td = new MetalinkTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes);\n-                } else if (uri.getScheme().equalsIgnoreCase(\"http\") || uri.getScheme().equalsIgnoreCase(\"https\")) {\n-                    td = new HttpTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes, user, password, proxy, resourceType);\n-                } else if (uri.getScheme().equalsIgnoreCase(\"file\")) {\n-                    td = new LocalTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n-                } else if (uri.getScheme().equalsIgnoreCase(\"scp\")) {\n-                    td = new ScpTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n-                } else if (uri.getScheme().equalsIgnoreCase(\"nfs\") || uri.getScheme().equalsIgnoreCase(\"cifs\")) {\n-                    td = null;\n-                    // TODO: implement this.\n-                    throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n-                } else {\n-                    throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n-                }\n-            } else {\n-                throw new CloudRuntimeException(\"Unable to download from URL: \" + url);\n-            }\n-            // NOTE the difference between installPathPrefix and templatePath\n-            // here. instalPathPrefix is the absolute path for template\n-            // including mount directory\n-            // on ssvm, while templatePath is the final relative path on\n-            // secondary storage.\n-            DownloadJob dj = new DownloadJob(td, jobId, id, name, format, hvm, accountId, descr, cksum, installPathPrefix, resourceType);\n-            dj.setTmpltPath(templatePath);\n-            jobs.put(jobId, dj);\n-            threadPool.execute(td);\n+                    if (!file.createNewFile()) {\n+                        LOGGER.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n+                        return \"Unable to create new file: \" + file.getAbsolutePath();\n+                    }\n \n-            return jobId;\n+                    URI uri;\n+                    try {\n+                        uri = new URI(url);\n+                    } catch (URISyntaxException e) {\n+                        throw new CloudRuntimeException(\"URI is incorrect: \" + url);\n+                    }\n+                    TemplateDownloader td;\n+                    if ((uri != null) && (uri.getScheme() != null)) {\n+                        if (uri.getPath().endsWith(\".metalink\")) {\n+                            td = new MetalinkTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes);\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"http\") || uri.getScheme().equalsIgnoreCase(\"https\")) {\n+                            td = new HttpTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes, user, password, proxy, resourceType);\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"file\")) {\n+                            td = new LocalTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"scp\")) {\n+                            td = new ScpTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"nfs\") || uri.getScheme().equalsIgnoreCase(\"cifs\")) {\n+                            td = null;\n+                            // TODO: implement this.\n+                            throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n+                        } else {\n+                            throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n+                        }\n+                    } else {\n+                        throw new CloudRuntimeException(\"Unable to download from URL: \" + url);\n+                    }\n+                    // NOTE the difference between installPathPrefix and templatePath\n+                    // here. instalPathPrefix is the absolute path for template\n+                    // including mount directory\n+                    // on ssvm, while templatePath is the final relative path on\n+                    // secondary storage.\n+                    DownloadJob dj = new DownloadJob(td, jobId, id, name, format, hvm, accountId, descr, cksum, installPathPrefix, resourceType);\n+                    dj.setTmpltPath(templatePath);\n+                    jobs.put(jobId, dj);\n+                    threadPool.execute(td);\n+\n+                    return jobId;\n         } catch (IOException e) {\n             LOGGER.warn(\"Unable to download to \" + tmpDir, e);\n             return null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NDYzOQ==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373464639", "bodyText": "probably due to rebase? LOGGER", "author": "DaanHoogland", "createdAt": "2020-01-31T12:52:25Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -596,54 +594,54 @@ public String downloadPublicTemplate(long id, String url, String name, ImageForm\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-                    if (file.exists()) {\n-                        if(! file.delete()) {\n-                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                        }\n-                    }\n+            if (file.exists()) {\n+                if(! file.delete()) {\n+                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n+                }\n+            }\n \n-                    if (!file.createNewFile()) {\n-                        LOGGER.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n-                        return \"Unable to create new file: \" + file.getAbsolutePath();\n-                    }\n+            if (!file.createNewFile()) {\n+                s_logger.warn(\"Unable to create new file: \" + file.getAbsolutePath());", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -594,54 +595,54 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-            if (file.exists()) {\n-                if(! file.delete()) {\n-                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                }\n-            }\n-\n-            if (!file.createNewFile()) {\n-                s_logger.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n-                return \"Unable to create new file: \" + file.getAbsolutePath();\n-            }\n+                    if (file.exists()) {\n+                        if(! file.delete()) {\n+                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n+                        }\n+                    }\n \n-            URI uri;\n-            try {\n-                uri = new URI(url);\n-            } catch (URISyntaxException e) {\n-                throw new CloudRuntimeException(\"URI is incorrect: \" + url);\n-            }\n-            TemplateDownloader td;\n-            if ((uri != null) && (uri.getScheme() != null)) {\n-                if (uri.getPath().endsWith(\".metalink\")) {\n-                    td = new MetalinkTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes);\n-                } else if (uri.getScheme().equalsIgnoreCase(\"http\") || uri.getScheme().equalsIgnoreCase(\"https\")) {\n-                    td = new HttpTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes, user, password, proxy, resourceType);\n-                } else if (uri.getScheme().equalsIgnoreCase(\"file\")) {\n-                    td = new LocalTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n-                } else if (uri.getScheme().equalsIgnoreCase(\"scp\")) {\n-                    td = new ScpTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n-                } else if (uri.getScheme().equalsIgnoreCase(\"nfs\") || uri.getScheme().equalsIgnoreCase(\"cifs\")) {\n-                    td = null;\n-                    // TODO: implement this.\n-                    throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n-                } else {\n-                    throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n-                }\n-            } else {\n-                throw new CloudRuntimeException(\"Unable to download from URL: \" + url);\n-            }\n-            // NOTE the difference between installPathPrefix and templatePath\n-            // here. instalPathPrefix is the absolute path for template\n-            // including mount directory\n-            // on ssvm, while templatePath is the final relative path on\n-            // secondary storage.\n-            DownloadJob dj = new DownloadJob(td, jobId, id, name, format, hvm, accountId, descr, cksum, installPathPrefix, resourceType);\n-            dj.setTmpltPath(templatePath);\n-            jobs.put(jobId, dj);\n-            threadPool.execute(td);\n+                    if (!file.createNewFile()) {\n+                        LOGGER.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n+                        return \"Unable to create new file: \" + file.getAbsolutePath();\n+                    }\n \n-            return jobId;\n+                    URI uri;\n+                    try {\n+                        uri = new URI(url);\n+                    } catch (URISyntaxException e) {\n+                        throw new CloudRuntimeException(\"URI is incorrect: \" + url);\n+                    }\n+                    TemplateDownloader td;\n+                    if ((uri != null) && (uri.getScheme() != null)) {\n+                        if (uri.getPath().endsWith(\".metalink\")) {\n+                            td = new MetalinkTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes);\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"http\") || uri.getScheme().equalsIgnoreCase(\"https\")) {\n+                            td = new HttpTemplateDownloader(_storage, url, tmpDir, new Completion(jobId), maxTemplateSizeInBytes, user, password, proxy, resourceType);\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"file\")) {\n+                            td = new LocalTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"scp\")) {\n+                            td = new ScpTemplateDownloader(_storage, url, tmpDir, maxTemplateSizeInBytes, new Completion(jobId));\n+                        } else if (uri.getScheme().equalsIgnoreCase(\"nfs\") || uri.getScheme().equalsIgnoreCase(\"cifs\")) {\n+                            td = null;\n+                            // TODO: implement this.\n+                            throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n+                        } else {\n+                            throw new CloudRuntimeException(\"Scheme is not supported \" + url);\n+                        }\n+                    } else {\n+                        throw new CloudRuntimeException(\"Unable to download from URL: \" + url);\n+                    }\n+                    // NOTE the difference between installPathPrefix and templatePath\n+                    // here. instalPathPrefix is the absolute path for template\n+                    // including mount directory\n+                    // on ssvm, while templatePath is the final relative path on\n+                    // secondary storage.\n+                    DownloadJob dj = new DownloadJob(td, jobId, id, name, format, hvm, accountId, descr, cksum, installPathPrefix, resourceType);\n+                    dj.setTmpltPath(templatePath);\n+                    jobs.put(jobId, dj);\n+                    threadPool.execute(td);\n+\n+                    return jobId;\n         } catch (IOException e) {\n             LOGGER.warn(\"Unable to download to \" + tmpDir, e);\n             return null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTUxMA==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465510", "bodyText": "renamed to LOGGER", "author": "DaanHoogland", "createdAt": "2020-01-31T12:54:40Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -850,10 +848,15 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -848,15 +849,14 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        NfsPathParser parser = new NfsPathParser(rootdir);\n-        script.execute(parser);\n+        PathParser zpp = new PathParser(rootdir);\n+        script.execute(zpp);\n         if (script.getExitValue() != 0) {\n-            s_logger.error(\"Error while executing script \" + script.toString());\n+            LOGGER.error(\"Error while executing script \" + script.toString());\n             throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n         }\n-        result.addAll(parser.getPaths());\n-        s_logger.info(\"found \" + parser.getPaths().size() + \" volumes\" + parser.getPaths());\n-\n+        result.addAll(zpp.getPaths());\n+        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n         return result;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTU4MA==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465580", "bodyText": "LOGGER", "author": "DaanHoogland", "createdAt": "2020-01-31T12:54:51Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -850,10 +848,15 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());\n+            throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n+        }\n+        result.addAll(parser.getPaths());\n+        s_logger.info(\"found \" + parser.getPaths().size() + \" volumes\" + parser.getPaths());", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -848,15 +849,14 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        NfsPathParser parser = new NfsPathParser(rootdir);\n-        script.execute(parser);\n+        PathParser zpp = new PathParser(rootdir);\n+        script.execute(zpp);\n         if (script.getExitValue() != 0) {\n-            s_logger.error(\"Error while executing script \" + script.toString());\n+            LOGGER.error(\"Error while executing script \" + script.toString());\n             throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n         }\n-        result.addAll(parser.getPaths());\n-        s_logger.info(\"found \" + parser.getPaths().size() + \" volumes\" + parser.getPaths());\n-\n+        result.addAll(zpp.getPaths());\n+        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n         return result;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTY3Mg==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465672", "bodyText": "sorry", "author": "DaanHoogland", "createdAt": "2020-01-31T12:55:05Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -862,10 +865,14 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -865,14 +865,14 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        NfsPathParser parser = new NfsPathParser(rootdir);\n-        script.execute(parser);\n+        PathParser zpp = new PathParser(rootdir);\n+        script.execute(zpp);\n         if (script.getExitValue() != 0) {\n-            s_logger.error(\"Error while executing script \" + script.toString());\n+            LOGGER.error(\"Error while executing script \" + script.toString());\n             throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n         }\n-        result.addAll(parser.getPaths());\n-        s_logger.info(\"found \" + parser.getPaths().size() + \" templates\" + parser.getPaths());\n+        result.addAll(zpp.getPaths());\n+        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n         return result;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTczNQ==", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465735", "bodyText": "again", "author": "DaanHoogland", "createdAt": "2020-01-31T12:55:17Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -862,10 +865,14 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());\n+            throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n+        }\n+        result.addAll(parser.getPaths());\n+        s_logger.info(\"found \" + parser.getPaths().size() + \" templates\" + parser.getPaths());", "originalCommit": "41da80493063311920883e33b8f5baeb2b8dbbee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "949fab1095933151d4264677e995f3bf72c7d1c3", "chunk": "diff --git a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\nindex 3120c06ad7..4149cd174d 100644\n--- a/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n+++ b/services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java\n\n@@ -865,14 +865,14 @@ public class DownloadManagerImpl extends ManagerBase implements DownloadManager\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        NfsPathParser parser = new NfsPathParser(rootdir);\n-        script.execute(parser);\n+        PathParser zpp = new PathParser(rootdir);\n+        script.execute(zpp);\n         if (script.getExitValue() != 0) {\n-            s_logger.error(\"Error while executing script \" + script.toString());\n+            LOGGER.error(\"Error while executing script \" + script.toString());\n             throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n         }\n-        result.addAll(parser.getPaths());\n-        s_logger.info(\"found \" + parser.getPaths().size() + \" templates\" + parser.getPaths());\n+        result.addAll(zpp.getPaths());\n+        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n         return result;\n     }\n \n"}}, {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3", "url": "https://github.com/apache/cloudstack/commit/949fab1095933151d4264677e995f3bf72c7d1c3", "message": "Resolved conflicts.", "committedDate": "2020-02-03T10:17:02Z", "type": "commit"}, {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3", "url": "https://github.com/apache/cloudstack/commit/949fab1095933151d4264677e995f3bf72c7d1c3", "message": "Resolved conflicts.", "committedDate": "2020-02-03T10:17:02Z", "type": "forcePushed"}]}