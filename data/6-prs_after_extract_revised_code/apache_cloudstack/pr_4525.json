{"pr_number": 4525, "pr_title": "xenserver: check and eject patch vbd for systemvms", "pr_createdAt": "2020-12-09T08:02:55Z", "pr_url": "https://github.com/apache/cloudstack/pull/4525", "timeline": [{"oid": "d962e569589d85228ec4a591e015173c0ae22784", "url": "https://github.com/apache/cloudstack/commit/d962e569589d85228ec4a591e015173c0ae22784", "message": "xenserver: check and eject patch vbd for systemvms\n\nThis failed to destroy systemvms patch VBDs that attaches systemvm.iso\non host setup (ready). This will ensure for upgrades old systemvm.iso\nfiles are not cached/used.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-09T08:00:25Z", "type": "commit"}, {"oid": "6cb9b300ad19408be9d6a50f96d86b864f9880a1", "url": "https://github.com/apache/cloudstack/commit/6cb9b300ad19408be9d6a50f96d86b864f9880a1", "message": "try to unplug before destroying\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-09T08:11:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjQ4Nw==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539102487", "bodyText": "@rhtyd Makes sense to eject only when ISO is inserted. Verified that this is being handled in all cases before ejecting vdb, except here.", "author": "sureshanaparti", "createdAt": "2020-12-09T08:26:55Z", "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1499,7 +1499,10 @@ public void destroyPatchVbd(final Connection conn, final String vmName) throws X\n                 final Set<VBD> vbds = vm.getVBDs(conn);\n                 for (final VBD vbd : vbds) {\n                     if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        vbd.eject(conn);\n+                        if (!vbd.getEmpty(conn)) {", "originalCommit": "6cb9b300ad19408be9d6a50f96d86b864f9880a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTExMTYwMw==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539111603", "bodyText": "agree that it makes sense, but I don't see why this yields the bug @vladimirpetrov saw. However if this fixes it for him, i'm all \ud83d\udc4d", "author": "DaanHoogland", "createdAt": "2020-12-09T08:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjQ4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "chunk": "diff --git a/plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java b/plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java\nindex 401ccf8578..f90fc8dfa7 100644\n--- a/plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java\n+++ b/plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java\n\n@@ -1489,27 +1489,31 @@ public abstract class CitrixResourceBase implements ServerResource, HypervisorRe\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n+    public void ejectPatchVbd(final Connection conn, final Host host) {\n+        try {\n+            final Set<VM> vms = host.getResidentVMs(conn);\n+            for (final VM vm : vms) {\n+                destroyPatchVbd(conn, vm);\n+            }\n+        } catch (XenAPIException | XmlRpcException ignored) {}\n+    }\n+\n+    public void destroyPatchVbd(final Connection conn, final VM vm) throws XmlRpcException, XenAPIException {\n+        final String vmName = vm.getNameLabel(conn);\n         try {\n             if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n                 return;\n             }\n-            final Set<VM> vms = VM.getByNameLabel(conn, vmName);\n-            for (final VM vm : vms) {\n-                final Set<VBD> vbds = vm.getVBDs(conn);\n-                for (final VBD vbd : vbds) {\n-                    if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        if (!vbd.getEmpty(conn)) {\n-                            vbd.eject(conn);\n-                        }\n-                        vbd.unplug(conn);\n-                        vbd.destroy(conn);\n-                        break;\n-                    }\n+            final Set<VBD> vbds = vm.getVBDs(conn);\n+            for (final VBD vbd : vbds) {\n+                if (Types.VbdType.CD.equals(vbd.getType(conn))) {\n+                    vbd.eject(conn);\n+                    vbd.destroy(conn);\n+                    break;\n                 }\n             }\n         } catch (final Exception e) {\n-            s_logger.debug(\"Cannot destory CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);\n+            s_logger.debug(\"Cannot destroy CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);\n         }\n     }\n \n"}}, {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "url": "https://github.com/apache/cloudstack/commit/8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "message": "fix\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-09T10:21:58Z", "type": "commit"}, {"oid": "a2e23fe90f83e9b3eb47568001bb712d967c792a", "url": "https://github.com/apache/cloudstack/commit/a2e23fe90f83e9b3eb47568001bb712d967c792a", "message": "workaround fix\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-09T11:10:14Z", "type": "commit"}, {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077", "url": "https://github.com/apache/cloudstack/commit/7fe57cf25bde54c1793aafee80f2647d78301077", "message": "add defensive checks\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-09T11:12:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMzY1Mg==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539233652", "bodyText": "@sureshanaparti @DaanHoogland @vladimirpetrov this confirms that this is a XS issue, the fix was to eject and then insert the new systemvm.iso and then eject is again \ud83e\udd26", "author": "rhtyd", "createdAt": "2020-12-09T11:37:27Z", "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,24 +1502,33 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n-        try {\n-            if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n-                return;\n-            }\n-            final Set<VM> vms = VM.getByNameLabel(conn, vmName);\n-            for (final VM vm : vms) {\n+    public void destroyPatchVbd(final Connection conn, final Set<VM> vms) throws XmlRpcException, XenAPIException {\n+        final SR sr = findPatchIsoSR(conn);\n+        final VDI patchVDI = findPatchIsoVDI(conn, sr);\n+        for (final VM vm : vms) {\n+            final String vmName = vm.getNameLabel(conn);\n+            try {\n+                if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n+                    return;\n+                }\n                 final Set<VBD> vbds = vm.getVBDs(conn);\n                 for (final VBD vbd : vbds) {\n-                    if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        vbd.eject(conn);\n+                    if (Types.VbdType.CD.equals(vbd.getType(conn))) {\n+                        if (!vbd.getEmpty(conn)) {\n+                            vbd.eject(conn);\n+                        }\n+                        // Workaround for any file descriptor caching issue\n+                        if (patchVDI != null) {\n+                            vbd.insert(conn, patchVDI);\n+                            vbd.eject(conn);", "originalCommit": "7fe57cf25bde54c1793aafee80f2647d78301077", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI0MDU4OA==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539240588", "bodyText": "@sureshanaparti @DaanHoogland @vladimirpetrov this confirms that this is a XS issue, the fix was to eject and then insert the new systemvm.iso and then eject is again \ud83e\udd26\n\nany specific version of XS?", "author": "sureshanaparti", "createdAt": "2020-12-09T11:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMzY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI1MDAyMQ==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539250021", "bodyText": "We've tested/reproduced this on XS7.1", "author": "rhtyd", "createdAt": "2020-12-09T12:03:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMzY1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTE5MA==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539289190", "bodyText": "is thsi a bedug message or maybe error or warn?", "author": "DaanHoogland", "createdAt": "2020-12-09T13:04:42Z", "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,27 +1489,31 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n+    public void ejectPatchVbd(final Connection conn, final Host host) {\n+        try {\n+            final Set<VM> vms = host.getResidentVMs(conn);\n+            for (final VM vm : vms) {\n+                destroyPatchVbd(conn, vm);\n+            }\n+        } catch (XenAPIException | XmlRpcException ignored) {}\n+    }\n+\n+    public void destroyPatchVbd(final Connection conn, final VM vm) throws XmlRpcException, XenAPIException {\n+        final String vmName = vm.getNameLabel(conn);\n         try {\n             if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n                 return;\n             }\n-            final Set<VM> vms = VM.getByNameLabel(conn, vmName);\n-            for (final VM vm : vms) {\n-                final Set<VBD> vbds = vm.getVBDs(conn);\n-                for (final VBD vbd : vbds) {\n-                    if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        if (!vbd.getEmpty(conn)) {\n-                            vbd.eject(conn);\n-                        }\n-                        vbd.unplug(conn);\n-                        vbd.destroy(conn);\n-                        break;\n-                    }\n+            final Set<VBD> vbds = vm.getVBDs(conn);\n+            for (final VBD vbd : vbds) {\n+                if (Types.VbdType.CD.equals(vbd.getType(conn))) {\n+                    vbd.eject(conn);\n+                    vbd.destroy(conn);\n+                    break;\n                 }\n             }\n         } catch (final Exception e) {\n-            s_logger.debug(\"Cannot destory CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);\n+            s_logger.debug(\"Cannot destroy CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);", "originalCommit": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwNDE1NQ==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539304155", "bodyText": "Yes the action failure is ignorable", "author": "rhtyd", "createdAt": "2020-12-09T13:26:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTE5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTc5MA==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539289790", "bodyText": "can we ignore this completely (without at least diagnostic debug message)?", "author": "DaanHoogland", "createdAt": "2020-12-09T13:05:35Z", "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,27 +1489,31 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n+    public void ejectPatchVbd(final Connection conn, final Host host) {\n+        try {\n+            final Set<VM> vms = host.getResidentVMs(conn);\n+            for (final VM vm : vms) {\n+                destroyPatchVbd(conn, vm);\n+            }\n+        } catch (XenAPIException | XmlRpcException ignored) {}", "originalCommit": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwNDQ3Ng==", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539304476", "bodyText": "Ignorable I think", "author": "rhtyd", "createdAt": "2020-12-09T13:27:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTc5MA=="}], "type": "inlineReview", "revised_code": null}]}