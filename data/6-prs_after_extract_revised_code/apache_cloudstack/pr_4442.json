{"pr_number": 4442, "pr_title": "Preventing port 53 being added as lb rule when dns service is availab\u2026", "pr_createdAt": "2020-11-05T04:32:31Z", "pr_url": "https://github.com/apache/cloudstack/pull/4442", "timeline": [{"oid": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989", "url": "https://github.com/apache/cloudstack/commit/07836a2db4c1dc8e27dbba98b9cc1bfced9a3989", "message": "Preventing port 53 being added as lb rule when dns service is available in network offering", "committedDate": "2020-11-05T04:29:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NTgyMQ==", "url": "https://github.com/apache/cloudstack/pull/4442#discussion_r518655821", "bodyText": "can you factor 53 out as DNS_PORT?", "author": "DaanHoogland", "createdAt": "2020-11-06T10:21:33Z", "path": "server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java", "diffHunk": "@@ -1598,65 +1602,73 @@ public LoadBalancer createPublicLoadBalancerRule(String xId, String name, String\n         // LoadBalancer result = _elbMgr.handleCreateLoadBalancerRule(lb,\n         // lbOwner, lb.getNetworkId());\n         LoadBalancer result = null;\n-        if (result == null) {\n-            IpAddress systemIp = null;\n-            NetworkOffering off = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n-            if (off.isElasticLb() && ipVO == null && network.getVpcId() == null) {\n-                systemIp = _ipAddrMgr.assignSystemIp(networkId, lbOwner, true, false);\n-                if (systemIp != null) {\n-                    ipVO = _ipAddressDao.findById(systemIp.getId());\n+        IpAddress systemIp = null;\n+        NetworkOffering off = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n+\n+        if (srcPortStart == 53 && ipVO.isSourceNat()) {", "originalCommit": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2NjY2Mg==", "url": "https://github.com/apache/cloudstack/pull/4442#discussion_r518666662", "bodyText": "Sure @DaanHoogland", "author": "Spaceman1984", "createdAt": "2020-11-06T10:41:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NTgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODczMzYzNA==", "url": "https://github.com/apache/cloudstack/pull/4442#discussion_r518733634", "bodyText": "Done", "author": "Spaceman1984", "createdAt": "2020-11-06T12:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NTgyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7e2c7d4f2ccb429e1a42e8bd6d32f185c0fcef54", "chunk": "diff --git a/server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java b/server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java\nindex e6c04ca830..0ac0374204 100644\n--- a/server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java\n+++ b/server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java\n\n@@ -1605,7 +1606,7 @@ public class LoadBalancingRulesManagerImpl<Type> extends ManagerBase implements\n         IpAddress systemIp = null;\n         NetworkOffering off = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n \n-        if (srcPortStart == 53 && ipVO.isSourceNat()) {\n+        if (srcPortStart == DNS_PORT && ipVO.isSourceNat()) {\n             List<NetworkOfferingServiceMapVO> offeringServices = _networkOfferingServiceDao.listByNetworkOfferingId(network.getNetworkOfferingId());\n             for (NetworkOfferingServiceMapVO serviceMapVo: offeringServices) {\n                 if (serviceMapVo.getService().equals(Service.Dns.getName())) {\n"}}, {"oid": "7e2c7d4f2ccb429e1a42e8bd6d32f185c0fcef54", "url": "https://github.com/apache/cloudstack/commit/7e2c7d4f2ccb429e1a42e8bd6d32f185c0fcef54", "message": "Changed dns port to static final var", "committedDate": "2020-11-06T12:55:29Z", "type": "commit"}]}