{"pr_number": 4177, "pr_title": "Prevent deploying IPv6 network if Zone has no IPv6 DNS configured", "pr_createdAt": "2020-06-24T21:08:39Z", "pr_url": "https://github.com/apache/cloudstack/pull/4177", "timeline": [{"oid": "ce658ac25bead28879778ce604d1cf924ef15d3f", "url": "https://github.com/apache/cloudstack/commit/ce658ac25bead28879778ce604d1cf924ef15d3f", "message": "Deploy ipv6 network if zone has IPv6 DNS\n\nIf you have a IPv6 enabled network and you haven't specified the IPv6 DNS 1 and DNS 2 under the zone it causes dnsmasq inside the Virtual Router not to start", "committedDate": "2020-06-25T18:12:41Z", "type": "commit"}, {"oid": "ce658ac25bead28879778ce604d1cf924ef15d3f", "url": "https://github.com/apache/cloudstack/commit/ce658ac25bead28879778ce604d1cf924ef15d3f", "message": "Deploy ipv6 network if zone has IPv6 DNS\n\nIf you have a IPv6 enabled network and you haven't specified the IPv6 DNS 1 and DNS 2 under the zone it causes dnsmasq inside the Virtual Router not to start", "committedDate": "2020-06-25T18:12:41Z", "type": "forcePushed"}, {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00", "url": "https://github.com/apache/cloudstack/commit/e060158d2c25b9865a8245ab430a3c19dd986e00", "message": "Add test case for networkModel.checkIp6Parameters\n\nFix logic on checkIp6Parameters", "committedDate": "2020-06-26T04:59:32Z", "type": "commit"}, {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00", "url": "https://github.com/apache/cloudstack/commit/e060158d2c25b9865a8245ab430a3c19dd986e00", "message": "Add test case for networkModel.checkIp6Parameters\n\nFix logic on checkIp6Parameters", "committedDate": "2020-06-26T04:59:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0ODYwMg==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446148602", "bodyText": "CloudStack uses SLAAC for managing IPv6 ranges, therefore it is not necessary to have a start/end IPv6 address; on the other hand, IPv6 CIDR is mandatory for IPv6 networks.\nThat is why I changed this and other pieces of code that had start/end ipv6 address as mandatory.", "author": "GabrielBrascher", "createdAt": "2020-06-26T12:19:04Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3781,7 +3781,7 @@ public Vlan createVlanAndPublicIpRange(final long zoneId, final long networkId,\n             ipv4 = true;\n         }\n \n-        if (startIPv6 != null) {\n+        if (vlanIp6Cidr != null) {", "originalCommit": "e060158d2c25b9865a8245ab430a3c19dd986e00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MDE3MQ==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446150171", "bodyText": "Due to SLAAC implementation, an IPv6 network needs CIDR and Gateway. With the refactored code a network is \"marked\" as ipv6 if IPv6 CIDR and Gateway are not null.", "author": "GabrielBrascher", "createdAt": "2020-06-26T12:22:22Z", "path": "server/src/main/java/com/cloud/network/NetworkServiceImpl.java", "diffHunk": "@@ -1195,7 +1195,7 @@ public Network createGuestNetwork(CreateNetworkCmd cmd) throws InsufficientCapac\n         if (startIP != null) {\n             ipv4 = true;\n         }\n-        if (startIPv6 != null) {\n+        if (isNotBlank(ip6Cidr) && isNotBlank(ip6Gateway)) {", "originalCommit": "e060158d2c25b9865a8245ab430a3c19dd986e00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ee923d80fd7bed7e55dfafafbf91351c1a039a26", "chunk": "diff --git a/server/src/main/java/com/cloud/network/NetworkServiceImpl.java b/server/src/main/java/com/cloud/network/NetworkServiceImpl.java\nindex c28dd8502c..148271a3ee 100644\n--- a/server/src/main/java/com/cloud/network/NetworkServiceImpl.java\n+++ b/server/src/main/java/com/cloud/network/NetworkServiceImpl.java\n\n@@ -1179,18 +1164,6 @@ public class NetworkServiceImpl extends ManagerBase implements NetworkService, C\n             throw new InvalidParameterValueException(\"Parameter subDomainAccess can be specified only with aclType=Domain\");\n         }\n \n-        if (aclType == ACLType.Domain) {\n-            owner = _accountDao.findById(Account.ACCOUNT_ID_SYSTEM);\n-        }\n-\n-        // The network name is unique under the account\n-        if (!AllowDuplicateNetworkName.valueIn(owner.getAccountId())) {\n-            List<NetworkVO> existingNetwork = _networksDao.listByAccountIdNetworkName(owner.getId(), name);\n-            if (!existingNetwork.isEmpty()) {\n-                throw new InvalidParameterValueException(\"Another network with same name already exists within account: \" + owner.getAccountName());\n-            }\n-        }\n-\n         boolean ipv4 = true, ipv6 = false;\n         if (startIP != null) {\n             ipv4 = true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MDY3Nw==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446150677", "bodyText": "Nowadays IPv6 networking support only /64 CIDR. Added Unit tests covering this.", "author": "GabrielBrascher", "createdAt": "2020-06-26T12:23:18Z", "path": "server/src/test/java/com/cloud/network/NetworkModelTest.java", "diffHunk": "@@ -90,6 +91,11 @@\n     private static final long PHYSICAL_NETWORK_1_ID = 1L;\n     private static final long PHYSICAL_NETWORK_2_ID = 2L;\n \n+    private static final String IPV6_CIDR = \"fd59:16ba:559b:243d::/64\";", "originalCommit": "e060158d2c25b9865a8245ab430a3c19dd986e00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "1898b2fd2b2addb54e3cc3847bc597303b563c5b", "url": "https://github.com/apache/cloudstack/commit/1898b2fd2b2addb54e3cc3847bc597303b563c5b", "message": "Merge branch 'master' into validate-ipv6-network", "committedDate": "2020-09-24T08:44:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwMDg2OQ==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r494800869", "bodyText": "can you encapsulate this in our local proxy to the StringUtils, so migration efforts will be located in a single file?", "author": "DaanHoogland", "createdAt": "2020-09-25T07:31:26Z", "path": "server/src/main/java/com/cloud/network/NetworkModelImpl.java", "diffHunk": "@@ -2207,14 +2207,8 @@ public boolean isNetworkInlineMode(Network network) {\n \n     @Override\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n-        if (!NetUtils.isValidIp6(startIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the startIPv6 parameter\");\n-        }\n-        if (!NetUtils.isValidIp6(endIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the endIPv6 parameter\");\n-        }\n \n-        if (!(ip6Gateway != null && ip6Cidr != null)) {\n+        if (org.apache.commons.lang3.StringUtils.isBlank(ip6Gateway) || org.apache.commons.lang3.StringUtils.isBlank(ip6Cidr)) {", "originalCommit": "1898b2fd2b2addb54e3cc3847bc597303b563c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYxODE4NA==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r495618184", "bodyText": "Fixed @DaanHoogland, code is now using the  com.cloud.utils.StringUtils.isBlank. Thanks!", "author": "GabrielBrascher", "createdAt": "2020-09-27T21:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwMDg2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b66843ecf26146964a17ae6023c0891ed82ff6c1", "chunk": "diff --git a/server/src/main/java/com/cloud/network/NetworkModelImpl.java b/server/src/main/java/com/cloud/network/NetworkModelImpl.java\nindex fc11206dc0..42f52c2a30 100644\n--- a/server/src/main/java/com/cloud/network/NetworkModelImpl.java\n+++ b/server/src/main/java/com/cloud/network/NetworkModelImpl.java\n\n@@ -2208,7 +2208,7 @@ public class NetworkModelImpl extends ManagerBase implements NetworkModel, Confi\n     @Override\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n \n-        if (org.apache.commons.lang3.StringUtils.isBlank(ip6Gateway) || org.apache.commons.lang3.StringUtils.isBlank(ip6Cidr)) {\n+        if (StringUtils.isBlank(ip6Gateway) || StringUtils.isBlank(ip6Cidr)) {\n             throw new InvalidParameterValueException(\"ip6Gateway and ip6Cidr should be defined when startIPv6/endIPv6 are passed in\");\n         }\n \n"}}, {"oid": "b66843ecf26146964a17ae6023c0891ed82ff6c1", "url": "https://github.com/apache/cloudstack/commit/b66843ecf26146964a17ae6023c0891ed82ff6c1", "message": "Use CloudStack StringUtils instead of org.apache.commons.lang3.StringUtils", "committedDate": "2020-09-27T21:08:21Z", "type": "commit"}, {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d", "url": "https://github.com/apache/cloudstack/commit/c90e1e23824eaeb2e1cf5326d717763212d2440d", "message": "Consider an IPv6 network if ip6Cidr not null at createVlanAndPublicIpRange(CreateVlanIpRangeCmd)", "committedDate": "2020-10-28T05:48:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MTk4MA==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r513351980", "bodyText": "@GabrielBrascher may be this exception msg has to be updated, as it is not sure here that startIPv6/endIPv6 are passed or not, as the checks for startIPv6/endIPv6 are moved after this.", "author": "sureshanaparti", "createdAt": "2020-10-28T10:57:47Z", "path": "server/src/main/java/com/cloud/network/NetworkModelImpl.java", "diffHunk": "@@ -2207,14 +2207,8 @@ public boolean isNetworkInlineMode(Network network) {\n \n     @Override\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n-        if (!NetUtils.isValidIp6(startIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the startIPv6 parameter\");\n-        }\n-        if (!NetUtils.isValidIp6(endIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the endIPv6 parameter\");\n-        }\n \n-        if (!(ip6Gateway != null && ip6Cidr != null)) {\n+        if (StringUtils.isBlank(ip6Gateway) || StringUtils.isBlank(ip6Cidr)) {\n             throw new InvalidParameterValueException(\"ip6Gateway and ip6Cidr should be defined when startIPv6/endIPv6 are passed in\");", "originalCommit": "c90e1e23824eaeb2e1cf5326d717763212d2440d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzUyMzUwNA==", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r513523504", "bodyText": "Just pushed a commit addressing your comment. Thanks Suresh.", "author": "GabrielBrascher", "createdAt": "2020-10-28T15:09:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MTk4MA=="}], "type": "inlineReview", "revised_code": {"commit": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "chunk": "diff --git a/server/src/main/java/com/cloud/network/NetworkModelImpl.java b/server/src/main/java/com/cloud/network/NetworkModelImpl.java\nindex 42f52c2a30..4322478d93 100644\n--- a/server/src/main/java/com/cloud/network/NetworkModelImpl.java\n+++ b/server/src/main/java/com/cloud/network/NetworkModelImpl.java\n\n@@ -2209,7 +2209,7 @@ public class NetworkModelImpl extends ManagerBase implements NetworkModel, Confi\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n \n         if (StringUtils.isBlank(ip6Gateway) || StringUtils.isBlank(ip6Cidr)) {\n-            throw new InvalidParameterValueException(\"ip6Gateway and ip6Cidr should be defined when startIPv6/endIPv6 are passed in\");\n+            throw new InvalidParameterValueException(\"ip6Gateway and ip6Cidr should be defined for an IPv6 network work properly\");\n         }\n \n         if (!NetUtils.isValidIp6(ip6Gateway)) {\n"}}, {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "url": "https://github.com/apache/cloudstack/commit/c52730d5e5497664f6d5d4793e1b2dceec281eb8", "message": "Enhance log message on checkIp6Parameters", "committedDate": "2020-10-28T15:08:51Z", "type": "commit"}, {"oid": "ee923d80fd7bed7e55dfafafbf91351c1a039a26", "url": "https://github.com/apache/cloudstack/commit/ee923d80fd7bed7e55dfafafbf91351c1a039a26", "message": "Enhance log message on checkIp6Parameters", "committedDate": "2020-10-28T18:35:09Z", "type": "forcePushed"}, {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "url": "https://github.com/apache/cloudstack/commit/c52730d5e5497664f6d5d4793e1b2dceec281eb8", "message": "Enhance log message on checkIp6Parameters", "committedDate": "2020-10-28T15:08:51Z", "type": "forcePushed"}]}