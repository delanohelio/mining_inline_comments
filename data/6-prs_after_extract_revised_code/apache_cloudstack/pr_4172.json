{"pr_number": 4172, "pr_title": "[VMware] Support to attach more than 15 data disks in VMware VM", "pr_createdAt": "2020-06-24T13:39:48Z", "pr_url": "https://github.com/apache/cloudstack/pull/4172", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMTIxNQ==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445221215", "bodyText": "Minor one: can you please add braces to this if statement?", "author": "nvazquez", "createdAt": "2020-06-24T23:13:18Z", "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -2068,13 +2068,16 @@ protected StartAnswer execute(StartCommand cmd) {\n                         }\n                     }\n                 } else {\n-                    controllerKey = vmMo.getScsiDiskControllerKeyNoException(diskController);\n+                    if (VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber))", "originalCommit": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEwNjA3OQ==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r448106079", "bodyText": "Minor one: can you please add braces to this if statement?\n\nupdated this", "author": "sureshanaparti", "createdAt": "2020-07-01T04:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMTIxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e73ca06f75b7ae065df20403fd6851028fb052b", "chunk": "diff --git a/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java b/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\nindex e19f0afb93..33cabc3d74 100644\n--- a/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\n+++ b/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\n\n@@ -2068,8 +2068,9 @@ public class VmwareResource implements StoragePoolResource, ServerResource, Vmwa\n                         }\n                     }\n                 } else {\n-                    if (VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber))\n+                    if (VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber)) {\n                         scsiUnitNumber++;\n+                    }\n \n                     controllerKey = vmMo.getScsiDiskControllerKeyNoException(diskController, scsiUnitNumber);\n                     if (controllerKey == -1) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzI2Ng==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445223266", "bodyText": "Also minor: unnecessary parenthesis", "author": "nvazquez", "createdAt": "2020-06-24T23:19:47Z", "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -2098,10 +2101,17 @@ protected StartAnswer execute(StartCommand cmd) {\n                     assert (volumeDsDetails != null);\n \n                     String[] diskChain = syncDiskChain(dcMo, vmMo, vmSpec, vol, matchingExistingDisk, dataStoresDetails);\n-                    if (controllerKey == scsiControllerKey && VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber))\n+\n+                    int deviceNumber = -1;\n+                    if (controllerKey == vmMo.getIDEControllerKey(ideUnitNumber)) {\n+                        deviceNumber = (ideUnitNumber % VmwareHelper.MAX_ALLOWED_DEVICES_IDE_CONTROLLER);", "originalCommit": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODEwNjExMA==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r448106110", "bodyText": "Also minor: unnecessary parenthesis\n\nupdated", "author": "sureshanaparti", "createdAt": "2020-07-01T04:19:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzI2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "2e73ca06f75b7ae065df20403fd6851028fb052b", "chunk": "diff --git a/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java b/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\nindex e19f0afb93..33cabc3d74 100644\n--- a/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\n+++ b/plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java\n\n@@ -2104,7 +2105,7 @@ public class VmwareResource implements StoragePoolResource, ServerResource, Vmwa\n \n                     int deviceNumber = -1;\n                     if (controllerKey == vmMo.getIDEControllerKey(ideUnitNumber)) {\n-                        deviceNumber = (ideUnitNumber % VmwareHelper.MAX_ALLOWED_DEVICES_IDE_CONTROLLER);\n+                        deviceNumber = ideUnitNumber % VmwareHelper.MAX_ALLOWED_DEVICES_IDE_CONTROLLER;\n                         ideUnitNumber++;\n                     } else {\n                         deviceNumber = scsiUnitNumber % VmwareHelper.MAX_ALLOWED_DEVICES_SCSI_CONTROLLER;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNDA3Nw==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445224077", "bodyText": "Maybe also a null check for scsiDiskDevicesOnController?", "author": "nvazquez", "createdAt": "2020-06-24T23:22:21Z", "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "diffHunk": "@@ -2412,6 +2419,23 @@ public void ensureScsiDeviceControllers(int count, int availableBusNum) throws E\n         }\n     }\n \n+    private boolean isValidScsiDiskController(VirtualSCSIController scsiDiskController) {\n+        if (scsiDiskController == null) {\n+            return false;\n+        }\n+\n+        List<Integer> scsiDiskDevicesOnController = scsiDiskController.getDevice();\n+        if (scsiDiskDevicesOnController != null && scsiDiskDevicesOnController.size() >= (VmwareHelper.MAX_SUPPORTED_DEVICES_SCSI_CONTROLLER)) {", "originalCommit": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMDA1NA==", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r448110054", "bodyText": "Maybe also a null check for scsiDiskDevicesOnController?\n\nupdated", "author": "sureshanaparti", "createdAt": "2020-07-01T04:36:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNDA3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2e73ca06f75b7ae065df20403fd6851028fb052b", "chunk": "diff --git a/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java b/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java\nindex 21e82784e2..394505627a 100644\n--- a/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java\n+++ b/vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java\n\n@@ -2425,7 +2425,7 @@ public class VirtualMachineMO extends BaseMO {\n         }\n \n         List<Integer> scsiDiskDevicesOnController = scsiDiskController.getDevice();\n-        if (scsiDiskDevicesOnController != null && scsiDiskDevicesOnController.size() >= (VmwareHelper.MAX_SUPPORTED_DEVICES_SCSI_CONTROLLER)) {\n+        if (scsiDiskDevicesOnController == null || scsiDiskDevicesOnController.size() >= (VmwareHelper.MAX_SUPPORTED_DEVICES_SCSI_CONTROLLER)) {\n             return false;\n         }\n \n"}}, {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b", "url": "https://github.com/apache/cloudstack/commit/2e73ca06f75b7ae065df20403fd6851028fb052b", "message": "[VMware] Support to attach more than 15 data disks in VMware VM", "committedDate": "2020-07-01T04:53:46Z", "type": "commit"}, {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b", "url": "https://github.com/apache/cloudstack/commit/2e73ca06f75b7ae065df20403fd6851028fb052b", "message": "[VMware] Support to attach more than 15 data disks in VMware VM", "committedDate": "2020-07-01T04:53:46Z", "type": "forcePushed"}]}