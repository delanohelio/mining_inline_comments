{"pr_number": 4428, "pr_title": "Moved dedicated hosts to the end of the resultset when selecting an e\u2026", "pr_createdAt": "2020-10-27T10:40:22Z", "pr_url": "https://github.com/apache/cloudstack/pull/4428", "timeline": [{"oid": "2c417131154b873eddf0ac89ed5d6264076cd476", "url": "https://github.com/apache/cloudstack/commit/2c417131154b873eddf0ac89ed5d6264076cd476", "message": "Moved dedicated hosts to the end of the resultset when selecting an endpoint", "committedDate": "2020-10-27T10:26:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512649778", "bodyText": "if we randomise and limit to one result, what does it matter what the ordering of the set is?", "author": "DaanHoogland", "createdAt": "2020-10-27T12:26:30Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +131,15 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        for (Long hostId: dedicatedHosts){ // put dedicated hosts at the end of the result set\n+            sbuilder.append(\"field(t.id, '\" + hostId +\"'),\" );\n+        }\n+        sbuilder.append(\" rand() limit 1\");", "originalCommit": "2c417131154b873eddf0ac89ed5d6264076cd476", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY1NzA5Mw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512657093", "bodyText": "The limit is only applied after the ordering and the dedicated hosts are not part of the randomization.", "author": "Spaceman1984", "createdAt": "2020-10-27T12:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcxNTgxOA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512715818", "bodyText": "ok, really not very clear code than. What would the resulting sql of this be?", "author": "DaanHoogland", "createdAt": "2020-10-27T13:59:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcxOTY4Mg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512719682", "bodyText": "select t.id from (\n    select h.id, cd.value \n    from host h \n    join storage_pool_host_ref s on h.id = s.host_id  \n    join cluster c on c.id=h.cluster_id \n    left join cluster_details cd on c.id=cd.cluster_id \n    and cd.name='cluster.storage.operations.exclude' \n    where h.status = 'Up' \n    and h.type = 'Routing' \n    and h.resource_state = 'Enabled' \n    and s.pool_id = 1\n    and h.data_center_id = 1\n) t \nwhere t.value<>'true' \nor t.value is null \nORDER BY field(t.id, '2'), field(t.id, '5'), rand() limit 1", "author": "Spaceman1984", "createdAt": "2020-10-27T14:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjcyODE5Mg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512728192", "bodyText": "so why this complicated way to filter out specific values? It isn't very readible and we can add tham to the where clause as not t.id in (<hostID>, ...)", "author": "DaanHoogland", "createdAt": "2020-10-27T14:15:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc1NDEyMA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512754120", "bodyText": "We don't want to filter them out, just reorder because there can be the case of all hosts being dedicated.", "author": "Spaceman1984", "createdAt": "2020-10-27T14:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjc3MjI5Mw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512772293", "bodyText": "ok, next question, why two separate field() calls and not a combined one?", "author": "DaanHoogland", "createdAt": "2020-10-27T15:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIzMjY4Nw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r513232687", "bodyText": "Yes, I have been thinking about that, I may be able to combine this into 1 field call. - I'll see what I can do.", "author": "Spaceman1984", "createdAt": "2020-10-28T07:39:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex de184270a3..b7cd205ecf 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -136,8 +137,17 @@ public class DefaultEndPointSelector implements EndPointSelector {\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n         sbuilder.append(\" ORDER by \");\n-        for (Long hostId: dedicatedHosts){ // put dedicated hosts at the end of the result set\n-            sbuilder.append(\"field(t.id, '\" + hostId +\"'),\" );\n+        if (dedicatedHosts.size() > 0) {\n+            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n+            sbuilder.append(\"field(t.id, \");\n+            Iterator<Long> hostIt = dedicatedHosts.iterator();\n+            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n+                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n+                if (hostIt.hasNext()) {\n+                    sbuilder.append(\",\");\n+                }\n+            }\n+            sbuilder.append(\"),\" );\n         }\n         sbuilder.append(\" rand() limit 1\");\n         String sql = sbuilder.toString();\n"}}, {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "url": "https://github.com/apache/cloudstack/commit/dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "message": "Reduced calling the field method to 1 call and randomized dedicated hosts", "committedDate": "2020-10-28T09:05:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MzExMQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r514093111", "bodyText": "can this be a separate method (i.e. moveDedicatedHostsToBackForExclusion(sbuilder,dedicatedHosts);) ?", "author": "DaanHoogland", "createdAt": "2020-10-29T08:49:48Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        if (dedicatedHosts.size() > 0) {\n+            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n+            sbuilder.append(\"field(t.id, \");\n+            Iterator<Long> hostIt = dedicatedHosts.iterator();\n+            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n+                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n+                if (hostIt.hasNext()) {\n+                    sbuilder.append(\",\");\n+                }\n+            }\n+            sbuilder.append(\"),\" );\n+        }", "originalCommit": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY2NTk3Mw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r518665973", "bodyText": "pretty please, @Spaceman1984", "author": "DaanHoogland", "createdAt": "2020-11-06T10:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY3NDQ4Mg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r518674482", "bodyText": "I'll see what I can do @DaanHoogland", "author": "Spaceman1984", "createdAt": "2020-11-06T10:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzODEyOQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519638129", "bodyText": "Done", "author": "Spaceman1984", "createdAt": "2020-11-09T08:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MzExMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d85bcdfdd7f46c25acf8d60141a478b7784c427c", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex b7cd205ecf..7ae8529702 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -138,16 +138,7 @@ public class DefaultEndPointSelector implements EndPointSelector {\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n         sbuilder.append(\" ORDER by \");\n         if (dedicatedHosts.size() > 0) {\n-            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n-            sbuilder.append(\"field(t.id, \");\n-            Iterator<Long> hostIt = dedicatedHosts.iterator();\n-            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n-                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n-                if (hostIt.hasNext()) {\n-                    sbuilder.append(\",\");\n-                }\n-            }\n-            sbuilder.append(\"),\" );\n+            moveDedicatedHostsToLowerPriority(sbuilder, dedicatedHosts);\n         }\n         sbuilder.append(\" rand() limit 1\");\n         String sql = sbuilder.toString();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519578227", "bodyText": "@Spaceman1984 get the dedicated hosts list based on the scope here, instead all hosts. not required to iterate through all hosts for the given scope.", "author": "sureshanaparti", "createdAt": "2020-11-09T06:35:55Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();", "originalCommit": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTcxMjA5MA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519712090", "bodyText": "This call doesn't get all hosts, it gets all dedicated hosts, which is then used to build up a random list of dedicated hosts to move to the back of the result set. To remove some of the entries I will have to iterate through another list of hosts from another resultset which I think would cause more overhead than doing it this way. Or am I misunderstanding your intention?", "author": "Spaceman1984", "createdAt": "2020-11-09T10:42:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM5MDYxMA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r520390610", "bodyText": "This call doesn't get all hosts, it gets all dedicated hosts, which is then used to build up a random list of dedicated hosts to move to the back of the result set. To remove some of the entries I will have to iterate through another list of hosts from another resultset which I think would cause more overhead than doing it this way. Or am I misunderstanding your intention?\n\n@Spaceman1984 I mean to say, pick only the dedicated hosts based on the scope. For example, whenever the pool scope is Cluster, pick all the dedicated hosts in that cluster only, not the entire list of dedicated hosts. Got it?", "author": "sureshanaparti", "createdAt": "2020-11-10T08:54:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM5Njg0MQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r520396841", "bodyText": "Yes, I understand. Making this change is not going to reduce the size of the result set, it will reduce the number of ids to order against. I don't think adding this complexity is worth the effort as this functionality is not available in the DAO, I will have to write a few more functions to make that happen. If you feel that we need this, then I will go ahead.", "author": "Spaceman1984", "createdAt": "2020-11-10T09:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM5OTYxOQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r520399619", "bodyText": "I mean, if a host is not in the order list it gets ignored.", "author": "Spaceman1984", "createdAt": "2020-11-10T09:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyOTc3MQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r520429771", "bodyText": "@Spaceman1984 New method in dao would be better. Consider a case with 2 clusters, one has 'N' dedicated hosts and the other has None. When you process the pool with second cluster, you have to iterate over the 'N' dedicated hosts (belongs to first cluster) without any use go them. and also, you are passing them to the sql knowingly that these host ids doesn't exist in the result set.", "author": "sureshanaparti", "createdAt": "2020-11-10T09:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "d85bcdfdd7f46c25acf8d60141a478b7784c427c", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex b7cd205ecf..7ae8529702 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -138,16 +138,7 @@ public class DefaultEndPointSelector implements EndPointSelector {\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n         sbuilder.append(\" ORDER by \");\n         if (dedicatedHosts.size() > 0) {\n-            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n-            sbuilder.append(\"field(t.id, \");\n-            Iterator<Long> hostIt = dedicatedHosts.iterator();\n-            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n-                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n-                if (hostIt.hasNext()) {\n-                    sbuilder.append(\",\");\n-                }\n-            }\n-            sbuilder.append(\"),\" );\n+            moveDedicatedHostsToLowerPriority(sbuilder, dedicatedHosts);\n         }\n         sbuilder.append(\" rand() limit 1\");\n         String sql = sbuilder.toString();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519580323", "bodyText": "@Spaceman1984 the ordering based on the dedicated host ids here would put them on the top, can you confirm the result here?", "author": "sureshanaparti", "createdAt": "2020-11-09T06:43:08Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        if (dedicatedHosts.size() > 0) {\n+            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n+            sbuilder.append(\"field(t.id, \");\n+            Iterator<Long> hostIt = dedicatedHosts.iterator();\n+            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set", "originalCommit": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzNzg3Nw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519637877", "bodyText": "@sureshanaparti  I ran the SQL multiple times, the dedicated hosts were always at the end of the result set.", "author": "Spaceman1984", "createdAt": "2020-11-09T08:45:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MTMyMg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519641322", "bodyText": "@sureshanaparti I ran the SQL multiple times, the dedicated hosts were always at the end of the result set.\n\nLet's consider host ids: 3, 4 are dedicated, then the query does \" ORDER by field(t.id, '3','4'), rand() limit 1\". Am I correct?", "author": "sureshanaparti", "createdAt": "2020-11-09T08:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MzMyOA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519643328", "bodyText": "Yes @sureshanaparti", "author": "Spaceman1984", "createdAt": "2020-11-09T08:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODYyNg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519668626", "bodyText": "thanks for the confirmation @Spaceman1984", "author": "sureshanaparti", "createdAt": "2020-11-09T09:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw=="}], "type": "inlineReview", "revised_code": {"commit": "d85bcdfdd7f46c25acf8d60141a478b7784c427c", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex b7cd205ecf..7ae8529702 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -138,16 +138,7 @@ public class DefaultEndPointSelector implements EndPointSelector {\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n         sbuilder.append(\" ORDER by \");\n         if (dedicatedHosts.size() > 0) {\n-            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n-            sbuilder.append(\"field(t.id, \");\n-            Iterator<Long> hostIt = dedicatedHosts.iterator();\n-            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n-                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n-                if (hostIt.hasNext()) {\n-                    sbuilder.append(\",\");\n-                }\n-            }\n-            sbuilder.append(\"),\" );\n+            moveDedicatedHostsToLowerPriority(sbuilder, dedicatedHosts);\n         }\n         sbuilder.append(\" rand() limit 1\");\n         String sql = sbuilder.toString();\n"}}, {"oid": "d85bcdfdd7f46c25acf8d60141a478b7784c427c", "url": "https://github.com/apache/cloudstack/commit/d85bcdfdd7f46c25acf8d60141a478b7784c427c", "message": "Moved logic to function", "committedDate": "2020-11-09T08:42:09Z", "type": "commit"}, {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498", "url": "https://github.com/apache/cloudstack/commit/033c66bef4a711808fca22a347b27c4fcb64e498", "message": "Checking for dedicated hosts by scope and excluding dedicated hosts belonging to calling account from lower priority list.", "committedDate": "2020-11-13T10:57:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzQ4Ng==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523973486", "bodyText": "@Spaceman1984 scope id in this case is zone id, and the hosts are found using cluster id method, please check.", "author": "sureshanaparti", "createdAt": "2020-11-16T08:39:58Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> zoneHosts = hostDao.findByClusterId(scope.getScopeId());", "originalCommit": "033c66bef4a711808fca22a347b27c4fcb64e498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3NTI5Mw==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523975293", "bodyText": "Right, copy-paste error. I'll fix it.", "author": "Spaceman1984", "createdAt": "2020-11-16T08:43:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzQ4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3NjU4MQ==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523976581", "bodyText": "good catch @sureshanaparti . guess my squared-eyes filtered this out \ud83d\udc4d", "author": "DaanHoogland", "createdAt": "2020-11-16T08:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzQ4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "0103724a9b71a37afa283da516720bff750572d9", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex a774ef0997..e51dce923a 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -144,7 +144,7 @@ public class DefaultEndPointSelector implements EndPointSelector {\n                 sbuilder.append(scope.getScopeId());\n                 DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n                 if (dedicatedHost != null){\n-                    List<HostVO> zoneHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    List<HostVO> zoneHosts = hostDao.findByDataCenterId(scope.getScopeId());\n                     for (HostVO hostVO: zoneHosts){\n                         dedicatedHosts.add(hostVO.getId());\n                     }\n"}}, {"oid": "0103724a9b71a37afa283da516720bff750572d9", "url": "https://github.com/apache/cloudstack/commit/0103724a9b71a37afa283da516720bff750572d9", "message": "Fixed cluster/zone issue", "committedDate": "2020-11-16T08:51:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4Mzk0OA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523983948", "bodyText": "@Spaceman1984 what if cluster is not dedicated, but some hosts in that cluster are dedicated?", "author": "sureshanaparti", "createdAt": "2020-11-16T08:54:42Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }", "originalCommit": "033c66bef4a711808fca22a347b27c4fcb64e498", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4ODA0MA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523988040", "bodyText": "This is handled on line 155", "author": "Spaceman1984", "createdAt": "2020-11-16T08:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4Mzk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "b21b734efb5383bc697d2b190d4465cc4bbe7f01", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex a774ef0997..6a903e4235 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -132,27 +132,13 @@ public class DefaultEndPointSelector implements EndPointSelector {\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n-                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n-                if (dedicatedHost != null){\n-                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n-                    for (HostVO hostVO: clusterHosts){\n-                        dedicatedHosts.add(hostVO.getId());\n-                    }\n-                }\n+                dedicatedHosts = dedicatedResourceDao.findHostsByCluster(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n-                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n-                if (dedicatedHost != null){\n-                    List<HostVO> zoneHosts = hostDao.findByClusterId(scope.getScopeId());\n-                    for (HostVO hostVO: zoneHosts){\n-                        dedicatedHosts.add(hostVO.getId());\n-                    }\n-                }\n+                dedicatedHosts = dedicatedResourceDao.findHostsByZone(scope.getScopeId());\n             }\n-        }\n-        // We didn't find any hosts specifically dedicated to a zone or cluster\n-        if (dedicatedHosts.size() == 0) {\n+        } else {\n             dedicatedHosts = dedicatedResourceDao.listAllHosts();\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk5MjcwMA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523992700", "bodyText": "@Spaceman1984  the scope is not considered here, this returns all the dedicated hosts same as the earlier case.\nIf the cluster is not dedicated and some hosts in that cluster are dedicated, then get the dedicated hosts in that cluster only, which you can move to the end of the result set. Got me? Didn't see any dao method for this?", "author": "sureshanaparti", "createdAt": "2020-11-16T09:02:43Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> zoneHosts = hostDao.findByDataCenterId(scope.getScopeId());\n+                    for (HostVO hostVO: zoneHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             }\n         }\n+        // We didn't find any hosts specifically dedicated to a zone or cluster\n+        if (dedicatedHosts.size() == 0) {\n+            dedicatedHosts = dedicatedResourceDao.listAllHosts();", "originalCommit": "0103724a9b71a37afa283da516720bff750572d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA1MDIyMg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r524050222", "bodyText": "Ok, I'll make some changes.", "author": "Spaceman1984", "createdAt": "2020-11-16T09:54:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk5MjcwMA=="}], "type": "inlineReview", "revised_code": {"commit": "b21b734efb5383bc697d2b190d4465cc4bbe7f01", "chunk": "diff --git a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\nindex e51dce923a..6a903e4235 100644\n--- a/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n+++ b/engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java\n\n@@ -132,27 +132,13 @@ public class DefaultEndPointSelector implements EndPointSelector {\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n-                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n-                if (dedicatedHost != null){\n-                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n-                    for (HostVO hostVO: clusterHosts){\n-                        dedicatedHosts.add(hostVO.getId());\n-                    }\n-                }\n+                dedicatedHosts = dedicatedResourceDao.findHostsByCluster(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n-                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n-                if (dedicatedHost != null){\n-                    List<HostVO> zoneHosts = hostDao.findByDataCenterId(scope.getScopeId());\n-                    for (HostVO hostVO: zoneHosts){\n-                        dedicatedHosts.add(hostVO.getId());\n-                    }\n-                }\n+                dedicatedHosts = dedicatedResourceDao.findHostsByZone(scope.getScopeId());\n             }\n-        }\n-        // We didn't find any hosts specifically dedicated to a zone or cluster\n-        if (dedicatedHosts.size() == 0) {\n+        } else {\n             dedicatedHosts = dedicatedResourceDao.listAllHosts();\n         }\n \n"}}, {"oid": "b21b734efb5383bc697d2b190d4465cc4bbe7f01", "url": "https://github.com/apache/cloudstack/commit/b21b734efb5383bc697d2b190d4465cc4bbe7f01", "message": "Fetching dedidcated hosts by zone and cluster id and changed logic", "committedDate": "2020-11-17T10:17:00Z", "type": "commit"}, {"oid": "9a334c7c0f743011b00971859a5da02534d532de", "url": "https://github.com/apache/cloudstack/commit/9a334c7c0f743011b00971859a5da02534d532de", "message": "Merge branch 'master' into dedicated_hosts_priority", "committedDate": "2020-11-17T11:11:23Z", "type": "commit"}, {"oid": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a", "url": "https://github.com/apache/cloudstack/commit/0e9d86caeacf882d4fe9e9c02bd102a046a8171a", "message": "Fixed bad merge", "committedDate": "2020-11-17T11:55:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMDAyNg==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r525910026", "bodyText": "@Spaceman1984 these changes are part of your fix?", "author": "sureshanaparti", "createdAt": "2020-11-18T08:49:25Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1672,10 +1672,13 @@ protected boolean sendStop(final VirtualMachineGuru guru, final VirtualMachinePr\n                 }\n \n                 guru.finalizeStop(profile, answer);\n+\n+                final UserVmVO userVm = _userVmDao.findById(vm.getId());\n                 if (vm.getType() == VirtualMachine.Type.User) {\n-                    final UserVmVO userVm = _userVmDao.findById(vm.getId());\n-                    userVm.setPowerState(PowerState.PowerOff);\n-                    _userVmDao.update(userVm.getId(), userVm);\n+                    if (userVm != null){\n+                        userVm.setPowerState(PowerState.PowerOff);\n+                        _userVmDao.update(userVm.getId(), userVm);", "originalCommit": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkyMDEwMA==", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r525920100", "bodyText": "Unrelated, just a missed null pointer check I picked up while testing.", "author": "Spaceman1984", "createdAt": "2020-11-18T09:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMDAyNg=="}], "type": "inlineReview", "revised_code": null}]}