{"pr_number": 4029, "pr_title": "Bring back vm.suspend during deleting VM snapshot", "pr_createdAt": "2020-04-14T19:04:29Z", "pr_url": "https://github.com/apache/cloudstack/pull/4029", "timeline": [{"oid": "ef58e564533e14f3f2dd2ed6aaa3bf8072011823", "url": "https://github.com/apache/cloudstack/commit/ef58e564533e14f3f2dd2ed6aaa3bf8072011823", "message": "Bring back vm.suspend during deleting VM snapshot", "committedDate": "2020-04-14T19:00:48Z", "type": "commit"}, {"oid": "6ae5eb572acc10778700defe35be085792100801", "url": "https://github.com/apache/cloudstack/commit/6ae5eb572acc10778700defe35be085792100801", "message": "catch'em all", "committedDate": "2020-04-14T19:20:38Z", "type": "commit"}, {"oid": "eeac1353b68b10f1de9d2b545af6ec3f4f769c8f", "url": "https://github.com/apache/cloudstack/commit/eeac1353b68b10f1de9d2b545af6ec3f4f769c8f", "message": "trailing spaces", "committedDate": "2020-04-15T07:24:24Z", "type": "commit"}, {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396", "url": "https://github.com/apache/cloudstack/commit/0f5e51133967bae750f089e53f7c78fa85d8a396", "message": "logging on suspend", "committedDate": "2020-04-15T15:38:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA==", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409445290", "bodyText": "same comment as in #4033: first we suspend unconditionaly, and than, we just assume it need resuming without checking if it was running in the first place. Are there situations we should guard against more diligently? (cc @weizhouapache @rhtyd )", "author": "DaanHoogland", "createdAt": "2020-04-16T10:19:02Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1005,6 +1005,13 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                             primaryStore.getUuid());\n                     if (state == DomainInfo.DomainState.VIR_DOMAIN_RUNNING && !primaryStorage.isExternalSnapshot()) {\n                         final DomainSnapshot snap = vm.snapshotLookupByName(snapshotName);\n+                        try {\n+                            s_logger.info(String.format(\"Suspending VM '%s' to delete snapshot,\", vm.getName()));\n+                            vm.suspend();\n+                        } catch (final LibvirtException e) {\n+                            s_logger.error(\"Failed to suspend the VM\", e);\n+                            throw e;", "originalCommit": "0f5e51133967bae750f089e53f7c78fa85d8a396", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDE2NQ==", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409490165", "bodyText": "@DaanHoogland I see on line 1007, we are checking that domain is running? Did I miss anything?", "author": "rhtyd", "createdAt": "2020-04-16T11:42:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5NDU5Mw==", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409494593", "bodyText": "yes, we are, i am confusing PRs. this one actually doesn't do anything in the delete vmshapshot scenario.", "author": "DaanHoogland", "createdAt": "2020-04-16T11:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA=="}], "type": "inlineReview", "revised_code": null}]}