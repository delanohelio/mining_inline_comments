{"pr_number": 4255, "pr_title": "Prevent null pointer on listPublicIpAddress cmd", "pr_createdAt": "2020-08-10T15:45:27Z", "pr_url": "https://github.com/apache/cloudstack/pull/4255", "timeline": [{"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2", "url": "https://github.com/apache/cloudstack/commit/6dc40f7b1467c2ba53f9baff0dcae69be681bbe2", "message": "Prevent null pointer on listPublicIpAddress cmd\n\nInsert an inner join between data_center table and user_ip_address where data_center.removed field is null", "committedDate": "2020-08-10T14:14:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NzY0OQ==", "url": "https://github.com/apache/cloudstack/pull/4255#discussion_r469397649", "bodyText": "I think that it would be better to implement this via the VLAN Search Builder instead of adding the proposed search builder. Here are a few points of why I think it would be better:\n\nAll removed zones should have its networks removed anyway, therefore VLANs of a removed zone are marked as removed as well;\nthis could also prevent issues of selecting IP addresses of removed VLANs on an existing Zone;\nand, at the end, it reduces costs of one extra join.\n\nCurrently lines 1984 - 1986:\nfinal SearchBuilder<VlanVO> vlanSearch = _vlanDao.createSearchBuilder();\nvlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\nsb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);\n\nChanging current VLAN search builder adding a verification \"WHERE removed IS NULL\":\nfinal SearchBuilder<VlanVO> vlanSearch = _vlanDao.createSearchBuilder();\nvlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\nvlanSearch.and(\"removed\", vlanSearch.entity().getRemoved(), SearchCriteria.Op.NULL);\nsb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);SearchCriteria.Op.NULL);", "author": "GabrielBrascher", "createdAt": "2020-08-12T16:45:07Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1985,6 +1985,10 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n         vlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\n         sb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);\n \n+        SearchBuilder<DataCenterVO> zoneSearchBuilder = _dcDao.createSearchBuilder();", "originalCommit": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQyODg1OQ==", "url": "https://github.com/apache/cloudstack/pull/4255#discussion_r469428859", "bodyText": "I did not see that. thanks for the hint\nwork like a charm adding this removed filter for Vlan Search.", "author": "RodrigoDLopez", "createdAt": "2020-08-12T17:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NzY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ5OTIyNg==", "url": "https://github.com/apache/cloudstack/pull/4255#discussion_r469499226", "bodyText": "That's great! \ud83d\ude42", "author": "GabrielBrascher", "createdAt": "2020-08-12T19:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NzY0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "fc8ad2110ac7f2fbdd63da1ad4923396302341a9", "chunk": "diff --git a/server/src/main/java/com/cloud/server/ManagementServerImpl.java b/server/src/main/java/com/cloud/server/ManagementServerImpl.java\nindex f982dfb42f..49d39a8617 100644\n--- a/server/src/main/java/com/cloud/server/ManagementServerImpl.java\n+++ b/server/src/main/java/com/cloud/server/ManagementServerImpl.java\n\n@@ -1983,12 +1983,9 @@ public class ManagementServerImpl extends ManagerBase implements ManagementServe\n \n         final SearchBuilder<VlanVO> vlanSearch = _vlanDao.createSearchBuilder();\n         vlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\n+        vlanSearch.and(\"removed\", vlanSearch.entity().getRemoved(), SearchCriteria.Op.NULL);\n         sb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);\n \n-        SearchBuilder<DataCenterVO> zoneSearchBuilder = _dcDao.createSearchBuilder();\n-        zoneSearchBuilder.and(\"removed\", zoneSearchBuilder.entity().getRemoved(), SearchCriteria.Op.NULL);\n-        sb.join(\"removed_zone_filter\", zoneSearchBuilder, sb.entity().getDataCenterId(), zoneSearchBuilder.entity().getId(), JoinBuilder.JoinType.INNER);\n-\n         if (isAllocated != null && isAllocated == true) {\n             sb.and(\"allocated\", sb.entity().getAllocatedTime(), SearchCriteria.Op.NNULL);\n         }\n"}}, {"oid": "fc8ad2110ac7f2fbdd63da1ad4923396302341a9", "url": "https://github.com/apache/cloudstack/commit/fc8ad2110ac7f2fbdd63da1ad4923396302341a9", "message": "Remove extra join and add a filter for VLAN removed", "committedDate": "2020-08-12T17:35:39Z", "type": "commit"}]}