{"pr_number": 4418, "pr_title": "Create Event in case of OOBM failure", "pr_createdAt": "2020-10-21T18:17:19Z", "pr_url": "https://github.com/apache/cloudstack/pull/4418", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDc2OQ==", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509924769", "bodyText": "In general in CloudStack we try to not log the 'hostid' as it doesn't say anything. The ID can only be fetched from the DB and not from the API and thus UI.", "author": "wido", "createdAt": "2020-10-22T07:03:24Z", "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -43,8 +53,26 @@ public void run() {\n         try {\n             service.executePowerOperation(host, powerOperation, null);\n         } catch (Exception e) {\n-            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d failed with: %s\",\n-                    powerOperation.name(), host.getId(), e.getMessage()));\n+            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n+                    powerOperation.name(), host.getId(), host.getName(), e.getMessage()));", "originalCommit": "3ae14d14eb3c3594b94963c839e981a44b57c996", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NDMyMw==", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r510164323", "bodyText": "Makes sense, I am going to keep only the host name then.", "author": "GabrielBrascher", "createdAt": "2020-10-22T13:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d931b09b902b745f28c06270c952fc5adb2bc210", "chunk": "diff --git a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\nindex 8ffc7352a8..84b7f27b7e 100644\n--- a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n+++ b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n\n@@ -56,23 +50,11 @@ public class PowerOperationTask implements Runnable, Configurable {\n             LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n                     powerOperation.name(), host.getId(), host.getName(), e.getMessage()));\n \n-            if(CREATE_EVENT_ON_OOBM_FAILURE.value()) {\n-                String eventMessage = String.format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\",\n-                        powerOperation.name(), host.getId(), host.getName());\n+            String eventMessage = String\n+                    .format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\", powerOperation.name(), host.getId(), host.getName());\n \n-                ActionEventUtils.onCreatedActionEvent(CallContext.current().getCallingUserId(), CallContext.current().getCallingAccountId(),\n-                        EventVO.LEVEL_WARN, EventTypes.EVENT_HOST_OUTOFBAND_MANAGEMENT_ACTION, true, eventMessage);\n-            }\n+            ActionEventUtils.onCreatedActionEvent(CallContext.current().getCallingUserId(), CallContext.current().getCallingAccountId(), EventVO.LEVEL_WARN,\n+                    EventTypes.EVENT_HOST_OUTOFBAND_MANAGEMENT_ACTION, true, eventMessage);\n         }\n     }\n-\n-    @Override\n-    public String getConfigComponentName() {\n-        return PowerOperationTask.class.getSimpleName();\n-    }\n-\n-    @Override\n-    public ConfigKey<?>[] getConfigKeys() {\n-        return new ConfigKey<?>[] { CREATE_EVENT_ON_OOBM_FAILURE };\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDg3NA==", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509924874", "bodyText": "Same applies here", "author": "wido", "createdAt": "2020-10-22T07:03:40Z", "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -43,8 +53,26 @@ public void run() {\n         try {\n             service.executePowerOperation(host, powerOperation, null);\n         } catch (Exception e) {\n-            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d failed with: %s\",\n-                    powerOperation.name(), host.getId(), e.getMessage()));\n+            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n+                    powerOperation.name(), host.getId(), host.getName(), e.getMessage()));\n+\n+            if(CREATE_EVENT_ON_OOBM_FAILURE.value()) {\n+                String eventMessage = String.format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\",\n+                        powerOperation.name(), host.getId(), host.getName());", "originalCommit": "3ae14d14eb3c3594b94963c839e981a44b57c996", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d931b09b902b745f28c06270c952fc5adb2bc210", "chunk": "diff --git a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\nindex 8ffc7352a8..84b7f27b7e 100644\n--- a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n+++ b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n\n@@ -56,23 +50,11 @@ public class PowerOperationTask implements Runnable, Configurable {\n             LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n                     powerOperation.name(), host.getId(), host.getName(), e.getMessage()));\n \n-            if(CREATE_EVENT_ON_OOBM_FAILURE.value()) {\n-                String eventMessage = String.format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\",\n-                        powerOperation.name(), host.getId(), host.getName());\n+            String eventMessage = String\n+                    .format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\", powerOperation.name(), host.getId(), host.getName());\n \n-                ActionEventUtils.onCreatedActionEvent(CallContext.current().getCallingUserId(), CallContext.current().getCallingAccountId(),\n-                        EventVO.LEVEL_WARN, EventTypes.EVENT_HOST_OUTOFBAND_MANAGEMENT_ACTION, true, eventMessage);\n-            }\n+            ActionEventUtils.onCreatedActionEvent(CallContext.current().getCallingUserId(), CallContext.current().getCallingAccountId(), EventVO.LEVEL_WARN,\n+                    EventTypes.EVENT_HOST_OUTOFBAND_MANAGEMENT_ACTION, true, eventMessage);\n         }\n     }\n-\n-    @Override\n-    public String getConfigComponentName() {\n-        return PowerOperationTask.class.getSimpleName();\n-    }\n-\n-    @Override\n-    public ConfigKey<?>[] getConfigKeys() {\n-        return new ConfigKey<?>[] { CREATE_EVENT_ON_OOBM_FAILURE };\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTM3NQ==", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509925375", "bodyText": "I know there is no naming scheme here, but isn't it easier if OOB related config keys are prefixed with oob?\noob.create.event.on.failure\nFor example", "author": "wido", "createdAt": "2020-10-22T07:04:38Z", "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -17,16 +17,26 @@\n \n package org.apache.cloudstack.outofbandmanagement;\n \n+import com.cloud.event.ActionEventUtils;\n+import com.cloud.event.EventTypes;\n+import com.cloud.event.EventVO;\n import com.cloud.host.Host;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.framework.config.ConfigKey;\n+import org.apache.cloudstack.framework.config.Configurable;\n import org.apache.log4j.Logger;\n \n-public class PowerOperationTask implements Runnable {\n+public class PowerOperationTask implements Runnable, Configurable {\n     public static final Logger LOG = Logger.getLogger(PowerOperationTask.class);\n \n     final private OutOfBandManagementService service;\n     final private Host host;\n     final private OutOfBandManagement.PowerOperation powerOperation;\n \n+    public static final ConfigKey<Boolean> CREATE_EVENT_ON_OOBM_FAILURE = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"create.event.on.oob.failure\", \"true\",", "originalCommit": "3ae14d14eb3c3594b94963c839e981a44b57c996", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMwNTg3Mw==", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r510305873", "bodyText": "Thanks for the suggestion, @wido.\nI am removing that global settings config key. There are too many config keys already, I am leaving to add a new one only if it is really necessary.", "author": "GabrielBrascher", "createdAt": "2020-10-22T16:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d931b09b902b745f28c06270c952fc5adb2bc210", "chunk": "diff --git a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\nindex 8ffc7352a8..84b7f27b7e 100644\n--- a/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n+++ b/server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java\n\n@@ -22,21 +22,15 @@ import com.cloud.event.EventTypes;\n import com.cloud.event.EventVO;\n import com.cloud.host.Host;\n import org.apache.cloudstack.context.CallContext;\n-import org.apache.cloudstack.framework.config.ConfigKey;\n-import org.apache.cloudstack.framework.config.Configurable;\n import org.apache.log4j.Logger;\n \n-public class PowerOperationTask implements Runnable, Configurable {\n+public class PowerOperationTask implements Runnable {\n     public static final Logger LOG = Logger.getLogger(PowerOperationTask.class);\n \n     final private OutOfBandManagementService service;\n     final private Host host;\n     final private OutOfBandManagement.PowerOperation powerOperation;\n \n-    public static final ConfigKey<Boolean> CREATE_EVENT_ON_OOBM_FAILURE = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"create.event.on.oob.failure\", \"true\",\n-            \"Creates an ERROR event each time an Out-of-band power operation fails. If set to false these errors will be silenced. Errors will be logged either way on management log.\",\n-            true, ConfigKey.Scope.Global);\n-\n     public PowerOperationTask(OutOfBandManagementService service, Host host, OutOfBandManagement.PowerOperation powerOperation) {\n         this.service = service;\n         this.host = host;\n"}}, {"oid": "d931b09b902b745f28c06270c952fc5adb2bc210", "url": "https://github.com/apache/cloudstack/commit/d931b09b902b745f28c06270c952fc5adb2bc210", "message": "Create Error EVENT in case of oobm failure", "committedDate": "2020-10-22T09:24:03Z", "type": "forcePushed"}, {"oid": "28f1baa610fe86f34cf20a4941b546bdc46b189c", "url": "https://github.com/apache/cloudstack/commit/28f1baa610fe86f34cf20a4941b546bdc46b189c", "message": "Create Error EVENT in case of oobm failure", "committedDate": "2020-10-22T16:53:41Z", "type": "commit"}, {"oid": "28f1baa610fe86f34cf20a4941b546bdc46b189c", "url": "https://github.com/apache/cloudstack/commit/28f1baa610fe86f34cf20a4941b546bdc46b189c", "message": "Create Error EVENT in case of oobm failure", "committedDate": "2020-10-22T16:53:41Z", "type": "forcePushed"}, {"oid": "8de5434252473a94c814afa0b3b20f902a935e88", "url": "https://github.com/apache/cloudstack/commit/8de5434252473a94c814afa0b3b20f902a935e88", "message": "Choose host name over host id on messages", "committedDate": "2020-10-22T20:08:45Z", "type": "commit"}]}