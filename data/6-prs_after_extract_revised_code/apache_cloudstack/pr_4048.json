{"pr_number": 4048, "pr_title": "Update DpdkDriverImpl.java to support DPDK trunk interfaces", "pr_createdAt": "2020-04-28T17:34:10Z", "pr_url": "https://github.com/apache/cloudstack/pull/4048", "timeline": [{"oid": "2e85e0f7933199bdd8a9a6e41bd5998a56ebd3d8", "url": "https://github.com/apache/cloudstack/commit/2e85e0f7933199bdd8a9a6e41bd5998a56ebd3d8", "message": "Update DpdkDriverImpl.java\n\nUpdate to support trunk interfaces for DPDK enabled hosts.", "committedDate": "2020-04-27T22:22:29Z", "type": "commit"}, {"oid": "e44f406037e58cd5e2e58395db247e07fabe7935", "url": "https://github.com/apache/cloudstack/commit/e44f406037e58cd5e2e58395db247e07fabe7935", "message": "Update DpdkDriverImpl.java", "committedDate": "2020-04-28T22:39:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwNzUwMg==", "url": "https://github.com/apache/cloudstack/pull/4048#discussion_r417107502", "bodyText": "could you put only this vland_mode and tag in the if-block and the rest around it. The other parts of the string do not depend on the condition and there is nothing that should go in the else-block.", "author": "DaanHoogland", "createdAt": "2020-04-29T07:07:32Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java", "diffHunk": "@@ -70,9 +70,15 @@ public void addDpdkPort(String bridgeName, String port, String vlan, DpdkHelper.\n                 dpdkPortVhostUserClientType;\n \n         StringBuilder stringBuilder = new StringBuilder();\n-        stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \" +\n-                \"vlan_mode=access tag=%s \" +\n-                \"-- set Interface %s type=%s\", bridgeName, port, vlan, port, type));\n+        \n+        if (Integer.parseInt(vlan) > 0 && Integer.parseInt(vlan) < 4095) {\n+            stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \" +\n+                    \"vlan_mode=access tag=%s \" +", "originalCommit": "e44f406037e58cd5e2e58395db247e07fabe7935", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzMjUwMg==", "url": "https://github.com/apache/cloudstack/pull/4048#discussion_r417432502", "bodyText": "updated", "author": "mbrashearnttglobalnet", "createdAt": "2020-04-29T16:04:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwNzUwMg=="}], "type": "inlineReview", "revised_code": {"commit": "b3303594e8e15cd7840b92165b42d1ec3e942a67", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\nindex 502ee32475..e09aa1a4c3 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\n\n@@ -70,16 +70,12 @@ public class DpdkDriverImpl extends AdapterBase implements DpdkDriver {\n                 dpdkPortVhostUserClientType;\n \n         StringBuilder stringBuilder = new StringBuilder();\n-        \n+        stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \", bridgeName, port));\n         if (Integer.parseInt(vlan) > 0 && Integer.parseInt(vlan) < 4095) {\n-            stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \" +\n-                    \"vlan_mode=access tag=%s \" +\n-                    \"-- set Interface %s type=%s\", bridgeName, port, vlan, port, type));\n-        } else {\n-            stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \" +\n-                    \"-- set Interface %s type=%s\", bridgeName, port, port, type));\n+            stringBuilder.append(String.format(\"vlan_mode=access tag=%s \", vlan));\n         }\n-\n+        stringBuilder.append(String.format(\"-- set Interface %s type=%s\", port, type));\n+        \n         if (vHostUserMode == DpdkHelper.VHostUserMode.CLIENT) {\n             stringBuilder.append(String.format(\" options:vhost-server-path=%s/%s\",\n                     dpdkOvsPath, port));\n"}}, {"oid": "b3303594e8e15cd7840b92165b42d1ec3e942a67", "url": "https://github.com/apache/cloudstack/commit/b3303594e8e15cd7840b92165b42d1ec3e942a67", "message": "Update DpdkDriverImpl.java", "committedDate": "2020-04-29T16:03:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2MjQyNQ==", "url": "https://github.com/apache/cloudstack/pull/4048#discussion_r417462425", "bodyText": "Packages failing with:\n[ERROR] /jenkins/workspace/acs-pr-centos7-pkg-builder/dist/rpmbuild/BUILD/cloudstack-4.14.0.0-SNAPSHOT/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java:78: Line has trailing spaces. [RegexpSingleline]\n\n@mbrashearnttglobalnet can you refactor this line space as a linux carriage?", "author": "nvazquez", "createdAt": "2020-04-29T16:49:37Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java", "diffHunk": "@@ -70,10 +70,12 @@ public void addDpdkPort(String bridgeName, String port, String vlan, DpdkHelper.\n                 dpdkPortVhostUserClientType;\n \n         StringBuilder stringBuilder = new StringBuilder();\n-        stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \" +\n-                \"vlan_mode=access tag=%s \" +\n-                \"-- set Interface %s type=%s\", bridgeName, port, vlan, port, type));\n-\n+        stringBuilder.append(String.format(\"ovs-vsctl add-port %s %s \", bridgeName, port));\n+        if (Integer.parseInt(vlan) > 0 && Integer.parseInt(vlan) < 4095) {\n+            stringBuilder.append(String.format(\"vlan_mode=access tag=%s \", vlan));\n+        }\n+        stringBuilder.append(String.format(\"-- set Interface %s type=%s\", port, type));\n+        ", "originalCommit": "b3303594e8e15cd7840b92165b42d1ec3e942a67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzUzNzg2OA==", "url": "https://github.com/apache/cloudstack/pull/4048#discussion_r417537868", "bodyText": "removed the white spaces on the blank line.", "author": "mbrashearnttglobalnet", "createdAt": "2020-04-29T18:52:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ2MjQyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "df2e06c9a60b54d977e48e95f93dcfe91e5082b9", "chunk": "diff --git a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\nindex e09aa1a4c3..b5886a1ced 100644\n--- a/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\n+++ b/plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/dpdk/DpdkDriverImpl.java\n\n@@ -75,7 +75,7 @@ public class DpdkDriverImpl extends AdapterBase implements DpdkDriver {\n             stringBuilder.append(String.format(\"vlan_mode=access tag=%s \", vlan));\n         }\n         stringBuilder.append(String.format(\"-- set Interface %s type=%s\", port, type));\n-        \n+\n         if (vHostUserMode == DpdkHelper.VHostUserMode.CLIENT) {\n             stringBuilder.append(String.format(\" options:vhost-server-path=%s/%s\",\n                     dpdkOvsPath, port));\n"}}, {"oid": "df2e06c9a60b54d977e48e95f93dcfe91e5082b9", "url": "https://github.com/apache/cloudstack/commit/df2e06c9a60b54d977e48e95f93dcfe91e5082b9", "message": "Update DpdkDriverImpl.java", "committedDate": "2020-04-29T18:50:30Z", "type": "commit"}]}