{"pr_number": 3864, "pr_title": "Ignore site to site vpn status check on internallbvm", "pr_createdAt": "2020-02-04T11:02:37Z", "pr_url": "https://github.com/apache/cloudstack/pull/3864", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r374647479", "bodyText": "Could it cause regressions for anything others: LB, INTERNAL_LB_VM, NETSCALER_VM cc @weizhouapache @DaanHoogland", "author": "rhtyd", "createdAt": "2020-02-04T12:41:30Z", "path": "server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java", "diffHunk": "@@ -885,6 +885,10 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n     @DB\n     protected void updateSite2SiteVpnConnectionState(final List<DomainRouterVO> routers) {\n         for (final DomainRouterVO router : routers) {\n+            if (router.getRole() != Role.VIRTUAL_ROUTER) {", "originalCommit": "164f9847d63435eb30e7c543958c419cb64328d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY4Mzg1Ng==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r374683856", "bodyText": "@rhtyd as far as I know, site2site vpn can only be applied on vpc vrs, so this should be ok.", "author": "weizhouapache", "createdAt": "2020-02-04T13:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA3ODcyNA==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r375078724", "bodyText": "@weizhouapache @ravening cc @DaanHoogland - the only type I'm not sure about is Netscalars. @PaulAngus can you comment if netscalar supports site-to-site VPN?", "author": "rhtyd", "createdAt": "2020-02-05T06:30:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE5Nzc5Ng==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r375197796", "bodyText": "Do we have netscaler users present and active?", "author": "DaanHoogland", "createdAt": "2020-02-05T11:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MDUyMw==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r375650523", "bodyText": "We may that's why I've pinged @PaulAngus - advice?", "author": "rhtyd", "createdAt": "2020-02-06T05:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyMjUwMQ==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r376222501", "bodyText": "Ping @andrijapanicsb @PaulAngus", "author": "rhtyd", "createdAt": "2020-02-07T05:41:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM2OTc3Mw==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r376369773", "bodyText": "not sure I can advise here... I say we go forward, as NetScaller should definitively NOT be marked as \"VIRTUAL_ROUTER\"", "author": "andrijapanicsb", "createdAt": "2020-02-07T12:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY5NTAyNA==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r376695024", "bodyText": "@ravening can you change the conditional to: router.getRole() == INTERNAL_LB_VM", "author": "rhtyd", "createdAt": "2020-02-08T07:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEzMDg4MQ==", "url": "https://github.com/apache/cloudstack/pull/3864#discussion_r378130881", "bodyText": "I have made necessary changes", "author": "ravening", "createdAt": "2020-02-12T09:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQ3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "4630e85c9e60415bb34938acf379414d808fc234", "chunk": "diff --git a/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java b/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java\nindex 272f9cd498..50cd8a4876 100644\n--- a/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java\n+++ b/server/src/main/java/com/cloud/network/router/VirtualNetworkApplianceManagerImpl.java\n\n@@ -885,7 +885,7 @@ Configurable, StateListener<VirtualMachine.State, VirtualMachine.Event, VirtualM\n     @DB\n     protected void updateSite2SiteVpnConnectionState(final List<DomainRouterVO> routers) {\n         for (final DomainRouterVO router : routers) {\n-            if (router.getRole() != Role.VIRTUAL_ROUTER) {\n+            if (router.getRole() == Role.INTERNAL_LB_VM) {\n                 continue;\n             }\n \n"}}, {"oid": "4630e85c9e60415bb34938acf379414d808fc234", "url": "https://github.com/apache/cloudstack/commit/4630e85c9e60415bb34938acf379414d808fc234", "message": "Ignore site to site vpn status check on internallbvm\n\nWhen the state of the site to site vpn changes, the check\nis done on all the virtual routers including the internal\nload balancing vm as well. It is not needed to check the\nstate for internal load balancing vm", "committedDate": "2020-02-12T09:29:07Z", "type": "forcePushed"}, {"oid": "2215f8b12de3fef7ea93ddda81cf9fa2208c17f3", "url": "https://github.com/apache/cloudstack/commit/2215f8b12de3fef7ea93ddda81cf9fa2208c17f3", "message": "Ignore site to site vpn status check on internallbvm\n\nWhen the state of the site to site vpn changes, the check\nis done on all the virtual routers including the internal\nload balancing vm as well. It is not needed to check the\nstate for internal load balancing vm", "committedDate": "2020-02-12T10:00:48Z", "type": "commit"}, {"oid": "2215f8b12de3fef7ea93ddda81cf9fa2208c17f3", "url": "https://github.com/apache/cloudstack/commit/2215f8b12de3fef7ea93ddda81cf9fa2208c17f3", "message": "Ignore site to site vpn status check on internallbvm\n\nWhen the state of the site to site vpn changes, the check\nis done on all the virtual routers including the internal\nload balancing vm as well. It is not needed to check the\nstate for internal load balancing vm", "committedDate": "2020-02-12T10:00:48Z", "type": "forcePushed"}]}