{"pr_number": 4284, "pr_title": "Fixed delayed power state update after vm shutdown", "pr_createdAt": "2020-08-25T15:04:30Z", "pr_url": "https://github.com/apache/cloudstack/pull/4284", "timeline": [{"oid": "a2d2fa0edfe023a9847f05d985e0f753d2931e80", "url": "https://github.com/apache/cloudstack/commit/a2d2fa0edfe023a9847f05d985e0f753d2931e80", "message": "Fixed delayed power state update after vm shutdown", "committedDate": "2020-08-25T14:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3Mzg0MA==", "url": "https://github.com/apache/cloudstack/pull/4284#discussion_r477073840", "bodyText": "@Spaceman1984 should we update the power state after guru finalises the stop? What is there is an exception then the power state will be off while VM may actually be running?", "author": "rhtyd", "createdAt": "2020-08-26T06:53:37Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1657,6 +1657,10 @@ protected boolean sendStop(final VirtualMachineGuru guru, final VirtualMachinePr\n                     return false;\n                 }\n \n+                final UserVmVO userVm = _userVmDao.findById(vm.getId());\n+                userVm.setPowerState(PowerState.PowerOff);\n+                _userVmDao.update(userVm.getId(), userVm);\n+\n                 guru.finalizeStop(profile, answer);", "originalCommit": "a2d2fa0edfe023a9847f05d985e0f753d2931e80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3NTMzOA==", "url": "https://github.com/apache/cloudstack/pull/4284#discussion_r477075338", "bodyText": "np @rhtyd, I'll move it down.", "author": "Spaceman1984", "createdAt": "2020-08-26T06:56:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3Mzg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "6725b5688b7df023ce12d868863b7fff9f56f022", "chunk": "diff --git a/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java b/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java\nindex 6144f58298..1e7156d37c 100755\n--- a/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java\n+++ b/engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java\n\n@@ -1657,11 +1657,10 @@ public class VirtualMachineManagerImpl extends ManagerBase implements VirtualMac\n                     return false;\n                 }\n \n+                guru.finalizeStop(profile, answer);\n                 final UserVmVO userVm = _userVmDao.findById(vm.getId());\n                 userVm.setPowerState(PowerState.PowerOff);\n                 _userVmDao.update(userVm.getId(), userVm);\n-\n-                guru.finalizeStop(profile, answer);\n             } else {\n                 s_logger.error(\"Invalid answer received in response to a StopCommand for \" + vm.getInstanceName());\n                 return false;\n"}}, {"oid": "6725b5688b7df023ce12d868863b7fff9f56f022", "url": "https://github.com/apache/cloudstack/commit/6725b5688b7df023ce12d868863b7fff9f56f022", "message": "Moved db update to after guru finalize stop method call", "committedDate": "2020-08-26T10:36:41Z", "type": "commit"}]}