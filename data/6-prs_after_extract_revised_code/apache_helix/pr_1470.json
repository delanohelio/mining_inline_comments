{"pr_number": 1470, "pr_title": "ExpiredJob Workaround for Selective Update Race Conditions", "pr_createdAt": "2020-10-15T20:28:54Z", "pr_url": "https://github.com/apache/helix/pull/1470", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3MDMzNg==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508070336", "bodyText": "This is a public API change. If there is other place using this API, the compilation may fail.", "author": "kaisun2000", "createdAt": "2020-10-19T21:22:27Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskUtil.java", "diffHunk": "@@ -789,14 +789,19 @@ protected static boolean removeJobsFromWorkflow(final HelixDataAccessor dataAcce\n    */\n   public static Set<String> getExpiredJobsFromCache(\n       WorkflowControllerDataProvider workflowControllerDataProvider, WorkflowConfig workflowConfig,\n-      WorkflowContext workflowContext) {\n+      WorkflowContext workflowContext, HelixManager manager) {", "originalCommit": "16feb8925efeb60aa15053d69c2cb3b2d57e0059", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508072950", "bodyText": "This is public API change. I know it is added recently, but are we sure this won't break some other code using TaskUtil?\nThe other way can be simply add a check after line 85 to see if any expiredJobs are in the config and remove them from the expiredJob set.", "author": "kaisun2000", "createdAt": "2020-10-19T21:27:54Z", "path": "helix-core/src/main/java/org/apache/helix/controller/stages/TaskGarbageCollectionStage.java", "diffHunk": "@@ -81,8 +81,8 @@ public void process(ClusterEvent event) throws Exception {\n         if (nextPurgeTime <= currentTime) {\n           nextPurgeTime = currentTime + purgeInterval;\n           // Find jobs that are ready to be purged\n-          Set<String> expiredJobs =\n-              TaskUtil.getExpiredJobsFromCache(dataProvider, workflowConfig, workflowContext);\n+          Set<String> expiredJobs = TaskUtil\n+              .getExpiredJobsFromCache(dataProvider, workflowConfig, workflowContext, manager);", "originalCommit": "16feb8925efeb60aa15053d69c2cb3b2d57e0059", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODExNDAzNw==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508114037", "bodyText": "I see the concern here, but doing it in the way you described is not so clean. We need to check for the case of \"JobConfig missing from cache but exist in ZK\" for all the expiredJobs, and for each of those cases, we need to apply the \"isJobExpired\" logic again. There is a lot of logic redundancy here.\nIs that better than changing the signature? I think both ways have minor drawbacks, but I personally think changing the signature is fine.", "author": "NealSun96", "createdAt": "2020-10-19T23:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyNzQ0NA==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508127444", "bodyText": "Good point. Maybe let us create something like TaskUtil.getExpiredJobsFromCacheAndCheckZk which uses TaskUtil.getExpiredJobsFromCache()", "author": "kaisun2000", "createdAt": "2020-10-19T23:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODcyMjY3NQ==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508722675", "bodyText": "Is that going to be a public function? If so, can we remove that public function after we fix phantom write?\nI don't think this is a big problem; this function is too new to cause large impact imo.", "author": "NealSun96", "createdAt": "2020-10-20T17:49:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc1MDQ2MA==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508750460", "bodyText": "We can make something like \"TaskUtil.getExpiredJobsFromCacheAndCheckZk\" deprecated once we fixed root of the selective update issue. The fix may take several quarters though.\nIf you believe TaskUtil.getExpiredJobsFromCache() is not used by others. Then shall we run this diff against TMC build to see partners in upstream can build against this one successfully? It would be much more costly if people later find this thing does not work in release time.", "author": "kaisun2000", "createdAt": "2020-10-20T18:33:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODc5OTE1Nw==", "url": "https://github.com/apache/helix/pull/1470#discussion_r508799157", "bodyText": "I think this may be an overkill. I did a code search and didn't find any code calling this function.\nIn addition, I can allow manager to be null for maximum backward compatibility. How about that?", "author": "NealSun96", "createdAt": "2020-10-20T19:55:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAzMzY4NA==", "url": "https://github.com/apache/helix/pull/1470#discussion_r509033684", "bodyText": "Some of the partners code are actually also hosted in github. Code search won't really yield the current usage. In fact last time we  found some issue when integrating with Gobblin. Let me slack you the command to check build.\nIf the build works, we can just use this diff without any change.", "author": "kaisun2000", "createdAt": "2020-10-21T07:00:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc0ODE4MQ==", "url": "https://github.com/apache/helix/pull/1470#discussion_r509748181", "bodyText": "The build seems working. let us just keep this change then.", "author": "kaisun2000", "createdAt": "2020-10-21T22:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA3Mjk1MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b0206ef3178313f498602796f75d3392306254f9", "url": "https://github.com/apache/helix/commit/b0206ef3178313f498602796f75d3392306254f9", "message": "Add ZK fallback when JobConfig is missing during Garbage Collection", "committedDate": "2020-10-21T17:51:11Z", "type": "commit"}, {"oid": "b0206ef3178313f498602796f75d3392306254f9", "url": "https://github.com/apache/helix/commit/b0206ef3178313f498602796f75d3392306254f9", "message": "Add ZK fallback when JobConfig is missing during Garbage Collection", "committedDate": "2020-10-21T17:51:11Z", "type": "forcePushed"}]}