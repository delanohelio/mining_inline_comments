{"pr_number": 696, "pr_title": "Add WAGED rebalancer reset method to clean up cached status.", "pr_createdAt": "2020-01-23T00:20:14Z", "pr_url": "https://github.com/apache/helix/pull/696", "timeline": [{"oid": "b27fa956023125586dc5b18ba5b4686b1eaf0d93", "url": "https://github.com/apache/helix/commit/b27fa956023125586dc5b18ba5b4686b1eaf0d93", "message": "Add WAGED rebalancer reset method to clean up cached status.\n\nThe reset method is for allowing to clean up any in-memory records within the rebalancer without recreating it.\n\nDetailed change list:\n1. Add reset methods to all the stateful objects that are used in the WAGED rebalancer.\n2. Refine some of the potential race condition in the WAGED rebalancer components.\n3. Adjust the tests accordingly. Also adding new tests to cover the components reset / the WAGED rebalancer reset logic.", "committedDate": "2020-01-23T00:15:33Z", "type": "commit"}, {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "url": "https://github.com/apache/helix/commit/b15bbd10381ad24fb8f6c89160210b723bd0415e", "message": "Additional change to clean up the WAGED rebalancer's constructors.", "committedDate": "2020-01-23T01:16:38Z", "type": "commit"}, {"oid": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "url": "https://github.com/apache/helix/commit/b15bbd10381ad24fb8f6c89160210b723bd0415e", "message": "Additional change to clean up the WAGED rebalancer's constructors.", "committedDate": "2020-01-23T01:16:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg5NzI5Ng==", "url": "https://github.com/apache/helix/pull/696#discussion_r369897296", "bodyText": "Whether HelixManager is null or not is not and should not be a flag for DelayedRebalance. Why does the log specifically mention delayed rebalance here?", "author": "narendly", "createdAt": "2020-01-23T01:45:47Z", "path": "helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/WagedRebalancer.java", "diffHunk": "@@ -177,12 +172,13 @@ private WagedRebalancer(AssignmentMetadataStore assignmentMetadataStore,\n     _assignmentMetadataStore = assignmentMetadataStore;\n     _rebalanceAlgorithm = algorithm;\n     _mappingCalculator = mappingCalculator;\n+    if (manager == null) {\n+      LOG.warn(\"HelixManager is not provided. The rebalancer is not going to schedule for a future \"\n+          + \"rebalance even when delayed rebalance is enabled.\");", "originalCommit": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwOTEwNw==", "url": "https://github.com/apache/helix/pull/696#discussion_r370309107", "bodyText": "DelayedRebalance != delayed rebalance.\nWAGED rebalancer also supports delayed rebalance feature. And this check will only impact this feature inside the WAGED rebalancer. We need to log it so when we debug we ensure if the delayed rebalance feature has been enabled or not.", "author": "jiajunwang", "createdAt": "2020-01-23T19:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg5NzI5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNjU5Ng==", "url": "https://github.com/apache/helix/pull/696#discussion_r369906596", "bodyText": "Nit: I think clearMetadataStore() might be a better name for this method because caching isn't really an explicit feature? Or resetMetadataStore()?", "author": "narendly", "createdAt": "2020-01-23T02:26:52Z", "path": "helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java", "diffHunk": "@@ -146,6 +146,17 @@ public boolean persistBestPossibleAssignment(\n     return true;\n   }\n \n+  protected synchronized void resetCache() {", "originalCommit": "b15bbd10381ad24fb8f6c89160210b723bd0415e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMwOTY1NA==", "url": "https://github.com/apache/helix/pull/696#discussion_r370309654", "bodyText": "Let's just call it reset()\nAssignmentMetadataStore.resetMetadataStore() is redundent.", "author": "jiajunwang", "createdAt": "2020-01-23T19:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTkwNjU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "55598b61cbcd5d278aeb7a9fa842e811f91ea975", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java b/helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java\nindex f84cf1fc3..afd018773 100644\n--- a/helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java\n+++ b/helix-core/src/main/java/org/apache/helix/controller/rebalancer/waged/AssignmentMetadataStore.java\n\n@@ -146,7 +146,7 @@ public class AssignmentMetadataStore {\n     return true;\n   }\n \n-  protected synchronized void resetCache() {\n+  protected synchronized void reset() {\n     if (_bestPossibleAssignment != null) {\n       _bestPossibleAssignment.clear();\n       _bestPossibleAssignment = null;\n"}}, {"oid": "55598b61cbcd5d278aeb7a9fa842e811f91ea975", "url": "https://github.com/apache/helix/commit/55598b61cbcd5d278aeb7a9fa842e811f91ea975", "message": "Rename method.", "committedDate": "2020-01-23T19:27:51Z", "type": "commit"}]}