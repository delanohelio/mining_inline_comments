{"pr_number": 1439, "pr_title": "Implement addTask API", "pr_createdAt": "2020-10-06T06:37:20Z", "pr_url": "https://github.com/apache/helix/pull/1439", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTMyMA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500469320", "bodyText": "Not necessarily a running job, people can add task to NOT_STARTED jobs too, right?", "author": "lei-xia", "createdAt": "2020-10-06T17:22:49Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTg2MA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500469860", "bodyText": "Add a task to a job, if a job is already completed, this operation has no effect?", "author": "lei-xia", "createdAt": "2020-10-06T17:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMjI2NA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501212264", "bodyText": "Added not started also. Yes if it is completed, then the add operation will be failed.", "author": "alirezazamani", "createdAt": "2020-10-07T18:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDk4MQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500470981", "bodyText": "I would suggest  to change the parameters order to this (String workflowName, String jobName, TaskConfig, timeout), just to follow the conventions in other methods in the TaskDriver.", "author": "lei-xia", "createdAt": "2020-10-06T17:25:27Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMjMzOQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501212339", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-07T18:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MDk4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MTg0NA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500471844", "bodyText": "If the workflow has not started, the context does not exist, right?  But do we allow them to add a task to newly created workflow/job?", "author": "lei-xia", "createdAt": "2020-10-06T17:26:42Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMjUxNg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501212516", "bodyText": "Yes. Added this behavior.", "author": "alirezazamani", "createdAt": "2020-10-07T18:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MTg0NA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MzA0OA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500473048", "bodyText": "Can we wrap this logic to a separate (private) method, such as validateTaskConfig(). Also, you may want to put this check at the beginning of the method (to avoid non-necessary ZK read if the input itself is not valid).", "author": "lei-xia", "createdAt": "2020-10-06T17:28:35Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMjYxMA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501212610", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-07T18:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MzA0OA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDA2Mg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500474062", "bodyText": "Could the JobState be null when the job was just created (has not be scheduled by the controller)?", "author": "lei-xia", "createdAt": "2020-10-06T17:30:08Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyMzQ3OA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501223478", "bodyText": "Added the ability to add a task to a job that is not started. If the job is not started or context is null, we can add tasks to the job.", "author": "alirezazamani", "createdAt": "2020-10-07T18:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDQxNQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500474415", "bodyText": "LOG.ERROR?", "author": "lei-xia", "createdAt": "2020-10-06T17:30:42Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMjcxMg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501212712", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-07T18:11:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NDQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500476813", "bodyText": "What will happen if timeout is less than 1000ms?  You may want to adjust the sleep time here based on the given timeout?", "author": "lei-xia", "createdAt": "2020-10-06T17:34:35Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);\n+      for (Map.Entry<String, Integer> entry : jobContext.getTaskIdPartitionMap().entrySet()) {\n+        if (entry.getKey().equals(taskID) && getWorkflowContext(workflowName)\n+            .getJobState(nameSpaceJobName) == TaskState.IN_PROGRESS) {\n+          return;\n+        }\n+      }\n+      Thread.sleep(1000L);", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIxMzU4NQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501213585", "bodyText": "This is the behaviour we are using in the other functions of the TaskDriver. I think we can stick to the same behaviour here as well. Let me know your thoughts.", "author": "alirezazamani", "createdAt": "2020-10-07T18:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0ODA0MQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502648041", "bodyText": "If there are other places, then please don't hardcode the time.\nIn addition, IMO, the timeout less than 1000ms does not make sense, so we shall reject the request. Obviously, we shall mention in the public API that timeout less than 1000ms means no wait, or just being rejected.", "author": "jiajunwang", "createdAt": "2020-10-09T20:07:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3ODI1Mw==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502678253", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:25:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NjgxMw=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NzgzMQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500477831", "bodyText": "Please add more javaDoc here to describe 1) the behaviors and expectations (task may not be added in different senarios), 2) what does the timeout here mean? and what the caller should do if it is timeout? 3) The possible Exceptions (and what does each mean) could be thrown.", "author": "lei-xia", "createdAt": "2020-10-06T17:36:21Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4ODc1Mw==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501288753", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-07T20:26:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NzgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTUwNQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500479505", "bodyText": "Should we throw a specific TimeoutException instead of a general exception. What is the caller expected to do if it is timeout, call another method to verify whether the task has been successfully added, or retry the addTask()?", "author": "lei-xia", "createdAt": "2020-10-06T17:39:15Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);\n+      for (Map.Entry<String, Integer> entry : jobContext.getTaskIdPartitionMap().entrySet()) {\n+        if (entry.getKey().equals(taskID) && getWorkflowContext(workflowName)\n+            .getJobState(nameSpaceJobName) == TaskState.IN_PROGRESS) {\n+          return;\n+        }\n+      }\n+      Thread.sleep(1000L);\n+    }\n+    throw new HelixException(\"An unexpected issue happened while task being added to the job!\");", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTIyMjQ0OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501222449", "bodyText": "Changed it to timeout exception.", "author": "alirezazamani", "createdAt": "2020-10-07T18:24:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTUwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDk5OA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500574998", "bodyText": "The default timeout is 5 mins. It is pretty long. Shall we just provide one method that returns immediately and one that waits for a timeout?", "author": "jiajunwang", "createdAt": "2020-10-06T20:26:35Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4OTI0OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501289249", "bodyText": "I think the agreement in the design doc was to have a timeout to check if the task has been added to not. Also, we are exposing another API with a non-default timeout.", "author": "alirezazamani", "createdAt": "2020-10-07T20:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDk5OA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NTk3MA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500575970", "bodyText": "Please define this as a private static field of the class.", "author": "jiajunwang", "createdAt": "2020-10-06T20:28:22Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI4OTMxNw==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501289317", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-07T20:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NTk3MA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3OTkwMA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r500579900", "bodyText": "It could be a trick issue, please verify.\nIt is possible that the caller pass accessor and propertyStore backed by different ZkClient. In this case, the accessor is used to update and the propertyStore is used to get context here. Given there might be a propagation latency on ZK server-side, this check here might be invalid. We need to set and read using the same ZkClient.", "author": "jiajunwang", "createdAt": "2020-10-06T20:35:53Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +524,123 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job with default timeout\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n+    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job\n+   * @param taskConfig\n+   * @param workflowName\n+   * @param jobName\n+   * @param timeout\n+   * @throws Exception\n+   */\n+  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+      throws Exception {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    long endTime = System.currentTimeMillis() + timeout;\n+\n+    if (workflowConfig == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    }\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+    if (jobConfig == null) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(\n+          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    }\n+\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    if (workflowContext == null) {\n+      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {\n+      throw new HelixException(\n+          \"Task cannot be added because command existed for both of job and task!\");\n+    }\n+\n+    for (String taskEntry : jobConfig.getMapConfigs().keySet()) {\n+      if (taskEntry.equals(taskConfig.getId())) {\n+        throw new HelixException(\n+            \"Task cannot be added because another task with the same ID already exists!\");\n+      }\n+    }\n+\n+    Set<TaskState> illegalJobStateForTaskAddition =\n+        new HashSet<>(Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING,\n+            TaskState.FAILED, TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPED,\n+            TaskState.STOPPING));\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because JobState \" + nameSpaceJobName + \" is null!\");\n+    }\n+\n+    if (illegalJobStateForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n+    }\n+\n+    DataUpdater<ZNRecord> updater = currentData -> {\n+      if (currentData != null) {\n+        currentData.setMapField(taskConfig.getId(), taskConfig.getConfigMap());\n+      } else {\n+        LOG.warn(\"JobConfig DataUpdater: Fails to update JobConfig. CurrentData is null.\");\n+      }\n+      return currentData;\n+    };\n+\n+    String path = _accessor.keyBuilder().resourceConfig(nameSpaceJobName).getPath();\n+    boolean status = _accessor.getBaseDataAccessor().update(path, updater, AccessOption.PERSISTENT);\n+    if (!status) {\n+      LOG.error(\"Failed to add task to the job {}\", nameSpaceJobName);\n+      throw new HelixException(\"Failed to add task to the job\");\n+    }\n+\n+    String taskID = taskConfig.getId();\n+    while (System.currentTimeMillis() <= endTime) {\n+      JobContext jobContext = getJobContext(nameSpaceJobName);", "originalCommit": "0c0782b90de1593cb72a3ad515fc6190e5088c11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM1NTQwNA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r501355404", "bodyText": "I don't think it is the case here. Here is how we initialize TaskDriver\n  public TaskDriver(HelixManager manager) {\n    this(manager.getClusterManagmentTool(), manager.getHelixDataAccessor(),\n        manager.getHelixPropertyStore(), manager.getClusterName());\n  }\n\nall of the input parameters are backed by the same manager.", "author": "alirezazamani", "createdAt": "2020-10-07T22:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3OTkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NTc2NA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502645764", "bodyText": "However, the following public constructor is not in this case.\npublic TaskDriver(HelixAdmin admin, HelixDataAccessor accessor,\nHelixPropertyStore propertyStore, String clusterName) {", "author": "jiajunwang", "createdAt": "2020-10-09T20:01:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3OTkwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NzU1MA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502677550", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:24:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3OTkwMA=="}], "type": "inlineReview", "revised_code": {"commit": "7388475382f2740511c508845823658dbf9986cd", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 8e1905812..5a9b29aea 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -525,51 +531,92 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job with default timeout\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName) throws Exception {\n-    addTask(taskConfig, workflowName, jobName, DEFAULT_TIMEOUT);\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job\n-   * @param taskConfig\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n    * @param workflowName\n    * @param jobName\n+   * @param taskConfig\n    * @param timeout\n    * @throws Exception\n    */\n-  public void addTask(TaskConfig taskConfig, String workflowName, String jobName, long timeout)\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeout)\n       throws Exception {\n-    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     long endTime = System.currentTimeMillis() + timeout;\n \n-    if (workflowConfig == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" config does not exist!\");\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (illegalJobStatesForTaskAddition.contains(jobState)) {\n+      throw new HelixException(\"Job \" + nameSpaceJobName\n+          + \" is in illegal state to accept new task. Job State is \" + jobState);\n     }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n \n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n     String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n     JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n-    if (jobConfig == null) {\n-      throw new HelixException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n-    }\n \n-    if (jobConfig.getTargetResource() != null) {\n-      throw new HelixException(\n-          \"Job \" + nameSpaceJobName + \" is a targeted job. New task cannot be added to this job!\");\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\"Workflow \" + workflowName + \" config does not exist!\");\n     }\n \n-    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n-    if (workflowContext == null) {\n-      throw new HelixException(\"Workflow \" + workflowName + \" context does not exist!\");\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\"Job \" + nameSpaceJobName + \" config does not exist!\");\n     }\n \n     if (taskConfig == null) {\n-      throw new IllegalArgumentException(\"Task cannot be added because taskConfig is null!\");\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n     }\n \n     if (taskConfig.getId() == null) {\n"}}, {"oid": "4eed4a2cd2c8b59482e1d94b778bf47fb3d7451f", "url": "https://github.com/apache/helix/commit/4eed4a2cd2c8b59482e1d94b778bf47fb3d7451f", "message": "Implement addTask API\n\nIn this commit, addTask API has been implemented which\nadd new task to running (IN-PROGRESS) jobs.", "committedDate": "2020-10-07T17:41:10Z", "type": "commit"}, {"oid": "7388475382f2740511c508845823658dbf9986cd", "url": "https://github.com/apache/helix/commit/7388475382f2740511c508845823658dbf9986cd", "message": "Addressing the comments", "committedDate": "2020-10-07T20:35:57Z", "type": "commit"}, {"oid": "7388475382f2740511c508845823658dbf9986cd", "url": "https://github.com/apache/helix/commit/7388475382f2740511c508845823658dbf9986cd", "message": "Addressing the comments", "committedDate": "2020-10-07T20:35:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NjE4MQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502646181", "bodyText": "nit, private final static... please\nAlso, in this case, the var name should be ILLEGAL_JOB_STATES_FOR_TASK_ADDITION (or TASKS_MODIFICATION?)", "author": "jiajunwang", "createdAt": "2020-10-09T20:02:49Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -77,6 +76,11 @@\n   /** Default time out for monitoring workflow or job state */\n   private final static int DEFAULT_TIMEOUT = 5 * 60 * 1000; /* 5 mins */\n \n+  /** The illegal job states for the jobs to accept new task */\n+  private static Set<TaskState> illegalJobStatesForTaskAddition = new HashSet<>(", "originalCommit": "7388475382f2740511c508845823658dbf9986cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NzQ5OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502677499", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NjE4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 5a9b29aea..44943b61e 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -76,8 +76,11 @@ public class TaskDriver {\n   /** Default time out for monitoring workflow or job state */\n   private final static int DEFAULT_TIMEOUT = 5 * 60 * 1000; /* 5 mins */\n \n-  /** The illegal job states for the jobs to accept new task */\n-  private static Set<TaskState> illegalJobStatesForTaskAddition = new HashSet<>(\n+  /** Default sleep time for requests */\n+  private final static long DEFAULT_SLEEP = 1000L; /* 1 second */\n+\n+  /** The illegal job states for job to accept new tasks */\n+  private final static Set<TaskState> ILLEGAL_JOB_STATES_FOR_TASK_MODIFICATION = new HashSet<>(\n       Arrays.asList(TaskState.TIMING_OUT, TaskState.TIMED_OUT, TaskState.FAILING, TaskState.FAILED,\n           TaskState.ABORTED, TaskState.COMPLETED, TaskState.STOPPING, TaskState.STOPPED));\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0Njk3OA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502646978", "bodyText": "\"default timeout\" is not clear enough.\nPlease mention the real timeout here. Maybe use java doc feature to link with the variable would be a good idea. But I'm not sure if it works fine. please have a try.", "author": "jiajunwang", "createdAt": "2020-10-09T20:04:52Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +530,163 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout", "originalCommit": "7388475382f2740511c508845823658dbf9986cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NzQ1Nw==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502677457", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0Njk3OA=="}], "type": "inlineReview", "revised_code": {"commit": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 5a9b29aea..44943b61e 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -531,14 +534,14 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n-   * operation is default timeout\n-   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n-   * new task is if the job is in progress or the job has not started yet.\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n    * Note2: The job can only be added to non-targeted jobs.\n-   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n    * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n-   * been successfully added ot not.\n+   * been successfully added or not.\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NzA3MA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502647070", "bodyText": "unit", "author": "jiajunwang", "createdAt": "2020-10-09T20:05:05Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +530,163 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n+   * operation is default timeout\n+   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n+   * new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or the job which is not started yet\n+   * Note1: Task may cannot be added if the job is in an illegal state. The states that job can\n+   * accept new task is if the job is in progress or the job has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added ot not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeout", "originalCommit": "7388475382f2740511c508845823658dbf9986cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NzI1NQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502677255", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0NzA3MA=="}], "type": "inlineReview", "revised_code": {"commit": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 5a9b29aea..44943b61e 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -531,14 +534,14 @@ public class TaskDriver {\n   }\n \n   /**\n-   * Add task to a running (IN-PROGRESS) job or the job which is not started yet. Timeout for this\n-   * operation is default timeout\n-   * Note1: Task cannot be added if the job is in an illegal state. The states that job can accept\n-   * new task is if the job is in progress or the job has not started yet.\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n    * Note2: The job can only be added to non-targeted jobs.\n-   * Note3: The taskID for new task should be unique. If not, this API throws and exception.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n    * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n-   * been successfully added ot not.\n+   * been successfully added or not.\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0ODMyNg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502648326", "bodyText": "nit, format the imports?", "author": "jiajunwang", "createdAt": "2020-10-09T20:07:58Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -28,6 +28,7 @@\n import java.util.Map;\n import java.util.Set;\n \n+import java.util.concurrent.TimeoutException;", "originalCommit": "7388475382f2740511c508845823658dbf9986cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NzI5OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r502677299", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-09T21:23:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY0ODMyNg=="}], "type": "inlineReview", "revised_code": {"commit": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 5a9b29aea..44943b61e 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -27,8 +27,8 @@ import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n-\n import java.util.concurrent.TimeoutException;\n+\n import org.apache.helix.AccessOption;\n import org.apache.helix.BaseDataAccessor;\n import org.apache.helix.ConfigAccessor;\n"}}, {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "url": "https://github.com/apache/helix/commit/dc5463281da78118ed1a1c30c6d1ed55cd159e50", "message": "Address comments", "committedDate": "2020-10-10T21:55:55Z", "type": "commit"}, {"oid": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "url": "https://github.com/apache/helix/commit/dc5463281da78118ed1a1c30c6d1ed55cd159e50", "message": "Address comments", "committedDate": "2020-10-10T21:55:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4NjM1Ng==", "url": "https://github.com/apache/helix/pull/1439#discussion_r503786356", "bodyText": "Since Exception is pretty generic, I don't see a clear clue where it is from. Can you clarify in what case this Exception is thrown?", "author": "huizhilu", "createdAt": "2020-10-13T09:01:51Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,177 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n+   * been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception", "originalCommit": "dc5463281da78118ed1a1c30c6d1ed55cd159e50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDMyMg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504190322", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-13T19:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc4NjM1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9b805011f2835226efdd9205896bc1c8fa36700c", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex 44943b61e..d9068446b 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -535,17 +535,21 @@ public class TaskDriver {\n \n   /**\n    * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n-   * operation is default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n    * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n    * new task if the job is in-progress or it has not started yet.\n    * Note2: The job can only be added to non-targeted jobs.\n-   * Note3: The taskID for new task should be unique. If not, this API throws an exception.\n-   * Note4: In case of timeout exception, it is user's responsibility to check whether the task has\n-   * been successfully added or not.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n-   * @throws Exception\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n    */\n   public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n     addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n"}}, {"oid": "9b805011f2835226efdd9205896bc1c8fa36700c", "url": "https://github.com/apache/helix/commit/9b805011f2835226efdd9205896bc1c8fa36700c", "message": "Add comments", "committedDate": "2020-10-13T16:45:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNTY1OA==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504115658", "bodyText": "This if condition is already covered by the one below.", "author": "NealSun96", "createdAt": "2020-10-13T16:58:52Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeoutMs)\n+      throws Exception {\n+\n+    if (timeoutMs < DEFAULT_SLEEP) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Timeout is less than the minimum acceptable timeout value which is %s ms\",\n+              DEFAULT_SLEEP));\n+    }\n+\n+    long endTime = System.currentTimeMillis() + timeoutMs;\n+\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {", "originalCommit": "9b805011f2835226efdd9205896bc1c8fa36700c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDUyOQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504190529", "bodyText": "removed.", "author": "alirezazamani", "createdAt": "2020-10-13T19:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNTY1OA=="}], "type": "inlineReview", "revised_code": {"commit": "bf965407d79c897406263c2b6f936a382466ab81", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex d9068446b..20c51b954 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -545,13 +545,13 @@ public class TaskDriver {\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n-   * @throws Exception if there is an issue with the request or the operation. 1-\n-   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n-   *           will be thrown if the job is not in the states to accept a new task or if there is\n-   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n-   *           the task addition is unknown and cannot be verified.\n+   * @throws TimeoutException if the outcome of the task addition is unknown and cannot be verified\n+   * @throws IllegalArgumentException if the inputs are invalid\n+   * @throws HelixException if the job is not in the states to accept a new task or if there is any\n+   *           issue in updating jobConfig.\n    */\n-  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig)\n+      throws TimeoutException, InterruptedException {\n     addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNjc2OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504116769", "bodyText": "nit: could combine into (taskConfig.getCommand() == null != jobConfig.getCommand() == null) and say \"Command must exist in either job or task, not both\".", "author": "NealSun96", "createdAt": "2020-10-13T17:00:44Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig, long timeoutMs)\n+      throws Exception {\n+\n+    if (timeoutMs < DEFAULT_SLEEP) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Timeout is less than the minimum acceptable timeout value which is %s ms\",\n+              DEFAULT_SLEEP));\n+    }\n+\n+    long endTime = System.currentTimeMillis() + timeoutMs;\n+\n+    validateAddTaskConfigs(workflowName, jobName, taskConfig);\n+\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    WorkflowContext workflowContext = getWorkflowContext(workflowName);\n+    JobContext jobContext = getJobContext(nameSpaceJobName);\n+    if (workflowContext == null || jobContext == null) {\n+      // Workflow context or job context is null. It means job has not been started. Hence task can\n+      // be added to the job\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    TaskState jobState = workflowContext.getJobState(nameSpaceJobName);\n+\n+    if (jobState == null) {\n+      // Null job state means the job has not started yet\n+      addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+      return;\n+    }\n+\n+    if (ILLEGAL_JOB_STATES_FOR_TASK_MODIFICATION.contains(jobState)) {\n+      throw new HelixException(\n+          String.format(\"Job %s is in illegal state to accept new task. Job State is %s\",\n+              nameSpaceJobName, jobState));\n+    }\n+    addTaskToJobConfig(workflowName, jobName, taskConfig, endTime);\n+  }\n+\n+  /**\n+   * The helper method which check the workflow, job and task configs to determine if new task can\n+   * be added to the job\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   */\n+  private void validateAddTaskConfigs(String workflowName, String jobName, TaskConfig taskConfig) {\n+    WorkflowConfig workflowConfig = TaskUtil.getWorkflowConfig(_accessor, workflowName);\n+    String nameSpaceJobName = TaskUtil.getNamespacedJobName(workflowName, jobName);\n+    JobConfig jobConfig = TaskUtil.getJobConfig(_accessor, nameSpaceJobName);\n+\n+    if (workflowConfig == null) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Workflow config for workflow %s does not exist!\", workflowName));\n+    }\n+\n+    if (jobConfig == null) {\n+      throw new IllegalArgumentException(\n+          String.format(\"Job config for job %s does not exist!\", nameSpaceJobName));\n+    }\n+\n+    if (taskConfig == null) {\n+      throw new IllegalArgumentException(\"TaskConfig is null!\");\n+    }\n+\n+    if (taskConfig.getId() == null) {\n+      throw new HelixException(\"Task cannot be added because taskID is null!\");\n+    }\n+\n+    if (jobConfig.getTargetResource() != null) {\n+      throw new HelixException(String.format(\n+          \"Job %s is a targeted job. New task cannot be added to this job!\", nameSpaceJobName));\n+    }\n+\n+    if (taskConfig.getCommand() == null && jobConfig.getCommand() == null) {\n+      throw new HelixException(\n+          \"Task cannot be added because both of the job and task have null command!\");\n+    }\n+\n+    if (taskConfig.getCommand() != null && jobConfig.getCommand() != null) {", "originalCommit": "9b805011f2835226efdd9205896bc1c8fa36700c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDk4Mg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504190982", "bodyText": "Good suggestion. Changed.", "author": "alirezazamani", "createdAt": "2020-10-13T19:05:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExNjc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf965407d79c897406263c2b6f936a382466ab81", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex d9068446b..20c51b954 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -545,13 +545,13 @@ public class TaskDriver {\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n-   * @throws Exception if there is an issue with the request or the operation. 1-\n-   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n-   *           will be thrown if the job is not in the states to accept a new task or if there is\n-   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n-   *           the task addition is unknown and cannot be verified.\n+   * @throws TimeoutException if the outcome of the task addition is unknown and cannot be verified\n+   * @throws IllegalArgumentException if the inputs are invalid\n+   * @throws HelixException if the job is not in the states to accept a new task or if there is any\n+   *           issue in updating jobConfig.\n    */\n-  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig)\n+      throws TimeoutException, InterruptedException {\n     addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1MzkyMg==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504153922", "bodyText": "It doesn't seem a general Exception is thrown, right? Since this is an API, to make the API signature clearer for users to use, instead of throwing a general Exception, shall we just throw an accurate exception that may be thrown: TimeoutException? Then it looks much clearer and easy to understand. RuntimeException doesn't need to be in a method signature.", "author": "huizhilu", "createdAt": "2020-10-13T18:03:46Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskDriver.java", "diffHunk": "@@ -526,6 +533,185 @@ public void enqueueJobs(final String queue, final List<String> jobs,\n     }\n   }\n \n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet. Timeout for this\n+   * operation is the default timeout which is 5 minutes. {@link TaskDriver#DEFAULT_TIMEOUT}\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @throws Exception if there is an issue with the request or the operation. 1-\n+   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n+   *           will be thrown if the job is not in the states to accept a new task or if there is\n+   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n+   *           the task addition is unknown and cannot be verified.\n+   */\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+    addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n+  }\n+\n+  /**\n+   * Add task to a running (IN-PROGRESS) job or a job which has not started yet\n+   * Note1: Task cannot be added if the job is in an illegal state. A job can accept\n+   * new task if the job is in-progress or it has not started yet.\n+   * Note2: The job can only be added to non-targeted jobs.\n+   * Note3: The taskID for the new task should be unique. If not, this API throws an exception.\n+   * Note4: In case of timeout exception, it is the user's responsibility to check whether the task\n+   * has been successfully added or not.\n+   * Note5: timeout is the time that this API checks whether the task has been successfully added or\n+   * not.\n+   * @param workflowName\n+   * @param jobName\n+   * @param taskConfig\n+   * @param timeoutMs\n+   * @throws Exception if there is an issue with the request or the operation. 1-", "originalCommit": "9b805011f2835226efdd9205896bc1c8fa36700c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE5MDM5OQ==", "url": "https://github.com/apache/helix/pull/1439#discussion_r504190399", "bodyText": "Done.", "author": "alirezazamani", "createdAt": "2020-10-13T19:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1MzkyMg=="}], "type": "inlineReview", "revised_code": {"commit": "bf965407d79c897406263c2b6f936a382466ab81", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\nindex d9068446b..20c51b954 100644\n--- a/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n+++ b/helix-core/src/main/java/org/apache/helix/task/TaskDriver.java\n\n@@ -545,13 +545,13 @@ public class TaskDriver {\n    * @param workflowName\n    * @param jobName\n    * @param taskConfig\n-   * @throws Exception if there is an issue with the request or the operation. 1-\n-   *           IllegalArgumentException will be thrown if the inputs are invalid. 2- HelixException\n-   *           will be thrown if the job is not in the states to accept a new task or if there is\n-   *           any issue in updating jobConfig. 3- TimeoutException will be thrown if the outcome of\n-   *           the task addition is unknown and cannot be verified.\n+   * @throws TimeoutException if the outcome of the task addition is unknown and cannot be verified\n+   * @throws IllegalArgumentException if the inputs are invalid\n+   * @throws HelixException if the job is not in the states to accept a new task or if there is any\n+   *           issue in updating jobConfig.\n    */\n-  public void addTask(String workflowName, String jobName, TaskConfig taskConfig) throws Exception {\n+  public void addTask(String workflowName, String jobName, TaskConfig taskConfig)\n+      throws TimeoutException, InterruptedException {\n     addTask(workflowName, jobName, taskConfig, DEFAULT_TIMEOUT);\n   }\n \n"}}, {"oid": "bf965407d79c897406263c2b6f936a382466ab81", "url": "https://github.com/apache/helix/commit/bf965407d79c897406263c2b6f936a382466ab81", "message": "Further comments being addressed", "committedDate": "2020-10-13T18:58:05Z", "type": "commit"}]}