{"pr_number": 1537, "pr_title": "fix two flaky test -- TestP2PNoDuplicatedMessage and TestDeleteJobFromJobQueue", "pr_createdAt": "2020-11-17T03:18:20Z", "pr_url": "https://github.com/apache/helix/pull/1537", "timeline": [{"oid": "990d5572ad1c75f18f4214065153e1fb8910a106", "url": "https://github.com/apache/helix/commit/990d5572ad1c75f18f4214065153e1fb8910a106", "message": "fix two flaky tests. For TestP2PNoDuplicatedMessage, cap the success\nrate to 90 percent as in github environment ZK access can be slow.\nFor TestDeleteJobFromJobQueue, the design of force delete can be\nin conflict with controller writes as contrary to what was noted by\nthe original deleveloper of this feature. We fix it by stop the\ncontroller for now.", "committedDate": "2020-11-17T04:01:35Z", "type": "commit"}, {"oid": "990d5572ad1c75f18f4214065153e1fb8910a106", "url": "https://github.com/apache/helix/commit/990d5572ad1c75f18f4214065153e1fb8910a106", "message": "fix two flaky tests. For TestP2PNoDuplicatedMessage, cap the success\nrate to 90 percent as in github environment ZK access can be slow.\nFor TestDeleteJobFromJobQueue, the design of force delete can be\nin conflict with controller writes as contrary to what was noted by\nthe original deleveloper of this feature. We fix it by stop the\ncontroller for now.", "committedDate": "2020-11-17T04:01:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDMwOA==", "url": "https://github.com/apache/helix/pull/1537#discussion_r525400308", "bodyText": "@zhangmeng916 and @lei-xia , could you please confirm if this is the expectation? I understand that Kai needs to change it since the current run does not always succeed with 100% threshold. But I'm not sure if this should be our expectation?", "author": "jiajunwang", "createdAt": "2020-11-17T18:43:23Z", "path": "helix-core/src/test/java/org/apache/helix/integration/messaging/TestP2PNoDuplicatedMessage.java", "diffHunk": "@@ -174,7 +174,10 @@ public void testP2PStateTransitionEnabled() {\n       verifyP2PEnabled(startTime);\n     }\n \n-    Assert.assertEquals(p2pTrigged, total);\n+    // The success rate really depends on how quick participant act in relationship with controller.\n+    // For now, we set 90% threshold.\n+    long threshold = Math.round(total * 0.9);", "originalCommit": "990d5572ad1c75f18f4214065153e1fb8910a106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzMTIyMA==", "url": "https://github.com/apache/helix/pull/1537#discussion_r525431220", "bodyText": "@jiajunwang, I sync-ed with Meng offline. @zhangmeng916, can you help to comment?", "author": "kaisun2000", "createdAt": "2020-11-17T19:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzNTk3Mg==", "url": "https://github.com/apache/helix/pull/1537#discussion_r525535972", "bodyText": "I think we cannot guarantee 100% P2P for all kinds of infrastructure. Although local tests always passed, there're some failures in our testing environment. The percent is always above 90% though. I believe there are corner cases that we cannot label all stale messages, which will block the sending of P2P.", "author": "zhangmeng916", "createdAt": "2020-11-17T21:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTIyOA==", "url": "https://github.com/apache/helix/pull/1537#discussion_r526501228", "bodyText": "Please make sure other reviewers are ok with this too.", "author": "zhangmeng916", "createdAt": "2020-11-18T23:56:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQwMDMwOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTA2NQ==", "url": "https://github.com/apache/helix/pull/1537#discussion_r526501065", "bodyText": "Can you change to \"TODO\", and put before the sleep line?", "author": "zhangmeng916", "createdAt": "2020-11-18T23:55:40Z", "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java", "diffHunk": "@@ -69,7 +69,14 @@ public void testForceDeleteJobFromJobQueue() throws InterruptedException {\n     Assert\n         .assertNotNull(_driver.getJobContext(TaskUtil.getNamespacedJobName(jobQueueName, \"job2\")));\n \n-    // The following force delete for the job should go through without getting an exception\n+    // Force deletion can have Exception thrown as controller is writing to propertystore path too.\n+    // https://github.com/apache/helix/issues/1406, also force deletion may not be safe.\n+    // Thus, we stop pipeline to make sure there is not such race condition.\n+    _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);\n+    Thread.sleep(3000);\n+    // note this sleep is critical as it would take time for controller to stop.", "originalCommit": "990d5572ad1c75f18f4214065153e1fb8910a106", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUyNzYzOQ==", "url": "https://github.com/apache/helix/pull/1537#discussion_r526527639", "bodyText": "changed.", "author": "kaisun2000", "createdAt": "2020-11-19T01:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMTA2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "71ce59eaa1984cb519d5a4aedbd709618b01773c", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\nindex 1988bd704..8a3e3de61 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n\n@@ -73,10 +73,10 @@ public class TestDeleteJobFromJobQueue extends TaskTestBase {\n     // https://github.com/apache/helix/issues/1406, also force deletion may not be safe.\n     // Thus, we stop pipeline to make sure there is not such race condition.\n     _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);\n-    Thread.sleep(3000);\n     // note this sleep is critical as it would take time for controller to stop.\n     // todo: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n     // todO: be another way. But this needs much more careful design.\n+    Thread.sleep(3000);\n     _driver.deleteJob(jobQueueName, \"job2\", true);\n \n     // Check that the job has been force-deleted (fully gone from ZK)\n"}}, {"oid": "71ce59eaa1984cb519d5a4aedbd709618b01773c", "url": "https://github.com/apache/helix/commit/71ce59eaa1984cb519d5a4aedbd709618b01773c", "message": "change todo comment up based on feedback.", "committedDate": "2020-11-19T01:12:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODEyMDAyNg==", "url": "https://github.com/apache/helix/pull/1537#discussion_r528120026", "bodyText": "CLUSTER_NAME is a defined in the parent class which is also used by other tests. How could you ensure disabling this CLUSTER_NAME would not impact or fail other tests that use the same cluster?", "author": "huizhilu", "createdAt": "2020-11-21T07:27:48Z", "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java", "diffHunk": "@@ -69,7 +69,14 @@ public void testForceDeleteJobFromJobQueue() throws InterruptedException {\n     Assert\n         .assertNotNull(_driver.getJobContext(TaskUtil.getNamespacedJobName(jobQueueName, \"job2\")));\n \n-    // The following force delete for the job should go through without getting an exception\n+    // Force deletion can have Exception thrown as controller is writing to propertystore path too.\n+    // https://github.com/apache/helix/issues/1406, also force deletion may not be safe.\n+    // Thus, we stop pipeline to make sure there is not such race condition.\n+    _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);", "originalCommit": "71ce59eaa1984cb519d5a4aedbd709618b01773c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODEzNzU0Mw==", "url": "https://github.com/apache/helix/pull/1537#discussion_r528137543", "bodyText": "protected final String CLUSTER_NAME = CLUSTER_PREFIX + \"_\" + getShortClassName(); each test class has unique  cluster name.", "author": "kaisun2000", "createdAt": "2020-11-21T07:52:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODEyMDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI3NjEyNg==", "url": "https://github.com/apache/helix/pull/1537#discussion_r528276126", "bodyText": "Ops, naming style as a constant but it is not... So easy to misread.", "author": "huizhilu", "createdAt": "2020-11-22T03:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODEyMDAyNg=="}], "type": "inlineReview", "revised_code": {"commit": "4d9dbbc6b757ac3dbba517f0968a46ae4c878cbd", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\nindex 8a3e3de61..8ade3a28a 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n\n@@ -74,8 +74,8 @@ public class TestDeleteJobFromJobQueue extends TaskTestBase {\n     // Thus, we stop pipeline to make sure there is not such race condition.\n     _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);\n     // note this sleep is critical as it would take time for controller to stop.\n-    // todo: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n-    // todO: be another way. But this needs much more careful design.\n+    // TODO: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n+    // TODO: be another way. But this needs much more careful design.\n     Thread.sleep(3000);\n     _driver.deleteJob(jobQueueName, \"job2\", true);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4MDM1MA==", "url": "https://github.com/apache/helix/pull/1537#discussion_r528980350", "bodyText": "Typo, and use uppercase \"TODO\", please.", "author": "jiajunwang", "createdAt": "2020-11-23T20:36:14Z", "path": "helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java", "diffHunk": "@@ -69,7 +69,14 @@ public void testForceDeleteJobFromJobQueue() throws InterruptedException {\n     Assert\n         .assertNotNull(_driver.getJobContext(TaskUtil.getNamespacedJobName(jobQueueName, \"job2\")));\n \n-    // The following force delete for the job should go through without getting an exception\n+    // Force deletion can have Exception thrown as controller is writing to propertystore path too.\n+    // https://github.com/apache/helix/issues/1406, also force deletion may not be safe.\n+    // Thus, we stop pipeline to make sure there is not such race condition.\n+    _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);\n+    // note this sleep is critical as it would take time for controller to stop.\n+    // todo: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n+    // todO: be another way. But this needs much more careful design.", "originalCommit": "71ce59eaa1984cb519d5a4aedbd709618b01773c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA3NTE0Mw==", "url": "https://github.com/apache/helix/pull/1537#discussion_r529075143", "bodyText": "fixed.", "author": "kaisun2000", "createdAt": "2020-11-24T00:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4MDM1MA=="}], "type": "inlineReview", "revised_code": {"commit": "4d9dbbc6b757ac3dbba517f0968a46ae4c878cbd", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\nindex 8a3e3de61..8ade3a28a 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/task/TestDeleteJobFromJobQueue.java\n\n@@ -74,8 +74,8 @@ public class TestDeleteJobFromJobQueue extends TaskTestBase {\n     // Thus, we stop pipeline to make sure there is not such race condition.\n     _gSetupTool.getClusterManagementTool().enableCluster(CLUSTER_NAME, false);\n     // note this sleep is critical as it would take time for controller to stop.\n-    // todo: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n-    // todO: be another way. But this needs much more careful design.\n+    // TODO: this is not best practice to sleep. Let GenericHelixController gives out a signal would\n+    // TODO: be another way. But this needs much more careful design.\n     Thread.sleep(3000);\n     _driver.deleteJob(jobQueueName, \"job2\", true);\n \n"}}, {"oid": "4d9dbbc6b757ac3dbba517f0968a46ae4c878cbd", "url": "https://github.com/apache/helix/commit/4d9dbbc6b757ac3dbba517f0968a46ae4c878cbd", "message": "fix typo", "committedDate": "2020-11-24T00:06:55Z", "type": "commit"}]}