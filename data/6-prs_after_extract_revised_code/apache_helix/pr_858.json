{"pr_number": 858, "pr_title": "Add logs and throw exceptions in getInstanceById", "pr_createdAt": "2020-03-04T22:34:06Z", "pr_url": "https://github.com/apache/helix/pull/858", "timeline": [{"oid": "77512846d2b9cd6a0f5b55f47445fa3f53849a77", "url": "https://github.com/apache/helix/commit/77512846d2b9cd6a0f5b55f47445fa3f53849a77", "message": "Add error handling to getInstanceById", "committedDate": "2020-03-04T21:41:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTI2MQ==", "url": "https://github.com/apache/helix/pull/858#discussion_r388015261", "bodyText": "This won't make things fail, will it? Since we are doing a continue, I don't think this would be necessary.", "author": "narendly", "createdAt": "2020-03-05T00:31:45Z", "path": "helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java", "diffHunk": "@@ -266,6 +269,9 @@ public static boolean isInstanceStable(HelixDataAccessor dataAccessor, String in\n       IdealState idealState = dataAccessor.getProperty(keyBuilder.idealStates(idealStateName));\n       if (idealState == null || !idealState.isEnabled() || !idealState.isValid()\n           || TaskConstants.STATE_MODEL_NAME.equals(idealState.getStateModelDefRef())) {\n+        _logger.warn(\n+            \"idealState is either null, not enabled, not valid, or has Task as stateModelDefRef. IdealState: {}\",\n+            instanceName);", "originalCommit": "77512846d2b9cd6a0f5b55f47445fa3f53849a77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyMjc1Mg==", "url": "https://github.com/apache/helix/pull/858#discussion_r388022752", "bodyText": "While this block doesn't fail the code, it's triggered in situations where idealState is null or is invalid. Just like the logs I did in InstanceServiceImpl.java, I think it's a good idea to log these unusual situations for debug purposes.", "author": "NealSun96", "createdAt": "2020-03-05T00:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyODMzMg==", "url": "https://github.com/apache/helix/pull/858#discussion_r388028332", "bodyText": "This block mostly exists to filter out non-existing IdealStates and Task Framework idealStates. The reason I pointed this out is because I don't think it will add much in debugging and it will just end up making the log file large. Let's not log this.", "author": "narendly", "createdAt": "2020-03-05T01:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNTczMA==", "url": "https://github.com/apache/helix/pull/858#discussion_r388035730", "bodyText": "I mostly want to ensure the case of idealState == null is caught. That situation shouldn't happen.\nRegardless, I don't have a strong opinion about this.", "author": "NealSun96", "createdAt": "2020-03-05T01:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTI2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAzNzIxNA==", "url": "https://github.com/apache/helix/pull/858#discussion_r388037214", "bodyText": "You're not catching anything here, right? Also if IdealState is null, you skip over that resource, right? Would that ever cause a problem?", "author": "narendly", "createdAt": "2020-03-05T01:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTI2MQ=="}], "type": "inlineReview", "revised_code": {"commit": "59573c574a2e71c90f046a3b45a8e239df70be44", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java b/helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java\nindex b7a4a1474..055e79796 100644\n--- a/helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java\n+++ b/helix-core/src/main/java/org/apache/helix/util/InstanceValidationUtil.java\n\n@@ -269,9 +269,6 @@ public class InstanceValidationUtil {\n       IdealState idealState = dataAccessor.getProperty(keyBuilder.idealStates(idealStateName));\n       if (idealState == null || !idealState.isEnabled() || !idealState.isValid()\n           || TaskConstants.STATE_MODEL_NAME.equals(idealState.getStateModelDefRef())) {\n-        _logger.warn(\n-            \"idealState is either null, not enabled, not valid, or has Task as stateModelDefRef. IdealState: {}\",\n-            instanceName);\n         continue;\n       }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTg1OA==", "url": "https://github.com/apache/helix/pull/858#discussion_r388015858", "bodyText": "LiveInstance?", "author": "narendly", "createdAt": "2020-03-05T00:33:41Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java", "diffHunk": "@@ -101,9 +103,15 @@ public InstanceInfo getInstanceInfo(String clusterId, String instanceName,\n             _dataAccessor.keyBuilder().currentState(instanceName, sessionId, resourceName));\n         if (currentState != null && currentState.getPartitionStateMap() != null) {\n           partitions.addAll(currentState.getPartitionStateMap().keySet());\n+        } else {\n+          LOG.warn(\n+              \"Current state is either null or partitionStateMap is missing. InstanceName: {}, SessionId: {}, ResourceName: {}\",\n+              instanceName, sessionId, resourceName);\n         }\n       }\n       instanceInfoBuilder.partitions(partitions);\n+    } else {\n+      LOG.warn(\"Missing instance config for {}\", instanceName);", "originalCommit": "77512846d2b9cd6a0f5b55f47445fa3f53849a77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAyMjg3Ng==", "url": "https://github.com/apache/helix/pull/858#discussion_r388022876", "bodyText": "Oops, let me fix that.", "author": "NealSun96", "createdAt": "2020-03-05T00:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODAxNTg1OA=="}], "type": "inlineReview", "revised_code": {"commit": "2c3da8869be9f023cf2f1e0555f65de8e6b6ae16", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java b/helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java\nindex 3605b9fec..931154418 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/server/service/InstanceServiceImpl.java\n\n@@ -111,7 +111,7 @@ public class InstanceServiceImpl implements InstanceService {\n       }\n       instanceInfoBuilder.partitions(partitions);\n     } else {\n-      LOG.warn(\"Missing instance config for {}\", instanceName);\n+      LOG.warn(\"Missing live instance for {}\", instanceName);\n     }\n     try {\n       Map<String, Boolean> healthStatus =\n"}}, {"oid": "2c3da8869be9f023cf2f1e0555f65de8e6b6ae16", "url": "https://github.com/apache/helix/commit/2c3da8869be9f023cf2f1e0555f65de8e6b6ae16", "message": "fix typo", "committedDate": "2020-03-05T00:58:38Z", "type": "commit"}, {"oid": "59573c574a2e71c90f046a3b45a8e239df70be44", "url": "https://github.com/apache/helix/commit/59573c574a2e71c90f046a3b45a8e239df70be44", "message": "remove log", "committedDate": "2020-03-05T01:45:03Z", "type": "commit"}]}