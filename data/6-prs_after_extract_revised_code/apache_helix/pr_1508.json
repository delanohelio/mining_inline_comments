{"pr_number": 1508, "pr_title": "Fix ondemand rebalance flooding and log flooding caused by dangling jobs", "pr_createdAt": "2020-11-03T03:45:12Z", "pr_url": "https://github.com/apache/helix/pull/1508", "timeline": [{"oid": "1ccbea19fd38c9e5abe9333ad2ffc81502404444", "url": "https://github.com/apache/helix/commit/1ccbea19fd38c9e5abe9333ad2ffc81502404444", "message": "Fix ondemand rebalance flooding caused by dangling jobs", "committedDate": "2020-11-03T01:28:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQxNTM0MQ==", "url": "https://github.com/apache/helix/pull/1508#discussion_r516415341", "bodyText": "Why this section is removed: this section is refresh runtime dags based on JobConfigs. For every new job config, its workflow is added; for ever job config that doesn't exist in the jobqueue's dag (seems to be duplicate with the first part of logic), its workflow is added.\nWith dangling jobs, their jobConfigs are never deleted, so this section is activated all the time and the workflow, if exists, will have its DAG refreshed all the time. The problem is detailed in PR description.\nI don't think the extra logic for new job config or for the race condition makes much sense, given that a new logic which compares WorkflowConfig version is in place - if a new job is added, eventually the DAG will be updated, which will cause a version change and a runtime dag refresh.", "author": "NealSun96", "createdAt": "2020-11-03T03:52:34Z", "path": "helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java", "diffHunk": "@@ -116,33 +116,6 @@ public synchronized boolean refresh(HelixDataAccessor accessor,\n       }\n     }\n \n-    // The following 3 blocks is for finding a list of workflows whose JobDAGs have been changed", "originalCommit": "1ccbea19fd38c9e5abe9333ad2ffc81502404444", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e14f0106b3fd2ca7453af177a1b7af093ed5482", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java b/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\nindex d24c32abe..d400e78c0 100644\n--- a/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\n+++ b/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\n\n@@ -116,9 +116,7 @@ public class TaskDataCache extends AbstractDataCache {\n       }\n     }\n \n-    // This block makes sure that the workflow config has been changed.\n-    // This avoid the race condition where job config has been purged but job has not been deleted\n-    // from JobDag yet\n+    // If the workflow config has been updated, it's possible that the dag has been changed.\n     for (String workflowName : _workflowConfigMap.keySet()) {\n       if (_runtimeJobDagMap.containsKey(workflowName)) {\n         if (_workflowConfigMap.get(workflowName).getRecord().getVersion() != _runtimeJobDagMap\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyOTkwNQ==", "url": "https://github.com/apache/helix/pull/1508#discussion_r516829905", "bodyText": "Maybe this comment needs to be changed. It was added for the purge race condition. Now it is serving as general-purpose workflow config modification.", "author": "alirezazamani", "createdAt": "2020-11-03T17:16:22Z", "path": "helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java", "diffHunk": "@@ -116,33 +116,6 @@ public synchronized boolean refresh(HelixDataAccessor accessor,\n       }\n     }\n \n-    // The following 3 blocks is for finding a list of workflows whose JobDAGs have been changed\n-    // because their RuntimeJobDags would need to be re-built\n-    // newly added jobs\n-    for (String jobName : newJobConfigs.keySet()) {\n-      if (!_jobConfigMap.containsKey(jobName) && newJobConfigs.get(jobName).getWorkflow() != null) {\n-        workflowsUpdated.add(newJobConfigs.get(jobName).getWorkflow());\n-      }\n-\n-      // Only for JobQueues when a new job is enqueued, there exists a race condition where only\n-      // JobConfig is updated and the RuntimeJobDag does not get updated because when the client\n-      // (TaskDriver) submits, it creates JobConfig ZNode first and modifies its parent JobDag next.\n-      // To ensure that they are both properly updated, check that workflow's DAG and existing\n-      // JobConfigs are consistent for JobQueues\n-      JobConfig jobConfig = newJobConfigs.get(jobName);\n-      if (_workflowConfigMap.containsKey(jobConfig.getWorkflow())) {\n-        WorkflowConfig workflowConfig = _workflowConfigMap.get(jobConfig.getWorkflow());\n-        // Check that the job's parent workflow's DAG contains this job\n-        if ((workflowConfig.isJobQueue() || !workflowConfig.isTerminable()) && !_runtimeJobDagMap\n-            .get(workflowConfig.getWorkflowId()).getAllNodes().contains(jobName)) {\n-          // Inconsistency between JobConfigs and DAGs found. Add the workflow to workflowsUpdated\n-          // to rebuild the RuntimeJobDag\n-          workflowsUpdated.add(jobConfig.getWorkflow());\n-        }\n-      }\n-    }\n-\n-    // Removed jobs\n     // This block makes sure that the workflow config has been changed.\n     // This avoid the race condition where job config has been purged but job has not been deleted", "originalCommit": "1ccbea19fd38c9e5abe9333ad2ffc81502404444", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8e14f0106b3fd2ca7453af177a1b7af093ed5482", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java b/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\nindex d24c32abe..d400e78c0 100644\n--- a/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\n+++ b/helix-core/src/main/java/org/apache/helix/common/caches/TaskDataCache.java\n\n@@ -116,9 +116,7 @@ public class TaskDataCache extends AbstractDataCache {\n       }\n     }\n \n-    // This block makes sure that the workflow config has been changed.\n-    // This avoid the race condition where job config has been purged but job has not been deleted\n-    // from JobDag yet\n+    // If the workflow config has been updated, it's possible that the dag has been changed.\n     for (String workflowName : _workflowConfigMap.keySet()) {\n       if (_runtimeJobDagMap.containsKey(workflowName)) {\n         if (_workflowConfigMap.get(workflowName).getRecord().getVersion() != _runtimeJobDagMap\n"}}, {"oid": "278afc6f4570fd86aab8f5727f3b82204dd72996", "url": "https://github.com/apache/helix/commit/278afc6f4570fd86aab8f5727f3b82204dd72996", "message": "Add test case", "committedDate": "2020-11-03T19:59:16Z", "type": "commit"}, {"oid": "8e14f0106b3fd2ca7453af177a1b7af093ed5482", "url": "https://github.com/apache/helix/commit/8e14f0106b3fd2ca7453af177a1b7af093ed5482", "message": "Comment change", "committedDate": "2020-11-03T23:55:24Z", "type": "commit"}]}