{"pr_number": 1201, "pr_title": "Identify and shutdown leaked timer threads", "pr_createdAt": "2020-08-01T00:57:43Z", "pr_url": "https://github.com/apache/helix/pull/1201", "timeline": [{"oid": "3ebaf2ccd7c9ac4080dcd14479642e2ae7f2cd85", "url": "https://github.com/apache/helix/commit/3ebaf2ccd7c9ac4080dcd14479642e2ae7f2cd85", "message": "Identify and shutdown leaked timer threads #1200\n\nUnit test has leaked several hundreds to thousand leaked timer threads.\nThis pull request give each timer thread a name to help identified the\nleaked threads. Also fix the major contributor of leaking in controller.", "committedDate": "2020-08-01T00:44:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM5NTg0MQ==", "url": "https://github.com/apache/helix/pull/1201#discussion_r465395841", "bodyText": "Shall we also stopOnDemandTimer on the FINALIZE notification? This is done for the PeriodRebalance timer.", "author": "jiajunwang", "createdAt": "2020-08-05T00:02:16Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -1272,7 +1280,7 @@ protected void checkLiveInstancesObservation(List<LiveInstance> liveInstances,\n \n   public void shutdown() throws InterruptedException {\n     stopPeriodRebalance();\n-\n+    stopOnDemandTimer();", "originalCommit": "3ebaf2ccd7c9ac4080dcd14479642e2ae7f2cd85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQwNTY1NQ==", "url": "https://github.com/apache/helix/pull/1201#discussion_r465405655", "bodyText": "I noticed it too. periodicalRebalanceTimer would be canceled in Finalize and created in init time. But this timer (added for p2p) did not do this. Maybe it is for a reason. (Not that familiar with P2P) I am afraid changing its life cycle may cause some unexpected behavior.", "author": "kaisun2000", "createdAt": "2020-08-05T00:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM5NTg0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkyMTk5OA==", "url": "https://github.com/apache/helix/pull/1201#discussion_r465921998", "bodyText": "In theory, if a FINALIZE notification comes, then we should stop any pending tasks. Or it will keep running even without the later INIT notification comes.\nBut I agree that this PR won't make it worse. We can skip that change for now.", "author": "jiajunwang", "createdAt": "2020-08-05T18:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM5NTg0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b467ef5a00784ad99f3f5862452a022484e2c0ef", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java b/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\nindex 94e1e1429..3f4dbc440 100644\n--- a/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\n+++ b/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\n\n@@ -1280,7 +1280,7 @@ public class GenericHelixController implements IdealStateChangeListener, LiveIns\n \n   public void shutdown() throws InterruptedException {\n     stopPeriodRebalance();\n-    stopOnDemandTimer();\n+    shutdownOnDemandTimer();\n     logger.info(\"Shutting down {} pipeline\", Pipeline.Type.DEFAULT.name());\n     shutdownPipeline(_eventThread, _eventQueue);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTMxMQ==", "url": "https://github.com/apache/helix/pull/1201#discussion_r465945311", "bodyText": "nit, let's call this shutdownOnDemandTimer.\nConsidering the periodRebalanceTimer can be started and stopped repeatedly. But this shutdownOnDemandTimer will be one-time thing in our logic.", "author": "jiajunwang", "createdAt": "2020-08-05T19:12:43Z", "path": "helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java", "diffHunk": "@@ -357,6 +358,12 @@ void stopPeriodRebalance() {\n     }\n   }\n \n+  private void stopOnDemandTimer() {", "originalCommit": "3ebaf2ccd7c9ac4080dcd14479642e2ae7f2cd85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MzM4NA==", "url": "https://github.com/apache/helix/pull/1201#discussion_r465953384", "bodyText": "changed.", "author": "kaisun2000", "createdAt": "2020-08-05T19:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b467ef5a00784ad99f3f5862452a022484e2c0ef", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java b/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\nindex 94e1e1429..3f4dbc440 100644\n--- a/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\n+++ b/helix-core/src/main/java/org/apache/helix/controller/GenericHelixController.java\n\n@@ -358,7 +358,7 @@ public class GenericHelixController implements IdealStateChangeListener, LiveIns\n     }\n   }\n \n-  private void stopOnDemandTimer() {\n+  private void shutdownOnDemandTimer() {\n     logger.info(\"GenericHelixController stopping onDemand timer\");\n     if (_onDemandRebalanceTimer != null) {\n       _onDemandRebalanceTimer.cancel();\n"}}, {"oid": "b467ef5a00784ad99f3f5862452a022484e2c0ef", "url": "https://github.com/apache/helix/commit/b467ef5a00784ad99f3f5862452a022484e2c0ef", "message": "change stopOnDemandTimer to shutdownOnDemandTimer", "committedDate": "2020-08-05T19:28:56Z", "type": "commit"}]}