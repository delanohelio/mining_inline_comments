{"pr_number": 819, "pr_title": "Make RealmAwareZkClient implementations use HttpRoutingDataReader for routing data", "pr_createdAt": "2020-02-27T00:11:39Z", "pr_url": "https://github.com/apache/helix/pull/819", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NTA2Nw==", "url": "https://github.com/apache/helix/pull/819#discussion_r385445067", "bodyText": "Document when/why IOExeption would be thrown and why InvalidRoutingDataException would be thrown.\nSeem from HttpRoutingDataReader code, if we can't get data/parse data from http respone, it would be IO exception, if constructing the trie based on parse http reponse failed, it is InvalidRoutingDataException.", "author": "kaisun2000", "createdAt": "2020-02-28T00:19:01Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/api/factory/RealmAwareZkClientFactory.java", "diffHunk": "@@ -31,25 +34,21 @@\n    * Build a RealmAwareZkClient using specified connection config and client config.\n    * @param connectionConfig\n    * @param clientConfig\n-   * @param metadataStoreRoutingData\n    * @return HelixZkClient", "originalCommit": "74ba53f0f773021eb2b14a540c212ff3c118ea34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3Mjc0Mw==", "url": "https://github.com/apache/helix/pull/819#discussion_r385472743", "bodyText": "That is correct. I will update the JavaDoc :)", "author": "narendly", "createdAt": "2020-02-28T02:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NTA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3a9d91c8be4955943a2d4dbd86e551b18cb4105e", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/api/factory/RealmAwareZkClientFactory.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/api/factory/RealmAwareZkClientFactory.java\nindex 7da4cc4ed..787f8251c 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/api/factory/RealmAwareZkClientFactory.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/api/factory/RealmAwareZkClientFactory.java\n\n@@ -46,8 +45,7 @@ public interface RealmAwareZkClientFactory {\n    * @return RealmAwareZkClient\n    */\n   default RealmAwareZkClient buildZkClient(\n-      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n-      MetadataStoreRoutingData metadataStoreRoutingData)\n+      RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig)\n       throws IOException, InvalidRoutingDataException {\n     return buildZkClient(connectionConfig, new RealmAwareZkClient.RealmAwareZkClientConfig());\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NDU2NQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r385454565", "bodyText": "This would be a conflict. Now my change is in, we need a rebase for this one.", "author": "kaisun2000", "createdAt": "2020-02-28T00:52:54Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/SharedZkClientFactory.java", "diffHunk": "@@ -45,21 +45,12 @@ protected SharedZkClientFactory() {\n   @Override\n   public RealmAwareZkClient buildZkClient(\n       RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n-      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig,\n-      MetadataStoreRoutingData metadataStoreRoutingData) {\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {", "originalCommit": "74ba53f0f773021eb2b14a540c212ff3c118ea34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3Mjg5OQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r385472899", "bodyText": "No worries.\nI won't merge this in until other ZkClients have been merged in. I might include other ZkClients in the scope of this PR.", "author": "narendly", "createdAt": "2020-02-28T02:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NDU2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "3a9d91c8be4955943a2d4dbd86e551b18cb4105e", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/SharedZkClientFactory.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/SharedZkClientFactory.java\nindex a7f1e3201..fb46ef20d 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/SharedZkClientFactory.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/SharedZkClientFactory.java\n\n@@ -39,16 +46,22 @@ public class SharedZkClientFactory extends HelixZkClientFactory {\n   private final HashMap<HelixZkClient.ZkConnectionConfig, ZkConnectionManager>\n       _connectionManagerPool = new HashMap<>();\n \n+  /*\n+   * Since we cannot really disconnect the ZkConnection, we need a dummy ZkConnection placeholder.\n+   * This is to ensure connection field is never null even the shared RealmAwareZkClient instance is closed so as to avoid NPE.\n+   */\n+  private final static ZkConnection IDLE_CONNECTION = new ZkConnection(\"Dummy_ZkServers\");\n+\n   protected SharedZkClientFactory() {\n   }\n \n   @Override\n   public RealmAwareZkClient buildZkClient(\n       RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n-      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig) {\n-    // TODO: Implement the logic\n-    // Return an instance of SharedZkClient\n-    return null;\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig)\n+      throws IOException, InvalidRoutingDataException {\n+    // Note, the logic sharing connectionManager logic is inside SharedZkClient, similar to innerSharedZkClient.\n+    return new SharedZkClient(connectionConfig, clientConfig);\n   }\n \n   private static class SingletonHelper {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NDk5NQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r385454995", "bodyText": "A little off topic. Do we have a issue to track this one? If we need to enhance this part, this is the number one issue in my opinion.", "author": "kaisun2000", "createdAt": "2020-02-28T00:54:35Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java", "diffHunk": "@@ -102,7 +102,8 @@ public static MetadataStoreRoutingData getMetadataStoreRoutingData()\n    * @throws IOException\n    */\n   private static String getAllRoutingData() throws IOException {\n-    // Note that MSDS_ENDPOINT should provide high-availability - it risks becoming a single point of failure if it's backed by a single IP address/host\n+    // Note that MSDS_ENDPOINT should provide high-availability - it risks becoming a single point\n+    // of failure if it's backed by a single IP address/host", "originalCommit": "74ba53f0f773021eb2b14a540c212ff3c118ea34", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ3MzA1Nw==", "url": "https://github.com/apache/helix/pull/819#discussion_r385473057", "bodyText": "We do not - could you please create an issue for it? Not an immediate blocker.", "author": "narendly", "createdAt": "2020-02-28T02:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1NDk5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "3a9d91c8be4955943a2d4dbd86e551b18cb4105e", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java\nindex 7a63d0df4..b4c1f9cd4 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/util/HttpRoutingDataReader.java\n\n@@ -106,7 +145,7 @@ public class HttpRoutingDataReader {\n     // of failure if it's backed by a single IP address/host\n     // Retry count is 3 by default.\n     HttpGet requestAllData = new HttpGet(\n-        MSDS_ENDPOINT + MetadataStoreRoutingConstants.MSDS_GET_ALL_ROUTING_DATA_ENDPOINT);\n+        SYSTEM_MSDS_ENDPOINT + MetadataStoreRoutingConstants.MSDS_GET_ALL_ROUTING_DATA_ENDPOINT);\n \n     // Define timeout configs\n     RequestConfig config = RequestConfig.custom().setConnectTimeout(HTTP_TIMEOUT_IN_MS)\n"}}, {"oid": "3a9d91c8be4955943a2d4dbd86e551b18cb4105e", "url": "https://github.com/apache/helix/commit/3a9d91c8be4955943a2d4dbd86e551b18cb4105e", "message": "Fix merge conflicts", "committedDate": "2020-03-01T03:56:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA==", "url": "https://github.com/apache/helix/pull/819#discussion_r386807578", "bodyText": "It may not be a good idea to declare exception in a constructor which I would try to avoid. For this case, I suggest catching them and throwing an IllegalStateException.", "author": "huizhilu", "createdAt": "2020-03-03T05:34:05Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java", "diffHunk": "@@ -80,19 +83,17 @@\n   private PathBasedZkSerializer _pathBasedZkSerializer;\n \n   // TODO: support capacity of ZkClient number in one FederatedZkClient and do garbage collection.\n-  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig,\n-      MetadataStoreRoutingData metadataStoreRoutingData) {\n-    if (metadataStoreRoutingData == null) {\n-      throw new IllegalArgumentException(\"MetadataStoreRoutingData cannot be null!\");\n-    }\n+  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig)\n+      throws IOException, InvalidRoutingDataException {", "originalCommit": "215ecf7549b27ff4c02c3e7763c0c7381154eb38", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0Nzg3Ng==", "url": "https://github.com/apache/helix/pull/819#discussion_r386847876", "bodyText": "Throwing exceptions in a constructor is not bad practice. In fact, it is the only way for a constructor to indicate that there is a problem; e.g. that the parameters/states are invalid.\nThis is a behavior agreed upon with @kaisun2000, which reminds me to add the Javadoc. IOException in the case of HTTP read failure, InvalidRoutingDataException in the case of an invalid routing data input. Users should be able to tell what's going on, and we let them distinguish failure cases by which type of exception we throw.", "author": "narendly", "createdAt": "2020-03-03T07:54:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Njk2MQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387186961", "bodyText": "I understand it is OK to throw exceptions in a constructor. In this case, if we declare exceptions in the signature, would it make it inconvenient to initialize/build a FederatedZkClient with try...catch? Personally, I would not like that. If the routing data does not exist or IO exception, it means routing data is not available for this FederatedZkClient construction. A runtime exception is good enough: IllegalStateException(\"Routing data is not available: \" + e.getMessage()). I wouldn't bother try...catch to construct a FederatedZkClient.", "author": "huizhilu", "createdAt": "2020-03-03T17:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIxOTQ1NQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387219455", "bodyText": "FederatedZkClient is still a low-level construct\nThis means that the users of this component will mostly be Helix Java APIs, and probably a few users who wish to use directly.\nIn that case, I think we still need to float these exceptions up and handle each case at the Helix Java API level. That way, we make it 1) user-friendly and 2) we still achieve the low-level granularity with FederatedZkClient that users of this class would want instead of hiding failure types behind an IllegalStateException.", "author": "narendly", "createdAt": "2020-03-03T18:44:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0NTE2Ng==", "url": "https://github.com/apache/helix/pull/819#discussion_r387445166", "bodyText": "Like I said, personally, hiding failure type in this case is more user-friendly than floating these exceptions up. And I also understand and respect your opinion.\nI am not sure how Helix Java APIs could handle these 2 exceptions differently when constructing this FederatedZkClient. Regarding a few other users, we could get opinions from them. I will be OK if we can get options from other users/committers and they think floating exceptions are better :)", "author": "huizhilu", "createdAt": "2020-03-04T04:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ4OTYxNQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387489615", "bodyText": "Here's one example where using checked exceptions is beneficial.\n\nYou could imagine a scenario where in the future we might have different sources from which we could obtain routing data. There is MSDS-1, MSDS-2, and MSDS-3 with different endpoints. In this case, we could add logic for trying options 1, 2, and 3 in order in case we run into IOException. Now, this logic won't apply to InvalidRoutingDataException because that implies that a data source is available but the actual routing data is invalid. This way, we could handle different exceptions differently.", "author": "narendly", "createdAt": "2020-03-04T07:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgwNzU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "1b9e9978ece4c96d547d11e3d2cdc4ec1f5d7b9c", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\nindex 90b7852d4..5f6340828 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\n\n@@ -83,10 +80,11 @@ public class FederatedZkClient implements RealmAwareZkClient {\n   private PathBasedZkSerializer _pathBasedZkSerializer;\n \n   // TODO: support capacity of ZkClient number in one FederatedZkClient and do garbage collection.\n-  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig)\n-      throws IOException, InvalidRoutingDataException {\n-    _metadataStoreRoutingData = HttpRoutingDataReader.getMetadataStoreRoutingData();\n-\n+  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig,\n+      MetadataStoreRoutingData metadataStoreRoutingData) {\n+    if (metadataStoreRoutingData == null) {\n+      throw new IllegalArgumentException(\"MetadataStoreRoutingData cannot be null!\");\n+    }\n     if (clientConfig == null) {\n       throw new IllegalArgumentException(\"Client config cannot be null!\");\n     }\n"}}, {"oid": "1b9e9978ece4c96d547d11e3d2cdc4ec1f5d7b9c", "url": "https://github.com/apache/helix/commit/1b9e9978ece4c96d547d11e3d2cdc4ec1f5d7b9c", "message": "Make DedicatedZkClient use HttpRoutingDataReader for routing data\n\nWe want all implementations of RealmAwareZkClient to do a one-time query to Metadata Store Directory Service for routing data and cache it in memory. In order to accomplish that, we have introduced HttpRoutingDataReader, which is a Singleton class that makes a REST call to read routing data and caches it in memory. This diff updates the initialization logic in DedicatedZkClient accordingly.\nChangelist:\n1. Update DedicatedZkClient initialization logic\n2. Fix tests", "committedDate": "2020-03-04T01:29:56Z", "type": "commit"}, {"oid": "4057d357319751fead08abce9c4e610dbd0ed4ab", "url": "https://github.com/apache/helix/commit/4057d357319751fead08abce9c4e610dbd0ed4ab", "message": "Update", "committedDate": "2020-03-04T01:29:56Z", "type": "commit"}, {"oid": "996547c53f8bc33821b40b21db811d32a0912821", "url": "https://github.com/apache/helix/commit/996547c53f8bc33821b40b21db811d32a0912821", "message": "refactor", "committedDate": "2020-03-04T01:30:27Z", "type": "commit"}, {"oid": "c3640a70d78106650d817a1da8b500299d3289b1", "url": "https://github.com/apache/helix/commit/c3640a70d78106650d817a1da8b500299d3289b1", "message": "fix job", "committedDate": "2020-03-04T01:30:27Z", "type": "commit"}, {"oid": "8b6cdec2bac7324f2effce42a0987d4529bcd83b", "url": "https://github.com/apache/helix/commit/8b6cdec2bac7324f2effce42a0987d4529bcd83b", "message": "Fix merge conflicts", "committedDate": "2020-03-04T01:30:27Z", "type": "commit"}, {"oid": "64d041e917f0ff03f5970b5ba8db5a5df830747d", "url": "https://github.com/apache/helix/commit/64d041e917f0ff03f5970b5ba8db5a5df830747d", "message": "asdf", "committedDate": "2020-03-04T01:30:27Z", "type": "commit"}, {"oid": "2ddff6720959a6b3f5e95ea93a803db1a45f12c3", "url": "https://github.com/apache/helix/commit/2ddff6720959a6b3f5e95ea93a803db1a45f12c3", "message": "Federated", "committedDate": "2020-03-04T01:30:27Z", "type": "commit"}, {"oid": "8fc917bf1d53c1760d6e13e95e6cbed03c840aad", "url": "https://github.com/apache/helix/commit/8fc917bf1d53c1760d6e13e95e6cbed03c840aad", "message": "fix tests", "committedDate": "2020-03-04T01:31:14Z", "type": "commit"}, {"oid": "e781b6a4953a4ebd1b7ec6c6b124b86646747bde", "url": "https://github.com/apache/helix/commit/e781b6a4953a4ebd1b7ec6c6b124b86646747bde", "message": "rebase", "committedDate": "2020-03-04T01:36:35Z", "type": "commit"}, {"oid": "e781b6a4953a4ebd1b7ec6c6b124b86646747bde", "url": "https://github.com/apache/helix/commit/e781b6a4953a4ebd1b7ec6c6b124b86646747bde", "message": "rebase", "committedDate": "2020-03-04T01:36:35Z", "type": "forcePushed"}, {"oid": "2af0a015bf158b97ccf06dc038de944ab7d56da5", "url": "https://github.com/apache/helix/commit/2af0a015bf158b97ccf06dc038de944ab7d56da5", "message": "conflict", "committedDate": "2020-03-04T01:59:12Z", "type": "commit"}, {"oid": "2fb55e2c2cd089386dd803576c9c224aaf803fa3", "url": "https://github.com/apache/helix/commit/2fb55e2c2cd089386dd803576c9c224aaf803fa3", "message": "remove", "committedDate": "2020-03-04T02:30:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTk2OQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387441969", "bodyText": "Typo in exception message. Should be RealmAwareZkClientConfig", "author": "huizhilu", "createdAt": "2020-03-04T04:21:43Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java", "diffHunk": "@@ -56,32 +59,42 @@\n   private final ZkClient _rawZkClient;\n   private final MetadataStoreRoutingData _metadataStoreRoutingData;\n   private final String _zkRealmShardingKey;\n-  private final String _zkRealmAddress;\n \n-  // TODO: Remove MetadataStoreRoutingData from constructor\n+  /**\n+   * DedicatedZkClient connects to a single ZK realm and supports full ZkClient functionalities\n+   * such as CRUD, change callback, and ephemeral operations for a single ZkRealmShardingKey.\n+   * @param connectionConfig\n+   * @param clientConfig\n+   * @throws IOException\n+   * @throws InvalidRoutingDataException\n+   */\n   public DedicatedZkClient(RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n-      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig,\n-      MetadataStoreRoutingData metadataStoreRoutingData) {\n-\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig)\n+      throws IOException, InvalidRoutingDataException {\n     if (connectionConfig == null) {\n       throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n     }\n-    _zkRealmShardingKey = connectionConfig.getZkRealmShardingKey();\n+    if (clientConfig == null) {\n+      throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");", "originalCommit": "2fb55e2c2cd089386dd803576c9c224aaf803fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ4NjUxNA==", "url": "https://github.com/apache/helix/pull/819#discussion_r387486514", "bodyText": "Good catch. Fixed", "author": "narendly", "createdAt": "2020-03-04T07:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MTk2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f70e8460d9bc32fc555707429e2bdced9e1a154f", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java\nindex 914f3d694..beeb08544 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java\n\n@@ -75,7 +75,7 @@ public class DedicatedZkClient implements RealmAwareZkClient {\n       throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n     }\n     if (clientConfig == null) {\n-      throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n+      throw new IllegalArgumentException(\"RealmAwareZkClientConfig cannot be null!\");\n     }\n \n     // Get the routing data from a static Singleton HttpRoutingDataReader\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MjQ3NQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387442475", "bodyText": "Nit, Shall we move this condition check out of try...catch block? I understand it not may be unrelated to your change. But since you already touch it and change the name :)\nOne more thing: This could throw NPE. _zkRealmShardingKey could be null if it is not set in connectionConfig when the user expects it to be a multi-realm mode by default.", "author": "huizhilu", "createdAt": "2020-03-04T04:24:22Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/DedicatedZkClient.java", "diffHunk": "@@ -457,17 +470,17 @@ public PathBasedZkSerializer getZkSerializer() {\n    * @return\n    */\n   private void checkIfPathContainsShardingKey(String path) {\n-    // TODO: replace with the singleton MetadataStoreRoutingData\n     try {\n-      String zkRealmForPath = _metadataStoreRoutingData.getMetadataStoreRealm(path);\n-      if (!_zkRealmAddress.equals(zkRealmForPath)) {\n-        throw new IllegalArgumentException(\"Given path: \" + path + \"'s ZK realm: \" + zkRealmForPath\n-            + \" does not match the ZK realm: \" + _zkRealmAddress + \" and sharding key: \"\n-            + _zkRealmShardingKey + \" for this DedicatedZkClient!\");\n+      String targetShardingKey = _metadataStoreRoutingData.getShardingKeyInPath(path);\n+      if (!_zkRealmShardingKey.equals(targetShardingKey)) {", "originalCommit": "2fb55e2c2cd089386dd803576c9c224aaf803fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ4ODEyOQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387488129", "bodyText": "I am glad that you brought this up. In fact, DedicatedZkClient and SharedZkClient are single-realm APIs, so we need to check in the constructor that Zk Sharding key is not null or empty.\nI will add this check. Then we don't need to worry about NPEs.", "author": "narendly", "createdAt": "2020-03-04T07:27:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0MjQ3NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0NTQxNQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387445415", "bodyText": "Client config in message.", "author": "huizhilu", "createdAt": "2020-03-04T04:39:09Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java", "diffHunk": "@@ -80,19 +83,27 @@\n   private PathBasedZkSerializer _pathBasedZkSerializer;\n \n   // TODO: support capacity of ZkClient number in one FederatedZkClient and do garbage collection.\n-  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkClientConfig clientConfig,\n-      MetadataStoreRoutingData metadataStoreRoutingData) {\n-    if (metadataStoreRoutingData == null) {\n-      throw new IllegalArgumentException(\"MetadataStoreRoutingData cannot be null!\");\n+  public FederatedZkClient(RealmAwareZkClient.RealmAwareZkConnectionConfig connectionConfig,\n+      RealmAwareZkClient.RealmAwareZkClientConfig clientConfig)\n+      throws IOException, InvalidRoutingDataException {\n+    if (connectionConfig == null) {\n+      throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n     }\n     if (clientConfig == null) {\n-      throw new IllegalArgumentException(\"Client config cannot be null!\");\n+      throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");", "originalCommit": "2fb55e2c2cd089386dd803576c9c224aaf803fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ4OTc3Mw==", "url": "https://github.com/apache/helix/pull/819#discussion_r387489773", "bodyText": "Fixed. thank you.", "author": "narendly", "createdAt": "2020-03-04T07:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0NTQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "f70e8460d9bc32fc555707429e2bdced9e1a154f", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\nindex 3b1933d19..1bfff6682 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/client/FederatedZkClient.java\n\n@@ -90,7 +90,7 @@ public class FederatedZkClient implements RealmAwareZkClient {\n       throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n     }\n     if (clientConfig == null) {\n-      throw new IllegalArgumentException(\"RealmAwareZkConnectionConfig cannot be null!\");\n+      throw new IllegalArgumentException(\"RealmAwareZkClientConfig cannot be null!\");\n     }\n \n     // Attempt to get MetadataStoreRoutingData\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0NjAwMg==", "url": "https://github.com/apache/helix/pull/819#discussion_r387446002", "bodyText": "static final?", "author": "huizhilu", "createdAt": "2020-03-04T04:42:20Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/constant/TestConstants.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package org.apache.helix.zookeeper.constant;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.util.Collection;\n+import java.util.Map;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+\n+\n+/**\n+ * Constants to be used for testing.\n+ */\n+public class TestConstants {\n+  // ZK hostname prefix and port to be used throughout the zookeeper-api module\n+  public static final String ZK_PREFIX = \"localhost:\";\n+  public static final int ZK_START_PORT = 2127;\n+\n+  // Based on the ZK hostname constants, construct a set of fake routing data mappings\n+  public static Map<String, Collection<String>> FAKE_ROUTING_DATA = ImmutableMap", "originalCommit": "2fb55e2c2cd089386dd803576c9c224aaf803fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ5MjE0OQ==", "url": "https://github.com/apache/helix/pull/819#discussion_r387492149", "bodyText": "Added final!", "author": "narendly", "createdAt": "2020-03-04T07:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ0NjAwMg=="}], "type": "inlineReview", "revised_code": {"commit": "f70e8460d9bc32fc555707429e2bdced9e1a154f", "chunk": "diff --git a/zookeeper-api/src/test/java/org/apache/helix/zookeeper/constant/TestConstants.java b/zookeeper-api/src/test/java/org/apache/helix/zookeeper/constant/TestConstants.java\nindex 8900598a7..a2172451f 100644\n--- a/zookeeper-api/src/test/java/org/apache/helix/zookeeper/constant/TestConstants.java\n+++ b/zookeeper-api/src/test/java/org/apache/helix/zookeeper/constant/TestConstants.java\n\n@@ -35,7 +35,7 @@ public class TestConstants {\n   public static final int ZK_START_PORT = 2127;\n \n   // Based on the ZK hostname constants, construct a set of fake routing data mappings\n-  public static Map<String, Collection<String>> FAKE_ROUTING_DATA = ImmutableMap\n+  public static final Map<String, Collection<String>> FAKE_ROUTING_DATA = ImmutableMap\n       .of(ZK_PREFIX + ZK_START_PORT,\n           ImmutableList.of(\"/sharding-key-0\", \"/sharding-key-1\", \"/sharding-key-2\"),\n           ZK_PREFIX + (ZK_START_PORT + 1),\n"}}, {"oid": "f70e8460d9bc32fc555707429e2bdced9e1a154f", "url": "https://github.com/apache/helix/commit/f70e8460d9bc32fc555707429e2bdced9e1a154f", "message": "addresscomments", "committedDate": "2020-03-04T07:34:53Z", "type": "commit"}]}