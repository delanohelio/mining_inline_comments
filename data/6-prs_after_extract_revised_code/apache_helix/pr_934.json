{"pr_number": 934, "pr_title": "Add cache update/delete in customized view aggregation stage", "pr_createdAt": "2020-04-08T19:03:39Z", "pr_url": "https://github.com/apache/helix/pull/934", "timeline": [{"oid": "0f08b1b4e3fa2c5f6e6cac637dc1f0c1441a9d40", "url": "https://github.com/apache/helix/commit/0f08b1b4e3fa2c5f6e6cac637dc1f0c1441a9d40", "message": "modify cache", "committedDate": "2020-04-08T18:58:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzMyNg==", "url": "https://github.com/apache/helix/pull/934#discussion_r406603326", "bodyText": "nit, You can move this condition out of the loop by checking and adding key if not exists.\nThen in the loop, you only need to set property.", "author": "jiajunwang", "createdAt": "2020-04-10T05:03:31Z", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -257,6 +258,24 @@ public void updateExternalViews(List<ExternalView> externalViews) {\n     }\n   }\n \n+  /**\n+   * Update the cached customized view map\n+   * @param customizedViews\n+   */\n+  public void updateCustomizedViews(String customizedStateType,\n+      List<CustomizedView> customizedViews) {\n+    for (CustomizedView cv : customizedViews) {\n+      if (_customizedViewCacheMap.containsKey(customizedStateType)) {", "originalCommit": "0f08b1b4e3fa2c5f6e6cac637dc1f0c1441a9d40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8652635b0aff8479e0278f7df67c9309a8b0639c", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java b/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\nindex 787de4da6..ebe820c71 100644\n--- a/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\n+++ b/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\n\n@@ -264,15 +264,13 @@ public class ResourceControllerDataProvider extends BaseControllerDataProvider {\n    */\n   public void updateCustomizedViews(String customizedStateType,\n       List<CustomizedView> customizedViews) {\n+    if (!_customizedViewCacheMap.containsKey(customizedStateType)) {\n+      CustomizedViewCache customizedViewCache =\n+          new CustomizedViewCache(getClusterName(), customizedStateType);\n+      _customizedViewCacheMap.put(customizedStateType, customizedViewCache);\n+    }\n     for (CustomizedView cv : customizedViews) {\n-      if (_customizedViewCacheMap.containsKey(customizedStateType)) {\n-        _customizedViewCacheMap.get(customizedStateType).getCustomizedViewCache().setProperty(cv);\n-      } else {\n-        CustomizedViewCache customizedViewCache =\n-            new CustomizedViewCache(getClusterName(), customizedStateType);\n-        customizedViewCache.getCustomizedViewCache().setProperty(cv);\n-        _customizedViewCacheMap.put(customizedStateType, customizedViewCache);\n-      }\n+      _customizedViewCacheMap.get(customizedStateType).getCustomizedViewCache().setProperty(cv);\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYwMzU0NA==", "url": "https://github.com/apache/helix/pull/934#discussion_r406603544", "bodyText": "Safer to check if the stateType exists or not.", "author": "jiajunwang", "createdAt": "2020-04-10T05:04:34Z", "path": "helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java", "diffHunk": "@@ -281,12 +300,24 @@ public void removeExternalViews(List<String> resourceNames) {\n    * @param stateTypeNames\n    */\n \n-  private void removeCustomizedViewTypes(Set<String> stateTypeNames) {\n+  public void removeCustomizedViewTypes(Set<String> stateTypeNames) {\n     for (String stateType : stateTypeNames) {\n       _customizedViewCacheMap.remove(stateType);\n     }\n   }\n \n+  /**\n+   * Remove dead customized views for a certain state type from customized view cache\n+   * @param stateType a specific customized state type\n+   * @param resourceNames the names of resources whose customized view is stale\n+   */\n+  public void removeCustomizedViews(String stateType, List<String> resourceNames) {\n+    for (String resourceName : resourceNames) {\n+      _customizedViewCacheMap.get(stateType).getCustomizedViewCache()", "originalCommit": "0f08b1b4e3fa2c5f6e6cac637dc1f0c1441a9d40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8652635b0aff8479e0278f7df67c9309a8b0639c", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java b/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\nindex 787de4da6..ebe820c71 100644\n--- a/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\n+++ b/helix-core/src/main/java/org/apache/helix/controller/dataproviders/ResourceControllerDataProvider.java\n\n@@ -312,6 +310,10 @@ public class ResourceControllerDataProvider extends BaseControllerDataProvider {\n    * @param resourceNames the names of resources whose customized view is stale\n    */\n   public void removeCustomizedViews(String stateType, List<String> resourceNames) {\n+    if (!_customizedViewCacheMap.containsKey(stateType)) {\n+      logger.warn(String.format(\"The customized state type : %s is not in the cache\", stateType));\n+      return;\n+    }\n     for (String resourceName : resourceNames) {\n       _customizedViewCacheMap.get(stateType).getCustomizedViewCache()\n           .deletePropertyByName(resourceName);\n"}}, {"oid": "8652635b0aff8479e0278f7df67c9309a8b0639c", "url": "https://github.com/apache/helix/commit/8652635b0aff8479e0278f7df67c9309a8b0639c", "message": "fix comment", "committedDate": "2020-04-10T05:29:35Z", "type": "commit"}]}