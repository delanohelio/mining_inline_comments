{"pr_number": 681, "pr_title": "Integration test for controller connect and disconnect", "pr_createdAt": "2020-01-15T02:38:05Z", "pr_url": "https://github.com/apache/helix/pull/681", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NzA2Ng==", "url": "https://github.com/apache/helix/pull/681#discussion_r366697066", "bodyText": "Would this break a class which extends HelixTimerTask in an external package?", "author": "huizhilu", "createdAt": "2020-01-15T05:04:23Z", "path": "helix-core/src/main/java/org/apache/helix/HelixTimerTask.java", "diffHunk": "@@ -32,4 +32,9 @@\n    * Stop a timer task\n    */\n   public abstract void stop();\n+\n+  /**\n+   * Validate if the timer task is stopped\n+   */\n+  public abstract boolean isStopped();", "originalCommit": "f9ecd9d7913f8c65f4f4928dad365ddc74caeb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyNjc4Mg==", "url": "https://github.com/apache/helix/pull/681#discussion_r366726782", "bodyText": "If this is for test only, please keep it in the implementation classes and keep it protected.", "author": "jiajunwang", "createdAt": "2020-01-15T07:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NzA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNjE0OA==", "url": "https://github.com/apache/helix/pull/681#discussion_r367036148", "bodyText": "The only exposed interface from ZkHelixManager is List<HelixTimerTask> _controllerTimerTasks = xxx and the actual implementation class is static class StatusDumpTask which is not exposed neither. How could I create a protected method and make it only visible for the test?", "author": "i3wangyi", "createdAt": "2020-01-15T18:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NzA2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY4NjM3MQ==", "url": "https://github.com/apache/helix/pull/681#discussion_r367686371", "bodyText": "One of the options is to cast the HelixTimerTask to a wrapper subclass only visible in test folders. And it assumes the objects in the list will be of type StatusDumpTask", "author": "i3wangyi", "createdAt": "2020-01-16T22:37:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NzA2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b53609b37098f5e0e0dc7bfebd46685b2f572a33", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/HelixTimerTask.java b/helix-core/src/main/java/org/apache/helix/HelixTimerTask.java\nindex 1c1338f4a..a26d5afc9 100644\n--- a/helix-core/src/main/java/org/apache/helix/HelixTimerTask.java\n+++ b/helix-core/src/main/java/org/apache/helix/HelixTimerTask.java\n\n@@ -32,9 +37,4 @@ public abstract class HelixTimerTask {\n    * Stop a timer task\n    */\n   public abstract void stop();\n-\n-  /**\n-   * Validate if the timer task is stopped\n-   */\n-  public abstract boolean isStopped();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyODk3OA==", "url": "https://github.com/apache/helix/pull/681#discussion_r366728978", "bodyText": "I think we have the same test case, or a similar test case. For example, TestStandAloneCMMain.java, there is more related test cases. The existing tests are actually more complicated than this one.\nI'm fine if you want to re-org the test so they are together. But can we remove the old duplicated tests and ensure we keep the most complicated cases in our test list?", "author": "jiajunwang", "createdAt": "2020-01-15T07:38:04Z", "path": "helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java", "diffHunk": "@@ -20,29 +20,136 @@\n  */\n \n import java.lang.management.ManagementFactory;\n+import java.util.List;\n import javax.management.MBeanServer;\n import javax.management.ObjectName;\n \n import org.apache.helix.AccessOption;\n import org.apache.helix.HelixDataAccessor;\n import org.apache.helix.HelixManager;\n import org.apache.helix.HelixManagerFactory;\n+import org.apache.helix.HelixTimerTask;\n import org.apache.helix.InstanceType;\n import org.apache.helix.PropertyPathBuilder;\n import org.apache.helix.common.ZkTestBase;\n+import org.apache.helix.integration.manager.ClusterControllerManager;\n import org.apache.helix.integration.manager.MockParticipantManager;\n+import org.apache.helix.manager.zk.CallbackHandler;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n import org.apache.helix.model.IdealState;\n import org.apache.helix.model.LiveInstance;\n import org.apache.helix.monitoring.mbeans.MonitorDomainNames;\n import org.apache.helix.tools.ClusterVerifiers.BestPossibleExternalViewVerifier;\n import org.apache.helix.tools.ClusterVerifiers.ZkHelixClusterVerifier;\n import org.testng.Assert;\n+import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n+\n+/**\n+ * Integration test on controller leadership on several phases given the test cluster:\n+ *  1. When a standby node becomes the leader node\n+ *     - single leader node mode\n+ *  2. When a leader node becomes standby node\n+ *     - single leader node mode\n+ *  3. When a leader node becomes standby node and the other leader node becomes leader node\n+ *     - The dual leader nodes mode when the leadership of the test cluster gets changed\n+ */\n public class TestControllerLeadershipChange extends ZkTestBase {\n+  private final String CLASS_NAME = getShortClassName();\n+  private final String CLUSTER_NAME = \"TestCluster-\" + CLASS_NAME;\n+\n+  @BeforeClass\n+  public void beforeClass()\n+      throws Exception {\n+    super.beforeClass();\n+    _gSetupTool.addCluster(CLUSTER_NAME, true);\n+    // add some instances\n+    _gSetupTool.addInstanceToCluster(CLUSTER_NAME, \"TestInstance\");\n+    _gSetupTool.addResourceToCluster(CLUSTER_NAME, \"TestResource\", 10, \"MasterSlave\");\n+  }\n \n   @Test\n-  public void testMissingTopStateDurationMonitoring() throws Exception {\n+  public void testOnSingleController() {", "originalCommit": "f9ecd9d7913f8c65f4f4928dad365ddc74caeb3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAzNDc1OA==", "url": "https://github.com/apache/helix/pull/681#discussion_r367034758", "bodyText": "Thanks for mentioning it! I was unaware of the existing test case at all (it's not trivial to find out). Will merge the similarities part later", "author": "i3wangyi", "createdAt": "2020-01-15T18:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyODk3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY4NTk5MQ==", "url": "https://github.com/apache/helix/pull/681#discussion_r367685991", "bodyText": "Synced offline. We both agree that the existing test is outdated and already broken. The new test case will cover the one since it's deleted in the PR", "author": "i3wangyi", "createdAt": "2020-01-16T22:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyODk3OA=="}], "type": "inlineReview", "revised_code": {"commit": "b53609b37098f5e0e0dc7bfebd46685b2f572a33", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\nindex 359561d07..eefaa32bf 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n\n@@ -28,7 +28,6 @@ import org.apache.helix.AccessOption;\n import org.apache.helix.HelixDataAccessor;\n import org.apache.helix.HelixManager;\n import org.apache.helix.HelixManagerFactory;\n-import org.apache.helix.HelixTimerTask;\n import org.apache.helix.InstanceType;\n import org.apache.helix.PropertyPathBuilder;\n import org.apache.helix.common.ZkTestBase;\n"}}, {"oid": "b53609b37098f5e0e0dc7bfebd46685b2f572a33", "url": "https://github.com/apache/helix/commit/b53609b37098f5e0e0dc7bfebd46685b2f572a33", "message": "Integration test for verifying controller on/off leadership of a cluster", "committedDate": "2020-01-28T02:31:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NjQ3OQ==", "url": "https://github.com/apache/helix/pull/681#discussion_r372646479", "bodyText": "Please keep the test cases as silent as possible. Only log or throw error asserts on failure case.", "author": "jiajunwang", "createdAt": "2020-01-29T21:42:49Z", "path": "helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java", "diffHunk": "@@ -30,19 +31,157 @@\n import org.apache.helix.InstanceType;\n import org.apache.helix.PropertyPathBuilder;\n import org.apache.helix.common.ZkTestBase;\n+import org.apache.helix.integration.manager.ClusterControllerManager;\n import org.apache.helix.integration.manager.MockParticipantManager;\n+import org.apache.helix.manager.zk.CallbackHandler;\n+import org.apache.helix.manager.zk.client.HelixZkClient;\n import org.apache.helix.model.IdealState;\n import org.apache.helix.model.LiveInstance;\n import org.apache.helix.monitoring.mbeans.MonitorDomainNames;\n import org.apache.helix.tools.ClusterVerifiers.BestPossibleExternalViewVerifier;\n import org.apache.helix.tools.ClusterVerifiers.ZkHelixClusterVerifier;\n import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n import org.testng.annotations.Test;\n \n+\n+/**\n+ * Integration test on controller leadership on several phases given the test cluster:\n+ *  1. When a standalone controller becomes the leader\n+ *  2. When a standalone leader relinquishes the leadership\n+ *  3. When the leader node relinquishes the leadership and the other controller takes it over\n+ */\n public class TestControllerLeadershipChange extends ZkTestBase {\n+  private final String CLASS_NAME = getShortClassName();\n+  private final String CLUSTER_NAME = \"TestCluster-\" + CLASS_NAME;\n+\n+  @BeforeClass\n+  public void beforeClass()\n+      throws Exception {\n+    super.beforeClass();\n+    _gSetupTool.addCluster(CLUSTER_NAME, true);\n+    _gSetupTool.addInstanceToCluster(CLUSTER_NAME, \"TestInstance\");\n+    _gSetupTool.addResourceToCluster(CLUSTER_NAME, \"TestResource\", 10, \"MasterSlave\");\n+  }\n+\n+  @AfterClass\n+  public void afterClass() {\n+    deleteCluster(CLUSTER_NAME);\n+  }\n \n   @Test\n-  public void testMissingTopStateDurationMonitoring() throws Exception {\n+  public void testControllerConnectThenDisconnect() {\n+    ClusterControllerManager controller =\n+        new ClusterControllerManager(ZK_ADDR, CLUSTER_NAME, \"TestController\");\n+    long start = System.currentTimeMillis();\n+    controller.syncStart();\n+    verifyControllerIsLeader(controller);\n+    System.out.println(System.currentTimeMillis() - start + \"ms spent on becoming the leader\");\n+\n+    start = System.currentTimeMillis();\n+    controller.syncStop();\n+    verifyControllerIsNotLeader(controller);\n+    verifyZKDisconnected(controller);\n+\n+    System.out.println(", "originalCommit": "731f6c9af3d3171ca65ec3fc885412bc4526f5de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MTAwMA==", "url": "https://github.com/apache/helix/pull/681#discussion_r372651000", "bodyText": "I do need these output of recording the time duration spent on L -> S and S -> L (to prove the improvements). Modify the console print to LOG so it won't be printed out at least during mvn test", "author": "i3wangyi", "createdAt": "2020-01-29T21:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NjQ3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9b6fb5dd98aacc9de458611fc6b385ad1c1549ea", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\nindex 077578b72..eefaa32bf 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n\n@@ -88,6 +88,30 @@ public class TestControllerLeadershipChange extends ZkTestBase {\n         System.currentTimeMillis() - start + \"ms spent on becoming the standby node from leader\");\n   }\n \n+  @Test\n+  public void testControllerReconnectAfterDisconnect() {\n+    ClusterControllerManager controller =\n+        new ClusterControllerManager(ZK_ADDR, CLUSTER_NAME, \"TestController\");\n+    long start = System.currentTimeMillis();\n+    controller.syncStart();\n+    verifyControllerIsLeader(controller);\n+    System.out.println(System.currentTimeMillis() - start + \"ms spent on becoming the leader\");\n+\n+    start = System.currentTimeMillis();\n+    controller.syncStop();\n+    verifyControllerIsNotLeader(controller);\n+    verifyZKDisconnected(controller);\n+    System.out.println(\n+        System.currentTimeMillis() - start + \"ms spent on becoming the standby node from leader\");\n+\n+    start = System.currentTimeMillis();\n+    controller.syncStart(); // TODO: what happens when the controller re-connects?\n+    verifyControllerIsLeader(controller);\n+\n+    System.out.println(\n+        System.currentTimeMillis() - start + \"ms spent on reconnecting as controller\");\n+  }\n+\n   @Test(description = \"If the cluster has a controller, the second controller cannot take its leadership\")\n   public void testWhenControllerAlreadyExists() {\n     // when the controller0 already takes over the leadership\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NzQyMw==", "url": "https://github.com/apache/helix/pull/681#discussion_r372647423", "bodyText": "nit, I believe the latest style file has changed exception throws to non-wrapping. Please update your local style configuration.", "author": "jiajunwang", "createdAt": "2020-01-29T21:44:45Z", "path": "helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java", "diffHunk": "@@ -117,16 +258,17 @@ public void testMissingTopStateDurationMonitoring() throws Exception {\n     // Resource lost top state, and manager1 lost leadership for 2000ms, because manager1 will\n     // clean monitoring cache after re-gaining leadership, so max value of hand off duration should\n     // not have such a large value\n-    Assert.assertTrue((long) beanServer.getAttribute(resourceMBeanObjectName,\n-        \"PartitionTopStateHandoffDurationGauge.Max\") < 500);\n+    Assert.assertTrue((long) beanServer\n+        .getAttribute(resourceMBeanObjectName, \"PartitionTopStateHandoffDurationGauge.Max\") < 500);\n \n     participant.syncStop();\n     manager1.disconnect();\n     manager2.disconnect();\n     deleteCluster(clusterName);\n   }\n \n-  private void setLeader(HelixManager manager) throws Exception {\n+  private void setLeader(HelixManager manager)", "originalCommit": "731f6c9af3d3171ca65ec3fc885412bc4526f5de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY1MDMxMw==", "url": "https://github.com/apache/helix/pull/681#discussion_r372650313", "bodyText": "good catch. updated", "author": "i3wangyi", "createdAt": "2020-01-29T21:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NzQyMw=="}], "type": "inlineReview", "revised_code": {"commit": "7536846baade72d06c807c4f86f9cb3ef2933d24", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\nindex 077578b72..73eeb55c4 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/controller/TestControllerLeadershipChange.java\n\n@@ -267,9 +268,7 @@ public class TestControllerLeadershipChange extends ZkTestBase {\n     deleteCluster(clusterName);\n   }\n \n-  private void setLeader(HelixManager manager)\n-      throws Exception {\n-    System.out.println(\"Setting controller \" + manager.getInstanceName() + \" as leader\");\n+  private void setLeader(HelixManager manager) throws Exception {\n     HelixDataAccessor accessor = manager.getHelixDataAccessor();\n     final LiveInstance leader = new LiveInstance(manager.getInstanceName());\n     leader.setLiveInstance(ManagementFactory.getRuntimeMXBean().getName());\n"}}, {"oid": "9b6fb5dd98aacc9de458611fc6b385ad1c1549ea", "url": "https://github.com/apache/helix/commit/9b6fb5dd98aacc9de458611fc6b385ad1c1549ea", "message": "Integration test for verifying controller on/off leadership of a cluster", "committedDate": "2020-01-29T21:46:12Z", "type": "commit"}, {"oid": "cfdbf7334a5ce32f60b66d7085c0482cb4e721ff", "url": "https://github.com/apache/helix/commit/cfdbf7334a5ce32f60b66d7085c0482cb4e721ff", "message": "Add a TODO for testing controller timer tasks", "committedDate": "2020-01-29T21:46:12Z", "type": "commit"}, {"oid": "7536846baade72d06c807c4f86f9cb3ef2933d24", "url": "https://github.com/apache/helix/commit/7536846baade72d06c807c4f86f9cb3ef2933d24", "message": "Update the code style and remove the system print", "committedDate": "2020-01-29T21:50:55Z", "type": "commit"}, {"oid": "7536846baade72d06c807c4f86f9cb3ef2933d24", "url": "https://github.com/apache/helix/commit/7536846baade72d06c807c4f86f9cb3ef2933d24", "message": "Update the code style and remove the system print", "committedDate": "2020-01-29T21:50:55Z", "type": "forcePushed"}]}