{"pr_number": 1401, "pr_title": "Mark AutoRebalancer as deprecated and convert the default test logic to not use AutoRebalancer.", "pr_createdAt": "2020-09-23T23:09:46Z", "pr_url": "https://github.com/apache/helix/pull/1401", "timeline": [{"oid": "a8bba281b0f7bcaa213fc390a65d726814ce3ee7", "url": "https://github.com/apache/helix/commit/a8bba281b0f7bcaa213fc390a65d726814ce3ee7", "message": "Mark AutoRebalancer as deprecated and convert the default test logic to not using AutoRebalancer by default.\n\nThe only remaining AutoRebalancer tests should be the ones that are specifically testing the AutoRebalancer class.", "committedDate": "2020-09-23T23:05:45Z", "type": "commit"}, {"oid": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "url": "https://github.com/apache/helix/commit/941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "message": "Minor code refine.", "committedDate": "2020-09-23T23:12:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2MTkxNA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493961914", "bodyText": "Here, RebalanceMode.FULL_AUTO, we will always use crushED, which means delayAutoRebalancer with CrushED\nBefore this change, it is AutoRebalancer with AutoRebalanceStrategy, both takes current state into consideration. They bestPossibleVerifier may still work, but the state mapping can be different from one run to another run", "author": "kaisun2000", "createdAt": "2020-09-23T23:54:46Z", "path": "helix-core/src/test/java/org/apache/helix/TestHelper.java", "diffHunk": "@@ -287,7 +289,10 @@ public static void setupCluster(String clusterName, String zkAddr, int startPort\n \n       for (int i = 0; i < resourceNb; i++) {\n         String resourceName = resourceNamePrefix + i;\n-        setupTool.addResourceToCluster(clusterName, resourceName, partitionNb, stateModelDef, mode.toString());\n+        setupTool.addResourceToCluster(clusterName, resourceName, partitionNb, stateModelDef,\n+            mode.name(),\n+            mode == RebalanceMode.FULL_AUTO ? CrushEdRebalanceStrategy.class.getName()\n+                : RebalanceStrategy.DEFAULT_REBALANCE_STRATEGY);", "originalCommit": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NzcyOA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493967728", "bodyText": "This actually relies on the fact that\n _gSetupTool.addResourceToCluster(CLUSTER_NAME, \"MyDB2\", _PARTITIONS, \"MasterSlave\",\n        RebalanceMode.FULL_AUTO + \"\");\n\nwould add  idea state using DelayedAutoRebalancer + AutoRebalance strategy\nhere, we change the idea state to use autoRebalancer, thus eventually we end up with autoRebalancer + autoRebalance strategy.\nThe thing is that if later people change the gSetupTool.addResourceToCluster() similar to testhelper to have DelayedAutoRebalancer + crushEd, this test won't work.\nShall we add a comment that we depends on  _gSetupTool.addResourceToCluster to use default AutoRebalanceStrategy, or just note here we need autoRebalancer + autoRebalance strategy.", "author": "kaisun2000", "createdAt": "2020-09-24T00:14:40Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java", "diffHunk": "@@ -229,6 +236,16 @@ static boolean verifyBalanceExternalView(ZNRecord externalView, int partitionCou\n     return partitionCount == totalCount;\n   }\n \n+  private void setupAutoRebalancer() {\n+    HelixAdmin admin = _gSetupTool.getClusterManagementTool();", "originalCommit": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MjY0NA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493972644", "bodyText": "This test is for testing AutoRebalancer, so no matter what's the default behavior change, it is the right test logic. If it fails, then the new code change shall be fixed. I think there is no necessity of adding comment. Because this change only makes the logic more explicit.", "author": "jiajunwang", "createdAt": "2020-09-24T00:31:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2NzcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "20b072e3db6abf496a4bb14d0677016ddc7a0a25", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java\nindex 5ca1292fb..0ebcfc6cb 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalance.java\n\n@@ -236,6 +236,7 @@ public class TestAutoRebalance extends ZkStandAloneCMTestBase {\n     return partitionCount == totalCount;\n   }\n \n+  // Ensure that we are testing the AutoRebalancer.\n   private void setupAutoRebalancer() {\n     HelixAdmin admin = _gSetupTool.getClusterManagementTool();\n     for (String resourceName : _gSetupTool.getClusterManagementTool()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2ODcyNg==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493968726", "bodyText": "add a comment, we need autoRebalancer + autoRebalance strategy. here as this is testing autoRebalancer.", "author": "kaisun2000", "createdAt": "2020-09-24T00:17:57Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java", "diffHunk": "@@ -54,7 +56,13 @@ public void beforeClass() throws Exception {\n     _gSetupTool.addCluster(CLUSTER_NAME, true);\n \n     _gSetupTool.addResourceToCluster(CLUSTER_NAME, TEST_DB, 100, \"OnlineOffline\",\n-        RebalanceMode.FULL_AUTO + \"\", 0, 25);\n+        RebalanceMode.FULL_AUTO.name(), 0, 25);\n+\n+    IdealState idealState =\n+        _gSetupTool.getClusterManagementTool().getResourceIdealState(CLUSTER_NAME, TEST_DB);\n+    idealState.setRebalancerClassName(AutoRebalancer.class.getName());", "originalCommit": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzA1NA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493973054", "bodyText": "Sure. Let me note this is to ensure we are testing AutoRebalancer.", "author": "jiajunwang", "createdAt": "2020-09-24T00:33:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2ODcyNg=="}], "type": "inlineReview", "revised_code": {"commit": "20b072e3db6abf496a4bb14d0677016ddc7a0a25", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\nindex c4a6d4734..2266fb682 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\n\n@@ -58,6 +61,7 @@ public class TestAutoRebalancePartitionLimit extends ZkStandAloneCMTestBase {\n     _gSetupTool.addResourceToCluster(CLUSTER_NAME, TEST_DB, 100, \"OnlineOffline\",\n         RebalanceMode.FULL_AUTO.name(), 0, 25);\n \n+    // Ensure that we are testing the AutoRebalancer.\n     IdealState idealState =\n         _gSetupTool.getClusterManagementTool().getResourceIdealState(CLUSTER_NAME, TEST_DB);\n     idealState.setRebalancerClassName(AutoRebalancer.class.getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTMyOA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493969328", "bodyText": "add a log.error please. It is better with stack trace. This would be tremendous helpful if the test fails.", "author": "kaisun2000", "createdAt": "2020-09-24T00:20:03Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java", "diffHunk": "@@ -204,10 +215,14 @@ public boolean verify() {\n           cache.getStateModelDef(cache.getIdealState(_resourceName).getStateModelDefRef())\n               .getStatesPriorityList().get(0);\n       int replicas = Integer.parseInt(cache.getIdealState(_resourceName).getReplicas());\n-      return verifyBalanceExternalView(\n-          accessor.getProperty(keyBuilder.externalView(_resourceName)).getRecord(),\n-          numberOfPartitions, masterValue, replicas, cache.getLiveInstances().size(),\n-          cache.getIdealState(_resourceName).getMaxPartitionsPerInstance());\n+      try {\n+        return verifyBalanceExternalView(\n+            accessor.getProperty(keyBuilder.externalView(_resourceName)).getRecord(),\n+            numberOfPartitions, masterValue, replicas, cache.getLiveInstances().size(),\n+            cache.getIdealState(_resourceName).getMaxPartitionsPerInstance());\n+      } catch (Exception e) {\n+        return false;", "originalCommit": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3NDMyMA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493974320", "bodyText": "Let me add a debug log here.\n\nIt is expected. Since the EV might not be created when the verify starts. So if we output an error message, it only pollutes the log with no good reason.\nIt will be retried in the loop. It would be too verbose if we output on every checks.", "author": "jiajunwang", "createdAt": "2020-09-24T00:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTMyOA=="}], "type": "inlineReview", "revised_code": {"commit": "20b072e3db6abf496a4bb14d0677016ddc7a0a25", "chunk": "diff --git a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\nindex c4a6d4734..2266fb682 100644\n--- a/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\n+++ b/helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalancePartitionLimit.java\n\n@@ -221,6 +225,7 @@ public class TestAutoRebalancePartitionLimit extends ZkStandAloneCMTestBase {\n             numberOfPartitions, masterValue, replicas, cache.getLiveInstances().size(),\n             cache.getIdealState(_resourceName).getMaxPartitionsPerInstance());\n       } catch (Exception e) {\n+        LOG.debug(\"Verify failed due to {}\", e.getStackTrace());\n         return false;\n       }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk2OTU3NA==", "url": "https://github.com/apache/helix/pull/1401#discussion_r493969574", "bodyText": "Again add the comment that we need autoRebalancer + autoRebalance strategy as this is autoRebalance test", "author": "kaisun2000", "createdAt": "2020-09-24T00:20:51Z", "path": "helix-core/src/test/java/org/apache/helix/integration/rebalancer/TestAutoRebalanceWithDisabledInstance.java", "diffHunk": "@@ -43,6 +45,7 @@ public void beforeClass() throws Exception {\n     super.beforeClass();\n     _gSetupTool.addResourceToCluster(CLUSTER_NAME, TEST_DB_2, _PARTITIONS, STATE_MODEL,\n         RebalanceMode.FULL_AUTO.name(), CrushEdRebalanceStrategy.class.getName());\n+    setupAutoRebalancer();", "originalCommit": "941b4ccd1eb0911b49b75d9e532f2a5c42c3ed3e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "20b072e3db6abf496a4bb14d0677016ddc7a0a25", "url": "https://github.com/apache/helix/commit/20b072e3db6abf496a4bb14d0677016ddc7a0a25", "message": "Address comments.", "committedDate": "2020-09-24T00:39:02Z", "type": "commit"}]}