{"pr_number": 1070, "pr_title": "Deprecate Raw ZkClient in helix-core", "pr_createdAt": "2020-06-07T00:34:48Z", "pr_url": "https://github.com/apache/helix/pull/1070", "timeline": [{"oid": "4f880bca2d5156fd772434a96fe8d9f5536fe7cb", "url": "https://github.com/apache/helix/commit/4f880bca2d5156fd772434a96fe8d9f5536fe7cb", "message": "Deprecate Raw ZkClient in helix-core\n\nWe have moved the raw ZkClient to zookeeper-api. As such, we need to deprecate the old one in helix-core. We are leaving the class for backward-compatibility purposes.", "committedDate": "2020-06-07T00:03:00Z", "type": "commit"}, {"oid": "01f114ea8585d04e76452006b83a0f15a7150bf1", "url": "https://github.com/apache/helix/commit/01f114ea8585d04e76452006b83a0f15a7150bf1", "message": "asdf", "committedDate": "2020-06-07T00:36:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxODU0NA==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436318544", "bodyText": "Do we still need these constructors in old file? Or we can just leave the class purely extend what we have in zookeeper-api module?", "author": "junkaixue", "createdAt": "2020-06-07T02:38:31Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZkClient.java", "diffHunk": "@@ -55,33 +49,26 @@\n  * TODO Completely replace usage of the raw ZkClient within helix-core. Instead, using HelixZkClient. --JJ\n  */\n \n-public class ZkClient extends org.apache.helix.manager.zk.zookeeper.ZkClient implements HelixZkClient {\n-  private static Logger LOG = LoggerFactory.getLogger(ZkClient.class);\n-\n-  public static final int DEFAULT_OPERATION_TIMEOUT = Integer.MAX_VALUE;\n-  public static final int DEFAULT_CONNECTION_TIMEOUT = 60 * 1000;\n-  public static final int DEFAULT_SESSION_TIMEOUT = 30 * 1000;\n-\n+@Deprecated\n+public class ZkClient extends org.apache.helix.zookeeper.impl.client.ZkClient {\n   /**\n-   *\n-   * @param zkConnection\n+   *  @param zkConnection\n    *            The Zookeeper connection\n    * @param connectionTimeout\n    *            The connection timeout in milli seconds\n-   * @param zkSerializer\n-   *            The Zookeeper data serializer\n    * @param operationRetryTimeout\n    *            Most operations are retried in cases like connection loss with the Zookeeper servers. During such failures, this\n    *            <code>operationRetryTimeout</code> decides the maximum amount of time, in milli seconds, each\n    *            operation is retried. A value lesser than 0 is considered as\n    *            \"retry forever until a connection has been reestablished\".\n+   * @param zkSerializer\n+   *            The Zookeeper data serializer\n    * @param monitorType\n    * @param monitorKey\n    * @param monitorInstanceName\n-   *            These 3 inputs are used to name JMX monitor bean name for this ZkClient.\n+   *            These 3 inputs are used to name JMX monitor bean name for this RealmAwareZkClient.\n    *            The JMX bean name will be: HelixZkClient.monitorType.monitorKey.monitorInstanceName.\n    * @param monitorRootPathOnly\n-   *            Should only stat of access to root path be reported to JMX bean or path-specific stat be reported too.\n    */\n   public ZkClient(IZkConnection zkConnection, int connectionTimeout, long operationRetryTimeout,", "originalCommit": "01f114ea8585d04e76452006b83a0f15a7150bf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxODgyNQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436318825", "bodyText": "Don't you think we should keep all public constructors for backward-compatibility?", "author": "narendly", "createdAt": "2020-06-07T02:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxODU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk0NTQzNQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436945435", "bodyText": "Oh. The move also involve some constructor change? Then I am OK for that.", "author": "junkaixue", "createdAt": "2020-06-08T19:20:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMxODU0NA=="}], "type": "inlineReview", "revised_code": {"commit": "a2203871d9bb6fa18b4e9196c18cf72bff3c8959", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/manager/zk/ZkClient.java b/helix-core/src/main/java/org/apache/helix/manager/zk/ZkClient.java\ndeleted file mode 100644\nindex 08ea0cdaf..000000000\n--- a/helix-core/src/main/java/org/apache/helix/manager/zk/ZkClient.java\n+++ /dev/null\n\n@@ -1,149 +0,0 @@\n-package org.apache.helix.manager.zk;\n-\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-import org.apache.helix.zookeeper.zkclient.IZkConnection;\n-import org.apache.helix.zookeeper.zkclient.serialize.PathBasedZkSerializer;\n-import org.apache.helix.zookeeper.zkclient.serialize.ZkSerializer;\n-\n-\n-/**\n- * This class has been deprecated! It has been moved to zookeeper-api module.\n- * Raw ZkClient that extends {@link org.apache.helix.zookeeper.impl.client.ZkClient} for backward-compatibility.\n- *\n- * Note that, instead of directly constructing a raw ZkClient, applications should always use\n- * HelixZkClientFactory to build shared or dedicated HelixZkClient instances.\n- * Only constructing a raw ZkClient when advanced usage is required.\n- * For example, application need to access/manage ZkConnection directly.\n- *\n- * Both SharedZKClient and DedicatedZkClient are built based on the raw ZkClient. As shown below.\n- *                ----------------------------\n- *               |                            |\n- *     ---------------------                  |\n- *    |                     |                 | *implements\n- *  SharedZkClient  DedicatedZkClient           ----> HelixZkClient Interface\n- *    |                     |                 |\n- *     ---------------------                  |\n- *               |                            |\n- *           Raw ZkClient (this class)--------\n- *               |\n- *         Native ZkClient\n- *\n- * TODO Completely replace usage of the raw ZkClient within helix-core. Instead, using HelixZkClient. --JJ\n- */\n-\n-@Deprecated\n-public class ZkClient extends org.apache.helix.zookeeper.impl.client.ZkClient {\n-  /**\n-   *  @param zkConnection\n-   *            The Zookeeper connection\n-   * @param connectionTimeout\n-   *            The connection timeout in milli seconds\n-   * @param operationRetryTimeout\n-   *            Most operations are retried in cases like connection loss with the Zookeeper servers. During such failures, this\n-   *            <code>operationRetryTimeout</code> decides the maximum amount of time, in milli seconds, each\n-   *            operation is retried. A value lesser than 0 is considered as\n-   *            \"retry forever until a connection has been reestablished\".\n-   * @param zkSerializer\n-   *            The Zookeeper data serializer\n-   * @param monitorType\n-   * @param monitorKey\n-   * @param monitorInstanceName\n-   *            These 3 inputs are used to name JMX monitor bean name for this RealmAwareZkClient.\n-   *            The JMX bean name will be: HelixZkClient.monitorType.monitorKey.monitorInstanceName.\n-   * @param monitorRootPathOnly\n-   */\n-  public ZkClient(IZkConnection zkConnection, int connectionTimeout, long operationRetryTimeout,\n-      PathBasedZkSerializer zkSerializer, String monitorType, String monitorKey,\n-      String monitorInstanceName, boolean monitorRootPathOnly) {\n-    super(zkConnection, connectionTimeout, operationRetryTimeout, zkSerializer, monitorType,\n-        monitorKey, monitorInstanceName, monitorRootPathOnly);\n-  }\n-\n-  public ZkClient(IZkConnection connection, int connectionTimeout,\n-      PathBasedZkSerializer zkSerializer, String monitorType, String monitorKey,\n-      long operationRetryTimeout) {\n-    super(connection, connectionTimeout, zkSerializer, monitorType, monitorKey,\n-        operationRetryTimeout);\n-  }\n-\n-  public ZkClient(IZkConnection connection, int connectionTimeout,\n-      PathBasedZkSerializer zkSerializer, String monitorType, String monitorKey) {\n-    super(connection, connectionTimeout, zkSerializer, monitorType, monitorKey);\n-  }\n-\n-  public ZkClient(String zkServers, String monitorType, String monitorKey) {\n-    super(zkServers, monitorType, monitorKey);\n-  }\n-\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout,\n-      PathBasedZkSerializer zkSerializer, String monitorType, String monitorKey) {\n-    super(zkServers, sessionTimeout, connectionTimeout, zkSerializer, monitorType, monitorKey);\n-  }\n-\n-  public ZkClient(IZkConnection connection, int connectionTimeout,\n-      PathBasedZkSerializer zkSerializer) {\n-    super(connection, connectionTimeout, zkSerializer);\n-  }\n-\n-  public ZkClient(IZkConnection connection, int connectionTimeout, ZkSerializer zkSerializer) {\n-    super(connection, connectionTimeout, zkSerializer);\n-  }\n-\n-  public ZkClient(IZkConnection connection, int connectionTimeout) {\n-    super(connection, connectionTimeout);\n-  }\n-\n-  public ZkClient(IZkConnection connection) {\n-    super(connection);\n-  }\n-\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout,\n-      ZkSerializer zkSerializer) {\n-    super(zkServers, sessionTimeout, connectionTimeout, zkSerializer);\n-  }\n-\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout,\n-      PathBasedZkSerializer zkSerializer) {\n-    super(zkServers, sessionTimeout, connectionTimeout, zkSerializer);\n-  }\n-\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout) {\n-    super(zkServers, sessionTimeout, connectionTimeout);\n-  }\n-\n-  public ZkClient(String zkServers, int connectionTimeout) {\n-    super(zkServers, connectionTimeout);\n-  }\n-\n-  public ZkClient(String zkServers) {\n-    super(zkServers);\n-  }\n-\n-  public ZkClient(String zkServers, int sessionTimeout, int connectionTimeout,\n-      ZkSerializer zkSerializer, long operationRetryTimeout) {\n-    super(zkServers, sessionTimeout, connectionTimeout, zkSerializer, operationRetryTimeout);\n-  }\n-\n-  public ZkClient(IZkConnection zkConnection, int connectionTimeout, ZkSerializer zkSerializer,\n-      long operationRetryTimeout) {\n-    super(zkConnection, connectionTimeout, zkSerializer, operationRetryTimeout);\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNDcwMQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436324701", "bodyText": "I think in the test we can just call Long.toHexString(sessionId).\nOtherwise, my concern is that this public API will be with the ZkClient forever... And it seems to an overkill to have such a public method in the ZkClient class.", "author": "jiajunwang", "createdAt": "2020-06-07T04:54:03Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java", "diffHunk": "@@ -2223,7 +2223,7 @@ private void validateCurrentThread() {\n    *\n    * @return String representation of session id in hexadecimal notation.\n    */\n-  private static String toHexSessionId(long sessionId) {\n+  public static String toHexSessionId(long sessionId) {", "originalCommit": "01f114ea8585d04e76452006b83a0f15a7150bf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNTk5NQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436325995", "bodyText": "I agree with this idea. I think it's a valid point to avoid introducing another public method for ZkClient.", "author": "narendly", "createdAt": "2020-06-07T05:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNDcwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a2203871d9bb6fa18b4e9196c18cf72bff3c8959", "chunk": "diff --git a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java\nindex 06758c240..bc067c340 100644\n--- a/zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java\n+++ b/zookeeper-api/src/main/java/org/apache/helix/zookeeper/zkclient/ZkClient.java\n\n@@ -2216,14 +2216,4 @@ public class ZkClient implements Watcher {\n       throw new IllegalArgumentException(\"Must not be done in the zookeeper event thread.\");\n     }\n   }\n-\n-  /**\n-   * Converts a session id in hexadecimal notation from a long type session id.\n-   * Ex. 1000a5ceb930004 is returned.\n-   *\n-   * @return String representation of session id in hexadecimal notation.\n-   */\n-  public static String toHexSessionId(long sessionId) {\n-    return Long.toHexString(sessionId);\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNDkyOQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436324929", "bodyText": "Can we merge 2 helpers? Maybe not a good idea.\nBut when we have both TestHelper and ZkTestHelper in the Zookeeper module, they are kind of confusing. Maybe a pair of better names would help.", "author": "jiajunwang", "createdAt": "2020-06-07T04:58:37Z", "path": "zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestHelper.java", "diffHunk": "@@ -0,0 +1,447 @@\n+package org.apache.helix.zookeeper.impl;\n+\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+import java.io.BufferedReader;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.net.Socket;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+import java.util.concurrent.BlockingQueue;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.helix.zookeeper.api.client.HelixZkClient;\n+import org.apache.helix.zookeeper.api.client.RealmAwareZkClient;\n+import org.apache.helix.zookeeper.zkclient.IZkChildListener;\n+import org.apache.helix.zookeeper.zkclient.IZkDataListener;\n+import org.apache.helix.zookeeper.zkclient.IZkStateListener;\n+import org.apache.helix.zookeeper.zkclient.ZkClient;\n+import org.apache.helix.zookeeper.zkclient.ZkConnection;\n+import org.apache.zookeeper.WatchedEvent;\n+import org.apache.zookeeper.Watcher;\n+import org.apache.zookeeper.Watcher.Event.EventType;\n+import org.apache.zookeeper.Watcher.Event.KeeperState;\n+import org.apache.zookeeper.ZooKeeper;\n+import org.apache.zookeeper.ZooKeeper.States;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testng.Assert;\n+\n+\n+public class ZkTestHelper {", "originalCommit": "01f114ea8585d04e76452006b83a0f15a7150bf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNjEyNw==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436326127", "bodyText": "On this point, I thought about it, but I decided to keep them separate because 1) It is less confusing - TestHelper solely provides methods around testing and TestNG, and ZkTestHelper provides methods related to ZK operations. 2) From the dev perspective, we get less confused (why are there 2 helpers in helix-core vs 1 helper in zookeeper-api?) and 3) it helps us keep the classes small.", "author": "narendly", "createdAt": "2020-06-07T05:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNDkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjkxMzA4NQ==", "url": "https://github.com/apache/helix/pull/1070#discussion_r436913085", "bodyText": "Sure, I didn't find any better name either...", "author": "jiajunwang", "createdAt": "2020-06-08T18:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjMyNDkyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a2203871d9bb6fa18b4e9196c18cf72bff3c8959", "chunk": "diff --git a/zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestHelper.java b/zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestHelper.java\nindex fdb626d50..32e2b8acc 100644\n--- a/zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestHelper.java\n+++ b/zookeeper-api/src/test/java/org/apache/helix/zookeeper/impl/ZkTestHelper.java\n\n@@ -87,7 +87,6 @@ public class ZkTestHelper {\n    * @param client\n    * @throws Exception\n    */\n-\n   public static void disconnectSession(HelixZkClient client)\n       throws Exception {\n     final ZkClient zkClient = (ZkClient) client;\n"}}, {"oid": "a2203871d9bb6fa18b4e9196c18cf72bff3c8959", "url": "https://github.com/apache/helix/commit/a2203871d9bb6fa18b4e9196c18cf72bff3c8959", "message": "remove oldzkclient", "committedDate": "2020-06-09T17:13:53Z", "type": "commit"}, {"oid": "75184bd2ac8ad7aa8106807f47c8cf4997d45bd9", "url": "https://github.com/apache/helix/commit/75184bd2ac8ad7aa8106807f47c8cf4997d45bd9", "message": "add it back", "committedDate": "2020-06-09T17:16:54Z", "type": "commit"}]}