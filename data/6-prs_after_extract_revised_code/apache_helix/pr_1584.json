{"pr_number": 1584, "pr_title": "Participant-side Task Current State Migration", "pr_createdAt": "2020-12-09T19:19:35Z", "pr_url": "https://github.com/apache/helix/pull/1584", "timeline": [{"oid": "09fc0c6252221c6f64cad9ca58f0b1a056ef04c7", "url": "https://github.com/apache/helix/commit/09fc0c6252221c6f64cad9ca58f0b1a056ef04c7", "message": "HelixStateTransitionhandler change", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "e17fc876b540ac86dd15101d30f00a01e36fcdd6", "url": "https://github.com/apache/helix/commit/e17fc876b540ac86dd15101d30f00a01e36fcdd6", "message": "Add system property", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "6ab3bbb7f080c87a352d7426d22540ea18beeaf1", "url": "https://github.com/apache/helix/commit/6ab3bbb7f080c87a352d7426d22540ea18beeaf1", "message": "Add remaining changes", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "fccdd22b5e2044998f9da5d575a35bd464a09dc4", "url": "https://github.com/apache/helix/commit/fccdd22b5e2044998f9da5d575a35bd464a09dc4", "message": "Add integration test and fix broekn parts", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "066837c6215ac33118cfc2200d8c43872d38b590", "url": "https://github.com/apache/helix/commit/066837c6215ac33118cfc2200d8c43872d38b590", "message": "add additional test", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "aa247562fda51a6358cf819fd0b6d047da15f26f", "url": "https://github.com/apache/helix/commit/aa247562fda51a6358cf819fd0b6d047da15f26f", "message": "Fix tests", "committedDate": "2020-12-09T19:10:28Z", "type": "commit"}, {"oid": "095a906795ffe26ef0aeb468742861797091e14f", "url": "https://github.com/apache/helix/commit/095a906795ffe26ef0aeb468742861797091e14f", "message": "add test, change flag name", "committedDate": "2020-12-09T22:56:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1OTMyOQ==", "url": "https://github.com/apache/helix/pull/1584#discussion_r540559329", "bodyText": "Let's have a variable to track TASK_CURRENT_STATE_PATH_DISABLED. We dont have to do the parse every time. Also, let's give a default value as true since participant will be the last component to deploy.", "author": "junkaixue", "createdAt": "2020-12-10T22:56:50Z", "path": "helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java", "diffHunk": "@@ -264,8 +271,12 @@ void postHandleMessage() {\n \n     try {\n       // Update the ZK current state of the node\n-      PropertyKey key = keyBuilder.currentState(instanceName, sessionId, resource,\n-          bucketizer.getBucketName(partitionKey));\n+      PropertyKey key =\n+          _isTaskMessage && !Boolean.getBoolean(SystemPropertyKeys.TASK_CURRENT_STATE_PATH_DISABLED)", "originalCommit": "095a906795ffe26ef0aeb468742861797091e14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5NDg2Mg==", "url": "https://github.com/apache/helix/pull/1584#discussion_r540594862", "bodyText": "Default value should be false because it's \"disabled\" right? If participants get the new version of Helix, we should assume that they want to use the new path, so \"disabled\" should default to false.\nFor variable tracking, there is a problem: if the boolean value is recorded at a central place, users cannot update this system property during run time, right?  If there is a variable that's tracking it, then it's as if it's cached.", "author": "NealSun96", "createdAt": "2020-12-11T00:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1OTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI2MjQ3MQ==", "url": "https://github.com/apache/helix/pull/1584#discussion_r541262471", "bodyText": "Ah... Yeah, the \"disable\" should be false.\nBut for dynamic update, let's not overkill the design:\n\nFor Helix, we use ZK centralized config for dynamic update purpose. If we decide to use system property, it means it is not dynamic changeable.\nThe system property mostly comes from Java property, which require restart the application. So we cannot support dynamic update as well.\n\nMake it a variable can also simplify the code. I would suggest create a variable to hold that when we create the object.", "author": "junkaixue", "createdAt": "2020-12-11T20:36:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1OTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU3OTIwOA==", "url": "https://github.com/apache/helix/pull/1584#discussion_r542579208", "bodyText": "Discussion ongoing.", "author": "NealSun96", "createdAt": "2020-12-14T17:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1OTMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMTg0OA==", "url": "https://github.com/apache/helix/pull/1584#discussion_r542831848", "bodyText": "Concluded to use one local variable when necessary.", "author": "NealSun96", "createdAt": "2020-12-14T21:48:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1OTMyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "0f5c0ce928b7b2ed01de6a86cb2d0a727566300d", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java b/helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java\nindex 889346a30..d32e90eec 100644\n--- a/helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java\n+++ b/helix-core/src/main/java/org/apache/helix/messaging/handling/HelixStateTransitionHandler.java\n\n@@ -271,12 +273,10 @@ public class HelixStateTransitionHandler extends MessageHandler {\n \n     try {\n       // Update the ZK current state of the node\n-      PropertyKey key =\n-          _isTaskMessage && !Boolean.getBoolean(SystemPropertyKeys.TASK_CURRENT_STATE_PATH_DISABLED)\n-              ? accessor.keyBuilder().taskCurrentState(instanceName, sessionId, resource,\n+      PropertyKey key = _isTaskMessage && !_isTaskCurrentStatePathDisabled ? accessor.keyBuilder()\n+          .taskCurrentState(instanceName, sessionId, resource,\n               bucketizer.getBucketName(partitionKey)) : accessor.keyBuilder()\n-              .currentState(instanceName, sessionId, resource,\n-                  bucketizer.getBucketName(partitionKey));\n+          .currentState(instanceName, sessionId, resource, bucketizer.getBucketName(partitionKey));\n       if (_message.getAttribute(Attributes.PARENT_MSG_ID) == null) {\n         // normal message\n         if (!accessor.updateProperty(key, _currentStateDelta)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU2MDU3Mw==", "url": "https://github.com/apache/helix/pull/1584#discussion_r540560573", "bodyText": "Let's have the path build when TaskRunner instantiated.", "author": "junkaixue", "createdAt": "2020-12-10T22:58:21Z", "path": "helix-core/src/main/java/org/apache/helix/task/TaskRunner.java", "diffHunk": "@@ -208,7 +209,10 @@ private static boolean setRequestedState(HelixDataAccessor accessor, String inst\n         String.format(\"Requesting a state transition to %s for partition %s.\", state, partition));\n     try {\n       PropertyKey.Builder keyBuilder = accessor.keyBuilder();\n-      PropertyKey key = keyBuilder.currentState(instance, sessionId, resource);\n+      PropertyKey key =\n+          Boolean.getBoolean(SystemPropertyKeys.TASK_CURRENT_STATE_PATH_DISABLED) ? keyBuilder", "originalCommit": "095a906795ffe26ef0aeb468742861797091e14f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMTUxMg==", "url": "https://github.com/apache/helix/pull/1584#discussion_r541121512", "bodyText": "For this I believe there's a similar problem: if users change this flag on the fly, the path has to be recreated. If we create the path when TaskRunner is instantiated, there's no way to recreate the path.", "author": "NealSun96", "createdAt": "2020-12-11T17:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU2MDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI2MjgxNw==", "url": "https://github.com/apache/helix/pull/1584#discussion_r541262817", "bodyText": "Same reason as the previous, dynamic update is overkill.", "author": "junkaixue", "createdAt": "2020-12-11T20:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU2MDU3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMTk1NQ==", "url": "https://github.com/apache/helix/pull/1584#discussion_r542831955", "bodyText": "Concluded to use one local variable when necessary.", "author": "NealSun96", "createdAt": "2020-12-14T21:48:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU2MDU3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0f5c0ce928b7b2ed01de6a86cb2d0a727566300d", "url": "https://github.com/apache/helix/commit/0f5c0ce928b7b2ed01de6a86cb2d0a727566300d", "message": "one variable", "committedDate": "2020-12-14T21:47:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxOTkwNQ==", "url": "https://github.com/apache/helix/pull/1584#discussion_r542919905", "bodyText": "With this config set up as \"disabled\", the default behavior would be to turn on task current state. Is this the expected behavior when customers roll out?", "author": "zhangmeng916", "createdAt": "2020-12-14T23:24:44Z", "path": "helix-common/src/main/java/org/apache/helix/SystemPropertyKeys.java", "diffHunk": "@@ -84,4 +84,7 @@\n       MetadataStoreRoutingConstants.MSDS_SERVER_ENDPOINT_KEY;\n \n   public static final String STATEUPDATEUTIL_ERROR_PERSISTENCY_ENABLED = \"helix.StateUpdateUtil.errorLog.enabled\";\n+\n+  public static final String TASK_CURRENT_STATE_PATH_DISABLED =", "originalCommit": "0f5c0ce928b7b2ed01de6a86cb2d0a727566300d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkzMTg5NQ==", "url": "https://github.com/apache/helix/pull/1584#discussion_r542931895", "bodyText": "Yes. When customers roll out a new versions for participants, they should expect the behavior to change accordingly. This system property is for an emergency controller rollback, during which users can disable this new behavior on participants.", "author": "NealSun96", "createdAt": "2020-12-14T23:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkxOTkwNQ=="}], "type": "inlineReview", "revised_code": null}]}