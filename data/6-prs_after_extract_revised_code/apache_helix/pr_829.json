{"pr_number": 829, "pr_title": "Fix bugs in ZkRoutingDataReader and ZkRoutingDataWriter", "pr_createdAt": "2020-02-27T20:30:43Z", "pr_url": "https://github.com/apache/helix/pull/829", "timeline": [{"oid": "383ec9292a096cda1cba3278deed26cef4980533", "url": "https://github.com/apache/helix/commit/383ec9292a096cda1cba3278deed26cef4980533", "message": "Fix bugs in ZkRoutingDataReader and ZkRoutingDataWriter", "committedDate": "2020-02-27T20:26:48Z", "type": "commit"}, {"oid": "7650dcadf314ea517989259fecb19be7b6739b8c", "url": "https://github.com/apache/helix/commit/7650dcadf314ea517989259fecb19be7b6739b8c", "message": "Add child change subscription for handleChildChange", "committedDate": "2020-02-27T22:17:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwNTEzMA==", "url": "https://github.com/apache/helix/pull/829#discussion_r385405130", "bodyText": "After making the fix, handleChildChange and handleDataDeleted are completely equal now. I added a comment on line 127 based on what you told me to justify the duplication - sometimes the callbacks may go missing. Should we consider calling handleDataDeleted from handleChildChange, for example, to reduce duplication? @narendly", "author": "NealSun96", "createdAt": "2020-02-27T22:20:34Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -134,6 +147,7 @@ public synchronized void handleChildChange(String s, List<String> list) {\n \n     // Subscribe data changes again because some children might have been deleted or added\n     _zkClient.unsubscribeAll();\n+    _zkClient.subscribeChildChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH, this);", "originalCommit": "7650dcadf314ea517989259fecb19be7b6739b8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDEzNg==", "url": "https://github.com/apache/helix/pull/829#discussion_r385440136", "bodyText": "Resolved offline.", "author": "NealSun96", "createdAt": "2020-02-28T00:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwNTEzMA=="}], "type": "inlineReview", "revised_code": {"commit": "38278be73231ca5ec1f71d61957a41a5386720fb", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\nindex 1f69a26d3..602de3ae3 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n\n@@ -141,18 +142,7 @@ public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader, IZkD\n \n   @Override\n   public synchronized void handleChildChange(String s, List<String> list) {\n-    if (_zkClient.isClosed()) {\n-      return;\n-    }\n-\n-    // Subscribe data changes again because some children might have been deleted or added\n-    _zkClient.unsubscribeAll();\n-    _zkClient.subscribeChildChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH, this);\n-    for (String child : _zkClient.getChildren(MetadataStoreRoutingConstants.ROUTING_DATA_PATH)) {\n-      _zkClient.subscribeDataChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + child,\n-          this);\n-    }\n-    _routingDataListener.refreshRoutingData(_namespace);\n+    handleDataDeleted(s);\n   }\n \n   @Override\n"}}, {"oid": "38278be73231ca5ec1f71d61957a41a5386720fb", "url": "https://github.com/apache/helix/commit/38278be73231ca5ec1f71d61957a41a5386720fb", "message": "change all endpoint's status code behavior and added test coverage", "committedDate": "2020-02-28T00:01:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDUyOQ==", "url": "https://github.com/apache/helix/pull/829#discussion_r385440529", "bodyText": "Nit: How about something like HTTP_PREFIX?", "author": "narendly", "createdAt": "2020-02-28T00:03:41Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java", "diffHunk": "@@ -26,4 +26,6 @@\n     PUT,\n     DELETE\n   }\n+\n+  public static final String HTTP_PROTOCOL = \"http://\";", "originalCommit": "38278be73231ca5ec1f71d61957a41a5386720fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MzY5NA==", "url": "https://github.com/apache/helix/pull/829#discussion_r385443694", "bodyText": "Good point, I'll opt for HTTP_PROTOCAL_PREFIX. It is a protocol and it is also a prefix.", "author": "NealSun96", "createdAt": "2020-02-28T00:14:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MDUyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "8cc4d9452019577604928dfc8c8d374b1c49dbbd", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java b/helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java\nindex 745df6c79..d5f3bd9a1 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/common/HttpConstants.java\n\n@@ -27,5 +27,5 @@ public class HttpConstants {\n     DELETE\n   }\n \n-  public static final String HTTP_PROTOCOL = \"http://\";\n+  public static final String HTTP_PROTOCOL_PREFIX = \"http://\";\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTM4OQ==", "url": "https://github.com/apache/helix/pull/829#discussion_r385441389", "bodyText": "Null check on allRealmAddress just in case?", "author": "narendly", "createdAt": "2020-02-28T00:06:33Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -90,10 +99,12 @@ public ZkRoutingDataReader(String namespace, String zkAddress,\n     for (String realmAddress : allRealmAddresses) {", "originalCommit": "38278be73231ca5ec1f71d61957a41a5386720fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NDI5OA==", "url": "https://github.com/apache/helix/pull/829#discussion_r385444298", "bodyText": "I'll add it, but is that case actually possible?", "author": "NealSun96", "createdAt": "2020-02-28T00:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTM4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "8cc4d9452019577604928dfc8c8d374b1c49dbbd", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\nindex 602de3ae3..ab6536725 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n\n@@ -96,14 +96,17 @@ public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader, IZkD\n           \"Routing data directory ZNode \" + MetadataStoreRoutingConstants.ROUTING_DATA_PATH\n               + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n     }\n-    for (String realmAddress : allRealmAddresses) {\n-      ZNRecord record =\n-          _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n-      if (record != null) {\n-        List<String> shardingKeys =\n-            record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n-        routingData\n-            .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+    if (allRealmAddresses != null)\n+    {\n+      for (String realmAddress : allRealmAddresses) {\n+        ZNRecord record =\n+            _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n+        if (record != null) {\n+          List<String> shardingKeys =\n+              record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n+          routingData\n+              .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+        }\n       }\n     }\n     return routingData;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTc4OA==", "url": "https://github.com/apache/helix/pull/829#discussion_r385441788", "bodyText": "Please refactor the logic out into a private method and call it handleResubscription() and call it in both of these methods.", "author": "narendly", "createdAt": "2020-02-28T00:07:48Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -128,17 +142,7 @@ public synchronized void handleDataDeleted(String s) {\n \n   @Override\n   public synchronized void handleChildChange(String s, List<String> list) {\n-    if (_zkClient.isClosed()) {\n-      return;\n-    }\n-\n-    // Subscribe data changes again because some children might have been deleted or added\n-    _zkClient.unsubscribeAll();\n-    for (String child : _zkClient.getChildren(MetadataStoreRoutingConstants.ROUTING_DATA_PATH)) {\n-      _zkClient.subscribeDataChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + child,\n-          this);\n-    }\n-    _routingDataListener.refreshRoutingData(_namespace);\n+    handleDataDeleted(s);", "originalCommit": "38278be73231ca5ec1f71d61957a41a5386720fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0NDQxMQ==", "url": "https://github.com/apache/helix/pull/829#discussion_r385444411", "bodyText": "Ack.", "author": "NealSun96", "createdAt": "2020-02-28T00:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0MTc4OA=="}], "type": "inlineReview", "revised_code": {"commit": "8cc4d9452019577604928dfc8c8d374b1c49dbbd", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\nindex 602de3ae3..ab6536725 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n\n@@ -126,23 +129,12 @@ public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader, IZkD\n   public synchronized void handleDataDeleted(String s) {\n     // When a child node is deleted, this and handleChildChange will both be triggered, but the\n     // behavior is safe\n-    if (_zkClient.isClosed()) {\n-      return;\n-    }\n-\n-    // Renew subscription\n-    _zkClient.unsubscribeAll();\n-    _zkClient.subscribeChildChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH, this);\n-    for (String child : _zkClient.getChildren(MetadataStoreRoutingConstants.ROUTING_DATA_PATH)) {\n-      _zkClient.subscribeDataChanges(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + child,\n-          this);\n-    }\n-    _routingDataListener.refreshRoutingData(_namespace);\n+    handleResubscription();\n   }\n \n   @Override\n   public synchronized void handleChildChange(String s, List<String> list) {\n-    handleDataDeleted(s);\n+    handleResubscription();\n   }\n \n   @Override\n"}}, {"oid": "8cc4d9452019577604928dfc8c8d374b1c49dbbd", "url": "https://github.com/apache/helix/commit/8cc4d9452019577604928dfc8c8d374b1c49dbbd", "message": "address comments", "committedDate": "2020-02-28T00:19:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ0OTQ4NA==", "url": "https://github.com/apache/helix/pull/829#discussion_r385449484", "bodyText": "format", "author": "narendly", "createdAt": "2020-02-28T00:35:05Z", "path": "helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java", "diffHunk": "@@ -87,13 +96,18 @@ public ZkRoutingDataReader(String namespace, String zkAddress,\n           \"Routing data directory ZNode \" + MetadataStoreRoutingConstants.ROUTING_DATA_PATH\n               + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n     }\n-    for (String realmAddress : allRealmAddresses) {\n-      ZNRecord record =\n-          _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n-      List<String> shardingKeys =\n-          record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n-      routingData\n-          .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+    if (allRealmAddresses != null)\n+    {\n+      for (String realmAddress : allRealmAddresses) {\n+        ZNRecord record =\n+            _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n+        if (record != null) {\n+          List<String> shardingKeys =\n+              record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n+          routingData\n+              .put(realmAddress, shardingKeys != null ? shardingKeys : Collections.emptyList());\n+        }\n+      }", "originalCommit": "8cc4d9452019577604928dfc8c8d374b1c49dbbd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a14a8fde783a72ccd7737f95d54145e0f2baca8b", "chunk": "diff --git a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\nindex ab6536725..925157148 100644\n--- a/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n+++ b/helix-rest/src/main/java/org/apache/helix/rest/metadatastore/accessor/ZkRoutingDataReader.java\n\n@@ -96,11 +96,10 @@ public class ZkRoutingDataReader implements MetadataStoreRoutingDataReader, IZkD\n           \"Routing data directory ZNode \" + MetadataStoreRoutingConstants.ROUTING_DATA_PATH\n               + \" does not exist. Routing ZooKeeper address: \" + _zkAddress);\n     }\n-    if (allRealmAddresses != null)\n-    {\n+    if (allRealmAddresses != null) {\n       for (String realmAddress : allRealmAddresses) {\n-        ZNRecord record =\n-            _zkClient.readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n+        ZNRecord record = _zkClient\n+            .readData(MetadataStoreRoutingConstants.ROUTING_DATA_PATH + \"/\" + realmAddress);\n         if (record != null) {\n           List<String> shardingKeys =\n               record.getListField(MetadataStoreRoutingConstants.ZNRECORD_LIST_FIELD_KEY);\n"}}, {"oid": "a14a8fde783a72ccd7737f95d54145e0f2baca8b", "url": "https://github.com/apache/helix/commit/a14a8fde783a72ccd7737f95d54145e0f2baca8b", "message": "fix formatting:", "committedDate": "2020-02-28T00:38:30Z", "type": "commit"}]}