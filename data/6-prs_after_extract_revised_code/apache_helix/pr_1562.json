{"pr_number": 1562, "pr_title": "Fix ZkClient leakage by correctly setting usesExternalZkClient flag", "pr_createdAt": "2020-11-30T08:01:58Z", "pr_url": "https://github.com/apache/helix/pull/1562", "timeline": [{"oid": "7f40e708dddc07e4bb349ac8201b2819b9334a61", "url": "https://github.com/apache/helix/commit/7f40e708dddc07e4bb349ac8201b2819b9334a61", "message": "Fix ZkClient leakage by correctly setting usesExternalZkClient flag\n\nZkBaseDataAccessor and Helix API that uses it using its Builder were having zkClient thread leak issues because the usesExternalZkClient flag was not being set properly. Also, the family of Verifiers were having a similar issue. This change solves this by making sure the private/protected constructors used by the Builders of these classes set the flag correctly to false so that in their respective close() functions, the underlying zkClient (created by the Builder) would get closed.", "committedDate": "2020-11-30T07:56:17Z", "type": "commit"}, {"oid": "6f657ad6aebe1a94ac67160d55037443834323c1", "url": "https://github.com/apache/helix/commit/6f657ad6aebe1a94ac67160d55037443834323c1", "message": "Add comment", "committedDate": "2020-11-30T08:05:10Z", "type": "commit"}, {"oid": "213eeeed003a7ab8fc5c2ebc56709cd516f8a16c", "url": "https://github.com/apache/helix/commit/213eeeed003a7ab8fc5c2ebc56709cd516f8a16c", "message": "Undo change for CacheBaseDataAccessor", "committedDate": "2020-11-30T08:11:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3OTI5NQ==", "url": "https://github.com/apache/helix/pull/1562#discussion_r532779295", "bodyText": "minor: should we throw out IllegalArgumentException instead?", "author": "lei-xia", "createdAt": "2020-11-30T17:40:25Z", "path": "helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java", "diffHunk": "@@ -134,14 +134,13 @@ public AccessResult() {\n    */\n   @Deprecated\n   public ZkBaseDataAccessor(RealmAwareZkClient zkClient) {\n-    if (zkClient == null) {\n-      throw new NullPointerException(\"zkclient is null\");\n-    }\n-    _zkClient = zkClient;\n-    _usesExternalZkClient = true;\n+    this(zkClient, true);\n   }\n \n   private ZkBaseDataAccessor(RealmAwareZkClient zkClient, boolean usesExternalZkClient) {\n+    if (zkClient == null) {\n+      throw new NullPointerException(\"zkclient is null\");", "originalCommit": "213eeeed003a7ab8fc5c2ebc56709cd516f8a16c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc5NTE3MA==", "url": "https://github.com/apache/helix/pull/1562#discussion_r535795170", "bodyText": "Yes. Good catch.", "author": "narendly", "createdAt": "2020-12-04T02:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc3OTI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "5ac90905deb00d16b6af9e7587c61e3cbb3605d3", "chunk": "diff --git a/helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java b/helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java\nindex cede77e8a..272164068 100644\n--- a/helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java\n+++ b/helix-core/src/main/java/org/apache/helix/manager/zk/ZkBaseDataAccessor.java\n\n@@ -139,7 +139,7 @@ public class ZkBaseDataAccessor<T> implements BaseDataAccessor<T> {\n \n   private ZkBaseDataAccessor(RealmAwareZkClient zkClient, boolean usesExternalZkClient) {\n     if (zkClient == null) {\n-      throw new NullPointerException(\"zkclient is null\");\n+      throw new IllegalArgumentException(\"zkclient is null\");\n     }\n     _zkClient = zkClient;\n     _usesExternalZkClient = usesExternalZkClient;\n"}}, {"oid": "5ac90905deb00d16b6af9e7587c61e3cbb3605d3", "url": "https://github.com/apache/helix/commit/5ac90905deb00d16b6af9e7587c61e3cbb3605d3", "message": "Fix StrictMatchExternalView", "committedDate": "2020-12-04T02:59:22Z", "type": "commit"}, {"oid": "da2d7c811f5fecf21f6258f7d5a88e60d9639c1e", "url": "https://github.com/apache/helix/commit/da2d7c811f5fecf21f6258f7d5a88e60d9639c1e", "message": "Enhance javadoc", "committedDate": "2020-12-04T03:11:28Z", "type": "commit"}, {"oid": "5c47a00af9cc801f92f2a0ee07096ef5cd3671e9", "url": "https://github.com/apache/helix/commit/5c47a00af9cc801f92f2a0ee07096ef5cd3671e9", "message": "Fix builders", "committedDate": "2020-12-04T05:21:47Z", "type": "commit"}]}