{"pr_number": 410, "pr_title": "[BOUNTY-4] Add NAT Kubernetes Support", "pr_createdAt": "2020-02-18T19:56:04Z", "pr_url": "https://github.com/hyperledger/besu/pull/410", "timeline": [{"oid": "a7b4b63fc21307d99ddd11642490e75d8eecedb1", "url": "https://github.com/hyperledger/besu/commit/a7b4b63fc21307d99ddd11642490e75d8eecedb1", "message": "add kubernetes support\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-18T19:31:12Z", "type": "commit"}, {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "url": "https://github.com/hyperledger/besu/commit/25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "message": "merge from master\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-18T19:34:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTcwMg==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r380951702", "bodyText": "What happens if it would return the NatMethod for both of these? Do we want Docker to be returned even if Kubernetes would be detected?", "author": "RatanRSur", "createdAt": "2020-02-18T21:41:18Z", "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -590,7 +597,7 @@ public Runner build() {\n     final NatMethod detectedNatMethod =\n         Optional.of(natMethod)\n             .filter(not(isEqual(NatMethod.AUTO)))\n-            .orElse(NatService.autoDetectNatMethod(new DockerDetector()));\n+            .orElse(NatService.autoDetectNatMethod(new DockerDetector(), new KubernetesDetector()));", "originalCommit": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1MDUxNw==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r381150517", "bodyText": "The first method detected would be the one selected. In the order they are declared. However in that case Kubernetes would be detected. The detection method for docker and kubernetes are mutually exclusive.", "author": "matkt", "createdAt": "2020-02-19T08:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMDc3MA==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r381300770", "bodyText": "The detection method for docker and kubernetes are mutually exclusive.\n\nI understand that only one would end up being selected but is it possible a misconfigured docker container inside a kubernetes \"pod\" (or whatever the term is haha), could succeed on the docker detector and not go on to the kubernetes detector? I ask because my intuition tells me that we should attempt to detect if we're in kubernetes first since it's the case that is a less general case.", "author": "RatanRSur", "createdAt": "2020-02-19T13:49:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTMwMjgxMw==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r381302813", "bodyText": "The detection method for docker and kubernetes are mutually exclusive.\nI understand that only one would end up being selected but is it possible a misconfigured docker container inside a kubernetes \"pod\" (or whatever the term is haha), could succeed on the docker detector and not go on to the kubernetes detector? I ask because my intuition tells me that we should attempt to detect if we're in kubernetes first since it's the case that is a less general case.\n\n\nOk I can create a new PR in order to change the order and put kubernetes detector first.", "author": "matkt", "createdAt": "2020-02-19T13:53:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTcwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Mzk1MQ==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r380953951", "bodyText": "Since the strings are only used once, I would inline usages here to make it easier to glance over at the file and see more richly typed fields. So the types would become Optional<String> and Path.", "author": "RatanRSur", "createdAt": "2020-02-18T21:46:06Z", "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package org.hyperledger.besu.nat.kubernetes;\n+\n+import org.hyperledger.besu.nat.NatMethod;\n+import org.hyperledger.besu.nat.core.NatMethodDetector;\n+\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+public class KubernetesDetector implements NatMethodDetector {\n+\n+  // When a Pod runs on a Node, the kubelet adds a set of environment variables for each active\n+  // Service.\n+  // https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#environment-variables\n+  private static final String KUBERNETES_SERVICE_HOST = \"KUBERNETES_SERVICE_HOST\";\n+  private static final String KUBERNETES_WATERMARK_FILE = \"/var/run/secrets/kubernetes.io\";", "originalCommit": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE1ODUzNA==", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r381158534", "bodyText": "done", "author": "matkt", "createdAt": "2020-02-19T09:08:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Mzk1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "b727b7b5132f7212895670617a09d3bb25f0171f", "chunk": "diff --git a/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java b/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java\nindex e8e88a517..823e06604 100644\n--- a/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java\n+++ b/nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java\n\n@@ -19,6 +19,7 @@ import org.hyperledger.besu.nat.NatMethod;\n import org.hyperledger.besu.nat.core.NatMethodDetector;\n \n import java.nio.file.Files;\n+import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.Optional;\n \n"}}, {"oid": "b727b7b5132f7212895670617a09d3bb25f0171f", "url": "https://github.com/hyperledger/besu/commit/b727b7b5132f7212895670617a09d3bb25f0171f", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-19T09:02:44Z", "type": "commit"}, {"oid": "41c7394b0edb6413abe00a17e1c3269e7c4d3066", "url": "https://github.com/hyperledger/besu/commit/41c7394b0edb6413abe00a17e1c3269e7c4d3066", "message": "merge from master\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-02-19T09:03:12Z", "type": "commit"}]}