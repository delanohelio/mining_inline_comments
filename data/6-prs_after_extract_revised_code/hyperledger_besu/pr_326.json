{"pr_number": 326, "pr_title": "Add Parity style Statediff", "pr_createdAt": "2020-01-25T07:15:53Z", "pr_url": "https://github.com/hyperledger/besu/pull/326", "timeline": [{"oid": "679b10a40cdacccb803436c9c39249630e010ed1", "url": "https://github.com/hyperledger/besu/commit/679b10a40cdacccb803436c9c39249630e010ed1", "message": "State diff\n\nAll but balances work at this point.\u00a0 And it has something to do with\nupfront gas costs.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-24T20:13:42Z", "type": "commit"}, {"oid": "90d3ff669f6e8f576b8fe1ef292494eb71090ee1", "url": "https://github.com/hyperledger/besu/commit/90d3ff669f6e8f576b8fe1ef292494eb71090ee1", "message": "fix the balances bug\n\nThere was also a chained transactions bug. To address this I create a\nnew WorldUpdater for each iteration of a transaction through the block.\n The current world updater has the new state, the prior the old one.\n Diffs just fall out after that.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T07:09:53Z", "type": "commit"}, {"oid": "83b5c34f5238a52f3f495897f476518515adb882", "url": "https://github.com/hyperledger/besu/commit/83b5c34f5238a52f3f495897f476518515adb882", "message": "get rid of midBlock state, it's unneeded with the chained updaters.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T07:28:13Z", "type": "commit"}, {"oid": "d8d53872a84fb4ee209fc6b3809494bf5d471ca2", "url": "https://github.com/hyperledger/besu/commit/d8d53872a84fb4ee209fc6b3809494bf5d471ca2", "message": "remove rootWorld method, old code from a prior attempt.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T07:33:37Z", "type": "commit"}, {"oid": "84dc04004a65571b3996d3d94ff7191a5532ae89", "url": "https://github.com/hyperledger/besu/commit/84dc04004a65571b3996d3d94ff7191a5532ae89", "message": "remove println\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T07:34:49Z", "type": "commit"}, {"oid": "8fa861c33052339552176e3f30cc6e8bf2c7ab73", "url": "https://github.com/hyperledger/besu/commit/8fa861c33052339552176e3f30cc6e8bf2c7ab73", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T17:15:43Z", "type": "commit"}, {"oid": "602c17202612d64ff2c165e422343b57244bfbd6", "url": "https://github.com/hyperledger/besu/commit/602c17202612d64ff2c165e422343b57244bfbd6", "message": "spotless, comments, and cleanup\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T17:33:57Z", "type": "commit"}, {"oid": "79f8a45288f64c4d9abfc0b7571a58f4e44a0e94", "url": "https://github.com/hyperledger/besu/commit/79f8a45288f64c4d9abfc0b7571a58f4e44a0e94", "message": "spotless keeps missing this.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T17:36:05Z", "type": "commit"}, {"oid": "716af088f117d3cf9cf213408d90c46cb2dc0978", "url": "https://github.com/hyperledger/besu/commit/716af088f117d3cf9cf213408d90c46cb2dc0978", "message": "javadoc\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T17:49:20Z", "type": "commit"}, {"oid": "da06ac543234198644a0dd9fd9dea00660e07e5c", "url": "https://github.com/hyperledger/besu/commit/da06ac543234198644a0dd9fd9dea00660e07e5c", "message": "fix broken reference tests\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T20:17:04Z", "type": "commit"}, {"oid": "a47ab7d8cc5b7301affb73d7ea0a865d31223888", "url": "https://github.com/hyperledger/besu/commit/a47ab7d8cc5b7301affb73d7ea0a865d31223888", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-25T20:21:19Z", "type": "commit"}, {"oid": "49c9b3473de834f6ec35c3a5c46c0fd012d59411", "url": "https://github.com/hyperledger/besu/commit/49c9b3473de834f6ec35c3a5c46c0fd012d59411", "message": "tighten access\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-01-26T20:07:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwMjMxMQ==", "url": "https://github.com/hyperledger/besu/pull/326#discussion_r371102311", "bodyText": "(Suggestion) Maybe add final modifier. Same comment for multiple local variables in this method.", "author": "abdelhamidbakhta", "createdAt": "2020-01-27T08:08:21Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/diff/StateDiffGenerator.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.diff;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.processor.TransactionTrace;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.Trace;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater.UpdateTrackingAccount;\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.core.WorldUpdater;\n+import org.hyperledger.besu.ethereum.debug.TraceFrame;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class StateDiffGenerator {\n+\n+  public Stream<Trace> generateStateDiff(final TransactionTrace transactionTrace) {\n+    List<TraceFrame> traceFrames = transactionTrace.getTraceFrames();", "originalCommit": "49c9b3473de834f6ec35c3a5c46c0fd012d59411", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwMjk2Mg==", "url": "https://github.com/hyperledger/besu/pull/326#discussion_r371102962", "bodyText": "Why not  filtering the transactionUpdater.getTouchedAccounts Collection to have only UpdateTrackingAccount types ?", "author": "abdelhamidbakhta", "createdAt": "2020-01-27T08:10:20Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/diff/StateDiffGenerator.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.diff;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.processor.TransactionTrace;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.Trace;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater.UpdateTrackingAccount;\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.core.WorldUpdater;\n+import org.hyperledger.besu.ethereum.debug.TraceFrame;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class StateDiffGenerator {\n+\n+  public Stream<Trace> generateStateDiff(final TransactionTrace transactionTrace) {\n+    List<TraceFrame> traceFrames = transactionTrace.getTraceFrames();\n+    if (traceFrames.size() < 1) {\n+      return Stream.empty();\n+    }\n+\n+    // This corresponds to the world state after the TX executed\n+    // It is two deep because of the way we addressed Spurious Dragon.\n+    WorldUpdater transactionUpdater =\n+        traceFrames\n+            .get(0)\n+            .getMessageFrame()\n+            .getWorldState()\n+            .parentUpdater()\n+            .get()\n+            .parentUpdater()\n+            .get();\n+    // This corresponds to the world state prior to the TX execution,\n+    // Either the initial block state or the state of the prior TX\n+    WorldUpdater previousUpdater = transactionUpdater.parentUpdater().get();\n+\n+    StateDiffTrace stateDiffResult = new StateDiffTrace();\n+\n+    for (Account touchedAccount : transactionUpdater.getTouchedAccounts()) {\n+      if (!(touchedAccount instanceof AbstractWorldUpdater.UpdateTrackingAccount)) {", "originalCommit": "49c9b3473de834f6ec35c3a5c46c0fd012d59411", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}