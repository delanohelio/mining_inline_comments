{"pr_number": 722, "pr_title": "[EIP-1559] Step 8 - Disable GasLimitRangeAndDeltaValidationRule and update ProofOfWorkValidationRule", "pr_createdAt": "2020-04-15T12:27:40Z", "pr_url": "https://github.com/hyperledger/besu/pull/722", "timeline": [{"oid": "ba37fd0efcba2de4ea34c979060ff361a1fe9798", "url": "https://github.com/hyperledger/besu/commit/ba37fd0efcba2de4ea34c979060ff361a1fe9798", "message": "Added changelog entries for PR:\n- https://github.com/hyperledger/besu/pull/430\n- https://github.com/hyperledger/besu/pull/440\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-12T09:09:40Z", "type": "commit"}, {"oid": "872f9cc4e93b90829961ebe6e599c51af43c95a7", "url": "https://github.com/hyperledger/besu/commit/872f9cc4e93b90829961ebe6e599c51af43c95a7", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-13T08:25:43Z", "type": "commit"}, {"oid": "e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "url": "https://github.com/hyperledger/besu/commit/e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-16T09:10:11Z", "type": "commit"}, {"oid": "a2fb831c87dae221c92a9f9ec7705500717f1e77", "url": "https://github.com/hyperledger/besu/commit/a2fb831c87dae221c92a9f9ec7705500717f1e77", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T09:17:25Z", "type": "commit"}, {"oid": "c07ed7de515e1e25ea22ef38b59bf8337086812e", "url": "https://github.com/hyperledger/besu/commit/c07ed7de515e1e25ea22ef38b59bf8337086812e", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T15:26:18Z", "type": "commit"}, {"oid": "1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "url": "https://github.com/hyperledger/besu/commit/1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-18T08:29:25Z", "type": "commit"}, {"oid": "ee10a2590d8e23b95a40c946a2927730714c4793", "url": "https://github.com/hyperledger/besu/commit/ee10a2590d8e23b95a40c946a2927730714c4793", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-19T16:27:54Z", "type": "commit"}, {"oid": "40cd31d7b48aab7b285524661ac17168c0d38467", "url": "https://github.com/hyperledger/besu/commit/40cd31d7b48aab7b285524661ac17168c0d38467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-23T10:35:38Z", "type": "commit"}, {"oid": "e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "url": "https://github.com/hyperledger/besu/commit/e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-25T08:04:10Z", "type": "commit"}, {"oid": "2c782ba4617a68e42def01737bdc6950ff7f9f53", "url": "https://github.com/hyperledger/besu/commit/2c782ba4617a68e42def01737bdc6950ff7f9f53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T09:26:18Z", "type": "commit"}, {"oid": "8b7f62d00c53ed1e8de940bffc675fad31825ba2", "url": "https://github.com/hyperledger/besu/commit/8b7f62d00c53ed1e8de940bffc675fad31825ba2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T11:50:21Z", "type": "commit"}, {"oid": "ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "url": "https://github.com/hyperledger/besu/commit/ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T08:45:52Z", "type": "commit"}, {"oid": "97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "url": "https://github.com/hyperledger/besu/commit/97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T10:50:47Z", "type": "commit"}, {"oid": "95947ab35e9145c5f788bb98ad1068a3db7a4895", "url": "https://github.com/hyperledger/besu/commit/95947ab35e9145c5f788bb98ad1068a3db7a4895", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T12:24:48Z", "type": "commit"}, {"oid": "63cc0286ffd370cf8e82ede9066b2bd473536ce1", "url": "https://github.com/hyperledger/besu/commit/63cc0286ffd370cf8e82ede9066b2bd473536ce1", "message": "Merge branch 'master' of https://github.com/hyperledger/besu", "committedDate": "2020-04-07T11:27:43Z", "type": "commit"}, {"oid": "6c836959d7bf7da960ebe4e063016f1f191e1467", "url": "https://github.com/hyperledger/besu/commit/6c836959d7bf7da960ebe4e063016f1f191e1467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-09T07:57:49Z", "type": "commit"}, {"oid": "f9ff23076dd7eded030cc3edb315086c67d6ce70", "url": "https://github.com/hyperledger/besu/commit/f9ff23076dd7eded030cc3edb315086c67d6ce70", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-09T11:17:24Z", "type": "commit"}, {"oid": "96433d65c57730d87d7aa2a9fed64d14b80dee53", "url": "https://github.com/hyperledger/besu/commit/96433d65c57730d87d7aa2a9fed64d14b80dee53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-10T07:44:03Z", "type": "commit"}, {"oid": "dd1c9b9145b1e73914ccec65ea3720f579277c38", "url": "https://github.com/hyperledger/besu/commit/dd1c9b9145b1e73914ccec65ea3720f579277c38", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-14T07:16:12Z", "type": "commit"}, {"oid": "a1a337a155e846bb02c693f26ff96a2fe642f61d", "url": "https://github.com/hyperledger/besu/commit/a1a337a155e846bb02c693f26ff96a2fe642f61d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-14T09:02:58Z", "type": "commit"}, {"oid": "f258611fa3e3429acffe627a90298a0bfaedc69b", "url": "https://github.com/hyperledger/besu/commit/f258611fa3e3429acffe627a90298a0bfaedc69b", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-14T11:40:59Z", "type": "commit"}, {"oid": "ec0f09a79e9c09a18f385e489fc56a2595158c7d", "url": "https://github.com/hyperledger/besu/commit/ec0f09a79e9c09a18f385e489fc56a2595158c7d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-15T10:51:15Z", "type": "commit"}, {"oid": "9cdeea1b13f545e2c82c8fb479185e4af66a312f", "url": "https://github.com/hyperledger/besu/commit/9cdeea1b13f545e2c82c8fb479185e4af66a312f", "message": "For post EIP-1559 blocks we must disable GasLimitRangeAndDeltaValidationRule.\nWe must also update ProofOfWorkValidationRule to include base fee field in the hash computation.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-15T12:25:49Z", "type": "commit"}, {"oid": "5a15a7304608116913f9f752f23277d00ebe2133", "url": "https://github.com/hyperledger/besu/commit/5a15a7304608116913f9f752f23277d00ebe2133", "message": "Rename logger\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-15T13:25:17Z", "type": "commit"}, {"oid": "c5ca0b142c8ca2521e977d6c403e9f42e879848e", "url": "https://github.com/hyperledger/besu/commit/c5ca0b142c8ca2521e977d6c403e9f42e879848e", "message": "Rename logger\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-15T13:25:40Z", "type": "commit"}, {"oid": "33be1bb1a52096b8080c97743debeffa55096467", "url": "https://github.com/hyperledger/besu/commit/33be1bb1a52096b8080c97743debeffa55096467", "message": "Merge branch 'master' into 720", "committedDate": "2020-04-15T15:00:25Z", "type": "commit"}, {"oid": "dc01da3ad40b4af4ce6eda8877255b111cfcee5d", "url": "https://github.com/hyperledger/besu/commit/dc01da3ad40b4af4ce6eda8877255b111cfcee5d", "message": "Fix base fee computation and add tests.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-15T15:19:10Z", "type": "commit"}, {"oid": "df457cea4d99ed09586d12c125661f3ff64ca289", "url": "https://github.com/hyperledger/besu/commit/df457cea4d99ed09586d12c125661f3ff64ca289", "message": "Merge branch '720' of https://github.com/abdelhamidbakhta/besu into 720", "committedDate": "2020-04-15T15:19:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxOTUyOQ==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409219529", "bodyText": "If we are to include the basefee shouldn't we require the header have the base fee?  Or does the spec allow it to be absent?  i.e. if we include base fee should an absent base fee be marked as invalid?", "author": "shemnon", "createdAt": "2020-04-16T01:00:06Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/headervalidationrules/ProofOfWorkValidationRule.java", "diffHunk": "@@ -95,6 +106,10 @@ Hash hashHeader(final BlockHeader header) {\n     out.writeLongScalar(header.getGasUsed());\n     out.writeLongScalar(header.getTimestamp());\n     out.writeBytes(header.getExtraData());\n+    if (includeBaseFee && header.getBaseFee().isPresent()) {", "originalCommit": "df457cea4d99ed09586d12c125661f3ff64ca289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2ODk1MA==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409468950", "bodyText": "Yes you are right. The spec does not allow it to be absent. So i will do the change to make it required if the boolean is set to true.", "author": "abdelhamidbakhta", "createdAt": "2020-04-16T11:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxOTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3OTMxOA==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409479318", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-04-16T11:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIxOTUyOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyMDAyNg==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409220026", "bodyText": "Does the basefee increase always at an increment or does it scale per the over/under?  I think a test case where we have the same parent fee but 5 gas used (way more, more, same, less, way less) would be good here to show that whatever the case is.", "author": "shemnon", "createdAt": "2020-04-16T01:02:05Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/fees/EIP1559BaseFeeTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.core.fees;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.hyperledger.besu.config.experimental.ExperimentalEIPs;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n+@RunWith(Parameterized.class)\n+public class EIP1559BaseFeeTest {\n+\n+  private static final long FORK_BLOCK = 783L;\n+  private final EIP1559 eip1559 = new EIP1559(FORK_BLOCK);\n+\n+  @Parameters\n+  public static Collection<Object[]> data() {\n+    return Arrays.asList(\n+        new Object[][] {\n+          {1000000000, 10000000, 1000000000},\n+          {1000000000, 7000000, 962500000},\n+          {1100000000, 10000000, 1100000000},\n+          {1100000000, 9000000, 1086250000},\n+          {1086250000, 9000000, 1072671875},\n+          {1072671875, 9000000, 1059263476},\n+          {1059263476, 10001000, 1059276716},\n+          {1059276716, 16000000, 1138722469},\n+          {1049238967, 0, 918084097}", "originalCommit": "df457cea4d99ed09586d12c125661f3ff64ca289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ2OTI0Mg==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409469242", "bodyText": "Ok sounds good", "author": "abdelhamidbakhta", "createdAt": "2020-04-16T11:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyMDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ3OTM5Mw==", "url": "https://github.com/hyperledger/besu/pull/722#discussion_r409479393", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-04-16T11:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyMDAyNg=="}], "type": "inlineReview", "revised_code": {"commit": "9e273be4f22a7fc11500dda057a406ce026bf823", "chunk": "diff --git a/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/fees/EIP1559BaseFeeTest.java b/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/fees/EIP1559BaseFeeTest.java\nindex 3d3c1ef5b..94356cb43 100644\n--- a/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/fees/EIP1559BaseFeeTest.java\n+++ b/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/fees/EIP1559BaseFeeTest.java\n\n@@ -31,22 +31,32 @@ import org.junit.runners.Parameterized.Parameters;\n @RunWith(Parameterized.class)\n public class EIP1559BaseFeeTest {\n \n-  private static final long FORK_BLOCK = 783L;\n-  private final EIP1559 eip1559 = new EIP1559(FORK_BLOCK);\n+  private static final long MARKER_BASE_FEE = 1049238967;\n+  private final EIP1559 eip1559 = new EIP1559(0L);\n+  private static final FeeMarket FEE_MARKET = FeeMarket.eip1559();\n \n   @Parameters\n   public static Collection<Object[]> data() {\n     return Arrays.asList(\n         new Object[][] {\n-          {1000000000, 10000000, 1000000000},\n-          {1000000000, 7000000, 962500000},\n-          {1100000000, 10000000, 1100000000},\n+          {\n+            FEE_MARKET.getInitialBasefee(),\n+            FEE_MARKET.getTargetGasUsed(),\n+            FEE_MARKET.getInitialBasefee()\n+          },\n+          {FEE_MARKET.getInitialBasefee(), 7000000, 962500000},\n+          {1100000000, FEE_MARKET.getTargetGasUsed(), 1100000000},\n           {1100000000, 9000000, 1086250000},\n           {1086250000, 9000000, 1072671875},\n           {1072671875, 9000000, 1059263476},\n           {1059263476, 10001000, 1059276716},\n           {1059276716, 16000000, 1138722469},\n-          {1049238967, 0, 918084097}\n+          {MARKER_BASE_FEE, 0, 918084097},\n+          {MARKER_BASE_FEE, 5, 918084161},\n+          {MARKER_BASE_FEE, 5000, 918149673},\n+          {MARKER_BASE_FEE, 500000, 924641839},\n+          {MARKER_BASE_FEE, FEE_MARKET.getTargetGasUsed(), MARKER_BASE_FEE},\n+          {MARKER_BASE_FEE, FEE_MARKET.getMaxGas(), 1127931889}\n         });\n   }\n \n"}}, {"oid": "bb6c120c2d0b4cdc2cd4e0a3647e4fedb70f0110", "url": "https://github.com/hyperledger/besu/commit/bb6c120c2d0b4cdc2cd4e0a3647e4fedb70f0110", "message": "Merge remote-tracking branch 'upstream/master' into 720\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-16T09:06:49Z", "type": "commit"}, {"oid": "9e273be4f22a7fc11500dda057a406ce026bf823", "url": "https://github.com/hyperledger/besu/commit/9e273be4f22a7fc11500dda057a406ce026bf823", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-16T11:20:49Z", "type": "commit"}, {"oid": "9955d2bc59a7065a4bb1e3cbe189720cd1975545", "url": "https://github.com/hyperledger/besu/commit/9955d2bc59a7065a4bb1e3cbe189720cd1975545", "message": "Merge branch 'master' into 720", "committedDate": "2020-04-16T15:25:19Z", "type": "commit"}]}