{"pr_number": 1647, "pr_title": "prevent Besu starting in GoQuorum mode on Mainnet", "pr_createdAt": "2020-12-02T01:21:38Z", "pr_url": "https://github.com/hyperledger/besu/pull/1647", "timeline": [{"oid": "784d8a9698e20e2bb707413ce65c932666fba6da", "url": "https://github.com/hyperledger/besu/commit/784d8a9698e20e2bb707413ce65c932666fba6da", "message": "prevent mainnet + goquorum\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-02T01:18:00Z", "type": "commit"}, {"oid": "0f86d120c1565518377cba92243645c8c5bd33fb", "url": "https://github.com/hyperledger/besu/commit/0f86d120c1565518377cba92243645c8c5bd33fb", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into no-gq-privacy-mainnet", "committedDate": "2020-12-02T02:24:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1NjY3MQ==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533856671", "bodyText": "what needs to happen if it is not present?", "author": "pinges", "createdAt": "2020-12-02T02:37:28Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1404,6 +1404,16 @@ private void validateGoQuorumCompatibilityModeParam() {\n         throw new IllegalStateException(\n             \"GoQuorum compatibility mode (enabled) can only be used if genesis file has 'isQuorum' flag set to true.\");\n       }\n+      genesisConfigOptions\n+          .getChainId()", "originalCommit": "784d8a9698e20e2bb707413ce65c932666fba6da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1ODkxNQ==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533858915", "bodyText": "if you don't specify chainId in genesis, it uses network if provided (cmd line) and if not provided then it's mainnet", "author": "macfarla", "createdAt": "2020-12-02T02:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1NjY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg2MDYwNQ==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533860605", "bodyText": "the validation against chainId is in a different place to network (because we don't read genesis file until later) but it might make sense to to them both later, together, to make it easier to read", "author": "macfarla", "createdAt": "2020-12-02T02:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1NjY3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg3Mjk2OA==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533872968", "bodyText": "refactored into a single method", "author": "macfarla", "createdAt": "2020-12-02T03:29:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1NjY3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "85ebd2398e946312e2d289fbc08e8d608560266c", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\nindex 0f2d32a4c..600715d74 100644\n--- a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n+++ b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n\n@@ -1396,27 +1396,6 @@ public class BesuCommand implements DefaultCommandValues, Runnable {\n     }\n   }\n \n-  private void validateGoQuorumCompatibilityModeParam() {\n-    if (isGoQuorumCompatibilityMode) {\n-      final GenesisConfigOptions genesisConfigOptions = readGenesisConfigOptions();\n-\n-      if (!genesisConfigOptions.isQuorum()) {\n-        throw new IllegalStateException(\n-            \"GoQuorum compatibility mode (enabled) can only be used if genesis file has 'isQuorum' flag set to true.\");\n-      }\n-      genesisConfigOptions\n-          .getChainId()\n-          .ifPresent(chainId -> ensureGoQuorumCompatibilityModeNotUsedOnMainnet(chainId));\n-    }\n-  }\n-\n-  private void ensureGoQuorumCompatibilityModeNotUsedOnMainnet(final BigInteger chainId) {\n-    if (chainId.equals(EthNetworkConfig.MAINNET_NETWORK_ID)) {\n-      throw new IllegalStateException(\n-          \"GoQuorum compatibility mode (enabled) cannot be used on Mainnet.\");\n-    }\n-  }\n-\n   private GenesisConfigOptions readGenesisConfigOptions() {\n     final GenesisConfigOptions genesisConfigOptions;\n     try {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1ODA5Mg==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533858092", "bodyText": "Could you use the valid quorum genesis file here with chainId 1?", "author": "pinges", "createdAt": "2020-12-02T02:41:56Z", "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3963,4 +3972,31 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"0\");\n     assertThat(commandErrorOutput.toString()).isEmpty();\n   }\n+\n+  @Test\n+  public void quorumInteropEnabledFailsWithMainnetDefaultNetwork() throws IOException {\n+    final Path genesisFile = createFakeGenesisFile(INVALID_GENESIS_QUORUM_INTEROP_ENABLED_MAINNET);\n+    parseCommand(\n+        \"--goquorum-compatibility-enabled\",\n+        \"--genesis-file\",\n+        genesisFile.toString(),\n+        \"--min-gas-price\",\n+        \"0\");\n+    assertThat(commandErrorOutput.toString())\n+        .contains(\"GoQuorum compatibility mode (enabled) cannot be used on Mainnet\");\n+  }\n+\n+  @Test\n+  public void quorumInteropEnabledFailsWithMainnetChainId() throws IOException {\n+    final Path genesisFile =\n+        createFakeGenesisFile(INVALID_GENESIS_QUORUM_INTEROP_ENABLED_MAINNET.put(\"chainId\", \"1\"));", "originalCommit": "784d8a9698e20e2bb707413ce65c932666fba6da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1OTMxOQ==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533859319", "bodyText": "yes that would work", "author": "macfarla", "createdAt": "2020-12-02T02:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1ODA5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg2ODQ5NA==", "url": "https://github.com/hyperledger/besu/pull/1647#discussion_r533868494", "bodyText": "but it's used in two spots (and the other one doesn't add chainId) so I think it's clearer to use the constant", "author": "macfarla", "createdAt": "2020-12-02T03:15:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg1ODA5Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "85ebd2398e946312e2d289fbc08e8d608560266c", "url": "https://github.com/hyperledger/besu/commit/85ebd2398e946312e2d289fbc08e8d608560266c", "message": "refactor\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-02T03:25:20Z", "type": "commit"}, {"oid": "056b2da1b2e05810a56d5565cc64239ba6b6cc0e", "url": "https://github.com/hyperledger/besu/commit/056b2da1b2e05810a56d5565cc64239ba6b6cc0e", "message": "changelog\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-02T03:28:29Z", "type": "commit"}]}