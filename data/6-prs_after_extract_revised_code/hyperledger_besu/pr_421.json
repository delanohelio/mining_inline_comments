{"pr_number": 421, "pr_title": "Report memory/processes at end of test", "pr_createdAt": "2020-02-20T12:38:42Z", "pr_url": "https://github.com/hyperledger/besu/pull/421", "timeline": [{"oid": "635e31500095be9d9b59f4f518046a4538359325", "url": "https://github.com/hyperledger/besu/commit/635e31500095be9d9b59f4f518046a4538359325", "message": "Report memory/processes at end of test\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-20T12:30:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r382404673", "bodyText": "Apply the clean code philosophy here, refactor these into private methods with descriptive names, please", "author": "CjHare", "createdAt": "2020-02-21T05:32:51Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -101,5 +115,42 @@ protected AcceptanceTestBase() {\n   @After\n   public void tearDownAcceptanceTestBase() {\n     cluster.close();\n+\n+    String os = System.getProperty(\"os.name\");", "originalCommit": "635e31500095be9d9b59f4f518046a4538359325", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk0MjI3OQ==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r382942279", "bodyText": "Done.", "author": "hmijail", "createdAt": "2020-02-22T21:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTk0MA==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r401959940", "bodyText": "Done.\n\nMy observation is that the code has yet to change \ud83e\udd14", "author": "CjHare", "createdAt": "2020-04-01T23:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1NzIwNQ==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r402057205", "bodyText": "This is weird. In the \"Conversation\" tab of GitHub, this thread shows the code as it was originally, on Feb 20. It ignores the changes I introduced Feb 23 (commit 497c15b)\nMeanwhile, in the \"Files changed\" tab, this thread does show those changes.\nI wonder whether we were looking at the code from different tabs then? Or did you really mean that you wanted even more cleaning?\nAnyway, I have just pushed some more cleaning/refactoring that I did before realizing the GitHub weirdness.", "author": "hmijail", "createdAt": "2020-04-02T05:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NTg5OQ==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r402075899", "bodyText": "Or did you really mean that you wanted even more cleaning?\n\nThat one \ud83d\ude01", "author": "CjHare", "createdAt": "2020-04-02T06:21:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NDIxNA==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r402154214", "bodyText": "so... done now?", "author": "hmijail", "createdAt": "2020-04-02T08:53:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDY3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "497c15b222ee6ffc77e0b2e1fc33f238c998f956", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\nindex 0319e54aa..d17464b07 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n\n@@ -115,7 +115,10 @@ public class AcceptanceTestBase {\n   @After\n   public void tearDownAcceptanceTestBase() {\n     cluster.close();\n+    reportMemory();\n+  }\n \n+  public void reportMemory() {\n     String os = System.getProperty(\"os.name\");\n     String[] command = null;\n     if (os.contains(\"Linux\")) {\n"}}, {"oid": "497c15b222ee6ffc77e0b2e1fc33f238c998f956", "url": "https://github.com/hyperledger/besu/commit/497c15b222ee6ffc77e0b2e1fc33f238c998f956", "message": "Clean code\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-22T19:01:08Z", "type": "commit"}, {"oid": "08896ec0f396bb429ef43fde7397d45dc0ee0495", "url": "https://github.com/hyperledger/besu/commit/08896ec0f396bb429ef43fde7397d45dc0ee0495", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-03-24T05:32:45Z", "type": "commit"}, {"oid": "93b2e803ee497365ff437ce604e75e7abc98b21e", "url": "https://github.com/hyperledger/besu/commit/93b2e803ee497365ff437ce604e75e7abc98b21e", "message": "Merge remote-tracking branch 'upstream/master' into report-memory\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>\n\n# Conflicts:\n#\tacceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "committedDate": "2020-03-24T08:30:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTExNg==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397541116", "bodyText": "Doesn't this Log4j property need setting before the Log4j2 framework get initialised? (isn't it too late by here)", "author": "CjHare", "createdAt": "2020-03-25T00:25:26Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -52,13 +53,18 @@\n \n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.ThreadContext;\n import org.junit.After;\n import org.junit.Rule;\n import org.junit.rules.TestName;\n import org.junit.rules.TestWatcher;\n import org.junit.runner.Description;\n \n public class AcceptanceTestBase {\n+  static {\n+    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");", "originalCommit": "93b2e803ee497365ff437ce604e75e7abc98b21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc4NjI4Mw==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397786283", "bodyText": "Yes, it does, and no, it isn't, since it works ;). The framework is initialized when anything from it is used, and the property is set here earlier than that.\nThough to tell the truth I can't find now anything explicitly sanctioning this way of doing things.\nAnyway, I guess this is fragile in that some code change elsewhere might cause the \"early enough\" assumption to fail. So if preferred this could be set in a log4j2.property file. I just thought that here it's closer to its purpose.", "author": "hmijail", "createdAt": "2020-03-25T11:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIzOTc0MQ==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r398239741", "bodyText": "Yeah put it a property file somewhere.\nYou'll want to also explicitly set\ndisableThreadContextMap = false\ndisableThreadContext = false\n\nAs if either of those are set to true by environment variables, the code isn't going to work\nhttps://logging.apache.org/log4j/2.x/manual/thread-context.html\n\nSet the system property disableThreadContextMap to true to disable the Thread Context Map.\nSet the system property disableThreadContext to true to disable both the Thread Context Map and Stack.", "author": "CjHare", "createdAt": "2020-03-25T23:52:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTExNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NzA4Mg==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r398467082", "bodyText": "Environment variables have higher priority than property files anyway, so setting those in a property file will not help for this scenario.\nDo we really want to force log4j2's behavior like that anyway? If so, then I guess the only way to do so is to set the values manually once the self-configuration is finished. That sounds gory to me.\nIMO, if the user has set environment variables like that, they already know enough to take care of the situation by themselves.", "author": "hmijail", "createdAt": "2020-03-26T10:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTExNg=="}], "type": "inlineReview", "revised_code": {"commit": "812a095fbc014ef85db71357a6082c60f2335f07", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\nindex 260ce9c1a..783aadbbf 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n\n@@ -61,9 +61,6 @@ import org.junit.rules.TestWatcher;\n import org.junit.runner.Description;\n \n public class AcceptanceTestBase {\n-  static {\n-    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");\n-  }\n \n   private static final Logger LOG = LogManager.getLogger();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQwMw==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397541403", "bodyText": "Remind me again why this rule needs to be in the AcceptanceTestBase and not it's own class?", "author": "CjHare", "createdAt": "2020-03-25T00:26:32Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -201,4 +168,46 @@ public void tearDownAcceptanceTestBase() {\n       LOG.info(\"Don't know how to report memory for OS {}\", os);\n     }\n   }\n+\n+  @Rule", "originalCommit": "93b2e803ee497365ff437ce604e75e7abc98b21e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5MTA4NQ==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397791085", "bodyText": "Its purpose is that of @Before and @After, so I thought here it makes conceptual sense. But I guess it could go to its own class. Let me know whether to separate it then.", "author": "hmijail", "createdAt": "2020-03-25T11:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5MTY4NA==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397791684", "bodyText": "By the way, the other @Rule was unused and just a vestige of a previous implementation. I'll remove it.", "author": "hmijail", "createdAt": "2020-03-25T11:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzgwMTA5Mg==", "url": "https://github.com/hyperledger/besu/pull/421#discussion_r397801092", "bodyText": "(... or should that be another PR?)", "author": "hmijail", "createdAt": "2020-03-25T12:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0MTQwMw=="}], "type": "inlineReview", "revised_code": {"commit": "55a4b1289587122ee98a9485cd9cd12fbd292976", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\nindex 260ce9c1a..ebc754c60 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java\n\n@@ -169,6 +153,19 @@ public class AcceptanceTestBase {\n     }\n   }\n \n+  private void printOutput(final Process process) {\n+    try (final BufferedReader in =\n+        new BufferedReader(new InputStreamReader(process.getInputStream(), UTF_8))) {\n+      String line = in.readLine();\n+      while (line != null) {\n+        LOG.info(line);\n+        line = in.readLine();\n+      }\n+    } catch (final IOException e) {\n+      LOG.warn(\"Failed to read output from memory information process: \", e);\n+    }\n+  }\n+\n   @Rule\n   public TestWatcher log_eraser =\n       new TestWatcher() {\n"}}, {"oid": "08a1164410b7413d288a0a3f1ae54d830f77de08", "url": "https://github.com/hyperledger/besu/commit/08a1164410b7413d288a0a3f1ae54d830f77de08", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-03-25T13:10:42Z", "type": "commit"}, {"oid": "812a095fbc014ef85db71357a6082c60f2335f07", "url": "https://github.com/hyperledger/besu/commit/812a095fbc014ef85db71357a6082c60f2335f07", "message": "Address comment: move property setting to a properties file\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-03-26T10:46:46Z", "type": "commit"}, {"oid": "83c83f517ea0ceb58aa448cfb6fb281a1974a0a5", "url": "https://github.com/hyperledger/besu/commit/83c83f517ea0ceb58aa448cfb6fb281a1974a0a5", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-03-27T00:41:35Z", "type": "commit"}, {"oid": "c4e14bae78155bae8b66632f7085c52c15667e5c", "url": "https://github.com/hyperledger/besu/commit/c4e14bae78155bae8b66632f7085c52c15667e5c", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-01T01:03:59Z", "type": "commit"}, {"oid": "a8bb6bf83fc28b0ab1e254f55ffd3ffe1dc2bacf", "url": "https://github.com/hyperledger/besu/commit/a8bb6bf83fc28b0ab1e254f55ffd3ffe1dc2bacf", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-01T12:32:53Z", "type": "commit"}, {"oid": "55a4b1289587122ee98a9485cd9cd12fbd292976", "url": "https://github.com/hyperledger/besu/commit/55a4b1289587122ee98a9485cd9cd12fbd292976", "message": "Clean code further\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-04-02T05:02:30Z", "type": "commit"}, {"oid": "7c9d44e6bcb278935606b414481cc85211dc4463", "url": "https://github.com/hyperledger/besu/commit/7c9d44e6bcb278935606b414481cc85211dc4463", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-02T05:04:07Z", "type": "commit"}, {"oid": "ad878feec10fb5ce72cf114575649cb4de07f457", "url": "https://github.com/hyperledger/besu/commit/ad878feec10fb5ce72cf114575649cb4de07f457", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-07T03:17:01Z", "type": "commit"}, {"oid": "edb3d189a5b100b2e53745c63687b2b32fbda18e", "url": "https://github.com/hyperledger/besu/commit/edb3d189a5b100b2e53745c63687b2b32fbda18e", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-07T06:51:45Z", "type": "commit"}, {"oid": "ae9a8a3c7f184bff30dee2343f8d20af8a0d7d9d", "url": "https://github.com/hyperledger/besu/commit/ae9a8a3c7f184bff30dee2343f8d20af8a0d7d9d", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-07T07:40:29Z", "type": "commit"}, {"oid": "ebbb671419d7754b98b5183ecadad2972ecdaf36", "url": "https://github.com/hyperledger/besu/commit/ebbb671419d7754b98b5183ecadad2972ecdaf36", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-07T13:49:15Z", "type": "commit"}, {"oid": "068426c8eba8ff17abb5710bdf480a284e2c0543", "url": "https://github.com/hyperledger/besu/commit/068426c8eba8ff17abb5710bdf480a284e2c0543", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-08T23:17:06Z", "type": "commit"}, {"oid": "e3e2c39eb7493849ff0c8e5a0c2502d8032e7c47", "url": "https://github.com/hyperledger/besu/commit/e3e2c39eb7493849ff0c8e5a0c2502d8032e7c47", "message": "Merge branch 'master' into report-memory", "committedDate": "2020-04-09T06:52:32Z", "type": "commit"}]}