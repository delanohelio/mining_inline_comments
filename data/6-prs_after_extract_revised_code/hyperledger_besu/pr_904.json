{"pr_number": 904, "pr_title": "Update transaction pool error handling.", "pr_createdAt": "2020-05-12T12:41:41Z", "pr_url": "https://github.com/hyperledger/besu/pull/904", "timeline": [{"oid": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "url": "https://github.com/hyperledger/besu/commit/0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "message": "Update transaction pool error handling.\nTransactions added locally into the pool via `eth_sendRawTransaction` can now generate 2 new JSON RPC errors:\n- `ETH_SEND_TX_ALREADY_KNOWN`: occurs when adding a transaction already present in the pool.\n    - code: -32000\n    - message: `Known Transaction`\n- `ETH_SEND_TX_REPLACEMENT_UNDERPRICED`: occurs when adding a transaction already present in the pool.\n    - code: -32000\n    - message: `Replacement transaction underpriced`\n\n### Changes summary\n- Created `TransactionAddedStatus` enum.\n    - `ALREADY_KNOWN`\n    - `REJECTED_UNDERPRICED_REPLACEMENT`\n    - `ADDED`\n- Created 2 new errors in `JsonRpcError`.\n- Updated JsonRpcErrorConverter to handle newly created errors.\n- Updated `addLocalTransaction` method of `PendingTransactions` to return `TransactionAddedStatus` instead of boolean.\n- Updated unit tests accordingly.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-05-12T12:38:35Z", "type": "commit"}, {"oid": "a8c4a3682d698537a60b058ecb7448f5e6ba7fb1", "url": "https://github.com/hyperledger/besu/commit/a8c4a3682d698537a60b058ecb7448f5e6ba7fb1", "message": "Address PR comment.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-05-12T13:37:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MjAwMA==", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423742000", "bodyText": "I think it would be better to use optional rather than putting a null. What do you think ?", "author": "matkt", "createdAt": "2020-05-12T13:41:14Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -435,4 +442,20 @@ public Instant getAddedToPoolAt() {\n \n     TransactionSelectionResult evaluateTransaction(final Transaction transaction);\n   }\n+\n+  public enum TransactionAddedStatus {\n+    ALREADY_KNOWN(TransactionInvalidReason.TRANSACTION_ALREADY_KNOWN),\n+    REJECTED_UNDERPRICED_REPLACEMENT(TransactionInvalidReason.TRANSACTION_REPLACEMENT_UNDERPRICED),\n+    ADDED(null);", "originalCommit": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0OTU1MA==", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423749550", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T13:50:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MjAwMA=="}], "type": "inlineReview", "revised_code": {"commit": "db0449fb43d37d36ac85695321ac526013f8ad9f", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\nindex 2d146eee0..fc0999971 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\n\n@@ -446,15 +447,19 @@ public class PendingTransactions {\n   public enum TransactionAddedStatus {\n     ALREADY_KNOWN(TransactionInvalidReason.TRANSACTION_ALREADY_KNOWN),\n     REJECTED_UNDERPRICED_REPLACEMENT(TransactionInvalidReason.TRANSACTION_REPLACEMENT_UNDERPRICED),\n-    ADDED(null);\n+    ADDED();\n \n-    private final TransactionInvalidReason invalidReason;\n+    private final Optional<TransactionInvalidReason> invalidReason;\n+\n+    TransactionAddedStatus() {\n+      this.invalidReason = Optional.empty();\n+    }\n \n     TransactionAddedStatus(final TransactionInvalidReason invalidReason) {\n-      this.invalidReason = invalidReason;\n+      this.invalidReason = Optional.of(invalidReason);\n     }\n \n-    public TransactionInvalidReason getInvalidReason() {\n+    public Optional<TransactionInvalidReason> getInvalidReason() {\n       return invalidReason;\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0Mjc4Ng==", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423742786", "bodyText": "We can use a variable to avoid doing the equals twice", "author": "matkt", "createdAt": "2020-05-12T13:42:18Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -130,11 +134,11 @@ public void evictOldTransactions() {\n   public boolean addRemoteTransaction(final Transaction transaction) {\n     final TransactionInfo transactionInfo =\n         new TransactionInfo(transaction, false, clock.instant());\n-    final boolean transactionAdded = addTransaction(transactionInfo);\n-    if (transactionAdded) {\n+    final TransactionAddedStatus transactionAddedStatus = addTransaction(transactionInfo);", "originalCommit": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0NDQzNA==", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423744434", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-05-12T13:44:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0Mjc4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "db0449fb43d37d36ac85695321ac526013f8ad9f", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\nindex 2d146eee0..fc0999971 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java\n\n@@ -135,10 +135,11 @@ public class PendingTransactions {\n     final TransactionInfo transactionInfo =\n         new TransactionInfo(transaction, false, clock.instant());\n     final TransactionAddedStatus transactionAddedStatus = addTransaction(transactionInfo);\n-    if (transactionAddedStatus.equals(ADDED)) {\n+    final boolean added = transactionAddedStatus.equals(ADDED);\n+    if (added) {\n       remoteTransactionAddedCounter.inc();\n     }\n-    return transactionAddedStatus.equals(ADDED);\n+    return added;\n   }\n \n   boolean addTransactionHash(final Hash transactionHash) {\n"}}, {"oid": "db0449fb43d37d36ac85695321ac526013f8ad9f", "url": "https://github.com/hyperledger/besu/commit/db0449fb43d37d36ac85695321ac526013f8ad9f", "message": "Changed nullable value to optional.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-05-12T13:50:42Z", "type": "commit"}]}