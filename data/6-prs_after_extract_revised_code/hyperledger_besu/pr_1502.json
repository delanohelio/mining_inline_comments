{"pr_number": 1502, "pr_title": "Update eth_estimateGas and eth_call RPC APIs for EIP1559 transaction", "pr_createdAt": "2020-10-30T11:33:28Z", "pr_url": "https://github.com/hyperledger/besu/pull/1502", "timeline": [{"oid": "489f274e8f0e527b8df060319702f74c10286c95", "url": "https://github.com/hyperledger/besu/commit/489f274e8f0e527b8df060319702f74c10286c95", "message": "init eth_estimateGas for EIP1559 transaction\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-10-30T10:57:12Z", "type": "commit"}, {"oid": "9f46fde48dec58827ca72774de69b9bc0108616c", "url": "https://github.com/hyperledger/besu/commit/9f46fde48dec58827ca72774de69b9bc0108616c", "message": "add validation for eip 1559 transaction\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-10-30T14:06:17Z", "type": "commit"}, {"oid": "26fdf379cb1a61c2a813b70e70dd6a453bbd591c", "url": "https://github.com/hyperledger/besu/commit/26fdf379cb1a61c2a813b70e70dd6a453bbd591c", "message": "Merge branch 'upstream/master' into feature/eth-estimate-gas-eip1559\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-10-30T14:16:37Z", "type": "commit"}, {"oid": "ec2305201ac139e17bd838b73e359aab6695c5bc", "url": "https://github.com/hyperledger/besu/commit/ec2305201ac139e17bd838b73e359aab6695c5bc", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-10-30T15:41:20Z", "type": "commit"}, {"oid": "4edaef34527b40f1f443916f680948e088852bf2", "url": "https://github.com/hyperledger/besu/commit/4edaef34527b40f1f443916f680948e088852bf2", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-11-02T08:54:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5Nzc4NA==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516097784", "bodyText": "I think while we're here we might as well fix this issue of CallParams and JsonCallParams. Take a look at FilterParameter, that has non-string types but also has the properties to make it json serializable. If you want to make it a separate PR that works!", "author": "RatanRSur", "createdAt": "2020-11-02T16:33:01Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGas.java", "diffHunk": "@@ -91,6 +91,8 @@ private JsonCallParameter overrideGasLimitAndPrice(\n         callParams.getTo() != null ? callParams.getTo().toString() : null,\n         Quantity.create(gasLimit),\n         Quantity.create(0L),\n+        callParams.getGasPremium().map(Quantity::create).orElse(null),\n+        callParams.getFeeCap().map(Quantity::create).orElse(null),", "originalCommit": "4edaef34527b40f1f443916f680948e088852bf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3OTI0Nw==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516679247", "bodyText": "I will do this in another PR because there are already two things in this PR with eth_call and eth_estimateGas", "author": "matkt", "createdAt": "2020-11-03T13:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5Nzc4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNjE3MQ==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516106171", "bodyText": "If process returns empty(), it could be that the world state is unavailable. As I read it, that means that we're sometimes giving the user INTERNAL_ERROR for world state unavailability and sometimes WORLD_STATE_UNAVAILABLE. Is that right?", "author": "RatanRSur", "createdAt": "2020-11-02T16:44:41Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGasTest.java", "diffHunk": "@@ -94,8 +94,22 @@ public void shouldReturnErrorWhenTransientTransactionProcessorReturnsEmpty() {\n   }\n \n   @Test\n-  public void shouldReturnGasEstimateWhenTransientTransactionProcessorReturnsResultSuccess() {\n-    final JsonRpcRequestContext request = ethEstimateGasRequest(callParameter());\n+  public void shouldReturnErrorWhenTransientEip1559TransactionProcessorReturnsEmpty() {\n+    final JsonRpcRequestContext request = ethEstimateGasRequest(eip1559TransactionCallParameter());\n+    when(transactionSimulator.process(\n+            eq(modifiedEip1559TransactionCallParameter()), any(OperationTracer.class), eq(1L)))\n+        .thenReturn(Optional.empty());\n+\n+    final JsonRpcResponse expectedResponse =\n+        new JsonRpcErrorResponse(null, JsonRpcError.INTERNAL_ERROR);", "originalCommit": "4edaef34527b40f1f443916f680948e088852bf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY1NzUzOQ==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516657539", "bodyText": "no because the json rpc method will fail fast thanks to this check without going into the simulator.\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGas.java\n    \n    \n         Line 65\n      in\n      83e0370\n    \n    \n    \n    \n\n        \n          \n           if (!blockchainQueries", "author": "matkt", "createdAt": "2020-11-03T13:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNjE3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNzM3NQ==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516107375", "bodyText": "Is this tested anywhere?", "author": "RatanRSur", "createdAt": "2020-11-02T16:46:21Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetTransactionValidator.java", "diffHunk": "@@ -102,6 +102,12 @@ public MainnetTransactionValidator(\n               String.format(\"gasPrice is less than the current BaseFee\"));\n         }\n       }\n+    } else if (transaction.isEIP1559Transaction()) {\n+      return ValidationResult.invalid(\n+          TransactionInvalidReason.INVALID_TRANSACTION_FORMAT,\n+          String.format(\n+              \"transaction format is invalid, accepted transaction types are %s\",\n+              acceptedTransactionTypes.toString()));", "originalCommit": "4edaef34527b40f1f443916f680948e088852bf2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY4MTQ5OA==", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516681498", "bodyText": "good catch . I just added a test", "author": "matkt", "createdAt": "2020-11-03T13:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNzM3NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5a74552d4cb520aec3a97d4d32cba88ac472d37e", "url": "https://github.com/hyperledger/besu/commit/5a74552d4cb520aec3a97d4d32cba88ac472d37e", "message": "add missing test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-11-03T13:51:13Z", "type": "commit"}, {"oid": "11a928016f4fdff438a33858ef1d1c209d8f59e7", "url": "https://github.com/hyperledger/besu/commit/11a928016f4fdff438a33858ef1d1c209d8f59e7", "message": "Merge\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-11-03T13:52:14Z", "type": "commit"}, {"oid": "9fd13ee32592efc79738e420385a002462fa376b", "url": "https://github.com/hyperledger/besu/commit/9fd13ee32592efc79738e420385a002462fa376b", "message": "fix pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-11-03T14:08:17Z", "type": "commit"}, {"oid": "f8eb1708de62eb564e35e58cdcec699e9ac9196b", "url": "https://github.com/hyperledger/besu/commit/f8eb1708de62eb564e35e58cdcec699e9ac9196b", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-11-05T10:34:03Z", "type": "commit"}, {"oid": "80fb218ffd7c07c9c8350539fe0bfa0e51088ba0", "url": "https://github.com/hyperledger/besu/commit/80fb218ffd7c07c9c8350539fe0bfa0e51088ba0", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-11-06T12:49:20Z", "type": "commit"}, {"oid": "fdec89214c6f1efe2ad4be5c39fffa84128a453c", "url": "https://github.com/hyperledger/besu/commit/fdec89214c6f1efe2ad4be5c39fffa84128a453c", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-11-10T13:01:16Z", "type": "commit"}, {"oid": "9509228a6d92e8c2d15a737c0d5fcc7e7cbe435d", "url": "https://github.com/hyperledger/besu/commit/9509228a6d92e8c2d15a737c0d5fcc7e7cbe435d", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559", "committedDate": "2020-11-12T09:10:12Z", "type": "commit"}, {"oid": "02601abde5d734b6348628a5e74fc51ba24b91e2", "url": "https://github.com/hyperledger/besu/commit/02601abde5d734b6348628a5e74fc51ba24b91e2", "message": "fix merge issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-11-12T10:02:10Z", "type": "commit"}]}