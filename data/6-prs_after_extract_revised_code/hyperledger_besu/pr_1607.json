{"pr_number": 1607, "pr_title": "priv_debugGetStateRoot bug refactorings.", "pr_createdAt": "2020-11-25T04:36:48Z", "pr_url": "https://github.com/hyperledger/besu/pull/1607", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwNTg5Mg==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r530105892", "bodyText": "A better name? \"findOnChainPrivacyGroupAndAddNewMembers\"?", "author": "pinges", "createdAt": "2020-11-25T04:48:09Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java", "diffHunk": "@@ -312,7 +324,7 @@ public long determineBesuNonce(\n   }\n \n   @Override\n-  public Optional<PrivacyGroup> retrieveOnChainPrivacyGroupWithToBeAddedMembers(\n+  public Optional<PrivacyGroup> findOnChainPrivacyGroupWithToBeAddedMembers(", "originalCommit": "8ec7c977ed2f1a76d3fd40c5ee9d4c168ed78b77", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ff09f3c24b93c110f8055adc22e6175217889a11", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\nindex c453542cc..58fb15eec 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\n\n@@ -324,7 +327,7 @@ public class DefaultPrivacyController implements PrivacyController {\n   }\n \n   @Override\n-  public Optional<PrivacyGroup> findOnChainPrivacyGroupWithToBeAddedMembers(\n+  public Optional<PrivacyGroup> findOnChainPrivacyGroupAndAddNewMembers(\n       final Bytes privacyGroupId,\n       final String enclavePublicKey,\n       final PrivateTransaction privateTransaction) {\n"}}, {"oid": "a7331e9e28b298ddd0d4dc53000a3d1784e10c17", "url": "https://github.com/hyperledger/besu/commit/a7331e9e28b298ddd0d4dc53000a3d1784e10c17", "message": "priv_debugGetStateRoot bug refactorings.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-01T04:25:38Z", "type": "commit"}, {"oid": "6a6f15f01d693f129bddf86f1eb371a4d180466a", "url": "https://github.com/hyperledger/besu/commit/6a6f15f01d693f129bddf86f1eb371a4d180466a", "message": "Offchain acceptance test.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-01T04:25:38Z", "type": "commit"}, {"oid": "8cdfa78bc6682ca06977e85abaee79d4645d6900", "url": "https://github.com/hyperledger/besu/commit/8cdfa78bc6682ca06977e85abaee79d4645d6900", "message": "Fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-01T04:25:38Z", "type": "commit"}, {"oid": "d92a1dcef953aab5524724f823e61bc32c78f02a", "url": "https://github.com/hyperledger/besu/commit/d92a1dcef953aab5524724f823e61bc32c78f02a", "message": "Fix2.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-01T04:46:49Z", "type": "commit"}, {"oid": "d92a1dcef953aab5524724f823e61bc32c78f02a", "url": "https://github.com/hyperledger/besu/commit/d92a1dcef953aab5524724f823e61bc32c78f02a", "message": "Fix2.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-01T04:46:49Z", "type": "forcePushed"}, {"oid": "dd4469bfee2200549edb736a6a4d4194362fa1f1", "url": "https://github.com/hyperledger/besu/commit/dd4469bfee2200549edb736a6a4d4194362fa1f1", "message": "Build fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T01:40:18Z", "type": "commit"}, {"oid": "2c2253c2ca890fb9a4f789afd147a0926705d75f", "url": "https://github.com/hyperledger/besu/commit/2c2253c2ca890fb9a4f789afd147a0926705d75f", "message": "Test fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T02:14:49Z", "type": "commit"}, {"oid": "58066a2ac3b3767e7454e0c4d3a7ccfad6de46b0", "url": "https://github.com/hyperledger/besu/commit/58066a2ac3b3767e7454e0c4d3a7ccfad6de46b0", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-02T09:54:42Z", "type": "commit"}, {"oid": "d1d9e9c1007c373b7c6956430a211020f2b066ae", "url": "https://github.com/hyperledger/besu/commit/d1d9e9c1007c373b7c6956430a211020f2b066ae", "message": "Onchain privacy group stateroot AT.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T12:39:03Z", "type": "commit"}, {"oid": "8adef126a6bdfbd1032ee991c353b5f7de094c5a", "url": "https://github.com/hyperledger/besu/commit/8adef126a6bdfbd1032ee991c353b5f7de094c5a", "message": "Test fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T12:59:15Z", "type": "commit"}, {"oid": "69b6e37728f7d34cfa27915999236cf1650e061b", "url": "https://github.com/hyperledger/besu/commit/69b6e37728f7d34cfa27915999236cf1650e061b", "message": "Added blockparam test.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T13:42:21Z", "type": "commit"}, {"oid": "ff09f3c24b93c110f8055adc22e6175217889a11", "url": "https://github.com/hyperledger/besu/commit/ff09f3c24b93c110f8055adc22e6175217889a11", "message": "PR fix - updated method name.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T13:45:31Z", "type": "commit"}, {"oid": "153009e70450a95d4cb354b2ea10f7b8b93d6c0a", "url": "https://github.com/hyperledger/besu/commit/153009e70450a95d4cb354b2ea10f7b8b93d6c0a", "message": "AT fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-02T23:05:55Z", "type": "commit"}, {"oid": "975904631a9eefa41cf5b3ff693d369e61a27060", "url": "https://github.com/hyperledger/besu/commit/975904631a9eefa41cf5b3ff693d369e61a27060", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-02T23:08:02Z", "type": "commit"}, {"oid": "028a8ac116d17a75692bd6e52101503831fce880", "url": "https://github.com/hyperledger/besu/commit/028a8ac116d17a75692bd6e52101503831fce880", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-03T02:59:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2NzA1Nw==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r534667057", "bodyText": "This has the same effect as using a const hash like Hash.ZERO", "author": "pinges", "createdAt": "2020-12-03T04:52:28Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOffchainGroupAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.privacy;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.PrivacyAcceptanceTestBase;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.PrivacyNode;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.account.PrivacyAccountResolver;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivacyRequestFactory;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class PrivDebugGetStateRootOffchainGroupAcceptanceTest extends PrivacyAcceptanceTestBase {\n+\n+  private PrivacyNode aliceNode;\n+  private PrivacyNode bobNode;\n+\n+  @Before\n+  public void setUp() throws IOException, URISyntaxException {\n+    aliceNode =\n+        privacyBesu.createPrivateTransactionEnabledMinerNode(\n+            \"alice-node\", PrivacyAccountResolver.ALICE);\n+    bobNode =\n+        privacyBesu.createPrivateTransactionEnabledMinerNode(\n+            \"bob-node\", PrivacyAccountResolver.BOB);\n+    privacyCluster.start(aliceNode, bobNode);\n+  }\n+\n+  @Test\n+  public void nodesInGroupShouldHaveSameStateRoot() {\n+    final String privacyGroupId =\n+        aliceNode.execute(\n+            privacyTransactions.createPrivacyGroup(\n+                \"testGroup\", \"A group for everyone\", aliceNode, bobNode));\n+\n+    final Hash aliceStateRootId =\n+        aliceNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    final Hash bobStateRootId =\n+        bobNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n+  }\n+\n+  @Test\n+  public void nodeNotInGroupShouldReturnError() {\n+    final String privacyGroupId =\n+        aliceNode.execute(\n+            privacyTransactions.createPrivacyGroup(\"testGroup\", \"A group for Alice\", aliceNode));\n+\n+    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n+        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n+\n+    assertThat(aliceResult.hasError()).isFalse();\n+    assertThat(aliceResult.getResult()).isNotNull();\n+    assertThat(aliceResult.getResult()).isInstanceOf(Hash.class);\n+\n+    final PrivacyRequestFactory.DebugGetStateRoot bobResult =\n+        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n+\n+    assertThat(bobResult.getResult()).isNull();\n+    assertThat(bobResult.hasError()).isTrue();\n+    assertThat(bobResult.getError()).isNotNull();\n+    assertThat(bobResult.getError().getMessage()).contains(\"Error finding privacy group\");\n+  }\n+\n+  @Test\n+  public void unknownGroupShouldReturnError() {\n+    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n+        aliceNode.execute(\n+            privacyTransactions.debugGetStateRoot(\n+                Hash.wrap(Bytes32.random()).toBase64String(), \"latest\"));", "originalCommit": "028a8ac116d17a75692bd6e52101503831fce880", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ef7295737c653128469d6de86b969c32700f85f", "chunk": "diff --git a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOffchainGroupAcceptanceTest.java b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOffchainGroupAcceptanceTest.java\nindex f1fe82fb6..7570bdf12 100644\n--- a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOffchainGroupAcceptanceTest.java\n+++ b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOffchainGroupAcceptanceTest.java\n\n@@ -65,28 +65,6 @@ public class PrivDebugGetStateRootOffchainGroupAcceptanceTest extends PrivacyAcc\n     assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n   }\n \n-  @Test\n-  public void nodeNotInGroupShouldReturnError() {\n-    final String privacyGroupId =\n-        aliceNode.execute(\n-            privacyTransactions.createPrivacyGroup(\"testGroup\", \"A group for Alice\", aliceNode));\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n-        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(aliceResult.hasError()).isFalse();\n-    assertThat(aliceResult.getResult()).isNotNull();\n-    assertThat(aliceResult.getResult()).isInstanceOf(Hash.class);\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot bobResult =\n-        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(bobResult.getResult()).isNull();\n-    assertThat(bobResult.hasError()).isTrue();\n-    assertThat(bobResult.getError()).isNotNull();\n-    assertThat(bobResult.getError().getMessage()).contains(\"Error finding privacy group\");\n-  }\n-\n   @Test\n   public void unknownGroupShouldReturnError() {\n     final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2ODgwMw==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r534668803", "bodyText": "This is really testing that you get an error for a privacy group that does not exist (on the node where you are calling the method) You could just use a const/random privacyGroupId ...\nI think that is the same with the off chain AT ...\nThinking about it, this is really the same test as the next one (unknownGroup...)", "author": "pinges", "createdAt": "2020-12-03T04:57:58Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.privacy;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.PrivacyNode;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.account.PrivacyAccountResolver;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivacyRequestFactory;\n+import org.hyperledger.besu.tests.web3j.privacy.OnChainPrivacyAcceptanceTestBase;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class PrivDebugGetStateRootOnchainGroupAcceptanceTest\n+    extends OnChainPrivacyAcceptanceTestBase {\n+\n+  private PrivacyNode aliceNode;\n+  private PrivacyNode bobNode;\n+\n+  @Before\n+  public void setUp() throws IOException, URISyntaxException {\n+    aliceNode =\n+        privacyBesu.createOnChainPrivacyGroupEnabledMinerNode(\n+            \"alice-node\", PrivacyAccountResolver.ALICE, Address.PRIVACY, false);\n+    bobNode =\n+        privacyBesu.createOnChainPrivacyGroupEnabledMinerNode(\n+            \"bob-node\", PrivacyAccountResolver.BOB, Address.PRIVACY, false);\n+    privacyCluster.start(aliceNode, bobNode);\n+  }\n+\n+  @Test\n+  public void nodesInGroupShouldHaveSameStateRoot() {\n+    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode, bobNode);\n+\n+    final Hash aliceStateRootId =\n+        aliceNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    final Hash bobStateRootId =\n+        bobNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n+  }\n+\n+  @Test\n+  public void nodesNotInGroupShouldReturnError() {", "originalCommit": "028a8ac116d17a75692bd6e52101503831fce880", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI0MjIzNw==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537242237", "bodyText": "I think you're right. Will remove.", "author": "mark-terry", "createdAt": "2020-12-07T05:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2ODgwMw=="}], "type": "inlineReview", "revised_code": {"commit": "1ef7295737c653128469d6de86b969c32700f85f", "chunk": "diff --git a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\nindex aef459f34..d5dfc9f25 100644\n--- a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\n+++ b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\n\n@@ -64,26 +64,6 @@ public class PrivDebugGetStateRootOnchainGroupAcceptanceTest\n     assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n   }\n \n-  @Test\n-  public void nodesNotInGroupShouldReturnError() {\n-    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode);\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n-        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(aliceResult.hasError()).isFalse();\n-    assertThat(aliceResult.getResult()).isNotNull();\n-    assertThat(aliceResult.getResult()).isInstanceOf(Hash.class);\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot bobResult =\n-        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(bobResult.getResult()).isNull();\n-    assertThat(bobResult.hasError()).isTrue();\n-    assertThat(bobResult.getError()).isNotNull();\n-    assertThat(bobResult.getError().getMessage()).contains(\"Error finding privacy group\");\n-  }\n-\n   @Test\n   public void unknownGroupShouldReturnError() {\n     final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MDY2OA==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r534670668", "bodyText": "What does it return? I really like this test, because it makes me wonder what result we do expect for a privacyGroup that has not yet existed at that block hight ....", "author": "pinges", "createdAt": "2020-12-03T05:04:01Z", "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.tests.acceptance.privacy;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.PrivacyNode;\n+import org.hyperledger.besu.tests.acceptance.dsl.privacy.account.PrivacyAccountResolver;\n+import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivacyRequestFactory;\n+import org.hyperledger.besu.tests.web3j.privacy.OnChainPrivacyAcceptanceTestBase;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+\n+import org.apache.tuweni.bytes.Bytes32;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class PrivDebugGetStateRootOnchainGroupAcceptanceTest\n+    extends OnChainPrivacyAcceptanceTestBase {\n+\n+  private PrivacyNode aliceNode;\n+  private PrivacyNode bobNode;\n+\n+  @Before\n+  public void setUp() throws IOException, URISyntaxException {\n+    aliceNode =\n+        privacyBesu.createOnChainPrivacyGroupEnabledMinerNode(\n+            \"alice-node\", PrivacyAccountResolver.ALICE, Address.PRIVACY, false);\n+    bobNode =\n+        privacyBesu.createOnChainPrivacyGroupEnabledMinerNode(\n+            \"bob-node\", PrivacyAccountResolver.BOB, Address.PRIVACY, false);\n+    privacyCluster.start(aliceNode, bobNode);\n+  }\n+\n+  @Test\n+  public void nodesInGroupShouldHaveSameStateRoot() {\n+    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode, bobNode);\n+\n+    final Hash aliceStateRootId =\n+        aliceNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    final Hash bobStateRootId =\n+        bobNode\n+            .execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"))\n+            .getResult();\n+\n+    assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n+  }\n+\n+  @Test\n+  public void nodesNotInGroupShouldReturnError() {\n+    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode);\n+\n+    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n+        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n+\n+    assertThat(aliceResult.hasError()).isFalse();\n+    assertThat(aliceResult.getResult()).isNotNull();\n+    assertThat(aliceResult.getResult()).isInstanceOf(Hash.class);\n+\n+    final PrivacyRequestFactory.DebugGetStateRoot bobResult =\n+        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n+\n+    assertThat(bobResult.getResult()).isNull();\n+    assertThat(bobResult.hasError()).isTrue();\n+    assertThat(bobResult.getError()).isNotNull();\n+    assertThat(bobResult.getError().getMessage()).contains(\"Error finding privacy group\");\n+  }\n+\n+  @Test\n+  public void unknownGroupShouldReturnError() {\n+    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n+        aliceNode.execute(\n+            privacyTransactions.debugGetStateRoot(\n+                Hash.wrap(Bytes32.random()).toBase64String(), \"latest\"));\n+\n+    assertThat(aliceResult.getResult()).isNull();\n+    assertThat(aliceResult.hasError()).isTrue();\n+    assertThat(aliceResult.getError()).isNotNull();\n+    assertThat(aliceResult.getError().getMessage()).contains(\"Error finding privacy group\");\n+  }\n+\n+  @Test\n+  public void blockParamShouldBeApplied() {\n+    waitForBlockHeight(aliceNode, 2);\n+    waitForBlockHeight(bobNode, 2);\n+\n+    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode, bobNode);\n+\n+    waitForBlockHeight(aliceNode, 10);\n+    waitForBlockHeight(bobNode, 10);\n+\n+    final Hash aliceResult1 =\n+        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"1\")).getResult();\n+    final Hash bobResultInt1 =\n+        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"1\")).getResult();\n+\n+    assertThat(aliceResult1).isEqualTo(bobResultInt1);", "originalCommit": "028a8ac116d17a75692bd6e52101503831fce880", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgzOTY0Mg==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r535839642", "bodyText": "A consistent Hash is returned until some block after the group has been created. Seems, if the requested block is before group creation, it looks back to the earliest state root.", "author": "mark-terry", "createdAt": "2020-12-04T05:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3MDY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "1ef7295737c653128469d6de86b969c32700f85f", "chunk": "diff --git a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\nindex aef459f34..d5dfc9f25 100644\n--- a/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\n+++ b/acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/privacy/PrivDebugGetStateRootOnchainGroupAcceptanceTest.java\n\n@@ -64,26 +64,6 @@ public class PrivDebugGetStateRootOnchainGroupAcceptanceTest\n     assertThat(aliceStateRootId).isEqualTo(bobStateRootId);\n   }\n \n-  @Test\n-  public void nodesNotInGroupShouldReturnError() {\n-    final String privacyGroupId = createOnChainPrivacyGroup(aliceNode);\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n-        aliceNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(aliceResult.hasError()).isFalse();\n-    assertThat(aliceResult.getResult()).isNotNull();\n-    assertThat(aliceResult.getResult()).isInstanceOf(Hash.class);\n-\n-    final PrivacyRequestFactory.DebugGetStateRoot bobResult =\n-        bobNode.execute(privacyTransactions.debugGetStateRoot(privacyGroupId, \"latest\"));\n-\n-    assertThat(bobResult.getResult()).isNull();\n-    assertThat(bobResult.hasError()).isTrue();\n-    assertThat(bobResult.getError()).isNotNull();\n-    assertThat(bobResult.getError().getMessage()).contains(\"Error finding privacy group\");\n-  }\n-\n   @Test\n   public void unknownGroupShouldReturnError() {\n     final PrivacyRequestFactory.DebugGetStateRoot aliceResult =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY4NzUxMA==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r534687510", "bodyText": "Why are we doing all that findPrivacyGroup  business when we are not using the privacy group later on? Is that necessary so that we fail with the right error message?", "author": "pinges", "createdAt": "2020-12-03T05:43:42Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivDebugGetStateRoot.java", "diffHunk": "@@ -68,13 +69,19 @@ protected Object resultByBlockNumber(\n         enclavePublicKeyProvider.getEnclaveKey(requestContext.getUser());\n     LOG.trace(\"Executing {}\", this::getName);\n \n-    final PrivacyGroup[] privacyGroups =\n-        privacyController.findPrivacyGroup(\n-            Collections.singletonList(privacyGroupId),\n-            enclavePublicKeyProvider.getEnclaveKey(requestContext.getUser()));\n+    final Optional<PrivacyGroup> privacyGroup;", "originalCommit": "028a8ac116d17a75692bd6e52101503831fce880", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgzNzgyMA==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r535837820", "bodyText": "To provide better feedback about the RPC parameters. Here we should catch: incorrect privacyGroupId, multi-tenancy validation problems, other invalid/incorrect parameter issues.\nThe error branch when the response returns will only be triggered if there's a problem retrieving the stateRoot, which, at that point, shouldn't be related to the RPC params... That return code could probably be improved.", "author": "mark-terry", "createdAt": "2020-12-04T05:02:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY4NzUxMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1ef7295737c653128469d6de86b969c32700f85f", "url": "https://github.com/hyperledger/besu/commit/1ef7295737c653128469d6de86b969c32700f85f", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-07T05:36:22Z", "type": "commit"}, {"oid": "ebc3cb69ac787643532966990a66247d11891336", "url": "https://github.com/hyperledger/besu/commit/ebc3cb69ac787643532966990a66247d11891336", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-07T05:37:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDMwNQ==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537250305", "bodyText": "should this be findOffChainPrivacyGroupByGroupId?", "author": "macfarla", "createdAt": "2020-12-07T05:58:46Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java", "diffHunk": "@@ -259,13 +260,25 @@ public long determineBesuNonce(\n   }\n \n   @Override\n-  public Optional<PrivacyGroup> retrieveOffChainPrivacyGroup(\n+  public Optional<PrivacyGroup> findPrivacyGroupByGroupId(", "originalCommit": "ebc3cb69ac787643532966990a66247d11891336", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MzQ0MQ==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537253441", "bodyText": "This method is checking both on and off chain groups. It first checks the offchain, then tries onchain if the enclave indicates the offchain group doesn't exist (via an exception.) This is to cover the case where both offchain and flexible privacy groups are enabled.", "author": "mark-terry", "createdAt": "2020-12-07T06:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDMwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NTM2OA==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537885368", "bodyText": "got it", "author": "macfarla", "createdAt": "2020-12-07T22:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDMwNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDU2NQ==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537250565", "bodyText": "should this be findOffChainPrivacyGroupByMembers?", "author": "macfarla", "createdAt": "2020-12-07T05:59:35Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java", "diffHunk": "@@ -47,7 +47,7 @@ PrivacyGroup createPrivacyGroup(\n \n   String deletePrivacyGroup(String privacyGroupId, String enclavePublicKey);\n \n-  PrivacyGroup[] findPrivacyGroup(List<String> addresses, String enclavePublicKey);\n+  PrivacyGroup[] findPrivacyGroupByMembers(List<String> addresses, String enclavePublicKey);", "originalCommit": "ebc3cb69ac787643532966990a66247d11891336", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8d6e44d04a7912fc404320406ddf46e2b2e90356", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java\nindex 42a89d131..3d6b0cb7d 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java\n\n@@ -47,7 +47,7 @@ public interface PrivacyController {\n \n   String deletePrivacyGroup(String privacyGroupId, String enclavePublicKey);\n \n-  PrivacyGroup[] findPrivacyGroupByMembers(List<String> addresses, String enclavePublicKey);\n+  PrivacyGroup[] findOffChainPrivacyGroupByMembers(List<String> addresses, String enclavePublicKey);\n \n   Transaction createPrivacyMarkerTransaction(\n       String privateTransactionLookupId, PrivateTransaction privateTransaction);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDc5Mw==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537250793", "bodyText": "should this be findOnChainPrivacyGroupByGroupId?", "author": "macfarla", "createdAt": "2020-12-07T06:00:14Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivacyController.java", "diffHunk": "@@ -74,17 +74,21 @@ long determineEeaNonce(\n   Optional<String> buildAndSendAddPayload(\n       PrivateTransaction privateTransaction, Bytes32 privacyGroupId, String enclaveKey);\n \n-  Optional<PrivacyGroup> retrieveOffChainPrivacyGroup(String toBase64String, String enclaveKey);\n+  Optional<PrivacyGroup> findOffChainPrivacyGroupByGroupId(\n+      String toBase64String, String enclaveKey);\n \n-  List<PrivacyGroup> findOnChainPrivacyGroup(List<String> asList, String enclaveKey);\n+  Optional<PrivacyGroup> findPrivacyGroupByGroupId(", "originalCommit": "ebc3cb69ac787643532966990a66247d11891336", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1NTExOQ==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537255119", "bodyText": "See reply from earlier. The findOnChainPrivacyGroupByGroupId is in the implementation, not the interface.", "author": "mark-terry", "createdAt": "2020-12-07T06:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg4NTUzMw==", "url": "https://github.com/hyperledger/besu/pull/1607#discussion_r537885533", "bodyText": "\ud83d\udc4d", "author": "macfarla", "createdAt": "2020-12-07T22:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MDc5Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "8d6e44d04a7912fc404320406ddf46e2b2e90356", "url": "https://github.com/hyperledger/besu/commit/8d6e44d04a7912fc404320406ddf46e2b2e90356", "message": "Test fix.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>", "committedDate": "2020-12-07T10:49:10Z", "type": "commit"}, {"oid": "952947a6c5d66a0ebc3d9daf04ca3c7d35e8c01b", "url": "https://github.com/hyperledger/besu/commit/952947a6c5d66a0ebc3d9daf04ca3c7d35e8c01b", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-08T03:32:04Z", "type": "commit"}, {"oid": "6cf833d234284f6ce34a8cd6b701094ec8003126", "url": "https://github.com/hyperledger/besu/commit/6cf833d234284f6ce34a8cd6b701094ec8003126", "message": "Merge branch 'master' into 1596", "committedDate": "2020-12-08T03:38:54Z", "type": "commit"}]}