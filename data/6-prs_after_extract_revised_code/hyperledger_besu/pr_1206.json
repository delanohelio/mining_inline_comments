{"pr_number": 1206, "pr_title": "Fix #1110: Privacy: Restart caused by insufficient memory can cause inconsistent private state", "pr_createdAt": "2020-07-09T01:30:48Z", "pr_url": "https://github.com/hyperledger/besu/pull/1206", "timeline": [{"oid": "040101fd3012956e22836ee23ccda1002f88e5fb", "url": "https://github.com/hyperledger/besu/commit/040101fd3012956e22836ee23ccda1002f88e5fb", "message": "Fix #1110: Privacy: Restart caused by insufficient memory can cause inconsistent private state\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-07-09T01:25:26Z", "type": "commit"}, {"oid": "fb119153d9ccf221a221373d431c2d1612b728d4", "url": "https://github.com/hyperledger/besu/commit/fb119153d9ccf221a221373d431c2d1612b728d4", "message": "merge and fix conflicts\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-07-09T01:42:59Z", "type": "commit"}, {"oid": "7cf16cc3d518c3b6c415490e32fda71731b6f6c2", "url": "https://github.com/hyperledger/besu/commit/7cf16cc3d518c3b6c415490e32fda71731b6f6c2", "message": "fix spotless, TODO, and test/resources\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-07-09T03:33:20Z", "type": "commit"}, {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36", "url": "https://github.com/hyperledger/besu/commit/0f20be36f5fba178070cf0c8918fc249f624ac36", "message": "Merge branch 'master' into reorgBug", "committedDate": "2020-07-09T23:25:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0NjMxMQ==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454646311", "bodyText": "Should this ever happen? If we have a hash on our PrivacyGroupHeadBlockMap, we should always find the state root for it, should we?\nMaybe this should throw an error.", "author": "lucassaldanha", "createdAt": "2020-07-14T21:08:35Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java", "diffHunk": "@@ -33,6 +34,26 @@ public PrivateStateRootResolver(final PrivateStateStorage privateStateStorage) {\n     this.privateStateStorage = privateStateStorage;\n   }\n \n+  public Hash resolveLastStateRoot(\n+      final Bytes32 privacyGroupId, final PrivateMetadataUpdater privateMetadataUpdater) {\n+    final PrivateBlockMetadata privateBlockMetadata =\n+        privateMetadataUpdater.getPrivateBlockMetadata(privacyGroupId);\n+    if (privateBlockMetadata != null) {\n+      return privateBlockMetadata.getLatestStateRoot().get();\n+    } else {\n+      final Hash blockHashForLastBlockWithTx =\n+          privateMetadataUpdater.getPrivacyGroupHeadBlockMap().get(privacyGroupId);\n+      if (blockHashForLastBlockWithTx != null) {\n+        return privateStateStorage\n+            .getPrivateBlockMetadata(blockHashForLastBlockWithTx, privacyGroupId)\n+            .flatMap(PrivateBlockMetadata::getLatestStateRoot)\n+            .orElse(EMPTY_ROOT_HASH);", "originalCommit": "0f20be36f5fba178070cf0c8918fc249f624ac36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4ODY4Mw==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454688683", "bodyText": "You are right. Copied that from the original method without questioning it. Will fix both!", "author": "pinges", "createdAt": "2020-07-14T22:48:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0NjMxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "842d29367de124f89bb7547b4209177002663107", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java\nindex b410ef3a04..2a64a13d7c 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java\n\n@@ -47,7 +47,11 @@ public class PrivateStateRootResolver {\n         return privateStateStorage\n             .getPrivateBlockMetadata(blockHashForLastBlockWithTx, privacyGroupId)\n             .flatMap(PrivateBlockMetadata::getLatestStateRoot)\n-            .orElse(EMPTY_ROOT_HASH);\n+            .orElseThrow(\n+                () ->\n+                    new RuntimeException(\n+                        \"Privacy inconsistent state: PrivateBlockMetadata does not exist for Block \"\n+                            + blockHashForLastBlockWithTx));\n       } else {\n         return EMPTY_ROOT_HASH;\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MDkwMA==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454650900", "bodyText": "I don't think I understand why we need this if statement. Is this because for each new block we need a new PrivateMetadataUpdater, and not reuse a previous one?", "author": "lucassaldanha", "createdAt": "2020-07-14T21:17:32Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/PrivacyBlockProcessor.java", "diffHunk": "@@ -79,20 +80,23 @@ public Result processBlock(\n       final MutableWorldState worldState,\n       final BlockHeader blockHeader,\n       final List<Transaction> transactions,\n-      final List<BlockHeader> ommers) {\n+      final List<BlockHeader> ommers,\n+      final PrivateMetadataUpdater privateMetadataUpdater) {\n+\n+    if (privateMetadataUpdater != null) {", "originalCommit": "0f20be36f5fba178070cf0c8918fc249f624ac36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4NDU5OA==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454684598", "bodyText": "I wasn't hundred percent sure either. But for every block that we are processing we do need a new PrivateMetadataUpdater. We are instantiating one in this block processor that is wrapping the public block processor.\nIf there was an updater passed in I thought that something must have gone wrong ...", "author": "pinges", "createdAt": "2020-07-14T22:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MDkwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MjM5MQ==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454652391", "bodyText": "At this point, has Besu already commit the changes in public world state?", "author": "lucassaldanha", "createdAt": "2020-07-14T21:20:36Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/PrivacyBlockProcessor.java", "diffHunk": "@@ -79,20 +80,23 @@ public Result processBlock(\n       final MutableWorldState worldState,\n       final BlockHeader blockHeader,\n       final List<Transaction> transactions,\n-      final List<BlockHeader> ommers) {\n+      final List<BlockHeader> ommers,\n+      final PrivateMetadataUpdater privateMetadataUpdater) {\n+\n+    if (privateMetadataUpdater != null) {\n+      throw new IllegalArgumentException(\"PrivateMetadataUpdater passed in is not null.\");\n+    }\n \n     maybeRehydrate(blockchain, blockHeader, transactions);\n \n-    final PrivacyGroupHeadBlockMap privacyGroupHeadBlockMap =\n-        new PrivacyGroupHeadBlockMap(\n-            privateStateStorage\n-                .getPrivacyGroupHeadBlockMap(blockHeader.getParentHash())\n-                .orElse(PrivacyGroupHeadBlockMap.EMPTY));\n-    privateStateStorage\n-        .updater()\n-        .putPrivacyGroupHeadBlockMap(blockHeader.getHash(), privacyGroupHeadBlockMap)\n-        .commit();\n-    return blockProcessor.processBlock(blockchain, worldState, blockHeader, transactions, ommers);\n+    final PrivateMetadataUpdater metadataUpdater =\n+        new PrivateMetadataUpdater(blockHeader, privateStateStorage);\n+\n+    final Result result =\n+        blockProcessor.processBlock(\n+            blockchain, worldState, blockHeader, transactions, ommers, metadataUpdater);\n+    metadataUpdater.commit();", "originalCommit": "0f20be36f5fba178070cf0c8918fc249f624ac36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY4MjI2Mg==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454682262", "bodyText": "Yes, the public changes have been commited at the end of the wrapped block processor.", "author": "pinges", "createdAt": "2020-07-14T22:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MjM5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg2NjUyOQ==", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r479866529", "bodyText": "... but the block has not been added to the chain yet. That is happening later.", "author": "pinges", "createdAt": "2020-08-31T03:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MjM5MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c861fd61e22453a92faead70b75a1fb35d6af711", "url": "https://github.com/hyperledger/besu/commit/c861fd61e22453a92faead70b75a1fb35d6af711", "message": "Merge branch 'master' of github.com:hyperledger/besu into reorgBug", "committedDate": "2020-07-14T22:51:13Z", "type": "commit"}, {"oid": "842d29367de124f89bb7547b4209177002663107", "url": "https://github.com/hyperledger/besu/commit/842d29367de124f89bb7547b4209177002663107", "message": "fix after review\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-07-15T02:33:53Z", "type": "commit"}, {"oid": "601b4361d77c0413c6ba9747aab985446f7e7177", "url": "https://github.com/hyperledger/besu/commit/601b4361d77c0413c6ba9747aab985446f7e7177", "message": "fix unit test\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-07-16T02:45:48Z", "type": "commit"}, {"oid": "a05dc59d6e34efc396f1de7c3c460c35b42cab8a", "url": "https://github.com/hyperledger/besu/commit/a05dc59d6e34efc396f1de7c3c460c35b42cab8a", "message": "Merge branch 'master' into reorgBug", "committedDate": "2020-07-16T03:51:40Z", "type": "commit"}, {"oid": "32fbfcc5284dd9c6e31fa185688660e2dae4498d", "url": "https://github.com/hyperledger/besu/commit/32fbfcc5284dd9c6e31fa185688660e2dae4498d", "message": "merge into master\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>", "committedDate": "2020-08-31T00:53:28Z", "type": "commit"}, {"oid": "ca7856f3886acedf0db0c1beffa0abc5bd695bff", "url": "https://github.com/hyperledger/besu/commit/ca7856f3886acedf0db0c1beffa0abc5bd695bff", "message": "Merge branch 'master' of github.com:hyperledger/besu into reorgBug", "committedDate": "2020-08-31T00:54:03Z", "type": "commit"}, {"oid": "cda381d2e23198d4b502d9d6ba67bb820f6f235e", "url": "https://github.com/hyperledger/besu/commit/cda381d2e23198d4b502d9d6ba67bb820f6f235e", "message": "Merge branch 'reorgBug' of github.com:pinges/besu into reorgBug", "committedDate": "2020-08-31T00:55:22Z", "type": "commit"}, {"oid": "91898fc0f37e42054f0a5abf0db266f600f5ba41", "url": "https://github.com/hyperledger/besu/commit/91898fc0f37e42054f0a5abf0db266f600f5ba41", "message": "Merge branch 'master' into reorgBug", "committedDate": "2020-08-31T03:46:54Z", "type": "commit"}]}