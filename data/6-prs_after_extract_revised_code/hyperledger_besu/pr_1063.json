{"pr_number": 1063, "pr_title": "[BESU-1919] Add proper support for eth_hashrate", "pr_createdAt": "2020-06-09T14:44:25Z", "pr_url": "https://github.com/hyperledger/besu/pull/1063", "timeline": [{"oid": "50f331f7e456a8a3f0ec7777522e7b079bee7238", "url": "https://github.com/hyperledger/besu/commit/50f331f7e456a8a3f0ec7777522e7b079bee7238", "message": "add eth_submithashrate implementation\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T13:17:58Z", "type": "commit"}, {"oid": "d23c690f6edb7a9442f9dc2f61977ceaf004d8d9", "url": "https://github.com/hyperledger/besu/commit/d23c690f6edb7a9442f9dc2f61977ceaf004d8d9", "message": "add missing files\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T13:24:55Z", "type": "commit"}, {"oid": "988ce6080b37b17cc1d393533d79502a9a36813d", "url": "https://github.com/hyperledger/besu/commit/988ce6080b37b17cc1d393533d79502a9a36813d", "message": "remove useless modification\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T14:39:59Z", "type": "commit"}, {"oid": "628602aaa36b772f5b71b7cabd9413d551bac341", "url": "https://github.com/hyperledger/besu/commit/628602aaa36b772f5b71b7cabd9413d551bac341", "message": "add test for stratum\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T15:27:54Z", "type": "commit"}, {"oid": "4592ef6b0e910947410b3d46f62a81b046853987", "url": "https://github.com/hyperledger/besu/commit/4592ef6b0e910947410b3d46f62a81b046853987", "message": "spotless apply\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T15:32:40Z", "type": "commit"}, {"oid": "08e5280bf803854511e59f135765e123dfb2c010", "url": "https://github.com/hyperledger/besu/commit/08e5280bf803854511e59f135765e123dfb2c010", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T15:38:07Z", "type": "commit"}, {"oid": "93d48dd7f208ca4db311fbb6c5472c911191e3ac", "url": "https://github.com/hyperledger/besu/commit/93d48dd7f208ca4db311fbb6c5472c911191e3ac", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T15:39:57Z", "type": "commit"}, {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65", "url": "https://github.com/hyperledger/besu/commit/973e240f831ebc2462ae68ff6c64a574fd758e65", "message": "fix merge issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-09T15:52:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDU4NA==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438974584", "bodyText": "Let's make this an --X option for the first few releases.  We can promote it later, but because this becomes part of the public API I want to have a window where it can be easily changed.", "author": "shemnon", "createdAt": "2020-06-11T18:02:23Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -724,6 +724,12 @@ void setBannedNodeIds(final List<String> values) {\n       description = \"Stratum port binding (default: ${DEFAULT-VALUE})\")\n   private final Integer stratumPort = 8008;\n \n+  @Option(\n+      names = {\"--miner-remote-sealers-limit\"},", "originalCommit": "973e240f831ebc2462ae68ff6c64a574fd758e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNTIwMA==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439535200", "bodyText": "Done", "author": "matkt", "createdAt": "2020-06-12T16:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\nindex bfc48c0f8d..2817dfd995 100644\n--- a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n+++ b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n\n@@ -725,7 +725,7 @@ public class BesuCommand implements DefaultCommandValues, Runnable {\n   private final Integer stratumPort = 8008;\n \n   @Option(\n-      names = {\"--miner-remote-sealers-limit\"},\n+      names = {\"--Xminer-remote-sealers-limit\"},\n       description =\n           \"Limits the number of remote sealers that can submit their hashrates (default: ${DEFAULT-VALUE})\")\n   private final Integer remoteSealersLimit = 1000;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3ODMyOA==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438978328", "bodyText": "I think a guava cache may be more appropriate for this particular data set https://github.com/google/guava/wiki/CachesExplained - we can set the max size via the flag and we can expire values after a certain time.  Which given miners come and go I think is a good thing.  Perhaps 10 minutes?  Also set by a flag like the max cache size.", "author": "shemnon", "createdAt": "2020-06-11T18:09:10Z", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -40,6 +44,8 @@\n         M extends BlockMiner<? extends AbstractBlockCreator>>\n     implements BlockAddedObserver, MiningCoordinator {\n \n+  private final Map<String, SealerInfo> sealerInfos;", "originalCommit": "973e240f831ebc2462ae68ff6c64a574fd758e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNTY4MQ==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439535681", "bodyText": "Done. The new policy is to delete after 10 minutes of inactivity. And the limit is by default 1000 but configurable via the CLI", "author": "matkt", "createdAt": "2020-06-12T16:55:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3ODMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNjA0OQ==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439536049", "bodyText": "I forgot I just need to add the CLI flag for TTL", "author": "matkt", "createdAt": "2020-06-12T16:56:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3ODMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTYwMDQyNw==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439600427", "bodyText": "Done you need to use --Xminer-remote-sealers-hashrate-ttl=10(default 10 minutes)", "author": "matkt", "createdAt": "2020-06-12T19:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3ODMyOA=="}], "type": "inlineReview", "revised_code": {"commit": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "chunk": "diff --git a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\nindex d6f809b9bd..834ac1ee0e 100644\n--- a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\n+++ b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\n\n@@ -44,8 +40,6 @@ public abstract class AbstractMiningCoordinator<\n         M extends BlockMiner<? extends AbstractBlockCreator>>\n     implements BlockAddedObserver, MiningCoordinator {\n \n-  private final Map<String, SealerInfo> sealerInfos;\n-\n   private enum State {\n     IDLE,\n     RUNNING,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzA3OQ==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438983079", "bodyText": "I think it would be better to move all the logic around submitting hashrate and storing the sealerInfo down into the EthashMiningCoordinator.  IBFT and Clique will never use these.", "author": "shemnon", "createdAt": "2020-06-11T18:18:02Z", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -215,4 +232,28 @@ public void setExtraData(final Bytes extraData) {\n \n   protected abstract boolean newChainHeadInvalidatesMiningOperation(\n       final BlockHeader newChainHeadHeader);\n+\n+  @Override\n+  public Map<String, SealerInfo> getSealerInfos() {", "originalCommit": "973e240f831ebc2462ae68ff6c64a574fd758e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNjE4Nw==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439536187", "bodyText": "Done", "author": "matkt", "createdAt": "2020-06-12T16:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "chunk": "diff --git a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\nindex d6f809b9bd..834ac1ee0e 100644\n--- a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\n+++ b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java\n\n@@ -232,28 +215,4 @@ public abstract class AbstractMiningCoordinator<\n \n   protected abstract boolean newChainHeadInvalidatesMiningOperation(\n       final BlockHeader newChainHeadHeader);\n-\n-  @Override\n-  public Map<String, SealerInfo> getSealerInfos() {\n-    return sealerInfos;\n-  }\n-\n-  @Override\n-  public boolean submitHashRate(final String id, final Long hashrate) {\n-    if (hashrate == 0) {\n-      return false;\n-    }\n-    LOG.info(\"Hashrate submitted id {} hashrate {}\", id, hashrate);\n-    addSealerInfo(new SealerInfo(id, hashrate));\n-    return true;\n-  }\n-\n-  private void addSealerInfo(final SealerInfo sealerInfo) {\n-    if (sealerInfos.size() >= remoteSealersLimit) {\n-      sealerInfos.values().stream()\n-          .min(SealerInfo::compareTo)\n-          .ifPresent(toRemove -> sealerInfos.remove(toRemove.getId()));\n-    }\n-    sealerInfos.put(sealerInfo.getId(), sealerInfo);\n-  }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzU4Nw==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438983587", "bodyText": "I would remove this in favor or a new getHashRate() function that defaults to zero.", "author": "shemnon", "createdAt": "2020-06-11T18:19:01Z", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java", "diffHunk": "@@ -77,6 +81,26 @@ default boolean submitWork(final EthHashSolution solution) {\n         \"Current consensus mechanism prevents submission of work solutions.\");\n   }\n \n+  /**\n+   * Allows to submit the hashrate of a sealer with a specific id\n+   *\n+   * @param id of the sealer\n+   * @param hashrate of the sealer\n+   * @return true if the hashrate has been added otherwise false\n+   */\n+  default boolean submitHashRate(final String id, final Long hashrate) {\n+    return false;\n+  }\n+\n+  /**\n+   * Returns a list of the current sealers\n+   *\n+   * @return a list of {@link SealerInfo}\n+   */\n+  default Map<String, SealerInfo> getSealerInfos() {", "originalCommit": "973e240f831ebc2462ae68ff6c64a574fd758e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUzNjI0NA==", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r439536244", "bodyText": "Done", "author": "matkt", "createdAt": "2020-06-12T16:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzU4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "chunk": "diff --git a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java\nindex 99004cd998..6c6b247df8 100644\n--- a/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java\n+++ b/ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java\n\n@@ -92,15 +88,6 @@ public interface MiningCoordinator {\n     return false;\n   }\n \n-  /**\n-   * Returns a list of the current sealers\n-   *\n-   * @return a list of {@link SealerInfo}\n-   */\n-  default Map<String, SealerInfo> getSealerInfos() {\n-    return emptyMap();\n-  }\n-\n   /**\n    * Creates a block if possible, otherwise return an empty result\n    *\n"}}, {"oid": "d20adaeea7a238603e1f3d4844250514bf44ed53", "url": "https://github.com/hyperledger/besu/commit/d20adaeea7a238603e1f3d4844250514bf44ed53", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T09:36:43Z", "type": "commit"}, {"oid": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "url": "https://github.com/hyperledger/besu/commit/c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "message": "resolve review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T16:35:58Z", "type": "commit"}, {"oid": "e285f9cf46604958607c13ceef3b0c87ded4b431", "url": "https://github.com/hyperledger/besu/commit/e285f9cf46604958607c13ceef3b0c87ded4b431", "message": "resolve last review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T16:43:22Z", "type": "commit"}, {"oid": "71d60a727d0dd8f7a508f9b50dd7e68659835300", "url": "https://github.com/hyperledger/besu/commit/71d60a727d0dd8f7a508f9b50dd7e68659835300", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T16:54:29Z", "type": "commit"}, {"oid": "c4ad87bd634b96dd2d958383b2bafcb31aa1ab5c", "url": "https://github.com/hyperledger/besu/commit/c4ad87bd634b96dd2d958383b2bafcb31aa1ab5c", "message": "add cli option for hashrate time to live\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T19:16:41Z", "type": "commit"}, {"oid": "ae8c4511455895d84c03c636a09a963eccc92101", "url": "https://github.com/hyperledger/besu/commit/ae8c4511455895d84c03c636a09a963eccc92101", "message": "fix command test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-12T20:34:30Z", "type": "commit"}, {"oid": "ecd1d4b4f931e1564981578d8563558427715412", "url": "https://github.com/hyperledger/besu/commit/ecd1d4b4f931e1564981578d8563558427715412", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-06-15T08:01:43Z", "type": "commit"}]}