{"pr_number": 1239, "pr_title": "Add ethstats support", "pr_createdAt": "2020-07-20T16:30:07Z", "pr_url": "https://github.com/hyperledger/besu/pull/1239", "timeline": [{"oid": "e9e4e63a150423d0279330465d9e2894ac9c97c6", "url": "https://github.com/hyperledger/besu/commit/e9e4e63a150423d0279330465d9e2894ac9c97c6", "message": "add ethstats integration\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:15:26Z", "type": "commit"}, {"oid": "c569630785321c350e426b17e5eae14bc10fb29f", "url": "https://github.com/hyperledger/besu/commit/c569630785321c350e426b17e5eae14bc10fb29f", "message": "add missing files\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:16:44Z", "type": "commit"}, {"oid": "3f534e39d789db68814ba7c528dcaa13f0b33b9b", "url": "https://github.com/hyperledger/besu/commit/3f534e39d789db68814ba7c528dcaa13f0b33b9b", "message": "Merge branch 'master' into add-ethstats-socket\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:25:08Z", "type": "commit"}, {"oid": "27a8ac49934020ec5666fe76dbc0d9ef5f90e90d", "url": "https://github.com/hyperledger/besu/commit/27a8ac49934020ec5666fe76dbc0d9ef5f90e90d", "message": "change log level\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:25:29Z", "type": "commit"}, {"oid": "6c83286cf99d2244f3cf4a8b6600067d7225819c", "url": "https://github.com/hyperledger/besu/commit/6c83286cf99d2244f3cf4a8b6600067d7225819c", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:29:06Z", "type": "commit"}, {"oid": "0ad42ac3b08e9d533031755e9fc522e0cc1d0312", "url": "https://github.com/hyperledger/besu/commit/0ad42ac3b08e9d533031755e9fc522e0cc1d0312", "message": "reset invalid referencetest modification\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:40:47Z", "type": "commit"}, {"oid": "e5b3bba781f2ed0c6f51d39b5dd2fc14229dc96b", "url": "https://github.com/hyperledger/besu/commit/e5b3bba781f2ed0c6f51d39b5dd2fc14229dc96b", "message": "fix tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T16:49:01Z", "type": "commit"}, {"oid": "4ddaa2f11841d0bdf7892aebf88347d90e5c4e25", "url": "https://github.com/hyperledger/besu/commit/4ddaa2f11841d0bdf7892aebf88347d90e5c4e25", "message": "fix tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T17:09:02Z", "type": "commit"}, {"oid": "d288ed636311c266900835c20b0973228bee727c", "url": "https://github.com/hyperledger/besu/commit/d288ed636311c266900835c20b0973228bee727c", "message": "fix tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T17:19:16Z", "type": "commit"}, {"oid": "28724e5462f70f81dd4a4d2b6bec244e810aa914", "url": "https://github.com/hyperledger/besu/commit/28724e5462f70f81dd4a4d2b6bec244e810aa914", "message": "fix tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-20T17:19:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MzMzNA==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r457693334", "bodyText": "Should this and the other object be created using the Immutables framework?  There are some special annotations for immutables: https://immutables.github.io/json.html#jackson", "author": "shemnon", "createdAt": "2020-07-20T21:09:48Z", "path": "ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/authentication/AuthenticationData.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethstats.authentication;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+public class AuthenticationData {", "originalCommit": "28724e5462f70f81dd4a4d2b6bec244e810aa914", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEwMzY0OQ==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r458103649", "bodyText": "You are right, it is a good opportunity to integrate Immutables into Besu. I just did it", "author": "matkt", "createdAt": "2020-07-21T13:39:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY5MzMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "63b9289280ab15a28a163357939a47e908d0716c", "chunk": "diff --git a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/authentication/AuthenticationData.java b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/authentication/AuthenticationData.java\nindex 3c7710879..49e191b75 100644\n--- a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/authentication/AuthenticationData.java\n+++ b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/authentication/AuthenticationData.java\n\n@@ -14,36 +14,22 @@\n  */\n package org.hyperledger.besu.ethstats.authentication;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import org.immutables.value.Value;\n \n-public class AuthenticationData {\n+@Value.Immutable\n+@JsonSerialize(as = ImmutableAuthenticationData.class)\n+@JsonDeserialize(as = ImmutableAuthenticationData.class)\n+public interface AuthenticationData {\n \n   @JsonProperty(\"id\")\n-  private final String id;\n+  String getId();\n \n   @JsonProperty(\"info\")\n-  private final NodeInfo info;\n+  NodeInfo getInfo();\n \n   @JsonProperty(\"secret\")\n-  private final String secret;\n-\n-  @JsonCreator\n-  public AuthenticationData(final String id, final NodeInfo info, final String secret) {\n-    this.id = id;\n-    this.info = info;\n-    this.secret = secret;\n-  }\n-\n-  public String getId() {\n-    return id;\n-  }\n-\n-  public NodeInfo getInfo() {\n-    return info;\n-  }\n-\n-  public String getSecret() {\n-    return secret;\n-  }\n+  String getSecret();\n }\n"}}, {"oid": "63b9289280ab15a28a163357939a47e908d0716c", "url": "https://github.com/hyperledger/besu/commit/63b9289280ab15a28a163357939a47e908d0716c", "message": "add immutables library  for ethstats\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-21T13:37:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NzE2Nw==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r459287167", "bodyText": "I think you missed the stop", "author": "abdelhamidbakhta", "createdAt": "2020-07-23T08:21:01Z", "path": "besu/src/main/java/org/hyperledger/besu/Runner.java", "diffHunk": "@@ -122,6 +126,9 @@ public void start() {\n       writeBesuNetworksToFile();\n       autoTransactionLogBloomCachingService.ifPresent(AutoTransactionLogBloomCachingService::start);\n       writePidFile();\n+\n+      ethStatsService.ifPresent(EthStatsService::start);", "originalCommit": "63b9289280ab15a28a163357939a47e908d0716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMyNDIxOQ==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r459324219", "bodyText": "good catch, I just added it", "author": "matkt", "createdAt": "2020-07-23T09:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NzE2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "94aa749557ad40862b64baef4571cfb1d1737caa", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/Runner.java b/besu/src/main/java/org/hyperledger/besu/Runner.java\nindex d63934dde..80995efd1 100644\n--- a/besu/src/main/java/org/hyperledger/besu/Runner.java\n+++ b/besu/src/main/java/org/hyperledger/besu/Runner.java\n\n@@ -121,14 +121,13 @@ public class Runner implements AutoCloseable {\n       graphQLHttp.ifPresent(service -> waitForServiceToStart(\"graphQLHttp\", service.start()));\n       websocketRpc.ifPresent(service -> waitForServiceToStart(\"websocketRpc\", service.start()));\n       metrics.ifPresent(service -> waitForServiceToStart(\"metrics\", service.start()));\n+      ethStatsService.ifPresent(EthStatsService::start);\n       LOG.info(\"Ethereum main loop is up.\");\n       writeBesuPortsToFile();\n       writeBesuNetworksToFile();\n       autoTransactionLogBloomCachingService.ifPresent(AutoTransactionLogBloomCachingService::start);\n       writePidFile();\n \n-      ethStatsService.ifPresent(EthStatsService::start);\n-\n     } catch (final Exception ex) {\n       LOG.error(\"Startup failed\", ex);\n       throw new IllegalStateException(ex);\n"}}, {"oid": "94aa749557ad40862b64baef4571cfb1d1737caa", "url": "https://github.com/hyperledger/besu/commit/94aa749557ad40862b64baef4571cfb1d1737caa", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-23T09:29:42Z", "type": "commit"}, {"oid": "35caaee1c818726e81d7f0bf6b2ca0713c8d7793", "url": "https://github.com/hyperledger/besu/commit/35caaee1c818726e81d7f0bf6b2ca0713c8d7793", "message": "Merge branch 'master' into add-ethstats-socket", "committedDate": "2020-07-23T09:29:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNTUyNg==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r458835526", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                      LOG.error(\"Failed to login to ethstats server \" + ack);\n          \n          \n            \n                                      LOG.error(\"Failed to login to ethstats server {}\", ack);", "author": "shemnon", "createdAt": "2020-07-22T14:29:11Z", "path": "ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java", "diffHunk": "@@ -169,8 +177,7 @@ public void start() {\n                           // send a full report after the connection\n                           sendFullReport();\n                         } else {\n-                          LOG.error(\"Failed to login to ethstats server\");\n-                          retryConnect();\n+                          LOG.error(\"Failed to login to ethstats server \" + ack);", "originalCommit": "63b9289280ab15a28a163357939a47e908d0716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkzOTc2MA==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r459939760", "bodyText": "Done", "author": "matkt", "createdAt": "2020-07-24T09:11:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzNTUyNg=="}], "type": "inlineReview", "revised_code": {"commit": "f614c948c8acfc277ddb3c3f92377c91d9a8ce09", "chunk": "diff --git a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\nindex 518e19f2f..512dfb8a4 100644\n--- a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\n+++ b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\n\n@@ -177,7 +172,7 @@ public class EthStatsService {\n                           // send a full report after the connection\n                           sendFullReport();\n                         } else {\n-                          LOG.error(\"Failed to login to ethstats server \" + ack);\n+                          LOG.error(\"Failed to login to ethstats server {}\", ack);\n                         }\n                       });\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1NzAxMA==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r458857010", "bodyText": "How would this look with the @Parameter annotation on the key fields?  That would open up the .of(...) static method and these singe use cases could become (I'm guesssing on the auto-formattting)...\n    sendMessage(\n      webSocket, \n      new EthStatsRequest(\n        NODE_PING, \n        ImmutablePingReport.of(\n          enodeURL.getNodeId().toHexString(),\n          String.valueOf(pingTimestamp))));", "author": "shemnon", "createdAt": "2020-07-22T14:57:16Z", "path": "ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java", "diffHunk": "@@ -274,22 +285,22 @@ private void sendFullReport() {\n   private void sendPing() {\n     // we store the timestamp when we sent the ping\n     pingTimestamp = System.currentTimeMillis();\n-    final EthStatsRequest ping =\n-        new EthStatsRequest(\n-            NODE_PING,\n-            new PingReport(enodeURL.getNodeId().toHexString(), String.valueOf(pingTimestamp)));\n-    sendMessage(webSocket, ping);\n+    final PingReport pingReport =\n+        ImmutablePingReport.builder()\n+            .id(enodeURL.getNodeId().toHexString())\n+            .currentTime(String.valueOf(pingTimestamp))\n+            .build();\n+    sendMessage(webSocket, new EthStatsRequest(NODE_PING, pingReport));", "originalCommit": "63b9289280ab15a28a163357939a47e908d0716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0MjMzMw==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r459942333", "bodyText": "Done. I added this in everything except in two object because having the builder allow to use this feature https://immutables.github.io/immutable.html#wrappertupple-initializers-inlined-as-alternative-setters-with-deep- immutables-detection", "author": "matkt", "createdAt": "2020-07-24T09:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1NzAxMA=="}], "type": "inlineReview", "revised_code": {"commit": "f614c948c8acfc277ddb3c3f92377c91d9a8ce09", "chunk": "diff --git a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\nindex 518e19f2f..512dfb8a4 100644\n--- a/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\n+++ b/ethereum/ethstats/src/main/java/org/hyperledger/besu/ethstats/EthStatsService.java\n\n@@ -285,22 +279,24 @@ public class EthStatsService {\n   private void sendPing() {\n     // we store the timestamp when we sent the ping\n     pingTimestamp = System.currentTimeMillis();\n-    final PingReport pingReport =\n-        ImmutablePingReport.builder()\n-            .id(enodeURL.getNodeId().toHexString())\n-            .currentTime(String.valueOf(pingTimestamp))\n-            .build();\n-    sendMessage(webSocket, new EthStatsRequest(NODE_PING, pingReport));\n+\n+    sendMessage(\n+        webSocket,\n+        new EthStatsRequest(\n+            NODE_PING,\n+            ImmutablePingReport.of(\n+                enodeURL.getNodeId().toHexString(), String.valueOf(pingTimestamp))));\n   }\n \n   /** Sends a latency report to the ethstats server */\n   private void sendLatencyReport() {\n-    final LatencyReport latencyReport =\n-        ImmutableLatencyReport.builder()\n-            .id(enodeURL.getNodeId().toHexString())\n-            .latency(String.valueOf(System.currentTimeMillis() - pingTimestamp))\n-            .build();\n-    sendMessage(webSocket, new EthStatsRequest(LATENCY, latencyReport));\n+    sendMessage(\n+        webSocket,\n+        new EthStatsRequest(\n+            LATENCY,\n+            ImmutableLatencyReport.of(\n+                enodeURL.getNodeId().toHexString(),\n+                String.valueOf(System.currentTimeMillis() - pingTimestamp))));\n   }\n \n   /** Sends a block report concerning the last block */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1ODQwNA==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r458858404", "bodyText": "Let's start these out as --X options and make them standard after one dot-dot release cycle without issues.", "author": "shemnon", "createdAt": "2020-07-22T14:59:13Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1039,6 +1040,21 @@ void setBannedNodeIds(final List<String> values) {\n       arity = \"1\")\n   private final Long wsTimeoutSec = TimeoutOptions.defaultOptions().getTimeoutSeconds();\n \n+  @SuppressWarnings({\"FieldCanBeFinal\", \"FieldMayBeFinal\"})\n+  @Option(\n+      names = {\"--ethstats\"},", "originalCommit": "63b9289280ab15a28a163357939a47e908d0716c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk0MDgyNw==", "url": "https://github.com/hyperledger/besu/pull/1239#discussion_r459940827", "bodyText": "Done", "author": "matkt", "createdAt": "2020-07-24T09:13:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg1ODQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "f614c948c8acfc277ddb3c3f92377c91d9a8ce09", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\nindex 933058735..c1bc31ddd 100644\n--- a/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n+++ b/besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java\n\n@@ -1042,7 +1042,7 @@ public class BesuCommand implements DefaultCommandValues, Runnable {\n \n   @SuppressWarnings({\"FieldCanBeFinal\", \"FieldMayBeFinal\"})\n   @Option(\n-      names = {\"--ethstats\"},\n+      names = {\"--Xethstats\"},\n       paramLabel = \"<nodename:secret@host:port>\",\n       description = \"Reporting URL of a ethstats server\",\n       arity = \"1\")\n"}}, {"oid": "f614c948c8acfc277ddb3c3f92377c91d9a8ce09", "url": "https://github.com/hyperledger/besu/commit/f614c948c8acfc277ddb3c3f92377c91d9a8ce09", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-24T09:11:16Z", "type": "commit"}, {"oid": "80cf14a74819d45f070272fd38013e156f732c98", "url": "https://github.com/hyperledger/besu/commit/80cf14a74819d45f070272fd38013e156f732c98", "message": "Merge remote-tracking branch 'origin/add-ethstats-socket' into add-ethstats-socket", "committedDate": "2020-07-24T09:11:46Z", "type": "commit"}, {"oid": "aaecf7804caede07ad0894377cc3974e5790d9b0", "url": "https://github.com/hyperledger/besu/commit/aaecf7804caede07ad0894377cc3974e5790d9b0", "message": "Merge branch 'master/master' into add-ethstats-socket\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-24T09:41:45Z", "type": "forcePushed"}, {"oid": "d15e47c57dc85ddbe4f7a7fb056dfbfc27ee2031", "url": "https://github.com/hyperledger/besu/commit/d15e47c57dc85ddbe4f7a7fb056dfbfc27ee2031", "message": "Merge branch 'upstream/master' into add-ethstats-socket\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-24T09:45:18Z", "type": "commit"}, {"oid": "028bff77a3bcd45a63b9999cd54ae491872ac96e", "url": "https://github.com/hyperledger/besu/commit/028bff77a3bcd45a63b9999cd54ae491872ac96e", "message": "clean merge\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-24T09:46:46Z", "type": "commit"}, {"oid": "028bff77a3bcd45a63b9999cd54ae491872ac96e", "url": "https://github.com/hyperledger/besu/commit/028bff77a3bcd45a63b9999cd54ae491872ac96e", "message": "clean merge\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-07-24T09:46:46Z", "type": "forcePushed"}, {"oid": "dcf5b108d8eb8ebb056e92148261478d71dc7a51", "url": "https://github.com/hyperledger/besu/commit/dcf5b108d8eb8ebb056e92148261478d71dc7a51", "message": "Merge branch 'master' into add-ethstats-socket", "committedDate": "2020-08-04T07:33:39Z", "type": "commit"}]}