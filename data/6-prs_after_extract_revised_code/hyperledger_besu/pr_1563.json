{"pr_number": 1563, "pr_title": "eth_gasPrice based on median block cost (#1546)", "pr_createdAt": "2020-11-13T20:21:57Z", "pr_url": "https://github.com/hyperledger/besu/pull/1563", "timeline": [{"oid": "eebfc94673ac96213412d8780130ec55eee16023", "url": "https://github.com/hyperledger/besu/commit/eebfc94673ac96213412d8780130ec55eee16023", "message": "eth_gasPrice based on median block cost (#1546)\n\nUpdate eth_gasPrice to return the median gas price of transactions in\nthe last 100 blocks (or whole chain if the chain is short).  If there\nare no TXes return the old value.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-13T20:05:02Z", "type": "commit"}, {"oid": "b3695791f2999bf67380279a739822f3905aa86f", "url": "https://github.com/hyperledger/besu/commit/b3695791f2999bf67380279a739822f3905aa86f", "message": "we need to support GraphQL too.\n\n* Refactor gas price to BlockchainQueries.\n* Adjust tests to reflect new reality of median gas price.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-14T03:36:01Z", "type": "commit"}, {"oid": "f69f3b51f552bb4d620f371f97d394bc53e7a226", "url": "https://github.com/hyperledger/besu/commit/f69f3b51f552bb4d620f371f97d394bc53e7a226", "message": "changelog\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-16T03:05:49Z", "type": "commit"}, {"oid": "12e9a028d65ad2a1ac43bdb28e2a1f4d726956bc", "url": "https://github.com/hyperledger/besu/commit/12e9a028d65ad2a1ac43bdb28e2a1f4d726956bc", "message": "merge with upstream master\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-16T17:39:19Z", "type": "commit"}, {"oid": "609b9cd8962be99d92f6538f507f343b9eeeefdf", "url": "https://github.com/hyperledger/besu/commit/609b9cd8962be99d92f6538f507f343b9eeeefdf", "message": "add CLI flags\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-16T22:51:19Z", "type": "commit"}, {"oid": "fd87d53e51af0b6b67d23ae20ae33ee31aa0dd23", "url": "https://github.com/hyperledger/besu/commit/fd87d53e51af0b6b67d23ae20ae33ee31aa0dd23", "message": "Merge branch 'master' of github.com:hyperledger/besu into gasPrice\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-16T22:52:36Z", "type": "commit"}, {"oid": "90c468d0545d012129be059dd8aa6ef98ac94c3a", "url": "https://github.com/hyperledger/besu/commit/90c468d0545d012129be059dd8aa6ef98ac94c3a", "message": "update changelog.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-16T22:55:22Z", "type": "commit"}, {"oid": "a5c61ab5ccb2bdc6b39efb20887ee85c3c1c8346", "url": "https://github.com/hyperledger/besu/commit/a5c61ab5ccb2bdc6b39efb20887ee85c3c1c8346", "message": "Merge branch 'master' into gasPrice", "committedDate": "2020-11-16T23:05:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMDg3Nw==", "url": "https://github.com/hyperledger/besu/pull/1563#discussion_r524810877", "bodyText": "I think this case should be an orElseThrow? It doesn't represent a normal case.", "author": "RatanRSur", "createdAt": "2020-11-17T00:44:24Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/BlockchainQueries.java", "diffHunk": "@@ -715,6 +733,34 @@ private TransactionWithMetadata transactionByHeaderAndIndex(\n     return header.map(BlockHeader::getStateRoot).flatMap(worldStateArchive::getMutable);\n   }\n \n+  public Optional<Long> gasPrice() {\n+    final long blockHeight = headBlockNumber();\n+    final long[] gasCollection =\n+        LongStream.range(Math.max(0, blockHeight - apiConfig.getGasPriceBlocks()), blockHeight)\n+            .mapToObj(\n+                l ->\n+                    blockchain\n+                        .getBlockByNumber(l)\n+                        .map(Block::getBody)\n+                        .map(BlockBody::getTransactions)\n+                        .orElse(Collections.emptyList()))", "originalCommit": "a5c61ab5ccb2bdc6b39efb20887ee85c3c1c8346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2NjU0Mg==", "url": "https://github.com/hyperledger/besu/pull/1563#discussion_r524866542", "bodyText": "It felt like an \"it could never happen situation,\" if we can't get blocks by number behind the head block.  Throwing an error does seem more appropriate instead of silently healing.\nI supposed if we are querying the gas right when we decide to switch to a shorter but heavier chain it might catch those blocks.  Simply send another request in that case.", "author": "shemnon", "createdAt": "2020-11-17T03:47:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMDg3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "cc15a43b82872b939b906808c7c543f7a8cb4e4a", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/BlockchainQueries.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/BlockchainQueries.java\nindex ed664711f..a69bbed19 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/BlockchainQueries.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/BlockchainQueries.java\n\n@@ -743,7 +743,8 @@ public class BlockchainQueries {\n                         .getBlockByNumber(l)\n                         .map(Block::getBody)\n                         .map(BlockBody::getTransactions)\n-                        .orElse(Collections.emptyList()))\n+                        .orElseThrow(\n+                            () -> new IllegalStateException(\"Could not retrieve block #\" + l)))\n             .flatMap(Collection::stream)\n             .mapToLong(t -> t.getGasPrice().toLong())\n             .sorted()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjIyMA==", "url": "https://github.com/hyperledger/besu/pull/1563#discussion_r524812220", "bodyText": "How come this isn't 500_000_000_000L?", "author": "RatanRSur", "createdAt": "2020-11-17T00:48:28Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/ApiConfiguration.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.api;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+@Value.Style(allParameters = true)\n+public abstract class ApiConfiguration {\n+\n+  @Value.Default\n+  public long getGasPriceBlocks() {\n+    return 100;\n+  }\n+\n+  @Value.Default\n+  public double getGasPricePercentile() {\n+    return 50.0d;\n+  }\n+\n+  @Value.Default\n+  public long getGasPriceMin() {\n+    return 1_000_000_000L; // 1 GWei\n+  }\n+\n+  @Value.Default\n+  public long getGasPriceMax() {\n+    return 1_000_000_000_000_000_000L; // 1 Eth\n+  }", "originalCommit": "a5c61ab5ccb2bdc6b39efb20887ee85c3c1c8346", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg2NjU5Mw==", "url": "https://github.com/hyperledger/besu/pull/1563#discussion_r524866593", "bodyText": "I wrote that before I decided to adopt the geth limits.", "author": "shemnon", "createdAt": "2020-11-17T03:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjIyMA=="}], "type": "inlineReview", "revised_code": {"commit": "cc15a43b82872b939b906808c7c543f7a8cb4e4a", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/ApiConfiguration.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/ApiConfiguration.java\nindex 70e5baf58..8aabbe1bf 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/ApiConfiguration.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/ApiConfiguration.java\n\n@@ -39,7 +39,7 @@ public abstract class ApiConfiguration {\n \n   @Value.Default\n   public long getGasPriceMax() {\n-    return 1_000_000_000_000_000_000L; // 1 Eth\n+    return 500_000_000_000L; // 500 GWei\n   }\n \n   @Value.Derived\n"}}, {"oid": "cc15a43b82872b939b906808c7c543f7a8cb4e4a", "url": "https://github.com/hyperledger/besu/commit/cc15a43b82872b939b906808c7c543f7a8cb4e4a", "message": "review changes\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-17T03:47:48Z", "type": "commit"}, {"oid": "0f96fde2d2bbdb7d16320590f82cddfabcc71d9b", "url": "https://github.com/hyperledger/besu/commit/0f96fde2d2bbdb7d16320590f82cddfabcc71d9b", "message": "update unit tests to deal with orElseThrow\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-17T04:46:14Z", "type": "commit"}]}