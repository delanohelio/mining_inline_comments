{"pr_number": 1605, "pr_title": "transaction RLP encode/decode handle GoQuorum private tx", "pr_createdAt": "2020-11-25T02:12:27Z", "pr_url": "https://github.com/hyperledger/besu/pull/1605", "timeline": [{"oid": "82cbccf4781879ad534ae4d3f07b294a5f58300c", "url": "https://github.com/hyperledger/besu/commit/82cbccf4781879ad534ae4d3f07b294a5f58300c", "message": "first pass of modifying transaction RLP encode/decode to handle GoQuorum private tx value\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:09:49Z", "type": "commit"}, {"oid": "fe62f5fa27a760453290faa2717d6ff7cd9fc623", "url": "https://github.com/hyperledger/besu/commit/fe62f5fa27a760453290faa2717d6ff7cd9fc623", "message": "removed import\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:16:59Z", "type": "commit"}, {"oid": "c1e1337ff010c34c14aa0fc5d7cdfa530b093ae1", "url": "https://github.com/hyperledger/besu/commit/c1e1337ff010c34c14aa0fc5d7cdfa530b093ae1", "message": "removed debug\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:22:30Z", "type": "commit"}, {"oid": "e8d3ea003780fa0da645342be6ae1680ce9f22d8", "url": "https://github.com/hyperledger/besu/commit/e8d3ea003780fa0da645342be6ae1680ce9f22d8", "message": "hack to make test pass\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:38:28Z", "type": "commit"}, {"oid": "a686b53461e99937420e9d7a758fab2e76edef3f", "url": "https://github.com/hyperledger/besu/commit/a686b53461e99937420e9d7a758fab2e76edef3f", "message": "javadoc\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:38:36Z", "type": "commit"}, {"oid": "e73d782eb2bc968aaa5668f74d3aa217a53a0ed1", "url": "https://github.com/hyperledger/besu/commit/e73d782eb2bc968aaa5668f74d3aa217a53a0ed1", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T02:40:34Z", "type": "commit"}, {"oid": "bd9b79996fb0c1a5c5fad44f06d7d3ff9cc1455e", "url": "https://github.com/hyperledger/besu/commit/bd9b79996fb0c1a5c5fad44f06d7d3ff9cc1455e", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T03:37:49Z", "type": "commit"}, {"oid": "45b4bebf38d17e773e0137131366f290327652bb", "url": "https://github.com/hyperledger/besu/commit/45b4bebf38d17e773e0137131366f290327652bb", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-25T03:44:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMTU1OQ==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r530721559", "bodyText": "Is it because of the privateFrom/privateFor?", "author": "lucassaldanha", "createdAt": "2020-11-26T01:24:51Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPDecoder.java", "diffHunk": "@@ -47,6 +49,19 @@ static Transaction decodeTransaction(final RLPInput input) {\n   static TransactionRLPDecoder frontierDecoder() {\n     return input -> {\n       input.enterList();\n+      // TODO clean this up - not sure why but the GoQuorum private tx has extra nesting", "originalCommit": "45b4bebf38d17e773e0137131366f290327652bb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d83ca91208e6fc82edaa87ed6840029a2d4176bf", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPDecoder.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPDecoder.java\nindex a0605887c..929703873 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPDecoder.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPDecoder.java\n\n@@ -49,19 +54,7 @@ public interface TransactionRLPDecoder {\n   static TransactionRLPDecoder frontierDecoder() {\n     return input -> {\n       input.enterList();\n-      // TODO clean this up - not sure why but the GoQuorum private tx has extra nesting\n-      if (input.nextIsList()) {\n-        input.enterList();\n-      }\n-      if (input.nextIsList()) {\n-        input.enterList();\n-      }\n-      if (input.nextIsList()) {\n-        input.enterList();\n-      }\n-      if (input.nextIsList()) {\n-        input.enterList();\n-      }\n+\n       final Transaction.Builder builder =\n           Transaction.builder()\n               .nonce(input.readLongScalar())\n"}}, {"oid": "d83ca91208e6fc82edaa87ed6840029a2d4176bf", "url": "https://github.com/hyperledger/besu/commit/d83ca91208e6fc82edaa87ed6840029a2d4176bf", "message": "added static flag to be read by TransactionRLPDecoder so that we can still allow chainId=1\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-26T02:23:17Z", "type": "commit"}, {"oid": "349e9ce85eaaccd5fe3dbbbd9cfbdbe7a68c08fa", "url": "https://github.com/hyperledger/besu/commit/349e9ce85eaaccd5fe3dbbbd9cfbdbe7a68c08fa", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-11-26T02:23:37Z", "type": "commit"}, {"oid": "2b510438453f367e51c843abc4fef8c3c2af6256", "url": "https://github.com/hyperledger/besu/commit/2b510438453f367e51c843abc4fef8c3c2af6256", "message": "moved v to Transaction\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-26T03:49:48Z", "type": "commit"}, {"oid": "e715569d2a5190bdd32bc26342eebd71d4cdeb34", "url": "https://github.com/hyperledger/besu/commit/e715569d2a5190bdd32bc26342eebd71d4cdeb34", "message": "moved v to Transaction\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-26T03:53:35Z", "type": "commit"}, {"oid": "b790421e25b902cc48f78b5ed901dd636fad6c12", "url": "https://github.com/hyperledger/besu/commit/b790421e25b902cc48f78b5ed901dd636fad6c12", "message": "javadoc\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-26T04:05:39Z", "type": "commit"}, {"oid": "1844277b81bc7ba078c40005832e05ad7b498c7c", "url": "https://github.com/hyperledger/besu/commit/1844277b81bc7ba078c40005832e05ad7b498c7c", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-11-27T02:43:06Z", "type": "commit"}, {"oid": "e9ccf0ab29b4bdf747ede4e1feac1c797b0a20fc", "url": "https://github.com/hyperledger/besu/commit/e9ccf0ab29b4bdf747ede4e1feac1c797b0a20fc", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-11-29T23:50:22Z", "type": "commit"}, {"oid": "176cdfaad353a4741bdf790beafba149645af3ea", "url": "https://github.com/hyperledger/besu/commit/176cdfaad353a4741bdf790beafba149645af3ea", "message": "javadoc\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-30T03:23:35Z", "type": "commit"}, {"oid": "6ba8b0ea6b1f9547b0db7de85558ab59c246c96d", "url": "https://github.com/hyperledger/besu/commit/6ba8b0ea6b1f9547b0db7de85558ab59c246c96d", "message": "fix RLP input in GoQuorum test to not have extra list nesting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-30T03:26:12Z", "type": "commit"}, {"oid": "7a34b3b501974f5c465a427e2c8e57b3a8ae4216", "url": "https://github.com/hyperledger/besu/commit/7a34b3b501974f5c465a427e2c8e57b3a8ae4216", "message": "undoing unnecessary changes\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-11-30T03:34:34Z", "type": "commit"}, {"oid": "444dac514eb1ce3074093ecdea7d9ca4e4978f8b", "url": "https://github.com/hyperledger/besu/commit/444dac514eb1ce3074093ecdea7d9ca4e4978f8b", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-11-30T23:55:52Z", "type": "commit"}, {"oid": "4d3898886b436966e670064696bb262e6f5c4ef3", "url": "https://github.com/hyperledger/besu/commit/4d3898886b436966e670064696bb262e6f5c4ef3", "message": "comments\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T01:24:35Z", "type": "commit"}, {"oid": "ef4f748919bac66499581dae5494132f7506de28", "url": "https://github.com/hyperledger/besu/commit/ef4f748919bac66499581dae5494132f7506de28", "message": "comments\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T01:28:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzkyNg==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533013926", "bodyText": "Do we need to enforce that only one of these is set?", "author": "RatanRSur", "createdAt": "2020-12-01T01:31:32Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java", "diffHunk": "@@ -121,7 +129,8 @@ public Transaction(\n       final SECP256K1.Signature signature,\n       final Bytes payload,\n       final Address sender,\n-      final Optional<BigInteger> chainId) {\n+      final Optional<BigInteger> chainId,\n+      final Optional<BigInteger> v) {", "originalCommit": "ef4f748919bac66499581dae5494132f7506de28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzODQzOQ==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533038439", "bodyText": "added this check. this is the only place where v gets set", "author": "macfarla", "createdAt": "2020-12-01T02:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxMzkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "fde472c9fea7ecb4d31762c60e7f84a748307edc", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\nindex 702c7ffa1..cbcf8970b 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\n\n@@ -131,6 +131,10 @@ public class Transaction implements org.hyperledger.besu.plugin.data.Transaction\n       final Address sender,\n       final Optional<BigInteger> chainId,\n       final Optional<BigInteger> v) {\n+    if (v.isPresent() && chainId.isPresent()) {\n+      throw new IllegalStateException(\n+          String.format(\"chainId {} and v {} cannot both be provided\", chainId.get(), v.get()));\n+    }\n     this.nonce = nonce;\n     this.gasPrice = gasPrice;\n     this.gasPremium = gasPremium;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNjI2Mw==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533016263", "bodyText": "Is MAX supposed to be smaller than MIN here?", "author": "RatanRSur", "createdAt": "2020-12-01T01:38:50Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java", "diffHunk": "@@ -45,6 +45,9 @@\n \n   public static final BigInteger REPLAY_PROTECTED_V_BASE = BigInteger.valueOf(35);\n \n+  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MAX = BigInteger.valueOf(37);\n+  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MIN = BigInteger.valueOf(38);", "originalCommit": "ef4f748919bac66499581dae5494132f7506de28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAyMTUwOA==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533021508", "bodyText": "YES", "author": "macfarla", "createdAt": "2020-12-01T01:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzODE2MQ==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533038161", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-12-01T02:48:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNjI2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAzODI4NQ==", "url": "https://github.com/hyperledger/besu/pull/1605#discussion_r533038285", "bodyText": "max and min don't make a whole lot of sense (they are never compared) but I couldn't think of anything better", "author": "macfarla", "createdAt": "2020-12-01T02:48:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzAxNjI2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "eec0e6835033d407a2382dc128071e98d85ee935", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\nindex 702c7ffa1..a4be762fa 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java\n\n@@ -45,8 +45,8 @@ public class Transaction implements org.hyperledger.besu.plugin.data.Transaction\n \n   public static final BigInteger REPLAY_PROTECTED_V_BASE = BigInteger.valueOf(35);\n \n-  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MAX = BigInteger.valueOf(37);\n-  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MIN = BigInteger.valueOf(38);\n+  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MIN = BigInteger.valueOf(37);\n+  public static final BigInteger GO_QUORUM_PRIVATE_TRANSACTION_V_VALUE_MAX = BigInteger.valueOf(38);\n \n   // The v signature parameter starts at 36 because 1 is the first valid chainId so:\n   // chainId > 1 implies that 2 * chainId + V_BASE > 36.\n"}}, {"oid": "fde472c9fea7ecb4d31762c60e7f84a748307edc", "url": "https://github.com/hyperledger/besu/commit/fde472c9fea7ecb4d31762c60e7f84a748307edc", "message": "ensure chainId and v not both provided and add v to hashCode\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T02:17:09Z", "type": "commit"}, {"oid": "eec0e6835033d407a2382dc128071e98d85ee935", "url": "https://github.com/hyperledger/besu/commit/eec0e6835033d407a2382dc128071e98d85ee935", "message": "max/min\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T02:38:26Z", "type": "commit"}, {"oid": "0b21e5ac2bc2eb38d71476afcba4258fd6bf69be", "url": "https://github.com/hyperledger/besu/commit/0b21e5ac2bc2eb38d71476afcba4258fd6bf69be", "message": "string format\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T02:47:58Z", "type": "commit"}, {"oid": "56048f0b1210ff2919926f0ce1eb96339123cc67", "url": "https://github.com/hyperledger/besu/commit/56048f0b1210ff2919926f0ce1eb96339123cc67", "message": "fixed recId calculation\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T18:48:29Z", "type": "commit"}, {"oid": "d25858b44b06a18b82fe190c60de633da5267c79", "url": "https://github.com/hyperledger/besu/commit/d25858b44b06a18b82fe190c60de633da5267c79", "message": "removed dupe\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-12-01T18:49:38Z", "type": "commit"}, {"oid": "616d264d5513e671dfc41a464a39cc11c62810c9", "url": "https://github.com/hyperledger/besu/commit/616d264d5513e671dfc41a464a39cc11c62810c9", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-12-01T18:50:29Z", "type": "commit"}, {"oid": "cf8620db11d9f7315f093a4e91ff6346d493acbb", "url": "https://github.com/hyperledger/besu/commit/cf8620db11d9f7315f093a4e91ff6346d493acbb", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-12-01T22:46:07Z", "type": "commit"}, {"oid": "38772a9235d40efcfbb26bde1c6d61387406006b", "url": "https://github.com/hyperledger/besu/commit/38772a9235d40efcfbb26bde1c6d61387406006b", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into quorum-rlp-decoder", "committedDate": "2020-12-02T01:34:23Z", "type": "commit"}]}