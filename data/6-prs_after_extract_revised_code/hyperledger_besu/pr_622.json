{"pr_number": 622, "pr_title": "[EIP-1559] Step 3 - Implement EIP-1559 logic in a manager class", "pr_createdAt": "2020-03-31T16:27:16Z", "pr_url": "https://github.com/hyperledger/besu/pull/622", "timeline": [{"oid": "ba37fd0efcba2de4ea34c979060ff361a1fe9798", "url": "https://github.com/hyperledger/besu/commit/ba37fd0efcba2de4ea34c979060ff361a1fe9798", "message": "Added changelog entries for PR:\n- https://github.com/hyperledger/besu/pull/430\n- https://github.com/hyperledger/besu/pull/440\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-12T09:09:40Z", "type": "commit"}, {"oid": "872f9cc4e93b90829961ebe6e599c51af43c95a7", "url": "https://github.com/hyperledger/besu/commit/872f9cc4e93b90829961ebe6e599c51af43c95a7", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-13T08:25:43Z", "type": "commit"}, {"oid": "e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "url": "https://github.com/hyperledger/besu/commit/e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-16T09:10:11Z", "type": "commit"}, {"oid": "a2fb831c87dae221c92a9f9ec7705500717f1e77", "url": "https://github.com/hyperledger/besu/commit/a2fb831c87dae221c92a9f9ec7705500717f1e77", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T09:17:25Z", "type": "commit"}, {"oid": "c07ed7de515e1e25ea22ef38b59bf8337086812e", "url": "https://github.com/hyperledger/besu/commit/c07ed7de515e1e25ea22ef38b59bf8337086812e", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T15:26:18Z", "type": "commit"}, {"oid": "1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "url": "https://github.com/hyperledger/besu/commit/1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-18T08:29:25Z", "type": "commit"}, {"oid": "ee10a2590d8e23b95a40c946a2927730714c4793", "url": "https://github.com/hyperledger/besu/commit/ee10a2590d8e23b95a40c946a2927730714c4793", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-19T16:27:54Z", "type": "commit"}, {"oid": "40cd31d7b48aab7b285524661ac17168c0d38467", "url": "https://github.com/hyperledger/besu/commit/40cd31d7b48aab7b285524661ac17168c0d38467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-23T10:35:38Z", "type": "commit"}, {"oid": "e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "url": "https://github.com/hyperledger/besu/commit/e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-25T08:04:10Z", "type": "commit"}, {"oid": "2c782ba4617a68e42def01737bdc6950ff7f9f53", "url": "https://github.com/hyperledger/besu/commit/2c782ba4617a68e42def01737bdc6950ff7f9f53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T09:26:18Z", "type": "commit"}, {"oid": "854ed2a6c863415636cd24a0519de23e9471c9fc", "url": "https://github.com/hyperledger/besu/commit/854ed2a6c863415636cd24a0519de23e9471c9fc", "message": "### Description\nBlockHeader object needs to be modified in order to add the new field (baseFee) as specified in the EIP.\nWe should take care about the RLP encoding/decoding of this structure since it has to include or not the new fields depending on whether we are pre fork or post fork.\n\n- Update `core.BlockHeader.java`\n    - Add `baseFee`\n    - Update `readFrom` method for RLP decoding\n    - Update `writeTo` method for RLP encoding\n- Update `plugin.data.BlockHeader.java`\n    - Add `getBaseFee` method\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T13:50:37Z", "type": "commit"}, {"oid": "d8ddc67cce5fb022f17b0bd8abfd0d70fd83420e", "url": "https://github.com/hyperledger/besu/commit/d8ddc67cce5fb022f17b0bd8abfd0d70fd83420e", "message": "### Description\nTransaction object needs to be modified in order to add the 2 new fields (`gasPremium` and `feeCap`) as specified in the EIP.\nWe should take care about the RLP encoding/decoding of this structure since it has to include or not the new fields depending on whether we are pre fork or post fork.\n\n- Update core `Transaction` object\n    - Add gasPremium and feeCap fields\n    - Update readFrom method for RLP decoding\n    - Update writeTo method for RLP encoding\n- Update plugin `Transaction` interface\n    - Add `getGasPremium` and `getFeeCap` methods\n\nThis EIP introduces gasPremium and feeCap fields in the transaction. They need to be included in the signing mechanism.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T15:05:17Z", "type": "commit"}, {"oid": "09b5c6d8556ffd4cda24714257d9c454ab32e503", "url": "https://github.com/hyperledger/besu/commit/09b5c6d8556ffd4cda24714257d9c454ab32e503", "message": "We need a manager class to hold EIP-1559 core logic. This helper class will be then used by glue code. This separation make testing simpler.\nSpecifically the following methods:\n\n- `long computeBaseFee(final long parentBaseFee, final long parentGasUsed)`\n- `boolean isValidBaseFee(final long parentBaseFee, final long baseFee)`\n- `long eip1559GasPool(final long blockNumber)`\n- `long legacyGasPool(final long blockNumber)`\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T16:25:22Z", "type": "commit"}, {"oid": "da50f903b7ce6ff192c5cd5cc841aade0ad8f35c", "url": "https://github.com/hyperledger/besu/commit/da50f903b7ce6ff192c5cd5cc841aade0ad8f35c", "message": "spotlessApply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T16:38:13Z", "type": "commit"}, {"oid": "493c7d320b4fcd24a561594121615622d7fb0410", "url": "https://github.com/hyperledger/besu/commit/493c7d320b4fcd24a561594121615622d7fb0410", "message": "Merge branch 'master' into step-3-manager-class", "committedDate": "2020-04-01T07:56:54Z", "type": "commit"}, {"oid": "e70b8baf179450eedc75f49f0c2c828c5c9baa0a", "url": "https://github.com/hyperledger/besu/commit/e70b8baf179450eedc75f49f0c2c828c5c9baa0a", "message": "TODO Add CLI command line flag `--Xeip1559-enabled`.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-01T15:25:38Z", "type": "commit"}, {"oid": "5c19dce6aef914e6cf295ede16793e31be0c9af0", "url": "https://github.com/hyperledger/besu/commit/5c19dce6aef914e6cf295ede16793e31be0c9af0", "message": "Merge remote-tracking branch 'upstream/master' into step-3-manager-class\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/BlockHeader.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/BlockHeaderBuilder.java\n#\tethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/SealableBlockHeader.java\n#\tplugin-api/build.gradle\n#\tplugin-api/src/main/java/org/hyperledger/besu/plugin/data/BlockHeader.java", "committedDate": "2020-04-03T11:39:20Z", "type": "commit"}, {"oid": "583acd197f5b4cfbfded20c9cf9ca6d31784364a", "url": "https://github.com/hyperledger/besu/commit/583acd197f5b4cfbfded20c9cf9ca6d31784364a", "message": "update known hash\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T11:46:30Z", "type": "commit"}, {"oid": "a43560735ccf71fa33a72b2e525fc1d6d07da70c", "url": "https://github.com/hyperledger/besu/commit/a43560735ccf71fa33a72b2e525fc1d6d07da70c", "message": "clean up\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T12:41:09Z", "type": "commit"}, {"oid": "e41d6ef15d288697b0284c7e63c62435787bf744", "url": "https://github.com/hyperledger/besu/commit/e41d6ef15d288697b0284c7e63c62435787bf744", "message": "Merge branch 'step-3-manager-class' of https://github.com/abdelhamidbakhta/besu into step-3-manager-class\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T12:47:13Z", "type": "commit"}, {"oid": "b5f8f84ce168a6111184d6733d969ab6b5eb7ef1", "url": "https://github.com/hyperledger/besu/commit/b5f8f84ce168a6111184d6733d969ab6b5eb7ef1", "message": "clean up\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T12:48:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzExMDM2NQ==", "url": "https://github.com/hyperledger/besu/pull/622#discussion_r403110365", "bodyText": "These numbers could change in future blocks, especially the target and max gas used.  I think this should be an interface with static methods for each fork.  Call the first one \"experimental\" or just \"EIP1559\".  I could see this moving into ProtocolSchedule once it ships, but while it is experimental it's own interface is fine.", "author": "shemnon", "createdAt": "2020-04-03T16:05:41Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/EIP1559Config.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.core.fees;\n+\n+public class EIP1559Config {", "originalCommit": "b5f8f84ce168a6111184d6733d969ab6b5eb7ef1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "22a49084eb09ae499f8ad448b1524955cd2fe10c", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/EIP1559Config.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/FeeMarket.java\nsimilarity index 55%\nrename from ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/EIP1559Config.java\nrename to ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/FeeMarket.java\nindex 36f0cfaa9a..d760f1cef1 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/EIP1559Config.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/fees/FeeMarket.java\n\n@@ -14,13 +14,32 @@\n  */\n package org.hyperledger.besu.ethereum.core.fees;\n \n-public class EIP1559Config {\n-  public static final long BASEFEE_MAX_CHANGE_DENOMINATOR = 8L;\n-  public static final long TARGET_GAS_USED = 10000000L;\n-  public static final long MAX_GAS_EIP1559 = 16000000L;\n-  public static final long EIP1559_DECAY_RANGE = MAX_GAS_EIP1559 / 20L;\n-  public static final long EIP1559_GAS_INCREMENT_AMOUNT =\n-      (MAX_GAS_EIP1559 / 2) / EIP1559_DECAY_RANGE;\n-  public static final long INITIAL_BASEFEE = 1000000000L;\n-  public static final long PER_TX_GASLIMIT = 8000000L;\n+public interface FeeMarket {\n+  static long eip1559BasefeeMaxChangeDenominator() {\n+    return 8L;\n+  }\n+\n+  static long eip1559TargetGasUsed() {\n+    return 10000000L;\n+  }\n+\n+  static long eip1559MaxGas() {\n+    return 16000000L;\n+  }\n+\n+  static long eip1559DecayRange() {\n+    return eip1559MaxGas() / 20L;\n+  }\n+\n+  static long eip1559GasIncrementAmount() {\n+    return (eip1559MaxGas() / 2) / eip1559DecayRange();\n+  }\n+\n+  static long eip1559InitialBasefee() {\n+    return 1000000000L;\n+  }\n+\n+  static long eip1559PerTxGaslimit() {\n+    return 8000000L;\n+  }\n }\n"}}, {"oid": "22a49084eb09ae499f8ad448b1524955cd2fe10c", "url": "https://github.com/hyperledger/besu/commit/22a49084eb09ae499f8ad448b1524955cd2fe10c", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T16:24:33Z", "type": "commit"}, {"oid": "9a2be3bd68d3a09b1653af5f33cb061f82015e8a", "url": "https://github.com/hyperledger/besu/commit/9a2be3bd68d3a09b1653af5f33cb061f82015e8a", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T16:44:26Z", "type": "commit"}, {"oid": "11d68c4c1f2725f4bf809096b3553c2cb7a17908", "url": "https://github.com/hyperledger/besu/commit/11d68c4c1f2725f4bf809096b3553c2cb7a17908", "message": "Merge remote-tracking branch 'upstream/master' into step-3-manager-class\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T16:47:09Z", "type": "commit"}, {"oid": "1b75ba74813da9833647c2600add1de7f65447d8", "url": "https://github.com/hyperledger/besu/commit/1b75ba74813da9833647c2600add1de7f65447d8", "message": "remove useless constructor\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T16:50:06Z", "type": "commit"}, {"oid": "95fceedf698cc14555c5602387ff904a9d042f9f", "url": "https://github.com/hyperledger/besu/commit/95fceedf698cc14555c5602387ff904a9d042f9f", "message": "add spdx header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T16:56:44Z", "type": "commit"}]}