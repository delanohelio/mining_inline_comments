{"pr_number": 680, "pr_title": "Update BesuController to work with NodeKey (not KeyPair)", "pr_createdAt": "2020-04-08T09:51:05Z", "pr_url": "https://github.com/hyperledger/besu/pull/680", "timeline": [{"oid": "c46b11d134fa96ee74c227025170d04141fa6192", "url": "https://github.com/hyperledger/besu/commit/c46b11d134fa96ee74c227025170d04141fa6192", "message": "Update BesuController to work with NodeKey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T01:50:51Z", "type": "commit"}, {"oid": "c46b11d134fa96ee74c227025170d04141fa6192", "url": "https://github.com/hyperledger/besu/commit/c46b11d134fa96ee74c227025170d04141fa6192", "message": "Update BesuController to work with NodeKey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T01:50:51Z", "type": "forcePushed"}, {"oid": "9c89d8dadda18a9a7d60e39511f79cb280ad9d4a", "url": "https://github.com/hyperledger/besu/commit/9c89d8dadda18a9a7d60e39511f79cb280ad9d4a", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T03:00:45Z", "type": "commit"}, {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "url": "https://github.com/hyperledger/besu/commit/6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "message": "Merge remote-tracking branch 'upstream/master' into update_controller2\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T03:16:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDU4NA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405934584", "bodyText": "Is there any change here except removing try/catch block?", "author": "usmansaleem", "createdAt": "2020-04-09T03:23:44Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -134,26 +133,21 @@ public void startNode(final BesuNode node) {\n             .withMetricsSystem(metricsSystem)\n             .build();\n \n-    final BesuController<?> besuController;\n-    try {\n-      besuController =\n-          builder\n-              .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n-              .dataDirectory(node.homeDirectory())\n-              .miningParameters(node.getMiningParameters())\n-              .privacyParameters(node.getPrivacyParameters())\n-              .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))\n-              .metricsSystem(metricsSystem)\n-              .transactionPoolConfiguration(TransactionPoolConfiguration.builder().build())\n-              .ethProtocolConfiguration(EthProtocolConfiguration.defaultConfig())\n-              .clock(Clock.systemUTC())\n-              .isRevertReasonEnabled(node.isRevertReasonEnabled())\n-              .storageProvider(storageProvider)\n-              .targetGasLimit(GasLimitCalculator.DEFAULT)\n-              .build();\n-    } catch (final IOException e) {\n-      throw new RuntimeException(\"Error building BesuController\", e);\n-    }\n+    final BesuController<?> besuController =\n+        builder\n+            .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n+            .dataDirectory(node.homeDirectory())\n+            .miningParameters(node.getMiningParameters())\n+            .privacyParameters(node.getPrivacyParameters())\n+            .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjI4Mw==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936283", "bodyText": "not sure why this is no longer required - will look into it - but yes, its the removal of the try/catch", "author": "rain-on", "createdAt": "2020-04-09T03:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1Njk5Mw==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405956993", "bodyText": "Think can still fail here with an IOException probably trying to load the private key from file", "author": "jframe", "createdAt": "2020-04-09T04:59:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDU4NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTQxMA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405935410", "bodyText": "shouldn't this be protected or private?", "author": "usmansaleem", "createdAt": "2020-04-09T03:27:26Z", "path": "besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java", "diffHunk": "@@ -85,7 +85,7 @@\n   protected PrivacyParameters privacyParameters;\n   protected Path dataDirectory;\n   protected Clock clock;\n-  KeyPair nodeKeys;\n+  NodeKey nodeKey;", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjI5MA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936290", "bodyText": "no - this is a builder, so this field has a setter.", "author": "rain-on", "createdAt": "2020-04-09T03:31:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1ODIzNw==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405958237", "bodyText": "Looks like it could be protected", "author": "jframe", "createdAt": "2020-04-09T05:05:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTQxMA=="}], "type": "inlineReview", "revised_code": {"commit": "15aab7125bc79cc016161bd35af03c02802d4160", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java b/besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java\nindex dcdcee61b..026e07e14 100644\n--- a/besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java\n+++ b/besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java\n\n@@ -85,7 +85,7 @@ public abstract class BesuControllerBuilder<C> {\n   protected PrivacyParameters privacyParameters;\n   protected Path dataDirectory;\n   protected Clock clock;\n-  NodeKey nodeKey;\n+  protected NodeKey nodeKey;\n   protected boolean isRevertReasonEnabled;\n   GasLimitCalculator gasLimitCalculator;\n   private StorageProvider storageProvider;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTc5OA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405935798", "bodyText": "nit: getNodeKey instead of accessing super class member variable.", "author": "usmansaleem", "createdAt": "2020-04-09T03:29:06Z", "path": "besu/src/main/java/org/hyperledger/besu/controller/CliqueBesuControllerBuilder.java", "diffHunk": "@@ -57,7 +56,7 @@\n \n   @Override\n   protected void prepForBuild() {\n-    localAddress = Util.publicKeyToAddress(nodeKeys.getPublicKey());\n+    localAddress = Util.publicKeyToAddress(nodeKey.getPublicKey());", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjM3Mg==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936372", "bodyText": "trying to leave as much untouched as possible - so wanted to leave this as is", "author": "rain-on", "createdAt": "2020-04-09T03:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjU5Mg==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936592", "bodyText": "fair enough.", "author": "usmansaleem", "createdAt": "2020-04-09T03:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTc5OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjEyNQ==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936125", "bodyText": "same as before, getNodeKey() instead of nodeKey??", "author": "usmansaleem", "createdAt": "2020-04-09T03:30:32Z", "path": "besu/src/main/java/org/hyperledger/besu/controller/IbftBesuControllerBuilder.java", "diffHunk": "@@ -208,7 +204,6 @@ protected MiningCoordinator createMiningCoordinator(\n \n   @Override\n   protected PluginServiceFactory createAdditionalPluginServices(final Blockchain blockchain) {\n-    final NodeKey nodeKey = new BouncyCastleNodeKey(nodeKeys);\n     return new IbftQueryPluginServiceFactory(blockchain, nodeKey);", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNzExOQ==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405937119", "bodyText": "as above - trying to leave things untouched.", "author": "rain-on", "createdAt": "2020-04-09T03:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjEyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NzQ4MQ==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405957481", "bodyText": "Why did you remove the try/catch here?", "author": "jframe", "createdAt": "2020-04-09T05:01:57Z", "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1224,40 +1224,36 @@ private BesuCommand controller() {\n   }\n \n   public BesuControllerBuilder<?> getControllerBuilder() {\n-    try {\n-      addConfigurationService();\n-      return controllerBuilderFactory\n-          .fromEthNetworkConfig(updateNetworkConfig(getNetwork()), genesisConfigOverrides)\n-          .synchronizerConfiguration(buildSyncConfig())\n-          .ethProtocolConfiguration(ethProtocolOptions.toDomainObject())\n-          .dataDirectory(dataDir())\n-          .miningParameters(\n-              new MiningParameters(\n-                  coinbase,\n-                  minTransactionGasPrice,\n-                  extraData,\n-                  isMiningEnabled,\n-                  iStratumMiningEnabled,\n-                  stratumNetworkInterface,\n-                  stratumPort,\n-                  stratumExtranonce,\n-                  Optional.empty()))\n-          .transactionPoolConfiguration(buildTransactionPoolConfiguration())\n-          .nodePrivateKeyFile(nodePrivateKeyFile())\n-          .metricsSystem(metricsSystem.get())\n-          .privacyParameters(privacyParameters())\n-          .clock(Clock.systemUTC())\n-          .isRevertReasonEnabled(isRevertReasonEnabled)\n-          .storageProvider(keyStorageProvider(keyValueStorageName))\n-          .isPruningEnabled(isPruningEnabled())\n-          .pruningConfiguration(\n-              new PrunerConfiguration(pruningBlockConfirmations, pruningBlocksRetained))\n-          .genesisConfigOverrides(genesisConfigOverrides)\n-          .targetGasLimit(targetGasLimit == null ? Optional.empty() : Optional.of(targetGasLimit))\n-          .requiredBlocks(requiredBlocks);\n-    } catch (final IOException e) {\n-      throw new ExecutionException(this.commandLine, \"Invalid path\", e);\n-    }\n+    addConfigurationService();", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NDY2MA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405964660", "bodyText": "The IOException is caught in the loader, then rethrown as an IllegalArgumentException - so this seemed superfluous.", "author": "rain-on", "createdAt": "2020-04-09T05:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NzQ4MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTEzMw==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405959133", "bodyText": "nit: NodeKey instead of nodeKey", "author": "jframe", "createdAt": "2020-04-09T05:08:57Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java", "diffHunk": "@@ -431,7 +429,7 @@ private P2PNetwork doBuild() {\n     }\n \n     private void validate() {\n-      checkState(keyPair != null, \"KeyPair must be set.\");\n+      checkState(nodeKey != null, \"nodeKey must be set.\");", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NTAxMg==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405965012", "bodyText": "done", "author": "rain-on", "createdAt": "2020-04-09T05:31:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTEzMw=="}], "type": "inlineReview", "revised_code": {"commit": "15aab7125bc79cc016161bd35af03c02802d4160", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java\nindex a4112a650..1176464e1 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java\n\n@@ -429,7 +429,7 @@ public class DefaultP2PNetwork implements P2PNetwork {\n     }\n \n     private void validate() {\n-      checkState(nodeKey != null, \"nodeKey must be set.\");\n+      checkState(nodeKey != null, \"NodeKey must be set.\");\n       checkState(config != null, \"NetworkingConfiguration must be set.\");\n       checkState(\n           supportedCapabilities != null && supportedCapabilities.size() > 0,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTI1NA==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405959254", "bodyText": "nit: nodeKey instead of NodeKey", "author": "jframe", "createdAt": "2020-04-09T05:09:26Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java", "diffHunk": "@@ -563,17 +563,17 @@ public RlpxAgent build() {\n     }\n \n     private void validate() {\n-      checkState(keyPair != null, \"KeyPair must be configured\");\n+      checkState(nodeKey != null, \"nodeKey must be configured\");", "originalCommit": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk2NTExNw==", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405965117", "bodyText": "done", "author": "rain-on", "createdAt": "2020-04-09T05:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTI1NA=="}], "type": "inlineReview", "revised_code": {"commit": "15aab7125bc79cc016161bd35af03c02802d4160", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java\nindex 6d40ecd66..565187ec0 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java\n\n@@ -563,7 +563,7 @@ public class RlpxAgent {\n     }\n \n     private void validate() {\n-      checkState(nodeKey != null, \"nodeKey must be configured\");\n+      checkState(nodeKey != null, \"NodeKey must be configured\");\n       checkState(localNode != null, \"LocalNode must be configured\");\n       checkState(config != null, \"RlpxConfiguration must be set\");\n       checkState(peerPrivileges != null, \"PeerPrivileges must be configured\");\n"}}, {"oid": "5da822ca14c4618a43dee4ccb3d311bec18e5209", "url": "https://github.com/hyperledger/besu/commit/5da822ca14c4618a43dee4ccb3d311bec18e5209", "message": "Rename nodekeys to nodekey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T05:19:39Z", "type": "commit"}, {"oid": "15aab7125bc79cc016161bd35af03c02802d4160", "url": "https://github.com/hyperledger/besu/commit/15aab7125bc79cc016161bd35af03c02802d4160", "message": "Post review\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-04-09T05:32:20Z", "type": "commit"}]}