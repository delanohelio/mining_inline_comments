{"pr_number": 402, "pr_title": "Private state update metadata and migration (release 1.4)", "pr_createdAt": "2020-02-14T03:19:57Z", "pr_url": "https://github.com/hyperledger/besu/pull/402", "timeline": [{"oid": "8d9f4aadc8936f1c808c78a27aee96053b529d6a", "url": "https://github.com/hyperledger/besu/commit/8d9f4aadc8936f1c808c78a27aee96053b529d6a", "message": "Private state update metadata and migration\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-02T20:05:59Z", "type": "commit"}, {"oid": "c28fb51b2ec52bed4e940b649fb2bb0382b267bb", "url": "https://github.com/hyperledger/besu/commit/c28fb51b2ec52bed4e940b649fb2bb0382b267bb", "message": "Fix migration of failed txs\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-03T19:48:41Z", "type": "commit"}, {"oid": "2d7ea371fa5573d78b2b11288c943b7abfb7a38e", "url": "https://github.com/hyperledger/besu/commit/2d7ea371fa5573d78b2b11288c943b7abfb7a38e", "message": "Remove restriction for priv_call\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T08:33:00Z", "type": "commit"}, {"oid": "b6d28554ec4b045431de404d5a2a84ccf0f12bfa", "url": "https://github.com/hyperledger/besu/commit/b6d28554ec4b045431de404d5a2a84ccf0f12bfa", "message": "Merge branch 'master' into updated-migration\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T08:36:35Z", "type": "commit"}, {"oid": "73adcf1fd55d42b8af9b9f78e70f15e106e91023", "url": "https://github.com/hyperledger/besu/commit/73adcf1fd55d42b8af9b9f78e70f15e106e91023", "message": "Fix import\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T21:47:45Z", "type": "commit"}, {"oid": "174021110de164438c39063fcfb6c3bfe11f66ef", "url": "https://github.com/hyperledger/besu/commit/174021110de164438c39063fcfb6c3bfe11f66ef", "message": "Merge branch 'master' into updated-migration\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T21:48:38Z", "type": "commit"}, {"oid": "5111882b16196d93e9a647bb15062120d143e93f", "url": "https://github.com/hyperledger/besu/commit/5111882b16196d93e9a647bb15062120d143e93f", "message": "Fix unit test\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T22:29:58Z", "type": "commit"}, {"oid": "aa0f1a6d55d0332ed7dbd9f38132cc7448ac9836", "url": "https://github.com/hyperledger/besu/commit/aa0f1a6d55d0332ed7dbd9f38132cc7448ac9836", "message": "Changed migration msg\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-04T23:30:29Z", "type": "commit"}, {"oid": "dc7917d65f2a37faf2cb8b1bbaf2a0c6c1561b92", "url": "https://github.com/hyperledger/besu/commit/dc7917d65f2a37faf2cb8b1bbaf2a0c6c1561b92", "message": "Merge branch 'master' into updated-migration", "committedDate": "2020-02-06T22:18:01Z", "type": "commit"}, {"oid": "f4da438a3fb9bdfb8600f5a888e91dac51dde311", "url": "https://github.com/hyperledger/besu/commit/f4da438a3fb9bdfb8600f5a888e91dac51dde311", "message": "Merge branch 'master' into updated-migration\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-10T00:57:20Z", "type": "commit"}, {"oid": "ea2af209972b6fc47351d86476bfb7b2a3199768", "url": "https://github.com/hyperledger/besu/commit/ea2af209972b6fc47351d86476bfb7b2a3199768", "message": "Minor PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T00:55:30Z", "type": "commit"}, {"oid": "6fce1b2df2120de7cc76fefbda72d9a4cc96a140", "url": "https://github.com/hyperledger/besu/commit/6fce1b2df2120de7cc76fefbda72d9a4cc96a140", "message": "Reorg test\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T03:07:57Z", "type": "commit"}, {"oid": "65704c24b17e676f2b8c5a22e4f2ab7350c86c31", "url": "https://github.com/hyperledger/besu/commit/65704c24b17e676f2b8c5a22e4f2ab7350c86c31", "message": "Spotless\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T03:12:43Z", "type": "commit"}, {"oid": "118c7e5f16b2f5b9dd449277828417dcf066920b", "url": "https://github.com/hyperledger/besu/commit/118c7e5f16b2f5b9dd449277828417dcf066920b", "message": "Fix unused warnings\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T03:42:08Z", "type": "commit"}, {"oid": "9652a9d4f44fc902e053656bbb634f8c8c6c3491", "url": "https://github.com/hyperledger/besu/commit/9652a9d4f44fc902e053656bbb634f8c8c6c3491", "message": "Revert \"Fix unused warnings\"\n\nThis reverts commit 118c7e5f\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T04:15:01Z", "type": "commit"}, {"oid": "16d938a8e6f853146b52a730d27b63c10903e475", "url": "https://github.com/hyperledger/besu/commit/16d938a8e6f853146b52a730d27b63c10903e475", "message": "Fix test\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T04:19:03Z", "type": "commit"}, {"oid": "57194da630a4c26a3ffc26ea5d05b804ef7ed5dc", "url": "https://github.com/hyperledger/besu/commit/57194da630a4c26a3ffc26ea5d05b804ef7ed5dc", "message": "Handling enclave error\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T06:25:37Z", "type": "commit"}, {"oid": "26539385684aa99037daedd86e1175a7dd5eebbe", "url": "https://github.com/hyperledger/besu/commit/26539385684aa99037daedd86e1175a7dd5eebbe", "message": "Merge branch 'master' into updated-migration\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T06:32:08Z", "type": "commit"}, {"oid": "e095b5be26a11a7724ae8b13b4b37f9adc7b58ad", "url": "https://github.com/hyperledger/besu/commit/e095b5be26a11a7724ae8b13b4b37f9adc7b58ad", "message": "Merge\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-11T06:38:51Z", "type": "commit"}, {"oid": "ca1147614a32014dfff2b680e9bb9fe2692a3577", "url": "https://github.com/hyperledger/besu/commit/ca1147614a32014dfff2b680e9bb9fe2692a3577", "message": "Fix AT\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-13T01:57:58Z", "type": "commit"}, {"oid": "177982f75365225f139aa75958d872d314c3a13e", "url": "https://github.com/hyperledger/besu/commit/177982f75365225f139aa75958d872d314c3a13e", "message": "[draft] private metadata migration v2\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-13T01:58:46Z", "type": "commit"}, {"oid": "5c5b83cceebecc4cafe9fc7d034f862dfa84a0f2", "url": "https://github.com/hyperledger/besu/commit/5c5b83cceebecc4cafe9fc7d034f862dfa84a0f2", "message": "Updated migration logic\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T02:59:18Z", "type": "commit"}, {"oid": "472073802706e640270f599ddf478a06c23aa86b", "url": "https://github.com/hyperledger/besu/commit/472073802706e640270f599ddf478a06c23aa86b", "message": "Fix rawtypes warning\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T03:16:46Z", "type": "commit"}, {"oid": "241d6a6bace7d387763f086476be4c42adc95631", "url": "https://github.com/hyperledger/besu/commit/241d6a6bace7d387763f086476be4c42adc95631", "message": "Merge branch 'release-1.4' into updated-migration-1.4\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T03:17:26Z", "type": "commit"}, {"oid": "dcd07e130b7406f8b8b2c0a96f25494c1709296b", "url": "https://github.com/hyperledger/besu/commit/dcd07e130b7406f8b8b2c0a96f25494c1709296b", "message": "Added private storage migration docs\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T03:35:57Z", "type": "commit"}, {"oid": "6b193c14221bd3067c3a16eb1e4b4cd140d02c5b", "url": "https://github.com/hyperledger/besu/commit/6b193c14221bd3067c3a16eb1e4b4cd140d02c5b", "message": "Updating changelog\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T03:43:32Z", "type": "commit"}, {"oid": "3808fe07507a5b9c3c496fccf67bff5439ae0ae5", "url": "https://github.com/hyperledger/besu/commit/3808fe07507a5b9c3c496fccf67bff5439ae0ae5", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T05:08:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0NzA4Mg==", "url": "https://github.com/hyperledger/besu/pull/402#discussion_r379247082", "bodyText": "are you sure about the index+1? I would have thought that index is the actual index to use for the pmt ...\nNot that it really matters, we would only execute one transaction that we don't have to execute ...", "author": "pinges", "createdAt": "2020-02-14T04:34:14Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.privacy.storage.migration;\n+\n+import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_x;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Block;\n+import org.hyperledger.besu.ethereum.core.BlockHeader;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.MutableWorldState;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.mainnet.ProtocolSchedule;\n+import org.hyperledger.besu.ethereum.mainnet.ProtocolSpec;\n+import org.hyperledger.besu.ethereum.privacy.PrivateStateRootResolver;\n+import org.hyperledger.besu.ethereum.privacy.storage.LegacyPrivateStateStorage;\n+import org.hyperledger.besu.ethereum.privacy.storage.PrivacyGroupHeadBlockMap;\n+import org.hyperledger.besu.ethereum.privacy.storage.PrivateStateStorage;\n+import org.hyperledger.besu.ethereum.worldstate.WorldStateArchive;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class PrivateStorageMigration {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final Blockchain blockchain;\n+  private final Address privacyPrecompileAddress;\n+  private final ProtocolSchedule<?> protocolSchedule;\n+  private final WorldStateArchive publicWorldStateArchive;\n+  private final PrivateStateStorage privateStateStorage;\n+  private final PrivateStateRootResolver privateStateRootResolver;\n+  private final LegacyPrivateStateStorage legacyPrivateStateStorage;\n+  private final Function<ProtocolSpec<?>, PrivateMigrationBlockProcessor>\n+      privateMigrationBlockProcessorBuilder;\n+\n+  public PrivateStorageMigration(\n+      final Blockchain blockchain,\n+      final Address privacyPrecompileAddress,\n+      final ProtocolSchedule<?> protocolSchedule,\n+      final WorldStateArchive publicWorldStateArchive,\n+      final PrivateStateStorage privateStateStorage,\n+      final PrivateStateRootResolver privateStateRootResolver,\n+      final LegacyPrivateStateStorage legacyPrivateStateStorage,\n+      final Function<ProtocolSpec<?>, PrivateMigrationBlockProcessor>\n+          privateMigrationBlockProcessorBuilder) {\n+    this.privateStateStorage = privateStateStorage;\n+    this.blockchain = blockchain;\n+    this.privacyPrecompileAddress = privacyPrecompileAddress;\n+    this.protocolSchedule = protocolSchedule;\n+    this.publicWorldStateArchive = publicWorldStateArchive;\n+    this.privateStateRootResolver = privateStateRootResolver;\n+    this.legacyPrivateStateStorage = legacyPrivateStateStorage;\n+    this.privateMigrationBlockProcessorBuilder = privateMigrationBlockProcessorBuilder;\n+  }\n+\n+  public void migratePrivateStorage() {\n+    final long migrationStartTimestamp = System.currentTimeMillis();\n+    final long chainHeadBlockNumber = blockchain.getChainHeadBlockNumber();\n+\n+    LOG.info(\"Migrating private storage database...\");\n+\n+    for (int blockNumber = 0; blockNumber <= chainHeadBlockNumber; blockNumber++) {\n+      final Block block =\n+          blockchain\n+              .getBlockByNumber(blockNumber)\n+              .orElseThrow(PrivateStorageMigrationException::new);\n+      final Hash blockHash = block.getHash();\n+      final BlockHeader blockHeader = block.getHeader();\n+      LOG.info(\"Processing block {} ({}/{})\", blockHash, blockNumber, chainHeadBlockNumber);\n+\n+      createPrivacyGroupHeadBlockMap(blockHeader);\n+\n+      final int lastPmtIndex = findLastPMTIndexInBlock(block);\n+      if (lastPmtIndex >= 0) {\n+        final ProtocolSpec<?> protocolSpec = protocolSchedule.getByBlockNumber(blockNumber);\n+        final PrivateMigrationBlockProcessor privateMigrationBlockProcessor =\n+            privateMigrationBlockProcessorBuilder.apply(protocolSpec);\n+\n+        final MutableWorldState publicWorldState =\n+            blockchain\n+                .getBlockHeader(blockHeader.getParentHash())\n+                .map(BlockHeader::getStateRoot)\n+                .flatMap(publicWorldStateArchive::getMutable)\n+                .orElseThrow(PrivateStorageMigrationException::new);\n+\n+        final List<Transaction> transactionsToProcess =\n+            block.getBody().getTransactions().subList(0, lastPmtIndex + 1);", "originalCommit": "6b193c14221bd3067c3a16eb1e4b4cd140d02c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI2MzMxOA==", "url": "https://github.com/hyperledger/besu/pull/402#discussion_r379263318", "bodyText": "The sublist params are (inclusive, exclusive). We have a unit test checking the logic :)", "author": "lucassaldanha", "createdAt": "2020-02-14T06:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0NzA4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "84174cf44d3f6ce298dea8c616b7835b2d1a9e9d", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\nindex 3945337ad..5f25246f8 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\n\n@@ -14,7 +14,7 @@\n  */\n package org.hyperledger.besu.ethereum.privacy.storage.migration;\n \n-import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_x;\n+import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_0;\n \n import org.hyperledger.besu.ethereum.chain.Blockchain;\n import org.hyperledger.besu.ethereum.core.Address;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0ODUzMw==", "url": "https://github.com/hyperledger/besu/pull/402#discussion_r379248533", "bodyText": "I'm not sure about the constant name for the schema version. This is going to be the version from 1.4 onwards, but maybe we are going to change the schema within the 1.4 versions again ...\nMaybe introduce an Enum for the version number that could be used to match the version number to a String that could be used to have meaningful error messages ...", "author": "pinges", "createdAt": "2020-02-14T04:43:02Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java", "diffHunk": "@@ -0,0 +1,176 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.privacy.storage.migration;\n+\n+import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_x;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Block;\n+import org.hyperledger.besu.ethereum.core.BlockHeader;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.MutableWorldState;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.mainnet.ProtocolSchedule;\n+import org.hyperledger.besu.ethereum.mainnet.ProtocolSpec;\n+import org.hyperledger.besu.ethereum.privacy.PrivateStateRootResolver;\n+import org.hyperledger.besu.ethereum.privacy.storage.LegacyPrivateStateStorage;\n+import org.hyperledger.besu.ethereum.privacy.storage.PrivacyGroupHeadBlockMap;\n+import org.hyperledger.besu.ethereum.privacy.storage.PrivateStateStorage;\n+import org.hyperledger.besu.ethereum.worldstate.WorldStateArchive;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class PrivateStorageMigration {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final Blockchain blockchain;\n+  private final Address privacyPrecompileAddress;\n+  private final ProtocolSchedule<?> protocolSchedule;\n+  private final WorldStateArchive publicWorldStateArchive;\n+  private final PrivateStateStorage privateStateStorage;\n+  private final PrivateStateRootResolver privateStateRootResolver;\n+  private final LegacyPrivateStateStorage legacyPrivateStateStorage;\n+  private final Function<ProtocolSpec<?>, PrivateMigrationBlockProcessor>\n+      privateMigrationBlockProcessorBuilder;\n+\n+  public PrivateStorageMigration(\n+      final Blockchain blockchain,\n+      final Address privacyPrecompileAddress,\n+      final ProtocolSchedule<?> protocolSchedule,\n+      final WorldStateArchive publicWorldStateArchive,\n+      final PrivateStateStorage privateStateStorage,\n+      final PrivateStateRootResolver privateStateRootResolver,\n+      final LegacyPrivateStateStorage legacyPrivateStateStorage,\n+      final Function<ProtocolSpec<?>, PrivateMigrationBlockProcessor>\n+          privateMigrationBlockProcessorBuilder) {\n+    this.privateStateStorage = privateStateStorage;\n+    this.blockchain = blockchain;\n+    this.privacyPrecompileAddress = privacyPrecompileAddress;\n+    this.protocolSchedule = protocolSchedule;\n+    this.publicWorldStateArchive = publicWorldStateArchive;\n+    this.privateStateRootResolver = privateStateRootResolver;\n+    this.legacyPrivateStateStorage = legacyPrivateStateStorage;\n+    this.privateMigrationBlockProcessorBuilder = privateMigrationBlockProcessorBuilder;\n+  }\n+\n+  public void migratePrivateStorage() {\n+    final long migrationStartTimestamp = System.currentTimeMillis();\n+    final long chainHeadBlockNumber = blockchain.getChainHeadBlockNumber();\n+\n+    LOG.info(\"Migrating private storage database...\");\n+\n+    for (int blockNumber = 0; blockNumber <= chainHeadBlockNumber; blockNumber++) {\n+      final Block block =\n+          blockchain\n+              .getBlockByNumber(blockNumber)\n+              .orElseThrow(PrivateStorageMigrationException::new);\n+      final Hash blockHash = block.getHash();\n+      final BlockHeader blockHeader = block.getHeader();\n+      LOG.info(\"Processing block {} ({}/{})\", blockHash, blockNumber, chainHeadBlockNumber);\n+\n+      createPrivacyGroupHeadBlockMap(blockHeader);\n+\n+      final int lastPmtIndex = findLastPMTIndexInBlock(block);\n+      if (lastPmtIndex >= 0) {\n+        final ProtocolSpec<?> protocolSpec = protocolSchedule.getByBlockNumber(blockNumber);\n+        final PrivateMigrationBlockProcessor privateMigrationBlockProcessor =\n+            privateMigrationBlockProcessorBuilder.apply(protocolSpec);\n+\n+        final MutableWorldState publicWorldState =\n+            blockchain\n+                .getBlockHeader(blockHeader.getParentHash())\n+                .map(BlockHeader::getStateRoot)\n+                .flatMap(publicWorldStateArchive::getMutable)\n+                .orElseThrow(PrivateStorageMigrationException::new);\n+\n+        final List<Transaction> transactionsToProcess =\n+            block.getBody().getTransactions().subList(0, lastPmtIndex + 1);\n+        final List<BlockHeader> ommers = block.getBody().getOmmers();\n+\n+        privateMigrationBlockProcessor.processBlock(\n+            blockchain, publicWorldState, blockHeader, transactionsToProcess, ommers);\n+      }\n+    }\n+\n+    if (isResultingPrivateStateRootAtHeadValid()) {\n+      privateStateStorage.updater().putDatabaseVersion(SCHEMA_VERSION_1_4_x).commit();", "originalCommit": "6b193c14221bd3067c3a16eb1e4b4cd140d02c5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI2MzUyNg==", "url": "https://github.com/hyperledger/besu/pull/402#discussion_r379263526", "bodyText": "I'll rename the constants to SCHEMA_VERSION_1_0_0 and SCHEMA_VERSION_1_4_0 to make it clearer that they are specific to this release. Let's save the enum idea for when we need to change the version again! :)", "author": "lucassaldanha", "createdAt": "2020-02-14T06:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI0ODUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "84174cf44d3f6ce298dea8c616b7835b2d1a9e9d", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\nindex 3945337ad..5f25246f8 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/storage/migration/PrivateStorageMigration.java\n\n@@ -14,7 +14,7 @@\n  */\n package org.hyperledger.besu.ethereum.privacy.storage.migration;\n \n-import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_x;\n+import static org.hyperledger.besu.ethereum.privacy.storage.PrivateStateKeyValueStorage.SCHEMA_VERSION_1_4_0;\n \n import org.hyperledger.besu.ethereum.chain.Blockchain;\n import org.hyperledger.besu.ethereum.core.Address;\n"}}, {"oid": "84174cf44d3f6ce298dea8c616b7835b2d1a9e9d", "url": "https://github.com/hyperledger/besu/commit/84174cf44d3f6ce298dea8c616b7835b2d1a9e9d", "message": "Renaming constants\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-02-14T06:05:49Z", "type": "commit"}]}