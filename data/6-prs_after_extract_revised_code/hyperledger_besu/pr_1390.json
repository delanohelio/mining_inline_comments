{"pr_number": 1390, "pr_title": "handle case where onchain groups do not exist", "pr_createdAt": "2020-09-22T06:41:55Z", "pr_url": "https://github.com/hyperledger/besu/pull/1390", "timeline": [{"oid": "cf2fae65bec41d6f9ff4493db2b1c962c6ba80af", "url": "https://github.com/hyperledger/besu/commit/cf2fae65bec41d6f9ff4493db2b1c962c6ba80af", "message": "handle case where onchain groups do not exist\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-09-22T06:37:32Z", "type": "commit"}, {"oid": "f1654e26f4af65eda4407869f1b575860a0ccfa3", "url": "https://github.com/hyperledger/besu/commit/f1654e26f4af65eda4407869f1b575860a0ccfa3", "message": "added constructor so the tests can mock the onchain management contract\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-09-24T03:07:51Z", "type": "commit"}, {"oid": "b239bdf83d25c701cac54e08256c0200621d40b9", "url": "https://github.com/hyperledger/besu/commit/b239bdf83d25c701cac54e08256c0200621d40b9", "message": "removed TODO comment\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-09-24T03:09:17Z", "type": "commit"}, {"oid": "21befdae84ef8a7a211f38351253241d0c095e40", "url": "https://github.com/hyperledger/besu/commit/21befdae84ef8a7a211f38351253241d0c095e40", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into onchain-mt", "committedDate": "2020-09-24T03:10:02Z", "type": "commit"}, {"oid": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a", "url": "https://github.com/hyperledger/besu/commit/33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a", "message": "unused variable\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-09-24T03:15:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NjM0Mg==", "url": "https://github.com/hyperledger/besu/pull/1390#discussion_r494056342", "bodyText": "It feels like this logic could be polished a bit. Maybe separating the logic for finding a ground onchain vs offchain in separate methods would make it a bit easier to read?", "author": "lucassaldanha", "createdAt": "2020-09-24T05:58:46Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java", "diffHunk": "@@ -260,17 +273,28 @@ public void verifyPrivacyGroupContainsEnclavePublicKey(\n   public void verifyPrivacyGroupContainsEnclavePublicKey(\n       final String privacyGroupId, final String enclavePublicKey, final Optional<Long> blockNumber)\n       throws MultiTenancyValidationException {\n-    // TODO: There's potentially a bug here where an onchain privacyGroup\n-    // that isn't found will default to the offchain privacy group.\n-    final PrivacyGroup privacyGroup =\n-        onchainPrivacyGroupContract\n-            .flatMap(\n-                contract -> contract.getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber))\n-            .orElse(enclave.retrievePrivacyGroup(privacyGroupId));\n-\n-    if (!privacyGroup.getMembers().contains(enclavePublicKey)) {\n-      throw new MultiTenancyValidationException(\n-          \"Privacy group must contain the enclave public key\");\n+    Optional<PrivacyGroup> maybePrivacyGroup;\n+    PrivacyGroup offchainPrivacyGroup;\n+    if (onchainPrivacyGroupContract.isPresent()) {\n+      maybePrivacyGroup =\n+          onchainPrivacyGroupContract\n+              .get()\n+              .getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber);\n+      if (maybePrivacyGroup.isEmpty()) {\n+        // group doesn't exist yet - this is normal for onchain privacy groups\n+      } else {\n+        // group DOES exist - does it contain the user?\n+        if (!maybePrivacyGroup.get().getMembers().contains(enclavePublicKey)) {\n+          throw new MultiTenancyValidationException(\n+              \"Privacy group must contain the enclave public key\");\n+        }", "originalCommit": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c8ea173edb78fd6e592e31b57ed1c0d251d3c459", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\nindex 6ba9bd8c3e..8e3d8fcde6 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\n\n@@ -273,31 +273,44 @@ public class MultiTenancyPrivacyController implements PrivacyController {\n   public void verifyPrivacyGroupContainsEnclavePublicKey(\n       final String privacyGroupId, final String enclavePublicKey, final Optional<Long> blockNumber)\n       throws MultiTenancyValidationException {\n-    Optional<PrivacyGroup> maybePrivacyGroup;\n-    PrivacyGroup offchainPrivacyGroup;\n-    if (onchainPrivacyGroupContract.isPresent()) {\n-      maybePrivacyGroup =\n-          onchainPrivacyGroupContract\n-              .get()\n-              .getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber);\n-      if (maybePrivacyGroup.isEmpty()) {\n-        // group doesn't exist yet - this is normal for onchain privacy groups\n-      } else {\n-        // group DOES exist - does it contain the user?\n-        if (!maybePrivacyGroup.get().getMembers().contains(enclavePublicKey)) {\n-          throw new MultiTenancyValidationException(\n-              \"Privacy group must contain the enclave public key\");\n-        }\n-      }\n-    } else {\n-      offchainPrivacyGroup = enclave.retrievePrivacyGroup(privacyGroupId);\n-      if (!offchainPrivacyGroup.getMembers().contains(enclavePublicKey)) {\n-        throw new MultiTenancyValidationException(\n-            \"Privacy group must contain the enclave public key\");\n-      }\n+    onchainPrivacyGroupContract.ifPresentOrElse(\n+        (contract) -> {\n+          verifyOnchainPrivacyGroupContainsMember(\n+              contract, privacyGroupId, enclavePublicKey, blockNumber);\n+        },\n+        () -> {\n+          verifyOffchainPrivacyGroupContainsMember(privacyGroupId, enclavePublicKey);\n+        });\n+  }\n+\n+  private void verifyOffchainPrivacyGroupContainsMember(\n+      final String privacyGroupId, final String enclavePublicKey) {\n+    final PrivacyGroup offchainPrivacyGroup = enclave.retrievePrivacyGroup(privacyGroupId);\n+    if (!offchainPrivacyGroup.getMembers().contains(enclavePublicKey)) {\n+      throw new MultiTenancyValidationException(\n+          \"Privacy group must contain the enclave public key\");\n     }\n   }\n \n+  private void verifyOnchainPrivacyGroupContainsMember(\n+      final OnchainPrivacyGroupContract contract,\n+      final String privacyGroupId,\n+      final String enclavePublicKey,\n+      final Optional<Long> blockNumber) {\n+    final Optional<PrivacyGroup> maybePrivacyGroup =\n+        contract.getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber);\n+    // IF the group exists, check member\n+    // ELSE member is valid if the group doesn't exist yet - this is normal for onchain privacy\n+    // groups\n+    maybePrivacyGroup.ifPresent(\n+        (group) -> {\n+          if (!group.getMembers().contains(enclavePublicKey)) {\n+            throw new MultiTenancyValidationException(\n+                \"Privacy group must contain the enclave public key\");\n+          }\n+        });\n+  }\n+\n   @Override\n   public PrivateTransactionSimulator getTransactionSimulator() {\n     return privacyController.getTransactionSimulator();\n"}}, {"oid": "c8ea173edb78fd6e592e31b57ed1c0d251d3c459", "url": "https://github.com/hyperledger/besu/commit/c8ea173edb78fd6e592e31b57ed1c0d251d3c459", "message": "refactoring\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-09-24T21:25:54Z", "type": "commit"}]}