{"pr_number": 1192, "pr_title": "Flatten EVM Loop", "pr_createdAt": "2020-07-03T21:55:26Z", "pr_url": "https://github.com/hyperledger/besu/pull/1192", "timeline": [{"oid": "3f83bdc9548ceabc1fcef69ac3842c2f60fcfd85", "url": "https://github.com/hyperledger/besu/commit/3f83bdc9548ceabc1fcef69ac3842c2f60fcfd85", "message": "first proof of concept\n\nJumpi shows good improvement in the loop tests.  Not all operations\nimplemented.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T02:17:27Z", "type": "commit"}, {"oid": "25f29eff7c2d891b5e1ac9aab3b5a39a7f388f38", "url": "https://github.com/hyperledger/besu/commit/25f29eff7c2d891b5e1ac9aab3b5a39a7f388f38", "message": "fixed cost operations\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T15:31:23Z", "type": "commit"}, {"oid": "5b4cefef9d99f53f2273962ef3eb777895737837", "url": "https://github.com/hyperledger/besu/commit/5b4cefef9d99f53f2273962ef3eb777895737837", "message": "test pass\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T21:37:34Z", "type": "commit"}, {"oid": "77257620428d7678a36e721d50e268ed3e6e40b3", "url": "https://github.com/hyperledger/besu/commit/77257620428d7678a36e721d50e268ed3e6e40b3", "message": "merge\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T21:54:13Z", "type": "commit"}, {"oid": "e3df258eaabb9cf4e0e032394e2ba457682895fc", "url": "https://github.com/hyperledger/besu/commit/e3df258eaabb9cf4e0e032394e2ba457682895fc", "message": "small fixes\n\nfix versions\nremove ExceptionalHaltException\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T22:21:12Z", "type": "commit"}, {"oid": "e3df258eaabb9cf4e0e032394e2ba457682895fc", "url": "https://github.com/hyperledger/besu/commit/e3df258eaabb9cf4e0e032394e2ba457682895fc", "message": "small fixes\n\nfix versions\nremove ExceptionalHaltException\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-03T22:21:12Z", "type": "forcePushed"}, {"oid": "06c627abcbd351ff635fb4194e1240335c1057e9", "url": "https://github.com/hyperledger/besu/commit/06c627abcbd351ff635fb4194e1240335c1057e9", "message": "refrence test fixes\n\nFix Some oddities on when we decrement gas in create and calls\nDon't charge gas on exceptional halts\nrely on stack exceptions for overflow/underflow\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-06T04:27:28Z", "type": "commit"}, {"oid": "bdb5f29daca82b27d925736a9a07e328ab14ea95", "url": "https://github.com/hyperledger/besu/commit/bdb5f29daca82b27d925736a9a07e328ab14ea95", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-06T04:31:38Z", "type": "commit"}, {"oid": "761b43f8c2f369e4b5491c710dc412cb2b71cb20", "url": "https://github.com/hyperledger/besu/commit/761b43f8c2f369e4b5491c710dc412cb2b71cb20", "message": "remove old cost, execeptionalHaltReason, and execute code\n\nPush down execute into all of the operations and remove old interface\nmethods that accessed costs in 3 ways.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-06T21:47:54Z", "type": "commit"}, {"oid": "0378c1286664b98fc7cd92e4f43196492b7e2d64", "url": "https://github.com/hyperledger/besu/commit/0378c1286664b98fc7cd92e4f43196492b7e2d64", "message": "clenup\n\nremove duplicate classes\nremove over/underflow catches that will never matter.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T00:46:55Z", "type": "commit"}, {"oid": "520021b45c33f55a40d1e73006457f9fb18d9e70", "url": "https://github.com/hyperledger/besu/commit/520021b45c33f55a40d1e73006457f9fb18d9e70", "message": "cleanup\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T00:53:55Z", "type": "commit"}, {"oid": "6e181233bfb0390360bf924efb827687c222edcc", "url": "https://github.com/hyperledger/besu/commit/6e181233bfb0390360bf924efb827687c222edcc", "message": "Merge branch 'master' of github.com:hyperledger/besu into evmLoop2\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T03:35:57Z", "type": "commit"}, {"oid": "9df2d41b63d86199ae4c7dd46a2f171a4ee1e5b3", "url": "https://github.com/hyperledger/besu/commit/9df2d41b63d86199ae4c7dd46a2f171a4ee1e5b3", "message": "Update Reference Tests\n\nUpdate to the reference tests used on hivetests.etherdevops.io and\nretesteth.etherdevops.io.  Both are using a more current release of the\nreference tessts that includes performance and subroutines items.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T05:05:03Z", "type": "commit"}, {"oid": "86d5c55d272a9d157bb27da82d70c166a838d702", "url": "https://github.com/hyperledger/besu/commit/86d5c55d272a9d157bb27da82d70c166a838d702", "message": "Update Reference Tests\n\nUpdate to the reference tests used on hivetests.etherdevops.io and\nretesteth.etherdevops.io.  Both are using a more current release of the\nreference tessts that includes performance and subroutines items.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T06:09:45Z", "type": "commit"}, {"oid": "185f7c6c5e0846f2bb4717bd849a082faf469cb3", "url": "https://github.com/hyperledger/besu/commit/185f7c6c5e0846f2bb4717bd849a082faf469cb3", "message": "fix wierd shanghai corner case\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T06:24:18Z", "type": "commit"}, {"oid": "55dd19e248cd38446b0c6ad302d52528217eb8ab", "url": "https://github.com/hyperledger/besu/commit/55dd19e248cd38446b0c6ad302d52528217eb8ab", "message": "Merge branch 'master' into evmLoop2", "committedDate": "2020-07-07T14:25:46Z", "type": "commit"}, {"oid": "488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "url": "https://github.com/hyperledger/besu/commit/488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "message": "compress some gets/pops in operations\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T16:19:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjUwMg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r450992502", "bodyText": "It seems like this ended up being redundant, is that right?", "author": "RatanRSur", "createdAt": "2020-07-07T16:28:31Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/AbstractMessageProcessor.java", "diffHunk": "@@ -155,8 +153,6 @@ protected void completedFailed(final MessageFrame frame) {\n   private void codeExecute(final MessageFrame frame, final OperationTracer operationTracer) {\n     try {\n       evm.runToHalt(frame, operationTracer);\n-    } catch (final ExceptionalHaltException e) {\n-      frame.setState(MessageFrame.State.EXCEPTIONAL_HALT);", "originalCommit": "488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MzQzMg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r450993432", "bodyText": "Yea, exceptional halts are no longer directly signaled via Java exceptions.", "author": "shemnon", "createdAt": "2020-07-07T16:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjUwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwODY2OA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451008668", "bodyText": "Since this now also checks gas, we should reflect the implementer's responsibility in the javadoc if not the name of the method.", "author": "RatanRSur", "createdAt": "2020-07-07T16:55:01Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Operation.java", "diffHunk": "@@ -20,34 +20,33 @@\n \n public interface Operation {\n \n-  /**\n-   * Gas cost of this operation, in context of the provided frame.\n-   *\n-   * @param frame The frame for execution of this operation.\n-   * @return The gas cost associated with executing this operation given the current {@link\n-   *     MessageFrame}.\n-   */\n-  Gas cost(MessageFrame frame);\n+  class OperationResult {\n+    final Optional<Gas> gasCost;\n+    final Optional<ExceptionalHaltReason> haltReason;\n+\n+    public OperationResult(\n+        final Optional<Gas> gasCost, final Optional<ExceptionalHaltReason> haltReason) {\n+      this.gasCost = gasCost;\n+      this.haltReason = haltReason;\n+    }\n+\n+    public Optional<Gas> getGasCost() {\n+      return gasCost;\n+    }\n+\n+    public Optional<ExceptionalHaltReason> getHaltReason() {\n+      return haltReason;\n+    }\n+  }\n \n   /**\n    * Executes the logic behind this operation.\n    *\n    * @param frame The frame for execution of this operation.\n+   * @param evm The EVM for execution of this operation.\n+   * @return the gas cost and any exeptional halt reasons of the operation.\n    */\n-  void execute(MessageFrame frame);\n-\n-  /**\n-   * Check if an exceptional halt condition should apply\n-   *\n-   * @param frame the current frame\n-   * @param evm the currently executing EVM\n-   * @return an {@link Optional} containing the {@link ExceptionalHaltReason} that applies or empty\n-   *     if no exceptional halt condition applies.\n-   */\n-  default Optional<ExceptionalHaltReason> exceptionalHaltCondition(\n-      final MessageFrame frame, final EVM evm) {\n-    return Optional.empty();\n-  }\n+  OperationResult execute(final MessageFrame frame, final EVM evm);", "originalCommit": "488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMDA1OA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451030058", "bodyText": "javadocs updated.", "author": "shemnon", "createdAt": "2020-07-07T17:31:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwODY2OA=="}], "type": "inlineReview", "revised_code": {"commit": "f53ec642a6e90be1e28cfae445d1e1645ee01cde", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Operation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Operation.java\nindex 46b8adfd94..392232bd01 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Operation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/Operation.java\n\n@@ -42,6 +42,11 @@ public interface Operation {\n   /**\n    * Executes the logic behind this operation.\n    *\n+   * <p>Implementors are responsible for calculating gas cost, checking Out-of-gas conditions,\n+   * applying gas cost to the MessageFrame, executing the operation including all side effects, and\n+   * checking for all operation related exceptional halts such as OutOfGas, InvalidJumpDestination,\n+   * Stack overflow/underflow, etc., and storing the halt in the MessageFrame\n+   *\n    * @param frame The frame for execution of this operation.\n    * @param evm The EVM for execution of this operation.\n    * @return the gas cost and any exeptional halt reasons of the operation.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNjc0NA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451026744", "bodyText": "OVERFLOWFLOW_RESPONSE? Do you want to say OVERFLOW_RESPONSE", "author": "matkt", "createdAt": "2020-07-07T17:25:45Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/BlockHashOperation.java", "diffHunk": "@@ -15,55 +15,70 @@\n package org.hyperledger.besu.ethereum.vm.operations;\n \n import org.hyperledger.besu.ethereum.core.BlockHeader;\n-import org.hyperledger.besu.ethereum.core.Gas;\n import org.hyperledger.besu.ethereum.core.Hash;\n import org.hyperledger.besu.ethereum.core.ProcessableBlockHeader;\n-import org.hyperledger.besu.ethereum.vm.AbstractOperation;\n import org.hyperledger.besu.ethereum.vm.BlockHashLookup;\n+import org.hyperledger.besu.ethereum.vm.EVM;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.OverflowException;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.UnderflowException;\n \n import org.apache.tuweni.bytes.Bytes32;\n import org.apache.tuweni.units.bigints.UInt256;\n \n-public class BlockHashOperation extends AbstractOperation {\n+public class BlockHashOperation extends AbstractFixedCostOperation {\n \n   private static final int MAX_RELATIVE_BLOCK = 255;\n \n   public BlockHashOperation(final GasCalculator gasCalculator) {\n-    super(0x40, \"BLOCKHASH\", 1, 1, false, 1, gasCalculator);\n+    super(\n+        0x40,\n+        \"BLOCKHASH\",\n+        1,\n+        1,\n+        false,\n+        1,\n+        gasCalculator,\n+        gasCalculator.getBlockHashOperationGasCost());\n   }\n \n   @Override\n-  public Gas cost(final MessageFrame frame) {\n-    return gasCalculator().getBlockHashOperationGasCost();\n-  }\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      if (frame.getRemainingGas().compareTo(gasCost) < 0) {\n+        return oogResponse;\n+      }\n+      final UInt256 blockArg = UInt256.fromBytes(frame.popStackItem());\n \n-  @Override\n-  public void execute(final MessageFrame frame) {\n-    final UInt256 blockArg = UInt256.fromBytes(frame.popStackItem());\n+      // Short-circuit if value is unreasonably large\n+      if (!blockArg.fitsLong()) {\n+        frame.pushStackItem(Bytes32.ZERO);\n+        return successResponse;\n+      }\n \n-    // Short-circuit if value is unreasonably large\n-    if (!blockArg.fitsLong()) {\n-      frame.pushStackItem(Bytes32.ZERO);\n-      return;\n-    }\n+      final long soughtBlock = blockArg.toLong();\n+      final ProcessableBlockHeader blockHeader = frame.getBlockHeader();\n+      final long currentBlockNumber = blockHeader.getNumber();\n+      final long mostRecentBlockNumber = currentBlockNumber - 1;\n \n-    final long soughtBlock = blockArg.toLong();\n-    final ProcessableBlockHeader blockHeader = frame.getBlockHeader();\n-    final long currentBlockNumber = blockHeader.getNumber();\n-    final long mostRecentBlockNumber = currentBlockNumber - 1;\n+      // If the current block is the genesis block or the sought block is\n+      // not within the last 256 completed blocks, zero is returned.\n+      if (currentBlockNumber == BlockHeader.GENESIS_BLOCK_NUMBER\n+          || soughtBlock < (mostRecentBlockNumber - MAX_RELATIVE_BLOCK)\n+          || soughtBlock > mostRecentBlockNumber) {\n+        frame.pushStackItem(Bytes32.ZERO);\n+      } else {\n+        final BlockHashLookup blockHashLookup = frame.getBlockHashLookup();\n+        final Hash blockHash = blockHashLookup.getBlockHash(soughtBlock);\n+        frame.pushStackItem(blockHash);\n+      }\n \n-    // If the current block is the genesis block or the sought block is\n-    // not within the last 256 completed blocks, zero is returned.\n-    if (currentBlockNumber == BlockHeader.GENESIS_BLOCK_NUMBER\n-        || soughtBlock < (mostRecentBlockNumber - MAX_RELATIVE_BLOCK)\n-        || soughtBlock > mostRecentBlockNumber) {\n-      frame.pushStackItem(Bytes32.ZERO);\n-    } else {\n-      final BlockHashLookup blockHashLookup = frame.getBlockHashLookup();\n-      final Hash blockHash = blockHashLookup.getBlockHash(soughtBlock);\n-      frame.pushStackItem(blockHash);\n+      return successResponse;\n+    } catch (final UnderflowException ue) {\n+      return UNDERFLOW_RESPONSE;\n+    } catch (final OverflowException oe) {\n+      return OVERFLOWFLOW_RESPONSE;", "originalCommit": "488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNzk1NA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451027954", "bodyText": "Yep.  Fix pushed.", "author": "shemnon", "createdAt": "2020-07-07T17:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNjc0NA=="}], "type": "inlineReview", "revised_code": {"commit": "4e6c564b31833fd87b39e74df66ae74d1e9e32e7", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/BlockHashOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/BlockHashOperation.java\nindex 7bf51b6a9a..690b605804 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/BlockHashOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/BlockHashOperation.java\n\n@@ -78,7 +78,7 @@ public class BlockHashOperation extends AbstractFixedCostOperation {\n     } catch (final UnderflowException ue) {\n       return UNDERFLOW_RESPONSE;\n     } catch (final OverflowException oe) {\n-      return OVERFLOWFLOW_RESPONSE;\n+      return OVERFLOW_RESPONSE;\n     }\n   }\n }\n"}}, {"oid": "4e6c564b31833fd87b39e74df66ae74d1e9e32e7", "url": "https://github.com/hyperledger/besu/commit/4e6c564b31833fd87b39e74df66ae74d1e9e32e7", "message": "OVERFLOWFLOW -> OVERFLOW\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T17:27:44Z", "type": "commit"}, {"oid": "f53ec642a6e90be1e28cfae445d1e1645ee01cde", "url": "https://github.com/hyperledger/besu/commit/f53ec642a6e90be1e28cfae445d1e1645ee01cde", "message": "update javadoc.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T17:31:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMDAzNA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451030034", "bodyText": "Maybe be we need to avoid using assert here ?", "author": "matkt", "createdAt": "2020-07-07T17:31:26Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java", "diffHunk": "@@ -15,32 +15,40 @@\n package org.hyperledger.besu.ethereum.vm.operations;\n \n import org.hyperledger.besu.ethereum.core.Account;\n-import org.hyperledger.besu.ethereum.core.Gas;\n-import org.hyperledger.besu.ethereum.vm.AbstractOperation;\n+import org.hyperledger.besu.ethereum.vm.EVM;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.OverflowException;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.UnderflowException;\n \n import org.apache.tuweni.bytes.Bytes32;\n import org.apache.tuweni.units.bigints.UInt256;\n \n-public class SLoadOperation extends AbstractOperation {\n+public class SLoadOperation extends AbstractFixedCostOperation {\n \n   public SLoadOperation(final GasCalculator gasCalculator) {\n-    super(0x54, \"SLOAD\", 1, 1, false, 1, gasCalculator);\n+    super(0x54, \"SLOAD\", 1, 1, false, 1, gasCalculator, gasCalculator.getSloadOperationGasCost());\n   }\n \n   @Override\n-  public Gas cost(final MessageFrame frame) {\n-    return gasCalculator().getSloadOperationGasCost();\n-  }\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      if (frame.getRemainingGas().compareTo(gasCost) < 0) {\n+        return oogResponse;\n+      }\n \n-  @Override\n-  public void execute(final MessageFrame frame) {\n-    final Bytes32 key = frame.popStackItem();\n+      final Bytes32 key = frame.popStackItem();\n+\n+      final Account account = frame.getWorldState().get(frame.getRecipientAddress());\n+      assert account != null : \"VM account should exist\";", "originalCommit": "488fa4d16207b13a37cb22ba4536ccf7df35ee5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NTgzNg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451045836", "bodyText": "I deleted it.  The account should exist already as it's an account that should have existed for the call to even be made.  If account is null we will get an NPE 2 lines later, and if it's null something has broken quite severely in the EVM implementation so native NPEs communicate the failure accurately.", "author": "shemnon", "createdAt": "2020-07-07T17:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMDAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java\nindex 32c7677125..4576c17dfc 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java\n\n@@ -16,11 +16,14 @@ package org.hyperledger.besu.ethereum.vm.operations;\n \n import org.hyperledger.besu.ethereum.core.Account;\n import org.hyperledger.besu.ethereum.vm.EVM;\n+import org.hyperledger.besu.ethereum.vm.ExceptionalHaltReason;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n import org.hyperledger.besu.ethereum.vm.OperandStack.OverflowException;\n import org.hyperledger.besu.ethereum.vm.OperandStack.UnderflowException;\n \n+import java.util.Optional;\n+\n import org.apache.tuweni.bytes.Bytes32;\n import org.apache.tuweni.units.bigints.UInt256;\n \n"}}, {"oid": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "url": "https://github.com/hyperledger/besu/commit/7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "message": "remove assert\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T17:57:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NjkyNQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451076925", "bodyText": "Can this ever be true?", "author": "RatanRSur", "createdAt": "2020-07-07T18:56:50Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java", "diffHunk": "@@ -146,55 +150,89 @@ protected AbstractCallOperation(\n   protected abstract boolean isStatic(MessageFrame frame);\n \n   @Override\n-  public void execute(final MessageFrame frame) {\n-    frame.clearReturnData();\n-\n-    final Address to = to(frame);\n-    final Account contract = frame.getWorldState().get(to);\n-\n-    final Account account = frame.getWorldState().get(frame.getRecipientAddress());\n-    final Wei balance = account.getBalance();\n-    if (value(frame).compareTo(balance) > 0 || frame.getMessageStackDepth() >= 1024) {\n-      frame.expandMemory(inputDataOffset(frame).intValue(), inputDataLength(frame).intValue());\n-      frame.expandMemory(outputDataOffset(frame).intValue(), outputDataLength(frame).intValue());\n-      frame.incrementRemainingGas(gasAvailableForChildCall(frame));\n-      frame.popStackItems(getStackItemsConsumed());\n-      frame.pushStackItem(Bytes32.ZERO);\n-      return;\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      // manual check becasue some reads won't come until the \"complete\" step.\n+      if (frame.stackSize() < getStackItemsConsumed()) {\n+        return UNDERFLOW_RESPONSE;\n+      }\n+      final Optional<ExceptionalHaltReason> haltReason = exceptionalHaltCondition(frame, evm);\n+      if (haltReason.isPresent()) {\n+        return new OperationResult(Optional.empty(), haltReason);\n+      }", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NTIwNg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451095206", "bodyText": "CallOperation can have the exceptionalHaltCondition return an IllegalStateChange when in a static context with value.  I think I can get rid of this by having CallOperation check that first and then call the super.", "author": "shemnon", "createdAt": "2020-07-07T19:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3NjkyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\nindex b727ea0cca..3a2dc055ef 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\n\n@@ -156,10 +156,7 @@ public abstract class AbstractCallOperation extends AbstractOperation {\n       if (frame.stackSize() < getStackItemsConsumed()) {\n         return UNDERFLOW_RESPONSE;\n       }\n-      final Optional<ExceptionalHaltReason> haltReason = exceptionalHaltCondition(frame, evm);\n-      if (haltReason.isPresent()) {\n-        return new OperationResult(Optional.empty(), haltReason);\n-      }\n+\n       final Gas cost = cost(frame);\n       final Optional<Gas> optionalCost = Optional.ofNullable(cost);\n       if (cost != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MDk5NA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451080994", "bodyText": "Could we make cost() just return an Optional?", "author": "RatanRSur", "createdAt": "2020-07-07T19:04:49Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java", "diffHunk": "@@ -146,55 +150,89 @@ protected AbstractCallOperation(\n   protected abstract boolean isStatic(MessageFrame frame);\n \n   @Override\n-  public void execute(final MessageFrame frame) {\n-    frame.clearReturnData();\n-\n-    final Address to = to(frame);\n-    final Account contract = frame.getWorldState().get(to);\n-\n-    final Account account = frame.getWorldState().get(frame.getRecipientAddress());\n-    final Wei balance = account.getBalance();\n-    if (value(frame).compareTo(balance) > 0 || frame.getMessageStackDepth() >= 1024) {\n-      frame.expandMemory(inputDataOffset(frame).intValue(), inputDataLength(frame).intValue());\n-      frame.expandMemory(outputDataOffset(frame).intValue(), outputDataLength(frame).intValue());\n-      frame.incrementRemainingGas(gasAvailableForChildCall(frame));\n-      frame.popStackItems(getStackItemsConsumed());\n-      frame.pushStackItem(Bytes32.ZERO);\n-      return;\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      // manual check becasue some reads won't come until the \"complete\" step.\n+      if (frame.stackSize() < getStackItemsConsumed()) {\n+        return UNDERFLOW_RESPONSE;\n+      }\n+      final Optional<ExceptionalHaltReason> haltReason = exceptionalHaltCondition(frame, evm);\n+      if (haltReason.isPresent()) {\n+        return new OperationResult(Optional.empty(), haltReason);\n+      }\n+      final Gas cost = cost(frame);\n+      final Optional<Gas> optionalCost = Optional.ofNullable(cost);", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NzM5OA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451097398", "bodyText": "We immediately use the unwrapped value of cost, and have a very large block executed if it is non null/present, so an ifPresent lambda would be inappropriate.  So that would be us wrapping, then unwrapping the value, then returning the wrapped value.  Having a plain Gas returned gets rid of the unwrapping step.", "author": "shemnon", "createdAt": "2020-07-07T19:36:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4MDk5NA=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\nindex b727ea0cca..3a2dc055ef 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/AbstractCallOperation.java\n\n@@ -156,10 +156,7 @@ public abstract class AbstractCallOperation extends AbstractOperation {\n       if (frame.stackSize() < getStackItemsConsumed()) {\n         return UNDERFLOW_RESPONSE;\n       }\n-      final Optional<ExceptionalHaltReason> haltReason = exceptionalHaltCondition(frame, evm);\n-      if (haltReason.isPresent()) {\n-        return new OperationResult(Optional.empty(), haltReason);\n-      }\n+\n       final Gas cost = cost(frame);\n       final Optional<Gas> optionalCost = Optional.ofNullable(cost);\n       if (cost != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODE3MA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451088170", "bodyText": "i'm not sure but it seems like an indexoutofbound exception is needed here. this is what is used in line 120 of this class", "author": "matkt", "createdAt": "2020-07-07T19:18:28Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java", "diffHunk": "@@ -24,71 +26,128 @@\n  * <p>The operand stack is responsible for storing the current operands that the EVM can execute. It\n  * is assumed to have a fixed size.\n  */\n-public interface OperandStack {\n+public class OperandStack {\n \n-  /**\n-   * Returns the operand located at the offset from the top of the stack.\n-   *\n-   * @param offset the position relative to the top of the stack of the operand to return\n-   * @return the operand located at the specified offset\n-   * @throws IndexOutOfBoundsException if the offset is out of range (offset &lt; 0 || offset &gt;=\n-   *     {@link #size()})\n-   */\n-  Bytes32 get(int offset);\n+  private final Bytes32[] entries;\n \n-  /**\n-   * Removes the operand at the top of the stack.\n-   *\n-   * @return the operand removed from the top of the stack\n-   * @throws IllegalStateException if the stack is empty (e.g. a stack underflow occurs)\n-   */\n-  Bytes32 pop();\n+  private final int maxSize;\n+\n+  private int top;\n+\n+  public static class UnderflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public static class OverflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public OperandStack(final int maxSize) {\n+    if (maxSize < 0) {\n+      throw new IllegalArgumentException(\n+          String.format(\"max size (%d) must be non-negative\", maxSize));\n+    }\n+    this.entries = new Bytes32[maxSize];\n+    this.maxSize = maxSize;\n+    this.top = -1;\n+  }\n+\n+  public Bytes32 get(final int offset) {\n+    if (offset < 0 || offset >= size()) {\n+      throw new UnderflowException();", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMDYyMg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451100622", "bodyText": "The only times this exception was meaningful was when it was underflow related.  But it can be changed back, I just need to add a few more underflow checks in some key operations.", "author": "shemnon", "createdAt": "2020-07-07T19:42:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODE3MA=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\nindex 35d4652184..07cc6d81a5 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n\n@@ -68,7 +68,7 @@ public class OperandStack {\n \n   public Bytes32 get(final int offset) {\n     if (offset < 0 || offset >= size()) {\n-      throw new UnderflowException();\n+      throw new IndexOutOfBoundsException();\n     }\n \n     return entries[top - offset];\n"}}, {"oid": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "url": "https://github.com/hyperledger/besu/commit/631da9cde1b2315f6016a84c36781c65f6fd1cf6", "message": "review changes\n\n* When get is out of bounds on OperandStack use\n  IndexOutOfBoundsException.\n* Move call in statics value halt check into an execute subclass and\n  remove the exceptionalHaltCondition method.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T19:44:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODQzMQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451088431", "bodyText": "What do you think about using these in ReturnStack as well?", "author": "RatanRSur", "createdAt": "2020-07-07T19:19:01Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java", "diffHunk": "@@ -24,71 +26,128 @@\n  * <p>The operand stack is responsible for storing the current operands that the EVM can execute. It\n  * is assumed to have a fixed size.\n  */\n-public interface OperandStack {\n+public class OperandStack {\n \n-  /**\n-   * Returns the operand located at the offset from the top of the stack.\n-   *\n-   * @param offset the position relative to the top of the stack of the operand to return\n-   * @return the operand located at the specified offset\n-   * @throws IndexOutOfBoundsException if the offset is out of range (offset &lt; 0 || offset &gt;=\n-   *     {@link #size()})\n-   */\n-  Bytes32 get(int offset);\n+  private final Bytes32[] entries;\n \n-  /**\n-   * Removes the operand at the top of the stack.\n-   *\n-   * @return the operand removed from the top of the stack\n-   * @throws IllegalStateException if the stack is empty (e.g. a stack underflow occurs)\n-   */\n-  Bytes32 pop();\n+  private final int maxSize;\n+\n+  private int top;\n+\n+  public static class UnderflowException extends RuntimeException {", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEzMTE3Ng==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451131176", "bodyText": "Perhaps in a follow on PR.  If we pull the exceptions out I also want them to be checked since we are removing the callstack (for performance).  That way we either have to handle it or re-wrap it as a runnable.", "author": "shemnon", "createdAt": "2020-07-07T20:42:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0Njk3MA==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451146970", "bodyText": "Sure, if we don't do it in this PR, we should make an issue so we can revisit it at some point. Something like Unify Underflow and Overflow Signalling Across Stacks.", "author": "RatanRSur", "createdAt": "2020-07-07T21:14:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA4ODQzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\nindex 35d4652184..07cc6d81a5 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n\n@@ -68,7 +68,7 @@ public class OperandStack {\n \n   public Bytes32 get(final int offset) {\n     if (offset < 0 || offset >= size()) {\n-      throw new UnderflowException();\n+      throw new IndexOutOfBoundsException();\n     }\n \n     return entries[top - offset];\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5MTA3Ng==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451091076", "bodyText": "(optional) checkArgument", "author": "RatanRSur", "createdAt": "2020-07-07T19:24:07Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java", "diffHunk": "@@ -24,71 +26,128 @@\n  * <p>The operand stack is responsible for storing the current operands that the EVM can execute. It\n  * is assumed to have a fixed size.\n  */\n-public interface OperandStack {\n+public class OperandStack {\n \n-  /**\n-   * Returns the operand located at the offset from the top of the stack.\n-   *\n-   * @param offset the position relative to the top of the stack of the operand to return\n-   * @return the operand located at the specified offset\n-   * @throws IndexOutOfBoundsException if the offset is out of range (offset &lt; 0 || offset &gt;=\n-   *     {@link #size()})\n-   */\n-  Bytes32 get(int offset);\n+  private final Bytes32[] entries;\n \n-  /**\n-   * Removes the operand at the top of the stack.\n-   *\n-   * @return the operand removed from the top of the stack\n-   * @throws IllegalStateException if the stack is empty (e.g. a stack underflow occurs)\n-   */\n-  Bytes32 pop();\n+  private final int maxSize;\n+\n+  private int top;\n+\n+  public static class UnderflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public static class OverflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public OperandStack(final int maxSize) {\n+    if (maxSize < 0) {\n+      throw new IllegalArgumentException(\n+          String.format(\"max size (%d) must be non-negative\", maxSize));\n+    }", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE0MDczMQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451140731", "bodyText": "done.", "author": "shemnon", "createdAt": "2020-07-07T21:01:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5MTA3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\nindex 35d4652184..07cc6d81a5 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n\n@@ -68,7 +68,7 @@ public class OperandStack {\n \n   public Bytes32 get(final int offset) {\n     if (offset < 0 || offset >= size()) {\n-      throw new UnderflowException();\n+      throw new IndexOutOfBoundsException();\n     }\n \n     return entries[top - offset];\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NDAzMg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451094032", "bodyText": "I think we just need to do the upper bounds check, right? Because we'll get the 0 one for free when we try to index.", "author": "RatanRSur", "createdAt": "2020-07-07T19:29:52Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java", "diffHunk": "@@ -24,71 +26,128 @@\n  * <p>The operand stack is responsible for storing the current operands that the EVM can execute. It\n  * is assumed to have a fixed size.\n  */\n-public interface OperandStack {\n+public class OperandStack {\n \n-  /**\n-   * Returns the operand located at the offset from the top of the stack.\n-   *\n-   * @param offset the position relative to the top of the stack of the operand to return\n-   * @return the operand located at the specified offset\n-   * @throws IndexOutOfBoundsException if the offset is out of range (offset &lt; 0 || offset &gt;=\n-   *     {@link #size()})\n-   */\n-  Bytes32 get(int offset);\n+  private final Bytes32[] entries;\n \n-  /**\n-   * Removes the operand at the top of the stack.\n-   *\n-   * @return the operand removed from the top of the stack\n-   * @throws IllegalStateException if the stack is empty (e.g. a stack underflow occurs)\n-   */\n-  Bytes32 pop();\n+  private final int maxSize;\n+\n+  private int top;\n+\n+  public static class UnderflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public static class OverflowException extends RuntimeException {\n+    // Don't create a stack trace since these are not \"errors\" per say but are using exceptions to\n+    // throw rare control flow conditions (EVM stack overflow) that are expected to be seen in\n+    // normal\n+    // operations.\n+    @Override\n+    public synchronized Throwable fillInStackTrace() {\n+      return this;\n+    }\n+  }\n+\n+  public OperandStack(final int maxSize) {\n+    if (maxSize < 0) {\n+      throw new IllegalArgumentException(\n+          String.format(\"max size (%d) must be non-negative\", maxSize));\n+    }\n+    this.entries = new Bytes32[maxSize];\n+    this.maxSize = maxSize;\n+    this.top = -1;\n+  }\n+\n+  public Bytes32 get(final int offset) {\n+    if (offset < 0 || offset >= size()) {\n+      throw new UnderflowException();\n+    }\n+\n+    return entries[top - offset];\n+  }\n+\n+  public Bytes32 pop() {\n+    if (top < 0) {\n+      throw new UnderflowException();\n+    }\n+\n+    final Bytes32 removed = entries[top];\n+    entries[top--] = null;\n+    return removed;\n+  }\n \n   /**\n    * Pops the specified number of operands from the stack.\n    *\n    * @param items the number of operands to pop off the stack\n    * @throws IllegalArgumentException if the items to pop is negative.\n-   * @throws IllegalStateException when the items to pop is greater than {@link #size()}\n+   * @throws UnderflowException when the items to pop is greater than {@link #size()}\n    */\n-  default void bulkPop(final int items) {\n+  void bulkPop(final int items) {\n     if (items < 0) {\n       throw new IllegalArgumentException(\n           String.format(\"requested number of items to bulk pop (%d) is negative\", items));\n     }\n     checkArgument(items > 0, \"number of items to pop must be greater than 0\");\n     if (items > size()) {\n-      throw new IllegalStateException(\n-          String.format(\"requested to bulk pop %d items off a stack of size %d\", items, size()));\n+      throw new UnderflowException();\n     }\n \n     for (int i = 0; i < items; ++i) {\n       pop();\n     }\n   }\n \n-  /**\n-   * Pushes the operand onto the stack.\n-   *\n-   * @param operand the operand to push on the stack\n-   * @throws IllegalStateException when the stack is at capacity (e.g. a stack overflow occurs)\n-   */\n-  public void push(Bytes32 operand);\n+  public void push(final Bytes32 operand) {\n+    final int nextTop = top + 1;\n+    if (nextTop == maxSize) {\n+      throw new OverflowException();\n+    }\n+    entries[nextTop] = operand;\n+    top = nextTop;\n+  }\n \n-  /**\n-   * Sets the ith item from the top of the stack to the value.\n-   *\n-   * @param index the position relative to the top of the stack to set\n-   * @param operand the new operand that replaces the operand at the current offset\n-   * @throws IndexOutOfBoundsException if the offset is out of range (offset &lt; 0 || offset &gt;=\n-   *     {@link #size()})\n-   */\n-  void set(int index, Bytes32 operand);\n+  public void set(final int offset, final Bytes32 operand) {\n+    if (offset < 0 || offset >= size()) {\n+      throw new IndexOutOfBoundsException();\n+    }", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MDQ2OQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451170469", "bodyText": "Not quite.  The reference is [top - offset] and a negative offset would usually go into the \"dirty\" part of the stack past the top (when it doesn't go out fo the array, the rare cases it works properly).  So we need to check negative explicitly.", "author": "shemnon", "createdAt": "2020-07-07T22:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NDAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MDk0MQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451170941", "bodyText": "Ahh, got it.", "author": "RatanRSur", "createdAt": "2020-07-07T22:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NDAzMg=="}], "type": "inlineReview", "revised_code": {"commit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\nindex 35d4652184..07cc6d81a5 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/OperandStack.java\n\n@@ -68,7 +68,7 @@ public class OperandStack {\n \n   public Bytes32 get(final int offset) {\n     if (offset < 0 || offset >= size()) {\n-      throw new UnderflowException();\n+      throw new IndexOutOfBoundsException();\n     }\n \n     return entries[top - offset];\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NjE1OQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451096159", "bodyText": "Just to make the code a bit more newbie friendly, I think we should rename oogResponse everywhere to outOfGasResponse.", "author": "RatanRSur", "createdAt": "2020-07-07T19:34:09Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AbstractFixedCostOperation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.vm.operations;\n+\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.vm.AbstractOperation;\n+import org.hyperledger.besu.ethereum.vm.ExceptionalHaltReason;\n+import org.hyperledger.besu.ethereum.vm.GasCalculator;\n+\n+import java.util.Optional;\n+\n+abstract class AbstractFixedCostOperation extends AbstractOperation {\n+\n+  protected final OperationResult successResponse;\n+  protected final OperationResult oogResponse;", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NDYxNw==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451184617", "bodyText": "done", "author": "shemnon", "createdAt": "2020-07-07T22:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA5NjE1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f1f6e90d347cd34e3a6159d2eb68b03bc2e05d7", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AbstractFixedCostOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AbstractFixedCostOperation.java\nindex 1777293920..374c336218 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AbstractFixedCostOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AbstractFixedCostOperation.java\n\n@@ -26,7 +26,7 @@ import java.util.Optional;\n abstract class AbstractFixedCostOperation extends AbstractOperation {\n \n   protected final OperationResult successResponse;\n-  protected final OperationResult oogResponse;\n+  protected final OperationResult outOfGasResponse;\n   protected final Gas gasCost;\n \n   protected AbstractFixedCostOperation(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjAyNQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451102025", "bodyText": "Do you think it'd be worth it to do all of this checking one layer up? We can have execute delegate to an executeOverflowUnderflowUnchecked that each operation implements. It would mean that we were wrapping things that can't over or underflow with the exception handlers but I think it's a small price to pay for that not being a potential slip-of-the-mind for a future opcode.", "author": "RatanRSur", "createdAt": "2020-07-07T19:45:34Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AndOperation.java", "diffHunk": "@@ -14,31 +14,38 @@\n  */\n package org.hyperledger.besu.ethereum.vm.operations;\n \n-import org.hyperledger.besu.ethereum.core.Gas;\n-import org.hyperledger.besu.ethereum.vm.AbstractOperation;\n+import org.hyperledger.besu.ethereum.vm.EVM;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.OverflowException;\n+import org.hyperledger.besu.ethereum.vm.OperandStack.UnderflowException;\n \n import org.apache.tuweni.units.bigints.UInt256;\n \n-public class AndOperation extends AbstractOperation {\n+public class AndOperation extends AbstractFixedCostOperation {\n \n   public AndOperation(final GasCalculator gasCalculator) {\n-    super(0x16, \"AND\", 2, 1, false, 1, gasCalculator);\n+    super(0x16, \"AND\", 2, 1, false, 1, gasCalculator, gasCalculator.getVeryLowTierGasCost());\n   }\n \n   @Override\n-  public Gas cost(final MessageFrame frame) {\n-    return gasCalculator().getVeryLowTierGasCost();\n-  }\n-\n-  @Override\n-  public void execute(final MessageFrame frame) {\n-    final UInt256 value0 = UInt256.fromBytes(frame.popStackItem());\n-    final UInt256 value1 = UInt256.fromBytes(frame.popStackItem());\n-\n-    final UInt256 result = value0.and(value1);\n-\n-    frame.pushStackItem(result.toBytes());\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      if (frame.getRemainingGas().compareTo(gasCost) < 0) {\n+        return oogResponse;\n+      }\n+\n+      final UInt256 value0 = UInt256.fromBytes(frame.popStackItem());\n+      final UInt256 value1 = UInt256.fromBytes(frame.popStackItem());\n+\n+      final UInt256 result = value0.and(value1);\n+      frame.pushStackItem(result.toBytes());\n+\n+      return successResponse;\n+    } catch (final UnderflowException ue) {\n+      return UNDERFLOW_RESPONSE;\n+    } catch (final OverflowException oe) {\n+      return OVERFLOW_RESPONSE;\n+    }", "originalCommit": "7e1b6bb44c2a4f8fd4e7cd77603d5542d364920c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NDU5Mg==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451184592", "bodyText": "Let's give it a try.   It also moves us into net negative lines territory", "author": "shemnon", "createdAt": "2020-07-07T22:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEwMjAyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "3f1f6e90d347cd34e3a6159d2eb68b03bc2e05d7", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AndOperation.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AndOperation.java\nindex e495805a2b..a639369b11 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AndOperation.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/AndOperation.java\n\n@@ -17,8 +17,6 @@ package org.hyperledger.besu.ethereum.vm.operations;\n import org.hyperledger.besu.ethereum.vm.EVM;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n-import org.hyperledger.besu.ethereum.vm.OperandStack.OverflowException;\n-import org.hyperledger.besu.ethereum.vm.OperandStack.UnderflowException;\n \n import org.apache.tuweni.units.bigints.UInt256;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExMDk5Ng==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451110996", "bodyText": "Why did we have so many more tests ignored before and why are these still ignored?", "author": "RatanRSur", "createdAt": "2020-07-07T20:02:32Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java", "diffHunk": "@@ -65,53 +68,24 @@\n   // fully test these operations and the mocking does not add much value.\n   // Additionally, the GeneralStateTests provide coverage of these\n   // operations so the proper functionality does get tested somewhere.\n-  private static final String[] BLACKLISTED_TESTS = {\n-    \"balance0\",\n-    \"balanceAddressInputTooBig\",\n-    \"balanceCaller3\",\n-    \"balanceAddressInputTooBigRightMyAddress\",\n-    \"ExtCodeSizeAddressInputTooBigRightMyAddress\",\n-    \"env1\",\n-    \"extcodecopy0AddressTooBigRight\",\n-    \"PostToNameRegistrator0\",\n-    \"CallToReturn1\",\n-    \"CallRecursiveBomb0\",\n-    \"createNameRegistratorValueTooHigh\",\n-    \"suicideNotExistingAccount\",\n-    \"callstatelessToReturn1\",\n-    \"CallRecursiveBomb1\",\n-    \"ABAcallsSuicide1\",\n-    \"suicideSendEtherToMe\",\n-    \"suicide0\",\n-    \"CallToNameRegistrator0\",\n-    \"callstatelessToNameRegistrator0\",\n-    \"PostToReturn1\",\n-    \"callcodeToReturn1\",\n-    \"ABAcalls0\",\n-    \"CallRecursiveBomb2\",\n-    \"CallRecursiveBomb3\",\n-    \"ABAcallsSuicide0\",\n-    \"callcodeToNameRegistrator0\",\n-    \"CallToPrecompiledContract\",\n-    \"createNameRegistrator\"\n+  private static final String[] IGNORED_TESTS = {\n+    \"push32AndSuicide\", \"suicide\", \"suicide0\", \"suicideNotExistingAccount\", \"suicideSendEtherToMe\",", "originalCommit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4NDc2Ng==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451184766", "bodyText": "Self descruct tests are known to be problematic for all clients.", "author": "shemnon", "createdAt": "2020-07-07T22:43:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExMDk5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExMTE1OQ==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451111159", "bodyText": "commented out code", "author": "RatanRSur", "createdAt": "2020-07-07T20:02:53Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java", "diffHunk": "@@ -157,15 +131,15 @@ protected void runTest() {\n     // This is normally set inside the containing message executing the code.\n     frame.setState(MessageFrame.State.CODE_EXECUTING);\n \n-    try {\n-      protocolSpec.getEvm().runToHalt(frame, OperationTracer.NO_TRACING);\n-    } catch (final ExceptionalHaltException ehe) {\n-      if (!spec.isExceptionHaltExpected())\n-        System.err.println(\n-            String.format(\n-                \"Test %s incurred in an exceptional halt exception for reasons: %s.\",\n-                name, ehe.getReasons()));\n-    }\n+    //    try {\n+    protocolSpec.getEvm().runToHalt(frame, OperationTracer.NO_TRACING);\n+    //    } catch (final ExceptionalHaltException ehe) {\n+    //      if (!spec.isExceptionHaltExpected())\n+    //        System.err.println(\n+    //            String.format(\n+    //                \"Test %s incurred in an exceptional halt exception for reasons: %s.\",\n+    //                name, ehe.getReasons()));\n+    //    }", "originalCommit": "631da9cde1b2315f6016a84c36781c65f6fd1cf6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4OTE1Ng==", "url": "https://github.com/hyperledger/besu/pull/1192#discussion_r451189156", "bodyText": "deleted", "author": "shemnon", "createdAt": "2020-07-07T22:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTExMTE1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "edc99f74544bc9ae0c07d55f5a580ddaaabb2b82", "chunk": "diff --git a/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java b/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java\nindex b5c96f1307..3fb039556c 100644\n--- a/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java\n+++ b/ethereum/core/src/test/java/org/hyperledger/besu/ethereum/vm/VMReferenceTest.java\n\n@@ -131,15 +131,7 @@ public class VMReferenceTest extends AbstractRetryingTest {\n     // This is normally set inside the containing message executing the code.\n     frame.setState(MessageFrame.State.CODE_EXECUTING);\n \n-    //    try {\n     protocolSpec.getEvm().runToHalt(frame, OperationTracer.NO_TRACING);\n-    //    } catch (final ExceptionalHaltException ehe) {\n-    //      if (!spec.isExceptionHaltExpected())\n-    //        System.err.println(\n-    //            String.format(\n-    //                \"Test %s incurred in an exceptional halt exception for reasons: %s.\",\n-    //                name, ehe.getReasons()));\n-    //    }\n \n     if (spec.isExceptionHaltExpected()) {\n       assertThat(frame.getState() == MessageFrame.State.EXCEPTIONAL_HALT)\n"}}, {"oid": "2a00a68d48bc46d785d3c46425bf5512a127fc8f", "url": "https://github.com/hyperledger/besu/commit/2a00a68d48bc46d785d3c46425bf5512a127fc8f", "message": "add missing mock, add assertion.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T20:56:42Z", "type": "commit"}, {"oid": "3f1f6e90d347cd34e3a6159d2eb68b03bc2e05d7", "url": "https://github.com/hyperledger/besu/commit/3f1f6e90d347cd34e3a6159d2eb68b03bc2e05d7", "message": "Move overflow/underflow checks up a level.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T22:41:57Z", "type": "commit"}, {"oid": "edc99f74544bc9ae0c07d55f5a580ddaaabb2b82", "url": "https://github.com/hyperledger/besu/commit/edc99f74544bc9ae0c07d55f5a580ddaaabb2b82", "message": "spotless, and checkArgument, and remove commented out code.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T22:57:29Z", "type": "commit"}, {"oid": "c59a1eb9d9ca1bae3b7ee4c35ec874c79e013a4a", "url": "https://github.com/hyperledger/besu/commit/c59a1eb9d9ca1bae3b7ee4c35ec874c79e013a4a", "message": "rework unit test to expect exception\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T23:39:49Z", "type": "commit"}, {"oid": "f50a7dad8fde0ece0daab6f25d41e80df875e95d", "url": "https://github.com/hyperledger/besu/commit/f50a7dad8fde0ece0daab6f25d41e80df875e95d", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-07-07T23:48:28Z", "type": "commit"}, {"oid": "264fa2101545de144225095ea246c892459b9a80", "url": "https://github.com/hyperledger/besu/commit/264fa2101545de144225095ea246c892459b9a80", "message": "Merge branch 'master' into evmLoop2", "committedDate": "2020-07-08T00:09:25Z", "type": "commit"}]}