{"pr_number": 1298, "pr_title": "Private Log Filters track enclavePublicKey and are removed when user removed from group", "pr_createdAt": "2020-08-12T03:32:07Z", "pr_url": "https://github.com/hyperledger/besu/pull/1298", "timeline": [{"oid": "1235ac997ec968773087ca9ac2ea54e926abbeaf", "url": "https://github.com/hyperledger/besu/commit/1235ac997ec968773087ca9ac2ea54e926abbeaf", "message": "added isRemovalTransaction\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T00:20:58Z", "type": "commit"}, {"oid": "419bda72b5139abca26d0082f3c37476ffce2c75", "url": "https://github.com/hyperledger/besu/commit/419bda72b5139abca26d0082f3c37476ffce2c75", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-12T00:21:07Z", "type": "commit"}, {"oid": "41945326c2e37c3b35087701cb712c4c5a8541d1", "url": "https://github.com/hyperledger/besu/commit/41945326c2e37c3b35087701cb712c4c5a8541d1", "message": "draft of processing Private Tx Event\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T02:45:40Z", "type": "commit"}, {"oid": "deebbfafaa649ddbaf66e219331a83305b967834", "url": "https://github.com/hyperledger/besu/commit/deebbfafaa649ddbaf66e219331a83305b967834", "message": "typo\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T02:47:23Z", "type": "commit"}, {"oid": "edf27661e33b7fae3127c3af6593fc8a2e2e1e4a", "url": "https://github.com/hyperledger/besu/commit/edf27661e33b7fae3127c3af6593fc8a2e2e1e4a", "message": "added enclavePublicKey to private log filter\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T03:13:09Z", "type": "commit"}, {"oid": "671385b07b191961e16e8283d14420872fa075a4", "url": "https://github.com/hyperledger/besu/commit/671385b07b191961e16e8283d14420872fa075a4", "message": "draft removal event\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T03:28:46Z", "type": "commit"}, {"oid": "da085c87f4cda191cde903b73db7fc561f24f071", "url": "https://github.com/hyperledger/besu/commit/da085c87f4cda191cde903b73db7fc561f24f071", "message": "final params\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-12T03:36:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTYwOQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469011609", "bodyText": "I think we need to check if the user is a member of the group before creating the private filter. Otherwise, an ex-member will be able to install the filter. And because they have already been removed, we will never have a removedEvent to destroy their filter.", "author": "lucassaldanha", "createdAt": "2020-08-12T05:22:56Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java", "diffHunk": "@@ -50,23 +50,27 @@ public String getName() {\n   public JsonRpcResponse response(final JsonRpcRequestContext request) {\n     final String privacyGroupId = request.getRequiredParameter(0, String.class);\n     final FilterParameter filter = request.getRequiredParameter(1, FilterParameter.class);\n+    final String enclavePublicKey = enclavePublicKeyProvider.getEnclaveKey(request.getUser());\n \n-    checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(request, privacyGroupId);\n+    checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(enclavePublicKey, privacyGroupId);", "originalCommit": "da085c87f4cda191cde903b73db7fc561f24f071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0NTIyNQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r471845225", "bodyText": "it still happens before. I just moved where we get the user's id out of the request", "author": "macfarla", "createdAt": "2020-08-18T00:26:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTYwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java\nindex 4bbbd1a6c..878870966 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java\n\n@@ -52,6 +52,7 @@ public class PrivNewFilter implements JsonRpcMethod {\n     final FilterParameter filter = request.getRequiredParameter(1, FilterParameter.class);\n     final String enclavePublicKey = enclavePublicKeyProvider.getEnclaveKey(request.getUser());\n \n+    // no need to pass blockNumber. To create a filter, you need to be a current member of the group\n     checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(enclavePublicKey, privacyGroupId);\n \n     if (!filter.isValid()) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjU5Ng==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469012596", "bodyText": "Why do we need this method here? Maybe we should add it to the PrivateTransaction class itself? Or to an OnchainPrivateTransactionUtil kind of class.", "author": "lucassaldanha", "createdAt": "2020-08-12T05:26:22Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java", "diffHunk": "@@ -414,6 +415,16 @@ public boolean isGroupAdditionTransaction(final PrivateTransaction privateTransa\n             .startsWith(ADD_TO_GROUP_METHOD_SIGNATURE.toHexString());\n   }\n \n+  @Override\n+  public boolean isGroupRemovalTransaction(final PrivateTransaction privateTransaction) {", "originalCommit": "da085c87f4cda191cde903b73db7fc561f24f071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0NjAxMA==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r471846010", "bodyText": "moved", "author": "macfarla", "createdAt": "2020-08-18T00:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjU5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\nindex cc6f0d543..b684a75c0 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java\n\n@@ -415,16 +414,6 @@ public class DefaultPrivacyController implements PrivacyController {\n             .startsWith(ADD_TO_GROUP_METHOD_SIGNATURE.toHexString());\n   }\n \n-  @Override\n-  public boolean isGroupRemovalTransaction(final PrivateTransaction privateTransaction) {\n-    return privateTransaction.getTo().isPresent()\n-        && privateTransaction.getTo().get().equals(Address.ONCHAIN_PRIVACY_PROXY)\n-        && privateTransaction\n-        .getPayload()\n-        .toHexString()\n-        .startsWith(REMOVE_PARTICIPANT_METHOD_SIGNATURE.toHexString());\n-  }\n-\n   @Override\n   public Optional<Bytes> getContractCode(\n       final String privacyGroupId,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzExOQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469013119", "bodyText": "We can't do this here, it is too early in the private tx lifecycle. We need to send the event when the transaction is processed as part of the block import.\nBasically, only after we know the tx has been successfully processed we can send the event.", "author": "lucassaldanha", "createdAt": "2020-08-12T05:28:19Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java", "diffHunk": "@@ -72,8 +72,19 @@ public String sendTransaction(\n       verifyPrivacyGroupContainsEnclavePublicKey(\n           privateTransaction.getPrivacyGroupId().get().toBase64String(), enclavePublicKey);\n     }\n-    return privacyController.sendTransaction(\n-        privateTransaction, enclavePublicKey, maybePrivacyGroup);\n+\n+    final String transactionResult =\n+        privacyController.sendTransaction(privateTransaction, enclavePublicKey, maybePrivacyGroup);\n+\n+    if (isGroupRemovalTransaction(privateTransaction)) {", "originalCommit": "da085c87f4cda191cde903b73db7fc561f24f071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0NjAzNw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r471846037", "bodyText": "moved", "author": "macfarla", "createdAt": "2020-08-18T00:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\nindex 4d8b61eac..837dc255e 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java\n\n@@ -73,18 +73,8 @@ public class MultiTenancyPrivacyController implements PrivacyController {\n           privateTransaction.getPrivacyGroupId().get().toBase64String(), enclavePublicKey);\n     }\n \n-    final String transactionResult =\n-        privacyController.sendTransaction(privateTransaction, enclavePublicKey, maybePrivacyGroup);\n-\n-    if (isGroupRemovalTransaction(privateTransaction)) {\n-      // TODO send removal event\n-      PrivateTransactionEvent removalEvent =\n-          new PrivateTransactionEvent(\n-              privateTransaction.getPrivacyGroupId().get().toBase64String(),\n-              privateTransaction.getPrivateFrom().toBase64String());\n-    }\n-\n-    return transactionResult;\n+    return privacyController.sendTransaction(\n+        privateTransaction, enclavePublicKey, maybePrivacyGroup);\n   }\n \n   @Override\n"}}, {"oid": "553f7bbadfa582eaf13a27204e7912c785e598a1", "url": "https://github.com/hyperledger/besu/commit/553f7bbadfa582eaf13a27204e7912c785e598a1", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-13T01:26:47Z", "type": "commit"}, {"oid": "dd8cf37a5df82ebba2d073e0358f7f69f2315e81", "url": "https://github.com/hyperledger/besu/commit/dd8cf37a5df82ebba2d073e0358f7f69f2315e81", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-17T02:22:51Z", "type": "commit"}, {"oid": "4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "url": "https://github.com/hyperledger/besu/commit/4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "message": "moved logic for checking group removal tx\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-18T00:05:11Z", "type": "commit"}, {"oid": "cce49cc9d499881a4e67be0e38bb77a1a838b9d4", "url": "https://github.com/hyperledger/besu/commit/cce49cc9d499881a4e67be0e38bb77a1a838b9d4", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-18T00:05:17Z", "type": "commit"}, {"oid": "6e7d05e8e22eee5c527ec1cd0e8428316c01888e", "url": "https://github.com/hyperledger/besu/commit/6e7d05e8e22eee5c527ec1cd0e8428316c01888e", "message": "wire up event subscription\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-18T04:00:30Z", "type": "commit"}, {"oid": "175058019490a757cca83b3a5f50531da982e457", "url": "https://github.com/hyperledger/besu/commit/175058019490a757cca83b3a5f50531da982e457", "message": "spdx header\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-18T04:27:37Z", "type": "commit"}, {"oid": "fc1edfbacc9abf44093d18e62d32cc1e7a194166", "url": "https://github.com/hyperledger/besu/commit/fc1edfbacc9abf44093d18e62d32cc1e7a194166", "message": "added param to javadoc\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-18T04:29:44Z", "type": "commit"}, {"oid": "6454b3f5ec1b726854a532057d4e8188edc1bdc6", "url": "https://github.com/hyperledger/besu/commit/6454b3f5ec1b726854a532057d4e8188edc1bdc6", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-18T23:14:50Z", "type": "commit"}, {"oid": "7cd819bccdb93b42203d9e7775378109544a7f2f", "url": "https://github.com/hyperledger/besu/commit/7cd819bccdb93b42203d9e7775378109544a7f2f", "message": "fixed todo's\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-19T01:52:52Z", "type": "commit"}, {"oid": "ef680480f7cad5290f5ec9af14769d61ed5a4e6d", "url": "https://github.com/hyperledger/besu/commit/ef680480f7cad5290f5ec9af14769d61ed5a4e6d", "message": "removed unnecessary blank line\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-19T03:26:23Z", "type": "commit"}, {"oid": "7ef2528d7dcc0789120db6964ea650b66d5ab5ab", "url": "https://github.com/hyperledger/besu/commit/7ef2528d7dcc0789120db6964ea650b66d5ab5ab", "message": "merge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-19T05:08:58Z", "type": "commit"}, {"oid": "07052912a3aa123388eae2fe52f282f6d11e2ff3", "url": "https://github.com/hyperledger/besu/commit/07052912a3aa123388eae2fe52f282f6d11e2ff3", "message": "create event with removed user not tx sender\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-19T05:15:49Z", "type": "commit"}, {"oid": "8bb848a0afbf5d18b9235314361683975a7cd6da", "url": "https://github.com/hyperledger/besu/commit/8bb848a0afbf5d18b9235314361683975a7cd6da", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-19T05:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NzM3Mg==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473357372", "bodyText": "We could move this to a private method SendRemovedParticipantEvent() to try to keep the compute() method a bit cleaner (I know it is already kinda messy, but let's try to not make it worse) :)", "author": "lucassaldanha", "createdAt": "2020-08-19T21:49:45Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -190,10 +191,13 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     }\n \n     if (privateTransaction.isGroupRemovalTransaction()) {\n+      // get first participant parameter - there will be only one for removal transaction\n+      final String removedParticipant = getParticipantsFromParameter(privateTransaction.getPayload()).get(0);\n+\n       final PrivateTransactionEvent removalEvent =\n           new PrivateTransactionEvent(\n               privateTransaction.getPrivacyGroupId().get().toBase64String(),\n-              privateTransaction.getPrivateFrom().toBase64String());\n+              removedParticipant);\n       privateTransactionEventObservers.forEach(\n           sub -> sub.onPrivateTransactionProcessed(removalEvent));", "originalCommit": "07052912a3aa123388eae2fe52f282f6d11e2ff3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ0MjQ3Nw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473442477", "bodyText": "will clean this up today!", "author": "macfarla", "createdAt": "2020-08-19T23:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NzM3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1MTQwMQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473551401", "bodyText": "refactored", "author": "macfarla", "createdAt": "2020-08-20T02:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NzM3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d2f6ce5ea01057398e4e8cb1dca6457c97bb6ff0", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\nindex 256dfab06..a657e114d 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\n\n@@ -190,17 +190,7 @@ public class OnChainPrivacyPrecompiledContract extends PrivacyPrecompiledContrac\n       return Bytes.EMPTY;\n     }\n \n-    if (privateTransaction.isGroupRemovalTransaction()) {\n-      // get first participant parameter - there will be only one for removal transaction\n-      final String removedParticipant = getParticipantsFromParameter(privateTransaction.getPayload()).get(0);\n-\n-      final PrivateTransactionEvent removalEvent =\n-          new PrivateTransactionEvent(\n-              privateTransaction.getPrivacyGroupId().get().toBase64String(),\n-              removedParticipant);\n-      privateTransactionEventObservers.forEach(\n-          sub -> sub.onPrivateTransactionProcessed(removalEvent));\n-    }\n+    sendParticipantRemovedEvent(privateTransaction);\n \n     if (messageFrame.isPersistingPrivateState()) {\n       persistPrivateState(\n"}}, {"oid": "d2f6ce5ea01057398e4e8cb1dca6457c97bb6ff0", "url": "https://github.com/hyperledger/besu/commit/d2f6ce5ea01057398e4e8cb1dca6457c97bb6ff0", "message": "get removed participant from tx payload\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T02:10:24Z", "type": "commit"}, {"oid": "5009793d1652334aff7d62c3b0dac90b71e44eca", "url": "https://github.com/hyperledger/besu/commit/5009793d1652334aff7d62c3b0dac90b71e44eca", "message": "final param\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T02:30:38Z", "type": "commit"}, {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "url": "https://github.com/hyperledger/besu/commit/bdcc174e9358231d23cb348e659c8e37ae71aa66", "message": "cleanup\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T03:16:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MzQ1Nw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473583457", "bodyText": "We only really have to do that when multi-tenancy is enabled. If we do not do multi-tenancy we can return any data that is available to this client to the user.", "author": "pinges", "createdAt": "2020-08-20T04:37:40Z", "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -789,6 +795,23 @@ private void createLogsSubscriptionService(\n     }\n   }\n \n+  private void createPrivateTransactionObserver(\n+      final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n+    // register filterManager as observer of events fired by the onchain precompile.\n+    // filterManager needs to remove filters when the creator is removed from onchain group\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {", "originalCommit": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwNzIyMw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474307223", "bodyText": "fixed", "author": "macfarla", "createdAt": "2020-08-20T22:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MzQ1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\nindex 6b1f5da01..45c1f8725 100644\n--- a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n+++ b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n\n@@ -799,7 +799,8 @@ public class RunnerBuilder {\n       final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n     // register filterManager as observer of events fired by the onchain precompile.\n     // filterManager needs to remove filters when the creator is removed from onchain group\n-    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()\n+        && privacyParameters.isMultiTenancyEnabled()) {\n       final PrecompiledContract onchainPrivacyPrecompiledContract =\n           besuController\n               .getProtocolSchedule()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NDEyMA==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473584120", "bodyText": "I'm not sure I like the two VERY similar variable names. We could do the casting in line 803!", "author": "pinges", "createdAt": "2020-08-20T04:39:58Z", "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -789,6 +795,23 @@ private void createLogsSubscriptionService(\n     }\n   }\n \n+  private void createPrivateTransactionObserver(\n+      final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n+    // register filterManager as observer of events fired by the onchain precompile.\n+    // filterManager needs to remove filters when the creator is removed from onchain group\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {\n+      final PrecompiledContract onchainPrivacyPrecompiledContract =\n+          besuController\n+              .getProtocolSchedule()\n+              .getByBlockNumber(1)\n+              .getPrecompileContractRegistry()\n+              .get(Address.ONCHAIN_PRIVACY, Account.DEFAULT_VERSION);\n+      OnChainPrivacyPrecompiledContract onChainPrivacyPrecompiledContract =", "originalCommit": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMwODEzOQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474308139", "bodyText": "fixed!", "author": "macfarla", "createdAt": "2020-08-20T22:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NDEyMA=="}], "type": "inlineReview", "revised_code": {"commit": "5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\nindex 6b1f5da01..45c1f8725 100644\n--- a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n+++ b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n\n@@ -799,7 +799,8 @@ public class RunnerBuilder {\n       final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n     // register filterManager as observer of events fired by the onchain precompile.\n     // filterManager needs to remove filters when the creator is removed from onchain group\n-    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()\n+        && privacyParameters.isMultiTenancyEnabled()) {\n       final PrecompiledContract onchainPrivacyPrecompiledContract =\n           besuController\n               .getProtocolSchedule()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NzQ2Mg==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473587462", "bodyText": "I thought about the possibility of a race condition. I think we do have to do the actual removal once the block where it happened is finalised. I think that the method recordBlockEvent could be a good place.\nAnother option would be to make it impossible for that enclaveKey to install a new filter in that privacy group until the block has been finalised.", "author": "pinges", "createdAt": "2020-08-20T04:53:09Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -192,6 +197,20 @@ public void recordBlockEvent(final BlockAddedEvent event) {\n             });\n   }\n \n+  @Override\n+  public void onPrivateTransactionProcessed(final PrivateTransactionEvent event) {", "originalCommit": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxNTA5Mg==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474315092", "bodyText": "to process these events in recordBlockEvent we will have to store them until that method gets called.", "author": "macfarla", "createdAt": "2020-08-20T22:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzNDI5MA==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474334290", "bodyText": "updated", "author": "macfarla", "createdAt": "2020-08-20T23:58:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NzQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6e41ca423e96f0b3f9f9b81a78646667ccf60dc1", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\nindex 65dec9b77..1bd766f75 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\n\n@@ -199,16 +204,8 @@ public class FilterManager extends AbstractVerticle implements PrivateTransactio\n \n   @Override\n   public void onPrivateTransactionProcessed(final PrivateTransactionEvent event) {\n-    // when user removed from privacy group, remove all filters created by that user in that group\n-    filterRepository.getFiltersOfType(PrivateLogFilter.class).stream()\n-        .filter(\n-            privateLogFilter ->\n-                privateLogFilter.getPrivacyGroupId().equals(event.getPrivacyGroupId())\n-                    && privateLogFilter.getEnclavePublicKey().equals(event.getEnclavePublicKey()))\n-        .forEach(\n-            privateLogFilter -> {\n-              uninstallFilter(privateLogFilter.getId());\n-            });\n+    // the list will be processed at the end of the block\n+    removalEvents.add(event);\n   }\n \n   @VisibleForTesting\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzODIxNA==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473638214", "bodyText": "this should not be necessary, as there is only one parameter in that call that has to be 32 bytes long. As the transaction has succeeded I think it should be safe to assume that it really is 32 bytes long. Maybe checking that is OK as well?", "author": "pinges", "createdAt": "2020-08-20T06:17:52Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -323,6 +353,11 @@ private boolean isMemberOfPrivacyGroup(\n     return participants;\n   }\n \n+  private String getRemovedParticipantFromParameter(final Bytes input) {\n+    final Bytes mungedParticipants = input.slice(4);\n+    return mungedParticipants.slice(0, 32).toBase64String();", "originalCommit": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0MTc0Mg==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474341742", "bodyText": "simplified", "author": "macfarla", "createdAt": "2020-08-21T00:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzODIxNA=="}], "type": "inlineReview", "revised_code": {"commit": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\nindex 4312ab615..38da445ef 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java\n\n@@ -354,8 +354,7 @@ public class OnChainPrivacyPrecompiledContract extends PrivacyPrecompiledContrac\n   }\n \n   private String getRemovedParticipantFromParameter(final Bytes input) {\n-    final Bytes mungedParticipants = input.slice(4);\n-    return mungedParticipants.slice(0, 32).toBase64String();\n+    return input.slice(4).toBase64String();\n   }\n \n   private List<Bytes> decodeList(final Bytes rlpEncodedList) {\n"}}, {"oid": "65edf1e3be15e4a64249a68322c5e638910c052d", "url": "https://github.com/hyperledger/besu/commit/65edf1e3be15e4a64249a68322c5e638910c052d", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter", "committedDate": "2020-08-20T22:25:16Z", "type": "commit"}, {"oid": "5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "url": "https://github.com/hyperledger/besu/commit/5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "message": "only set up filtermanager to listen for group removals if multi-tenancy AND onchain groups enabled\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T22:26:27Z", "type": "commit"}, {"oid": "b2a2dd6f0895a87072613c8023a4a3533eab4997", "url": "https://github.com/hyperledger/besu/commit/b2a2dd6f0895a87072613c8023a4a3533eab4997", "message": "simplified similar variable names\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T22:33:25Z", "type": "commit"}, {"oid": "6e41ca423e96f0b3f9f9b81a78646667ccf60dc1", "url": "https://github.com/hyperledger/besu/commit/6e41ca423e96f0b3f9f9b81a78646667ccf60dc1", "message": "store removal events and process with addBlockEvent\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-20T23:54:16Z", "type": "commit"}, {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "url": "https://github.com/hyperledger/besu/commit/7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "message": "simplify getting param\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-08-21T00:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474385727", "bodyText": "Is there a chance for an NPE here?", "author": "mark-terry", "createdAt": "2020-08-21T03:17:36Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -189,6 +205,20 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     return result.getOutput();\n   }\n \n+  private void sendParticipantRemovedEvent(final PrivateTransaction privateTransaction) {\n+    if (privateTransaction.isGroupRemovalTransaction()) {\n+      // get first participant parameter - there is only one for removal transaction\n+      final String removedParticipant =\n+          getRemovedParticipantFromParameter(privateTransaction.getPayload());\n+\n+      final PrivateTransactionEvent removalEvent =\n+          new PrivateTransactionEvent(\n+              privateTransaction.getPrivacyGroupId().get().toBase64String(), removedParticipant);", "originalCommit": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM5MTgxMw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474391813", "bodyText": "from within the onchain precompile?", "author": "macfarla", "createdAt": "2020-08-21T03:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM5MjY3MA==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474392670", "bodyText": "looking at the code, the calling method returns earlier if privacy group id is empty. I can refactor to make that clearer?", "author": "macfarla", "createdAt": "2020-08-21T03:48:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM5MjY3Nw==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474392677", "bodyText": "Unchecked privateTransaction.getPrivacyGroupId().get() ?", "author": "mark-terry", "createdAt": "2020-08-21T03:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM5NjQ4OQ==", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474396489", "bodyText": "You're right - I missed that in the diff.\nAny chance this function could be called from a different path?", "author": "mark-terry", "createdAt": "2020-08-21T04:05:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw=="}], "type": "inlineReview", "revised_code": null}]}