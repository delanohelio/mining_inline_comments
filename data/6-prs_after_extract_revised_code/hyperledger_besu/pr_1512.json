{"pr_number": 1512, "pr_title": "Add gas measurement to full import log line", "pr_createdAt": "2020-11-02T20:09:19Z", "pr_url": "https://github.com/hyperledger/besu/pull/1512", "timeline": [{"oid": "2a6ac03f541fee5a272e2a4d4e9b8977048f1207", "url": "https://github.com/hyperledger/besu/commit/2a6ac03f541fee5a272e2a4d4e9b8977048f1207", "message": "Add gas measurement to full import log line\n\nTo provide more context to admins and to add more meaning the full sync\nlog lines report the amount of gas processed in MegaGas/Second.  Some\nblocks are fuller than others and this provides a gauge as to wether the\nimport is slowing down or if the blocks are filling up.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-02T20:07:16Z", "type": "commit"}, {"oid": "1a7f6bcd742d163facd592581169dea7c18d2d6a", "url": "https://github.com/hyperledger/besu/commit/1a7f6bcd742d163facd592581169dea7c18d2d6a", "message": "spotless and changelog\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-02T20:10:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5NzI3Ng==", "url": "https://github.com/hyperledger/besu/pull/1512#discussion_r516297276", "bodyText": "Why not just allow it to log the 0? It doesn't do much harm and it makes it more consistent, grepable, etc.", "author": "RatanRSur", "createdAt": "2020-11-02T22:37:32Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java", "diffHunk": "@@ -56,12 +60,28 @@ public void accept(final Block block) {\n     if (!importer.importBlock(protocolContext, block, HeaderValidationMode.SKIP_DETACHED)) {\n       throw new InvalidBlockException(\"Failed to import block\", blockNumber, block.getHash());\n     }\n+    gasAccumulator += block.getHeader().getGasUsed();\n     int peerCount = -1; // ethContext is not available in tests\n     if (ethContext != null && ethContext.getEthPeers().peerCount() >= 0) {\n       peerCount = ethContext.getEthPeers().peerCount();\n     }\n     if (blockNumber % 200 == 0) {\n-      LOG.info(\"Import reached block {} ({}), Peers: {}\", blockNumber, shortHash, peerCount);\n+      final long nowMilli = Instant.now().toEpochMilli();\n+      if (lastReportMillis == 0 || gasAccumulator == 0) {\n+        // this is a formatted logger statement\n+        //noinspection PlaceholderCountMatchesArgumentCount\n+        LOG.info(\"Import reached block %d (%s), Peers: %d\", blockNumber, shortHash, peerCount);", "originalCommit": "1a7f6bcd742d163facd592581169dea7c18d2d6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk3MDg4NQ==", "url": "https://github.com/hyperledger/besu/pull/1512#discussion_r516970885", "bodyText": "updated it to log a - when either time is not accurate or gas burnt is zero.  Greps consistently now.", "author": "shemnon", "createdAt": "2020-11-03T21:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI5NzI3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3ad768b250622925e0a8c3fd90c0b15f0025d658", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java\nindex d0384f406..1d583a85b 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java\n\n@@ -67,19 +66,17 @@ public class FullImportBlockStep implements Consumer<Block> {\n     }\n     if (blockNumber % 200 == 0) {\n       final long nowMilli = Instant.now().toEpochMilli();\n-      if (lastReportMillis == 0 || gasAccumulator == 0) {\n-        // this is a formatted logger statement\n-        //noinspection PlaceholderCountMatchesArgumentCount\n-        LOG.info(\"Import reached block %d (%s), Peers: %d\", blockNumber, shortHash, peerCount);\n-      } else {\n-        final long deltaMilli = nowMilli - lastReportMillis;\n-        final double mgps = gasAccumulator / 1000.0 / deltaMilli;\n-        // this is a formatted logger statement\n-        //noinspection PlaceholderCountMatchesArgumentCount\n-        LOG.info(\n-            \"Import reached block %d (%s), %.3f Mg/s, Peers: %d\",\n-            blockNumber, shortHash, mgps, peerCount);\n-      }\n+      final long deltaMilli = nowMilli - lastReportMillis;\n+      final String mgps =\n+          (lastReportMillis == 0 || gasAccumulator == 0)\n+              ? \"-\"\n+              : String.format(\"%.3f\", gasAccumulator / 1000.0 / deltaMilli);\n+      LOG.info(\n+          \"Import reached block {} ({}), {} Mg/s, Peers: {}\",\n+          blockNumber,\n+          shortHash,\n+          mgps,\n+          peerCount);\n       lastReportMillis = nowMilli;\n       gasAccumulator = 0;\n     }\n"}}, {"oid": "3ad768b250622925e0a8c3fd90c0b15f0025d658", "url": "https://github.com/hyperledger/besu/commit/3ad768b250622925e0a8c3fd90c0b15f0025d658", "message": "keep a consistant greppable line.\n\nUse a '-' when there is (a) no time measurement or (b) no gas\nmeasurement.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-11-03T21:20:31Z", "type": "commit"}, {"oid": "3900b98ffbe62c90e93741d228d35335e7474b91", "url": "https://github.com/hyperledger/besu/commit/3900b98ffbe62c90e93741d228d35335e7474b91", "message": "Merge branch 'master' into mgpsImports", "committedDate": "2020-11-03T21:39:44Z", "type": "commit"}]}