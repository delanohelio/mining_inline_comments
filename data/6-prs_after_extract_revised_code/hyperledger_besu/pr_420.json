{"pr_number": 420, "pr_title": "Kill correctly Besu node processes", "pr_createdAt": "2020-02-20T12:10:48Z", "pr_url": "https://github.com/hyperledger/besu/pull/420", "timeline": [{"oid": "f73563e3a20464d85475ce31e5507c35eec64186", "url": "https://github.com/hyperledger/besu/commit/f73563e3a20464d85475ce31e5507c35eec64186", "message": "Kill processes correctly\n\nNotify of corner cases\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-20T11:45:28Z", "type": "commit"}, {"oid": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "url": "https://github.com/hyperledger/besu/commit/e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "message": "Close a leaked cluster\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-02-20T12:05:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwMjkxNg==", "url": "https://github.com/hyperledger/besu/pull/420#discussion_r382402916", "bodyText": "final modifier\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Process p = besuProcesses.remove(name);\n          \n          \n            \n                final Process p = besuProcesses.remove(name);", "author": "CjHare", "createdAt": "2020-02-21T05:24:29Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -361,17 +360,25 @@ public boolean isActive(final String nodeName) {\n   private void killBesuProcess(final String name, final Process process) {\n     LOG.info(\"Killing \" + name + \" process\");\n \n-    Awaitility.waitAtMost(30, TimeUnit.SECONDS)\n-        .until(\n-            () -> {\n-              if (process.isAlive()) {\n-                process.destroy();\n-                besuProcesses.remove(name);\n-                return false;\n-              } else {\n-                besuProcesses.remove(name);\n-                return true;\n-              }\n-            });\n+    Process p = besuProcesses.remove(name);", "originalCommit": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\nindex d135153307..f89cf63280 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n\n@@ -358,9 +362,9 @@ public class ProcessBesuNodeRunner implements BesuNodeRunner {\n   }\n \n   private void killBesuProcess(final String name, final Process process) {\n-    LOG.info(\"Killing \" + name + \" process\");\n+    LOG.info(\"Killing {} process\", name);\n \n-    Process p = besuProcesses.remove(name);\n+    final Process p = besuProcesses.remove(name);\n     if (p == null) {\n       LOG.error(\"Process {} wasn't in our list\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwMzczNA==", "url": "https://github.com/hyperledger/besu/pull/420#discussion_r382403734", "bodyText": "Consistent new line white space\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (process.isAlive()) {\n          \n          \n            \n            \n          \n          \n            \n                if (process.isAlive()) {", "author": "CjHare", "createdAt": "2020-02-21T05:28:23Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -361,17 +360,25 @@ public boolean isActive(final String nodeName) {\n   private void killBesuProcess(final String name, final Process process) {\n     LOG.info(\"Killing \" + name + \" process\");\n \n-    Awaitility.waitAtMost(30, TimeUnit.SECONDS)\n-        .until(\n-            () -> {\n-              if (process.isAlive()) {\n-                process.destroy();\n-                besuProcesses.remove(name);\n-                return false;\n-              } else {\n-                besuProcesses.remove(name);\n-                return true;\n-              }\n-            });\n+    Process p = besuProcesses.remove(name);\n+    if (p == null) {\n+      LOG.error(\"Process {} wasn't in our list\", name);\n+    }\n+\n+    process.destroy();\n+    try {\n+      process.waitFor(2, TimeUnit.SECONDS);\n+    } catch (InterruptedException e) {\n+      LOG.warn(\"Wait for death of process \" + name + \" was interrupted\", e);\n+    }\n+    if (process.isAlive()) {", "originalCommit": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\nindex d135153307..f89cf63280 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n\n@@ -358,9 +362,9 @@ public class ProcessBesuNodeRunner implements BesuNodeRunner {\n   }\n \n   private void killBesuProcess(final String name, final Process process) {\n-    LOG.info(\"Killing \" + name + \" process\");\n+    LOG.info(\"Killing {} process\", name);\n \n-    Process p = besuProcesses.remove(name);\n+    final Process p = besuProcesses.remove(name);\n     if (p == null) {\n       LOG.error(\"Process {} wasn't in our list\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwMzkyMQ==", "url": "https://github.com/hyperledger/besu/pull/420#discussion_r382403921", "bodyText": "Consistency with other log messages\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.warn(\"Wait for death of process \" + name + \" was interrupted\", e);\n          \n          \n            \n                  LOG.warn(\"Wait for death of process \"{} was interrupted\", name, e);", "author": "CjHare", "createdAt": "2020-02-21T05:29:13Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -361,17 +360,25 @@ public boolean isActive(final String nodeName) {\n   private void killBesuProcess(final String name, final Process process) {\n     LOG.info(\"Killing \" + name + \" process\");\n \n-    Awaitility.waitAtMost(30, TimeUnit.SECONDS)\n-        .until(\n-            () -> {\n-              if (process.isAlive()) {\n-                process.destroy();\n-                besuProcesses.remove(name);\n-                return false;\n-              } else {\n-                besuProcesses.remove(name);\n-                return true;\n-              }\n-            });\n+    Process p = besuProcesses.remove(name);\n+    if (p == null) {\n+      LOG.error(\"Process {} wasn't in our list\", name);\n+    }\n+\n+    process.destroy();\n+    try {\n+      process.waitFor(2, TimeUnit.SECONDS);\n+    } catch (InterruptedException e) {\n+      LOG.warn(\"Wait for death of process \" + name + \" was interrupted\", e);", "originalCommit": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\nindex d135153307..f89cf63280 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n\n@@ -358,9 +362,9 @@ public class ProcessBesuNodeRunner implements BesuNodeRunner {\n   }\n \n   private void killBesuProcess(final String name, final Process process) {\n-    LOG.info(\"Killing \" + name + \" process\");\n+    LOG.info(\"Killing {} process\", name);\n \n-    Process p = besuProcesses.remove(name);\n+    final Process p = besuProcesses.remove(name);\n     if (p == null) {\n       LOG.error(\"Process {} wasn't in our list\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDEzMw==", "url": "https://github.com/hyperledger/besu/pull/420#discussion_r382404133", "bodyText": "final modifier\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } catch (Exception e) {\n          \n          \n            \n                  } catch (final Exception e) {", "author": "CjHare", "createdAt": "2020-02-21T05:30:20Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -361,17 +360,25 @@ public boolean isActive(final String nodeName) {\n   private void killBesuProcess(final String name, final Process process) {\n     LOG.info(\"Killing \" + name + \" process\");\n \n-    Awaitility.waitAtMost(30, TimeUnit.SECONDS)\n-        .until(\n-            () -> {\n-              if (process.isAlive()) {\n-                process.destroy();\n-                besuProcesses.remove(name);\n-                return false;\n-              } else {\n-                besuProcesses.remove(name);\n-                return true;\n-              }\n-            });\n+    Process p = besuProcesses.remove(name);\n+    if (p == null) {\n+      LOG.error(\"Process {} wasn't in our list\", name);\n+    }\n+\n+    process.destroy();\n+    try {\n+      process.waitFor(2, TimeUnit.SECONDS);\n+    } catch (InterruptedException e) {\n+      LOG.warn(\"Wait for death of process \" + name + \" was interrupted\", e);\n+    }\n+    if (process.isAlive()) {\n+      LOG.warn(\"Process {} still alive, destroying forcibly now\", name);\n+      try {\n+        process.destroyForcibly().waitFor(2, TimeUnit.SECONDS);\n+      } catch (Exception e) {", "originalCommit": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\nindex d135153307..f89cf63280 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n\n@@ -358,9 +362,9 @@ public class ProcessBesuNodeRunner implements BesuNodeRunner {\n   }\n \n   private void killBesuProcess(final String name, final Process process) {\n-    LOG.info(\"Killing \" + name + \" process\");\n+    LOG.info(\"Killing {} process\", name);\n \n-    Process p = besuProcesses.remove(name);\n+    final Process p = besuProcesses.remove(name);\n     if (p == null) {\n       LOG.error(\"Process {} wasn't in our list\", name);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQwNDI0NA==", "url": "https://github.com/hyperledger/besu/pull/420#discussion_r382404244", "bodyText": "final modifier\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                } catch (InterruptedException e) {\n          \n          \n            \n                } catch (final InterruptedException e) {", "author": "CjHare", "createdAt": "2020-02-21T05:30:47Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -361,17 +360,25 @@ public boolean isActive(final String nodeName) {\n   private void killBesuProcess(final String name, final Process process) {\n     LOG.info(\"Killing \" + name + \" process\");\n \n-    Awaitility.waitAtMost(30, TimeUnit.SECONDS)\n-        .until(\n-            () -> {\n-              if (process.isAlive()) {\n-                process.destroy();\n-                besuProcesses.remove(name);\n-                return false;\n-              } else {\n-                besuProcesses.remove(name);\n-                return true;\n-              }\n-            });\n+    Process p = besuProcesses.remove(name);\n+    if (p == null) {\n+      LOG.error(\"Process {} wasn't in our list\", name);\n+    }\n+\n+    process.destroy();\n+    try {\n+      process.waitFor(2, TimeUnit.SECONDS);\n+    } catch (InterruptedException e) {", "originalCommit": "e28ce7ecbe086fa98d52916302f8d76002e1bfbc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "chunk": "diff --git a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\nindex d135153307..f89cf63280 100644\n--- a/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n+++ b/acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java\n\n@@ -358,9 +362,9 @@ public class ProcessBesuNodeRunner implements BesuNodeRunner {\n   }\n \n   private void killBesuProcess(final String name, final Process process) {\n-    LOG.info(\"Killing \" + name + \" process\");\n+    LOG.info(\"Killing {} process\", name);\n \n-    Process p = besuProcesses.remove(name);\n+    final Process p = besuProcesses.remove(name);\n     if (p == null) {\n       LOG.error(\"Process {} wasn't in our list\", name);\n     }\n"}}, {"oid": "633237bbb897ed38a9cabff0ce83bff0b92008c4", "url": "https://github.com/hyperledger/besu/commit/633237bbb897ed38a9cabff0ce83bff0b92008c4", "message": "Merge branch 'master' into kill-correctly", "committedDate": "2020-03-24T05:33:34Z", "type": "commit"}, {"oid": "1ca460859800d1bc12d6440d0864ab4d22dc844c", "url": "https://github.com/hyperledger/besu/commit/1ca460859800d1bc12d6440d0864ab4d22dc844c", "message": "Address comments\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>", "committedDate": "2020-03-24T07:26:15Z", "type": "commit"}, {"oid": "a272ca05d57f9fe9b8d462c9f68f42cf8f8a6f40", "url": "https://github.com/hyperledger/besu/commit/a272ca05d57f9fe9b8d462c9f68f42cf8f8a6f40", "message": "Merge branch 'master' into kill-correctly\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>\n\n# Conflicts:\n#\tacceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "committedDate": "2020-03-24T08:39:45Z", "type": "commit"}]}