{"pr_number": 724, "pr_title": "Fix support of peers that do not support eth/65", "pr_createdAt": "2020-04-15T16:35:18Z", "pr_url": "https://github.com/hyperledger/besu/pull/724", "timeline": [{"oid": "555322dbca3c78b1947f70f5013306ec37f22802", "url": "https://github.com/hyperledger/besu/commit/555322dbca3c78b1947f70f5013306ec37f22802", "message": "Fix support of peers <eth/65\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>", "committedDate": "2020-04-15T16:35:01Z", "type": "commit"}, {"oid": "af76df0d4e8211b077c66218447375964f8b2170", "url": "https://github.com/hyperledger/besu/commit/af76df0d4e8211b077c66218447375964f8b2170", "message": "Fix unit test\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>", "committedDate": "2020-04-15T17:25:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxOTUzOA==", "url": "https://github.com/hyperledger/besu/pull/724#discussion_r409019538", "bodyText": "The protocol should be an argument, for future feature support.  I don't think this will be the first time we will change behavior based on ETH subprotocol support.", "author": "shemnon", "createdAt": "2020-04-15T17:40:48Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java", "diffHunk": "@@ -67,6 +68,10 @@ public synchronized void addToPeerSendQueue(final EthPeer peer, final Hash hash)\n     }\n   }\n \n+  public boolean isPeerSupported(final EthPeer peer) {", "originalCommit": "af76df0d4e8211b077c66218447375964f8b2170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTUwOQ==", "url": "https://github.com/hyperledger/besu/pull/724#discussion_r409021509", "bodyText": "\ud83d\udc4d", "author": "atoulme", "createdAt": "2020-04-15T17:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxOTUzOA=="}], "type": "inlineReview", "revised_code": {"commit": "77772a84527a726ab95ec920dd332d59dd7c2a25", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\nindex b76e11b767..103608a2de 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\n\n@@ -68,8 +68,8 @@ public class PeerPendingTransactionTracker implements EthPeer.DisconnectCallback\n     }\n   }\n \n-  public boolean isPeerSupported(final EthPeer peer) {\n-    return peer.getAgreedCapabilities().contains(EthProtocol.ETH65);\n+  public boolean isPeerSupported(final EthPeer peer, final Capability capability) {\n+    return peer.getAgreedCapabilities().contains(capability);\n   }\n \n   private Set<Hash> getOrCreateSeenTransactionsForPeer(final EthPeer peer) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMDk1Mg==", "url": "https://github.com/hyperledger/besu/pull/724#discussion_r409020952", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public boolean isPeerSupported(final EthPeer peer) {\n          \n          \n            \n                return peer.getAgreedCapabilities().contains(EthProtocol.ETH65);\n          \n          \n            \n              }\n          \n          \n            \n              public boolean isPeerSupported(final EthPeer peer, final Capability capability) {\n          \n          \n            \n                return peer.getAgreedCapabilities().contains(capability);\n          \n          \n            \n              }", "author": "shemnon", "createdAt": "2020-04-15T17:43:07Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java", "diffHunk": "@@ -67,6 +68,10 @@ public synchronized void addToPeerSendQueue(final EthPeer peer, final Hash hash)\n     }\n   }\n \n+  public boolean isPeerSupported(final EthPeer peer) {\n+    return peer.getAgreedCapabilities().contains(EthProtocol.ETH65);\n+  }", "originalCommit": "af76df0d4e8211b077c66218447375964f8b2170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "77772a84527a726ab95ec920dd332d59dd7c2a25", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\nindex b76e11b767..103608a2de 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\n\n@@ -68,8 +68,8 @@ public class PeerPendingTransactionTracker implements EthPeer.DisconnectCallback\n     }\n   }\n \n-  public boolean isPeerSupported(final EthPeer peer) {\n-    return peer.getAgreedCapabilities().contains(EthProtocol.ETH65);\n+  public boolean isPeerSupported(final EthPeer peer, final Capability capability) {\n+    return peer.getAgreedCapabilities().contains(capability);\n   }\n \n   private Set<Hash> getOrCreateSeenTransactionsForPeer(final EthPeer peer) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTYyMQ==", "url": "https://github.com/hyperledger/besu/pull/724#discussion_r409021621", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .filter(transactionTracker::isPeerSupported)\n          \n          \n            \n                    .filter(peer -> transactionTracker.isPeerSupported(peer, EthProtocol.ETH65)\n          \n      \n    \n    \n  \n\nMay require an import, and similarly to the other 5 places it's called.", "author": "shemnon", "createdAt": "2020-04-15T17:44:10Z", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -38,6 +38,7 @@ public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n     ethContext\n         .getEthPeers()\n         .streamAvailablePeers()\n+        .filter(transactionTracker::isPeerSupported)", "originalCommit": "af76df0d4e8211b077c66218447375964f8b2170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTk0MA==", "url": "https://github.com/hyperledger/besu/pull/724#discussion_r409021940", "bodyText": "I'll commit your first suggestion and work my way from there, no worries.", "author": "atoulme", "createdAt": "2020-04-15T17:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAyMTYyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "c6d9431495726b656f6ae49c292c28e0cb5cf907", "chunk": "diff --git a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java\nindex 96c04522f3..46c7d8ad1b 100644\n--- a/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java\n+++ b/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java\n\n@@ -38,7 +39,7 @@ class PendingTransactionSender implements TransactionBatchAddedListener {\n     ethContext\n         .getEthPeers()\n         .streamAvailablePeers()\n-        .filter(transactionTracker::isPeerSupported)\n+        .filter(peer -> transactionTracker.isPeerSupported(peer, EthProtocol.ETH65))\n         .forEach(\n             peer ->\n                 transactions.forEach(\n"}}, {"oid": "77772a84527a726ab95ec920dd332d59dd7c2a25", "url": "https://github.com/hyperledger/besu/commit/77772a84527a726ab95ec920dd332d59dd7c2a25", "message": "Update ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PeerPendingTransactionTracker.java\n\nCo-Authored-By: Danno Ferrin <danno.ferrin@shemnon.com>\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>", "committedDate": "2020-04-15T17:49:56Z", "type": "commit"}, {"oid": "c6d9431495726b656f6ae49c292c28e0cb5cf907", "url": "https://github.com/hyperledger/besu/commit/c6d9431495726b656f6ae49c292c28e0cb5cf907", "message": "make protocol version part of the function\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>", "committedDate": "2020-04-15T17:50:02Z", "type": "commit"}, {"oid": "c6d9431495726b656f6ae49c292c28e0cb5cf907", "url": "https://github.com/hyperledger/besu/commit/c6d9431495726b656f6ae49c292c28e0cb5cf907", "message": "make protocol version part of the function\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>", "committedDate": "2020-04-15T17:50:02Z", "type": "forcePushed"}, {"oid": "af50c96677c37576c8e559246b1c232614e37093", "url": "https://github.com/hyperledger/besu/commit/af50c96677c37576c8e559246b1c232614e37093", "message": "Merge branch 'master' into eth65_compat", "committedDate": "2020-04-15T19:13:04Z", "type": "commit"}]}