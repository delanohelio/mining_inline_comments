{"pr_number": 1236, "pr_title": "Disregard Malformed From Fields and Use Sender Endpoints for Pongs", "pr_createdAt": "2020-07-18T17:25:32Z", "pr_url": "https://github.com/hyperledger/besu/pull/1236", "timeline": [{"oid": "e2d542ccdfe710eac84bac504f138f9b81699827", "url": "https://github.com/hyperledger/besu/commit/e2d542ccdfe710eac84bac504f138f9b81699827", "message": "add hive test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "dc5b1a2d4bfb078fe8418bfb44c5c471a3cdba21", "url": "https://github.com/hyperledger/besu/commit/dc5b1a2d4bfb078fe8418bfb44c5c471a3cdba21", "message": "garbage endpoint in peerdisccontrollertest\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "1b00a0924683b893430a81eb4e5160921e138381", "url": "https://github.com/hyperledger/besu/commit/1b00a0924683b893430a81eb4e5160921e138381", "message": "rlp deserialization test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "bbbc41e02cd51e5ce097c5c267d76368fce803c2", "url": "https://github.com/hyperledger/besu/commit/bbbc41e02cd51e5ce097c5c267d76368fce803c2", "message": "make things work with optional\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "264e55745b6c0b48bc285767e5d36e02f43629ef", "url": "https://github.com/hyperledger/besu/commit/264e55745b6c0b48bc285767e5d36e02f43629ef", "message": "PeerDiscoveryPacketPcapSedesTest changes from Optional getFrom\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "ad3baa63a3b3164738f6f3b60d16aed6f5be7264", "url": "https://github.com/hyperledger/besu/commit/ad3baa63a3b3164738f6f3b60d16aed6f5be7264", "message": "rlp deserialization test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T18:47:44Z", "type": "commit"}, {"oid": "50a40a88c47689ca9d8b6d96b9ae4a2e555d6e6e", "url": "https://github.com/hyperledger/besu/commit/50a40a88c47689ca9d8b6d96b9ae4a2e555d6e6e", "message": "allow empty from field in ping\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T23:41:09Z", "type": "commit"}, {"oid": "ffacf5f58a001e59e6801f52cf1c85b6f77f9174", "url": "https://github.com/hyperledger/besu/commit/ffacf5f58a001e59e6801f52cf1c85b6f77f9174", "message": "comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T23:41:09Z", "type": "commit"}, {"oid": "3cef8259995da5258da43fcdb427b8a3a04dfd2b", "url": "https://github.com/hyperledger/besu/commit/3cef8259995da5258da43fcdb427b8a3a04dfd2b", "message": "logging\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T23:41:09Z", "type": "commit"}, {"oid": "a37b26f45f674edba821290b4872b6c3d693ea8d", "url": "https://github.com/hyperledger/besu/commit/a37b26f45f674edba821290b4872b6c3d693ea8d", "message": "cleanup rebase\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-16T23:41:09Z", "type": "commit"}, {"oid": "a1491c4cebc5ec30ba8f090c24263e7e5d872e79", "url": "https://github.com/hyperledger/besu/commit/a1491c4cebc5ec30ba8f090c24263e7e5d872e79", "message": "scaffolding\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-17T03:07:30Z", "type": "commit"}, {"oid": "b965e5fef5ff97110686ae1f4671802451b3346c", "url": "https://github.com/hyperledger/besu/commit/b965e5fef5ff97110686ae1f4671802451b3346c", "message": "pass hive\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-18T03:15:43Z", "type": "commit"}, {"oid": "dc0fa9dc94b6033e753501cff4aaff0077b43bbd", "url": "https://github.com/hyperledger/besu/commit/dc0fa9dc94b6033e753501cff4aaff0077b43bbd", "message": "remove some stuff\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-18T03:22:16Z", "type": "commit"}, {"oid": "a4ae1673ec79a22563c1366922b4739e9e3a8db7", "url": "https://github.com/hyperledger/besu/commit/a4ae1673ec79a22563c1366922b4739e9e3a8db7", "message": "comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-18T03:22:24Z", "type": "commit"}, {"oid": "4b4f888e3eb3e63c2a17610bbcc670ca3fcec20b", "url": "https://github.com/hyperledger/besu/commit/4b4f888e3eb3e63c2a17610bbcc670ca3fcec20b", "message": "leave list properly\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-18T16:49:30Z", "type": "commit"}, {"oid": "be9c6e46fa05bf907ad197254fde0b35c1904d50", "url": "https://github.com/hyperledger/besu/commit/be9c6e46fa05bf907ad197254fde0b35c1904d50", "message": "spotless\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-18T17:17:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDA1NA==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r456940054", "bodyText": "perhaps map instead of isPresent ? otherOptional : empty\nActually OptionalInt doesn't have map.  That's why I hate it and use Optional<Integer>", "author": "shemnon", "createdAt": "2020-07-19T18:31:13Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "diffHunk": "@@ -182,23 +182,28 @@ protected boolean validatePacketSize(final int packetSize) {\n   }\n \n   protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet packet) {\n-    OptionalInt tcpPort = OptionalInt.empty();\n-    if (packet.getPacketData(PingPacketData.class).isPresent()) {\n-      final PingPacketData ping = packet.getPacketData(PingPacketData.class).orElseGet(null);\n-      if (ping != null && ping.getFrom() != null && ping.getFrom().getTcpPort().isPresent()) {\n-        tcpPort = ping.getFrom().getTcpPort();\n-      }\n-    }\n+    final int port = sourceEndpoint.getUdpPort();\n+    final int tcpPort =\n+        packet\n+            .getPacketData(PingPacketData.class)\n+            .flatMap(PingPacketData::getFrom)\n+            .flatMap(\n+                fromEndpoint -> {\n+                  final OptionalInt maybePort = fromEndpoint.getTcpPort();\n+                  return maybePort.isPresent()", "originalCommit": "be9c6e46fa05bf907ad197254fde0b35c1904d50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2ODc3NQ==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r456968775", "bodyText": "Totally agree, I already have a separate PR that I'll put up after this that includes the change.", "author": "RatanRSur", "createdAt": "2020-07-19T23:25:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDA1NA=="}], "type": "inlineReview", "revised_code": {"commit": "4ad40ff2b2a2c2d60cc5e5126305b8f1dedc8348", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\nindex de2a9e0d5..77282714d 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\n\n@@ -182,7 +182,7 @@ public abstract class PeerDiscoveryAgent {\n   }\n \n   protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet packet) {\n-    final int port = sourceEndpoint.getUdpPort();\n+    final int udpPort = sourceEndpoint.getUdpPort();\n     final int tcpPort =\n         packet\n             .getPacketData(PingPacketData.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDIzOA==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r456940238", "bodyText": "rename to udpPort for clarity.", "author": "shemnon", "createdAt": "2020-07-19T18:33:13Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "diffHunk": "@@ -182,23 +182,28 @@ protected boolean validatePacketSize(final int packetSize) {\n   }\n \n   protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet packet) {\n-    OptionalInt tcpPort = OptionalInt.empty();\n-    if (packet.getPacketData(PingPacketData.class).isPresent()) {\n-      final PingPacketData ping = packet.getPacketData(PingPacketData.class).orElseGet(null);\n-      if (ping != null && ping.getFrom() != null && ping.getFrom().getTcpPort().isPresent()) {\n-        tcpPort = ping.getFrom().getTcpPort();\n-      }\n-    }\n+    final int port = sourceEndpoint.getUdpPort();", "originalCommit": "be9c6e46fa05bf907ad197254fde0b35c1904d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4ad40ff2b2a2c2d60cc5e5126305b8f1dedc8348", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\nindex de2a9e0d5..77282714d 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java\n\n@@ -182,7 +182,7 @@ public abstract class PeerDiscoveryAgent {\n   }\n \n   protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet packet) {\n-    final int port = sourceEndpoint.getUdpPort();\n+    final int udpPort = sourceEndpoint.getUdpPort();\n     final int tcpPort =\n         packet\n             .getPacketData(PingPacketData.class)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDMyMw==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r456940323", "bodyText": "Would this comment look better before?  So it formats w/o breaking up the sender.getEndPoint()", "author": "shemnon", "createdAt": "2020-07-19T18:34:22Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -541,7 +541,12 @@ private void respondToPing(\n     if (packetData.getExpiration() < Instant.now().getEpochSecond()) {\n       return;\n     }\n-    final PongPacketData data = PongPacketData.create(packetData.getFrom(), pingHash);\n+    final PongPacketData data =\n+        PongPacketData.create(\n+            sender\n+                .getEndpoint() /* We don't care about the `from` field of the ping, we pong to the `sender` */,", "originalCommit": "be9c6e46fa05bf907ad197254fde0b35c1904d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a314fb943e5064ef5e15561481d928636fd87829", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java\nindex b89ad8390..88ceae793 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java\n\n@@ -541,11 +541,8 @@ public class PeerDiscoveryController {\n     if (packetData.getExpiration() < Instant.now().getEpochSecond()) {\n       return;\n     }\n-    final PongPacketData data =\n-        PongPacketData.create(\n-            sender\n-                .getEndpoint() /* We don't care about the `from` field of the ping, we pong to the `sender` */,\n-            pingHash);\n+    // We don't care about the `from` field of the ping, we pong to the `sender`\n+    final PongPacketData data = PongPacketData.create(sender.getEndpoint(), pingHash);\n \n     sendPacket(sender, PacketType.PONG, data);\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk0MDQzMw==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r456940433", "bodyText": "Is this correct?  Is it seconds?", "author": "shemnon", "createdAt": "2020-07-19T18:35:15Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java", "diffHunk": "@@ -20,26 +20,28 @@\n import org.hyperledger.besu.ethereum.rlp.RLPInput;\n import org.hyperledger.besu.ethereum.rlp.RLPOutput;\n \n+import java.util.Optional;\n+\n public class PingPacketData implements PacketData {\n \n   /* Fixed value that represents we're using v5 of the P2P discovery protocol. */\n   private static final int VERSION = 5;\n \n-  /* Source. */\n-  private final Endpoint from;\n+  /* Source. If the field is garbage this is empty and we might need to recover it another way. From our bonded peers, for example. */\n+  private final Optional<Endpoint> maybeFrom;\n \n   /* Destination. */\n   private final Endpoint to;\n \n   /* In millis after epoch. */", "originalCommit": "be9c6e46fa05bf907ad197254fde0b35c1904d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d10a6484442d6d94e1d54d058acc9cd6b9141b72", "chunk": "diff --git a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java\nindex 37da158d0..a9763d94a 100644\n--- a/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java\n+++ b/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PingPacketData.java\n\n@@ -33,7 +33,7 @@ public class PingPacketData implements PacketData {\n   /* Destination. */\n   private final Endpoint to;\n \n-  /* In millis after epoch. */\n+  /* In seconds after epoch. */\n   private final long expiration;\n \n   private PingPacketData(\n"}}, {"oid": "4ad40ff2b2a2c2d60cc5e5126305b8f1dedc8348", "url": "https://github.com/hyperledger/besu/commit/4ad40ff2b2a2c2d60cc5e5126305b8f1dedc8348", "message": "rename port -> udpPort\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-19T22:50:03Z", "type": "commit"}, {"oid": "a314fb943e5064ef5e15561481d928636fd87829", "url": "https://github.com/hyperledger/besu/commit/a314fb943e5064ef5e15561481d928636fd87829", "message": "move comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-19T23:30:30Z", "type": "commit"}, {"oid": "d10a6484442d6d94e1d54d058acc9cd6b9141b72", "url": "https://github.com/hyperledger/besu/commit/d10a6484442d6d94e1d54d058acc9cd6b9141b72", "message": "fix documentation bug\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-19T23:37:52Z", "type": "commit"}, {"oid": "115970d93bcdf2e2e281bf15eb009c62db89f4c8", "url": "https://github.com/hyperledger/besu/commit/115970d93bcdf2e2e281bf15eb009c62db89f4c8", "message": "remove redundant supression\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-19T23:40:40Z", "type": "commit"}, {"oid": "8e0eae123c963b44010931f2b675596ba2bf7328", "url": "https://github.com/hyperledger/besu/commit/8e0eae123c963b44010931f2b675596ba2bf7328", "message": "Merge branch 'master' into hive-devp2p-fixes", "committedDate": "2020-07-20T19:49:20Z", "type": "commit"}, {"oid": "16798bfc43ed0620fa01e735cfe3b4a34a5bef74", "url": "https://github.com/hyperledger/besu/commit/16798bfc43ed0620fa01e735cfe3b4a34a5bef74", "message": "more accurate tests\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-21T16:37:38Z", "type": "commit"}, {"oid": "0aff700d0e13e4c8e5acb5d5da0a1aa84ac57d1e", "url": "https://github.com/hyperledger/besu/commit/0aff700d0e13e4c8e5acb5d5da0a1aa84ac57d1e", "message": "Merge remote-tracking branch 'upstream/master' into hive-devp2p-fixes", "committedDate": "2020-07-21T16:44:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDIwMA==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r458244200", "bodyText": "cosmetic", "author": "RatanRSur", "createdAt": "2020-07-21T16:50:31Z", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/Endpoint.java", "diffHunk": "@@ -38,26 +39,39 @@\n   private final int udpPort;\n   private final OptionalInt tcpPort;\n \n+  private static class IllegalPortException extends IllegalArgumentException {\n+    IllegalPortException(final String message) {\n+      super(message);\n+    }\n+  }\n+\n+  private static void checkPort(final int port, final String portTypeName) {\n+    if (!NetworkUtility.isValidPort(port)) {\n+      throw new IllegalPortException(\n+          String.format(\n+              \"%s port requires a value between 1 and 65535. Got %d.\", portTypeName, port));\n+    }\n+  }\n+\n   public Endpoint(final String host, final int udpPort, final OptionalInt tcpPort) {\n     checkArgument(\n         host != null && InetAddresses.isInetAddress(host), \"host requires a valid IP address\");\n-    checkArgument(\n-        NetworkUtility.isValidPort(udpPort), \"UDP port requires a value between 1 and 65535\");\n-    tcpPort.ifPresent(\n-        p ->\n-            checkArgument(\n-                NetworkUtility.isValidPort(p), \"TCP port requires a value between 1 and 65535\"));\n+    checkPort(udpPort, \"UDP\");\n+    tcpPort.ifPresent(port -> checkPort(port, \"TCP\"));\n \n     this.host = host;\n     this.udpPort = udpPort;\n     this.tcpPort = tcpPort;\n   }\n \n   public static Endpoint fromEnode(final EnodeURL enode) {\n-    checkArgument(\n-        enode.getDiscoveryPort().isPresent(),\n-        \"Attempt to create a discovery endpoint for an enode with discovery disabled.\");\n-    final int discoveryPort = enode.getDiscoveryPort().getAsInt();\n+    final int discoveryPort =\n+        enode\n+            .getDiscoveryPort()\n+            .orElseThrow(\n+                () ->\n+                    new IllegalArgumentException(\n+                        \"Attempt to create a discovery endpoint for an enode with discovery disabled.\"));", "originalCommit": "0aff700d0e13e4c8e5acb5d5da0a1aa84ac57d1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2ODA0Mw==", "url": "https://github.com/hyperledger/besu/pull/1236#discussion_r458268043", "bodyText": "I think the guard block reads better.", "author": "shemnon", "createdAt": "2020-07-21T17:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0NDIwMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b13c199f3fbbb8d760051c3b1355edefac6ea772", "url": "https://github.com/hyperledger/besu/commit/b13c199f3fbbb8d760051c3b1355edefac6ea772", "message": "empty commit to trigger build\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-21T18:20:28Z", "type": "commit"}, {"oid": "b13c199f3fbbb8d760051c3b1355edefac6ea772", "url": "https://github.com/hyperledger/besu/commit/b13c199f3fbbb8d760051c3b1355edefac6ea772", "message": "empty commit to trigger build\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-07-21T18:20:28Z", "type": "forcePushed"}]}