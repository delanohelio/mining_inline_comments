{"pr_number": 522, "pr_title": "[PIE-2333] Fix trace replay block transactions", "pr_createdAt": "2020-03-18T14:42:51Z", "pr_url": "https://github.com/hyperledger/besu/pull/522", "timeline": [{"oid": "9e1a491fbe2f47aa4b9bb81337adf175080e008b", "url": "https://github.com/hyperledger/besu/commit/9e1a491fbe2f47aa4b9bb81337adf175080e008b", "message": "update changelog\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-12T09:36:38Z", "type": "commit"}, {"oid": "4f91d6f0cb2305e3decd444d3796edf72da5e0b9", "url": "https://github.com/hyperledger/besu/commit/4f91d6f0cb2305e3decd444d3796edf72da5e0b9", "message": "Merge branch 'master' of https://github.com/hyperledger/besu\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-12T15:28:02Z", "type": "commit"}, {"oid": "9b72e4aebeed925ea6eff57c6e831786fd2dd920", "url": "https://github.com/hyperledger/besu/commit/9b72e4aebeed925ea6eff57c6e831786fd2dd920", "message": "Merge branch 'master' of https://github.com/matkt/besu\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-16T10:27:25Z", "type": "commit"}, {"oid": "6853b33303744e64884eec8953ad8bd838ce07de", "url": "https://github.com/hyperledger/besu/commit/6853b33303744e64884eec8953ad8bd838ce07de", "message": "fix trace_replayBlockTransactions and add missing tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-18T14:13:31Z", "type": "commit"}, {"oid": "aaa51949bef65c560ddf24453a18d6914a66f108", "url": "https://github.com/hyperledger/besu/commit/aaa51949bef65c560ddf24453a18d6914a66f108", "message": "remove useless diff\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-18T14:28:37Z", "type": "commit"}, {"oid": "ddfd1cd10076fec19589a706f22ecb9be941cce0", "url": "https://github.com/hyperledger/besu/commit/ddfd1cd10076fec19589a706f22ecb9be941cce0", "message": "rename method addContractCreationMethodTrace\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-18T14:44:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0Mjc5MQ==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394442791", "bodyText": "Why using a local variable there ? You could pass directly this value to the builder", "author": "abdelhamidbakhta", "createdAt": "2020-03-18T15:39:19Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java", "diffHunk": "@@ -428,21 +431,26 @@ private static void addAdditionalTransactionInformationToFlatTrace(\n         .transactionPosition(\n             block.getBody().getTransactions().indexOf(transactionTrace.getTransaction()))\n         .transactionHash(transactionTrace.getTransaction().getHash().toHexString());\n-    // add creationMethod for create action\n-    Optional.ofNullable(builder.getType())\n-        .filter(type -> type.equals(\"create\"))\n-        .ifPresent(__ -> addContractCreationMethodToFlatTrace(transactionTrace, builder));\n+\n+    addContractCreationMethodToTrace(transactionTrace, builder);\n   }\n \n-  private static void addContractCreationMethodToFlatTrace(\n+  private static void addContractCreationMethodToTrace(\n       final TransactionTrace transactionTrace, final FlatTrace.Builder builder) {\n-    final String creationMethod =\n-        transactionTrace.getTraceFrames().stream()\n-            .filter(frame -> \"CREATE2\".equals(frame.getOpcode()))\n-            .findFirst()\n-            .map(TraceFrame::getOpcode)\n-            .orElse(\"CREATE\")\n-            .toLowerCase(Locale.US);\n-    builder.getActionBuilder().creationMethod(creationMethod);\n+\n+    // add creationMethod for create action\n+    Optional.ofNullable(builder.getType())\n+        .filter(type -> type.equals(\"create\"))\n+        .ifPresent(\n+            __ -> {\n+              final String creationMethod =", "originalCommit": "ddfd1cd10076fec19589a706f22ecb9be941cce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxODg5NQ==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394918895", "bodyText": "Done \ud83d\udc4d", "author": "matkt", "createdAt": "2020-03-19T10:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0Mjc5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxOTg5MA==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394919890", "bodyText": "Nice", "author": "abdelhamidbakhta", "createdAt": "2020-03-19T10:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0Mjc5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "5629419689aaff0f94b8f95e522ebd16dad236a7", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\nindex 3f228f2d2..4d9bf6d74 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n\n@@ -442,15 +442,15 @@ public class FlatTraceGenerator {\n     Optional.ofNullable(builder.getType())\n         .filter(type -> type.equals(\"create\"))\n         .ifPresent(\n-            __ -> {\n-              final String creationMethod =\n-                  transactionTrace.getTraceFrames().stream()\n-                      .filter(frame -> \"CREATE2\".equals(frame.getOpcode()))\n-                      .findFirst()\n-                      .map(TraceFrame::getOpcode)\n-                      .orElse(\"CREATE\")\n-                      .toLowerCase(Locale.US);\n-              builder.getActionBuilder().creationMethod(creationMethod);\n-            });\n+            __ ->\n+                builder\n+                    .getActionBuilder()\n+                    .creationMethod(\n+                        transactionTrace.getTraceFrames().stream()\n+                            .filter(frame -> \"CREATE2\".equals(frame.getOpcode()))\n+                            .findFirst()\n+                            .map(TraceFrame::getOpcode)\n+                            .orElse(\"CREATE\")\n+                            .toLowerCase(Locale.US)));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0MzQzMA==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394443430", "bodyText": "Have you tested with several levels deep ?", "author": "abdelhamidbakhta", "createdAt": "2020-03-18T15:40:10Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/vm/VmTraceGenerator.java", "diffHunk": "@@ -172,6 +180,10 @@ private void handleDepthIncreased(\n         } else {\n           if (currentTraceFrame.getPrecompiledGasCost().isPresent()) {\n             op.setCost(op.getCost() + currentTraceFrame.getPrecompiledGasCost().get().toLong());\n+          } else if (currentOperation.equals(\"STATICCALL\")\n+              && nextTraceFrame.map(TraceFrame::getDepth).orElse(0)", "originalCommit": "ddfd1cd10076fec19589a706f22ecb9be941cce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxODc2OA==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394918768", "bodyText": "I added a new test transaction with several levels deeps :\n\nBlock 0x17 with depth == 0\nBlock 0x18 with depth == 2", "author": "matkt", "createdAt": "2020-03-19T10:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0MzQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxOTk1Mg==", "url": "https://github.com/hyperledger/besu/pull/522#discussion_r394919952", "bodyText": "Nice", "author": "abdelhamidbakhta", "createdAt": "2020-03-19T10:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ0MzQzMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5629419689aaff0f94b8f95e522ebd16dad236a7", "url": "https://github.com/hyperledger/besu/commit/5629419689aaff0f94b8f95e522ebd16dad236a7", "message": "update test and fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-19T10:13:54Z", "type": "commit"}, {"oid": "93606fbfadf24d11a2b741598f2d5e0c493f2703", "url": "https://github.com/hyperledger/besu/commit/93606fbfadf24d11a2b741598f2d5e0c493f2703", "message": "Merge commit 'bcdb1144b54949edac3b76ed456bf4d8e3e0741c' into feature/PIE-2333-fix-trace-replay-block-transactions\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-19T10:24:21Z", "type": "commit"}, {"oid": "1c4ed7b961fa8665aef18bc086687a8366718bad", "url": "https://github.com/hyperledger/besu/commit/1c4ed7b961fa8665aef18bc086687a8366718bad", "message": "fix test after merge\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>", "committedDate": "2020-03-19T10:41:37Z", "type": "commit"}]}