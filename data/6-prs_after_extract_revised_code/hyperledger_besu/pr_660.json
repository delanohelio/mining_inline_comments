{"pr_number": 660, "pr_title": "[EIP-1559] Step 5 - Gas price and gas limit block header validation rules", "pr_createdAt": "2020-04-06T15:36:27Z", "pr_url": "https://github.com/hyperledger/besu/pull/660", "timeline": [{"oid": "ba37fd0efcba2de4ea34c979060ff361a1fe9798", "url": "https://github.com/hyperledger/besu/commit/ba37fd0efcba2de4ea34c979060ff361a1fe9798", "message": "Added changelog entries for PR:\n- https://github.com/hyperledger/besu/pull/430\n- https://github.com/hyperledger/besu/pull/440\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-12T09:09:40Z", "type": "commit"}, {"oid": "872f9cc4e93b90829961ebe6e599c51af43c95a7", "url": "https://github.com/hyperledger/besu/commit/872f9cc4e93b90829961ebe6e599c51af43c95a7", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md", "committedDate": "2020-03-13T08:25:43Z", "type": "commit"}, {"oid": "e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "url": "https://github.com/hyperledger/besu/commit/e417b30e90cb0b33940adb1bee6a9dc8953c4abd", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-16T09:10:11Z", "type": "commit"}, {"oid": "a2fb831c87dae221c92a9f9ec7705500717f1e77", "url": "https://github.com/hyperledger/besu/commit/a2fb831c87dae221c92a9f9ec7705500717f1e77", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T09:17:25Z", "type": "commit"}, {"oid": "c07ed7de515e1e25ea22ef38b59bf8337086812e", "url": "https://github.com/hyperledger/besu/commit/c07ed7de515e1e25ea22ef38b59bf8337086812e", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-17T15:26:18Z", "type": "commit"}, {"oid": "1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "url": "https://github.com/hyperledger/besu/commit/1c1e22fe5a81e6a748b338a2ebedaaa53a00f04d", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-18T08:29:25Z", "type": "commit"}, {"oid": "ee10a2590d8e23b95a40c946a2927730714c4793", "url": "https://github.com/hyperledger/besu/commit/ee10a2590d8e23b95a40c946a2927730714c4793", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-19T16:27:54Z", "type": "commit"}, {"oid": "40cd31d7b48aab7b285524661ac17168c0d38467", "url": "https://github.com/hyperledger/besu/commit/40cd31d7b48aab7b285524661ac17168c0d38467", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-23T10:35:38Z", "type": "commit"}, {"oid": "e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "url": "https://github.com/hyperledger/besu/commit/e96c01a8ca248ded2aa4f22a6f56d9119cabebf2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-25T08:04:10Z", "type": "commit"}, {"oid": "2c782ba4617a68e42def01737bdc6950ff7f9f53", "url": "https://github.com/hyperledger/besu/commit/2c782ba4617a68e42def01737bdc6950ff7f9f53", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-03-31T09:26:18Z", "type": "commit"}, {"oid": "8b7f62d00c53ed1e8de940bffc675fad31825ba2", "url": "https://github.com/hyperledger/besu/commit/8b7f62d00c53ed1e8de940bffc675fad31825ba2", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-02T11:50:21Z", "type": "commit"}, {"oid": "ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "url": "https://github.com/hyperledger/besu/commit/ce2a4c9a0d600f1309fc1a6e3be8c3d04c0e543a", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-03T08:45:52Z", "type": "commit"}, {"oid": "97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "url": "https://github.com/hyperledger/besu/commit/97fc9b5900c05a3f4c18183e1b861fd86b6152b6", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T10:50:47Z", "type": "commit"}, {"oid": "95947ab35e9145c5f788bb98ad1068a3db7a4895", "url": "https://github.com/hyperledger/besu/commit/95947ab35e9145c5f788bb98ad1068a3db7a4895", "message": "Merge remote-tracking branch 'upstream/master'\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T12:24:48Z", "type": "commit"}, {"oid": "e8c4e9921430b8a06f8bb882bc9ce4975ce5579b", "url": "https://github.com/hyperledger/besu/commit/e8c4e9921430b8a06f8bb882bc9ce4975ce5579b", "message": "Implement gas limit and gas price block header validation rules as per specified in EIP-1559\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-06T15:33:44Z", "type": "commit"}, {"oid": "e911532ffe39cc3d159d29fa8e99b7506fdcf168", "url": "https://github.com/hyperledger/besu/commit/e911532ffe39cc3d159d29fa8e99b7506fdcf168", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T08:15:04Z", "type": "commit"}, {"oid": "9fb289299c04b4afc774b74c51b5ed15ad63882f", "url": "https://github.com/hyperledger/besu/commit/9fb289299c04b4afc774b74c51b5ed15ad63882f", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T09:00:06Z", "type": "commit"}, {"oid": "c521cef761d09abb3aee753bf5207fac9574bf87", "url": "https://github.com/hyperledger/besu/commit/c521cef761d09abb3aee753bf5207fac9574bf87", "message": "Merge remote-tracking branch 'upstream/master' into eip1559-step5\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-07T11:18:43Z", "type": "commit"}, {"oid": "aa2f839d1218a684625a616a76754af216510221", "url": "https://github.com/hyperledger/besu/commit/aa2f839d1218a684625a616a76754af216510221", "message": "Merge branch 'eip1559-step5' of https://github.com/abdelhamidbakhta/besu into eip1559-step5", "committedDate": "2020-04-07T11:19:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNDk1OA==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r404914958", "bodyText": "This makes the BlockHeaderValidator mutable, and IMHO should not be done.  Note we have a builder that has the exact same method, so instead of mutating a produced BlockHeaderValidator we should hook into wherever the builder is being created.", "author": "shemnon", "createdAt": "2020-04-07T15:46:21Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/BlockHeaderValidator.java", "diffHunk": "@@ -99,6 +99,10 @@ private boolean applyRules(\n     return parent;\n   }\n \n+  public void addRule(final AttachedBlockHeaderValidationRule<C> rule) {", "originalCommit": "aa2f839d1218a684625a616a76754af216510221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NTgyNw==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r405475827", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-04-08T12:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNDk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyNDg0MA==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r405724840", "bodyText": "We still need to delete this method.", "author": "shemnon", "createdAt": "2020-04-08T18:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxNDk1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxODYzMg==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r404918632", "bodyText": "Maybe start this off with a check of the feature flag?  Throw an exception if not set?", "author": "shemnon", "createdAt": "2020-04-07T15:51:07Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java", "diffHunk": "@@ -324,6 +328,21 @@ private MainnetProtocolSpecs() {}\n         .name(\"MuirGlacier\");\n   }\n \n+  // TODO EIP-1559 change for the actual fork name when known\n+  static ProtocolSpecBuilder<Void> eip1559Definition(\n+      final Optional<BigInteger> chainId,\n+      final OptionalInt contractSizeLimit,\n+      final OptionalInt configStackSizeLimit,\n+      final boolean enableRevertReason,\n+      final GenesisConfigOptions genesisConfigOptions) {", "originalCommit": "aa2f839d1218a684625a616a76754af216510221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MjE4Mw==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r404972183", "bodyText": "Good idea.", "author": "abdelhamidbakhta", "createdAt": "2020-04-07T17:06:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxODYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3MzUxNg==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r404973516", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-04-07T17:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkxODYzMg=="}], "type": "inlineReview", "revised_code": {"commit": "f50d8a82784032eb10bb0ae34ceb17ca0e48cff5", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java\nindex 16767a910..9a9c9d1e9 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetProtocolSpecs.java\n\n@@ -335,6 +336,9 @@ public abstract class MainnetProtocolSpecs {\n       final OptionalInt configStackSizeLimit,\n       final boolean enableRevertReason,\n       final GenesisConfigOptions genesisConfigOptions) {\n+    if (!ExperimentalEIPs.eip1559Enabled) {\n+      throw new RuntimeException(\"EIP-1559 feature flag must be enabled\");\n+    }\n     final EIP1559 eip1559 = new EIP1559(genesisConfigOptions.getEIP1559BlockNumber().orElse(0));\n     return muirGlacierDefinition(\n             chainId, contractSizeLimit, configStackSizeLimit, enableRevertReason)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyMjg5NQ==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r404922895", "bodyText": "This will require a tiny bit of replumbing.  We can have blockHeaderValidatorBuilder return the builder instead of the fully assembled blockHeaderValidator. Then we call addRule on the builder, then build and store.", "author": "shemnon", "createdAt": "2020-04-07T15:56:50Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java", "diffHunk": "@@ -284,6 +294,8 @@\n \n     final BlockHeaderValidator<T> blockHeaderValidator =\n         blockHeaderValidatorBuilder.apply(difficultyCalculator);\n+    additionalBlockHeaderValidationRules.forEach(blockHeaderValidator::addRule);", "originalCommit": "aa2f839d1218a684625a616a76754af216510221", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ3NTg4OQ==", "url": "https://github.com/hyperledger/besu/pull/660#discussion_r405475889", "bodyText": "Done", "author": "abdelhamidbakhta", "createdAt": "2020-04-08T12:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkyMjg5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "73d8cb5ea853db4d1e8c59f35ac71129f45ec2ec", "chunk": "diff --git a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java\nindex 3b4fb5bab..e93c2a369 100644\n--- a/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java\n+++ b/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/ProtocolSpecBuilder.java\n\n@@ -293,11 +285,10 @@ public class ProtocolSpecBuilder<T> {\n             gasCalculator, transactionValidator, contractCreationProcessor, messageCallProcessor);\n \n     final BlockHeaderValidator<T> blockHeaderValidator =\n-        blockHeaderValidatorBuilder.apply(difficultyCalculator);\n-    additionalBlockHeaderValidationRules.forEach(blockHeaderValidator::addRule);\n+        blockHeaderValidatorBuilder.build(difficultyCalculator);\n \n     final BlockHeaderValidator<T> ommerHeaderValidator =\n-        ommerHeaderValidatorBuilder.apply(difficultyCalculator);\n+        ommerHeaderValidatorBuilder.build(difficultyCalculator);\n     final BlockBodyValidator<T> blockBodyValidator =\n         blockBodyValidatorBuilder.apply(protocolSchedule);\n \n"}}, {"oid": "bf071760ff3b625136c23384427ada14d4e3b929", "url": "https://github.com/hyperledger/besu/commit/bf071760ff3b625136c23384427ada14d4e3b929", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T16:31:31Z", "type": "commit"}, {"oid": "f50d8a82784032eb10bb0ae34ceb17ca0e48cff5", "url": "https://github.com/hyperledger/besu/commit/f50d8a82784032eb10bb0ae34ceb17ca0e48cff5", "message": "guard with feature flag\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-07T17:08:20Z", "type": "commit"}, {"oid": "25a5a2191bd92fa7ef31bf9664ab58eabb8ca243", "url": "https://github.com/hyperledger/besu/commit/25a5a2191bd92fa7ef31bf9664ab58eabb8ca243", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-07T17:46:49Z", "type": "commit"}, {"oid": "a30112f700f3a1a9b19c18b20693bd226279f19d", "url": "https://github.com/hyperledger/besu/commit/a30112f700f3a1a9b19c18b20693bd226279f19d", "message": "Merge remote-tracking branch 'upstream/master' into eip1559-step5\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-08T07:51:09Z", "type": "commit"}, {"oid": "73d8cb5ea853db4d1e8c59f35ac71129f45ec2ec", "url": "https://github.com/hyperledger/besu/commit/73d8cb5ea853db4d1e8c59f35ac71129f45ec2ec", "message": "address pr comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-08T10:11:46Z", "type": "commit"}, {"oid": "498493b7047070b855d6a9abc99f0a7758ccb352", "url": "https://github.com/hyperledger/besu/commit/498493b7047070b855d6a9abc99f0a7758ccb352", "message": "address pr comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-04-08T11:19:00Z", "type": "commit"}, {"oid": "c3abfac07d0891efa58baf56770f0b0384828507", "url": "https://github.com/hyperledger/besu/commit/c3abfac07d0891efa58baf56770f0b0384828507", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-08T13:57:57Z", "type": "commit"}, {"oid": "c92365a564a2f913fd799d9ae76fb6434072b0b3", "url": "https://github.com/hyperledger/besu/commit/c92365a564a2f913fd799d9ae76fb6434072b0b3", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-09T05:28:47Z", "type": "commit"}, {"oid": "5af7cbf0169956e1310ae6020026490c8fe58195", "url": "https://github.com/hyperledger/besu/commit/5af7cbf0169956e1310ae6020026490c8fe58195", "message": "Merge branch 'master' into eip1559-step5", "committedDate": "2020-04-09T06:17:11Z", "type": "commit"}]}