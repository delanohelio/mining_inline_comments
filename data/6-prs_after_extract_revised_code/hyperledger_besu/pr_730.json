{"pr_number": 730, "pr_title": "Private log filter implementation", "pr_createdAt": "2020-04-16T04:36:14Z", "pr_url": "https://github.com/hyperledger/besu/pull/730", "timeline": [{"oid": "c9fcc02a4694f7cce33a4cee322885ad77938a45", "url": "https://github.com/hyperledger/besu/commit/c9fcc02a4694f7cce33a4cee322885ad77938a45", "message": "Private log filter implementation\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-04-16T22:44:29Z", "type": "commit"}, {"oid": "c9fcc02a4694f7cce33a4cee322885ad77938a45", "url": "https://github.com/hyperledger/besu/commit/c9fcc02a4694f7cce33a4cee322885ad77938a45", "message": "Private log filter implementation\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-04-16T22:44:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk0NTk1NA==", "url": "https://github.com/hyperledger/besu/pull/730#discussion_r409945954", "bodyText": "What I do not really like about this method is that it creates the filter manager AND then does the vertx.deployVerticle() as well. That means that at least the name is wrong!\nMaybe this method is not needed at all if we just use the builder instead and do the deploy after?", "author": "pinges", "createdAt": "2020-04-17T01:48:26Z", "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -626,11 +625,18 @@ public Runner build() {\n   private FilterManager createFilterManager(\n       final Vertx vertx,\n       final BlockchainQueries blockchainQueries,\n-      final TransactionPool transactionPool) {\n+      final TransactionPool transactionPool,", "originalCommit": "c9fcc02a4694f7cce33a4cee322885ad77938a45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e875846eb7b1ece2ff2bbdeb3cefa37e89bb9012", "chunk": "diff --git a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\nindex 35b0cc2768..0aeb45a3be 100644\n--- a/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n+++ b/besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java\n\n@@ -622,24 +628,6 @@ public class RunnerBuilder {\n     return fixedNodes;\n   }\n \n-  private FilterManager createFilterManager(\n-      final Vertx vertx,\n-      final BlockchainQueries blockchainQueries,\n-      final TransactionPool transactionPool,\n-      final PrivacyParameters privacyParameters) {\n-\n-    final FilterManager filterManager =\n-        new FilterManagerBuilder()\n-            .blockchainQueries(blockchainQueries)\n-            .transactionPool(transactionPool)\n-            .privacyParameters(privacyParameters)\n-            .build();\n-\n-    vertx.deployVerticle(filterManager);\n-\n-    return filterManager;\n-  }\n-\n   private Map<String, JsonRpcMethod> jsonRpcMethods(\n       final ProtocolSchedule<?> protocolSchedule,\n       final BesuController<?> besuController,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk0NzEyMA==", "url": "https://github.com/hyperledger/besu/pull/730#discussion_r409947120", "bodyText": "The other public methods seem to have javadoc. I'm not sure how consistent we are with javadoc. What are we aiming for?", "author": "pinges", "createdAt": "2020-04-17T01:52:44Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -110,6 +116,17 @@ public String installLogFilter(\n     return filterId;\n   }\n \n+  public String installPrivateLogFilter(", "originalCommit": "c9fcc02a4694f7cce33a4cee322885ad77938a45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e875846eb7b1ece2ff2bbdeb3cefa37e89bb9012", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\nindex f08ec65303..8b47874554 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java\n\n@@ -116,6 +116,15 @@ public class FilterManager extends AbstractVerticle {\n     return filterId;\n   }\n \n+  /**\n+   * Installs a new private log filter\n+   *\n+   * @param privacyGroupId String privacyGroupId\n+   * @param fromBlock {@link BlockParameter} Integer block number, or latest/pending/earliest.\n+   * @param toBlock {@link BlockParameter} Integer block number, or latest/pending/earliest.\n+   * @param logsQuery {@link LogsQuery} Addresses and/or topics to filter by\n+   * @return the log filter id\n+   */\n   public String installPrivateLogFilter(\n       final String privacyGroupId,\n       final BlockParameter fromBlock,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk1MzM4Ng==", "url": "https://github.com/hyperledger/besu/pull/730#discussion_r409953386", "bodyText": "you could check whether it is equal to the logWithMetadata() log.", "author": "pinges", "createdAt": "2020-04-17T02:18:07Z", "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManagerLogFilterTest.java", "diffHunk": "@@ -194,6 +202,34 @@ public void getLogsShouldResetFilterExpireDate() {\n     verify(filter).resetExpireTime();\n   }\n \n+  @Test\n+  public void installAndUninstallPrivateFilter() {\n+    final String filterId =\n+        filterManager.installPrivateLogFilter(PRIVACY_GROUP_ID, latest(), latest(), logsQuery());\n+\n+    assertThat(filterRepository.getFilter(filterId, PrivateLogFilter.class)).isPresent();\n+\n+    assertThat(filterManager.uninstallFilter(filterId)).isTrue();\n+\n+    assertThat(filterRepository.getFilter(filterId, PrivateLogFilter.class)).isEmpty();\n+  }\n+\n+  @Test\n+  public void privateLogFilterShouldQueryPrivacyQueriesObject() {\n+    when(privacyQueries.matchingLogs(eq(PRIVACY_GROUP_ID), anyLong(), anyLong(), any()))\n+        .thenReturn(Lists.newArrayList(logWithMetadata()));\n+\n+    final String filterId =\n+        filterManager.installPrivateLogFilter(PRIVACY_GROUP_ID, latest(), latest(), logsQuery());\n+    recordNewBlockEvent();\n+\n+    verify(blockchainQueries, times(2)).headBlockNumber();\n+    verify(blockchainQueries, times(0)).matchingLogs(anyLong(), anyLong(), any());\n+\n+    verify(privacyQueries).matchingLogs(eq(PRIVACY_GROUP_ID), anyLong(), anyLong(), any());\n+    assertThat(filterManager.logsChanges(filterId).size()).isEqualTo(1);", "originalCommit": "c9fcc02a4694f7cce33a4cee322885ad77938a45", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e875846eb7b1ece2ff2bbdeb3cefa37e89bb9012", "chunk": "diff --git a/ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManagerLogFilterTest.java b/ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManagerLogFilterTest.java\nindex 4eb69b4320..904d37e0c5 100644\n--- a/ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManagerLogFilterTest.java\n+++ b/ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManagerLogFilterTest.java\n\n@@ -216,8 +216,9 @@ public class FilterManagerLogFilterTest {\n \n   @Test\n   public void privateLogFilterShouldQueryPrivacyQueriesObject() {\n+    final LogWithMetadata logWithMetadata = logWithMetadata();\n     when(privacyQueries.matchingLogs(eq(PRIVACY_GROUP_ID), anyLong(), anyLong(), any()))\n-        .thenReturn(Lists.newArrayList(logWithMetadata()));\n+        .thenReturn(Lists.newArrayList(logWithMetadata));\n \n     final String filterId =\n         filterManager.installPrivateLogFilter(PRIVACY_GROUP_ID, latest(), latest(), logsQuery());\n"}}, {"oid": "9b339827bd09f70a59802a50ab0a80fd6b265036", "url": "https://github.com/hyperledger/besu/commit/9b339827bd09f70a59802a50ab0a80fd6b265036", "message": "Merge branch 'master' into priv_filters\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-04-17T03:39:18Z", "type": "commit"}, {"oid": "e875846eb7b1ece2ff2bbdeb3cefa37e89bb9012", "url": "https://github.com/hyperledger/besu/commit/e875846eb7b1ece2ff2bbdeb3cefa37e89bb9012", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucas.saldanha@consensys.net>", "committedDate": "2020-04-17T03:51:27Z", "type": "commit"}, {"oid": "96458c446371972744ba3251d48037787365fa24", "url": "https://github.com/hyperledger/besu/commit/96458c446371972744ba3251d48037787365fa24", "message": "Merge branch 'master' into priv_filters", "committedDate": "2020-04-17T04:18:18Z", "type": "commit"}]}