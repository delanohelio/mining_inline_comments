{"pr_number": 1726, "pr_title": "Generate All Transaction Types and TransactionReceipt Types in BlockDataGenerator", "pr_createdAt": "2020-12-16T19:41:15Z", "pr_url": "https://github.com/hyperledger/besu/pull/1726", "timeline": [{"oid": "1e81c0b1bac1a5129cf10805375259eda909fdb5", "url": "https://github.com/hyperledger/besu/commit/1e81c0b1bac1a5129cf10805375259eda909fdb5", "message": "some test fixes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-16T19:34:30Z", "type": "commit"}, {"oid": "c6c16f1b6b1f392dd43607279c7412b28baed80c", "url": "https://github.com/hyperledger/besu/commit/c6c16f1b6b1f392dd43607279c7412b28baed80c", "message": "spotless\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-16T19:36:34Z", "type": "commit"}, {"oid": "4b3b63165dbcf9743c8b3c9d8cf1173c2cce5949", "url": "https://github.com/hyperledger/besu/commit/4b3b63165dbcf9743c8b3c9d8cf1173c2cce5949", "message": "go back to wrap\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-16T20:03:03Z", "type": "commit"}, {"oid": "ef843dd1d787dd01f472fd398b17419d30e3e9a3", "url": "https://github.com/hyperledger/besu/commit/ef843dd1d787dd01f472fd398b17419d30e3e9a3", "message": "wrap bytes properly\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-16T21:26:14Z", "type": "commit"}, {"oid": "17aa80ca7923caf1ff937186f9f21c7da96f2c1b", "url": "https://github.com/hyperledger/besu/commit/17aa80ca7923caf1ff937186f9f21c7da96f2c1b", "message": "add TransactionType to BlockOptions\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-16T22:30:51Z", "type": "commit"}, {"oid": "cf0cffed3f19485767e3b26e24f48895f27c3c85", "url": "https://github.com/hyperledger/besu/commit/cf0cffed3f19485767e3b26e24f48895f27c3c85", "message": "REPLACE STATE ROOTS\n\nThis happened because the random seed created different payloads\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T00:30:16Z", "type": "commit"}, {"oid": "1c500aea89ce3d390312885961932a460c2b39da", "url": "https://github.com/hyperledger/besu/commit/1c500aea89ce3d390312885961932a460c2b39da", "message": "don't generate gas price for EIP-1559 transaction\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T15:55:38Z", "type": "commit"}, {"oid": "df5244b5be22383d928acb21ef16ff877a13d3e6", "url": "https://github.com/hyperledger/besu/commit/df5244b5be22383d928acb21ef16ff877a13d3e6", "message": "fix hardcoded index\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T16:35:22Z", "type": "commit"}, {"oid": "79eed1df7b0b44a4f98e9f642a37e0c95c5fac8f", "url": "https://github.com/hyperledger/besu/commit/79eed1df7b0b44a4f98e9f642a37e0c95c5fac8f", "message": "fix brittle test again\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T17:26:37Z", "type": "commit"}, {"oid": "2782623c5c6204904e889fb586373719846c4bfd", "url": "https://github.com/hyperledger/besu/commit/2782623c5c6204904e889fb586373719846c4bfd", "message": "remove unnecessary test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T17:28:04Z", "type": "commit"}, {"oid": "8b4cbae079b3d48c4275dae3e3661fa82b5afd20", "url": "https://github.com/hyperledger/besu/commit/8b4cbae079b3d48c4275dae3e3661fa82b5afd20", "message": "private\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2020-12-17T17:28:51Z", "type": "commit"}, {"oid": "00f7c7bbdae4f265e01ae158f90873ca1fbc2b6e", "url": "https://github.com/hyperledger/besu/commit/00f7c7bbdae4f265e01ae158f90873ca1fbc2b6e", "message": "fix limited message test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-04T18:56:12Z", "type": "commit"}, {"oid": "75a8056a7624f1760a98297fa7c536dbd5a98409", "url": "https://github.com/hyperledger/besu/commit/75a8056a7624f1760a98297fa7c536dbd5a98409", "message": "transactions generator change\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-04T18:56:33Z", "type": "commit"}, {"oid": "248cfe44d6bdf2ea2576b4f34a2ed6dc083f9bb6", "url": "https://github.com/hyperledger/besu/commit/248cfe44d6bdf2ea2576b4f34a2ed6dc083f9bb6", "message": "Merge branch 'master' of github.com:hyperledger/besu into transaction-type-test-support", "committedDate": "2021-01-04T18:56:51Z", "type": "commit"}, {"oid": "2c6ea0960c4a84946321a832917ee042317230dc", "url": "https://github.com/hyperledger/besu/commit/2c6ea0960c4a84946321a832917ee042317230dc", "message": "simplify condition\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-04T19:04:24Z", "type": "commit"}, {"oid": "74467f4eecb06846016989e9dc41c807bc1de40b", "url": "https://github.com/hyperledger/besu/commit/74467f4eecb06846016989e9dc41c807bc1de40b", "message": "unhardcode limits\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-04T19:33:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUzODU0Nw==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r551538547", "bodyText": "@lucassaldanha this test broke because I changed the BlockDataGenerator. I think it's safe to change the state roots here but I don't think the test should rely on hardcoded state roots anyways. Is there a way to determine at test time what the correct state roots should be?", "author": "RatanRSur", "createdAt": "2021-01-04T20:03:55Z", "path": "besu/src/test/java/org/hyperledger/besu/PrivacyReorgTest.java", "diffHunk": "@@ -92,9 +93,9 @@\n       Bytes.fromBase64String(\"A1aVtMxLCUHmBVHXoZzzBgPbW/wj5axDpW9X8l91SGo=\");\n \n   private static final String FIRST_BLOCK_WITH_NO_TRANSACTIONS_STATE_ROOT =\n-      \"0x1bdf13f6d14c7322d6e695498aab258949e55574bef7eac366eb777f43d7dd2b\";\n+      \"0xc9dcaffbebc7edc20839c80e706430a8fa885e8f703bb89f6e95633cc2b05d4d\";\n   private static final String FIRST_BLOCK_WITH_SINGLE_TRANSACTION_STATE_ROOT =\n-      \"0x16979b290f429e06d86a43584c7d8689d4292ade9a602e5c78e2867c6ebd904e\";\n+      \"0x66fbc6ad12ef1da78740093ea2b3362e773e510e27d8f88b68c27bfc1f4d58c8\";", "originalCommit": "74467f4eecb06846016989e9dc41c807bc1de40b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQxOTAxOA==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557419018", "bodyText": "I think actually this is not a bad thing to rely on hardcoded state roots on tests. Because when you change something it breaks, and this is good. If you use your code to generate the assertion there is a risk of working only in close loop.", "author": "abdelhamidbakhta", "createdAt": "2021-01-14T14:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUzODU0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "6a146290174354466232c0823bd738b6393f7630", "chunk": "diff --git a/besu/src/test/java/org/hyperledger/besu/PrivacyReorgTest.java b/besu/src/test/java/org/hyperledger/besu/PrivacyReorgTest.java\nindex 18d309bd1..59f4110a0 100644\n--- a/besu/src/test/java/org/hyperledger/besu/PrivacyReorgTest.java\n+++ b/besu/src/test/java/org/hyperledger/besu/PrivacyReorgTest.java\n\n@@ -98,7 +98,7 @@ public class PrivacyReorgTest {\n       \"0x66fbc6ad12ef1da78740093ea2b3362e773e510e27d8f88b68c27bfc1f4d58c8\";\n   private static final String BLOCK_WITH_SINGLE_TRANSACTION_RECEIPTS_ROOT =\n       \"0xc8267b3f9ed36df3ff8adb51a6d030716f23eeb50270e7fce8d9822ffa7f0461\";\n-  private static final String STATE_ROOT_AFTER_TRANSACTION_APPENDED_TO_EMTPY_STATE =\n+  private static final String STATE_ROOT_AFTER_TRANSACTION_APPENDED_TO_EMPTY_STATE =\n       \"0x2121b68f1333e93bae8cd717a3ca68c9d7e7003f6b288c36dfc59b0f87be9590\";\n   private static final Bytes32 PRIVACY_GROUP_BYTES32 =\n       Bytes32.fromHexString(\"0xf250d523ae9164722b06ca25cfa2a7f3c45df96b09e215236f886c876f715bfa\");\n"}}, {"oid": "b279692c9a0247b1300124c7f62b8be10696c555", "url": "https://github.com/hyperledger/besu/commit/b279692c9a0247b1300124c7f62b8be10696c555", "message": "Merge branch 'master' of github.com:hyperledger/besu into transaction-type-test-support", "committedDate": "2021-01-05T15:23:24Z", "type": "commit"}, {"oid": "1b88d32d461b1367aa21a4e025aed33d7445302b", "url": "https://github.com/hyperledger/besu/commit/1b88d32d461b1367aa21a4e025aed33d7445302b", "message": "transaction receipt generation with types\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-05T18:54:02Z", "type": "commit"}, {"oid": "aaf0d87fd222db9eb52b3b88159ce41c74d27cee", "url": "https://github.com/hyperledger/besu/commit/aaf0d87fd222db9eb52b3b88159ce41c74d27cee", "message": "fix receipt en/decoding\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-05T19:06:54Z", "type": "commit"}, {"oid": "a1ceab797209398c34c184c0633dba7b4bb93531", "url": "https://github.com/hyperledger/besu/commit/a1ceab797209398c34c184c0633dba7b4bb93531", "message": "Objects.equals\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>", "committedDate": "2021-01-05T19:16:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0NDI3Mw==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r552144273", "bodyText": "We previously tested only FRONTIER receipts so roundtripping issues that were exposed are fixed here.", "author": "RatanRSur", "createdAt": "2021-01-05T19:25:39Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/TransactionReceipt.java", "diffHunk": "@@ -171,26 +173,37 @@ public void writeToWithRevertReason(final RLPOutput out) {\n     writeTo(out, true);\n   }\n ", "originalCommit": "a1ceab797209398c34c184c0633dba7b4bb93531", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "6a146290174354466232c0823bd738b6393f7630", "url": "https://github.com/hyperledger/besu/commit/6a146290174354466232c0823bd738b6393f7630", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into transaction-type-test-support", "committedDate": "2021-01-13T16:26:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQxNjExMQ==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557416111", "bodyText": "We don't fail at deseriailization anymore. We always deserialize and reject in transaction validation based on what fork we're on", "author": "RatanRSur", "createdAt": "2021-01-14T14:02:45Z", "path": "ethereum/core/src/test/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPEncoderTest.java", "diffHunk": "@@ -66,17 +65,4 @@ public void encodeEIP1559TxNominalCase() {\n         .isEqualTo(output.encoded().toHexString());\n     ExperimentalEIPs.eip1559Enabled = ExperimentalEIPs.EIP1559_ENABLED_DEFAULT_VALUE;\n   }\n-\n-  @Test\n-  public void encodeEIP1559TxFailureNotEnabled() {\n-    ExperimentalEIPs.eip1559Enabled = false;\n-    assertThatThrownBy(\n-            () ->\n-                TransactionRLPEncoder.encode(\n-                    TransactionRLPDecoder.decode(RLP.input(Bytes.fromHexString(EIP1559_TX_RLP))),\n-                    new BytesValueRLPOutput()))\n-        .isInstanceOf(RuntimeException.class)\n-        .hasMessageContaining(\"EIP-1559 feature flag\");\n-    ExperimentalEIPs.eip1559Enabled = ExperimentalEIPs.EIP1559_ENABLED_DEFAULT_VALUE;\n-  }", "originalCommit": "6a146290174354466232c0823bd738b6393f7630", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQxOTY4Mg==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557419682", "bodyText": "Why this change is necessary ?", "author": "abdelhamidbakhta", "createdAt": "2021-01-14T14:08:06Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Wei.java", "diffHunk": "@@ -18,7 +18,7 @@\n \n import java.math.BigInteger;\n \n-import org.apache.tuweni.bytes.Bytes32;\n+import org.apache.tuweni.bytes.Bytes;", "originalCommit": "6a146290174354466232c0823bd738b6393f7630", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyMzQ3OA==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557423478", "bodyText": "In TransactionRLPDecoder, we previously had Wei.of of a BigInteger, sometimes that BigInteger was negative so the Wei was negative. When I changed it to Wei.wrap I needed to allow Bytes instead of just Bytes32 since it could be shorter.", "author": "RatanRSur", "createdAt": "2021-01-14T14:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQxOTY4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyNDQxNg==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557424416", "bodyText": "That makes sense", "author": "abdelhamidbakhta", "createdAt": "2021-01-14T14:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQxOTY4Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyMDAwMw==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557420003", "bodyText": "Why do you remove that ?", "author": "abdelhamidbakhta", "createdAt": "2021-01-14T14:08:31Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPEncoder.java", "diffHunk": "@@ -77,8 +76,6 @@ static void encodeFrontier(final Transaction transaction, final RLPOutput out) {\n   }\n \n   static void encodeEIP1559(final Transaction transaction, final RLPOutput out) {\n-    ExperimentalEIPs.eip1559MustBeEnabled();", "originalCommit": "6a146290174354466232c0823bd738b6393f7630", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyNDMxMA==", "url": "https://github.com/hyperledger/besu/pull/1726#discussion_r557424310", "bodyText": "In general we're moving the transactions to not be validated at serialization time. All the checks to make sure we're not creating/deserializing transactions for a different fork are done elsewhere.", "author": "RatanRSur", "createdAt": "2021-01-14T14:15:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyMDAwMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "73522c31c477573229ef0d25fe929478a43dbd34", "url": "https://github.com/hyperledger/besu/commit/73522c31c477573229ef0d25fe929478a43dbd34", "message": "Merge branch 'master' into transaction-type-test-support", "committedDate": "2021-01-14T19:27:02Z", "type": "commit"}]}