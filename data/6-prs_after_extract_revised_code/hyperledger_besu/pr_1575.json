{"pr_number": 1575, "pr_title": "IBFT2 roundchange not sent if timeout after import", "pr_createdAt": "2020-11-17T06:54:47Z", "pr_url": "https://github.com/hyperledger/besu/pull/1575", "timeline": [{"oid": "3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "url": "https://github.com/hyperledger/besu/commit/3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-17T06:55:18Z", "type": "forcePushed"}, {"oid": "8ec5c0a9866037b1591e5367626972e65100eae7", "url": "https://github.com/hyperledger/besu/commit/8ec5c0a9866037b1591e5367626972e65100eae7", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-17T06:56:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTc5OA==", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r525635798", "bodyText": "are these comments meant to be removed?", "author": "usmansaleem", "createdAt": "2020-11-18T01:29:48Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java", "diffHunk": "@@ -140,7 +140,9 @@ public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n             id, privateTransaction, privateTransactionLookupId, Address.DEFAULT_PRIVACY);\n       }\n     } catch (final IllegalArgumentException | RLPException e) {\n+      /// RIGHT HERE <----", "originalCommit": "606e704936422dd691138b6200f0cba36f10243a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0MzA5Nw==", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r525643097", "bodyText": "oops", "author": "rain-on", "createdAt": "2020-11-18T01:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTc5OA=="}], "type": "inlineReview", "revised_code": {"commit": "3fe882dc8c48d328e904baea35aae6685f5a299a", "chunk": "diff --git a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java\nindex 44d67c08c0..8d247c1786 100644\n--- a/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java\n+++ b/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java\n\n@@ -140,9 +140,7 @@ public class EeaSendRawTransaction implements JsonRpcMethod {\n             id, privateTransaction, privateTransactionLookupId, Address.DEFAULT_PRIVACY);\n       }\n     } catch (final IllegalArgumentException | RLPException e) {\n-      /// RIGHT HERE <----\n       return new JsonRpcErrorResponse(id, DECODE_ERROR);\n-      /// RIGHT HERE <----\n     } catch (final Exception e) {\n       final String message = e.getMessage();\n       return new JsonRpcErrorResponse(id, convertEnclaveInvalidReason(message));\n"}}, {"oid": "3fe882dc8c48d328e904baea35aae6685f5a299a", "url": "https://github.com/hyperledger/besu/commit/3fe882dc8c48d328e904baea35aae6685f5a299a", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T01:56:20Z", "type": "forcePushed"}, {"oid": "7a1306d22aa4876d615803318e1ecce8ac8758c8", "url": "https://github.com/hyperledger/besu/commit/7a1306d22aa4876d615803318e1ecce8ac8758c8", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T04:23:46Z", "type": "commit"}, {"oid": "7a1306d22aa4876d615803318e1ecce8ac8758c8", "url": "https://github.com/hyperledger/besu/commit/7a1306d22aa4876d615803318e1ecce8ac8758c8", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T04:23:46Z", "type": "forcePushed"}, {"oid": "0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "url": "https://github.com/hyperledger/besu/commit/0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "message": "fix tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T04:43:54Z", "type": "commit"}, {"oid": "0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "url": "https://github.com/hyperledger/besu/commit/0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "message": "fix tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T04:43:54Z", "type": "forcePushed"}, {"oid": "056efa929d1fc2c5773d9512f9e7cf2213bfe49b", "url": "https://github.com/hyperledger/besu/commit/056efa929d1fc2c5773d9512f9e7cf2213bfe49b", "message": "Change to <=\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T04:52:21Z", "type": "commit"}, {"oid": "5c6e90fbe116cc7f6479ed86855dbd3d83dc4fd9", "url": "https://github.com/hyperledger/besu/commit/5c6e90fbe116cc7f6479ed86855dbd3d83dc4fd9", "message": "added new tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T06:13:39Z", "type": "commit"}, {"oid": "b35bdcaabe90a5d4aa612f286639760b17803eb6", "url": "https://github.com/hyperledger/besu/commit/b35bdcaabe90a5d4aa612f286639760b17803eb6", "message": "Merge remote-tracking branch 'upstream/master' into ibft_rc_post_import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T21:37:26Z", "type": "commit"}, {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "url": "https://github.com/hyperledger/besu/commit/25277ce5b1f82d28a72bbb20958cde2f81d59835", "message": "remove unneeded mocks\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T21:59:16Z", "type": "commit"}, {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "url": "https://github.com/hyperledger/besu/commit/25277ce5b1f82d28a72bbb20958cde2f81d59835", "message": "remove unneeded mocks\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-18T21:59:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjE3Nw==", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r526502177", "bodyText": "This comment seems like a nice check to add", "author": "jframe", "createdAt": "2020-11-18T23:58:50Z", "path": "consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java", "diffHunk": "@@ -110,4 +112,47 @@ public void importsToChainWithoutReceivingPrepareMessages() {\n     assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n     peers.verifyNoMessagesReceived();\n   }\n+\n+  @Test\n+  public void nodeDoesNotSendRoundChangeIfRoundTimesOutAfterBlockImportButBeforeNewBlock() {\n+    peers.verifyMessagesReceived(expectedTxProposal);\n+    peers.getNonProposing(0).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(0);\n+    peers.verifyNoMessagesReceived();\n+\n+    peers.getNonProposing(1).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n+    peers.verifyNoMessagesReceived();\n+\n+    context.getController().handleRoundExpiry(new RoundExpiry(roundId));\n+    peers.verifyNoMessagesReceived();\n+\n+    context\n+        .getController()\n+        .handleNewBlockEvent(new NewChainHead(expectedProposedBlock.getHeader()));\n+    peers.verifyNoMessagesReceived();\n+  }\n+\n+  @Test\n+  public void nodeDoesNotGoIntoRoundChangeAfterImport() {\n+    peers.verifyMessagesReceived(expectedTxProposal);\n+    peers.getNonProposing(0).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(0);\n+    peers.verifyNoMessagesReceived();\n+\n+    peers.getNonProposing(1).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n+    peers.verifyNoMessagesReceived();\n+\n+    final ConsensusRoundIdentifier nextRound = new ConsensusRoundIdentifier(1, 1);\n+\n+    peers.getNonProposing(0).injectRoundChange(nextRound, Optional.empty());\n+    peers.verifyNoMessagesReceived();\n+    peers.getNonProposing(1).injectRoundChange(nextRound, Optional.empty());\n+    peers.verifyNoMessagesReceived();\n+    peers.getNonProposing(2).injectRoundChange(nextRound, Optional.empty());\n+\n+    // Prove local node is NOT in Round(1,1)", "originalCommit": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "chunk": "diff --git a/consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java b/consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java\nindex 35813d789a..134e350297 100644\n--- a/consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java\n+++ b/consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java\n\n@@ -134,7 +134,7 @@ public class LocalNodeIsProposerTest {\n   }\n \n   @Test\n-  public void nodeDoesNotGoIntoRoundChangeAfterImport() {\n+  public void nodeDoesNotSendCommitMessageAfterBlockIsImportedAndBeforeNewBlockEvent() {\n     peers.verifyMessagesReceived(expectedTxProposal);\n     peers.getNonProposing(0).injectCommit(roundId, expectedProposedBlock.getHash());\n     assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(0);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjg0NQ==", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r526502845", "bodyText": "Think we should log if this happens", "author": "jframe", "createdAt": "2020-11-19T00:00:35Z", "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java", "diffHunk": "@@ -129,6 +130,14 @@ private void handleMessage(final Message message) {\n   private <P extends IbftMessage<?>> void consumeMessage(\n       final Message message, final P ibftMessage, final Consumer<P> handleMessage) {\n     LOG.trace(\"Received IBFT {} message\", ibftMessage.getClass().getSimpleName());\n+\n+    // Discard all messages which target the BLOCKCHAIN height (which SHOULD be 1 less than\n+    // the currentHeightManager, but CAN be the same directly following import).\n+    if (ibftMessage.getRoundIdentifier().getSequenceNumber()\n+        <= blockchain.getChainHeadBlockNumber()) {\n+      return;", "originalCommit": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUxMjY4NA==", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r526512684", "bodyText": "done", "author": "rain-on", "createdAt": "2020-11-19T00:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjg0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "chunk": "diff --git a/consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java b/consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java\nindex 254b0356b2..cb9e7c4226 100644\n--- a/consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java\n+++ b/consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java\n\n@@ -135,6 +135,7 @@ public class IbftController {\n     // the currentHeightManager, but CAN be the same directly following import).\n     if (ibftMessage.getRoundIdentifier().getSequenceNumber()\n         <= blockchain.getChainHeadBlockNumber()) {\n+      LOG.debug(\"Discarding a message which targets a height not above current chain height.\");\n       return;\n     }\n \n"}}, {"oid": "a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "url": "https://github.com/hyperledger/besu/commit/a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "message": "post review\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-19T00:45:04Z", "type": "commit"}, {"oid": "f293ab7a834eba9d9c1fc5885afe9fab17fe8fc3", "url": "https://github.com/hyperledger/besu/commit/f293ab7a834eba9d9c1fc5885afe9fab17fe8fc3", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-19T00:53:46Z", "type": "commit"}, {"oid": "6155dab7daebbc2e25d76f5db710f1ff83ef64ae", "url": "https://github.com/hyperledger/besu/commit/6155dab7daebbc2e25d76f5db710f1ff83ef64ae", "message": "Merge remote-tracking branch 'upstream/master' into ibft_rc_post_import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-19T01:50:46Z", "type": "commit"}, {"oid": "6072de2ecd19ec707cd22457972cacee9c88fe2d", "url": "https://github.com/hyperledger/besu/commit/6072de2ecd19ec707cd22457972cacee9c88fe2d", "message": "updated changelog\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>", "committedDate": "2020-11-19T01:54:05Z", "type": "commit"}]}