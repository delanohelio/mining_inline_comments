{"pr_number": 1387, "pr_title": "Implementation of EIP-2929 ", "pr_createdAt": "2020-09-21T20:25:44Z", "pr_url": "https://github.com/hyperledger/besu/pull/1387", "timeline": [{"oid": "35c1eb9673da865c5418c5759b2b598dba0e474f", "url": "https://github.com/hyperledger/besu/commit/35c1eb9673da865c5418c5759b2b598dba0e474f", "message": "Add Legacy State Tests\n\nLegacy State tests before constantinople were moved to a child\ndirectory.  We still need to validate against those.  Generate and\nexecute those tests under a \"LegacyX\" class series.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:19:27Z", "type": "commit"}, {"oid": "0d63e7638de15cd6621fbe040b105f7640e8f613", "url": "https://github.com/hyperledger/besu/commit/0d63e7638de15cd6621fbe040b105f7640e8f613", "message": "YOLOv2 configuration\n\n* deprecate old yoloV1 options\n* replace with  yoloV2 options\n* clear the yolo bootnode\n* expose experimental EIPs flag to EVM Tool\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "026aa1756ab1007eab9171791726412880714788", "url": "https://github.com/hyperledger/besu/commit/026aa1756ab1007eab9171791726412880714788", "message": "Implementation of EIP-2929\n\n* store warmed addresses and slots in the MessageFrame\n* probably need to do a gas calculator refactor at some point\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "1838e6ce10ac01daa3a33a47a9f8d1af99009142", "url": "https://github.com/hyperledger/besu/commit/1838e6ce10ac01daa3a33a47a9f8d1af99009142", "message": "Add sender, drop recipient.\n\nRecipient and sender are (almost) always the same.  We want sender and\ncontract (which should be recipient, unless it's a create, when we\ndo want the contract)\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "95bc20c835c70061f4c908866cb734aca8579fcc", "url": "https://github.com/hyperledger/besu/commit/95bc20c835c70061f4c908866cb734aca8579fcc", "message": "allow state tests in EVMTool to override the forks.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "365d344e1cfa4e5d642c5bad08d06371cf8c9b0e", "url": "https://github.com/hyperledger/besu/commit/365d344e1cfa4e5d642c5bad08d06371cf8c9b0e", "message": "javadoc\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "98f9ebad987cb581b49bcf5354badb455d5863c4", "url": "https://github.com/hyperledger/besu/commit/98f9ebad987cb581b49bcf5354badb455d5863c4", "message": "pass down access list to children.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:37Z", "type": "commit"}, {"oid": "e050b68e3b13b5544a7831bb6048db8c75060ba7", "url": "https://github.com/hyperledger/besu/commit/e050b68e3b13b5544a7831bb6048db8c75060ba7", "message": "Minor Fixes\n\n* 0x0 is not a precompile.\n* Call operations need to check against to, not value recipient (which\n  can be null)\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:38Z", "type": "commit"}, {"oid": "f8067a7197761d206fab6e31a134509c7f871e44", "url": "https://github.com/hyperledger/besu/commit/f8067a7197761d206fab6e31a134509c7f871e44", "message": "fix self-destruct warm account detection\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:38Z", "type": "commit"}, {"oid": "a438c35fe4218a4f2eb531e700e594c339ffb997", "url": "https://github.com/hyperledger/besu/commit/a438c35fe4218a4f2eb531e700e594c339ffb997", "message": "javadoc\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:38Z", "type": "commit"}, {"oid": "b0384a0e9b62cfd3e8c8e8fe60b801cc36daca78", "url": "https://github.com/hyperledger/besu/commit/b0384a0e9b62cfd3e8c8e8fe60b801cc36daca78", "message": "retesteth doesn't care about re-orgs.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:38Z", "type": "commit"}, {"oid": "331744ef28cb28976bbd826e31b022711322a4a2", "url": "https://github.com/hyperledger/besu/commit/331744ef28cb28976bbd826e31b022711322a4a2", "message": "Tracer fixes\n\n* keep order of test cases\n* show all memory\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-23T20:22:38Z", "type": "commit"}, {"oid": "c75d1657ef93d913843bc725b32bf27a28425419", "url": "https://github.com/hyperledger/besu/commit/c75d1657ef93d913843bc725b32bf27a28425419", "message": "keep warmed up list across creates\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-24T19:23:01Z", "type": "commit"}, {"oid": "c75d1657ef93d913843bc725b32bf27a28425419", "url": "https://github.com/hyperledger/besu/commit/c75d1657ef93d913843bc725b32bf27a28425419", "message": "keep warmed up list across creates\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-24T19:23:01Z", "type": "forcePushed"}, {"oid": "e332adeb79ce0a18951d80717dc28ce62322a5b4", "url": "https://github.com/hyperledger/besu/commit/e332adeb79ce0a18951d80717dc28ce62322a5b4", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-24T19:34:43Z", "type": "commit"}, {"oid": "149830e69cba821a27d7a65619435c56ae0ea72c", "url": "https://github.com/hyperledger/besu/commit/149830e69cba821a27d7a65619435c56ae0ea72c", "message": "test fixes\n\nDear mocking frameworks, I hate you.\nAlso, reference tests: chillax on the memory load.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-24T21:40:35Z", "type": "commit"}, {"oid": "25c3f5b13e12f9dfbceaa32ad765cb4775e37605", "url": "https://github.com/hyperledger/besu/commit/25c3f5b13e12f9dfbceaa32ad765cb4775e37605", "message": "errorprone\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-24T23:58:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMzEyNQ==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496033125", "bodyText": "Why are we redefining these?", "author": "RatanRSur", "createdAt": "2020-09-28T15:20:23Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/BerlinGasCalculator.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.mainnet;\n+\n+import static org.hyperledger.besu.ethereum.core.Address.BLS12_MAP_FP2_TO_G2;\n+\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.vm.MessageFrame;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class BerlinGasCalculator extends IstanbulGasCalculator {\n+\n+  // new constants for EIP-2929\n+  private static final Gas COLD_SLOAD_COST = Gas.of(2100);\n+  private static final Gas COLD_ACCOUNT_ACCESS_COST = Gas.of(2600);\n+  private static final Gas WARM_STORAGE_READ_COST = Gas.of(100);\n+\n+  // redefinitions for EIP-2929\n+  private static final Gas SLOAD_GAS = WARM_STORAGE_READ_COST;\n+  private static final Gas SSTORE_RESET_GAS = Gas.of(5000L).minus(COLD_SLOAD_COST);\n+\n+  // unchanged from Istanbul", "originalCommit": "25c3f5b13e12f9dfbceaa32ad765cb4775e37605", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTQ2MQ==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496041461", "bodyText": "We are copying in some formulas that require them.  The formulas we are bringing in are a mix of new values and old values, and the old values are private static.  I'm copying instead of upping the visibility to make it explicit what we are using and also to prevent accidental shadowing in future forks.", "author": "shemnon", "createdAt": "2020-09-28T15:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMzEyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMzQ5NA==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496033494", "bodyText": "dittto from above", "author": "RatanRSur", "createdAt": "2020-09-28T15:20:42Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/BerlinGasCalculator.java", "diffHunk": "@@ -0,0 +1,206 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.mainnet;\n+\n+import static org.hyperledger.besu.ethereum.core.Address.BLS12_MAP_FP2_TO_G2;\n+\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.vm.MessageFrame;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class BerlinGasCalculator extends IstanbulGasCalculator {\n+\n+  // new constants for EIP-2929\n+  private static final Gas COLD_SLOAD_COST = Gas.of(2100);\n+  private static final Gas COLD_ACCOUNT_ACCESS_COST = Gas.of(2600);\n+  private static final Gas WARM_STORAGE_READ_COST = Gas.of(100);\n+\n+  // redefinitions for EIP-2929\n+  private static final Gas SLOAD_GAS = WARM_STORAGE_READ_COST;\n+  private static final Gas SSTORE_RESET_GAS = Gas.of(5000L).minus(COLD_SLOAD_COST);\n+\n+  // unchanged from Istanbul\n+  private static final Gas SSTORE_SET_GAS = Gas.of(20_000);\n+  private static final Gas SSTORE_CLEARS_SCHEDULE = Gas.of(15_000);\n+\n+  private static final Gas SSTORE_SET_GAS_LESS_SLOAD_GAS = SSTORE_SET_GAS.minus(SLOAD_GAS);\n+  private static final Gas SSTORE_RESET_GAS_LESS_SLOAD_GAS = SSTORE_RESET_GAS.minus(SLOAD_GAS);\n+  private static final Gas NEGATIVE_SSTORE_CLEARS_SCHEDULE = Gas.ZERO.minus(SSTORE_CLEARS_SCHEDULE);\n+\n+  // unchanged from Frontier", "originalCommit": "25c3f5b13e12f9dfbceaa32ad765cb4775e37605", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MjA5NQ==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496042095", "bodyText": "Again, I chose to redefine over escalating visibility to prevent future accidental shadowing. A form of this issue caused one of the Geth failures in early testing.", "author": "shemnon", "createdAt": "2020-09-28T15:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAzMzQ5NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c4b1dd305eeae250f466bbe0afe1df07a4032a12", "url": "https://github.com/hyperledger/besu/commit/c4b1dd305eeae250f466bbe0afe1df07a4032a12", "message": "Merge branch 'master' of github.com:hyperledger/besu into EIP2929\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-28T15:31:03Z", "type": "commit"}, {"oid": "5e56e826eec80444bbd84bf1577157b81e143a27", "url": "https://github.com/hyperledger/besu/commit/5e56e826eec80444bbd84bf1577157b81e143a27", "message": "changelog\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-28T15:32:39Z", "type": "commit"}, {"oid": "1d07795cc4e7593145bb0cee91012464f2785379", "url": "https://github.com/hyperledger/besu/commit/1d07795cc4e7593145bb0cee91012464f2785379", "message": "add yolov2 link\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-28T15:34:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MzQ2Mg==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496063462", "bodyText": "This might be related to a question I asked in a previous pr but I can't remember. Do these need to be optional everywhere? For example, isn't the warmCost and coldCost always present here?", "author": "RatanRSur", "createdAt": "2020-09-28T16:01:22Z", "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/operations/SLoadOperation.java", "diffHunk": "@@ -15,27 +15,60 @@\n package org.hyperledger.besu.ethereum.vm.operations;\n \n import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Gas;\n+import org.hyperledger.besu.ethereum.vm.AbstractOperation;\n import org.hyperledger.besu.ethereum.vm.EVM;\n+import org.hyperledger.besu.ethereum.vm.ExceptionalHaltReason;\n+import org.hyperledger.besu.ethereum.vm.FixedStack.OverflowException;\n+import org.hyperledger.besu.ethereum.vm.FixedStack.UnderflowException;\n import org.hyperledger.besu.ethereum.vm.GasCalculator;\n import org.hyperledger.besu.ethereum.vm.MessageFrame;\n \n+import java.util.Optional;\n+\n import org.apache.tuweni.bytes.Bytes32;\n import org.apache.tuweni.units.bigints.UInt256;\n \n-public class SLoadOperation extends AbstractFixedCostOperation {\n+public class SLoadOperation extends AbstractOperation {\n+\n+  private final Optional<Gas> warmCost;\n+  private final Optional<Gas> coldCost;\n+\n+  private final OperationResult warmSuccess;\n+  private final OperationResult coldSuccess;\n \n   public SLoadOperation(final GasCalculator gasCalculator) {\n-    super(0x54, \"SLOAD\", 1, 1, false, 1, gasCalculator, gasCalculator.getSloadOperationGasCost());\n+    super(0x54, \"SLOAD\", 1, 1, false, 1, gasCalculator);\n+    final Gas baseCost = gasCalculator.getSloadOperationGasCost();\n+    warmCost = Optional.of(baseCost.plus(gasCalculator.getWarmStorageReadCost()));\n+    coldCost = Optional.of(baseCost.plus(gasCalculator.getColdSloadCost()));\n+\n+    warmSuccess = new OperationResult(warmCost, Optional.empty());\n+    coldSuccess = new OperationResult(coldCost, Optional.empty());\n   }\n \n   @Override\n-  public OperationResult executeFixedCostOperation(final MessageFrame frame, final EVM evm) {\n-    final Bytes32 key = frame.popStackItem();\n-\n-    final Account account = frame.getWorldState().get(frame.getRecipientAddress());\n-\n-    frame.pushStackItem(account.getStorageValue(UInt256.fromBytes(key)).toBytes());\n+  public OperationResult execute(final MessageFrame frame, final EVM evm) {\n+    try {\n+      final Account account = frame.getWorldState().get(frame.getRecipientAddress());\n+      final Address address = account.getAddress();\n+      final Bytes32 key = frame.popStackItem();\n+      final boolean slotIsWarm = frame.warmUpStorage(address, key);\n+      final Optional<Gas> optionalCost = slotIsWarm ? warmCost : coldCost;", "originalCommit": "1d07795cc4e7593145bb0cee91012464f2785379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NTY3OA==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496075678", "bodyText": "It's a mix.  We need the optional for the return value but we need the value during gas calculations.  The gas cost is not optional within the method but on the return, for some errors we return an empty cost (such as when we can't know because of a stack underflow).", "author": "shemnon", "createdAt": "2020-09-28T16:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3ODM5OQ==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496078399", "bodyText": "Ah, I see, could we push the optional wrapping to as late as possible? I think it makes it clearer for which sections it is guaranteed to be defined. The intent is a bit unclear when the warmCost and coldCost fields are Optional.", "author": "RatanRSur", "createdAt": "2020-09-28T16:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MzQ2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3ODI2Mg==", "url": "https://github.com/hyperledger/besu/pull/1387#discussion_r496178262", "bodyText": "The optionals are re-used across requests.  If we wrapped in the execute method it would result in object churn.", "author": "shemnon", "createdAt": "2020-09-28T19:20:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2MzQ2Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "06d895d0b062b143aaa79522ff9377fa6b2376ce", "url": "https://github.com/hyperledger/besu/commit/06d895d0b062b143aaa79522ff9377fa6b2376ce", "message": "merge\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>", "committedDate": "2020-09-28T17:25:50Z", "type": "commit"}]}