{"pr_number": 2420, "pr_title": "Add Import from File / URL Dialogs", "pr_createdAt": "2020-06-01T21:09:22Z", "pr_url": "https://github.com/zaproxy/zap-extensions/pull/2420", "timeline": [{"oid": "0de33a1f7cc36b3475a9986d64d7d032e4884a6d", "url": "https://github.com/zaproxy/zap-extensions/commit/0de33a1f7cc36b3475a9986d64d7d032e4884a6d", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create classes GraphQlParser and Introspection\n- Ability to add endpoint url to the sites tree\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-01T21:13:07Z", "type": "forcePushed"}, {"oid": "454fcd82a3a7e85cb49d3c2d01625b5f21086250", "url": "https://github.com/zaproxy/zap-extensions/commit/454fcd82a3a7e85cb49d3c2d01625b5f21086250", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create classes GraphQlParser and Introspection\n- Ability to add endpoint url to the sites tree\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-02T09:42:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MjI2Nw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r434542267", "bodyText": "Is this still a TODO? If so some more details might help you remember whats TODO in the future ;)", "author": "psiinon", "createdAt": "2020-06-03T12:51:37Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import java.awt.GridBagConstraints;\n+import java.io.IOException;\n+import javax.swing.JButton;\n+import javax.swing.JFileChooser;\n+import javax.swing.JFrame;\n+import org.parosproxy.paros.Constant;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.view.View;\n+\n+public class ImportFromFileDialog extends ImportFromAbstractDialog {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final String MESSAGE_PREFIX = \"graphql.importfromfiledialog.\";\n+\n+    private JButton buttonChooseFile;\n+\n+    public ImportFromFileDialog(JFrame parent, ExtensionGraphQl caller) {\n+        super(\n+                parent,\n+                caller,\n+                Constant.messages.getString(MESSAGE_PREFIX + \"title\"),\n+                Constant.messages.getString(MESSAGE_PREFIX + \"labelfile\"));\n+    }\n+\n+    @Override\n+    protected void addFromFields(GridBagConstraints constraints) {\n+        constraints.gridwidth = 2;\n+        super.addFromFields(constraints);\n+\n+        constraints.gridx = 3;\n+        constraints.gridwidth = 1;\n+        add(getButtonChooseFile(), constraints);\n+    }\n+\n+    private JButton getButtonChooseFile() {\n+        if (buttonChooseFile == null) {\n+            buttonChooseFile =\n+                    new JButton(Constant.messages.getString(MESSAGE_PREFIX + \"choosefilebutton\"));\n+\n+            buttonChooseFile.addActionListener(\n+                    e -> {\n+                        JFileChooser filechooser =\n+                                new JFileChooser(\n+                                        Model.getSingleton().getOptionsParam().getUserDirectory());\n+                        int state = filechooser.showOpenDialog(View.getSingleton().getMainFrame());\n+                        if (state == JFileChooser.APPROVE_OPTION) {\n+                            try {\n+                                getFromField()\n+                                        .setText(filechooser.getSelectedFile().getCanonicalPath());\n+                                Model.getSingleton()\n+                                        .getOptionsParam()\n+                                        .setUserDirectory(filechooser.getCurrentDirectory());\n+                            } catch (IOException ex) {\n+                                showWarningDialog(\n+                                        Constant.messages.getString(MESSAGE_PREFIX + \"badfile\"));\n+                            }\n+                        }\n+                    });\n+        }\n+        return buttonChooseFile;\n+    }\n+\n+    @Override\n+    protected boolean importDefinition() {\n+        // Import and parse schema if file path is provided\n+        if (!getFromField().getText().isEmpty()) {\n+            // TO DO", "originalCommit": "454fcd82a3a7e85cb49d3c2d01625b5f21086250", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU2MDQyOQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r434560429", "bodyText": "Yes it is. Updated :).", "author": "ricekot", "createdAt": "2020-06-03T13:20:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MjI2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "2db8439e47f9c442bc25135327393524bd4d1839", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\nindex 4bfcb45bf..cc13d4226 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n\n@@ -85,7 +85,10 @@ public class ImportFromFileDialog extends ImportFromAbstractDialog {\n     protected boolean importDefinition() {\n         // Import and parse schema if file path is provided\n         if (!getFromField().getText().isEmpty()) {\n-            // TO DO\n+            /* TO DO:\n+             * Import schema definition from file path; and\n+             * Send it to the parser.\n+             */\n             showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n             return false;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0MjQ1MQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r434542451", "bodyText": "Ditto", "author": "psiinon", "createdAt": "2020-06-03T12:51:55Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromUrlDialog.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import javax.swing.JFrame;\n+import org.parosproxy.paros.Constant;\n+\n+public class ImportFromUrlDialog extends ImportFromAbstractDialog {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final String MESSAGE_PREFIX = \"graphql.importfromurldialog.\";\n+\n+    public ImportFromUrlDialog(JFrame parent, ExtensionGraphQl caller) {\n+        super(\n+                parent,\n+                caller,\n+                Constant.messages.getString(MESSAGE_PREFIX + \"title\"),\n+                Constant.messages.getString(MESSAGE_PREFIX + \"labelurl\"));\n+    }\n+\n+    @Override\n+    protected boolean importDefinition() {\n+        // Import and parse schema if schema URL is provided\n+        if (!getFromField().getText().isEmpty()) {\n+            if (validateUrl(getFromField())) {\n+                // TO DO", "originalCommit": "454fcd82a3a7e85cb49d3c2d01625b5f21086250", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2db8439e47f9c442bc25135327393524bd4d1839", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromUrlDialog.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromUrlDialog.java\nindex 7113036bd..67b3e11cc 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromUrlDialog.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromUrlDialog.java\n\n@@ -40,7 +40,10 @@ public class ImportFromUrlDialog extends ImportFromAbstractDialog {\n         // Import and parse schema if schema URL is provided\n         if (!getFromField().getText().isEmpty()) {\n             if (validateUrl(getFromField())) {\n-                // TO DO\n+                /* TO DO:\n+                 * - Import schema definition from provided url; and\n+                 * - Send it to the parser.\n+                 */\n                 showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n             } else return false;\n         }\n"}}, {"oid": "2db8439e47f9c442bc25135327393524bd4d1839", "url": "https://github.com/zaproxy/zap-extensions/commit/2db8439e47f9c442bc25135327393524bd4d1839", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create classes GraphQlParser and Introspection\n- Ability to add endpoint url to the sites tree\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-03T13:19:13Z", "type": "forcePushed"}, {"oid": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "url": "https://github.com/zaproxy/zap-extensions/commit/29f5dc0b87d53879d3765c0990db40ff73ff9c40", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create classes GraphQlParser and Introspection\n- Ability to add endpoint url to the sites tree\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-03T13:23:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxMTg2MA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435911860", "bodyText": "I believe this can simply be this instead of Class.this? (Same below)", "author": "kingthorin", "createdAt": "2020-06-05T13:13:41Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ExtensionGraphQl.java", "diffHunk": "@@ -66,11 +66,8 @@ private ZapMenuItem getMenuImportLocalGraphQl() {\n                     Constant.messages.getString(\"graphql.topmenu.import.importgraphql.tooltip\"));\n             menuImportLocalGraphQl.addActionListener(\n                     e ->\n-                            View.getSingleton()\n-                                    .showMessageDialog(\n-                                            Constant.messages.getString(\n-                                                    \"graphql.importfromdialog.message\")));\n-            ;\n+                            new ImportFromFileDialog(\n+                                    View.getSingleton().getMainFrame(), ExtensionGraphQl.this));", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ExtensionGraphQl.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ExtensionGraphQl.java\nindex 85492c329..4e5f5b7ab 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ExtensionGraphQl.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ExtensionGraphQl.java\n\n@@ -65,9 +65,7 @@ public class ExtensionGraphQl extends ExtensionAdaptor implements CommandLineLis\n             menuImportLocalGraphQl.setToolTipText(\n                     Constant.messages.getString(\"graphql.topmenu.import.importgraphql.tooltip\"));\n             menuImportLocalGraphQl.addActionListener(\n-                    e ->\n-                            new ImportFromFileDialog(\n-                                    View.getSingleton().getMainFrame(), ExtensionGraphQl.this));\n+                    e -> new ImportFromFileDialog(View.getSingleton().getMainFrame(), this));\n         }\n         return menuImportLocalGraphQl;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNTUxMA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435915510", "bodyText": "addPath needs to be done in the Event Dispatch Thread (this PR might help secdec/attack-surface-detector-zap#14). addHistory doesn't need to be done in EDT but can't hurt.\nThis class will probably be used by the API so it might be worth wrapping the site tree addition in a view check.", "author": "kingthorin", "createdAt": "2020-06-05T13:20:22Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import java.awt.EventQueue;\n+import org.apache.log4j.Logger;\n+import org.parosproxy.paros.control.Control;\n+import org.parosproxy.paros.extension.history.ExtensionHistory;\n+import org.parosproxy.paros.model.HistoryReference;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.network.HttpMessage;\n+\n+public class GraphQlParser {\n+\n+    private static final Logger LOG = Logger.getLogger(GraphQlParser.class);\n+\n+    public static void persistMessage(final HttpMessage message) {\n+        // Add the message to the history panel and sites tree\n+        final HistoryReference historyRef;\n+\n+        try {\n+            historyRef =\n+                    new HistoryReference(\n+                            Model.getSingleton().getSession(),\n+                            HistoryReference.TYPE_ZAP_USER,\n+                            message);\n+        } catch (Exception e) {\n+            LOG.error(e.getMessage(), e);\n+            return;\n+        }\n+\n+        final ExtensionHistory extHistory =\n+                Control.getSingleton().getExtensionLoader().getExtension(ExtensionHistory.class);\n+        if (extHistory != null) {\n+            EventQueue.invokeLater(\n+                    new Runnable() {\n+\n+                        @Override\n+                        public void run() {\n+                            extHistory.addHistory(historyRef);\n+                            Model.getSingleton()\n+                                    .getSession()\n+                                    .getSiteTree()\n+                                    .addPath(historyRef, message);", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0MzY0Nw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435943647", "bodyText": "There's a core method ThreadUtils#invokeAndWait that handles that (it's synchronous but this methods should be as well?).", "author": "thc202", "createdAt": "2020-06-05T14:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNTUxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyMTQ4OQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r436121489", "bodyText": "I used invokeAndWait to do addPath in the EDT, but getting this error: Exception in thread \"AWT-EventQueue-0\"java.lang.Error: Cannot call invokeAndWait from the event dispatcher thread. It seems that it is already in the EDT, so there is no need to use invokeAndWait... What should be done instead?", "author": "ricekot", "createdAt": "2020-06-05T19:28:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxNTUxMA=="}], "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\nindex 20edc8f2e..3d22342d2 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\n\n@@ -19,48 +19,49 @@\n  */\n package org.zaproxy.addon.graphql;\n \n-import java.awt.EventQueue;\n+import org.apache.commons.httpclient.URI;\n import org.apache.log4j.Logger;\n import org.parosproxy.paros.control.Control;\n import org.parosproxy.paros.extension.history.ExtensionHistory;\n import org.parosproxy.paros.model.HistoryReference;\n import org.parosproxy.paros.model.Model;\n import org.parosproxy.paros.network.HttpMessage;\n+import org.parosproxy.paros.network.HttpSender;\n+import org.zaproxy.zap.utils.ThreadUtils;\n \n public class GraphQlParser {\n \n     private static final Logger LOG = Logger.getLogger(GraphQlParser.class);\n \n-    public static void persistMessage(final HttpMessage message) {\n-        // Add the message to the history panel and sites tree\n-        final HistoryReference historyRef;\n-\n+    public static void parse(URI uri) {\n+        HttpMessage msg;\n         try {\n-            historyRef =\n-                    new HistoryReference(\n-                            Model.getSingleton().getSession(),\n-                            HistoryReference.TYPE_ZAP_USER,\n-                            message);\n+            msg = new HttpMessage(uri);\n+            HttpSender sender =\n+                    new HttpSender(\n+                            Model.getSingleton().getOptionsParam().getConnectionParam(),\n+                            true,\n+                            HttpSender.MANUAL_REQUEST_INITIATOR);\n+            sender.sendAndReceive(msg, true);\n         } catch (Exception e) {\n-            LOG.error(e.getMessage(), e);\n+            LOG.error(\"Unable to send request.\", e);\n             return;\n         }\n \n-        final ExtensionHistory extHistory =\n+        // Add the message to the history panel and sites tree\n+        ExtensionHistory extHistory =\n                 Control.getSingleton().getExtensionLoader().getExtension(ExtensionHistory.class);\n-        if (extHistory != null) {\n-            EventQueue.invokeLater(\n-                    new Runnable() {\n-\n-                        @Override\n-                        public void run() {\n-                            extHistory.addHistory(historyRef);\n-                            Model.getSingleton()\n-                                    .getSession()\n-                                    .getSiteTree()\n-                                    .addPath(historyRef, message);\n-                        }\n+        try {\n+            ThreadUtils.invokeAndWait(\n+                    () -> {\n+                        extHistory.addHistory(msg, HistoryReference.TYPE_ZAP_USER);\n+                        Model.getSingleton()\n+                                .getSession()\n+                                .getSiteTree()\n+                                .addPath(msg.getHistoryRef(), msg);\n                     });\n+        } catch (Exception e) {\n+            LOG.error(\"Could not add message to sites tree.\", e);\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0MDQyMg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435940422", "bodyText": "parse?", "author": "thc202", "createdAt": "2020-06-05T13:59:02Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import java.awt.EventQueue;\n+import org.apache.log4j.Logger;\n+import org.parosproxy.paros.control.Control;\n+import org.parosproxy.paros.extension.history.ExtensionHistory;\n+import org.parosproxy.paros.model.HistoryReference;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.network.HttpMessage;\n+\n+public class GraphQlParser {\n+\n+    private static final Logger LOG = Logger.getLogger(GraphQlParser.class);\n+\n+    public static void persistMessage(final HttpMessage message) {", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\nindex 20edc8f2e..3d22342d2 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/GraphQlParser.java\n\n@@ -19,48 +19,49 @@\n  */\n package org.zaproxy.addon.graphql;\n \n-import java.awt.EventQueue;\n+import org.apache.commons.httpclient.URI;\n import org.apache.log4j.Logger;\n import org.parosproxy.paros.control.Control;\n import org.parosproxy.paros.extension.history.ExtensionHistory;\n import org.parosproxy.paros.model.HistoryReference;\n import org.parosproxy.paros.model.Model;\n import org.parosproxy.paros.network.HttpMessage;\n+import org.parosproxy.paros.network.HttpSender;\n+import org.zaproxy.zap.utils.ThreadUtils;\n \n public class GraphQlParser {\n \n     private static final Logger LOG = Logger.getLogger(GraphQlParser.class);\n \n-    public static void persistMessage(final HttpMessage message) {\n-        // Add the message to the history panel and sites tree\n-        final HistoryReference historyRef;\n-\n+    public static void parse(URI uri) {\n+        HttpMessage msg;\n         try {\n-            historyRef =\n-                    new HistoryReference(\n-                            Model.getSingleton().getSession(),\n-                            HistoryReference.TYPE_ZAP_USER,\n-                            message);\n+            msg = new HttpMessage(uri);\n+            HttpSender sender =\n+                    new HttpSender(\n+                            Model.getSingleton().getOptionsParam().getConnectionParam(),\n+                            true,\n+                            HttpSender.MANUAL_REQUEST_INITIATOR);\n+            sender.sendAndReceive(msg, true);\n         } catch (Exception e) {\n-            LOG.error(e.getMessage(), e);\n+            LOG.error(\"Unable to send request.\", e);\n             return;\n         }\n \n-        final ExtensionHistory extHistory =\n+        // Add the message to the history panel and sites tree\n+        ExtensionHistory extHistory =\n                 Control.getSingleton().getExtensionLoader().getExtension(ExtensionHistory.class);\n-        if (extHistory != null) {\n-            EventQueue.invokeLater(\n-                    new Runnable() {\n-\n-                        @Override\n-                        public void run() {\n-                            extHistory.addHistory(historyRef);\n-                            Model.getSingleton()\n-                                    .getSession()\n-                                    .getSiteTree()\n-                                    .addPath(historyRef, message);\n-                        }\n+        try {\n+            ThreadUtils.invokeAndWait(\n+                    () -> {\n+                        extHistory.addHistory(msg, HistoryReference.TYPE_ZAP_USER);\n+                        Model.getSingleton()\n+                                .getSession()\n+                                .getSiteTree()\n+                                .addPath(msg.getHistoryRef(), msg);\n                     });\n+        } catch (Exception e) {\n+            LOG.error(\"Could not add message to sites tree.\", e);\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0MDY1MQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435940651", "bodyText": "These comments should not be needed, code is clear.", "author": "thc202", "createdAt": "2020-06-05T13:59:18Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import java.awt.GridBagConstraints;\n+import java.io.IOException;\n+import javax.swing.JButton;\n+import javax.swing.JFileChooser;\n+import javax.swing.JFrame;\n+import org.parosproxy.paros.Constant;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.view.View;\n+\n+public class ImportFromFileDialog extends ImportFromAbstractDialog {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final String MESSAGE_PREFIX = \"graphql.importfromfiledialog.\";\n+\n+    private JButton buttonChooseFile;\n+\n+    public ImportFromFileDialog(JFrame parent, ExtensionGraphQl caller) {\n+        super(\n+                parent,\n+                caller,\n+                Constant.messages.getString(MESSAGE_PREFIX + \"title\"),\n+                Constant.messages.getString(MESSAGE_PREFIX + \"labelfile\"));\n+    }\n+\n+    @Override\n+    protected void addFromFields(GridBagConstraints constraints) {\n+        constraints.gridwidth = 2;\n+        super.addFromFields(constraints);\n+\n+        constraints.gridx = 3;\n+        constraints.gridwidth = 1;\n+        add(getButtonChooseFile(), constraints);\n+    }\n+\n+    private JButton getButtonChooseFile() {\n+        if (buttonChooseFile == null) {\n+            buttonChooseFile =\n+                    new JButton(Constant.messages.getString(MESSAGE_PREFIX + \"choosefilebutton\"));\n+\n+            buttonChooseFile.addActionListener(\n+                    e -> {\n+                        JFileChooser filechooser =\n+                                new JFileChooser(\n+                                        Model.getSingleton().getOptionsParam().getUserDirectory());\n+                        int state = filechooser.showOpenDialog(View.getSingleton().getMainFrame());\n+                        if (state == JFileChooser.APPROVE_OPTION) {\n+                            try {\n+                                getFromField()\n+                                        .setText(filechooser.getSelectedFile().getCanonicalPath());\n+                                Model.getSingleton()\n+                                        .getOptionsParam()\n+                                        .setUserDirectory(filechooser.getCurrentDirectory());\n+                            } catch (IOException ex) {\n+                                showWarningDialog(\n+                                        Constant.messages.getString(MESSAGE_PREFIX + \"badfile\"));\n+                            }\n+                        }\n+                    });\n+        }\n+        return buttonChooseFile;\n+    }\n+\n+    @Override\n+    protected boolean importDefinition() {\n+        // Import and parse schema if file path is provided", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\nindex cc13d4226..0c0e95881 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n\n@@ -83,18 +83,11 @@ public class ImportFromFileDialog extends ImportFromAbstractDialog {\n \n     @Override\n     protected boolean importDefinition() {\n-        // Import and parse schema if file path is provided\n-        if (!getFromField().getText().isEmpty()) {\n-            /* TO DO:\n-             * Import schema definition from file path; and\n-             * Send it to the parser.\n-             */\n-            showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n-            return false;\n-        }\n-        // else send introspection query to endpoint\n-        // For now, simply adding endpoint URL to sites tree\n-        else Introspection.sendIntrospectionQuery(getEndpointUri());\n-        return true;\n+        /* TO DO:\n+         * Import schema definition from file path; and\n+         * Send it to the parser.\n+         */\n+        showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n+        return false;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0MTAxNQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435941015", "bodyText": "We should require the file, if the user wants to import from URL it can use the other dialogue.", "author": "thc202", "createdAt": "2020-06-05T13:59:41Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import java.awt.GridBagConstraints;\n+import java.io.IOException;\n+import javax.swing.JButton;\n+import javax.swing.JFileChooser;\n+import javax.swing.JFrame;\n+import org.parosproxy.paros.Constant;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.view.View;\n+\n+public class ImportFromFileDialog extends ImportFromAbstractDialog {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final String MESSAGE_PREFIX = \"graphql.importfromfiledialog.\";\n+\n+    private JButton buttonChooseFile;\n+\n+    public ImportFromFileDialog(JFrame parent, ExtensionGraphQl caller) {\n+        super(\n+                parent,\n+                caller,\n+                Constant.messages.getString(MESSAGE_PREFIX + \"title\"),\n+                Constant.messages.getString(MESSAGE_PREFIX + \"labelfile\"));\n+    }\n+\n+    @Override\n+    protected void addFromFields(GridBagConstraints constraints) {\n+        constraints.gridwidth = 2;\n+        super.addFromFields(constraints);\n+\n+        constraints.gridx = 3;\n+        constraints.gridwidth = 1;\n+        add(getButtonChooseFile(), constraints);\n+    }\n+\n+    private JButton getButtonChooseFile() {\n+        if (buttonChooseFile == null) {\n+            buttonChooseFile =\n+                    new JButton(Constant.messages.getString(MESSAGE_PREFIX + \"choosefilebutton\"));\n+\n+            buttonChooseFile.addActionListener(\n+                    e -> {\n+                        JFileChooser filechooser =\n+                                new JFileChooser(\n+                                        Model.getSingleton().getOptionsParam().getUserDirectory());\n+                        int state = filechooser.showOpenDialog(View.getSingleton().getMainFrame());\n+                        if (state == JFileChooser.APPROVE_OPTION) {\n+                            try {\n+                                getFromField()\n+                                        .setText(filechooser.getSelectedFile().getCanonicalPath());\n+                                Model.getSingleton()\n+                                        .getOptionsParam()\n+                                        .setUserDirectory(filechooser.getCurrentDirectory());\n+                            } catch (IOException ex) {\n+                                showWarningDialog(\n+                                        Constant.messages.getString(MESSAGE_PREFIX + \"badfile\"));\n+                            }\n+                        }\n+                    });\n+        }\n+        return buttonChooseFile;\n+    }\n+\n+    @Override\n+    protected boolean importDefinition() {\n+        // Import and parse schema if file path is provided\n+        if (!getFromField().getText().isEmpty()) {", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\nindex cc13d4226..0c0e95881 100644\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n+++ b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/ImportFromFileDialog.java\n\n@@ -83,18 +83,11 @@ public class ImportFromFileDialog extends ImportFromAbstractDialog {\n \n     @Override\n     protected boolean importDefinition() {\n-        // Import and parse schema if file path is provided\n-        if (!getFromField().getText().isEmpty()) {\n-            /* TO DO:\n-             * Import schema definition from file path; and\n-             * Send it to the parser.\n-             */\n-            showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n-            return false;\n-        }\n-        // else send introspection query to endpoint\n-        // For now, simply adding endpoint URL to sites tree\n-        else Introspection.sendIntrospectionQuery(getEndpointUri());\n-        return true;\n+        /* TO DO:\n+         * Import schema definition from file path; and\n+         * Send it to the parser.\n+         */\n+        showWarningDialog(Constant.messages.getString(\"graphql.importfromdialog.message\"));\n+        return false;\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0MTY5NQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2420#discussion_r435941695", "bodyText": "Move to GraphQlParser? (e.g. GraphQlParser#parse(URI)`)", "author": "thc202", "createdAt": "2020-06-05T14:00:21Z", "path": "addOns/graphql/src/main/java/org/zaproxy/addon/graphql/Introspection.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Zed Attack Proxy (ZAP) and its related class files.\n+ *\n+ * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n+ *\n+ * Copyright 2020 The ZAP Development Team\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.zaproxy.addon.graphql;\n+\n+import org.apache.commons.httpclient.URI;\n+import org.apache.log4j.Logger;\n+import org.parosproxy.paros.model.Model;\n+import org.parosproxy.paros.network.HttpMessage;\n+import org.parosproxy.paros.network.HttpSender;\n+\n+public class Introspection {\n+    private static final Logger LOG = Logger.getLogger(Introspection.class);\n+\n+    public static void sendIntrospectionQuery(URI uri) {", "originalCommit": "29f5dc0b87d53879d3765c0990db40ff73ff9c40", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "chunk": "diff --git a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/Introspection.java b/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/Introspection.java\ndeleted file mode 100644\nindex 91460607b..000000000\n--- a/addOns/graphql/src/main/java/org/zaproxy/addon/graphql/Introspection.java\n+++ /dev/null\n\n@@ -1,48 +0,0 @@\n-/*\n- * Zed Attack Proxy (ZAP) and its related class files.\n- *\n- * ZAP is an HTTP/HTTPS proxy for assessing web application security.\n- *\n- * Copyright 2020 The ZAP Development Team\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.zaproxy.addon.graphql;\n-\n-import org.apache.commons.httpclient.URI;\n-import org.apache.log4j.Logger;\n-import org.parosproxy.paros.model.Model;\n-import org.parosproxy.paros.network.HttpMessage;\n-import org.parosproxy.paros.network.HttpSender;\n-\n-public class Introspection {\n-    private static final Logger LOG = Logger.getLogger(Introspection.class);\n-\n-    public static void sendIntrospectionQuery(URI uri) {\n-        HttpMessage message;\n-        try {\n-            message = new HttpMessage(uri);\n-            HttpSender sender =\n-                    new HttpSender(\n-                            Model.getSingleton().getOptionsParam().getConnectionParam(),\n-                            true,\n-                            HttpSender.MANUAL_REQUEST_INITIATOR);\n-            sender.sendAndReceive(message, true);\n-        } catch (Exception e) {\n-            LOG.error(\"Unable to send request.\", e);\n-            return;\n-        }\n-\n-        GraphQlParser.persistMessage(message);\n-    }\n-}\n"}}, {"oid": "1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "url": "https://github.com/zaproxy/zap-extensions/commit/1f7f88ba6e4ee27d6bb898c3fa1487de59a627d7", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create classes GraphQlParser and Introspection\n- Ability to add endpoint url to the sites tree\n- Replace 'Target URL' with 'Endpoint URL' for clarity\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-05T20:21:52Z", "type": "forcePushed"}, {"oid": "0308b25f8b173b5ecf06da5786395146fe313019", "url": "https://github.com/zaproxy/zap-extensions/commit/0308b25f8b173b5ecf06da5786395146fe313019", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create class GraphQlParser\n- Ability to add endpoint url to the sites tree\n- Replace 'Target URL' with 'Endpoint URL' for clarity\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-05T20:23:43Z", "type": "forcePushed"}, {"oid": "c684d00e9f2bb53e162cef06c5a11693d2dd70ac", "url": "https://github.com/zaproxy/zap-extensions/commit/c684d00e9f2bb53e162cef06c5a11693d2dd70ac", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create class GraphQlParser\n- Ability to add endpoint url to the sites tree\n- Replace 'Target URL' with 'Endpoint URL' for clarity\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-05T20:27:53Z", "type": "forcePushed"}, {"oid": "5720e8cea19d470cd8ea6f0ac92506991ef69f62", "url": "https://github.com/zaproxy/zap-extensions/commit/5720e8cea19d470cd8ea6f0ac92506991ef69f62", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create class GraphQlParser\n- Ability to add endpoint url to the sites tree\n- Replace 'Target URL' with 'Endpoint URL' for clarity\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-05T20:38:32Z", "type": "commit"}, {"oid": "5720e8cea19d470cd8ea6f0ac92506991ef69f62", "url": "https://github.com/zaproxy/zap-extensions/commit/5720e8cea19d470cd8ea6f0ac92506991ef69f62", "message": "Add Import from File / URL Dialogs\n\n- Create classes for Import from File / URL Dialogs\n- Create class GraphQlParser\n- Ability to add endpoint url to the sites tree\n- Replace 'Target URL' with 'Endpoint URL' for clarity\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-06-05T20:38:32Z", "type": "forcePushed"}]}