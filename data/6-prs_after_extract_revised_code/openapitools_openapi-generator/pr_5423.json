{"pr_number": 5423, "pr_title": "Add pythonSrcRoot option to python servers (aiohttp/flask/blueplanet) to support src/ layout projects [and reenable/fix all python server tests]", "pr_createdAt": "2020-02-25T00:01:02Z", "pr_url": "https://github.com/OpenAPITools/openapi-generator/pull/5423", "timeline": [{"oid": "4a5566b6e4250701ad3c7b4b75640e342a982578", "url": "https://github.com/OpenAPITools/openapi-generator/commit/4a5566b6e4250701ad3c7b4b75640e342a982578", "message": "Add src/ layout option to python servers (aiohttp/flask)\n\nThis allows the generated code to sit under src/ instead of a module in\nthe root dir. This is opt-in, as the option defaults to false (the\nexisting behavior).", "committedDate": "2020-02-25T04:03:31Z", "type": "forcePushed"}, {"oid": "cc9424702d35e5b13942826afb4e77a7ccb20bed", "url": "https://github.com/OpenAPITools/openapi-generator/commit/cc9424702d35e5b13942826afb4e77a7ccb20bed", "message": "Add src/ layout option to python servers (aiohttp/flask)\n\nThis allows the generated code to sit under src/ instead of a module in\nthe root dir. This is opt-in, as the option defaults to false (the\nexisting behavior).", "committedDate": "2020-02-25T04:08:53Z", "type": "forcePushed"}, {"oid": "4ecb0854f3788783d8ddba45f0370fd69800dfb5", "url": "https://github.com/OpenAPITools/openapi-generator/commit/4ecb0854f3788783d8ddba45f0370fd69800dfb5", "message": "Add src/ layout option to python servers (aiohttp/flask)\n\nThis allows the generated code to sit under src/ instead of a module in\nthe root dir. This is opt-in, as the option defaults to false (the\nexisting behavior).", "committedDate": "2020-02-25T04:14:50Z", "type": "forcePushed"}, {"oid": "15360ac0ad3778de25f728dde3b6ce232aa68a01", "url": "https://github.com/OpenAPITools/openapi-generator/commit/15360ac0ad3778de25f728dde3b6ce232aa68a01", "message": "update python-server docs", "committedDate": "2020-03-06T06:34:38Z", "type": "forcePushed"}, {"oid": "47056805d2023fa929831593f1b630b2278a93a1", "url": "https://github.com/OpenAPITools/openapi-generator/commit/47056805d2023fa929831593f1b630b2278a93a1", "message": "python server: build sample srclayout project", "committedDate": "2020-03-07T04:14:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODAwOQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389228009", "bodyText": "@cognifloyd would there ever be a use case where we would want to name the folder something other than src?\nIf so why don't we make this parameter more general like sourceFolderName type string.\nWhat do you think?", "author": "spacether", "createdAt": "2020-03-07T04:46:13Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java", "diffHunk": "@@ -165,6 +167,8 @@ public PythonAbstractConnexionServerCodegen(String templateDirectory, boolean fi\n                 defaultValue(\"8080\"));\n         cliOptions.add(CliOption.newBoolean(USE_NOSE, \"use the nose test framework\").\n                 defaultValue(Boolean.FALSE.toString()));\n+        cliOptions.add(CliOption.newBoolean(SRC_LAYOUT, \"put python module under src/\").", "originalCommit": "47056805d2023fa929831593f1b630b2278a93a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMzQ2Nw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389233467", "bodyText": "src/ is pretty standard, but I suppose I have seen projects that do lib/ as well.\nSo, an empty string (or maybe a .) means no subdir and a string == a subdir? hmm.", "author": "cognifloyd", "createdAt": "2020-03-07T06:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDEyMA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389234120", "bodyText": "hmm. Here's someone that puts his source in a python dir. So, there may be use cases where that would be helpful. Like in multi-language projects or where you include client and server libs in the same repo.\nSo, the name srcLayout only makes sense as a boolean. What would an option be for selecting an alternate directory for the python source files? pythonSrcRoot?\u00a0srcLayoutDir? or would you do two vars, one for the dir to use and a boolean to enable it?", "author": "cognifloyd", "createdAt": "2020-03-07T06:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM5MTM4Ng==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389391386", "bodyText": "How about the string pythonSrcRoot? And make it an empty value by default.", "author": "spacether", "createdAt": "2020-03-08T17:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODAwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE4Njk3Mw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r390186973", "bodyText": "done", "author": "cognifloyd", "createdAt": "2020-03-10T09:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "96c8704deda74ba7227343651c4efd71b3b26ea8", "chunk": "diff --git a/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java b/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\nindex 40c3d37ffdc..38ed47d4e66 100644\n--- a/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\n+++ b/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\n\n@@ -167,8 +167,8 @@ public class PythonAbstractConnexionServerCodegen extends DefaultCodegen impleme\n                 defaultValue(\"8080\"));\n         cliOptions.add(CliOption.newBoolean(USE_NOSE, \"use the nose test framework\").\n                 defaultValue(Boolean.FALSE.toString()));\n-        cliOptions.add(CliOption.newBoolean(SRC_LAYOUT, \"put python module under src/\").\n-                defaultValue(Boolean.FALSE.toString()));\n+        cliOptions.add(new CliOption(PYTHON_SRC_ROOT, \"put python sources in this subdirectory of output folder (defaults to \\\"\\\" for). Use this for src/ layout.\").\n+                defaultValue(\"\"));\n     }\n \n     protected void addSupportingFiles() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODQwNQ==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389228405", "bodyText": "Why not edit outputFolder up above before this is run?\nThen we don't need to put these if blocks in twice and can keep this code as-is.\nUp in processOpts:\n        if (this.srcLayout) {\n            outputFolder += \"src\" + File.separator + \"src\";\n        }", "author": "spacether", "createdAt": "2020-03-07T04:54:54Z", "path": "modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java", "diffHunk": "@@ -304,7 +315,20 @@ public String escapeReservedWord(String name) {\n      */\n     @Override\n     public String apiFileFolder() {\n-        return outputFolder + File.separator + apiPackage().replace('.', File.separatorChar);\n+        String pkgPath = apiPackage().replace('.', File.separatorChar);\n+        if (this.srcLayout) {\n+            pkgPath = \"src\" + File.separator + pkgPath;\n+        }", "originalCommit": "47056805d2023fa929831593f1b630b2278a93a1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzMzU1MA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389233550", "bodyText": "Because there are still supporting files (like Readme, .gitignore, etc) that still need to be in the root dir. So we need to selectively move only the source files under the src/ dir.", "author": "cognifloyd", "createdAt": "2020-03-07T06:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM5MTUyMA==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r389391520", "bodyText": "Ah, in that case why not use your new variable\npythonSrcRoot? Then it is only defined once and it will include the file separator when you pass in the value \"src/\"", "author": "spacether", "createdAt": "2020-03-08T17:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE4NjgzNw==", "url": "https://github.com/OpenAPITools/openapi-generator/pull/5423#discussion_r390186837", "bodyText": "done", "author": "cognifloyd", "createdAt": "2020-03-10T09:30:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIyODQwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "96c8704deda74ba7227343651c4efd71b3b26ea8", "chunk": "diff --git a/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java b/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\nindex 40c3d37ffdc..38ed47d4e66 100644\n--- a/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\n+++ b/modules/openapi-generator/src/main/java/org/openapitools/codegen/languages/PythonAbstractConnexionServerCodegen.java\n\n@@ -316,19 +334,13 @@ public class PythonAbstractConnexionServerCodegen extends DefaultCodegen impleme\n     @Override\n     public String apiFileFolder() {\n         String pkgPath = apiPackage().replace('.', File.separatorChar);\n-        if (this.srcLayout) {\n-            pkgPath = \"src\" + File.separator + pkgPath;\n-        }\n-        return outputFolder + File.separator + pkgPath;\n+        return pythonSrcOutputFolder() + pkgPath;\n     }\n \n     @Override\n     public String modelFileFolder() {\n         String pkgPath = modelPackage().replace('.', File.separatorChar);\n-        if (this.srcLayout) {\n-            pkgPath = \"src\" + File.separator + pkgPath;\n-        }\n-        return outputFolder + File.separator + pkgPath;\n+        return pythonSrcOutputFolder() + pkgPath;\n     }\n \n     @Override\n"}}, {"oid": "96c8704deda74ba7227343651c4efd71b3b26ea8", "url": "https://github.com/OpenAPITools/openapi-generator/commit/96c8704deda74ba7227343651c4efd71b3b26ea8", "message": "python server: build sample srclayout project", "committedDate": "2020-03-10T09:26:39Z", "type": "forcePushed"}, {"oid": "2a924ba174996d0e29b17d1adff2a905b7b08634", "url": "https://github.com/OpenAPITools/openapi-generator/commit/2a924ba174996d0e29b17d1adff2a905b7b08634", "message": "python server: build sample srclayout project", "committedDate": "2020-03-10T09:28:04Z", "type": "forcePushed"}, {"oid": "76d54f7f400a6a2f0338df5aa345e7c765f79179", "url": "https://github.com/OpenAPITools/openapi-generator/commit/76d54f7f400a6a2f0338df5aa345e7c765f79179", "message": "python server: Add pythonSrcRoot option\n\nThis will allow the python project to be in a subdirectory (as specified\nin pythonSrcRoot). That could mean following the src layout with sources\nunder src/ or lib/. Multi-language projects might use a sub directory\nlike python/, or whatever makes sense for the project.\n\nBy default, the pythonSrcRoot is \"\", meaning the existing behavior is\nthe default.", "committedDate": "2020-04-03T22:56:05Z", "type": "commit"}, {"oid": "fd751e9efd4413fc50d5233b1504ba71f3158a43", "url": "https://github.com/OpenAPITools/openapi-generator/commit/fd751e9efd4413fc50d5233b1504ba71f3158a43", "message": "python server: update template files to support pythonSrcRoot", "committedDate": "2020-04-03T22:56:20Z", "type": "commit"}, {"oid": "7df485f284f1e6623c0f47c1e34f9fe3512b8bb3", "url": "https://github.com/OpenAPITools/openapi-generator/commit/7df485f284f1e6623c0f47c1e34f9fe3512b8bb3", "message": "python server: update docs to add pythonSrcRoot option", "committedDate": "2020-04-03T22:56:23Z", "type": "commit"}, {"oid": "9e7a2a32cce3fa69510a0b6722d00614998f2c33", "url": "https://github.com/OpenAPITools/openapi-generator/commit/9e7a2a32cce3fa69510a0b6722d00614998f2c33", "message": "python server: add pythonSrcRoot sample script", "committedDate": "2020-04-03T22:56:26Z", "type": "commit"}, {"oid": "a440404e1629a066e6c6872c3c325666381a85fb", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a440404e1629a066e6c6872c3c325666381a85fb", "message": "python server: build sample srclayout project", "committedDate": "2020-04-03T22:56:27Z", "type": "commit"}, {"oid": "0bbd2b7c085d33a5b7fa8d621cac074400db5a69", "url": "https://github.com/OpenAPITools/openapi-generator/commit/0bbd2b7c085d33a5b7fa8d621cac074400db5a69", "message": "[Python] copy test files preserving history", "committedDate": "2020-04-03T23:26:32Z", "type": "commit"}, {"oid": "23a64a7baa745ccafb0a1b3ae901852c05868c03", "url": "https://github.com/OpenAPITools/openapi-generator/commit/23a64a7baa745ccafb0a1b3ae901852c05868c03", "message": "[Python] Make a conflict to preserve file copy history", "committedDate": "2020-04-03T23:40:21Z", "type": "commit"}, {"oid": "0e32620247b76e364c56bcdc12afdf5381107b21", "url": "https://github.com/OpenAPITools/openapi-generator/commit/0e32620247b76e364c56bcdc12afdf5381107b21", "message": "Merge branch to finish copying python test files", "committedDate": "2020-04-03T23:46:57Z", "type": "commit"}, {"oid": "a649ac450efc728a9d5c78af384e084db6a1c031", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a649ac450efc728a9d5c78af384e084db6a1c031", "message": "[Python] customize pom.xml for src layout tests", "committedDate": "2020-04-03T23:49:34Z", "type": "commit"}, {"oid": "ef999c283c19fb192a01a98c6a16222329a848cd", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ef999c283c19fb192a01a98c6a16222329a848cd", "message": "[Python] add python-aiohttp-srclayout tests", "committedDate": "2020-04-04T00:01:25Z", "type": "commit"}, {"oid": "b03adefccfcfe39db754528ad2316dcefdff62da", "url": "https://github.com/OpenAPITools/openapi-generator/commit/b03adefccfcfe39db754528ad2316dcefdff62da", "message": "[Python] Fix server tests by updating requirements\n\nReverts the PR that disabled python2 server tests:\nhttps://github.com/OpenAPITools/openapi-generator/pull/4949\n\nReverts commits that disabled python3 server tests:\n9adfedbfbb45c7059e64b3d9a285710bded4fb62\n17ee990baaa80585242c7a07d64e2be4888fcfd0\n\nIssue about the python 3 tests:\nhttps://github.com/OpenAPITools/openapi-generator/issues/5235\n\nI couldn't find an issue about the python2 tests being disabled.\nI'm guessing build errors like the following were the trigger:\nhttps://travis-ci.org/github/OpenAPITools/openapi-generator/builds/634238181\n\nLet's see what breaks!", "committedDate": "2020-04-04T01:08:04Z", "type": "commit"}, {"oid": "a37f27ff32e01c5d587229c5ed15bb3d4c114f42", "url": "https://github.com/OpenAPITools/openapi-generator/commit/a37f27ff32e01c5d587229c5ed15bb3d4c114f42", "message": "hack to only run tests on travis for now", "committedDate": "2020-04-04T01:48:53Z", "type": "forcePushed"}, {"oid": "c46e5ab8e1ea2d1e58b1f1eca8ac11104fe228b9", "url": "https://github.com/OpenAPITools/openapi-generator/commit/c46e5ab8e1ea2d1e58b1f1eca8ac11104fe228b9", "message": "rebuild python servers", "committedDate": "2020-04-04T02:05:55Z", "type": "forcePushed"}, {"oid": "458de3f923987c4fdf28af6b04fc07188e8a6075", "url": "https://github.com/OpenAPITools/openapi-generator/commit/458de3f923987c4fdf28af6b04fc07188e8a6075", "message": "[Python] Copy setup.py to python-aiohttp", "committedDate": "2020-04-04T06:04:29Z", "type": "commit"}, {"oid": "c76879714208f0762af1384f1c113270a848e92b", "url": "https://github.com/OpenAPITools/openapi-generator/commit/c76879714208f0762af1384f1c113270a848e92b", "message": "[Python] Save history while copying setup.py to python-aiohttp", "committedDate": "2020-04-04T06:04:59Z", "type": "commit"}, {"oid": "422022a7dd92c5a071dba9edf57b550e2b228533", "url": "https://github.com/OpenAPITools/openapi-generator/commit/422022a7dd92c5a071dba9edf57b550e2b228533", "message": "[Python] Merge copied setup.py", "committedDate": "2020-04-04T06:06:23Z", "type": "commit"}, {"oid": "b791fff77eb0e688170b611cc23af08677e7de77", "url": "https://github.com/OpenAPITools/openapi-generator/commit/b791fff77eb0e688170b611cc23af08677e7de77", "message": "[Python] Add aiohttp server setup.py", "committedDate": "2020-04-04T06:07:56Z", "type": "commit"}, {"oid": "8a63a5cf2a6a7d022385bc60072340af4dfaafaf", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8a63a5cf2a6a7d022385bc60072340af4dfaafaf", "message": "[Python] Fix python server tests with src layout", "committedDate": "2020-04-04T06:07:57Z", "type": "commit"}, {"oid": "03988270cc9e0879757da97f66a184c825efed76", "url": "https://github.com/OpenAPITools/openapi-generator/commit/03988270cc9e0879757da97f66a184c825efed76", "message": "[Python] bump Flask-Testing version", "committedDate": "2020-04-04T06:07:57Z", "type": "commit"}, {"oid": "886490209b314e8ddd48fc618acbbcec3f916558", "url": "https://github.com/OpenAPITools/openapi-generator/commit/886490209b314e8ddd48fc618acbbcec3f916558", "message": "[Python] rebuild python server samples", "committedDate": "2020-04-04T06:08:30Z", "type": "forcePushed"}, {"oid": "8dbc5f6b342f6d4e1c3ab5545473a21d2a25d734", "url": "https://github.com/OpenAPITools/openapi-generator/commit/8dbc5f6b342f6d4e1c3ab5545473a21d2a25d734", "message": "[Python] Pin pyyaml for py2.7 flask server", "committedDate": "2020-04-04T07:24:32Z", "type": "commit"}, {"oid": "ef445968526d73f72038a62e66848947e7842c5b", "url": "https://github.com/OpenAPITools/openapi-generator/commit/ef445968526d73f72038a62e66848947e7842c5b", "message": "[Python] simplify flask server requirements", "committedDate": "2020-04-04T07:27:11Z", "type": "commit"}, {"oid": "743a618e81c7a39a43e3225f0ac16277d0ca7c9e", "url": "https://github.com/OpenAPITools/openapi-generator/commit/743a618e81c7a39a43e3225f0ac16277d0ca7c9e", "message": "consolidate server tests", "committedDate": "2020-04-04T07:27:50Z", "type": "commit"}, {"oid": "2f5148bc753a0e2bcee14d29715185cee0351fc4", "url": "https://github.com/OpenAPITools/openapi-generator/commit/2f5148bc753a0e2bcee14d29715185cee0351fc4", "message": "[Python] rebuild python server samples", "committedDate": "2020-04-04T07:27:51Z", "type": "commit"}, {"oid": "2f5148bc753a0e2bcee14d29715185cee0351fc4", "url": "https://github.com/OpenAPITools/openapi-generator/commit/2f5148bc753a0e2bcee14d29715185cee0351fc4", "message": "[Python] rebuild python server samples", "committedDate": "2020-04-04T07:27:51Z", "type": "forcePushed"}, {"oid": "85665f1f07d89cb868a2372946d4387ee50c7538", "url": "https://github.com/OpenAPITools/openapi-generator/commit/85665f1f07d89cb868a2372946d4387ee50c7538", "message": "[Python] Fix python server requirements for older pythons\n\nDocumented minimum python version for our aiohttp server is 3.5.\nDocumented minimum python version for our flask server is 3.4.\nConnexion 2.3 is the last version to support python 3.4 and 3.5, so fix\nthe version pinning to correctly select <=2.3 for these EOL python\nversions. Newer pythons should get the latest if possible as there many\nrelevant bug fixes.\n\nWerkzeug also needs to be pinned for these old versions in the aiohttp\nserver just like for the flask server.\n\n3.4 and 3.5 are EOL. We really should increase the minimum supported\nversion, but that is for another PR to do.", "committedDate": "2020-04-07T18:11:45Z", "type": "commit"}, {"oid": "85665f1f07d89cb868a2372946d4387ee50c7538", "url": "https://github.com/OpenAPITools/openapi-generator/commit/85665f1f07d89cb868a2372946d4387ee50c7538", "message": "[Python] Fix python server requirements for older pythons\n\nDocumented minimum python version for our aiohttp server is 3.5.\nDocumented minimum python version for our flask server is 3.4.\nConnexion 2.3 is the last version to support python 3.4 and 3.5, so fix\nthe version pinning to correctly select <=2.3 for these EOL python\nversions. Newer pythons should get the latest if possible as there many\nrelevant bug fixes.\n\nWerkzeug also needs to be pinned for these old versions in the aiohttp\nserver just like for the flask server.\n\n3.4 and 3.5 are EOL. We really should increase the minimum supported\nversion, but that is for another PR to do.", "committedDate": "2020-04-07T18:11:45Z", "type": "forcePushed"}]}