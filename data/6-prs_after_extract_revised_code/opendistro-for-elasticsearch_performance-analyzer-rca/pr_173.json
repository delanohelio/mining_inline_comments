{"pr_number": 173, "pr_title": "Adding NPE Fix during RCA controller start up", "pr_createdAt": "2020-04-29T20:46:42Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/173", "timeline": [{"oid": "5074d68e0ad2b119055f4e9645ef4d4bb665e210", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/5074d68e0ad2b119055f4e9645ef4d4bb665e210", "message": "Adding NPE Fix during RCA controller start up", "committedDate": "2020-04-29T20:44:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNDc4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/173#discussion_r417604781", "bodyText": "In what case can this be null ? This shouldn't ever be null. RCA system depends on this config. Scheduler etc. cannot even start when this is null.", "author": "yojs", "createdAt": "2020-04-29T20:53:34Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -276,6 +276,11 @@ private void readRcaEnabledFromConf() {\n    * <p>In case all the RCAs in param value are incorrect, return without any update.\n    */\n   private void readAndUpdateMutesRcas() {\n+    if (rcaConf == null) {", "originalCommit": "5074d68e0ad2b119055f4e9645ef4d4bb665e210", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMjYzMA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/173#discussion_r417612630", "bodyText": "The rca config is initialized in the start() as part of updateRcaState() invocation.\nThe readAndUpdateMutesRcas() is invoked from readRcaEnabledFromConf(), which happens before the updateRcaState()call, thus leading to NPE.", "author": "khushbr", "createdAt": "2020-04-29T21:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYwNDc4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a4915daec8bb43a0ed06a75fe220e059a8f35283", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\nindex 0039ab0f..fc098796 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\n\n@@ -276,16 +276,11 @@ public class RcaController {\n    * <p>In case all the RCAs in param value are incorrect, return without any update.\n    */\n   private void readAndUpdateMutesRcas() {\n-    if (rcaConf == null) {\n-      LOG.error(\"RCA Conf: {} null, returning.\", rcaConf);\n-      return;\n-    }\n-\n-    // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n-    // refresh the `muted-rcas` value from rca config file.\n-    long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n-    if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n-      try {\n+    try {\n+      // If the rca config file has been updated since the lastModifiedTimeInMillisInMemory in memory,\n+      // refresh the `muted-rcas` value from rca config file.\n+      long lastModifiedTimeInMillisOnDisk = rcaConf.getLastModifiedTime();\n+      if (lastModifiedTimeInMillisOnDisk > lastModifiedTimeInMillisInMemory) {\n         Set<String> rcasForMute = new HashSet<>(rcaConf.getMutedRcaList());\n         LOG.info(\"RCAs provided for muting : {}\", rcasForMute);\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzYxMzI1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/173#discussion_r417613252", "bodyText": "This call has to be before updateRcaState as updateRcaState starts the scheduler. The scheduler is started, then it might start its run anytime. Therefore, in theory, it might execute the muted RCA node before coming around to it. Therefore, my suggestion, is move this call before updateRcaState this will also require adjusting the call to rcaConf = RcaControllerHelper.pickRcaConfForRole(currentRole);", "author": "yojs", "createdAt": "2020-04-29T21:09:20Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -225,6 +225,12 @@ public void run() {\n         }\n         updateRcaState();\n \n+        // If RCA is enabled, update Analysis graph with Muted RCAs value\n+        if (rcaEnabled) {\n+          LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n+          readAndUpdateMutesRcas();", "originalCommit": "5074d68e0ad2b119055f4e9645ef4d4bb665e210", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a4915daec8bb43a0ed06a75fe220e059a8f35283", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\nindex 0039ab0f..fc098796 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java\n\n@@ -223,13 +222,14 @@ public class RcaController {\n             checkUpdateNodeRole(nodeDetails);\n           }\n         }\n-        updateRcaState();\n \n         // If RCA is enabled, update Analysis graph with Muted RCAs value\n         if (rcaEnabled) {\n+          rcaConf = RcaControllerHelper.pickRcaConfForRole(currentRole);\n           LOG.debug(\"Updating Analysis Graph with Muted RCAs\");\n           readAndUpdateMutesRcas();\n         }\n+        updateRcaState();\n \n         long duration = System.currentTimeMillis() - startTime;\n         if (duration < rcaStateCheckIntervalMillis) {\n"}}, {"oid": "a4915daec8bb43a0ed06a75fe220e059a8f35283", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a4915daec8bb43a0ed06a75fe220e059a8f35283", "message": "Addressing PR comments", "committedDate": "2020-04-29T22:31:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1MjE3MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/173#discussion_r417652171", "bodyText": "You might want to emit a metric here. If we really expect never for this to happen, then we should emit a domain level metric and add it to the dashboard.", "author": "yojs", "createdAt": "2020-04-29T22:34:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/RcaController.java", "diffHunk": "@@ -297,11 +297,11 @@ private void readAndUpdateMutesRcas() {\n \n         LOG.info(\"Updating the muted RCA Graph to : {}\", rcasForMute);\n         Stats.getInstance().updateMutedGraphNodes(rcasForMute);\n-      } catch (Exception e) {\n-        LOG.error(\"Couldn't read/update the muted RCAs.\", e);\n       }\n+      lastModifiedTimeInMillisInMemory = lastModifiedTimeInMillisOnDisk;\n+    } catch (Exception e) {\n+        LOG.error(\"Couldn't read/update the muted RCAs.\", e);", "originalCommit": "a4915daec8bb43a0ed06a75fe220e059a8f35283", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}