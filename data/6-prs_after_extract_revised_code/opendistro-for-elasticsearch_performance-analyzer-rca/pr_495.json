{"pr_number": 495, "pr_title": "PersistableSlidingWindow#load() modification", "pr_createdAt": "2020-10-26T20:53:18Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/495", "timeline": [{"oid": "7aacb99d2f369cde699af36a4272e80f75401a65", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/7aacb99d2f369cde699af36a4272e80f75401a65", "message": "PersistableSlidingWindow#load() modification\n\n- PersistableSlidingWindow#load() will no longer throw an IOException\nwhen it is called with a Path that doesn't exist", "committedDate": "2020-10-26T20:50:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3NDA0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/495#discussion_r512274045", "bodyText": "As no file exists in this path, will this be more of a warning logger level?", "author": "sruti1312", "createdAt": "2020-10-26T21:17:25Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -72,6 +72,10 @@ protected synchronized void load(Path path) throws IOException {\n     if (!enablePersistence) {\n       return;\n     }\n+    if (!Files.exists(path)) {\n+      LOG.debug(\"{}#load({}) called but the file doesn't exist\", this.getClass().getSimpleName(), path);", "originalCommit": "7aacb99d2f369cde699af36a4272e80f75401a65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzNTg4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/495#discussion_r512335881", "bodyText": "I moved the validation responsibility to the caller and deleted this conditional. The ITs still pass.", "author": "sidheart", "createdAt": "2020-10-26T23:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3NDA0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "ed0ab850cf3005e8e92e33e485d375550cc877e7", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\nindex ad227dee..5817ecf3 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n\n@@ -69,13 +67,6 @@ public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n    * @throws IOException If there is an error reading the file\n    */\n   protected synchronized void load(Path path) throws IOException {\n-    if (!enablePersistence) {\n-      return;\n-    }\n-    if (!Files.exists(path)) {\n-      LOG.debug(\"{}#load({}) called but the file doesn't exist\", this.getClass().getSimpleName(), path);\n-      return;\n-    }\n     LineIterator it = FileUtils.lineIterator(path.toFile(), \"UTF-8\");\n     try {\n       while (it.hasNext()) {\n"}}, {"oid": "ed0ab850cf3005e8e92e33e485d375550cc877e7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/ed0ab850cf3005e8e92e33e485d375550cc877e7", "message": "Move load() validation resposiblity to caller", "committedDate": "2020-10-26T23:49:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3Njg4Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/495#discussion_r512876883", "bodyText": "Can we add a log message when enablePersistence is not set or when file does not exist in the path? Even debug level log would be great.", "author": "sruti1312", "createdAt": "2020-10-27T17:15:08Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -49,17 +49,15 @@ public PersistableSlidingWindow(int slidingWindowSize,\n                                   Path filePath) {\n     super(slidingWindowSize, timeUnit);\n     this.pathToFile = filePath;\n-    if (this.pathToFile == null) {\n-      this.enablePersistence = false;\n-    } else {\n-      this.enablePersistence = true;\n-      // setting the last write time to now will cause our first write to occur 5 minutes after construction\n-      this.lastWriteTimeEpochMs = Instant.now().toEpochMilli();\n-      try {\n+    this.enablePersistence = this.pathToFile != null;\n+    // setting the last write time to now will cause our first write to occur 5 minutes after construction\n+    this.lastWriteTimeEpochMs = Instant.now().toEpochMilli();\n+    try {\n+      if (enablePersistence && Files.exists(filePath)) {", "originalCommit": "ed0ab850cf3005e8e92e33e485d375550cc877e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMDI2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/495#discussion_r512910262", "bodyText": "Added more logging in the most recent commit", "author": "sidheart", "createdAt": "2020-10-27T17:57:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg3Njg4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "372dd94613d270e737360394ebdf514f51b6f7bd", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\nindex 5817ecf3..49364f6c 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n\n@@ -50,14 +50,21 @@ public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n     super(slidingWindowSize, timeUnit);\n     this.pathToFile = filePath;\n     this.enablePersistence = this.pathToFile != null;\n-    // setting the last write time to now will cause our first write to occur 5 minutes after construction\n+    if (!enablePersistence) {\n+      LOG.debug(\"Persistence is not enabled for {}:{}\", this.getClass().getSimpleName(), this);\n+      return;\n+    }\n     this.lastWriteTimeEpochMs = Instant.now().toEpochMilli();\n-    try {\n-      if (enablePersistence && Files.exists(filePath)) {\n+    if (Files.exists(filePath)) {\n+      try {\n         load(this.pathToFile);\n+      } catch (IOException ex) {\n+        LOG.error(\"Unable to load previous data from {} into {}\", this.pathToFile,\n+            getClass().getSimpleName(), ex);\n       }\n-    } catch (IOException ex) {\n-      LOG.error(\"Unable to load previous data from {} into {}\", this.pathToFile, getClass().getSimpleName());\n+    } else {\n+      LOG.warn(\"{}:{} attempted to load data from {}, but the file doesn't exist\",\n+          this.getClass().getSimpleName(), this, filePath);\n     }\n   }\n \n"}}, {"oid": "372dd94613d270e737360394ebdf514f51b6f7bd", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/372dd94613d270e737360394ebdf514f51b6f7bd", "message": "Added more logging", "committedDate": "2020-10-27T17:56:08Z", "type": "commit"}]}