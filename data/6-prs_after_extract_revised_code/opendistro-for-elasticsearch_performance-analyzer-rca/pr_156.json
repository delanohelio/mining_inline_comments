{"pr_number": 156, "pr_title": "Collect node stats as top consumers for JVM RCA", "pr_createdAt": "2020-04-22T19:03:57Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156", "timeline": [{"oid": "fdbdb84ff74a8dbb9c006b073e0be998fd232f82", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/fdbdb84ff74a8dbb9c006b073e0be998fd232f82", "message": "Add node stats as top consumers for JVM RCA", "committedDate": "2020-04-20T17:36:15Z", "type": "commit"}, {"oid": "a9e693ea2a733a6431db92d13bded645ddf708f2", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/a9e693ea2a733a6431db92d13bded645ddf708f2", "message": "fix a bug in JVM cluster RCA", "committedDate": "2020-04-20T23:15:22Z", "type": "commit"}, {"oid": "45ba5eac59165b14a5b95909d5b233a9f76db8c9", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/45ba5eac59165b14a5b95909d5b233a9f76db8c9", "message": "Add unit test for NodeStatAggregator", "committedDate": "2020-04-22T18:58:08Z", "type": "commit"}, {"oid": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/915f207bc781a95cb7def885d2f41c99af9d5a2b", "message": "update README.md to show the latest RCA API response", "committedDate": "2020-04-22T19:18:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NzcyNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414157724", "bodyText": "Should we make it an rca.conf param ?", "author": "yojs", "createdAt": "2020-04-23T22:10:35Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java", "diffHunk": "@@ -80,11 +92,12 @@\n   // minimum\n   private static final double OLD_GEN_GC_THRESHOLD = 1;\n   private static final double CONVERT_BYTES_TO_MEGABYTES = Math.pow(1024, 3);\n+  private static final int TOP_K = 3;", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTMzNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221337", "bodyText": "done.", "author": "rguo-aws", "createdAt": "2020-04-27T23:36:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1NzcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\nindex 6bde38bc..55e9de3c 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\n\n@@ -93,6 +94,8 @@ public class HighHeapUsageOldGenRca extends Rca<ResourceFlowUnit> {\n   private static final double OLD_GEN_GC_THRESHOLD = 1;\n   private static final double CONVERT_BYTES_TO_MEGABYTES = Math.pow(1024, 3);\n   private static final int TOP_K = 3;\n+  private static final String TOP_K_RCA_CONF = \"top-k\";\n+  private int top_k;\n   protected Clock clock;\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MDM0Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414160347", "bodyText": "We should make that change where this is no longer required to be specified and it becomes a constant in the Node class", "author": "yojs", "createdAt": "2020-04-23T22:16:08Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java", "diffHunk": "@@ -80,11 +92,12 @@\n   // minimum\n   private static final double OLD_GEN_GC_THRESHOLD = 1;\n   private static final double CONVERT_BYTES_TO_MEGABYTES = Math.pow(1024, 3);\n+  private static final int TOP_K = 3;\n   protected Clock clock;\n \n \n   public <M extends Metric> HighHeapUsageOldGenRca(final int rcaPeriod, final double lowerBoundThreshold,\n-      final M heap_Used, final M gc_event, final M heap_Max) {\n+      final M heap_Used, final M gc_event, final M heap_Max, final List<Metric> consumers) {\n     super(5);", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMTY0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414821645", "bodyText": "I agree. But that will be a big code change which involves a lot of files and unit tests. Let me create a github issue to keep track. we might need to create a separate PR to address it.", "author": "rguo-aws", "createdAt": "2020-04-24T19:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MDM0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\nindex 6bde38bc..55e9de3c 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/HighHeapUsageOldGenRca.java\n\n@@ -93,6 +94,8 @@ public class HighHeapUsageOldGenRca extends Rca<ResourceFlowUnit> {\n   private static final double OLD_GEN_GC_THRESHOLD = 1;\n   private static final double CONVERT_BYTES_TO_MEGABYTES = Math.pow(1024, 3);\n   private static final int TOP_K = 3;\n+  private static final String TOP_K_RCA_CONF = \"top-k\";\n+  private int top_k;\n   protected Clock clock;\n \n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MjAyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414162027", "bodyText": "we can remove this ?", "author": "yojs", "createdAt": "2020-04-23T22:19:53Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotshard.IndexShardKey;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * We've seen huge performance impact if collecting node stats across all shards on data node.\n+ * So Performance Analyzer writer will only try to collect node stats from a small portion of\n+ * shards at a time to reduce performance impact. This class on reader side will allow us to\n+ * keep track of node stat from all previous batches and calculate its sum.\n+ */\n+public class NodeStatAggregator {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeStatAggregator.class);\n+  private Metric nodeStatMetric;\n+  private int sum;\n+  private final HashMap<IndexShardKey, NodeStatValue> shardKeyMap;\n+  private long lastPurgeTimestamp;\n+  //purge the hash table every 30 mins\n+  private static final int PURGE_HASH_TABLE_INTERVAL_IN_MINS = 30;\n+\n+\n+  public NodeStatAggregator(Metric nodeStatMetric) {\n+    this.nodeStatMetric = nodeStatMetric;\n+    this.sum = 0;\n+    this.lastPurgeTimestamp = 0L;\n+    this.shardKeyMap = new HashMap<>();\n+  }\n+\n+  /**\n+   * Whether this NodeStatAggregator contains valid node stats from writer\n+   * This is to avoid reading stale data when the node stats has already been\n+   * disabled from writer side\n+   * @return if it has valid node stats\n+   */\n+  public boolean isEmpty() {\n+    return this.shardKeyMap.isEmpty();", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTQxNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221414", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-27T23:37:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2MjAyNw=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\nindex 7bfc13dd..26c87944 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\n\n@@ -43,7 +43,7 @@ public class NodeStatAggregator {\n    * @return if it has valid node stats\n    */\n   public boolean isEmpty() {\n-    return this.shardKeyMap.isEmpty();\n+    return shardKeyMap.isEmpty();\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NDAxNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414164016", "bodyText": "Can we use the hascode builder from Apache commons as here ?", "author": "yojs", "createdAt": "2020-04-23T22:24:37Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotshard/IndexShardKey.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotshard;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.CommonDimension;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.exception.DataTypeException;\n+\n+public class IndexShardKey {\n+\n+  private static final Logger LOG = LogManager.getLogger(IndexShardKey.class);\n+  private final String indexName;\n+  private final int shardId;\n+\n+  public IndexShardKey(String indexName, int shardId) {\n+    this.indexName = indexName;\n+    this.shardId = shardId;\n+  }\n+\n+  public String getIndexName() {\n+    return this.indexName;\n+  }\n+\n+  public int getShardId() {\n+    return this.shardId;\n+  }\n+\n+  public static IndexShardKey buildIndexShardKey(Record record) throws IllegalArgumentException {\n+    if (record == null) {\n+      throw new IllegalArgumentException(\"record is null\");\n+    }\n+    try {\n+      String indexName = record.getValue(CommonDimension.INDEX_NAME.toString(), String.class);\n+      Integer shardId = record.getValue(CommonDimension.SHARD_ID.toString(), Integer.class);\n+      return new IndexShardKey(indexName, shardId);\n+    }\n+    catch (DataTypeException de) {\n+      LOG.error(\"Fail to read field from SQL record, message {}\", de.getMessage());\n+      throw new IllegalArgumentException(\"failed to read field from record\");\n+    }\n+  }\n+\n+  @Override\n+  public boolean equals(Object obj) {\n+    if (obj != null && obj instanceof IndexShardKey) {\n+      IndexShardKey key = (IndexShardKey)obj;\n+      return indexName.equals(key.indexName) && shardId == key.shardId;\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return indexName.hashCode() * 31 + shardId;", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMjkyMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414822921", "bodyText": "I will leave this to Khushboo to address it as this is copied directly from her PR.", "author": "rguo-aws", "createdAt": "2020-04-24T19:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NDAxNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NDQ4MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414164480", "bodyText": "Maybe we can remove additional empty lines ?", "author": "yojs", "createdAt": "2020-04-23T22:25:43Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/rca/hotheap/NodeStatAggregatorTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ *  permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.store.rca.hotheap;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metrics.AllMetrics.CommonDimension;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.GradleTaskForRca;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.metrics.MetricTestHelper;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap.NodeStatAggregator;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+@Category(GradleTaskForRca.class)\n+public class NodeStatAggregatorTest {\n+\n+  private MetricTestHelper nodeStat;\n+  private NodeStatAggregator nodeStatAggregator;\n+\n+  @Before\n+  public void setup() {\n+    this.nodeStat = new MetricTestHelper(5);\n+    this.nodeStatAggregator = new NodeStatAggregator(nodeStat);\n+  }\n+\n+  @Test\n+  public void testCollect() {\n+    List<String> columnName = Arrays.asList(CommonDimension.INDEX_NAME.toString(), CommonDimension.SHARD_ID.toString(), MetricsDB.MAX);\n+\n+    nodeStat.createTestFlowUnits(columnName, Arrays.asList(\"index1\", \"1\", \"5\"));\n+    nodeStatAggregator.collect(0);\n+    Assert.assertEquals(5, nodeStatAggregator.getSum());\n+\n+    nodeStat.createTestFlowUnits(columnName, Arrays.asList(\"index1\", \"2\", \"3\"));\n+    nodeStatAggregator.collect(TimeUnit.MINUTES.toMillis(3));\n+    Assert.assertEquals(8, nodeStatAggregator.getSum());\n+\n+    nodeStat.createTestFlowUnits(columnName, Arrays.asList(\"index2\", \"1\", \"10\"));\n+    nodeStatAggregator.collect(TimeUnit.MINUTES.toMillis(8));\n+    Assert.assertEquals(18, nodeStatAggregator.getSum());\n+\n+    nodeStat.createTestFlowUnits(columnName, Arrays.asList(\"index1\", \"2\", \"1\"));\n+    nodeStatAggregator.collect(TimeUnit.MINUTES.toMillis(12));\n+    Assert.assertEquals(16, nodeStatAggregator.getSum());\n+\n+    //purge the hash after 30min\n+    nodeStat.createTestFlowUnits(columnName, Arrays.asList(\"index2\", \"2\", \"10\"));\n+    nodeStatAggregator.collect(TimeUnit.MINUTES.toMillis(32));\n+    Assert.assertEquals(21, nodeStatAggregator.getSum());\n+  }\n+\n+", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTQ4MQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221481", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-27T23:37:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NDQ4MA=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/rca/hotheap/NodeStatAggregatorTest.java b/src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/rca/hotheap/NodeStatAggregatorTest.java\nindex e0bdfc3b..0701bd0a 100644\n--- a/src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/rca/hotheap/NodeStatAggregatorTest.java\n+++ b/src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/store/rca/hotheap/NodeStatAggregatorTest.java\n\n@@ -65,7 +65,4 @@ public class NodeStatAggregatorTest {\n     nodeStatAggregator.collect(TimeUnit.MINUTES.toMillis(32));\n     Assert.assertEquals(21, nodeStatAggregator.getSum());\n   }\n-\n-\n-\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NzkyNw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414167927", "bodyText": "Should we also catch DataAccessException as well ?", "author": "yojs", "createdAt": "2020-04-23T22:33:11Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/persist/SQLParsingUtil.java", "diffHunk": "@@ -73,7 +73,7 @@ public static double readDataFromSqlResult(Result<Record> result, Field<String>\n     if (result != null) {\n       try {\n         Record record = SQLParsingUtil.getRecordByName(result, matchedField, matchedFieldName);\n-        ret = record.getValue(MetricsDB.MAX, Double.class);\n+        ret = record.getValue(dataField, Double.class);\n       }\n       catch (IllegalArgumentException ie) {", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMjE3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416222170", "bodyText": "revert this as it has been addressed in other PR", "author": "rguo-aws", "createdAt": "2020-04-27T23:39:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE2NzkyNw=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/persist/SQLParsingUtil.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/persist/SQLParsingUtil.java\nindex 782bc3df..d0d5164a 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/persist/SQLParsingUtil.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/persist/SQLParsingUtil.java\n\n@@ -73,7 +73,7 @@ public class SQLParsingUtil {\n     if (result != null) {\n       try {\n         Record record = SQLParsingUtil.getRecordByName(result, matchedField, matchedFieldName);\n-        ret = record.getValue(dataField, Double.class);\n+        ret = record.getValue(MetricsDB.MAX, Double.class);\n       }\n       catch (IllegalArgumentException ie) {\n         LOG.error(\"{} fails to match any row in field {}.\", matchedFieldName, matchedField.getName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MDQ2Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414170462", "bodyText": "Can we just typecast if required instead of creating new ArrayList ?", "author": "yojs", "createdAt": "2020-04-23T22:39:03Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java", "diffHunk": "@@ -65,10 +81,19 @@ public void construct() {\n     addLeaf(gc_Collection_Time);\n     addLeaf(cpuUtilizationGroupByOperation);\n \n+    //add node stats metrics\n+    List<Metric> nodeStatsMetrics = constructNodeStatsMetrics();\n+    for (Metric metric : nodeStatsMetrics) {\n+      metric.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+      addLeaf(metric);\n+    }\n+\n     Rca<ResourceFlowUnit> highHeapUsageOldGenRca = new HighHeapUsageOldGenRca(12, heapUsed, gcEvent,\n-        heapMax);\n+        heapMax, nodeStatsMetrics);\n     highHeapUsageOldGenRca.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n-    highHeapUsageOldGenRca.addAllUpstreams(Arrays.asList(heapUsed, gcEvent, heapMax));\n+    List<Node<?>> upstream = new ArrayList<>(Arrays.asList(heapUsed, gcEvent, heapMax));", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMjU4OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416222589", "bodyText": "not sure if typecast works here because Arrays.asList() can not be appended but we need to add a list of node stat metrics here as upstream.", "author": "rguo-aws", "createdAt": "2020-04-27T23:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MDQ2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\nindex 7933aa1c..e8349822 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n\n@@ -83,10 +83,6 @@ public class DummyGraph extends AnalysisGraph {\n \n     //add node stats metrics\n     List<Metric> nodeStatsMetrics = constructNodeStatsMetrics();\n-    for (Metric metric : nodeStatsMetrics) {\n-      metric.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n-      addLeaf(metric);\n-    }\n \n     Rca<ResourceFlowUnit> highHeapUsageOldGenRca = new HighHeapUsageOldGenRca(12, heapUsed, gcEvent,\n         heapMax, nodeStatsMetrics);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MDg3MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414170870", "bodyText": "We should consider extracting parts out of this method. Its growing in size :)", "author": "yojs", "createdAt": "2020-04-23T22:39:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java", "diffHunk": "@@ -65,10 +81,19 @@ public void construct() {\n     addLeaf(gc_Collection_Time);\n     addLeaf(cpuUtilizationGroupByOperation);\n \n+    //add node stats metrics", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTU5Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221593", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-27T23:37:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MDg3MA=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\nindex 7933aa1c..e8349822 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n\n@@ -83,10 +83,6 @@ public class DummyGraph extends AnalysisGraph {\n \n     //add node stats metrics\n     List<Metric> nodeStatsMetrics = constructNodeStatsMetrics();\n-    for (Metric metric : nodeStatsMetrics) {\n-      metric.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n-      addLeaf(metric);\n-    }\n \n     Rca<ResourceFlowUnit> highHeapUsageOldGenRca = new HighHeapUsageOldGenRca(12, heapUsed, gcEvent,\n         heapMax, nodeStatsMetrics);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MTMxMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414171312", "bodyText": "It would help to make the runPeriod constant so that we don't have to use the redundant 5 everywhere.", "author": "yojs", "createdAt": "2020-04-23T22:41:02Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java", "diffHunk": "@@ -95,4 +120,23 @@ public void construct() {\n     hotNodeClusterRca.addTag(TAG_LOCUS, LOCUS_MASTER_NODE);\n     hotNodeClusterRca.addAllUpstreams(Collections.singletonList(hotJVMNodeRca));\n   }\n+\n+  private List<Metric> constructNodeStatsMetrics() {\n+    List<Metric> nodeStatsMetrics = new ArrayList<Metric>() {{\n+      add(new Cache_FieldData_Size(5));", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMjc5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416222795", "bodyText": "As mentioned above, will address this in a separate PR.", "author": "rguo-aws", "createdAt": "2020-04-27T23:40:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE3MTMxMg=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\nindex 7933aa1c..e8349822 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/DummyGraph.java\n\n@@ -137,6 +133,10 @@ public class DummyGraph extends AnalysisGraph {\n       add(new Bitset_Memory(5));\n       add(new VersionMap_Memory(5));\n     }};\n+    for (Metric metric : nodeStatsMetrics) {\n+      metric.addTag(TAG_LOCUS, LOCUS_DATA_MASTER_NODE);\n+      addLeaf(metric);\n+    }\n     return nodeStatsMetrics;\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzIzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414197234", "bodyText": "It might make sense to typecast and keep it into a variable instead of typecasting it for each method call ?", "author": "yojs", "createdAt": "2020-04-23T23:46:34Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java", "diffHunk": "@@ -86,20 +86,18 @@\n         .getDataNodesDetails()) {\n       ImmutableList<ResourceFlowUnit> nodeStateList = currentMap.get(nodeDetails.getId());\n       if (nodeStateList != null) {\n-        int unhealthyOldGenCnt = 0;\n-        int unhealthyYoungGenCnt = 0;\n+        List<HotResourceSummary> oldGenSummaries = new ArrayList<>();\n+        List<HotResourceSummary> youngGenSummaries = new ArrayList<>();\n         for (ResourceFlowUnit flowUnit : nodeStateList) {\n           if (flowUnit.getResourceContext().getState() == Resources.State.UNHEALTHY) {\n             HotNodeSummary currentNodSummary = (HotNodeSummary) flowUnit.getResourceSummary();\n             for (GenericSummary resourceSummary : currentNodSummary.getNestedSummaryList()) {\n               if (resourceSummary instanceof HotResourceSummary) {", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTYyNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221626", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-27T23:37:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzIzNA=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\nindex 9275efb7..53d631b6 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n\n@@ -91,13 +91,14 @@ public class HighHeapUsageClusterRca extends Rca<ResourceFlowUnit> {\n         for (ResourceFlowUnit flowUnit : nodeStateList) {\n           if (flowUnit.getResourceContext().getState() == Resources.State.UNHEALTHY) {\n             HotNodeSummary currentNodSummary = (HotNodeSummary) flowUnit.getResourceSummary();\n-            for (GenericSummary resourceSummary : currentNodSummary.getNestedSummaryList()) {\n-              if (resourceSummary instanceof HotResourceSummary) {\n-                if (((HotResourceSummary) resourceSummary).getResourceType().getJVM() == JvmEnum.YOUNG_GEN) {\n-                  youngGenSummaries.add((HotResourceSummary) resourceSummary);\n+            for (GenericSummary genericSummary : currentNodSummary.getNestedSummaryList()) {\n+              if (genericSummary instanceof HotResourceSummary) {\n+                HotResourceSummary resourceSummary = (HotResourceSummary) genericSummary;\n+                if (resourceSummary.getResourceType().getJVM() == JvmEnum.YOUNG_GEN) {\n+                  youngGenSummaries.add(resourceSummary);\n                 }\n-                else if (((HotResourceSummary) resourceSummary).getResourceType().getJVM() == JvmEnum.OLD_GEN) {\n-                  oldGenSummaries.add((HotResourceSummary) resourceSummary);\n+                else if (resourceSummary.getResourceType().getJVM() == JvmEnum.OLD_GEN) {\n+                  oldGenSummaries.add(resourceSummary);\n                 }\n               }\n               else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMTQzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414201436", "bodyText": "If we only expect youngGenSummaries to have just one element, should we throw an IllegalStateException for that ?", "author": "yojs", "createdAt": "2020-04-23T23:58:02Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java", "diffHunk": "@@ -108,8 +106,15 @@ else if (((HotResourceSummary) resourceSummary).getResourceType().getJVM() == Jv\n             }\n           }\n         }\n-        if (unhealthyYoungGenCnt >= UNHEALTHY_FLOWUNIT_THRESHOLD || unhealthyOldGenCnt >= UNHEALTHY_FLOWUNIT_THRESHOLD) {\n-          unhealthyNodeList.add(nodeStateList.get(0).getResourceSummary());\n+        if (youngGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD || oldGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD) {\n+          HotNodeSummary nodeSummary = new HotNodeSummary(nodeDetails.getId(), nodeDetails.getHostAddress());\n+          if (youngGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD) {\n+            nodeSummary.addNestedSummaryList(youngGenSummaries.get(0));", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMzg5NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416223895", "bodyText": "youngGenSummaries can have multiple elements but we will only consider it as unhealthy if three consecutive summaries are all unhealthy and we will then pick the first element as the summary for output.", "author": "rguo-aws", "createdAt": "2020-04-27T23:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMTQzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyODM3Nw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416728377", "bodyText": "I see. Can we put the thoughts as code comments ?", "author": "yojs", "createdAt": "2020-04-28T15:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwMTQzNg=="}], "type": "inlineReview", "revised_code": {"commit": "1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\nindex 9275efb7..2c014d1a 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n\n@@ -106,6 +107,8 @@ public class HighHeapUsageClusterRca extends Rca<ResourceFlowUnit> {\n             }\n           }\n         }\n+        // youngGenSummaries can have multiple elements but we will only consider it as unhealthy if\n+        // three consecutive summaries are all unhealthy and we will then pick the first element as the summary for output.\n         if (youngGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD || oldGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD) {\n           HotNodeSummary nodeSummary = new HotNodeSummary(nodeDetails.getId(), nodeDetails.getHostAddress());\n           if (youngGenSummaries.size() >= UNHEALTHY_FLOWUNIT_THRESHOLD) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDQ1Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r414204452", "bodyText": "I am thinking we throw an exception and capture the stacktrace if this is unexpected ?", "author": "yojs", "createdAt": "2020-04-24T00:06:50Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java", "diffHunk": "@@ -170,15 +175,12 @@ public ResourceFlowUnit operate() {\n     }\n   }\n \n+  /**\n+   * This is a cluster level RCA vertex which by definition can not be serialize/de-serialized\n+   * over gRPC.\n+   */\n   @Override\n   public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n-    final List<FlowUnitMessage> flowUnitMessages =\n-        args.getWireHopper().readFromWire(args.getNode());\n-    List<ResourceFlowUnit> flowUnitList = new ArrayList<>();\n-    LOG.debug(\"rca: Executing fromWire: {}\", this.getClass().getSimpleName());\n-    for (FlowUnitMessage flowUnitMessage : flowUnitMessages) {\n-      flowUnitList.add(ResourceFlowUnit.buildFlowUnitFromWrapper(flowUnitMessage));\n-    }\n-    setFlowUnits(flowUnitList);\n+    LOG.error(\"RCA: {} should not be send over from network\", this.getClass().getSimpleName());", "originalCommit": "915f207bc781a95cb7def885d2f41c99af9d5a2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyMTY5MA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416221690", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-27T23:37:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDQ1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\nindex 9275efb7..53d631b6 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/HighHeapUsageClusterRca.java\n\n@@ -181,6 +182,7 @@ public class HighHeapUsageClusterRca extends Rca<ResourceFlowUnit> {\n    */\n   @Override\n   public void generateFlowUnitListFromWire(FlowUnitOperationArgWrapper args) {\n-    LOG.error(\"RCA: {} should not be send over from network\", this.getClass().getSimpleName());\n+    throw new IllegalArgumentException(name() + \"'s generateFlowUnitListFromWire() should not \"\n+        + \"be required.\");\n   }\n }\n"}}, {"oid": "f87df926c8b8c706f306c96b9fa35cb77251e2d4", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f87df926c8b8c706f306c96b9fa35cb77251e2d4", "message": "Add rca settings into rca.conf", "committedDate": "2020-04-27T23:34:52Z", "type": "commit"}, {"oid": "21bddab473614668f65dae0a6b232f10db66abf1", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/21bddab473614668f65dae0a6b232f10db66abf1", "message": "Merge branch 'master' into rguo-node-stat", "committedDate": "2020-04-27T23:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NjcwMg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416266702", "bodyText": "Can we use a class instead of hashmap?", "author": "aadithya", "createdAt": "2020-04-28T01:45:43Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConfJsonWrapper.java", "diffHunk": "@@ -36,6 +36,7 @@\n   private final String analysisGraphEntryPoint;\n   private final int networkQueueLength;\n   private final int perVertexBufferLength;\n+  private final Map<String, String> highHeapUsageOldGenRcaSettings;", "originalCommit": "21bddab473614668f65dae0a6b232f10db66abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNTQ4Mg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416725482", "bodyText": "+1", "author": "yojs", "createdAt": "2020-04-28T15:49:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NjcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgwNDY4NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416804684", "bodyText": "done. Added a class HighHeapUsageOldGenRcaConfig", "author": "rguo-aws", "createdAt": "2020-04-28T17:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2NjcwMg=="}], "type": "inlineReview", "revised_code": {"commit": "1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConfJsonWrapper.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConfJsonWrapper.java\nindex 830406cd..0d9bb416 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConfJsonWrapper.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/core/ConfJsonWrapper.java\n\n@@ -36,7 +37,7 @@ class ConfJsonWrapper {\n   private final String analysisGraphEntryPoint;\n   private final int networkQueueLength;\n   private final int perVertexBufferLength;\n-  private final Map<String, String> highHeapUsageOldGenRcaSettings;\n+  private final HighHeapUsageOldGenRcaConfig highHeapUsageOldGenRcaConfig;\n \n   String getRcaStoreLoc() {\n     return rcaStoreLoc;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDk1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416724953", "bodyText": "Should we make this warning ?", "author": "yojs", "createdAt": "2020-04-28T15:49:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/Metric.java", "diffHunk": "@@ -75,6 +75,8 @@ public MetricFlowUnit gather(Queryable queryable) {\n     } catch (DataAccessException dex) {\n       // This can happen if the RCA started querying for metrics before the Reader obtained them.\n       // This is not an error.\n+      // And node stats metrics can be enabled/disabled on writer side so we might end up being here\n+      // if RCA is trying to read node stats which are not enabled yet.\n       LOG.info(\"Looking for metric {}, when it does not exist.\", name);", "originalCommit": "21bddab473614668f65dae0a6b232f10db66abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgwNDc3NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416804775", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-28T17:44:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjcyNDk1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/Metric.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/Metric.java\nindex 3cd75753..f0223f93 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/Metric.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/Metric.java\n\n@@ -77,7 +77,7 @@ public abstract class Metric extends LeafNode<MetricFlowUnit> {\n       // This is not an error.\n       // And node stats metrics can be enabled/disabled on writer side so we might end up being here\n       // if RCA is trying to read node stats which are not enabled yet.\n-      LOG.info(\"Looking for metric {}, when it does not exist.\", name);\n+      LOG.warn(\"Looking for metric {}, when it does not exist.\", name);\n     } catch (Exception e) {\n       PerformanceAnalyzerApp.ERRORS_AND_EXCEPTIONS_AGGREGATOR.updateStat(\n           ExceptionsAndErrors.EXCEPTION_IN_GATHER, name(), 1);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjczMjQyNQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416732425", "bodyText": "Fail to read parse node stats -> Failed to parse node stats ?", "author": "yojs", "createdAt": "2020-04-28T15:58:50Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotheap;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.metricsdb.MetricsDB;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.Metric;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.api.flow_units.MetricFlowUnit;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.store.rca.hotshard.IndexShardKey;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.jooq.Record;\n+import org.jooq.Result;\n+\n+/**\n+ * We've seen huge performance impact if collecting node stats across all shards on data node.\n+ * So Performance Analyzer writer will only try to collect node stats from a small portion of\n+ * shards at a time to reduce performance impact. This class on reader side will allow us to\n+ * keep track of node stat from all previous batches and calculate its sum.\n+ */\n+public class NodeStatAggregator {\n+\n+  private static final Logger LOG = LogManager.getLogger(NodeStatAggregator.class);\n+  private Metric nodeStatMetric;\n+  private int sum;\n+  private final HashMap<IndexShardKey, NodeStatValue> shardKeyMap;\n+  private long lastPurgeTimestamp;\n+  //purge the hash table every 30 mins\n+  private static final int PURGE_HASH_TABLE_INTERVAL_IN_MINS = 30;\n+\n+\n+  public NodeStatAggregator(Metric nodeStatMetric) {\n+    this.nodeStatMetric = nodeStatMetric;\n+    this.sum = 0;\n+    this.lastPurgeTimestamp = 0L;\n+    this.shardKeyMap = new HashMap<>();\n+  }\n+\n+  /**\n+   * Whether this NodeStatAggregator contains valid node stats from writer\n+   * This is to avoid reading stale data when the node stats has already been\n+   * disabled from writer side\n+   * @return if it has valid node stats\n+   */\n+  public boolean isEmpty() {\n+    return shardKeyMap.isEmpty();\n+  }\n+\n+  /**\n+   * get the name of node stat metric.\n+   * i.e. Norms_Memory, Cache_FieldData_Size, etc.\n+   * @return name of node stat metric\n+   */\n+  public String getName() {\n+    return nodeStatMetric.name();\n+  }\n+\n+  /**\n+   * get the sum of node stat metric across all shards on this node\n+   * @return sum of node stat metric\n+   */\n+  public int getSum() {\n+    return this.sum;\n+  }\n+\n+  /**\n+   * call this method to collect node stats of each shard from node stat metric\n+   * and calculate its sum.\n+   * @param timestamp current timestamp when collecting from metricDB\n+   */\n+  public void collect(final long timestamp) {\n+    for (MetricFlowUnit metric : nodeStatMetric.getFlowUnits()) {\n+      if (metric.isEmpty()) {\n+        continue;\n+      }\n+      Result<Record> result = metric.getData();\n+      for (Record record : result) {\n+        try {\n+          IndexShardKey shardKey = IndexShardKey.buildIndexShardKey(record);\n+          Integer value = record.getValue(MetricsDB.MAX, Integer.class);\n+          NodeStatValue oldNodeStatValue = shardKeyMap.getOrDefault(shardKey, new NodeStatValue(0, 0));\n+          shardKeyMap.put(shardKey, new NodeStatValue(value, timestamp));\n+          this.sum += (value - oldNodeStatValue.getValue());\n+        }\n+        catch (Exception e) {\n+          LOG.error(\"Fail to read parse node stats {}\", this.getName());", "originalCommit": "21bddab473614668f65dae0a6b232f10db66abf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjgwNDg2OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/156#discussion_r416804869", "bodyText": "done", "author": "rguo-aws", "createdAt": "2020-04-28T17:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjczMjQyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\nindex 26c87944..fdff4f10 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/rca/hotheap/NodeStatAggregator.java\n\n@@ -83,7 +83,7 @@ public class NodeStatAggregator {\n           this.sum += (value - oldNodeStatValue.getValue());\n         }\n         catch (Exception e) {\n-          LOG.error(\"Fail to read parse node stats {}\", this.getName());\n+          LOG.error(\"Fail to parse node stats {}\", this.getName());\n         }\n       }\n     }\n"}}, {"oid": "1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/1e8830f8fc10945d8a6b6cc5d06ded6dc3660c58", "message": "Add config object for old gen RCA", "committedDate": "2020-04-28T17:42:44Z", "type": "commit"}]}