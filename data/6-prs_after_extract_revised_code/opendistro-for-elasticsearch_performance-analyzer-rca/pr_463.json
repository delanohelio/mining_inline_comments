{"pr_number": 463, "pr_title": "Make JvmActionsAlarmMonitor persistable", "pr_createdAt": "2020-10-09T22:35:14Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/463", "timeline": [{"oid": "b382da17144b4267b0b0358695ebd5b246203502", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b382da17144b4267b0b0358695ebd5b246203502", "message": "Make JvmActionsAlarmMonitor persistable\n\n- BucketizedSlidingWindow now extends PersistableSlidingWindow which\nmeans it can write and load window data from a file on disk\n- JvmActionsAlarmMonitor has a new constructor that will allow its data\nto be written to and loaded from the disk", "committedDate": "2020-10-09T22:35:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNTgzMw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/463#discussion_r503425833", "bodyText": "You need to close the stream here after flushing. You can use a try-with-resources block so that it gets autoclosed after using.", "author": "ktkrg", "createdAt": "2020-10-12T17:05:55Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java", "diffHunk": "@@ -94,5 +110,6 @@ protected synchronized void write() throws IOException {\n     writer.flush();", "originalCommit": "b382da17144b4267b0b0358695ebd5b246203502", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyODQwOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/463#discussion_r503428409", "bodyText": "Good catch, done", "author": "sidheart", "createdAt": "2020-10-12T17:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyNTgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "884766727f1d0d0900905ddf7d17b15400ca27b7", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\nindex 1c0203f3..ab52325f 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/api/aggregators/PersistableSlidingWindow.java\n\n@@ -100,16 +100,17 @@ public class PersistableSlidingWindow extends SlidingWindow<SlidingWindowData> {\n     String tmpFile = pathToFile.toString();\n     Path tmpPath = Paths.get(tmpFile);\n     Files.createFile(Paths.get(tmpFile));\n-    BufferedWriter writer = new BufferedWriter(new FileWriter(tmpFile, false));\n-    Iterator<SlidingWindowData> it = windowDeque.descendingIterator();\n-    while (it.hasNext()) {\n-      writer.write(objectMapper.writeValueAsString(it.next()));\n-      writer.write(System.lineSeparator());\n+    try (BufferedWriter writer = new BufferedWriter(new FileWriter(tmpFile, false))) {\n+      Iterator<SlidingWindowData> it = windowDeque.descendingIterator();\n+      while (it.hasNext()) {\n+        writer.write(objectMapper.writeValueAsString(it.next()));\n+        writer.write(System.lineSeparator());\n+      }\n+      // write to temporary file\n+      writer.flush();\n+      // atomic rotate\n+      FileRotate.rotateFile(tmpPath, pathToFile);\n+      lastWriteTimeEpochMs = Instant.now().toEpochMilli();\n     }\n-    // write to temporary file\n-    writer.flush();\n-    // atomic rotate\n-    FileRotate.rotateFile(tmpPath, pathToFile);\n-    lastWriteTimeEpochMs = Instant.now().toEpochMilli();\n   }\n }\n"}}, {"oid": "884766727f1d0d0900905ddf7d17b15400ca27b7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/884766727f1d0d0900905ddf7d17b15400ca27b7", "message": "Make JvmActionsAlarmMonitor persistable\n\n- BucketizedSlidingWindow now extends PersistableSlidingWindow which\nmeans it can write and load window data from a file on disk\n- JvmActionsAlarmMonitor has a new constructor that will allow its data\nto be written to and loaded from the disk", "committedDate": "2020-10-12T17:10:22Z", "type": "commit"}, {"oid": "884766727f1d0d0900905ddf7d17b15400ca27b7", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/884766727f1d0d0900905ddf7d17b15400ca27b7", "message": "Make JvmActionsAlarmMonitor persistable\n\n- BucketizedSlidingWindow now extends PersistableSlidingWindow which\nmeans it can write and load window data from a file on disk\n- JvmActionsAlarmMonitor has a new constructor that will allow its data\nto be written to and loaded from the disk", "committedDate": "2020-10-12T17:10:22Z", "type": "forcePushed"}]}