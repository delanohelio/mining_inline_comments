{"pr_number": 321, "pr_title": "Fix failures in ResourceHeatMapGraphTest", "pr_createdAt": "2020-07-30T16:53:04Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321", "timeline": [{"oid": "77d0b3d43398d770c2175648f49d7d8a09defb63", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/77d0b3d43398d770c2175648f49d7d8a09defb63", "message": "Fix failures in ResourceHeatMapGraphTest\n\nWhen ResourceHeatMapGraphTest was run after\nPerformanceAnalyzerWebServerTest, we noticed connection refused\nexceptions that didn't happen when the tests were run in isolation.\n\nThis commit makes sure that PerformanceAnalyzerWebServerTest cleans up\nafter itself so that subsequent tests will run as expected.", "committedDate": "2020-07-30T16:50:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NjQ3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463146473", "bodyText": "Are we trying to restore oldBindHost to some default value here? If so, should it be done in setUp() ?\nSame for others.", "author": "vigyasharma", "createdAt": "2020-07-30T17:10:14Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/PerformanceAnalyzerWebServerTest.java", "diffHunk": "@@ -70,9 +70,13 @@ public void tearDown() {\n         // Unset all SSL settings\n         if (oldBindHost != null) {\n             PluginSettings.instance().overrideProperty(PerformanceAnalyzerWebServer.WEBSERVICE_BIND_HOST_NAME, oldBindHost);\n+        } else {\n+            PluginSettings.instance().overrideProperty(PerformanceAnalyzerWebServer.WEBSERVICE_BIND_HOST_NAME, \"localhost\");", "originalCommit": "77d0b3d43398d770c2175648f49d7d8a09defb63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NzYzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463147636", "bodyText": "Ah wait, this is for across tests. Got it.", "author": "vigyasharma", "createdAt": "2020-07-30T17:12:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NjQ3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODk3Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463148973", "bodyText": "Let's take oldBindHost as an example. If oldBindHost is null then after this test class ran, we would previously keep the value that PerformanceAnalyzerWebServer changed WEBSERVICE_BIND_HOST_NAME to. This could lead to other tests failing.\nThe reason this runs as part of a tearDown is to make sure that everything is reset after the test class finishes running.", "author": "sidheart", "createdAt": "2020-07-30T17:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NjQ3Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0Nzk1OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463147958", "bodyText": "Why is this sleep needed?", "author": "vigyasharma", "createdAt": "2020-07-30T17:12:56Z", "path": "src/test/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/store/ResourceHeatMapGraphTest.java", "diffHunk": "@@ -151,6 +150,12 @@ public static void shutdown() {\n     clientServers.getHttpServer().stop(0);\n     clientServers.getNetServer().stop();\n     clientServers.getNetClient().stop();\n+\n+    try {\n+      Thread.sleep(1000);", "originalCommit": "77d0b3d43398d770c2175648f49d7d8a09defb63", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzOTg1OQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463239859", "bodyText": "It isn't strictly necessary, I'm mimicking similar logic from RcaControllerTest which does this sleep after stopping its clients and servers.", "author": "sidheart", "createdAt": "2020-07-30T20:03:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0Nzk1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI1MTkzNA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/321#discussion_r463251934", "bodyText": "nit: Maybe it\u2019s a good idea to abstract the shutdown logic with sleep into its own method so that we don\u2019t have to carry the sleep change wherever we use shutdown?", "author": "ktkrg", "createdAt": "2020-07-30T20:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0Nzk1OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d5182ca55c2ab8a76d895f46ae23204d3befdc95", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/d5182ca55c2ab8a76d895f46ae23204d3befdc95", "message": "Remove Assert.fail() calls from ResourceHeatMapGraphTest\n\nCalls to Assert.fail() obscure the actual Exception in our testing logs.\n\nThis commit removes the fail() calls and simply throws instead.", "committedDate": "2020-07-30T17:24:33Z", "type": "commit"}]}