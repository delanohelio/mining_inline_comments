{"pr_number": 433, "pr_title": "Persist published actions in sqlite", "pr_createdAt": "2020-09-22T21:42:57Z", "pr_url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433", "timeline": [{"oid": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "message": "Persist actions in sqlite", "committedDate": "2020-09-22T21:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMDc0NQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493100745", "bodyText": "It might be a good idea to add javadocs for all public methods.", "author": "yojs", "createdAt": "2020-09-23T00:08:05Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -55,7 +56,11 @@ public Publisher(int evalIntervalSeconds, Collator collator) {\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Need to add dampening, avoidance, state persistence etc.\n+    return new EmptyFlowUnit(Instant.now().toEpochMilli());\n+  }\n+\n+  public void compute(FlowUnitOperationArgWrapper args) {", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEyMDgzMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493120831", "bodyText": "Added javadoc", "author": "sruti1312", "createdAt": "2020-09-23T01:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMDc0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b093a7e79b2e5a160fc1b18be56dd04452e081f6", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\nindex 67457abe..e5393c0b 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\n\n@@ -59,19 +59,24 @@ public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n     return new EmptyFlowUnit(Instant.now().toEpochMilli());\n   }\n \n+  /**\n+   * Publish the decisions to action listeners and persist actions.\n+   */\n   public void compute(FlowUnitOperationArgWrapper args) {\n     // TODO: Need to add dampening, avoidance etc.\n-    Decision decision = collator.getFlowUnits().get(0);\n-    for (Action action : decision.getActions()) {\n-      if (coolOffDetector.isCooledOff(action) && !flipFlopDetector.isFlipFlop(action)) {\n-        flipFlopDetector.recordAction(action);\n-        coolOffDetector.recordAction(action);\n-        for (ActionListener listener : actionListeners) {\n-          listener.actionPublished(action);\n+    if (!collator.getFlowUnits().isEmpty()) {\n+      Decision decision = collator.getFlowUnits().get(0);\n+      for (Action action : decision.getActions()) {\n+        if (coolOffDetector.isCooledOff(action) && !flipFlopDetector.isFlipFlop(action)) {\n+          flipFlopDetector.recordAction(action);\n+          coolOffDetector.recordAction(action);\n+          for (ActionListener listener : actionListeners) {\n+            listener.actionPublished(action);\n+          }\n+          // Persist actions to sqlite\n+          PublisherEventsPersistor persistor = new PublisherEventsPersistor(args.getPersistable());\n+          persistor.persistAction(action);\n         }\n-        // Persist actions to sqlite\n-        PublisherEventsPersistor persistor = new PublisherEventsPersistor(args.getPersistable());\n-        persistor.persistAction(action);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMDk3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493100978", "bodyText": "Maybe we want to verify that the size is 1 ?", "author": "yojs", "createdAt": "2020-09-23T00:08:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java", "diffHunk": "@@ -55,7 +56,11 @@ public Publisher(int evalIntervalSeconds, Collator collator) {\n \n   @Override\n   public EmptyFlowUnit operate() {\n-    // TODO: Need to add dampening, avoidance, state persistence etc.\n+    return new EmptyFlowUnit(Instant.now().toEpochMilli());\n+  }\n+\n+  public void compute(FlowUnitOperationArgWrapper args) {\n+    // TODO: Need to add dampening, avoidance etc.\n     Decision decision = collator.getFlowUnits().get(0);", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExNzYzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493117636", "bodyText": "Added a check.", "author": "sruti1312", "createdAt": "2020-09-23T01:11:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMDk3OA=="}], "type": "inlineReview", "revised_code": {"commit": "b093a7e79b2e5a160fc1b18be56dd04452e081f6", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\nindex 67457abe..e5393c0b 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/decisionmaker/deciders/Publisher.java\n\n@@ -59,19 +59,24 @@ public class Publisher extends NonLeafNode<EmptyFlowUnit> {\n     return new EmptyFlowUnit(Instant.now().toEpochMilli());\n   }\n \n+  /**\n+   * Publish the decisions to action listeners and persist actions.\n+   */\n   public void compute(FlowUnitOperationArgWrapper args) {\n     // TODO: Need to add dampening, avoidance etc.\n-    Decision decision = collator.getFlowUnits().get(0);\n-    for (Action action : decision.getActions()) {\n-      if (coolOffDetector.isCooledOff(action) && !flipFlopDetector.isFlipFlop(action)) {\n-        flipFlopDetector.recordAction(action);\n-        coolOffDetector.recordAction(action);\n-        for (ActionListener listener : actionListeners) {\n-          listener.actionPublished(action);\n+    if (!collator.getFlowUnits().isEmpty()) {\n+      Decision decision = collator.getFlowUnits().get(0);\n+      for (Action action : decision.getActions()) {\n+        if (coolOffDetector.isCooledOff(action) && !flipFlopDetector.isFlipFlop(action)) {\n+          flipFlopDetector.recordAction(action);\n+          coolOffDetector.recordAction(action);\n+          for (ActionListener listener : actionListeners) {\n+            listener.actionPublished(action);\n+          }\n+          // Persist actions to sqlite\n+          PublisherEventsPersistor persistor = new PublisherEventsPersistor(args.getPersistable());\n+          persistor.persistAction(action);\n         }\n-        // Persist actions to sqlite\n-        PublisherEventsPersistor persistor = new PublisherEventsPersistor(args.getPersistable());\n-        persistor.persistAction(action);\n       }\n     }\n   }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwMTkwMQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493101901", "bodyText": "Awesome ! Thanks for adding these metrics", "author": "yojs", "createdAt": "2020-09-23T00:11:59Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/framework/metrics/RcaRuntimeMetrics.java", "diffHunk": "@@ -43,7 +43,12 @@\n    * Metric tracking if RCA is enabled or disabled. We write a 0 if RCA is disabled and 1 if it is\n    * enabled.\n    */\n-  RCA_ENABLED(\"RcaEnabled\", \"count\", Collections.singletonList(Statistics.SAMPLE));\n+  RCA_ENABLED(\"RcaEnabled\", \"count\", Collections.singletonList(Statistics.SAMPLE)),\n+\n+  /**\n+   * Metric tracking the actions published by the publisher that are persisted in sqlite.\n+   */\n+  ACTIONS_PUBLISHED(\"ActionsPublished\", \"namedCount\", Collections.singletonList(Statistics.NAMED_COUNTERS));", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNzI3OA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493107278", "bodyText": "Maybe this.name() is a redundant dimension for this metric as it does not change from action to action. Do we want to capture the name of the Action we wanted to persist ?", "author": "yojs", "createdAt": "2020-09-23T00:31:57Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.PerformanceAnalyzerApp;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.ExceptionsAndErrors;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaRuntimeMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import java.time.Instant;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * A listener that persists all actions published by the publisher to rca.sqlite\n+ */\n+public class PublisherEventsPersistor {\n+    public static final String NAME = \"publisher_events_persistor\";\n+    private static final Logger LOG = LogManager.getLogger(PublisherEventsPersistor.class);\n+\n+    private final Persistable persistable;\n+\n+    public PublisherEventsPersistor(final Persistable persistable) {\n+        this.persistable = persistable;\n+    }\n+\n+    public void persistAction(final Action action) {\n+        long timestamp = Instant.now().toEpochMilli();\n+        if (persistable != null) {\n+            LOG.debug(\"Action: [{}] published to persistor publisher.\", action.name());\n+            PerformanceAnalyzerApp.RCA_RUNTIME_METRICS_AGGREGATOR.updateStat(\n+                    RcaRuntimeMetrics.ACTIONS_PUBLISHED, action.name(), 1);\n+            if (action.impactedNodes() != null) {\n+                final String nodeIds = action.impactedNodes().stream()\n+                                        .map(n -> n.getNodeId().toString())\n+                                        .collect(Collectors.joining(\",\", \"{\", \"}\"));\n+                final String nodeIps = action.impactedNodes().stream()\n+                                         .map(n -> n.getHostAddress().toString())\n+                                         .collect(Collectors.joining(\",\", \"{\", \"}\"));\n+                final PersistedAction actionsSummary = new PersistedAction();\n+                actionsSummary.setActionName(action.name());\n+                actionsSummary.setNodeIds(nodeIds);\n+                actionsSummary.setNodeIps(nodeIps);\n+                actionsSummary.setActionable(action.isActionable());\n+                actionsSummary.setCoolOffPeriod(action.coolOffPeriodInMillis());\n+                actionsSummary.setMuted(action.isMuted());\n+                actionsSummary.setSummary(action.summary());\n+                actionsSummary.setTimestamp(timestamp);\n+                try {\n+                    persistable.write(actionsSummary);\n+                } catch (Exception e) {\n+                    LOG.error(\"Unable to write publisher events to sqlite\", e);\n+                    PerformanceAnalyzerApp.ERRORS_AND_EXCEPTIONS_AGGREGATOR.updateStat(\n+                            ExceptionsAndErrors.EXCEPTION_IN_PERSIST, this.name(), 1);", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExNzExOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493117119", "bodyText": "Right. Modified.", "author": "sruti1312", "createdAt": "2020-09-23T01:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwNzI3OA=="}], "type": "inlineReview", "revised_code": {"commit": "b093a7e79b2e5a160fc1b18be56dd04452e081f6", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\nindex 31cd4ae1..5e4c9450 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\n\n@@ -21,6 +21,7 @@ import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.met\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaRuntimeMetrics;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n import java.time.Instant;\n+import java.util.Objects;\n import java.util.stream.Collectors;\n \n import org.apache.logging.log4j.LogManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTE1NA==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493109154", "bodyText": "Because persistable is assigned in the constructor and this is declared final, maybe we can do something like Objects.requireNonNull in the constructor and remove the if else here ?", "author": "yojs", "createdAt": "2020-09-23T00:39:12Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.PerformanceAnalyzerApp;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.decisionmaker.actions.Action;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.ExceptionsAndErrors;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaRuntimeMetrics;\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n+import java.time.Instant;\n+import java.util.stream.Collectors;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * A listener that persists all actions published by the publisher to rca.sqlite\n+ */\n+public class PublisherEventsPersistor {\n+    public static final String NAME = \"publisher_events_persistor\";\n+    private static final Logger LOG = LogManager.getLogger(PublisherEventsPersistor.class);\n+\n+    private final Persistable persistable;\n+\n+    public PublisherEventsPersistor(final Persistable persistable) {\n+        this.persistable = persistable;\n+    }\n+\n+    public void persistAction(final Action action) {\n+        long timestamp = Instant.now().toEpochMilli();\n+        if (persistable != null) {", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExNzAzNg==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493117036", "bodyText": "Right. Modified.", "author": "sruti1312", "createdAt": "2020-09-23T01:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzEwOTE1NA=="}], "type": "inlineReview", "revised_code": {"commit": "b093a7e79b2e5a160fc1b18be56dd04452e081f6", "chunk": "diff --git a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\nindex 31cd4ae1..5e4c9450 100644\n--- a/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\n+++ b/src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/PublisherEventsPersistor.java\n\n@@ -21,6 +21,7 @@ import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.met\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.framework.metrics.RcaRuntimeMetrics;\n import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions.PersistedAction;\n import java.time.Instant;\n+import java.util.Objects;\n import java.util.stream.Collectors;\n \n import org.apache.logging.log4j.LogManager;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMTQ1Mw==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493111453", "bodyText": "nit: should we make this a nested static class in PublisherEventsPersistor ?", "author": "vigyasharma", "createdAt": "2020-09-23T00:48:08Z", "path": "src/main/java/com/amazon/opendistro/elasticsearch/performanceanalyzer/rca/persistence/actions/PersistedAction.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.actions;\n+\n+import com.amazon.opendistro.elasticsearch.performanceanalyzer.rca.persistence.ValueColumn;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+/**\n+ * Action summary that can be persisted in SQL\n+ *\n+ * <p>Table name : PersistedAction\n+ *\n+ * <p>schema :\n+ * | id(primary key) |     actionName       |   timestamp       |       nodeIds          |\n+ * |      1          | ModifyQueueCapacity  |  1599257910923    |   node1, node2         |\n+ * |        nodeIps         | actionable | coolOffPeriod    |  muted    |   summary         |\n+ * | 127.0.0.1, 127.0.0.2   |  1         |  300             |   0       | actionSummary     |\n+ */\n+public class PersistedAction {", "originalCommit": "f0e83e4e111edcbdcdd275ecc5cd6d63200c4273", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExNjEyOQ==", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/pull/433#discussion_r493116129", "bodyText": "During read(), the persistable (object used to persist things in sqlite) needs this class as it returns s Class type object.\nIt is better to have this to support write and read.", "author": "sruti1312", "createdAt": "2020-09-23T01:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzExMTQ1Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b093a7e79b2e5a160fc1b18be56dd04452e081f6", "url": "https://github.com/opendistro-for-elasticsearch/performance-analyzer-rca/commit/b093a7e79b2e5a160fc1b18be56dd04452e081f6", "message": "Address PR comments", "committedDate": "2020-09-23T01:23:06Z", "type": "commit"}]}