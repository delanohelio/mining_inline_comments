{"pr_number": 834, "pr_title": "Initial jooq flyway commit to connect to job activity", "pr_createdAt": "2020-04-02T05:01:53Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/834", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMTY0NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/834#discussion_r402431644", "bodyText": "This code is duplicated (we should call into RdsUtil added below).", "author": "tbak", "createdAt": "2020-04-02T16:05:58Z", "path": "titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RDSSSLSocketFactory.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.ext.jooqflyway.jobactivity;\n+\n+import java.io.InputStream;\n+import java.security.KeyStore;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.TrustManagerFactory;\n+\n+import org.postgresql.ssl.WrappedFactory;\n+\n+public class RDSSSLSocketFactory extends WrappedFactory {\n+    public RDSSSLSocketFactory() {\n+        try {\n+            KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());", "originalCommit": "d7b7b770770f143b765b2f0165a03106759b8097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU5ODQ4Nw==", "url": "https://github.com/Netflix/titus-control-plane/pull/834#discussion_r412598487", "bodyText": "fixed it.", "author": "amitaekbote", "createdAt": "2020-04-22T01:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMTY0NA=="}], "type": "inlineReview", "revised_code": {"commit": "385efd5a3d6bc2064394b6a810efb3816fc6f7ec", "chunk": "diff --git a/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RDSSSLSocketFactory.java b/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RDSSSLSocketFactory.java\ndeleted file mode 100644\nindex 125d43ef1..000000000\n--- a/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RDSSSLSocketFactory.java\n+++ /dev/null\n\n@@ -1,42 +0,0 @@\n-/*\n- * Copyright 2020 Netflix, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.netflix.titus.ext.jooqflyway.jobactivity;\n-\n-import java.io.InputStream;\n-import java.security.KeyStore;\n-import javax.net.ssl.SSLContext;\n-import javax.net.ssl.TrustManagerFactory;\n-\n-import org.postgresql.ssl.WrappedFactory;\n-\n-public class RDSSSLSocketFactory extends WrappedFactory {\n-    public RDSSSLSocketFactory() {\n-        try {\n-            KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n-            try (InputStream inputStream = RdsUtils.class.getClassLoader().getResourceAsStream(\"RDS-2019.truststore\")) {\n-                trustStore.load(inputStream, \"titus124\".toCharArray());\n-            }\n-            TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n-            tmf.init(trustStore);\n-            SSLContext sslContext = SSLContext.getInstance(\"TLS\");\n-            sslContext.init(null, tmf.getTrustManagers(), null);\n-            _factory = sslContext.getSocketFactory();\n-        } catch (Exception e) {\n-            throw new IllegalStateException(\"Cannot initialize RDS socket factory\", e);\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMjUzNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/834#discussion_r402432534", "bodyText": "For security reason, we should allow injecting the truststore file name and the password here. Thus internally we can use a different file, and a different (ideally encrypted) password.", "author": "tbak", "createdAt": "2020-04-02T16:07:17Z", "path": "titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RdsUtils.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.ext.jooqflyway.jobactivity;\n+\n+import java.io.InputStream;\n+import java.security.KeyStore;\n+import javax.net.ssl.SSLContext;\n+import javax.net.ssl.SSLSocketFactory;\n+import javax.net.ssl.TrustManagerFactory;\n+\n+public final class RdsUtils {\n+    /**\n+     * Setting as a constant as it is not critical.\n+     */\n+    private static final String TRUST_STORE_PASSWORD = \"titus123\";\n+\n+    public static SSLSocketFactory createRdsSSLSocketFactory() {\n+        try {\n+            KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+            try (InputStream inputStream = RdsUtils.class.getClassLoader().getResourceAsStream(\"RDS-2019.truststore\")) {", "originalCommit": "d7b7b770770f143b765b2f0165a03106759b8097", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzNDM4NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/834#discussion_r402434385", "bodyText": "We should reference the attached truststure in this repo for running the integration tests only.", "author": "tbak", "createdAt": "2020-04-02T16:09:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMjUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU5ODcxMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/834#discussion_r412598712", "bodyText": "will fix this in the following pr, finally able to test this. was fighting gradle builds. definitely needs more work here", "author": "amitaekbote", "createdAt": "2020-04-22T01:18:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQzMjUzNA=="}], "type": "inlineReview", "revised_code": {"commit": "385efd5a3d6bc2064394b6a810efb3816fc6f7ec", "chunk": "diff --git a/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RdsUtils.java b/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RdsUtils.java\ndeleted file mode 100644\nindex bd2ff9e9a..000000000\n--- a/titus-ext/jooqflyway/src/main/java/com/netflix/titus/ext/jooqflyway/jobactivity/RdsUtils.java\n+++ /dev/null\n\n@@ -1,46 +0,0 @@\n-/*\n- * Copyright 2020 Netflix, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.netflix.titus.ext.jooqflyway.jobactivity;\n-\n-import java.io.InputStream;\n-import java.security.KeyStore;\n-import javax.net.ssl.SSLContext;\n-import javax.net.ssl.SSLSocketFactory;\n-import javax.net.ssl.TrustManagerFactory;\n-\n-public final class RdsUtils {\n-    /**\n-     * Setting as a constant as it is not critical.\n-     */\n-    private static final String TRUST_STORE_PASSWORD = \"titus123\";\n-\n-    public static SSLSocketFactory createRdsSSLSocketFactory() {\n-        try {\n-            KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());\n-            try (InputStream inputStream = RdsUtils.class.getClassLoader().getResourceAsStream(\"RDS-2019.truststore\")) {\n-                trustStore.load(inputStream, TRUST_STORE_PASSWORD.toCharArray());\n-            }\n-            TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n-            tmf.init(trustStore);\n-            SSLContext sslContext = SSLContext.getInstance(\"TLS\");\n-            sslContext.init(null, tmf.getTrustManagers(), null);\n-            return sslContext.getSocketFactory();\n-        } catch (Exception e) {\n-            throw new IllegalStateException(\"Cannot initialize RDS socket factory\", e);\n-        }\n-    }\n-}\n"}}, {"oid": "385efd5a3d6bc2064394b6a810efb3816fc6f7ec", "url": "https://github.com/Netflix/titus-control-plane/commit/385efd5a3d6bc2064394b6a810efb3816fc6f7ec", "message": "Update api", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "5bbc638696406c47bd0a743d23b44d1970b03ebc", "url": "https://github.com/Netflix/titus-control-plane/commit/5bbc638696406c47bd0a743d23b44d1970b03ebc", "message": "Connecting to db", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "065f389d85a76cee4864cca19bd488d917ead710", "url": "https://github.com/Netflix/titus-control-plane/commit/065f389d85a76cee4864cca19bd488d917ead710", "message": "Updating versions", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "fe985b4bf813f133be720d7c37f0ecff6deb66e7", "url": "https://github.com/Netflix/titus-control-plane/commit/fe985b4bf813f133be720d7c37f0ecff6deb66e7", "message": "Making db connections work", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "8418f7d146c7f3262c7a48c2774cd3703de9fc15", "url": "https://github.com/Netflix/titus-control-plane/commit/8418f7d146c7f3262c7a48c2774cd3703de9fc15", "message": "logs", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "dc385c7b1bf089a4a46e956fd08ef40808151b63", "url": "https://github.com/Netflix/titus-control-plane/commit/dc385c7b1bf089a4a46e956fd08ef40808151b63", "message": "fixing errors, burnt by local cache", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "5d297ea677c304244de115434f25648950e32e29", "url": "https://github.com/Netflix/titus-control-plane/commit/5d297ea677c304244de115434f25648950e32e29", "message": "Fixing error with sslContext", "committedDate": "2020-04-16T03:52:52Z", "type": "commit"}, {"oid": "5d297ea677c304244de115434f25648950e32e29", "url": "https://github.com/Netflix/titus-control-plane/commit/5d297ea677c304244de115434f25648950e32e29", "message": "Fixing error with sslContext", "committedDate": "2020-04-16T03:52:52Z", "type": "forcePushed"}, {"oid": "59d4c8723c9357d8e5abf3b8b32823404e449a71", "url": "https://github.com/Netflix/titus-control-plane/commit/59d4c8723c9357d8e5abf3b8b32823404e449a71", "message": "Spring version conflict", "committedDate": "2020-04-21T04:29:30Z", "type": "commit"}, {"oid": "a998abf3a418936e56245a3a3c7846613adde2b0", "url": "https://github.com/Netflix/titus-control-plane/commit/a998abf3a418936e56245a3a3c7846613adde2b0", "message": "fixing gradle", "committedDate": "2020-04-21T05:05:45Z", "type": "commit"}, {"oid": "d983049abf6ff0b8a9a943682cec9e128605858b", "url": "https://github.com/Netflix/titus-control-plane/commit/d983049abf6ff0b8a9a943682cec9e128605858b", "message": "Updating postgressql versions", "committedDate": "2020-04-22T01:15:38Z", "type": "commit"}, {"oid": "f7e46cec1b8e9e6e9a203c3e9808a702a57780e4", "url": "https://github.com/Netflix/titus-control-plane/commit/f7e46cec1b8e9e6e9a203c3e9808a702a57780e4", "message": "Updating dependencies", "committedDate": "2020-04-22T01:25:17Z", "type": "commit"}]}