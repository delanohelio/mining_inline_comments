{"pr_number": 797, "pr_title": "Upgrade to kube-java-client 7.x", "pr_createdAt": "2020-03-03T00:38:57Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/797", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODg5OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387308898", "bodyText": "can you see if this is still needed?", "author": "corindwyer", "createdAt": "2020-03-03T21:38:33Z", "path": "titus-common-ext/kube/src/main/java/com/netflix/titus/ext/kube/clustermembership/connector/KubeClusterMembershipConnectorComponent.java", "diffHunk": "@@ -70,7 +69,7 @@ public ApiClient getApiClient(KubeConnectorConfiguration configuration) {\n             client = Config.fromUrl(kubeApiServerUri);\n         }\n \n-        client.getHttpClient().setReadTimeout(0, TimeUnit.SECONDS); // infinite timeout\n+        client.setReadTimeout(0); // infinite timeout", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxMDg0Mg==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387310842", "bodyText": "I do not know why it was set like that. I am just keeping the original behavior.\nEven if not needed, I do not want to remove it now.", "author": "tbak", "createdAt": "2020-03-03T21:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODg5OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODk5MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387308991", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:38:44Z", "path": "titus-common-ext/kube/src/test/java/com/netflix/titus/ext/kube/clustermembership/connector/KubeExternalResource.java", "diffHunk": "@@ -40,7 +39,7 @@ protected void before() throws Throwable {\n                 .standard()\n                 .setBasePath(String.format(\"http://%s:7001\", kubeServer))\n                 .build();\n-        client.getHttpClient().setReadTimeout(0, TimeUnit.SECONDS); // infinite timeout\n+        client.setReadTimeout(0); // infinite timeout", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxMDg4Nw==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387310887", "bodyText": "I do not know why it was set like that. I am just keeping the original behavior.\nEven if not needed, I do not want to remove it now.", "author": "tbak", "createdAt": "2020-03-03T21:42:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwODk5MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTIwMw==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309203", "bodyText": "can you move taskId to new line to make it easier to read?", "author": "corindwyer", "createdAt": "2020-03-03T21:39:10Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -248,7 +248,15 @@ public void killTask(String taskId) {\n         killTaskCounter.increment();\n         try {\n             logger.info(\"deleting pod: {}\", taskId);\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId, KUBERNETES_NAMESPACE, null, null, null, DELETE_GRACE_PERIOD_SECONDS, null, null);\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -248,7 +248,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n         killTaskCounter.increment();\n         try {\n             logger.info(\"deleting pod: {}\", taskId);\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(\n+                    taskId,\n                     KUBERNETES_NAMESPACE,\n                     null,\n                     null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTMwMw==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309303", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:39:21Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -675,7 +683,14 @@ private void reconcileNodesAndPods() {\n     private void gcNode(V1Node node) {\n         String nodeName = node.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNode(nodeName, null, null, null, 0, null, \"Background\");\n+            kubeApiFacade.getCoreV1Api().deleteNode(nodeName,", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -683,7 +684,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n     private void gcNode(V1Node node) {\n         String nodeName = node.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNode(nodeName,\n+            kubeApiFacade.getCoreV1Api().deleteNode(\n+                    nodeName,\n                     null,\n                     null,\n                     0,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTM5MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309391", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:39:30Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -712,7 +727,15 @@ private boolean isNodeReadyForGc(V1Node node) {\n     private void gcPod(V1Pod pod) {\n         String podName = pod.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName, KUBERNETES_NAMESPACE, null, null, null, 0, null, \"Background\");\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName,", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -727,7 +729,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n     private void gcPod(V1Pod pod) {\n         String podName = pod.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName,\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(\n+                    podName,\n                     KUBERNETES_NAMESPACE,\n                     null,\n                     null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTUzMQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309531", "bodyText": "should verify if extra catch is still needed", "author": "corindwyer", "createdAt": "2020-03-03T21:39:46Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -248,7 +248,15 @@ public void killTask(String taskId) {\n         killTaskCounter.increment();\n         try {\n             logger.info(\"deleting pod: {}\", taskId);\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId, KUBERNETES_NAMESPACE, null, null, null, DELETE_GRACE_PERIOD_SECONDS, null, null);\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,\n+                    KUBERNETES_NAMESPACE,\n+                    null,\n+                    null,\n+                    DELETE_GRACE_PERIOD_SECONDS,\n+                    null,\n+                    null,\n+                    null\n+            );\n         } catch (JsonSyntaxException e) {\n             // this is probably successful. the generated client has the wrong response type", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMzOTA4OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387339088", "bodyText": "Still fails with the same exception:\ncom.google.gson.JsonSyntaxException: java.lang.IllegalStateException:\n Expected a string but was BEGIN_OBJECT at line 1 column 2451 path $.status", "author": "tbak", "createdAt": "2020-03-03T22:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -248,7 +248,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n         killTaskCounter.increment();\n         try {\n             logger.info(\"deleting pod: {}\", taskId);\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(\n+                    taskId,\n                     KUBERNETES_NAMESPACE,\n                     null,\n                     null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTU4MA==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309580", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:39:53Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -675,7 +683,14 @@ private void reconcileNodesAndPods() {\n     private void gcNode(V1Node node) {\n         String nodeName = node.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNode(nodeName, null, null, null, 0, null, \"Background\");\n+            kubeApiFacade.getCoreV1Api().deleteNode(nodeName,\n+                    null,\n+                    null,\n+                    0,\n+                    null,\n+                    \"Background\",\n+                    null\n+            );\n         } catch (JsonSyntaxException e) {\n             // this is probably successful. the generated client has the wrong response type", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -683,7 +684,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n     private void gcNode(V1Node node) {\n         String nodeName = node.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNode(nodeName,\n+            kubeApiFacade.getCoreV1Api().deleteNode(\n+                    nodeName,\n                     null,\n                     null,\n                     0,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMwOTYzNg==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387309636", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:39:59Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java", "diffHunk": "@@ -712,7 +727,15 @@ private boolean isNodeReadyForGc(V1Node node) {\n     private void gcPod(V1Pod pod) {\n         String podName = pod.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName, KUBERNETES_NAMESPACE, null, null, null, 0, null, \"Background\");\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName,\n+                    KUBERNETES_NAMESPACE,\n+                    null,\n+                    null,\n+                    0,\n+                    null,\n+                    \"Background\",\n+                    null\n+            );\n         } catch (JsonSyntaxException e) {\n             // this is probably successful. the generated client has the wrong response type", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\nindex 685ec7a5b..07146c4b9 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java\n\n@@ -727,7 +729,8 @@ public class KubeApiServerIntegrator implements VirtualMachineMasterService {\n     private void gcPod(V1Pod pod) {\n         String podName = pod.getMetadata().getName();\n         try {\n-            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(podName,\n+            kubeApiFacade.getCoreV1Api().deleteNamespacedPod(\n+                    podName,\n                     KUBERNETES_NAMESPACE,\n                     null,\n                     null,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxMDA5Mg==", "url": "https://github.com/Netflix/titus-control-plane/pull/797#discussion_r387310092", "bodyText": "same as above", "author": "corindwyer", "createdAt": "2020-03-03T21:40:53Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultDirectKubeApiServerIntegrator.java", "diffHunk": "@@ -143,7 +143,15 @@ public void shutdown() {\n             Stopwatch timer = Stopwatch.createStarted();\n             try {\n                 logger.info(\"Deleting pod: {}\", taskId);\n-                kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId, KUBERNETES_NAMESPACE, null, null, null, DELETE_GRACE_PERIOD_SECONDS, null, null);\n+                kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,", "originalCommit": "d044f17dbd38059de21601dd6f2c48fa43131596", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultDirectKubeApiServerIntegrator.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultDirectKubeApiServerIntegrator.java\nindex a493d4833..dd803d639 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultDirectKubeApiServerIntegrator.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultDirectKubeApiServerIntegrator.java\n\n@@ -143,7 +143,8 @@ public class DefaultDirectKubeApiServerIntegrator implements DirectKubeApiServer\n             Stopwatch timer = Stopwatch.createStarted();\n             try {\n                 logger.info(\"Deleting pod: {}\", taskId);\n-                kubeApiFacade.getCoreV1Api().deleteNamespacedPod(taskId,\n+                kubeApiFacade.getCoreV1Api().deleteNamespacedPod(\n+                        taskId,\n                         KUBERNETES_NAMESPACE,\n                         null,\n                         null,\n"}}, {"oid": "28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "url": "https://github.com/Netflix/titus-control-plane/commit/28e54c70d6dcfb4ee6fa99e2b2cee47b01e9ac5f", "message": "Code review updates", "committedDate": "2020-03-05T18:59:51Z", "type": "forcePushed"}, {"oid": "828218a2036e4e8f4cbd59fdaf0bfc14063e1d0b", "url": "https://github.com/Netflix/titus-control-plane/commit/828218a2036e4e8f4cbd59fdaf0bfc14063e1d0b", "message": "Upgrade to kube-java-client 7.x", "committedDate": "2020-03-05T23:08:41Z", "type": "commit"}, {"oid": "aed473597171ccd36630d744826b3b5f84b8bc21", "url": "https://github.com/Netflix/titus-control-plane/commit/aed473597171ccd36630d744826b3b5f84b8bc21", "message": "Code review updates", "committedDate": "2020-03-05T23:08:41Z", "type": "commit"}, {"oid": "c44a9ca6f73651ec34e96359198643ec838c0ebf", "url": "https://github.com/Netflix/titus-control-plane/commit/c44a9ca6f73651ec34e96359198643ec838c0ebf", "message": "Leader election tunning", "committedDate": "2020-03-05T23:08:41Z", "type": "commit"}, {"oid": "c44a9ca6f73651ec34e96359198643ec838c0ebf", "url": "https://github.com/Netflix/titus-control-plane/commit/c44a9ca6f73651ec34e96359198643ec838c0ebf", "message": "Leader election tunning", "committedDate": "2020-03-05T23:08:41Z", "type": "forcePushed"}, {"oid": "2e85395fe8b78e466bc4c39589ea717f22ca481c", "url": "https://github.com/Netflix/titus-control-plane/commit/2e85395fe8b78e466bc4c39589ea717f22ca481c", "message": "Dependency lock update", "committedDate": "2020-03-05T23:42:26Z", "type": "commit"}]}