{"pr_number": 864, "pr_title": "Do not attempt scheduling if Kube integrator is not ready or healthy", "pr_createdAt": "2020-06-08T20:48:58Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/864", "timeline": [{"oid": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "url": "https://github.com/Netflix/titus-control-plane/commit/3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "message": "Do not attempt scheduling if Kube integrator is not ready or healthy", "committedDate": "2020-06-08T20:46:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMDg5OQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437000899", "bodyText": "minor: combine the if below into a single boolean logic operation (&&)", "author": "fabiokung", "createdAt": "2020-06-08T21:06:16Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -269,17 +269,19 @@ public BatchDifferenceResolver(\n         for (BatchJobTask refTask : tasks) {\n             BatchJobTask runningTask = runningJobView.getTaskById(refTask.getId());\n             if (JobFunctions.isOwnedByKubeScheduler(refTask)) {\n-                // TODO This complexity exists due to the way Fenzo is initialized on bootstrap. This code can be simplified one we move off Fenzo.\n-                if (runningTask == null || (refTask.getStatus().getState() == TaskState.Accepted && !TaskStatus.hasPod(refTask))) {\n-                    missingTasks.add(BasicTaskActions.launchTaskInKube(\n-                            kubeApiServerIntegrator,\n-                            configuration,\n-                            engine,\n-                            runningJobView.getJob(),\n-                            refTask,\n-                            RECONCILER_CALLMETADATA.toBuilder().withCallReason(\"Launching task in Kube\").build(),\n-                            titusRuntime\n-                    ));\n+                if (kubeApiServerIntegrator.isReadyForScheduling()) {", "originalCommit": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMTE3Nw==", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437001177", "bodyText": "even better, maybe consider extracting the boolean logic chain into a separate method/function", "author": "fabiokung", "createdAt": "2020-06-08T21:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAxMTU2NA==", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437011564", "bodyText": "I was thinking about extracting this into a util function, but there would be too many arguments, which would not improved the code readability.", "author": "tbak", "createdAt": "2020-06-08T21:28:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMDg5OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAwMjQzMg==", "url": "https://github.com/Netflix/titus-control-plane/pull/864#discussion_r437002432", "bodyText": "typo s/Abi/Api/", "author": "fabiokung", "createdAt": "2020-06-08T21:09:28Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java", "diffHunk": "@@ -153,6 +155,23 @@ private boolean processNoActiveAgent(T taskRequest, List<TaskAssignmentResult> a\n         return true;\n     }\n \n+    private boolean processKubeAbiNotReady(T taskRequest, List<TaskAssignmentResult> assignmentResults,", "originalCommit": "3510fff0abd387c11a6c4437cf50ba1fb7afc3c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b27b876201f349ace33a7a08375b1d8235b1ebb", "chunk": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java b/titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java\nindex 6eb0fee8d..ec483138a 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/scheduler/TaskPlacementFailureClassifier.java\n\n@@ -155,7 +155,7 @@ class TaskPlacementFailureClassifier<T extends TaskRequest> {\n         return true;\n     }\n \n-    private boolean processKubeAbiNotReady(T taskRequest, List<TaskAssignmentResult> assignmentResults,\n+    private boolean processKubeApiNotReady(T taskRequest, List<TaskAssignmentResult> assignmentResults,\n                                            Map<FailureKind, Map<T, List<TaskPlacementFailure>>> resultCollector) {\n         int count = 0;\n         for (TaskAssignmentResult assignmentResult : assignmentResults) {\n"}}, {"oid": "8b27b876201f349ace33a7a08375b1d8235b1ebb", "url": "https://github.com/Netflix/titus-control-plane/commit/8b27b876201f349ace33a7a08375b1d8235b1ebb", "message": "Code review updates", "committedDate": "2020-06-08T21:29:05Z", "type": "commit"}]}