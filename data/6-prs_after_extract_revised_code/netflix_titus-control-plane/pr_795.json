{"pr_number": 795, "pr_title": "Refactoring ConstraintValidators to sanitize violation message templates", "pr_createdAt": "2020-02-29T01:36:56Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/795", "timeline": [{"oid": "977bddc7bfeaeacc33d15b82157aff95a6f9b48f", "url": "https://github.com/Netflix/titus-control-plane/commit/977bddc7bfeaeacc33d15b82157aff95a6f9b48f", "message": "Refactoring ConstraintValidators to sanitize violation message so it is not an EL expression", "committedDate": "2020-02-29T00:54:26Z", "type": "commit"}, {"oid": "59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "url": "https://github.com/Netflix/titus-control-plane/commit/59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "message": "Merge pull request #3 from joshi-keyur/VUL-1981/sanitize-violation-message\n\nRefactoring ConstraintValidators to sanitize violation message templates", "committedDate": "2020-02-29T01:35:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUxNzAxNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/795#discussion_r386517014", "bodyText": "protected? We want clients to call the original validator method?", "author": "tbak", "createdAt": "2020-03-02T16:52:26Z", "path": "titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintSetValidator.java", "diffHunk": "@@ -53,7 +54,7 @@ public void initialize(SchedulingConstraintSet constraintAnnotation) {\n     }\n \n     @Override\n-    public boolean isValid(Container container, ConstraintValidatorContext context) {\n+    public boolean isValid(Container container, ConstraintValidatorContextWrapper context) {", "originalCommit": "59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b10fc85d64c5ae72663a0de03d3d48bf916af138", "chunk": "diff --git a/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintSetValidator.java b/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintSetValidator.java\nindex fa1ebb1d3..4e1e6c841 100644\n--- a/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintSetValidator.java\n+++ b/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintSetValidator.java\n\n@@ -54,7 +55,7 @@ public class SchedulingConstraintSetValidator extends AbstractConstraintValidato\n     }\n \n     @Override\n-    public boolean isValid(Container container, ConstraintValidatorContextWrapper context) {\n+    protected boolean isValid(Container container, Function<String, ConstraintValidatorContext.ConstraintViolationBuilder> constraintViolationBuilderFunction) {\n         if (container == null) {\n             return true;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUxNzgyNA==", "url": "https://github.com/Netflix/titus-control-plane/pull/795#discussion_r386517824", "bodyText": "protected?", "author": "tbak", "createdAt": "2020-03-02T16:53:41Z", "path": "titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/AbstractConstraintValidator.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.model.sanitizer.internal;\n+\n+import javax.validation.ConstraintValidator;\n+import javax.validation.ConstraintValidatorContext;\n+import java.lang.annotation.Annotation;\n+\n+public abstract class AbstractConstraintValidator<A extends Annotation, T> implements ConstraintValidator<A, T> {\n+\n+    @Override\n+    final public boolean isValid(T type, ConstraintValidatorContext context) {\n+        return this.isValid(type, new ConstraintValidatorContextWrapper(context));\n+    }\n+\n+    abstract public boolean isValid(T type, ConstraintValidatorContextWrapper wrapper);", "originalCommit": "59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b10fc85d64c5ae72663a0de03d3d48bf916af138", "chunk": "diff --git a/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/AbstractConstraintValidator.java b/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/AbstractConstraintValidator.java\nindex 652f1046b..fad0a6943 100644\n--- a/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/AbstractConstraintValidator.java\n+++ b/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/AbstractConstraintValidator.java\n\n@@ -19,14 +19,38 @@ package com.netflix.titus.common.model.sanitizer.internal;\n import javax.validation.ConstraintValidator;\n import javax.validation.ConstraintValidatorContext;\n import java.lang.annotation.Annotation;\n+import java.util.function.Function;\n \n public abstract class AbstractConstraintValidator<A extends Annotation, T> implements ConstraintValidator<A, T> {\n \n+    /**\n+     * Escape all special characters that participate in EL expressions so the the message string\n+     * cannot be classified as a template for interpolation.\n+     *\n+     * @param message string that needs to be sanitized\n+     * @return copy of the input string with '{','}','#' and '$' characters escaped\n+     */\n+    private static String sanitizeMessage(String message) {\n+        return message.replaceAll(\"([}{$#])\", \"\\\\\\\\$1\");\n+    }\n+\n     @Override\n     final public boolean isValid(T type, ConstraintValidatorContext context) {\n-        return this.isValid(type, new ConstraintValidatorContextWrapper(context));\n+        return this.isValid(type, message -> {\n+            String sanitizedMessage = sanitizeMessage(message);\n+            return context.buildConstraintViolationWithTemplate(sanitizedMessage);\n+        });\n     }\n \n-    abstract public boolean isValid(T type, ConstraintValidatorContextWrapper wrapper);\n+    /**\n+     * Implementing classes will need to apply the builder function with the violation message string\n+     * to retrieve the underlying instance of {@link javax.validation.ConstraintValidatorContext} in order\n+     * to continue add any violations.\n+     *\n+     * @param type                               type of the object under validation\n+     * @param constraintViolationBuilderFunction function to apply with a violation message string\n+     * @return validation status\n+     */\n+    abstract protected boolean isValid(T type, Function<String, ConstraintValidatorContext.ConstraintViolationBuilder> constraintViolationBuilderFunction);\n \n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyMDMyMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/795#discussion_r386520320", "bodyText": "Replace this class with Function< String, ConstraintViolationBuilder >, and the default implementation as here?", "author": "tbak", "createdAt": "2020-03-02T16:57:36Z", "path": "titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/ConstraintValidatorContextWrapper.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.titus.common.model.sanitizer.internal;\n+\n+import javax.validation.ConstraintValidatorContext;\n+\n+public class ConstraintValidatorContextWrapper {", "originalCommit": "59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYzNTU4Mg==", "url": "https://github.com/Netflix/titus-control-plane/pull/795#discussion_r386635582", "bodyText": "Thank you for the feedback. Please review the updates.", "author": "joshi-keyur", "createdAt": "2020-03-02T20:36:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUyMDMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "b10fc85d64c5ae72663a0de03d3d48bf916af138", "chunk": "diff --git a/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/ConstraintValidatorContextWrapper.java b/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/ConstraintValidatorContextWrapper.java\ndeleted file mode 100644\nindex 39e20101a..000000000\n--- a/titus-common/src/main/java/com/netflix/titus/common/model/sanitizer/internal/ConstraintValidatorContextWrapper.java\n+++ /dev/null\n\n@@ -1,44 +0,0 @@\n-/*\n- * Copyright 2020 Netflix, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.netflix.titus.common.model.sanitizer.internal;\n-\n-import javax.validation.ConstraintValidatorContext;\n-\n-public class ConstraintValidatorContextWrapper {\n-\n-    private final ConstraintValidatorContext constraintValidatorContext;\n-\n-    /**\n-     * Escape all special characters that participate in EL expressions so the the message string\n-     * cannot be classified as a template for interpolation.\n-     *\n-     * @param message string that needs to be sanitized\n-     * @return copy of the input string with '{','}','#' and '$' characters escaped\n-     */\n-    private static String sanitizeMessage(String message) {\n-        return message.replaceAll(\"([}{$#])\", \"\\\\\\\\$1\");\n-    }\n-\n-    public ConstraintValidatorContextWrapper(ConstraintValidatorContext context) {\n-        this.constraintValidatorContext = context;\n-    }\n-\n-    public ConstraintValidatorContext.ConstraintViolationBuilder buildConstraintViolationWithStaticMessage(String message) {\n-        String sanitizedMessage = sanitizeMessage(message);\n-        return this.constraintValidatorContext.buildConstraintViolationWithTemplate(sanitizedMessage);\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU5NTE1NQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/795#discussion_r386595155", "bodyText": "minor: weird indentation here", "author": "fabiokung", "createdAt": "2020-03-02T19:16:07Z", "path": "titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintValidator.java", "diffHunk": "@@ -66,17 +65,16 @@\n \n     @Override\n     public void initialize(SchedulingConstraint constraintAnnotation) {\n-    }\n+   }", "originalCommit": "59b0d7d80b1dc3c194b5e7b59d2dff898514cc8c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b10fc85d64c5ae72663a0de03d3d48bf916af138", "chunk": "diff --git a/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintValidator.java b/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintValidator.java\nindex 7b563bc27..a8ec64f41 100644\n--- a/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintValidator.java\n+++ b/titus-api/src/main/java/com/netflix/titus/api/jobmanager/model/job/sanitizer/SchedulingConstraintValidator.java\n\n@@ -65,16 +66,16 @@ public class SchedulingConstraintValidator extends AbstractConstraintValidator<S\n \n     @Override\n     public void initialize(SchedulingConstraint constraintAnnotation) {\n-   }\n+    }\n \n     @Override\n-    public boolean isValid(Map<String, String> value, ConstraintValidatorContextWrapper context) {\n+    protected boolean isValid(Map<String, String> value, Function<String, ConstraintValidatorContext.ConstraintViolationBuilder> constraintViolationBuilderFunction) {\n         HashSet<String> unknown = value.keySet().stream().map(String::toLowerCase).collect(Collectors.toCollection(HashSet::new));\n         unknown.removeAll(JobConstraints.CONSTRAINT_NAMES);\n         if (unknown.isEmpty()) {\n             return true;\n         }\n-        context.buildConstraintViolationWithStaticMessage(\"Unrecognized constraints \" + unknown)\n+        constraintViolationBuilderFunction.apply(\"Unrecognized constraints \" + unknown)\n                 .addConstraintViolation().disableDefaultConstraintViolation();\n         return false;\n     }\n"}}, {"oid": "b10fc85d64c5ae72663a0de03d3d48bf916af138", "url": "https://github.com/Netflix/titus-control-plane/commit/b10fc85d64c5ae72663a0de03d3d48bf916af138", "message": "Replacing the Wrapper class with a Function which sanitizes the string message", "committedDate": "2020-03-02T20:35:03Z", "type": "commit"}, {"oid": "9eb082394c84d191cc6de9318260b5866ae0ea3f", "url": "https://github.com/Netflix/titus-control-plane/commit/9eb082394c84d191cc6de9318260b5866ae0ea3f", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-03-03T19:24:20Z", "type": "commit"}]}