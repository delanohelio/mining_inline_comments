{"pr_number": 770, "pr_title": "Add grpc to reactor server support for cglib proxies", "pr_createdAt": "2020-02-13T20:45:42Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/770", "timeline": [{"oid": "8a0616fc5a79af7fba20d2cea34b50bfeb7bb266", "url": "https://github.com/Netflix/titus-control-plane/commit/8a0616fc5a79af7fba20d2cea34b50bfeb7bb266", "message": "Add gprc to reactor server support for cglib proxies", "committedDate": "2020-02-13T20:18:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTExMzA0Ng==", "url": "https://github.com/Netflix/titus-control-plane/pull/770#discussion_r379113046", "bodyText": "Could you add a comment why we need reactorDetailedFallbackClass, and cannot just do reactService.getClass()?", "author": "tbak", "createdAt": "2020-02-13T20:54:55Z", "path": "titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/GrpcToReactorServerFactory.java", "diffHunk": "@@ -22,4 +22,6 @@\n public interface GrpcToReactorServerFactory {\n \n     <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDefinition, REACT_SERVICE reactService);\n+\n+    <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDefinition, REACT_SERVICE reactService, Class<REACT_SERVICE> reactorDetailedFallbackClass);", "originalCommit": "8a0616fc5a79af7fba20d2cea34b50bfeb7bb266", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e7acc7473b480d2be8b39eb5cf9078f424cc7581", "chunk": "diff --git a/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/GrpcToReactorServerFactory.java b/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/GrpcToReactorServerFactory.java\nindex d492a0191..aefe0f0e2 100644\n--- a/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/GrpcToReactorServerFactory.java\n+++ b/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/GrpcToReactorServerFactory.java\n\n@@ -23,5 +23,10 @@ public interface GrpcToReactorServerFactory {\n \n     <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDefinition, REACT_SERVICE reactService);\n \n+    /**\n+     * This method is used when the {@link REACT_SERVICE} is a CGLIB proxy and additional class details need to be provided to the factory.\n+     * If the {@link REACT_SERVICE} is a CGLIB proxy class it does not retain generic type information from the proxy target class so a\n+     * detailed description of the target class is needed.\n+     */\n     <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDefinition, REACT_SERVICE reactService, Class<REACT_SERVICE> reactorDetailedFallbackClass);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTExMzUwNg==", "url": "https://github.com/Netflix/titus-control-plane/pull/770#discussion_r379113506", "bodyText": "Can we pass here reactService.getClass(), not null?", "author": "tbak", "createdAt": "2020-02-13T20:55:48Z", "path": "titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/server/DefaultGrpcToReactorServerFactory.java", "diffHunk": "@@ -34,8 +34,14 @@ public DefaultGrpcToReactorServerFactory(Class<CONTEXT> contextType, Supplier<CO\n \n     @Override\n     public <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDescriptor, REACT_SERVICE reactService) {\n+        return apply(serviceDescriptor, reactService, null);", "originalCommit": "8a0616fc5a79af7fba20d2cea34b50bfeb7bb266", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e7acc7473b480d2be8b39eb5cf9078f424cc7581", "chunk": "diff --git a/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/server/DefaultGrpcToReactorServerFactory.java b/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/server/DefaultGrpcToReactorServerFactory.java\nindex 387dc8d51..c183fbcbe 100644\n--- a/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/server/DefaultGrpcToReactorServerFactory.java\n+++ b/titus-common/src/main/java/com/netflix/titus/common/util/grpc/reactor/server/DefaultGrpcToReactorServerFactory.java\n\n@@ -34,7 +34,7 @@ public class DefaultGrpcToReactorServerFactory<CONTEXT> implements GrpcToReactor\n \n     @Override\n     public <REACT_SERVICE> ServerServiceDefinition apply(ServiceDescriptor serviceDescriptor, REACT_SERVICE reactService) {\n-        return apply(serviceDescriptor, reactService, null);\n+        return apply(serviceDescriptor, reactService, (Class<REACT_SERVICE>) reactService.getClass());\n     }\n \n     @Override\n"}}, {"oid": "e7acc7473b480d2be8b39eb5cf9078f424cc7581", "url": "https://github.com/Netflix/titus-control-plane/commit/e7acc7473b480d2be8b39eb5cf9078f424cc7581", "message": "Review comments: Pass instance's class instead of null and add interface comment", "committedDate": "2020-02-13T21:41:37Z", "type": "commit"}]}