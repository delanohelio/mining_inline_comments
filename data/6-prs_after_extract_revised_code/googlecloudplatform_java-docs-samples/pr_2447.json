{"pr_number": 2447, "pr_title": "Fix Flaky DLP tests", "pr_createdAt": "2020-03-19T21:02:58Z", "pr_url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2447", "timeline": [{"oid": "a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "message": "modified tests to cancel job", "committedDate": "2020-03-19T21:06:43Z", "type": "commit"}, {"oid": "a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "message": "modified tests to cancel job", "committedDate": "2020-03-19T21:06:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyNzc3Mg==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2447#discussion_r395327772", "bodyText": "Fine if it works, but I'd bet these things can't happen right after the other.  (some hysteresis).\n(and it would be a flaky test again)", "author": "lesv", "createdAt": "2020-03-19T21:23:36Z", "path": "dlp/src/test/java/dlp/snippets/InspectTests.java", "diffHunk": "@@ -103,8 +105,13 @@ public void testInspectGcsFile() throws InterruptedException, ExecutionException\n     InspectGcsFile.inspectGcsFile(PROJECT_ID, GCS_PATH, TOPIC_ID, SUBSCRIPTION_ID);\n \n     String output = bout.toString();\n-    assertThat(output, containsString(\"Info type: PHONE_NUMBER\"));\n-    assertThat(output, containsString(\"Info type: EMAIL_ADDRESS\"));\n+    assertThat(output, containsString(\"Job created: \"));\n+\n+    String jobId = output.split(\"Job created: \")[1].split(\"\\n\")[0];\n+    CancelDlpJobRequest request = CancelDlpJobRequest.newBuilder().setName(jobId).build();\n+    try (DlpServiceClient client = DlpServiceClient.create()) {\n+      client.cancelDlpJob(request);\n+    }", "originalCommit": "a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d9a26e61663ba5c5f517b1c700cd445916fb754", "chunk": "diff --git a/dlp/src/test/java/dlp/snippets/InspectTests.java b/dlp/src/test/java/dlp/snippets/InspectTests.java\nindex 0c73718fb..7267992e6 100644\n--- a/dlp/src/test/java/dlp/snippets/InspectTests.java\n+++ b/dlp/src/test/java/dlp/snippets/InspectTests.java\n\n@@ -102,7 +103,9 @@ public class InspectTests {\n \n   @Test\n   public void testInspectGcsFile() throws InterruptedException, ExecutionException, IOException {\n+\n     InspectGcsFile.inspectGcsFile(PROJECT_ID, GCS_PATH, TOPIC_ID, SUBSCRIPTION_ID);\n+    TimeUnit.SECONDS.sleep(3);\n \n     String output = bout.toString();\n     assertThat(output, containsString(\"Job created: \"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyNzkyMw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2447#discussion_r395327923", "bodyText": "Fine if it works, but I'd bet these things can't happen right after the other.  (some hysteresis).\n(and it would be a flaky test again)", "author": "lesv", "createdAt": "2020-03-19T21:23:54Z", "path": "dlp/src/test/java/dlp/snippets/InspectTests.java", "diffHunk": "@@ -114,8 +121,13 @@ public void testInspectDatastoreEntity()\n         PROJECT_ID, datastoreNamespace, datastoreKind, TOPIC_ID, SUBSCRIPTION_ID);\n \n     String output = bout.toString();\n-    assertThat(output, containsString(\"Info type: PHONE_NUMBER\"));\n-    assertThat(output, containsString(\"Info type: EMAIL_ADDRESS\"));\n+    assertThat(output, containsString(\"Job created: \"));\n+\n+    String jobId = output.split(\"Job created: \")[1].split(\"\\n\")[0];\n+    CancelDlpJobRequest request = CancelDlpJobRequest.newBuilder().setName(jobId).build();\n+    try (DlpServiceClient client = DlpServiceClient.create()) {\n+      client.cancelDlpJob(request);\n+    }", "originalCommit": "a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d9a26e61663ba5c5f517b1c700cd445916fb754", "chunk": "diff --git a/dlp/src/test/java/dlp/snippets/InspectTests.java b/dlp/src/test/java/dlp/snippets/InspectTests.java\nindex 0c73718fb..7267992e6 100644\n--- a/dlp/src/test/java/dlp/snippets/InspectTests.java\n+++ b/dlp/src/test/java/dlp/snippets/InspectTests.java\n\n@@ -117,8 +120,10 @@ public class InspectTests {\n   @Test\n   public void testInspectDatastoreEntity()\n       throws InterruptedException, ExecutionException, IOException {\n+\n     InspectDatastoreEntity.insepctDatastoreEntity(\n         PROJECT_ID, datastoreNamespace, datastoreKind, TOPIC_ID, SUBSCRIPTION_ID);\n+    TimeUnit.SECONDS.sleep(3);\n \n     String output = bout.toString();\n     assertThat(output, containsString(\"Job created: \"));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyODA0Mw==", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2447#discussion_r395328043", "bodyText": "Fine if it works, but I'd bet these things can't happen right after the other.  (some hysteresis).\n(and it would be a flaky test again)", "author": "lesv", "createdAt": "2020-03-19T21:24:10Z", "path": "dlp/src/test/java/dlp/snippets/InspectTests.java", "diffHunk": "@@ -125,6 +137,12 @@ public void testInspectBigQueryTable()\n         PROJECT_ID, DATASET_ID, TABLE_ID, TOPIC_ID, SUBSCRIPTION_ID);\n \n     String output = bout.toString();\n-    assertThat(output, containsString(\"Info type: PHONE_NUMBER\"));\n+    assertThat(output, containsString(\"Job created: \"));\n+\n+    String jobId = output.split(\"Job created: \")[1].split(\"\\n\")[0];\n+    CancelDlpJobRequest request = CancelDlpJobRequest.newBuilder().setName(jobId).build();\n+    try (DlpServiceClient client = DlpServiceClient.create()) {\n+      client.cancelDlpJob(request);\n+    }", "originalCommit": "a1846b0eb54fbef3a4d3339f799fb2b13f26ec62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1d9a26e61663ba5c5f517b1c700cd445916fb754", "chunk": "diff --git a/dlp/src/test/java/dlp/snippets/InspectTests.java b/dlp/src/test/java/dlp/snippets/InspectTests.java\nindex 0c73718fb..7267992e6 100644\n--- a/dlp/src/test/java/dlp/snippets/InspectTests.java\n+++ b/dlp/src/test/java/dlp/snippets/InspectTests.java\n\n@@ -133,8 +138,10 @@ public class InspectTests {\n   @Test\n   public void testInspectBigQueryTable()\n       throws InterruptedException, ExecutionException, IOException {\n+\n     InspectBigQueryTable.inspectBigQueryTable(\n         PROJECT_ID, DATASET_ID, TABLE_ID, TOPIC_ID, SUBSCRIPTION_ID);\n+    TimeUnit.SECONDS.sleep(3);\n \n     String output = bout.toString();\n     assertThat(output, containsString(\"Job created: \"));\n"}}, {"oid": "1d9a26e61663ba5c5f517b1c700cd445916fb754", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1d9a26e61663ba5c5f517b1c700cd445916fb754", "message": "added delay to tests", "committedDate": "2020-03-19T23:40:19Z", "type": "commit"}, {"oid": "ff5af0ac9159aa93278e5e040d571c913dd557ab", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ff5af0ac9159aa93278e5e040d571c913dd557ab", "message": "added comment", "committedDate": "2020-03-20T06:40:40Z", "type": "commit"}, {"oid": "4ba43cb04bb5bb59bd99c821a24a00313c8ed495", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/4ba43cb04bb5bb59bd99c821a24a00313c8ed495", "message": "Merge branch 'master' into fix-flaky-tests", "committedDate": "2020-03-20T22:00:19Z", "type": "commit"}]}