{"pr_number": 6283, "pr_title": "Make Solr query time allowed configurable", "pr_createdAt": "2020-09-03T00:05:46Z", "pr_url": "https://github.com/codice/ddf/pull/6283", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNTgwOQ==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482635809", "bodyText": "\u2753 Is it not enough to simply check for instanceof Map instead?", "author": "Lambeaux", "createdAt": "2020-09-03T01:16:45Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java", "diffHunk": "@@ -309,6 +317,30 @@ private void handleSuggestionResponse(\n     }\n   }\n \n+  private void handlePartialResults(\n+      QueryResponse solrResponse, Map<String, Serializable> responseProps) {\n+    if (solrResponse.getResponseHeader() != null) {\n+      Boolean partialResults = (Boolean) solrResponse.getResponseHeader().get(\"partialResults\");\n+      if (Boolean.TRUE.equals(partialResults)) {\n+        responseProps.put(\"partial-results\", true);\n+        if (LOGGER.isDebugEnabled()) {\n+          String q = \"unknown\";\n+          if (solrResponse.getResponseHeader().get(\"params\") != null\n+              && solrResponse.getResponseHeader().get(\"params\") instanceof SimpleOrderedMap) {", "originalCommit": "a558ed0777f9b26f4a3e898392529ae8424b3bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc1NDI1NA==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482754254", "bodyText": "It does not appear Map is actually in the type hierarchy of SimpleOrderedMap.  You can see some of the differences from Map in the NamedList JavaDoc.\nhttps://github.com/apache/lucene-solr/blob/a70a47d053954b0f13b7da6f5612432a8ea7a898/solr/solrj/src/java/org/apache/solr/common/util/NamedList.java#L46-L54", "author": "pklinef", "createdAt": "2020-09-03T07:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNTgwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d54cf966d7c579d5c7b4e292ee45ede6538b163c", "chunk": "diff --git a/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java b/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\nindex faab58db88..151fc46e6f 100644\n--- a/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n+++ b/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n\n@@ -319,25 +320,36 @@ private void handleSuggestionResponse(\n \n   private void handlePartialResults(\n       QueryResponse solrResponse, Map<String, Serializable> responseProps) {\n-    if (solrResponse.getResponseHeader() != null) {\n-      Boolean partialResults = (Boolean) solrResponse.getResponseHeader().get(\"partialResults\");\n-      if (Boolean.TRUE.equals(partialResults)) {\n-        responseProps.put(\"partial-results\", true);\n-        if (LOGGER.isDebugEnabled()) {\n-          String q = \"unknown\";\n-          if (solrResponse.getResponseHeader().get(\"params\") != null\n-              && solrResponse.getResponseHeader().get(\"params\") instanceof SimpleOrderedMap) {\n-            q =\n-                String.valueOf(\n-                    ((SimpleOrderedMap) solrResponse.getResponseHeader().get(\"params\")).get(\"q\"));\n-          }\n-          LOGGER.debug(\n-              \"Found {} partial results for query [{}] that took {}ms.\",\n-              solrResponse.getResults().getNumFound(),\n-              q,\n-              solrResponse.getQTime());\n-        }\n-      }\n+    boolean partialResults =\n+        Optional.of(solrResponse)\n+            .map(QueryResponse::getResponseHeader)\n+            .map(header -> header.get(\"partialResults\"))\n+            .filter(Boolean.class::isInstance)\n+            .map(Boolean.class::cast)\n+            .orElse(false);\n+\n+    if (!partialResults) {\n+      return;\n+    }\n+\n+    responseProps.put(\"partial-results\", true);\n+\n+    if (LOGGER.isDebugEnabled()) {\n+      String q =\n+          Optional.of(solrResponse)\n+              .map(QueryResponse::getResponseHeader)\n+              .map(header -> header.get(\"params\"))\n+              .filter(SimpleOrderedMap.class::isInstance)\n+              .map(SimpleOrderedMap.class::cast)\n+              .map(params -> params.get(\"q\"))\n+              .map(String::valueOf)\n+              .orElse(\"unknown\");\n+\n+      LOGGER.debug(\n+          \"Found {} partial results for query [{}] that took {}ms.\",\n+          solrResponse.getResults().getNumFound(),\n+          q,\n+          solrResponse.getQTime());\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNzA1Mg==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482637052", "bodyText": "\u2753 If you don't get a new Solr metacard client do you have to refresh the bundle to validate the system property change?", "author": "Lambeaux", "createdAt": "2020-09-03T01:21:26Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java", "diffHunk": "@@ -150,6 +151,11 @@\n   private final int commitNrtCommitWithinMs =\n       Math.max(NumberUtils.toInt(accessProperty(SOLR_COMMIT_NRT_COMMITWITHINMS, \"1000\")), 0);\n \n+  private static final String SOLR_QUERY_TIMEALLOWEDMS = \"solr.query.timeAllowed\";\n+\n+  private final int queryTimeAllowedMs =\n+      Math.max(NumberUtils.toInt(accessProperty(SOLR_QUERY_TIMEALLOWEDMS, \"0\")), 0);", "originalCommit": "a558ed0777f9b26f4a3e898392529ae8424b3bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzOTE5Ng==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482639196", "bodyText": "Just now saw that in the testing instructions. No big deal.", "author": "Lambeaux", "createdAt": "2020-09-03T01:29:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjYzNzA1Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwMzIzNg==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482703236", "bodyText": "\u270f\ufe0f I wonder if this would be any cleaner with some of these if conditions inverted , though thats purely style so you can keep it whatever way you wish", "author": "rzwiefel", "createdAt": "2020-09-03T04:53:53Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java", "diffHunk": "@@ -309,6 +317,30 @@ private void handleSuggestionResponse(\n     }\n   }\n \n+  private void handlePartialResults(", "originalCommit": "a558ed0777f9b26f4a3e898392529ae8424b3bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc1ODI2Ng==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r482758266", "bodyText": "Maybe.  How does this look to you?\n  private void handlePartialResults(\n      QueryResponse solrResponse, Map<String, Serializable> responseProps) {\n    if (solrResponse.getResponseHeader() == null) {\n      return;\n    }\n\n    Boolean partialResults = (Boolean) solrResponse.getResponseHeader().get(\"partialResults\");\n    if (!Boolean.TRUE.equals(partialResults)) {\n      return;\n    }\n\n    responseProps.put(\"partial-results\", true);\n\n    if (!LOGGER.isDebugEnabled()) {\n      return;\n    }\n\n    String q = \"unknown\";\n    if (solrResponse.getResponseHeader().get(\"params\") != null\n        && solrResponse.getResponseHeader().get(\"params\") instanceof SimpleOrderedMap) {\n      q =\n          String.valueOf(\n              ((SimpleOrderedMap) solrResponse.getResponseHeader().get(\"params\")).get(\"q\"));\n    }\n\n    LOGGER.debug(\n        \"Found {} partial results for query [{}] that took {}ms.\",\n        solrResponse.getResults().getNumFound(),\n        q,\n        solrResponse.getQTime());\n  }", "author": "pklinef", "createdAt": "2020-09-03T07:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwMzIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE2MjEyMg==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r483162122", "bodyText": "And here's yet another option to consider.\nboolean partialResults = Optional.of(solrResponse)\n  .map(QueryResponse::getResponseHeader)\n  .map(responseHeader -> responseHeader.get(\"partialResults\"))\n  .orElse(false);\n\nif (!partialResults) {\n  return;\n}\n\nresponseProps.put(\"partial-results\", partialResults);\n\n// could keep inline or extract to func\nif (LOGGER.isDebugEnabled()) {\n  String q = Optional.of(solrResponse)\n    .map(QueryResponse::getResponseHeader)\n    .map(responseHeader -> responseHeader.get(\"params\"))\n    .filter(SimpleOrderedMap.class::instanceOf)\n    .map(SimpleOrderedMap.class::cast)\n    .map(params -> params.get(\"q\"))\n    .orElse(\"unknown\");\n\n  LOGGER.debug(\n    \"Found {} partial results for query [{}] that took {}ms.\",\n    solrResponse.getResults().getNumFound(),\n    q,\n    solrResponse.getQTime());\n}", "author": "rzwiefel", "createdAt": "2020-09-03T18:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjcwMzIzNg=="}], "type": "inlineReview", "revised_code": {"commit": "d54cf966d7c579d5c7b4e292ee45ede6538b163c", "chunk": "diff --git a/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java b/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\nindex faab58db88..151fc46e6f 100644\n--- a/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n+++ b/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n\n@@ -319,25 +320,36 @@ private void handleSuggestionResponse(\n \n   private void handlePartialResults(\n       QueryResponse solrResponse, Map<String, Serializable> responseProps) {\n-    if (solrResponse.getResponseHeader() != null) {\n-      Boolean partialResults = (Boolean) solrResponse.getResponseHeader().get(\"partialResults\");\n-      if (Boolean.TRUE.equals(partialResults)) {\n-        responseProps.put(\"partial-results\", true);\n-        if (LOGGER.isDebugEnabled()) {\n-          String q = \"unknown\";\n-          if (solrResponse.getResponseHeader().get(\"params\") != null\n-              && solrResponse.getResponseHeader().get(\"params\") instanceof SimpleOrderedMap) {\n-            q =\n-                String.valueOf(\n-                    ((SimpleOrderedMap) solrResponse.getResponseHeader().get(\"params\")).get(\"q\"));\n-          }\n-          LOGGER.debug(\n-              \"Found {} partial results for query [{}] that took {}ms.\",\n-              solrResponse.getResults().getNumFound(),\n-              q,\n-              solrResponse.getQTime());\n-        }\n-      }\n+    boolean partialResults =\n+        Optional.of(solrResponse)\n+            .map(QueryResponse::getResponseHeader)\n+            .map(header -> header.get(\"partialResults\"))\n+            .filter(Boolean.class::isInstance)\n+            .map(Boolean.class::cast)\n+            .orElse(false);\n+\n+    if (!partialResults) {\n+      return;\n+    }\n+\n+    responseProps.put(\"partial-results\", true);\n+\n+    if (LOGGER.isDebugEnabled()) {\n+      String q =\n+          Optional.of(solrResponse)\n+              .map(QueryResponse::getResponseHeader)\n+              .map(header -> header.get(\"params\"))\n+              .filter(SimpleOrderedMap.class::isInstance)\n+              .map(SimpleOrderedMap.class::cast)\n+              .map(params -> params.get(\"q\"))\n+              .map(String::valueOf)\n+              .orElse(\"unknown\");\n+\n+      LOGGER.debug(\n+          \"Found {} partial results for query [{}] that took {}ms.\",\n+          solrResponse.getResults().getNumFound(),\n+          q,\n+          solrResponse.getQTime());\n     }\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNzM1NQ==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r483117355", "bodyText": "what would 0 do? would it not perform the search at all or omit this property? should it be default to something else?", "author": "lamhuy", "createdAt": "2020-09-03T16:44:52Z", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java", "diffHunk": "@@ -150,6 +151,11 @@\n   private final int commitNrtCommitWithinMs =\n       Math.max(NumberUtils.toInt(accessProperty(SOLR_COMMIT_NRT_COMMITWITHINMS, \"1000\")), 0);\n \n+  private static final String SOLR_QUERY_TIMEALLOWEDMS = \"solr.query.timeAllowed\";\n+\n+  private final int queryTimeAllowedMs =\n+      Math.max(NumberUtils.toInt(accessProperty(SOLR_QUERY_TIMEALLOWEDMS, \"0\")), 0);", "originalCommit": "a558ed0777f9b26f4a3e898392529ae8424b3bf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE0MDYyMQ==", "url": "https://github.com/codice/ddf/pull/6283#discussion_r483140621", "bodyText": "Before setting the time allowed on the Solr query, I check if queryTimeAllowedMs is greater than 0.  So this currently disables it.  I was having a hard time coming up with a safe default for everyone's production use case.\nI would like to have a sensible default other than disabling it but I did not want to hold up getting this in while trying to figure out what that value should be.  Ideally it would be something like one second but that assumes everyone will be able to scale their clusters or fix their schemas (and reindex) quick enough to avoid going over that value.  I think it would be safe for the majority of production use cases but I know it is not safe for all of them.  But a value safe for all of them might be so high that it is similar to disabling it.\nI am also not sure how many production use cases might have a small outlier of users that really need to do very complex queries and get the full results back.\nThere is also no feedback from current endpoints to know if you are seeing the full results or a partial result.", "author": "pklinef", "createdAt": "2020-09-03T17:25:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzExNzM1NQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "d54cf966d7c579d5c7b4e292ee45ede6538b163c", "url": "https://github.com/codice/ddf/commit/d54cf966d7c579d5c7b4e292ee45ede6538b163c", "message": "Make Solr query time allowed configurable\n\n- Allows the solr.query.timeAllowed system property to set a time\n  allowed to do a Solr query.  This is not a hard limit.\n- Time allowed is not enabled by default.", "committedDate": "2020-09-03T22:47:18Z", "type": "commit"}, {"oid": "d54cf966d7c579d5c7b4e292ee45ede6538b163c", "url": "https://github.com/codice/ddf/commit/d54cf966d7c579d5c7b4e292ee45ede6538b163c", "message": "Make Solr query time allowed configurable\n\n- Allows the solr.query.timeAllowed system property to set a time\n  allowed to do a Solr query.  This is not a hard limit.\n- Time allowed is not enabled by default.", "committedDate": "2020-09-03T22:47:18Z", "type": "forcePushed"}]}