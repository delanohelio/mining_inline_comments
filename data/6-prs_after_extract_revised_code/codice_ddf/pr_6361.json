{"pr_number": 6361, "pr_title": "DDF-6360 Upgrade to CXF 3.4.0", "pr_createdAt": "2020-09-30T20:37:49Z", "pr_url": "https://github.com/codice/ddf/pull/6361", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc5MjI0OQ==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497792249", "bodyText": "\u270f\ufe0f Add @Nullable annotation", "author": "emmberk", "createdAt": "2020-09-30T20:50:40Z", "path": "platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java", "diffHunk": "@@ -116,12 +117,16 @@ public static SecurityAssertion getSecurityAssertion(Message message) {\n   }\n \n   /**\n-   * Return the TokenStore associated with this message.\n+   * Return the TokenStore associated with this message\n    *\n    * @param message\n-   * @return TokenStore\n+   * @return the TokenStore, or null if it could not be retrieved\n    */\n   public static TokenStore getTokenStore(Message message) {", "originalCommit": "d6f38da494ab572bd102df1b66ad36cbc4aaf0cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "050b4db58a49c37de2defac8d7fc6a4df0ac1513", "chunk": "diff --git a/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java b/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\nindex 827eed5a38..236e3dbeb4 100644\n--- a/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\n+++ b/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\n\n@@ -122,6 +123,7 @@ public static SecurityAssertion getSecurityAssertion(Message message) {\n    * @param message\n    * @return the TokenStore, or null if it could not be retrieved\n    */\n+  @Nullable\n   public static TokenStore getTokenStore(Message message) {\n     try {\n       return TokenStoreUtils.getTokenStore(message);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4NjM1MQ==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497786351", "bodyText": "It's a pain to maintain two environments. Didn't think it was in-scope for this PR, but it made me wonder why we don't run these on top of the kernel", "author": "SmithJosh", "createdAt": "2020-09-30T20:39:17Z", "path": "catalog/rest/catalog-rest-endpoint/src/test/java/org/codice/ddf/endpoints/rest/it/RestEndpointIT.java", "diffHunk": "@@ -229,17 +224,22 @@ protected FeatureOption getFeatureOptions() {\n \n       @Override\n       public Option get() {\n+        // Add activation and annotation bundles and expose them via the system bundle. This is\n+        // the same thing that the DDF kernel does, but this test runs on the base Karaf distro, so\n+        // we don't have those changes", "originalCommit": "d6f38da494ab572bd102df1b66ad36cbc4aaf0cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed46d80e515b3708621dce285ebe4dd124ad2e17", "chunk": "diff --git a/catalog/rest/catalog-rest-endpoint/src/test/java/org/codice/ddf/endpoints/rest/it/RestEndpointIT.java b/catalog/rest/catalog-rest-endpoint/src/test/java/org/codice/ddf/endpoints/rest/it/RestEndpointIT.java\nindex 750f05ed08..3015d0d92d 100644\n--- a/catalog/rest/catalog-rest-endpoint/src/test/java/org/codice/ddf/endpoints/rest/it/RestEndpointIT.java\n+++ b/catalog/rest/catalog-rest-endpoint/src/test/java/org/codice/ddf/endpoints/rest/it/RestEndpointIT.java\n\n@@ -224,22 +229,17 @@ protected FeatureOption getFeatureOptions() {\n \n       @Override\n       public Option get() {\n-        // Add activation and annotation bundles and expose them via the system bundle. This is\n-        // the same thing that the DDF kernel does, but this test runs on the base Karaf distro, so\n-        // we don't have those changes\n         return CoreOptions.composite(\n             super.get(),\n             CoreOptions.bootClasspathLibraries(\n                 new BootClasspathLibraryOption(\n-                    CoreOptions.maven(\"jakarta.annotation\", \"jakarta.annotation-api\", \"1.3.5\")),\n-                new BootClasspathLibraryOption(\n-                    CoreOptions.maven(\"com.google.code.findbugs\", \"jsr305\", \"3.0.2\"))),\n+                    CoreOptions.maven(\"javax.annotation\", \"javax.annotation-api\", \"1.3\"))),\n             KarafDistributionOption.editConfigurationFilePut(\n                 \"etc/custom.properties\",\n                 \"org.osgi.framework.system.packages.extra\",\n                 new StringBuilder()\n-                    .append(\"javax.activation;version=1.2.1,\")\n-                    .append(\"javax.annotation;version=1.3.5,\")\n+                    .append(\"javax.annotation;version=1.0.0,\")\n+                    .append(\"javax.annotation;version=1.3.2,\")\n                     .append(\"javax.annotation;version=3.0.2\")\n                     .toString()));\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc4NzQ4Ng==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497787486", "bodyText": "There was no change to the DDF JAXB schemas, but for some reason after upgrading JAXB, it started failing to unmarshall this request. I looked at the schema and the namespace here should be csw, so I think JAXB should have been failing on this before as well.", "author": "SmithJosh", "createdAt": "2020-09-30T20:41:34Z", "path": "catalog/spatial/csw/spatial-csw-endpoint/src/test/java/org/codice/ddf/spatial/ogc/csw/catalog/endpoint/reader/TransactionMessageBodyReaderTest.java", "diffHunk": "@@ -107,9 +107,9 @@\n           + \"   xmlns:ogc=\\\"http://www.opengis.net/ogc\\\">\\n\"\n           + \"  <csw:Delete typeName=\\\"csw:Record\\\" handle=\\\"something\\\">\\n\"\n           + \"    <csw:Constraint version=\\\"2.0.0\\\">\\n\"\n-          + \"      <ogc:CqlText>\\n\"\n+          + \"      <csw:CqlText>\\n\"", "originalCommit": "d6f38da494ab572bd102df1b66ad36cbc4aaf0cb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ed46d80e515b3708621dce285ebe4dd124ad2e17", "chunk": "diff --git a/catalog/spatial/csw/spatial-csw-endpoint/src/test/java/org/codice/ddf/spatial/ogc/csw/catalog/endpoint/reader/TransactionMessageBodyReaderTest.java b/catalog/spatial/csw/spatial-csw-endpoint/src/test/java/org/codice/ddf/spatial/ogc/csw/catalog/endpoint/reader/TransactionMessageBodyReaderTest.java\nindex 1739f52b44..cf7b70dce0 100644\n--- a/catalog/spatial/csw/spatial-csw-endpoint/src/test/java/org/codice/ddf/spatial/ogc/csw/catalog/endpoint/reader/TransactionMessageBodyReaderTest.java\n+++ b/catalog/spatial/csw/spatial-csw-endpoint/src/test/java/org/codice/ddf/spatial/ogc/csw/catalog/endpoint/reader/TransactionMessageBodyReaderTest.java\n\n@@ -107,9 +107,9 @@\n           + \"   xmlns:ogc=\\\"http://www.opengis.net/ogc\\\">\\n\"\n           + \"  <csw:Delete typeName=\\\"csw:Record\\\" handle=\\\"something\\\">\\n\"\n           + \"    <csw:Constraint version=\\\"2.0.0\\\">\\n\"\n-          + \"      <csw:CqlText>\\n\"\n+          + \"      <ogc:CqlText>\\n\"\n           + \"        title = 'foo'\\n\"\n-          + \"      </csw:CqlText>\\n\"\n+          + \"      </ogc:CqlText>\\n\"\n           + \"    </csw:Constraint>\\n\"\n           + \"  </csw:Delete>\\n\"\n           + \"</csw:Transaction>\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwMDcxNQ==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497800715", "bodyText": "The only code change for this PR \ud83c\udf89\nIf this is null, we just return a new SecurityAssertionSaml instance. I'm not sure if that's what we actually want, as the code looks like we were not expecting the token store to be null. Would appreciate another set of eyes.\nhttps://github.com/codice/ddf/blob/master/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java#L115", "author": "SmithJosh", "createdAt": "2020-09-30T21:06:54Z", "path": "platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java", "diffHunk": "@@ -116,12 +117,16 @@ public static SecurityAssertion getSecurityAssertion(Message message) {\n   }\n \n   /**\n-   * Return the TokenStore associated with this message.\n+   * Return the TokenStore associated with this message\n    *\n    * @param message\n-   * @return TokenStore\n+   * @return the TokenStore, or null if it could not be retrieved\n    */\n   public static TokenStore getTokenStore(Message message) {\n-    return TokenStoreUtils.getTokenStore(message);\n+    try {\n+      return TokenStoreUtils.getTokenStore(message);\n+    } catch (TokenStoreException e) {\n+      return null;\n+    }", "originalCommit": "d6f38da494ab572bd102df1b66ad36cbc4aaf0cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgyMjg2Ng==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497822866", "bodyText": "It will work correctly the way it is and the PEP still fails closed as long as the token for the assertion is null, which it will be if you just create an empty SAML assertion. However, it might be more correct if we just return an exception if the token store is null or in the case where we might flow down to returning that empty SecurityAssertionSaml instance. I think all that empty instance does is trigger the error condition anyways, so we may as well just jump there. That way we can avoid someone changing the PEP in the future and this possibly failing open at some point.", "author": "stustison", "createdAt": "2020-09-30T21:54:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwMDcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg3NTIyMg==", "url": "https://github.com/codice/ddf/pull/6361#discussion_r497875222", "bodyText": "Ok thanks for confirming. I'm inclined to keep it as-is in that case since the PEP still denies access. I checked and the PEP has tests for null tokens and null assertions so that should raise some flags if it starts failing open.", "author": "SmithJosh", "createdAt": "2020-10-01T00:25:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgwMDcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "050b4db58a49c37de2defac8d7fc6a4df0ac1513", "chunk": "diff --git a/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java b/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\nindex 827eed5a38..236e3dbeb4 100644\n--- a/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\n+++ b/platform/security/pep/security-pep-interceptor/src/main/java/ddf/security/pep/interceptor/SecurityAssertionStore.java\n\n@@ -122,6 +123,7 @@ public static SecurityAssertion getSecurityAssertion(Message message) {\n    * @param message\n    * @return the TokenStore, or null if it could not be retrieved\n    */\n+  @Nullable\n   public static TokenStore getTokenStore(Message message) {\n     try {\n       return TokenStoreUtils.getTokenStore(message);\n"}}, {"oid": "050b4db58a49c37de2defac8d7fc6a4df0ac1513", "url": "https://github.com/codice/ddf/commit/050b4db58a49c37de2defac8d7fc6a4df0ac1513", "message": "Address comments", "committedDate": "2020-10-01T18:08:33Z", "type": "forcePushed"}, {"oid": "c4c7b663cf56bd0f2845775b2dae17aadf467da0", "url": "https://github.com/codice/ddf/commit/c4c7b663cf56bd0f2845775b2dae17aadf467da0", "message": "Address comments", "committedDate": "2020-10-01T18:11:29Z", "type": "forcePushed"}, {"oid": "ed46d80e515b3708621dce285ebe4dd124ad2e17", "url": "https://github.com/codice/ddf/commit/ed46d80e515b3708621dce285ebe4dd124ad2e17", "message": "DDF-6360 Remove wrapped OpenSAML library", "committedDate": "2020-10-06T00:29:18Z", "type": "commit"}, {"oid": "605be10a76cb17b73cb7a51286b6509210de3e3b", "url": "https://github.com/codice/ddf/commit/605be10a76cb17b73cb7a51286b6509210de3e3b", "message": "DDF-6360 Upgrade CXF and friends", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "4fb6307e9c549b025c77213afe59147bb4cfab70", "url": "https://github.com/codice/ddf/commit/4fb6307e9c549b025c77213afe59147bb4cfab70", "message": "DDF-6360 Remove unused dependencies", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "235e84fb734cd1af2d9d78d4442a6ab6e2e237b8", "url": "https://github.com/codice/ddf/commit/235e84fb734cd1af2d9d78d4442a6ab6e2e237b8", "message": "DDF-6360 Switch to Jakarta JAXB dependencies", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "151d25620557a11974d2c587ae7919a8fd598435", "url": "https://github.com/codice/ddf/commit/151d25620557a11974d2c587ae7919a8fd598435", "message": "DDF-6360 Switch to Jakarta Annotations", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "9009f967ad7346ede3764ab3645e6701ab6a58f5", "url": "https://github.com/codice/ddf/commit/9009f967ad7346ede3764ab3645e6701ab6a58f5", "message": "DDF-6360 Switch to Jakarta Activation", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "5830a1c72240f23179fc1fed9a3a03ad16b4a111", "url": "https://github.com/codice/ddf/commit/5830a1c72240f23179fc1fed9a3a03ad16b4a111", "message": "DDF-6360 Add javax.servlet-api to dependencyManagement in root pom", "committedDate": "2020-10-06T00:29:19Z", "type": "commit"}, {"oid": "f8e859f36622c2ecff550100c9b3353000fb5604", "url": "https://github.com/codice/ddf/commit/f8e859f36622c2ecff550100c9b3353000fb5604", "message": "DDF-6360 Add Guava to dependencyManagment in root pom and upgrade to JSR305 3.0.2", "committedDate": "2020-10-06T00:30:03Z", "type": "commit"}, {"oid": "95c2f412077e7bacde24120547ca556175b38b6c", "url": "https://github.com/codice/ddf/commit/95c2f412077e7bacde24120547ca556175b38b6c", "message": "DDF-6360 Fix maven-enforcer-plugin NPE", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "fcea1e253084db3e13e0dfa927de55b1f83d199d", "url": "https://github.com/codice/ddf/commit/fcea1e253084db3e13e0dfa927de55b1f83d199d", "message": "DDF-6360 Fix rest endpoint itest", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "5a456f847295354f17909b35a7d14833240067ef", "url": "https://github.com/codice/ddf/commit/5a456f847295354f17909b35a7d14833240067ef", "message": "DDF-6360 Fix Invalid CSW request", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "08c5c79788fb9f616bfa5ad72fa6a0c9d8b698f5", "url": "https://github.com/codice/ddf/commit/08c5c79788fb9f616bfa5ad72fa6a0c9d8b698f5", "message": "DDF-6360 Fix broken CSW endpoint", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "594fa47142c0772306c2f7d8e92be24413634084", "url": "https://github.com/codice/ddf/commit/594fa47142c0772306c2f7d8e92be24413634084", "message": "DDF-6360 Install JAXB via startup.properties", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "28ed81963b226b1061e26df60b91c2931e6cb57f", "url": "https://github.com/codice/ddf/commit/28ed81963b226b1061e26df60b91c2931e6cb57f", "message": "DDF-6360 Match Guava versions to prevent uses constraint violations", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "d18128fc9c5df2666c6ced5a9caf24009c68dbd7", "url": "https://github.com/codice/ddf/commit/d18128fc9c5df2666c6ced5a9caf24009c68dbd7", "message": "Address comments", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "6ca9cba5df77127c4e9b35e9ed266a494268504d", "url": "https://github.com/codice/ddf/commit/6ca9cba5df77127c4e9b35e9ed266a494268504d", "message": "Fix rest endpoint again", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "0af5b6b332021720cfb15b7f5b580a73f064d381", "url": "https://github.com/codice/ddf/commit/0af5b6b332021720cfb15b7f5b580a73f064d381", "message": "Fix invalid CSW requests", "committedDate": "2020-10-06T00:30:05Z", "type": "commit"}, {"oid": "34f7238e60857c6099944622084023b5ff9858b4", "url": "https://github.com/codice/ddf/commit/34f7238e60857c6099944622084023b5ff9858b4", "message": "Fix catalog itests", "committedDate": "2020-10-06T00:30:06Z", "type": "commit"}, {"oid": "34f7238e60857c6099944622084023b5ff9858b4", "url": "https://github.com/codice/ddf/commit/34f7238e60857c6099944622084023b5ff9858b4", "message": "Fix catalog itests", "committedDate": "2020-10-06T00:30:06Z", "type": "forcePushed"}, {"oid": "73d032050b08fedc65993cadea931f67de610f4c", "url": "https://github.com/codice/ddf/commit/73d032050b08fedc65993cadea931f67de610f4c", "message": "Take 3 for the rest endpoint itest", "committedDate": "2020-10-06T00:37:14Z", "type": "commit"}]}