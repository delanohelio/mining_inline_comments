{"pr_number": 6251, "pr_title": "Log unhandled exceptions during federation strategy future execution", "pr_createdAt": "2020-08-18T23:35:46Z", "pr_url": "https://github.com/codice/ddf/pull/6251", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5MzI4OA==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476493288", "bodyText": "\u270f\ufe0f Might be good to create a custom subclass of RuntimeException for use here, especially as it would allow for the code that catches the exception to handle it differently from other RTExceptions.", "author": "coyotesqrl", "createdAt": "2020-08-25T14:28:35Z", "path": "catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/federation/impl/SortedFederationStrategy.java", "diffHunk": "@@ -332,4 +337,34 @@ public void run() {\n       offsetResultQueue.closeResultQueue();\n     }\n   }\n+\n+  /**\n+   * Logs unhandled Throwable, adds processing details, and closes the result queue when Errors\n+   * (e.g. NoClassDefFoundError) and RuntimeExceptions are thrown from the wrapped runnable.\n+   */\n+  static class QueryResponseRunnableMonitor implements Runnable {\n+\n+    final Runnable wrapped;\n+\n+    final QueryResponseImpl queryResponse;\n+\n+    QueryResponseRunnableMonitor(Runnable runnable, QueryResponseImpl queryResponse) {\n+      wrapped = runnable;\n+      this.queryResponse = queryResponse;\n+    }\n+\n+    @Override\n+    public void run() {\n+      try {\n+        wrapped.run();\n+      } catch (Throwable t) {\n+        LOGGER.debug(\"Unhandled exception while watching query response runnable.\", t);\n+        queryResponse\n+            .getProcessingDetails()\n+            .add(new ProcessingDetailsImpl(\"unknown\", new RuntimeException(t)));", "originalCommit": "614b70c269ce62403f4365fd6c6188a1957b4b59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY1NTM1OA==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476655358", "bodyText": "I think I would need to be exporting that exception for it to help other modules.  If I export from the standard framework, then that would create coupling to that module.  Though I think throwing a FederationException would make sense here since it is from the federation strategy which throws FederationExceptions.", "author": "pklinef", "createdAt": "2020-08-25T18:32:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5MzI4OA=="}], "type": "inlineReview", "revised_code": {"commit": "afa9e9ec57d945706c90f5e0b0594976d9452a09", "chunk": "diff --git a/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/federation/impl/SortedFederationStrategy.java b/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/federation/impl/SortedFederationStrategy.java\nindex c535756899..80dd75df27 100644\n--- a/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/federation/impl/SortedFederationStrategy.java\n+++ b/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/federation/impl/SortedFederationStrategy.java\n\n@@ -361,7 +362,9 @@ public void run() {\n         LOGGER.debug(\"Unhandled exception while watching query response runnable.\", t);\n         queryResponse\n             .getProcessingDetails()\n-            .add(new ProcessingDetailsImpl(\"unknown\", new RuntimeException(t)));\n+            .add(\n+                new ProcessingDetailsImpl(\n+                    \"unknown\", new FederationException(\"Failed to apply federation strategy.\", t)));\n         queryResponse.closeResultQueue();\n         throw t;\n       }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5Nzc4Ng==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476497786", "bodyText": "\u270f\ufe0f !isEmpty() instead of size check.", "author": "coyotesqrl", "createdAt": "2020-08-25T14:34:26Z", "path": "catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java", "diffHunk": "@@ -219,18 +219,38 @@ QueryResponse query(\n       queryResponse = processPostQueryAccessPlugins(queryResponse);\n       queryResponse = processPostQueryPlugins(queryResponse);\n \n-      LOGGER.trace(\"AfterPostQueryFilter result size: {}\", queryResponse.getResults().size());\n-      LOGGER.trace(\"Total Hit count: {}\", queryResponse.getHits());\n+      log(queryResponse);\n \n     } catch (OAuthPluginException e) {\n       throw e;\n     } catch (RuntimeException re) {\n+      LOGGER.debug(\"Unhandled runtime exception during query\", re);\n       throw new UnsupportedQueryException(\"Exception during runtime while performing query\", re);\n     }\n \n     return queryResponse;\n   }\n \n+  private void log(QueryResponse queryResponse) {\n+    LOGGER.trace(\"AfterPostQueryFilter result size: {}\", queryResponse.getResults().size());\n+    LOGGER.trace(\"Total Hit count: {}\", queryResponse.getHits());\n+    if (LOGGER.isTraceEnabled() && queryResponse.getProcessingDetails() != null) {\n+      LOGGER.trace(\"Processing details count: {}\", queryResponse.getProcessingDetails().size());\n+      for (ProcessingDetails details : queryResponse.getProcessingDetails()) {\n+        if (details.getException() != null) {\n+          LOGGER.trace(\n+              \"Source [{}] query exception\", details.getSourceId(), details.getException());\n+        }\n+        if (details.getWarnings() != null && details.getWarnings().size() > 0) {", "originalCommit": "614b70c269ce62403f4365fd6c6188a1957b4b59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4Njg2MQ==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476586861", "bodyText": "What are the trade offs between a size check and using isEmpty?\nhttps://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/classes/java/util/ArrayList.java#L278-L294", "author": "pklinef", "createdAt": "2020-08-25T16:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5Nzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NzQ1MA==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476667450", "bodyText": "Clarity over performance (which is negligible). Having been tasked with resolving a lot of SonarQube findings recently, it's fresh on my mind. Though I can't find a link to it right now, it pops up as a minor code smell.", "author": "coyotesqrl", "createdAt": "2020-08-25T18:53:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5Nzc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY5MjQ4Mw==", "url": "https://github.com/codice/ddf/pull/6251#discussion_r476692483", "bodyText": "I think I found it.\n\nUsing Collection.size() to test for emptiness works, but using Collection.isEmpty() makes the code more readable and can be more performant. The time complexity of any isEmpty() method implementation should be O(1) whereas some implementations of size() can be O(n).\n\nhttps://rules.sonarsource.com/java/tag/clumsy/RSPEC-1155", "author": "pklinef", "createdAt": "2020-08-25T19:39:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5Nzc4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "c6f74b36aa65eaa8ba63f4a53cc58c54ff26db40", "chunk": "diff --git a/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java b/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java\nindex af7beb35ea..7827a37b86 100644\n--- a/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java\n+++ b/catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java\n\n@@ -241,7 +241,7 @@ private void log(QueryResponse queryResponse) {\n           LOGGER.trace(\n               \"Source [{}] query exception\", details.getSourceId(), details.getException());\n         }\n-        if (details.getWarnings() != null && details.getWarnings().size() > 0) {\n+        if (details.getWarnings() != null && !details.getWarnings().isEmpty()) {\n           LOGGER.trace(\n               \"Source [{}] warnings: {}\",\n               details.getSourceId(),\n"}}, {"oid": "afa9e9ec57d945706c90f5e0b0594976d9452a09", "url": "https://github.com/codice/ddf/commit/afa9e9ec57d945706c90f5e0b0594976d9452a09", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-25T18:35:33Z", "type": "forcePushed"}, {"oid": "c6f74b36aa65eaa8ba63f4a53cc58c54ff26db40", "url": "https://github.com/codice/ddf/commit/c6f74b36aa65eaa8ba63f4a53cc58c54ff26db40", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-26T19:53:59Z", "type": "forcePushed"}, {"oid": "db80c0e6238c95bd87bfc5fcafb79583ada3f5e3", "url": "https://github.com/codice/ddf/commit/db80c0e6238c95bd87bfc5fcafb79583ada3f5e3", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-28T20:13:40Z", "type": "forcePushed"}, {"oid": "8c6d237443d1c784a3b6731d14888440c706cdb9", "url": "https://github.com/codice/ddf/commit/8c6d237443d1c784a3b6731d14888440c706cdb9", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-31T20:18:53Z", "type": "forcePushed"}, {"oid": "4e6f4f18a45591258fa145dc9020653898c700ab", "url": "https://github.com/codice/ddf/commit/4e6f4f18a45591258fa145dc9020653898c700ab", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-31T22:54:26Z", "type": "commit"}, {"oid": "4e6f4f18a45591258fa145dc9020653898c700ab", "url": "https://github.com/codice/ddf/commit/4e6f4f18a45591258fa145dc9020653898c700ab", "message": "Log unhandled exceptions during federation strategy future execution\n\n- Added a future monitor to SortedFederationStrategy to watch for\n  unhandled exceptions while monitoring source responses or offsetting\n  results to log, close the queue, and add processing details\n- Added additional logging in catalog framework to log unhandled\n  exceptions and query processing details\n- Fixed a bug where QueryResponseImpl would set its timeout to 0 from\n  the QueryImpl default value which for Query means no timeout but in\n  QueryResponseImpl would disable blocking for all take/poll methods", "committedDate": "2020-08-31T22:54:26Z", "type": "forcePushed"}]}