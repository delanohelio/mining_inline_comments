{"pr_number": 175, "pr_title": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM", "pr_createdAt": "2020-05-04T12:18:22Z", "pr_url": "https://github.com/eclipse/jkube/pull/175", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1NzA4Mw==", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r422057083", "bodyText": "this if condition feels redundant.", "author": "dev-gaur", "createdAt": "2020-05-08T10:00:00Z", "path": "jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java", "diffHunk": "@@ -56,23 +56,40 @@ private DockerFileUtil() {}\n      */\n     public static List<String> extractBaseImages(File dockerFile, Properties properties) throws IOException {\n         List<String[]> fromLines = extractLines(dockerFile, \"FROM\", properties);\n+        Map<String, String> args = extractArgs(extractLines(dockerFile, \"ARG\", properties));\n         Set<String> result = new LinkedHashSet<>();\n         Set<String> fromAlias = new HashSet<>();\n         for (String[] fromLine :  fromLines) {\n             if (fromLine.length > 1) {", "originalCommit": "cfaaeb402c45c9855f2b2f0d35f344519dffa3f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1ODMyOA==", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r422058328", "bodyText": "Line 63", "author": "dev-gaur", "createdAt": "2020-05-08T10:02:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA1NzA4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "chunk": "diff --git a/jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\nsimilarity index 73%\nrename from jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java\nrename to jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\nindex 2e6d78d1..b889f6b5 100644\n--- a/jkube-kit/build/service/docker/src/main/java/org/eclipse/jkube/kit/build/service/docker/helper/DockerFileUtil.java\n+++ b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\n\n@@ -54,21 +55,19 @@ public class DockerFileUtil {\n      * @return LinkedList of base images name or empty collection if none is found.\n      * @throws IOException if there's a problem while performin IO operations.\n      */\n-    public static List<String> extractBaseImages(File dockerFile, Properties properties) throws IOException {\n-        List<String[]> fromLines = extractLines(dockerFile, \"FROM\", properties);\n-        Map<String, String> args = extractArgs(extractLines(dockerFile, \"ARG\", properties));\n+    public static List<String> extractBaseImages(File dockerFile, Properties properties, String filter) throws IOException {\n+        List<String[]> fromLines = extractLines(dockerFile, \"FROM\", properties, filter);\n+        Map<String, String> args = extractArgs(dockerFile, properties, filter);\n         Set<String> result = new LinkedHashSet<>();\n         Set<String> fromAlias = new HashSet<>();\n         for (String[] fromLine :  fromLines) {\n-            if (fromLine.length > 1) {\n-                if (fromLine.length == 2) { // FROM image:tag use case\n+            if (fromLine.length == 2) { // FROM image:tag use case\n+                result.add(resolveImageTagFromArgs(fromLine[1], args));\n+            } else if (fromLine.length == 4) { // FROM image:tag AS alias use case\n+                if (!fromAlias.contains(fromLine[1])) {\n                     result.add(resolveImageTagFromArgs(fromLine[1], args));\n-                } else if (fromLine.length == 4) { // FROM image:tag AS alias use case\n-                    if (!fromAlias.contains(fromLine[1])) {\n-                        result.add(resolveImageTagFromArgs(fromLine[1], args));\n-                    }\n-                    fromAlias.add(resolveImageTagFromArgs(fromLine[3], args));\n                 }\n+                fromAlias.add(resolveImageTagFromArgs(fromLine[3], args));\n             }\n         }\n         return new ArrayList<>(result);\n"}}, {"oid": "724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "url": "https://github.com/eclipse/jkube/commit/724e8f2d42cd2215df5a1b21b8cba8c5aa6be860", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\n port of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-09-11T16:17:18Z", "type": "forcePushed"}, {"oid": "1c945891e034f995cc11345179cd4643e6eab1ac", "url": "https://github.com/eclipse/jkube/commit/1c945891e034f995cc11345179cd4643e6eab1ac", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-27T18:29:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MDY2NQ==", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r514880665", "bodyText": "This Regex is dangerous, and reported as a bug https://sonarcloud.io/project/issues?id=jkubeio_jkube&open=AXVraCJxz5kaBwk-uluS&pullRequest=175&resolved=false&types=BUG", "author": "manusa", "createdAt": "2020-10-30T05:34:19Z", "path": "jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java", "diffHunk": "@@ -209,4 +273,36 @@ private static File getHomeDir() {\n         return new File(homeDir);\n     }\n \n+    private static void updateMapWithArgValue(Map<String, String> result, Map<String, String> args, String argString) {\n+        if (argString.contains(\"=\") || argString.contains(\":\")) {\n+            String[] argStringParts = argString.split(\"[=:]\");\n+            String argStringValue = argString.substring(argStringParts[0].length() + 1);\n+            if (argStringValue.startsWith(\"\\\"\") || argStringValue.startsWith(\"'\")) {\n+                // Replaces surrounding quotes\n+                argStringValue = argStringValue.replaceAll(\"^\\\"|\\\"|'|'$\", \"\");", "originalCommit": "1c945891e034f995cc11345179cd4643e6eab1ac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98e914841b8a967eeaaa58cbed6c96581af2f55f", "chunk": "diff --git a/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\nindex a2103e22..bec84672 100644\n--- a/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\n+++ b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\n\n@@ -279,7 +279,7 @@ public class DockerFileUtil {\n             String argStringValue = argString.substring(argStringParts[0].length() + 1);\n             if (argStringValue.startsWith(\"\\\"\") || argStringValue.startsWith(\"'\")) {\n                 // Replaces surrounding quotes\n-                argStringValue = argStringValue.replaceAll(\"^\\\"|\\\"|'|'$\", \"\");\n+                argStringValue = argStringValue.replaceAll(\"^[\\\"']+|[\\\"']$\", \"\");\n             } else {\n                 validateArgValue(argStringValue);\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4MDkxMA==", "url": "https://github.com/eclipse/jkube/pull/175#discussion_r514880910", "bodyText": "Declare the pattern as a constant, it's thread-safe. This way you're compiling the pattern  for every method call.", "author": "manusa", "createdAt": "2020-10-30T05:35:14Z", "path": "jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java", "diffHunk": "@@ -130,6 +146,54 @@ private static Reader getFileReaderFromDir(File file) {\n         }\n     }\n \n+    /**\n+     * Helper method for extractArgs(exposed for test)\n+     *\n+     * @param argLines list of string arrays containing lines with words\n+     * @param argsFromBuildConfig Docker build args from Build Configuration\n+     * @return map of parsed arguments\n+     */\n+    protected static Map<String, String> extractArgsFromLines(List<String[]> argLines, Map<String, String> argsFromBuildConfig) {\n+        Map<String, String> result = new HashMap<>();\n+        for (String[] argLine : argLines) {\n+            if (argLine.length > 1) {\n+                updateMapWithArgValue(result, argsFromBuildConfig, argLine[1]);\n+            }\n+        }\n+        return result;\n+    }\n+\n+    private static String resolveImageTagFromArgs(String imageTagString, Map<String, String> args) {\n+        if (imageTagString.startsWith(\"$\")) { // FROM $IMAGE\n+            String resolvedVal = resolveArgValueFromStrContainingArgKey(imageTagString, args);\n+            if (resolvedVal != null) {\n+                return resolvedVal;\n+            }\n+        } else { // FROM image:$TAG_ARG\n+            String[] imageTagArr = imageTagString.split(\":\");\n+            if (imageTagArr.length > 1) {\n+                String tag = resolveArgValueFromStrContainingArgKey(imageTagArr[1], args);\n+                if (tag != null) {\n+                    return imageTagArr[0] + \":\" + tag;\n+                }\n+            }\n+        }\n+        return imageTagString;\n+    }\n+\n+    static String resolveArgValueFromStrContainingArgKey(String argString, Map<String, String> args) {\n+        Pattern argPattern = Pattern.compile(ARG_PATTERN_REGEX);", "originalCommit": "1c945891e034f995cc11345179cd4643e6eab1ac", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98e914841b8a967eeaaa58cbed6c96581af2f55f", "chunk": "diff --git a/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\nindex a2103e22..bec84672 100644\n--- a/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\n+++ b/jkube-kit/build/api/src/main/java/org/eclipse/jkube/kit/build/api/helper/DockerFileUtil.java\n\n@@ -182,7 +182,7 @@ public class DockerFileUtil {\n     }\n \n     static String resolveArgValueFromStrContainingArgKey(String argString, Map<String, String> args) {\n-        Pattern argPattern = Pattern.compile(ARG_PATTERN_REGEX);\n+        final Pattern argPattern = Pattern.compile(ARG_PATTERN_REGEX);\n         Matcher matcher = argPattern.matcher(argString);\n         if (matcher.matches()) {\n             if (matcher.group(1) != null) {\n"}}, {"oid": "98e914841b8a967eeaaa58cbed6c96581af2f55f", "url": "https://github.com/eclipse/jkube/commit/98e914841b8a967eeaaa58cbed6c96581af2f55f", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-30T11:02:15Z", "type": "forcePushed"}, {"oid": "7355a25858f3aae89a8b1413351b30ae9e8df66e", "url": "https://github.com/eclipse/jkube/commit/7355a25858f3aae89a8b1413351b30ae9e8df66e", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-30T11:04:40Z", "type": "forcePushed"}, {"oid": "50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "url": "https://github.com/eclipse/jkube/commit/50ec7f07657c50ad87b3ed1f406aabb4fc3f6423", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-30T11:11:28Z", "type": "forcePushed"}, {"oid": "2b693e6dd78b2c6d57db44557d5d1e48165148a4", "url": "https://github.com/eclipse/jkube/commit/2b693e6dd78b2c6d57db44557d5d1e48165148a4", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-30T13:02:04Z", "type": "commit"}, {"oid": "2b693e6dd78b2c6d57db44557d5d1e48165148a4", "url": "https://github.com/eclipse/jkube/commit/2b693e6dd78b2c6d57db44557d5d1e48165148a4", "message": "Fix #174: Build failure when trying to use Dockerfile for arguments in FROM\n\nPort of fabric8io/docker-maven-plugin#1299", "committedDate": "2020-10-30T13:02:04Z", "type": "forcePushed"}]}