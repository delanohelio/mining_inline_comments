{"pr_number": 728, "pr_title": "Updates the tokenizer settings for SearchableEntity and PrefixSearchableEntity", "pr_createdAt": "2020-04-22T08:27:11Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/728", "timeline": [{"oid": "dcd83909a2d922123acac8860255c5fae3618bb9", "url": "https://github.com/scireum/sirius-biz/commit/dcd83909a2d922123acac8860255c5fae3618bb9", "message": "BREAKING CHANGE: Changes the index settings for SearchableEntities.\n\nThe searchField only contains tokenized data solely for the purpose\nof index lookups. There is no benefit of storing or retrieving this\ndata in either an ES field or the _source itself.\n\nHowever, this is a breaking change, as this leads to a re-index\nfor subclasses of this entity.", "committedDate": "2020-04-22T08:25:35Z", "type": "commit"}, {"oid": "6ff114db7c5e0cb7cbd3d1bb71196e08ef35eeab", "url": "https://github.com/scireum/sirius-biz/commit/6ff114db7c5e0cb7cbd3d1bb71196e08ef35eeab", "message": "Merge remote-tracking branch 'origin/master' into aha/make-searchable-entities-great-again", "committedDate": "2020-06-02T17:22:46Z", "type": "commit"}, {"oid": "87ef11ae9b9e60b1021c622b5ae3004d83a8741a", "url": "https://github.com/scireum/sirius-biz/commit/87ef11ae9b9e60b1021c622b5ae3004d83a8741a", "message": "Uses the new tokenization framework for SearchableEntities.", "committedDate": "2020-06-02T21:04:53Z", "type": "commit"}, {"oid": "3ece5b3a7fe84b210a8204450ba0414805b762db", "url": "https://github.com/scireum/sirius-biz/commit/3ece5b3a7fe84b210a8204450ba0414805b762db", "message": "Adds a remark which encourages the user to fill storage.sharedSecret.\n\nWe also now prevent a startup warning in case it is not filled\n(as the framework might be unused). If required, the framework\nwill emit an appropriate warning itself.", "committedDate": "2020-06-02T21:06:50Z", "type": "commit"}, {"oid": "334f1181c5dfb8c15cfb7bb8794954686ce1de29", "url": "https://github.com/scireum/sirius-biz/commit/334f1181c5dfb8c15cfb7bb8794954686ce1de29", "message": " Uses the new tokenizer framework for PrefixSearchableEntities.", "committedDate": "2020-06-02T21:07:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1MjkzNA==", "url": "https://github.com/scireum/sirius-biz/pull/728#discussion_r434352934", "bodyText": "W\u00e4rs ned vllt sauberer wenn man da nen Consumer f\u00fcr Strings bekommt, der dann automatisch den Tokenizer daf\u00fcr aufruft? Also einfach damit man ned selbst addContentAsTokens aufrufen muss und vor allem keinen Pfusch mit dem Tokenizer machen kann", "author": "sabieber", "createdAt": "2020-06-03T07:09:35Z", "path": "src/main/java/sirius/biz/mongo/PrefixSearchableEntity.java", "diffHunk": "@@ -66,51 +49,52 @@ protected void updateSearchField() {\n \n         getSearchPrefixes().clear();\n \n+        Tokenizer tokenizer = createPrefixTokenizer();\n         this.getDescriptor()\n             .getProperties()\n             .stream()\n             .filter(p -> p.getAnnotation(PrefixSearchContent.class).isPresent())\n             .map(p -> p.tryAs(PrefixSearchableContentConsumer.class).orElse((entity, consumer) -> {\n                 consumer.accept(p.getValue(this));\n             }))\n-            .forEach(consumer -> consumer.accept(this, this::addContentAsTokens));\n+            .forEach(consumer -> consumer.accept(this, value -> addContentAsTokens(tokenizer, value)));\n+\n+        addCustomSearchPrefixes(tokenizer);\n+    }\n+\n+    /**\n+     * Adds custom fields as search prefixes.\n+     * <p>\n+     * This method is empty by default and intended to be overwritten by sub classes.\n+     */\n+    protected void addCustomSearchPrefixes(Tokenizer tokenizer) {", "originalCommit": "334f1181c5dfb8c15cfb7bb8794954686ce1de29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM4NzAzMA==", "url": "https://github.com/scireum/sirius-biz/pull/728#discussion_r434387030", "bodyText": "aber dann kann man keinen pfusch mehr mit dem tokenizer machen :-P", "author": "andyHa", "createdAt": "2020-06-03T08:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM1MjkzNA=="}], "type": "inlineReview", "revised_code": {"commit": "db2ae02c77304c688c9f5ed3348fdee573028567", "chunk": "diff --git a/src/main/java/sirius/biz/mongo/PrefixSearchableEntity.java b/src/main/java/sirius/biz/mongo/PrefixSearchableEntity.java\nindex 55543a3c..713ac4ec 100644\n--- a/src/main/java/sirius/biz/mongo/PrefixSearchableEntity.java\n+++ b/src/main/java/sirius/biz/mongo/PrefixSearchableEntity.java\n\n@@ -59,15 +59,18 @@ public abstract class PrefixSearchableEntity extends MongoEntity {\n             }))\n             .forEach(consumer -> consumer.accept(this, value -> addContentAsTokens(tokenizer, value)));\n \n-        addCustomSearchPrefixes(tokenizer);\n+        addCustomSearchPrefixes(token -> addContentAsTokens(tokenizer, token));\n     }\n \n     /**\n      * Adds custom fields as search prefixes.\n      * <p>\n      * This method is empty by default and intended to be overwritten by sub classes.\n+     *\n+     * @param contentConsumer can be supplied with strings to be tokenized and added to the list\n+     *                        of search prefixes\n      */\n-    protected void addCustomSearchPrefixes(Tokenizer tokenizer) {\n+    protected void addCustomSearchPrefixes(Consumer<String> contentConsumer) {\n         // Empty by default, to be overwritten by sub classes\n     }\n \n"}}, {"oid": "db2ae02c77304c688c9f5ed3348fdee573028567", "url": "https://github.com/scireum/sirius-biz/commit/db2ae02c77304c688c9f5ed3348fdee573028567", "message": "Simplifies the API used to provide custom search prefixes.", "committedDate": "2020-06-03T08:15:42Z", "type": "commit"}, {"oid": "0beb069a23a833edba7d0b3dbb99ad02f2a42f94", "url": "https://github.com/scireum/sirius-biz/commit/0beb069a23a833edba7d0b3dbb99ad02f2a42f94", "message": "Updates to the simpler API of the Tokenizer.", "committedDate": "2020-06-05T07:02:11Z", "type": "commit"}, {"oid": "70004ea9f39aad5cdc4998e6b64dfc27689732d4", "url": "https://github.com/scireum/sirius-biz/commit/70004ea9f39aad5cdc4998e6b64dfc27689732d4", "message": "Keeps the search contents in the _source field.\n\nOtherwise we'd had to re-tokenized the data\nin every update, which isn't guaranteed by the\nframework.\n\nTherefore this would open up a bunch of dataloss\nproblems when using this entity in certain circumstances.\nAlso, loading the field isn't that expensive anyway as it should\nbe quite small for most entities.", "committedDate": "2020-06-05T07:04:56Z", "type": "commit"}, {"oid": "472a28a8fabc9dccfad7a92ae1bdf50103f36601", "url": "https://github.com/scireum/sirius-biz/commit/472a28a8fabc9dccfad7a92ae1bdf50103f36601", "message": "Updates to the latest sirius-kernel.", "committedDate": "2020-06-05T07:05:11Z", "type": "commit"}, {"oid": "ebcd9c596c3f984b46ce981817c811ad5c244170", "url": "https://github.com/scireum/sirius-biz/commit/ebcd9c596c3f984b46ce981817c811ad5c244170", "message": "Merge remote-tracking branch 'origin/master' into aha/make-searchable-entities-great-again", "committedDate": "2020-06-05T07:05:20Z", "type": "commit"}, {"oid": "da3b5ffd1e595fbbd2676d3381b5abae7f79e16a", "url": "https://github.com/scireum/sirius-biz/commit/da3b5ffd1e595fbbd2676d3381b5abae7f79e16a", "message": "Uses the proper ToLowercaseProcessor and adds a JavaDoc.", "committedDate": "2020-06-05T07:07:43Z", "type": "commit"}, {"oid": "6c05b740e90bbe09ae0c0aae7fee34874fa94cea", "url": "https://github.com/scireum/sirius-biz/commit/6c05b740e90bbe09ae0c0aae7fee34874fa94cea", "message": "Adapts to the new API of Tokenizer in sirius-db.", "committedDate": "2020-06-05T07:30:13Z", "type": "commit"}, {"oid": "6c05b740e90bbe09ae0c0aae7fee34874fa94cea", "url": "https://github.com/scireum/sirius-biz/commit/6c05b740e90bbe09ae0c0aae7fee34874fa94cea", "message": "Adapts to the new API of Tokenizer in sirius-db.", "committedDate": "2020-06-05T07:30:13Z", "type": "forcePushed"}, {"oid": "51bd1a8d2925fc812e6c0c80571ef2c485170118", "url": "https://github.com/scireum/sirius-biz/commit/51bd1a8d2925fc812e6c0c80571ef2c485170118", "message": "Removes Controller from all @Registers.", "committedDate": "2020-06-09T07:58:29Z", "type": "commit"}, {"oid": "7cc4e64d619f4bff23f6f0f69c11c0ae53549b4a", "url": "https://github.com/scireum/sirius-biz/commit/7cc4e64d619f4bff23f6f0f69c11c0ae53549b4a", "message": "Merge remote-tracking branch 'origin/master' into aha/make-searchable-entities-great-again", "committedDate": "2020-06-09T07:58:41Z", "type": "commit"}, {"oid": "c285c8febd1555666d8d040d71c8b92a8f531a4f", "url": "https://github.com/scireum/sirius-biz/commit/c285c8febd1555666d8d040d71c8b92a8f531a4f", "message": "Improves imports and fixes sonarlint inspections.", "committedDate": "2020-06-09T08:20:04Z", "type": "commit"}, {"oid": "9044a21749b3011d0a458963928c83e52222951a", "url": "https://github.com/scireum/sirius-biz/commit/9044a21749b3011d0a458963928c83e52222951a", "message": "Updates to the latest sirius dependencies.", "committedDate": "2020-06-09T08:43:16Z", "type": "commit"}, {"oid": "949b80dc122ed7b836b0e7ef91eeb008001d0041", "url": "https://github.com/scireum/sirius-biz/commit/949b80dc122ed7b836b0e7ef91eeb008001d0041", "message": "Removes prematurely committed code.", "committedDate": "2020-06-09T09:06:30Z", "type": "commit"}]}