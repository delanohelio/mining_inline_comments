{"pr_number": 906, "pr_title": "Improves handling of archives in file based import jobs and especially reworks the archive extraction job.", "pr_createdAt": "2020-11-11T21:17:20Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/906", "timeline": [{"oid": "98a764cb70a8b202395544b1f6c87527854c1be3", "url": "https://github.com/scireum/sirius-biz/commit/98a764cb70a8b202395544b1f6c87527854c1be3", "message": "Merge branch 'aha/make-parameters-great-again' into aha/archive-jobs", "committedDate": "2020-11-11T20:42:49Z", "type": "commit"}, {"oid": "ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "url": "https://github.com/scireum/sirius-biz/commit/ee4bea40e7ef6ffbb852b3f6ff11191b2d8d8fb5", "message": "Uses the new constants as provided by sirius-db.", "committedDate": "2020-11-11T21:02:09Z", "type": "commit"}, {"oid": "8016e7777932d2451ef8321f22af211dfe817ac9", "url": "https://github.com/scireum/sirius-biz/commit/8016e7777932d2451ef8321f22af211dfe817ac9", "message": "Makes the FileImportJob use the ArchiveExtractor and adds support for handling auxiliary files.", "committedDate": "2020-11-11T21:04:10Z", "type": "commit"}, {"oid": "774c048126fcc9d7b404b35daaafac5257d32652", "url": "https://github.com/scireum/sirius-biz/commit/774c048126fcc9d7b404b35daaafac5257d32652", "message": "Uses the new API as defined by the FileImportJob.", "committedDate": "2020-11-11T21:05:02Z", "type": "commit"}, {"oid": "8396fa50c19c57e074fe9c36094077649da33a09", "url": "https://github.com/scireum/sirius-biz/commit/8396fa50c19c57e074fe9c36094077649da33a09", "message": "Uses the new API as defined by FileImportJob.\n\nThis greatly simplifies the internal workings as it eliminates a whole\nbunch of duplicate code.", "committedDate": "2020-11-11T21:06:01Z", "type": "commit"}, {"oid": "fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "url": "https://github.com/scireum/sirius-biz/commit/fc230b5dc579281ba1d8feb62c5d9d4d6db496e1", "message": "Supports the new API as defined by FileImportJob and adds support to import all sheets of an excel file.", "committedDate": "2020-11-11T21:07:21Z", "type": "commit"}, {"oid": "e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "url": "https://github.com/scireum/sirius-biz/commit/e8d46aa792eba500cc06f0b6b9b23b5fd1bd2a9b", "message": "Provides updated translations for the refactored jobs.", "committedDate": "2020-11-11T21:08:19Z", "type": "commit"}, {"oid": "6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "url": "https://github.com/scireum/sirius-biz/commit/6ac8f4a984357e4f952ee8b8ca326da207c8cdd4", "message": "Provides some cleanup for the ArchiveImportJob.", "committedDate": "2020-11-11T21:08:40Z", "type": "commit"}, {"oid": "e7b86eafd6eb0de75af377f1160013d81bf7038e", "url": "https://github.com/scireum/sirius-biz/commit/e7b86eafd6eb0de75af377f1160013d81bf7038e", "message": "Refactors the extract archive job.\n\nBy default we now overwrite files if a change is detected (SIRI-279) and also permit to delete\nthe archive once all files are extracted (SIRI-276).\n\nWe also reduced the logging quite a bit (which is still available in debug mode). Also we now\nrequire a destination to be given and no longer use the parent directory of the archive\nas fallback (as this provides quite a potential for trouble).", "committedDate": "2020-11-11T21:15:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkzNjAzOQ==", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r521936039", "bodyText": "sourceParameter", "author": "mkeckmkeck", "createdAt": "2020-11-12T08:50:49Z", "path": "src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.storage.layer3;\n+\n+import sirius.biz.jobs.batch.SimpleBatchProcessJobFactory;\n+import sirius.biz.jobs.params.BooleanParameter;\n+import sirius.biz.jobs.params.EnumParameter;\n+import sirius.biz.jobs.params.Parameter;\n+import sirius.biz.process.PersistencePeriod;\n+import sirius.biz.process.ProcessContext;\n+import sirius.biz.process.logs.ProcessLog;\n+import sirius.biz.storage.layer1.FileHandle;\n+import sirius.biz.util.ArchiveExtractor;\n+import sirius.biz.util.ExtractedFile;\n+import sirius.kernel.async.TaskContext;\n+import sirius.kernel.commons.Files;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.http.QueryString;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.util.ArrayList;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides a job able to extract archives from the {@link VirtualFileSystem}.\n+ * <p>\n+ * This uses the {@link ArchiveExtractor} so depending if 7-ZIP is enabled this supports either a whole bunch\n+ * of formats (rar, 7z, tar etc.) or \"just\" ZIP files using the Java API.\n+ */\n+@Register\n+public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n+\n+    @Part\n+    private VirtualFileSystem vfs;\n+\n+    @Part\n+    private ArchiveExtractor extractor;\n+\n+    private final Parameter<VirtualFile> sourceParamter;", "originalCommit": "e7b86eafd6eb0de75af377f1160013d81bf7038e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f838bd1258a19e04e28060ea8ba7364a6739fde5", "chunk": "diff --git a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\nindex 84b2a2f0..4248f0b0 100644\n--- a/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n+++ b/src/main/java/sirius/biz/storage/layer3/ExtractArchiveJob.java\n\n@@ -48,7 +48,7 @@ public class ExtractArchiveJob extends SimpleBatchProcessJobFactory {\n     @Part\n     private ArchiveExtractor extractor;\n \n-    private final Parameter<VirtualFile> sourceParamter;\n+    private final Parameter<VirtualFile> sourceParameter;\n     private final Parameter<VirtualFile> destinationParameter;\n     private final Parameter<ArchiveExtractor.OverrideMode> overwriteExistingFilesParameter;\n     private final Parameter<Boolean> deleteArchiveParameter;\n"}}, {"oid": "26781b29a991845de401bcc27510d029f047a174", "url": "https://github.com/scireum/sirius-biz/commit/26781b29a991845de401bcc27510d029f047a174", "message": "Merge remote-tracking branch 'origin/master' into aha/archive-jobs\n\n# Conflicts:\n#\tsrc/main/java/sirius/biz/jobs/batch/file/VirtualFileExtractionJob.java", "committedDate": "2020-11-12T14:52:57Z", "type": "commit"}, {"oid": "f838bd1258a19e04e28060ea8ba7364a6739fde5", "url": "https://github.com/scireum/sirius-biz/commit/f838bd1258a19e04e28060ea8ba7364a6739fde5", "message": "Fixes a typo.", "committedDate": "2020-11-12T14:54:11Z", "type": "commit"}, {"oid": "f693066045e7c968fcabca60d5df6ace8e683d7a", "url": "https://github.com/scireum/sirius-biz/commit/f693066045e7c968fcabca60d5df6ace8e683d7a", "message": "Improves JavaDocs.", "committedDate": "2020-11-12T14:56:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4NTc3Ng==", "url": "https://github.com/scireum/sirius-biz/pull/906#discussion_r522185776", "bodyText": "vfs -> fileSystem?", "author": "sabieber", "createdAt": "2020-11-12T15:19:09Z", "path": "src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java", "diffHunk": "@@ -42,7 +50,48 @@\n      */\n     public static final Parameter<VirtualFile> FILE_PARAMETER = createFileParameter(null);\n \n+    /**\n+     * Determines the mode in which auxiliary files are handled (if this job supports it).\n+     */\n+    public static final Parameter<AuxiliaryFileMode> AUX_FILE_MODE_PARAMETER = new EnumParameter<>(\"auxFileMode\",\n+                                                                                                   \"$FileImportJobFactory.auxFileMode\",\n+                                                                                                   AuxiliaryFileMode.class)\n+            .withDefault(AuxiliaryFileMode.UPDATE_ON_CHANGE)\n+            .markRequired()\n+            .build();\n+\n+    @Part\n+    private static VirtualFileSystem vfs;", "originalCommit": "8016e7777932d2451ef8321f22af211dfe817ac9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "chunk": "diff --git a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\nindex 02bfac38..d8901a27 100644\n--- a/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n+++ b/src/main/java/sirius/biz/jobs/batch/file/FileImportJob.java\n\n@@ -61,7 +61,7 @@ public abstract class FileImportJob extends ImportJob {\n             .build();\n \n     @Part\n-    private static VirtualFileSystem vfs;\n+    private static VirtualFileSystem virtualFileSystem;\n \n     @Part\n     private static ArchiveExtractor extractor;\n"}}, {"oid": "98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "url": "https://github.com/scireum/sirius-biz/commit/98ae7ce3d33d9850e5b10e05d3f485466c5ec0ec", "message": "Code style.", "committedDate": "2020-11-12T15:35:04Z", "type": "commit"}]}