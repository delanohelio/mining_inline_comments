{"pr_number": 1338, "pr_title": "GG-30394 False start of cacheGrpStates initialization(in CheckpointEntry)", "pr_createdAt": "2020-08-03T14:03:55Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1338", "timeline": [{"oid": "c6ae138e992f70222aec47572e04c4ad55bc537e", "url": "https://github.com/gridgain/gridgain/commit/c6ae138e992f70222aec47572e04c4ad55bc537e", "message": "GG-30394 Prototype solution without test.", "committedDate": "2020-08-03T14:03:02Z", "type": "commit"}, {"oid": "2f88a371a0997ac283df54635e4f9c3d991d5191", "url": "https://github.com/gridgain/gridgain/commit/2f88a371a0997ac283df54635e4f9c3d991d5191", "message": "GG-30394 Assertion instead of check.", "committedDate": "2020-08-03T14:10:43Z", "type": "commit"}, {"oid": "9c3072f24745d2c74173e03e6c13e7bc17970130", "url": "https://github.com/gridgain/gridgain/commit/9c3072f24745d2c74173e03e6c13e7bc17970130", "message": "GG-30394 Other fix that won't mess with soft references.", "committedDate": "2020-08-04T06:02:03Z", "type": "commit"}, {"oid": "dd668c6e20a96e6b6085809065d06e6e9f4bf52d", "url": "https://github.com/gridgain/gridgain/commit/dd668c6e20a96e6b6085809065d06e6e9f4bf52d", "message": "GG-30394 First fix rolled back.", "committedDate": "2020-08-04T06:05:15Z", "type": "commit"}, {"oid": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "url": "https://github.com/gridgain/gridgain/commit/b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "message": "GG-30394 \"hasSpace\" removed.", "committedDate": "2020-08-04T08:51:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MTU3MQ==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465041571", "bodyText": "to avoid mistakes in further refactoring, I suggest splitting this method into two with the following signature:\n\nvoid addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates)\nvoid addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CheckpointEntry.GroupState> cacheGrpStates)\n\nAnd extract following code to extra method:\nif (!earliestCp.containsKey(grpPartKey))\n         earliestCp.put(grpPartKey, entry);\n\nbecause if tomorrow somebody changes the condition there are no guarantees that they do it in both places.", "author": "akalash", "createdAt": "2020-08-04T13:15:48Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -240,21 +242,38 @@ public CheckpointEntry lastCheckpointMarkingAsInapplicable(Integer grpId) {\n      * Add last checkpoint to map of the earliest checkpoints.\n      *\n      * @param entry Checkpoint entry.\n+     * @param cacheGrpStates\n      */\n-    private void addCpToEarliestCpMap(CheckpointEntry entry) {\n+    private void addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates) {", "originalCommit": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4MzM0OA==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465583348", "bodyText": "Done", "author": "ibessonov", "createdAt": "2020-08-05T09:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MTU3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\nindex d3d7ace0f09..c9ba347e6b8 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n\n@@ -242,46 +242,54 @@ public class CheckpointHistory {\n      * Add last checkpoint to map of the earliest checkpoints.\n      *\n      * @param entry Checkpoint entry.\n-     * @param cacheGrpStates\n+     * @param cacheStates Cache states map.\n      */\n-    private void addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates) {\n-        try {\n-            if (cacheGrpStates != null) {\n-                for (Integer grpId : cacheGrpStates.keySet()) {\n-                    CacheState cacheState = cacheGrpStates.get(grpId);\n+    private void addCpCacheStatesToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheStates) {\n+        for (Integer grpId : cacheStates.keySet()) {\n+            CacheState cacheState = cacheStates.get(grpId);\n \n-                    for (int pIdx = 0; pIdx < cacheState.size(); pIdx++) {\n-                        int part = cacheState.partitionByIndex(pIdx);\n+            for (int pIdx = 0; pIdx < cacheState.size(); pIdx++) {\n+                int part = cacheState.partitionByIndex(pIdx);\n \n-                        GroupPartitionId grpPartKey = new GroupPartitionId(grpId, part);\n+                GroupPartitionId grpPartKey = new GroupPartitionId(grpId, part);\n \n-                        if (!earliestCp.containsKey(grpPartKey))\n-                            earliestCp.put(grpPartKey, entry);\n-                    }\n-                }\n+                addPartitionToEarliestCheckpoints(grpPartKey, entry);\n             }\n-            else {\n-                Map<Integer, CheckpointEntry.GroupState> states = entry.groupState(cctx);\n+        }\n+    }\n \n-                for (Integer grpId : states.keySet()) {\n-                    CheckpointEntry.GroupState grpState = states.get(grpId);\n+    /**\n+     * Add last checkpoint to map of the earliest checkpoints.\n+     *\n+     * @param entry Checkpoint entry.\n+     * @param cacheGrpStates Group states map.\n+     */\n+    private void addCpGroupStatesToEarliestCpMap(\n+        CheckpointEntry entry,\n+        Map<Integer, CheckpointEntry.GroupState> cacheGrpStates\n+    ) {\n+        for (Integer grpId : cacheGrpStates.keySet()) {\n+            CheckpointEntry.GroupState grpState = cacheGrpStates.get(grpId);\n \n-                    for (int pIdx = 0; pIdx < grpState.size(); pIdx++) {\n-                        int part = grpState.getPartitionByIndex(pIdx);\n+            for (int pIdx = 0; pIdx < grpState.size(); pIdx++) {\n+                int part = grpState.getPartitionByIndex(pIdx);\n \n-                        GroupPartitionId grpPartKey = new GroupPartitionId(grpId, part);\n+                GroupPartitionId grpPartKey = new GroupPartitionId(grpId, part);\n \n-                        if (!earliestCp.containsKey(grpPartKey))\n-                            earliestCp.put(grpPartKey, entry);\n-                    }\n-                }\n+                addPartitionToEarliestCheckpoints(grpPartKey, entry);\n             }\n         }\n-        catch (IgniteCheckedException ex) {\n-            U.warn(log, \"Failed to process checkpoint: \" + (entry != null ? entry : \"none\"), ex);\n+    }\n \n-            earliestCp.clear();\n-        }\n+    /**\n+     * Add entry to earliest checkpoint map. Ignore is such key is already present.\n+     *\n+     * @param grpPartKey Key that consists of cache group id and partition index.\n+     * @param entry Checkpoint entry.\n+     */\n+    private void addPartitionToEarliestCheckpoints(GroupPartitionId grpPartKey, CheckpointEntry entry) {\n+        if (!earliestCp.containsKey(grpPartKey))\n+            earliestCp.put(grpPartKey, entry);\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MzExOQ==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465043119", "bodyText": "I believe it makes sense to add some comment why using cacheGrpStates from entry is a bad idea(to prevent further mistakes)", "author": "akalash", "createdAt": "2020-08-04T13:18:13Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -174,9 +175,10 @@ public WALPointer firstCheckpointPointer() {\n      * is not finished yet.\n      *\n      * @param entry Entry to add.\n+     * @param cacheGrpStates", "originalCommit": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU4NDE5Mg==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465584192", "bodyText": "I doubt that someone will reuse this method, and if they do, they can find current fix I guess.", "author": "ibessonov", "createdAt": "2020-08-05T09:08:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MzExOQ=="}], "type": "inlineReview", "revised_code": {"commit": "3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\nindex d3d7ace0f09..c9ba347e6b8 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n\n@@ -175,10 +175,10 @@ public class CheckpointHistory {\n      * is not finished yet.\n      *\n      * @param entry Entry to add.\n-     * @param cacheGrpStates\n+     * @param cacheStates Cache states map.\n      */\n-    public void addCheckpoint(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates) {\n-        addCpToEarliestCpMap(entry, cacheGrpStates);\n+    public void addCheckpoint(CheckpointEntry entry, Map<Integer, CacheState> cacheStates) {\n+        addCpCacheStatesToEarliestCpMap(entry, cacheStates);\n \n         histMap.put(entry.timestamp(), entry);\n     }\n"}}, {"oid": "3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "url": "https://github.com/gridgain/gridgain/commit/3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "message": "GG-30394 Review remarks addressed.", "committedDate": "2020-08-05T06:20:31Z", "type": "commit"}, {"oid": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "url": "https://github.com/gridgain/gridgain/commit/80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "message": "GG-30394 Missing exception thrown.", "committedDate": "2020-08-06T07:30:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2MTcwNg==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466261706", "bodyText": "As I understand you can skip the assignment of initEx here, because if you just throw an exception from here, initEx will be assignmented in the catch block.", "author": "akalash", "createdAt": "2020-08-06T09:14:26Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java", "diffHunk": "@@ -356,9 +356,12 @@ private void initIfNeeded(\n \n                         grpStates = remap(stateRec);\n                     }\n-                    else\n+                    else {\n                         initEx = new IgniteCheckedException(\n                             \"Failed to find checkpoint record at the given WAL pointer: \" + ptr);\n+\n+                        throw initEx;", "originalCommit": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5NTc5NA==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466295794", "bodyText": "Done.", "author": "ibessonov", "createdAt": "2020-08-06T09:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2MTcwNg=="}], "type": "inlineReview", "revised_code": {"commit": "fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java\nindex a596ddb288e..dde16f1aebf 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java\n\n@@ -357,10 +357,8 @@ public class CheckpointEntry {\n                         grpStates = remap(stateRec);\n                     }\n                     else {\n-                        initEx = new IgniteCheckedException(\n+                        throw new IgniteCheckedException(\n                             \"Failed to find checkpoint record at the given WAL pointer: \" + ptr);\n-\n-                        throw initEx;\n                     }\n                 }\n                 catch (IgniteCheckedException e) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2Mzk5OA==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466263998", "bodyText": "You can use variable 'states' here because entry.groupState(cctx) was called in this method a little earlier.", "author": "akalash", "createdAt": "2020-08-06T09:16:28Z", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -211,7 +213,7 @@ private void updateEarliestCpMap(CheckpointEntry entry) {\n                     iter.remove();\n             }\n \n-            addCpToEarliestCpMap(entry);\n+            addCpGroupStatesToEarliestCpMap(entry, entry.groupState(cctx));", "originalCommit": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI5NTg5MQ==", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466295891", "bodyText": "Done.", "author": "ibessonov", "createdAt": "2020-08-06T09:46:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2Mzk5OA=="}], "type": "inlineReview", "revised_code": {"commit": "fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "chunk": "diff --git a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\nindex c9ba347e6b8..325c20d100a 100644\n--- a/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n+++ b/modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java\n\n@@ -213,7 +213,7 @@ public class CheckpointHistory {\n                     iter.remove();\n             }\n \n-            addCpGroupStatesToEarliestCpMap(entry, entry.groupState(cctx));\n+            addCpGroupStatesToEarliestCpMap(entry, states);\n         }\n         catch (IgniteCheckedException ex) {\n             U.warn(log, \"Failed to process checkpoint: \" + (entry != null ? entry : \"none\"), ex);\n"}}, {"oid": "fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "url": "https://github.com/gridgain/gridgain/commit/fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "message": "GG-30394 Review remarks addressed.", "committedDate": "2020-08-06T09:45:39Z", "type": "commit"}]}