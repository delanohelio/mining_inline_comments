{"pr_number": 1085, "pr_title": "GG-25705: Add kill query action.", "pr_createdAt": "2020-04-20T07:54:15Z", "pr_url": "https://github.com/gridgain/gridgain/pull/1085", "timeline": [{"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "url": "https://github.com/gridgain/gridgain/commit/d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "message": "GG-25705: Add kill query action.", "committedDate": "2020-04-20T07:53:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDA5Ng==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411210096", "bodyText": "Can we receive SQL injections here?", "author": "nva", "createdAt": "2020-04-20T08:57:53Z", "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,27 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n+        return ctx.closure().callLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");", "originalCommit": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1MzcxNw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411353717", "bodyText": "I don't think we should care too much about this here. If the user has access to killing queries, she probably can execute them as well.", "author": "dmekhanikov", "createdAt": "2020-04-20T12:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ2NTMwNA==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411465304", "bodyText": "We have a special action for execution any SQL query, :)", "author": "somjik-api", "createdAt": "2020-04-20T15:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDA5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "chunk": "diff --git a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\nindex d379d305bf4..b5400e6f9ab 100644\n--- a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n+++ b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n\n@@ -93,20 +93,12 @@ public class QueryActionsController {\n      * @param globalQryId Global query id.\n      * @return Kill query result.\n      */\n-    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n-        return ctx.closure().callLocalSafe(() -> {\n-            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");\n-\n-            try (\n-                FieldsQueryCursor<List<?>> cur = qryProc.querySqlFields(qryFields, true);\n-                CursorHolder cursorHolder = new CursorHolder(cur)\n-            ) {\n-                QueryResult res = fetchSqlQueryResult(cursorHolder, 1);\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n+                .setLazy(false);\n \n-                res.setResultNodeId(ctx.localNodeId().toString());\n-\n-                return res;\n-            }\n+            qryProc.querySqlFields(qryFields, true).close();\n         }, MANAGEMENT_POOL);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxNzEyOQ==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411217129", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** ID. */\n          \n          \n            \n                /** Query ID from request. */", "author": "nva", "createdAt": "2020-04-20T09:08:33Z", "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java", "diffHunk": "@@ -23,9 +23,12 @@\n  * Descriptor of running query.\n  */\n public class RunningQuery {\n-    /** */\n+    /** ID. */", "originalCommit": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5NDA2OQ==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411494069", "bodyText": "Done.", "author": "somjik-api", "createdAt": "2020-04-20T15:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxNzEyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "chunk": "diff --git a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java\nindex 9397eea8992..eda01d2869d 100644\n--- a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java\n+++ b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java\n\n@@ -23,7 +23,7 @@ import org.apache.ignite.internal.util.typedef.internal.S;\n  * Descriptor of running query.\n  */\n public class RunningQuery {\n-    /** ID. */\n+    /** Query ID. */\n     private long id;\n \n     /** Global query ID. */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NDI1Mg==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411354252", "bodyText": "Is the result going to be used the frontend?", "author": "dmekhanikov", "createdAt": "2020-04-20T12:56:08Z", "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,27 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n+        return ctx.closure().callLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");\n+\n+            try (\n+                FieldsQueryCursor<List<?>> cur = qryProc.querySqlFields(qryFields, true);\n+                CursorHolder cursorHolder = new CursorHolder(cur)\n+            ) {\n+                QueryResult res = fetchSqlQueryResult(cursorHolder, 1);\n+\n+                res.setResultNodeId(ctx.localNodeId().toString());\n+\n+                return res;", "originalCommit": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ3MTIyMw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411471223", "bodyText": "I think no, make it as cancel action :)", "author": "somjik-api", "createdAt": "2020-04-20T15:27:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NDI1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "chunk": "diff --git a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\nindex d379d305bf4..b5400e6f9ab 100644\n--- a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n+++ b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n\n@@ -93,20 +93,12 @@ public class QueryActionsController {\n      * @param globalQryId Global query id.\n      * @return Kill query result.\n      */\n-    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n-        return ctx.closure().callLocalSafe(() -> {\n-            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");\n-\n-            try (\n-                FieldsQueryCursor<List<?>> cur = qryProc.querySqlFields(qryFields, true);\n-                CursorHolder cursorHolder = new CursorHolder(cur)\n-            ) {\n-                QueryResult res = fetchSqlQueryResult(cursorHolder, 1);\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n+                .setLazy(false);\n \n-                res.setResultNodeId(ctx.localNodeId().toString());\n-\n-                return res;\n-            }\n+            qryProc.querySqlFields(qryFields, true).close();\n         }, MANAGEMENT_POOL);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTI4Mw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411355283", "bodyText": "Please add a test that kill a query started from Ignite directly without using GGCC API.", "author": "dmekhanikov", "createdAt": "2020-04-20T12:57:39Z", "path": "modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java", "diffHunk": "@@ -388,6 +391,62 @@ public void shouldCancelLongQuery() {\n         );\n     }\n \n+    /**\n+     * 1. Execute a query with sleep function.\n+     * 2. Send kill query action with global query id for a query from 1.\n+     * 3. Assert that action was completed and no one running queries exists in a cluster.\n+     */\n+    @Test\n+    public void shouldKillRunningQuery() {", "originalCommit": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Mzk2Nw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411493967", "bodyText": "Added", "author": "somjik-api", "createdAt": "2020-04-20T15:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "chunk": "diff --git a/modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java b/modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java\nindex 22c9ebcded2..b59bf490707 100644\n--- a/modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java\n+++ b/modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java\n\n@@ -392,7 +396,7 @@ public class QueryActionsControllerTest extends AbstractActionControllerTest {\n     }\n \n     /**\n-     * 1. Execute a query with sleep function.\n+     * 1. Execute a query action with sleep function.\n      * 2. Send kill query action with global query id for a query from 1.\n      * 3. Assert that action was completed and no one running queries exists in a cluster.\n      */\n"}}, {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "url": "https://github.com/gridgain/gridgain/commit/6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "message": "GG-25075: Review fixes.", "committedDate": "2020-04-20T15:54:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjEyMw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411532123", "bodyText": "Should we have checks features that \"KILL QUERY\" is supported by node?", "author": "akuznetsov-gridgain", "createdAt": "2020-04-20T16:47:29Z", "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,19 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {", "originalCommit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTgyNTUwMw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411825503", "bodyText": "May be we should define some interceptor for all actions that can validate feature/version from annotation on action method?", "author": "nva", "createdAt": "2020-04-21T02:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjEyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA1NDkzNA==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412054934", "bodyText": "Why we should check it on the agent? I think we should check that we can run some action on UI as we do it with baseline auto-adjust feature.", "author": "somjik-api", "createdAt": "2020-04-21T10:11:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjEyMw=="}], "type": "inlineReview", "revised_code": {"commit": "1182811d6eec758955647cb0bc8e87a5472fffcc", "chunk": "diff --git a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\nindex b5400e6f9ab..d03d6ac30ed 100644\n--- a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n+++ b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n\n@@ -98,7 +101,9 @@ public class QueryActionsController {\n             SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n                 .setLazy(false);\n \n-            qryProc.querySqlFields(qryFields, true).close();\n+            try (FieldsQueryCursor<List<?>> cursor = qryProc.querySqlFields(qryFields, true)) {\n+                cursor.getAll();\n+            }\n         }, MANAGEMENT_POOL);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412149429", "bodyText": "May be it make sense to introduce base class for ActionsControllers?\nAnd declare protected method \"safeExecute(lambda)\" that will accept function to execute?", "author": "akuznetsov-gridgain", "createdAt": "2020-04-21T12:41:32Z", "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,19 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n+                .setLazy(false);\n+\n+            qryProc.querySqlFields(qryFields, true).close();\n+        }, MANAGEMENT_POOL);\n+    }", "originalCommit": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE2Njk2Nw==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412166967", "bodyText": "@nva What do you think about it? If yes then i create a separate ticket for this and change in all places  where it need. But my opinion that it's not require.", "author": "somjik-api", "createdAt": "2020-04-21T13:05:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMyMDIxNQ==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412320215", "bodyText": "It will reduce amount of boilerplate code. IMHO.", "author": "akuznetsov-gridgain", "createdAt": "2020-04-21T16:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjY0ODUxNA==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412648514", "bodyText": "Let's do this in separated ticket.", "author": "nva", "createdAt": "2020-04-22T03:50:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjczNzM4NQ==", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412737385", "bodyText": "Ticket: GG-28865", "author": "somjik-api", "createdAt": "2020-04-22T07:26:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "1182811d6eec758955647cb0bc8e87a5472fffcc", "chunk": "diff --git a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\nindex b5400e6f9ab..d03d6ac30ed 100644\n--- a/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n+++ b/modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java\n\n@@ -98,7 +101,9 @@ public class QueryActionsController {\n             SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n                 .setLazy(false);\n \n-            qryProc.querySqlFields(qryFields, true).close();\n+            try (FieldsQueryCursor<List<?>> cursor = qryProc.querySqlFields(qryFields, true)) {\n+                cursor.getAll();\n+            }\n         }, MANAGEMENT_POOL);\n     }\n \n"}}, {"oid": "d82cf168c183e38f54126382862dec02356799dd", "url": "https://github.com/gridgain/gridgain/commit/d82cf168c183e38f54126382862dec02356799dd", "message": "Merge remote-tracking branch 'origin/8.7-master' into gg-25705\n\n# Conflicts:\n#\tmodules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java", "committedDate": "2020-04-22T16:21:42Z", "type": "commit"}, {"oid": "1182811d6eec758955647cb0bc8e87a5472fffcc", "url": "https://github.com/gridgain/gridgain/commit/1182811d6eec758955647cb0bc8e87a5472fffcc", "message": "GG-25705: Remove instant closing kill query cursor.", "committedDate": "2020-04-22T16:23:19Z", "type": "commit"}]}