{"pr_number": 10873, "pr_title": "Add integration test for transform journaling", "pr_createdAt": "2020-02-10T00:55:10Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10873", "timeline": [{"oid": "e5c56bc516b743fb620972865bbfa46d8450c367", "url": "https://github.com/Alluxio/alluxio/commit/e5c56bc516b743fb620972865bbfa46d8450c367", "message": "add integration test for transform journaling", "committedDate": "2020-02-10T00:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNzE1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10873#discussion_r377437155", "bodyText": "is there a way we can avoid this rule? This doesn't interact well with LocalAlluxioClusterResource especially when LocalAlluxioClusterResource is a class rule (which is ideal, so it only creates the cluster once per class)", "author": "gpang", "createdAt": "2020-02-11T03:53:49Z", "path": "tests/src/test/java/alluxio/server/ft/journal/TableMasterJournalIntegrationTest.java", "diffHunk": "@@ -45,18 +56,17 @@\n \n   private static final String DB_NAME = TestDatabase.TEST_UDB_NAME;\n \n-  @Before\n-  public void before() throws Exception {\n-    TestDatabase.genTable(1, 2);\n-  }\n+  @ClassRule\n+  public static ManuallyScheduleHeartbeat sManuallySchedule = new ManuallyScheduleHeartbeat(", "originalCommit": "e5c56bc516b743fb620972865bbfa46d8450c367", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY0MjE3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10873#discussion_r377642176", "bodyText": "Is there a way we can make the LocalAlluxioClusterResource a ClassRule, and not per test?", "author": "gpang", "createdAt": "2020-02-11T13:45:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNzE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwMTg0Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10873#discussion_r377901847", "bodyText": "If we make it a ClassRule, does that mean the state will be kept between each test? that way, tests will interfere with each other right?", "author": "yuzhu", "createdAt": "2020-02-11T21:13:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNzE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkwNjU5MA==", "url": "https://github.com/Alluxio/alluxio/pull/10873#discussion_r377906590", "bodyText": "Yes, so we just have to clear the necessary state in Alluxio. The reason I want to go in that direction is that there is a large startup cost to creating a cluster.", "author": "gpang", "createdAt": "2020-02-11T21:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNzE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNTM3OQ==", "url": "https://github.com/Alluxio/alluxio/pull/10873#discussion_r377935379", "bodyText": "what is the alternative to ManuallyScheduleHeartbeat? i need to manually trigger a heartbeat in a test.\nChanged it to use classrule.", "author": "yuzhu", "createdAt": "2020-02-11T22:22:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQzNzE1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "25e9fd9d1da434e9513743c16588de2db02c31c7", "chunk": "diff --git a/tests/src/test/java/alluxio/server/ft/journal/TableMasterJournalIntegrationTest.java b/tests/src/test/java/alluxio/server/ft/journal/TableMasterJournalIntegrationTest.java\nindex af0902dec5..debf5123e3 100644\n--- a/tests/src/test/java/alluxio/server/ft/journal/TableMasterJournalIntegrationTest.java\n+++ b/tests/src/test/java/alluxio/server/ft/journal/TableMasterJournalIntegrationTest.java\n\n@@ -49,21 +49,24 @@ import java.util.List;\n  * Integration tests for table master functionality.\n  */\n public class TableMasterJournalIntegrationTest {\n-  @Rule\n-  public LocalAlluxioClusterResource mClusterResource =\n-      new LocalAlluxioClusterResource.Builder().setStartCluster(false)\n-          .build();\n-\n-  private static final String DB_NAME = TestDatabase.TEST_UDB_NAME;\n+  @ClassRule\n+  public static LocalAlluxioClusterResource sClusterResource =\n+      new LocalAlluxioClusterResource.Builder().setNumWorkers(1).build();\n \n   @ClassRule\n   public static ManuallyScheduleHeartbeat sManuallySchedule = new ManuallyScheduleHeartbeat(\n       HeartbeatContext.MASTER_TABLE_TRANSFORMATION_MONITOR);\n \n+  private static final String DB_NAME = TestDatabase.TEST_UDB_NAME;\n+\n+  @Before\n+  public void reset() throws Exception {\n+    sClusterResource.get().formatAndRestartMasters();\n+  }\n+\n   @Test\n   public void journalSync() throws Exception {\n-    mClusterResource.start();\n-    LocalAlluxioCluster mCluster = mClusterResource.get();\n+    LocalAlluxioCluster mCluster = sClusterResource.get();\n     TableMaster tableMaster =\n         mCluster.getLocalAlluxioMaster().getMasterProcess().getMaster(TableMaster.class);\n     genTable(1, 2, true);\n"}}, {"oid": "25e9fd9d1da434e9513743c16588de2db02c31c7", "url": "https://github.com/Alluxio/alluxio/commit/25e9fd9d1da434e9513743c16588de2db02c31c7", "message": "change to use classrule", "committedDate": "2020-02-11T22:20:17Z", "type": "commit"}]}