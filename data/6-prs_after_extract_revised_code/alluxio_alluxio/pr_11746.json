{"pr_number": 11746, "pr_title": "Simplify UfsStatus handling in loadMetadata", "pr_createdAt": "2020-07-10T17:17:29Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11746", "timeline": [{"oid": "30e8bf81689ba9ebc5c3504cea36532884f25c6c", "url": "https://github.com/Alluxio/alluxio/commit/30e8bf81689ba9ebc5c3504cea36532884f25c6c", "message": "attempt 2", "committedDate": "2020-07-10T17:19:51Z", "type": "forcePushed"}, {"oid": "fe47767c1c0e291bd00c32c7de0772e7dead852f", "url": "https://github.com/Alluxio/alluxio/commit/fe47767c1c0e291bd00c32c7de0772e7dead852f", "message": "attempt 2", "committedDate": "2020-07-10T18:43:57Z", "type": "forcePushed"}, {"oid": "920dfa320b1817a8baa01d97bad3ce626df0a59e", "url": "https://github.com/Alluxio/alluxio/commit/920dfa320b1817a8baa01d97bad3ce626df0a59e", "message": "Try to improve SSCW perf", "committedDate": "2020-07-10T19:57:06Z", "type": "commit"}, {"oid": "00240680873d305a9a153118c575072f0f5140b9", "url": "https://github.com/Alluxio/alluxio/commit/00240680873d305a9a153118c575072f0f5140b9", "message": "attempt 2", "committedDate": "2020-07-10T19:57:06Z", "type": "commit"}, {"oid": "00240680873d305a9a153118c575072f0f5140b9", "url": "https://github.com/Alluxio/alluxio/commit/00240680873d305a9a153118c575072f0f5140b9", "message": "attempt 2", "committedDate": "2020-07-10T19:57:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExMjU4NA==", "url": "https://github.com/Alluxio/alluxio/pull/11746#discussion_r453112584", "bodyText": "This means for load metadata, this context.getUfsStatus() must always be prepopulated with the UFS status? Something earlier in the call stack will be populating everything? What is the difference between this context.getUfsStatus() and the status cache?\nThis also implies this method itself will never call UFS?\nCan we add this to the method javadoc?", "author": "gpang", "createdAt": "2020-07-10T22:59:15Z", "path": "core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java", "diffHunk": "@@ -639,10 +639,8 @@ private void loadMetadata(LockedInodePath inodePath, LoadMetadataContext context\n       FileDoesNotExistException, InvalidFileSizeException, InvalidPathException, IOException {\n     AlluxioURI path = inodePath.getUri();\n     MountTable.Resolution resolution = mMountTable.resolve(path);\n-    AlluxioURI ufsUri = resolution.getUri();\n-    try (CloseableResource<UnderFileSystem> ufsResource = resolution.acquireUfsResource()) {\n-      UnderFileSystem ufs = ufsResource.get();\n-      if (context.getUfsStatus() == null && !ufs.exists(ufsUri.toString())) {\n+    try {\n+      if (context.getUfsStatus() == null) {", "originalCommit": "00240680873d305a9a153118c575072f0f5140b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExODk0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11746#discussion_r453118946", "bodyText": "context.getUfsStatus is can be thought of as similar to an RPC options object. The context object is basically a POJO that just holds information. No fancy processing. Just getters and setters.\nWhen calling this method it is now expected that the ufs status is already populated. And yes, this method shouldn't call the UFS except in the case where the child statuses may need to be retrieved (see the fetchChildren call lower in the code). The context will always have a setUfsStatus call as this method is only called in one place", "author": "ZacBlanco", "createdAt": "2020-07-10T23:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExMjU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "0005e829c3b6f12cf519512544788e55b1484410", "chunk": "diff --git a/core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java b/core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java\nindex 0e34c13a49..8e30263399 100644\n--- a/core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java\n+++ b/core/server/master/src/main/java/alluxio/master/file/InodeSyncStream.java\n\n@@ -634,6 +634,10 @@ public class InodeSyncStream {\n     loadMetadata(inodePath, ctx);\n   }\n \n+  /**\n+  * This method creates inodes containing the metadata from the UFS. The {@link UfsStatus} object must be\n+  * set in the {@link LoadMetadataContext} in order to successfully create the inodes.\n+  */\n   private void loadMetadata(LockedInodePath inodePath, LoadMetadataContext context)\n       throws AccessControlException, BlockInfoException, FileAlreadyCompletedException,\n       FileDoesNotExistException, InvalidFileSizeException, InvalidPathException, IOException {\n"}}, {"oid": "0005e829c3b6f12cf519512544788e55b1484410", "url": "https://github.com/Alluxio/alluxio/commit/0005e829c3b6f12cf519512544788e55b1484410", "message": "Add javadoc to loadMetadata", "committedDate": "2020-07-10T23:27:55Z", "type": "commit"}, {"oid": "dd0b410cf424da8e508b1826f8ef3c76a2c3bae6", "url": "https://github.com/Alluxio/alluxio/commit/dd0b410cf424da8e508b1826f8ef3c76a2c3bae6", "message": "Fix style", "committedDate": "2020-07-10T23:48:15Z", "type": "commit"}]}