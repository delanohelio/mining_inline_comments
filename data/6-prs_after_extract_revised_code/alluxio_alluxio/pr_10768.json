{"pr_number": 10768, "pr_title": "Add client config load before initializing metrics heartbeat", "pr_createdAt": "2020-01-20T23:04:45Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10768", "timeline": [{"oid": "7a1b72198b1017868663dcef06227a24c4ce056f", "url": "https://github.com/Alluxio/alluxio/commit/7a1b72198b1017868663dcef06227a24c4ce056f", "message": "Load conf before initializing metrics heartbeat", "committedDate": "2020-01-20T23:01:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Mjk0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10768#discussion_r368762942", "bodyText": "Should we only do this if metrics are enabled?", "author": "calvinjia", "createdAt": "2020-01-21T00:04:38Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java", "diffHunk": "@@ -229,6 +229,15 @@ private synchronized void initContext(ClientContext ctx,\n     mClosed.set(false);\n     mMasterClientContext = MasterClientContext.newBuilder(ctx)\n         .setMasterInquireClient(masterInquireClient).build();\n+    try {\n+      InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();\n+      mMasterClientContext.loadConf(masterAddr, true, true);\n+    } catch (UnavailableException e) {\n+      LOG.error(\"Failed to get master address during initialization\", e);\n+    } catch (AlluxioStatusException ae) {\n+      LOG.error(\"Failed to load configuration from \"\n+          + \"meta master during initialization\", ae);\n+    }", "originalCommit": "7a1b72198b1017868663dcef06227a24c4ce056f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc3MjYzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/10768#discussion_r368772639", "bodyText": "For the safest change, we should only do this if metrics are enabled.\nUpdate client configuration beforehand in all cases may help acquire and work with block worker client and file system master client.", "author": "LuQQiu", "createdAt": "2020-01-21T01:08:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Mjk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE4MjI3NA==", "url": "https://github.com/Alluxio/alluxio/pull/10768#discussion_r369182274", "bodyText": "Change to only do it when client metrics is enabled.", "author": "LuQQiu", "createdAt": "2020-01-21T18:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2Mjk0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d08fd43b2469557dbdeffda52d551d929a57298a", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java b/core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java\nindex b234b27e8f..8161d4571d 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/FileSystemContext.java\n\n@@ -229,25 +229,25 @@ public final class FileSystemContext implements Closeable {\n     mClosed.set(false);\n     mMasterClientContext = MasterClientContext.newBuilder(ctx)\n         .setMasterInquireClient(masterInquireClient).build();\n-    try {\n-      InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();\n-      mMasterClientContext.loadConf(masterAddr, true, true);\n-    } catch (UnavailableException e) {\n-      LOG.error(\"Failed to get master address during initialization\", e);\n-    } catch (AlluxioStatusException ae) {\n-      LOG.error(\"Failed to load configuration from \"\n-          + \"meta master during initialization\", ae);\n+    mMetricsEnabled = getClusterConf().getBoolean(PropertyKey.USER_METRICS_COLLECTION_ENABLED);\n+    if (mMetricsEnabled) {\n+      try {\n+        InetSocketAddress masterAddr = masterInquireClient.getPrimaryRpcAddress();\n+        mMasterClientContext.loadConf(masterAddr, true, true);\n+      } catch (UnavailableException e) {\n+        LOG.error(\"Failed to get master address during initialization\", e);\n+      } catch (AlluxioStatusException ae) {\n+        LOG.error(\"Failed to load configuration from \"\n+            + \"meta master during initialization\", ae);\n+      }\n+      MetricsSystem.startSinks(getClusterConf().get(PropertyKey.METRICS_CONF_FILE));\n+      MetricsHeartbeatContext.addHeartbeat(getClientContext(), masterInquireClient);\n     }\n     mFileSystemMasterClientPool = new FileSystemMasterClientPool(mMasterClientContext);\n     mBlockMasterClientPool = new BlockMasterClientPool(mMasterClientContext);\n     mWorkerGroup = NettyUtils.createEventLoop(NettyUtils.getUserChannel(getClusterConf()),\n         getClusterConf().getInt(PropertyKey.USER_NETWORK_NETTY_WORKER_THREADS),\n         String.format(\"alluxio-client-nettyPool-%s-%%d\", mId), true);\n-    mMetricsEnabled = getClusterConf().getBoolean(PropertyKey.USER_METRICS_COLLECTION_ENABLED);\n-    if (mMetricsEnabled) {\n-      MetricsSystem.startSinks(getClusterConf().get(PropertyKey.METRICS_CONF_FILE));\n-      MetricsHeartbeatContext.addHeartbeat(getClientContext(), masterInquireClient);\n-    }\n     mUriValidationEnabled = ctx.getUriValidationEnabled();\n   }\n \n"}}, {"oid": "d08fd43b2469557dbdeffda52d551d929a57298a", "url": "https://github.com/Alluxio/alluxio/commit/d08fd43b2469557dbdeffda52d551d929a57298a", "message": "Move metrics enabled get conf", "committedDate": "2020-01-21T02:37:18Z", "type": "commit"}]}