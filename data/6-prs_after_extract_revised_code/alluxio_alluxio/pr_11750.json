{"pr_number": 11750, "pr_title": "Fix Object UFS edge case again", "pr_createdAt": "2020-07-10T20:27:20Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11750", "timeline": [{"oid": "35cbb5800f8e7c4d93216063c23cc74854a28a57", "url": "https://github.com/Alluxio/alluxio/commit/35cbb5800f8e7c4d93216063c23cc74854a28a57", "message": "Fix Object UFS edge case again", "committedDate": "2020-07-10T20:26:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453070366", "bodyText": "can we keep this test case? \"s3a://\" + BUCKET_NAME + \"/test/\"", "author": "gpang", "createdAt": "2020-07-10T20:49:00Z", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,8 +244,8 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test/\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));", "originalCommit": "35cbb5800f8e7c4d93216063c23cc74854a28a57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDk5OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453070999", "bodyText": "No because I don't think /test/ is actually a valid input to this function. It was becuase I thought it was a valid input that I made this mistake.", "author": "bradyoo", "createdAt": "2020-07-10T20:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA5MzY2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453093665", "bodyText": "We can't pass in directory paths to this method? I thought any s3 UFS path can be passed to this method?", "author": "gpang", "createdAt": "2020-07-10T21:53:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExMjg3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453112873", "bodyText": "I think directories are also allowed, since a few lines above, we have \"s3a://\" + BUCKET_NAME + \"/\" which is a directory.", "author": "gpang", "createdAt": "2020-07-10T23:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA3MDM2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "chunk": "diff --git a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\nindex c9318549bc..7385c12858 100644\n--- a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n+++ b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n\n@@ -245,7 +245,7 @@ public class S3AUnderFileSystemTest {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n     Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n-    Assert.assertEquals(\"test\",\n-        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test\"));\n+    Assert.assertEquals(\"test/\",\n+        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));\n   }\n }\n"}}, {"oid": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "url": "https://github.com/Alluxio/alluxio/commit/a60a5b42fe542aa126c541ea9ff54593282c1d50", "message": "feedback", "committedDate": "2020-07-10T23:17:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExOTM2MA==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453119360", "bodyText": "Can we do the full matrix of test cases?\ntest\ntest/\n/test\n/test/\n\nare these also possible?\n\"\"\n\"/\"", "author": "gpang", "createdAt": "2020-07-10T23:25:24Z", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -244,7 +244,7 @@ public void getOperationMode() throws Exception {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));", "originalCommit": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "chunk": "diff --git a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\nindex 7385c12858..832d4cccf0 100644\n--- a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n+++ b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n\n@@ -244,8 +244,13 @@ public class S3AUnderFileSystemTest {\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n-    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n     Assert.assertEquals(\"test/\",\n         mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n+    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test/\"));\n+    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"/test/\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"/test\"));\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"\"));\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"/\"));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzExOTUxNw==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453119517", "bodyText": "Can we save this normalized root at the top, so both branches can re-use it?", "author": "gpang", "createdAt": "2020-07-10T23:26:02Z", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n+    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (!path.equals(normalizedPath)) {\n+      stripedKey = CommonUtils.stripPrefixIfPresent(\n+          normalizedPath,\n+          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));", "originalCommit": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "chunk": "diff --git a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\nindex 8aa305bd6e..7f26830899 100755\n--- a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n+++ b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n\n@@ -1118,24 +1118,15 @@ public abstract class ObjectUnderFileSystem extends BaseUnderFileSystem {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n+    if (mRootKeySupplier.get().equals(path)) {\n+      return \"\";\n+    }\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        path,\n-        PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n+        path, PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n     if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n \n-    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n-    if (!path.equals(normalizedPath)) {\n-      stripedKey = CommonUtils.stripPrefixIfPresent(\n-          normalizedPath,\n-          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-      if (!stripedKey.equals(normalizedPath)) {\n-        return stripedKey;\n-      }\n-    }\n-\n     return CommonUtils.stripPrefixIfPresent(path, PATH_SEPARATOR);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDM1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453120357", "bodyText": "What is an example where this will make a difference? PathUtils.normalizePath just adds a separator at the end, so does this only apply to the single string s3://bucket?", "author": "gpang", "createdAt": "2020-07-10T23:30:08Z", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix", "originalCommit": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMjA2Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453122066", "bodyText": "That is correct.", "author": "bradyoo", "createdAt": "2020-07-10T23:38:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDM1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "chunk": "diff --git a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\nindex 8aa305bd6e..7f26830899 100755\n--- a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n+++ b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n\n@@ -1118,24 +1118,15 @@ public abstract class ObjectUnderFileSystem extends BaseUnderFileSystem {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n+    if (mRootKeySupplier.get().equals(path)) {\n+      return \"\";\n+    }\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        path,\n-        PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n+        path, PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n     if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n \n-    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n-    if (!path.equals(normalizedPath)) {\n-      stripedKey = CommonUtils.stripPrefixIfPresent(\n-          normalizedPath,\n-          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-      if (!stripedKey.equals(normalizedPath)) {\n-        return stripedKey;\n-      }\n-    }\n-\n     return CommonUtils.stripPrefixIfPresent(path, PATH_SEPARATOR);\n   }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMDU5NA==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453120594", "bodyText": "(nit) reuse the result from line 1123?", "author": "bf8086", "createdAt": "2020-07-10T23:31:01Z", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,25 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        normalizedPath,\n+        path,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(normalizedPath)) {\n+    if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n+\n+    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n+    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (!path.equals(normalizedPath)) {\n+      stripedKey = CommonUtils.stripPrefixIfPresent(\n+          normalizedPath,\n+          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));", "originalCommit": "a60a5b42fe542aa126c541ea9ff54593282c1d50", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "chunk": "diff --git a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\nindex 8aa305bd6e..7f26830899 100755\n--- a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n+++ b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n\n@@ -1118,24 +1118,15 @@ public abstract class ObjectUnderFileSystem extends BaseUnderFileSystem {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n+    if (mRootKeySupplier.get().equals(path)) {\n+      return \"\";\n+    }\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        path,\n-        PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n+        path, PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n     if (!stripedKey.equals(path)) {\n       return stripedKey;\n     }\n \n-    // See if adding a PATH_SEPARATOR makes a difference in stripping prefix\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n-    if (!path.equals(normalizedPath)) {\n-      stripedKey = CommonUtils.stripPrefixIfPresent(\n-          normalizedPath,\n-          PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-      if (!stripedKey.equals(normalizedPath)) {\n-        return stripedKey;\n-      }\n-    }\n-\n     return CommonUtils.stripPrefixIfPresent(path, PATH_SEPARATOR);\n   }\n \n"}}, {"oid": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "url": "https://github.com/Alluxio/alluxio/commit/cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "message": "add test cases simplify code", "committedDate": "2020-07-10T23:40:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEyMjcxOA==", "url": "https://github.com/Alluxio/alluxio/pull/11750#discussion_r453122718", "bodyText": "mRootKeySupplier.get() is a memoized function so don't be concerned about callng twice.", "author": "bradyoo", "createdAt": "2020-07-10T23:41:25Z", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1118,14 +1118,16 @@ protected boolean parentExists(String path) throws IOException {\n    */\n   @VisibleForTesting\n   public String stripPrefixIfPresent(String path) {\n-    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n+    if (mRootKeySupplier.get().equals(path)) {", "originalCommit": "cb484101bb01a1d2ab9f0a52b746c64e9c55a2a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}