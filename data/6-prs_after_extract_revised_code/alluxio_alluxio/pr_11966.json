{"pr_number": 11966, "pr_title": "Remove JvmPauseMonitorTest#interruptOnStop test", "pr_createdAt": "2020-08-11T16:44:36Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11966", "timeline": [{"oid": "a5ef69e35db571caf1e7f1dc1a90349539b67f35", "url": "https://github.com/Alluxio/alluxio/commit/a5ef69e35db571caf1e7f1dc1a90349539b67f35", "message": "Fix JvmPauseMonitorTest#interruptOnStop test\n\nMockito was recently upgraded which includes a new feature that allows us to mock final methods and classes. I rewrote the test to be simpler using one of Mockito's Spy classes.", "committedDate": "2020-08-11T16:43:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMDQ3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11966#discussion_r468720472", "bodyText": "Thread#join is final", "author": "ZacBlanco", "createdAt": "2020-08-11T16:45:35Z", "path": "core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java", "diffHunk": "@@ -49,28 +49,16 @@ public void pauseMonitorStartStopTest() {\n \n   @Test\n   public void interruptOnStop() throws Exception {\n-    JvmPauseMonitor mon = Mockito.spy(new JvmPauseMonitor(10000, 900000, 90000));\n-    CyclicBarrier barrier = new CyclicBarrier(2);\n-    doAnswer((Answer<Void>) invocation -> {\n-      barrier.await();\n-      invocation.callRealMethod();\n-      return null;\n-    }).when(mon).sleepMillis(any(Long.class));\n-    Thread current = Thread.currentThread();\n-    Thread t1 = new Thread(() -> {\n-      try {\n-        barrier.await();\n-        current.interrupt();\n-      } catch (InterruptedException | BrokenBarrierException e) {\n-        fail(\"Failed to await on barrier\");\n-      }\n-    });\n-    t1.start();\n+    JvmPauseMonitor mon = Mockito.spy(new JvmPauseMonitor(1000, 900000, 90000));\n     mon.start();\n-    barrier.await();\n+    Thread pmThread = Whitebox.getInternalState(mon, \"mJvmMonitorThread\");\n+    Thread spied = Mockito.spy(pmThread);\n+    doThrow(InterruptedException.class).when(spied).join();", "originalCommit": "a5ef69e35db571caf1e7f1dc1a90349539b67f35", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "746b904b310cd32f3765b5887dc7c50b3ee66ea0", "chunk": "diff --git a/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java b/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\nindex e4f33fd9bb..b33b45255e 100644\n--- a/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\n+++ b/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\n\n@@ -57,8 +57,12 @@ public final class JvmPauseMonitorTest {\n     Whitebox.setInternalState(mon, \"mJvmMonitorThread\", spied);\n     mon.stop();\n     assertTrue(Thread.currentThread().isInterrupted());\n-    pmThread.interrupt();\n-    pmThread.join();\n+    try {\n+      pmThread.interrupt();\n+      pmThread.join();\n+    } catch (InterruptedException e) {\n+      // ok, join was a cleanup operation\n+    }\n   }\n \n   @Test\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcyMDkwOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11966#discussion_r468720909", "bodyText": "org.mockito.Matchers is now deprecated, so I moved to the newer class", "author": "ZacBlanco", "createdAt": "2020-08-11T16:46:16Z", "path": "core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java", "diffHunk": "@@ -14,9 +14,9 @@\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n-import static org.junit.Assert.fail;\n-import static org.mockito.Matchers.any;\n+import static org.mockito.ArgumentMatchers.any;", "originalCommit": "a5ef69e35db571caf1e7f1dc1a90349539b67f35", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8ea8f27efee382b808448504f3d62752759c9c6", "chunk": "diff --git a/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java b/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\nindex e4f33fd9bb..6c1cf619f1 100644\n--- a/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\n+++ b/core/common/src/test/java/alluxio/util/JvmPauseMonitorTest.java\n\n@@ -14,9 +14,9 @@ package alluxio.util;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertFalse;\n import static org.junit.Assert.assertTrue;\n-import static org.mockito.ArgumentMatchers.any;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Matchers.any;\n import static org.mockito.Mockito.doAnswer;\n-import static org.mockito.Mockito.doThrow;\n \n import alluxio.TestLoggerRule;\n \n"}}, {"oid": "746b904b310cd32f3765b5887dc7c50b3ee66ea0", "url": "https://github.com/Alluxio/alluxio/commit/746b904b310cd32f3765b5887dc7c50b3ee66ea0", "message": "Fix static mocks", "committedDate": "2020-08-11T22:50:35Z", "type": "forcePushed"}, {"oid": "cbb5e84e4adc3f8e6b1ee5f7433bf30b6a1a528d", "url": "https://github.com/Alluxio/alluxio/commit/cbb5e84e4adc3f8e6b1ee5f7433bf30b6a1a528d", "message": "Fix static mocks", "committedDate": "2020-08-11T22:52:22Z", "type": "commit"}, {"oid": "cbb5e84e4adc3f8e6b1ee5f7433bf30b6a1a528d", "url": "https://github.com/Alluxio/alluxio/commit/cbb5e84e4adc3f8e6b1ee5f7433bf30b6a1a528d", "message": "Fix static mocks", "committedDate": "2020-08-11T22:52:22Z", "type": "forcePushed"}, {"oid": "0ce5e0b9264524280edf7c78f544e2a64b3ecdfa", "url": "https://github.com/Alluxio/alluxio/commit/0ce5e0b9264524280edf7c78f544e2a64b3ecdfa", "message": "Exclude mockito extension from test jar", "committedDate": "2020-08-15T00:12:40Z", "type": "commit"}, {"oid": "73aafa3a6d3db43a541d49fed938328862741019", "url": "https://github.com/Alluxio/alluxio/commit/73aafa3a6d3db43a541d49fed938328862741019", "message": "Revert \"Exclude mockito extension from test jar\"\n\nThis reverts commit 0ce5e0b9264524280edf7c78f544e2a64b3ecdfa.", "committedDate": "2020-08-17T16:46:10Z", "type": "commit"}, {"oid": "cd2b7f78d47e2e24cf0044bfe585f2b8fde1c5be", "url": "https://github.com/Alluxio/alluxio/commit/cd2b7f78d47e2e24cf0044bfe585f2b8fde1c5be", "message": "Revert \"Fix static mocks\"\n\nThis reverts commit cbb5e84e4adc3f8e6b1ee5f7433bf30b6a1a528d.", "committedDate": "2020-08-17T16:46:24Z", "type": "commit"}, {"oid": "b8ea8f27efee382b808448504f3d62752759c9c6", "url": "https://github.com/Alluxio/alluxio/commit/b8ea8f27efee382b808448504f3d62752759c9c6", "message": "Revert \"Fix JvmPauseMonitorTest#interruptOnStop test\"\n\nThis reverts commit a5ef69e35db571caf1e7f1dc1a90349539b67f35.", "committedDate": "2020-08-17T16:46:44Z", "type": "commit"}, {"oid": "36834e31258e9c34726ec790f48f4ecebb0d0ca9", "url": "https://github.com/Alluxio/alluxio/commit/36834e31258e9c34726ec790f48f4ecebb0d0ca9", "message": "Remove test", "committedDate": "2020-08-17T16:58:48Z", "type": "commit"}]}