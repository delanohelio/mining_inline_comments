{"pr_number": 10706, "pr_title": "Add listening address for embedded journal", "pr_createdAt": "2020-01-07T21:11:25Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10706", "timeline": [{"oid": "a7e3974064236154dc82a3da2e89532e369cf46a", "url": "https://github.com/Alluxio/alluxio/commit/a7e3974064236154dc82a3da2e89532e369cf46a", "message": "Add external proxy support for GrpcMessagingTransport", "committedDate": "2020-01-07T20:55:38Z", "type": "commit"}, {"oid": "d3d8c5ca498d866db16a87fd26264ca8fa896240", "url": "https://github.com/Alluxio/alluxio/commit/d3d8c5ca498d866db16a87fd26264ca8fa896240", "message": "Use external proxy infra to pass bind address", "committedDate": "2020-01-07T21:10:38Z", "type": "commit"}, {"oid": "08ea41b7ffa53653649fd5c93c997d5d3b8ccd68", "url": "https://github.com/Alluxio/alluxio/commit/08ea41b7ffa53653649fd5c93c997d5d3b8ccd68", "message": "Fix bug-check", "committedDate": "2020-01-07T22:00:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4ODE1Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10706#discussion_r365488153", "bodyText": "Consider creating the GrpcMessagingTransport here? Then we won't have to do as many null checks here and in GrpcMessagingTransport since we can assume the proxy is only set if necessary.", "author": "calvinjia", "createdAt": "2020-01-11T01:32:47Z", "path": "core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java", "diffHunk": "@@ -238,14 +239,21 @@ private synchronized void initServer() {\n       mStateMachine.close();\n     }\n     mStateMachine = new JournalStateMachine(mJournals, () -> this.getJournalSinks(null));\n+    // Read external proxy configuration.\n+    GrpcMessagingProxy serverProxy = null;\n+    if (mConf.getProxyAddress() != null) {\n+      serverProxy = new GrpcMessagingProxy();\n+      serverProxy.addProxy(getLocalAddress(mConf), new Address(mConf.getProxyAddress()));\n+    }", "originalCommit": "08ea41b7ffa53653649fd5c93c997d5d3b8ccd68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3MDYzMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10706#discussion_r366070631", "bodyText": "I was able to strip some null checks by enforcing valid proxy reference.", "author": "ggezer", "createdAt": "2020-01-13T22:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4ODE1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "178ab8b7d21789eff93332d315b8ef1134993601", "chunk": "diff --git a/core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java b/core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java\nindex 44f860a3aa..0307b03f7e 100644\n--- a/core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java\n+++ b/core/server/common/src/main/java/alluxio/master/journal/raft/RaftJournalSystem.java\n\n@@ -240,9 +240,8 @@ public final class RaftJournalSystem extends AbstractJournalSystem {\n     }\n     mStateMachine = new JournalStateMachine(mJournals, () -> this.getJournalSinks(null));\n     // Read external proxy configuration.\n-    GrpcMessagingProxy serverProxy = null;\n+    GrpcMessagingProxy serverProxy = new GrpcMessagingProxy();\n     if (mConf.getProxyAddress() != null) {\n-      serverProxy = new GrpcMessagingProxy();\n       serverProxy.addProxy(getLocalAddress(mConf), new Address(mConf.getProxyAddress()));\n     }\n     mServer = CopycatServer.builder(getLocalAddress(mConf))\n"}}, {"oid": "178ab8b7d21789eff93332d315b8ef1134993601", "url": "https://github.com/Alluxio/alluxio/commit/178ab8b7d21789eff93332d315b8ef1134993601", "message": "Require valid proxy reference", "committedDate": "2020-01-13T22:48:39Z", "type": "commit"}]}