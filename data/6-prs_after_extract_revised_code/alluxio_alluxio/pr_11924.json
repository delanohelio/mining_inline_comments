{"pr_number": 11924, "pr_title": "Fix LoginModuleTest in Java 11", "pr_createdAt": "2020-08-06T21:58:39Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11924", "timeline": [{"oid": "01bb4aef55cc8fd36460c5d2494422429953e5bb", "url": "https://github.com/Alluxio/alluxio/commit/01bb4aef55cc8fd36460c5d2494422429953e5bb", "message": "Fix LoginModuleTest", "committedDate": "2020-08-06T21:57:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r466744613", "bodyText": "If this test assumed that logout twice is a no-op, is there any place in the code that uses it which makes the same assumption?", "author": "ZacBlanco", "createdAt": "2020-08-06T23:49:02Z", "path": "core/common/src/test/java/alluxio/security/login/LoginModuleTest.java", "diffHunk": "@@ -62,10 +62,6 @@ public void simpleLogin() throws Exception {\n     // logout and verify the user is removed\n     loginContext.logout();\n     assertTrue(subject.getPrincipals(User.class).isEmpty());\n-\n-    // logout twice should be no-op.\n-    loginContext.logout();\n-    assertTrue(subject.getPrincipals(User.class).isEmpty());", "originalCommit": "01bb4aef55cc8fd36460c5d2494422429953e5bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE1OTg1OA==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467159858", "bodyText": "no ... we don't even use logout", "author": "LuQQiu", "createdAt": "2020-08-07T16:59:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4Mjk0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467182943", "bodyText": "@bf8086  could you take a look at this and confirm that we don't assume logout is idempotent anywhere in our code?", "author": "yuzhu", "createdAt": "2020-08-07T17:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI1MjI0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467252242", "bodyText": "It looks like we do it on EE for relogins. It is also likely this is indirectly called from JDK or Hadoop. Maybe we can disable it only for Java 11 to ensure it doesn't regress on Java 8?", "author": "bf8086", "createdAt": "2020-08-07T20:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI2NTg2Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467265863", "bodyText": "@bf8086 is there a test we can write to ensure our relogins on EE will work under java 11? do we need special handling for java 11? if so, there is a function available for it here. \n  \n    \n      alluxio/core/common/src/main/java/alluxio/util/CommonUtils.java\n    \n    \n         Line 127\n      in\n      5ce8371\n    \n    \n    \n    \n\n        \n          \n           public static int getJavaVersion() {", "author": "yuzhu", "createdAt": "2020-08-07T20:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjkyMA==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467312920", "bodyText": "We do have a relogin test in Autobots. Not sure what is the impact from Java 11. I don't think we should specialize in our production code. If it doesn't work in Java 11 due to the idempotent issue then we should make it not assume that regardless of the java version.\nWe should still specialize the test here for java 11 to make sure it doesn't break the promise for other callers(i.e. in case Java 8 itself calls logout internally multiple times).", "author": "bf8086", "createdAt": "2020-08-07T22:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NDc4OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11924#discussion_r467344789", "bodyText": "@LuQQiu do you mind updating the PR to only test calling twice on Java 8?", "author": "yuzhu", "createdAt": "2020-08-08T01:29:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njc0NDYxMw=="}], "type": "inlineReview", "revised_code": {"commit": "58d88a9cf6b1d537b8b83e2fe26d0ee4c5f2a42d", "chunk": "diff --git a/core/common/src/test/java/alluxio/security/login/LoginModuleTest.java b/core/common/src/test/java/alluxio/security/login/LoginModuleTest.java\nindex e8eded8ead..fa7f51a2f0 100644\n--- a/core/common/src/test/java/alluxio/security/login/LoginModuleTest.java\n+++ b/core/common/src/test/java/alluxio/security/login/LoginModuleTest.java\n\n@@ -62,6 +63,13 @@ public final class LoginModuleTest {\n     // logout and verify the user is removed\n     loginContext.logout();\n     assertTrue(subject.getPrincipals(User.class).isEmpty());\n+\n+    if (CommonUtils.getJavaVersion() == 8) {\n+      // logout twice should be no-op in java 8\n+      // logout more than once is not allowed in java 11\n+      loginContext.logout();\n+      assertTrue(subject.getPrincipals(User.class).isEmpty());\n+    }\n   }\n \n    /**\n"}}, {"oid": "c5475f230e49aefcf95ea4612ccc50df286f5c35", "url": "https://github.com/Alluxio/alluxio/commit/c5475f230e49aefcf95ea4612ccc50df286f5c35", "message": "Merge branch 'master' of github.com:Alluxio/alluxio into fixLoginModuleTest", "committedDate": "2020-08-10T18:22:50Z", "type": "commit"}, {"oid": "58d88a9cf6b1d537b8b83e2fe26d0ee4c5f2a42d", "url": "https://github.com/Alluxio/alluxio/commit/58d88a9cf6b1d537b8b83e2fe26d0ee4c5f2a42d", "message": "Add back logout twice test for java 8", "committedDate": "2020-08-10T18:33:43Z", "type": "commit"}]}