{"pr_number": 11733, "pr_title": "Fix edge case for ObjectUFS when looking at root path", "pr_createdAt": "2020-07-08T03:46:41Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11733", "timeline": [{"oid": "6b4ea9d49ea1fc28e8675ca1ef67338ea8b747d9", "url": "https://github.com/Alluxio/alluxio/commit/6b4ea9d49ea1fc28e8675ca1ef67338ea8b747d9", "message": "Fix cases for ObjectUnderFileSystem when looking at root and doesn't end with path separator", "committedDate": "2020-07-08T03:43:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY2MTI3MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451661271", "bodyText": "Can you add a unit tests for this?", "author": "gpang", "createdAt": "2020-07-08T16:10:04Z", "path": "core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java", "diffHunk": "@@ -1117,7 +1117,8 @@ protected boolean parentExists(String path) throws IOException {\n    * @return the path without the bucket prefix\n    */\n   protected String stripPrefixIfPresent(String path) {\n-    String stripedKey = CommonUtils.stripPrefixIfPresent(path,\n+    String stripedKey = CommonUtils.stripPrefixIfPresent(\n+        PathUtils.normalizePath(path, PATH_SEPARATOR),", "originalCommit": "6b4ea9d49ea1fc28e8675ca1ef67338ea8b747d9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8c16b3f249fa4553d8513792e6b5f8dff9165802", "chunk": "diff --git a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\nindex 7da5332781..351958841c 100755\n--- a/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n+++ b/core/common/src/main/java/alluxio/underfs/ObjectUnderFileSystem.java\n\n@@ -1116,14 +1116,16 @@ public abstract class ObjectUnderFileSystem extends BaseUnderFileSystem {\n    * @param path the path to strip\n    * @return the path without the bucket prefix\n    */\n-  protected String stripPrefixIfPresent(String path) {\n+  @VisibleForTesting\n+  public String stripPrefixIfPresent(String path) {\n+    final String normalizedPath = PathUtils.normalizePath(path, PATH_SEPARATOR);\n     String stripedKey = CommonUtils.stripPrefixIfPresent(\n-        PathUtils.normalizePath(path, PATH_SEPARATOR),\n+        normalizedPath,\n         PathUtils.normalizePath(mRootKeySupplier.get(), PATH_SEPARATOR));\n-    if (!stripedKey.equals(path)) {\n+    if (!stripedKey.equals(normalizedPath)) {\n       return stripedKey;\n     }\n-    return CommonUtils.stripPrefixIfPresent(path, PATH_SEPARATOR);\n+    return CommonUtils.stripPrefixIfPresent(normalizedPath, PATH_SEPARATOR);\n   }\n \n   /**\n"}}, {"oid": "8c16b3f249fa4553d8513792e6b5f8dff9165802", "url": "https://github.com/Alluxio/alluxio/commit/8c16b3f249fa4553d8513792e6b5f8dff9165802", "message": "add test", "committedDate": "2020-07-08T16:36:38Z", "type": "commit"}, {"oid": "539215247e8d3bedd5e1c8fa17c33ab732042b53", "url": "https://github.com/Alluxio/alluxio/commit/539215247e8d3bedd5e1c8fa17c33ab732042b53", "message": "replace bucket_name with constant variable", "committedDate": "2020-07-08T16:40:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4Njk1NA==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451686954", "bodyText": "What would the previous code have returned?", "author": "gpang", "createdAt": "2020-07-08T16:49:43Z", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -239,4 +239,9 @@ public void getOperationMode() throws Exception {\n     Assert.assertEquals(UfsMode.READ_WRITE,\n         mS3UnderFileSystem.getOperationMode(physicalUfsState));\n   }\n+\n+  @Test\n+  public void stripPrefixIfPresent() throws Exception {\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));", "originalCommit": "539215247e8d3bedd5e1c8fa17c33ab732042b53", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY5MjYzNQ==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451692635", "bodyText": "The previous code would have returned s3a:// + BUCKET_NAME", "author": "bradyoo", "createdAt": "2020-07-08T16:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4Njk1NA=="}], "type": "inlineReview", "revised_code": {"commit": "92038f2c96877490e4b8dea8a8ed7667d27af68d", "chunk": "diff --git a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\nindex ffcc4b7a4a..76fd8dea06 100644\n--- a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n+++ b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n\n@@ -243,5 +243,7 @@ public class S3AUnderFileSystemTest {\n   @Test\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n   }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY4NzUzOA==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451687538", "bodyText": "Could you add a few more tests cases to test the method stripPrefixIfPresent?", "author": "gpang", "createdAt": "2020-07-08T16:50:39Z", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -239,4 +239,9 @@ public void getOperationMode() throws Exception {\n     Assert.assertEquals(UfsMode.READ_WRITE,\n         mS3UnderFileSystem.getOperationMode(physicalUfsState));\n   }\n+\n+  @Test\n+  public void stripPrefixIfPresent() throws Exception {", "originalCommit": "539215247e8d3bedd5e1c8fa17c33ab732042b53", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "92038f2c96877490e4b8dea8a8ed7667d27af68d", "chunk": "diff --git a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\nindex ffcc4b7a4a..76fd8dea06 100644\n--- a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n+++ b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n\n@@ -243,5 +243,7 @@ public class S3AUnderFileSystemTest {\n   @Test\n   public void stripPrefixIfPresent() throws Exception {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n+    Assert.assertEquals(\"test\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n   }\n }\n"}}, {"oid": "92038f2c96877490e4b8dea8a8ed7667d27af68d", "url": "https://github.com/Alluxio/alluxio/commit/92038f2c96877490e4b8dea8a8ed7667d27af68d", "message": "add more test cases", "committedDate": "2020-07-08T17:00:43Z", "type": "commit"}, {"oid": "dea3b052b3bcd8acb2a1d884dbef11a6034ff436", "url": "https://github.com/Alluxio/alluxio/commit/dea3b052b3bcd8acb2a1d884dbef11a6034ff436", "message": "fix test", "committedDate": "2020-07-08T17:27:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNDQ3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451734477", "bodyText": "Should there be 1 additional case of something like \"s3a://\" + BUCKET_NAME + \"/path/\" ?", "author": "gpang", "createdAt": "2020-07-08T18:10:01Z", "path": "underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java", "diffHunk": "@@ -239,4 +239,11 @@ public void getOperationMode() throws Exception {\n     Assert.assertEquals(UfsMode.READ_WRITE,\n         mS3UnderFileSystem.getOperationMode(physicalUfsState));\n   }\n+\n+  @Test\n+  public void stripPrefixIfPresent() throws Exception {\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n+    Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n+    Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));", "originalCommit": "dea3b052b3bcd8acb2a1d884dbef11a6034ff436", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNTc3NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11733#discussion_r451735775", "bodyText": "ah right yeah I'll do that.", "author": "bradyoo", "createdAt": "2020-07-08T18:12:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczNDQ3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9e8248b994f27ee9a0dc6c9d65556bf312f20b63", "chunk": "diff --git a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\nindex 0fbddefc62..910eeb27bd 100644\n--- a/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n+++ b/underfs/s3a/src/test/java/alluxio/underfs/s3a/S3AUnderFileSystemTest.java\n\n@@ -245,5 +245,7 @@ public class S3AUnderFileSystemTest {\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME));\n     Assert.assertEquals(\"\", mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/\"));\n     Assert.assertEquals(\"test/\", mS3UnderFileSystem.stripPrefixIfPresent(\"test\"));\n+    Assert.assertEquals(\"test/\",\n+        mS3UnderFileSystem.stripPrefixIfPresent(\"s3a://\" + BUCKET_NAME + \"/test/\"));\n   }\n }\n"}}, {"oid": "9e8248b994f27ee9a0dc6c9d65556bf312f20b63", "url": "https://github.com/Alluxio/alluxio/commit/9e8248b994f27ee9a0dc6c9d65556bf312f20b63", "message": "add test", "committedDate": "2020-07-08T18:15:04Z", "type": "commit"}]}