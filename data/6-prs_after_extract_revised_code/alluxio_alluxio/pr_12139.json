{"pr_number": 12139, "pr_title": "Fix deadlock of racing worker client acquisition and file completion", "pr_createdAt": "2020-09-23T22:45:06Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12139", "timeline": [{"oid": "7f38a19609856f0c10338b0dba37182f2e2b40dd", "url": "https://github.com/Alluxio/alluxio/commit/7f38a19609856f0c10338b0dba37182f2e2b40dd", "message": "Fix bug: fuse pod hang forever if open&read many files without close the files\nRoot cause:\n      mBlockInStream in AlluxioFileInStream won't be released even reading to end of the block.\n      In this case, BlockWorkerClient will be held in BlockInStream. Given many files opened, BlockWorkerClient in the pool will be exhausted and the following operations will be blocked.\nFix:\n      Release mBlockInStream after reading to end of the block.", "committedDate": "2020-09-23T22:32:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTM4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12139#discussion_r496129386", "bodyText": "The setting of mBlockInStream = null is handled in closeBlockInStream.", "author": "calvinjia", "createdAt": "2020-09-28T17:49:54Z", "path": "core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java", "diffHunk": "@@ -147,6 +147,10 @@ public int read() throws IOException {\n         if (result != -1) {\n           mPosition++;\n         }\n+        if (mBlockInStream.remaining() == 0) {\n+          closeBlockInStream(mBlockInStream);\n+          mBlockInStream = null;", "originalCommit": "7f38a19609856f0c10338b0dba37182f2e2b40dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjI4OTUxNg==", "url": "https://github.com/Alluxio/alluxio/pull/12139#discussion_r496289516", "bodyText": "removed this line.", "author": "chaowangnk1", "createdAt": "2020-09-28T23:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTM4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java b/core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java\nindex d0d606523f..ca2507ce1e 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/AlluxioFileInStream.java\n\n@@ -149,7 +149,6 @@ public class AlluxioFileInStream extends FileInStream {\n         }\n         if (mBlockInStream.remaining() == 0) {\n           closeBlockInStream(mBlockInStream);\n-          mBlockInStream = null;\n         }\n         return result;\n       } catch (IOException e) {\n"}}, {"oid": "6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c", "url": "https://github.com/Alluxio/alluxio/commit/6b5f4009bcfe01b1211c9f02e9ba64d4c27ec13c", "message": "Address comments & add UT", "committedDate": "2020-09-28T23:24:28Z", "type": "commit"}, {"oid": "ff3b3a4f0511fa447d006bd08c587db891a9a6ca", "url": "https://github.com/Alluxio/alluxio/commit/ff3b3a4f0511fa447d006bd08c587db891a9a6ca", "message": "Apply the logic to mCachedPositionedStream", "committedDate": "2020-09-28T23:40:13Z", "type": "commit"}, {"oid": "5e332f12d03dc3f05da3d42b6c1d4467bf3c4171", "url": "https://github.com/Alluxio/alluxio/commit/5e332f12d03dc3f05da3d42b6c1d4467bf3c4171", "message": "Add new UTs instead of updating existing UTs", "committedDate": "2020-09-28T23:55:41Z", "type": "commit"}]}