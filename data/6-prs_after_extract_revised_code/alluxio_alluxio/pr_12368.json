{"pr_number": 12368, "pr_title": "Support passing FileOpener for local cache", "pr_createdAt": "2020-10-22T18:43:37Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/12368", "timeline": [{"oid": "69c51fea342c60ec76e4954074bbf2ed832c6170", "url": "https://github.com/Alluxio/alluxio/commit/69c51fea342c60ec76e4954074bbf2ed832c6170", "message": "Support customized way to open InputStream for local cache", "committedDate": "2020-10-22T18:42:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NjI1MA==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510386250", "bodyText": "Could we call this mExternalFileOpener?", "author": "calvinjia", "createdAt": "2020-10-22T18:54:56Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java", "diffHunk": "@@ -48,13 +46,11 @@\n \n   /** Local store to store pages. */\n   private final CacheManager mCacheManager;\n-  /** External storage system. */\n-  private final FileSystem mExternalFs;\n   /** Path of the file. */\n   private final AlluxioURI mPath;\n   /** File info, fetched from external FS. */\n   private final URIStatus mStatus;\n-  private final OpenFilePOptions mOpenOptions;\n+  private final FileInStreamOpener mFileInStreamOpener;", "originalCommit": "69c51fea342c60ec76e4954074bbf2ed832c6170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4OTQyOA==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510689428", "bodyText": "done", "author": "apc999", "createdAt": "2020-10-23T07:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NjI1MA=="}], "type": "inlineReview", "revised_code": {"commit": "a2b1a64c2550981c2aa4d60da62bc87c01eca792", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java b/core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java\nindex 5991c6493e..f242d99d95 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java\n\n@@ -50,7 +50,7 @@ public class LocalCacheFileInStream extends FileInStream {\n   private final AlluxioURI mPath;\n   /** File info, fetched from external FS. */\n   private final URIStatus mStatus;\n-  private final FileInStreamOpener mFileInStreamOpener;\n+  private final FileInStreamOpener mExternalFileInStreamOpener;\n \n   /** Stream reading from the external file system, opened once. */\n   private FileInStream mExternalFileInStream;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NzE0MA==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510387140", "bodyText": "Will this cause a performance regression because getStatus will no longer be called lazily?", "author": "calvinjia", "createdAt": "2020-10-22T18:56:26Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileSystem.java", "diffHunk": "@@ -56,7 +56,7 @@ public FileInStream openFile(AlluxioURI path, OpenFilePOptions options)\n     if (mCacheManager == null || mCacheManager.state() == CacheManager.State.NOT_IN_USE) {\n       return mDelegatedFileSystem.openFile(path, options);\n     }\n-    return new LocalCacheFileInStream(path, options, mDelegatedFileSystem, mCacheManager);\n+    return openFile(mDelegatedFileSystem.getStatus(path), options);", "originalCommit": "69c51fea342c60ec76e4954074bbf2ed832c6170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5NTc0Nw==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510395747", "bodyText": "it was not called lazily even prior to this pr.\nWe memorized a closure and call get right away.\nit actually caused issues in error handling: exceptions are wrapped as RTE to through which is not nice.\n\n  \n    \n      alluxio/core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileInStream.java\n    \n    \n        Lines 82 to 88\n      in\n      91e1e86\n    \n    \n    \n    \n\n        \n          \n           mStatus = Suppliers.memoize(() -> { \n        \n\n        \n          \n             try { \n        \n\n        \n          \n               return externalFs.getStatus(mPath); \n        \n\n        \n          \n             } catch (Exception e) { \n        \n\n        \n          \n               throw new RuntimeException(e); \n        \n\n        \n          \n             } \n        \n\n        \n          \n           }).get();", "author": "apc999", "createdAt": "2020-10-22T19:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM4NzE0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MjUxOA==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510392518", "bodyText": "Do we only need 2 of these three methods? ie. the interface open(Path, int) and implementation open(URIStatus, int)? We should always use the hadoop file opener if cache is not enabled?\nAlso, buffer size is only respected if the cache is not enabled?", "author": "calvinjia", "createdAt": "2020-10-22T19:05:36Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java", "diffHunk": "@@ -112,10 +121,8 @@ public FSDataInputStream open(Path path, int bufferSize) throws IOException {\n     if (mCacheManager == null) {\n       return mExternalFileSystem.open(path, bufferSize);\n     }\n-    return new FSDataInputStream(new HdfsFileInputStream(\n-        new LocalCacheFileInStream(new AlluxioURI(path.toString()),\n-            OpenFilePOptions.getDefaultInstance(), mExternalFileSystemWrapper, mCacheManager),\n-        statistics));\n+    URIStatus status = HadoopUtils.toAlluxioUriStatus(mExternalFileSystem.getFileStatus(path));\n+    return open(status, bufferSize);", "originalCommit": "69c51fea342c60ec76e4954074bbf2ed832c6170", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MjM0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/12368#discussion_r510692346", "bodyText": "Do we only need 2 of these three methods? ie. the interface open(Path, int) and implementation open(URIStatus, int)? We should always use the hadoop file opener if cache is not enabled?\n\ncorrect, i removed the 3rd open method with FileOpener. originally I thought I needed in Presto land, but it turns out not the case (see draft PR https://github.com/prestodb/presto/pull/15344/files)\n\nAlso, buffer size is only respected if the cache is not enabled?\n\nCorrect", "author": "apc999", "createdAt": "2020-10-23T07:37:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM5MjUxOA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a2b1a64c2550981c2aa4d60da62bc87c01eca792", "url": "https://github.com/Alluxio/alluxio/commit/a2b1a64c2550981c2aa4d60da62bc87c01eca792", "message": "Address comments", "committedDate": "2020-10-23T07:57:39Z", "type": "commit"}]}