{"pr_number": 10704, "pr_title": "Fix Distributed Load Retry Logic", "pr_createdAt": "2020-01-07T20:25:18Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10704", "timeline": [{"oid": "70379fce21e9b11d2410e9130593150f123d4078", "url": "https://github.com/Alluxio/alluxio/commit/70379fce21e9b11d2410e9130593150f123d4078", "message": "attempt to improve performance on load retries", "committedDate": "2020-01-07T20:23:08Z", "type": "commit"}, {"oid": "26ddf434af3c29a459720216f02abc2cdacdd780", "url": "https://github.com/Alluxio/alluxio/commit/26ddf434af3c29a459720216f02abc2cdacdd780", "message": "Fix print add another print", "committedDate": "2020-01-07T22:09:55Z", "type": "commit"}, {"oid": "16b8151bcc4e9ed76a40ef9da5c108e806db8806", "url": "https://github.com/Alluxio/alluxio/commit/16b8151bcc4e9ed76a40ef9da5c108e806db8806", "message": "fix checkstyle", "committedDate": "2020-01-07T22:12:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAxNjk0MA==", "url": "https://github.com/Alluxio/alluxio/pull/10704#discussion_r364016940", "bodyText": "Print number of retries?", "author": "calvinjia", "createdAt": "2020-01-08T00:31:44Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -89,7 +88,8 @@ private boolean run() {\n         }\n         return true;\n       }\n-      LOG.warn(\"Failed to complete job after retries: {}\", mJobConfig);\n+      System.out.println(String.format(\"Failed to complete loading %s after retries.\",\n+          mJobConfig.getFilePath()));", "originalCommit": "16b8151bcc4e9ed76a40ef9da5c108e806db8806", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da1084b160a485795be73c0675ec396f8ce3f3eb", "chunk": "diff --git a/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java b/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\nindex 4fe8ad95ef..26466da3a3 100644\n--- a/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\n+++ b/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\n\n@@ -88,8 +88,8 @@ public final class DistributedLoadCommand extends AbstractFileSystemCommand {\n         }\n         return true;\n       }\n-      System.out.println(String.format(\"Failed to complete loading %s after retries.\",\n-          mJobConfig.getFilePath()));\n+      System.out.println(String.format(\"Failed to complete loading %s after %d retries.\",\n+          mJobConfig.getFilePath(), mRetryPolicy.getAttemptCount()));\n       return false;\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAxNzUwMQ==", "url": "https://github.com/Alluxio/alluxio/pull/10704#discussion_r364017501", "bodyText": "Perhaps word this a bit differently, Successfully loaded path %s after %d attempts? Also, is it possible for this to become spammy if a large number of files is to be loaded?", "author": "calvinjia", "createdAt": "2020-01-08T00:34:11Z", "path": "shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java", "diffHunk": "@@ -111,7 +111,27 @@ private Status check() {\n         return Status.FAILED;\n       }\n \n-      return jobInfo.getStatus();\n+      // This make an assumption that this job tree only goes 1 level deep\n+      boolean finished = true;\n+      for (JobInfo child : jobInfo.getChildren()) {\n+        if (!child.getStatus().isFinished()) {\n+          finished = false;\n+          break;\n+        }\n+      }\n+\n+      if (finished) {\n+        if (jobInfo.getStatus().equals(Status.FAILED)) {\n+          System.out.println(String.format(\"Attempt %s to load %s failed because: %s\",\n+              mRetryPolicy.getAttemptCount(), mJobConfig.getFilePath(),\n+              jobInfo.getErrorMessage()));\n+        } else if (jobInfo.getStatus().equals(Status.COMPLETED)) {\n+          System.out.println(String.format(\"Attempt %s to load %s completed\",", "originalCommit": "16b8151bcc4e9ed76a40ef9da5c108e806db8806", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "da1084b160a485795be73c0675ec396f8ce3f3eb", "chunk": "diff --git a/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java b/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\nindex 4fe8ad95ef..26466da3a3 100644\n--- a/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\n+++ b/shell/src/main/java/alluxio/cli/fs/command/DistributedLoadCommand.java\n\n@@ -122,12 +122,12 @@ public final class DistributedLoadCommand extends AbstractFileSystemCommand {\n \n       if (finished) {\n         if (jobInfo.getStatus().equals(Status.FAILED)) {\n-          System.out.println(String.format(\"Attempt %s to load %s failed because: %s\",\n+          System.out.println(String.format(\"Attempt %d to load %s failed because: %s\",\n               mRetryPolicy.getAttemptCount(), mJobConfig.getFilePath(),\n               jobInfo.getErrorMessage()));\n         } else if (jobInfo.getStatus().equals(Status.COMPLETED)) {\n-          System.out.println(String.format(\"Attempt %s to load %s completed\",\n-              mRetryPolicy.getAttemptCount(), mJobConfig.getFilePath()));\n+          System.out.println(String.format(\"Successfully loaded path %s after %d attempts\",\n+                  mJobConfig.getFilePath(), mRetryPolicy.getAttemptCount()));\n         }\n         return jobInfo.getStatus();\n       }\n"}}, {"oid": "da1084b160a485795be73c0675ec396f8ce3f3eb", "url": "https://github.com/Alluxio/alluxio/commit/da1084b160a485795be73c0675ec396f8ce3f3eb", "message": "feedback", "committedDate": "2020-01-08T21:34:56Z", "type": "commit"}]}