{"pr_number": 11763, "pr_title": "Add null checks for glueUDB", "pr_createdAt": "2020-07-14T02:51:12Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11763", "timeline": [{"oid": "37777c24c5bcd699c462289b404a465188002dc5", "url": "https://github.com/Alluxio/alluxio/commit/37777c24c5bcd699c462289b404a465188002dc5", "message": "Add check null for glueDb, fix style", "committedDate": "2020-07-14T02:32:09Z", "type": "commit"}, {"oid": "2c0c8a4ab33afb5bb0dd574ff832b39a26184216", "url": "https://github.com/Alluxio/alluxio/commit/2c0c8a4ab33afb5bb0dd574ff832b39a26184216", "message": "Fix style", "committedDate": "2020-07-14T02:40:17Z", "type": "commit"}, {"oid": "0ecab2085a83d8ead5456165ab5f1169baae6ac7", "url": "https://github.com/Alluxio/alluxio/commit/0ecab2085a83d8ead5456165ab5f1169baae6ac7", "message": "Fix style", "committedDate": "2020-07-14T02:50:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA3NzYzMA==", "url": "https://github.com/Alluxio/alluxio/pull/11763#discussion_r454077630", "bodyText": "Is this the only use of statsMap? We may be able to just get rid of this variable and here, we could just use Collections.emptyList().", "author": "gpang", "createdAt": "2020-07-14T03:31:22Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java", "diffHunk": "@@ -346,28 +340,29 @@ public UdbTable getTable(String tableName) throws IOException {\n       List<UdbPartition> udbPartitions = new ArrayList<>();\n       if (partitionColumns.isEmpty()) {\n         PartitionInfo.Builder partitionInfoBuilder = PartitionInfo.newBuilder()\n-            .setDbName(getUdbContext().getDbName())\n+            .setDbName(mGlueDbName)\n             .setTableName(tableName)\n             .addAllDataCols(GlueUtils.toProto(table.getStorageDescriptor().getColumns()))\n             .setStorage(GlueUtils.toProto(table.getStorageDescriptor(), pathTranslator))\n             .setPartitionName(tableName)\n-            .putAllParameters(table.getParameters());\n+            .putAllParameters(tableParameters);\n         udbPartitions.add(new GluePartition(\n             new HiveLayout(partitionInfoBuilder.build(), Collections.emptyList())));\n       } else {\n         for (Partition partition : partitions) {\n           String partName = GlueUtils.makePartitionName(partitionColumns, partition.getValues());\n-          PartitionInfo.Builder pib = PartitionInfo.newBuilder()\n-              .setDbName(getUdbContext().getDbName())\n+          PartitionInfo.Builder partitionInfoBuilder = PartitionInfo.newBuilder()\n+              .setDbName(mGlueDbName)\n               .setTableName(tableName)\n               .addAllDataCols(GlueUtils.toProto(partition.getStorageDescriptor().getColumns()))\n               .setStorage(GlueUtils.toProto(partition.getStorageDescriptor(), pathTranslator))\n               .setPartitionName(partName)\n-              .putAllParameters(partition.getParameters());\n+              .putAllParameters(partition.getParameters() == null\n+                  ? Collections.emptyMap() : partition.getParameters());\n           if (partition.getValues() != null) {\n-            pib.addAllValues(partition.getValues());\n+            partitionInfoBuilder.addAllValues(partition.getValues());\n           }\n-          udbPartitions.add(new GluePartition(new HiveLayout(pib.build(),\n+          udbPartitions.add(new GluePartition(new HiveLayout(partitionInfoBuilder.build(),\n               statsMap.getOrDefault(partName, Collections.emptyList()))));", "originalCommit": "0ecab2085a83d8ead5456165ab5f1169baae6ac7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5NDA5MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11763#discussion_r454094091", "bodyText": "I have changed to Collections.emptyList(), and I noticed the latest glue client supports the column statistics, added to TODO.", "author": "HelloHorizon", "createdAt": "2020-07-14T04:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA3NzYzMA=="}], "type": "inlineReview", "revised_code": {"commit": "23a6b9f83f1dd209bfe4b5f2958a4e2937b05f00", "chunk": "diff --git a/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java b/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\nindex 79a3aa09d7..0169c2e019 100644\n--- a/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\n+++ b/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\n\n@@ -363,7 +365,7 @@ public class GlueDatabase implements UnderDatabase {\n             partitionInfoBuilder.addAllValues(partition.getValues());\n           }\n           udbPartitions.add(new GluePartition(new HiveLayout(partitionInfoBuilder.build(),\n-              statsMap.getOrDefault(partName, Collections.emptyList()))));\n+              Collections.emptyList())));\n         }\n       }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA3ODc1NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11763#discussion_r454078755", "bodyText": "I feel like the previous code was better, since we still create a new map for our own internal data structure. What does the new code fix?\nWe could change this code a little bit to be something like:\nif (parameters != null) {\n  glueParameters.putAll(parameters);\n}", "author": "gpang", "createdAt": "2020-07-14T03:35:40Z", "path": "table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java", "diffHunk": "@@ -123,13 +122,8 @@ public DatabaseInfo getDatabaseInfo() throws IOException {\n           ? \"\" : glueDatabase.getLocationUri();\n       String glueDbDescription = glueDatabase.getDescription() == null\n           ? \"\" : glueDatabase.getDescription();\n-      Map<String, String> glueParameters = new HashMap<>();\n-      Map<String, String> parameters = glueDatabase.getParameters();\n-      if (parameters != null) {", "originalCommit": "0ecab2085a83d8ead5456165ab5f1169baae6ac7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA5NDI3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11763#discussion_r454094272", "bodyText": "yeah, it's better, changed.", "author": "HelloHorizon", "createdAt": "2020-07-14T04:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA3ODc1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "23a6b9f83f1dd209bfe4b5f2958a4e2937b05f00", "chunk": "diff --git a/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java b/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\nindex 79a3aa09d7..0169c2e019 100644\n--- a/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\n+++ b/table/server/underdb/glue/src/main/java/alluxio/table/under/glue/GlueDatabase.java\n\n@@ -122,8 +123,10 @@ public class GlueDatabase implements UnderDatabase {\n           ? \"\" : glueDatabase.getLocationUri();\n       String glueDbDescription = glueDatabase.getDescription() == null\n           ? \"\" : glueDatabase.getDescription();\n-      Map<String, String> glueParameters = glueDatabase.getParameters() == null\n-          ? Collections.emptyMap() : glueDatabase.getParameters();\n+      Map<String, String> glueParameters = new HashMap<>();\n+      if (glueDatabase.getParameters() != null) {\n+        glueParameters.putAll(glueDatabase.getParameters());\n+      }\n       return new DatabaseInfo(\n           glueDbLocation,\n           mOwnerName,\n"}}, {"oid": "23a6b9f83f1dd209bfe4b5f2958a4e2937b05f00", "url": "https://github.com/Alluxio/alluxio/commit/23a6b9f83f1dd209bfe4b5f2958a4e2937b05f00", "message": "Add minor changes", "committedDate": "2020-07-14T04:47:39Z", "type": "commit"}]}