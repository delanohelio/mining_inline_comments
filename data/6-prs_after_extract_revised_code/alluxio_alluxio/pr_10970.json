{"pr_number": 10970, "pr_title": "Fix potential resource leak issues in LocalPageStore", "pr_createdAt": "2020-02-21T17:36:06Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10970", "timeline": [{"oid": "af969558636dd767248bb815a57642a4a0226fbb", "url": "https://github.com/Alluxio/alluxio/commit/af969558636dd767248bb815a57642a4a0226fbb", "message": "Close Files.walk stream resource in LocalPageStore", "committedDate": "2020-02-21T17:34:54Z", "type": "commit"}, {"oid": "523d6d2210af40c2eb230b2f9ab510158a04de75", "url": "https://github.com/Alluxio/alluxio/commit/523d6d2210af40c2eb230b2f9ab510158a04de75", "message": "Make the channel returned by LocalPageStore.get also close the input stream on close", "committedDate": "2020-02-21T17:54:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NTA0OA==", "url": "https://github.com/Alluxio/alluxio/pull/10970#discussion_r382765048", "bodyText": "Make a vanilla delegating file channel and then a subclass that does the closing? This also will fix the strangeness of having the delegating filechannel require an inputstream in the constructor.", "author": "calvinjia", "createdAt": "2020-02-21T19:29:44Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/DelegatingFileChannel.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache.store;\n+\n+import java.io.FileInputStream;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.MappedByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.nio.channels.FileLock;\n+import java.nio.channels.ReadableByteChannel;\n+import java.nio.channels.WritableByteChannel;\n+\n+/**\n+ * A delegating {@link FileChannel} that also closes the FileInputStream as well.\n+ */\n+public class DelegatingFileChannel extends FileChannel {", "originalCommit": "523d6d2210af40c2eb230b2f9ab510158a04de75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "32934e9b28fc0b83efcfc64b68ce872e55b986a0", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/store/DelegatingFileChannel.java b/core/client/fs/src/main/java/alluxio/client/file/cache/store/DelegatingFileChannel.java\ndeleted file mode 100644\nindex d30dda8cc6..0000000000\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/store/DelegatingFileChannel.java\n+++ /dev/null\n\n@@ -1,127 +0,0 @@\n-/*\n- * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n- * (the \"License\"). You may not use this work except in compliance with the License, which is\n- * available at www.apache.org/licenses/LICENSE-2.0\n- *\n- * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n- * either express or implied, as more fully set forth in the License.\n- *\n- * See the NOTICE file distributed with this work for information regarding copyright ownership.\n- */\n-\n-package alluxio.client.file.cache.store;\n-\n-import java.io.FileInputStream;\n-import java.io.IOException;\n-import java.nio.ByteBuffer;\n-import java.nio.MappedByteBuffer;\n-import java.nio.channels.FileChannel;\n-import java.nio.channels.FileLock;\n-import java.nio.channels.ReadableByteChannel;\n-import java.nio.channels.WritableByteChannel;\n-\n-/**\n- * A delegating {@link FileChannel} that also closes the FileInputStream as well.\n- */\n-public class DelegatingFileChannel extends FileChannel {\n-\n-  private FileChannel mFileChannel;\n-  private FileInputStream mInputStream;\n-\n-  /**\n-   * Constructor for DelegatingFileChannel that takes in the {@link FileChannel} and {@link FileInputStream}\n-   * @param fileChannel the fileChannel\n-   * @param inputStream the input stream\n-   */\n-  public DelegatingFileChannel(FileChannel fileChannel, FileInputStream inputStream) {\n-    mFileChannel = fileChannel;\n-    mInputStream = inputStream;\n-  }\n-\n-\n-  @Override\n-  public int read(ByteBuffer dst) throws IOException {\n-    return mFileChannel.read(dst);\n-  }\n-\n-  @Override\n-  public long read(ByteBuffer[] dsts, int offset, int length) throws IOException {\n-    return mFileChannel.read(dsts, offset, length);\n-  }\n-\n-  @Override\n-  public int write(ByteBuffer src) throws IOException {\n-    return mFileChannel.write(src);\n-  }\n-\n-  @Override\n-  public long write(ByteBuffer[] srcs, int offset, int length) throws IOException {\n-    return mFileChannel.write(srcs, offset, length);\n-  }\n-\n-  @Override\n-  public long position() throws IOException {\n-    return mFileChannel.position();\n-  }\n-\n-  @Override\n-  public FileChannel position(long newPosition) throws IOException {\n-    return mFileChannel.position(newPosition);\n-  }\n-\n-  @Override\n-  public long size() throws IOException {\n-    return mFileChannel.size();\n-  }\n-\n-  @Override\n-  public FileChannel truncate(long size) throws IOException {\n-    return mFileChannel.truncate(size);\n-  }\n-\n-  @Override\n-  public void force(boolean metaData) throws IOException {\n-    mFileChannel.force(metaData);\n-  }\n-\n-  @Override\n-  public long transferTo(long position, long count, WritableByteChannel target) throws IOException {\n-    return mFileChannel.transferTo(position, count, target);\n-  }\n-\n-  @Override\n-  public long transferFrom(ReadableByteChannel src, long position, long count) throws IOException {\n-    return mFileChannel.transferFrom(src, position, count);\n-  }\n-\n-  @Override\n-  public int read(ByteBuffer dst, long position) throws IOException {\n-    return mFileChannel.read(dst, position);\n-  }\n-\n-  @Override\n-  public int write(ByteBuffer src, long position) throws IOException {\n-    return mFileChannel.write(src, position);\n-  }\n-\n-  @Override\n-  public MappedByteBuffer map(MapMode mode, long position, long size) throws IOException {\n-    return mFileChannel.map(mode, position, size);\n-  }\n-\n-  @Override\n-  public FileLock lock(long position, long size, boolean shared) throws IOException {\n-    return mFileChannel.lock(position, size, shared);\n-  }\n-\n-  @Override\n-  public FileLock tryLock(long position, long size, boolean shared) throws IOException {\n-    return mFileChannel.tryLock(position, size, shared);\n-  }\n-\n-  @Override\n-  protected void implCloseChannel() throws IOException {\n-    mFileChannel.close();\n-    mInputStream.close();\n-  }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc2NTMxNQ==", "url": "https://github.com/Alluxio/alluxio/pull/10970#discussion_r382765315", "bodyText": "Do you mind doing the filter outside of the try? (See #getPages)", "author": "calvinjia", "createdAt": "2020-02-21T19:30:23Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java", "diffHunk": "@@ -69,9 +69,12 @@ public LocalPageStore(LocalPageStoreOptions options) throws IOException {\n     mPagePattern = Pattern.compile(\n         String.format(\"%s/%d/(\\\\d+)/(\\\\d+)\", Pattern.quote(rootDir.toString()), mPageSize));\n     try {\n-      boolean invalidPage = Files.exists(rootDir) && Files.walk(rootDir)\n-          .filter(Files::isRegularFile)\n-          .anyMatch(path -> {\n+\n+      boolean invalidPage = false;\n+\n+      if (Files.exists(rootDir)) {\n+        try (Stream<Path> pathStream = Files.walk(rootDir).filter(Files::isRegularFile)) {", "originalCommit": "523d6d2210af40c2eb230b2f9ab510158a04de75", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "32934e9b28fc0b83efcfc64b68ce872e55b986a0", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java b/core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java\nindex 2e36781d32..a4b7816ede 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/store/LocalPageStore.java\n\n@@ -73,8 +73,8 @@ public class LocalPageStore implements PageStore {\n       boolean invalidPage = false;\n \n       if (Files.exists(rootDir)) {\n-        try (Stream<Path> pathStream = Files.walk(rootDir).filter(Files::isRegularFile)) {\n-          invalidPage = pathStream.anyMatch(path -> {\n+        try (Stream<Path> stream = Files.walk(rootDir)) {\n+          invalidPage = stream.filter(Files::isRegularFile).anyMatch(path -> {\n             if (getPageId(path) == null) {\n               LOG.warn(\"Invalid page path {}\", path);\n               return true;\n"}}, {"oid": "32934e9b28fc0b83efcfc64b68ce872e55b986a0", "url": "https://github.com/Alluxio/alluxio/commit/32934e9b28fc0b83efcfc64b68ce872e55b986a0", "message": "Feedback + Undo DelegatingFileChannel changes", "committedDate": "2020-02-21T20:53:59Z", "type": "commit"}, {"oid": "0acdb8ff0d1dce44287fe3c8640a03f1dc439a99", "url": "https://github.com/Alluxio/alluxio/commit/0acdb8ff0d1dce44287fe3c8640a03f1dc439a99", "message": "fix formatting", "committedDate": "2020-02-21T21:52:57Z", "type": "commit"}]}