{"pr_number": 10825, "pr_title": "Add instance check", "pr_createdAt": "2020-01-31T23:28:57Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10825", "timeline": [{"oid": "010f4c429d68f24d7c70dda876743d7d7e0ca606", "url": "https://github.com/Alluxio/alluxio/commit/010f4c429d68f24d7c70dda876743d7d7e0ca606", "message": "Implement EC2 and GCP instance check", "committedDate": "2020-01-31T23:07:18Z", "type": "commit"}, {"oid": "a7ace6bd1b0e351817975cbc93577d4977ab25bc", "url": "https://github.com/Alluxio/alluxio/commit/a7ace6bd1b0e351817975cbc93577d4977ab25bc", "message": "Fix UpdateCheckTest", "committedDate": "2020-01-31T23:28:20Z", "type": "commit"}, {"oid": "8b81cd50160c5e2396bd1e8f302f3df70f0064d1", "url": "https://github.com/Alluxio/alluxio/commit/8b81cd50160c5e2396bd1e8f302f3df70f0064d1", "message": "Fix the findbugs issues", "committedDate": "2020-02-03T18:23:58Z", "type": "commit"}, {"oid": "de47fe1986edbb732820d2a26daf607bb8f27aab", "url": "https://github.com/Alluxio/alluxio/commit/de47fe1986edbb732820d2a26daf607bb8f27aab", "message": "fix DMI_HARDCODED_ABSOLUTE_FILENAME", "committedDate": "2020-02-03T18:43:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI4NjU0Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374286542", "bodyText": "make this call in UpdateCheck instance so that we query the metadata service only once and not for each call like isCFT  / isEMR? try to minimize the metadata service calls needed", "author": "madanadit", "createdAt": "2020-02-03T19:11:41Z", "path": "core/common/src/main/java/alluxio/util/EnvironmentUtils.java", "diffHunk": "@@ -45,5 +59,197 @@ public static boolean isKubernetes() {\n     return System.getenv(\"KUBERNETES_SERVICE_HOST\") != null;\n   }\n \n+  /**\n+   * Utility to detect the EC2 deployment environment.\n+   *\n+   * @return true, if running on EC2\n+   */\n+  public static boolean isEC2() {\n+    return isEC2WithUUID() || isEC2WithProductUUID() || isEC2WithInstanceIdentity();\n+  }\n+\n+  /**\n+   * Utility to detect the Google compute engine deployment environment.\n+   *\n+   * @return true, if running on gce\n+   */\n+  public static boolean isGoogleComputeEngine() {\n+    return isGCEWithMetadata() || isGCEWithBiosVendor();\n+  }\n+\n+  /**\n+   * Gets the EC2 product code if any.\n+   *\n+   * @return the first product code if any, an empty string otherwise\n+   */\n+  public static String getEC2ProductCode() {\n+    try {\n+      List<String> productCodes = EC2MetadataUtils.getProductCodes();\n+      if (productCodes.size() < 1) {\n+        return \"\";\n+      }\n+      return productCodes.get(0);\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have product code\n+      return \"\";\n+    }\n+  }\n+\n+  /**\n+   * @return true if this instance is launched from CFT, false otherwise\n+   */\n+  public static boolean isCFT() {\n+    try {\n+      String userData = EC2MetadataUtils.getUserData();", "originalCommit": "de47fe1986edbb732820d2a26daf607bb8f27aab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0MDY1OA==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374340658", "bodyText": "Move this call to UpdateCheck, thanks", "author": "LuQQiu", "createdAt": "2020-02-03T21:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI4NjU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "271f7ac2d6ab6a837f79db3e94319052abe73b55", "chunk": "diff --git a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\nindex 61a031317f..24e8bb9c11 100644\n--- a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n+++ b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n\n@@ -97,38 +98,26 @@ public final class EnvironmentUtils {\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through CFT.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from CFT, false otherwise\n    */\n-  public static boolean isCFT() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"cft_configure\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isCFT(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"cft_configure\");\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through EMR.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from EMR, false otherwise\n    */\n-  public static boolean isEMR() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"emr-apps\")\n-          && userData.contains(\"emr-platform\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isEMR(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"emr-apps\")\n+        && userData.contains(\"emr-platform\");\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5Mjc1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374292750", "bodyText": "nit: instead of reading the entire file, read a limited number of bytes into a buffer of length=content.size only?", "author": "madanadit", "createdAt": "2020-02-03T19:24:09Z", "path": "core/common/src/main/java/alluxio/util/EnvironmentUtils.java", "diffHunk": "@@ -45,5 +59,197 @@ public static boolean isKubernetes() {\n     return System.getenv(\"KUBERNETES_SERVICE_HOST\") != null;\n   }\n \n+  /**\n+   * Utility to detect the EC2 deployment environment.\n+   *\n+   * @return true, if running on EC2\n+   */\n+  public static boolean isEC2() {\n+    return isEC2WithUUID() || isEC2WithProductUUID() || isEC2WithInstanceIdentity();\n+  }\n+\n+  /**\n+   * Utility to detect the Google compute engine deployment environment.\n+   *\n+   * @return true, if running on gce\n+   */\n+  public static boolean isGoogleComputeEngine() {\n+    return isGCEWithMetadata() || isGCEWithBiosVendor();\n+  }\n+\n+  /**\n+   * Gets the EC2 product code if any.\n+   *\n+   * @return the first product code if any, an empty string otherwise\n+   */\n+  public static String getEC2ProductCode() {\n+    try {\n+      List<String> productCodes = EC2MetadataUtils.getProductCodes();\n+      if (productCodes.size() < 1) {\n+        return \"\";\n+      }\n+      return productCodes.get(0);\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have product code\n+      return \"\";\n+    }\n+  }\n+\n+  /**\n+   * @return true if this instance is launched from CFT, false otherwise\n+   */\n+  public static boolean isCFT() {\n+    try {\n+      String userData = EC2MetadataUtils.getUserData();\n+      if (!userData.isEmpty() && userData.contains(\"cft_configure\")) {\n+        return true;\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have user data\n+      return false;\n+    }\n+    return false;\n+  }\n+\n+  /**\n+   * @return true if this instance is launched from EMR, false otherwise\n+   */\n+  public static boolean isEMR() {\n+    try {\n+      String userData = EC2MetadataUtils.getUserData();\n+      if (!userData.isEmpty() && userData.contains(\"emr-apps\")\n+          && userData.contains(\"emr-platform\")) {\n+        return true;\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have user data\n+      return false;\n+    }\n+    return false;\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with UUID file.\n+   * This method does not work on new m5 or c5 ec2 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithUUID() {\n+    try {\n+      return fileExistAndStartWithIdentifier(\"/sys/hypervisor/uuid\", \"ec2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with product UUID file\n+   * This method does not work on new m5 or c5 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with product UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithProductUUID() {\n+    try {\n+      return fileExistAndStartWithIdentifier(\"/sys/devices/virtual/dmi/id/product_uuid\", \"EC2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with instance identity.\n+   * Note that other cloud providers make this instance metadata URL available\n+   * and may thus cause false positive.\n+   *\n+   * @return true if jvm runs in EC2 instance with instance identity, false otherwise\n+   */\n+  private static boolean isEC2WithInstanceIdentity() {\n+    try {\n+      EC2MetadataUtils.getInstanceInfo();\n+      return true;\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with google metadata available\n+   */\n+  private static boolean isGCEWithMetadata() {\n+    try {\n+      String url = \"http://metadata.google.internal/computeMetadata/v1/instance/zone\";\n+      HttpGet post = new HttpGet(url);\n+      post.setHeader(\"Metadata-Flavor\", \"Google\");\n+      HttpClient client = HttpClientBuilder.create()\n+          .setDefaultRequestConfig(\n+              RequestConfig.custom()\n+                  .setConnectionRequestTimeout(1000)\n+                  .setConnectTimeout(1000)\n+                  .setSocketTimeout(1000)\n+                  .build())\n+          .build();\n+      HttpResponse response = client.execute(post);\n+\n+      int responseCode = response.getStatusLine().getStatusCode();\n+      if (responseCode != HttpURLConnection.HTTP_OK) {\n+        return false;\n+      }\n+      String zone = EntityUtils.toString(response.getEntity(), \"UTF-8\");\n+      return !zone.isEmpty();\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not GCE instance\n+      // or this GCE does not allow fetching metadata\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with Google bios vendor\n+   */\n+  private static boolean isGCEWithBiosVendor() {\n+    try {\n+      Process process = Runtime.getRuntime().exec(\"sudo dmidecode -s bios-vendor\");\n+      try (Reader reader = new InputStreamReader(process.getInputStream())) {\n+        String output = CharStreams.toString(reader);\n+        return output.contains(\"Google\");\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not\n+      // running on Google bios vendor\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Checks if the target file exists and starts with the identifier string.\n+   *\n+   * @param filePath the file to check\n+   * @param identifier the string identifier to check\n+   * @return true if file exists and starts with the identifier\n+   */\n+  private static boolean fileExistAndStartWithIdentifier(String filePath,\n+      String identifier) throws IOException {\n+    if (FileUtils.exists(filePath)) {\n+      try (Reader reader = new InputStreamReader(new FileInputStream(filePath))) {\n+        String content = CharStreams.toString(reader);", "originalCommit": "de47fe1986edbb732820d2a26daf607bb8f27aab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0MDc4NA==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374340784", "bodyText": "Change to read only the identifer size length in the file. Thanks", "author": "LuQQiu", "createdAt": "2020-02-03T21:06:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5Mjc1MA=="}], "type": "inlineReview", "revised_code": {"commit": "271f7ac2d6ab6a837f79db3e94319052abe73b55", "chunk": "diff --git a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\nindex 61a031317f..24e8bb9c11 100644\n--- a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n+++ b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n\n@@ -97,38 +98,26 @@ public final class EnvironmentUtils {\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through CFT.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from CFT, false otherwise\n    */\n-  public static boolean isCFT() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"cft_configure\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isCFT(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"cft_configure\");\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through EMR.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from EMR, false otherwise\n    */\n-  public static boolean isEMR() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"emr-apps\")\n-          && userData.contains(\"emr-platform\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isEMR(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"emr-apps\")\n+        && userData.contains(\"emr-platform\");\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5NDM2Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374294367", "bodyText": "nit: rename to ec2UUIDFileExistsWithID?", "author": "madanadit", "createdAt": "2020-02-03T19:27:25Z", "path": "core/common/src/main/java/alluxio/util/EnvironmentUtils.java", "diffHunk": "@@ -45,5 +59,197 @@ public static boolean isKubernetes() {\n     return System.getenv(\"KUBERNETES_SERVICE_HOST\") != null;\n   }\n \n+  /**\n+   * Utility to detect the EC2 deployment environment.\n+   *\n+   * @return true, if running on EC2\n+   */\n+  public static boolean isEC2() {\n+    return isEC2WithUUID() || isEC2WithProductUUID() || isEC2WithInstanceIdentity();\n+  }\n+\n+  /**\n+   * Utility to detect the Google compute engine deployment environment.\n+   *\n+   * @return true, if running on gce\n+   */\n+  public static boolean isGoogleComputeEngine() {\n+    return isGCEWithMetadata() || isGCEWithBiosVendor();\n+  }\n+\n+  /**\n+   * Gets the EC2 product code if any.\n+   *\n+   * @return the first product code if any, an empty string otherwise\n+   */\n+  public static String getEC2ProductCode() {\n+    try {\n+      List<String> productCodes = EC2MetadataUtils.getProductCodes();\n+      if (productCodes.size() < 1) {\n+        return \"\";\n+      }\n+      return productCodes.get(0);\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have product code\n+      return \"\";\n+    }\n+  }\n+\n+  /**\n+   * @return true if this instance is launched from CFT, false otherwise\n+   */\n+  public static boolean isCFT() {\n+    try {\n+      String userData = EC2MetadataUtils.getUserData();\n+      if (!userData.isEmpty() && userData.contains(\"cft_configure\")) {\n+        return true;\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have user data\n+      return false;\n+    }\n+    return false;\n+  }\n+\n+  /**\n+   * @return true if this instance is launched from EMR, false otherwise\n+   */\n+  public static boolean isEMR() {\n+    try {\n+      String userData = EC2MetadataUtils.getUserData();\n+      if (!userData.isEmpty() && userData.contains(\"emr-apps\")\n+          && userData.contains(\"emr-platform\")) {\n+        return true;\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have user data\n+      return false;\n+    }\n+    return false;\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with UUID file.\n+   * This method does not work on new m5 or c5 ec2 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithUUID() {\n+    try {\n+      return fileExistAndStartWithIdentifier(\"/sys/hypervisor/uuid\", \"ec2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with product UUID file\n+   * This method does not work on new m5 or c5 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with product UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithProductUUID() {\n+    try {\n+      return fileExistAndStartWithIdentifier(\"/sys/devices/virtual/dmi/id/product_uuid\", \"EC2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with instance identity.\n+   * Note that other cloud providers make this instance metadata URL available\n+   * and may thus cause false positive.\n+   *\n+   * @return true if jvm runs in EC2 instance with instance identity, false otherwise\n+   */\n+  private static boolean isEC2WithInstanceIdentity() {\n+    try {\n+      EC2MetadataUtils.getInstanceInfo();\n+      return true;\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with google metadata available\n+   */\n+  private static boolean isGCEWithMetadata() {\n+    try {\n+      String url = \"http://metadata.google.internal/computeMetadata/v1/instance/zone\";\n+      HttpGet post = new HttpGet(url);\n+      post.setHeader(\"Metadata-Flavor\", \"Google\");\n+      HttpClient client = HttpClientBuilder.create()\n+          .setDefaultRequestConfig(\n+              RequestConfig.custom()\n+                  .setConnectionRequestTimeout(1000)\n+                  .setConnectTimeout(1000)\n+                  .setSocketTimeout(1000)\n+                  .build())\n+          .build();\n+      HttpResponse response = client.execute(post);\n+\n+      int responseCode = response.getStatusLine().getStatusCode();\n+      if (responseCode != HttpURLConnection.HTTP_OK) {\n+        return false;\n+      }\n+      String zone = EntityUtils.toString(response.getEntity(), \"UTF-8\");\n+      return !zone.isEmpty();\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not GCE instance\n+      // or this GCE does not allow fetching metadata\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with Google bios vendor\n+   */\n+  private static boolean isGCEWithBiosVendor() {\n+    try {\n+      Process process = Runtime.getRuntime().exec(\"sudo dmidecode -s bios-vendor\");\n+      try (Reader reader = new InputStreamReader(process.getInputStream())) {\n+        String output = CharStreams.toString(reader);\n+        return output.contains(\"Google\");\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not\n+      // running on Google bios vendor\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Checks if the target file exists and starts with the identifier string.\n+   *\n+   * @param filePath the file to check\n+   * @param identifier the string identifier to check\n+   * @return true if file exists and starts with the identifier\n+   */\n+  private static boolean fileExistAndStartWithIdentifier(String filePath,", "originalCommit": "de47fe1986edbb732820d2a26daf607bb8f27aab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0MDgxMg==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374340812", "bodyText": "Done.", "author": "LuQQiu", "createdAt": "2020-02-03T21:06:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5NDM2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "271f7ac2d6ab6a837f79db3e94319052abe73b55", "chunk": "diff --git a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\nindex 61a031317f..24e8bb9c11 100644\n--- a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n+++ b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n\n@@ -97,38 +98,26 @@ public final class EnvironmentUtils {\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through CFT.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from CFT, false otherwise\n    */\n-  public static boolean isCFT() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"cft_configure\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isCFT(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"cft_configure\");\n   }\n \n   /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through EMR.\n+   *\n+   * @param userData the ec2 instance user data\n    * @return true if this instance is launched from EMR, false otherwise\n    */\n-  public static boolean isEMR() {\n-    try {\n-      String userData = EC2MetadataUtils.getUserData();\n-      if (!userData.isEmpty() && userData.contains(\"emr-apps\")\n-          && userData.contains(\"emr-platform\")) {\n-        return true;\n-      }\n-    } catch (Throwable t) {\n-      // Exceptions are expected if this instance is not EC2 instance\n-      // or this EC2 does not have user data\n-      return false;\n-    }\n-    return false;\n+  public static boolean isEMR(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"emr-apps\")\n+        && userData.contains(\"emr-platform\");\n   }\n \n   /**\n"}}, {"oid": "271f7ac2d6ab6a837f79db3e94319052abe73b55", "url": "https://github.com/Alluxio/alluxio/commit/271f7ac2d6ab6a837f79db3e94319052abe73b55", "message": "address comments", "committedDate": "2020-02-03T20:57:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM0NTU3OA==", "url": "https://github.com/Alluxio/alluxio/pull/10825#discussion_r374345578", "bodyText": "nit: is this early line break needed?", "author": "madanadit", "createdAt": "2020-02-03T21:17:13Z", "path": "core/common/src/main/java/alluxio/util/EnvironmentUtils.java", "diffHunk": "@@ -45,5 +60,200 @@ public static boolean isKubernetes() {\n     return System.getenv(\"KUBERNETES_SERVICE_HOST\") != null;\n   }\n \n+  /**\n+   * Utility to detect the EC2 deployment environment.\n+   *\n+   * @return true, if running on EC2\n+   */\n+  public static boolean isEC2() {\n+    return isEC2WithUUID() || isEC2WithProductUUID() || isEC2WithInstanceIdentity();\n+  }\n+\n+  /**\n+   * Utility to detect the Google compute engine deployment environment.\n+   *\n+   * @return true, if running on gce\n+   */\n+  public static boolean isGoogleComputeEngine() {\n+    return isGCEWithMetadata() || isGCEWithBiosVendor();\n+  }\n+\n+  /**\n+   * Gets the EC2 product code if any.\n+   *\n+   * @return the first product code if any, an empty string otherwise\n+   */\n+  public static String getEC2ProductCode() {\n+    try {\n+      List<String> productCodes = EC2MetadataUtils.getProductCodes();\n+      if (productCodes.size() < 1) {\n+        return \"\";\n+      }\n+      return productCodes.get(0);\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this EC2 does not have product code\n+      return \"\";\n+    }\n+  }\n+\n+  /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through CFT.\n+   *\n+   * @param userData the ec2 instance user data\n+   * @return true if this instance is launched from CFT, false otherwise\n+   */\n+  public static boolean isCFT(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"cft_configure\");\n+  }\n+\n+  /**\n+   * Checks whether the given user data belongs to an instance launched\n+   * through EMR.\n+   *\n+   * @param userData the ec2 instance user data\n+   * @return true if this instance is launched from EMR, false otherwise\n+   */\n+  public static boolean isEMR(String userData) {\n+    return !userData.isEmpty() && userData.contains(\"emr-apps\")\n+        && userData.contains(\"emr-platform\");\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with UUID file.\n+   * This method does not work on new m5 or c5 ec2 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithUUID() {\n+    try {\n+      return ec2UUIDFileExistsWithID(\"/sys/hypervisor/uuid\", \"ec2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with product UUID file\n+   * This method does not work on new m5 or c5 instances.\n+   *\n+   * @return true if jvm runs in EC2 instance with product UUID file, false otherwise\n+   */\n+  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+  private static boolean isEC2WithProductUUID() {\n+    try {\n+      return ec2UUIDFileExistsWithID(\"/sys/devices/virtual/dmi/id/product_uuid\", \"EC2\");\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Check if this instance is an EC2 instance with instance identity.\n+   * Note that other cloud providers make this instance metadata URL available\n+   * and may thus cause false positive.\n+   *\n+   * @return true if jvm runs in EC2 instance with instance identity, false otherwise\n+   */\n+  private static boolean isEC2WithInstanceIdentity() {\n+    try {\n+      EC2MetadataUtils.getInstanceInfo();\n+      return true;\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not EC2 instance\n+      // or this check is not valid\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with google metadata available\n+   */\n+  private static boolean isGCEWithMetadata() {\n+    try {\n+      String url = \"http://metadata.google.internal/computeMetadata/v1/instance/zone\";\n+      HttpGet post = new HttpGet(url);\n+      post.setHeader(\"Metadata-Flavor\", \"Google\");\n+      HttpClient client = HttpClientBuilder.create()\n+          .setDefaultRequestConfig(\n+              RequestConfig.custom()\n+                  .setConnectionRequestTimeout(1000)\n+                  .setConnectTimeout(1000)\n+                  .setSocketTimeout(1000)\n+                  .build())\n+          .build();\n+      HttpResponse response = client.execute(post);\n+\n+      int responseCode = response.getStatusLine().getStatusCode();\n+      if (responseCode != HttpURLConnection.HTTP_OK) {\n+        return false;\n+      }\n+      String zone = EntityUtils.toString(response.getEntity(), \"UTF-8\");\n+      return !zone.isEmpty();\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not GCE instance\n+      // or this GCE does not allow fetching metadata\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * @return true, if running on GCE with Google bios vendor\n+   */\n+  private static boolean isGCEWithBiosVendor() {\n+    try {\n+      Process process = Runtime.getRuntime().exec(\"sudo dmidecode -s bios-vendor\");\n+      try (Reader reader = new InputStreamReader(process.getInputStream())) {\n+        String output = CharStreams.toString(reader);\n+        return output.contains(\"Google\");\n+      }\n+    } catch (Throwable t) {\n+      // Exceptions are expected if this instance is not\n+      // running on Google bios vendor\n+      return false;\n+    }\n+  }\n+\n+  /**\n+   * Checks if the target ec2 UUID file exists and starts with the identifier string.\n+   *\n+   * @param filePath the file to check\n+   * @param identifier the string identifier to check\n+   * @return true if file exists and starts with the identifier\n+   */\n+  private static boolean ec2UUIDFileExistsWithID(String filePath,\n+      String identifier) throws IOException {\n+    if (FileUtils.exists(filePath)) {\n+      int length = identifier.length();\n+      // Read the first several bytes to see\n+      // if file starts with id", "originalCommit": "271f7ac2d6ab6a837f79db3e94319052abe73b55", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6d5de27879f8ed278efee0eaaf39050f44847cb2", "chunk": "diff --git a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\nindex 24e8bb9c11..aa93785e3a 100644\n--- a/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n+++ b/core/common/src/main/java/alluxio/util/EnvironmentUtils.java\n\n@@ -231,8 +231,6 @@ public final class EnvironmentUtils {\n       String identifier) throws IOException {\n     if (FileUtils.exists(filePath)) {\n       int length = identifier.length();\n-      // Read the first several bytes to see\n-      // if file starts with id\n       byte[] array = new byte[length];\n       try (InputStream in = new FileInputStream(filePath)) {\n         int offset = 0;\n"}}, {"oid": "4ca73360be3dbdf5ee4670f04c9633ba6a932978", "url": "https://github.com/Alluxio/alluxio/commit/4ca73360be3dbdf5ee4670f04c9633ba6a932978", "message": "Fix updateCheckTest", "committedDate": "2020-02-03T21:36:53Z", "type": "commit"}, {"oid": "6d5de27879f8ed278efee0eaaf39050f44847cb2", "url": "https://github.com/Alluxio/alluxio/commit/6d5de27879f8ed278efee0eaaf39050f44847cb2", "message": "smallfix", "committedDate": "2020-02-03T21:58:17Z", "type": "commit"}]}