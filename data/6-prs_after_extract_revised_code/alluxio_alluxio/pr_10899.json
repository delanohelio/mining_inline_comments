{"pr_number": 10899, "pr_title": "Add Wasbs support to Wasb Underfs", "pr_createdAt": "2020-02-12T20:11:19Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10899", "timeline": [{"oid": "c3b04d4788a880f68c084d60e8219d327874a325", "url": "https://github.com/Alluxio/alluxio/commit/c3b04d4788a880f68c084d60e8219d327874a325", "message": "adding configuration changes for wasbs", "committedDate": "2020-02-12T20:12:39Z", "type": "forcePushed"}, {"oid": "adbdd4e74457d009f73a7fd4cc7e6bae18791a13", "url": "https://github.com/Alluxio/alluxio/commit/adbdd4e74457d009f73a7fd4cc7e6bae18791a13", "message": "adding configuration changes for wasbs", "committedDate": "2020-02-12T20:16:23Z", "type": "forcePushed"}, {"oid": "69b394ffb22f5fbb583dd441b75f9ee0202151ee", "url": "https://github.com/Alluxio/alluxio/commit/69b394ffb22f5fbb583dd441b75f9ee0202151ee", "message": "Adding wasbs support to wasb underfs", "committedDate": "2020-02-12T20:23:36Z", "type": "commit"}, {"oid": "b9f403e37e2721547c7e2b59e5305d7e834b7ad1", "url": "https://github.com/Alluxio/alluxio/commit/b9f403e37e2721547c7e2b59e5305d7e834b7ad1", "message": "Fix wasbs test typo", "committedDate": "2020-02-12T20:23:52Z", "type": "commit"}, {"oid": "70e4afe6a707fe325abb60c0a6ed8dc86041453c", "url": "https://github.com/Alluxio/alluxio/commit/70e4afe6a707fe325abb60c0a6ed8dc86041453c", "message": "adding configuration changes for wasbs", "committedDate": "2020-02-12T20:24:15Z", "type": "commit"}, {"oid": "70e4afe6a707fe325abb60c0a6ed8dc86041453c", "url": "https://github.com/Alluxio/alluxio/commit/70e4afe6a707fe325abb60c0a6ed8dc86041453c", "message": "adding configuration changes for wasbs", "committedDate": "2020-02-12T20:24:15Z", "type": "forcePushed"}, {"oid": "2432b2f246c94192c3066b66bde4fed67119fe47", "url": "https://github.com/Alluxio/alluxio/commit/2432b2f246c94192c3066b66bde4fed67119fe47", "message": "Fixing for checkstyle", "committedDate": "2020-02-12T20:43:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzODc0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r378538741", "bodyText": "isWasb doesn't seem very clear to me. Do you think something like isSecure might be easier to understand? - If so, you'd also have to flip the logic for the conditional below", "author": "ZacBlanco", "createdAt": "2020-02-12T22:02:34Z", "path": "underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java", "diffHunk": "@@ -36,15 +38,18 @@\n   private static final Logger LOG = LoggerFactory.getLogger(WasbUnderFileSystem.class);\n \n   /** Constant for the wasb URI scheme. */\n-  public static final String SCHEME = \"wasb://\";\n+  public static final List<String> SCHEMES = Stream.of(\"wasb://\", \"wasbs://\")\n+          .collect(Collectors.toList());\n \n   /**\n    * Prepares the configuration for this Wasb as an HDFS configuration.\n    *\n    * @param conf the configuration for this UFS\n+   * @param isWasb whether to use wasb configuration or not\n    * @return the created configuration\n    */\n-  public static Configuration createConfiguration(UnderFileSystemConfiguration conf) {\n+  public static Configuration createConfiguration(UnderFileSystemConfiguration conf,\n+          Boolean isWasb) {", "originalCommit": "2432b2f246c94192c3066b66bde4fed67119fe47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NjY1Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r378546652", "bodyText": "Sure, I have changed this flag to isSecure.", "author": "imiller31", "createdAt": "2020-02-12T22:20:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzODc0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8064122f3ebabd7559e12cd1b365a168f31d4e67", "chunk": "diff --git a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\nindex 295c062b65..f6b4dbe117 100644\n--- a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n+++ b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n\n@@ -45,11 +45,11 @@ public class WasbUnderFileSystem extends HdfsUnderFileSystem {\n    * Prepares the configuration for this Wasb as an HDFS configuration.\n    *\n    * @param conf the configuration for this UFS\n-   * @param isWasb whether to use wasb configuration or not\n+   * @param isSecure whether blob storage is using https\n    * @return the created configuration\n    */\n   public static Configuration createConfiguration(UnderFileSystemConfiguration conf,\n-          Boolean isWasb) {\n+          Boolean isSecure) {\n     Configuration wasbConf = HdfsUnderFileSystem.createConfiguration(conf);\n     for (Map.Entry<String, String> entry : conf.toMap().entrySet()) {\n       String key = entry.getKey();\n"}}, {"oid": "8064122f3ebabd7559e12cd1b365a168f31d4e67", "url": "https://github.com/Alluxio/alluxio/commit/8064122f3ebabd7559e12cd1b365a168f31d4e67", "message": "changing isWasb to isSecure for clarity", "committedDate": "2020-02-12T22:16:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NzI0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r379067246", "bodyText": "Does this not have to be \"fs.AbstractFileSystem.wasbs.impl\"?", "author": "gpang", "createdAt": "2020-02-13T19:20:31Z", "path": "underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java", "diffHunk": "@@ -53,8 +58,13 @@ public static Configuration createConfiguration(UnderFileSystemConfiguration con\n         wasbConf.set(key, value);\n       }\n     }\n-    wasbConf.set(\"fs.AbstractFileSystem.wasb.impl\", \"org.apache.hadoop.fs.azure.Wasb\");\n-    wasbConf.set(\"fs.wasb.impl\", \"org.apache.hadoop.fs.azure.NativeAzureFileSystem\");\n+    if (isSecure) {\n+      wasbConf.set(\"fs.AbstractFileSystem.wasb.impl\", \"org.apache.hadoop.fs.azure.Wasbs\");", "originalCommit": "8064122f3ebabd7559e12cd1b365a168f31d4e67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MDc0Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r379070743", "bodyText": "Yes this should be, that is a good catch. Strange that wasbs worked correctly in my testing.", "author": "imiller31", "createdAt": "2020-02-13T19:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NzI0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyMDMzMA==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r379120330", "bodyText": "I've validated the new code works on a k8s installation. Resolving.", "author": "imiller31", "createdAt": "2020-02-13T21:10:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2NzI0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "8b6b37dfa0b50db82c594bf09acc3de756cf6735", "chunk": "diff --git a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\nindex f6b4dbe117..326c775cb2 100644\n--- a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n+++ b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n\n@@ -59,7 +59,7 @@ public class WasbUnderFileSystem extends HdfsUnderFileSystem {\n       }\n     }\n     if (isSecure) {\n-      wasbConf.set(\"fs.AbstractFileSystem.wasb.impl\", \"org.apache.hadoop.fs.azure.Wasbs\");\n+      wasbConf.set(\"fs.AbstractFileSystem.wasbs.impl\", \"org.apache.hadoop.fs.azure.Wasbs\");\n       wasbConf.set(\"fs.wasbs.impl\", \"org.apache.hadoop.fs.azure.NativeAzureFileSystem\");\n     } else {\n       wasbConf.set(\"fs.AbstractFileSystem.wasb.impl\", \"org.apache.hadoop.fs.azure.Wasb\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2ODEwMA==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r379068100", "bodyText": "Shouldn't this be startsWith(\"wasbs://\")?\nInstead, can we have 2 other constants, like SCHEME_SECURE=\"wasbs://\", and SCHEME_INSECURE=\"wasb://\"?", "author": "gpang", "createdAt": "2020-02-13T19:22:05Z", "path": "underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java", "diffHunk": "@@ -67,7 +77,7 @@ public static Configuration createConfiguration(UnderFileSystemConfiguration con\n    */\n   public static WasbUnderFileSystem createInstance(AlluxioURI uri,\n       UnderFileSystemConfiguration conf) {\n-    Configuration wasbConf = createConfiguration(conf);\n+    Configuration wasbConf = createConfiguration(conf, uri.getScheme().startsWith(\"wasb://\"));", "originalCommit": "8064122f3ebabd7559e12cd1b365a168f31d4e67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTEyMDQ4Mg==", "url": "https://github.com/Alluxio/alluxio/pull/10899#discussion_r379120482", "bodyText": "Changed and verified", "author": "imiller31", "createdAt": "2020-02-13T21:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2ODEwMA=="}], "type": "inlineReview", "revised_code": {"commit": "8b6b37dfa0b50db82c594bf09acc3de756cf6735", "chunk": "diff --git a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\nindex f6b4dbe117..326c775cb2 100644\n--- a/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n+++ b/underfs/wasb/src/main/java/alluxio/underfs/wasb/WasbUnderFileSystem.java\n\n@@ -77,7 +77,7 @@ public class WasbUnderFileSystem extends HdfsUnderFileSystem {\n    */\n   public static WasbUnderFileSystem createInstance(AlluxioURI uri,\n       UnderFileSystemConfiguration conf) {\n-    Configuration wasbConf = createConfiguration(conf, uri.getScheme().startsWith(\"wasb://\"));\n+    Configuration wasbConf = createConfiguration(conf, uri.getScheme().startsWith(SCHEME_SECURE));\n     return new WasbUnderFileSystem(uri, conf, wasbConf);\n   }\n \n"}}, {"oid": "8b6b37dfa0b50db82c594bf09acc3de756cf6735", "url": "https://github.com/Alluxio/alluxio/commit/8b6b37dfa0b50db82c594bf09acc3de756cf6735", "message": "changing from streams to string constants", "committedDate": "2020-02-13T19:50:19Z", "type": "commit"}]}