{"pr_number": 11466, "pr_title": "Return stats from each block management task", "pr_createdAt": "2020-05-22T09:46:02Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11466", "timeline": [{"oid": "060caa13930b69af697cdb57d84110bf29d18a55", "url": "https://github.com/Alluxio/alluxio/commit/060caa13930b69af697cdb57d84110bf29d18a55", "message": "Return a report from each management task", "committedDate": "2020-05-22T09:43:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NzU4Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r429167586", "bodyText": "@calvinjia\nWhat do you think about making this log INFO level?\nIt would only print when a management task actually ran.\nAt the worst this would print every 10 seconds when;\n\nBackoffStrategy is DIRECTORY\nTiers don't align\nAlignTask can't make progress (due to failures or heavy load)\n\nI prefer this over crafting an admin report because the latter can't provide information for a full range without persistence at worker/master. I think this would be sufficient until at least we stabilize worker management infra.", "author": "ggezer", "createdAt": "2020-05-22T10:26:03Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/management/ManagementTaskCoordinator.java", "diffHunk": "@@ -181,12 +181,19 @@ private void runManagement() {\n         LOG.debug(\"Running task of type:{}\", currentTask.getClass().getSimpleName());\n         // Run the current task on coordinator thread.\n         try {\n-          currentTask.run();\n+          BlockManagementTaskResult result = currentTask.run();\n+          LOG.debug(\"Management task: {} finished with result: {}\",\n+              currentTask.getClass().getSimpleName(), result);", "originalCommit": "060caa13930b69af697cdb57d84110bf29d18a55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NjQwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r429456406", "bodyText": "I think that's fine, we can also add a template to raise the log level of this class if it is too noisy.", "author": "calvinjia", "createdAt": "2020-05-22T21:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NzU4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTUzMjY2MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r429532661", "bodyText": "Cool. I don't think it will be noisy. I will watch for a while though.", "author": "ggezer", "createdAt": "2020-05-23T09:59:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2NzU4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b9fe6b35f869ca6a64799845bdcca54906b91d41", "chunk": "diff --git a/core/server/worker/src/main/java/alluxio/worker/block/management/ManagementTaskCoordinator.java b/core/server/worker/src/main/java/alluxio/worker/block/management/ManagementTaskCoordinator.java\nindex 6df84256d3..d00d918d59 100644\n--- a/core/server/worker/src/main/java/alluxio/worker/block/management/ManagementTaskCoordinator.java\n+++ b/core/server/worker/src/main/java/alluxio/worker/block/management/ManagementTaskCoordinator.java\n\n@@ -182,8 +182,7 @@ public class ManagementTaskCoordinator implements Closeable {\n         // Run the current task on coordinator thread.\n         try {\n           BlockManagementTaskResult result = currentTask.run();\n-          LOG.debug(\"Management task: {} finished with result: {}\",\n-              currentTask.getClass().getSimpleName(), result);\n+          LOG.info(\"{} finished with result: {}\", currentTask.getClass().getSimpleName(), result);\n \n           if (result.noProgress()) {\n             LOG.debug(\"Task made no progress due to failures/back-offs. Sleeping {}ms\",\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NTE4MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r429455181", "bodyText": "Use a map here?", "author": "calvinjia", "createdAt": "2020-05-22T21:19:25Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.worker.block.management;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import java.util.Hashtable;\n+import java.util.Map;\n+\n+/**\n+ * Holds results of a {@link BlockManagementTask}.\n+ *\n+ * It contains sub-results for each {@link BlockOperationType} that is issued\n+ * by the magement task.\n+ */\n+public class BlockManagementTaskResult {\n+  /** Map of block-operation results. */\n+  private Hashtable<BlockOperationType, BlockOperationResult> mBlockOpResults;", "originalCommit": "060caa13930b69af697cdb57d84110bf29d18a55", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b9fe6b35f869ca6a64799845bdcca54906b91d41", "chunk": "diff --git a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\nindex 800c96c23d..9b3389d821 100644\n--- a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n+++ b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n\n@@ -12,6 +12,7 @@\n package alluxio.worker.block.management;\n \n import com.google.common.base.MoreObjects;\n+import net.jcip.annotations.NotThreadSafe;\n \n import java.util.Hashtable;\n import java.util.Map;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NTI4NA==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r429455284", "bodyText": "Add @NotThreadSafe?", "author": "calvinjia", "createdAt": "2020-05-22T21:19:52Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.worker.block.management;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import java.util.Hashtable;\n+import java.util.Map;\n+\n+/**\n+ * Holds results of a {@link BlockManagementTask}.\n+ *\n+ * It contains sub-results for each {@link BlockOperationType} that is issued\n+ * by the magement task.\n+ */\n+public class BlockManagementTaskResult {", "originalCommit": "060caa13930b69af697cdb57d84110bf29d18a55", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b9fe6b35f869ca6a64799845bdcca54906b91d41", "chunk": "diff --git a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\nindex 800c96c23d..9b3389d821 100644\n--- a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n+++ b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n\n@@ -12,6 +12,7 @@\n package alluxio.worker.block.management;\n \n import com.google.common.base.MoreObjects;\n+import net.jcip.annotations.NotThreadSafe;\n \n import java.util.Hashtable;\n import java.util.Map;\n"}}, {"oid": "b9fe6b35f869ca6a64799845bdcca54906b91d41", "url": "https://github.com/Alluxio/alluxio/commit/b9fe6b35f869ca6a64799845bdcca54906b91d41", "message": "PR feedback", "committedDate": "2020-05-23T09:58:40Z", "type": "commit"}, {"oid": "494cc56c6b090f4e3b704582266a6160d71550f2", "url": "https://github.com/Alluxio/alluxio/commit/494cc56c6b090f4e3b704582266a6160d71550f2", "message": "Merge branch 'master' into tm-job-stats", "committedDate": "2020-05-24T01:01:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3NDQ3Mw==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r430674473", "bodyText": "Any reason we want to use HashTable here?", "author": "calvinjia", "createdAt": "2020-05-26T20:00:52Z", "path": "core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.worker.block.management;\n+\n+import com.google.common.base.MoreObjects;\n+import net.jcip.annotations.NotThreadSafe;\n+\n+import java.util.Hashtable;\n+import java.util.Map;\n+\n+/**\n+ * Holds results of a {@link BlockManagementTask}.\n+ *\n+ * It contains sub-results for each {@link BlockOperationType} that is issued\n+ * by the magement task.\n+ */\n+@NotThreadSafe\n+public class BlockManagementTaskResult {\n+  /** Map of block-operation results. */\n+  private Map<BlockOperationType, BlockOperationResult> mBlockOpResults;\n+\n+  /**\n+   * Creates a new empty task result.\n+   */\n+  public BlockManagementTaskResult() {\n+    mBlockOpResults = new Hashtable<>();", "originalCommit": "494cc56c6b090f4e3b704582266a6160d71550f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDczMTY1OQ==", "url": "https://github.com/Alluxio/alluxio/pull/11466#discussion_r430731659", "bodyText": "no reason. just accidents. fixed.", "author": "ggezer", "createdAt": "2020-05-26T22:00:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3NDQ3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "719d373c17879c3096cdcb4fde3d09c1c777566e", "chunk": "diff --git a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\nindex 9b3389d821..5f935d1a22 100644\n--- a/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n+++ b/core/server/worker/src/main/java/alluxio/worker/block/management/BlockManagementTaskResult.java\n\n@@ -14,7 +14,7 @@ package alluxio.worker.block.management;\n import com.google.common.base.MoreObjects;\n import net.jcip.annotations.NotThreadSafe;\n \n-import java.util.Hashtable;\n+import java.util.HashMap;\n import java.util.Map;\n \n /**\n"}}, {"oid": "719d373c17879c3096cdcb4fde3d09c1c777566e", "url": "https://github.com/Alluxio/alluxio/commit/719d373c17879c3096cdcb4fde3d09c1c777566e", "message": "Fix auto-complete accident", "committedDate": "2020-05-26T21:58:20Z", "type": "commit"}]}