{"pr_number": 11567, "pr_title": "Add alluxio.hadoop.LocalCacheFileSystem.java", "pr_createdAt": "2020-06-16T07:32:22Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11567", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MTg1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441041857", "bodyText": "Should we set this to null? Or the idea is if we fail once we do not retry creating the cache manager in the future? If its the latter, update the javadoc to state we only try once.", "author": "calvinjia", "createdAt": "2020-06-16T18:03:14Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java", "diffHunk": "@@ -12,20 +12,71 @@\n package alluxio.client.file.cache;\n \n import alluxio.conf.AlluxioConfiguration;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n+\n   /**\n-   * @param conf the Alluxio configuration\n-   * @return an instance of {@link CacheManager}\n+   * Factory class to get or create a CacheManager.\n    */\n-  static CacheManager create(AlluxioConfiguration conf) throws IOException {\n-    // TODO(feng): make cache manager type configurable when we introduce more implementations.\n-    return new NoExceptionCacheManager(LocalCacheManager.create(conf));\n+  class Factory {\n+    private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n+    private static Optional<CacheManager> sCacheManager = null;\n+\n+    /**\n+     * @param conf the Alluxio configuration\n+     * @return current CacheManager, creating a new one if it doesn't yet exist\n+     */\n+    @Nullable\n+    public static synchronized CacheManager get(AlluxioConfiguration conf) throws IOException {\n+      // TODO(feng): support multiple cache managers\n+      if (sCacheManager == null) {\n+        try {\n+          sCacheManager = Optional.of(create(conf));\n+        } catch (IOException e) {\n+          sCacheManager = Optional.empty();", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDE5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r449304196", "bodyText": "now we always try to create a new filesystem to make the logic simpler to reason", "author": "apc999", "createdAt": "2020-07-02T23:11:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MTg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9d3264a576a654291a481f25d3dc6c87ec3fdb9b", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\nindex 09f3498879..fb14c355a1 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n\n@@ -20,38 +20,28 @@ import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n-import java.util.Optional;\n-\n-import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n-\n   /**\n    * Factory class to get or create a CacheManager.\n    */\n   class Factory {\n     private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n-    private static Optional<CacheManager> sCacheManager = null;\n+    private static CacheManager sCacheManager = null;\n \n     /**\n      * @param conf the Alluxio configuration\n      * @return current CacheManager, creating a new one if it doesn't yet exist\n      */\n-    @Nullable\n     public static synchronized CacheManager get(AlluxioConfiguration conf) throws IOException {\n       // TODO(feng): support multiple cache managers\n       if (sCacheManager == null) {\n-        try {\n-          sCacheManager = Optional.of(create(conf));\n-        } catch (IOException e) {\n-          sCacheManager = Optional.empty();\n-          throw e;\n-        }\n+        sCacheManager = create(conf);\n       }\n-      return sCacheManager.orElse(null);\n+      return sCacheManager;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MjEyNw==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441042127", "bodyText": "document null value meaning?", "author": "calvinjia", "createdAt": "2020-06-16T18:03:43Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java", "diffHunk": "@@ -12,20 +12,71 @@\n package alluxio.client.file.cache;\n \n import alluxio.conf.AlluxioConfiguration;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n+\n   /**\n-   * @param conf the Alluxio configuration\n-   * @return an instance of {@link CacheManager}\n+   * Factory class to get or create a CacheManager.\n    */\n-  static CacheManager create(AlluxioConfiguration conf) throws IOException {\n-    // TODO(feng): make cache manager type configurable when we introduce more implementations.\n-    return new NoExceptionCacheManager(LocalCacheManager.create(conf));\n+  class Factory {\n+    private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n+    private static Optional<CacheManager> sCacheManager = null;\n+\n+    /**\n+     * @param conf the Alluxio configuration\n+     * @return current CacheManager, creating a new one if it doesn't yet exist", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwMjMyNA==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r449302324", "bodyText": "no more nullable", "author": "apc999", "createdAt": "2020-07-02T23:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MjEyNw=="}], "type": "inlineReview", "revised_code": {"commit": "9d3264a576a654291a481f25d3dc6c87ec3fdb9b", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\nindex 09f3498879..fb14c355a1 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n\n@@ -20,38 +20,28 @@ import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n-import java.util.Optional;\n-\n-import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n-\n   /**\n    * Factory class to get or create a CacheManager.\n    */\n   class Factory {\n     private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n-    private static Optional<CacheManager> sCacheManager = null;\n+    private static CacheManager sCacheManager = null;\n \n     /**\n      * @param conf the Alluxio configuration\n      * @return current CacheManager, creating a new one if it doesn't yet exist\n      */\n-    @Nullable\n     public static synchronized CacheManager get(AlluxioConfiguration conf) throws IOException {\n       // TODO(feng): support multiple cache managers\n       if (sCacheManager == null) {\n-        try {\n-          sCacheManager = Optional.of(create(conf));\n-        } catch (IOException e) {\n-          sCacheManager = Optional.empty();\n-          throw e;\n-        }\n+        sCacheManager = create(conf);\n       }\n-      return sCacheManager.orElse(null);\n+      return sCacheManager;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MjYyMA==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441042620", "bodyText": "Do we need to throw the exception here, I thought we are using null as the signal of failed to create?", "author": "calvinjia", "createdAt": "2020-06-16T18:04:40Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java", "diffHunk": "@@ -12,20 +12,71 @@\n package alluxio.client.file.cache;\n \n import alluxio.conf.AlluxioConfiguration;\n+import alluxio.metrics.MetricKey;\n+import alluxio.metrics.MetricsSystem;\n+\n+import com.codahale.metrics.Counter;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n+\n   /**\n-   * @param conf the Alluxio configuration\n-   * @return an instance of {@link CacheManager}\n+   * Factory class to get or create a CacheManager.\n    */\n-  static CacheManager create(AlluxioConfiguration conf) throws IOException {\n-    // TODO(feng): make cache manager type configurable when we introduce more implementations.\n-    return new NoExceptionCacheManager(LocalCacheManager.create(conf));\n+  class Factory {\n+    private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n+    private static Optional<CacheManager> sCacheManager = null;\n+\n+    /**\n+     * @param conf the Alluxio configuration\n+     * @return current CacheManager, creating a new one if it doesn't yet exist\n+     */\n+    @Nullable\n+    public static synchronized CacheManager get(AlluxioConfiguration conf) throws IOException {\n+      // TODO(feng): support multiple cache managers\n+      if (sCacheManager == null) {\n+        try {\n+          sCacheManager = Optional.of(create(conf));\n+        } catch (IOException e) {\n+          sCacheManager = Optional.empty();\n+          throw e;", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDI3Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r449304276", "bodyText": "no more relevant now", "author": "apc999", "createdAt": "2020-07-02T23:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MjYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "9d3264a576a654291a481f25d3dc6c87ec3fdb9b", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\nindex 09f3498879..fb14c355a1 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheManager.java\n\n@@ -20,38 +20,28 @@ import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n-import java.util.Optional;\n-\n-import javax.annotation.Nullable;\n \n /**\n  * Interface for managing cached pages.\n  */\n public interface CacheManager extends AutoCloseable  {\n-\n   /**\n    * Factory class to get or create a CacheManager.\n    */\n   class Factory {\n     private static final Logger LOG = LoggerFactory.getLogger(Factory.class);\n-    private static Optional<CacheManager> sCacheManager = null;\n+    private static CacheManager sCacheManager = null;\n \n     /**\n      * @param conf the Alluxio configuration\n      * @return current CacheManager, creating a new one if it doesn't yet exist\n      */\n-    @Nullable\n     public static synchronized CacheManager get(AlluxioConfiguration conf) throws IOException {\n       // TODO(feng): support multiple cache managers\n       if (sCacheManager == null) {\n-        try {\n-          sCacheManager = Optional.of(create(conf));\n-        } catch (IOException e) {\n-          sCacheManager = Optional.empty();\n-          throw e;\n-        }\n+        sCacheManager = create(conf);\n       }\n-      return sCacheManager.orElse(null);\n+      return sCacheManager;\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MzM0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441043341", "bodyText": "Since CacheManager.Factory.get is nullable, we should put this in a null check instead of exception clause? Up to you how you want to handle the error path", "author": "calvinjia", "createdAt": "2020-06-16T18:05:54Z", "path": "core/client/fs/src/main/java/alluxio/client/file/FileSystem.java", "diffHunk": "@@ -147,7 +148,8 @@ public static FileSystem create(FileSystemContext context) {\n       if (conf.getBoolean(PropertyKey.USER_CLIENT_CACHE_ENABLED)\n           && CommonUtils.PROCESS_TYPE.get().equals(CommonUtils.ProcessType.CLIENT)) {\n         try {\n-          return new LocalCacheFileSystem(fs, conf);\n+          CacheManager cacheManager = CacheManager.Factory.get(conf);\n+          return new LocalCacheFileSystem(cacheManager, fs, conf);\n         } catch (IOException e) {\n           LOG.error(\"Fallback without client caching: \", e);", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwMzk3NA==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r449303974", "bodyText": "Changed CacheManager.Factory  so it is no more nullable", "author": "apc999", "createdAt": "2020-07-02T23:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MzM0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NDA0MQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441044041", "bodyText": "Should this be allowed to be null? It looks like we have fallback logic in the appropriate places", "author": "calvinjia", "createdAt": "2020-06-16T18:07:04Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LocalCacheFileSystem.java", "diffHunk": "@@ -19,49 +19,30 @@\n import alluxio.conf.AlluxioConfiguration;\n import alluxio.exception.AlluxioException;\n import alluxio.grpc.OpenFilePOptions;\n-import alluxio.metrics.MetricKey;\n-import alluxio.metrics.MetricsSystem;\n \n-import com.codahale.metrics.Counter;\n+import com.google.common.base.Preconditions;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n import java.io.IOException;\n-import java.util.Optional;\n \n /**\n  * A FileSystem implementation with a local cache.\n  */\n public class LocalCacheFileSystem extends DelegatingFileSystem {\n   private static final Logger LOG = LoggerFactory.getLogger(LocalCacheFileSystem.class);\n-  private static Optional<CacheManager> sCacheManager;\n-\n+  private final CacheManager mCacheManager;\n   private final AlluxioConfiguration mConf;\n \n-  // TODO(binfan): Remove the IOException throwing or make this into a factory method\n   /**\n+   * @param cacheManage cache manager\n    * @param fs a FileSystem instance to query on local cache miss\n    * @param conf the configuration, only respected for the first call\n    */\n-  @edu.umd.cs.findbugs.annotations.SuppressFBWarnings(\n-      value = \"ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD\",\n-      justification = \"write to static is made threadsafe\")\n-  public LocalCacheFileSystem(FileSystem fs, AlluxioConfiguration conf) throws IOException {\n+  public LocalCacheFileSystem(CacheManager cacheManage, FileSystem fs, AlluxioConfiguration conf) {\n     super(fs);\n-    // TODO(feng): support multiple cache managers\n-    if (sCacheManager == null) {\n-      synchronized (LocalCacheFileSystem.class) {\n-        if (sCacheManager == null) {\n-          try {\n-            sCacheManager = Optional.of(CacheManager.create(conf));\n-          } catch (IOException e) {\n-            Metrics.CREATE_ERRORS.inc();\n-            throw new IOException(\"Failed to create CacheManager\", e);\n-          }\n-        }\n-      }\n-    }\n-    mConf = conf;\n+    mCacheManager = Preconditions.checkNotNull(cacheManage, \"cacheManager\");", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMwNDQzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r449304439", "bodyText": "no more relevant", "author": "apc999", "createdAt": "2020-07-02T23:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NDA0MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NDU0Ng==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441044546", "bodyText": "Please add comments stating this is only to be used internally/most methods are not implemented", "author": "calvinjia", "createdAt": "2020-06-16T18:07:59Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsFileSystem.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.hadoop;\n+\n+import static com.google.common.hash.Hashing.md5;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.FileInStream;\n+import alluxio.client.file.FileOutStream;\n+import alluxio.client.file.URIStatus;\n+import alluxio.conf.AlluxioConfiguration;\n+import alluxio.grpc.CreateDirectoryPOptions;\n+import alluxio.grpc.CreateFilePOptions;\n+import alluxio.grpc.DeletePOptions;\n+import alluxio.grpc.ExistsPOptions;\n+import alluxio.grpc.FreePOptions;\n+import alluxio.grpc.GetStatusPOptions;\n+import alluxio.grpc.ListStatusPOptions;\n+import alluxio.grpc.MountPOptions;\n+import alluxio.grpc.OpenFilePOptions;\n+import alluxio.grpc.RenamePOptions;\n+import alluxio.grpc.ScheduleAsyncPersistencePOptions;\n+import alluxio.grpc.SetAclAction;\n+import alluxio.grpc.SetAclPOptions;\n+import alluxio.grpc.SetAttributePOptions;\n+import alluxio.grpc.UnmountPOptions;\n+import alluxio.security.authorization.AclEntry;\n+import alluxio.security.authorization.Mode;\n+import alluxio.wire.BlockLocationInfo;\n+import alluxio.wire.FileInfo;\n+import alluxio.wire.MountPointInfo;\n+import alluxio.wire.SyncPointInfo;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.permission.FsPermission;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A wrapper class to translate Hadoop FileSystem to Alluxio FileSystem.", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4ODAxMg==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441088012", "bodyText": "done", "author": "apc999", "createdAt": "2020-06-16T19:22:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NDU0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "aae3c92939a793f7ef9e50915b5d7c2abc9c6558", "chunk": "diff --git a/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsFileSystem.java b/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsFileSystem.java\nindex b568a9ed41..5e3f7f6d63 100644\n--- a/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsFileSystem.java\n+++ b/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsFileSystem.java\n\n@@ -11,14 +11,12 @@\n \n package alluxio.hadoop;\n \n-import static com.google.common.hash.Hashing.md5;\n-import static java.nio.charset.StandardCharsets.UTF_8;\n-\n import alluxio.AlluxioURI;\n import alluxio.client.file.FileInStream;\n import alluxio.client.file.FileOutStream;\n import alluxio.client.file.URIStatus;\n import alluxio.conf.AlluxioConfiguration;\n+import alluxio.conf.InstancedConfiguration;\n import alluxio.grpc.CreateDirectoryPOptions;\n import alluxio.grpc.CreateFilePOptions;\n import alluxio.grpc.DeletePOptions;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NjA2Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441046062", "bodyText": "For now it is okay not to support this but can we leave a TODO? Otherwise if we use the API later in LocalCacheFileInStream, there will be unexpected issues.", "author": "calvinjia", "createdAt": "2020-06-16T18:10:31Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsInputStream.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.hadoop;\n+\n+import alluxio.client.file.FileInStream;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+\n+import java.io.IOException;\n+\n+/**\n+ * A wrapper class to translate Hadoop FileSystem FSDataInputStream to Alluxio FileSystem\n+ * FileInStream.\n+ */\n+public class AlluxioHdfsInputStream extends FileInStream {\n+  private final FSDataInputStream mInput;\n+\n+  /**\n+   * @param input Hadoop FileSystem FSDataInputStream\n+   */\n+  public AlluxioHdfsInputStream(FSDataInputStream input) {\n+    mInput = Preconditions.checkNotNull(input, \"null\");\n+  }\n+\n+  @Override\n+  public int read(byte[] bytes) throws IOException {\n+    return mInput.read(bytes);\n+  }\n+\n+  @Override\n+  public int read(byte[] bytes, int offset, int length) throws IOException {\n+    return mInput.read(bytes, offset, length);\n+  }\n+\n+  @Override\n+  public int read() throws IOException {\n+    return mInput.read();\n+  }\n+\n+  @Override\n+  public long skip(long length) throws IOException {\n+    return mInput.skip(length);\n+  }\n+\n+  @Override\n+  public int available() throws IOException {\n+    return mInput.available();\n+  }\n+\n+  @Override\n+  public void close() throws IOException {\n+    mInput.close();\n+  }\n+\n+  @Override\n+  public synchronized void mark(int limit) {\n+    mInput.mark(limit);\n+  }\n+\n+  @Override\n+  public synchronized void reset() throws IOException {\n+    mInput.reset();\n+  }\n+\n+  @Override\n+  public boolean markSupported() {\n+    return mInput.markSupported();\n+  }\n+\n+  @Override\n+  public void seek(long position) throws IOException {\n+    mInput.seek(position);\n+  }\n+\n+  @Override\n+  public long getPos() throws IOException {\n+    return mInput.getPos();\n+  }\n+\n+  @Override\n+  public long remaining() {\n+    throw new UnsupportedOperationException(\"Remaining is not supported\");", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4ODYzNA==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441088634", "bodyText": "added", "author": "apc999", "createdAt": "2020-06-16T19:23:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NjA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "aae3c92939a793f7ef9e50915b5d7c2abc9c6558", "chunk": "diff --git a/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsInputStream.java b/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsInputStream.java\nindex daaea7246c..a0ded10718 100644\n--- a/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsInputStream.java\n+++ b/core/client/hdfs/src/main/java/alluxio/hadoop/AlluxioHdfsInputStream.java\n\n@@ -87,6 +87,7 @@ public class AlluxioHdfsInputStream extends FileInStream {\n     return mInput.getPos();\n   }\n \n+  // TODO(binfan): implement this method\n   @Override\n   public long remaining() {\n     throw new UnsupportedOperationException(\"Remaining is not supported\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NzYzOA==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441047638", "bodyText": "Although its a wrapper, do we want to make a new Filesystem every time?", "author": "calvinjia", "createdAt": "2020-06-16T18:13:20Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/LocalCachingFileSystem.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.hadoop;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.LocalCacheFileInStream;\n+import alluxio.conf.AlluxioConfiguration;\n+import alluxio.conf.AlluxioProperties;\n+import alluxio.conf.InstancedConfiguration;\n+import alluxio.conf.Source;\n+import alluxio.grpc.OpenFilePOptions;\n+import alluxio.metrics.MetricsConfig;\n+import alluxio.metrics.MetricsSystem;\n+import alluxio.util.ConfigurationUtils;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.permission.FsPermission;\n+import org.apache.hadoop.util.Progressable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+/**\n+ * An Alluxio client compatible with Apache Hadoop {@link org.apache.hadoop.fs.FileSystem}\n+ * interface, using Alluxio local cache. On cache miss,\n+ */\n+public class LocalCachingFileSystem extends org.apache.hadoop.fs.FileSystem {\n+  private static final Logger LOG = LoggerFactory.getLogger(LocalCachingFileSystem.class);\n+  // The filesystem to query on cache miss\n+  private final org.apache.hadoop.fs.FileSystem mExternalFileSystem;\n+  private CacheManager mCacheManager;\n+  private org.apache.hadoop.conf.Configuration mHadoopConf;\n+  private AlluxioConfiguration mAlluxioConf;\n+\n+  /**\n+   * @param fileSystem File System instance\n+   */\n+  LocalCachingFileSystem(org.apache.hadoop.fs.FileSystem fileSystem) {\n+    mExternalFileSystem = Preconditions.checkNotNull(fileSystem, \"filesystem\");\n+  }\n+\n+  @Override\n+  public synchronized void initialize(URI uri, org.apache.hadoop.conf.Configuration conf)\n+      throws IOException {\n+    super.initialize(uri, conf);\n+    mHadoopConf = conf;\n+\n+    // Set statistics\n+    setConf(conf);\n+\n+    // Take hadoop configuration to merge to Alluxio configuration\n+    Map<String, Object> hadoopConfProperties =\n+        HadoopConfigurationUtils.getConfigurationFromHadoop(conf);\n+    LOG.info(\"Creating Alluxio configuration from Hadoop configuration {}\", hadoopConfProperties);\n+    AlluxioProperties alluxioProps = ConfigurationUtils.defaults();\n+    // Merge relevant Hadoop configuration into Alluxio's configuration.\n+    alluxioProps.merge(hadoopConfProperties, Source.RUNTIME);\n+    // Creating a new instanced configuration from an AlluxioProperties object isn't expensive.\n+    mAlluxioConf = new InstancedConfiguration(alluxioProps);\n+\n+    // Handle metrics\n+    Properties metricsProperties = new Properties();\n+    for (Map.Entry<String, String> entry : conf) {\n+      metricsProperties.setProperty(entry.getKey(), entry.getValue());\n+    }\n+    MetricsSystem.startSinksFromConfig(new MetricsConfig(metricsProperties));\n+\n+    mCacheManager = CacheManager.Factory.get(mAlluxioConf);\n+  }\n+\n+  @Override\n+  public void close() throws IOException {\n+    // super.close should be called first before releasing the resources in this instance, as the\n+    // super class may invoke other methods in this class. For example,\n+    // org.apache.hadoop.fs.FileSystem.close may check the existence of certain temp files before\n+    // closing\n+    super.close();\n+    mExternalFileSystem.close();\n+  }\n+\n+  /**\n+   * @return scheme\n+   */\n+  // @Override This doesn't exist in Hadoop 1.x, so cannot put {@literal @Override}.\n+  public String getScheme() {\n+    return mExternalFileSystem.getScheme();\n+  }\n+\n+  @Override\n+  public FSDataInputStream open(Path path, int bufferSize) throws IOException {\n+    if (mCacheManager == null) {\n+      return mExternalFileSystem.open(path, bufferSize);\n+    }\n+    return new FSDataInputStream(new HdfsFileInputStream(\n+        new LocalCacheFileInStream(\n+            new AlluxioURI(path.toString()),\n+            OpenFilePOptions.getDefaultInstance(),\n+            new AlluxioHdfsFileSystem(mExternalFileSystem, mAlluxioConf), mCacheManager),", "originalCommit": "6627357b88352e656e46bc1acd0ceaccce2cc9c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA4ODk3Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r441088972", "bodyText": "created a member variable to save creation overhead", "author": "apc999", "createdAt": "2020-06-16T19:23:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NzYzOA=="}], "type": "inlineReview", "revised_code": {"commit": "aae3c92939a793f7ef9e50915b5d7c2abc9c6558", "chunk": "diff --git a/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCachingFileSystem.java b/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\nsimilarity index 81%\nrename from core/client/hdfs/src/main/java/alluxio/hadoop/LocalCachingFileSystem.java\nrename to core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\nindex 8bb230e814..a2c839e0a4 100644\n--- a/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCachingFileSystem.java\n+++ b/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\n\n@@ -12,6 +12,7 @@\n package alluxio.hadoop;\n \n import alluxio.AlluxioURI;\n+import alluxio.client.file.URIStatus;\n import alluxio.client.file.cache.CacheManager;\n import alluxio.client.file.cache.LocalCacheFileInStream;\n import alluxio.conf.AlluxioConfiguration;\n"}}, {"oid": "aae3c92939a793f7ef9e50915b5d7c2abc9c6558", "url": "https://github.com/Alluxio/alluxio/commit/aae3c92939a793f7ef9e50915b5d7c2abc9c6558", "message": "Address comments", "committedDate": "2020-06-17T04:38:23Z", "type": "forcePushed"}, {"oid": "206ee7482ee48bcc26271c908b11aa2eef94ce38", "url": "https://github.com/Alluxio/alluxio/commit/206ee7482ee48bcc26271c908b11aa2eef94ce38", "message": "Add LocalCachingFileSystem", "committedDate": "2020-07-02T22:54:22Z", "type": "commit"}, {"oid": "2eb243df914f58e5461da55d542160ce85b651a3", "url": "https://github.com/Alluxio/alluxio/commit/2eb243df914f58e5461da55d542160ce85b651a3", "message": "Address comments", "committedDate": "2020-07-02T22:54:22Z", "type": "commit"}, {"oid": "9d3264a576a654291a481f25d3dc6c87ec3fdb9b", "url": "https://github.com/Alluxio/alluxio/commit/9d3264a576a654291a481f25d3dc6c87ec3fdb9b", "message": "Address comments", "committedDate": "2020-07-02T23:20:53Z", "type": "forcePushed"}, {"oid": "1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "url": "https://github.com/Alluxio/alluxio/commit/1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "message": "Address comments", "committedDate": "2020-07-02T23:31:39Z", "type": "commit"}, {"oid": "1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "url": "https://github.com/Alluxio/alluxio/commit/1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "message": "Address comments", "committedDate": "2020-07-02T23:31:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwMDQxMQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r451000411", "bodyText": "Should we use file id here?", "author": "calvinjia", "createdAt": "2020-07-07T16:41:25Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/HadoopUtils.java", "diffHunk": "@@ -184,5 +189,30 @@ private static void setConfigurationFromSystemProperty(Configuration configurati\n     }\n   }\n \n+  /**\n+   * @param alluxioURI Alluxio uri\n+   * @return corresponding Hadoop Path instance\n+   */\n+  public static Path toPath(AlluxioURI alluxioURI) {\n+    return new Path(alluxioURI.toString());\n+  }\n+\n+  /**\n+   * @param status Hadoop file status\n+   * @return corresponding Alluxio uri status instance\n+   */\n+  public static URIStatus toUriStatus(FileStatus status) {\n+    // FilePath is a unique identifier for a file, however it can be a long string\n+    // hence using md5 hash of the file path as the identifier in the cache.\n+    FileInfo info = new FileInfo();\n+    info.setFileIdentifier(md5().hashString(status.getPath().toString(), UTF_8).toString());", "originalCommit": "1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ3NTIzOQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r452475239", "bodyText": "i don't think so. A HDFS file shall not have a fileID as fileID is alluxio generated. after some thoughts, i decided to move this util method back to AlluxioHdfsFileSystem and only accessible there as it is specific to that class", "author": "apc999", "createdAt": "2020-07-09T20:36:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwMDQxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "35484cc8be9a5020fe942f148e5b0025884a75c2", "chunk": "diff --git a/core/client/hdfs/src/main/java/alluxio/hadoop/HadoopUtils.java b/core/client/hdfs/src/main/java/alluxio/hadoop/HadoopUtils.java\nindex daa5e2a9a9..a27c87fb95 100644\n--- a/core/client/hdfs/src/main/java/alluxio/hadoop/HadoopUtils.java\n+++ b/core/client/hdfs/src/main/java/alluxio/hadoop/HadoopUtils.java\n\n@@ -197,22 +192,5 @@ public final class HadoopUtils {\n     return new Path(alluxioURI.toString());\n   }\n \n-  /**\n-   * @param status Hadoop file status\n-   * @return corresponding Alluxio uri status instance\n-   */\n-  public static URIStatus toUriStatus(FileStatus status) {\n-    // FilePath is a unique identifier for a file, however it can be a long string\n-    // hence using md5 hash of the file path as the identifier in the cache.\n-    FileInfo info = new FileInfo();\n-    info.setFileIdentifier(md5().hashString(status.getPath().toString(), UTF_8).toString());\n-    info.setLength(status.getLen()).setPath(status.getPath().toString());\n-    info.setFolder(status.isDirectory()).setBlockSizeBytes(status.getBlockSize());\n-    info.setLastModificationTimeMs(status.getModificationTime())\n-        .setLastAccessTimeMs(status.getAccessTime());\n-    info.setOwner(status.getOwner()).setGroup(status.getGroup());\n-    return new URIStatus(info);\n-  }\n-\n   private HadoopUtils() {} // prevent instantiation\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAwMDg5NQ==", "url": "https://github.com/Alluxio/alluxio/pull/11567#discussion_r451000895", "bodyText": "Complete this javadoc", "author": "calvinjia", "createdAt": "2020-07-07T16:42:10Z", "path": "core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.hadoop;\n+\n+import alluxio.AlluxioURI;\n+import alluxio.client.file.URIStatus;\n+import alluxio.client.file.cache.CacheManager;\n+import alluxio.client.file.cache.LocalCacheFileInStream;\n+import alluxio.conf.AlluxioConfiguration;\n+import alluxio.conf.AlluxioProperties;\n+import alluxio.conf.InstancedConfiguration;\n+import alluxio.conf.Source;\n+import alluxio.grpc.OpenFilePOptions;\n+import alluxio.metrics.MetricsConfig;\n+import alluxio.metrics.MetricsSystem;\n+import alluxio.util.ConfigurationUtils;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.fs.FSDataInputStream;\n+import org.apache.hadoop.fs.FSDataOutputStream;\n+import org.apache.hadoop.fs.FileStatus;\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.fs.permission.FsPermission;\n+import org.apache.hadoop.util.Progressable;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.FileNotFoundException;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+/**\n+ * An Alluxio client compatible with Apache Hadoop {@link org.apache.hadoop.fs.FileSystem}\n+ * interface, using Alluxio local cache. On cache miss,", "originalCommit": "1805639212ef92f9e0a91e9e9c1ad6644ed2ea82", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35484cc8be9a5020fe942f148e5b0025884a75c2", "chunk": "diff --git a/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java b/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\nindex a2c839e0a4..22e2f1a3b3 100644\n--- a/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\n+++ b/core/client/hdfs/src/main/java/alluxio/hadoop/LocalCacheFileSystem.java\n\n@@ -12,6 +12,7 @@\n package alluxio.hadoop;\n \n import alluxio.AlluxioURI;\n+import alluxio.Constants;\n import alluxio.client.file.URIStatus;\n import alluxio.client.file.cache.CacheManager;\n import alluxio.client.file.cache.LocalCacheFileInStream;\n"}}, {"oid": "35484cc8be9a5020fe942f148e5b0025884a75c2", "url": "https://github.com/Alluxio/alluxio/commit/35484cc8be9a5020fe942f148e5b0025884a75c2", "message": "Address comments", "committedDate": "2020-07-14T00:19:45Z", "type": "forcePushed"}, {"oid": "91f2316e05835d6c8d8b13eccb617d3947e0b772", "url": "https://github.com/Alluxio/alluxio/commit/91f2316e05835d6c8d8b13eccb617d3947e0b772", "message": "Address comments", "committedDate": "2020-07-14T00:41:27Z", "type": "commit"}, {"oid": "91f2316e05835d6c8d8b13eccb617d3947e0b772", "url": "https://github.com/Alluxio/alluxio/commit/91f2316e05835d6c8d8b13eccb617d3947e0b772", "message": "Address comments", "committedDate": "2020-07-14T00:41:27Z", "type": "forcePushed"}]}