{"pr_number": 11984, "pr_title": "Trim java opts when applying them in the command line", "pr_createdAt": "2020-08-14T00:52:32Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/11984", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxNzYwMg==", "url": "https://github.com/Alluxio/alluxio/pull/11984#discussion_r471817602", "bodyText": "The java opts are intentionally passed to the spawned tasks, so that the tasks can also be started with a larger mem size", "author": "gpang", "createdAt": "2020-08-17T22:53:29Z", "path": "stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java", "diffHunk": "@@ -87,10 +87,12 @@ protected static void mainInternal(String[] args, Benchmark benchmark) {\n    * @return the JobConfig\n    * */\n   public PlanConfig generateJobConfig(String[] args) {\n-    // remove the cluster flag\n+    // remove the cluster flag and java opts", "originalCommit": "bbb8cac4e14ff67ada050995f993e3a09e6d1e10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyNDg5Mg==", "url": "https://github.com/Alluxio/alluxio/pull/11984#discussion_r471924892", "bodyText": "when are the java opts used?", "author": "yuzhu", "createdAt": "2020-08-18T05:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTgxNzYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "508c24614f46ccef945b476561917697aeaa4a08", "chunk": "diff --git a/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java b/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\nindex 3aeff4e94e..eb18f15026 100644\n--- a/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\n+++ b/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\n\n@@ -92,9 +92,10 @@ public abstract class Benchmark<T extends TaskResult> {\n             Arrays.stream(args).filter((s) -> !BaseParameters.JAVA_OPT_FLAG.equals(s)\n                 && !BaseParameters.CLUSTER_FLAG.equals(s)\n                 && !s.isEmpty()\n-                && !mBaseParameters.mJavaOpts.contains(s.trim())).collect(Collectors.toList());\n+                && !mBaseParameters.mJavaOpts.contains(s)).collect(Collectors.toList());\n \n-    commandArgs.addAll(mBaseParameters.mJavaOpts);\n+    commandArgs.addAll(mBaseParameters.mJavaOpts.stream().map(String::trim)\n+        .collect(Collectors.toList()));\n     String className = this.getClass().getCanonicalName();\n     return new StressBenchConfig(className, commandArgs, 10000, mBaseParameters.mClusterLimit);\n   }\n"}}, {"oid": "508c24614f46ccef945b476561917697aeaa4a08", "url": "https://github.com/Alluxio/alluxio/commit/508c24614f46ccef945b476561917697aeaa4a08", "message": "make passing jvm option easier in command line\n\nfix trim location\n\nremove java opt and prevent it from recursively passed to jobworker\n\nremove trim\n\nfix checkstyle\n\nfix minor space issue\n\nfix minor space issue\n\nfix minor space issue", "committedDate": "2020-08-18T05:28:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyNTIwNA==", "url": "https://github.com/Alluxio/alluxio/pull/11984#discussion_r471925204", "bodyText": "the JavaOpts is applied to the job launch process here. are you saying there is another level of launching jobs within the job?", "author": "yuzhu", "createdAt": "2020-08-18T05:36:19Z", "path": "stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java", "diffHunk": "@@ -87,12 +87,15 @@ protected static void mainInternal(String[] args, Benchmark benchmark) {\n    * @return the JobConfig\n    * */\n   public PlanConfig generateJobConfig(String[] args) {\n-    // remove the cluster flag\n+    // remove the cluster flag and java opts\n     List<String> commandArgs =\n-            Arrays.stream(args).filter((s) -> !BaseParameters.CLUSTER_FLAG.equals(s))\n-                    .filter((s) -> !s.isEmpty()).collect(Collectors.toList());\n+            Arrays.stream(args).filter((s) -> !BaseParameters.JAVA_OPT_FLAG.equals(s)\n+                && !BaseParameters.CLUSTER_FLAG.equals(s)\n+                && !s.isEmpty()\n+                && !mBaseParameters.mJavaOpts.contains(s)).collect(Collectors.toList());\n \n-    commandArgs.addAll(mBaseParameters.mJavaOpts);", "originalCommit": "508c24614f46ccef945b476561917697aeaa4a08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM0NzYwNg==", "url": "https://github.com/Alluxio/alluxio/pull/11984#discussion_r472347606", "bodyText": "basically, all job tasks on the workers also spawn processes, to make it look exactly like it would have if it was run locally (not in cluster mode). https://github.com/Alluxio/alluxio/blob/master/job/server/src/main/java/alluxio/job/plan/stress/StressBenchDefinition.java#L114\nI just want to make sure if we set java opts for max mem, that it will affect local mode, as well as cluster mode, all in the same way.", "author": "gpang", "createdAt": "2020-08-18T17:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkyNTIwNA=="}], "type": "inlineReview", "revised_code": {"commit": "dad94cf936bfcc0fcb3baf602fa325598f2749f5", "chunk": "diff --git a/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java b/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\nindex eb18f15026..85a41581c5 100644\n--- a/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\n+++ b/stress/shell/src/main/java/alluxio/stress/cli/Benchmark.java\n\n@@ -88,11 +88,9 @@ public abstract class Benchmark<T extends TaskResult> {\n    * */\n   public PlanConfig generateJobConfig(String[] args) {\n     // remove the cluster flag and java opts\n-    List<String> commandArgs =\n-            Arrays.stream(args).filter((s) -> !BaseParameters.JAVA_OPT_FLAG.equals(s)\n-                && !BaseParameters.CLUSTER_FLAG.equals(s)\n-                && !s.isEmpty()\n-                && !mBaseParameters.mJavaOpts.contains(s)).collect(Collectors.toList());\n+    List<String> commandArgs = Arrays.stream(args).filter((s) ->\n+        !BaseParameters.CLUSTER_FLAG.equals(s) && !s.isEmpty())\n+        .collect(Collectors.toList());\n \n     commandArgs.addAll(mBaseParameters.mJavaOpts.stream().map(String::trim)\n         .collect(Collectors.toList()));\n"}}, {"oid": "dad94cf936bfcc0fcb3baf602fa325598f2749f5", "url": "https://github.com/Alluxio/alluxio/commit/dad94cf936bfcc0fcb3baf602fa325598f2749f5", "message": "make passing jvm option easier in command line\n\nfix trim location\n\nremove java opt and prevent it from recursively passed to jobworker\n\nremove trim\n\nfix checkstyle\n\nfix minor space issue\n\nfix minor space issue\n\nfix minor space issue\n\nretain javaopts", "committedDate": "2020-08-18T19:46:50Z", "type": "commit"}, {"oid": "dad94cf936bfcc0fcb3baf602fa325598f2749f5", "url": "https://github.com/Alluxio/alluxio/commit/dad94cf936bfcc0fcb3baf602fa325598f2749f5", "message": "make passing jvm option easier in command line\n\nfix trim location\n\nremove java opt and prevent it from recursively passed to jobworker\n\nremove trim\n\nfix checkstyle\n\nfix minor space issue\n\nfix minor space issue\n\nfix minor space issue\n\nretain javaopts", "committedDate": "2020-08-18T19:46:50Z", "type": "forcePushed"}]}