{"pr_number": 10733, "pr_title": "Implement client side cache evictor and metastore", "pr_createdAt": "2020-01-13T20:44:41Z", "pr_url": "https://github.com/Alluxio/alluxio/pull/10733", "timeline": [{"oid": "8b0107368ea937b7a22723b7d3e2a36e40271aeb", "url": "https://github.com/Alluxio/alluxio/commit/8b0107368ea937b7a22723b7d3e2a36e40271aeb", "message": "implement evictor and metastore", "committedDate": "2020-01-13T20:43:17Z", "type": "commit"}, {"oid": "6f19f6243b9b7aed92371319a59869f18fed71bd", "url": "https://github.com/Alluxio/alluxio/commit/6f19f6243b9b7aed92371319a59869f18fed71bd", "message": "clean up test", "committedDate": "2020-01-13T20:47:12Z", "type": "commit"}, {"oid": "39855f9093db2056fd991c8b7fc92c737db96d74", "url": "https://github.com/Alluxio/alluxio/commit/39855f9093db2056fd991c8b7fc92c737db96d74", "message": "Fix license header", "committedDate": "2020-01-13T20:58:20Z", "type": "commit"}, {"oid": "407ac69095500d9b76936b76dc4d768cea112cb4", "url": "https://github.com/Alluxio/alluxio/commit/407ac69095500d9b76936b76dc4d768cea112cb4", "message": "Merge remote-tracking branch 'upstream/lite' into lite-metastore", "committedDate": "2020-01-13T21:39:48Z", "type": "commit"}, {"oid": "2443241d44a45f9b835ca144654a8c45c9de67c2", "url": "https://github.com/Alluxio/alluxio/commit/2443241d44a45f9b835ca144654a8c45c9de67c2", "message": "resolve conflicts", "committedDate": "2020-01-13T21:48:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjY1Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366076657", "bodyText": "Is this implementation actually exactly the same as the HashSetMetaStore in the test? If so maybe we only need 1 of these?", "author": "calvinjia", "createdAt": "2020-01-13T23:06:19Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/DefaultMetaStore.java", "diffHunk": "@@ -13,43 +13,29 @@\n \n import alluxio.exception.PageNotFoundException;\n \n+import java.util.HashSet;\n+import java.util.Set;\n+\n /**\n  * The default implementation of a metadata store for pages stored in cache.\n  */\n public class DefaultMetaStore implements MetaStore {\n+  private final Set<PageId> mPageMap = new HashSet<>();", "originalCommit": "2443241d44a45f9b835ca144654a8c45c9de67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4MDY1MA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366080650", "bodyText": "looks like so. Then we should dedup and keep one impl DefaultMetaStore.", "author": "apc999", "createdAt": "2020-01-13T23:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NDY2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366084665", "bodyText": "We can reuse the DefaultMetaStore in tests for now, but it is likely we will have to reintroduce the test implementation as the DefaultMetaStore become more complex.", "author": "bf8086", "createdAt": "2020-01-13T23:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTMwMw==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366101303", "bodyText": "if that's the case we can keep them separate.", "author": "calvinjia", "createdAt": "2020-01-14T00:34:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjY1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NTQxOA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366085418", "bodyText": "is this class thread safe? If yes, please annotate it with @ThreadSafe; if not, currently LocalCacheManager does not provide any guard to protect concurrent access to this evictor from multiple threads.", "author": "apc999", "createdAt": "2020-01-13T23:35:09Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+/**\n+ * LRU client-side cache eviction policy.\n+ */\n+public class LRUCacheEvictor implements CacheEvictor {", "originalCommit": "2443241d44a45f9b835ca144654a8c45c9de67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNzM2NQ==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366107365", "bodyText": "It is. Updated with annotation.", "author": "bf8086", "createdAt": "2020-01-14T00:59:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NTQxOA=="}], "type": "inlineReview", "revised_code": {"commit": "5debdcf96c023f7529b13713523bffa9ff4d5794", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java b/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\nindex 8059987bdb..61f126bcaa 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\n\n@@ -15,9 +15,12 @@ import java.util.Collections;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import javax.annotation.concurrent.ThreadSafe;\n+\n /**\n  * LRU client-side cache eviction policy.\n  */\n+@ThreadSafe\n public class LRUCacheEvictor implements CacheEvictor {\n   private static final int LINKED_HASH_MAP_INIT_CAPACITY = 200;\n   private static final float LINKED_HASH_MAP_INIT_LOAD_FACTOR = 0.75f;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NjQ4Mw==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366086483", "bodyText": "I would suggest to add user-facing propertyKey like alluxio.user.client.cache.evictor and allow to select different evictors (thought currently we have only one). This will make it easier to switch cache replacement policy without recompiling the src code", "author": "apc999", "createdAt": "2020-01-13T23:38:42Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java", "diffHunk": "@@ -23,7 +23,7 @@\n    */\n   static CacheEvictor create() {\n     // return corresponding CacheEvictor impl\n-    return null;\n+    return new LRUCacheEvictor();", "originalCommit": "2443241d44a45f9b835ca144654a8c45c9de67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNzM5Ng==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366107396", "bodyText": "Added.", "author": "bf8086", "createdAt": "2020-01-14T00:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4NjQ4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5debdcf96c023f7529b13713523bffa9ff4d5794", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\nindex 1dc4b02dfe..c04e556a51 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\n\n@@ -19,11 +23,12 @@ import javax.annotation.Nullable;\n public interface CacheEvictor {\n \n   /**\n+   * @param conf the alluxio configuration\n    * @return a CacheEvictor instance\n    */\n-  static CacheEvictor create() {\n-    // return corresponding CacheEvictor impl\n-    return new LRUCacheEvictor();\n+  static CacheEvictor create(AlluxioConfiguration conf) {\n+    return CommonUtils.createNewClassInstance(\n+        conf.getClass(PropertyKey.USER_CLIENT_CACHE_EVICTOR_CLASS), new Class[0], new Object[0]);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MDY3NA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366090674", "bodyText": "Shall we cover the following cases:\n\nevict before any other operations (just make sure we don't see NPE)\nevict after all pages are put and then deleted", "author": "apc999", "createdAt": "2020-01-13T23:53:41Z", "path": "core/client/fs/src/test/java/alluxio/client/file/cache/LRUCacheEvictorTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests for the {@link LRUCacheEvictor} class.\n+ */\n+public final class LRUCacheEvictorTest {\n+  private LRUCacheEvictor mEvictor;\n+  private final PageId mFirst = new PageId(1L, 2L);\n+  private final PageId mSecond = new PageId(3L, 4L);\n+  private final PageId mThird = new PageId(5L, 6L);\n+\n+  /**\n+   * Sets up the instances.\n+   */\n+  @Before\n+  public void before() {\n+    mEvictor = new LRUCacheEvictor();\n+  }\n+\n+  @Test", "originalCommit": "2443241d44a45f9b835ca144654a8c45c9de67c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNzQyMw==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366107423", "bodyText": "Added.", "author": "bf8086", "createdAt": "2020-01-14T01:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MDY3NA=="}], "type": "inlineReview", "revised_code": {"commit": "5debdcf96c023f7529b13713523bffa9ff4d5794", "chunk": "diff --git a/core/client/fs/src/test/java/alluxio/client/file/cache/LRUCacheEvictorTest.java b/core/client/fs/src/test/java/alluxio/client/file/cache/LRUCacheEvictorTest.java\nindex cfb628b794..7844f32582 100644\n--- a/core/client/fs/src/test/java/alluxio/client/file/cache/LRUCacheEvictorTest.java\n+++ b/core/client/fs/src/test/java/alluxio/client/file/cache/LRUCacheEvictorTest.java\n\n@@ -86,4 +86,20 @@ public final class LRUCacheEvictorTest {\n     mEvictor.updateOnDelete(mFirst);\n     Assert.assertEquals(mThird, mEvictor.evict());\n   }\n+\n+  @Test\n+  public void evictEmpty() {\n+    Assert.assertNull(mEvictor.evict());\n+  }\n+\n+  @Test\n+  public void evictAllGone() {\n+    mEvictor.updateOnPut(mFirst);\n+    mEvictor.updateOnPut(mSecond);\n+    mEvictor.updateOnPut(mThird);\n+    mEvictor.updateOnDelete(mFirst);\n+    mEvictor.updateOnDelete(mSecond);\n+    mEvictor.updateOnDelete(mThird);\n+    Assert.assertNull(mEvictor.evict());\n+  }\n }\n"}}, {"oid": "5debdcf96c023f7529b13713523bffa9ff4d5794", "url": "https://github.com/Alluxio/alluxio/commit/5debdcf96c023f7529b13713523bffa9ff4d5794", "message": "address comments", "committedDate": "2020-01-14T00:59:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExNzc3OA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366117778", "bodyText": "I think you want null instead of empty arrays?", "author": "calvinjia", "createdAt": "2020-01-14T01:46:34Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java", "diffHunk": "@@ -19,11 +23,12 @@\n public interface CacheEvictor {\n \n   /**\n+   * @param conf the alluxio configuration\n    * @return a CacheEvictor instance\n    */\n-  static CacheEvictor create() {\n-    // return corresponding CacheEvictor impl\n-    return new LRUCacheEvictor();\n+  static CacheEvictor create(AlluxioConfiguration conf) {\n+    return CommonUtils.createNewClassInstance(\n+        conf.getClass(PropertyKey.USER_CLIENT_CACHE_EVICTOR_CLASS), new Class[0], new Object[0]);", "originalCommit": "5debdcf96c023f7529b13713523bffa9ff4d5794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1OTI3Nw==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366159277", "bodyText": "Updated.", "author": "bf8086", "createdAt": "2020-01-14T05:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjExNzc3OA=="}], "type": "inlineReview", "revised_code": {"commit": "3e6c88b6e69d60975e30b6f719bac90df7ba4249", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\nindex c04e556a51..a67b6eea5e 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/CacheEvictor.java\n\n@@ -28,7 +28,7 @@ public interface CacheEvictor {\n    */\n   static CacheEvictor create(AlluxioConfiguration conf) {\n     return CommonUtils.createNewClassInstance(\n-        conf.getClass(PropertyKey.USER_CLIENT_CACHE_EVICTOR_CLASS), new Class[0], new Object[0]);\n+        conf.getClass(PropertyKey.USER_CLIENT_CACHE_EVICTOR_CLASS), null, null);\n   }\n \n   /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE0NDMxNA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366144314", "bodyText": "can you mark this method and the interface def with @Nullable", "author": "apc999", "createdAt": "2020-01-14T04:05:29Z", "path": "core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * The Alluxio Open Foundation licenses this work under the Apache License, version 2.0\n+ * (the \"License\"). You may not use this work except in compliance with the License, which is\n+ * available at www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * This software is distributed on an \"AS IS\" basis, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,\n+ * either express or implied, as more fully set forth in the License.\n+ *\n+ * See the NOTICE file distributed with this work for information regarding copyright ownership.\n+ */\n+\n+package alluxio.client.file.cache;\n+\n+import java.util.Collections;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+import javax.annotation.concurrent.ThreadSafe;\n+\n+/**\n+ * LRU client-side cache eviction policy.\n+ */\n+@ThreadSafe\n+public class LRUCacheEvictor implements CacheEvictor {\n+  private static final int LINKED_HASH_MAP_INIT_CAPACITY = 200;\n+  private static final float LINKED_HASH_MAP_INIT_LOAD_FACTOR = 0.75f;\n+  private static final boolean LINKED_HASH_MAP_ACCESS_ORDERED = true;\n+  private static final boolean UNUSED_MAP_VALUE = true;\n+\n+  // TODO(feng): unify with worker side evictor\n+  protected final Map<PageId, Boolean> mLRUCache =\n+      Collections.synchronizedMap(new LinkedHashMap<>(LINKED_HASH_MAP_INIT_CAPACITY,\n+          LINKED_HASH_MAP_INIT_LOAD_FACTOR, LINKED_HASH_MAP_ACCESS_ORDERED));\n+\n+  @Override\n+  public void updateOnGet(PageId pageId) {\n+    mLRUCache.put(pageId, UNUSED_MAP_VALUE);\n+  }\n+\n+  @Override\n+  public void updateOnPut(PageId pageId) {\n+    mLRUCache.put(pageId, UNUSED_MAP_VALUE);\n+  }\n+\n+  @Override\n+  public void updateOnDelete(PageId pageId) {\n+    mLRUCache.remove(pageId, UNUSED_MAP_VALUE);\n+  }\n+\n+  @Override\n+  public PageId evict() {", "originalCommit": "5debdcf96c023f7529b13713523bffa9ff4d5794", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE1OTIzOA==", "url": "https://github.com/Alluxio/alluxio/pull/10733#discussion_r366159238", "bodyText": "Done.", "author": "bf8086", "createdAt": "2020-01-14T05:36:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE0NDMxNA=="}], "type": "inlineReview", "revised_code": {"commit": "3e6c88b6e69d60975e30b6f719bac90df7ba4249", "chunk": "diff --git a/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java b/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\nindex 61f126bcaa..2707aa04b9 100644\n--- a/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\n+++ b/core/client/fs/src/main/java/alluxio/client/file/cache/LRUCacheEvictor.java\n\n@@ -15,6 +15,7 @@ import java.util.Collections;\n import java.util.LinkedHashMap;\n import java.util.Map;\n \n+import javax.annotation.Nullable;\n import javax.annotation.concurrent.ThreadSafe;\n \n /**\n"}}, {"oid": "3e6c88b6e69d60975e30b6f719bac90df7ba4249", "url": "https://github.com/Alluxio/alluxio/commit/3e6c88b6e69d60975e30b6f719bac90df7ba4249", "message": "address comments", "committedDate": "2020-01-14T05:35:52Z", "type": "commit"}]}