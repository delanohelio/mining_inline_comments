{"pr_number": 8071, "pr_title": "JPA named query with Hibernate with Panache", "pr_createdAt": "2020-03-23T10:52:52Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8071", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2ODEwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398568101", "bodyText": "Given that we're testing for this before we check for isEmpty this can throw.", "author": "FroMage", "createdAt": "2020-03-26T13:24:26Z", "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -135,6 +142,10 @@ static String createFindQuery(Class<?> entityClass, String query, int paramCount\n         return \"FROM \" + getEntityName(entityClass) + \" WHERE \" + query;\n     }\n \n+    static boolean isNamedQuery(String query) {\n+        return query.charAt(0) == '#';", "originalCommit": "eda3c749fce3d2e78364f991ac96355d9cddca45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0NjEzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398646135", "bodyText": "Fixed", "author": "loicmathieu", "createdAt": "2020-03-26T15:06:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2ODEwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "051f3cfb9b3d140f4de1647817df0c63c9868f8a", "chunk": "diff --git a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\nindex 9c65536390..02a72e23a4 100644\n--- a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n+++ b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n\n@@ -143,6 +143,9 @@ public class JpaOperations {\n     }\n \n     static boolean isNamedQuery(String query) {\n+        if (query == null || query.isEmpty()) {\n+            return false;\n+        }\n         return query.charAt(0) == '#';\n     }\n \n"}}, {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "url": "https://github.com/quarkusio/quarkus/commit/4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "message": "feat: JPA named query\n\nFixes #3483", "committedDate": "2020-03-26T14:41:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398650062", "bodyText": "Well, it can also happen here. You could have fixed isNamedQuery instead ;)", "author": "FroMage", "createdAt": "2020-03-26T15:11:09Z", "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -249,7 +260,12 @@ public static Object findById(Class<?> entityClass, Object id, LockModeType lock\n         String findQuery = createFindQuery(entityClass, query, paramCount(params));\n         EntityManager em = getEntityManager();\n         // FIXME: check for duplicate ORDER BY clause?\n-        Query jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n+        Query jpaQuery;\n+        if (isNamedQuery(query)) {", "originalCommit": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MjQxNw==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398652417", "bodyText": "No, here this is the query computed by createFindQuery and it's never null (if null it will be from EntityClass.", "author": "loicmathieu", "createdAt": "2020-03-26T15:14:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODE2NA==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398658164", "bodyText": "it looks like the query created by createFindQuery is stored in findQuery and not in the query used, which is a parameter.", "author": "FroMage", "createdAt": "2020-03-26T15:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODU1OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398658559", "bodyText": "Nope, this comes straight from the user.", "author": "FroMage", "createdAt": "2020-03-26T15:21:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY3MjY3NA==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398672674", "bodyText": "Damned it! I need to clean my glasses ;)\nI will add a test with null and emtpy query so we didn't risk such bugs later", "author": "loicmathieu", "createdAt": "2020-03-26T15:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDQ1NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r399174455", "bodyText": "@FroMage fixed.\nI also add tests for empty and null query.", "author": "loicmathieu", "createdAt": "2020-03-27T10:39:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "58c364d9d9871834f0ee6feec96ad6f78dc2f558", "chunk": "diff --git a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\nindex ce466235da..0ce3a44309 100644\n--- a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n+++ b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n\n@@ -262,7 +265,9 @@ public class JpaOperations {\n         // FIXME: check for duplicate ORDER BY clause?\n         Query jpaQuery;\n         if (isNamedQuery(query)) {\n-            jpaQuery = em.createNamedQuery(query.substring(1));\n+            String namedQuery = query.substring(1);\n+            NamedQueryUtil.checkNamedQuery(entityClass, namedQuery);\n+            jpaQuery = em.createNamedQuery(namedQuery);\n         } else {\n             jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDQ3MA==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398650470", "bodyText": "And here.", "author": "FroMage", "createdAt": "2020-03-26T15:11:38Z", "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -263,7 +279,12 @@ public static Object findById(Class<?> entityClass, Object id, LockModeType lock\n         String findQuery = createFindQuery(entityClass, query, paramCount(params));\n         EntityManager em = getEntityManager();\n         // FIXME: check for duplicate ORDER BY clause?\n-        Query jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n+        Query jpaQuery;\n+        if (isNamedQuery(query)) {", "originalCommit": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MjUxMw==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398652513", "bodyText": "same", "author": "loicmathieu", "createdAt": "2020-03-26T15:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODk3NA==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398658974", "bodyText": "Same here, it comes straight from the user. Now, I'll admit it looks like we're missing a null check too\u2026", "author": "FroMage", "createdAt": "2020-03-26T15:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NDU1OA==", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r399174558", "bodyText": "same, fixed", "author": "loicmathieu", "createdAt": "2020-03-27T10:39:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDQ3MA=="}], "type": "inlineReview", "revised_code": {"commit": "58c364d9d9871834f0ee6feec96ad6f78dc2f558", "chunk": "diff --git a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\nindex ce466235da..0ce3a44309 100644\n--- a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n+++ b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java\n\n@@ -281,7 +286,9 @@ public class JpaOperations {\n         // FIXME: check for duplicate ORDER BY clause?\n         Query jpaQuery;\n         if (isNamedQuery(query)) {\n-            jpaQuery = em.createNamedQuery(query.substring(1));\n+            String namedQuery = query.substring(1);\n+            NamedQueryUtil.checkNamedQuery(entityClass, namedQuery);\n+            jpaQuery = em.createNamedQuery(namedQuery);\n         } else {\n             jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n         }\n"}}, {"oid": "051f3cfb9b3d140f4de1647817df0c63c9868f8a", "url": "https://github.com/quarkusio/quarkus/commit/051f3cfb9b3d140f4de1647817df0c63c9868f8a", "message": "feat: JPA named query\n\nFixes #3483", "committedDate": "2020-03-27T10:38:17Z", "type": "forcePushed"}, {"oid": "bbd2dda8f37c07ffd8ca07c8df992f5c66d8a8d8", "url": "https://github.com/quarkusio/quarkus/commit/bbd2dda8f37c07ffd8ca07c8df992f5c66d8a8d8", "message": "feat: JPA named query\n\nFixes #3483", "committedDate": "2020-04-01T09:02:11Z", "type": "commit"}, {"oid": "58c364d9d9871834f0ee6feec96ad6f78dc2f558", "url": "https://github.com/quarkusio/quarkus/commit/58c364d9d9871834f0ee6feec96ad6f78dc2f558", "message": "Scoping : check that the named query is defined on the JPA entity", "committedDate": "2020-04-01T09:05:21Z", "type": "forcePushed"}, {"oid": "59384e27e753be751e6e194cc63fc3ea1257a5e5", "url": "https://github.com/quarkusio/quarkus/commit/59384e27e753be751e6e194cc63fc3ea1257a5e5", "message": "Scoping : check that the named query is defined on the JPA entity", "committedDate": "2020-04-03T10:38:29Z", "type": "commit"}, {"oid": "59384e27e753be751e6e194cc63fc3ea1257a5e5", "url": "https://github.com/quarkusio/quarkus/commit/59384e27e753be751e6e194cc63fc3ea1257a5e5", "message": "Scoping : check that the named query is defined on the JPA entity", "committedDate": "2020-04-03T10:38:29Z", "type": "forcePushed"}]}