{"pr_number": 11300, "pr_title": "Properly support subfolders for Flyway database migrations", "pr_createdAt": "2020-08-10T12:19:21Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11300", "timeline": [{"oid": "ec47f0312e5c41196cb752b8359861a6cccfb7aa", "url": "https://github.com/quarkusio/quarkus/commit/ec47f0312e5c41196cb752b8359861a6cccfb7aa", "message": "Properly support subfolders for Flyway database migrations\n\nFix #11288", "committedDate": "2020-08-10T12:27:04Z", "type": "commit"}, {"oid": "c715ba3410e6d45efe55128115756f37d179642e", "url": "https://github.com/quarkusio/quarkus/commit/c715ba3410e6d45efe55128115756f37d179642e", "message": "Remove debug logging in Flyway test", "committedDate": "2020-08-10T12:27:04Z", "type": "commit"}, {"oid": "c715ba3410e6d45efe55128115756f37d179642e", "url": "https://github.com/quarkusio/quarkus/commit/c715ba3410e6d45efe55128115756f37d179642e", "message": "Remove debug logging in Flyway test", "committedDate": "2020-08-10T12:27:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw==", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481086637", "bodyText": "This does not work in a Jar !\nI get unable to optain inputstream for resource:\ndb/migration/oracle/../oracle/<migration_name>.sql\nwith quarkus/flyway.locations=db/migration/oracle", "author": "rmanibus", "createdAt": "2020-09-01T12:05:00Z", "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/FlywayProcessor.java", "diffHunk": "@@ -232,11 +226,33 @@ ServiceStartBuildItem createBeansAndStartActions(FlywayRecorder recorder,\n         }\n     }\n \n+    private String normalizeLocation(String location) {\n+        if (location == null) {\n+            throw new IllegalStateException(\"Flyway migration location may not be null.\");\n+        }\n+\n+        // Strip any 'classpath:' protocol prefixes because they are assumed\n+        // but not recognized by ClassLoader.getResources()\n+        if (location.startsWith(CLASSPATH_APPLICATION_MIGRATIONS_PROTOCOL + ':')) {\n+            location = location.substring(CLASSPATH_APPLICATION_MIGRATIONS_PROTOCOL.length() + 1);\n+            if (location.startsWith(\"/\")) {\n+                location = location.substring(1);\n+            }\n+        }\n+        if (!location.endsWith(\"/\")) {\n+            location += \"/\";\n+        }\n+\n+        return location;\n+    }\n+\n     private Set<String> getApplicationMigrationsFromPath(final String location, final URL path)\n             throws IOException, URISyntaxException {\n-        try (final Stream<Path> pathStream = Files.walk(Paths.get(path.toURI()))) {\n+        Path rootPath = Paths.get(path.toURI());\n+\n+        try (final Stream<Path> pathStream = Files.walk(rootPath)) {\n             return pathStream.filter(Files::isRegularFile)\n-                    .map(it -> Paths.get(location, it.getFileName().toString()).toString())\n+                    .map(it -> Paths.get(location, rootPath.relativize(it).toString()).toString())", "originalCommit": "c715ba3410e6d45efe55128115756f37d179642e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NzcxMw==", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481087713", "bodyText": "I will try to make a reproducer yes", "author": "rmanibus", "createdAt": "2020-09-01T12:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4Nzk3MA==", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481087970", "bodyText": "Thanks", "author": "geoand", "createdAt": "2020-09-01T12:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA5OTM2OA==", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481099368", "bodyText": "Please open a separate issue with a reproducer so that we can easily track it.\nThanks!", "author": "gsmet", "createdAt": "2020-09-01T12:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NDAyNw==", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481144027", "bodyText": "Please see #11780", "author": "rmanibus", "createdAt": "2020-09-01T13:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw=="}], "type": "inlineReview", "revised_code": null}]}