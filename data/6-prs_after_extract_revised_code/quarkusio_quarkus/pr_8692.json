{"pr_number": 8692, "pr_title": "Config root beans - throw CreationException if a root is not initialized", "pr_createdAt": "2020-04-20T10:07:33Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8692", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411261241", "bodyText": "Perhaps we should simplify the message to just say that config roots can only be accessed at runtime init? Mentioning bootstrap here is kind of confusing since there is also the bootstrap config phase.", "author": "geoand", "createdAt": "2020-04-20T10:16:54Z", "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "originalCommit": "7e5ce8bba5c654640f605d9d5611f4d495d4f057", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5MDMwNA==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411290304", "bodyText": "Perhaps we should simplify the message to just say that config roots can only be accessed at runtime init\n\nWell, BUILD_AND_RUN_TIME_FIXED roots can be safely used in STATIC_INIT.\n\nMentioning bootstrap here is kind of confusing since there is also the bootstrap config phase.\n\nHm, so it's bootstrap phase VS bootstrap config phase. I'm not sure about the correct wording.", "author": "mkouba", "createdAt": "2020-04-20T11:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMDE1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411300151", "bodyText": "Yeah it's tricky. Maybe let's just go with what you added and see if people get confused", "author": "geoand", "createdAt": "2020-04-20T11:24:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM3OTY4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411379687", "bodyText": "I'll remove the next sentence...", "author": "mkouba", "createdAt": "2020-04-20T13:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4Nzg5Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411387896", "bodyText": "Done.", "author": "mkouba", "createdAt": "2020-04-20T13:43:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzMjU4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411432580", "bodyText": "\ud83d\udc4d", "author": "geoand", "createdAt": "2020-04-20T14:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "9a0ce74485263326c9f4463ec308dba495c654f3", "chunk": "diff --git a/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java b/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java\nindex 9e26a2c3cf..6d90e69e4b 100644\n--- a/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java\n+++ b/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java\n\n@@ -158,9 +158,10 @@ public class ConfigBuildStep {\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n                                     ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    // BUILD_AND_RUN_TIME_FIXED roots are always set before the container is started (in the static initializer of the generated Config class)\n+                                    // However, RUN_TIME roots may be not be set when the bean instance is created \n                                     mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n-                                            String.format(\n-                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",\n+                                            String.format(\"Config root [%s] with config phase [%s] not initialized yet.\",\n                                                     configRootClass.getName(), rootDefinition.getConfigPhase().name()));\n                                     mc.returnValue(configRoot);\n                                 }).done();\n"}}, {"oid": "9a0ce74485263326c9f4463ec308dba495c654f3", "url": "https://github.com/quarkusio/quarkus/commit/9a0ce74485263326c9f4463ec308dba495c654f3", "message": "Config root beans - throw CreationException if a root is not initialized", "committedDate": "2020-04-20T13:38:12Z", "type": "commit"}, {"oid": "9a0ce74485263326c9f4463ec308dba495c654f3", "url": "https://github.com/quarkusio/quarkus/commit/9a0ce74485263326c9f4463ec308dba495c654f3", "message": "Config root beans - throw CreationException if a root is not initialized", "committedDate": "2020-04-20T13:38:12Z", "type": "forcePushed"}]}