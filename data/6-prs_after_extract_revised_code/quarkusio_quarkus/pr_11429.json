{"pr_number": 11429, "pr_title": "Hibernate Validator: don't skip interface annotation lookup if impl method has annotations", "pr_createdAt": "2020-08-17T21:26:31Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11429", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Njc2OA==", "url": "https://github.com/quarkusio/quarkus/pull/11429#discussion_r471786768", "bodyText": "So we could discuss this 400 vs. 500 problem in this PR (as suggested here: #11341 (comment)) or we could do it separately (Zulip?).\nThe main challenge I see is that MethodValidatedAnnotationsTransformer is only aware of a single transformation target at a time but to check potentially present interfaces for JAX-RS annotations, the transformer needs MethodInfo/ClassInfo for those interfaces.\nI guess the constructor of MethodValidatedAnnotationsTransformer has to be extended with more context...", "author": "famod", "createdAt": "2020-08-17T21:32:07Z", "path": "integration-tests/hibernate-validator/src/test/java/io/quarkus/it/hibernate/validator/HibernateValidatorFunctionalityTest.java", "diffHunk": "@@ -69,6 +69,36 @@ public void testRestEndPointValidation() {\n                 .body(is(\"42\"));\n     }\n \n+    @Test\n+    public void testRestEndPointInterfaceValidation() {\n+        RestAssured.when()\n+                .get(\"/hibernate-validator/test/rest-end-point-interface-validation/plop/\")\n+                .then()\n+                // 500 until this is fixed: https://github.com/quarkusio/quarkus/issues/11341#issuecomment-673146350", "originalCommit": "f21487b355148fcd727a78f71760150c82ac2749", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzODA0OA==", "url": "https://github.com/quarkusio/quarkus/pull/11429#discussion_r472138048", "bodyText": "I think you could do something like method.declaringClass().interfaceTypes() and call .annotations() on the items of the list.", "author": "gsmet", "createdAt": "2020-08-18T12:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Njc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE0MzgwNg==", "url": "https://github.com/quarkusio/quarkus/pull/11429#discussion_r472143806", "bodyText": "The issue with it is that you basically only have a view of all the annotations of the type, they are not split by method.\nI think you could make calls to the bean archive index by getting it through the BeanArchiveIndexBuildItem. But I'm not entirely sure it's safe to use it in the AnnotationsTransformer. @mkouba WDYT?", "author": "gsmet", "createdAt": "2020-08-18T12:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Njc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMyNjA5MA==", "url": "https://github.com/quarkusio/quarkus/pull/11429#discussion_r474326090", "bodyText": "Let's continue in #11506.", "author": "famod", "createdAt": "2020-08-20T23:29:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Njc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTI5NDY1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/11429#discussion_r479294651", "bodyText": "So in theory, you should be able to do TransformationContext#get(io.quarkus.arc.processor.BuildExtension.Key.INDEX) inside the AnnotationsTransformer.transform() method... or even TransformationContext#get(io.quarkus.arc.processor.BuildExtension.Key.ANNOTATION_STORE) but this could be tricky (I can smell stack overflow ;-).", "author": "mkouba", "createdAt": "2020-08-28T13:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc4Njc2OA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5b606c2a5bf994fdc29dafecadfc2929214bf256", "url": "https://github.com/quarkusio/quarkus/commit/5b606c2a5bf994fdc29dafecadfc2929214bf256", "message": "Validation: don't skip iface annotation lookup if impl method has annotation(s)\n\nFixes #11341", "committedDate": "2020-08-18T12:10:11Z", "type": "commit"}]}