{"pr_number": 9570, "pr_title": "Support Charset in Quarkus Config - Use it in Hibernate", "pr_createdAt": "2020-05-25T10:01:21Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9570", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2OTczMw==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429869733", "bodyText": "Hello @geoand, perhaps this should just be defaulted to UTF-8 to remove the inconsistency of system level defaults? AFAIK, Java (in recent versions) too has started defaulting to UTF-8 for some of its IO APIs to avoid this system level inconsistencies.", "author": "jaikiran", "createdAt": "2020-05-25T10:49:56Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java", "diffHunk": "@@ -75,6 +76,13 @@\n     @ConfigItem(defaultValueDocumentation = \"import.sql in DEV, TEST ; no-file otherwise\")\n     public Optional<String> sqlLoadScript;\n \n+    /**\n+     * The name of the charset used by the schema generation resource. Without specifying this configuration property, the JVM\n+     * default charset is used.\n+     */\n+    @ConfigItem(defaultValueDocumentation = \"JVM default charset\")\n+    public Optional<Charset> ddlCharset;", "originalCommit": "b610601ffe00a656c9258b8d02da60792b6feda8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg3MTUzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429871535", "bodyText": "I think that's reasonable, but I didn't because I wanted to keep it consistent with the other charset property.\nIf  @Sanne and @gsmet also think it should be UTF-8, I'll gladly update it.", "author": "geoand", "createdAt": "2020-05-25T10:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2OTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkxOTkyNA==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429919924", "bodyText": "My inclination would be to go with UTF-8 by default too.\nI don't like the name though because it's not the DDL charset, it's the charset used for schema generation and the import scripts (or database initialization in general).", "author": "gsmet", "createdAt": "2020-05-25T12:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2OTczMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyOTkwNg==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429929906", "bodyText": "Removed this completely", "author": "geoand", "createdAt": "2020-05-25T13:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTg2OTczMw=="}], "type": "inlineReview", "revised_code": {"commit": "a957a10b11405da56e0f0afd51df20af43cb01fb", "chunk": "diff --git a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\nindex 60e2e7bc01..167c224608 100644\n--- a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n+++ b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n\n@@ -76,13 +76,6 @@ public class HibernateOrmConfig {\n     @ConfigItem(defaultValueDocumentation = \"import.sql in DEV, TEST ; no-file otherwise\")\n     public Optional<String> sqlLoadScript;\n \n-    /**\n-     * The name of the charset used by the schema generation resource. Without specifying this configuration property, the JVM\n-     * default charset is used.\n-     */\n-    @ConfigItem(defaultValueDocumentation = \"JVM default charset\")\n-    public Optional<Charset> ddlCharset;\n-\n     /**\n      * The size of the batches used when loading entities and collections.\n      *\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkxNTA4MA==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429915080", "bodyText": "Maybe add a Unable to create Charset from: \" + value message? (JVM messages can be very obscure sometimes, not sure about that one)", "author": "gsmet", "createdAt": "2020-05-25T12:43:17Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/configuration/CharsetConverter.java", "diffHunk": "@@ -0,0 +1,28 @@\n+package io.quarkus.runtime.configuration;\n+\n+import static io.quarkus.runtime.configuration.ConverterSupport.DEFAULT_QUARKUS_CONVERTER_PRIORITY;\n+\n+import java.io.Serializable;\n+import java.nio.charset.Charset;\n+\n+import javax.annotation.Priority;\n+\n+import org.eclipse.microprofile.config.spi.Converter;\n+\n+/**\n+ * A converter which converts a Charset string into an instance of {@link java.nio.charset.Charset}.\n+ */\n+@Priority(DEFAULT_QUARKUS_CONVERTER_PRIORITY)\n+public class CharsetConverter implements Converter<Charset>, Serializable {\n+\n+    private static final long serialVersionUID = 2320905063828247874L;\n+\n+    @Override\n+    public Charset convert(String value) {\n+        try {\n+            return Charset.forName(value);\n+        } catch (Exception e) {\n+            throw new IllegalArgumentException(e);", "originalCommit": "b610601ffe00a656c9258b8d02da60792b6feda8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0NTExNA==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r430245114", "bodyText": "@geoand did you miss that one? Or is it intended you didn't fix it?", "author": "gsmet", "createdAt": "2020-05-26T08:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkxNTA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0ODE5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r430248192", "bodyText": "Ah, I missed it! Will fix now", "author": "geoand", "createdAt": "2020-05-26T08:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkxNTA4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI1MDA4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r430250082", "bodyText": "Fixed", "author": "geoand", "createdAt": "2020-05-26T08:41:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkxNTA4MA=="}], "type": "inlineReview", "revised_code": {"commit": "f594dd68f89f73a3e47f58d4a5860f25f5e8213e", "chunk": "diff --git a/core/runtime/src/main/java/io/quarkus/runtime/configuration/CharsetConverter.java b/core/runtime/src/main/java/io/quarkus/runtime/configuration/CharsetConverter.java\nindex 16c769777b..07c9dee914 100644\n--- a/core/runtime/src/main/java/io/quarkus/runtime/configuration/CharsetConverter.java\n+++ b/core/runtime/src/main/java/io/quarkus/runtime/configuration/CharsetConverter.java\n\n@@ -22,7 +22,7 @@ public class CharsetConverter implements Converter<Charset>, Serializable {\n         try {\n             return Charset.forName(value);\n         } catch (Exception e) {\n-            throw new IllegalArgumentException(e);\n+            throw new IllegalArgumentException(\"Unable to create Charset from \" + value + \"'\", e);\n         }\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMDM0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429920346", "bodyText": "So isn't it already implemented then? :]\n(have a look at the name of the property)", "author": "gsmet", "createdAt": "2020-05-25T12:55:55Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -785,7 +785,7 @@ private void handleHibernateORMWithNoPersistenceXml(\n                 }\n \n                 hibernateConfig.database.charset.ifPresent(\n-                        charset -> desc.getProperties().setProperty(AvailableSettings.HBM2DDL_CHARSET_NAME, charset));\n+                        charset -> desc.getProperties().setProperty(AvailableSettings.HBM2DDL_CHARSET_NAME, charset.name()));", "originalCommit": "b610601ffe00a656c9258b8d02da60792b6feda8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMzMwMw==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429923303", "bodyText": "Oh man... I didn't even see that this was the same property... F**k", "author": "geoand", "createdAt": "2020-05-25T13:02:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMDM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMDAyNg==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429930026", "bodyText": "Yeah...", "author": "geoand", "createdAt": "2020-05-25T13:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyMDM0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e958ebada3a43597ba6ff5c073705d7946cb1daf", "chunk": "diff --git a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java\nindex 5cfab47fbb..50eb46eca5 100644\n--- a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java\n+++ b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java\n\n@@ -784,8 +784,9 @@ public final class HibernateOrmProcessor {\n                     desc.getProperties().setProperty(AvailableSettings.HBM2DDL_HALT_ON_ERROR, \"true\");\n                 }\n \n-                hibernateConfig.database.charset.ifPresent(\n-                        charset -> desc.getProperties().setProperty(AvailableSettings.HBM2DDL_CHARSET_NAME, charset.name()));\n+                //charset\n+                desc.getProperties().setProperty(AvailableSettings.HBM2DDL_CHARSET_NAME,\n+                        hibernateConfig.database.charset.name());\n \n                 hibernateConfig.database.defaultCatalog.ifPresent(\n                         catalog -> desc.getProperties().setProperty(AvailableSettings.DEFAULT_CATALOG, catalog));\n"}}, {"oid": "a957a10b11405da56e0f0afd51df20af43cb01fb", "url": "https://github.com/quarkusio/quarkus/commit/a957a10b11405da56e0f0afd51df20af43cb01fb", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-25T13:13:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMTA1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429931056", "bodyText": "So let's not make it an Optional anymore.", "author": "gsmet", "createdAt": "2020-05-25T13:20:03Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java", "diffHunk": "@@ -250,8 +253,8 @@ public boolean isAnyPropertySet() {\n         /**\n          * The charset of the database.\n          */\n-        @ConfigItem\n-        public Optional<String> charset;\n+        @ConfigItem(defaultValue = \"UTF-8\")\n+        public Optional<Charset> charset;", "originalCommit": "a957a10b11405da56e0f0afd51df20af43cb01fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMzAzMA==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429933030", "bodyText": "Good point, done", "author": "geoand", "createdAt": "2020-05-25T13:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMTA1Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e958ebada3a43597ba6ff5c073705d7946cb1daf", "chunk": "diff --git a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\nindex 167c224608..010502801b 100644\n--- a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n+++ b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n\n@@ -254,7 +254,7 @@ public class HibernateOrmConfig {\n          * The charset of the database.\n          */\n         @ConfigItem(defaultValue = \"UTF-8\")\n-        public Optional<Charset> charset;\n+        public Charset charset;\n \n         /**\n          * Whether Hibernate should quote all identifiers.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMTU4NA==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429931584", "bodyText": "Maybe add to the doc:\n<p>\nUsed for DDL generation and also for the SQL import scripts.", "author": "gsmet", "createdAt": "2020-05-25T13:21:10Z", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java", "diffHunk": "@@ -250,8 +253,8 @@ public boolean isAnyPropertySet() {\n         /**\n          * The charset of the database.", "originalCommit": "a957a10b11405da56e0f0afd51df20af43cb01fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMzM3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/9570#discussion_r429933376", "bodyText": "Done", "author": "geoand", "createdAt": "2020-05-25T13:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkzMTU4NA=="}], "type": "inlineReview", "revised_code": {"commit": "e958ebada3a43597ba6ff5c073705d7946cb1daf", "chunk": "diff --git a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\nindex 167c224608..010502801b 100644\n--- a/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n+++ b/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfig.java\n\n@@ -254,7 +254,7 @@ public class HibernateOrmConfig {\n          * The charset of the database.\n          */\n         @ConfigItem(defaultValue = \"UTF-8\")\n-        public Optional<Charset> charset;\n+        public Charset charset;\n \n         /**\n          * Whether Hibernate should quote all identifiers.\n"}}, {"oid": "e958ebada3a43597ba6ff5c073705d7946cb1daf", "url": "https://github.com/quarkusio/quarkus/commit/e958ebada3a43597ba6ff5c073705d7946cb1daf", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-25T13:22:10Z", "type": "forcePushed"}, {"oid": "a97554572747a8eb5ae289f6b96144be8a3726cc", "url": "https://github.com/quarkusio/quarkus/commit/a97554572747a8eb5ae289f6b96144be8a3726cc", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-25T13:24:53Z", "type": "forcePushed"}, {"oid": "53def9ffdec28566edf95bdc6ab2a2fe0fa9dc96", "url": "https://github.com/quarkusio/quarkus/commit/53def9ffdec28566edf95bdc6ab2a2fe0fa9dc96", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-26T07:18:49Z", "type": "forcePushed"}, {"oid": "f594dd68f89f73a3e47f58d4a5860f25f5e8213e", "url": "https://github.com/quarkusio/quarkus/commit/f594dd68f89f73a3e47f58d4a5860f25f5e8213e", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-26T08:41:33Z", "type": "forcePushed"}, {"oid": "7e8875a8da3194ef90bdb769429f99863811bb1a", "url": "https://github.com/quarkusio/quarkus/commit/7e8875a8da3194ef90bdb769429f99863811bb1a", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-26T08:42:15Z", "type": "forcePushed"}, {"oid": "ceba39c03b300d779c35413c65528b87fca90253", "url": "https://github.com/quarkusio/quarkus/commit/ceba39c03b300d779c35413c65528b87fca90253", "message": "Add support for Charset in Quarkus Config system", "committedDate": "2020-05-26T08:42:49Z", "type": "commit"}, {"oid": "94256b9c08f7b25d4d80f4b10147877382e3c498", "url": "https://github.com/quarkusio/quarkus/commit/94256b9c08f7b25d4d80f4b10147877382e3c498", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-26T08:42:49Z", "type": "commit"}, {"oid": "94256b9c08f7b25d4d80f4b10147877382e3c498", "url": "https://github.com/quarkusio/quarkus/commit/94256b9c08f7b25d4d80f4b10147877382e3c498", "message": "Use Charset in HibernateOrmConfig and default to UTF-8", "committedDate": "2020-05-26T08:42:49Z", "type": "forcePushed"}]}