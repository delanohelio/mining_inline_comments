{"pr_number": 9071, "pr_title": "Don't throw an error if container is stopped", "pr_createdAt": "2020-05-05T03:17:37Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9071", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg0Mjk0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9071#discussion_r419842941", "bodyText": "Most changes are from removing lambdas, the real change is removing the exception and just making it a noop.", "author": "stuartwdouglas", "createdAt": "2020-05-05T03:18:55Z", "path": "extensions/arc/runtime/src/main/java/io/quarkus/arc/runtime/context/ArcContextProvider.java", "diffHunk": "@@ -28,46 +28,62 @@ public ThreadContextSnapshot currentContext(Map<String, String> map) {\n \n         // capture the state, null indicates no active context while capturing snapshot\n         InjectableContext.ContextState state = isContextActiveOnThisThread(arc) ? arc.requestContext().getState() : null;\n-        return () -> {\n-            // can be called later on, we should retrieve the container again\n-            ArcContainer arcContainer = Arc.container();\n-            if (arcContainer == null || !arcContainer.isRunning()) {\n-                throw new IllegalStateException(\"Arc context propagation was attempted but the container is not running.\");", "originalCommit": "026ccf4ffcb4822e93758d370be74d724dd0be3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1NjE5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9071#discussion_r419956192", "bodyText": "Sounds good for shutdown, but what if this happens in other scenarios? Shouldn't we at least log something?", "author": "manovotn", "createdAt": "2020-05-05T08:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg0Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1NzU3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9071#discussion_r419957572", "bodyText": "I don't think it matters, if the container is gone there is no request context anymore.", "author": "stuartwdouglas", "createdAt": "2020-05-05T08:52:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg0Mjk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk1ODUyMA==", "url": "https://github.com/quarkusio/quarkus/pull/9071#discussion_r419958520", "bodyText": "Actually. never mind. Checking on history, this check was added specifically because of shutdown scenario.", "author": "manovotn", "createdAt": "2020-05-05T08:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg0Mjk0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1ec126f30cbd37e14a9c60c26d4176d8cc37e0ee", "chunk": "diff --git a/extensions/arc/runtime/src/main/java/io/quarkus/arc/runtime/context/ArcContextProvider.java b/extensions/arc/runtime/src/main/java/io/quarkus/arc/runtime/context/ArcContextProvider.java\nindex 3b91d2d4a7..a51d4e847f 100644\n--- a/extensions/arc/runtime/src/main/java/io/quarkus/arc/runtime/context/ArcContextProvider.java\n+++ b/extensions/arc/runtime/src/main/java/io/quarkus/arc/runtime/context/ArcContextProvider.java\n\n@@ -36,12 +43,7 @@ public class ArcContextProvider implements ThreadContextProvider {\n                 if (arcContainer == null || !arcContainer.isRunning()) {\n                     //this happens on shutdown, if we blow up here it can break shutdown, and stop\n                     //resources from being cleaned up, causing tests to fail\n-                    return new ThreadContextController() {\n-                        @Override\n-                        public void endContext() throws IllegalStateException {\n-\n-                        }\n-                    };\n+                    return NOOP_CONTROLLER;\n                 }\n                 ThreadContextController controller;\n                 ManagedContext requestContext = arcContainer.requestContext();\n"}}, {"oid": "1ec126f30cbd37e14a9c60c26d4176d8cc37e0ee", "url": "https://github.com/quarkusio/quarkus/commit/1ec126f30cbd37e14a9c60c26d4176d8cc37e0ee", "message": "Don't throw an error if container is stopped\n\nThis can happen on shutdown, and can prevent\nrective messaging shutting down correctly,\ncausing tests to fail.", "committedDate": "2020-05-06T04:28:42Z", "type": "forcePushed"}, {"oid": "4d7ebf59432c9f22c1f6f35f9957c6bda8bb6132", "url": "https://github.com/quarkusio/quarkus/commit/4d7ebf59432c9f22c1f6f35f9957c6bda8bb6132", "message": "Don't throw an error if container is stopped\n\nThis can happen on shutdown, and can prevent\nrective messaging shutting down correctly,\ncausing tests to fail.", "committedDate": "2020-05-07T02:51:53Z", "type": "commit"}, {"oid": "4d7ebf59432c9f22c1f6f35f9957c6bda8bb6132", "url": "https://github.com/quarkusio/quarkus/commit/4d7ebf59432c9f22c1f6f35f9957c6bda8bb6132", "message": "Don't throw an error if container is stopped\n\nThis can happen on shutdown, and can prevent\nrective messaging shutting down correctly,\ncausing tests to fail.", "committedDate": "2020-05-07T02:51:53Z", "type": "forcePushed"}]}