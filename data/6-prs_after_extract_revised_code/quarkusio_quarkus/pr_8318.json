{"pr_number": 8318, "pr_title": "Don't remove classes from the resettable elements", "pr_createdAt": "2020-04-01T03:21:23Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8318", "timeline": [{"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3", "url": "https://github.com/quarkusio/quarkus/commit/c1416efff529a20c98a3f7dca5fd9042998ca5b3", "message": "Don't remove classes from the resettable elements\n\nFixes #8301", "committedDate": "2020-04-01T03:20:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401432005", "bodyText": "So if I understand it correctly when we generate a fwk class that is not marked as an application class it's loaded by the \"Base Runtime ClassLoader\" which is persistent but always reset during restart (because the generated classes may differ). But even if gizmo generates a different name for a function the new generated fwk class should reference this new name, or? I mean the generated class cannot not survive the hot reload, can it?", "author": "mkouba", "createdAt": "2020-04-01T08:12:03Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/MemoryClassPathElement.java", "diffHunk": "@@ -22,7 +23,21 @@ public MemoryClassPathElement(Map<String, byte[]> resources) {\n     }\n \n     public void reset(Map<String, byte[]> resources) {\n-        this.resources = resources;\n+        Map<String, byte[]> newResources = new HashMap<>(resources);\n+        //we can't delete .class files from the loader\n+        //gizmo may not generate the same function names on restart\n+        //so if we delete them already loaded classes may have problems, as functions they reference", "originalCommit": "c1416efff529a20c98a3f7dca5fd9042998ca5b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ1NjY1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401456654", "bodyText": "gizmo is not generating stable function names, so if you generate a new class that is exactly the same the function names will be different. If the outer class has been loaded but not the function then the original function would get deleted by the reset code.", "author": "stuartwdouglas", "createdAt": "2020-04-01T08:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ1NzA0NA==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401457044", "bodyText": "Really gizmo should generate stable function names, but this is safer regardless.", "author": "stuartwdouglas", "createdAt": "2020-04-01T08:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3MDg2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401470861", "bodyText": "If the outer class has been loaded but not the function...\n\nI see. BTW what happens if the outer class is loaded but should be discarded because the newly generated class differs? I'm asking because the base runtime CL is said to be persistent...", "author": "mkouba", "createdAt": "2020-04-01T09:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3MjY4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401472680", "bodyText": "Then we are doing something wrong. Base runtime classes should be effectivly immutable, e.g. a client proxy for a bean in the base runtime CL will never change, as the class it is based on will never change. It might be added though as the bean may have been removed, but the user might add something to change that. The reset mechanism is really supposed to be about adding new classes.", "author": "stuartwdouglas", "createdAt": "2020-04-01T09:20:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3NDIzNw==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401474237", "bodyText": "Now I finally understand ;-). Thanks! In our case (#8301), the generated value resolver should be identical.", "author": "mkouba", "createdAt": "2020-04-01T09:22:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MjA2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401482066", "bodyText": "I wonder if we should make the io.quarkus.gizmo.BytecodeCreatorImpl.FUNCTION field public and use it here?", "author": "mkouba", "createdAt": "2020-04-01T09:34:52Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/MemoryClassPathElement.java", "diffHunk": "@@ -22,7 +23,21 @@ public MemoryClassPathElement(Map<String, byte[]> resources) {\n     }\n \n     public void reset(Map<String, byte[]> resources) {\n-        this.resources = resources;\n+        Map<String, byte[]> newResources = new HashMap<>(resources);\n+        //we can't delete .class files from the loader\n+        //gizmo may not generate the same function names on restart\n+        //so if we delete them already loaded classes may have problems, as functions they reference\n+        //may have been removed\n+        //see https://github.com/quarkusio/quarkus/issues/8301\n+        for (Map.Entry<String, byte[]> e : this.resources.entrySet()) {\n+            if (newResources.containsKey(e.getKey())) {\n+                continue;\n+            }\n+            if (e.getKey().endsWith(\".class\")) {", "originalCommit": "c1416efff529a20c98a3f7dca5fd9042998ca5b3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}