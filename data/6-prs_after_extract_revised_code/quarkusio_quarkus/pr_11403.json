{"pr_number": 11403, "pr_title": "Hibernate-Envers: Support store_data_at_delete", "pr_createdAt": "2020-08-15T18:02:02Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11403", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNTQ5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r474625499", "bodyText": "It's a better pattern to inject the config in the @BuildStep method. This way, we keep track of the dependencies.\n(our code is not consistent so you might have found occurrences of this pattern)", "author": "gsmet", "createdAt": "2020-08-21T10:55:40Z", "path": "extensions/hibernate-envers/deployment/src/main/java/io/quarkus/hibernate/envers/deployment/QuarkusHibernateEnversProcessor.java", "diffHunk": "@@ -3,11 +3,17 @@\n import io.quarkus.deployment.Feature;\n import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.annotations.ExecutionTime;\n+import io.quarkus.deployment.annotations.Record;\n import io.quarkus.deployment.builditem.FeatureBuildItem;\n import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.hibernate.envers.HibernateEnversBuildTimeConfig;\n+import io.quarkus.hibernate.envers.HibernateEnversRecorder;\n \n public final class QuarkusHibernateEnversProcessor {\n \n+    HibernateEnversBuildTimeConfig buildTimeConfig;", "originalCommit": "9297d48b958ca7dccf2d80ccd8803d2b300481f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIwNTk5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r475205999", "bodyText": "Good to know, fixed.", "author": "j-be", "createdAt": "2020-08-23T11:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNTQ5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "64980d2f66d297f52a921eb82e69c687587e04a5", "chunk": "diff --git a/extensions/hibernate-envers/deployment/src/main/java/io/quarkus/hibernate/envers/deployment/QuarkusHibernateEnversProcessor.java b/extensions/hibernate-envers/deployment/src/main/java/io/quarkus/hibernate/envers/deployment/QuarkusHibernateEnversProcessor.java\nindex 65d1cfd284..6b69b7928c 100644\n--- a/extensions/hibernate-envers/deployment/src/main/java/io/quarkus/hibernate/envers/deployment/QuarkusHibernateEnversProcessor.java\n+++ b/extensions/hibernate-envers/deployment/src/main/java/io/quarkus/hibernate/envers/deployment/QuarkusHibernateEnversProcessor.java\n\n@@ -12,8 +12,6 @@ import io.quarkus.hibernate.envers.HibernateEnversRecorder;\n \n public final class QuarkusHibernateEnversProcessor {\n \n-    HibernateEnversBuildTimeConfig buildTimeConfig;\n-\n     @BuildStep\n     FeatureBuildItem feature() {\n         return new FeatureBuildItem(Feature.HIBERNATE_ENVERS);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjI4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r474626289", "bodyText": "I would make it BUILD_AND_RUN_TIME_FIXED as you access it in the recorder thus at runtime.", "author": "gsmet", "createdAt": "2020-08-21T10:57:40Z", "path": "extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversBuildTimeConfig.java", "diffHunk": "@@ -0,0 +1,13 @@\n+package io.quarkus.hibernate.envers;\n+\n+import io.quarkus.runtime.annotations.ConfigItem;\n+import io.quarkus.runtime.annotations.ConfigRoot;\n+\n+@ConfigRoot", "originalCommit": "9297d48b958ca7dccf2d80ccd8803d2b300481f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIwNjc0NA==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r475206744", "bodyText": "Done. Is there some documentation on which Phase to use for which values?\nMy thinking was: the config here is only needed to drive the recorder, which in turn applies the (equivalent, though different) configuration to Hibernate. In such case, I thought, the config value itself is not needed on Runtime.\nBut I did not yet fully grasp what runs when and what does what. From decompiling the release jar I saw hunks of what seemed to me to be generated code, but I wasn't yet able to track it back to what happens on build time.", "author": "j-be", "createdAt": "2020-08-23T11:17:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNTI5MA==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r478335290", "bodyText": "If you extracted the config in the build step and just passed a boolean then it would be only used at build time. But that's not what you do. The recorder code is executed at runtime.", "author": "gsmet", "createdAt": "2020-08-27T11:06:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjI4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "64980d2f66d297f52a921eb82e69c687587e04a5", "chunk": "diff --git a/extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversBuildTimeConfig.java b/extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversBuildTimeConfig.java\nindex 3ec2f97783..da15823cfd 100644\n--- a/extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversBuildTimeConfig.java\n+++ b/extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversBuildTimeConfig.java\n\n@@ -1,9 +1,10 @@\n package io.quarkus.hibernate.envers;\n \n import io.quarkus.runtime.annotations.ConfigItem;\n+import io.quarkus.runtime.annotations.ConfigPhase;\n import io.quarkus.runtime.annotations.ConfigRoot;\n \n-@ConfigRoot\n+@ConfigRoot(phase = ConfigPhase.BUILD_AND_RUN_TIME_FIXED)\n public class HibernateEnversBuildTimeConfig {\n     /**\n      * Enable store_data_at_delete feature.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjY4NA==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r474626684", "bodyText": "If you make it runtime fixed, I think you should be able to just inject the config in the @Recorder class.\nWhich would avoid passing the config object through the recording mechanism.", "author": "gsmet", "createdAt": "2020-08-21T10:58:41Z", "path": "extensions/hibernate-envers/runtime/src/main/java/io/quarkus/hibernate/envers/HibernateEnversRecorder.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.hibernate.envers;\n+\n+import java.util.function.BiConsumer;\n+\n+import org.hibernate.boot.Metadata;\n+import org.hibernate.boot.spi.BootstrapContext;\n+import org.hibernate.envers.configuration.EnversSettings;\n+\n+import io.quarkus.hibernate.orm.runtime.integration.HibernateOrmIntegrationListener;\n+import io.quarkus.hibernate.orm.runtime.integration.HibernateOrmIntegrations;\n+import io.quarkus.runtime.annotations.Recorder;\n+\n+@Recorder\n+public class HibernateEnversRecorder {\n+\n+    public void registerHibernateEnversIntegration(HibernateEnversBuildTimeConfig buildTimeConfig) {", "originalCommit": "9297d48b958ca7dccf2d80ccd8803d2b300481f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIwNzE5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r475207199", "bodyText": "It seems like I can't, or I simply don't know how. I tried injecting both HibernateEnversBuildTimeConfig and RuntimeValue<HibernateEnversBuildTimeConfig>, both with and without @Inject without success (NullPointerExcepiton on first access).", "author": "j-be", "createdAt": "2020-08-23T11:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjY4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNTQ4NA==", "url": "https://github.com/quarkusio/quarkus/pull/11403#discussion_r478335484", "bodyText": "Weird. Let's not block this PR for that.", "author": "gsmet", "createdAt": "2020-08-27T11:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNjY4NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "64980d2f66d297f52a921eb82e69c687587e04a5", "url": "https://github.com/quarkusio/quarkus/commit/64980d2f66d297f52a921eb82e69c687587e04a5", "message": "[Envers] Implement support for store_data_at_delete.\n\nSigned-off-by: Juri Berlanda <juriberlanda@hotmail.com>", "committedDate": "2020-08-27T11:03:59Z", "type": "commit"}, {"oid": "64980d2f66d297f52a921eb82e69c687587e04a5", "url": "https://github.com/quarkusio/quarkus/commit/64980d2f66d297f52a921eb82e69c687587e04a5", "message": "[Envers] Implement support for store_data_at_delete.\n\nSigned-off-by: Juri Berlanda <juriberlanda@hotmail.com>", "committedDate": "2020-08-27T11:03:59Z", "type": "forcePushed"}]}