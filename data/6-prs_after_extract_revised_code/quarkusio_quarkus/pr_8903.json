{"pr_number": 8903, "pr_title": "Avoid creating Uni objects where possible", "pr_createdAt": "2020-04-28T07:32:52Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8903", "timeline": [{"oid": "00fb931e0f976d8f7f453b493c71966a2dbaa391", "url": "https://github.com/quarkusio/quarkus/commit/00fb931e0f976d8f7f453b493c71966a2dbaa391", "message": "Avoid creating Uni objects where possible", "committedDate": "2020-04-28T07:56:58Z", "type": "forcePushed"}, {"oid": "6f18fb1d7d0f1b8f1c984f0932add75879cb6d65", "url": "https://github.com/quarkusio/quarkus/commit/6f18fb1d7d0f1b8f1c984f0932add75879cb6d65", "message": "Avoid creating Uni objects where possible", "committedDate": "2020-04-28T08:18:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NjQzNA==", "url": "https://github.com/quarkusio/quarkus/pull/8903#discussion_r416456434", "bodyText": "Not sure this works, because you may need to capture the fact that there's no context, to make sure that when you run the action you remove any existing context.", "author": "FroMage", "createdAt": "2020-04-28T09:11:23Z", "path": "extensions/resteasy-common/runtime/src/main/java/io/quarkus/resteasy/common/runtime/ResteasyContextProvider.java", "diffHunk": "@@ -13,7 +14,10 @@\n \n     @Override\n     public ThreadContextSnapshot currentContext(Map<String, String> props) {\n-        Map<Class<?>, Object> context = ResteasyContext.getContextDataMap();\n+        Map<Class<?>, Object> context = ResteasyContext.getContextDataMap(false);\n+        if (context == null) {\n+            return null;\n+        }", "originalCommit": "cf693b7a802df8a72528d73c347453a20312312f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwNDUzMA==", "url": "https://github.com/quarkusio/quarkus/pull/8903#discussion_r416504530", "bodyText": "Does that actually matter? There won't be a context unless you are inside a RESTEasy request, or unless you have saved it.", "author": "stuartwdouglas", "createdAt": "2020-04-28T10:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NjQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE1NjczMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8903#discussion_r417156731", "bodyText": "Well, you don't know where a Uni is coming from. If it came from a place outside of a request context, it will have no RESTEasy context. If you then complete it from within a context, it will inherit the RESTEasy context by accident, where it should not.", "author": "FroMage", "createdAt": "2020-04-29T08:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NjQzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzczNzA4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8903#discussion_r417737087", "bodyText": "I still don't think this is a real issue. If there is a RESTEasy request is progress then CP will have captured the context, so it should be propagated everywhere and there is no change of behaviour. The only way this will be missing is if a request is started with no request is progress, and then ends up in a RESTEasy request, such as with lazy authentication. This could mean that RESTEasy requests effectively loose their context once they start dealing with the SecurityIdentity, which does not seem ideal IMHO.", "author": "stuartwdouglas", "createdAt": "2020-04-30T03:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ1NjQzNA=="}], "type": "inlineReview", "revised_code": {"commit": "d2462b874d98399b8cbc93b03a2df3ce6589362f", "chunk": "diff --git a/extensions/resteasy-common/runtime/src/main/java/io/quarkus/resteasy/common/runtime/ResteasyContextProvider.java b/extensions/resteasy-common/runtime/src/main/java/io/quarkus/resteasy/common/runtime/ResteasyContextProvider.java\nindex 4ee07b87fe..161d323fd1 100644\n--- a/extensions/resteasy-common/runtime/src/main/java/io/quarkus/resteasy/common/runtime/ResteasyContextProvider.java\n+++ b/extensions/resteasy-common/runtime/src/main/java/io/quarkus/resteasy/common/runtime/ResteasyContextProvider.java\n\n@@ -14,10 +13,7 @@ public class ResteasyContextProvider implements ThreadContextProvider {\n \n     @Override\n     public ThreadContextSnapshot currentContext(Map<String, String> props) {\n-        Map<Class<?>, Object> context = ResteasyContext.getContextDataMap(false);\n-        if (context == null) {\n-            return null;\n-        }\n+        Map<Class<?>, Object> context = ResteasyContext.getContextDataMap();\n         return () -> {\n             ResteasyContext.pushContextDataMap(context);\n             return () -> {\n"}}, {"oid": "f3051db95d1e8ae1206d52d98adb96778e001cb5", "url": "https://github.com/quarkusio/quarkus/commit/f3051db95d1e8ae1206d52d98adb96778e001cb5", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-04-28T21:31:51Z", "type": "forcePushed"}, {"oid": "fadd932d6a76cf7983c2971b7c5ea03cd8316bd4", "url": "https://github.com/quarkusio/quarkus/commit/fadd932d6a76cf7983c2971b7c5ea03cd8316bd4", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-06T03:42:25Z", "type": "forcePushed"}, {"oid": "5d8118a1dcbf03d53badceb7377c39a325d080b5", "url": "https://github.com/quarkusio/quarkus/commit/5d8118a1dcbf03d53badceb7377c39a325d080b5", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-06T04:29:56Z", "type": "forcePushed"}, {"oid": "bfba5f188356fb3a92c24dce3d73e4b1653d9c0a", "url": "https://github.com/quarkusio/quarkus/commit/bfba5f188356fb3a92c24dce3d73e4b1653d9c0a", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-07T02:55:09Z", "type": "forcePushed"}, {"oid": "8f2d15abfb90891c5562e24690f63fe169ec63dc", "url": "https://github.com/quarkusio/quarkus/commit/8f2d15abfb90891c5562e24690f63fe169ec63dc", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-07T05:56:06Z", "type": "forcePushed"}, {"oid": "d2462b874d98399b8cbc93b03a2df3ce6589362f", "url": "https://github.com/quarkusio/quarkus/commit/d2462b874d98399b8cbc93b03a2df3ce6589362f", "message": "Avoid creating Uni objects where possible", "committedDate": "2020-05-11T04:41:59Z", "type": "commit"}, {"oid": "6d02f461adca6fdeedd351c71be3d0faa84a0557", "url": "https://github.com/quarkusio/quarkus/commit/6d02f461adca6fdeedd351c71be3d0faa84a0557", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-11T06:10:53Z", "type": "commit"}, {"oid": "6d02f461adca6fdeedd351c71be3d0faa84a0557", "url": "https://github.com/quarkusio/quarkus/commit/6d02f461adca6fdeedd351c71be3d0faa84a0557", "message": "Don't create a RESTEasy context if it is not already active", "committedDate": "2020-05-11T06:10:53Z", "type": "forcePushed"}]}