{"pr_number": 10333, "pr_title": "Fix broken sidecar handling", "pr_createdAt": "2020-06-29T11:07:14Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10333", "timeline": [{"oid": "f23d210cb551039a3c72e52a4c4befe397159bd8", "url": "https://github.com/quarkusio/quarkus/commit/f23d210cb551039a3c72e52a4c4befe397159bd8", "message": "Fix broken sidecar handling\n\nFixes: #10308", "committedDate": "2020-06-29T11:13:06Z", "type": "forcePushed"}, {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "url": "https://github.com/quarkusio/quarkus/commit/6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "message": "Fix broken sidecar handling\n\nFixes: #10308", "committedDate": "2020-06-29T11:23:34Z", "type": "commit"}, {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "url": "https://github.com/quarkusio/quarkus/commit/6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "message": "Fix broken sidecar handling\n\nFixes: #10308", "committedDate": "2020-06-29T11:23:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MDc2NA==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446970764", "bodyText": "The class seems identical to the upstream version. Can you please point out the difference?", "author": "iocanel", "createdAt": "2020-06-29T13:27:57Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddSidecarDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ObjectMeta;\n+import io.dekorate.deps.kubernetes.api.model.PodSpecBuilder;\n+import io.dekorate.kubernetes.config.Container;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.NamedResourceDecorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+class AddSidecarDecorator extends NamedResourceDecorator<PodSpecBuilder> {", "originalCommit": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MTg3NA==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446981874", "bodyText": "It uses our custom ContainerAdapter, that's the only change", "author": "geoand", "createdAt": "2020-06-29T13:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MDc2NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDIwMA==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446974200", "bodyText": "It's not obvious to me what's wrong with the upstream version.\nAlso, keep in mind that this implementation will result in the port being applied to all containers of all deployments (including init containers, sidecars or any other kind of container generated, or found under /src/main/kubernetes).", "author": "iocanel", "createdAt": "2020-06-29T13:32:53Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddContainerPortDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.annotation.Protocol;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddSidecarDecorator;\n+import io.dekorate.kubernetes.decorator.ContainerDecorator;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Adapted from Dekorate's {@link io.dekorate.kubernetes.decorator.AddPortDecorator} in order to\n+ * address the limitation that the port was not being added (due to missing metadata)\n+ */\n+class AddContainerPortDecorator extends Decorator<ContainerBuilder> {", "originalCommit": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MjkxNw==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446982917", "bodyText": "The upstream version doesn't apply the port because the object contains no metadata.\nI am pretty certain that this decorator doesn't apply to all containers and if I am not mistaken, my test verifies that", "author": "geoand", "createdAt": "2020-06-29T13:45:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDIwMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDk3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446974973", "bodyText": "Ok, I now see why you needed to copy the sidecar decorator...", "author": "iocanel", "createdAt": "2020-06-29T13:34:06Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/ContainerAdapter.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.Container;\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.config.Env;\n+import io.dekorate.kubernetes.config.Mount;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddEnvVarDecorator;\n+import io.dekorate.kubernetes.decorator.AddLivenessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.AddMountDecorator;\n+import io.dekorate.kubernetes.decorator.AddReadinessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.ApplyImagePullPolicyDecorator;\n+import io.dekorate.utils.Images;\n+import io.dekorate.utils.Strings;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+public class ContainerAdapter {", "originalCommit": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NjYxMg==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446976612", "bodyText": "We will have to apply that upstream as well", "author": "iocanel", "createdAt": "2020-06-29T13:36:34Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/ContainerAdapter.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.Container;\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.config.Env;\n+import io.dekorate.kubernetes.config.Mount;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddEnvVarDecorator;\n+import io.dekorate.kubernetes.decorator.AddLivenessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.AddMountDecorator;\n+import io.dekorate.kubernetes.decorator.AddReadinessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.ApplyImagePullPolicyDecorator;\n+import io.dekorate.utils.Images;\n+import io.dekorate.utils.Strings;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+public class ContainerAdapter {\n+\n+    public static Container adapt(io.dekorate.kubernetes.config.Container container) {\n+        String name = container.getName();\n+        if (Strings.isNullOrEmpty(name)) {\n+            name = Images.getName(container.getImage());\n+        }\n+\n+        ContainerBuilder builder = new ContainerBuilder()\n+                .withName(name)\n+                .withImage(container.getImage())\n+                // this was changed to add working dir", "originalCommit": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4MzUwNg==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446983506", "bodyText": "Yes of course. I just wanted to get these changes in Quarkus so we can include the fixes in 1.6 which is right around the corner.", "author": "geoand", "createdAt": "2020-06-29T13:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NjYxMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3Nzk3OQ==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446977979", "bodyText": "What happens if the container you add has a port named after the port you are trying to add?", "author": "iocanel", "createdAt": "2020-06-29T13:38:34Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddContainerPortDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.annotation.Protocol;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddSidecarDecorator;\n+import io.dekorate.kubernetes.decorator.ContainerDecorator;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Adapted from Dekorate's {@link io.dekorate.kubernetes.decorator.AddPortDecorator} in order to\n+ * address the limitation that the port was not being added (due to missing metadata)\n+ */\n+class AddContainerPortDecorator extends Decorator<ContainerBuilder> {\n+\n+    private final Port port;\n+\n+    AddContainerPortDecorator(Port port) {\n+        this.port = port;\n+    }\n+\n+    @Override\n+    public void visit(ContainerBuilder containerBuilder) {\n+        containerBuilder.addNewPort()", "originalCommit": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NDE2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446984163", "bodyText": "That probably won't go down well, but I think it's rather unlikely to happen, no?", "author": "geoand", "createdAt": "2020-06-29T13:46:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3Nzk3OQ=="}], "type": "inlineReview", "revised_code": null}]}