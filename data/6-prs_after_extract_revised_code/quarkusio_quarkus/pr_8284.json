{"pr_number": 8284, "pr_title": "Allow AppArtifact to have more than one path", "pr_createdAt": "2020-03-30T22:17:57Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8284", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400529854", "bodyText": "@stuartwdouglas please check this one. I am adding the root application artifact here. I think it's ok because all the deps are added here besides the root artifact. Full deployment deps above already contain the \"user deps\".", "author": "aloubyansky", "createdAt": "2020-03-30T22:22:03Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java", "diffHunk": "@@ -164,30 +161,23 @@ public synchronized QuarkusClassLoader getAugmentClassLoader() {\n             //we want a class loader that can load the deployment artifacts and all their dependencies, but not\n             //any of the runtime artifacts, or user classes\n             //this will load any deployment artifacts from the parent CL if they are present\n-            Set<AppArtifact> deploymentArtifacts = new HashSet<>();\n             for (AppDependency i : appModel.getFullDeploymentDeps()) {\n-                AppArtifactKey key = getKey(i);\n-                deploymentArtifacts.add(i.getArtifact());\n-                ClassPathElement element = getElement(i.getArtifact());\n-                builder.addElement(element);\n-                if (appModel.getParentFirstArtifacts().contains(key)) {\n-                    //we always load this from the parent if it is available, as this acts as a bridge between the running\n-                    //app and the dev mode code\n-                    builder.addParentFirstElement(element);\n-                }\n-            }\n-            for (AppDependency userDep : appModel.getUserDependencies()) {\n-                if (!deploymentArtifacts.contains(userDep.getArtifact())) {\n-                    AppArtifactKey key = getKey(userDep);\n-                    ClassPathElement element = getElement(userDep.getArtifact());\n-                    if (appModel.getParentFirstArtifacts().contains(key)) {\n-                        //this mostly happens when building quarkus itself\n+                processCpElement(i.getArtifact(), element -> {\n+                    builder.addElement(element);\n+                    if (appModel.getParentFirstArtifacts().contains(getKey(i))) {\n+                        //we always load this from the parent if it is available, as this acts as a bridge between the running\n+                        //app and the dev mode code\n                         builder.addParentFirstElement(element);\n                     }\n-                    builder.addElement(element);\n-                }\n+                });\n             }\n \n+            appModel.getAppArtifact().getPaths().forEach(p -> {\n+                if (Files.exists(p)) {\n+                    builder.addElement(ClassPathElement.fromPath(p));\n+                }\n+            });", "originalCommit": "15fd623d459fd46b76481225d62d5f6938091c44", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1NDY3MA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400654670", "bodyText": "This does not look right, this should be in the deployment CL instead.\nIn dev mode this CL is persistent, so if you include parts of the application then any changes will not be visible.", "author": "stuartwdouglas", "createdAt": "2020-03-31T05:38:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMTc4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400711786", "bodyText": "What about the local projects that appear as \"user deps\" and among the full deployment dependencies?", "author": "aloubyansky", "createdAt": "2020-03-31T07:54:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxMjcwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400712701", "bodyText": "BTW, there would be test failures if I added it in the deployment CL.", "author": "aloubyansky", "createdAt": "2020-03-31T07:56:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMyNjMxNw==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r401326317", "bodyText": "Local projects that are extension dependencies and this not hot reloadable are fine, but we can't have anything hot reloadable here.", "author": "stuartwdouglas", "createdAt": "2020-04-01T02:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM2Mjc4NA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r401362784", "bodyText": "Isn't it happening here https://github.com/quarkusio/quarkus/blob/master/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java#L172 ? Full deployment deps include all the user configured runtime deps including the local hot reloadable projects, afaiu.", "author": "aloubyansky", "createdAt": "2020-04-01T05:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjAxMTg5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r402011897", "bodyText": "Hmm, looks like this is an existing problem.\nIn practice it should be fine as the relevant classes should always be loaded from the runtime/deployment class loader.", "author": "stuartwdouglas", "createdAt": "2020-04-02T02:07:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUyOTg1NA=="}], "type": "inlineReview", "revised_code": {"commit": "d93b04af0b4fd5b24488bbd2156a81e2a81746a2", "chunk": "diff --git a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java\nindex 244ff30355..ac61068bff 100644\n--- a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java\n+++ b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/app/CuratedApplication.java\n\n@@ -164,10 +164,13 @@ public class CuratedApplication implements Serializable, Closeable {\n             for (AppDependency i : appModel.getFullDeploymentDeps()) {\n                 processCpElement(i.getArtifact(), element -> {\n                     builder.addElement(element);\n-                    if (appModel.getParentFirstArtifacts().contains(getKey(i))) {\n+                    final AppArtifactKey key = getKey(i);\n+                    if (appModel.getParentFirstArtifacts().contains(key)) {\n                         //we always load this from the parent if it is available, as this acts as a bridge between the running\n                         //app and the dev mode code\n                         builder.addParentFirstElement(element);\n+                    } else if (appModel.getLesserPriorityArtifacts().contains(key)) {\n+                        builder.addLesserPriorityElement(element);\n                     }\n                 });\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MTk5OA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400651998", "bodyText": "This needs to be thread safe.\nNormally we don't want mutable build items but for this use case this makes sense, as we only want these to be produced as side effects.", "author": "stuartwdouglas", "createdAt": "2020-03-31T05:28:38Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.deployment.builditem;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class QuarkusBuildCloseablesBuildItem extends SimpleBuildItem implements Closeable {\n+\n+    private static final Logger log = Logger.getLogger(QuarkusBuildCloseablesBuildItem.class);\n+\n+    private final List<Closeable> closeables = new ArrayList<>();", "originalCommit": "15fd623d459fd46b76481225d62d5f6938091c44", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f6d34a28fcb4d7d9214eae78e124c5411c30959", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java b/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\nindex 164dc512cf..bba713e7e9 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\n\n@@ -1,8 +1,8 @@\n package io.quarkus.deployment.builditem;\n \n import java.io.Closeable;\n-import java.io.IOException;\n import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n \n import org.jboss.logging.Logger;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1MjE4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400652182", "bodyText": "This should probably catch Throwable, just to make sure everything gets closed.", "author": "stuartwdouglas", "createdAt": "2020-03-31T05:29:12Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.deployment.builditem;\n+\n+import java.io.Closeable;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class QuarkusBuildCloseablesBuildItem extends SimpleBuildItem implements Closeable {\n+\n+    private static final Logger log = Logger.getLogger(QuarkusBuildCloseablesBuildItem.class);\n+\n+    private final List<Closeable> closeables = new ArrayList<>();\n+\n+    public <T extends Closeable> T add(T closeable) {\n+        closeables.add(closeable);\n+        return closeable;\n+    }\n+\n+    @Override\n+    public void close() {\n+        for (Closeable c : closeables) {\n+            try {\n+                c.close();\n+            } catch (IOException e) {", "originalCommit": "15fd623d459fd46b76481225d62d5f6938091c44", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f6d34a28fcb4d7d9214eae78e124c5411c30959", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java b/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\nindex 164dc512cf..bba713e7e9 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/builditem/QuarkusBuildCloseablesBuildItem.java\n\n@@ -1,8 +1,8 @@\n package io.quarkus.deployment.builditem;\n \n import java.io.Closeable;\n-import java.io.IOException;\n import java.util.ArrayList;\n+import java.util.Collections;\n import java.util.List;\n \n import org.jboss.logging.Logger;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1NTUzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400655535", "bodyText": "Do we actually want this? If we forget to update it we could have weird errors when upgrading.", "author": "stuartwdouglas", "createdAt": "2020-03-31T05:41:10Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/AppArtifact.java", "diffHunk": "@@ -12,7 +10,9 @@\n  */\n public class AppArtifact extends AppArtifactCoords implements Serializable {\n \n-    protected transient Path path;\n+    private static final long serialVersionUID = 1L;", "originalCommit": "15fd623d459fd46b76481225d62d5f6938091c44", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f6d34a28fcb4d7d9214eae78e124c5411c30959", "chunk": "diff --git a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/AppArtifact.java b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/AppArtifact.java\nindex 4bea055ad8..54065a7b2b 100644\n--- a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/AppArtifact.java\n+++ b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/AppArtifact.java\n\n@@ -10,8 +10,6 @@ import java.nio.file.Path;\n  */\n public class AppArtifact extends AppArtifactCoords implements Serializable {\n \n-    private static final long serialVersionUID = 1L;\n-\n     protected PathsCollection paths;\n \n     public AppArtifact(String groupId, String artifactId, String version) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1NTkwOA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400655908", "bodyText": "See my comments above.", "author": "stuartwdouglas", "createdAt": "2020-03-31T05:42:24Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/PathsCollection.java", "diffHunk": "@@ -0,0 +1,140 @@\n+package io.quarkus.bootstrap.model;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+\n+public class PathsCollection implements Iterable<Path>, Serializable {\n+\n+    private static final long serialVersionUID = 1L;", "originalCommit": "15fd623d459fd46b76481225d62d5f6938091c44", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6f6d34a28fcb4d7d9214eae78e124c5411c30959", "chunk": "diff --git a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/PathsCollection.java b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/PathsCollection.java\nindex 874586208a..74c63f0ce4 100644\n--- a/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/PathsCollection.java\n+++ b/independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/model/PathsCollection.java\n\n@@ -13,8 +13,6 @@ import java.util.List;\n \n public class PathsCollection implements Iterable<Path>, Serializable {\n \n-    private static final long serialVersionUID = 1L;\n-\n     public static PathsCollection from(Iterable<Path> paths) {\n         final List<Path> list = new ArrayList<>();\n         paths.forEach(list::add);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3MDY4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r400670686", "bodyText": "This is pretty ugly. I'm still waiting for the CI to see if it fixes it.", "author": "aloubyansky", "createdAt": "2020-03-31T06:27:36Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/JarResultBuildStep.java", "diffHunk": "@@ -234,17 +228,35 @@ private JarBuildItem buildUberJar(CurateOutcomeBuildItem curateOutcomeBuildItem,\n \n         runnerJar.toFile().setReadable(true, false);\n \n+        //for uberjars we move the original jar, so there is only a single jar in the output directory\n+        final Path standardJar = outputTargetBuildItem.getOutputDirectory()\n+                .resolve(outputTargetBuildItem.getBaseName() + \".jar\");\n+        final Path originalJar;\n+        if (standardJar.toFile().exists()) {\n+            originalJar = outputTargetBuildItem.getOutputDirectory()\n+                    .resolve(outputTargetBuildItem.getBaseName() + \".jar.original\");\n+        } else {\n+            originalJar = null;\n+        }\n+\n+        // this hack is necessary to wait for the original JAR to get closed\n+        closeablesBuildItem.add(new Closeable() {\n+            @Override\n+            public void close() throws IOException {\n+                if (standardJar.toFile().exists()) {\n+                    Files.deleteIfExists(originalJar);\n+                    Files.move(standardJar, originalJar);\n+                }\n+            }\n+        });", "originalCommit": "2f1a2c95a8450801bf916552862772e819a9b4d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "640b8366835e2ca790ac52e1daebd838a2447daf", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/JarResultBuildStep.java b/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/JarResultBuildStep.java\nindex c9f745bc3b..d81df501ba 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/JarResultBuildStep.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/JarResultBuildStep.java\n\n@@ -235,21 +235,20 @@ public class JarResultBuildStep {\n         if (standardJar.toFile().exists()) {\n             originalJar = outputTargetBuildItem.getOutputDirectory()\n                     .resolve(outputTargetBuildItem.getBaseName() + \".jar.original\");\n+            // this hack is necessary to wait for the original JAR to get closed\n+            closeablesBuildItem.add(new Closeable() {\n+                @Override\n+                public void close() throws IOException {\n+                    if (originalJar != null && standardJar.toFile().exists()) {\n+                        Files.deleteIfExists(originalJar);\n+                        Files.move(standardJar, originalJar);\n+                    }\n+                }\n+            });\n         } else {\n             originalJar = null;\n         }\n \n-        // this hack is necessary to wait for the original JAR to get closed\n-        closeablesBuildItem.add(new Closeable() {\n-            @Override\n-            public void close() throws IOException {\n-                if (standardJar.toFile().exists()) {\n-                    Files.deleteIfExists(originalJar);\n-                    Files.move(standardJar, originalJar);\n-                }\n-            }\n-        });\n-\n         return new JarBuildItem(runnerJar, originalJar, null);\n     }\n \n"}}, {"oid": "6f6d34a28fcb4d7d9214eae78e124c5411c30959", "url": "https://github.com/quarkusio/quarkus/commit/6f6d34a28fcb4d7d9214eae78e124c5411c30959", "message": "When building an uber jar, rename the original jar in a Closeable to wait for the original jar to get closed", "committedDate": "2020-03-31T08:16:06Z", "type": "forcePushed"}, {"oid": "640b8366835e2ca790ac52e1daebd838a2447daf", "url": "https://github.com/quarkusio/quarkus/commit/640b8366835e2ca790ac52e1daebd838a2447daf", "message": "When building an uber jar, rename the original jar in a Closeable to wait for the original jar to get closed", "committedDate": "2020-03-31T08:44:37Z", "type": "forcePushed"}, {"oid": "d20784b8213938a80ef79687bf6fbe4f4fc24bc5", "url": "https://github.com/quarkusio/quarkus/commit/d20784b8213938a80ef79687bf6fbe4f4fc24bc5", "message": "Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.", "committedDate": "2020-03-31T11:07:55Z", "type": "forcePushed"}, {"oid": "a9db93430045660098f9e5402b2889dc57e840cc", "url": "https://github.com/quarkusio/quarkus/commit/a9db93430045660098f9e5402b2889dc57e840cc", "message": "Move the JARs around when the Quarkus classloaders are closed to avoid locking issues on Windows", "committedDate": "2020-04-02T11:25:18Z", "type": "forcePushed"}, {"oid": "58c3d2dec4f68ac4dc1cc9ce78aabd1255cb6cdb", "url": "https://github.com/quarkusio/quarkus/commit/58c3d2dec4f68ac4dc1cc9ce78aabd1255cb6cdb", "message": "Move the JARs around when the Quarkus classloaders are closed to avoid locking issues on Windows", "committedDate": "2020-04-02T13:03:59Z", "type": "forcePushed"}, {"oid": "449439b872ef37797a32d51080f95f82d7a08115", "url": "https://github.com/quarkusio/quarkus/commit/449439b872ef37797a32d51080f95f82d7a08115", "message": "Move the JARs around when the Quarkus classloaders are closed to avoid locking issues on Windows", "committedDate": "2020-04-02T15:04:25Z", "type": "forcePushed"}, {"oid": "81fcc2812420ef10f6f188253664f1e082b66b41", "url": "https://github.com/quarkusio/quarkus/commit/81fcc2812420ef10f6f188253664f1e082b66b41", "message": "Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\nMove the JARs around when the Quarkus classloaders are closed to avoid locking issues on Windows", "committedDate": "2020-04-08T16:47:14Z", "type": "forcePushed"}, {"oid": "d93b04af0b4fd5b24488bbd2156a81e2a81746a2", "url": "https://github.com/quarkusio/quarkus/commit/d93b04af0b4fd5b24488bbd2156a81e2a81746a2", "message": "Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\nMove the JARs around when the Quarkus classloaders are closed to avoid locking issues on Windows", "committedDate": "2020-04-09T09:21:50Z", "type": "forcePushed"}, {"oid": "b0acb8e4d0e67b92cd99523268dd586ec4ebc07e", "url": "https://github.com/quarkusio/quarkus/commit/b0acb8e4d0e67b92cd99523268dd586ec4ebc07e", "message": "more", "committedDate": "2020-03-28T20:53:25Z", "type": "forcePushed"}, {"oid": "487220ba2a7ac0f4dd9adbbdb2943acd456aefac", "url": "https://github.com/quarkusio/quarkus/commit/487220ba2a7ac0f4dd9adbbdb2943acd456aefac", "message": "Workaround for URL.openConnection() for JARs", "committedDate": "2020-04-13T23:22:14Z", "type": "forcePushed"}, {"oid": "2b882d0dc52aabde8b909cba46ecf6339714748b", "url": "https://github.com/quarkusio/quarkus/commit/2b882d0dc52aabde8b909cba46ecf6339714748b", "message": "workaround to URL.openConnection() for JARs", "committedDate": "2020-04-14T15:41:50Z", "type": "forcePushed"}, {"oid": "3e272b9c60f20dc59e9eabed2c7f6373401cb0e0", "url": "https://github.com/quarkusio/quarkus/commit/3e272b9c60f20dc59e9eabed2c7f6373401cb0e0", "message": "workaround to URL.openConnection() for JARs", "committedDate": "2020-04-14T16:03:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMTc1NA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408411754", "bodyText": "What's the benefit of having PathsCollection over List<Path> ?", "author": "gastaldi", "createdAt": "2020-04-14T20:22:46Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/ApplicationArchive.java", "diffHunk": "@@ -26,33 +29,72 @@\n      * jar, but rather a path to the root of the mounted {@link com.sun.nio.zipfs.ZipFileSystem}\n      *\n      * @return The archive root.\n+     * @deprecated in favor of {@link #getRootDirs()}\n      */\n+    @Deprecated\n     Path getArchiveRoot();\n \n     /**\n      *\n      * @return <code>true</code> if this archive is a jar\n+     * @deprecated does not appear to be used anywhere and now it shouldn't be\n      */\n+    @Deprecated\n     boolean isJarArchive();\n \n     /**\n      * If this archive is a jar file it will return the path to the jar file on the file system,\n      * otherwise it will return the directory that this corresponds to.\n+     *\n+     * @deprecated in favor of {@link #getPaths()}\n      */\n+    @Deprecated\n     Path getArchiveLocation();\n \n+    /**\n+     *\n+     * Returns paths representing the archive root directories. Note that every path in this collection\n+     * is guaranteed to be a directory. If the actual application archive appears to be a JAR,\n+     * this collection will include a path to the root of the mounted {@link java.nio.file.FileSystem}\n+     * created from the JAR.\n+     *\n+     * @return The archive root directories.\n+     */\n+    PathsCollection getRootDirs();", "originalCommit": "3e272b9c60f20dc59e9eabed2c7f6373401cb0e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMjA2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408412062", "bodyText": "the utility methods I suppose, like resolveExistingOrNull?", "author": "gastaldi", "createdAt": "2020-04-14T20:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMTc1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNDUxMA==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408414510", "bodyText": "Yes, it allows/will allow us to add functionality we find useful in our context.", "author": "aloubyansky", "createdAt": "2020-04-14T20:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMTc1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMzQxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408413411", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return rootDirs.iterator().next();\n          \n          \n            \n                    return rootDirs.getSinglePath();", "author": "gastaldi", "createdAt": "2020-04-14T20:25:46Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/ApplicationArchiveImpl.java", "diffHunk": "@@ -31,24 +36,30 @@ public IndexView getIndex() {\n     }\n \n     @Override\n+    @Deprecated\n     public Path getArchiveRoot() {\n-        return archiveRoot;\n+        return rootDirs.iterator().next();", "originalCommit": "3e272b9c60f20dc59e9eabed2c7f6373401cb0e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNTU3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408415573", "bodyText": "Not yet, single path is assertive, it'll throw an exception in case there are more. In our current impl (not this PR but actually current codebase) we actually pick the first path in a few places.", "author": "aloubyansky", "createdAt": "2020-04-14T20:29:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMzQxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMzUxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408413511", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return paths.iterator().next();\n          \n          \n            \n                    return paths.getSinglePath();", "author": "gastaldi", "createdAt": "2020-04-14T20:25:58Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/ApplicationArchiveImpl.java", "diffHunk": "@@ -31,24 +36,30 @@ public IndexView getIndex() {\n     }\n \n     @Override\n+    @Deprecated\n     public Path getArchiveRoot() {\n-        return archiveRoot;\n+        return rootDirs.iterator().next();\n     }\n \n     @Override\n+    @Deprecated\n     public boolean isJarArchive() {\n         return jar;\n     }\n \n     @Override\n+    @Deprecated\n     public Path getArchiveLocation() {\n-        return archiveLocation;\n+        return paths.iterator().next();", "originalCommit": "3e272b9c60f20dc59e9eabed2c7f6373401cb0e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxNTc5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8284#discussion_r408415792", "bodyText": "Same as above, not yet.", "author": "aloubyansky", "createdAt": "2020-04-14T20:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxMzUxMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "1168e0c9cc2aed7867c6f0727f2bdfef829e2dd4", "url": "https://github.com/quarkusio/quarkus/commit/1168e0c9cc2aed7867c6f0727f2bdfef829e2dd4", "message": "Avoid SmallRye's PropertiesConfigSourceProvider that causes the JARs to stay locked on Windows", "committedDate": "2020-04-14T22:14:27Z", "type": "forcePushed"}, {"oid": "7f1fa4ce6ce2eac8e8125ee18e9627d12b08fe96", "url": "https://github.com/quarkusio/quarkus/commit/7f1fa4ce6ce2eac8e8125ee18e9627d12b08fe96", "message": "Avoid URL.openStream() where possible", "committedDate": "2020-04-15T14:27:02Z", "type": "forcePushed"}, {"oid": "e6aa9661f520c31bc369659d6ffdf11f6fc40c00", "url": "https://github.com/quarkusio/quarkus/commit/e6aa9661f520c31bc369659d6ffdf11f6fc40c00", "message": "Avoid URL.openStream() where possible", "committedDate": "2020-04-15T16:52:19Z", "type": "forcePushed"}, {"oid": "3eb20dfbaa72fe669d2a87af277e3ff101782647", "url": "https://github.com/quarkusio/quarkus/commit/3eb20dfbaa72fe669d2a87af277e3ff101782647", "message": "Avoid URL.openStream() where possible", "committedDate": "2020-04-15T21:48:05Z", "type": "forcePushed"}, {"oid": "3e69e5c58227b97a759c647445d64b2d07ee3b32", "url": "https://github.com/quarkusio/quarkus/commit/3e69e5c58227b97a759c647445d64b2d07ee3b32", "message": "more", "committedDate": "2020-04-16T15:45:09Z", "type": "forcePushed"}, {"oid": "cbd3279da1b68a9a161dbac2612f1ebe5df839ca", "url": "https://github.com/quarkusio/quarkus/commit/cbd3279da1b68a9a161dbac2612f1ebe5df839ca", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-16T21:10:33Z", "type": "forcePushed"}, {"oid": "a4cc04b431233b4f9afe13b0d73482646b9a690c", "url": "https://github.com/quarkusio/quarkus/commit/a4cc04b431233b4f9afe13b0d73482646b9a690c", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-17T16:28:21Z", "type": "forcePushed"}, {"oid": "64abca66110970e24dd3bc9b89c1893362a7bf6c", "url": "https://github.com/quarkusio/quarkus/commit/64abca66110970e24dd3bc9b89c1893362a7bf6c", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-17T19:25:59Z", "type": "forcePushed"}, {"oid": "6f085a99b18c01eef5341abc6ab61f6411309ed1", "url": "https://github.com/quarkusio/quarkus/commit/6f085a99b18c01eef5341abc6ab61f6411309ed1", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-19T06:49:25Z", "type": "forcePushed"}, {"oid": "5f8a55ecd63e96ef3089671bb46354cdbd8a00fc", "url": "https://github.com/quarkusio/quarkus/commit/5f8a55ecd63e96ef3089671bb46354cdbd8a00fc", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-19T08:22:06Z", "type": "forcePushed"}, {"oid": "7da2dce5b602b4c27bfda431d39a0898a95eb33c", "url": "https://github.com/quarkusio/quarkus/commit/7da2dce5b602b4c27bfda431d39a0898a95eb33c", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-19T22:11:11Z", "type": "commit"}, {"oid": "7da2dce5b602b4c27bfda431d39a0898a95eb33c", "url": "https://github.com/quarkusio/quarkus/commit/7da2dce5b602b4c27bfda431d39a0898a95eb33c", "message": "* Refactoring of AppArtifact to allow more than one path as its content. This is necessary, for example, to represent not yet packaged Gradle projects.\n\n* Introduce QuarkusBuildCloseablesBuildItem that can be used to collect various instances of Closeable that should be closed at the end of the build.\n\n* Moved the JAR renaming logic when uber-jar=true from the build step to BuildMojo to avoid running into JAR locking issue on Windows.\n\n* Introduce utility methods to read URLs as InputStreams in a way that does not lock JARs on Windows.\n\n* Avoid URL.openConnection() and URL.openStream() calls where possible to avoid JAR locking issues on Windows.", "committedDate": "2020-04-19T22:11:11Z", "type": "forcePushed"}]}