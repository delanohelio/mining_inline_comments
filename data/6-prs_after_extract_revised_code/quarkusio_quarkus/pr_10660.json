{"pr_number": 10660, "pr_title": "Access-Control-Allow-Credentials default value", "pr_createdAt": "2020-07-12T10:47:49Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10660", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0MzM4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453343389", "bodyText": "I think it should be boolean, with the defaultValue=false", "author": "sberyozkin", "createdAt": "2020-07-12T17:37:35Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java", "diffHunk": "@@ -61,6 +61,14 @@\n     @ConfigItem\n     public Optional<Duration> accessControlMaxAge;\n \n+    /**\n+     * The `Access-Control-Allow-Credentials` header is used to tell the\n+     * browsers to expose the response to front-end JavaScript code when\n+     * the request\u2019s credentials mode Request.credentials is \u201cinclude\u201d.\n+     */\n+    @ConfigItem(defaultValueDocumentation = \"Default value is true when origins is present and does not include '*', else it is false\")\n+    public Optional<Boolean> accessControlAllowCredentials;", "originalCommit": "f72c6349c8f44ff698e7a283287436cf279967a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0ODg1Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453348856", "bodyText": "My rational here was that the user may want to force false. It can be strange to define the value as false, and in fact becoming true because the conditions match. No? I guess if it's documented there is no problem.", "author": "mcserra", "createdAt": "2020-07-12T18:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0MzM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2OTk4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453769982", "bodyText": "@mcserra, makes sense", "author": "sberyozkin", "createdAt": "2020-07-13T16:19:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0MzM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3MTMxMA==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453771310", "bodyText": "Ok, cool :) So you want me to revert it?", "author": "mcserra", "createdAt": "2020-07-13T16:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0MzM4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "chunk": "diff --git a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\nindex 035927fbed..b42197b414 100644\n--- a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\n+++ b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\n\n@@ -65,8 +65,11 @@ public class CORSConfig {\n      * The `Access-Control-Allow-Credentials` header is used to tell the\n      * browsers to expose the response to front-end JavaScript code when\n      * the request\u2019s credentials mode Request.credentials is \u201cinclude\u201d.\n+     *\n+     * The value of this header will default to `true` if `quarkus.http.cors.origins` property is set and\n+     * there is a match with the precise `Origin` header and that header is not '*'.\n      */\n-    @ConfigItem(defaultValueDocumentation = \"Default value is true when origins is present and does not include '*', else it is false\")\n+    @ConfigItem\n     public Optional<Boolean> accessControlAllowCredentials;\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0NDY3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453344672", "bodyText": "I'm trying to figure out how to change either the docs or the defaultValueDocumentation and I'm getting confused for the 3rd time :-).\nOK, so, if this property is false (which is a default value of this property) then Access-Control-Allow-Credentials is false unless a matching non-wildcard Origins is present.\nIt feels it would be less confusing if we remove this defaultValueDocumentation and instead add to the javaDocs:\nThe value of this header will be set to `true` if either this property is set to `true` or `quarkus.http.cors.origins` property is set and does not include '*' which will require a precise `Origin` header check.\n\nHow does it sound ?", "author": "sberyozkin", "createdAt": "2020-07-12T17:50:44Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java", "diffHunk": "@@ -61,6 +61,14 @@\n     @ConfigItem\n     public Optional<Duration> accessControlMaxAge;\n \n+    /**\n+     * The `Access-Control-Allow-Credentials` header is used to tell the\n+     * browsers to expose the response to front-end JavaScript code when\n+     * the request\u2019s credentials mode Request.credentials is \u201cinclude\u201d.\n+     */\n+    @ConfigItem(defaultValueDocumentation = \"Default value is true when origins is present and does not include '*', else it is false\")", "originalCommit": "f72c6349c8f44ff698e7a283287436cf279967a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM2MjY1Nw==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453362657", "bodyText": "Its clear, sounds good. Done", "author": "mcserra", "createdAt": "2020-07-12T20:57:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0NDY3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "chunk": "diff --git a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\nindex 035927fbed..b42197b414 100644\n--- a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\n+++ b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSConfig.java\n\n@@ -65,8 +65,11 @@ public class CORSConfig {\n      * The `Access-Control-Allow-Credentials` header is used to tell the\n      * browsers to expose the response to front-end JavaScript code when\n      * the request\u2019s credentials mode Request.credentials is \u201cinclude\u201d.\n+     *\n+     * The value of this header will default to `true` if `quarkus.http.cors.origins` property is set and\n+     * there is a match with the precise `Origin` header and that header is not '*'.\n      */\n-    @ConfigItem(defaultValueDocumentation = \"Default value is true when origins is present and does not include '*', else it is false\")\n+    @ConfigItem\n     public Optional<Boolean> accessControlAllowCredentials;\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0NTE5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453345195", "bodyText": "Can you also have a boolean var recording the result of the origin comparison checked here ? It is probably not very critical but it is better to return true only if the exact origin match happened...", "author": "sberyozkin", "createdAt": "2020-07-12T17:56:19Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java", "diffHunk": "@@ -97,7 +97,10 @@ public void handle(RoutingContext event) {\n                 response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, origin);\n             }\n \n-            response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            boolean allowCredentials = corsConfig.accessControlAllowCredentials\n+                    .orElseGet(() -> (corsConfig.origins.isPresent() && !corsConfig.origins.get().contains(\"*\")));", "originalCommit": "f72c6349c8f44ff698e7a283287436cf279967a2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM2MjY5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453362695", "bodyText": "Done. Thanks :)", "author": "mcserra", "createdAt": "2020-07-12T20:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0NTE5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "chunk": "diff --git a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\nindex f5ce518c1f..29cee851b4 100644\n--- a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\n+++ b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\n\n@@ -98,7 +98,8 @@ public class CORSFilter implements Handler<RoutingContext> {\n             }\n \n             boolean allowCredentials = corsConfig.accessControlAllowCredentials\n-                    .orElseGet(() -> (corsConfig.origins.isPresent() && !corsConfig.origins.get().contains(\"*\")));\n+                    .orElseGet(() -> corsConfig.origins.isPresent() && corsConfig.origins.get().contains(origin)\n+                            && !origin.equals(\"*\"));\n \n             response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, String.valueOf(allowCredentials));\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3Mjg3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453772871", "bodyText": "Hi @mcserra, interesting case, I actually think it should be true here because a precise match possible, I think we may need to tweak the check, please see below", "author": "sberyozkin", "createdAt": "2020-07-13T16:24:18Z", "path": "extensions/vertx-http/deployment/src/test/java/io/quarkus/vertx/http/cors/CORSHandlerTestWildcardOriginCase.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package io.quarkus.vertx.http.cors;\n+\n+import static io.restassured.RestAssured.given;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.DisplayName;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class CORSHandlerTestWildcardOriginCase {", "originalCommit": "8a4d829b12b28cdc1b9aeb7ecbe4f893837c808e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3Mzk2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453773966", "bodyText": "Yes, sure, I suppose if the origin match the '*' is irrelevant", "author": "mcserra", "createdAt": "2020-07-13T16:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3Mjg3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "chunk": "diff --git a/extensions/vertx-http/deployment/src/test/java/io/quarkus/vertx/http/cors/CORSHandlerTestWildcardOriginCase.java b/extensions/vertx-http/deployment/src/test/java/io/quarkus/vertx/http/cors/CORSHandlerTestWildcardOriginCase.java\nindex e57f3a0e9e..47fc49f3f9 100644\n--- a/extensions/vertx-http/deployment/src/test/java/io/quarkus/vertx/http/cors/CORSHandlerTestWildcardOriginCase.java\n+++ b/extensions/vertx-http/deployment/src/test/java/io/quarkus/vertx/http/cors/CORSHandlerTestWildcardOriginCase.java\n\n@@ -10,7 +10,7 @@ import org.junit.jupiter.api.extension.RegisterExtension;\n \n import io.quarkus.test.QuarkusUnitTest;\n \n-public class CORSHandlerTestWildcardOriginCase {\n+class CORSHandlerTestWildcardOriginCase {\n \n     @RegisterExtension\n     static QuarkusUnitTest runner = new QuarkusUnitTest()\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3NTgyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453775825", "bodyText": "@mcserra Looks like we can drop !corsConfig.origins.get().contains(\"*\") because we have corsConfig.origins.get().contains(origin) which ensures the precise match, but instead we should check that the Origin header does no contain *.\nThis will ensure that, assuming Origin is something like https://origin, then if we have the allowed origins as https://origin,* then true will be returned due to a precise match.\nDo you agree ?", "author": "sberyozkin", "createdAt": "2020-07-13T16:28:50Z", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java", "diffHunk": "@@ -97,7 +97,11 @@ public void handle(RoutingContext event) {\n                 response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, origin);\n             }\n \n-            response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            boolean allowCredentials = corsConfig.accessControlAllowCredentials\n+                    || (corsConfig.origins.isPresent() && !corsConfig.origins.get().contains(\"*\")", "originalCommit": "8a4d829b12b28cdc1b9aeb7ecbe4f893837c808e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgyMDMzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/10660#discussion_r453820339", "bodyText": "I do. I'll do a commit.", "author": "mcserra", "createdAt": "2020-07-13T17:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3NTgyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "chunk": "diff --git a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\nindex d17aff8644..29cee851b4 100644\n--- a/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\n+++ b/extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/cors/CORSFilter.java\n\n@@ -98,8 +98,8 @@ public class CORSFilter implements Handler<RoutingContext> {\n             }\n \n             boolean allowCredentials = corsConfig.accessControlAllowCredentials\n-                    || (corsConfig.origins.isPresent() && !corsConfig.origins.get().contains(\"*\")\n-                            && corsConfig.origins.get().contains(origin));\n+                    .orElseGet(() -> corsConfig.origins.isPresent() && corsConfig.origins.get().contains(origin)\n+                            && !origin.equals(\"*\"));\n \n             response.headers().set(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, String.valueOf(allowCredentials));\n \n"}}, {"oid": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "url": "https://github.com/quarkusio/quarkus/commit/1dceff50e80597272172cfbdfd75beca3fd29bf4", "message": "Access-Control-Allow-Credentials default value\n\nUpdate docs/src/main/asciidoc/http-reference.adoc\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>\n\nconfig type + tests\n\nchange origin match rules\n\nchange config to Optional<Boolean>", "committedDate": "2020-07-15T08:35:53Z", "type": "commit"}, {"oid": "1dceff50e80597272172cfbdfd75beca3fd29bf4", "url": "https://github.com/quarkusio/quarkus/commit/1dceff50e80597272172cfbdfd75beca3fd29bf4", "message": "Access-Control-Allow-Credentials default value\n\nUpdate docs/src/main/asciidoc/http-reference.adoc\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>\n\nconfig type + tests\n\nchange origin match rules\n\nchange config to Optional<Boolean>", "committedDate": "2020-07-15T08:35:53Z", "type": "forcePushed"}]}