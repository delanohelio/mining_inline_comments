{"pr_number": 10294, "pr_title": "Add the ability to print the startup time of each build step", "pr_createdAt": "2020-06-26T08:27:33Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/10294", "timeline": [{"oid": "9e81161a67caa372417e6c60034ecdf15d8b9aba", "url": "https://github.com/quarkusio/quarkus/commit/9e81161a67caa372417e6c60034ecdf15d8b9aba", "message": "Add the ability to print the startup time of each build step\n\nThis has been discussed a couple times and I myself could have\nused it when I was looking into the Flwyay startup times", "committedDate": "2020-06-26T08:32:04Z", "type": "forcePushed"}, {"oid": "eac1ec06470849d8c9b8a6905ac157eda0490293", "url": "https://github.com/quarkusio/quarkus/commit/eac1ec06470849d8c9b8a6905ac157eda0490293", "message": "Add the ability to print the startup time of each build step\n\nThis has been discussed a couple times and I myself could have\nused it when I was looking into the Flwyay startup times", "committedDate": "2020-07-02T11:44:13Z", "type": "forcePushed"}, {"oid": "b64f4f1a5d164a62610706454065cbe2651bffba", "url": "https://github.com/quarkusio/quarkus/commit/b64f4f1a5d164a62610706454065cbe2651bffba", "message": "Add the ability to print the startup time of each build step - v2", "committedDate": "2020-07-03T12:15:40Z", "type": "forcePushed"}, {"oid": "c9faf62ef3cd9498e546058775ee122fded6ee5c", "url": "https://github.com/quarkusio/quarkus/commit/c9faf62ef3cd9498e546058775ee122fded6ee5c", "message": "Add the ability to print the startup time of each build step - v2", "committedDate": "2020-07-03T12:20:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449961580", "bodyText": "Does this actually need to be generated? Can't it just be a static utility method?", "author": "stuartwdouglas", "createdAt": "2020-07-06T03:01:05Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/MainClassBuildStep.java", "diffHunk": "@@ -308,6 +333,78 @@ void build(List<StaticBytecodeRecorderBuildItem> staticInitTasks,\n         file.close();\n     }\n \n+    /**\n+     * Step timing is enabled only if 'quarkus.debug.print-startup-times' is set.\n+     * This method should be called both in static init and runtime init in order to\n+     * make sure that the system properly works properly in native mode\n+     */\n+    private void setStepTimingField(MethodCreator mv) {\n+        ResultHandle timingEnabledProp = mv.invokeStaticMethod(\n+                ofMethod(System.class, \"getProperty\", String.class, String.class, String.class),\n+                mv.load(MainClassBuildStep.PRINT_STARTUP_TIMES_PROPERTY), mv.load(\"false\"));\n+        mv.writeStaticField(STEP_TIMING_ENABLED_FIELD, mv.invokeStaticMethod(\n+                ofMethod(Boolean.class, \"parseBoolean\", boolean.class, String.class), timingEnabledProp));\n+    }\n+\n+    /**\n+     * Generates the following bytecode:\n+     * \n+     * <pre>\n+     *\n+     * private static void printStepTime() {\n+     *     if (stepTimingEnabled) {\n+     *         long var2 = System.currentTimeMillis();\n+     *         String var0 = STARTUP_CONTEXT.getCurrentBuildStepName();\n+     *         StringBuilder var1 = new StringBuilder(\"Build step \");\n+     *         var1.append(var0);\n+     *         var1.append(\" completed in: \");\n+     *         long var4 = stepTimingStart;\n+     *         String var6 = String.valueOf(Math.subtractExact(var2, var4));\n+     *         var1.append(var6);\n+     *         var1.append(\"ms\");\n+     *         PrintStream var7 = System.out;\n+     *         String var8 = var1.toString();\n+     *         var7.println(var8);\n+     *         stepTimingStart = System.currentTimeMillis();\n+     *     }\n+     * }\n+     *\n+     * </pre>\n+     *\n+     * This is used to print the time it took for a build step to execute. The first invocation of this method\n+     * assumes that the static {@code stepTimingStart} field has been set.\n+     *\n+     * After printing the time, it also resets {@code stepTimingStart} because steps are executed one after the other.\n+     */\n+    private void generationPrintStepTimeMethod(ClassCreator file) {", "originalCommit": "c9faf62ef3cd9498e546058775ee122fded6ee5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3NzM3OA==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449977378", "bodyText": "In it's current form yes because it changes uses the classes static fields. Do you prefer this not be generated and instead have the  stepTimingEnabled check and setting of stepTimingStart outside the method?", "author": "geoand", "createdAt": "2020-07-06T04:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3ODEzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449978135", "bodyText": "Or we could move the fields to the utility class as well :)", "author": "geoand", "createdAt": "2020-07-06T04:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4Mjk4Mg==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449982982", "bodyText": "Yea, I was thinking just move as much as possible to the utility class.", "author": "stuartwdouglas", "createdAt": "2020-07-06T04:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NDk3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449984971", "bodyText": "On it", "author": "geoand", "createdAt": "2020-07-06T05:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NjQ3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/10294#discussion_r449986471", "bodyText": "PR updated", "author": "geoand", "createdAt": "2020-07-06T05:10:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2MTU4MA=="}], "type": "inlineReview", "revised_code": {"commit": "69398b5778111c297a251dd9ed849a44422f2f24", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/steps/MainClassBuildStep.java b/core/deployment/src/main/java/io/quarkus/deployment/steps/MainClassBuildStep.java\nindex e40396c9d0..fe2ef6657d 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/steps/MainClassBuildStep.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/steps/MainClassBuildStep.java\n\n@@ -333,78 +322,6 @@ public class MainClassBuildStep {\n         file.close();\n     }\n \n-    /**\n-     * Step timing is enabled only if 'quarkus.debug.print-startup-times' is set.\n-     * This method should be called both in static init and runtime init in order to\n-     * make sure that the system properly works properly in native mode\n-     */\n-    private void setStepTimingField(MethodCreator mv) {\n-        ResultHandle timingEnabledProp = mv.invokeStaticMethod(\n-                ofMethod(System.class, \"getProperty\", String.class, String.class, String.class),\n-                mv.load(MainClassBuildStep.PRINT_STARTUP_TIMES_PROPERTY), mv.load(\"false\"));\n-        mv.writeStaticField(STEP_TIMING_ENABLED_FIELD, mv.invokeStaticMethod(\n-                ofMethod(Boolean.class, \"parseBoolean\", boolean.class, String.class), timingEnabledProp));\n-    }\n-\n-    /**\n-     * Generates the following bytecode:\n-     * \n-     * <pre>\n-     *\n-     * private static void printStepTime() {\n-     *     if (stepTimingEnabled) {\n-     *         long var2 = System.currentTimeMillis();\n-     *         String var0 = STARTUP_CONTEXT.getCurrentBuildStepName();\n-     *         StringBuilder var1 = new StringBuilder(\"Build step \");\n-     *         var1.append(var0);\n-     *         var1.append(\" completed in: \");\n-     *         long var4 = stepTimingStart;\n-     *         String var6 = String.valueOf(Math.subtractExact(var2, var4));\n-     *         var1.append(var6);\n-     *         var1.append(\"ms\");\n-     *         PrintStream var7 = System.out;\n-     *         String var8 = var1.toString();\n-     *         var7.println(var8);\n-     *         stepTimingStart = System.currentTimeMillis();\n-     *     }\n-     * }\n-     *\n-     * </pre>\n-     *\n-     * This is used to print the time it took for a build step to execute. The first invocation of this method\n-     * assumes that the static {@code stepTimingStart} field has been set.\n-     *\n-     * After printing the time, it also resets {@code stepTimingStart} because steps are executed one after the other.\n-     */\n-    private void generationPrintStepTimeMethod(ClassCreator file) {\n-        MethodCreator mc = file.getMethodCreator(PRINT_STEP_TIME_METHOD).setModifiers(Modifier.STATIC | Modifier.PRIVATE);\n-        ResultHandle resultHandle = mc.readStaticField(STEP_TIMING_ENABLED_FIELD);\n-        BytecodeCreator timingEnabled = mc.ifTrue(resultHandle).trueBranch();\n-\n-        ResultHandle stopTime = timingEnabled.invokeStaticMethod(MILLIS_TIME);\n-        ResultHandle buildStepName = timingEnabled.invokeVirtualMethod(\n-                ofMethod(StartupContext.class, \"getCurrentBuildStepName\", String.class),\n-                timingEnabled.readStaticField(STARTUP_CONTEXT_FIELD));\n-        ResultHandle builder = timingEnabled.newInstance(ofConstructor(StringBuilder.class, String.class),\n-                timingEnabled.load(\"Build step \"));\n-        timingEnabled.invokeVirtualMethod(STRING_BUILDER_APPEND, builder, buildStepName);\n-        timingEnabled.invokeVirtualMethod(STRING_BUILDER_APPEND, builder, timingEnabled.load(\" completed in: \"));\n-        timingEnabled.invokeVirtualMethod(STRING_BUILDER_APPEND, builder,\n-                timingEnabled.invokeStaticMethod(ofMethod(String.class, \"valueOf\", String.class, long.class),\n-                        timingEnabled.invokeStaticMethod(\n-                                ofMethod(Math.class, \"subtractExact\", long.class, long.class, long.class),\n-                                stopTime,\n-                                timingEnabled.readStaticField(STEP_TIMING_START_FIELD))));\n-        timingEnabled.invokeVirtualMethod(STRING_BUILDER_APPEND, builder, timingEnabled.load(\"ms\"));\n-        ResultHandle out = timingEnabled.readStaticField(FieldDescriptor.of(System.class, \"out\", PrintStream.class));\n-        timingEnabled.invokeVirtualMethod(ofMethod(PrintStream.class, \"println\", void.class, String.class), out,\n-                timingEnabled.invokeVirtualMethod(ofMethod(StringBuilder.class, \"toString\", String.class), builder));\n-\n-        // record the start time which will be used to compute the startup time of the next build step\n-        timingEnabled.writeStaticField(STEP_TIMING_START_FIELD, timingEnabled.invokeStaticMethod(MILLIS_TIME));\n-        mc.returnValue(null);\n-    }\n-\n     @BuildStep\n     public MainClassBuildItem mainClassBuildStep(BuildProducer<GeneratedClassBuildItem> generatedClass,\n             ApplicationArchivesBuildItem applicationArchivesBuildItem,\n"}}, {"oid": "69398b5778111c297a251dd9ed849a44422f2f24", "url": "https://github.com/quarkusio/quarkus/commit/69398b5778111c297a251dd9ed849a44422f2f24", "message": "Add the ability to print the startup time of each build step - v3", "committedDate": "2020-07-06T05:10:24Z", "type": "forcePushed"}, {"oid": "4015a51a989fd9c781927a2c1730c972a114d995", "url": "https://github.com/quarkusio/quarkus/commit/4015a51a989fd9c781927a2c1730c972a114d995", "message": "Add the ability to print the startup time of each build step - v3", "committedDate": "2020-07-06T05:11:45Z", "type": "forcePushed"}, {"oid": "18d66e6a2daafa6fe524b987613b72e921b4d159", "url": "https://github.com/quarkusio/quarkus/commit/18d66e6a2daafa6fe524b987613b72e921b4d159", "message": "Add the ability to print the startup time of each build step", "committedDate": "2020-07-06T06:13:11Z", "type": "forcePushed"}, {"oid": "fa70fb634d3262fb275aed6fbb38258c63c4d2a3", "url": "https://github.com/quarkusio/quarkus/commit/fa70fb634d3262fb275aed6fbb38258c63c4d2a3", "message": "Add the ability to print the startup time of each build step", "committedDate": "2020-07-06T08:01:53Z", "type": "forcePushed"}, {"oid": "86b9fda5342d8f48b16e1a8e6a710d883caab033", "url": "https://github.com/quarkusio/quarkus/commit/86b9fda5342d8f48b16e1a8e6a710d883caab033", "message": "Add the ability to print the startup time of each build step", "committedDate": "2020-07-06T12:30:12Z", "type": "commit"}, {"oid": "86b9fda5342d8f48b16e1a8e6a710d883caab033", "url": "https://github.com/quarkusio/quarkus/commit/86b9fda5342d8f48b16e1a8e6a710d883caab033", "message": "Add the ability to print the startup time of each build step", "committedDate": "2020-07-06T12:30:12Z", "type": "forcePushed"}]}