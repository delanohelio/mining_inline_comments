{"pr_number": 8255, "pr_title": "Fix issue 8254 - PanacheQuery.count() throws \"unexpected token: SELECT\"", "pr_createdAt": "2020-03-29T16:08:49Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8255", "timeline": [{"oid": "7c984eab57517c83942cff7891120cbc11ca869c", "url": "https://github.com/quarkusio/quarkus/commit/7c984eab57517c83942cff7891120cbc11ca869c", "message": "Fix https://github.com/quarkusio/quarkus/issues/8254", "committedDate": "2020-03-30T12:23:25Z", "type": "forcePushed"}, {"oid": "2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "url": "https://github.com/quarkusio/quarkus/commit/2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T12:33:45Z", "type": "forcePushed"}, {"oid": "08e9e141df39a1f234f46a44e1671ad0affc9975", "url": "https://github.com/quarkusio/quarkus/commit/08e9e141df39a1f234f46a44e1671ad0affc9975", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T13:57:53Z", "type": "forcePushed"}, {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387", "url": "https://github.com/quarkusio/quarkus/commit/b236505e57b3f6df38ce21172611f6abf98dd387", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T14:14:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0NDI2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8255#discussion_r400244261", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (selectMatcher.matches())\n          \n          \n            \n                        return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n          \n          \n            \n                    if (selectMatcher.matches()) {\n          \n          \n            \n                        return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n          \n          \n            \n                    }", "author": "gastaldi", "createdAt": "2020-03-30T14:38:38Z", "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java", "diffHunk": "@@ -153,6 +158,9 @@ public long count() {\n     }\n \n     protected String countQuery() {\n+        Matcher selectMatcher = SELECT_PATTERN.matcher(query);\n+        if (selectMatcher.matches())\n+            return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);", "originalCommit": "b236505e57b3f6df38ce21172611f6abf98dd387", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "91cfbfec4433bc62d5041267b93143b3b29cba79", "chunk": "diff --git a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java\nindex 4bbfe41f62..5d5aa01a68 100644\n--- a/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java\n+++ b/extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java\n\n@@ -159,8 +159,9 @@ public class PanacheQueryImpl<Entity> implements PanacheQuery<Entity> {\n \n     protected String countQuery() {\n         Matcher selectMatcher = SELECT_PATTERN.matcher(query);\n-        if (selectMatcher.matches())\n-            return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n+        if (selectMatcher.matches()) {\n+\t        return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n+        }\n         return \"SELECT COUNT(*) \" + query;\n     }\n \n"}}, {"oid": "91cfbfec4433bc62d5041267b93143b3b29cba79", "url": "https://github.com/quarkusio/quarkus/commit/91cfbfec4433bc62d5041267b93143b3b29cba79", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T14:53:10Z", "type": "forcePushed"}, {"oid": "331aa50588216ff42abb804ff9ff1f649f11b03e", "url": "https://github.com/quarkusio/quarkus/commit/331aa50588216ff42abb804ff9ff1f649f11b03e", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T15:01:01Z", "type": "commit"}, {"oid": "331aa50588216ff42abb804ff9ff1f649f11b03e", "url": "https://github.com/quarkusio/quarkus/commit/331aa50588216ff42abb804ff9ff1f649f11b03e", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\"", "committedDate": "2020-03-30T15:01:01Z", "type": "forcePushed"}]}