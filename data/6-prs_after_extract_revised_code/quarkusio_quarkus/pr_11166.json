{"pr_number": 11166, "pr_title": "Upgrade to Hibernate Search 6.0.0.Beta9 + Elasticsearch 7.8", "pr_createdAt": "2020-08-03T14:20:38Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/11166", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464451374", "bodyText": "Not sure I follow you here. We make the version mandatory for named backend so maybe we should just make it mandatory for everything, default backend included? And then we could keep the named backend active?", "author": "gsmet", "createdAt": "2020-08-03T14:31:01Z", "path": "extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java", "diffHunk": "@@ -97,37 +97,34 @@ void setRuntimeConfig(HibernateSearchElasticsearchRecorder recorder,\n     }\n \n     private static void checkConfig(HibernateSearchElasticsearchBuildTimeConfig buildTimeConfig) {\n-        if (buildTimeConfig.additionalBackends.defaultBackend.isPresent()) {\n-            String defaultBackend = buildTimeConfig.additionalBackends.defaultBackend.get();\n-            // we have a default named backend\n-            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n-                throw new ConfigurationError(\n-                        \"quarkus.hibernate-search.elasticsearch.default-backend cannot be used in conjunction with a default backend configuration.\");\n-            }\n-            if (!buildTimeConfig.additionalBackends.backends.containsKey(defaultBackend)) {\n-                throw new ConfigurationError(\n-                        \"The default backend defined does not exist: \" + defaultBackend);\n-            }\n-        } else {\n-            // we are in the default backend case\n+        if (buildTimeConfig.namedBackends.backends.isEmpty()) {\n+            // There isn't any named backend: the default backend will be used.\n+\n+            // we validate that the version is present\n             if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n                 throw new ConfigurationError(\n                         \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n             }\n-        }\n+        } else {\n+            // There is at least one named backend: we disallow using the default backend.\n+            // Theoretically we could allow using it,\n+            // but then we would be unable to detect whether the default backend is used\n+            // (and thus absolutely needs the version to be configured)", "originalCommit": "c926b015d63fe221332a261a2ab1a4db0349ca5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NzUwMA==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464467500", "bodyText": "If we do that, then people using named backends exclusively (which, IMO, is what they should do if they have multiple backends) will have to set the version for the default backend even if they don't use it. I can do that if you want, but I'm not sure it's a better solution.", "author": "yrodiere", "createdAt": "2020-08-03T14:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwNDYzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r473104631", "bodyText": "I fixed this according to our discussion on Zulip, rebased and force-pushed. Let's wait for CI, but then as far as I know it can be merged.", "author": "yrodiere", "createdAt": "2020-08-19T15:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "1bfd83f94f8a76939403201af5451fed0c4db5d5", "chunk": "diff --git a/extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java b/extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java\nindex a97b46a48b..e26c964146 100644\n--- a/extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java\n+++ b/extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java\n\n@@ -97,34 +97,37 @@ class HibernateSearchElasticsearchProcessor {\n     }\n \n     private static void checkConfig(HibernateSearchElasticsearchBuildTimeConfig buildTimeConfig) {\n-        if (buildTimeConfig.namedBackends.backends.isEmpty()) {\n-            // There isn't any named backend: the default backend will be used.\n-\n-            // we validate that the version is present\n-            if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n+        if (buildTimeConfig.additionalBackends.defaultBackend.isPresent()) {\n+            String defaultBackend = buildTimeConfig.additionalBackends.defaultBackend.get();\n+            // we have a default named backend\n+            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n                 throw new ConfigurationError(\n-                        \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n+                        \"quarkus.hibernate-search.elasticsearch.default-backend cannot be used in conjunction with a default backend configuration.\");\n+            }\n+            if (!buildTimeConfig.additionalBackends.backends.containsKey(defaultBackend)) {\n+                throw new ConfigurationError(\n+                        \"The default backend defined does not exist: \" + defaultBackend);\n             }\n         } else {\n-            // There is at least one named backend: we disallow using the default backend.\n-            // Theoretically we could allow using it,\n-            // but then we would be unable to detect whether the default backend is used\n-            // (and thus absolutely needs the version to be configured)\n-            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n-                throw new ConfigurationError(\"The default backend cannot be configured if named backends are configured.\");\n+            // we are in the default backend case\n+            if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n+                throw new ConfigurationError(\n+                        \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n             }\n+        }\n \n-            // we validate that the version is present for all the named backends\n-            List<String> namedBackendsWithNoVersion = new ArrayList<>();\n-            for (Entry<String, ElasticsearchBackendBuildTimeConfig> additionalBackendEntry : buildTimeConfig.namedBackends.backends\n+        // we validate that the version is present for all the additional backends\n+        if (!buildTimeConfig.additionalBackends.backends.isEmpty()) {\n+            List<String> additionalBackendsWithNoVersion = new ArrayList<>();\n+            for (Entry<String, ElasticsearchBackendBuildTimeConfig> additionalBackendEntry : buildTimeConfig.additionalBackends.backends\n                     .entrySet()) {\n                 if (!additionalBackendEntry.getValue().version.isPresent()) {\n-                    namedBackendsWithNoVersion.add(additionalBackendEntry.getKey());\n+                    additionalBackendsWithNoVersion.add(additionalBackendEntry.getKey());\n                 }\n             }\n-            if (!namedBackendsWithNoVersion.isEmpty()) {\n+            if (!additionalBackendsWithNoVersion.isEmpty()) {\n                 throw new ConfigurationError(\"The Elasticsearch version property needs to be defined for backends \"\n-                        + String.join(\", \", namedBackendsWithNoVersion));\n+                        + String.join(\", \", additionalBackendsWithNoVersion));\n             }\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTc3NA==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464451774", "bodyText": "Given we are still experimental, I would just drop it and document it in the release notes.", "author": "gsmet", "createdAt": "2020-08-03T14:31:36Z", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,9 +128,18 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;\n \n+        /**\n+         * @deprecated Define index defaults directly at the backend level instead of using {@code index-defaults};\n+         *             e.g. use simply {@code quarkus.hibernate-search.elasticsearch.indexing.queue.count}\n+         *             instead of {@code quarkus.hibernate-search.elasticsearch.index-defaults.indexing.queue.count}.\n+         */\n+        @ConfigItem(name = \"index-defaults\")\n+        @Deprecated\n+        ElasticsearchIndexConfig legacyIndexDefaults;", "originalCommit": "c926b015d63fe221332a261a2ab1a4db0349ca5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NzcyMg==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464467722", "bodyText": "Ok, I'll add a commit.", "author": "yrodiere", "createdAt": "2020-08-03T14:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTc3NA=="}], "type": "inlineReview", "revised_code": {"commit": "1bfd83f94f8a76939403201af5451fed0c4db5d5", "chunk": "diff --git a/extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java b/extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java\nindex 7a8fcef5ec..ac3eff4f28 100644\n--- a/extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java\n+++ b/extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java\n\n@@ -128,18 +128,9 @@ public class HibernateSearchElasticsearchRuntimeConfig {\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem(name = ConfigItem.PARENT)\n+        @ConfigItem\n         ElasticsearchIndexConfig indexDefaults;\n \n-        /**\n-         * @deprecated Define index defaults directly at the backend level instead of using {@code index-defaults};\n-         *             e.g. use simply {@code quarkus.hibernate-search.elasticsearch.indexing.queue.count}\n-         *             instead of {@code quarkus.hibernate-search.elasticsearch.index-defaults.indexing.queue.count}.\n-         */\n-        @ConfigItem(name = \"index-defaults\")\n-        @Deprecated\n-        ElasticsearchIndexConfig legacyIndexDefaults;\n-\n         /**\n          * Per-index specific configuration.\n          */\n"}}, {"oid": "1bfd83f94f8a76939403201af5451fed0c4db5d5", "url": "https://github.com/quarkusio/quarkus/commit/1bfd83f94f8a76939403201af5451fed0c4db5d5", "message": "Upgrade to Hibernate Search 6.0.0.Beta9", "committedDate": "2020-08-19T14:18:19Z", "type": "commit"}, {"oid": "20533c622ec52d310c6eb9ff748898be2d004d94", "url": "https://github.com/quarkusio/quarkus/commit/20533c622ec52d310c6eb9ff748898be2d004d94", "message": "Upgrade to Elasticsearch 7.8.0", "committedDate": "2020-08-19T14:18:20Z", "type": "commit"}, {"oid": "1d70c61e2182c7d5bb741d65f97f5918c42d0890", "url": "https://github.com/quarkusio/quarkus/commit/1d70c61e2182c7d5bb741d65f97f5918c42d0890", "message": "hsearch-es: Use HSearch's native concept of default (unnamed) backend instead of defining our own", "committedDate": "2020-08-19T14:18:20Z", "type": "commit"}, {"oid": "2c0e8ae1eb9dd85fd58806a32d98b725ee3c226c", "url": "https://github.com/quarkusio/quarkus/commit/2c0e8ae1eb9dd85fd58806a32d98b725ee3c226c", "message": "hsearch-es: Remove the ability to define a *named*, default backend\n\nThis feature probably wasn't used a lot by Quarkus users, since it's\nonly (potentially) useful when you have multiple backends.", "committedDate": "2020-08-19T15:03:38Z", "type": "commit"}, {"oid": "04b56b5dd80ee693f9de141b2d29480e0995e323", "url": "https://github.com/quarkusio/quarkus/commit/04b56b5dd80ee693f9de141b2d29480e0995e323", "message": "hsearch-es: Add missing 'final' keyword", "committedDate": "2020-08-19T15:03:38Z", "type": "commit"}, {"oid": "4c164d866ac9edb35c24db01c0040b06b98ccb6b", "url": "https://github.com/quarkusio/quarkus/commit/4c164d866ac9edb35c24db01c0040b06b98ccb6b", "message": "hsearch-es: Move to HSearch's new simplified syntax for specifying default configuration for indexes", "committedDate": "2020-08-19T15:03:38Z", "type": "commit"}, {"oid": "d9071e5a4827470945664bc810d95d05d7d266f6", "url": "https://github.com/quarkusio/quarkus/commit/d9071e5a4827470945664bc810d95d05d7d266f6", "message": "hsearch-es: Drop the deprecated '.index-defaults.foo' syntax for specifying default configuration for indexes", "committedDate": "2020-08-19T15:03:38Z", "type": "commit"}, {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612", "url": "https://github.com/quarkusio/quarkus/commit/2e6f816539f6bf5b54ea75a45cddfd585c559612", "message": "hsearch-es: Clarify the name of some unit tests\n\nI had renamed the tests in 961d95b3b8e02c2c104f6ef2bf96d82f822580c8\nbecause I misunderstood their purpose from the comment on IndexedEntity\nand thought they were misnamed, but actually it's the comment that was\nunclear and should have been fixed.", "committedDate": "2020-08-19T15:05:54Z", "type": "commit"}, {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612", "url": "https://github.com/quarkusio/quarkus/commit/2e6f816539f6bf5b54ea75a45cddfd585c559612", "message": "hsearch-es: Clarify the name of some unit tests\n\nI had renamed the tests in 961d95b3b8e02c2c104f6ef2bf96d82f822580c8\nbecause I misunderstood their purpose from the comment on IndexedEntity\nand thought they were misnamed, but actually it's the comment that was\nunclear and should have been fixed.", "committedDate": "2020-08-19T15:05:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474267518", "bodyText": "Maybe we could rename that one to defaultBackend? That would be clearer IMHO.", "author": "gsmet", "createdAt": "2020-08-20T20:55:57Z", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "originalCommit": "2e6f816539f6bf5b54ea75a45cddfd585c559612", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzODU3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474438575", "bodyText": "This is not the default backend. This is the default configuration for indexes of a particular backend. E.g. quarkus.hibernate-search.elasticsearch.index-defaults.foo or quarkus.hibernate-search.elasticsearch.myBackend.index-defaults.foo.\ndefaultBackend is already present at line 32.\nWhat we could do, if you want, is remove this indexDefaults, since users can now put their default index configuration at the backend level, and it will be automatically applied to all indexes. In Hibernate Search it's already deprecated and we log a warning when it's used:\n\t@LogMessage(level = Logger.Level.WARN)\n\t@Message(id = ID_OFFSET_2 + 85,\n\t\t\tvalue = \"Using configuration property '%1$s'. The prefix 'index_defaults' is deprecated and its support will ultimately be removed.\"\n\t\t\t\t\t+ \" Instead, you should just set defaults for index properties at the backend level.\"\n\t\t\t\t\t+ \" For example, set 'hibernate.search.backend.indexing.queue_size'\"\n\t\t\t\t\t+ \" instead of 'hibernate.search.backend.index_defaults.indexing.queue_size'.\")\n\tvoid deprecatedIndexDefaultsPrefix(String key);", "author": "yrodiere", "createdAt": "2020-08-21T06:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxODgxNw==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474618817", "bodyText": "Ah OK, then let's remove it if it's deprecated in Search.", "author": "gsmet", "createdAt": "2020-08-21T10:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNDM5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474624392", "bodyText": "Actually I was wrong, since I changed @ConfigItem to @ConfigItem(name = ConfigItem.PARENT), the index-defaults. prefix is no longer used. This will just be used to collect default index properties set at the backend level. So we're good, and the name is correct too.", "author": "yrodiere", "createdAt": "2020-08-21T10:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNDk5MA==", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474624990", "bodyText": "After discussion on Zulip, we want to keep it.", "author": "gsmet", "createdAt": "2020-08-21T10:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}], "type": "inlineReview", "revised_code": null}]}