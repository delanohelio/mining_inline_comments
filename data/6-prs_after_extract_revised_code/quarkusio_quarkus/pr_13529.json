{"pr_number": 13529, "pr_title": "Rework constrained method inheritance for Hibernate Validator extension", "pr_createdAt": "2020-11-27T21:43:17Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13529", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgwMDUzMw==", "url": "https://github.com/quarkusio/quarkus/pull/13529#discussion_r531800533", "bodyText": "method.declaringClass() is already available as clazz .", "author": "famod", "createdAt": "2020-11-27T22:38:56Z", "path": "extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/HibernateValidatorProcessor.java", "diffHunk": "@@ -376,13 +376,23 @@ private static void contributeClassMarkedForCascadingValidation(Set<DotName> cla\n     }\n \n     private static void contributeMethodsWithInheritedValidation(\n-            Map<DotName, Set<SimpleMethodSignatureKey>> inheritedAnnotationsToBeValidated,\n+            Map<DotName, Set<SimpleMethodSignatureKey>> methodsWithInheritedValidation,\n             IndexView indexView, MethodInfo method) {\n         ClassInfo clazz = method.declaringClass();\n-        if (Modifier.isInterface(clazz.flags())) {\n-            // Remember annotated interface methods that must be validated\n-            inheritedAnnotationsToBeValidated.computeIfAbsent(clazz.name(), k -> new HashSet<>())\n-                    .add(new SimpleMethodSignatureKey(method));\n+\n+        methodsWithInheritedValidation.computeIfAbsent(clazz.name(), k -> new HashSet<>())\n+                .add(new SimpleMethodSignatureKey(method));\n+\n+        if (Modifier.isInterface(method.declaringClass().flags())) {", "originalCommit": "ef6d8b0e8c8549279a2f59f0920c6c0920b28344", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "253cf9b58a054e0d8b30dac1629bd20ac9b33146", "chunk": "diff --git a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/HibernateValidatorProcessor.java b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/HibernateValidatorProcessor.java\nindex ec2ec21cd8..cc0caaa980 100644\n--- a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/HibernateValidatorProcessor.java\n+++ b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/HibernateValidatorProcessor.java\n\n@@ -383,7 +383,7 @@ class HibernateValidatorProcessor {\n         methodsWithInheritedValidation.computeIfAbsent(clazz.name(), k -> new HashSet<>())\n                 .add(new SimpleMethodSignatureKey(method));\n \n-        if (Modifier.isInterface(method.declaringClass().flags())) {\n+        if (Modifier.isInterface(clazz.flags())) {\n             for (ClassInfo implementor : indexView.getAllKnownImplementors(clazz.name())) {\n                 methodsWithInheritedValidation.computeIfAbsent(implementor.name(), k -> new HashSet<>())\n                         .add(new SimpleMethodSignatureKey(method));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgwMTEwNA==", "url": "https://github.com/quarkusio/quarkus/pull/13529#discussion_r531801104", "bodyText": "Parameter name should also be methodsWithInheritedValidation.", "author": "famod", "createdAt": "2020-11-27T22:43:39Z", "path": "extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java", "diffHunk": "@@ -23,15 +23,15 @@\n     private static final Logger LOGGER = Logger.getLogger(MethodValidatedAnnotationsTransformer.class.getPackage().getName());\n \n     private final Set<DotName> consideredAnnotations;\n-    private final Map<DotName, Set<SimpleMethodSignatureKey>> inheritedAnnotationsToBeValidated;\n+    private final Map<DotName, Set<SimpleMethodSignatureKey>> methodsWithInheritedValidation;\n     private final Map<DotName, Set<SimpleMethodSignatureKey>> jaxRsMethods;\n \n     MethodValidatedAnnotationsTransformer(Set<DotName> consideredAnnotations,\n             Map<DotName, Set<SimpleMethodSignatureKey>> jaxRsMethods,\n             Map<DotName, Set<SimpleMethodSignatureKey>> inheritedAnnotationsToBeValidated) {", "originalCommit": "ef6d8b0e8c8549279a2f59f0920c6c0920b28344", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "253cf9b58a054e0d8b30dac1629bd20ac9b33146", "chunk": "diff --git a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\nindex 1ef41fb2d0..969dd3d3e6 100644\n--- a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\n+++ b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\n\n@@ -28,10 +28,10 @@ public class MethodValidatedAnnotationsTransformer implements AnnotationsTransfo\n \n     MethodValidatedAnnotationsTransformer(Set<DotName> consideredAnnotations,\n             Map<DotName, Set<SimpleMethodSignatureKey>> jaxRsMethods,\n-            Map<DotName, Set<SimpleMethodSignatureKey>> inheritedAnnotationsToBeValidated) {\n+            Map<DotName, Set<SimpleMethodSignatureKey>> methodsWithInheritedValidation) {\n         this.consideredAnnotations = consideredAnnotations;\n         this.jaxRsMethods = jaxRsMethods;\n-        this.methodsWithInheritedValidation = inheritedAnnotationsToBeValidated;\n+        this.methodsWithInheritedValidation = methodsWithInheritedValidation;\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgwMTI3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13529#discussion_r531801276", "bodyText": "This could be moved further down because it is only needed when validatedMethods is not null or empty.", "author": "famod", "createdAt": "2020-11-27T22:44:44Z", "path": "extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java", "diffHunk": "@@ -67,17 +67,19 @@ private boolean requiresValidation(MethodInfo method) {\n                 return true;\n             }\n         }\n+\n         // This method has no annotations of its own: look for inherited annotations\n-        ClassInfo clazz = method.declaringClass();\n         SimpleMethodSignatureKey signatureKey = new SimpleMethodSignatureKey(method);", "originalCommit": "ef6d8b0e8c8549279a2f59f0920c6c0920b28344", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "253cf9b58a054e0d8b30dac1629bd20ac9b33146", "chunk": "diff --git a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\nindex 1ef41fb2d0..969dd3d3e6 100644\n--- a/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\n+++ b/extensions/hibernate-validator/deployment/src/main/java/io/quarkus/hibernate/validator/deployment/MethodValidatedAnnotationsTransformer.java\n\n@@ -69,13 +69,14 @@ public class MethodValidatedAnnotationsTransformer implements AnnotationsTransfo\n         }\n \n         // This method has no annotations of its own: look for inherited annotations\n-        SimpleMethodSignatureKey signatureKey = new SimpleMethodSignatureKey(method);\n \n         Set<SimpleMethodSignatureKey> validatedMethods = methodsWithInheritedValidation.get(method.declaringClass().name());\n         if (validatedMethods == null || validatedMethods.isEmpty()) {\n             return false;\n         }\n \n+        SimpleMethodSignatureKey signatureKey = new SimpleMethodSignatureKey(method);\n+\n         if (validatedMethods.contains(signatureKey)) {\n             return true;\n         }\n"}}, {"oid": "253cf9b58a054e0d8b30dac1629bd20ac9b33146", "url": "https://github.com/quarkusio/quarkus/commit/253cf9b58a054e0d8b30dac1629bd20ac9b33146", "message": "Rework constrained method inheritance for Hibernate Validator extension\n\nFixes #13470", "committedDate": "2020-11-27T22:59:25Z", "type": "forcePushed"}, {"oid": "ddea520d5912e5a83614a6755df3585d93c83a1b", "url": "https://github.com/quarkusio/quarkus/commit/ddea520d5912e5a83614a6755df3585d93c83a1b", "message": "Rework constrained method inheritance for Hibernate Validator extension\n\nFixes #13470", "committedDate": "2020-11-28T11:49:26Z", "type": "commit"}, {"oid": "ddea520d5912e5a83614a6755df3585d93c83a1b", "url": "https://github.com/quarkusio/quarkus/commit/ddea520d5912e5a83614a6755df3585d93c83a1b", "message": "Rework constrained method inheritance for Hibernate Validator extension\n\nFixes #13470", "committedDate": "2020-11-28T11:49:26Z", "type": "forcePushed"}]}