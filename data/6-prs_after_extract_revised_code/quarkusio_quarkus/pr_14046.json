{"pr_number": 14046, "pr_title": "Only add json content-type when necessary", "pr_createdAt": "2020-12-24T09:10:46Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/14046", "timeline": [{"oid": "87ac924b66e7092c1243f91712ab45fe58dbfa96", "url": "https://github.com/quarkusio/quarkus/commit/87ac924b66e7092c1243f91712ab45fe58dbfa96", "message": "Only add json content-type when necessary\n\nFixes: #14045", "committedDate": "2020-12-24T09:07:29Z", "type": "commit"}, {"oid": "de22493e38dde2b463048175a2318548b67dd868", "url": "https://github.com/quarkusio/quarkus/commit/de22493e38dde2b463048175a2318548b67dd868", "message": "Take suffix of media type into account when Response is used", "committedDate": "2020-12-24T09:30:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2OTE0MQ==", "url": "https://github.com/quarkusio/quarkus/pull/14046#discussion_r551369141", "bodyText": "Pretty sure that's not how media type mapping works, as it will even match application/stef-hates-json which is not JSON at all ;)", "author": "FroMage", "createdAt": "2021-01-04T15:02:04Z", "path": "independent-projects/resteasy-reactive/server/vertx/src/main/java/org/jboss/resteasy/reactive/server/vertx/providers/serialisers/json/JsonMessageBodyWriterUtil.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.jboss.resteasy.reactive.server.vertx.providers.serialisers.json;\n+\n+import io.vertx.core.MultiMap;\n+import java.util.Map;\n+import javax.ws.rs.core.HttpHeaders;\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.MultivaluedMap;\n+import org.jboss.resteasy.reactive.server.spi.ServerRequestContext;\n+\n+public final class JsonMessageBodyWriterUtil {\n+\n+    private JsonMessageBodyWriterUtil() {\n+    }\n+\n+    public static void setContentTypeIfNecessary(MultivaluedMap<String, Object> httpHeaders) {\n+        Object contentType = httpHeaders.getFirst(HttpHeaders.CONTENT_TYPE);\n+        if (isNotJson(contentType)) {\n+            httpHeaders.putSingle(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n+        }\n+    }\n+\n+    public static void setContentTypeIfNecessary(ServerRequestContext context) {\n+        String currentContentType = null;\n+        Iterable<Map.Entry<String, String>> responseHeaders = context.serverResponse().getAllResponseHeaders();\n+        if (responseHeaders instanceof MultiMap) {\n+            currentContentType = ((MultiMap) responseHeaders).get(HttpHeaders.CONTENT_TYPE);\n+        } else {\n+            for (Map.Entry<String, String> entry : responseHeaders) {\n+                if (entry.getKey().equalsIgnoreCase(HttpHeaders.CONTENT_TYPE)) {\n+                    currentContentType = entry.getValue();\n+                    break;\n+                }\n+            }\n+        }\n+        if (isNotJson(currentContentType)) {\n+            context.serverResponse().setResponseHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON);\n+        }\n+    }\n+\n+    private static boolean isNotJson(Object contentType) {\n+        return (contentType == null) || !contentType.toString().contains(\"json\");", "originalCommit": "de22493e38dde2b463048175a2318548b67dd868", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM3MTk0Nw==", "url": "https://github.com/quarkusio/quarkus/pull/14046#discussion_r551371947", "bodyText": "Fair point. When someone comes to us with such an example, you can tell me: I told you so :)", "author": "geoand", "createdAt": "2021-01-04T15:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2OTE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4Mjk3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/14046#discussion_r551382976", "bodyText": "Sure, but just remember that media type matching doesn't work like this, we don't want to oversimplify stuff everywhere ;)", "author": "FroMage", "createdAt": "2021-01-04T15:24:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2OTE0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM4MzczOQ==", "url": "https://github.com/quarkusio/quarkus/pull/14046#discussion_r551383739", "bodyText": "Definitely.\nMade a mental note, so when this comes up, I'll know where to look :)", "author": "geoand", "createdAt": "2021-01-04T15:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTM2OTE0MQ=="}], "type": "inlineReview", "revised_code": null}]}