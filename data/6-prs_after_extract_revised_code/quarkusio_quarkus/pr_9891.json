{"pr_number": 9891, "pr_title": "OIDC JWK refresh support", "pr_createdAt": "2020-06-09T16:48:04Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9891", "timeline": [{"oid": "cb18f05d0d6e133fa66f916fdef9cd6b4ba95740", "url": "https://github.com/quarkusio/quarkus/commit/cb18f05d0d6e133fa66f916fdef9cd6b4ba95740", "message": "OIDC JWK refresh support", "committedDate": "2020-06-09T16:25:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0NjczNA==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438046734", "bodyText": "I think this should be a Duration, so our standard time based converters work.", "author": "stuartwdouglas", "createdAt": "2020-06-10T11:17:39Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java", "diffHunk": "@@ -638,6 +638,12 @@ public static Token fromAudience(String... audience) {\n         @ConfigItem\n         public boolean refreshExpired;\n \n+        /**\n+         * Forced JWK set refresh interval in minutes.\n+         */\n+        @ConfigItem(defaultValue = \"10\")\n+        public long forcedJwkRefreshInterval = 10;", "originalCommit": "cb18f05d0d6e133fa66f916fdef9cd6b4ba95740", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "chunk": "diff --git a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java\nindex af52d3cca5..055cf833a2 100644\n--- a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java\n+++ b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java\n\n@@ -641,8 +641,8 @@ public class OidcTenantConfig {\n         /**\n          * Forced JWK set refresh interval in minutes.\n          */\n-        @ConfigItem(defaultValue = \"10\")\n-        public long forcedJwkRefreshInterval = 10;\n+        @ConfigItem(defaultValue = \"10M\")\n+        public Duration forcedJwkRefreshInterval = Duration.ofMinutes(10);\n \n         public Optional<String> getIssuer() {\n             return issuer;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0ODMxOA==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438048318", "bodyText": "Wouldn't it be a lot more efficient to just use a loop? Using a regex to count the number of '.' characters in a string feels like overkill.", "author": "stuartwdouglas", "createdAt": "2020-06-10T11:20:58Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java", "diffHunk": "@@ -27,11 +29,25 @@\n      * ignoring those which are located inside a pair of the double quotes.\n      */\n     private static final Pattern CLAIM_PATH_PATTERN = Pattern.compile(\"\\\\/(?=(?:(?:[^\\\"]*\\\"){2})*[^\\\"]*$)\");\n+    private static final Pattern JWT_PARTS_PATTERN = Pattern.compile(\"\\\\.\");\n \n     private OidcUtils() {\n \n     }\n \n+    public static boolean isOpaqueToken(String token) {\n+        return JWT_PARTS_PATTERN.split(token).length != 3;", "originalCommit": "cb18f05d0d6e133fa66f916fdef9cd6b4ba95740", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEyMjIyMg==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438122222", "bodyText": "@stuartwdouglas is it what you had in mind ?", "author": "sberyozkin", "createdAt": "2020-06-10T13:29:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0ODMxOA=="}], "type": "inlineReview", "revised_code": {"commit": "e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "chunk": "diff --git a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java\nindex 24f8782a4c..514dd8c6f0 100644\n--- a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java\n+++ b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java\n\n@@ -29,22 +30,33 @@ public final class OidcUtils {\n      * ignoring those which are located inside a pair of the double quotes.\n      */\n     private static final Pattern CLAIM_PATH_PATTERN = Pattern.compile(\"\\\\/(?=(?:(?:[^\\\"]*\\\"){2})*[^\\\"]*$)\");\n-    private static final Pattern JWT_PARTS_PATTERN = Pattern.compile(\"\\\\.\");\n \n     private OidcUtils() {\n \n     }\n \n     public static boolean isOpaqueToken(String token) {\n-        return JWT_PARTS_PATTERN.split(token).length != 3;\n+        return new StringTokenizer(token, \".\").countTokens() != 3;\n     }\n \n     public static JsonObject decodeJwtContent(String jwt) {\n-        String[] parts = JWT_PARTS_PATTERN.split(jwt);\n-        if (parts.length != 3) {\n+        StringTokenizer tokens = new StringTokenizer(jwt, \".\");\n+        // part 1: skip the token headers\n+        tokens.nextToken();\n+        if (!tokens.hasMoreTokens()) {\n+            return null;\n+        }\n+        // part 2: token content\n+        String encodedContent = tokens.nextToken();\n+\n+        // lets check only 1 more signature part is available\n+        if (tokens.countTokens() != 1) {\n+            return null;\n+        }\n+        try {\n+            return new JsonObject(new String(Base64.getUrlDecoder().decode(encodedContent), StandardCharsets.UTF_8));\n+        } catch (IllegalArgumentException ex) {\n             return null;\n-        } else {\n-            return new JsonObject(new String(Base64.getUrlDecoder().decode(parts[1]), StandardCharsets.UTF_8));\n         }\n     }\n \n"}}, {"oid": "e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "url": "https://github.com/quarkusio/quarkus/commit/e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "message": "Minor optimizations", "committedDate": "2020-06-10T13:26:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEzMjc5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438132795", "bodyText": "I'm not sure if it is a good idea to log the state value considering it is used in OAuth2 to prevent CSRF.", "author": "pedroigor", "createdAt": "2020-06-10T13:44:15Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -193,7 +193,8 @@ public SecurityIdentity apply(Throwable throwable) {\n                 LOG.debug(\"State parameter can not be empty or multi-valued\");\n                 return Uni.createFrom().failure(new AuthenticationCompletionException());\n             } else if (!stateCookie.getValue().startsWith(values.get(0))) {\n-                LOG.debug(\"State cookie does not match the state parameter\");\n+                LOG.debugf(\"State cookie value '%s' does not match the state query parameter value '%s'\",", "originalCommit": "e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5MDU3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438190572", "bodyText": "@pedroigor I just added it because the user was getting this error, but I suppose seeing 2 different uuids in the logs won't help the users to figure out why it happened :-). OK, let me revert it", "author": "sberyozkin", "createdAt": "2020-06-10T14:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEzMjc5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "dcc41479459bf7721aa2109061441dceea0c0ceb", "chunk": "diff --git a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java\nindex ce536c0f6d..2a49897af3 100644\n--- a/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java\n+++ b/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java\n\n@@ -193,8 +193,7 @@ public class CodeAuthenticationMechanism extends AbstractOidcAuthenticationMecha\n                 LOG.debug(\"State parameter can not be empty or multi-valued\");\n                 return Uni.createFrom().failure(new AuthenticationCompletionException());\n             } else if (!stateCookie.getValue().startsWith(values.get(0))) {\n-                LOG.debugf(\"State cookie value '%s' does not match the state query parameter value '%s'\",\n-                        stateCookie.getValue(), values.get(0));\n+                LOG.debug(\"State cookie value does not match the state query parameter value\");\n                 return Uni.createFrom().failure(new AuthenticationCompletionException());\n             } else if (context.queryParam(\"pathChecked\").isEmpty()) {\n                 // This is an original redirect from IDP, check if the request path needs to be updated\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE0MjgyMA==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438142820", "bodyText": "A minor comment. Right now we only support JWS, but JWE uses 5 tokens.\nBut I guess we would handle JWEs as opaque tokens considering that you would need an introspection call to check claims.", "author": "pedroigor", "createdAt": "2020-06-10T13:57:38Z", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcUtils.java", "diffHunk": "@@ -32,6 +35,31 @@ private OidcUtils() {\n \n     }\n \n+    public static boolean isOpaqueToken(String token) {\n+        return new StringTokenizer(token, \".\").countTokens() != 3;", "originalCommit": "e6d153a6f2ea0ad644e33a715aaeee35a0760a93", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE4ODE4OA==", "url": "https://github.com/quarkusio/quarkus/pull/9891#discussion_r438188188", "bodyText": "@pedroigor Right, at the moment no local JWE decryption is possible, so they are technically opaque for Quarkus", "author": "sberyozkin", "createdAt": "2020-06-10T14:55:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE0MjgyMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "dcc41479459bf7721aa2109061441dceea0c0ceb", "url": "https://github.com/quarkusio/quarkus/commit/dcc41479459bf7721aa2109061441dceea0c0ceb", "message": "Revert logging the state values", "committedDate": "2020-06-10T15:21:06Z", "type": "commit"}]}