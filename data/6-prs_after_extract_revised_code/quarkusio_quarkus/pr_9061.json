{"pr_number": 9061, "pr_title": "Support Spring Controllers throwing ResponseStatusException", "pr_createdAt": "2020-05-04T17:42:08Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9061", "timeline": [{"oid": "7f7b4facd5e0b0a7b98dd57325b86283323c7f15", "url": "https://github.com/quarkusio/quarkus/commit/7f7b4facd5e0b0a7b98dd57325b86283323c7f15", "message": "Support Spring Controllers throwing ResponseStatusException\n\nFixes: #9055", "committedDate": "2020-05-04T18:35:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0NDYyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/9061#discussion_r419644625", "bodyText": "Does Spring always send text/plain? I would expect it to be clever than that.", "author": "gsmet", "createdAt": "2020-05-04T18:37:01Z", "path": "extensions/spring-web/runtime/src/main/java/io/quarkus/spring/web/runtime/ResponseStatusExceptionMapper.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package io.quarkus.spring.web.runtime;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.ws.rs.core.MediaType;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.ext.ExceptionMapper;\n+\n+import org.jboss.resteasy.specimpl.ResponseBuilderImpl;\n+import org.springframework.http.HttpHeaders;\n+import org.springframework.web.server.ResponseStatusException;\n+\n+public class ResponseStatusExceptionMapper implements ExceptionMapper<ResponseStatusException> {\n+\n+    @Override\n+    public Response toResponse(ResponseStatusException exception) {\n+        Response.ResponseBuilder responseBuilder = new ResponseBuilderImpl().status(exception.getStatus().value());\n+        addHeaders(responseBuilder, exception.getResponseHeaders());\n+        return responseBuilder.entity(exception.getMessage())\n+                .type(MediaType.TEXT_PLAIN).build();", "originalCommit": "7f7b4facd5e0b0a7b98dd57325b86283323c7f15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0NTg1MA==", "url": "https://github.com/quarkusio/quarkus/pull/9061#discussion_r419645850", "bodyText": "Fair point, but we have been using text/plain for exceptions annotated with @ResponseStatus (which is very similar to this) and we haven't had anyone complain so far.\nWe can certainly reexamine this on a grander scale if it becomes a problem.", "author": "geoand", "createdAt": "2020-05-04T18:39:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0NDYyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "bd2c5bd2139a0d9986dc64286fb487209f42f842", "chunk": "diff --git a/extensions/spring-web/runtime/src/main/java/io/quarkus/spring/web/runtime/ResponseStatusExceptionMapper.java b/extensions/spring-web/runtime/src/main/java/io/quarkus/spring/web/runtime/ResponseStatusExceptionMapper.java\nindex 0c25cb09c3..2a3f11e997 100644\n--- a/extensions/spring-web/runtime/src/main/java/io/quarkus/spring/web/runtime/ResponseStatusExceptionMapper.java\n+++ b/extensions/spring-web/runtime/src/main/java/io/quarkus/spring/web/runtime/ResponseStatusExceptionMapper.java\n\n@@ -22,9 +22,8 @@ public class ResponseStatusExceptionMapper implements ExceptionMapper<ResponseSt\n     }\n \n     private void addHeaders(Response.ResponseBuilder responseBuilder, HttpHeaders springHeaders) {\n-        for (Map.Entry<String, List<Object>> entry : ResponseEntityConverter.toJaxRsHeaders(springHeaders)\n-                .entrySet()) {\n-            for (Object headerValue : entry.getValue()) {\n+        for (Map.Entry<String, List<String>> entry : springHeaders.entrySet()) {\n+            for (String headerValue : entry.getValue()) {\n                 responseBuilder.header(entry.getKey(), headerValue);\n             }\n         }\n"}}, {"oid": "bd2c5bd2139a0d9986dc64286fb487209f42f842", "url": "https://github.com/quarkusio/quarkus/commit/bd2c5bd2139a0d9986dc64286fb487209f42f842", "message": "Support Spring Controllers throwing ResponseStatusException\n\nFixes: #9055", "committedDate": "2020-05-04T18:37:12Z", "type": "forcePushed"}, {"oid": "aae3bf1deff84d6761ea666e7ee64d6125e274e3", "url": "https://github.com/quarkusio/quarkus/commit/aae3bf1deff84d6761ea666e7ee64d6125e274e3", "message": "Bump Spring Web API version", "committedDate": "2020-05-05T06:02:07Z", "type": "commit"}, {"oid": "ed94b770bb1623ddb5dd6ba20ebcbf91d1b1c6ae", "url": "https://github.com/quarkusio/quarkus/commit/ed94b770bb1623ddb5dd6ba20ebcbf91d1b1c6ae", "message": "Support Spring Controllers throwing ResponseStatusException\n\nFixes: #9055", "committedDate": "2020-05-05T06:02:07Z", "type": "commit"}, {"oid": "ed94b770bb1623ddb5dd6ba20ebcbf91d1b1c6ae", "url": "https://github.com/quarkusio/quarkus/commit/ed94b770bb1623ddb5dd6ba20ebcbf91d1b1c6ae", "message": "Support Spring Controllers throwing ResponseStatusException\n\nFixes: #9055", "committedDate": "2020-05-05T06:02:07Z", "type": "forcePushed"}]}