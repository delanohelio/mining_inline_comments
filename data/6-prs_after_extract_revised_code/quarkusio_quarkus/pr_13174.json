{"pr_number": 13174, "pr_title": "Handle gradle multiple source directories in test extension", "pr_createdAt": "2020-11-08T14:02:28Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13174", "timeline": [{"oid": "9a17a0236c2a7899c2c78477bbeb2e82ecf91fd9", "url": "https://github.com/quarkusio/quarkus/commit/9a17a0236c2a7899c2c78477bbeb2e82ecf91fd9", "message": "Handle gradle mutliple source directories in test extension", "committedDate": "2020-11-09T08:02:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyNzExNA==", "url": "https://github.com/quarkusio/quarkus/pull/13174#discussion_r519627114", "bodyText": "If a project has only one output test dir, wouldn't this dir be added twice? I.e. through this property and the default test dir that would have been added w/o this code?", "author": "aloubyansky", "createdAt": "2020-11-09T08:26:21Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java", "diffHunk": "@@ -195,7 +198,21 @@ private ExtensionState doJavaStart(ExtensionContext context, Class<? extends Qua\n \n             // If gradle project running directly with IDE\n             if (System.getProperty(BootstrapConstants.SERIALIZED_APP_MODEL) == null) {\n-                BuildToolHelper.enableGradleAppModelForTest(projectRoot);\n+                QuarkusModel model = BuildToolHelper.enableGradleAppModelForTest(projectRoot);\n+                final Set<File> classDirectories = model.getWorkspace().getMainModule().getSourceSet().getSourceDirectories();\n+                for (File classes : classDirectories) {\n+                    if (!rootBuilder.contains(classes.toPath())) {\n+                        rootBuilder.add(classes.toPath());\n+                    }\n+                }\n+            } else if (System.getProperty(BootstrapConstants.OUTPUT_SOURCES_DIR) != null) {\n+                final String[] sourceDirectories = System.getProperty(BootstrapConstants.OUTPUT_SOURCES_DIR).split(\",\");", "originalCommit": "9a17a0236c2a7899c2c78477bbeb2e82ecf91fd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY1OTE4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13174#discussion_r519659185", "bodyText": "I check if the directory is already in the rootBuilder before adding it in order to avoid duplicate", "author": "glefloch", "createdAt": "2020-11-09T09:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyNzExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwNjAzMQ==", "url": "https://github.com/quarkusio/quarkus/pull/13174#discussion_r520706031", "bodyText": "Yes, that's ok.\nHowever, could you remind me why we did BuildToolHelper.enableGradleAppModelForTest(projectRoot)? Is this to support IDEs?", "author": "aloubyansky", "createdAt": "2020-11-10T16:39:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyNzExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwOTYyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13174#discussion_r520709625", "bodyText": "BuildToolHelper.enableGradleAppModelForTest(projectRoot) is already checking whether it's a gradle project, btw.", "author": "aloubyansky", "createdAt": "2020-11-10T16:44:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyNzExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc0MTgyNw==", "url": "https://github.com/quarkusio/quarkus/pull/13174#discussion_r520741827", "bodyText": "Yes exactly if you come from the IDE the model has not been serialized yet. This is why there is those two similar blocks.\nI added the check in the if because the BuildToolHelper.enableGradleAppModelForTest(projectRoot) returns null if it's not a Gradle project. You are right, it's better to check if the returned model is not null rather than checking if this a Gradle project (as the method recursively look for a build file). I will update the code", "author": "glefloch", "createdAt": "2020-11-10T17:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYyNzExNA=="}], "type": "inlineReview", "revised_code": {"commit": "757e43a6ac85f2f806fbfa6d45dde9824f9aee7e", "chunk": "diff --git a/test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java b/test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java\nindex be7d2dafad..e63b02b23c 100644\n--- a/test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java\n+++ b/test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java\n\n@@ -197,7 +197,8 @@ public class QuarkusTestExtension\n             }\n \n             // If gradle project running directly with IDE\n-            if (System.getProperty(BootstrapConstants.SERIALIZED_APP_MODEL) == null) {\n+            if (BuildToolHelper.isGradleProject(projectRoot)\n+                    && System.getProperty(BootstrapConstants.SERIALIZED_APP_MODEL) == null) {\n                 QuarkusModel model = BuildToolHelper.enableGradleAppModelForTest(projectRoot);\n                 final Set<File> classDirectories = model.getWorkspace().getMainModule().getSourceSet().getSourceDirectories();\n                 for (File classes : classDirectories) {\n"}}, {"oid": "757e43a6ac85f2f806fbfa6d45dde9824f9aee7e", "url": "https://github.com/quarkusio/quarkus/commit/757e43a6ac85f2f806fbfa6d45dde9824f9aee7e", "message": "Handle gradle mutliple source directories in test extension", "committedDate": "2020-11-09T16:41:22Z", "type": "forcePushed"}, {"oid": "d15556421304a87957d071f54a70fd3742efa683", "url": "https://github.com/quarkusio/quarkus/commit/d15556421304a87957d071f54a70fd3742efa683", "message": "Handle gradle mutliple source directories in test extension", "committedDate": "2020-11-10T08:37:33Z", "type": "forcePushed"}, {"oid": "dfc9e32aa2ca5f128c4d334361c6094283ccbb3d", "url": "https://github.com/quarkusio/quarkus/commit/dfc9e32aa2ca5f128c4d334361c6094283ccbb3d", "message": "Handle gradle mutliple source directories in test extension", "committedDate": "2020-11-10T19:22:44Z", "type": "commit"}, {"oid": "dfc9e32aa2ca5f128c4d334361c6094283ccbb3d", "url": "https://github.com/quarkusio/quarkus/commit/dfc9e32aa2ca5f128c4d334361c6094283ccbb3d", "message": "Handle gradle mutliple source directories in test extension", "committedDate": "2020-11-10T19:22:44Z", "type": "forcePushed"}]}