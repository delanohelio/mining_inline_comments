{"pr_number": 12828, "pr_title": "Use buildtool build command in Dockerfile documentation", "pr_createdAt": "2020-10-20T14:02:22Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12828", "timeline": [{"oid": "9096045a31392ccf9f7b037aa203e0cfd34956c7", "url": "https://github.com/quarkusio/quarkus/commit/9096045a31392ccf9f7b037aa203e0cfd34956c7", "message": "Use buildtool build command in Dockerfile documentation", "committedDate": "2020-10-20T15:13:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508658881", "bodyText": "Why this check was removed?", "author": "gastaldi", "createdAt": "2020-10-20T16:11:39Z", "path": "integration-tests/devtools/src/test/java/io/quarkus/devtools/codestarts/QuarkusCodestartGenerationTest.java", "diffHunk": "@@ -519,13 +519,11 @@ private void checkNoExample(Path projectDir) {\n     private void checkDockerfiles(Path projectDir) {\n         assertThat(projectDir.resolve(\".dockerignore\")).exists();\n         assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.jvm\")).exists()\n-                .satisfies(checkContains(\"mvn package\"))", "originalCommit": "9096045a31392ccf9f7b037aa203e0cfd34956c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY2MDIzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508660235", "bodyText": "Good catch!", "author": "ia3andy", "createdAt": "2020-10-20T16:13:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY2MDgyMA==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508660820", "bodyText": "ah because it depends on the buildtool now :)", "author": "ia3andy", "createdAt": "2020-10-20T16:13:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY2NDQxNw==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508664417", "bodyText": "In this case, the checkDockerfiles should have an extra parameter for the expected build tool command. I think it's nice to still have that check", "author": "gastaldi", "createdAt": "2020-10-20T16:17:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY2NjY0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508666643", "bodyText": "+1 yeah I guess it should be fairly easy", "author": "ia3andy", "createdAt": "2020-10-20T16:20:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5ODgzOA==", "url": "https://github.com/quarkusio/quarkus/pull/12828#discussion_r508698838", "bodyText": "Yes you are right, I will add checks depending on the buildtool", "author": "glefloch", "createdAt": "2020-10-20T17:10:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1ODg4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a0fcba85d3308eddec2871c65667d703a499f69f", "chunk": "diff --git a/integration-tests/devtools/src/test/java/io/quarkus/devtools/codestarts/QuarkusCodestartGenerationTest.java b/integration-tests/devtools/src/test/java/io/quarkus/devtools/codestarts/QuarkusCodestartGenerationTest.java\nindex 54c4ae2004..a2559a80a1 100644\n--- a/integration-tests/devtools/src/test/java/io/quarkus/devtools/codestarts/QuarkusCodestartGenerationTest.java\n+++ b/integration-tests/devtools/src/test/java/io/quarkus/devtools/codestarts/QuarkusCodestartGenerationTest.java\n\n@@ -516,19 +516,56 @@ class QuarkusCodestartGenerationTest extends PlatformAwareTestBase {\n         assertThat(projectDir.resolve(\"src/main/scala\")).doesNotExist();\n     }\n \n-    private void checkDockerfiles(Path projectDir) {\n+    private void checkDockerfiles(Path projectDir, BuildTool buildTool) {\n+        switch (buildTool) {\n+            case MAVEN:\n+                checkDockerfilesWithMaven(projectDir);\n+                break;\n+            case GRADLE_KOTLIN_DSL:\n+            case GRADLE:\n+                checkDockerfilesWithGradle(projectDir);\n+                break;\n+            default:\n+                throw new IllegalArgumentException(\"Unhandled buildtool\");\n+        }\n+    }\n+\n+    private void checkDockerfilesWithMaven(Path projectDir) {\n+        assertThat(projectDir.resolve(\".dockerignore\")).exists();\n+        assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.jvm\")).exists()\n+                .satisfies(checkContains(\"./mvnw package\"))\n+                .satisfies(checkContains(\"docker build -f src/main/docker/Dockerfile.jvm\"))\n+                .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n+                .satisfies(checkContains(\"ARG JAVA_PACKAGE=java-11-openjdk-headless\"))\n+                .satisfies(checkContains(\"ENTRYPOINT [ \\\"/deployments/run-java.sh\\\" ]\"));\n+        assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.fast-jar\")).exists()\n+                .satisfies(checkContains(\"./mvnw package -Dquarkus.package.type=fast-jar\"))\n+                .satisfies(checkContains(\"docker build -f src/main/docker/Dockerfile.fast-jar\"))\n+                .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n+                .satisfies(checkContains(\"ARG JAVA_PACKAGE=java-11-openjdk-headless\"))\n+                .satisfies(checkContains(\"ENTRYPOINT [ \\\"/deployments/run-java.sh\\\" ]\"));\n+        assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.native\")).exists()\n+                .satisfies(checkContains(\"./mvnw package -Pnative\"))\n+                .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n+                .satisfies(checkContains(\"CMD [\\\"./application\\\", \\\"-Dquarkus.http.host=0.0.0.0\\\"]\"));\n+    }\n+\n+    private void checkDockerfilesWithGradle(Path projectDir) {\n         assertThat(projectDir.resolve(\".dockerignore\")).exists();\n         assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.jvm\")).exists()\n+                .satisfies(checkContains(\"./gradlew build\"))\n                 .satisfies(checkContains(\"docker build -f src/main/docker/Dockerfile.jvm\"))\n                 .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n                 .satisfies(checkContains(\"ARG JAVA_PACKAGE=java-11-openjdk-headless\"))\n                 .satisfies(checkContains(\"ENTRYPOINT [ \\\"/deployments/run-java.sh\\\" ]\"));\n         assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.fast-jar\")).exists()\n+                .satisfies(checkContains(\"./gradlew build -Dquarkus.package.type=fast-jar\"))\n                 .satisfies(checkContains(\"docker build -f src/main/docker/Dockerfile.fast-jar\"))\n                 .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n                 .satisfies(checkContains(\"ARG JAVA_PACKAGE=java-11-openjdk-headless\"))\n                 .satisfies(checkContains(\"ENTRYPOINT [ \\\"/deployments/run-java.sh\\\" ]\"));\n         assertThat(projectDir.resolve(\"src/main/docker/Dockerfile.native\")).exists()\n+                .satisfies(checkContains(\"./gradlew build -Dquarkus.package.type=native\"))\n                 .satisfies(checkContains(\"registry.access.redhat.com/ubi8/ubi-minimal:8.1\"))\n                 .satisfies(checkContains(\"CMD [\\\"./application\\\", \\\"-Dquarkus.http.host=0.0.0.0\\\"]\"));\n     }\n"}}, {"oid": "a0fcba85d3308eddec2871c65667d703a499f69f", "url": "https://github.com/quarkusio/quarkus/commit/a0fcba85d3308eddec2871c65667d703a499f69f", "message": "Use buildtool build command in Dockerfile documentation", "committedDate": "2020-10-20T18:13:38Z", "type": "commit"}, {"oid": "a0fcba85d3308eddec2871c65667d703a499f69f", "url": "https://github.com/quarkusio/quarkus/commit/a0fcba85d3308eddec2871c65667d703a499f69f", "message": "Use buildtool build command in Dockerfile documentation", "committedDate": "2020-10-20T18:13:38Z", "type": "forcePushed"}]}