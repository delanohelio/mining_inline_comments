{"pr_number": 13561, "pr_title": "Add @JsonView support to quarkus-resteasy-reactive-jackson", "pr_createdAt": "2020-11-30T12:41:10Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13561", "timeline": [{"oid": "83c796e441d3b97a6be7015efcbac924e8e4e752", "url": "https://github.com/quarkusio/quarkus/commit/83c796e441d3b97a6be7015efcbac924e8e4e752", "message": "Add @JsonView support to quarkus-resteasy-reactive-jackson", "committedDate": "2020-11-30T12:46:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532612426", "bodyText": "Should the view class be added for reflection?\nI don't see us doing it in the quarkus-jackson extension and it looks like reflection could be used by Jackson, right?", "author": "gsmet", "createdAt": "2020-11-30T13:54:18Z", "path": "extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/test/java/io/quarkus/resteasy/reactive/jackson/deployment/test/SimpleJsonResource.java", "diffHunk": "@@ -81,4 +83,30 @@ public void run() {\n         }).start();\n     }\n \n+    @GET\n+    @Path(\"/user-without-view\")\n+    public User userWithoutView() {\n+        return testUser();\n+    }\n+\n+    @JsonView(Views.Public.class)", "originalCommit": "83c796e441d3b97a6be7015efcbac924e8e4e752", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjkzNg==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532612936", "bodyText": "I'll check and see if it's needed", "author": "geoand", "createdAt": "2020-11-30T13:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyMjY5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532622692", "bodyText": "I just tried it in native and it works without registering anything from reflection", "author": "geoand", "createdAt": "2020-11-30T14:09:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyNjAyNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532626025", "bodyText": "Hmmm. How does it work? It's not using reflection?", "author": "gsmet", "createdAt": "2020-11-30T14:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyODYxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532628615", "bodyText": "Let me try something. I might have messed up my test", "author": "geoand", "createdAt": "2020-11-30T14:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYzMzQyNg==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532633426", "bodyText": "Indeed it fails if I actually perform a proper test. I'll fix it.", "author": "geoand", "createdAt": "2020-11-30T14:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjcyNjg5NA==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532726894", "bodyText": "Properly fixed", "author": "geoand", "createdAt": "2020-11-30T16:27:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjQyNg=="}], "type": "inlineReview", "revised_code": {"commit": "eaed59788d6f38ac12812b71c0404c784299deac", "chunk": "diff --git a/extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/test/java/io/quarkus/resteasy/reactive/jackson/deployment/test/SimpleJsonResource.java b/extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/test/java/io/quarkus/resteasy/reactive/jackson/deployment/test/SimpleJsonResource.java\nindex 08cc8270ab..15fcc16ac4 100644\n--- a/extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/test/java/io/quarkus/resteasy/reactive/jackson/deployment/test/SimpleJsonResource.java\n+++ b/extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/test/java/io/quarkus/resteasy/reactive/jackson/deployment/test/SimpleJsonResource.java\n\n@@ -83,30 +81,4 @@ public class SimpleJsonResource {\n         }).start();\n     }\n \n-    @GET\n-    @Path(\"/user-without-view\")\n-    public User userWithoutView() {\n-        return testUser();\n-    }\n-\n-    @JsonView(Views.Public.class)\n-    @GET\n-    @Path(\"/user-with-public-view\")\n-    public User userWithPublicView() {\n-        return testUser();\n-    }\n-\n-    @JsonView(Views.Private.class)\n-    @GET\n-    @Path(\"/user-with-private-view\")\n-    public User userWithPrivateView() {\n-        return testUser();\n-    }\n-\n-    private User testUser() {\n-        User user = new User();\n-        user.id = 1;\n-        user.name = \"test\";\n-        return user;\n-    }\n }\n"}}, {"oid": "eaed59788d6f38ac12812b71c0404c784299deac", "url": "https://github.com/quarkusio/quarkus/commit/eaed59788d6f38ac12812b71c0404c784299deac", "message": "Add proper reflection registration for RESTEasy Reactive", "committedDate": "2020-11-30T16:27:00Z", "type": "commit"}, {"oid": "975f0b7a3ac3cebe8527cac1974bb124dcab1b4d", "url": "https://github.com/quarkusio/quarkus/commit/975f0b7a3ac3cebe8527cac1974bb124dcab1b4d", "message": "Add @JsonView support to quarkus-resteasy-reactive-jackson", "committedDate": "2020-11-30T16:27:00Z", "type": "commit"}, {"oid": "975f0b7a3ac3cebe8527cac1974bb124dcab1b4d", "url": "https://github.com/quarkusio/quarkus/commit/975f0b7a3ac3cebe8527cac1974bb124dcab1b4d", "message": "Add @JsonView support to quarkus-resteasy-reactive-jackson", "committedDate": "2020-11-30T16:27:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532730766", "bodyText": "Sorry to be that guy but shouldn't we do this in the quarkus-jackson extension given it's a generic Jackson annotation?\nIt could be used in other extensions then.\nAnd I would do it for all @JsonView annotations in the classpath.", "author": "gsmet", "createdAt": "2020-11-30T16:32:30Z", "path": "extensions/resteasy-reactive/quarkus-resteasy-reactive-jackson/deployment/src/main/java/io/quarkus/resteasy/reactive/jackson/deployment/processor/ResteasyReactiveJacksonProcessor.java", "diffHunk": "@@ -38,4 +51,24 @@ void additionalProviders(BuildProducer<AdditionalBeanBuildItem> additionalBean,\n                 .produce(new MessageBodyWriterBuildItem(JacksonMessageBodyWriter.class.getName(), Object.class.getName(),\n                         Collections.singletonList(MediaType.APPLICATION_JSON)));\n     }\n+\n+    @BuildStep\n+    void registerForReflection(Optional<ResourceScanningResultBuildItem> resourceScanningResultBuildItem,\n+            BuildProducer<ReflectiveClassBuildItem> reflectiveClass) {\n+        if (!resourceScanningResultBuildItem.isPresent()) {\n+            return;\n+        }\n+\n+        Collection<ClassInfo> resourceClasses = resourceScanningResultBuildItem.get().getScannedResources().values();\n+        Set<String> classesNeedingReflectionOnMethods = new HashSet<>();\n+        for (ClassInfo resourceClass : resourceClasses) {\n+            if (resourceClass.annotations().containsKey(JSON_VIEW)) {\n+                classesNeedingReflectionOnMethods.add(resourceClass.name().toString());", "originalCommit": "975f0b7a3ac3cebe8527cac1974bb124dcab1b4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMjY4NQ==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532732685", "bodyText": "No, because this reflection is only needed in order to make resteasy-reactive work. Normally RESTEasy reactive does not have to perform reflection on the resource method, but in this case (and in other that we will surely find later on) it does.\nThat means that this reflection is resteasy-reactive specific, not Jackson specific.", "author": "geoand", "createdAt": "2020-11-30T16:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNDc3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532734776", "bodyText": "Maybe I'm missing something but if we do need reflection for the class referenced in JsonView, I think it's a general requirement.\nI'm not sure though if you added reflection for that?", "author": "gsmet", "createdAt": "2020-11-30T16:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczNjE1MA==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532736150", "bodyText": "We are not doing reflection for the class referenced in the annotation, but for the class that contains the resource method in question.\nPerhaps the variables names are not clear enough?", "author": "geoand", "createdAt": "2020-11-30T16:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2MjY2OA==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532762668", "bodyText": "They are clear but I'm still puzzled on how it can work without having the class in @JsonView registered for reflection.", "author": "gsmet", "createdAt": "2020-11-30T17:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc2NDY0OA==", "url": "https://github.com/quarkusio/quarkus/pull/13561#discussion_r532764648", "bodyText": "Why do you think the value needs to be registered? Jackson almost certainly doesn't need to do any reflection on this class. It probably just has to call isAssignable on the class", "author": "geoand", "createdAt": "2020-11-30T17:18:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjczMDc2Ng=="}], "type": "inlineReview", "revised_code": null}]}