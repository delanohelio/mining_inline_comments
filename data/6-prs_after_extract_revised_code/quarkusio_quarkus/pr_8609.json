{"pr_number": 8609, "pr_title": "Make Jaeger metrics more consistent with other extensions", "pr_createdAt": "2020-04-16T06:25:24Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8609", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NzgxMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409357811", "bodyText": "I'm pretty sure I've changed this code yesterday, you might want to rebase. (Wonder why GitHub doesn't complain...?)", "author": "Ladicek", "createdAt": "2020-04-16T08:00:18Z", "path": "extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java", "diffHunk": "@@ -22,13 +28,17 @@\n     @BuildStep\n     @Record(ExecutionTime.RUNTIME_INIT)\n     void setupTracer(JaegerDeploymentRecorder jdr, JaegerBuildTimeConfig buildTimeConfig, JaegerConfig jaeger,\n-            ApplicationConfig appConfig, Capabilities capabilities) {\n+            ApplicationConfig appConfig, Capabilities capabilities, BuildProducer<MetricBuildItem> metricProducer) {\n \n         // Indicates that this extension would like the SSL support to be enabled\n         extensionSslNativeSupport.produce(new ExtensionSslNativeSupportBuildItem(FeatureBuildItem.JAEGER));\n \n         if (buildTimeConfig.enabled) {\n-            boolean metricsEnabled = capabilities.isCapabilityPresent(Capabilities.METRICS);\n+            boolean metricsEnabled = capabilities.isCapabilityPresent(Capabilities.METRICS)\n+                    && buildTimeConfig.metricsEnabled;\n+            if (metricsEnabled) {", "originalCommit": "2a5b5765bce465357979934a3d88f8e6b938fb3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5MTU5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409391599", "bodyText": "Git was able to handle the rebase itself, but the code after rebase was ugly (two if(metricsEnabled) conditions after each other), so I fixed it up a bit", "author": "jmartisk", "createdAt": "2020-04-16T08:53:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NzgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5NjczNg==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409396736", "bodyText": "You don't need this first if then, right? It seems duplicate.", "author": "Ladicek", "createdAt": "2020-04-16T09:01:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NzgxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQyNjExNg==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409426116", "bodyText": "Hmm, yeah, seems I managed to mess it up. Fixed, thanks for noticing :D", "author": "jmartisk", "createdAt": "2020-04-16T09:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NzgxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b536c7aea2d31f9f8af6a92d864e7e40b282f3a6", "chunk": "diff --git a/extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java b/extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java\nindex d6fc8377ef..fc48b73e46 100644\n--- a/extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java\n+++ b/extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java\n\n@@ -40,7 +40,12 @@ public class JaegerProcessor {\n                 produceMetrics(metricProducer);\n             }\n \n-            jdr.registerTracer(jaeger, appConfig, metricsEnabled);\n+            if (metricsEnabled) {\n+                produceMetrics(metricProducer);\n+                jdr.registerTracerWithMetrics(jaeger, appConfig);\n+            } else {\n+                jdr.registerTracerWithoutMetrics(jaeger, appConfig);\n+            }\n         }\n     }\n \n"}}, {"oid": "b536c7aea2d31f9f8af6a92d864e7e40b282f3a6", "url": "https://github.com/quarkusio/quarkus/commit/b536c7aea2d31f9f8af6a92d864e7e40b282f3a6", "message": "Test for Jaeger metrics registration", "committedDate": "2020-04-16T08:53:00Z", "type": "forcePushed"}, {"oid": "5187153ad3e90e1083961ac069ff7150f7fa82f2", "url": "https://github.com/quarkusio/quarkus/commit/5187153ad3e90e1083961ac069ff7150f7fa82f2", "message": "Config property to enable Jaeger metrics", "committedDate": "2020-04-16T09:45:54Z", "type": "commit"}, {"oid": "21fa5fa1489eacb468a81e26f4005f1c577e682e", "url": "https://github.com/quarkusio/quarkus/commit/21fa5fa1489eacb468a81e26f4005f1c577e682e", "message": "Use smallrye-metrics-spi to eagerly register metrics", "committedDate": "2020-04-16T09:45:55Z", "type": "commit"}, {"oid": "e4fbdbbd5e22d0ba571ab1a608a42a3b503480fe", "url": "https://github.com/quarkusio/quarkus/commit/e4fbdbbd5e22d0ba571ab1a608a42a3b503480fe", "message": "Test for Jaeger metrics registration", "committedDate": "2020-04-16T09:45:55Z", "type": "commit"}, {"oid": "e4fbdbbd5e22d0ba571ab1a608a42a3b503480fe", "url": "https://github.com/quarkusio/quarkus/commit/e4fbdbbd5e22d0ba571ab1a608a42a3b503480fe", "message": "Test for Jaeger metrics registration", "committedDate": "2020-04-16T09:45:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409438335", "bodyText": "Is there any test that checks that these metrics are actually reported by Jaeger and alternatively also report that new metrics are reported by Jaeger client?", "author": "pavolloffay", "createdAt": "2020-04-16T10:07:06Z", "path": "extensions/jaeger/deployment/src/main/java/io/quarkus/jaeger/deployment/JaegerProcessor.java", "diffHunk": "@@ -43,4 +50,51 @@ public void build(BuildProducer<FeatureBuildItem> feature) {\n         feature.produce(new FeatureBuildItem(FeatureBuildItem.JAEGER));\n     }\n \n+    private void produceMetrics(BuildProducer<MetricBuildItem> producer) {", "originalCommit": "e4fbdbbd5e22d0ba571ab1a608a42a3b503480fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0Nzk4OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409447989", "bodyText": "None that I'm aware of, Jaeger tests in Quarkus codebase are extremely basic because they don't spin up an actual Jaeger instance so there's not much that we can actually test... That would need a wholly new test suite I think.", "author": "jmartisk", "createdAt": "2020-04-16T10:23:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ1MDEwMA==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r409450100", "bodyText": "We could probably use testcontainers for that - we do use it in some places.", "author": "geoand", "createdAt": "2020-04-16T10:27:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIyNjI2NA==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r410226264", "bodyText": "I thought that these metrics were reported by the Jaeger client not the server.\nThis article might help to test jaeger with test containers https://medium.com/jaegertracing/generating-jaeger-grpc-services-and-using-jaeger-in-junit-with-testcontainers-ac08a6e4e1c", "author": "pavolloffay", "createdAt": "2020-04-17T13:35:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEyMzgxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r411123815", "bodyText": "The metrics are computed by the client, but they seem to be updated after succesfully reporting the related data to the server, so if there's no server connection, then the generated metrics don't make much sense (for example, the counter of finished spans seems to be incremented once that span is reported to the server).", "author": "jmartisk", "createdAt": "2020-04-20T06:26:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1MDI3OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8609#discussion_r411150279", "bodyText": "I reported #8680 for the new tests so we don't forget about it", "author": "jmartisk", "createdAt": "2020-04-20T07:20:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQzODMzNQ=="}], "type": "inlineReview", "revised_code": null}]}