{"pr_number": 13154, "pr_title": "Support @TestProfile in native mode #12974", "pr_createdAt": "2020-11-06T13:04:08Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13154", "timeline": [{"oid": "8399489368c5ac340d6038d1a68a6e247fe0c957", "url": "https://github.com/quarkusio/quarkus/commit/8399489368c5ac340d6038d1a68a6e247fe0c957", "message": "Support @TestProfile in native mode #12974", "committedDate": "2020-11-06T16:27:11Z", "type": "forcePushed"}, {"oid": "9aa9f869a616e2ef700b59d6e71ebb30abd68dcc", "url": "https://github.com/quarkusio/quarkus/commit/9aa9f869a616e2ef700b59d6e71ebb30abd68dcc", "message": "Support @TestProfile in native mode #12974", "committedDate": "2020-11-25T11:16:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxMzgyNw==", "url": "https://github.com/quarkusio/quarkus/pull/13154#discussion_r530813827", "bodyText": "I don't think this can be supported as it is a build time property only", "author": "geoand", "createdAt": "2020-11-26T07:14:34Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/NativeTestExtension.java", "diffHunk": "@@ -112,26 +82,117 @@ private void ensureNoInjectAnnotationIsUsed(Class<?> testClass) {\n \n     }\n \n-    /**\n-     * We don't support {@link TestProfile} in native tests because we don't want to incur the native binary rebuild cost\n-     * which is very high.\n-     *\n-     * This method looks up the annotations via Jandex in order to try and prevent the image generation if there are\n-     * any cases of {@link NativeImageTest} being used with {@link TestProfile}\n-     */\n-    private void ensureNoTestProfile(Class<?> testClass) {\n-        Index index = TestClassIndexer.readIndex(testClass);\n-        List<AnnotationInstance> instances = index.getAnnotations(DotName.createSimple(NativeImageTest.class.getName()));\n-        for (AnnotationInstance instance : instances) {\n-            if (instance.target().kind() != AnnotationTarget.Kind.CLASS) {\n-                continue;\n+    private ExtensionState ensureStarted(ExtensionContext extensionContext) {\n+        Class<?> testClass = extensionContext.getRequiredTestClass();\n+        ensureNoInjectAnnotationIsUsed(testClass);\n+\n+        ExtensionContext root = extensionContext.getRoot();\n+        ExtensionContext.Store store = root.getStore(ExtensionContext.Namespace.GLOBAL);\n+        ExtensionState state = store.get(ExtensionState.class.getName(), ExtensionState.class);\n+        TestProfile annotation = testClass.getAnnotation(TestProfile.class);\n+        Class<? extends QuarkusTestProfile> selectedProfile = null;\n+        if (annotation != null) {\n+            selectedProfile = annotation.value();\n+        }\n+        boolean wrongProfile = !Objects.equals(selectedProfile, quarkusTestProfile);\n+        if ((state == null && !failedBoot) || wrongProfile) {\n+            if (wrongProfile) {\n+                if (state != null) {\n+                    try {\n+                        state.close();\n+                    } catch (Throwable throwable) {\n+                        throwable.printStackTrace();\n+                    }\n+                }\n             }\n-            ClassInfo testClassInfo = instance.target().asClass();\n-            if (testClassInfo.classAnnotation(DotName.createSimple(TestProfile.class.getName())) != null) {\n-                throw new JUnitException(\n-                        \"@TestProfile is not supported in NativeImageTest tests. Offending class is \" + testClassInfo.name());\n+            PropertyTestUtil.setLogFileProperty();\n+            try {\n+                state = doNativeStart(extensionContext, selectedProfile);\n+                store.put(ExtensionState.class.getName(), state);\n+\n+            } catch (Throwable e) {\n+                failedBoot = true;\n+                firstException = e;\n             }\n         }\n+        return state;\n+    }\n+\n+    private ExtensionState doNativeStart(ExtensionContext context, Class<? extends QuarkusTestProfile> profile)\n+            throws Throwable {\n+        quarkusTestProfile = profile;\n+        TestResourceManager testResourceManager = null;\n+        try {\n+            Class<?> requiredTestClass = context.getRequiredTestClass();\n+\n+            Map<String, String> sysPropRestore = new HashMap<>();\n+            sysPropRestore.put(ProfileManager.QUARKUS_TEST_PROFILE_PROP,\n+                    System.getProperty(ProfileManager.QUARKUS_TEST_PROFILE_PROP));\n+\n+            QuarkusTestProfile profileInstance = null;\n+            final Map<String, String> additional = new HashMap<>();\n+            if (profile != null) {\n+                profileInstance = profile.newInstance();\n+                additional.putAll(profileInstance.getConfigOverrides());\n+                final Set<Class<?>> enabledAlternatives = profileInstance.getEnabledAlternatives();\n+                if (!enabledAlternatives.isEmpty()) {\n+                    additional.put(\"quarkus.arc.selected-alternatives\", enabledAlternatives.stream()", "originalCommit": "9aa9f869a616e2ef700b59d6e71ebb30abd68dcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg0MzIxMw==", "url": "https://github.com/quarkusio/quarkus/pull/13154#discussion_r530843213", "bodyText": "Good point, but I think the current solution is not that bad: If enabledAlternatives is a non-empty set containing anything different than what the test app was compiled with, the test app will fail at boot. I think that's better than ignoring silently or warning. The user should do a conscious decision what to do in such a case. If he wants to test with the alternatives in JVM mode and ignore them in the native mode, he can create subclass of his QuarkusTestProfile for the native mode in which he returns an empty set of alternatives.\nDo you think warn+ignore would be better?", "author": "ppalaga", "createdAt": "2020-11-26T08:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxMzgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg1MTkzNA==", "url": "https://github.com/quarkusio/quarkus/pull/13154#discussion_r530851934", "bodyText": "You are probably right, Let's keep it for now and see.", "author": "geoand", "createdAt": "2020-11-26T08:33:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDgxMzgyNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2478d22784fcd19117fa5a213a8e6fccc463df1b", "url": "https://github.com/quarkusio/quarkus/commit/2478d22784fcd19117fa5a213a8e6fccc463df1b", "message": "Support @TestProfile in native mode #12974", "committedDate": "2020-12-18T09:23:47Z", "type": "commit"}, {"oid": "2478d22784fcd19117fa5a213a8e6fccc463df1b", "url": "https://github.com/quarkusio/quarkus/commit/2478d22784fcd19117fa5a213a8e6fccc463df1b", "message": "Support @TestProfile in native mode #12974", "committedDate": "2020-12-18T09:23:47Z", "type": "forcePushed"}]}