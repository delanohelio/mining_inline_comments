{"pr_number": 9394, "pr_title": "Allow application to be re-augmented", "pr_createdAt": "2020-05-18T03:24:49Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9394", "timeline": [{"oid": "0995bdcfe448a3b976e1b91bc4537f3d422603ff", "url": "https://github.com/quarkusio/quarkus/commit/0995bdcfe448a3b976e1b91bc4537f3d422603ff", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-18T05:16:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDExNA==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426710114", "bodyText": "Is it really costly? I would have imagined this to be always generated", "author": "emmanuelbernard", "createdAt": "2020-05-18T15:27:38Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java", "diffHunk": "@@ -27,6 +29,16 @@\n     @ConfigItem(defaultValue = JAR)\n     public String type;\n \n+    /**\n+     * Experimental property that allows for the creation of a 'mutable' application that\n+     * can be re-augmented after creation.\n+     *\n+     * TODO: should this just be a different package type: 'mutable-jar'\n+     *\n+     */\n+    @ConfigProperty(defaultValue = \"true\")\n+    public boolean mutableApplication;", "originalCommit": "0995bdcfe448a3b976e1b91bc4537f3d422603ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NTc3Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426965772", "bodyText": "It results in a bigger application, as you need the -deployment artifacts (and their deps) in the final output. For a normal launch these are not loaded, so there is no memory usage or boot time overhead, but it does make the final image bigger.", "author": "stuartwdouglas", "createdAt": "2020-05-19T00:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNTE1MA==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r427415150", "bodyText": "should be default false then?", "author": "emmanuelbernard", "createdAt": "2020-05-19T15:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDExNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzMDI2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r427630263", "bodyText": "Oops, sorry, trying to do too many things at once and missed that.", "author": "stuartwdouglas", "createdAt": "2020-05-19T22:12:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDExNA=="}], "type": "inlineReview", "revised_code": {"commit": "b609c98a299ad07c7b3bc770d22f315ff7594f19", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java b/core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java\nindex 4f995887ef..e2381f13ef 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java\n\n@@ -36,7 +36,7 @@ public class PackageConfig {\n      * TODO: should this just be a different package type: 'mutable-jar'\n      *\n      */\n-    @ConfigProperty(defaultValue = \"true\")\n+    @ConfigProperty(defaultValue = \"false\")\n     public boolean mutableApplication;\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDU3OA==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426710578", "bodyText": "What are the reason for the rebuild Boolean a. Is it just to read from the dat model? Or is there more to it ?", "author": "emmanuelbernard", "createdAt": "2020-05-18T15:28:17Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/builditem/BuildSystemTargetBuildItem.java", "diffHunk": "@@ -11,10 +11,12 @@\n \n     private final Path outputDirectory;\n     private final String baseName;\n+    private final boolean rebuild;\n \n-    public BuildSystemTargetBuildItem(Path outputDirectory, String baseName) {\n+    public BuildSystemTargetBuildItem(Path outputDirectory, String baseName, boolean rebuild) {", "originalCommit": "0995bdcfe448a3b976e1b91bc4537f3d422603ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NjA5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426966091", "bodyText": "When you rebuild you don't want to re-copy libraries, as they are already in place on disk. A normal build will also delete the target dir to start with a clean slate.", "author": "stuartwdouglas", "createdAt": "2020-05-19T00:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMDU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "b609c98a299ad07c7b3bc770d22f315ff7594f19", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/pkg/builditem/BuildSystemTargetBuildItem.java b/core/deployment/src/main/java/io/quarkus/deployment/pkg/builditem/BuildSystemTargetBuildItem.java\nindex 19746b66ad..3fa8da77c6 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/pkg/builditem/BuildSystemTargetBuildItem.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/pkg/builditem/BuildSystemTargetBuildItem.java\n\n@@ -12,11 +13,13 @@ public final class BuildSystemTargetBuildItem extends SimpleBuildItem {\n     private final Path outputDirectory;\n     private final String baseName;\n     private final boolean rebuild;\n+    private final Properties buildSystemProps;\n \n-    public BuildSystemTargetBuildItem(Path outputDirectory, String baseName, boolean rebuild) {\n+    public BuildSystemTargetBuildItem(Path outputDirectory, String baseName, boolean rebuild, Properties buildSystemProps) {\n         this.outputDirectory = outputDirectory;\n         this.baseName = baseName;\n         this.rebuild = rebuild;\n+        this.buildSystemProps = buildSystemProps;\n     }\n \n     public Path getOutputDirectory() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMzA2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426713067", "bodyText": "So there is a mutability main entry and a reaugment main entry? What\u2019s the difference?", "author": "emmanuelbernard", "createdAt": "2020-05-18T15:31:51Z", "path": "independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/AugmentEntryPoint.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package io.quarkus.bootstrap.runner;\n+\n+import java.io.ObjectInputStream;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.net.URLDecoder;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Experimental class that allows Quarkus applications to be re-augmented\n+ * \n+ */\n+public class AugmentEntryPoint {\n+\n+    public static void main(String... args) throws Exception {", "originalCommit": "0995bdcfe448a3b976e1b91bc4537f3d422603ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NjUwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r426966501", "bodyText": "This is the entry point to regenerate the app. As my transparent rebuild idea was not popular this must be invoked manually. For now while this is experimental this is just run using java -cp quarkus-run.jar io.quarkus.bootstrap.runner.AumentEntryPoint, once this feature is no longer experimental we will likely want an easier way to do this.", "author": "stuartwdouglas", "createdAt": "2020-05-19T00:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMzA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQxNjAzMw==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r427416033", "bodyText": "ok but what about this one? MutabilityEntryPoint", "author": "emmanuelbernard", "createdAt": "2020-05-19T15:59:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMzA2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzMDU4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r427630583", "bodyText": "Its just badly named, its purpose changed but not its name, I have renamed it.", "author": "stuartwdouglas", "createdAt": "2020-05-19T22:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcxMzA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b609c98a299ad07c7b3bc770d22f315ff7594f19", "chunk": "diff --git a/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/AugmentEntryPoint.java b/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/ReAugmentEntryPoint.java\nsimilarity index 73%\nrename from independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/AugmentEntryPoint.java\nrename to independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/ReAugmentEntryPoint.java\nindex 5a23b1a7ab..79a0b8f1ba 100644\n--- a/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/AugmentEntryPoint.java\n+++ b/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/ReAugmentEntryPoint.java\n\n@@ -9,37 +9,35 @@ import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.List;\n-import java.util.stream.Collectors;\n \n /**\n  * Experimental class that allows Quarkus applications to be re-augmented\n- * \n+ *\n  */\n-public class AugmentEntryPoint {\n+public class ReAugmentEntryPoint {\n \n     public static void main(String... args) throws Exception {\n         System.setProperty(\"java.util.logging.manager\", org.jboss.logmanager.LogManager.class.getName());\n         Timing.staticInitStarted();\n \n-        String path = AugmentEntryPoint.class.getProtectionDomain().getCodeSource().getLocation().getPath();\n+        String path = ReAugmentEntryPoint.class.getProtectionDomain().getCodeSource().getLocation().getPath();\n         String decodedPath = URLDecoder.decode(path, \"UTF-8\");\n         Path appRoot = Paths.get(decodedPath).getParent().getParent();\n \n         try (ObjectInputStream in = new ObjectInputStream(\n                 Files.newInputStream(appRoot.resolve(\"deployment-quarkus/deployment-class-path.dat\")))) {\n             List<String> paths = (List<String>) in.readObject();\n-            List<URL> urls = paths.stream().map((s) -> {\n+            //yuck, should use runner class loader\n+            URLClassLoader loader = new URLClassLoader(paths.stream().map((s) -> {\n                 try {\n                     return appRoot.resolve(s).toUri().toURL();\n                 } catch (MalformedURLException e) {\n                     throw new RuntimeException(e);\n                 }\n-            }).collect(Collectors.toList());\n-            //yuck, should use runner class loader\n-            URLClassLoader loader = new URLClassLoader(urls.toArray(new URL[0]));\n+            }).toArray(URL[]::new));\n             try {\n-                loader.loadClass(\"io.quarkus.deployment.mutability.MutabilityEntryPoint\")\n-                        .getDeclaredMethod(\"main\", Path.class, String[].class).invoke(null, appRoot, args);\n+                loader.loadClass(\"io.quarkus.deployment.mutability.ReaugmentTask\")\n+                        .getDeclaredMethod(\"main\", Path.class).invoke(null, appRoot);\n             } finally {\n                 loader.close();\n             }\n"}}, {"oid": "051134c6789254557cc09824bad42b72966fddbb", "url": "https://github.com/quarkusio/quarkus/commit/051134c6789254557cc09824bad42b72966fddbb", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-19T08:51:02Z", "type": "forcePushed"}, {"oid": "7e6d931dc4962a4011e7791c10e97cf78538af00", "url": "https://github.com/quarkusio/quarkus/commit/7e6d931dc4962a4011e7791c10e97cf78538af00", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-19T09:27:34Z", "type": "forcePushed"}, {"oid": "b609c98a299ad07c7b3bc770d22f315ff7594f19", "url": "https://github.com/quarkusio/quarkus/commit/b609c98a299ad07c7b3bc770d22f315ff7594f19", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-20T00:22:48Z", "type": "forcePushed"}, {"oid": "c245f69864b3045e93376b6379b33c23e83089b0", "url": "https://github.com/quarkusio/quarkus/commit/c245f69864b3045e93376b6379b33c23e83089b0", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-20T03:49:52Z", "type": "forcePushed"}, {"oid": "ef4c4d1a90988e3b7c7d392f9b6355ccee68201b", "url": "https://github.com/quarkusio/quarkus/commit/ef4c4d1a90988e3b7c7d392f9b6355ccee68201b", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-25T05:22:03Z", "type": "forcePushed"}, {"oid": "e16ca5361c7e8f5b8a9b811957eb149bfdef0f69", "url": "https://github.com/quarkusio/quarkus/commit/e16ca5361c7e8f5b8a9b811957eb149bfdef0f69", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-25T06:26:29Z", "type": "forcePushed"}, {"oid": "4c9fd4f99e909e976ec48b7b86a97884fc6acaa9", "url": "https://github.com/quarkusio/quarkus/commit/4c9fd4f99e909e976ec48b7b86a97884fc6acaa9", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-25T07:10:03Z", "type": "forcePushed"}, {"oid": "f98e0393664788f56169d055d585335f845ab8dd", "url": "https://github.com/quarkusio/quarkus/commit/f98e0393664788f56169d055d585335f845ab8dd", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-25T23:17:36Z", "type": "commit"}, {"oid": "f98e0393664788f56169d055d585335f845ab8dd", "url": "https://github.com/quarkusio/quarkus/commit/f98e0393664788f56169d055d585335f845ab8dd", "message": "Allow application to be re-augmented\n\nThis adds the concept of a 'Mutable Application' that can be reaugmented.\n\nThis is an experimental capability for now, and will form the basis for\nthe new remote dev mode.", "committedDate": "2020-05-25T23:17:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQwNDY3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r430404675", "bodyText": "+1 to make it a different package type, since IIUC you can't really use mutableApplication with the other package types", "author": "geoand", "createdAt": "2020-05-26T13:18:24Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/PackageConfig.java", "diffHunk": "@@ -27,6 +29,16 @@\n     @ConfigItem(defaultValue = JAR)\n     public String type;\n \n+    /**\n+     * Experimental property that allows for the creation of a 'mutable' application that\n+     * can be re-augmented after creation.\n+     *\n+     * TODO: should this just be a different package type: 'mutable-jar'", "originalCommit": "f98e0393664788f56169d055d585335f845ab8dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQwNjU4OA==", "url": "https://github.com/quarkusio/quarkus/pull/9394#discussion_r430406588", "bodyText": "What is the reason to not use it?", "author": "geoand", "createdAt": "2020-05-26T13:21:09Z", "path": "independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/ReAugmentEntryPoint.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package io.quarkus.bootstrap.runner;\n+\n+import java.io.File;\n+import java.io.ObjectInputStream;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLClassLoader;\n+import java.net.URLDecoder;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+/**\n+ * Experimental class that allows Quarkus applications to be re-augmented\n+ *\n+ */\n+public class ReAugmentEntryPoint {\n+\n+    public static void main(String... args) throws Exception {\n+        System.setProperty(\"java.util.logging.manager\", org.jboss.logmanager.LogManager.class.getName());\n+        Timing.staticInitStarted();\n+\n+        String path = ReAugmentEntryPoint.class.getProtectionDomain().getCodeSource().getLocation().getPath();\n+        String decodedPath = URLDecoder.decode(path, \"UTF-8\");\n+        Path appRoot = new File(decodedPath).toPath().getParent().getParent();\n+\n+        try (ObjectInputStream in = new ObjectInputStream(\n+                Files.newInputStream(appRoot.resolve(\"deployment-quarkus/deployment-class-path.dat\")))) {\n+            List<String> paths = (List<String>) in.readObject();\n+            //yuck, should use runner class loader", "originalCommit": "f98e0393664788f56169d055d585335f845ab8dd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}