{"pr_number": 13503, "pr_title": "Runtime classloader micro optimisations", "pr_createdAt": "2020-11-26T22:19:50Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/13503", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531401478", "bodyText": "Are we sure about using a method reference here?", "author": "geoand", "createdAt": "2020-11-27T06:17:12Z", "path": "independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/RunnerClassLoader.java", "diffHunk": "@@ -73,33 +71,35 @@\n             if (loaded != null) {\n                 return loaded;\n             }\n-            ClassLoadingResource[] resources;\n+            final ClassLoadingResource[] resources;\n             if (packageName == null) {\n                 resources = resourceDirectoryMap.get(\"\");\n             } else {\n-                String dirName = packageName.replace(\".\", \"/\");\n+                String dirName = packageName.replace('.', '/');\n                 resources = resourceDirectoryMap.get(dirName);\n             }\n             if (resources != null) {\n-                String classResource = name.replace(\".\", \"/\") + \".class\";\n+                String classResource = name.replace('.', '/') + \".class\";\n                 for (ClassLoadingResource resource : resources) {\n                     byte[] data = resource.getResourceData(classResource);\n                     if (data == null) {\n                         continue;\n                     }\n                     definePackage(packageName, resources);\n                     return defineClass(name, data, 0, data.length,\n-                            protectionDomains.computeIfAbsent(resource, new Function<ClassLoadingResource, ProtectionDomain>() {\n-                                @Override\n-                                public ProtectionDomain apply(ClassLoadingResource ce) {\n-                                    return ce.getProtectionDomain(RunnerClassLoader.this);\n-                                }\n-                            }));\n+                            getProtectionDomain(resource));\n                 }\n             }\n         }\n         return getParent().loadClass(name);\n+    }\n+\n+    private ProtectionDomain getProtectionDomain(ClassLoadingResource resource) {\n+        return protectionDomains.computeIfAbsent(resource, this::extractProtectionDomainFromClassLoadingResource);", "originalCommit": "e6942e4afd58c6f542c1621fa067706938b8f25f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ4OTc5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531489797", "bodyText": "why not? It's typically preferreable over a lambda - although in this case (since my other changes made it stateless) it should be comparable.\nI generally highly prefer method references, as there is no possible mistake about the lambda possibly becoming a stateful lambda, which requires extra memory, a proxy, and extra overhead to track the proxy. A method handle will never unintentionally capture state, so it helps to fight such hidden costs.", "author": "Sanne", "createdAt": "2020-11-27T09:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwMTA2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531501063", "bodyText": "It doesn't capture state, but it's still implemented via invokedynamic, isn't it?", "author": "geoand", "createdAt": "2020-11-27T10:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwNTE1NA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531505154", "bodyText": "I know it should not make any real world difference and the cost will probably be dominated by the slowness of computeIfAbsent, just trying to cover all bases because we are talking about a core component :)", "author": "geoand", "createdAt": "2020-11-27T10:13:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwODM4Ng==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531508386", "bodyText": "yes but invokedynamic isn't a performance problem? Capturing state lambdas and anonymous Function classes are far worse", "author": "Sanne", "createdAt": "2020-11-27T10:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUwOTQzNg==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531509436", "bodyText": "BTW I thought this was straight forward, but if there's concerns I don't mind removing this specific commit. It's not that important :)\nI do care more about some of the other commits in this PR though, so I'd prefer removing this change if it expedites the others.", "author": "Sanne", "createdAt": "2020-11-27T10:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxMDQzNw==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531510437", "bodyText": "Right, if it were me, I'd remove it, but I'm not hell bent on it", "author": "geoand", "createdAt": "2020-11-27T10:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUxOTgxMA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531519810", "bodyText": "removed", "author": "Sanne", "createdAt": "2020-11-27T10:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTUzNzY3MA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531537670", "bodyText": "Is there a reason why you don't apply your trick of trying to get the value first before calling computeIfAbsent? Or is it a case where you have a good change for it to not be in the map?\nYou told me about it a long time ago and it had quite a few benefits in HV.", "author": "gsmet", "createdAt": "2020-11-27T11:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2NjExNw==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531566117", "bodyText": "yea good idea, we could have done that as well I guess. I didn't jump to it as this whole block doesn't seem highly concurrent - call me conservative, but @geoand still got scared :)", "author": "Sanne", "createdAt": "2020-11-27T12:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU2Njk3OA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531566978", "bodyText": "BTW I also wonder why do we care for protection domains... return a singleton and disable all this stuff \ud83d\udde1\ufe0f\nBut I don't know the consequences well enough.", "author": "Sanne", "createdAt": "2020-11-27T12:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3MzgyOQ==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531573829", "bodyText": "In this specific case, that should work as there is ever only one RunnerClassLoader, so the JarResource could indeed be passed the ClassLoader that it helps \"populate\" (perhaps by adding an init method to ClassLoadingResource) and then this block would just class getProtectionDomain which would just return the singleton.", "author": "geoand", "createdAt": "2020-11-27T12:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU3ODUxNA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531578514", "bodyText": "I can make that change when this lands", "author": "geoand", "createdAt": "2020-11-27T12:38:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTU5MjEyNA==", "url": "https://github.com/quarkusio/quarkus/pull/13503#discussion_r531592124", "bodyText": "Here it is: #13515", "author": "geoand", "createdAt": "2020-11-27T13:08:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQwMTQ3OA=="}], "type": "inlineReview", "revised_code": {"commit": "611ee15a04c97a939739bfc75c9d31969c231448", "chunk": "diff --git a/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/RunnerClassLoader.java b/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/RunnerClassLoader.java\nindex a4c95efa47..86630eea30 100644\n--- a/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/RunnerClassLoader.java\n+++ b/independent-projects/bootstrap/runner/src/main/java/io/quarkus/bootstrap/runner/RunnerClassLoader.java\n\n@@ -71,15 +73,15 @@ public final class RunnerClassLoader extends ClassLoader {\n             if (loaded != null) {\n                 return loaded;\n             }\n-            final ClassLoadingResource[] resources;\n+            ClassLoadingResource[] resources;\n             if (packageName == null) {\n                 resources = resourceDirectoryMap.get(\"\");\n             } else {\n-                String dirName = packageName.replace('.', '/');\n+                String dirName = packageName.replace(\".\", \"/\");\n                 resources = resourceDirectoryMap.get(dirName);\n             }\n             if (resources != null) {\n-                String classResource = name.replace('.', '/') + \".class\";\n+                String classResource = name.replace(\".\", \"/\") + \".class\";\n                 for (ClassLoadingResource resource : resources) {\n                     byte[] data = resource.getResourceData(classResource);\n                     if (data == null) {\n"}}, {"oid": "611ee15a04c97a939739bfc75c9d31969c231448", "url": "https://github.com/quarkusio/quarkus/commit/611ee15a04c97a939739bfc75c9d31969c231448", "message": "Micro-optimise sanitizeName(String)", "committedDate": "2020-11-27T10:34:37Z", "type": "commit"}, {"oid": "7c916e9b05be2c7a822241918e7d0ef97be89516", "url": "https://github.com/quarkusio/quarkus/commit/7c916e9b05be2c7a822241918e7d0ef97be89516", "message": "Character replacements in String are better off by passing a char", "committedDate": "2020-11-27T10:34:37Z", "type": "commit"}, {"oid": "9890b211373c2be3800a443934baef63cabb3a4f", "url": "https://github.com/quarkusio/quarkus/commit/9890b211373c2be3800a443934baef63cabb3a4f", "message": "Adding a toString method to JarResource greatly helps debugging", "committedDate": "2020-11-27T10:34:37Z", "type": "commit"}, {"oid": "e39fd4d6f4e9fe1f440d1b0abaaaca933c75c82d", "url": "https://github.com/quarkusio/quarkus/commit/e39fd4d6f4e9fe1f440d1b0abaaaca933c75c82d", "message": "Remove never thrown IOException from signature", "committedDate": "2020-11-27T10:35:23Z", "type": "commit"}, {"oid": "ebb85186e7be2c443f18f3d84c64268707c51a49", "url": "https://github.com/quarkusio/quarkus/commit/ebb85186e7be2c443f18f3d84c64268707c51a49", "message": "Make RunnerClassLoader final", "committedDate": "2020-11-27T10:35:23Z", "type": "commit"}, {"oid": "ebb85186e7be2c443f18f3d84c64268707c51a49", "url": "https://github.com/quarkusio/quarkus/commit/ebb85186e7be2c443f18f3d84c64268707c51a49", "message": "Make RunnerClassLoader final", "committedDate": "2020-11-27T10:35:23Z", "type": "forcePushed"}]}