{"pr_number": 8815, "pr_title": "Make deploying to Minikube effortless when not using a registry ", "pr_createdAt": "2020-04-24T08:52:58Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8815", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNDI2MA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414424260", "bodyText": "Should inline the determineImagePullPolicy call like the subsequent applyConfig calls do?", "author": "Ladicek", "createdAt": "2020-04-24T09:16:24Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -225,10 +230,13 @@ public void build(ApplicationInfoBuildItem applicationInfo,\n         //Apply configuration\n         applyGlobalConfig(session, kubernetesConfig);\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n+        ImagePullPolicy imagePullPolicy = determineImagePullPolicy(kubernetesConfig, containerImage, capabilities);\n         applyConfig(session, project, KUBERNETES, getResourceName(kubernetesConfig, applicationInfo), kubernetesConfig,", "originalCommit": "de7177bf438c5921395dca6fbea35d2367d7ff30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNzE2OA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414427168", "bodyText": "Yeah, that makes sense.", "author": "geoand", "createdAt": "2020-04-24T09:20:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNDI2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNzg5Mg==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414427892", "bodyText": "I must have missed it, thanks for pointing it out :)", "author": "geoand", "createdAt": "2020-04-24T09:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNDI2MA=="}], "type": "inlineReview", "revised_code": {"commit": "12ba684fc7074138b347b51b41e654c3cebf8e16", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\nindex b8783fadac..7d03a3aa2a 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n\n@@ -230,9 +230,8 @@ class KubernetesProcessor {\n         //Apply configuration\n         applyGlobalConfig(session, kubernetesConfig);\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        ImagePullPolicy imagePullPolicy = determineImagePullPolicy(kubernetesConfig, containerImage, capabilities);\n         applyConfig(session, project, KUBERNETES, getResourceName(kubernetesConfig, applicationInfo), kubernetesConfig,\n-                now, imagePullPolicy);\n+                now, determineImagePullPolicy(kubernetesConfig, containerImage, capabilities));\n         applyConfig(session, project, OPENSHIFT, getResourceName(openshiftConfig, applicationInfo), openshiftConfig, now,\n                 determineImagePullPolicy(openshiftConfig, containerImage, capabilities));\n         applyConfig(session, project, KNATIVE, getResourceName(knativeConfig, applicationInfo), knativeConfig, now,\n"}}, {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16", "url": "https://github.com/quarkusio/quarkus/commit/12ba684fc7074138b347b51b41e654c3cebf8e16", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes", "committedDate": "2020-04-24T09:21:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414437945", "bodyText": "I don't really get the purpose of calling kubernetesDeploy.getAsBoolean().\nWhatever the reason, this needs to change, as this call is performing an actual request to kubernetes. This should never be the case when generating resources. Generated resources should be the same regardless of the if and what is the configured environment on the user side.", "author": "iocanel", "createdAt": "2020-04-24T09:37:35Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -391,6 +399,22 @@ private void applyConfig(Session session, Project project, String target, String\n         });\n     }\n \n+    /**\n+     * When there is no registry defined and s2i isn't being used, the only ImagePullPolicy that can work is 'IfNotPresent'.\n+     * This case comes up when users want to deploy their application to a cluster like Minikube where no registry is used\n+     * and instead they rely on the image being built directly into the docker daemon that the cluster uses.\n+     */\n+    private ImagePullPolicy determineImagePullPolicy(PlatformConfiguration config,\n+            Optional<ContainerImageInfoBuildItem> containerImage, Capabilities capabilities) {\n+        ImagePullPolicy imagePullPolicy = config.getImagePullPolicy();\n+        if (containerImage.isPresent()\n+                && ContainerImageUtil.isRegistryMissingAndNotS2I(capabilities, containerImage.get())\n+                && kubernetesDeploy.getAsBoolean()) {", "originalCommit": "12ba684fc7074138b347b51b41e654c3cebf8e16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzOTYyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414439621", "bodyText": "The idea is that the resource only changes if you are actually deploying, if you are not deploying you get what you configured.\nI think it's the best compromise.", "author": "geoand", "createdAt": "2020-04-24T09:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ0MzA5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414443093", "bodyText": "I would rather decorate what we deploy rather than the physical generated file.", "author": "iocanel", "createdAt": "2020-04-24T09:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1Mzg0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414453846", "bodyText": "That sounds weird to me. -Dquarkus.kubernetes.deploy=true should, in my opinion, be the same as kubectl apply -f target/kubernetes/kubernetes.yml. Why not do this always?", "author": "Ladicek", "createdAt": "2020-04-24T10:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ1ODkwMg==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414458902", "bodyText": "I agree with @Ladicek. If it's not the same thing, I think users will be very confused", "author": "geoand", "createdAt": "2020-04-24T10:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MTY4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414461680", "bodyText": "The idea for me is to surprise users the least. With the proposed PR, users get an indicative warning message and they can inspect what was generated.\nHaving what is deployed different from what is generated would cause a lot of surprise I think.", "author": "geoand", "createdAt": "2020-04-24T10:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzU5MA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414463590", "bodyText": "I was trying to ask, why not remove the && kubernetesDeploy.getAsBoolean() condition. What is it good for?", "author": "Ladicek", "createdAt": "2020-04-24T10:18:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2NTA2Nw==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414465067", "bodyText": "My idea is to only change the policy when we absolutely have to - which is only when deploying. A user may for some reason want to just generate the resources and in that case I don't see why we should change it.\nIt's an edge case, so I am happy to go either way", "author": "geoand", "createdAt": "2020-04-24T10:21:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2OTk3MA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414469970", "bodyText": "So, in addition to \"-Dquarkus.kubernetes.deploy=true should be the same as kubectl apply -f target/kubernetes/kubernetes.yml\", I also believe that target/kubernetes/kubernetes.yml should be the same regardless of quarkus.kubernetes.deploy value. I know, I'm demanding :-)", "author": "Ladicek", "createdAt": "2020-04-24T10:29:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MDY5OQ==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414470699", "bodyText": "If that isn't possible, then I think I agree with @geoand that it's important to deploy the same thing that is on the filesystem.", "author": "Ladicek", "createdAt": "2020-04-24T10:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MTU0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414471546", "bodyText": "Well I don't think we can do everything, so we need to find a good compromise. My opinion is obviously that the current PR is the best compromise, but I am open to other ideas.", "author": "geoand", "createdAt": "2020-04-24T10:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MjEzMA==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414492130", "bodyText": "I think that the absence of a registry is enough to trigger the desired behaviour and keeps things simple. Having, the runtime affect in any way the generated resources is going to bite us.", "author": "iocanel", "createdAt": "2020-04-24T11:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MzAyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414493021", "bodyText": "So you prefer that I remove the kubernetesDeploy.getAsBoolean() check altogether?", "author": "geoand", "createdAt": "2020-04-24T11:10:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "94927aa7ab96fadd14347fc1a99e1da01ba47305", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\nindex 7d03a3aa2a..dfdeb0d93a 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n\n@@ -399,22 +391,6 @@ class KubernetesProcessor {\n         });\n     }\n \n-    /**\n-     * When there is no registry defined and s2i isn't being used, the only ImagePullPolicy that can work is 'IfNotPresent'.\n-     * This case comes up when users want to deploy their application to a cluster like Minikube where no registry is used\n-     * and instead they rely on the image being built directly into the docker daemon that the cluster uses.\n-     */\n-    private ImagePullPolicy determineImagePullPolicy(PlatformConfiguration config,\n-            Optional<ContainerImageInfoBuildItem> containerImage, Capabilities capabilities) {\n-        ImagePullPolicy imagePullPolicy = config.getImagePullPolicy();\n-        if (containerImage.isPresent()\n-                && ContainerImageUtil.isRegistryMissingAndNotS2I(capabilities, containerImage.get())\n-                && kubernetesDeploy.getAsBoolean()) {\n-            imagePullPolicy = ImagePullPolicy.IfNotPresent;\n-        }\n-        return imagePullPolicy;\n-    }\n-\n     private void applyBuildItems(Session session,\n             ApplicationInfoBuildItem applicationInfo,\n             KubernetesConfig kubernetesConfig,\n"}}, {"oid": "94927aa7ab96fadd14347fc1a99e1da01ba47305", "url": "https://github.com/quarkusio/quarkus/commit/94927aa7ab96fadd14347fc1a99e1da01ba47305", "message": "Fix broken KubernetesDeployer\n\n7f78a470 cleaned up the class, but the build item\nthat was removed was evidently also used to control\nthe execution order of the various build steps.\nThe issue is easily be fixed by adding\nArtifactResultBuildItem as a \"dependency\" since it is\nproduced by the container-image build steps", "committedDate": "2020-04-24T11:12:36Z", "type": "commit"}, {"oid": "d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "url": "https://github.com/quarkusio/quarkus/commit/d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes", "committedDate": "2020-04-24T11:25:22Z", "type": "forcePushed"}, {"oid": "b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "url": "https://github.com/quarkusio/quarkus/commit/b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes", "committedDate": "2020-04-24T11:37:00Z", "type": "forcePushed"}, {"oid": "4781238019392e70ef6463bc51b29dffa229119c", "url": "https://github.com/quarkusio/quarkus/commit/4781238019392e70ef6463bc51b29dffa229119c", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes", "committedDate": "2020-04-24T11:40:45Z", "type": "commit"}, {"oid": "4781238019392e70ef6463bc51b29dffa229119c", "url": "https://github.com/quarkusio/quarkus/commit/4781238019392e70ef6463bc51b29dffa229119c", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes", "committedDate": "2020-04-24T11:40:45Z", "type": "forcePushed"}]}