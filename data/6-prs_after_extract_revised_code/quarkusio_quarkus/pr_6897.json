{"pr_number": 6897, "pr_title": "Show image pull output when using a builder image", "pr_createdAt": "2020-01-30T19:43:23Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6897", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzI3MQ==", "url": "https://github.com/quarkusio/quarkus/pull/6897#discussion_r373157271", "bodyText": "Better call process.destroy() in a finally block just in case", "author": "gastaldi", "createdAt": "2020-01-30T19:46:39Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -108,6 +108,22 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n                 nativeImage.add(\"--publish=\" + DEBUG_BUILD_PROCESS_PORT + \":\" + DEBUG_BUILD_PROCESS_PORT);\n             }\n             Collections.addAll(nativeImage, \"--rm\", nativeConfig.builderImage);\n+\n+            if (\"docker\".equals(containerRuntime) || \"podman\".equals(containerRuntime)) {\n+                // we pull the docker image in order to give users an indication of which step the process is at\n+                // it's not strictly necessary we do this, however if we don't the subsequent version command\n+                // will appear to block and no output will be shown\n+                log.info(\"Pulling image \" + nativeConfig.builderImage);\n+                try {\n+                    Process pullProcess = new ProcessBuilder(Arrays.asList(containerRuntime, \"pull\", nativeConfig.builderImage))\n+                            .inheritIO()\n+                            .start();\n+                    pullProcess.waitFor();", "originalCommit": "cb65e2bbf54d77f489d96d64cdc799f0a4e7267e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzczMA==", "url": "https://github.com/quarkusio/quarkus/pull/6897#discussion_r373157730", "bodyText": "Good idea", "author": "geoand", "createdAt": "2020-01-30T19:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1OTQxNw==", "url": "https://github.com/quarkusio/quarkus/pull/6897#discussion_r373159417", "bodyText": "Done", "author": "geoand", "createdAt": "2020-01-30T19:51:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1OTY0Ng==", "url": "https://github.com/quarkusio/quarkus/pull/6897#discussion_r373159646", "bodyText": "Maybe have a look at that change by Stuart: #6031 .", "author": "gsmet", "createdAt": "2020-01-30T19:51:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzI3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE2MTE4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/6897#discussion_r373161187", "bodyText": "Hm... In this case we aren't really reading anything from the process output, we just want to wait for it, so I don't think the change is needed, right?", "author": "geoand", "createdAt": "2020-01-30T19:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE1NzI3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d18b6ba8a9b174a2bb096e186e6f34db17bc9725", "chunk": "diff --git a/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java b/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java\nindex c94241ccf9..7080b3cf11 100644\n--- a/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java\n+++ b/core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java\n\n@@ -114,13 +114,18 @@ public class NativeImageBuildStep {\n                 // it's not strictly necessary we do this, however if we don't the subsequent version command\n                 // will appear to block and no output will be shown\n                 log.info(\"Pulling image \" + nativeConfig.builderImage);\n+                Process pullProcess =  null;\n                 try {\n-                    Process pullProcess = new ProcessBuilder(Arrays.asList(containerRuntime, \"pull\", nativeConfig.builderImage))\n+                    pullProcess = new ProcessBuilder(Arrays.asList(containerRuntime, \"pull\", nativeConfig.builderImage))\n                             .inheritIO()\n                             .start();\n                     pullProcess.waitFor();\n                 } catch (IOException | InterruptedException e) {\n                     throw new RuntimeException(\"Failed to pull builder image \" + nativeConfig.builderImage, e);\n+                } finally {\n+                    if (pullProcess != null) {\n+                        pullProcess.destroy();\n+                    }\n                 }\n             }\n \n"}}, {"oid": "d18b6ba8a9b174a2bb096e186e6f34db17bc9725", "url": "https://github.com/quarkusio/quarkus/commit/d18b6ba8a9b174a2bb096e186e6f34db17bc9725", "message": "Show image pull output when using a builder image\n\nFixes: #6892", "committedDate": "2020-01-30T19:49:34Z", "type": "forcePushed"}, {"oid": "c3ff8b84265f7014325ddbf742af2d4813788cfe", "url": "https://github.com/quarkusio/quarkus/commit/c3ff8b84265f7014325ddbf742af2d4813788cfe", "message": "Show image pull output when using a builder image\n\nFixes: #6892", "committedDate": "2020-01-31T06:15:32Z", "type": "commit"}, {"oid": "c3ff8b84265f7014325ddbf742af2d4813788cfe", "url": "https://github.com/quarkusio/quarkus/commit/c3ff8b84265f7014325ddbf742af2d4813788cfe", "message": "Show image pull output when using a builder image\n\nFixes: #6892", "committedDate": "2020-01-31T06:15:32Z", "type": "forcePushed"}]}