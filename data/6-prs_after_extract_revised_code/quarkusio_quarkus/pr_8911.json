{"pr_number": 8911, "pr_title": "Add the singleton scope to beans produced by the JsonbProducer", "pr_createdAt": "2020-04-28T12:44:32Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/8911", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416624328", "bodyText": "JsonbConfig is not thread safe. So I don't think it's a good idea to share the instance. Do we really need to expose it as a bean?", "author": "mkouba", "createdAt": "2020-04-28T13:44:01Z", "path": "extensions/jsonb/runtime/src/main/java/io/quarkus/jsonb/JsonbProducer.java", "diffHunk": "@@ -13,6 +13,7 @@\n public class JsonbProducer {\n \n     @Produces\n+    @Singleton\n     @DefaultBean\n     public JsonbConfig jsonbConfig(Instance<JsonbConfigCustomizer> customizers) {", "originalCommit": "14ac3da4c86e55893c04f4d3c5fda3791d98b831", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDU4MA==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416624580", "bodyText": "@geoand @loicmathieu ^ ?", "author": "mkouba", "createdAt": "2020-04-28T13:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNzEyMg==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416627122", "bodyText": "@mkouba ah, great catch!\nBy making it a bean users are able to supply there own configuration by means of a CDI producer, which you of course know is super helpful :).\nSo let's just remove the @Singleton here and add a comment on why we can't make it @Singleton, OK?", "author": "geoand", "createdAt": "2020-04-28T13:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYzMzM5MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416633391", "bodyText": "By making it a bean users are able to supply there own configuration by means of a CDI producer, which you of course know is super helpful :).\n\nSo an alternative could be to fire an event of type JsonbConfig when creating a Jsonb instance so that users can observe the config and modify it. But this would break the compatibility of course.\n\nSo let's just remove the @singleton here and add a comment on why we can't make it @singleton, OK?\n\nSounds good enough. If there is a doc about overriding the JsonbConfig bean we should mention it there as well.", "author": "mkouba", "createdAt": "2020-04-28T13:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0MjIxMg==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416642212", "bodyText": "@loicmathieu can you adjust your PR to only make Jsonb singleton.\nAlso I would add a comment for JsonbConfig: \"JsonbConfig is not thread safe so it must not be made singleton.\"", "author": "gsmet", "createdAt": "2020-04-28T14:06:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0NDM1MQ==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416644351", "bodyText": "must be @Dependent maybe? It can't be @ApplicationScoped or any other scope that is shared.", "author": "mkouba", "createdAt": "2020-04-28T14:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY0NDQ0MA==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416644440", "bodyText": "And also like @mkouba mentioned to mention the fact here: \n  \n    \n      quarkus/docs/src/main/asciidoc/rest-json.adoc\n    \n    \n         Line 162\n      in\n      a1380ee\n    \n    \n    \n    \n\n        \n          \n           ==== JSON-B", "author": "geoand", "createdAt": "2020-04-28T14:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY2MDEyMQ==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416660121", "bodyText": "I switch to @Dependent even if it's the default scope so it's explicit that we want it.\nI added the comment.\nI also add the two scopes to the documentation so if someone provides their own beans they know which scope to add to them.", "author": "loicmathieu", "createdAt": "2020-04-28T14:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY2MDk1MA==", "url": "https://github.com/quarkusio/quarkus/pull/8911#discussion_r416660950", "bodyText": "Great, thanks!", "author": "geoand", "createdAt": "2020-04-28T14:30:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNDMyOA=="}], "type": "inlineReview", "revised_code": {"commit": "532605411be3b49b0ca3a0a4b6a8ea85910b5b81", "chunk": "diff --git a/extensions/jsonb/runtime/src/main/java/io/quarkus/jsonb/JsonbProducer.java b/extensions/jsonb/runtime/src/main/java/io/quarkus/jsonb/JsonbProducer.java\nindex bab9fc8218..faaf4bcddb 100644\n--- a/extensions/jsonb/runtime/src/main/java/io/quarkus/jsonb/JsonbProducer.java\n+++ b/extensions/jsonb/runtime/src/main/java/io/quarkus/jsonb/JsonbProducer.java\n\n@@ -13,7 +14,7 @@ import io.quarkus.arc.DefaultBean;\n public class JsonbProducer {\n \n     @Produces\n-    @Singleton\n+    @Dependent //JsonbConfig is not thread safe so it must not be made singleton.\n     @DefaultBean\n     public JsonbConfig jsonbConfig(Instance<JsonbConfigCustomizer> customizers) {\n         JsonbConfig jsonbConfig = new JsonbConfig();\n"}}, {"oid": "532605411be3b49b0ca3a0a4b6a8ea85910b5b81", "url": "https://github.com/quarkusio/quarkus/commit/532605411be3b49b0ca3a0a4b6a8ea85910b5b81", "message": "Add the singleton scope to beans produces by the JsonbProducer", "committedDate": "2020-04-28T14:27:40Z", "type": "commit"}, {"oid": "532605411be3b49b0ca3a0a4b6a8ea85910b5b81", "url": "https://github.com/quarkusio/quarkus/commit/532605411be3b49b0ca3a0a4b6a8ea85910b5b81", "message": "Add the singleton scope to beans produces by the JsonbProducer", "committedDate": "2020-04-28T14:27:40Z", "type": "forcePushed"}]}