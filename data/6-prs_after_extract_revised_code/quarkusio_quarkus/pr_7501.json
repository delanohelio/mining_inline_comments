{"pr_number": 7501, "pr_title": "Quarkus recommended labels", "pr_createdAt": "2020-03-01T14:36:07Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7501", "timeline": [{"oid": "bbf4603b2c75902abff1e7ec8073f45f07ce981b", "url": "https://github.com/quarkusio/quarkus/commit/bbf4603b2c75902abff1e7ec8073f45f07ce981b", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-01T14:39:24Z", "type": "forcePushed"}, {"oid": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "url": "https://github.com/quarkusio/quarkus/commit/ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-01T17:06:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMjc0Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386212743", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The name of the group this component belogs too\n          \n          \n            \n                 * The name of the group this component belongs too", "author": "geoand", "createdAt": "2020-03-02T06:16:44Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KnativeConfig.java", "diffHunk": "@@ -11,11 +11,12 @@\n \n @ConfigRoot\n public class KnativeConfig implements PlatformConfiguration {\n+\n     /**\n-     * The group of the application.\n+     * The name of the group this component belogs too", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KnativeConfig.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KnativeConfig.java\nindex 262667d075..69d26abe30 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KnativeConfig.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KnativeConfig.java\n\n@@ -13,7 +13,7 @@ import io.quarkus.runtime.annotations.ConfigRoot;\n public class KnativeConfig implements PlatformConfiguration {\n \n     /**\n-     * The name of the group this component belogs too\n+     * The name of the group this component belongs too\n      */\n     @ConfigItem\n     Optional<String> partOf;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMjc3OA==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386212778", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The name of the group this component belogs too\n          \n          \n            \n                 * The name of the group this component belongs too", "author": "geoand", "createdAt": "2020-03-02T06:16:54Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesConfig.java", "diffHunk": "@@ -13,10 +13,10 @@\n public class KubernetesConfig implements PlatformConfiguration {\n \n     /**\n-     * The group of the application.\n+     * The name of the group this component belogs too", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesConfig.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesConfig.java\nindex e9a4202b2d..1887a433ec 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesConfig.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesConfig.java\n\n@@ -13,7 +13,7 @@ import io.quarkus.runtime.annotations.ConfigRoot;\n public class KubernetesConfig implements PlatformConfiguration {\n \n     /**\n-     * The name of the group this component belogs too\n+     * The name of the group this component belongs too\n      */\n     @ConfigItem\n     Optional<String> partOf;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMjgxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386212815", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The name of the group this component belogs too\n          \n          \n            \n                 * The name of the group this component belongs too", "author": "geoand", "createdAt": "2020-03-02T06:17:05Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/OpenshiftConfig.java", "diffHunk": "@@ -14,10 +14,10 @@\n public class OpenshiftConfig implements PlatformConfiguration {\n \n     /**\n-     * The group of the application.\n+     * The name of the group this component belogs too", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/OpenshiftConfig.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/OpenshiftConfig.java\nindex 0791cddafd..de9af2242d 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/OpenshiftConfig.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/OpenshiftConfig.java\n\n@@ -14,7 +14,7 @@ import io.quarkus.runtime.annotations.ConfigRoot;\n public class OpenshiftConfig implements PlatformConfiguration {\n \n     /**\n-     * The name of the group this component belogs too\n+     * The name of the group this component belongs too\n      */\n     @ConfigItem\n     Optional<String> partOf;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxMzI1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386213253", "bodyText": "This comment seems to have been removed from the code that adds ApplyContainerImageDecorator. Should it be re-added sicne the issue is still open or has the issue been side-stepped?", "author": "geoand", "createdAt": "2020-03-02T06:18:58Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -370,16 +374,14 @@ private void applyBuildItems(Session session,\n         String openshiftName = openshiftConfig.name.orElse(name);\n         String knativeName = knativeConfig.name.orElse(name);\n \n-        //TODO: This is needed until https://github.com/dekorateio/dekorate/issues/456 is resolved.", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "80572c6518a62b8702b77cafe94dbb2d38fcc664", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\nindex 8e41a552ec..59256cb9a9 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n\n@@ -374,14 +393,16 @@ class KubernetesProcessor {\n         String openshiftName = openshiftConfig.name.orElse(name);\n         String knativeName = knativeConfig.name.orElse(name);\n \n+        //TODO: This is needed until https://github.com/dekorateio/dekorate/issues/456 is resolved.\n+        containerImageBuildItem\n+                .ifPresent(c -> session.resources().decorate(new ApplyImageDecorator(kubernetesName, c.getImage())));\n+\n         containerImageBuildItem.ifPresent(\n-                c -> session.resources().decorate(KUBERNETES, new ApplyContainerImageDecorator(kubernetesName, c.getImage())));\n+                c -> session.resources().decorate(KUBERNETES, new ApplyImageDecorator(kubernetesName, c.getImage())));\n         containerImageBuildItem\n-                .ifPresent(c -> session.resources().decorate(OPENSHIFT,\n-                        new ApplyContainerImageDecorator(openshiftName, c.getImage())));\n+                .ifPresent(c -> session.resources().decorate(OPENSHIFT, new ApplyImageDecorator(openshiftName, c.getImage())));\n         containerImageBuildItem\n-                .ifPresent(c -> session.resources().decorate(KNATIVE,\n-                        new ApplyContainerImageDecorator(knativeName, c.getImage())));\n+                .ifPresent(c -> session.resources().decorate(KNATIVE, new ApplyImageDecorator(knativeName, c.getImage())));\n \n         //Handle Command and arguments\n         commandBuildItem.ifPresent(c -> {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxNDUwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386214505", "bodyText": "With these changes DOCKER_REGISTRY_PROPERTY and APP_GROUP_PROPERTY are no longer used", "author": "geoand", "createdAt": "2020-03-02T06:24:32Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -151,65 +156,48 @@ public void build(ApplicationInfoBuildItem applicationInfo,\n                 .map(KubernetesDeploymentTargetBuildItem::getName)\n                 .collect(Collectors.toSet());\n \n-        // this is a hack to get kubernetes.registry working because currently it's not supported as is in Dekorate\n-        Optional<String> dockerRegistry = KubernetesConfigUtil.getDockerRegistry(config);\n-        dockerRegistry.ifPresent(v -> System.setProperty(DOCKER_REGISTRY_PROPERTY, v));\n-\n-        // this is a hack to work around Dekorate using the default group for some of the properties\n-        Optional<String> kubernetesGroup = KubernetesConfigUtil.getGroup(config);\n-        kubernetesGroup.ifPresent(v -> System.setProperty(APP_GROUP_PROPERTY, v));", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\nindex 8e41a552ec..e3d047cb11 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n\n@@ -158,6 +155,7 @@ class KubernetesProcessor {\n \n         Path artifactPath = archiveRootBuildItem.getArchiveRoot().resolve(\n                 String.format(OUTPUT_ARTIFACT_FORMAT, outputTargetBuildItem.getBaseName(), packageConfig.runnerSuffix));\n+\n         final Map<String, String> generatedResourcesMap;\n         // by passing false to SimpleFileWriter, we ensure that no files are actually written during this phase\n         final SessionWriter sessionWriter = new SimpleFileWriter(root, false);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxNDg4Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7501#discussion_r386214883", "bodyText": "Can we have a comment here please explaining that dekorate adds these automatically and we want to replace them with more specific ones?", "author": "geoand", "createdAt": "2020-03-02T06:26:23Z", "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -259,20 +247,36 @@ private void applyGlobalConfig(Session session, KubernetesConfig config) {\n      * @param config The {@link PlatformConfiguration} instance\n      * @param now\n      */\n-    private void applyConfig(Session session, String target, String name, PlatformConfiguration config, ZonedDateTime now) {\n+    private void applyConfig(Session session, Project project, String target, String name, PlatformConfiguration config,\n+            ZonedDateTime now) {\n         //Labels\n         config.getLabels().forEach((key, value) -> {\n             session.resources().decorate(target, new AddLabelDecorator(new Label(key, value)));\n         });\n \n+        if (OPENSHIFT.equals(target)) {\n+            session.resources().decorate(OPENSHIFT, new AddLabelDecorator(new Label(OPENSHIFT_APP_RUNTIME, QUARKUS)));\n+        }\n+\n         //Annotations\n         config.getAnnotations().forEach((key, value) -> {\n             session.resources().decorate(target, new AddAnnotationDecorator(new Annotation(key, value)));\n         });\n+\n+        ScmInfo scm = project.getScmInfo();\n+        String vcsUrl = scm != null ? scm.getUrl() : Annotations.UNKNOWN;\n+        String commitId = scm != null ? scm.getCommit() : Annotations.UNKNOWN;\n+\n+        session.resources().decorate(target, new RemoveAnnotationDecorator(Annotations.VCS_URL));\n+        session.resources().decorate(target, new RemoveAnnotationDecorator(Annotations.COMMIT_ID));", "originalCommit": "ce73d842b69cc91afd68cbc8ae74127f3fa2b337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "chunk": "diff --git a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\nindex 8e41a552ec..e3d047cb11 100644\n--- a/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n+++ b/extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java\n\n@@ -267,6 +265,7 @@ class KubernetesProcessor {\n         String vcsUrl = scm != null ? scm.getUrl() : Annotations.UNKNOWN;\n         String commitId = scm != null ? scm.getCommit() : Annotations.UNKNOWN;\n \n+        //Dekorate uses its own annotations. Let's replace them with the quarkus ones.\n         session.resources().decorate(target, new RemoveAnnotationDecorator(Annotations.VCS_URL));\n         session.resources().decorate(target, new RemoveAnnotationDecorator(Annotations.COMMIT_ID));\n         //Add quarkus vcs annotations\n"}}, {"oid": "be495a1a8b48b84902f5e1bd41a3e1ef47a2a661", "url": "https://github.com/quarkusio/quarkus/commit/be495a1a8b48b84902f5e1bd41a3e1ef47a2a661", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-03T12:35:45Z", "type": "forcePushed"}, {"oid": "d3cfa95eef5826bed2589a39459961c2795ee5af", "url": "https://github.com/quarkusio/quarkus/commit/d3cfa95eef5826bed2589a39459961c2795ee5af", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-03T13:29:08Z", "type": "forcePushed"}, {"oid": "e1c8c906274bbc23f3f4677f76af3a49172c95ce", "url": "https://github.com/quarkusio/quarkus/commit/e1c8c906274bbc23f3f4677f76af3a49172c95ce", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-03T13:44:18Z", "type": "forcePushed"}, {"oid": "068eb985325fc7456f2f8da552737cb58e837ed0", "url": "https://github.com/quarkusio/quarkus/commit/068eb985325fc7456f2f8da552737cb58e837ed0", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-03T14:08:08Z", "type": "forcePushed"}, {"oid": "b9da790bd76943a155db75f699c4e7648d5d8575", "url": "https://github.com/quarkusio/quarkus/commit/b9da790bd76943a155db75f699c4e7648d5d8575", "message": "chore: Show warning about certs on s2i builds too", "committedDate": "2020-03-03T19:14:12Z", "type": "forcePushed"}, {"oid": "80572c6518a62b8702b77cafe94dbb2d38fcc664", "url": "https://github.com/quarkusio/quarkus/commit/80572c6518a62b8702b77cafe94dbb2d38fcc664", "message": "feat: Add custom labels for vcs info", "committedDate": "2020-03-05T11:12:34Z", "type": "commit"}, {"oid": "4d763a7f2eef488f49f0e1086ce8587c2eb3f04b", "url": "https://github.com/quarkusio/quarkus/commit/4d763a7f2eef488f49f0e1086ce8587c2eb3f04b", "message": "feat: Adopt recommended k8s/openshift labels", "committedDate": "2020-03-05T11:13:25Z", "type": "commit"}, {"oid": "ce576fd9312e18f2e750dad142aa88f6a8a741a4", "url": "https://github.com/quarkusio/quarkus/commit/ce576fd9312e18f2e750dad142aa88f6a8a741a4", "message": "fix: Openshift DEPLOYMENT_CONFIG constant", "committedDate": "2020-03-05T11:13:25Z", "type": "commit"}, {"oid": "7e307b1ed012fd94d185cc2030d6a57b9764f638", "url": "https://github.com/quarkusio/quarkus/commit/7e307b1ed012fd94d185cc2030d6a57b9764f638", "message": "doc: Align kubernetes.adoc with recent changes", "committedDate": "2020-03-05T11:13:25Z", "type": "commit"}, {"oid": "2e53b5e6c9ba4c5a26c277761a8297991a8d4ffa", "url": "https://github.com/quarkusio/quarkus/commit/2e53b5e6c9ba4c5a26c277761a8297991a8d4ffa", "message": "feat: Adopt recommended k8s/openshift labels", "committedDate": "2020-03-05T11:13:25Z", "type": "commit"}, {"oid": "f3f85159afe3cffccb8637f6591a791cc945644c", "url": "https://github.com/quarkusio/quarkus/commit/f3f85159afe3cffccb8637f6591a791cc945644c", "message": "chore: Show warning about certs on s2i builds too", "committedDate": "2020-03-05T11:13:25Z", "type": "commit"}, {"oid": "f3f85159afe3cffccb8637f6591a791cc945644c", "url": "https://github.com/quarkusio/quarkus/commit/f3f85159afe3cffccb8637f6591a791cc945644c", "message": "chore: Show warning about certs on s2i builds too", "committedDate": "2020-03-05T11:13:25Z", "type": "forcePushed"}]}