{"pr_number": 7073, "pr_title": "Handle MongoDB BsonDiscriminator", "pr_createdAt": "2020-02-07T13:43:34Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7073", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg5Njc5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7073#discussion_r376896790", "bodyText": "I don't think this can happen really... And if it does it's doubtful that AbstractMongoClientProducer.class.getClassLoader() will save you (certainly not dev mode that is :))", "author": "geoand", "createdAt": "2020-02-10T07:17:13Z", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java", "diffHunk": "@@ -217,11 +219,24 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n         }\n         // add pojo codec provider with automatic capabilities\n         // it always needs to be the last codec provided\n-        CodecProvider pojoCodecProvider = PojoCodecProvider.builder()\n+        PojoCodecProvider.Builder pojoCodecProviderBuilder = PojoCodecProvider.builder()\n                 .automatic(true)\n-                .conventions(Conventions.DEFAULT_CONVENTIONS)\n-                .build();\n-        providers.add(pojoCodecProvider);\n+                .conventions(Conventions.DEFAULT_CONVENTIONS);\n+        // register bson discriminators\n+        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n+        if (classLoader == null) {", "originalCommit": "c6a896a63e66f1f9f36200f7ce195416ddd55ebf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyODA5Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7073#discussion_r376928097", "bodyText": "I copied this pattern from the Smallrye Fault Tolerance extension, and I just check almost all extensions directly used Thread.currentThread().getContextClassLoader() so it should be safe to use it.", "author": "loicmathieu", "createdAt": "2020-02-10T08:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg5Njc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkzMDEzOQ==", "url": "https://github.com/quarkusio/quarkus/pull/7073#discussion_r376930139", "bodyText": "Yeah, I can't see a scenario where Thread.currentThread().getContextClassLoader() will return null. In any case this is very minor so it's not worth putting too much thought into it", "author": "geoand", "createdAt": "2020-02-10T08:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg5Njc5MA=="}], "type": "inlineReview", "revised_code": {"commit": "191c53d660651a6890dd41084fd86b49a4c9c1a7", "chunk": "diff --git a/extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java b/extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java\nindex f70ec5c54f..d18bc6c831 100644\n--- a/extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java\n+++ b/extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java\n\n@@ -224,9 +224,6 @@ public abstract class AbstractMongoClientProducer {\n                 .conventions(Conventions.DEFAULT_CONVENTIONS);\n         // register bson discriminators\n         ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n-        if (classLoader == null) {\n-            classLoader = AbstractMongoClientProducer.class.getClassLoader();\n-        }\n         for (String bsonDiscriminator : bsonDiscriminators) {\n             try {\n                 pojoCodecProviderBuilder\n"}}, {"oid": "191c53d660651a6890dd41084fd86b49a4c9c1a7", "url": "https://github.com/quarkusio/quarkus/commit/191c53d660651a6890dd41084fd86b49a4c9c1a7", "message": "Handle MongoDB BsonDiscriminator\n\nFixes #6292", "committedDate": "2020-02-10T09:01:07Z", "type": "forcePushed"}, {"oid": "9ee1c84725054f8a7a8036e4c4e22ae9badeffb7", "url": "https://github.com/quarkusio/quarkus/commit/9ee1c84725054f8a7a8036e4c4e22ae9badeffb7", "message": "Handle MongoDB BsonDiscriminator\n\nFixes #6292", "committedDate": "2020-02-10T12:12:57Z", "type": "commit"}, {"oid": "9ee1c84725054f8a7a8036e4c4e22ae9badeffb7", "url": "https://github.com/quarkusio/quarkus/commit/9ee1c84725054f8a7a8036e4c4e22ae9badeffb7", "message": "Handle MongoDB BsonDiscriminator\n\nFixes #6292", "committedDate": "2020-02-10T12:12:57Z", "type": "forcePushed"}]}