{"pr_number": 6681, "pr_title": "Ensure that a missing user.country system property doesn't break the application", "pr_createdAt": "2020-01-21T12:41:23Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/6681", "timeline": [{"oid": "a6047d02efdbe949ac0ee1a3db11bdea6019828c", "url": "https://github.com/quarkusio/quarkus/commit/a6047d02efdbe949ac0ee1a3db11bdea6019828c", "message": "Ensure that a missing user.country system property doesn't break the application\n\nThis can happen in CI:\nhttps://github.com/apache/camel-quarkus/pull/603#issuecomment-576636989\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T12:45:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxMDQyMw==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369010423", "bodyText": "The idea here is to return null only when no locale value is set explicitly, but instead the defaults are both empty. This allows the user explicitly set locale strings like en- or en-US even when there are no default values.\nIf the default values are empty and the user doesn't specify any locales, then a higher up layer will end up throwing an exception like:\njava.lang.RuntimeException: java.util.NoSuchElementException: Property quarkus.locales not found", "author": "geoand", "createdAt": "2020-01-21T13:50:49Z", "path": "core/runtime/src/main/java/io/quarkus/runtime/configuration/LocaleConverter.java", "diffHunk": "@@ -29,6 +32,11 @@ public Locale convert(final String value) {\n             return null;\n         }\n \n+        if (localeValue.equals(\"-\")) {", "originalCommit": "19c60b6107a49b0c3f8eddafbf8c1055a407ef1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxMTEwNQ==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369011105", "bodyText": "In this case the warning message will at least give the user the opportunity to know to set user.language instead of having to set quarkus.locales and quarkus.default-locale", "author": "geoand", "createdAt": "2020-01-21T13:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxMDQyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyNTczNg==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369025736", "bodyText": "After talking we @gsmet we decided to use en as the last line of defence, so this stuff is no longer needed", "author": "geoand", "createdAt": "2020-01-21T14:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxMDQyMw=="}], "type": "inlineReview", "revised_code": {"commit": "f93e01a5de5c893b088bed09f04a94480dfe1fde", "chunk": "diff --git a/core/runtime/src/main/java/io/quarkus/runtime/configuration/LocaleConverter.java b/core/runtime/src/main/java/io/quarkus/runtime/configuration/LocaleConverter.java\nindex f63671c78c..304668aa73 100644\n--- a/core/runtime/src/main/java/io/quarkus/runtime/configuration/LocaleConverter.java\n+++ b/core/runtime/src/main/java/io/quarkus/runtime/configuration/LocaleConverter.java\n\n@@ -32,11 +29,6 @@ public class LocaleConverter implements Converter<Locale>, Serializable {\n             return null;\n         }\n \n-        if (localeValue.equals(\"-\")) {\n-            log.warn(\"No user language was set. This can be done by setting the 'user.language' property\");\n-            return null;\n-        }\n-\n         Locale locale = Locale.forLanguageTag(NORMALIZE_LOCALE_PATTERN.matcher(localeValue).replaceAll(\"-\"));\n         if (locale.getLanguage() == null || locale.getLanguage().isEmpty()) {\n             throw new IllegalArgumentException(\"Unable to resolve locale: \" + value);\n"}}, {"oid": "f93e01a5de5c893b088bed09f04a94480dfe1fde", "url": "https://github.com/quarkusio/quarkus/commit/f93e01a5de5c893b088bed09f04a94480dfe1fde", "message": "Use en as the default language when all else is empty\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T14:14:43Z", "type": "forcePushed"}, {"oid": "fbb246d00bc2d7eed07e9544b409f8e1676f02de", "url": "https://github.com/quarkusio/quarkus/commit/fbb246d00bc2d7eed07e9544b409f8e1676f02de", "message": "Use en as the default language when all else is empty\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T14:15:51Z", "type": "forcePushed"}, {"oid": "c9a79be6b4d18e0b2ae1eeeac396c5778e690629", "url": "https://github.com/quarkusio/quarkus/commit/c9a79be6b4d18e0b2ae1eeeac396c5778e690629", "message": "Use en as the default language when all else is empty\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T16:03:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA5NDY1OA==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369094658", "bodyText": "Why not use the @BeforeAll annotation in a static method?", "author": "gastaldi", "createdAt": "2020-01-21T16:09:31Z", "path": "test-framework/junit5-internal/src/main/java/io/quarkus/test/QuarkusUnitTest.java", "diffHunk": "@@ -133,6 +135,18 @@ public QuarkusUnitTest setLogFileName(String logFileName) {\n         return this;\n     }\n \n+    // set a Runnable that will run before ANYTHING else is done\n+    public QuarkusUnitTest setBeforeAllCustomizer(Runnable beforeAllCustomizer) {\n+        this.beforeAllCustomizer = beforeAllCustomizer;", "originalCommit": "c9a79be6b4d18e0b2ae1eeeac396c5778e690629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEwMTUxOQ==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369101519", "bodyText": "That's the first thing I tried \ud83d\ude09 . However that is executed after the Quarkus extension and I needed it to execute before the build.", "author": "geoand", "createdAt": "2020-01-21T16:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA5NDY1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA5OTQwMA==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369099400", "bodyText": "Using @BeforeAll and @AfterAll static methods should be the standard way of invoking code before and after tests (If not through a junit extension using callbacks). Not sure if it's worth adding another strategy to do the same thing, unless I am missing something, of course", "author": "gastaldi", "createdAt": "2020-01-21T16:17:30Z", "path": "extensions/hibernate-validator/deployment/src/test/java/io/quarkus/hibernate/validator/test/UserCountryNotSetValidatorLocaleTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package io.quarkus.hibernate.validator.test;\n+\n+import javax.inject.Inject;\n+import javax.validation.ValidatorFactory;\n+import javax.validation.constraints.Pattern;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.asset.StringAsset;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class UserCountryNotSetValidatorLocaleTest {\n+\n+    @Inject\n+    ValidatorFactory validatorFactory;\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest test = new QuarkusUnitTest().setArchiveProducer(() -> ShrinkWrap\n+            .create(JavaArchive.class).addClasses(Bean.class)\n+            .addAsResource(new StringAsset(\"foo=bar\"), \"application.properties\"))\n+            .setBeforeAllCustomizer(new Runnable() {\n+                @Override\n+                public void run() {\n+                    userCountry = System.clearProperty(\"user.country\");\n+                    userLanguage = System.clearProperty(\"user.language\");\n+                }\n+            }).setAfterAllCustomizer(new Runnable() {\n+                @Override\n+                public void run() {\n+                    System.setProperty(\"user.country\", userCountry);\n+                    System.setProperty(\"user.language\", userLanguage);\n+                }", "originalCommit": "c9a79be6b4d18e0b2ae1eeeac396c5778e690629", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTEwMTY2Mw==", "url": "https://github.com/quarkusio/quarkus/pull/6681#discussion_r369101663", "bodyText": "See my comment above", "author": "geoand", "createdAt": "2020-01-21T16:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA5OTQwMA=="}], "type": "inlineReview", "revised_code": {"commit": "c92a512b5aa4fe3d885ffe8a4a99f5aa9cf9f35f", "chunk": "diff --git a/extensions/hibernate-validator/deployment/src/test/java/io/quarkus/hibernate/validator/test/UserCountryNotSetValidatorLocaleTest.java b/extensions/hibernate-validator/deployment/src/test/java/io/quarkus/hibernate/validator/test/UserCountryNotSetValidatorLocaleTest.java\ndeleted file mode 100644\nindex 47206adc1c..0000000000\n--- a/extensions/hibernate-validator/deployment/src/test/java/io/quarkus/hibernate/validator/test/UserCountryNotSetValidatorLocaleTest.java\n+++ /dev/null\n\n@@ -1,56 +0,0 @@\n-package io.quarkus.hibernate.validator.test;\n-\n-import javax.inject.Inject;\n-import javax.validation.ValidatorFactory;\n-import javax.validation.constraints.Pattern;\n-\n-import org.jboss.shrinkwrap.api.ShrinkWrap;\n-import org.jboss.shrinkwrap.api.asset.StringAsset;\n-import org.jboss.shrinkwrap.api.spec.JavaArchive;\n-import org.junit.jupiter.api.Test;\n-import org.junit.jupiter.api.extension.RegisterExtension;\n-\n-import io.quarkus.test.QuarkusUnitTest;\n-\n-public class UserCountryNotSetValidatorLocaleTest {\n-\n-    @Inject\n-    ValidatorFactory validatorFactory;\n-\n-    @RegisterExtension\n-    static final QuarkusUnitTest test = new QuarkusUnitTest().setArchiveProducer(() -> ShrinkWrap\n-            .create(JavaArchive.class).addClasses(Bean.class)\n-            .addAsResource(new StringAsset(\"foo=bar\"), \"application.properties\"))\n-            .setBeforeAllCustomizer(new Runnable() {\n-                @Override\n-                public void run() {\n-                    userCountry = System.clearProperty(\"user.country\");\n-                    userLanguage = System.clearProperty(\"user.language\");\n-                }\n-            }).setAfterAllCustomizer(new Runnable() {\n-                @Override\n-                public void run() {\n-                    System.setProperty(\"user.country\", userCountry);\n-                    System.setProperty(\"user.language\", userLanguage);\n-                }\n-            });\n-\n-    private static String userCountry;\n-    private static String userLanguage;\n-\n-    @Test\n-    public void testApplicationStarts() {\n-        // we don't really need to test anything, just make sure that the application starts\n-    }\n-\n-    static class Bean {\n-\n-        public Bean(String name) {\n-            super();\n-            this.name = name;\n-        }\n-\n-        @Pattern(regexp = \"A.*\", message = \"{pattern.message}\")\n-        private String name;\n-    }\n-}\n"}}, {"oid": "c92a512b5aa4fe3d885ffe8a4a99f5aa9cf9f35f", "url": "https://github.com/quarkusio/quarkus/commit/c92a512b5aa4fe3d885ffe8a4a99f5aa9cf9f35f", "message": "Add beforeAll and afterAll hooks for QuarkusUnitTest", "committedDate": "2020-01-21T19:13:47Z", "type": "commit"}, {"oid": "d8aa18536798829868d180f48e0e5ef889cf2383", "url": "https://github.com/quarkusio/quarkus/commit/d8aa18536798829868d180f48e0e5ef889cf2383", "message": "Ensure that a missing user.country system property doesn't break the application\n\nThis can happen in CI:\nhttps://github.com/apache/camel-quarkus/pull/603#issuecomment-576636989\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T19:13:47Z", "type": "commit"}, {"oid": "a79162e32110839f86f584ba0ef898d699f56e6b", "url": "https://github.com/quarkusio/quarkus/commit/a79162e32110839f86f584ba0ef898d699f56e6b", "message": "Use en as the default language when all else is empty\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T19:13:47Z", "type": "commit"}, {"oid": "a79162e32110839f86f584ba0ef898d699f56e6b", "url": "https://github.com/quarkusio/quarkus/commit/a79162e32110839f86f584ba0ef898d699f56e6b", "message": "Use en as the default language when all else is empty\n\nCo-Authored-By: Guillaume Smet <guillaume.smet@gmail.com>", "committedDate": "2020-01-21T19:13:47Z", "type": "forcePushed"}]}