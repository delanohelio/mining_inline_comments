{"pr_number": 60221, "pr_title": "[ML] Improve assertion on regression alias field test", "pr_createdAt": "2020-07-27T15:15:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60221", "timeline": [{"oid": "378b62429b188568e84b83b6a6e4c288b5a0ffcc", "url": "https://github.com/elastic/elasticsearch/commit/378b62429b188568e84b83b6a6e4c288b5a0ffcc", "message": "[ML] Improve assertion on regression alias field test\n\nPreviously the test was asserting the prediction on each document\nwas close 10.0 from the expected. It turned out that was not enough\nas we occasionally saw the test failing by little.\n\nInstead of relaxing that assertion, this commit changes it to\nassert the mean prediction error is less than 10.0. This should\nreduce the chances of the test failing significantly.\n\nFixes #60212", "committedDate": "2020-07-27T15:13:51Z", "type": "commit"}, {"oid": "84342b1cad1386c3bfa8887019f1ab07e63d892c", "url": "https://github.com/elastic/elasticsearch/commit/84342b1cad1386c3bfa8887019f1ab07e63d892c", "message": "Remove unused import", "committedDate": "2020-07-27T15:33:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NjA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60221#discussion_r461386041", "bodyText": "I'm wondering if we could drop the Math.abs here. This would of course increase the chance of the assertion in line 564 to pass but maybe it is not necessary.", "author": "przemekwitek", "createdAt": "2020-07-28T07:49:37Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -544,19 +543,26 @@ public void testAliasFields() throws Exception {\n         startAnalytics(jobId);\n         waitUntilAnalyticsIsStopped(jobId);\n \n+        double predictionErrorSum = 0.0;\n+\n         SearchResponse sourceData = client().prepareSearch(sourceIndex).setSize(totalDocCount).get();\n         for (SearchHit hit : sourceData.getHits()) {\n             Map<String, Object> destDoc = getDestDoc(config, hit);\n             Map<String, Object> resultsObject = getMlResultsObjectFromDestDoc(destDoc);\n \n-            int featureValue = (int) destDoc.get(\"field_1\");\n-            double predictionValue = (double) resultsObject.get(predictionField);\n-            assertThat(predictionValue, closeTo(2 * featureValue, 10.0));\n-\n             assertThat(resultsObject.containsKey(predictionField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n+\n+            int featureValue = (int) destDoc.get(\"field_1\");\n+            double predictionValue = (double) resultsObject.get(predictionField);\n+            predictionErrorSum += Math.abs(predictionValue - 2 * featureValue);", "originalCommit": "84342b1cad1386c3bfa8887019f1ab07e63d892c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM5NDk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/60221#discussion_r461394944", "bodyText": "We are interested in how far the prediction is from what we expect. Dropping the abs would mean that 2 errors that are opposite direction would cancel each other out and possibly this could hide the fact that the error is too large.", "author": "dimitris-athanasiou", "createdAt": "2020-07-28T08:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NjA0MQ=="}], "type": "inlineReview", "revised_code": null}]}