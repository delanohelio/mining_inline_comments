{"pr_number": 51232, "pr_title": "[ML] Validate classification dependent_variable cardinality is at lea\u2026", "pr_createdAt": "2020-01-20T16:59:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51232", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1NzA5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r368657093", "bodyText": "s/limits/constraints\n?", "author": "przemekwitek", "createdAt": "2020-01-20T17:16:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java", "diffHunk": "@@ -37,9 +37,9 @@\n     List<RequiredField> getRequiredFields();\n \n     /**\n-     * @return {@link Map} containing cardinality limits for the selected (analysis-specific) fields\n+     * @return {@link List} containing cardinality limits for the selected (analysis-specific) fields", "originalCommit": "017be7852fb418eae981d8f3556df7e587277eab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\nindex f879c62b44e..0c71bc35f7c 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\n\n@@ -42,15 +42,13 @@ public interface DataFrameAnalysis extends ToXContentObject, NamedWriteable {\n     List<FieldCardinalityConstraint> getFieldCardinalityLimits();\n \n     /**\n-     * Returns fields for which the mappings should be copied from source index to destination index.\n-     * Each entry of the returned {@link Map} is of the form:\n-     *   key   - field path in the destination index\n-     *   value - field path in the source index from which the mapping should be taken\n+     * Returns fields for which the mappings should be either predefined or copied from source index to destination index.\n      *\n+     * @param mappingsProperties mappings.properties portion of the index mappings\n      * @param resultsFieldName name of the results field under which all the results are stored\n-     * @return {@link Map} containing fields for which the mappings should be copied from source index to destination index\n+     * @return {@link Map} containing fields for which the mappings should be handled explicitly\n      */\n-    Map<String, String> getExplicitlyMappedFields(String resultsFieldName);\n+    Map<String, Object> getExplicitlyMappedFields(Map<String, Object> mappingsProperties, String resultsFieldName);\n \n     /**\n      * @return {@code true} if this analysis supports data frame rows with missing values\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1NzIwMg==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r368657202", "bodyText": "s/Limits/Constraints\n?", "author": "przemekwitek", "createdAt": "2020-01-20T17:16:19Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java", "diffHunk": "@@ -37,9 +37,9 @@\n     List<RequiredField> getRequiredFields();\n \n     /**\n-     * @return {@link Map} containing cardinality limits for the selected (analysis-specific) fields\n+     * @return {@link List} containing cardinality limits for the selected (analysis-specific) fields\n      */\n-    Map<String, Long> getFieldCardinalityLimits();\n+    List<FieldCardinalityConstraint> getFieldCardinalityLimits();", "originalCommit": "017be7852fb418eae981d8f3556df7e587277eab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\nindex f879c62b44e..0c71bc35f7c 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/DataFrameAnalysis.java\n\n@@ -42,15 +42,13 @@ public interface DataFrameAnalysis extends ToXContentObject, NamedWriteable {\n     List<FieldCardinalityConstraint> getFieldCardinalityLimits();\n \n     /**\n-     * Returns fields for which the mappings should be copied from source index to destination index.\n-     * Each entry of the returned {@link Map} is of the form:\n-     *   key   - field path in the destination index\n-     *   value - field path in the source index from which the mapping should be taken\n+     * Returns fields for which the mappings should be either predefined or copied from source index to destination index.\n      *\n+     * @param mappingsProperties mappings.properties portion of the index mappings\n      * @param resultsFieldName name of the results field under which all the results are stored\n-     * @return {@link Map} containing fields for which the mappings should be copied from source index to destination index\n+     * @return {@link Map} containing fields for which the mappings should be handled explicitly\n      */\n-    Map<String, String> getExplicitlyMappedFields(String resultsFieldName);\n+    Map<String, Object> getExplicitlyMappedFields(Map<String, Object> mappingsProperties, String resultsFieldName);\n \n     /**\n      * @return {@code true} if this analysis supports data frame rows with missing values\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1ODIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r368658211", "bodyText": "There is a \"Matchers.empty()\" matcher that could be used here.", "author": "przemekwitek", "createdAt": "2020-01-20T17:19:03Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/OutlierDetectionTests.java", "diffHunk": "@@ -89,7 +89,7 @@ public void testRequiredFieldsIsEmpty() {\n     }\n \n     public void testFieldCardinalityLimitsIsEmpty() {\n-        assertThat(createTestInstance().getFieldCardinalityLimits(), is(anEmptyMap()));\n+        assertThat(createTestInstance().getFieldCardinalityLimits().isEmpty(), is(true));", "originalCommit": "017be7852fb418eae981d8f3556df7e587277eab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/OutlierDetectionTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/OutlierDetectionTests.java\nindex 78ccd5cc971..0ce016ae856 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/OutlierDetectionTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/OutlierDetectionTests.java\n\n@@ -92,8 +92,8 @@ public class OutlierDetectionTests extends AbstractSerializingTestCase<OutlierDe\n         assertThat(createTestInstance().getFieldCardinalityLimits().isEmpty(), is(true));\n     }\n \n-    public void testFieldMappingsToCopyIsEmpty() {\n-        assertThat(createTestInstance().getExplicitlyMappedFields(\"\"), is(anEmptyMap()));\n+    public void testGetExplicitlyMappedFields() {\n+        assertThat(createTestInstance().getExplicitlyMappedFields(null, null), is(anEmptyMap()));\n     }\n \n     public void testGetStateDocId() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1ODI0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r368658247", "bodyText": "There is a \"Matchers.empty()\" matcher that could be used here.", "author": "przemekwitek", "createdAt": "2020-01-20T17:19:09Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java", "diffHunk": "@@ -106,7 +106,7 @@ public void testRequiredFieldsIsNonEmpty() {\n     }\n \n     public void testFieldCardinalityLimitsIsEmpty() {\n-        assertThat(createTestInstance().getFieldCardinalityLimits(), is(anEmptyMap()));\n+        assertThat(createTestInstance().getFieldCardinalityLimits().isEmpty(), is(true));", "originalCommit": "017be7852fb418eae981d8f3556df7e587277eab", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java\nindex 08669ead520..3decfa33e43 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java\n\n@@ -109,8 +110,10 @@ public class RegressionTests extends AbstractSerializingTestCase<Regression> {\n         assertThat(createTestInstance().getFieldCardinalityLimits().isEmpty(), is(true));\n     }\n \n-    public void testFieldMappingsToCopyIsNonEmpty() {\n-        assertThat(createTestInstance().getExplicitlyMappedFields(\"\"), is(not(anEmptyMap())));\n+    public void testGetExplicitlyMappedFields() {\n+        assertThat(\n+            new Regression(\"foo\").getExplicitlyMappedFields(null, \"results\"),\n+            hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"type\", \"double\")));\n     }\n \n     public void testGetStateDocId() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA2MTI5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r369061296", "bodyText": "Note that this is now necessary as we are checking the field cardinality before we call startAnalytics which refreshes the dest index.", "author": "dimitris-athanasiou", "createdAt": "2020-01-21T15:16:33Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -177,6 +177,7 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n         ActionListener<CreateIndexResponse> copyIndexCreatedListener = ActionListener.wrap(\n             createIndexResponse -> {\n                 ReindexRequest reindexRequest = new ReindexRequest();\n+                reindexRequest.setRefresh(true);", "originalCommit": "f96b35073794e10e5a36718c3367ff48fc330392", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\nindex 6f70b9b6d6d..6bcd22997fb 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\n\n@@ -177,7 +177,6 @@ public class DataFrameAnalyticsManager {\n         ActionListener<CreateIndexResponse> copyIndexCreatedListener = ActionListener.wrap(\n             createIndexResponse -> {\n                 ReindexRequest reindexRequest = new ReindexRequest();\n-                reindexRequest.setRefresh(true);\n                 reindexRequest.setSourceIndices(config.getSource().getIndex());\n                 reindexRequest.setSourceQuery(config.getSource().getParsedQuery());\n                 reindexRequest.getSearchRequest().source().fetchSource(config.getSource().getSourceFiltering());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3MDMzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r369070335", "bodyText": "Should this be reverted?", "author": "przemekwitek", "createdAt": "2020-01-21T15:30:52Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -492,7 +492,7 @@ private void initialize(String jobId) {\n         this.jobId = jobId;\n         this.sourceIndex = jobId + \"_source_index\";\n         this.destIndex = sourceIndex + \"_results\";\n-        this.analysisUsesExistingDestIndex = randomBoolean();\n+        this.analysisUsesExistingDestIndex = false;", "originalCommit": "f96b35073794e10e5a36718c3367ff48fc330392", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA5MDE1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51232#discussion_r369090155", "bodyText": "Ah, yes of course.", "author": "dimitris-athanasiou", "createdAt": "2020-01-21T16:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTA3MDMzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\nindex 5bd3b8ddcec..96f8047bfab 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n\n@@ -492,7 +489,7 @@ public class ClassificationIT extends MlNativeDataFrameAnalyticsIntegTestCase {\n         this.jobId = jobId;\n         this.sourceIndex = jobId + \"_source_index\";\n         this.destIndex = sourceIndex + \"_results\";\n-        this.analysisUsesExistingDestIndex = false;\n+        this.analysisUsesExistingDestIndex = randomBoolean();\n         createIndex(sourceIndex);\n         if (analysisUsesExistingDestIndex) {\n             createIndex(destIndex);\n"}}, {"oid": "607fbc41c11d5bb08e471f09918d78f0de1d045d", "url": "https://github.com/elastic/elasticsearch/commit/607fbc41c11d5bb08e471f09918d78f0de1d045d", "message": "[ML] Validate classification dependent_variable cardinality is at least two\n\nData frame analytics classification currently only supports 2 classes for the\ndependent variable. We were checking that the field's cardinality is not higher\nthan 2 but we should also check it is not less than that as otherwise the process\nfails.", "committedDate": "2020-01-22T11:43:53Z", "type": "commit"}, {"oid": "de2c194024674ffb7fbce651fc706c99f0882067", "url": "https://github.com/elastic/elasticsearch/commit/de2c194024674ffb7fbce651fc706c99f0882067", "message": "Address review comments", "committedDate": "2020-01-22T11:43:54Z", "type": "commit"}, {"oid": "b197ed888e06048389f2c6980e9e227947a5eb17", "url": "https://github.com/elastic/elasticsearch/commit/b197ed888e06048389f2c6980e9e227947a5eb17", "message": "Revert accidental change in test and fix another test", "committedDate": "2020-01-22T11:43:54Z", "type": "commit"}, {"oid": "283c012fc70a60128bb889aa7ae8bf8efa9eda79", "url": "https://github.com/elastic/elasticsearch/commit/283c012fc70a60128bb889aa7ae8bf8efa9eda79", "message": "Refresh dest before detected extracted fields", "committedDate": "2020-01-22T11:43:54Z", "type": "commit"}, {"oid": "eab85d5f455b86ae7c2d2628ab3ccc060d68490a", "url": "https://github.com/elastic/elasticsearch/commit/eab85d5f455b86ae7c2d2628ab3ccc060d68490a", "message": "Remove unused imports after rebase", "committedDate": "2020-01-22T12:04:15Z", "type": "forcePushed"}, {"oid": "eab85d5f455b86ae7c2d2628ab3ccc060d68490a", "url": "https://github.com/elastic/elasticsearch/commit/eab85d5f455b86ae7c2d2628ab3ccc060d68490a", "message": "Remove unused imports after rebase", "committedDate": "2020-01-22T12:04:15Z", "type": "commit"}]}