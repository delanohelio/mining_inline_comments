{"pr_number": 60911, "pr_title": "[ML] Monitor reindex response in DF analytics", "pr_createdAt": "2020-08-10T15:42:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60911", "timeline": [{"oid": "55b386eaa46f5d771cf35b073f66d2f2b13b6e4f", "url": "https://github.com/elastic/elasticsearch/commit/55b386eaa46f5d771cf35b073f66d2f2b13b6e4f", "message": "[ML] Monitor reindex response in DF analytics\n\nExamines the reindex response in order to report potential\nproblems that occurred during the reindexing phase of\ndata frame analytics jobs.", "committedDate": "2020-08-10T15:32:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwNzExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60911#discussion_r468007115", "bodyText": "I think since the reindex task is done, wouldn't we want to mark it as null even when it failed?", "author": "benwtrent", "createdAt": "2020-08-10T15:52:07Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -222,6 +223,13 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n                     task.markAsCompleted();\n                     return;\n                 }\n+\n+                Exception reindexError = getReindexError(task.getParams().getId(), reindexResponse);\n+                if (reindexError != null) {\n+                    task.markAsFailed(reindexError);\n+                    return;\n+                }\n+\n                 task.setReindexingTaskId(null);", "originalCommit": "55b386eaa46f5d771cf35b073f66d2f2b13b6e4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM2NjUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/60911#discussion_r468366528", "bodyText": "Good point, will do.", "author": "dimitris-athanasiou", "createdAt": "2020-08-11T06:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwNzExNQ=="}], "type": "inlineReview", "revised_code": {"commit": "404bb889a657d4a5fd844944a3c14325568c692c", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\nindex e0a0ab6797a..cbdebc944fb 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\n\n@@ -224,13 +225,17 @@ public class DataFrameAnalyticsManager {\n                     return;\n                 }\n \n+                task.setReindexingTaskId(null);\n+\n                 Exception reindexError = getReindexError(task.getParams().getId(), reindexResponse);\n                 if (reindexError != null) {\n                     task.markAsFailed(reindexError);\n                     return;\n                 }\n \n-                task.setReindexingTaskId(null);\n+                LOGGER.debug(\"[{}] Reindex completed; created [{}]; retries [{}]\", task.getParams().getId(),\n+                    reindexResponse.getCreated(), reindexResponse.getBulkRetries());\n+\n                 auditor.info(\n                     config.getId(),\n                     Messages.getMessage(Messages.DATA_FRAME_ANALYTICS_AUDIT_FINISHED_REINDEXING, config.getDest().getIndex(),\n"}}, {"oid": "404bb889a657d4a5fd844944a3c14325568c692c", "url": "https://github.com/elastic/elasticsearch/commit/404bb889a657d4a5fd844944a3c14325568c692c", "message": "Clear reindex task id", "committedDate": "2020-08-11T07:04:28Z", "type": "commit"}, {"oid": "e45029087ba771de747ae6b40b8a8603406e4f95", "url": "https://github.com/elastic/elasticsearch/commit/e45029087ba771de747ae6b40b8a8603406e4f95", "message": "Also not allow partial search results on reindex", "committedDate": "2020-08-11T11:22:03Z", "type": "commit"}]}