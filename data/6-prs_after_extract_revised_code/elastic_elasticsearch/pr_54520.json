{"pr_number": 54520, "pr_title": "[TEST] rename AsyncSearchActionTests to IT and move it out of unit tests", "pr_createdAt": "2020-03-31T16:24:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54520", "timeline": [{"oid": "02faf42a4e6f03ae0b023baa3bad859c1571e508", "url": "https://github.com/elastic/elasticsearch/commit/02faf42a4e6f03ae0b023baa3bad859c1571e508", "message": "[TEST] rename AsyncSearchActionTests to IT and move it out of unit tests\n\n`AsyncSearchActionTests` currently fails quite often. That is since the introduction of `RestSubmitAsyncSearchActionTests` which indirectly manipulates the channels being tracked in `RestCancellableNodeClient`. There are channels left in the map after `RestSubmitAsyncSearchActionTests`  is run, and later `AsyncSearchActionTests` checks that there are no channels in the map which makes each test method fail. This is particularily hard to reproduce as the order in which tests are run appears to be platform dependent.\n\nThe test cluster assertion that there are no channels in the map only makes sense in the context of internal cluster tests, while there may be collisions with unit tests that register http channels as part of their testing.\n\nThis can be solved by renaming `AsyncSearchActionTests` to `AsyncSearchActionIT`. This way it won't be run as part of unit tests but rather within another JVM where the number of channels is `0` and such assumption holds, because there are no expected manual manipulation of the channels.\n\nRelates to #54180", "committedDate": "2020-03-31T16:21:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0ODgzMg==", "url": "https://github.com/elastic/elasticsearch/pull/54520#discussion_r401048832", "bodyText": "it would be cleaner to also clean up the channels being tracked due to the dispatchRequest calls from this test. I gave it a try though and it was not trivial, and the same should be done in RestCancellableNodeClientTests where we actually assume that we may have channels in the map already, hence we only check the delta since the test has started. I wonder if it's worth looking into cleaning the channels up after both tests have executed, or not.", "author": "javanna", "createdAt": "2020-03-31T16:26:55Z", "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/RestSubmitAsyncSearchActionTests.java", "diffHunk": "@@ -72,8 +72,8 @@ public void testParameters() throws IOException {\n         boolean requestCache = randomBoolean();\n         doTestParameter(\"request_cache\", Boolean.toString(requestCache), requestCache,\n                 r -> r.getSearchRequest().requestCache());\n-        Integer batchReduceSize = randomIntBetween(2, 50);\n-        doTestParameter(\"batched_reduce_size\", Integer.toString(batchReduceSize), batchReduceSize,\n+        int batchedReduceSize = randomIntBetween(2, 50);\n+        doTestParameter(\"batched_reduce_size\", Integer.toString(batchedReduceSize), batchedReduceSize,\n                 r -> r.getSearchRequest().getBatchedReduceSize());", "originalCommit": "02faf42a4e6f03ae0b023baa3bad859c1571e508", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "a073fc5eb91ba268d5cb9893b41b93960f908516", "url": "https://github.com/elastic/elasticsearch/commit/a073fc5eb91ba268d5cb9893b41b93960f908516", "message": "Merge branch 'master' into test/async_search_action_tests_channels", "committedDate": "2020-04-01T07:56:52Z", "type": "commit"}]}