{"pr_number": 54967, "pr_title": "Deprecate the kibana reserved user; introduce kibana_system user", "pr_createdAt": "2020-04-08T16:54:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54967", "timeline": [{"oid": "601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "url": "https://github.com/elastic/elasticsearch/commit/601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "message": "fix license and test errors", "committedDate": "2020-04-08T18:15:17Z", "type": "forcePushed"}, {"oid": "6813965047e5e8605b46efb8fecba3a82e86b85b", "url": "https://github.com/elastic/elasticsearch/commit/6813965047e5e8605b46efb8fecba3a82e86b85b", "message": "fix license and test errors", "committedDate": "2020-04-08T20:36:07Z", "type": "forcePushed"}, {"oid": "b34e4bbdab5bde85cc8f3cabbcbc92a5cd64d665", "url": "https://github.com/elastic/elasticsearch/commit/b34e4bbdab5bde85cc8f3cabbcbc92a5cd64d665", "message": "deprecate the kibana reserved user; introduce kibana_system user", "committedDate": "2020-04-09T12:19:41Z", "type": "commit"}, {"oid": "6e9c434b1b21d4670e77583192df6b8583428cf5", "url": "https://github.com/elastic/elasticsearch/commit/6e9c434b1b21d4670e77583192df6b8583428cf5", "message": "fix license and test errors", "committedDate": "2020-04-09T12:19:41Z", "type": "forcePushed"}, {"oid": "ef8452ac8a43e4ccd8f8d65e747271c810634b09", "url": "https://github.com/elastic/elasticsearch/commit/ef8452ac8a43e4ccd8f8d65e747271c810634b09", "message": "fix license and test errors", "committedDate": "2020-04-09T14:17:09Z", "type": "forcePushed"}, {"oid": "7bc702d903009d1414ab20716eb814ba2ca334ad", "url": "https://github.com/elastic/elasticsearch/commit/7bc702d903009d1414ab20716eb814ba2ca334ad", "message": "fix license and test errors", "committedDate": "2020-04-09T17:33:58Z", "type": "commit"}, {"oid": "7bc702d903009d1414ab20716eb814ba2ca334ad", "url": "https://github.com/elastic/elasticsearch/commit/7bc702d903009d1414ab20716eb814ba2ca334ad", "message": "fix license and test errors", "committedDate": "2020-04-09T17:33:58Z", "type": "forcePushed"}, {"oid": "b5125556a15bea064c2d0123c125962ea68e96fd", "url": "https://github.com/elastic/elasticsearch/commit/b5125556a15bea064c2d0123c125962ea68e96fd", "message": "fix IdentityProviderAuthenticationIT tests", "committedDate": "2020-04-09T18:50:31Z", "type": "commit"}, {"oid": "761f401ba0a1c932622df7455b9d61e3e9c613b9", "url": "https://github.com/elastic/elasticsearch/commit/761f401ba0a1c932622df7455b9d61e3e9c613b9", "message": "test deprecation logging", "committedDate": "2020-04-09T19:45:29Z", "type": "commit"}, {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a", "url": "https://github.com/elastic/elasticsearch/commit/6b576e8b7a684f5ae6296d574374b0c169db7e8a", "message": "Merge branch 'master' into security/deprecate-kibana-user", "committedDate": "2020-04-10T01:47:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDY2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r406924665", "bodyText": "I don't love this test because it's fixed on the single deprecated kibana user, and won't work once we actually remove this user. I'm open to suggestions on how to rewrite this more generically, because it wasn't immediately obvious to me.\nI could make the logDeprercatedUser method public so that it's testable on its own, but that didn't seem like the right solution either.", "author": "legrego", "createdAt": "2020-04-10T20:17:50Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java", "diffHunk": "@@ -125,10 +126,22 @@ public void testAuthenticationDisabledUserWithStoredPassword() throws Throwable\n         verifySuccessfulAuthentication(false);\n     }\n \n+    public void testLogDeprecatedUser() throws Exception {", "originalCommit": "6b576e8b7a684f5ae6296d574374b0c169db7e8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg3NTkxMA==", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r408875910", "bodyText": "I think this is fine, but I would go with:\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n@@ -126,16 +126,13 @@ public class ReservedRealmTests extends ESTestCase {\n         verifySuccessfulAuthentication(false);\n     }\n\n-    public void testLogDeprecatedUser() throws Exception {\n-        final User expected = new KibanaUser(true);\n-        this.verifySuccessfulAuthenticationForUser(expected, true);\n-        assertWarnings(\"The user [kibana] is deprecated and will be removed in a future version of Elasticsearch. \" +\n-            \"Please use the [kibana_system] user instead.\");\n-    }\n-\n     private void verifySuccessfulAuthentication(boolean enabled) throws Exception {\n         final User expectedUser = randomReservedUser(enabled);\n         this.verifySuccessfulAuthenticationForUser(expectedUser, enabled);\n+        if (new KibanaUser(enabled).equals(expectedUser)) {\n+            assertWarnings(\"The user [kibana] is deprecated and will be removed in a future version of Elasticsearch. \" +\n+                    \"Please use the [kibana_system] user instead.\");\n+        }\n     }\n\n     private void verifySuccessfulAuthenticationForUser(User expectedUser, boolean enabled) throws Exception {", "author": "albertzaharovits", "createdAt": "2020-04-15T14:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDY2NQ=="}], "type": "inlineReview", "revised_code": {"commit": "1fe89d886feb8accfd997ae430a8ea0f7cd16835", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\nindex 2d86abf599b..a8870eef59f 100644\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n\n@@ -126,22 +126,10 @@ public class ReservedRealmTests extends ESTestCase {\n         verifySuccessfulAuthentication(false);\n     }\n \n-    public void testLogDeprecatedUser() throws Exception {\n-        final User expected = new KibanaUser(true);\n-        this.verifySuccessfulAuthenticationForUser(expected, true);\n-        assertWarnings(\"The user [kibana] is deprecated and will be removed in a future version of Elasticsearch. \" +\n-            \"Please use the [kibana_system] user instead.\");\n-    }\n-\n     private void verifySuccessfulAuthentication(boolean enabled) throws Exception {\n-        final User expectedUser = randomReservedUser(enabled);\n-        this.verifySuccessfulAuthenticationForUser(expectedUser, enabled);\n-    }\n-\n-    private void verifySuccessfulAuthenticationForUser(User expectedUser, boolean enabled) throws Exception {\n         final ReservedRealm reservedRealm = new ReservedRealm(mock(Environment.class), Settings.EMPTY, usersStore,\n             new AnonymousUser(Settings.EMPTY), securityIndex, threadPool);\n-\n+        final User expectedUser = randomReservedUser(enabled);\n         final String principal = expectedUser.principal();\n         final SecureString newPassword = new SecureString(\"foobar\".toCharArray());\n         // Mocked users store is initiated with default hashing algorithm\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgzODk3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r408838977", "bodyText": "I think it's cumbersome on the user to have password prompts for both kibana and kibana_system.\nI suggest we display the prompt for the new kibana_system user and also set the same password for the kibana user.", "author": "albertzaharovits", "createdAt": "2020-04-15T13:26:00Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java", "diffHunk": "@@ -65,8 +66,8 @@\n public class SetupPasswordTool extends LoggingAwareMultiCommand {\n \n     private static final char[] CHARS = (\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\").toCharArray();\n-    public static final List<String> USERS = asList(ElasticUser.NAME, APMSystemUser.NAME, KibanaUser.NAME, LogstashSystemUser.NAME,\n-        BeatsSystemUser.NAME, RemoteMonitoringUser.NAME);\n+    public static final List<String> USERS = asList(ElasticUser.NAME, APMSystemUser.NAME, KibanaUser.NAME, KibanaSystemUser.NAME,\n+        LogstashSystemUser.NAME, BeatsSystemUser.NAME, RemoteMonitoringUser.NAME);\n ", "originalCommit": "6b576e8b7a684f5ae6296d574374b0c169db7e8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NTk1NA==", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r408895954", "bodyText": "Good point, I agree this is cumbersome. I'll take a stab at updating the SetupPasswordTool to support this", "author": "legrego", "createdAt": "2020-04-15T14:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgzODk3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "1fe89d886feb8accfd997ae430a8ea0f7cd16835", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java\nindex 329fae93580..fbd2b15047e 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java\n\n@@ -69,6 +70,8 @@ public class SetupPasswordTool extends LoggingAwareMultiCommand {\n     public static final List<String> USERS = asList(ElasticUser.NAME, APMSystemUser.NAME, KibanaUser.NAME, KibanaSystemUser.NAME,\n         LogstashSystemUser.NAME, BeatsSystemUser.NAME, RemoteMonitoringUser.NAME);\n \n+    public static final Map<String, String> USERS_WITH_SHARED_PASSWORDS = Map.of(KibanaSystemUser.NAME, KibanaUser.NAME);\n+\n     private final Function<Environment, CommandLineHttpClient> clientFunction;\n     private final CheckedFunction<Environment, KeyStoreWrapper, Exception> keyStoreFunction;\n \n"}}, {"oid": "1fe89d886feb8accfd997ae430a8ea0f7cd16835", "url": "https://github.com/elastic/elasticsearch/commit/1fe89d886feb8accfd997ae430a8ea0f7cd16835", "message": "First pass at SetupPasswordTool updates", "committedDate": "2020-04-17T16:02:30Z", "type": "commit"}, {"oid": "9cde855042c5ab13fc4c7fbbd9b4d40c1d69d17a", "url": "https://github.com/elastic/elasticsearch/commit/9cde855042c5ab13fc4c7fbbd9b4d40c1d69d17a", "message": "Merge branch 'security/deprecate-kibana-user' of github.com:legrego/elasticsearch into security/deprecate-kibana-user", "committedDate": "2020-04-17T16:03:10Z", "type": "commit"}, {"oid": "b32de55722bfd469e9a381996e0c6b2cf3806bc8", "url": "https://github.com/elastic/elasticsearch/commit/b32de55722bfd469e9a381996e0c6b2cf3806bc8", "message": "fix checkstyle", "committedDate": "2020-04-23T13:20:59Z", "type": "commit"}, {"oid": "56490e5eb3a9e1adb2edd1b1d7a40f383af15b60", "url": "https://github.com/elastic/elasticsearch/commit/56490e5eb3a9e1adb2edd1b1d7a40f383af15b60", "message": "update docs", "committedDate": "2020-04-23T13:21:06Z", "type": "commit"}, {"oid": "f28670c1c3f5d790fc4350ba6be652a072a23c9c", "url": "https://github.com/elastic/elasticsearch/commit/f28670c1c3f5d790fc4350ba6be652a072a23c9c", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into security/deprecate-kibana-user", "committedDate": "2020-04-23T13:31:30Z", "type": "commit"}, {"oid": "e92196c4f2cfd2f74a5a5fd10d6b23488ed041a8", "url": "https://github.com/elastic/elasticsearch/commit/e92196c4f2cfd2f74a5a5fd10d6b23488ed041a8", "message": "Merge branch 'master' into security/deprecate-kibana-user", "committedDate": "2020-04-23T17:37:02Z", "type": "commit"}, {"oid": "da5acfa3b6218cca625473e6389867741ca11fb5", "url": "https://github.com/elastic/elasticsearch/commit/da5acfa3b6218cca625473e6389867741ca11fb5", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into security/deprecate-kibana-user", "committedDate": "2020-04-23T19:38:43Z", "type": "commit"}, {"oid": "d5938991edfb36c4677f4b4cba2a17e8f7daba66", "url": "https://github.com/elastic/elasticsearch/commit/d5938991edfb36c4677f4b4cba2a17e8f7daba66", "message": "Merge branch 'security/deprecate-kibana-user' of github.com:legrego/elasticsearch into security/deprecate-kibana-user", "committedDate": "2020-04-23T19:39:04Z", "type": "commit"}, {"oid": "50b58d434bd320e6b2cd7c396248c9ed90ae692f", "url": "https://github.com/elastic/elasticsearch/commit/50b58d434bd320e6b2cd7c396248c9ed90ae692f", "message": "update number of expected users", "committedDate": "2020-04-23T19:50:23Z", "type": "commit"}, {"oid": "b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832", "url": "https://github.com/elastic/elasticsearch/commit/b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832", "message": "Merge branch 'master' into security/deprecate-kibana-user", "committedDate": "2020-04-27T13:32:02Z", "type": "commit"}, {"oid": "74fdc1cd20de4602d65eae0177a9f5a72ec57488", "url": "https://github.com/elastic/elasticsearch/commit/74fdc1cd20de4602d65eae0177a9f5a72ec57488", "message": "update test to expect deprecation header", "committedDate": "2020-04-27T16:39:58Z", "type": "commit"}]}