{"pr_number": 55758, "pr_title": "Async Search: correct shards counting", "pr_createdAt": "2020-04-24T23:32:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55758", "timeline": [{"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "url": "https://github.com/elastic/elasticsearch/commit/03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "message": "Async Search: correct shards counting\n\nAsync search allows users to retrieve partial results for a running search. For partial results, the number of successful shards does not include the skipped shards, while the response returned to users should.\n\nWhen a fatal failure happened after some partial results were processed, for instance because all of the shards failed to fetch their hits, the number of successful shards should be reset to align it with what ordinary search would return.\n\nAlso, we recently had a bug where async search would miss tracking shard failures, which would have been caught if we had assertions in place that verified that whenever we get the last response, the number of failures included in it is the same as the failures that were tracked through the listener notifications.", "committedDate": "2020-04-24T23:29:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416474927", "bodyText": "I believe this makes what gets returned more consistent with what _search does, though we lose information on how many shards the partial results come from. We possibly need to expand the info that we return if we want to better represent this scenario where there are partial results yet the whole search has failed hence stopped.", "author": "javanna", "createdAt": "2020-04-28T09:40:03Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java", "diffHunk": "@@ -120,6 +129,10 @@ synchronized void updateWithFailure(Exception exc) {\n         failIfFrozen();\n         // copy the response headers from the current context\n         this.responseHeaders = threadContext.getResponseHeaders();\n+        //We may have already received some partial results, in which case the number of successful shards reflects that despite the search\n+        //has failed entirely at a later stage. We should consider all shards as failed given that none of them was able to e.g. fetch\n+        //skipped shards are considered successful though\n+        this.successfulShards = this.skippedShards;", "originalCommit": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3MTcyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416571721", "bodyText": "Why do we need to update these informations ? They are not used anymore when the response is final. I think #55683 has the more straightforward approach of keeping the final response as is.", "author": "jimczi", "createdAt": "2020-04-28T12:28:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYwNzM2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416607362", "bodyText": "I think that this is the reason why you can end up with situations like successful: 3 failed: 3 total: 3 .", "author": "javanna", "createdAt": "2020-04-28T13:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYwNzg1NA==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416607854", "bodyText": "I would rather want successful: 0 failed: 3 total:3 ( I left skipped out for simplicity)\nI have yet to look at the linked PR, will do", "author": "javanna", "createdAt": "2020-04-28T13:22:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA5NjkzNw==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r418096937", "bodyText": "ok I am now up-to-date, I agree with you on updateFinalResponse, no need to touch successful shards anymore, but you commented on updateWithFailure which still has the problem of returning a shards header that search does not return? Hence shall we signal how many shards have returned partial results although all of them later failed, or shall we just zero the successful shards that makes things more consistent with search? Otherwise I think we would need to add more details on which phase has failed to the response to be more accurate... I will update and merge conflicts.", "author": "javanna", "createdAt": "2020-04-30T15:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI1NzA0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r418257049", "bodyText": "I think we'll solve this discrepancy when wee add partial top hits in the response. In the meantime I don't think we should reset the successful shards, it would be weird to have successful: 0 (assuming no shards were skipped) but some partial results in the response ?", "author": "jimczi", "createdAt": "2020-04-30T20:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MjkxNw==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r418282917", "bodyText": "I think it's weird either way. I cant make up my mind on which way is less weird :) I will revert this bit then and maybe add a comment that explains what happens today.", "author": "javanna", "createdAt": "2020-04-30T20:54:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NDE4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r420764182", "bodyText": "maybe one thing we could rather do in this case is to reset shard failures, as they have caused a fatal failure and don't need to be returned as part of the search response too, they are already in the outer error section. That way we would have failed: 0 in the inner search response, which makes more sense as it's a snapshot of the results before the failure happened. Not too sure though if this may end up causing problems in other scenarios. Doing nothing is also fine with me, as long as we are aware that the shards section can be weird at times.", "author": "javanna", "createdAt": "2020-05-06T12:50:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQwNzQ4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r421407483", "bodyText": "What about ignoring fetch shard failures when building partial responses ?\nWe never return partial top hits if the response is partial so the successful and failure counts should only reflect the query phase ? This will change when we add the support for partial top hits but that's the least confusing solution I can think of.", "author": "jimczi", "createdAt": "2020-05-07T10:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}], "type": "inlineReview", "revised_code": {"commit": "372e0eda84f8a08d1cd4cf66d8f4541dfd5f8a5f", "chunk": "diff --git a/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java b/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java\nindex 8d8802054fd..cfe2971f15d 100644\n--- a/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java\n+++ b/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java\n\n@@ -129,10 +127,8 @@ class MutableSearchResponse {\n         failIfFrozen();\n         // copy the response headers from the current context\n         this.responseHeaders = threadContext.getResponseHeaders();\n-        //We may have already received some partial results, in which case the number of successful shards reflects that despite the search\n-        //has failed entirely at a later stage. We should consider all shards as failed given that none of them was able to e.g. fetch\n-        //skipped shards are considered successful though\n-        this.successfulShards = this.skippedShards;\n+        //note that when search fails, we may have gotten partial results before the failure. In that case async\n+        // search will return an error plus the last partial results that were collected.\n         this.isPartial = true;\n         this.failure = ElasticsearchException.guessRootCauses(exc)[0];\n         this.frozen = true;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416569401", "bodyText": "+1, #55683 has the same change", "author": "jimczi", "createdAt": "2020-04-28T12:25:16Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -387,7 +387,7 @@ public void onFinalReduce(List<SearchShard> shards, TotalHits totalHits, Interna\n \n         @Override\n         public void onResponse(SearchResponse response) {\n-            searchResponse.get().updateFinalResponse(response.getSuccessfulShards(), response.getInternalResponse());\n+            searchResponse.get().updateFinalResponse(response);", "originalCommit": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjYyNTQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416625426", "bodyText": "When I was working on mine I was wondering if I should assert that the final response looks \"right\" based on our updates. I never did that, but maybe it is good?", "author": "nik9000", "createdAt": "2020-04-28T13:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY2NzU3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416667573", "bodyText": "what do you mean by \"right\" here?", "author": "javanna", "createdAt": "2020-04-28T14:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY4MDgyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416680820", "bodyText": "I'm not sure! That was part of why I didn't do it....\nI was thinking that it might be useful to know if the response that we got here \"agrees\" with the results we got from the listener. Maybe that is just checking counts or something.", "author": "nik9000", "createdAt": "2020-04-28T14:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY4MzA0OA==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416683048", "bodyText": "You've already added the assertions below. Ignore me!", "author": "nik9000", "createdAt": "2020-04-28T14:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY4Nzk5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416687995", "bodyText": "I see, yea that is the reason why I added the whole response as argument ;)", "author": "javanna", "createdAt": "2020-04-28T15:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3db15c389760b4f57e8620fcbbb675f5f6cd25e", "chunk": "diff --git a/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java b/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java\nindex 6be1d98a601..6954e2d4723 100644\n--- a/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java\n+++ b/x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java\n\n@@ -362,27 +363,41 @@ final class AsyncSearchTask extends SearchTask implements AsyncTask {\n             // best effort to cancel expired tasks\n             checkCancellation();\n             searchResponse.compareAndSet(null,\n-                new MutableSearchResponse(shards.size() + skipped.size(), skipped.size(), clusters,\n-                    aggReduceContextSupplier, threadPool.getThreadContext()));\n+                new MutableSearchResponse(shards.size() + skipped.size(), skipped.size(), clusters, threadPool.getThreadContext()));\n             executeInitListeners();\n         }\n \n         @Override\n-        public void onPartialReduce(List<SearchShard> shards, TotalHits totalHits, InternalAggregations aggs, int reducePhase) {\n+        public void onPartialReduce(List<SearchShard> shards, TotalHits totalHits,\n+                DelayableWriteable.Serialized<InternalAggregations> aggregations, int reducePhase) {\n             // best effort to cancel expired tasks\n             checkCancellation();\n-            searchResponse.get().updatePartialResponse(shards.size(),\n-                new InternalSearchResponse(new SearchHits(SearchHits.EMPTY, totalHits, Float.NaN), aggs,\n-                    null, null, false, null, reducePhase), aggs == null);\n+            // The way that the MutableSearchResponse will build the aggs.\n+            Supplier<InternalAggregations> reducedAggs;\n+            if (aggregations == null) {\n+                // There aren't any aggs to reduce.\n+                reducedAggs = () -> null;\n+            } else {\n+                /*\n+                 * Keep a reference to the serialized form of the partially\n+                 * reduced aggs and reduce it on the fly when someone asks\n+                 * for it. It's important that we wait until someone needs\n+                 * the result so we don't perform the final reduce only to\n+                 * throw it away. And it is important that we keep the reference\n+                 * to the serialized aggregations because SearchPhaseController\n+                 * *already* has that reference so we're not creating more garbage.\n+                 */\n+                reducedAggs = () ->\n+                    InternalAggregations.topLevelReduce(singletonList(aggregations.expand()), aggReduceContextSupplier.get());\n+            }\n+            searchResponse.get().updatePartialResponse(shards.size(), totalHits, reducedAggs, reducePhase);\n         }\n \n         @Override\n-        public void onFinalReduce(List<SearchShard> shards, TotalHits totalHits, InternalAggregations aggs, int reducePhase) {\n+        public void onFinalReduce(List<SearchShard> shards, TotalHits totalHits, InternalAggregations aggregations, int reducePhase) {\n             // best effort to cancel expired tasks\n             checkCancellation();\n-            searchResponse.get().updatePartialResponse(shards.size(),\n-                new InternalSearchResponse(new SearchHits(SearchHits.EMPTY, totalHits, Float.NaN), aggs,\n-                    null, null, false, null, reducePhase), true);\n+            searchResponse.get().updatePartialResponse(shards.size(), totalHits, () -> aggregations, reducePhase);\n         }\n \n         @Override\n"}}, {"oid": "b3db15c389760b4f57e8620fcbbb675f5f6cd25e", "url": "https://github.com/elastic/elasticsearch/commit/b3db15c389760b4f57e8620fcbbb675f5f6cd25e", "message": "Merge branch 'master' into enhancement/async_search_shards_assert", "committedDate": "2020-04-30T15:43:44Z", "type": "commit"}, {"oid": "f377669973687ffebadde53d25661e68f91502f9", "url": "https://github.com/elastic/elasticsearch/commit/f377669973687ffebadde53d25661e68f91502f9", "message": "Merge branch 'master' into enhancement/async_search_shards_assert", "committedDate": "2020-05-06T06:49:44Z", "type": "commit"}, {"oid": "372e0eda84f8a08d1cd4cf66d8f4541dfd5f8a5f", "url": "https://github.com/elastic/elasticsearch/commit/372e0eda84f8a08d1cd4cf66d8f4541dfd5f8a5f", "message": "iter", "committedDate": "2020-05-06T07:31:33Z", "type": "commit"}]}