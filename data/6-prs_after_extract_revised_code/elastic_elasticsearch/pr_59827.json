{"pr_number": 59827, "pr_title": "EQL: Fix matching of tail/desc queries", "pr_createdAt": "2020-07-18T14:55:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59827", "timeline": [{"oid": "fd883411d8a6489f6026589499bd4997dca42d11", "url": "https://github.com/elastic/elasticsearch/commit/fd883411d8a6489f6026589499bd4997dca42d11", "message": "EQL: Fix matching of tail/desc queries\n\nWhen dealing with tail queries, data is returned descending for the base\ncriterion yet the rest of the queries are ascending. This caused a\nproblem during insertion since while in a page, the data is ASC, between\npages the blocks of data is DESC.\nThis caused incorrectly sorting inside a SequenceGroup which led to\nincorrect results.\n\nFurther more in case of limit, since the data in a page is ASC, early\nreturn is not possible neither is desc matching. Thus the page needs to\nbe consumed first before finding the final results.\nA future improvement could be to keep only the top N results dropping\nthe rest during insertion time.", "committedDate": "2020-07-18T14:33:44Z", "type": "commit"}, {"oid": "4dff1ec919cd40285fa929d9e85e532f49dce494", "url": "https://github.com/elastic/elasticsearch/commit/4dff1ec919cd40285fa929d9e85e532f49dce494", "message": "Reset position also for completed sequences", "committedDate": "2020-07-18T16:09:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgwODQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/59827#discussion_r456808427", "bodyText": "Unnecessary /*.", "author": "astefan", "createdAt": "2020-07-18T17:02:47Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java", "diffHunk": "@@ -28,6 +28,13 @@\n     // timestamp compression (whose range is known for the current frame).\n     private final List<E> elements = new LinkedList<>();\n \n+    /**\n+    /* index in the list used for resetting the insertion point", "originalCommit": "fd883411d8a6489f6026589499bd4997dca42d11", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "676947bb48ba6b33a510233a13793c6504599764", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java\nindex 9728f18cfdb..173955b1a56 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java\n\n@@ -29,7 +29,7 @@ abstract class OrdinalGroup<E> implements Iterable<Ordinal> {\n     private final List<E> elements = new LinkedList<>();\n \n     /**\n-    /* index in the list used for resetting the insertion point\n+     * index in the list used for resetting the insertion point\n      * it gets reset when dealing with descending queries since the data inserted is ascending in a page\n      * but descending compared to the previous stages.\n      */\n"}}, {"oid": "676947bb48ba6b33a510233a13793c6504599764", "url": "https://github.com/elastic/elasticsearch/commit/676947bb48ba6b33a510233a13793c6504599764", "message": "Avoid duplicated matches", "committedDate": "2020-07-18T20:51:20Z", "type": "commit"}]}