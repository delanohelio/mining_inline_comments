{"pr_number": 61702, "pr_title": "Include trusted issuer details in SSL diagnostics", "pr_createdAt": "2020-08-31T08:47:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61702", "timeline": [{"oid": "45ea5cd96d6dfdcdbabbf4db446a0d47eaca6285", "url": "https://github.com/elastic/elasticsearch/commit/45ea5cd96d6dfdcdbabbf4db446a0d47eaca6285", "message": "Include trusted issuer details in SSL diagnostics\n\nThis commit changes the SSL Diagnostic warning to include additional\ndetails about trusted certificate issuers when the provide certificate\nchain does not match any trust anchors.\n\n- If there are no trusted issuers, this is explicitly called out\n- If there is one trusted issuer, it is listed by name (DN) and fingerprint\n- If there are between 2 and 10 trusted issuers, then they are listed\n  by name (DN)\n- If there are more than 10 trusted issuers, the number of issuers is\n  included in the message (but no other details).", "committedDate": "2020-08-31T08:45:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgwNDcwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/61702#discussion_r480804705", "bodyText": "For completeness, should we have a test where the number is greater than 9?", "author": "ywangd", "createdAt": "2020-09-01T04:54:00Z", "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java", "diffHunk": "@@ -126,7 +126,8 @@ public void testDiagnosticMessageWhenServerProvidesEndCertificateOnlyButTheCertA\n             \" the certificate has subject alternative names [DNS:localhost,IP:127.0.0.1];\" +\n             \" the certificate is issued by [CN=Test CA 1]\" +\n             \" but the server did not provide a copy of the issuing certificate in the certificate chain;\" +\n-            \" this ssl context ([xpack.http.ssl]) is not configured to trust that issuer\"));\n+            \" this ssl context ([xpack.http.ssl]) is not configured to trust that issuer\" +\n+            \" but trusts [2] other issuers ([CN=Test CA 2, CN=Test CA 3])\"));", "originalCommit": "45ea5cd96d6dfdcdbabbf4db446a0d47eaca6285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4MDA1NA==", "url": "https://github.com/elastic/elasticsearch/pull/61702#discussion_r482680054", "bodyText": "I will add that.\nI have a philosophical question about it - if I had included this part of the message in the original PR to add diagnostics, I don't think anyone would have expected it to have a test to cover every single case, but we tend to lean that way when we add small changes after the fact.\nI wonder whether that means we should be aiming for smaller PRs in general, or most extensive testing on the larger PRs. Our current approach of doing more complete testing on the followup PRs than we do on the first delivery doesn't seem right.", "author": "tvernum", "createdAt": "2020-09-03T03:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgwNDcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY4NTc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61702#discussion_r482685799", "bodyText": "I'd personally agree it has something to do with the size of the PR. Large PRs are hard to be exhaustive. They also tend to run for longer and hence people are more easily to get less focused. On the other hand, smaller PRs are easier to get nitpicked since there aren't many things to talk about. It's a different level of zooming due to the PR sizes( and possibly human nature?). In an ideal world, I'd prefer every PR to be small. But that's pratically impossible. Overall, I don't think what we are doing is perfect, but it is not seriously flawed either.", "author": "ywangd", "createdAt": "2020-09-03T03:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDgwNDcwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "08da2d413652a512debd29f48b711b4df62223c3", "chunk": "diff --git a/libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java b/libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java\nindex 7aab49453cd..10112ce26f9 100644\n--- a/libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java\n+++ b/libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/SslDiagnosticsTests.java\n\n@@ -130,6 +131,25 @@ public class SslDiagnosticsTests extends ESTestCase {\n             \" but trusts [2] other issuers ([CN=Test CA 2, CN=Test CA 3])\"));\n     }\n \n+    public void testDiagnosticMessageWhenServerTrustsManyCAs() throws Exception {\n+        final X509Certificate[] chain = loadCertChain(\"cert1/cert1.crt\");\n+        final SSLSession session = session(\"192.168.1.2\");\n+        final Map<String, List<X509Certificate>> trustIssuers = new HashMap<>();\n+        final X509Certificate dummyCa = loadCertificate(\"ca2/ca.crt\");\n+        final int numberOfCAs = randomIntBetween(30, 50);\n+        for (int i = 0; i < numberOfCAs; i++) {\n+            trustIssuers.put(\"CN=Authority-\" + i + \",OU=security,DC=example,DC=net\", randomList(1, 3, () -> dummyCa));\n+        }\n+        final String message = SslDiagnostics.getTrustDiagnosticFailure(chain, SslDiagnostics.PeerType.CLIENT, session,\n+            \"xpack.security.http.ssl\", trustIssuers);\n+        assertThat(message, Matchers.equalTo(\"failed to establish trust with client at [192.168.1.2];\" +\n+            \" the client provided a certificate with subject name [CN=cert1] and fingerprint [3bebe388a66362784afd6c51a9000961a4e10050];\" +\n+            \" the certificate is issued by [CN=Test CA 1]\" +\n+            \" but the client did not provide a copy of the issuing certificate in the certificate chain;\" +\n+            \" this ssl context ([xpack.security.http.ssl]) is not configured to trust that issuer\" +\n+            \" but trusts [\" + numberOfCAs + \"] other issuers\"));\n+    }\n+\n     public void testDiagnosticMessageWhenServerProvidesEndCertificateOnlyWithMimicIssuer() throws Exception {\n         X509Certificate[] chain = loadCertChain(\"cert1/cert1.crt\");\n         final SSLSession session = session(\"192.168.1.1\");\n"}}, {"oid": "08da2d413652a512debd29f48b711b4df62223c3", "url": "https://github.com/elastic/elasticsearch/commit/08da2d413652a512debd29f48b711b4df62223c3", "message": "Add test for large # of issuers", "committedDate": "2020-09-03T03:37:29Z", "type": "commit"}, {"oid": "d293233da02571f4d85b2809eeacc677c731ee95", "url": "https://github.com/elastic/elasticsearch/commit/d293233da02571f4d85b2809eeacc677c731ee95", "message": "Merge branch 'master' into ssl-diagnostics-empty-trust", "committedDate": "2020-09-03T03:37:50Z", "type": "commit"}, {"oid": "3672afc10c2e5d697ab5b138ae88b0ae9e0faf8b", "url": "https://github.com/elastic/elasticsearch/commit/3672afc10c2e5d697ab5b138ae88b0ae9e0faf8b", "message": "Merge branch 'master' into ssl-diagnostics-empty-trust", "committedDate": "2020-09-18T04:01:48Z", "type": "commit"}, {"oid": "e46bd7f0a309a02dd1dc086eaa1f810031b04a0b", "url": "https://github.com/elastic/elasticsearch/commit/e46bd7f0a309a02dd1dc086eaa1f810031b04a0b", "message": "Add tests for unknown issuers", "committedDate": "2020-09-18T04:12:29Z", "type": "commit"}]}