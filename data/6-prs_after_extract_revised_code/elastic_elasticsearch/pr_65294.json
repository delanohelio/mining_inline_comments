{"pr_number": 65294, "pr_title": "Remove unnecessary method AbstractFieldScript#getSource.", "pr_createdAt": "2020-11-20T03:56:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65294", "timeline": [{"oid": "9890c4ae4f3b3b5e357d0e867a19fa51b25e68e9", "url": "https://github.com/elastic/elasticsearch/commit/9890c4ae4f3b3b5e357d0e867a19fa51b25e68e9", "message": "Correct some javadoc on AbstractFieldScript.", "committedDate": "2020-11-20T03:43:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527571531", "bodyText": "Do we actually need this method at all?  All the tests that call it also have access to the leafSearchLookup object so they could just use that?", "author": "romseygeek", "createdAt": "2020-11-20T09:46:14Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractFieldScript.java", "diffHunk": "@@ -88,17 +88,17 @@ public final void setDocument(int docId) {\n     }\n \n     /**\n-     * Expose the {@code _source} to the script.\n+     * Expose field data to the script as {@code doc}.\n      */\n-    protected final Map<String, Object> getSource() {\n-        return leafSearchLookup.source();\n+    public final Map<String, ScriptDocValues<?>> getDoc() {\n+        return leafSearchLookup.doc();\n     }\n \n     /**\n-     * Expose field data to the script as {@code doc}.\n+     * A non-public convenience method that's used in testing.\n      */\n-    public final Map<String, ScriptDocValues<?>> getDoc() {\n-        return leafSearchLookup.doc();\n+    protected final Map<String, Object> getSource() {\n+        return leafSearchLookup.source();\n     }", "originalCommit": "9890c4ae4f3b3b5e357d0e867a19fa51b25e68e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc4ODE3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527788172", "bodyText": "you mean that we should make leafSearchLookup protected? I don't think the tests have access to it today but maybe they should.", "author": "javanna", "createdAt": "2020-11-20T15:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgzNzk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527837955", "bodyText": "Right, leafSearchLookup is currently private. I was just thinking of this as a tiny incremental improvement to avoid another person being confused by the javadoc.", "author": "jtibshirani", "createdAt": "2020-11-20T17:13:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1ODM3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527858379", "bodyText": "I mean the tests currently look like this:\nreturn (fieldName, params, lookup) -> (ctx) -> new BooleanFieldScript(fieldName, params, lookup, ctx) {\n                                    @Override\n                                    public void execute() {\n                                        for (Object foo : (List<?>) getSource().get(\"foo\")) {\n                                            emit((Boolean) foo);\n                                        }\n                                    }\n                                };\n\nwhere lookup is passed as a parameter to the lambda, so we could rewrite them like this:\nreturn (fieldName, params, lookup) -> (ctx) -> new BooleanFieldScript(fieldName, params, lookup, ctx) {\n                                    @Override\n                                    public void execute() {\n                                        for (Object foo : (List<?>) lookup.source().get(\"foo\")) {\n                                            emit((Boolean) foo);\n                                        }\n                                    }\n                                };", "author": "romseygeek", "createdAt": "2020-11-20T17:39:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg4OTM3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527889371", "bodyText": "Thanks @romseygeek for the suggestion, I updated the PR to remove AbstractFieldScript#getSource entirely.", "author": "jtibshirani", "createdAt": "2020-11-20T18:18:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzkzNTIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/65294#discussion_r527935224", "bodyText": "Makes sense to me too, thanks", "author": "javanna", "createdAt": "2020-11-20T19:48:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3MTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "770d1bf8ab0a714d2697f022a4298922dce7d1cc", "chunk": "diff --git a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractFieldScript.java b/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractFieldScript.java\nindex 704fb48b8d5..a7aac61b255 100644\n--- a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractFieldScript.java\n+++ b/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractFieldScript.java\n\n@@ -94,13 +94,6 @@ public abstract class AbstractFieldScript {\n         return leafSearchLookup.doc();\n     }\n \n-    /**\n-     * A non-public convenience method that's used in testing.\n-     */\n-    protected final Map<String, Object> getSource() {\n-        return leafSearchLookup.source();\n-    }\n-\n     /**\n      * Check if the we can add another value to the list of values.\n      * @param currentSize the current size of the list\n"}}, {"oid": "770d1bf8ab0a714d2697f022a4298922dce7d1cc", "url": "https://github.com/elastic/elasticsearch/commit/770d1bf8ab0a714d2697f022a4298922dce7d1cc", "message": "Remove AbstractFieldScript#getSource altogether.", "committedDate": "2020-11-20T18:06:33Z", "type": "commit"}]}