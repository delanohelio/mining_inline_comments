{"pr_number": 63836, "pr_title": "Convert geo field mappers to Parametrized form", "pr_createdAt": "2020-10-16T16:38:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63836", "timeline": [{"oid": "9d4834311b1bbe4a2a19da88ed43967aedea56a0", "url": "https://github.com/elastic/elasticsearch/commit/9d4834311b1bbe4a2a19da88ed43967aedea56a0", "message": "Convert geo field mappers to Parametrized form", "committedDate": "2020-10-16T16:37:15Z", "type": "commit"}, {"oid": "6ef3e685d429e7be803e73001b492a00a6bb7218", "url": "https://github.com/elastic/elasticsearch/commit/6ef3e685d429e7be803e73001b492a00a6bb7218", "message": "duh", "committedDate": "2020-10-16T19:38:15Z", "type": "commit"}, {"oid": "61de96c9b7c67b13af75a6a95fc36984db7bb107", "url": "https://github.com/elastic/elasticsearch/commit/61de96c9b7c67b13af75a6a95fc36984db7bb107", "message": "tests", "committedDate": "2020-10-17T11:08:02Z", "type": "commit"}, {"oid": "9fcd17dd42e5ad1267b5d6fd35b7b132c3de7742", "url": "https://github.com/elastic/elasticsearch/commit/9fcd17dd42e5ad1267b5d6fd35b7b132c3de7742", "message": "Merge remote-tracking branch 'origin/master' into mapper/geo-params", "committedDate": "2020-10-19T08:05:39Z", "type": "commit"}, {"oid": "db49a6938ad3cd9080b613c822269df334a4e8d0", "url": "https://github.com/elastic/elasticsearch/commit/db49a6938ad3cd9080b613c822269df334a4e8d0", "message": "points_only fixes", "committedDate": "2020-10-19T09:29:54Z", "type": "commit"}, {"oid": "393631d6e1666bc579fc9048902df82d1bfe3f88", "url": "https://github.com/elastic/elasticsearch/commit/393631d6e1666bc579fc9048902df82d1bfe3f88", "message": "geopoint takes arrays", "committedDate": "2020-10-19T09:36:29Z", "type": "commit"}, {"oid": "76feae0d15c1c2d2a8e3e0f43500981de4988c03", "url": "https://github.com/elastic/elasticsearch/commit/76feae0d15c1c2d2a8e3e0f43500981de4988c03", "message": "tests", "committedDate": "2020-10-19T10:28:24Z", "type": "commit"}, {"oid": "9e1307ad316d702c6257df78f7226e38f798602c", "url": "https://github.com/elastic/elasticsearch/commit/9e1307ad316d702c6257df78f7226e38f798602c", "message": "legacy -> bkd merges", "committedDate": "2020-10-19T11:37:58Z", "type": "commit"}, {"oid": "b4d892f6a848cd5963787e2623b54f0d9b5b7bf8", "url": "https://github.com/elastic/elasticsearch/commit/b4d892f6a848cd5963787e2623b54f0d9b5b7bf8", "message": "wut", "committedDate": "2020-10-19T12:50:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r507757959", "bodyText": "This ended up catching a pre-existing bug in GeoShapeQueryTests, which was asking for TERM instead of term as a strategy, and therefore ending up falling back on null here, which was getting translated to recursive once the mapper had been parsed.  Silently falling back to recursive is a bug, I think, although on backport we will need to change this to emit a warning instead, as you can't change the strategy once it has been set and so existing mappings with badly-spelled term strategies will have to stay using recursive", "author": "romseygeek", "createdAt": "2020-10-19T13:44:56Z", "path": "server/src/main/java/org/elasticsearch/common/geo/SpatialStrategy.java", "diffHunk": "@@ -54,6 +54,12 @@ public static SpatialStrategy fromString(String strategyName) {\n                 return strategy;\n             }\n         }\n-        return null;\n+        throw new IllegalArgumentException(\"Unknown strategy [\" + strategyName + \"]\");\n+    }", "originalCommit": "b4d892f6a848cd5963787e2623b54f0d9b5b7bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4NTQ4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r508385482", "bodyText": "Do you think this is a breaking change?", "author": "iverase", "createdAt": "2020-10-20T10:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQxMDEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r508410135", "bodyText": "I'd say it was a bugfix rather than a breaking change, I think?", "author": "romseygeek", "createdAt": "2020-10-20T11:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyNDcwNA==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r509124704", "bodyText": "I opened #63975 to emit a deprecation warning for this case in 7.x", "author": "romseygeek", "createdAt": "2020-10-21T09:21:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyNTgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r509125814", "bodyText": "Existing mappings sort of fix themselves, btw, so my above comment was not correct.  Once a user has added a mapping with a bad strategy, it will serialize itself as recursive, so we don't need to worry about parsing mappings from previous versions.", "author": "romseygeek", "createdAt": "2020-10-21T09:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyODU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r509128588", "bodyText": "Yes, that is what I checked so the only change is that creating a mapping will throw an error when before it was successful.", "author": "iverase", "createdAt": "2020-10-21T09:27:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1Nzk1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "ff0269d5d759cdc2321acfed790c3ba7737ea3a1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/geo/SpatialStrategy.java b/server/src/main/java/org/elasticsearch/common/geo/SpatialStrategy.java\nindex 4b200a06f0a..9991a32ce4b 100644\n--- a/server/src/main/java/org/elasticsearch/common/geo/SpatialStrategy.java\n+++ b/server/src/main/java/org/elasticsearch/common/geo/SpatialStrategy.java\n\n@@ -56,10 +56,4 @@ public enum SpatialStrategy implements Writeable {\n         }\n         throw new IllegalArgumentException(\"Unknown strategy [\" + strategyName + \"]\");\n     }\n-\n-\n-    @Override\n-    public String toString() {\n-        return super.toString();\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1OTA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r507759099", "bodyText": "Whether or not a parameter has been explicitly set is of interest only to the mapper itself, and its serialization code; the PR changes these getters on the mappers to return simple booleans.", "author": "romseygeek", "createdAt": "2020-10-19T13:46:24Z", "path": "server/src/main/java/org/elasticsearch/common/geo/parsers/GeoJsonParser.java", "diffHunk": "@@ -50,14 +49,10 @@ protected static ShapeBuilder parse(XContentParser parser, AbstractShapeGeometry\n         GeometryCollectionBuilder geometryCollections = null;\n \n         Orientation orientation = (shapeMapper == null)\n-            ? AbstractShapeGeometryFieldMapper.Defaults.ORIENTATION.value()\n+            ? Orientation.RIGHT\n             : shapeMapper.orientation();\n-        Explicit<Boolean> coerce = (shapeMapper == null)\n-            ? AbstractShapeGeometryFieldMapper.Defaults.COERCE\n-            : shapeMapper.coerce();\n-        Explicit<Boolean> ignoreZValue = (shapeMapper == null)\n-            ? AbstractShapeGeometryFieldMapper.Defaults.IGNORE_Z_VALUE\n-            : shapeMapper.ignoreZValue();\n+        boolean coerce = shapeMapper != null && shapeMapper.coerce();\n+        boolean ignoreZValue = shapeMapper == null || shapeMapper.ignoreZValue();", "originalCommit": "b4d892f6a848cd5963787e2623b54f0d9b5b7bf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyNzIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r509127219", "bodyText": "+1", "author": "iverase", "createdAt": "2020-10-21T09:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc1OTA5OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc2MjgyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r507762824", "bodyText": "These needed to be changed to getters, rather than just asserting in themselves, so that the checks for deprecated boost parameters didn't get confused by the additional warnings.", "author": "romseygeek", "createdAt": "2020-10-19T13:51:25Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -205,12 +205,28 @@ public void testMinimalToMaximal() throws IOException {\n         assertParseMaximalWarnings();\n     }\n \n-    protected void assertParseMinimalWarnings() {\n+    protected final void assertParseMinimalWarnings() {\n+        String[] warnings = getParseMinimalWarnings();\n+        if (warnings.length > 0) {\n+            assertWarnings(warnings);\n+        }\n+    }\n+\n+    protected final void assertParseMaximalWarnings() {\n+        String[] warnings = getParseMaximalWarnings();\n+        if (warnings.length > 0) {\n+            assertWarnings(warnings);\n+        }\n+    }\n+\n+    protected String[] getParseMinimalWarnings() {", "originalCommit": "b4d892f6a848cd5963787e2623b54f0d9b5b7bf8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "ff0269d5d759cdc2321acfed790c3ba7737ea3a1", "url": "https://github.com/elastic/elasticsearch/commit/ff0269d5d759cdc2321acfed790c3ba7737ea3a1", "message": "remove unnecessary bit", "committedDate": "2020-10-19T14:42:57Z", "type": "commit"}, {"oid": "c49b6270b7d4336227d46e77a77c051d76089169", "url": "https://github.com/elastic/elasticsearch/commit/c49b6270b7d4336227d46e77a77c051d76089169", "message": "Merge remote-tracking branch 'origin/master' into mapper/geo-params", "committedDate": "2020-10-19T14:43:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNDk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r507914987", "bodyText": "It looks like the old code had a comment that this was intentionally a noop. I think it is worth keeping that.", "author": "nik9000", "createdAt": "2020-10-19T17:08:39Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/GeoShapeWithDocValuesFieldMapper.java", "diffHunk": "@@ -198,8 +221,12 @@ public GeoShapeWithDocValuesFieldType fieldType() {\n     }\n \n     @Override\n-    protected String contentType() {\n-        return CONTENT_TYPE;\n+    protected void addStoredFields(ParseContext context, Geometry geometry) {\n+\n     }\n \n+    @Override\n+    protected void addMultiFields(ParseContext context, Geometry geometry) {\n+", "originalCommit": "c49b6270b7d4336227d46e77a77c051d76089169", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec447e9d2f93d7573355f89edf66dc99accf5d17", "chunk": "diff --git a/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/GeoShapeWithDocValuesFieldMapper.java b/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/GeoShapeWithDocValuesFieldMapper.java\nindex 09216519e41..dab381eb963 100644\n--- a/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/GeoShapeWithDocValuesFieldMapper.java\n+++ b/x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/GeoShapeWithDocValuesFieldMapper.java\n\n@@ -222,11 +222,11 @@ public class GeoShapeWithDocValuesFieldMapper extends AbstractShapeGeometryField\n \n     @Override\n     protected void addStoredFields(ParseContext context, Geometry geometry) {\n-\n+        // noop (stored fields not available for geo_shape fields)\n     }\n \n     @Override\n     protected void addMultiFields(ParseContext context, Geometry geometry) {\n-\n+        // noop (completion suggester currently not compatible with geo_shape)\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r507915906", "bodyText": "We don't need to be equal to ParsedCartesianPoints?", "author": "nik9000", "createdAt": "2020-10-19T17:10:12Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/PointFieldMapper.java", "diffHunk": "@@ -186,12 +212,8 @@ public boolean equals(Object other) {\n                 CartesianPoint o = (CartesianPoint)other;\n                 oX = o.getX();\n                 oY = o.getY();\n-            } else if (other instanceof ParsedCartesianPoint == false) {", "originalCommit": "c49b6270b7d4336227d46e77a77c051d76089169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI4MDAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r508280023", "bodyText": "If we're comparing against a ParsedCartesianPoint, then the earlier instanceof CartesianPoint branch will already have matched, so this branch is never called.", "author": "romseygeek", "createdAt": "2020-10-20T07:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTkwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMxNjYyNw==", "url": "https://github.com/elastic/elasticsearch/pull/63836#discussion_r509316627", "bodyText": "++. I hadn't pulled it up.", "author": "nik9000", "createdAt": "2020-10-21T14:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxNTkwNg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b53b33bbbc3d2d0d7e171bfc5b79f77857a11062", "url": "https://github.com/elastic/elasticsearch/commit/b53b33bbbc3d2d0d7e171bfc5b79f77857a11062", "message": "Merge remote-tracking branch 'origin/master' into mapper/geo-params", "committedDate": "2020-10-21T08:49:02Z", "type": "commit"}, {"oid": "ec447e9d2f93d7573355f89edf66dc99accf5d17", "url": "https://github.com/elastic/elasticsearch/commit/ec447e9d2f93d7573355f89edf66dc99accf5d17", "message": "add comments back in", "committedDate": "2020-10-21T08:56:31Z", "type": "commit"}, {"oid": "c62cbd8a94545e2f9e01ac0365ca3f2faf81f642", "url": "https://github.com/elastic/elasticsearch/commit/c62cbd8a94545e2f9e01ac0365ca3f2faf81f642", "message": "Merge branch 'master' into mapper/geo-params", "committedDate": "2020-10-21T14:19:55Z", "type": "commit"}, {"oid": "7bddf07f4d5ac5952c87a0fcce225e2b273c9e91", "url": "https://github.com/elastic/elasticsearch/commit/7bddf07f4d5ac5952c87a0fcce225e2b273c9e91", "message": "Add to breaking changes", "committedDate": "2020-10-21T14:25:29Z", "type": "commit"}, {"oid": "d7315420175f6a1026798eadd9fa41e169d5a119", "url": "https://github.com/elastic/elasticsearch/commit/d7315420175f6a1026798eadd9fa41e169d5a119", "message": "Merge branch 'master' into mapper/geo-params", "committedDate": "2020-10-22T07:22:52Z", "type": "commit"}]}