{"pr_number": 58418, "pr_title": "Filter empty fields in SearchHit#toXContent", "pr_createdAt": "2020-06-23T10:21:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58418", "timeline": [{"oid": "6f8588b2e23785f5dc8075ea3b7dd81a2b741f35", "url": "https://github.com/elastic/elasticsearch/commit/6f8588b2e23785f5dc8075ea3b7dd81a2b741f35", "message": "Filter empty fields in SearchHit#toXContent\n\nThis commit restores the filtering of empty fields during the\nxcontent serialization of SearchHit. The filtering was removed\nunintentionally in #41656.", "committedDate": "2020-06-23T10:20:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNzM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444137340", "bodyText": "It would be great to have a a test for this too.", "author": "cbuescher", "createdAt": "2020-06-23T10:55:39Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -635,7 +635,12 @@ public XContentBuilder toInnerXContent(XContentBuilder builder, Params params) t\n         } else {\n             builder.field(Fields._SCORE, score);\n         }\n+\n         for (DocumentField field : metaFields.values()) {\n+            // ignore empty metadata fields\n+            if (field.getValues().size() == 0) {\n+                continue;", "originalCommit": "6f8588b2e23785f5dc8075ea3b7dd81a2b741f35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MDkxMA==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444690910", "bodyText": "++, I pushed b947758", "author": "jimczi", "createdAt": "2020-06-24T07:13:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNzM0MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNzYyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444137629", "bodyText": "nit: documentFields.isEmpty() == false?", "author": "cbuescher", "createdAt": "2020-06-23T10:56:15Z", "path": "server/src/main/java/org/elasticsearch/search/SearchHit.java", "diffHunk": "@@ -647,10 +652,15 @@ public XContentBuilder toInnerXContent(XContentBuilder builder, Params params) t\n         if (source != null) {\n             XContentHelper.writeRawField(SourceFieldMapper.NAME, source, builder, params);\n         }\n-        if (!documentFields.isEmpty()) {\n+        if (!documentFields.isEmpty() &&", "originalCommit": "6f8588b2e23785f5dc8075ea3b7dd81a2b741f35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MDk1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444690956", "bodyText": "b947758", "author": "jimczi", "createdAt": "2020-06-24T07:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzNzYyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "b947758d96000e4b6aa87b1b4bf531dd1f0f9677", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/SearchHit.java b/server/src/main/java/org/elasticsearch/search/SearchHit.java\nindex 8603b910f54..24e5eb7902e 100644\n--- a/server/src/main/java/org/elasticsearch/search/SearchHit.java\n+++ b/server/src/main/java/org/elasticsearch/search/SearchHit.java\n\n@@ -652,7 +652,7 @@ public final class SearchHit implements Writeable, ToXContentObject, Iterable<Do\n         if (source != null) {\n             XContentHelper.writeRawField(SourceFieldMapper.NAME, source, builder, params);\n         }\n-        if (!documentFields.isEmpty() &&\n+        if (documentFields.isEmpty() == false &&\n                 // ignore fields all together if they are all empty\n                 documentFields.values().stream()\n                     .anyMatch(df -> df.getValues().size() > 0)) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzODQ5OA==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444138498", "bodyText": "Can we also check that the fields object is not only empty in the xContent rendering but really not present? I think the parsed object would contain an empty map regardless.", "author": "cbuescher", "createdAt": "2020-06-23T10:58:07Z", "path": "server/src/test/java/org/elasticsearch/search/SearchHitTests.java", "diffHunk": "@@ -353,6 +353,42 @@ public void testWeirdScriptFields() throws Exception {\n         }\n     }\n \n+    public void testToXContentEmptyFields() throws IOException {\n+        Map<String, DocumentField> fields = new HashMap<>();\n+        fields.put(\"foo\", new DocumentField(\"foo\", Collections.emptyList()));\n+        fields.put(\"bar\", new DocumentField(\"bar\", Collections.emptyList()));\n+        SearchHit hit = new SearchHit(0, \"_id\", fields, Collections.emptyMap());\n+        {\n+            BytesReference originalBytes = toShuffledXContent(hit, XContentType.JSON, ToXContent.EMPTY_PARAMS, randomBoolean());\n+            final SearchHit parsed;\n+            try (XContentParser parser = createParser(XContentType.JSON.xContent(), originalBytes)) {\n+                parser.nextToken(); // jump to first START_OBJECT\n+                parsed = SearchHit.fromXContent(parser);\n+                assertEquals(XContentParser.Token.END_OBJECT, parser.currentToken());\n+                assertNull(parser.nextToken());\n+            }\n+            assertThat(parsed.getFields().size(), equalTo(0));", "originalCommit": "6f8588b2e23785f5dc8075ea3b7dd81a2b741f35", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5MDM3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444690379", "bodyText": "I am not sure I understand, we check if the empty fields are removed when rendering to xcontent. What kind of test are you expecting ?", "author": "jimczi", "createdAt": "2020-06-24T07:12:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc0Mjk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444742996", "bodyText": "Sorry that I wasn't clear, what I mean is that both hits:\n{\u00a0\n    [...], \n    \"_source\" : { ... },\n    \"fields\" : { }\n}\n\nand\n{ \n    [...], \n    \"_source\" : { ... }\n}\n\nwould be parsed to a SearchHit where getFields() returns an empty map, but it would be nice to check that we really don't render the fields object at all when there are no entries to the documentFields with size>0. It's only about checking the output of the rendering step directly rather than parsing it, because then we cannot tell the difference in the test. Not sure if that's clearer now and if such a test is necessary but I think it would be good to add, but not a bit deal if not...", "author": "cbuescher", "createdAt": "2020-06-24T08:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzODQ5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg2NzgxMg==", "url": "https://github.com/elastic/elasticsearch/pull/58418#discussion_r444867812", "bodyText": "Got it, thanks. I pushed 459cb60", "author": "jimczi", "createdAt": "2020-06-24T12:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEzODQ5OA=="}], "type": "inlineReview", "revised_code": {"commit": "b947758d96000e4b6aa87b1b4bf531dd1f0f9677", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/SearchHitTests.java b/server/src/test/java/org/elasticsearch/search/SearchHitTests.java\nindex eede489e7f0..57cf763ff08 100644\n--- a/server/src/test/java/org/elasticsearch/search/SearchHitTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/SearchHitTests.java\n\n@@ -387,6 +387,23 @@ public class SearchHitTests extends AbstractWireSerializingTestCase<SearchHit> {\n             assertThat(parsed.getFields().get(\"bar\").getValues(), equalTo( Collections.singletonList(\"value\")));\n         }\n \n+        Map<String, DocumentField> metadata = new HashMap<>();\n+        metadata.put(\"_routing\", new DocumentField(\"_routing\", Collections.emptyList()));\n+        hit = new SearchHit(0, \"_id\", fields, Collections.emptyMap());\n+        {\n+            BytesReference originalBytes = toShuffledXContent(hit, XContentType.JSON, ToXContent.EMPTY_PARAMS, randomBoolean());\n+            final SearchHit parsed;\n+            try (XContentParser parser = createParser(XContentType.JSON.xContent(), originalBytes)) {\n+                parser.nextToken(); // jump to first START_OBJECT\n+                parsed = SearchHit.fromXContent(parser);\n+                assertEquals(XContentParser.Token.END_OBJECT, parser.currentToken());\n+                assertNull(parser.nextToken());\n+            }\n+            assertThat(parsed.getFields().size(), equalTo(1));\n+            assertThat(parsed.getFields().get(\"bar\").getValues(), equalTo( Collections.singletonList(\"value\")));\n+            assertNull(parsed.getFields().get(\"_routing\"));\n+        }\n+\n     }\n \n     static Explanation createExplanation(int depth) {\n"}}, {"oid": "781cd16fad455a5565c91ec8a44e3d7b15666c75", "url": "https://github.com/elastic/elasticsearch/commit/781cd16fad455a5565c91ec8a44e3d7b15666c75", "message": "Merge branch 'master' into bug/search_hit_empty_fields", "committedDate": "2020-06-24T07:06:44Z", "type": "commit"}, {"oid": "b947758d96000e4b6aa87b1b4bf531dd1f0f9677", "url": "https://github.com/elastic/elasticsearch/commit/b947758d96000e4b6aa87b1b4bf531dd1f0f9677", "message": "address review", "committedDate": "2020-06-24T07:13:11Z", "type": "commit"}, {"oid": "459cb604e4464f8ee2978958b7ebaaff993dd7de", "url": "https://github.com/elastic/elasticsearch/commit/459cb604e4464f8ee2978958b7ebaaff993dd7de", "message": "check fields is missing from xcontent", "committedDate": "2020-06-24T12:47:35Z", "type": "commit"}]}