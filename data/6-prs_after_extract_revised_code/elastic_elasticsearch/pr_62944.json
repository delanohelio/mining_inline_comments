{"pr_number": 62944, "pr_title": "Fix Race in ClusterApplierService Shutdown", "pr_createdAt": "2020-09-28T10:49:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62944", "timeline": [{"oid": "b41eb19b06ae95584981e6beac7b28bf12eee172", "url": "https://github.com/elastic/elasticsearch/commit/b41eb19b06ae95584981e6beac7b28bf12eee172", "message": "Fix Race in ClusterApplierService Shutdown\n\nThe iteration over `timeoutClusterStateListeners` starts when the CS applier\nthread is still running. This can lead to entries being added to it that never\nget their listener resolved on shutdown and thus leak that listener as observed\nin a stuck test in #62863.\nSince `listener.onClose()` is idempotent we can just call it if we run into a stopped service\non the CS thread to avoid the race with certainty (because the iteration in `doStop` starts after\nthe stopped state has been set).\n\nCloses #62863", "committedDate": "2020-09-28T10:46:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MTcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/62944#discussion_r499371723", "bodyText": "Could we not do this 3 lines earlier? No need to schedule a task in this case.", "author": "henningandersen", "createdAt": "2020-10-05T06:39:40Z", "path": "server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java", "diffHunk": "@@ -274,6 +274,10 @@ public void run() {\n                     if (timeout != null) {\n                         notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);\n                     }\n+                    if (lifecycle.stoppedOrClosed()) {", "originalCommit": "b41eb19b06ae95584981e6beac7b28bf12eee172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3Mzg5MA==", "url": "https://github.com/elastic/elasticsearch/pull/62944#discussion_r499373890", "bodyText": "Right we could -> will do :)", "author": "original-brownbear", "createdAt": "2020-10-05T06:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MTcyMw=="}], "type": "inlineReview", "revised_code": {"commit": "b420c5ac7e807c616953c7c2ddbae095216584cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java b/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java\nindex d805476b7e5..d43ee954b30 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java\n\n@@ -271,13 +271,13 @@ public class ClusterApplierService extends AbstractLifecycleComponent implements\n                     final NotifyTimeout notifyTimeout = new NotifyTimeout(listener, timeout);\n                     final NotifyTimeout previous = timeoutClusterStateListeners.put(listener, notifyTimeout);\n                     assert previous == null : \"Added same listener [\" + listener + \"]\";\n-                    if (timeout != null) {\n-                        notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);\n-                    }\n                     if (lifecycle.stoppedOrClosed()) {\n                         listener.onClose();\n                         return;\n                     }\n+                    if (timeout != null) {\n+                        notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);\n+                    }\n                     listener.postAdded();\n                 }\n             });\n"}}, {"oid": "cb64bb3466ccd0a6994d07d0aba7b23e946ab9e8", "url": "https://github.com/elastic/elasticsearch/commit/cb64bb3466ccd0a6994d07d0aba7b23e946ab9e8", "message": "Merge remote-tracking branch 'elastic/master' into 62863-2", "committedDate": "2020-10-05T06:44:00Z", "type": "commit"}, {"oid": "b420c5ac7e807c616953c7c2ddbae095216584cb", "url": "https://github.com/elastic/elasticsearch/commit/b420c5ac7e807c616953c7c2ddbae095216584cb", "message": "CR: check earlier", "committedDate": "2020-10-05T06:48:19Z", "type": "commit"}]}