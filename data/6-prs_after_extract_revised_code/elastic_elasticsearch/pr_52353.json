{"pr_number": 52353, "pr_title": "[7.x][ML] Refactor ML mappings and templates into JSON resources (#51\u2026", "pr_createdAt": "2020-02-14T09:32:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52353", "timeline": [{"oid": "697fcf0b8176916a0736f55f5022a94846f49615", "url": "https://github.com/elastic/elasticsearch/commit/697fcf0b8176916a0736f55f5022a94846f49615", "message": "[7.x][ML] Refactor ML mappings and templates into JSON resources (#51765)\n\nML mappings and index templates have so far been created\nprogrammatically. While this had its merits due to static typing,\nthere is consensus it would be clear to maintain those in json files.\nIn addition, we are going to adding ILM policies to these indices\nand the component for a plugin to register ILM policies is\n`IndexTemplateRegistry`. It expects the templates to be in resource\njson files.\n\nFor the above reasons this commit refactors ML mappings and index\ntemplates into json resource files that are registered via\n`MlIndexTemplateRegistry`.\n\nBackport of #51765", "committedDate": "2020-02-14T09:26:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMyOTk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52353#discussion_r379329979", "bodyText": "In 7.x we need to still handle 6.x indices that have doc instead of _doc as the mapping type for the config and results index.", "author": "dimitris-athanasiou", "createdAt": "2020-02-14T09:33:29Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/MlConfigIndex.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.xpack.core.template.TemplateUtils;\n+\n+import java.util.Collections;\n+\n+public class MlConfigIndex {\n+\n+    private static final String MAPPINGS_VERSION_VARIABLE = \"xpack.ml.version\";\n+\n+    private MlConfigIndex() {}\n+\n+    public static String mapping() {\n+        return mapping(MapperService.SINGLE_MAPPING_NAME);\n+    }\n+\n+    public static String mapping(String mappingType) {", "originalCommit": "697fcf0b8176916a0736f55f5022a94846f49615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMzMDI4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52353#discussion_r379330289", "bodyText": "This is where we pass the mapping type to the mapping supplier method.", "author": "dimitris-athanasiou", "createdAt": "2020-02-14T09:34:09Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/persistence/ElasticsearchMappings.java", "diffHunk": "@@ -1290,10 +170,11 @@ public static void addDocMappingIfMissing(String alias,\n             IndexMetaData indexMetaData = state.metaData().index(indicesThatRequireAnUpdate[0]);\n             String mappingType = indexMetaData.mapping().type();\n \n-            try (XContentBuilder mapping = mappingSupplier.apply(mappingType)) {\n+            try {\n+                String mapping = mappingSupplier.apply(mappingType);", "originalCommit": "697fcf0b8176916a0736f55f5022a94846f49615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMzMDUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/52353#discussion_r379330503", "bodyText": "In 7.x we need to still handle 6.x indices that have doc instead of _doc as the mapping type for the config and results index.", "author": "dimitris-athanasiou", "createdAt": "2020-02-14T09:34:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/persistence/AnomalyDetectorsIndex.java", "diffHunk": "@@ -144,4 +150,12 @@ public static void createStateIndexAndAliasIfNecessary(Client client, ClusterSta\n         }\n     }\n \n+    public static String resultsMapping() {\n+        return resultsMapping(MapperService.SINGLE_MAPPING_NAME);\n+    }\n+\n+    public static String resultsMapping(String mappingType) {", "originalCommit": "697fcf0b8176916a0736f55f5022a94846f49615", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "4db195813a265cbb71c0412b90df5fec435ec86e", "url": "https://github.com/elastic/elasticsearch/commit/4db195813a265cbb71c0412b90df5fec435ec86e", "message": "Fix bwc test", "committedDate": "2020-02-14T10:45:43Z", "type": "commit"}, {"oid": "572aaaf4719eda50692087051397dd8f4d5fe6a1", "url": "https://github.com/elastic/elasticsearch/commit/572aaaf4719eda50692087051397dd8f4d5fe6a1", "message": "Really fix bwc test", "committedDate": "2020-02-14T11:05:22Z", "type": "commit"}, {"oid": "92e22e679a8e83969498c14799b362ca631b55d6", "url": "https://github.com/elastic/elasticsearch/commit/92e22e679a8e83969498c14799b362ca631b55d6", "message": "Fix MlConfigMigratorIT failure", "committedDate": "2020-02-14T12:05:08Z", "type": "commit"}]}