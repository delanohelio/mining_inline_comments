{"pr_number": 60093, "pr_title": "Allow CCR on nodes with legacy roles only", "pr_createdAt": "2020-07-22T21:18:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60093", "timeline": [{"oid": "527998075868c5548673c4233387587894d68891", "url": "https://github.com/elastic/elasticsearch/commit/527998075868c5548673c4233387587894d68891", "message": "Assume old nodes have remote cluster client role", "committedDate": "2020-07-22T21:17:57Z", "type": "commit"}, {"oid": "990ea086af13407247b7a5bea80750313ca51113", "url": "https://github.com/elastic/elasticsearch/commit/990ea086af13407247b7a5bea80750313ca51113", "message": "Merge branch '7.x' into 7x-remote-cluster-role", "committedDate": "2020-07-23T00:46:47Z", "type": "commit"}, {"oid": "104ff8721176841ef525c6e367e2a4bf93c93a95", "url": "https://github.com/elastic/elasticsearch/commit/104ff8721176841ef525c6e367e2a4bf93c93a95", "message": "do not add roles", "committedDate": "2020-07-23T00:55:45Z", "type": "commit"}, {"oid": "839c46de8dd80c06bb4a6e51ceafadfc978bccce", "url": "https://github.com/elastic/elasticsearch/commit/839c46de8dd80c06bb4a6e51ceafadfc978bccce", "message": "oops", "committedDate": "2020-07-23T02:37:14Z", "type": "commit"}, {"oid": "c75f661934bb2321d1ad0418f532a657efb0d7c3", "url": "https://github.com/elastic/elasticsearch/commit/c75f661934bb2321d1ad0418f532a657efb0d7c3", "message": "move the assumption to ccr", "committedDate": "2020-07-23T03:43:11Z", "type": "commit"}, {"oid": "bafccbcd3faaef7d5b1d01a324e0e14579f37865", "url": "https://github.com/elastic/elasticsearch/commit/bafccbcd3faaef7d5b1d01a324e0e14579f37865", "message": "fix test", "committedDate": "2020-07-23T04:12:33Z", "type": "commit"}, {"oid": "f43fdd17ac900408a1abff95de59c30fbe1ce11e", "url": "https://github.com/elastic/elasticsearch/commit/f43fdd17ac900408a1abff95de59c30fbe1ce11e", "message": "fix test", "committedDate": "2020-07-23T04:12:52Z", "type": "commit"}, {"oid": "fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4", "url": "https://github.com/elastic/elasticsearch/commit/fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4", "message": "avoid hotspot in a mixed cluster", "committedDate": "2020-07-28T17:56:55Z", "type": "commit"}, {"oid": "2069e529e5b4021c9aaaaba5812a3b057b426827", "url": "https://github.com/elastic/elasticsearch/commit/2069e529e5b4021c9aaaaba5812a3b057b426827", "message": "Merge branch '7.x' into 7x-remote-cluster-role", "committedDate": "2020-07-28T17:57:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r461884003", "bodyText": "Assigning to a node that is a data node but before version 7.3.0 could still fail (if the node doesn't have the remote cluster client role). I wonder if we should implement this as a last resort? So try to select the least loaded node that is a data node and is a remote cluster client. If that doesn't turn up any nodes, try to assign to a node that is a data node and is before the version that we formalized the remote cluster client role. Note that that is a different version than when we made roles pluggable.", "author": "jasontedor", "createdAt": "2020-07-28T21:15:15Z", "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -124,14 +123,14 @@ public void validate(ShardFollowTask params, ClusterState clusterState) {\n \n     @Override\n     public Assignment getAssignment(final ShardFollowTask params, final ClusterState clusterState) {\n-        final DiscoveryNode node = selectLeastLoadedNode(\n+        final DiscoveryNode selectedNode = selectLeastLoadedNode(\n             clusterState,\n-            ((Predicate<DiscoveryNode>) DiscoveryNode::isDataNode).and(DiscoveryNode::isRemoteClusterClient)\n+            node -> node.isDataNode() && (node.isRemoteClusterClient() || node.getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION))", "originalCommit": "2069e529e5b4021c9aaaaba5812a3b057b426827", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwODAyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r462008029", "bodyText": "I implemented this in fda3927, but I backed it out because I thought it could lead to hotspots on upgraded nodes. I am okay with either option. I pushed 7eeaa14 to restore this behavior.", "author": "dnhatn", "createdAt": "2020-07-29T02:56:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDAwMw=="}], "type": "inlineReview", "revised_code": {"commit": "7eeaa145c13f8c389e195683335d4e26bf206b7d", "chunk": "diff --git a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java\nindex cd7adf70632..b0e3d9a0ee4 100644\n--- a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java\n+++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java\n\n@@ -123,14 +124,17 @@ public class ShardFollowTasksExecutor extends PersistentTasksExecutor<ShardFollo\n \n     @Override\n     public Assignment getAssignment(final ShardFollowTask params, final ClusterState clusterState) {\n-        final DiscoveryNode selectedNode = selectLeastLoadedNode(\n+        DiscoveryNode node = selectLeastLoadedNode(\n             clusterState,\n-            node -> node.isDataNode() && (node.isRemoteClusterClient() || node.getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION))\n+            ((Predicate<DiscoveryNode>) DiscoveryNode::isDataNode).and(DiscoveryNode::isRemoteClusterClient)\n         );\n-        if (selectedNode == null) {\n+        if (node == null) {\n+            node = selectLeastLoadedNode(clusterState, n -> n.isDataNode() && n.getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION));\n+        }\n+        if (node == null) {\n             return NO_ASSIGNMENT;\n         } else {\n-            return new Assignment(selectedNode.getId(), \"node is the least loaded data node and remote cluster client\");\n+            return new Assignment(node.getId(), \"node is the least loaded data node and remote cluster client\");\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDc0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r461884746", "bodyText": "I wonder if this should be the version that we introduced the remote cluster client role in as opposed to the version that we made node roles pluggable.", "author": "jasontedor", "createdAt": "2020-07-28T21:16:49Z", "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java", "diffHunk": "@@ -57,11 +58,14 @@ public Decision canAllocate(ShardRouting shardRouting, RoutingNode node, Routing\n             return allocation.decision(Decision.YES, NAME,\n                 \"shard is a primary follower but was bootstrapped already; hence is not under the purview of this decider\");\n         }\n-        if (node.node().isRemoteClusterClient() == false) {\n-            return allocation.decision(Decision.NO, NAME, \"shard is a primary follower and being bootstrapped, but node does not have the \"\n-                + DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE.roleName() + \" role\");\n+        if (node.node().isRemoteClusterClient()) {\n+            return allocation.decision(Decision.YES, NAME,\n+                \"shard is a primary follower and node has the \" + DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE.roleName() + \" role\");\n+        }\n+        if (node.node().getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION)) {", "originalCommit": "2069e529e5b4021c9aaaaba5812a3b057b426827", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwODEyNA==", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r462008124", "bodyText": "Good catch, fixed in 3a33f0a", "author": "dnhatn", "createdAt": "2020-07-29T02:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDc0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "3a33f0acd69337e5437dcb911e237582f3a821c6", "chunk": "diff --git a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java\nindex e162ce23e53..534d00e86f6 100644\n--- a/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java\n+++ b/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java\n\n@@ -62,7 +62,7 @@ public final class CcrPrimaryFollowerAllocationDecider extends AllocationDecider\n             return allocation.decision(Decision.YES, NAME,\n                 \"shard is a primary follower and node has the \" + DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE.roleName() + \" role\");\n         }\n-        if (node.node().getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION)) {\n+        if (node.node().getVersion().before(DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE_VERSION)) {\n             return allocation.decision(Decision.YES, NAME, \"shard is a primary follower and node has only the legacy roles\");\n         }\n         return allocation.decision(Decision.NO, NAME, \"shard is a primary follower and being bootstrapped, but node does not have the \"\n"}}, {"oid": "7eeaa145c13f8c389e195683335d4e26bf206b7d", "url": "https://github.com/elastic/elasticsearch/commit/7eeaa145c13f8c389e195683335d4e26bf206b7d", "message": "Revert \"avoid hotspot in a mixed cluster\"\n\nThis reverts commit fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4.", "committedDate": "2020-07-28T23:50:37Z", "type": "commit"}, {"oid": "3a33f0acd69337e5437dcb911e237582f3a821c6", "url": "https://github.com/elastic/elasticsearch/commit/3a33f0acd69337e5437dcb911e237582f3a821c6", "message": "correct version", "committedDate": "2020-07-29T02:53:03Z", "type": "commit"}, {"oid": "eace13080101c9b46c3b8aad6843e2fa41141ddf", "url": "https://github.com/elastic/elasticsearch/commit/eace13080101c9b46c3b8aad6843e2fa41141ddf", "message": "remove unused import", "committedDate": "2020-07-29T03:07:02Z", "type": "commit"}]}