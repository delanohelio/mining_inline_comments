{"pr_number": 58547, "pr_title": "Fix two scripted_metric bugs", "pr_createdAt": "2020-06-25T13:27:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58547", "timeline": [{"oid": "01ff4720768d7f7aab65451e792e081fec01f091", "url": "https://github.com/elastic/elasticsearch/commit/01ff4720768d7f7aab65451e792e081fec01f091", "message": "Fix two scripted_metric bugs\n\nFixes two bugs introduced by #57627:\n1. We were not properly letting go of memory from the request breaker\n   when the aggregation finished.\n2. We no longer supported totally arbitrary stuff produced by the init\n   script because we *assumed* that it'd be ok to run the script once\n   and clone its results. Sadly, cloning can't clone *anything* that the\n   init script can make, like `String` arrays. This runs the init script\n   once for every new bucket so we don't need to clone.", "committedDate": "2020-06-25T13:26:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mjc3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445562776", "bodyText": "We could check this for all aggs in the AggregatorTestCase directly ?", "author": "jimczi", "createdAt": "2020-06-25T13:35:45Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregatorTests.java", "diffHunk": "@@ -181,6 +200,46 @@ public static void initMockScripts() {\n            state.put(\"selfRef\", state);\n            return state;\n         });\n+        SCRIPTS.put(\"initScriptMakingArray\", params -> {\n+            Map<String, Object> state = (Map<String, Object>) params.get(\"state\");\n+            state.put(\"array\", new String[] {\"foo\", \"bar\"});\n+            state.put(\"collector\", new ArrayList<Integer>());\n+            return state;\n+         });\n+    }\n+\n+    private CircuitBreakerService circuitBreakerService;\n+\n+    @Before\n+    public void mockBreaker() {", "originalCommit": "01ff4720768d7f7aab65451e792e081fec01f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4MjI3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445582279", "bodyText": "Would you be ok if I moved it in there in a followup? I think there are quite a few fiddly things involved in getting that right.", "author": "nik9000", "createdAt": "2020-06-25T14:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mjc3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxMzUzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445613539", "bodyText": "Sure, it might uncovered some other bugs so be prepared ;).", "author": "jimczi", "createdAt": "2020-06-25T14:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mjc3Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mzc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445563757", "bodyText": ";)", "author": "jimczi", "createdAt": "2020-06-25T13:37:07Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java", "diffHunk": "@@ -170,7 +180,7 @@ public InternalAggregation buildEmptyAggregation() {\n     }\n \n     @Override\n-    public void close() {\n+    public void doClose() {", "originalCommit": "01ff4720768d7f7aab65451e792e081fec01f091", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU4MjQyOA==", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445582428", "bodyText": "I'm dreaming of a checkstyle rule.....", "author": "nik9000", "createdAt": "2020-06-25T14:02:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mzc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e4d9212a4e72abd6398b96cf0d8eafd629e27666", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java\nindex bf881931521..c718024a9b2 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java\n\n@@ -186,17 +167,42 @@ class ScriptedMetricAggregator extends MetricsAggregator {\n \n     private class State {\n         private final ScriptedMetricAggContexts.MapScript.LeafFactory mapScript;\n+        private final Map<String, Object> mapScriptParamsForState;\n+        private final Map<String, Object> combineScriptParamsForState;\n         private final Map<String, Object> aggState;\n         private MapScript leafMapScript;\n \n         State() {\n-            aggState = newInitialState();\n+            // Its possible for building the initial state to mutate the parameters as a side effect\n+            Map<String, Object> aggParamsForState = ScriptedMetricAggregatorFactory.deepCopyParams(aggParams, context);\n+            mapScriptParamsForState = ScriptedMetricAggregatorFactory.mergeParams(aggParamsForState, mapScriptParams);\n+            combineScriptParamsForState = ScriptedMetricAggregatorFactory.mergeParams(aggParamsForState, combineScriptParams);\n+            aggState = newInitialState(ScriptedMetricAggregatorFactory.mergeParams(aggParamsForState, initScriptParams));\n             mapScript = mapScriptFactory.newFactory(\n-                // Send a deep copy of the params because the script is allowed to mutate it\n-                ScriptedMetricAggregatorFactory.deepCopyParams(mapScriptParams, context),\n+                ScriptedMetricAggregatorFactory.deepCopyParams(mapScriptParamsForState, context),\n                 aggState,\n                 lookup\n             );\n         }\n+\n+        private Map<String, Object> newInitialState(Map<String, Object> initScriptParamsForState) {\n+            if (initScriptFactory == null) {\n+                return new HashMap<>();\n+            }\n+            Map<String, Object> initialState = new HashMap<>();\n+            initScriptFactory.newInstance(initScriptParamsForState, initialState).execute();\n+            CollectionUtils.ensureNoSelfReferences(initialState, \"Scripted metric aggs init script\");\n+            return initialState;\n+        }\n+\n+        private Object combine() {\n+            if (combineScriptFactory == null) {\n+                return aggState;\n+            }\n+            Object result = combineScriptFactory.newInstance(combineScriptParamsForState, aggState).execute();\n+            CollectionUtils.ensureNoSelfReferences(result, \"Scripted metric aggs combine script\");\n+            return result;\n+        }\n+\n     }\n }\n"}}, {"oid": "accffa5b01912e13e936802291e83c6abbac6020", "url": "https://github.com/elastic/elasticsearch/commit/accffa5b01912e13e936802291e83c6abbac6020", "message": "Merge branch 'master' into scripted_metric_mem_fixup", "committedDate": "2020-06-25T15:20:41Z", "type": "commit"}, {"oid": "e4d9212a4e72abd6398b96cf0d8eafd629e27666", "url": "https://github.com/elastic/elasticsearch/commit/e4d9212a4e72abd6398b96cf0d8eafd629e27666", "message": "Handle mutating params\n\nAdds code to handle when the init script mutates the aggregation\nparameters. I hadn't caught this in my initial testing and it is\n*weird*, but we allow it.", "committedDate": "2020-06-25T16:01:51Z", "type": "commit"}]}