{"pr_number": 54692, "pr_title": "Improve robustness of Query Result serializations", "pr_createdAt": "2020-04-02T22:49:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54692", "timeline": [{"oid": "e2ae755acac7ae91f5a2967b52ef1c01624d9d79", "url": "https://github.com/elastic/elasticsearch/commit/e2ae755acac7ae91f5a2967b52ef1c01624d9d79", "message": "Improve robustness of Query Result serializations\n\nMakes query result serialization more robust by propagating possible\nIOExceptions that can occur during shard level result serialization to the\ncaller instead of throwing AssertError that is not intercepted.\n\nFixes #54665", "committedDate": "2020-04-02T22:46:40Z", "type": "commit"}, {"oid": "cf338c1746cc0b21dfa7b646b55aeae92a63c94f", "url": "https://github.com/elastic/elasticsearch/commit/cf338c1746cc0b21dfa7b646b55aeae92a63c94f", "message": "Fix imports", "committedDate": "2020-04-02T23:27:04Z", "type": "commit"}, {"oid": "97734b56f7e4fd4a89adb55bdc4189ddc325d6b4", "url": "https://github.com/elastic/elasticsearch/commit/97734b56f7e4fd4a89adb55bdc4189ddc325d6b4", "message": "Address review comments", "committedDate": "2020-04-03T15:31:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMjEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54692#discussion_r403132139", "bodyText": "This should not be needed anymore, ? We should keep the error as it is.", "author": "jimczi", "createdAt": "2020-04-03T16:34:32Z", "path": "server/src/main/java/org/elasticsearch/indices/IndicesService.java", "diffHunk": "@@ -1374,9 +1374,8 @@ public void loadIntoContext(ShardSearchRequest request, SearchContext context, Q\n             queryPhase.execute(context);\n             try {\n                 context.queryResult().writeToNoId(out);\n-\n             } catch (IOException e) {\n-                throw new AssertionError(\"Could not serialize response\", e);\n+                throw new IllegalArgumentException(\"Could not serialize response\", e);", "originalCommit": "97734b56f7e4fd4a89adb55bdc4189ddc325d6b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMzY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54692#discussion_r403133649", "bodyText": "I think this statement is unsafe.", "author": "imotov", "createdAt": "2020-04-03T16:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzOTQ1MA==", "url": "https://github.com/elastic/elasticsearch/pull/54692#discussion_r403139450", "bodyText": "Then it should be an UncheckedIOException but imo this change is not needed.", "author": "jimczi", "createdAt": "2020-04-03T16:47:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMjEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk0ODc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/54692#discussion_r403948744", "bodyText": "In general when there is an IOException, you're in big trouble anyway, and trying to handle it is quite heroic. Since the signature of this method throws Exception, I'd be in favor of removing this catch block too. The root cause of the problem is that StreamOutput throws an IOException for something that is not I/O related.", "author": "jpountz", "createdAt": "2020-04-06T09:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMjEzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2e97b3e8e5303ed1e8171167b3d6e7891f2a9eb4", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/indices/IndicesService.java b/server/src/main/java/org/elasticsearch/indices/IndicesService.java\nindex 356e7438ce4..9f0c88ff7fe 100644\n--- a/server/src/main/java/org/elasticsearch/indices/IndicesService.java\n+++ b/server/src/main/java/org/elasticsearch/indices/IndicesService.java\n\n@@ -1372,11 +1374,7 @@ public class IndicesService extends AbstractLifecycleComponent\n             () -> \"Shard: \" + request.shardId() + \"\\nSource:\\n\" + request.source(),\n             out -> {\n             queryPhase.execute(context);\n-            try {\n-                context.queryResult().writeToNoId(out);\n-            } catch (IOException e) {\n-                throw new IllegalArgumentException(\"Could not serialize response\", e);\n-            }\n+            context.queryResult().writeToNoId(out);\n             loadedFromCache[0] = false;\n         });\n \n"}}, {"oid": "2e97b3e8e5303ed1e8171167b3d6e7891f2a9eb4", "url": "https://github.com/elastic/elasticsearch/commit/2e97b3e8e5303ed1e8171167b3d6e7891f2a9eb4", "message": "Return back IOException handling in IndicesService", "committedDate": "2020-04-06T16:55:35Z", "type": "commit"}, {"oid": "739aa093d3db51a6445d9b365b523a9692362633", "url": "https://github.com/elastic/elasticsearch/commit/739aa093d3db51a6445d9b365b523a9692362633", "message": "Merge branch 'master' into issue-54665-improve-query-result-serialization", "committedDate": "2020-04-06T17:14:08Z", "type": "commit"}]}