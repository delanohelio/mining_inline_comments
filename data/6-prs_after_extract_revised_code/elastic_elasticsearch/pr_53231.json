{"pr_number": 53231, "pr_title": "Fix potential NPE in FuzzyTermsEnum", "pr_createdAt": "2020-03-06T15:56:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53231", "timeline": [{"oid": "fd5687ba154cc84db16b9baac0731d6c6fc78cc6", "url": "https://github.com/elastic/elasticsearch/commit/fd5687ba154cc84db16b9baac0731d6c6fc78cc6", "message": "Fix potential NPE in FuzzyTermsEnum\n\nUnder certain circumstances SpanMultiTermQueryWrapper uses\nSpanBooleanQueryRewriteWithMaxClause as its rewrite method, which in turn tries\nto get a TermsEnum from the wrapped MultiTermQuery currently using a `null`\nAttributeSource. While queries TermsQuery or subclasses of AutomatonQuery ignore\nthis argument, FuzzyQuery uses it to create a FuzzyTermsEnum which triggers an\nNPE when the AttributeSource is not provided. This PR fixes this by supplying an\nempty AttributeSource instead of a `null` value.\n\nCloses #52894", "committedDate": "2020-03-06T15:55:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2MTk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53231#discussion_r389161992", "bodyText": "Can you change to a more descriptive name ? I don't think we should add a link to an issue in the comment either. This test checks that span_fuzzy query are correctly handled and #52894 revealed that it was missing.", "author": "jimczi", "createdAt": "2020-03-06T21:51:59Z", "path": "server/src/test/java/org/elasticsearch/search/query/SearchQueryIT.java", "diffHunk": "@@ -1758,4 +1761,19 @@ public void testFieldAliasesForMetaFields() throws Exception {\n        }\n \n    }\n+\n+    /**\n+     * Test fix for NPE from {@link SpanBooleanQueryRewriteWithMaxClause#rewrite(IndexReader, MultiTermQuery)}.\n+     * See https://github.com/elastic/elasticsearch/issues/52894 for details\n+     */\n+    public void testIssue52894() {", "originalCommit": "fd5687ba154cc84db16b9baac0731d6c6fc78cc6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "408ae607224025f72b0f0fa5c666bf2deb37ffc6", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/query/SearchQueryIT.java b/server/src/test/java/org/elasticsearch/search/query/SearchQueryIT.java\nindex b3fe7a8920d..51bb41f2389 100644\n--- a/server/src/test/java/org/elasticsearch/search/query/SearchQueryIT.java\n+++ b/server/src/test/java/org/elasticsearch/search/query/SearchQueryIT.java\n\n@@ -1763,10 +1764,11 @@ public class SearchQueryIT extends ESIntegTestCase {\n    }\n \n     /**\n-     * Test fix for NPE from {@link SpanBooleanQueryRewriteWithMaxClause#rewrite(IndexReader, MultiTermQuery)}.\n-     * See https://github.com/elastic/elasticsearch/issues/52894 for details\n+     * Test correct handling {@link SpanBooleanQueryRewriteWithMaxClause#rewrite(IndexReader, MultiTermQuery)}. That rewrite method is e.g.\n+     * set for fuzzy queries with \"constant_score\" rewrite nested inside a `span_multi` query and would cause NPEs due to an unset\n+     * {@link AttributeSource}.\n      */\n-    public void testIssue52894() {\n+    public void testIssueFuzzyInsideSpanMulti() {\n         createIndex(\"test\");\n         client().prepareIndex(\"test\").setId(\"1\").setSource(\"field\", \"foobarbaz\").get();\n         ensureGreen();\n"}}, {"oid": "408ae607224025f72b0f0fa5c666bf2deb37ffc6", "url": "https://github.com/elastic/elasticsearch/commit/408ae607224025f72b0f0fa5c666bf2deb37ffc6", "message": "change test name and description", "committedDate": "2020-03-09T10:08:58Z", "type": "commit"}]}