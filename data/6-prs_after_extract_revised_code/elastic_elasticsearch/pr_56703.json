{"pr_number": 56703, "pr_title": "Fix S3ClientSettings Leak", "pr_createdAt": "2020-05-13T17:13:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56703", "timeline": [{"oid": "1958036d1caea797b3b6557e40874bc5ddbb6aa7", "url": "https://github.com/elastic/elasticsearch/commit/1958036d1caea797b3b6557e40874bc5ddbb6aa7", "message": "Fix S3ClientSettings Leak\n\nFixes the fact that repository metadata with the same settings still results in\nmultiple settings instances being cached as well as leaking settings on closing\na repository.\n\nCloses #56702", "committedDate": "2020-05-13T17:11:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMTc3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56703#discussion_r424601779", "bodyText": "The logic of just blank clearing out everything here isn't great but with the complicated way in which we handle the AWS references I figured I'd rather not make this code more complicated and for now keep invalidating the whole cache on closing any repo.", "author": "original-brownbear", "createdAt": "2020-05-13T17:16:08Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java", "diffHunk": "@@ -214,6 +215,7 @@ private synchronized void releaseCachedClients() {\n         }\n         // clear previously cached clients, they will be build lazily\n         clientsCache = emptyMap();\n+        derivedClientSettings = emptyMap();", "originalCommit": "1958036d1caea797b3b6557e40874bc5ddbb6aa7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwMzA3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56703#discussion_r424603073", "bodyText": "Keying this by metadata was just plain wrong. The whole point of this map was to not duplicate S3ClientSettings but no two repos will ever share the exact same metadata obviously ... moving this to settings since only the Settings in the metadata go into the derived settings anyway.", "author": "original-brownbear", "createdAt": "2020-05-13T17:18:17Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java", "diffHunk": "@@ -57,7 +57,7 @@\n      * Client settings derived from those in {@link #staticClientSettings} by combining them with settings\n      * in the {@link RepositoryMetadata}.\n      */\n-    private volatile Map<S3ClientSettings, Map<RepositoryMetadata, S3ClientSettings>> derivedClientSettings = emptyMap();\n+    private volatile Map<S3ClientSettings, Map<Settings, S3ClientSettings>> derivedClientSettings = emptyMap();", "originalCommit": "1958036d1caea797b3b6557e40874bc5ddbb6aa7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "56ee45d034190090f514f6094379ea5b566ca8cf", "chunk": "diff --git a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java\nindex 457ea33d683..c60c0ea7908 100644\n--- a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java\n+++ b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java\n\n@@ -57,7 +57,7 @@ class S3Service implements Closeable {\n      * Client settings derived from those in {@link #staticClientSettings} by combining them with settings\n      * in the {@link RepositoryMetadata}.\n      */\n-    private volatile Map<S3ClientSettings, Map<Settings, S3ClientSettings>> derivedClientSettings = emptyMap();\n+    private volatile Map<Settings, S3ClientSettings> derivedClientSettings = emptyMap();\n \n     /**\n      * Refreshes the settings for the AmazonS3 clients and clears the cache of\n"}}, {"oid": "56ee45d034190090f514f6094379ea5b566ca8cf", "url": "https://github.com/elastic/elasticsearch/commit/56ee45d034190090f514f6094379ea5b566ca8cf", "message": "simpler", "committedDate": "2020-05-13T18:15:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzOTUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56703#discussion_r424639521", "bodyText": "This was way over-engineered. Since we don't have any selective cache invalidation when the static settings get refreshed, using this kind of complicated map was completely pointless.", "author": "original-brownbear", "createdAt": "2020-05-13T18:18:38Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3Service.java", "diffHunk": "@@ -57,7 +57,7 @@\n      * Client settings derived from those in {@link #staticClientSettings} by combining them with settings\n      * in the {@link RepositoryMetadata}.\n      */\n-    private volatile Map<S3ClientSettings, Map<RepositoryMetadata, S3ClientSettings>> derivedClientSettings = emptyMap();\n+    private volatile Map<Settings, S3ClientSettings> derivedClientSettings = emptyMap();", "originalCommit": "56ee45d034190090f514f6094379ea5b566ca8cf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "d65d4804afd6ca20595cf93a11e2bf3705146e34", "url": "https://github.com/elastic/elasticsearch/commit/d65d4804afd6ca20595cf93a11e2bf3705146e34", "message": "keep optimization", "committedDate": "2020-05-13T18:21:21Z", "type": "commit"}, {"oid": "b157d5947621e0858543a1293570e100009fe3ec", "url": "https://github.com/elastic/elasticsearch/commit/b157d5947621e0858543a1293570e100009fe3ec", "message": "fix test", "committedDate": "2020-05-13T18:23:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk1MzgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56703#discussion_r424953831", "bodyText": "nit: maybe we can name the parameter repositorySettings?", "author": "fcofdez", "createdAt": "2020-05-14T08:19:10Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java", "diffHunk": "@@ -179,14 +178,13 @@ private S3ClientSettings(S3BasicCredentials credentials, String endpoint, Protoc\n     /**\n      * Overrides the settings in this instance with settings found in repository metadata.\n      *\n-     * @param metadata RepositoryMetadata\n+     * @param settings found in repository metadata\n      * @return S3ClientSettings\n      */\n-    S3ClientSettings refine(RepositoryMetadata metadata) {\n-        final Settings repoSettings = metadata.settings();\n+    S3ClientSettings refine(Settings settings) {", "originalCommit": "b157d5947621e0858543a1293570e100009fe3ec", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "53e87150951ec14db4262d0a41689d77d8b0dae3", "chunk": "diff --git a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java\nindex 31f6ac00c10..d5b636d1656 100644\n--- a/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java\n+++ b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3ClientSettings.java\n\n@@ -178,13 +178,13 @@ final class S3ClientSettings {\n     /**\n      * Overrides the settings in this instance with settings found in repository metadata.\n      *\n-     * @param settings found in repository metadata\n+     * @param repositorySettings found in repository metadata\n      * @return S3ClientSettings\n      */\n-    S3ClientSettings refine(Settings settings) {\n+    S3ClientSettings refine(Settings repositorySettings) {\n         // Normalize settings to placeholder client settings prefix so that we can use the affix settings directly\n         final Settings normalizedSettings =\n-            Settings.builder().put(settings).normalizePrefix(PREFIX + PLACEHOLDER_CLIENT + '.').build();\n+            Settings.builder().put(repositorySettings).normalizePrefix(PREFIX + PLACEHOLDER_CLIENT + '.').build();\n         final String newEndpoint = getRepoSettingOrDefault(ENDPOINT_SETTING, normalizedSettings, endpoint);\n \n         final Protocol newProtocol = getRepoSettingOrDefault(PROTOCOL_SETTING, normalizedSettings, protocol);\n"}}, {"oid": "d5ffd36455887da5a27d691adc123ae87b2e5497", "url": "https://github.com/elastic/elasticsearch/commit/d5ffd36455887da5a27d691adc123ae87b2e5497", "message": "Merge remote-tracking branch 'elastic/master' into s3-client-mem-leak", "committedDate": "2020-05-14T08:47:07Z", "type": "commit"}, {"oid": "53e87150951ec14db4262d0a41689d77d8b0dae3", "url": "https://github.com/elastic/elasticsearch/commit/53e87150951ec14db4262d0a41689d77d8b0dae3", "message": "CR: renaming", "committedDate": "2020-05-14T08:50:12Z", "type": "commit"}]}