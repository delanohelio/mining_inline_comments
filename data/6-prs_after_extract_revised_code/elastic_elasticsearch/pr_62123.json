{"pr_number": 62123, "pr_title": "[ML] only persist progress if it has changed", "pr_createdAt": "2020-09-08T17:04:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62123", "timeline": [{"oid": "6dc2c7bc92c3cfdfbe8c75b21a048b2f4e94fb13", "url": "https://github.com/elastic/elasticsearch/commit/6dc2c7bc92c3cfdfbe8c75b21a048b2f4e94fb13", "message": "[ML] only persist progress if it has changed\n\nWe already search for the previously stored progress document.\n\nFor optimization purposes, and to prevent restoring the same\nprogress after a failed analytics job is stopped,\nthis commit does an equality check between the previously stored progress and current progress\nIf the progress has changed, persistence continues as normal.", "committedDate": "2020-09-08T17:18:10Z", "type": "commit"}, {"oid": "6dc2c7bc92c3cfdfbe8c75b21a048b2f4e94fb13", "url": "https://github.com/elastic/elasticsearch/commit/6dc2c7bc92c3cfdfbe8c75b21a048b2f4e94fb13", "message": "[ML] only persist progress if it has changed\n\nWe already search for the previously stored progress document.\n\nFor optimization purposes, and to prevent restoring the same\nprogress after a failed analytics job is stopped,\nthis commit does an equality check between the previously stored progress and current progress\nIf the progress has changed, persistence continues as normal.", "committedDate": "2020-09-08T17:18:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ4NDE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/62123#discussion_r485484148", "bodyText": "Could you explain how we could have leftover progress here?", "author": "dimitris-athanasiou", "createdAt": "2020-09-09T09:48:06Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java", "diffHunk": "@@ -93,7 +97,13 @@ private void cleanUpAnalytics() {\n         for (DataFrameAnalyticsConfig config : analytics) {\n             try {\n                 assertThat(deleteAnalytics(config.getId()).isAcknowledged(), is(true));\n-                assertThat(searchStoredProgress(config.getId()).getHits().getTotalHits().value, equalTo(0L));\n+                if (searchStoredProgress(config.getId()).getHits().getTotalHits().value > 0) {", "originalCommit": "6dc2c7bc92c3cfdfbe8c75b21a048b2f4e94fb13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU1MDIwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/62123#discussion_r485550205", "bodyText": "@dimitris-athanasiou the overall change only partially handles the race condition window.\n\nforce close a job\npersist progress\ndelete job (deletes previous progress)\njob finally fires onCancelled()\njob sees that there was no previous progress persisted\npersists the new progress", "author": "benwtrent", "createdAt": "2020-09-09T11:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ4NDE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY2MjQ4MA==", "url": "https://github.com/elastic/elasticsearch/pull/62123#discussion_r485662480", "bodyText": "OK, I think we can then remove the assertion here entirely. I'll add a test dedicated to deleting a job and checking things like the stored progress doc was cleaned up in a separate PR.", "author": "dimitris-athanasiou", "createdAt": "2020-09-09T14:35:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ4NDE0OA=="}], "type": "inlineReview", "revised_code": {"commit": "f4757b97efea2afe0c3c920085ad56e688543d3e", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java\nindex 3da351dd079..5046e0b6c3b 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java\n\n@@ -97,13 +93,6 @@ abstract class MlNativeDataFrameAnalyticsIntegTestCase extends MlNativeIntegTest\n         for (DataFrameAnalyticsConfig config : analytics) {\n             try {\n                 assertThat(deleteAnalytics(config.getId()).isAcknowledged(), is(true));\n-                if (searchStoredProgress(config.getId()).getHits().getTotalHits().value > 0) {\n-                    logger.warn(\"[{}] had progress written after it was deleted.\", config.getId());\n-                    UnusedStateRemover remover = new UnusedStateRemover(new OriginSettingClient(client(), ML_ORIGIN), clusterService());\n-                    PlainActionFuture<Boolean> future = new PlainActionFuture<>();\n-                    remover.remove(Float.POSITIVE_INFINITY, future, () -> false);\n-                    future.actionGet();\n-                }\n             } catch (Exception e) {\n                 // just log and ignore\n                 logger.error(new ParameterizedMessage(\"[{}] Could not clean up analytics job config\", config.getId()), e);\n"}}, {"oid": "f4757b97efea2afe0c3c920085ad56e688543d3e", "url": "https://github.com/elastic/elasticsearch/commit/f4757b97efea2afe0c3c920085ad56e688543d3e", "message": "removing assertion on left over progress", "committedDate": "2020-09-09T14:35:20Z", "type": "commit"}]}