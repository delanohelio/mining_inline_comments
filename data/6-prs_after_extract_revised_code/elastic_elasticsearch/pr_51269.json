{"pr_number": 51269, "pr_title": "Add host address to BindTransportException message", "pr_createdAt": "2020-01-21T20:12:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51269", "timeline": [{"oid": "07a0b5bef8f470c3a97085d4dba88c4f19626b07", "url": "https://github.com/elastic/elasticsearch/commit/07a0b5bef8f470c3a97085d4dba88c4f19626b07", "message": "Add host address to BindTransportException message\n\nWhen bind fails, show the host address in addition to the port. This\nhelps debugging cases with wrong \"network.host\" values.\n\nCloses #48001", "committedDate": "2020-01-21T19:48:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r369433972", "bodyText": "This is failing forbidden APIs checks, see the logs:\nForbidden method invocation: java.net.InetAddress#getHostAddress() [use NetworkAddress format/formatAddress to print IP or IP+ports]\n  in org.elasticsearch.transport.TcpTransport (TcpTransport.java:381)\nForbidden method invocation: java.net.InetAddress#getHostAddress() [use NetworkAddress format/formatAddress to print IP or IP+ports]\n  in org.elasticsearch.http.AbstractHttpServerTransport (AbstractHttpServerTransport.java:178)\nScanned 5715 class file(s) for forbidden API invocations (in 5.20s), 2 error(s).", "author": "original-brownbear", "createdAt": "2020-01-22T08:55:25Z", "path": "server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java", "diffHunk": "@@ -174,7 +174,10 @@ private TransportAddress bindAddress(final InetAddress hostAddress) {\n             return true;\n         });\n         if (!success) {\n-            throw new BindHttpException(\"Failed to bind to [\" + port.getPortRangeString() + \"]\", lastException.get());\n+            throw new BindHttpException(", "originalCommit": "07a0b5bef8f470c3a97085d4dba88c4f19626b07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4NjQ0MA==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r369486440", "bodyText": "Hi @original-brownbear, thanks for reviewing this. I ran the tests but forgot to run the check task. Will fix this ASAP.", "author": "mariaral", "createdAt": "2020-01-22T10:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4NzUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r369487528", "bodyText": "@mariaral FYI, you can just run these simple static code checks via:\n./gradlew precommit \n\nno need to run a full check for those", "author": "original-brownbear", "createdAt": "2020-01-22T10:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg1MjI0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r369852243", "bodyText": "Thanks @original-brownbear for the tip. I didn't know of the precommit task.\nI'm thinking of extending NetworkAddress.format() to be able to handle PortsRange objects and use that instead of coping the same message in five places. I propose using the following format:\n    IPv4 no port: 127.0.0.1\n    IPv4 single port: 127.0.0.1:9300\n    IPv4 multiple ports: 127.0.0.1:[9300-9400]\n    IPv6 multiple ports: [::1]:[9300-9400]\n\nWhat do you think?", "author": "mariaral", "createdAt": "2020-01-22T22:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDAxNjY4OA==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r370016688", "bodyText": "I only count two spots where we print the PortsRange but fine by me to keep it consistent via a utility method :)", "author": "original-brownbear", "createdAt": "2020-01-23T09:43:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDMzMTk5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r370331999", "bodyText": "I pushed a new commit. Please take a look.", "author": "mariaral", "createdAt": "2020-01-23T20:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzMzk3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "52705b587c220f6643932ccedcc1f1ab7b3eee3b", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java b/server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java\nindex 44ab60f4341..ae9028d07e0 100644\n--- a/server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java\n+++ b/server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java\n\n@@ -175,7 +175,7 @@ public abstract class AbstractHttpServerTransport extends AbstractLifecycleCompo\n         });\n         if (!success) {\n             throw new BindHttpException(\n-                \"Failed to bind to [\" + port.getPortRangeString() + \"] on \" + hostAddress.getHostAddress(),\n+                \"Failed to bind to \" + NetworkAddress.format(hostAddress, port),\n                 lastException.get()\n             );\n         }\n"}}, {"oid": "52705b587c220f6643932ccedcc1f1ab7b3eee3b", "url": "https://github.com/elastic/elasticsearch/commit/52705b587c220f6643932ccedcc1f1ab7b3eee3b", "message": "Extend NetworkAddress.format() to handle port ranges\n\nExtend NetworkAddress.format() to handle port ranges and use this\nutility method instead of forbidden InetAddress.getHostAddress().", "committedDate": "2020-01-23T19:29:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwNDk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r371804943", "bodyText": "Please would you add a test case to NetworkAddressTests for this new behaviour?", "author": "DaveCTurner", "createdAt": "2020-01-28T13:36:42Z", "path": "server/src/main/java/org/elasticsearch/common/network/NetworkAddress.java", "diffHunk": "@@ -88,21 +90,64 @@ public static String format(InetSocketAddress address) {\n         return format(address.getAddress(), address.getPort());\n     }\n \n-    // note, we don't validate port, because we only allow InetSocketAddress\n-    static String format(InetAddress address, int port) {\n+    /**\n+     * Formats a network address and port for display purposes.\n+     * <p>\n+     * This formats the address with {@link #format(InetAddress)}\n+     * and appends the port number. IPv6 addresses will be bracketed.\n+     * Any host information, if present is ignored.\n+     * <p>\n+     * Example output:\n+     * <ul>\n+     *   <li>IPv4: {@code 127.0.0.1:9300}</li>\n+     *   <li>IPv6: {@code [::1]:9300}</li>\n+     * </ul>\n+     * @param address IPv4 or IPv6 address\n+     * @param port port\n+     * @return formatted string\n+     */\n+    public static String format(InetAddress address, int port) {\n+        return format(address, new PortsRange(String.valueOf(port)));\n+    }\n+\n+    /**\n+     * Formats a network address and port range for display purposes.\n+     * <p>\n+     * This formats the address with {@link #format(InetAddress)}\n+     * and appends the port range in brackets. In case there is only one\n+     * port, the result is the same with {@link #format(InetAddress, int)}.\n+     * <p>\n+     * Example output:\n+     * <ul>\n+     *   <li>IPv4 no port: {@code 127.0.0.1}</li>\n+     *   <li>IPv4 single port: {@code 127.0.0.1:9300}</li>\n+     *   <li>IPv4 multiple ports: {@code 127.0.0.1:[9300-9400]}</li>\n+     *   <li>IPv6 multiple ports: {@code [::1]:[9300-9400]}</li>\n+     * </ul>\n+     * @param address IPv4 or IPv6 address\n+     * @param portsRange range of ports\n+     * @return formatted string\n+     */\n+    public static String format(InetAddress address, PortsRange portsRange) {", "originalCommit": "52705b587c220f6643932ccedcc1f1ab7b3eee3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExODY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51269#discussion_r372118645", "bodyText": "Ok, I pushed another commit with the relative tests.", "author": "mariaral", "createdAt": "2020-01-28T23:34:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgwNDk0Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "57fe01934c582d778c1d5dd43a10fead438f9fa2", "url": "https://github.com/elastic/elasticsearch/commit/57fe01934c582d778c1d5dd43a10fead438f9fa2", "message": "Merge branch 'master' into feature-bind-host", "committedDate": "2020-01-28T13:57:16Z", "type": "commit"}, {"oid": "c01ad2b15054dea44fe6c44f0f12bb25e2e8d362", "url": "https://github.com/elastic/elasticsearch/commit/c01ad2b15054dea44fe6c44f0f12bb25e2e8d362", "message": "Test NetworkAddress.format() with PortsRange", "committedDate": "2020-01-28T22:53:10Z", "type": "commit"}, {"oid": "4405e4ecddac4fce2221e4eeb9ab575b267d0442", "url": "https://github.com/elastic/elasticsearch/commit/4405e4ecddac4fce2221e4eeb9ab575b267d0442", "message": "Merge branch 'master' into feature-bind-host", "committedDate": "2020-02-03T15:14:25Z", "type": "commit"}]}