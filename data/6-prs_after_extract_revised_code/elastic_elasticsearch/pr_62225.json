{"pr_number": 62225, "pr_title": "Take into account sas tokens while metering put object requests on azure", "pr_createdAt": "2020-09-10T13:36:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62225", "timeline": [{"oid": "fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "url": "https://github.com/elastic/elasticsearch/commit/fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208", "committedDate": "2020-09-10T13:52:40Z", "type": "forcePushed"}, {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "url": "https://github.com/elastic/elasticsearch/commit/498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208", "committedDate": "2020-09-10T13:53:24Z", "type": "commit"}, {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "url": "https://github.com/elastic/elasticsearch/commit/498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208", "committedDate": "2020-09-10T13:53:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1OTUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/62225#discussion_r486459530", "bodyText": "This is a somewhat confusing comment IMO :) It nicely explains the diff here actually but doesn't really explain why it's ok to count this kind of request as a PUT.\nWhat does this kind of request without relevant query portion do? Can we add whatever it does as a comment to justify this logic?", "author": "original-brownbear", "createdAt": "2020-09-10T16:02:57Z", "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -117,18 +117,18 @@ public AzureBlobStore(RepositoryMetadata metadata, AzureStorageService service,\n         };\n         this.uploadMetricsCollector = (httpURLConnection -> {\n            assert httpURLConnection.getRequestMethod().equals(\"PUT\");\n-            String queryParams = httpURLConnection.getURL().getQuery();\n-            if (queryParams == null) {\n-                stats.putOperations.incrementAndGet();\n-                return;\n-            }\n+            String queryParams = httpURLConnection.getURL().getQuery() == null ? \"\" : httpURLConnection.getURL().getQuery();\n \n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block\n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list\n             if (queryParams.contains(\"comp=block\") && queryParams.contains(\"blockid=\")) {\n                 stats.putBlockOperations.incrementAndGet();\n             } else if (queryParams.contains(\"comp=blocklist\")) {\n                 stats.putBlockListOperations.incrementAndGet();\n+            } else {\n+                // if a sas token is used, it's possible that the query params contain\n+                // additional parameters unrelated to the upload type", "originalCommit": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f28026940e3f34330c9b8fae61b3f61cdd45b78b", "chunk": "diff --git a/plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java b/plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java\nindex 2988cbc9364..bf518749aa1 100644\n--- a/plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java\n+++ b/plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java\n\n@@ -126,8 +126,9 @@ public class AzureBlobStore implements BlobStore {\n             } else if (queryParams.contains(\"comp=blocklist\")) {\n                 stats.putBlockListOperations.incrementAndGet();\n             } else {\n-                // if a sas token is used, it's possible that the query params contain\n-                // additional parameters unrelated to the upload type\n+                // https://docs.microsoft.com/en-us/rest/api/storageservices/put-blob#uri-parameters\n+                // The only URI parameter allowed for put-blob operation is \"timeout\", but if a sas token is used,\n+                // it's possible that the URI parameters contain additional parameters unrelated to the upload type.\n                 stats.putOperations.incrementAndGet();\n             }\n         });\n"}}, {"oid": "f28026940e3f34330c9b8fae61b3f61cdd45b78b", "url": "https://github.com/elastic/elasticsearch/commit/f28026940e3f34330c9b8fae61b3f61cdd45b78b", "message": "Improve comment", "committedDate": "2020-09-10T16:09:42Z", "type": "commit"}]}