{"pr_number": 54463, "pr_title": "Disallow changing 'enabled' on the root mapper.", "pr_createdAt": "2020-03-30T19:55:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54463", "timeline": [{"oid": "ea9433aa7bf54e425a0ef6fe4d05e22c6d48562c", "url": "https://github.com/elastic/elasticsearch/commit/ea9433aa7bf54e425a0ef6fe4d05e22c6d48562c", "message": "Disallow changing 'enabled' on the root mapper.", "committedDate": "2020-03-30T19:55:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1NjY4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54463#discussion_r400456687", "bodyText": "It's pretty confusing that this error message will contain the singleton type name: \"The [enabled] parameter can't be updated for the object mapping [_doc].\" I think we should address this in a separate, more general change to not pass in the type as the root object mapper's name.", "author": "jtibshirani", "createdAt": "2020-03-30T19:58:09Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/ObjectMapperMergeTests.java", "diffHunk": "@@ -93,7 +93,16 @@ public void testMergeWhenEnablingField() {\n         // WHEN merging mappings\n         // THEN a MapperException is thrown with an excepted message\n         MapperException e = expectThrows(MapperException.class, () -> rootObjectMapper.merge(mergeWith));\n-        assertEquals(\"Can't update attribute for type [type1.disabled.enabled] in index mapping\", e.getMessage());\n+        assertEquals(\"The [enabled] parameter can't be updated for the object mapping [disabled].\", e.getMessage());\n+    }\n+\n+    public void testDisableRootMapper() {\n+        String type = MapperService.SINGLE_MAPPING_NAME;\n+        ObjectMapper firstMapper = createRootObjectMapper(type, true, Collections.emptyMap());\n+        ObjectMapper secondMapper = createRootObjectMapper(type, false, Collections.emptyMap());\n+\n+        MapperException e = expectThrows(MapperException.class, () -> firstMapper.merge(secondMapper));\n+        assertEquals(\"The [enabled] parameter can't be updated for the object mapping [\" + type + \"].\", e.getMessage());", "originalCommit": "ea9433aa7bf54e425a0ef6fe4d05e22c6d48562c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "b1590bce0ae9eb6e7993923097c0feca171f4c07", "url": "https://github.com/elastic/elasticsearch/commit/b1590bce0ae9eb6e7993923097c0feca171f4c07", "message": "Disallow changing 'enabled' on the root mapper.", "committedDate": "2020-04-01T21:23:01Z", "type": "commit"}, {"oid": "16ddeb9ed63d5074423ca245090231f200c24d53", "url": "https://github.com/elastic/elasticsearch/commit/16ddeb9ed63d5074423ca245090231f200c24d53", "message": "Fix SourceOnlySnapshotShardTests.", "committedDate": "2020-04-01T21:23:53Z", "type": "forcePushed"}, {"oid": "df69ea75287591ed7279eb2c677afdf0a25c6935", "url": "https://github.com/elastic/elasticsearch/commit/df69ea75287591ed7279eb2c677afdf0a25c6935", "message": "Fix SourceOnlySnapshotShardTests.", "committedDate": "2020-04-01T21:37:33Z", "type": "commit"}, {"oid": "df69ea75287591ed7279eb2c677afdf0a25c6935", "url": "https://github.com/elastic/elasticsearch/commit/df69ea75287591ed7279eb2c677afdf0a25c6935", "message": "Fix SourceOnlySnapshotShardTests.", "committedDate": "2020-04-01T21:37:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0NDY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54463#discussion_r401944685", "bodyText": "I'll double check with someone from the distributed team that this change is okay.", "author": "jtibshirani", "createdAt": "2020-04-01T22:22:26Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/snapshots/SourceOnlySnapshotShardTests.java", "diffHunk": "@@ -236,7 +235,6 @@ public void testRestoreMinmal() throws IOException {\n         IndexMetadata metadata = runAsSnapshot(threadPool, () -> repository.getSnapshotIndexMetadata(snapshotId, indexId));\n         IndexShard restoredShard = newShard(\n             shardRouting, metadata, null, SourceOnlySnapshotRepository.getEngineFactory(), () -> {}, RetentionLeaseSyncer.EMPTY);\n-        restoredShard.mapperService().merge(shard.indexSettings().getIndexMetadata(), MapperService.MergeReason.MAPPING_RECOVERY);", "originalCommit": "df69ea75287591ed7279eb2c677afdf0a25c6935", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2MzQ0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54463#discussion_r402463447", "bodyText": "@original-brownbear would you be up for taking a look? I saw that you made several changes in this area recently.", "author": "jtibshirani", "createdAt": "2020-04-02T16:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0NDY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1ODE2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54463#discussion_r402558163", "bodyText": "I think this is fine. This line seems unnecessary and makes the test behave less like a real restore as far as I can see anyway (just restoring the meta from the repo in a real restore).\n=> LGTM :)", "author": "original-brownbear", "createdAt": "2020-04-02T19:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0NDY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU3MDUyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54463#discussion_r402570529", "bodyText": "Thanks @original-brownbear ! It also seemed strange to me, that we would add the original mappings as part of restoring a source-only snapshot.", "author": "jtibshirani", "createdAt": "2020-04-02T19:49:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0NDY4NQ=="}], "type": "inlineReview", "revised_code": null}]}