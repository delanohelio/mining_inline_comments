{"pr_number": 57869, "pr_title": "Split internal distribution handling into separate internal plugin", "pr_createdAt": "2020-06-09T09:58:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57869", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU3MTQ0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r437571443", "bodyText": "not used before this PR already", "author": "breskeby", "createdAt": "2020-06-09T16:42:23Z", "path": "buildSrc/src/integTest/java/org/elasticsearch/gradle/DistributionDownloadPluginIT.java", "diffHunk": "@@ -164,14 +164,6 @@ private void checkService(\n         }\n     }\n \n-    private void assertFileDistro(String version, String type, String platform, String flavor, Boolean bundledJdk, String... sysProps)", "originalCommit": "b6f2ee0aac5548183f22802016721a17e2b7a8ad", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9a0279c9cd891085339cb61279553e805780108e", "chunk": "diff --git a/buildSrc/src/integTest/java/org/elasticsearch/gradle/DistributionDownloadPluginIT.java b/buildSrc/src/integTest/java/org/elasticsearch/gradle/DistributionDownloadPluginIT.java\nindex b3ae5a1ab01..69da7e519d3 100644\n--- a/buildSrc/src/integTest/java/org/elasticsearch/gradle/DistributionDownloadPluginIT.java\n+++ b/buildSrc/src/integTest/java/org/elasticsearch/gradle/DistributionDownloadPluginIT.java\n\n@@ -164,6 +147,14 @@ public class DistributionDownloadPluginIT extends GradleIntegrationTestCase {\n         }\n     }\n \n+    private void assertFileDistro(String version, String type, String platform, String flavor, Boolean bundledJdk, String... sysProps)\n+        throws IOException {\n+        List<String> finalSysProps = new ArrayList<>();\n+        addDistroSysProps(finalSysProps, version, type, platform, flavor, bundledJdk);\n+        finalSysProps.addAll(Arrays.asList(sysProps));\n+        runBuild(\":subproj:assertDistroFile\", finalSysProps.toArray(new String[0]));\n+    }\n+\n     private void assertExtractedDistro(String version, String type, String platform, String flavor, Boolean bundledJdk, String... sysProps)\n         throws IOException {\n         List<String> finalSysProps = new ArrayList<>();\n"}}, {"oid": "e00d2fdf0d01322cb9c8511c17101f42f2c3c07b", "url": "https://github.com/elastic/elasticsearch/commit/e00d2fdf0d01322cb9c8511c17101f42f2c3c07b", "message": "Fix distribution download unit tests", "committedDate": "2020-06-09T16:48:12Z", "type": "forcePushed"}, {"oid": "9a0279c9cd891085339cb61279553e805780108e", "url": "https://github.com/elastic/elasticsearch/commit/9a0279c9cd891085339cb61279553e805780108e", "message": "Split internal distribution logic into separate plugin", "committedDate": "2020-07-15T07:52:22Z", "type": "forcePushed"}, {"oid": "c8b77ef1e7007fb00a055619a3ee9f1d22022037", "url": "https://github.com/elastic/elasticsearch/commit/c8b77ef1e7007fb00a055619a3ee9f1d22022037", "message": "Assert internal plugin is only appied on internal build", "committedDate": "2020-07-16T06:20:36Z", "type": "forcePushed"}, {"oid": "b378d1f45d97a822e7c406dd4502be8733b68589", "url": "https://github.com/elastic/elasticsearch/commit/b378d1f45d97a822e7c406dd4502be8733b68589", "message": "Polishing\n\n- extract common abstract test specification for plugin func tests\n- update javadocs", "committedDate": "2020-07-17T08:38:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r456354026", "bodyText": "We kicked the can of differentiating between internal and external builds further to here for now.\nIs this plugin even considered to be used externally. Otherwise we can remove this differentiation here and just apply the internal plugin", "author": "breskeby", "createdAt": "2020-07-17T10:16:58Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -89,7 +90,11 @@\n     @Override\n     public void apply(Project project) {\n         project.getRootProject().getPluginManager().apply(DockerSupportPlugin.class);\n-        project.getPluginManager().apply(DistributionDownloadPlugin.class);\n+        if (BuildParams.isInternal()) {", "originalCommit": "b378d1f45d97a822e7c406dd4502be8733b68589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU1MjMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r456552306", "bodyText": "I believe it is since it's needed for integration testing plugin projects. It's applied by the TestClusters plugin which in turn is used by PluginBuildPlugin which is the primary \"external\" plugin folks use.", "author": "mark-vieira", "createdAt": "2020-07-17T16:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY2MTYwMg==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r457661602", "bodyText": "DistroTestPlugin is only used in :qa:os, I don't see where it is part of PluginBuildPlugin or TestClusters. I don't think we need to support running distro tests for plugins, since they are about testing the distribution's platform specific behavior, not any individual plugin. Thus I think we can assume internal, and fail otherwise.", "author": "rjernst", "createdAt": "2020-07-20T20:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NzkzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r457687935", "bodyText": "I was referring to DistributionDownloadPlugin which is the plugin that's affected by this line change, not DistroTestPlugin, which is simply utilizing the download plugin.", "author": "mark-vieira", "createdAt": "2020-07-20T20:58:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcyMTk0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r457721949", "bodyText": "I thought the original question was whether we needed to have internal/external behavior here, in DistroTestPlugin?", "author": "rjernst", "createdAt": "2020-07-20T22:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMDE5MA==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r457730190", "bodyText": "Oh. In that case, no. But in DistroDownloadPlugin, yes. Sorry, I got confused.", "author": "mark-vieira", "createdAt": "2020-07-20T22:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNjY1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r458026651", "bodyText": "thank you guys for clarification.", "author": "breskeby", "createdAt": "2020-07-21T11:29:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDAyNg=="}], "type": "inlineReview", "revised_code": {"commit": "65ec3870558c9f021a39cfbeeaedbee137a5f63e", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java\nindex 0bf6d278c5c..239b5a51ff5 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java\n\n@@ -90,11 +90,7 @@ public class DistroTestPlugin implements Plugin<Project> {\n     @Override\n     public void apply(Project project) {\n         project.getRootProject().getPluginManager().apply(DockerSupportPlugin.class);\n-        if (BuildParams.isInternal()) {\n-            project.getPlugins().apply(InternalDistributionDownloadPlugin.class);\n-        } else {\n-            project.getPlugins().apply(DistributionDownloadPlugin.class);\n-        }\n+        project.getPlugins().apply(InternalDistributionDownloadPlugin.class);\n         project.getPluginManager().apply(\"elasticsearch.build\");\n \n         Provider<DockerSupportService> dockerSupport = GradleUtils.getBuildService(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjM1NDM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r456354359", "bodyText": "We kicked the can of differentiating between internal and external builds further to here for now. We might want to apply similar internal / external plugin distinction later for that plugin too", "author": "breskeby", "createdAt": "2020-07-17T10:17:44Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java", "diffHunk": "@@ -49,7 +52,13 @@\n \n     @Override\n     public void apply(Project project) {\n-        project.getPlugins().apply(DistributionDownloadPlugin.class);\n+        project.getRootProject().getPluginManager().apply(GlobalBuildInfoPlugin.class);\n+        if (BuildParams.isInternal()) {", "originalCommit": "b378d1f45d97a822e7c406dd4502be8733b68589", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b26ba2d58d44d7db1d61591d5afb41979d92b2a5", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java\nindex 8cf6b3adc72..48c436c42e0 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClustersPlugin.java\n\n@@ -52,13 +49,7 @@ public class TestClustersPlugin implements Plugin<Project> {\n \n     @Override\n     public void apply(Project project) {\n-        project.getRootProject().getPluginManager().apply(GlobalBuildInfoPlugin.class);\n-        if (BuildParams.isInternal()) {\n-            project.getPlugins().apply(InternalDistributionDownloadPlugin.class);\n-        } else {\n-            project.getPlugins().apply(DistributionDownloadPlugin.class);\n-        }\n-\n+        project.getPlugins().apply(DistributionDownloadPlugin.class);\n         project.getRootProject().getPluginManager().apply(ReaperPlugin.class);\n \n         ReaperService reaper = project.getRootProject().getExtensions().getByType(ReaperService.class);\n"}}, {"oid": "65ec3870558c9f021a39cfbeeaedbee137a5f63e", "url": "https://github.com/elastic/elasticsearch/commit/65ec3870558c9f021a39cfbeeaedbee137a5f63e", "message": "DistroTestPlugin is used internal only", "committedDate": "2020-07-21T11:51:43Z", "type": "forcePushed"}, {"oid": "b26ba2d58d44d7db1d61591d5afb41979d92b2a5", "url": "https://github.com/elastic/elasticsearch/commit/b26ba2d58d44d7db1d61591d5afb41979d92b2a5", "message": "Split internal distribution logic into separate plugin", "committedDate": "2020-07-22T07:18:28Z", "type": "commit"}, {"oid": "066c68cbe09f8ea11507c9f154339e99e46b8da7", "url": "https://github.com/elastic/elasticsearch/commit/066c68cbe09f8ea11507c9f154339e99e46b8da7", "message": "Remove moved func test from DistributionDownloadPluginIT", "committedDate": "2020-07-22T07:18:28Z", "type": "commit"}, {"oid": "78b77ae82ef40adc8b1b2f046d35990a76634f11", "url": "https://github.com/elastic/elasticsearch/commit/78b77ae82ef40adc8b1b2f046d35990a76634f11", "message": "Ensure ordering is reproducible for registered distribution resolutions", "committedDate": "2020-07-22T07:18:28Z", "type": "commit"}, {"oid": "139b9c47981872069720b3fc974ae5c356bc039f", "url": "https://github.com/elastic/elasticsearch/commit/139b9c47981872069720b3fc974ae5c356bc039f", "message": "Fix ordering of dist resolution regisrations", "committedDate": "2020-07-22T07:18:29Z", "type": "commit"}, {"oid": "d53e709f27982d71af32ebb6c1d31f5ead68db2b", "url": "https://github.com/elastic/elasticsearch/commit/d53e709f27982d71af32ebb6c1d31f5ead68db2b", "message": "Some cleanup", "committedDate": "2020-07-22T07:18:29Z", "type": "commit"}, {"oid": "54c5417e6b6183d1db709b181c0e5c07bd0469c5", "url": "https://github.com/elastic/elasticsearch/commit/54c5417e6b6183d1db709b181c0e5c07bd0469c5", "message": "Assert internal plugin is only appied on internal build", "committedDate": "2020-07-22T07:18:29Z", "type": "commit"}, {"oid": "8aa58bcf98d81ba56fc3218286175b2f77d702e1", "url": "https://github.com/elastic/elasticsearch/commit/8aa58bcf98d81ba56fc3218286175b2f77d702e1", "message": "Polishing\n\n- extract common abstract test specification for plugin func tests\n- update javadocs", "committedDate": "2020-07-22T07:18:29Z", "type": "commit"}, {"oid": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "url": "https://github.com/elastic/elasticsearch/commit/aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "message": "DistroTestPlugin is used internal only", "committedDate": "2020-07-22T07:18:30Z", "type": "commit"}, {"oid": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "url": "https://github.com/elastic/elasticsearch/commit/aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "message": "DistroTestPlugin is used internal only", "committedDate": "2020-07-22T07:18:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MjQ4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r459772483", "bodyText": "This mixed snake-case/kebab-case naming is making my brain hurt. I think I originally made an objection to using snake-case when this plugin was introduced but didn't make much of a fuss. Alternatively could we make the resolutions configuration a config item under the elasticsearch_distributions extension rather than have two separate extensions?", "author": "mark-vieira", "createdAt": "2020-07-23T22:56:09Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -45,71 +41,83 @@\n import org.gradle.authentication.http.HttpHeaderAuthentication;\n \n import java.io.File;\n-import java.util.HashMap;\n+import java.util.Comparator;\n import java.util.Locale;\n-import java.util.Map;\n import java.util.concurrent.Callable;\n import java.util.function.Supplier;\n \n+import static org.elasticsearch.gradle.util.GradleUtils.projectDependency;\n import static org.elasticsearch.gradle.util.Util.capitalize;\n \n /**\n  * A plugin to manage getting and extracting distributions of Elasticsearch.\n  *\n- * The source of the distribution could be from a local snapshot, a locally built\n- * bwc snapshot, or the Elastic downloads service.\n+ * The plugin provides hooks to register custom distribution resolutions.\n+ * This plugin resolves distributions from the Elastic downloads service if\n+ * no registered resolution strategy can resolve to a distribution.\n  */\n public class DistributionDownloadPlugin implements Plugin<Project> {\n \n+    static final String RESOLUTION_CONTAINER_NAME = \"elasticsearch_distributions-resolutions\";", "originalCommit": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NDYwNw==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r459774607", "bodyText": "Or perhaps it doesn't really matter since we don't really expect folks to configure this in build scripts?", "author": "mark-vieira", "createdAt": "2020-07-23T23:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MjQ4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NzUyNw==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r460677527", "bodyText": "I fixed the name to not be mixed. Working it into the elasticsearch_distributions extensions is more work as this is just a plain named container. We don't even use the name in the plugins and I don't expect anyone to configure this in a script.", "author": "breskeby", "createdAt": "2020-07-27T06:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MjQ4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d082e21ba511a5b6c8f2282d1d238f3ddb719818", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java\nindex e075447d656..b3e1a07bdf3 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java\n\n@@ -58,7 +58,7 @@ import static org.elasticsearch.gradle.util.Util.capitalize;\n  */\n public class DistributionDownloadPlugin implements Plugin<Project> {\n \n-    static final String RESOLUTION_CONTAINER_NAME = \"elasticsearch_distributions-resolutions\";\n+    static final String RESOLUTION_CONTAINER_NAME = \"elasticsearch_distributions_resolutions\";\n     private static final String CONTAINER_NAME = \"elasticsearch_distributions\";\n     private static final String FAKE_IVY_GROUP = \"elasticsearch-distribution\";\n     private static final String FAKE_SNAPSHOT_IVY_GROUP = \"elasticsearch-distribution-snapshot\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MzAyMg==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r459773022", "bodyText": "Should this be \"bwc\"?", "author": "mark-vieira", "createdAt": "2020-07-23T22:57:48Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.Architecture;\n+import org.elasticsearch.gradle.BwcVersions;\n+import org.elasticsearch.gradle.DistributionDownloadPlugin;\n+import org.elasticsearch.gradle.DistributionResolution;\n+import org.elasticsearch.gradle.ElasticsearchDistribution;\n+import org.elasticsearch.gradle.Version;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.info.GlobalBuildInfoPlugin;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+\n+import static org.elasticsearch.gradle.util.GradleUtils.projectDependency;\n+\n+/**\n+ * An internal elasticsearch build plugin that registers additional\n+ * distribution resolution strategies to the 'elasticsearch.download-distribution' plugin\n+ * to resolve distributions from a local snapshot or a locally built bwc snapshot.\n+ */\n+public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n+\n+    private BwcVersions bwcVersions = null;\n+\n+    @Override\n+    public void apply(Project project) {\n+        // this is needed for isInternal\n+        project.getRootProject().getPluginManager().apply(GlobalBuildInfoPlugin.class);\n+        if (!BuildParams.isInternal()) {\n+            throw new GradleException(\n+                \"Plugin 'elasticsearch.internal-distribution-download' is not supported. \"\n+                    + \"Use 'elasticsearch.distribution-download' plugin instead.\"\n+            );\n+        }\n+        project.getPluginManager().apply(DistributionDownloadPlugin.class);\n+        this.bwcVersions = BuildParams.getBwcVersions();\n+        registerInternalDistributionResolutions(DistributionDownloadPlugin.getRegistrationsContainer(project));\n+    }\n+\n+    /**\n+     * Registers internal distribution resolutions.\n+     *\n+     * Elasticsearch distributions are resolved as project dependencies either representing\n+     * the current version pointing to a project either under `:distribution:archives` or :distribution:packages`.\n+     *\n+     * BWC versions are resolved as project to projects under `:distribution:bwc`.\n+     * */\n+    private void registerInternalDistributionResolutions(NamedDomainObjectContainer<DistributionResolution> resolutions) {\n+\n+        resolutions.register(\"localBuild\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+            if (VersionProperties.getElasticsearch().equals(distribution.getVersion())) {\n+                // non-external project, so depend on local build\n+                return projectDependency(project, distributionProjectPath(distribution), \"default\");\n+            }\n+            return null;\n+        }));\n+\n+        resolutions.register(\"bwb\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {", "originalCommit": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NjkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r460676915", "bodyText": "fixed", "author": "breskeby", "createdAt": "2020-07-27T06:41:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MzAyMg=="}], "type": "inlineReview", "revised_code": {"commit": "d082e21ba511a5b6c8f2282d1d238f3ddb719818", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\nindex 27e109f92d8..9399f1f062c 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n\n@@ -77,10 +77,17 @@ public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n             return null;\n         }));\n \n-        resolutions.register(\"bwb\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+        resolutions.register(\"bwc\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n             BwcVersions.UnreleasedVersionInfo unreleasedInfo = bwcVersions.unreleasedInfo(Version.fromString(distribution.getVersion()));\n             if (unreleasedInfo != null) {\n-                assert distribution.getBundledJdk();\n+                if (!distribution.getBundledJdk()) {\n+                    throw new GradleException(\n+                        \"Configuring a snapshot bwc distribution ('\"\n+                            + distribution.getName()\n+                            + \"') \"\n+                            + \"without a bundled JDK is not supported.\"\n+                    );\n+                }\n                 return projectDependency(project, unreleasedInfo.gradleProjectPath, distributionProjectName(distribution));\n             }\n             return null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MzgzOA==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r459773838", "bodyText": "Should we add a message here so that if folks incorrectly configure a snapshot bwc distribution w/o bundled JDK that we return an error as such?", "author": "mark-vieira", "createdAt": "2020-07-23T23:00:15Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.Architecture;\n+import org.elasticsearch.gradle.BwcVersions;\n+import org.elasticsearch.gradle.DistributionDownloadPlugin;\n+import org.elasticsearch.gradle.DistributionResolution;\n+import org.elasticsearch.gradle.ElasticsearchDistribution;\n+import org.elasticsearch.gradle.Version;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.info.GlobalBuildInfoPlugin;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+\n+import static org.elasticsearch.gradle.util.GradleUtils.projectDependency;\n+\n+/**\n+ * An internal elasticsearch build plugin that registers additional\n+ * distribution resolution strategies to the 'elasticsearch.download-distribution' plugin\n+ * to resolve distributions from a local snapshot or a locally built bwc snapshot.\n+ */\n+public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n+\n+    private BwcVersions bwcVersions = null;\n+\n+    @Override\n+    public void apply(Project project) {\n+        // this is needed for isInternal\n+        project.getRootProject().getPluginManager().apply(GlobalBuildInfoPlugin.class);\n+        if (!BuildParams.isInternal()) {\n+            throw new GradleException(\n+                \"Plugin 'elasticsearch.internal-distribution-download' is not supported. \"\n+                    + \"Use 'elasticsearch.distribution-download' plugin instead.\"\n+            );\n+        }\n+        project.getPluginManager().apply(DistributionDownloadPlugin.class);\n+        this.bwcVersions = BuildParams.getBwcVersions();\n+        registerInternalDistributionResolutions(DistributionDownloadPlugin.getRegistrationsContainer(project));\n+    }\n+\n+    /**\n+     * Registers internal distribution resolutions.\n+     *\n+     * Elasticsearch distributions are resolved as project dependencies either representing\n+     * the current version pointing to a project either under `:distribution:archives` or :distribution:packages`.\n+     *\n+     * BWC versions are resolved as project to projects under `:distribution:bwc`.\n+     * */\n+    private void registerInternalDistributionResolutions(NamedDomainObjectContainer<DistributionResolution> resolutions) {\n+\n+        resolutions.register(\"localBuild\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+            if (VersionProperties.getElasticsearch().equals(distribution.getVersion())) {\n+                // non-external project, so depend on local build\n+                return projectDependency(project, distributionProjectPath(distribution), \"default\");\n+            }\n+            return null;\n+        }));\n+\n+        resolutions.register(\"bwb\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+            BwcVersions.UnreleasedVersionInfo unreleasedInfo = bwcVersions.unreleasedInfo(Version.fromString(distribution.getVersion()));\n+            if (unreleasedInfo != null) {\n+                assert distribution.getBundledJdk();", "originalCommit": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NzYzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r460677639", "bodyText": "I changed this to throw a proper GradleException with an error message.", "author": "breskeby", "createdAt": "2020-07-27T06:43:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3MzgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "d082e21ba511a5b6c8f2282d1d238f3ddb719818", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\nindex 27e109f92d8..9399f1f062c 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n\n@@ -77,10 +77,17 @@ public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n             return null;\n         }));\n \n-        resolutions.register(\"bwb\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+        resolutions.register(\"bwc\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n             BwcVersions.UnreleasedVersionInfo unreleasedInfo = bwcVersions.unreleasedInfo(Version.fromString(distribution.getVersion()));\n             if (unreleasedInfo != null) {\n-                assert distribution.getBundledJdk();\n+                if (!distribution.getBundledJdk()) {\n+                    throw new GradleException(\n+                        \"Configuring a snapshot bwc distribution ('\"\n+                            + distribution.getName()\n+                            + \"') \"\n+                            + \"without a bundled JDK is not supported.\"\n+                    );\n+                }\n                 return projectDependency(project, unreleasedInfo.gradleProjectPath, distributionProjectName(distribution));\n             }\n             return null;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NTA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57869#discussion_r459775079", "bodyText": "Nice. At least for now until we physically separate this code such that we don't publish internal stuff this seems like a good pattern to ensure that folks don't \"accidentally\" leverage internal plugins.", "author": "mark-vieira", "createdAt": "2020-07-23T23:04:15Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.Architecture;\n+import org.elasticsearch.gradle.BwcVersions;\n+import org.elasticsearch.gradle.DistributionDownloadPlugin;\n+import org.elasticsearch.gradle.DistributionResolution;\n+import org.elasticsearch.gradle.ElasticsearchDistribution;\n+import org.elasticsearch.gradle.Version;\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.info.GlobalBuildInfoPlugin;\n+import org.gradle.api.GradleException;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+\n+import static org.elasticsearch.gradle.util.GradleUtils.projectDependency;\n+\n+/**\n+ * An internal elasticsearch build plugin that registers additional\n+ * distribution resolution strategies to the 'elasticsearch.download-distribution' plugin\n+ * to resolve distributions from a local snapshot or a locally built bwc snapshot.\n+ */\n+public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n+\n+    private BwcVersions bwcVersions = null;\n+\n+    @Override\n+    public void apply(Project project) {\n+        // this is needed for isInternal\n+        project.getRootProject().getPluginManager().apply(GlobalBuildInfoPlugin.class);\n+        if (!BuildParams.isInternal()) {\n+            throw new GradleException(", "originalCommit": "aeb25536f48e35502d45ec9dc85dcbd66e2774d7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d082e21ba511a5b6c8f2282d1d238f3ddb719818", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\nindex 27e109f92d8..9399f1f062c 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionDownloadPlugin.java\n\n@@ -77,10 +77,17 @@ public class InternalDistributionDownloadPlugin implements Plugin<Project> {\n             return null;\n         }));\n \n-        resolutions.register(\"bwb\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n+        resolutions.register(\"bwc\", distributionResolution -> distributionResolution.setResolver((project, distribution) -> {\n             BwcVersions.UnreleasedVersionInfo unreleasedInfo = bwcVersions.unreleasedInfo(Version.fromString(distribution.getVersion()));\n             if (unreleasedInfo != null) {\n-                assert distribution.getBundledJdk();\n+                if (!distribution.getBundledJdk()) {\n+                    throw new GradleException(\n+                        \"Configuring a snapshot bwc distribution ('\"\n+                            + distribution.getName()\n+                            + \"') \"\n+                            + \"without a bundled JDK is not supported.\"\n+                    );\n+                }\n                 return projectDependency(project, unreleasedInfo.gradleProjectPath, distributionProjectName(distribution));\n             }\n             return null;\n"}}, {"oid": "d082e21ba511a5b6c8f2282d1d238f3ddb719818", "url": "https://github.com/elastic/elasticsearch/commit/d082e21ba511a5b6c8f2282d1d238f3ddb719818", "message": "Apply review feedback\n\n- rename resolve strategy container\n- fix naming of bwc resolving strategy\n- provide proper failure if unexpected non jdk bundled bwc version is requested", "committedDate": "2020-07-27T06:39:51Z", "type": "commit"}]}