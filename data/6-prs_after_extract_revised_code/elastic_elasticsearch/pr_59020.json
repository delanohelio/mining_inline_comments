{"pr_number": 59020, "pr_title": "Add Support in geo_match enrichment policy for any type of geometry", "pr_createdAt": "2020-07-03T14:31:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59020", "timeline": [{"oid": "7e5c8ea7e28f36e7798785b6fda22f0ee414343d", "url": "https://github.com/elastic/elasticsearch/commit/7e5c8ea7e28f36e7798785b6fda22f0ee414343d", "message": "make geomatch works on generic shapes", "committedDate": "2020-07-03T14:25:04Z", "type": "commit"}, {"oid": "796d27b45238d7f1007df4375b8967c5b1dff60e", "url": "https://github.com/elastic/elasticsearch/commit/796d27b45238d7f1007df4375b8967c5b1dff60e", "message": "unused imports", "committedDate": "2020-07-03T14:32:39Z", "type": "commit"}, {"oid": "797932fac6df253ab13a743d501147e087d0ea78", "url": "https://github.com/elastic/elasticsearch/commit/797932fac6df253ab13a743d501147e087d0ea78", "message": "potlessJavaCheck", "committedDate": "2020-07-03T14:51:54Z", "type": "commit"}, {"oid": "979f0b18aed3a1680aad112045858ecceb96ba89", "url": "https://github.com/elastic/elasticsearch/commit/979f0b18aed3a1680aad112045858ecceb96ba89", "message": "polygon / line decomposition already implemented in the query builder", "committedDate": "2020-07-04T15:33:57Z", "type": "commit"}, {"oid": "aa1a12e5e10242e94393a970004ee563d57ea555", "url": "https://github.com/elastic/elasticsearch/commit/aa1a12e5e10242e94393a970004ee563d57ea555", "message": "Adds support for orientation", "committedDate": "2020-07-06T07:29:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ4Njc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/59020#discussion_r450486758", "bodyText": "should we add a non-point geometry here as well?", "author": "talevy", "createdAt": "2020-07-06T21:22:18Z", "path": "server/src/test/java/org/elasticsearch/common/geo/GeometryParserTests.java", "diffHunk": "@@ -173,4 +178,24 @@ public void testUnsupportedValueParsing() throws Exception {\n             assertEquals(\"shape must be an object consisting of type and coordinates\", ex.getMessage());\n         }\n     }\n+\n+    public void testBasics() {\n+        GeometryParser parser = new GeometryParser(true, randomBoolean(), randomBoolean());\n+        Point expectedPoint = new Point(-122.084110, 37.386637);\n+        testBasics(parser, Map.of(\"lat\", 37.386637, \"lon\", -122.084110), expectedPoint);\n+        testBasics(parser, \"37.386637, -122.084110\", expectedPoint);\n+        testBasics(parser, \"POINT (-122.084110 37.386637)\", expectedPoint);\n+        testBasics(parser, Map.of(\"type\", \"Point\", \"coordinates\", List.of(-122.084110, 37.386637)), expectedPoint);", "originalCommit": "aa1a12e5e10242e94393a970004ee563d57ea555", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7fcc7cfb789b0e12c6db6de1149c0d0633ce6a71", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/common/geo/GeometryParserTests.java b/server/src/test/java/org/elasticsearch/common/geo/GeometryParserTests.java\nindex cc83372da55..c3919d39d20 100644\n--- a/server/src/test/java/org/elasticsearch/common/geo/GeometryParserTests.java\n+++ b/server/src/test/java/org/elasticsearch/common/geo/GeometryParserTests.java\n\n@@ -187,11 +187,30 @@ public class GeometryParserTests extends ESTestCase {\n         testBasics(parser, \"POINT (-122.084110 37.386637)\", expectedPoint);\n         testBasics(parser, Map.of(\"type\", \"Point\", \"coordinates\", List.of(-122.084110, 37.386637)), expectedPoint);\n         testBasics(parser, List.of(-122.084110, 37.386637), expectedPoint);\n+        Line expectedLine = new Line(new double[] {0, 1}, new double[] {0, 1});\n+        testBasics(parser, \"LINESTRING(0 0, 1 1)\", expectedLine);\n+        testBasics(parser, Map.of(\"type\", \"LineString\", \"coordinates\", List.of(List.of(0, 0), List.of(1, 1))), expectedLine);\n+\n+        Polygon expectedPolygon = new Polygon(new LinearRing(new double[] {0, 1, 1, 0, 0}, new double[] {0, 0, 1, 1, 0}));\n+        testBasics(parser, \"POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))\", expectedPolygon);\n+        testBasics(parser, Map.of(\"type\", \"Polygon\", \"coordinates\",\n+            List.of(\n+                List.of(List.of(0, 0), List.of(1, 0), List.of(1, 1), List.of(0, 1), List.of(0, 0)))\n+            ),\n+            expectedPolygon);\n+\n         testBasics(parser,\n-            List.of(List.of(-122.084110, 37.386637), \"37.386637, -122.084110\", \"POINT (-122.084110 37.386637)\"),\n-            new GeometryCollection<>(List.of(expectedPoint, expectedPoint, expectedPoint))\n+            List.of(\n+                List.of(-122.084110, 37.386637),\n+                \"37.386637, -122.084110\",\n+                \"POINT (-122.084110 37.386637)\",\n+                Map.of(\"type\", \"Point\", \"coordinates\", List.of(-122.084110, 37.386637)),\n+                Map.of(\"type\", \"LineString\", \"coordinates\", List.of(List.of(0, 0), List.of(1, 1))),\n+                \"POLYGON((0 0, 1 0, 1 1, 0 1, 0 0))\"\n+            ),\n+            new GeometryCollection<>(List.of(expectedPoint, expectedPoint, expectedPoint, expectedPoint, expectedLine, expectedPolygon))\n         );\n-        expectThrows(ElasticsearchParseException.class, () -> testBasics(parser, \"not a point\", null));\n+        expectThrows(ElasticsearchParseException.class, () -> testBasics(parser, \"not a geometry\", null));\n     }\n \n     private void testBasics(GeometryParser parser, Object value, Geometry expected) {\n"}}, {"oid": "7fcc7cfb789b0e12c6db6de1149c0d0633ce6a71", "url": "https://github.com/elastic/elasticsearch/commit/7fcc7cfb789b0e12c6db6de1149c0d0633ce6a71", "message": "Add test for more complex geometries", "committedDate": "2020-07-07T09:38:58Z", "type": "commit"}, {"oid": "8b851ad868f045175567b342bdcac3b79d275d61", "url": "https://github.com/elastic/elasticsearch/commit/8b851ad868f045175567b342bdcac3b79d275d61", "message": "Merge branch 'master' into geoenrich", "committedDate": "2020-07-07T11:54:18Z", "type": "commit"}, {"oid": "3b80440d8e62904145e683a43bb20414d9f503dd", "url": "https://github.com/elastic/elasticsearch/commit/3b80440d8e62904145e683a43bb20414d9f503dd", "message": "more test", "committedDate": "2020-07-07T12:13:14Z", "type": "commit"}]}