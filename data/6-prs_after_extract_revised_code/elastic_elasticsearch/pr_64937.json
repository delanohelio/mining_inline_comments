{"pr_number": 64937, "pr_title": "[ML] fix custom feature processor extraction bugs around boolean fields and custom one_hot feature output order", "pr_createdAt": "2020-11-11T15:25:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64937", "timeline": [{"oid": "fab97eeb66a0ea69119233959bb8e6e90374e7a5", "url": "https://github.com/elastic/elasticsearch/commit/fab97eeb66a0ea69119233959bb8e6e90374e7a5", "message": "[ML] fix custom featur processor extraction bugs around boolean fields and field order", "committedDate": "2020-11-11T15:22:44Z", "type": "commit"}, {"oid": "bb6f94fb4cca99734a9e9aab670348838bbda761", "url": "https://github.com/elastic/elasticsearch/commit/bb6f94fb4cca99734a9e9aab670348838bbda761", "message": "Merge branch 'master' into bugfix/ml-analytics-processed-field-boolean-handling", "committedDate": "2020-11-11T15:42:06Z", "type": "commit"}, {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b", "url": "https://github.com/elastic/elasticsearch/commit/d830809c7b658eaada3550f18a8b75cf3e3b366b", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/ml-analytics-processed-field-boolean-handling", "committedDate": "2020-11-11T21:26:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1MjU0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952547", "bodyText": "Ditto", "author": "dimitris-athanasiou", "createdAt": "2020-11-12T09:16:37Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());\n     }\n \n     public List<String> getOutputFieldNames() {\n-        return preProcessor.outputFields();\n+        return preProcessor.outputFields().stream().sorted().collect(Collectors.toList());", "originalCommit": "d830809c7b658eaada3550f18a8b75cf3e3b366b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8f9846a6fd9680d9d03215ff321447d9b96586e2", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\nindex fdecdfb1216..3102a3e14b5 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n\n@@ -27,11 +26,11 @@ public class ProcessedField {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());\n+        return preProcessor.inputFields();\n     }\n \n     public List<String> getOutputFieldNames() {\n-        return preProcessor.outputFields().stream().sorted().collect(Collectors.toList());\n+        return preProcessor.outputFields();\n     }\n \n     public Set<String> getOutputFieldType(String outputField) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1Mjk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952940", "bodyText": "This is called for every document we load into the process. I suggest we sort once when we store them in the PreProcessor.", "author": "dimitris-athanasiou", "createdAt": "2020-11-12T09:17:11Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());", "originalCommit": "d830809c7b658eaada3550f18a8b75cf3e3b366b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8f9846a6fd9680d9d03215ff321447d9b96586e2", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\nindex fdecdfb1216..3102a3e14b5 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n\n@@ -27,11 +26,11 @@ public class ProcessedField {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());\n+        return preProcessor.inputFields();\n     }\n \n     public List<String> getOutputFieldNames() {\n-        return preProcessor.outputFields().stream().sorted().collect(Collectors.toList());\n+        return preProcessor.outputFields();\n     }\n \n     public Set<String> getOutputFieldType(String outputField) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg==", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521954732", "bodyText": "If the preprocessor already returns the output fields sorted, we shouldn't need to sort here.\nNow unfortunately there is not sorted list interface. But as we're dealing with fields, if we want to enforce this to the PreProcessor interface we should switch to SortedSet.", "author": "dimitris-athanasiou", "createdAt": "2020-11-12T09:20:07Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -47,12 +51,12 @@ public ProcessedField(PreProcessor processor) {\n                 continue;\n             }\n             final Object value = values[0];\n-            if (values.length == 1 && (value instanceof String || value instanceof Number)) {\n+            if (values.length == 1 && (isValidValue(value))) {\n                 inputs.put(field, value);\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();", "originalCommit": "d830809c7b658eaada3550f18a8b75cf3e3b366b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1MjYzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r522052633", "bodyText": "The only one that causes this problem is the Onehot processor, I will see if I can figure out a way for the order to always be the same. The order will always have to be the same after serializing from the wire and on xcontent.", "author": "benwtrent", "createdAt": "2020-11-12T11:58:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1NjcxMg==", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r522056712", "bodyText": "Yeah, I don't know what I was thinking \ud83e\udd26\nI will fix this...The preprocessor output should be consistent", "author": "benwtrent", "createdAt": "2020-11-12T12:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg=="}], "type": "inlineReview", "revised_code": {"commit": "8f9846a6fd9680d9d03215ff321447d9b96586e2", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\nindex fdecdfb1216..3102a3e14b5 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java\n\n@@ -56,7 +55,7 @@ public class ProcessedField {\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n     }\n \n     public String getProcessorName() {\n"}}, {"oid": "8f9846a6fd9680d9d03215ff321447d9b96586e2", "url": "https://github.com/elastic/elasticsearch/commit/8f9846a6fd9680d9d03215ff321447d9b96586e2", "message": "making and testing preprocessor outputs to be consistent", "committedDate": "2020-11-12T12:33:12Z", "type": "commit"}, {"oid": "c87a95ebd6d1664cba33ddfa2299e4ed3889034c", "url": "https://github.com/elastic/elasticsearch/commit/c87a95ebd6d1664cba33ddfa2299e4ed3889034c", "message": "validating and fixing tests", "committedDate": "2020-11-12T13:24:45Z", "type": "commit"}, {"oid": "e22e13baa50849565ec152e3362fce3252f63628", "url": "https://github.com/elastic/elasticsearch/commit/e22e13baa50849565ec152e3362fce3252f63628", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/ml-analytics-processed-field-boolean-handling", "committedDate": "2020-11-12T13:25:11Z", "type": "commit"}]}