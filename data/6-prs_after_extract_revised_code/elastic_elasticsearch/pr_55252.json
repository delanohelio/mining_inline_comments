{"pr_number": 55252, "pr_title": "Ensure error handler is called during SLM retention callback failure", "pr_createdAt": "2020-04-15T18:19:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55252", "timeline": [{"oid": "8587226947fc6bb8161aad55cb379773c7361f68", "url": "https://github.com/elastic/elasticsearch/commit/8587226947fc6bb8161aad55cb379773c7361f68", "message": "Ensure error handler is called during SLM retention callback failure\n\nWhen retrieving the snapshots for a set of repos or deleting a single snapshot, it's possible for\nthe body of the `ActionListener`'s `onResponse` method to throw an Exception. In this case, the\n`errHandler` passed in may not be executed, resulting in the `running` boolean not being reset back\nto false.\n\nThis commit uses `ActionListener.wrap(...)` instead of creating a new ActionListener, which ensures\nthat if the `onResponse` fails in any way, the `onFailure` handler is still called.\n\nResolves #55217", "committedDate": "2020-04-15T18:11:17Z", "type": "commit"}, {"oid": "f8e19cedb97df2b05d4fbb6a3e262ec8239d2de3", "url": "https://github.com/elastic/elasticsearch/commit/f8e19cedb97df2b05d4fbb6a3e262ec8239d2de3", "message": "Merge branch 'master' into slm-ensure-errhandlers-are-called", "committedDate": "2020-04-15T18:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5Njk0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55252#discussion_r409396947", "bodyText": "I found this confusing, but I see it's just how getAllRetainableSnapshots does the listener callback, so maybe it's a discussion we should have on a separate ocasion", "author": "andreidan", "createdAt": "2020-04-16T09:01:53Z", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotRetentionTaskTests.java", "diffHunk": "@@ -375,6 +384,114 @@ public void testOkToDeleteSnapshots() {\n         assertThat(SnapshotRetentionTask.okayToDeleteSnapshots(state), equalTo(true));\n     }\n \n+    public void testErrStillRunsFailureHandlerWhenRetrieving() throws Exception {\n+        ThreadPool threadPool = new TestThreadPool(\"slm-test\");\n+        final String policyId = \"policy\";\n+        final String repoId = \"repo\";\n+        try (ClusterService clusterService = ClusterServiceUtils.createClusterService(threadPool);\n+             Client noOpClient = new NoOpClient(\"slm-test\") {\n+\n+                 @Override\n+                 @SuppressWarnings(\"unchecked\")\n+                 protected <Request extends ActionRequest, Response extends ActionResponse>\n+                 void doExecute(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n+                     if (request instanceof GetSnapshotsRequest) {\n+                         logger.info(\"--> called\");\n+                         listener.onResponse((Response) new GetSnapshotsResponse(\n+                             Collections.singleton(GetSnapshotsResponse.Response.snapshots(repoId, Collections.emptyList()))));\n+                     } else {\n+                         super.doExecute(action, request, listener);\n+                     }\n+                 }\n+             }) {\n+            SnapshotLifecyclePolicy policy = new SnapshotLifecyclePolicy(policyId, \"snap\", \"1 * * * * ?\",\n+                repoId, null, new SnapshotRetentionConfiguration(TimeValue.timeValueDays(30), null, null));\n+\n+            ClusterState state = createState(policy);\n+            ClusterServiceUtils.setState(clusterService, state);\n+\n+            SnapshotRetentionTask task = new SnapshotRetentionTask(noOpClient, clusterService,\n+                System::nanoTime,\n+                new SnapshotLifecycleTaskTests.VerifyingHistoryStore(noOpClient, ZoneOffset.UTC,\n+                    (historyItem) -> fail(\"should never write history\")),\n+                threadPool);\n+\n+            AtomicReference<Exception> errHandlerCalled = new AtomicReference<>(null);\n+            task.getAllRetainableSnapshots(Collections.singleton(repoId), new ActionListener<>() {\n+                @Override\n+                public void onResponse(Map<String, List<SnapshotInfo>> stringListMap) {\n+                    logger.info(\"--> forcing failure\");\n+                    throw new ElasticsearchException(\"forced failure\");\n+                }\n+\n+                @Override\n+                public void onFailure(Exception e) {\n+                    fail(\"we have another err handler that should have been called\");", "originalCommit": "f8e19cedb97df2b05d4fbb6a3e262ec8239d2de3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1MjkzOA==", "url": "https://github.com/elastic/elasticsearch/pull/55252#discussion_r409652938", "bodyText": "Yeah, we can do that maybe in future work since it's technically not really a bugfix.", "author": "dakrone", "createdAt": "2020-04-16T15:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM5Njk0Nw=="}], "type": "inlineReview", "revised_code": null}]}