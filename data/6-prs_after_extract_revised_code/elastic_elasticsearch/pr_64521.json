{"pr_number": 64521, "pr_title": "Use data stream for ILM history", "pr_createdAt": "2020-11-03T10:37:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64521", "timeline": [{"oid": "3bf4f571143408d1670d5cab93c3e04827edda89", "url": "https://github.com/elastic/elasticsearch/commit/3bf4f571143408d1670d5cab93c3e04827edda89", "message": "ILM history data stream", "committedDate": "2020-11-03T10:25:04Z", "type": "commit"}, {"oid": "73029fc59346076f32ff0018cc59bff7d51b5517", "url": "https://github.com/elastic/elasticsearch/commit/73029fc59346076f32ff0018cc59bff7d51b5517", "message": "remove unneeded tests", "committedDate": "2020-11-03T10:31:18Z", "type": "commit"}, {"oid": "b19b7b5904aecdcde6882194db8dfd285c7af6e0", "url": "https://github.com/elastic/elasticsearch/commit/b19b7b5904aecdcde6882194db8dfd285c7af6e0", "message": "add flush", "committedDate": "2020-11-03T22:29:48Z", "type": "commit"}, {"oid": "73ef56ea19a61556ca17ccfead8eef3f88975473", "url": "https://github.com/elastic/elasticsearch/commit/73ef56ea19a61556ca17ccfead8eef3f88975473", "message": "null check", "committedDate": "2020-11-03T22:48:26Z", "type": "commit"}, {"oid": "3ec4de52624b235ff107d9f6da27fabadaa80500", "url": "https://github.com/elastic/elasticsearch/commit/3ec4de52624b235ff107d9f6da27fabadaa80500", "message": "discard", "committedDate": "2020-11-04T00:07:51Z", "type": "commit"}, {"oid": "1e16b332df299a5cc6aa5a66cea46976e6a8c248", "url": "https://github.com/elastic/elasticsearch/commit/1e16b332df299a5cc6aa5a66cea46976e6a8c248", "message": "null check", "committedDate": "2020-11-04T00:28:01Z", "type": "commit"}, {"oid": "17d1d669539efb9692ef4ed3b1660afe7327559a", "url": "https://github.com/elastic/elasticsearch/commit/17d1d669539efb9692ef4ed3b1660afe7327559a", "message": "Revert \"null check\"\n\nThis reverts commit 1e16b332df299a5cc6aa5a66cea46976e6a8c248.", "committedDate": "2020-11-04T07:47:52Z", "type": "commit"}, {"oid": "5bd1c2d89e1d1984460eabffc1e6c491609a57f1", "url": "https://github.com/elastic/elasticsearch/commit/5bd1c2d89e1d1984460eabffc1e6c491609a57f1", "message": "Revert \"discard\"\n\nThis reverts commit 3ec4de52624b235ff107d9f6da27fabadaa80500.", "committedDate": "2020-11-04T07:48:03Z", "type": "commit"}, {"oid": "90922c8d5716ba75b53c26dbd5caee6c1772c125", "url": "https://github.com/elastic/elasticsearch/commit/90922c8d5716ba75b53c26dbd5caee6c1772c125", "message": "ilm history connected to ilm status", "committedDate": "2020-11-04T08:26:45Z", "type": "commit"}, {"oid": "e7644a989290fef497fbf411118fc212117b0485", "url": "https://github.com/elastic/elasticsearch/commit/e7644a989290fef497fbf411118fc212117b0485", "message": "test fix", "committedDate": "2020-11-04T09:36:57Z", "type": "commit"}, {"oid": "833a333d9afb60f088e9cf01feb5bbcadd076534", "url": "https://github.com/elastic/elasticsearch/commit/833a333d9afb60f088e9cf01feb5bbcadd076534", "message": "Merge remote-tracking branch 'origin/master' into ilm-history-data-stream2", "committedDate": "2020-11-04T09:57:05Z", "type": "commit"}, {"oid": "e13b573dba5e2238506a465480168e2b6a639584", "url": "https://github.com/elastic/elasticsearch/commit/e13b573dba5e2238506a465480168e2b6a639584", "message": "revert", "committedDate": "2020-11-04T12:06:42Z", "type": "commit"}, {"oid": "94f090016417313c642684bb8762fba984b487af", "url": "https://github.com/elastic/elasticsearch/commit/94f090016417313c642684bb8762fba984b487af", "message": "ignore backing indices from history", "committedDate": "2020-11-04T12:10:45Z", "type": "commit"}, {"oid": "9fb80dc811c2ad22e6c245e57dad08cfd82446d4", "url": "https://github.com/elastic/elasticsearch/commit/9fb80dc811c2ad22e6c245e57dad08cfd82446d4", "message": "imports", "committedDate": "2020-11-04T12:11:49Z", "type": "commit"}, {"oid": "051319bff95543b3b1802051b1a4cb38ffd34e91", "url": "https://github.com/elastic/elasticsearch/commit/051319bff95543b3b1802051b1a4cb38ffd34e91", "message": "Merge branch 'master' into ilm-history-data-stream2", "committedDate": "2020-11-04T12:12:22Z", "type": "commit"}, {"oid": "62ad220558cf182d7d1da11825e6273568be7e37", "url": "https://github.com/elastic/elasticsearch/commit/62ad220558cf182d7d1da11825e6273568be7e37", "message": "cleanup", "committedDate": "2020-11-04T12:13:53Z", "type": "commit"}, {"oid": "81cfcf0be34024cb30f2f8febc7b24a38d061413", "url": "https://github.com/elastic/elasticsearch/commit/81cfcf0be34024cb30f2f8febc7b24a38d061413", "message": "fix pattern", "committedDate": "2020-11-04T12:17:43Z", "type": "commit"}, {"oid": "d8183cd084f4d1aa7a9984f2d2b31cb55b35f802", "url": "https://github.com/elastic/elasticsearch/commit/d8183cd084f4d1aa7a9984f2d2b31cb55b35f802", "message": "fix pattern", "committedDate": "2020-11-04T12:19:45Z", "type": "commit"}, {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c", "url": "https://github.com/elastic/elasticsearch/commit/52330f2813dca52777d557fa1e66dc5045921e2c", "message": "import", "committedDate": "2020-11-04T12:32:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE3MzU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r518173549", "bodyText": "This looks fishy but it's similar situation as we had before - ILM history index could pop up just after deleting all indices and it didn't do any harm", "author": "probakowski", "createdAt": "2020-11-05T16:12:30Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -646,7 +646,8 @@ private void wipeCluster() throws Exception {\n     protected static void wipeAllIndices() throws IOException {\n         boolean includeHidden = minimumNodeVersion().onOrAfter(Version.V_7_7_0);\n         try {\n-            final Request deleteRequest = new Request(\"DELETE\", \"*\");\n+            //remove all indices except ilm history which can pop up after deleting all data streams but shouldn't interfere\n+            final Request deleteRequest = new Request(\"DELETE\", \"*,-.ds-ilm-history-*\");", "originalCommit": "52330f2813dca52777d557fa1e66dc5045921e2c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MDIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r518650239", "bodyText": "I don't think we need this check here as well.\nIs this meant to catch the case when the ilm history was disabled between the time putAsync was called and the bulk was actually executed? If so, I think it'd be fine to allow it to go through as opposed to failing (and the next putAsync call will not record any history items anymore)\nIf we do decide to keep it I believe the exception should report the items it had not indexed.\nWhat do you think?", "author": "andreidan", "createdAt": "2020-11-06T10:10:58Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java", "diffHunk": "@@ -75,18 +65,12 @@ public ILMHistoryStore(Settings nodeSettings, Client client, ClusterService clus\n             new BulkProcessor.Listener() {\n                 @Override\n                 public void beforeBulk(long executionId, BulkRequest request) {\n-                    // Prior to actually performing the bulk, we should ensure the index exists, and\n-                    // if we were unable to create it or it was in a bad state, we should not\n-                    // attempt to index documents.\n-                    try {\n-                        final CompletableFuture<Boolean> indexCreated = new CompletableFuture<>();\n-                        ensureHistoryIndex(client, clusterService.state(), ActionListener.wrap(indexCreated::complete,\n-                            ex -> {\n-                                logger.warn(\"failed to create ILM history store index prior to issuing bulk request\", ex);\n-                                indexCreated.completeExceptionally(ex);\n-                            }));\n-                        indexCreated.get(2, TimeUnit.MINUTES);\n-                    } catch (Exception e) {\n+                    if (ilmHistoryEnabled == false) {\n+                        throw new ElasticsearchException(\"can not index ILM history items when ILM history is disabled\");\n+                    }", "originalCommit": "52330f2813dca52777d557fa1e66dc5045921e2c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2MDE3MA==", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r520060170", "bodyText": "Since the indices.lifecycle.history_index_enabled setting is not dynamic, I don't think we need this check (since putAsync will always punt)", "author": "dakrone", "createdAt": "2020-11-09T19:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MDIzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExNDcyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r520114720", "bodyText": "You are right, I've removed it", "author": "probakowski", "createdAt": "2020-11-09T20:56:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MDIzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "7543e0efcf5208ffb28400f84c9e30e2ca15144d", "chunk": "diff --git a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\nindex 11a2600eb88..1a019710b6c 100644\n--- a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\n+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\n\n@@ -65,10 +65,6 @@ public class ILMHistoryStore implements Closeable {\n             new BulkProcessor.Listener() {\n                 @Override\n                 public void beforeBulk(long executionId, BulkRequest request) {\n-                    if (ilmHistoryEnabled == false) {\n-                        throw new ElasticsearchException(\"can not index ILM history items when ILM history is disabled\");\n-                    }\n-\n                     if (clusterService.state().getMetadata().templatesV2().containsKey(ILM_TEMPLATE_NAME) == false) {\n                         ElasticsearchException e = new ElasticsearchException(\"no ILM history template\");\n                         logger.warn(new ParameterizedMessage(\"unable to index the following ILM history items:\\n{}\",\n"}}, {"oid": "7543e0efcf5208ffb28400f84c9e30e2ca15144d", "url": "https://github.com/elastic/elasticsearch/commit/7543e0efcf5208ffb28400f84c9e30e2ca15144d", "message": "review comments", "committedDate": "2020-11-09T20:45:40Z", "type": "commit"}, {"oid": "5cbb089f57c5e8e439cc3e793bd60d38bae0e42c", "url": "https://github.com/elastic/elasticsearch/commit/5cbb089f57c5e8e439cc3e793bd60d38bae0e42c", "message": "Merge branch 'master' into ilm-history-data-stream2", "committedDate": "2020-11-09T21:02:50Z", "type": "commit"}]}