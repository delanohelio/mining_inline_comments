{"pr_number": 62276, "pr_title": "EQL: Use Point In Time inside sequences", "pr_createdAt": "2020-09-11T22:03:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62276", "timeline": [{"oid": "ee156d037f161f3339dd446c7f297f37ff05ad86", "url": "https://github.com/elastic/elasticsearch/commit/ee156d037f161f3339dd446c7f297f37ff05ad86", "message": "EQL: Use Point In Time inside sequences\n\nUse the newly introduced PIT API to have a consistent view of the data\nwhile doing sequence matching, which involves multiple calls, aka\nrepeatable reads and thus avoid race conditions or any in-flight updates\non the data.", "committedDate": "2020-09-11T22:00:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxMTQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487311494", "bodyText": "PIT feedback:\n\npointInTimeBuilder method in SearchSource could be renamed to getPoint.. to follow the naming convention of the rest of the methods in the class\nSince the keepAlive is optional, it could be removed from the constructor and moved to a separate method (setKeepAlive()) in the PointInTimeBuilder class.", "author": "costin", "createdAt": "2020-09-11T22:06:26Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Opens a point-in-time, uses it for all queries and closes it when disposed,\n+ * freeing consumer from doing any special management for it.\n+ */\n+public class PITAwareQueryClient extends BasicQueryClient {\n+\n+    private String pitId;\n+    private final TimeValue keepAlive;\n+\n+    public PITAwareQueryClient(EqlSession eqlSession) {\n+        super(eqlSession);\n+        this.keepAlive = eqlSession.configuration().requestTimeout();\n+    }\n+\n+    @Override\n+    protected void search(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // no pid, ask for one\n+        if (pitId == null) {\n+            openPIT(wrap(r -> {\n+                pitId = r;\n+                searchWithPIT(search, listener);\n+            }, listener::onFailure));\n+        }\n+        else {\n+            searchWithPIT(search, listener);\n+        }\n+    }\n+\n+    private void searchWithPIT(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // don't increase the keep alive\n+        search.source().pointInTimeBuilder(new SearchSourceBuilder.PointInTimeBuilder(pitId, null));", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI0ODA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r492248072", "bodyText": "Since the keepAlive is optional, it could be removed from the constructor and moved to a separate method (setKeepAlive()) in the PointInTimeBuilder class.\n\nThanks Costin. I've opened #62720 for this.\n\npointInTimeBuilder method in SearchSource could be renamed to getPoint.. to follow the naming convention of the rest of the methods in the class\n\nWe do not use get/set in SearchSourceBuilder; hence, I will leave pointInTimeBuilder as is.", "author": "dnhatn", "createdAt": "2020-09-21T18:01:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxMTQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI1MTMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r492251338", "bodyText": "We do not use get/set in SearchSourceBuilder; hence, I will leave pointInTimeBuilder as is.\n\nThanks for double-checking. There seems to be some inconsistency here - AggregationBuilder and SliceBuilder seem to use getter/setter while the other builders that I've checked (e.g. SortBuilder or HighlightBuilder) do not.\n:+1 from my side.", "author": "costin", "createdAt": "2020-09-21T18:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxMTQ5NA=="}], "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNzYwNg==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487727606", "bodyText": "Do I understand correctly that PITs are used only when there are more than one search requests internally (sequences) ?", "author": "jimczi", "createdAt": "2020-09-14T08:09:44Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Opens a point-in-time, uses it for all queries and closes it when disposed,\n+ * freeing consumer from doing any special management for it.\n+ */\n+public class PITAwareQueryClient extends BasicQueryClient {\n+\n+    private String pitId;\n+    private final TimeValue keepAlive;\n+\n+    public PITAwareQueryClient(EqlSession eqlSession) {\n+        super(eqlSession);\n+        this.keepAlive = eqlSession.configuration().requestTimeout();\n+    }\n+\n+    @Override\n+    protected void search(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // no pid, ask for one\n+        if (pitId == null) {\n+            openPIT(wrap(r -> {\n+                pitId = r;\n+                searchWithPIT(search, listener);\n+            }, listener::onFailure));", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4NzI2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487887269", "bodyText": "Correct.", "author": "costin", "createdAt": "2020-09-14T12:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyNzYwNg=="}], "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyODU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487728567", "bodyText": "What do we do on partial failures (shard failures) ? I wonder if these requests should run with allow_partial_search_results set to false ?", "author": "jimczi", "createdAt": "2020-09-14T08:11:21Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Opens a point-in-time, uses it for all queries and closes it when disposed,\n+ * freeing consumer from doing any special management for it.\n+ */\n+public class PITAwareQueryClient extends BasicQueryClient {\n+\n+    private String pitId;\n+    private final TimeValue keepAlive;\n+\n+    public PITAwareQueryClient(EqlSession eqlSession) {\n+        super(eqlSession);\n+        this.keepAlive = eqlSession.configuration().requestTimeout();\n+    }\n+\n+    @Override\n+    protected void search(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // no pid, ask for one\n+        if (pitId == null) {\n+            openPIT(wrap(r -> {\n+                pitId = r;\n+                searchWithPIT(search, listener);\n+            }, listener::onFailure));\n+        }\n+        else {\n+            searchWithPIT(search, listener);\n+        }\n+    }\n+\n+    private void searchWithPIT(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // don't increase the keep alive\n+        search.source().pointInTimeBuilder(new SearchSourceBuilder.PointInTimeBuilder(pitId, null));\n+        // get the pid on each request\n+        super.search(search, wrap(r -> {\n+                pitId = r.pointInTimeId();\n+                listener.onResponse(r);", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg4ODY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487888652", "bodyText": "We don't support partial failures (it is set to false, inside RuntimeUtils#prepareRequest).", "author": "costin", "createdAt": "2020-09-14T12:54:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyODU2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0OTQxNA==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r489549414", "bodyText": "cool, thanks", "author": "jimczi", "createdAt": "2020-09-16T15:57:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyODU2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyOTEyNw==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487729127", "bodyText": "It would be nice to have tests that check that all PITs are closed when the request finishes ?", "author": "jimczi", "createdAt": "2020-09-14T08:12:19Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Opens a point-in-time, uses it for all queries and closes it when disposed,\n+ * freeing consumer from doing any special management for it.\n+ */\n+public class PITAwareQueryClient extends BasicQueryClient {\n+\n+    private String pitId;\n+    private final TimeValue keepAlive;\n+\n+    public PITAwareQueryClient(EqlSession eqlSession) {\n+        super(eqlSession);\n+        this.keepAlive = eqlSession.configuration().requestTimeout();\n+    }\n+\n+    @Override\n+    protected void search(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // no pid, ask for one\n+        if (pitId == null) {\n+            openPIT(wrap(r -> {\n+                pitId = r;\n+                searchWithPIT(search, listener);\n+            }, listener::onFailure));\n+        }\n+        else {\n+            searchWithPIT(search, listener);\n+        }\n+    }\n+\n+    private void searchWithPIT(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // don't increase the keep alive\n+        search.source().pointInTimeBuilder(new SearchSourceBuilder.PointInTimeBuilder(pitId, null));\n+        // get the pid on each request\n+        super.search(search, wrap(r -> {\n+                pitId = r.pointInTimeId();\n+                listener.onResponse(r);\n+            },\n+            // always close PIT in case of exceptions\n+            e -> {\n+                if (pitId != null) {\n+                    close(wrap(b -> {}, listener::onFailure));\n+                }\n+                listener.onFailure(e);\n+            }));\n+    }\n+\n+    private void openPIT(ActionListener<String> listener) {\n+        OpenPointInTimeRequest request = new OpenPointInTimeRequest(\n+            indices,\n+            IndexResolver.FIELD_CAPS_INDICES_OPTIONS,\n+            keepAlive,\n+            null,\n+            null\n+        );\n+        client.execute(OpenPointInTimeAction.INSTANCE, request, map(listener, OpenPointInTimeResponse::getSearchContextId));\n+    }\n+\n+    @Override\n+    public void close(ActionListener<Boolean> listener)  {\n+        client.execute(ClosePointInTimeAction.INSTANCE, new ClosePointInTimeRequest(pitId),\n+            map(listener, ClosePointInTimeResponse::isSucceeded));\n+        pitId = null;", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1MzYzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488053631", "bodyText": "Indeed. I've checked and found the assertion for no search contexts existed only in SQL so I moved it into QL to be reused into EQL as well. Commented out close to see the assertion being tripped.\nI believe that's enough.", "author": "costin", "createdAt": "2020-09-14T16:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyOTEyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU0OTU1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r489549555", "bodyText": "agreed, thanks", "author": "jimczi", "createdAt": "2020-09-16T15:57:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcyOTEyNw=="}], "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MTI1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487991256", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Extension of basic query, adding awareness Point-in-Time awareness.\n          \n          \n            \n             * Extension of basic query, adding Point-in-Time awareness.", "author": "bpintea", "createdAt": "2020-09-14T14:47:59Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MTg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r487991876", "bodyText": "PIT or pit ID?", "author": "bpintea", "createdAt": "2020-09-14T14:48:47Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.search;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.ClosePointInTimeResponse;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeAction;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeRequest;\n+import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Opens a point-in-time, uses it for all queries and closes it when disposed,\n+ * freeing consumer from doing any special management for it.\n+ */\n+public class PITAwareQueryClient extends BasicQueryClient {\n+\n+    private String pitId;\n+    private final TimeValue keepAlive;\n+\n+    public PITAwareQueryClient(EqlSession eqlSession) {\n+        super(eqlSession);\n+        this.keepAlive = eqlSession.configuration().requestTimeout();\n+    }\n+\n+    @Override\n+    protected void search(SearchRequest search, ActionListener<SearchResponse> listener) {\n+        // no pid, ask for one", "originalCommit": "ee156d037f161f3339dd446c7f297f37ff05ad86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1MzgzOA==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488053838", "bodyText": "pitID", "author": "costin", "createdAt": "2020-09-14T16:10:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzk5MTg3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "chunk": "diff --git a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\nindex b90864c0ba2..4f80d949a2f 100644\n--- a/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n+++ b/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/PITAwareQueryClient.java\n\n@@ -20,11 +20,11 @@ import org.elasticsearch.xpack.core.search.action.OpenPointInTimeResponse;\n import org.elasticsearch.xpack.eql.session.EqlSession;\n import org.elasticsearch.xpack.ql.index.IndexResolver;\n \n-import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.ql.util.ActionListeners.map;\n \n /**\n- * Extension of basic query, adding awareness Point-in-Time awareness.\n+ * Extension of basic query, adding Point-in-Time awareness.\n  * Opens a point-in-time, uses it for all queries and closes it when disposed,\n  * freeing consumer from doing any special management for it.\n  */\n"}}, {"oid": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "url": "https://github.com/elastic/elasticsearch/commit/e98239bc865ac2219d185f9b427aa9c29e77d5ad", "message": "Address feedback", "committedDate": "2020-09-14T16:01:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1NTAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488055011", "bodyText": "Add assertion that all search contexts are closed after each single test.", "author": "costin", "createdAt": "2020-09-14T16:12:10Z", "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlRestTestCase.java", "diffHunk": "@@ -31,6 +31,11 @@\n     private static final String defaultValidationIndexName = \"eql_search_validation_test\";\n     private static final String validQuery = \"process where user = 'SYSTEM'\";\n \n+    @After\n+    public void checkSearchContent() throws Exception {", "originalCommit": "e98239bc865ac2219d185f9b427aa9c29e77d5ad", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU3NzY3OA==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488577678", "bodyText": "Really minor: checkSearchContent or checkSearchContext?", "author": "astefan", "createdAt": "2020-09-15T11:03:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA1NTAxMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "f90fbb04776a8cc5234a13320b8d56a9ba0e4e92", "url": "https://github.com/elastic/elasticsearch/commit/f90fbb04776a8cc5234a13320b8d56a9ba0e4e92", "message": "Trying to fix the SQL classpath", "committedDate": "2020-09-15T08:41:57Z", "type": "commit"}, {"oid": "c6baac3a2acbead83b96818a3422de997a890299", "url": "https://github.com/elastic/elasticsearch/commit/c6baac3a2acbead83b96818a3422de997a890299", "message": "Merge branch 'master' into eql/add-pit", "committedDate": "2020-09-15T10:03:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU3ODM2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488578365", "bodyText": "This check is being performed in other places in code. If we remove this one here, should it be removed anywhere else as well?", "author": "astefan", "createdAt": "2020-09-15T11:04:37Z", "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlRestTestCase.java", "diffHunk": "@@ -43,14 +48,9 @@\n             {\"{\\\"query\\\": \\\"\" + validQuery + \"\\\", \\\"filter\\\": {}}\", \"query malformed, empty clause found\"}\n     };\n \n-    @BeforeClass\n-    public static void checkForSnapshot() {\n-        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());", "originalCommit": "c6baac3a2acbead83b96818a3422de997a890299", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYyMjE0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/62276#discussion_r488622142", "bodyText": "There are several improvements that can be made to this class but I wanted to keep it separate:\n\nthe class / index name needs to be changed\nthe snapshot was suppose to be removed outside the feature flag - it hasn't so maybe there are cases for this.\nThe class should be refactored so it contains only the loading and utility tests, not any tests itself.", "author": "costin", "createdAt": "2020-09-15T12:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU3ODM2NQ=="}], "type": "inlineReview", "revised_code": null}]}