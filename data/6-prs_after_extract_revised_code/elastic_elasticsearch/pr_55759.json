{"pr_number": 55759, "pr_title": "Improve RemoteConnectionManager consistency", "pr_createdAt": "2020-04-24T23:56:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55759", "timeline": [{"oid": "4b7c6cc428728c8969a685825cea88f2b12bbe8d", "url": "https://github.com/elastic/elasticsearch/commit/4b7c6cc428728c8969a685825cea88f2b12bbe8d", "message": "Improve RemoteConnectionManager consistency\n\nIn order to iterate through remote connections, the remote connection\nmanager maintains a local cache of connected nodes. Unfortunately this\nis difficult in relationship with testing as it is inherently racy in\ncomparison to the parent connection manager map of connections.\n\nThis commit improves the relationship by only returning a cached\nconnection if it is still registered with the parent. If the connection\nis not open, we will go to the slow path of allocating a iterator\ndirectly from the parent.", "committedDate": "2020-04-24T23:52:34Z", "type": "commit"}, {"oid": "bddc589e585f0c4aa466f61ddc501a2be0be3d7d", "url": "https://github.com/elastic/elasticsearch/commit/bddc589e585f0c4aa466f61ddc501a2be0be3d7d", "message": "Change", "committedDate": "2020-04-24T23:56:01Z", "type": "commit"}, {"oid": "25b1f1dfd54bcb25fb4741caf870e3304d656c73", "url": "https://github.com/elastic/elasticsearch/commit/25b1f1dfd54bcb25fb4741caf870e3304d656c73", "message": "Merge remote-tracking branch 'upstream/master' into remote_connection_manager_consistency", "committedDate": "2020-04-25T02:59:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM1OTMwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55759#discussion_r415359301", "bodyText": "NIT: Why have this check? Seems kind of racy and not much of an optimization if any to begin with?", "author": "original-brownbear", "createdAt": "2020-04-26T17:30:51Z", "path": "server/src/main/java/org/elasticsearch/transport/RemoteConnectionManager.java", "diffHunk": "@@ -98,23 +99,38 @@ public ConnectionProfile getConnectionProfile() {\n     }\n \n     public Transport.Connection getAnyRemoteConnection() {\n-        List<Transport.Connection> localConnections = this.connections;\n-        if (localConnections.isEmpty()) {\n-            throw new NoSuchRemoteClusterException(clusterAlias);\n-        } else {\n-            long curr;\n-            while ((curr = counter.incrementAndGet()) == Long.MIN_VALUE);\n-            return localConnections.get(Math.floorMod(curr, localConnections.size()));\n+        List<DiscoveryNode> localConnectedNodes = this.connectedNodes;\n+        long curr;\n+        while ((curr = counter.incrementAndGet()) == Long.MIN_VALUE);\n+        if (localConnectedNodes.isEmpty() == false) {\n+            DiscoveryNode nextNode = localConnectedNodes.get(Math.floorMod(curr, localConnectedNodes.size()));\n+            try {\n+                return delegate.getConnection(nextNode);\n+            } catch (NodeNotConnectedException e) {\n+                // Ignore. We will manually create an iterator of open nodes\n+            }\n+        }\n+        if (delegate.size() != 0) {", "originalCommit": "25b1f1dfd54bcb25fb4741caf870e3304d656c73", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "17abdcef4d7b59dc9b34105e813ec5ddb758f417", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/transport/RemoteConnectionManager.java b/server/src/main/java/org/elasticsearch/transport/RemoteConnectionManager.java\nindex 3c7888b63a4..f4d0f72d33f 100644\n--- a/server/src/main/java/org/elasticsearch/transport/RemoteConnectionManager.java\n+++ b/server/src/main/java/org/elasticsearch/transport/RemoteConnectionManager.java\n\n@@ -110,14 +110,12 @@ public class RemoteConnectionManager implements ConnectionManager {\n                 // Ignore. We will manually create an iterator of open nodes\n             }\n         }\n-        if (delegate.size() != 0) {\n-            Set<DiscoveryNode> allConnectionNodes = getAllConnectedNodes();\n-            for (DiscoveryNode connectedNode : allConnectionNodes) {\n-                try {\n-                    return delegate.getConnection(connectedNode);\n-                } catch (NodeNotConnectedException e) {\n-                    // Ignore. We will try the next one until all are exhausted.\n-                }\n+        Set<DiscoveryNode> allConnectionNodes = getAllConnectedNodes();\n+        for (DiscoveryNode connectedNode : allConnectionNodes) {\n+            try {\n+                return delegate.getConnection(connectedNode);\n+            } catch (NodeNotConnectedException e) {\n+                // Ignore. We will try the next one until all are exhausted.\n             }\n         }\n         throw new NoSuchRemoteClusterException(clusterAlias);\n"}}, {"oid": "17abdcef4d7b59dc9b34105e813ec5ddb758f417", "url": "https://github.com/elastic/elasticsearch/commit/17abdcef4d7b59dc9b34105e813ec5ddb758f417", "message": "Chnage", "committedDate": "2020-04-28T15:53:59Z", "type": "commit"}, {"oid": "58752e952ca349f77a5ac0259266107cd5505710", "url": "https://github.com/elastic/elasticsearch/commit/58752e952ca349f77a5ac0259266107cd5505710", "message": "Merge remote-tracking branch 'upstream/master' into remote_connection_manager_consistency", "committedDate": "2020-04-28T15:54:12Z", "type": "commit"}]}