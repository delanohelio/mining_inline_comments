{"pr_number": 60742, "pr_title": "Add UBI docker builds", "pr_createdAt": "2020-08-05T13:46:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60742", "timeline": [{"oid": "e703b1756d1e5487d07b93b2befbb013c37d7fc1", "url": "https://github.com/elastic/elasticsearch/commit/e703b1756d1e5487d07b93b2befbb013c37d7fc1", "message": "Reinstate UBI builds", "committedDate": "2020-07-29T15:14:58Z", "type": "commit"}, {"oid": "20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "url": "https://github.com/elastic/elasticsearch/commit/20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "message": "Only provide a task to build a UBI context", "committedDate": "2020-07-30T11:37:21Z", "type": "commit"}, {"oid": "8a3f3bc47471c59fd6dfb49f324a839a0273c109", "url": "https://github.com/elastic/elasticsearch/commit/8a3f3bc47471c59fd6dfb49f324a839a0273c109", "message": "Generate UBI downloads.json during context build (badly)", "committedDate": "2020-07-30T13:56:39Z", "type": "commit"}, {"oid": "ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "url": "https://github.com/elastic/elasticsearch/commit/ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "message": "Revert unnecessary changes", "committedDate": "2020-07-30T14:15:13Z", "type": "commit"}, {"oid": "ad9140f8021fcef9944a8fd194cf14648bd9f98e", "url": "https://github.com/elastic/elasticsearch/commit/ad9140f8021fcef9944a8fd194cf14648bd9f98e", "message": "Fix UBI version in archive name", "committedDate": "2020-07-30T14:22:26Z", "type": "commit"}, {"oid": "2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "url": "https://github.com/elastic/elasticsearch/commit/2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "message": "Hack around gradle issues with configurations and project context", "committedDate": "2020-07-30T15:19:34Z", "type": "commit"}, {"oid": "10247102e6cf11b0d9462d57e8720bff28cadaf9", "url": "https://github.com/elastic/elasticsearch/commit/10247102e6cf11b0d9462d57e8720bff28cadaf9", "message": "Revert \"Hack around gradle issues with configurations and project context\"\n\nThis reverts commit 2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0.", "committedDate": "2020-07-30T15:41:51Z", "type": "commit"}, {"oid": "4a87d279010d91135f468b90bd1fc271066bde19", "url": "https://github.com/elastic/elasticsearch/commit/4a87d279010d91135f468b90bd1fc271066bde19", "message": "Support ubi and ubi-minimal", "committedDate": "2020-07-31T10:28:05Z", "type": "commit"}, {"oid": "c0d3ace8c198f916f828ce675bbf4334482b6f87", "url": "https://github.com/elastic/elasticsearch/commit/c0d3ace8c198f916f828ce675bbf4334482b6f87", "message": "Make it possible to run tests on UBI image", "committedDate": "2020-07-31T11:30:32Z", "type": "commit"}, {"oid": "06a4d2ed13b999e1aa1e02d23144be05cbd16888", "url": "https://github.com/elastic/elasticsearch/commit/06a4d2ed13b999e1aa1e02d23144be05cbd16888", "message": "Only support ubi-minimal and rename it ubi", "committedDate": "2020-08-05T11:45:10Z", "type": "commit"}, {"oid": "5dc83ec8a89e86efd9d9f5f69472fec934f9d319", "url": "https://github.com/elastic/elasticsearch/commit/5dc83ec8a89e86efd9d9f5f69472fec934f9d319", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-05T12:40:16Z", "type": "commit"}, {"oid": "2db70916aa340ba8e0a703658446ede5bcca1ef2", "url": "https://github.com/elastic/elasticsearch/commit/2db70916aa340ba8e0a703658446ede5bcca1ef2", "message": "Fixes", "committedDate": "2020-08-05T13:19:37Z", "type": "commit"}, {"oid": "1a95b295efe2c9769c04249dcb3b9702d21f0201", "url": "https://github.com/elastic/elasticsearch/commit/1a95b295efe2c9769c04249dcb3b9702d21f0201", "message": "Formatting", "committedDate": "2020-08-05T13:27:24Z", "type": "commit"}, {"oid": "b4e9f7ac1d001aa2417f582490762d8f62d6b893", "url": "https://github.com/elastic/elasticsearch/commit/b4e9f7ac1d001aa2417f582490762d8f62d6b893", "message": "Tweaks", "committedDate": "2020-08-05T13:39:29Z", "type": "commit"}, {"oid": "2f25d7683415e7891f265244c7fd542e0b3500aa", "url": "https://github.com/elastic/elasticsearch/commit/2f25d7683415e7891f265244c7fd542e0b3500aa", "message": "Fixes", "committedDate": "2020-08-05T19:53:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NTI2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r465895262", "bodyText": "Maybe DOCKER_UBI then?", "author": "mark-vieira", "createdAt": "2020-08-05T17:41:14Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -50,7 +50,9 @@ public String toString() {\n         ARCHIVE,\n         RPM,\n         DEB,\n-        DOCKER;\n+        DOCKER,\n+        // This is a different flavour of Docker image\n+        UBI;", "originalCommit": "b4e9f7ac1d001aa2417f582490762d8f62d6b893", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ1OTQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r466459490", "bodyText": "That's probably clearer, I'll go with DOCKER_UBI.", "author": "pugnascotia", "createdAt": "2020-08-06T14:36:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NTI2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "fc13ddd374ef11d411f0a1856ee2d124c9041c3b", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\nindex 917b59c58af..7ce5646a2c2 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\n\n@@ -52,7 +52,7 @@ public class ElasticsearchDistribution implements Buildable, Iterable<File> {\n         DEB,\n         DOCKER,\n         // This is a different flavour of Docker image\n-        UBI;\n+        DOCKER_UBI;\n \n         @Override\n         public String toString() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NzE3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r465897177", "bodyText": "I assume you decided that introducing yet another axis on ElasticsearchDistribution was folly and therefore this isn't actually used? ;)", "author": "mark-vieira", "createdAt": "2020-08-05T17:44:28Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/Variant.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+/**\n+ * Models the different varieties of Docker image that the build can create.\n+ */\n+public enum Variant {", "originalCommit": "b4e9f7ac1d001aa2417f582490762d8f62d6b893", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQ2MTY2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r466461669", "bodyText": "I use this in distribution/docker/build.gradle. I introduced it before going on to add support for UBI in the distro tests. It's sort of a blend of ElasticsearchDistribution.Type and ElasticsearchDistribution.Flavour, which is why I created a new enum for it.", "author": "pugnascotia", "createdAt": "2020-08-06T14:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NzE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU2ODEyMA==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r469568120", "bodyText": "Perhaps then it should just live there, given there are no other references to it in buildSrc.", "author": "mark-vieira", "createdAt": "2020-08-12T21:53:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NzE3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "3d80c484638b5ba24b9a9904d79bcd8d4f6b591f", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/Variant.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IndexNode.java\nsimilarity index 66%\nrename from buildSrc/src/main/java/org/elasticsearch/gradle/Variant.java\nrename to modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IndexNode.java\nindex 0340d0f7e90..0304cdded02 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/Variant.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IndexNode.java\n\n@@ -17,13 +17,22 @@\n  * under the License.\n  */\n \n-package org.elasticsearch.gradle;\n+package org.elasticsearch.painless.ir;\n+\n+public abstract class IndexNode extends ExpressionNode {\n+\n+    /* ---- begin tree structure ---- */\n+\n+    private ExpressionNode indexNode;\n+\n+    public void setIndexNode(ExpressionNode indexNode) {\n+        this.indexNode = indexNode;\n+    }\n+\n+    public ExpressionNode getIndexNode() {\n+        return indexNode;\n+    }\n+\n+    /* ---- end tree structure ---- */\n \n-/**\n- * Models the different varieties of Docker image that the build can create.\n- */\n-public enum Variant {\n-    DEFAULT,\n-    OSS,\n-    UBI\n }\n"}}, {"oid": "fc13ddd374ef11d411f0a1856ee2d124c9041c3b", "url": "https://github.com/elastic/elasticsearch/commit/fc13ddd374ef11d411f0a1856ee2d124c9041c3b", "message": "Change UBI type to DOCKER_UBI", "committedDate": "2020-08-06T14:36:30Z", "type": "commit"}, {"oid": "b83b2b571553d643a36ef2170dcd6c2239f8fd63", "url": "https://github.com/elastic/elasticsearch/commit/b83b2b571553d643a36ef2170dcd6c2239f8fd63", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-06T14:37:31Z", "type": "commit"}, {"oid": "e3d0396ee389a41b5272361ac5f483deb3d425e6", "url": "https://github.com/elastic/elasticsearch/commit/e3d0396ee389a41b5272361ac5f483deb3d425e6", "message": "Add UBI image testing", "committedDate": "2020-08-06T15:20:32Z", "type": "commit"}, {"oid": "d8cfd28ff28fc3e5e4ee0d9cecbb1fe509b55cf5", "url": "https://github.com/elastic/elasticsearch/commit/d8cfd28ff28fc3e5e4ee0d9cecbb1fe509b55cf5", "message": "Fix UBI label test", "committedDate": "2020-08-10T09:16:01Z", "type": "commit"}, {"oid": "d4593ef5afc32ff4b02b1878ece8155c6f1fbf89", "url": "https://github.com/elastic/elasticsearch/commit/d4593ef5afc32ff4b02b1878ece8155c6f1fbf89", "message": "Formatting", "committedDate": "2020-08-10T09:22:06Z", "type": "commit"}, {"oid": "064bb2e38a5d4c215d28fe9d32b2582c88e7569e", "url": "https://github.com/elastic/elasticsearch/commit/064bb2e38a5d4c215d28fe9d32b2582c88e7569e", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-10T20:35:18Z", "type": "commit"}, {"oid": "724117c5fe526d08dd294e34f95fc351f0116426", "url": "https://github.com/elastic/elasticsearch/commit/724117c5fe526d08dd294e34f95fc351f0116426", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-12T11:23:11Z", "type": "commit"}, {"oid": "f89a2b63a64bc275eceaa77c50c82b2ad9066a75", "url": "https://github.com/elastic/elasticsearch/commit/f89a2b63a64bc275eceaa77c50c82b2ad9066a75", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-13T12:57:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA4NzE5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470087193", "bodyText": "We should actually add some validation in here so you can't choose DOCKER_UBI along with the OSS flavor.", "author": "mark-vieira", "createdAt": "2020-08-13T16:46:56Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -283,7 +289,7 @@ void finalizeValues() {\n                     \"platform cannot be set on elasticsearch distribution [\" + name + \"] of type [\" + getType() + \"]\"\n                 );\n             }", "originalCommit": "724117c5fe526d08dd294e34f95fc351f0116426", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUzMzY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470533662", "bodyText": "I've added a check here.", "author": "pugnascotia", "createdAt": "2020-08-14T10:05:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA4NzE5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "d4d250f2a369c28d5f1f4d851edd8e24459c0c6b", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\nindex 7ce5646a2c2..a2337ed8f3d 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java\n\n@@ -289,10 +289,14 @@ public class ElasticsearchDistribution implements Buildable, Iterable<File> {\n                     \"platform cannot be set on elasticsearch distribution [\" + name + \"] of type [\" + getType() + \"]\"\n                 );\n             }\n-            if (isDocker() && bundledJdk.isPresent()) {\n-                throw new IllegalArgumentException(\n-                    \"bundledJdk cannot be set on elasticsearch distribution [\" + name + \"] of type [docker]\"\n-                );\n+            if (isDocker()) {\n+                if (bundledJdk.isPresent()) {\n+                    throw new IllegalArgumentException(\"bundledJdk cannot be set on elasticsearch distribution [\" + name + \"] of type \"\n+                        + \"[docker]\");\n+                }\n+                if (flavor.get() == Flavor.OSS && type.get() == Type.DOCKER_UBI) {\n+                    throw new IllegalArgumentException(\"Cannot build a UBI docker image for the OSS distribution\");\n+                }\n             }\n         }\n \n"}}, {"oid": "3d80c484638b5ba24b9a9904d79bcd8d4f6b591f", "url": "https://github.com/elastic/elasticsearch/commit/3d80c484638b5ba24b9a9904d79bcd8d4f6b591f", "message": "Remove Variant enum, introduce DockerBase", "committedDate": "2020-08-14T09:53:46Z", "type": "commit"}, {"oid": "8574daa5e634ffb45bad542f3c4ec4cff05eee7b", "url": "https://github.com/elastic/elasticsearch/commit/8574daa5e634ffb45bad542f3c4ec4cff05eee7b", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds", "committedDate": "2020-08-14T09:53:59Z", "type": "commit"}, {"oid": "d4d250f2a369c28d5f1f4d851edd8e24459c0c6b", "url": "https://github.com/elastic/elasticsearch/commit/d4d250f2a369c28d5f1f4d851edd8e24459c0c6b", "message": "Avoid OSS + UBI in ElasticsearchDistribution", "committedDate": "2020-08-14T10:04:53Z", "type": "commit"}, {"oid": "6a4ecf8393571163868124102a013c3dd8cc50a2", "url": "https://github.com/elastic/elasticsearch/commit/6a4ecf8393571163868124102a013c3dd8cc50a2", "message": "Formatting", "committedDate": "2020-08-14T10:27:24Z", "type": "commit"}, {"oid": "eea1bacf7a4c38c2f891f166c7db9618cd2afc2e", "url": "https://github.com/elastic/elasticsearch/commit/eea1bacf7a4c38c2f891f166c7db9618cd2afc2e", "message": "Add explanatory comment", "committedDate": "2020-08-14T19:06:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NzIzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470857235", "bodyText": "This doesn't appear to be used, since the same condition is written in isDocker above?", "author": "rjernst", "createdAt": "2020-08-14T20:46:06Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java", "diffHunk": "@@ -92,6 +95,10 @@ public boolean isDocker() {\n             this.extension = extension;\n             this.compatible = compatible;\n         }\n+\n+        public boolean isDocker() {", "originalCommit": "eea1bacf7a4c38c2f891f166c7db9618cd2afc2e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxOTUzOA==", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r471419538", "bodyText": "Ah, yeah, good catch.", "author": "pugnascotia", "createdAt": "2020-08-17T11:37:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NzIzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a964cdb701978fe1ac20957cce11748d096a1aa2", "chunk": "diff --git a/qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java b/qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java\nindex 1fd7805bda0..992335c9c2e 100644\n--- a/qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java\n+++ b/qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java\n\n@@ -95,10 +95,6 @@ public class Distribution {\n             this.extension = extension;\n             this.compatible = compatible;\n         }\n-\n-        public boolean isDocker() {\n-            return this == DOCKER || this == DOCKER_UBI;\n-        }\n     }\n \n     public enum Platform {\n"}}, {"oid": "a964cdb701978fe1ac20957cce11748d096a1aa2", "url": "https://github.com/elastic/elasticsearch/commit/a964cdb701978fe1ac20957cce11748d096a1aa2", "message": "Remove unnecessary isDocker method", "committedDate": "2020-08-17T11:36:48Z", "type": "commit"}, {"oid": "be65ee77050303fb0b2db4735d7aeb9de01a022e", "url": "https://github.com/elastic/elasticsearch/commit/be65ee77050303fb0b2db4735d7aeb9de01a022e", "message": "Merge branch 'master' into add-ubi-docker-builds", "committedDate": "2020-08-17T13:58:27Z", "type": "commit"}]}