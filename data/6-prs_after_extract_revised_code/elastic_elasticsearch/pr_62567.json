{"pr_number": 62567, "pr_title": "EQL: Disallow chained comparisons", "pr_createdAt": "2020-09-17T16:26:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62567", "timeline": [{"oid": "44bec4ad8388538f149001aa7106ee5df64a5784", "url": "https://github.com/elastic/elasticsearch/commit/44bec4ad8388538f149001aa7106ee5df64a5784", "message": "EQL: Disallow chained comparisons\n\nExpressions like `1 = 2 = 3 = 4` or `1 < 2 = 3 >= 4` were treated with\nleftmost priority: ((1 = 2) = 3) = 4 which can lead to confusing\nresults. Since such expressions don't make so much change for EQL\nfilters we disallow them in the parser to prevent unexpected results\nfrom their bad usage.\n\nMajor DBs like PostgreSQL and Oracle also disallow them in their SQL\nsyntax. (counter example would be MySQL which interprets them as we did\nbefore with leftmost priority).\n\nFixes: #61654", "committedDate": "2020-09-17T16:20:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5Nzk5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/62567#discussion_r490397997", "bodyText": "Can you add a test for something like 1 * 2 <= 3 * 4, just to make sure these operators are still playing nicely with precedence for other operators. Even better would be to verify the AST matches this: (1 * 2) <= (3 * 4)", "author": "rw-access", "createdAt": "2020-09-17T16:28:37Z", "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java", "diffHunk": "@@ -221,4 +221,25 @@ public void testInEmptySet() {\n         expectThrows(ParsingException.class, \"Expected syntax error\",\n             () -> expr(\"name in ()\"));\n     }\n+\n+    public void testChainedComparisons() {", "originalCommit": "44bec4ad8388538f149001aa7106ee5df64a5784", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2480ff92dc449d0b127c65eb956c7f5a8cc04eea", "chunk": "diff --git a/x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java b/x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java\nindex 564577e85683..b6cc95ea4e2c 100644\n--- a/x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java\n+++ b/x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java\n\n@@ -222,7 +223,25 @@ public class ExpressionTests extends ESTestCase {\n             () -> expr(\"name in ()\"));\n     }\n \n-    public void testChainedComparisons() {\n+    public void testComplexComparison() {\n+        String comparison;\n+        if (randomBoolean()) {\n+            comparison = \"1 * -2 <= -3 * 4\";\n+        } else {\n+            comparison = \"(1 * -2) <= (-3 * 4)\";\n+        }\n+\n+        Mul left = new Mul(null,\n+                new Literal(null, 1, DataTypes.INTEGER),\n+                new Neg(null, new Literal(null, 2, DataTypes.INTEGER)));\n+        Mul right = new Mul(null,\n+                new Neg(null, new Literal(null, 3, DataTypes.INTEGER)),\n+                new Literal(null, 4, DataTypes.INTEGER));\n+\n+        assertEquals(new LessThanOrEqual(null, left, right, UTC), expr(comparison));\n+    }\n+\n+    public void testChainedComparisonsDisallowed() {\n         int noComparisions = randomIntBetween(2, 20);\n         String firstComparator = \"\";\n         String secondComparator = \"\";\n"}}, {"oid": "2480ff92dc449d0b127c65eb956c7f5a8cc04eea", "url": "https://github.com/elastic/elasticsearch/commit/2480ff92dc449d0b127c65eb956c7f5a8cc04eea", "message": "add test", "committedDate": "2020-09-17T16:50:27Z", "type": "commit"}, {"oid": "ba8db83085c72175faf0a3eba7ca9f238e66a67f", "url": "https://github.com/elastic/elasticsearch/commit/ba8db83085c72175faf0a3eba7ca9f238e66a67f", "message": "revert parser prediction mode", "committedDate": "2020-09-17T16:55:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxNTUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/62567#discussion_r490415524", "bodyText": "could also do this, although it doesn't make assertions on what the underlying trees are, just that they are equivalent\nassertEquals(expr(\"1 * -2 <= -3 * 4\"), expr(\"(1 * -2) <= (-3 * 4)\"))", "author": "rw-access", "createdAt": "2020-09-17T16:56:02Z", "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/parser/ExpressionTests.java", "diffHunk": "@@ -221,4 +222,43 @@ public void testInEmptySet() {\n         expectThrows(ParsingException.class, \"Expected syntax error\",\n             () -> expr(\"name in ()\"));\n     }\n+\n+    public void testComplexComparison() {\n+        String comparison;\n+        if (randomBoolean()) {\n+            comparison = \"1 * -2 <= -3 * 4\";\n+        } else {\n+            comparison = \"(1 * -2) <= (-3 * 4)\";\n+        }\n+\n+        Mul left = new Mul(null,\n+                new Literal(null, 1, DataTypes.INTEGER),\n+                new Neg(null, new Literal(null, 2, DataTypes.INTEGER)));\n+        Mul right = new Mul(null,\n+                new Neg(null, new Literal(null, 3, DataTypes.INTEGER)),\n+                new Literal(null, 4, DataTypes.INTEGER));\n+\n+        assertEquals(new LessThanOrEqual(null, left, right, UTC), expr(comparison));", "originalCommit": "2480ff92dc449d0b127c65eb956c7f5a8cc04eea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "c38e5e7340087cfa28c7393d15f00c9351dbad63", "url": "https://github.com/elastic/elasticsearch/commit/c38e5e7340087cfa28c7393d15f00c9351dbad63", "message": "Merge remote-tracking branch 'upstream/master' into fix-61654", "committedDate": "2020-09-17T16:56:05Z", "type": "commit"}, {"oid": "a437240db976af8b4c4f0febd13c14c90ce152ef", "url": "https://github.com/elastic/elasticsearch/commit/a437240db976af8b4c4f0febd13c14c90ce152ef", "message": "rename new intermediate expression in grammar", "committedDate": "2020-09-17T19:52:36Z", "type": "commit"}, {"oid": "bc7f1e32614b8a9c8bb328a88001cb8329b487bb", "url": "https://github.com/elastic/elasticsearch/commit/bc7f1e32614b8a9c8bb328a88001cb8329b487bb", "message": "remove unused import", "committedDate": "2020-09-17T20:14:27Z", "type": "commit"}, {"oid": "9909a2300ebfb5503cee3f8aa18cfa237eb84626", "url": "https://github.com/elastic/elasticsearch/commit/9909a2300ebfb5503cee3f8aa18cfa237eb84626", "message": "Merge remote-tracking branch 'upstream/master' into fix-61654", "committedDate": "2020-09-18T07:13:55Z", "type": "commit"}]}