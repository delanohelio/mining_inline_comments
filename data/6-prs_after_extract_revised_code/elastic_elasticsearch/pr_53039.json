{"pr_number": 53039, "pr_title": "Avoid race condition in ILMHistorySotre", "pr_createdAt": "2020-03-02T23:23:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53039", "timeline": [{"oid": "ccc6d16e486e077a0b12b4130ac2fc20242bc2b8", "url": "https://github.com/elastic/elasticsearch/commit/ccc6d16e486e077a0b12b4130ac2fc20242bc2b8", "message": "Avoid race condition in ILMHistorySotre\n\nThis change modifies ILMHistoryStore to always apply correct settings and mappings,\neven if template is deleted and not yet recreated. This ensures that ILM history index\nis correctly managed by ILM and also fixes flaky history tests that were prone to\ntriggenring this race.\n\nThis commit also refactors and simplifies ILM history tests.\n\nCloses #50353 and #52853", "committedDate": "2020-03-02T23:09:32Z", "type": "commit"}, {"oid": "ad432c9cf5495d56dab4c6df9810830ab42a7055", "url": "https://github.com/elastic/elasticsearch/commit/ad432c9cf5495d56dab4c6df9810830ab42a7055", "message": "Merge branch 'master' into fix-ilmhistorystore", "committedDate": "2020-03-03T08:37:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4NzU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53039#discussion_r386987569", "bodyText": "super minor nit: \"templateAsMap\" or a name along those lines would be a bit more readable perhaps?", "author": "andreidan", "createdAt": "2020-03-03T12:29:59Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java", "diffHunk": "@@ -183,11 +188,19 @@ static void ensureHistoryIndex(Client client, ClusterState state, ActionListener\n         if (ilmHistory == null && initialHistoryIndex == null) {\n             // No alias or index exists with the expected names, so create the index with appropriate alias\n             logger.debug(\"creating ILM history index [{}]\", initialHistoryIndexName);\n+\n+            // Template below should be already defined as real index template but it can be deleted. To avoid race condition with its\n+            // recreation we apply settings and mappings ourselves\n+            byte[] templateBytes = TEMPLATE_ILM_HISTORY.loadBytes();\n+            Map<String, Object> map = XContentHelper.convertToMap(new BytesArray(templateBytes, 0, templateBytes.length),", "originalCommit": "ccc6d16e486e077a0b12b4130ac2fc20242bc2b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMyNjQzOA==", "url": "https://github.com/elastic/elasticsearch/pull/53039#discussion_r387326438", "bodyText": "Good idea, changed", "author": "probakowski", "createdAt": "2020-03-03T22:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4NzU2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "7a863902759fddb9abeadfb7faaf2762423ab29e", "chunk": "diff --git a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\nindex 19e05de1a03..cf80312c2d6 100644\n--- a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\n+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java\n\n@@ -192,12 +192,12 @@ public class ILMHistoryStore implements Closeable {\n             // Template below should be already defined as real index template but it can be deleted. To avoid race condition with its\n             // recreation we apply settings and mappings ourselves\n             byte[] templateBytes = TEMPLATE_ILM_HISTORY.loadBytes();\n-            Map<String, Object> map = XContentHelper.convertToMap(new BytesArray(templateBytes, 0, templateBytes.length),\n+            Map<String, Object> templateAsMap = XContentHelper.convertToMap(new BytesArray(templateBytes, 0, templateBytes.length),\n                 false, XContentType.JSON).v2();\n \n             client.admin().indices().prepareCreate(initialHistoryIndexName)\n-                .setSettings((Map<String, ?>) map.get(\"settings\"))\n-                .setMapping((Map<String, Object>) map.get(\"mappings\"))\n+                .setSettings((Map<String, ?>) templateAsMap.get(\"settings\"))\n+                .setMapping((Map<String, Object>) templateAsMap.get(\"mappings\"))\n                 .setWaitForActiveShards(1)\n                 .addAlias(new Alias(ILM_HISTORY_ALIAS).writeIndex(true))\n                 .execute(new ActionListener<>() {\n"}}, {"oid": "7a863902759fddb9abeadfb7faaf2762423ab29e", "url": "https://github.com/elastic/elasticsearch/commit/7a863902759fddb9abeadfb7faaf2762423ab29e", "message": "Review comment", "committedDate": "2020-03-03T22:12:51Z", "type": "commit"}, {"oid": "acde520bbca889838f5fc8ff1583a2e649d5bb61", "url": "https://github.com/elastic/elasticsearch/commit/acde520bbca889838f5fc8ff1583a2e649d5bb61", "message": "Merge branch 'master' into fix-ilmhistorystore", "committedDate": "2020-03-03T23:53:54Z", "type": "commit"}]}