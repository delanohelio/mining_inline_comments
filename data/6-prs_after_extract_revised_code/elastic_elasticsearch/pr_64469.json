{"pr_number": 64469, "pr_title": "Fix merging of terms aggregation with compound order", "pr_createdAt": "2020-11-02T11:40:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64469", "timeline": [{"oid": "faf33ed2985874c7fc9b4a33ac3618e5fbbbb921", "url": "https://github.com/elastic/elasticsearch/commit/faf33ed2985874c7fc9b4a33ac3618e5fbbbb921", "message": "Fix merging of terms aggregation with compound order\n\nThis change fixes a bug introduced in #61779 that uses a compound order to\ncompare buckets when merging. The bug is triggered when the compound order\nuses a primary sort ordered by key (asc or desc).\nThis commit ensures that we always extract the primary sort when comparing keys\nduring merging.\nThe PR is marked as no-issue since the bug has not been released in any official version.", "committedDate": "2020-11-02T11:39:20Z", "type": "commit"}, {"oid": "3b0a05e8765d8ad3cf1f1ec482e6d9151308660f", "url": "https://github.com/elastic/elasticsearch/commit/3b0a05e8765d8ad3cf1f1ec482e6d9151308660f", "message": "fix random dictionary", "committedDate": "2020-11-02T12:21:00Z", "type": "commit"}, {"oid": "c6844571f433e1355bb919fccb9beca471cb05e8", "url": "https://github.com/elastic/elasticsearch/commit/c6844571f433e1355bb919fccb9beca471cb05e8", "message": "checkstyl", "committedDate": "2020-11-02T12:42:21Z", "type": "commit"}, {"oid": "f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5", "url": "https://github.com/elastic/elasticsearch/commit/f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5", "message": "Merge branch 'master' into bugs/terms_compound_order", "committedDate": "2020-11-03T08:20:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTU2NA==", "url": "https://github.com/elastic/elasticsearch/pull/64469#discussion_r517471564", "bodyText": "Can dict be a local variable?", "author": "nik9000", "createdAt": "2020-11-04T16:28:39Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java", "diffHunk": "@@ -34,13 +34,26 @@\n import java.util.Set;\n \n public class StringTermsTests extends InternalTermsTestCase {\n+    private BytesRef[] dict;\n+\n+    public synchronized void generateRandomDict() {\n+        if (dict == null) {\n+            Set<BytesRef> terms = new HashSet<>();\n+            int numTerms = randomIntBetween(2, 100);\n+            for (int i = 0; i < numTerms; i++) {\n+                terms.add(new BytesRef(randomAlphaOfLength(10)));\n+            }\n+            dict = terms.stream().toArray(BytesRef[]::new);\n+        }\n+    }\n \n     @Override\n     protected InternalTerms<?, ?> createTestInstance(String name,\n                                                      Map<String, Object> metadata,\n                                                      InternalAggregations aggregations,\n                                                      boolean showTermDocCountError,\n                                                      long docCountError) {\n+        generateRandomDict();", "originalCommit": "f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3NDcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64469#discussion_r517474713", "bodyText": "I want to ensure that there are some equal keys in the instances that we try to merge so I build a single dictionary for the entire test suite. It could be easier if the class was not used by the AggregationTests.", "author": "jimczi", "createdAt": "2020-11-04T16:33:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4NDkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64469#discussion_r517484916", "bodyText": "Could you override randomResultsToReduce?", "author": "nik9000", "createdAt": "2020-11-04T16:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk0NjEwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64469#discussion_r517946107", "bodyText": "++,  I pushed 3777760", "author": "jimczi", "createdAt": "2020-11-05T10:29:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTU2NA=="}], "type": "inlineReview", "revised_code": {"commit": "a1e48bd76529f47db3cf6951848d54c05c5c8b4c", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java\nindex 0be516eca74..7a45d12b4f8 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java\n\n@@ -34,17 +34,19 @@ import java.util.Map;\n import java.util.Set;\n \n public class StringTermsTests extends InternalTermsTestCase {\n-    private BytesRef[] dict;\n+    private final BytesRef[] dict;\n \n-    public synchronized void generateRandomDict() {\n-        if (dict == null) {\n-            Set<BytesRef> terms = new HashSet<>();\n-            int numTerms = randomIntBetween(2, 100);\n-            for (int i = 0; i < numTerms; i++) {\n-                terms.add(new BytesRef(randomAlphaOfLength(10)));\n-            }\n-            dict = terms.stream().toArray(BytesRef[]::new);\n+    public StringTermsTests() {\n+        this.dict = generateRandomDict();\n+    }\n+\n+    private  BytesRef[] generateRandomDict() {\n+        Set<BytesRef> terms = new HashSet<>();\n+        int numTerms = randomIntBetween(2, 100);\n+        for (int i = 0; i < numTerms; i++) {\n+            terms.add(new BytesRef(randomAlphaOfLength(10)));\n         }\n+        return terms.stream().toArray(BytesRef[]::new);\n     }\n \n     @Override\n"}}, {"oid": "a1e48bd76529f47db3cf6951848d54c05c5c8b4c", "url": "https://github.com/elastic/elasticsearch/commit/a1e48bd76529f47db3cf6951848d54c05c5c8b4c", "message": "apply review", "committedDate": "2020-11-04T20:28:36Z", "type": "commit"}, {"oid": "22ae61b8c0003e09c7208c251d692456307e6c5e", "url": "https://github.com/elastic/elasticsearch/commit/22ae61b8c0003e09c7208c251d692456307e6c5e", "message": "Merge branch 'master' into bugs/terms_compound_order", "committedDate": "2020-11-04T20:28:51Z", "type": "commit"}, {"oid": "3777760966b73941679ef742ce86e7149c3bf6dd", "url": "https://github.com/elastic/elasticsearch/commit/3777760966b73941679ef742ce86e7149c3bf6dd", "message": "refactor tests to use a local variable", "committedDate": "2020-11-05T09:03:44Z", "type": "commit"}]}