{"pr_number": 55474, "pr_title": "Allow Deleting Multiple Snapshots at Once", "pr_createdAt": "2020-04-20T16:44:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55474", "timeline": [{"oid": "540ff1de306a07e08e1dac41d69a570cb1f2838f", "url": "https://github.com/elastic/elasticsearch/commit/540ff1de306a07e08e1dac41d69a570cb1f2838f", "message": "bck", "committedDate": "2019-11-28T09:09:42Z", "type": "commit"}, {"oid": "e8bfdaa362fbfa82aeef426aeae88d66ee004c9c", "url": "https://github.com/elastic/elasticsearch/commit/e8bfdaa362fbfa82aeef426aeae88d66ee004c9c", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-11-28T20:05:11Z", "type": "commit"}, {"oid": "32fb757a953f91c53e746eee3e68ead299042270", "url": "https://github.com/elastic/elasticsearch/commit/32fb757a953f91c53e746eee3e68ead299042270", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-02T10:05:01Z", "type": "commit"}, {"oid": "3067bc5585e3e47866b8121605e4afbb7151845d", "url": "https://github.com/elastic/elasticsearch/commit/3067bc5585e3e47866b8121605e4afbb7151845d", "message": "works", "committedDate": "2019-12-02T12:25:02Z", "type": "commit"}, {"oid": "add63fda3b00a7204239aa0c2d781c9b72fc149a", "url": "https://github.com/elastic/elasticsearch/commit/add63fda3b00a7204239aa0c2d781c9b72fc149a", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-02T12:25:18Z", "type": "commit"}, {"oid": "703e727482fddea6c9a25d51f12719877e4750bd", "url": "https://github.com/elastic/elasticsearch/commit/703e727482fddea6c9a25d51f12719877e4750bd", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-03T11:01:15Z", "type": "commit"}, {"oid": "ce320745ee5fbf2b16f240e9f3342242d5f4a6e0", "url": "https://github.com/elastic/elasticsearch/commit/ce320745ee5fbf2b16f240e9f3342242d5f4a6e0", "message": "bck", "committedDate": "2019-12-03T12:53:36Z", "type": "commit"}, {"oid": "7ff185109d46d6937502e23ca2bb95f32858f384", "url": "https://github.com/elastic/elasticsearch/commit/7ff185109d46d6937502e23ca2bb95f32858f384", "message": "bck", "committedDate": "2019-12-03T14:29:05Z", "type": "commit"}, {"oid": "5cf930b549019ccf23a1f202c749e97af3002ba0", "url": "https://github.com/elastic/elasticsearch/commit/5cf930b549019ccf23a1f202c749e97af3002ba0", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-03T14:29:24Z", "type": "commit"}, {"oid": "e7428e5f4ba630a9ec9df72f329f87184f958c20", "url": "https://github.com/elastic/elasticsearch/commit/e7428e5f4ba630a9ec9df72f329f87184f958c20", "message": "bck", "committedDate": "2019-12-03T14:43:13Z", "type": "commit"}, {"oid": "7588a93c2b18a1534fdf484e2d11eb682d2349b9", "url": "https://github.com/elastic/elasticsearch/commit/7588a93c2b18a1534fdf484e2d11eb682d2349b9", "message": "bck", "committedDate": "2019-12-03T15:16:53Z", "type": "commit"}, {"oid": "1984cc02c4bdd8ec0704b71411da8130bdbbf6a5", "url": "https://github.com/elastic/elasticsearch/commit/1984cc02c4bdd8ec0704b71411da8130bdbbf6a5", "message": "more multi", "committedDate": "2019-12-03T15:57:02Z", "type": "commit"}, {"oid": "e91a873b4a048718e972fbd243affa8b285cc001", "url": "https://github.com/elastic/elasticsearch/commit/e91a873b4a048718e972fbd243affa8b285cc001", "message": "works", "committedDate": "2019-12-03T16:37:45Z", "type": "commit"}, {"oid": "116f95f2e363344b4d4d3d6ed3af5e2616fc586b", "url": "https://github.com/elastic/elasticsearch/commit/116f95f2e363344b4d4d3d6ed3af5e2616fc586b", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-03T16:38:28Z", "type": "commit"}, {"oid": "e88145918b480ab6c919e336cb81a975904b9521", "url": "https://github.com/elastic/elasticsearch/commit/e88145918b480ab6c919e336cb81a975904b9521", "message": "bck", "committedDate": "2019-12-03T18:34:02Z", "type": "commit"}, {"oid": "2cc0c740d792d6e3453e23454434c4d31a119030", "url": "https://github.com/elastic/elasticsearch/commit/2cc0c740d792d6e3453e23454434c4d31a119030", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-10T08:05:49Z", "type": "commit"}, {"oid": "609daad56efedb87fa283d552c2cec2cc522432e", "url": "https://github.com/elastic/elasticsearch/commit/609daad56efedb87fa283d552c2cec2cc522432e", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-10T12:03:00Z", "type": "commit"}, {"oid": "e72a50bfc6778bbf16b48c39be1c02b69a73877b", "url": "https://github.com/elastic/elasticsearch/commit/e72a50bfc6778bbf16b48c39be1c02b69a73877b", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-10T13:36:44Z", "type": "commit"}, {"oid": "ffe5adb5f0ca70f6f03101fd23a82491ed8346fa", "url": "https://github.com/elastic/elasticsearch/commit/ffe5adb5f0ca70f6f03101fd23a82491ed8346fa", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-10T16:26:57Z", "type": "commit"}, {"oid": "488f4e702631f6f03dde072b4a499fe40bbab0c1", "url": "https://github.com/elastic/elasticsearch/commit/488f4e702631f6f03dde072b4a499fe40bbab0c1", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-12T10:11:18Z", "type": "commit"}, {"oid": "92ab9d575ba06021e3afea6863305c84e64e7b03", "url": "https://github.com/elastic/elasticsearch/commit/92ab9d575ba06021e3afea6863305c84e64e7b03", "message": "bck", "committedDate": "2019-12-12T11:09:46Z", "type": "commit"}, {"oid": "f192cb5ea7cc60477cfb1b9b1518dbfdf4461e41", "url": "https://github.com/elastic/elasticsearch/commit/f192cb5ea7cc60477cfb1b9b1518dbfdf4461e41", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot", "committedDate": "2019-12-12T14:55:26Z", "type": "commit"}, {"oid": "821c36ae3b96f4c0b736b6c58dbc180029b97eb8", "url": "https://github.com/elastic/elasticsearch/commit/821c36ae3b96f4c0b736b6c58dbc180029b97eb8", "message": "bck", "committedDate": "2019-12-12T15:21:34Z", "type": "commit"}, {"oid": "522b6fa1350e4768a5d14134916677e8ee733086", "url": "https://github.com/elastic/elasticsearch/commit/522b6fa1350e4768a5d14134916677e8ee733086", "message": "drop it for now", "committedDate": "2019-12-12T15:28:19Z", "type": "commit"}, {"oid": "d9bd055a724f946948fabdd35997ca29f9410e73", "url": "https://github.com/elastic/elasticsearch/commit/d9bd055a724f946948fabdd35997ca29f9410e73", "message": "Merge branch 'multi-delete-snapshot' into multi-delete-snapshot-v2", "committedDate": "2020-04-20T13:24:50Z", "type": "commit"}, {"oid": "0e074040fb9cbda6cb9b0fff0096f4f92d897d67", "url": "https://github.com/elastic/elasticsearch/commit/0e074040fb9cbda6cb9b0fff0096f4f92d897d67", "message": "fixed", "committedDate": "2020-04-20T13:44:30Z", "type": "commit"}, {"oid": "4d1b3c8e4aa7eabf30e8c9de97ac6f2e8256586c", "url": "https://github.com/elastic/elasticsearch/commit/4d1b3c8e4aa7eabf30e8c9de97ac6f2e8256586c", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-20T14:33:57Z", "type": "commit"}, {"oid": "b4123baeabdb86934b2be2414b0e55963ea446ae", "url": "https://github.com/elastic/elasticsearch/commit/b4123baeabdb86934b2be2414b0e55963ea446ae", "message": "dead code", "committedDate": "2020-04-20T14:42:15Z", "type": "commit"}, {"oid": "75d2eef25efc8702fb45a43c5cfe18241469c686", "url": "https://github.com/elastic/elasticsearch/commit/75d2eef25efc8702fb45a43c5cfe18241469c686", "message": "mroe stuff", "committedDate": "2020-04-20T15:22:57Z", "type": "commit"}, {"oid": "4f5ff303c946d6e0e8a53bcc5d41f9da7ccf1695", "url": "https://github.com/elastic/elasticsearch/commit/4f5ff303c946d6e0e8a53bcc5d41f9da7ccf1695", "message": "fixes", "committedDate": "2020-04-20T15:46:50Z", "type": "commit"}, {"oid": "bf170bfb5836c4d33f68b1691c0eacd6f8385628", "url": "https://github.com/elastic/elasticsearch/commit/bf170bfb5836c4d33f68b1691c0eacd6f8385628", "message": "nicer", "committedDate": "2020-04-20T15:54:48Z", "type": "commit"}, {"oid": "8c0db754257782fc39aa5e7e240306a6c5b9b30a", "url": "https://github.com/elastic/elasticsearch/commit/8c0db754257782fc39aa5e7e240306a6c5b9b30a", "message": "nicer", "committedDate": "2020-04-20T16:14:30Z", "type": "commit"}, {"oid": "21bc7564d53c50ec8784a7ba342722380f7d460f", "url": "https://github.com/elastic/elasticsearch/commit/21bc7564d53c50ec8784a7ba342722380f7d460f", "message": "works better", "committedDate": "2020-04-20T16:43:34Z", "type": "commit"}, {"oid": "841e0160e21aff90bdbdfb2156aaf514ac8135ee", "url": "https://github.com/elastic/elasticsearch/commit/841e0160e21aff90bdbdfb2156aaf514ac8135ee", "message": "simpler", "committedDate": "2020-04-20T16:46:48Z", "type": "commit"}, {"oid": "5cd97062e2e0493bec2a08b901ec1b5d07e54834", "url": "https://github.com/elastic/elasticsearch/commit/5cd97062e2e0493bec2a08b901ec1b5d07e54834", "message": "nicer", "committedDate": "2020-04-20T16:51:46Z", "type": "commit"}, {"oid": "36dd5d51811a7eabfe015e1fba7742f72747a4d0", "url": "https://github.com/elastic/elasticsearch/commit/36dd5d51811a7eabfe015e1fba7742f72747a4d0", "message": "fixes", "committedDate": "2020-04-20T18:48:28Z", "type": "commit"}, {"oid": "3772426297448d64ea3258d03ecc7b5ca02beebf", "url": "https://github.com/elastic/elasticsearch/commit/3772426297448d64ea3258d03ecc7b5ca02beebf", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-20T18:50:04Z", "type": "commit"}, {"oid": "4b7f76b445519dbed96c10a53aeafd37a06c7dee", "url": "https://github.com/elastic/elasticsearch/commit/4b7f76b445519dbed96c10a53aeafd37a06c7dee", "message": "shorter diff", "committedDate": "2020-04-20T19:08:23Z", "type": "commit"}, {"oid": "a85f127bf38f41ee465406d81d092d75d88aea01", "url": "https://github.com/elastic/elasticsearch/commit/a85f127bf38f41ee465406d81d092d75d88aea01", "message": "revert naming stuff", "committedDate": "2020-04-20T19:13:17Z", "type": "commit"}, {"oid": "e0775d489fd5fbaffd209c4b4ba2cea4cd117c7a", "url": "https://github.com/elastic/elasticsearch/commit/e0775d489fd5fbaffd209c4b4ba2cea4cd117c7a", "message": "assert", "committedDate": "2020-04-20T19:16:59Z", "type": "commit"}, {"oid": "b894d580e03f4bd64e08f4def68278212fa06e5e", "url": "https://github.com/elastic/elasticsearch/commit/b894d580e03f4bd64e08f4def68278212fa06e5e", "message": "shorter diff", "committedDate": "2020-04-20T19:51:35Z", "type": "commit"}, {"oid": "e6d51899c4850616f52bbf10d30f55108c9f1f90", "url": "https://github.com/elastic/elasticsearch/commit/e6d51899c4850616f52bbf10d30f55108c9f1f90", "message": "shorter diff", "committedDate": "2020-04-20T19:59:57Z", "type": "commit"}, {"oid": "44cf43286aa2467256e24dcbae357b03559ee74c", "url": "https://github.com/elastic/elasticsearch/commit/44cf43286aa2467256e24dcbae357b03559ee74c", "message": "shorter diff", "committedDate": "2020-04-20T20:00:54Z", "type": "commit"}, {"oid": "7002a15c089bd080d4242fdb6d6ba8b17a2a2eb6", "url": "https://github.com/elastic/elasticsearch/commit/7002a15c089bd080d4242fdb6d6ba8b17a2a2eb6", "message": "shorter diff", "committedDate": "2020-04-20T20:02:12Z", "type": "commit"}, {"oid": "bda3e6e3a3d3da5aafcd7ff96359595d2970b149", "url": "https://github.com/elastic/elasticsearch/commit/bda3e6e3a3d3da5aafcd7ff96359595d2970b149", "message": "shorter diff", "committedDate": "2020-04-20T20:04:13Z", "type": "commit"}, {"oid": "b84152803fdec34a6c3f0f416beecee1a437d60e", "url": "https://github.com/elastic/elasticsearch/commit/b84152803fdec34a6c3f0f416beecee1a437d60e", "message": "shorter diff", "committedDate": "2020-04-20T20:06:07Z", "type": "commit"}, {"oid": "e02710e0e873232e162bb63b1236940dfacda132", "url": "https://github.com/elastic/elasticsearch/commit/e02710e0e873232e162bb63b1236940dfacda132", "message": "shorter diff", "committedDate": "2020-04-20T20:06:54Z", "type": "commit"}, {"oid": "9d6bfb5f4cce77bc35e17573fbf6912843de5ab3", "url": "https://github.com/elastic/elasticsearch/commit/9d6bfb5f4cce77bc35e17573fbf6912843de5ab3", "message": "shorter diff", "committedDate": "2020-04-20T20:08:15Z", "type": "commit"}, {"oid": "4cb1dd52eeb017e212b587c1c055132fe96a2179", "url": "https://github.com/elastic/elasticsearch/commit/4cb1dd52eeb017e212b587c1c055132fe96a2179", "message": "shorter diff", "committedDate": "2020-04-20T20:11:23Z", "type": "commit"}, {"oid": "b9171d599b46509c328961ea9cb169468e971631", "url": "https://github.com/elastic/elasticsearch/commit/b9171d599b46509c328961ea9cb169468e971631", "message": "shorter diff", "committedDate": "2020-04-20T20:12:30Z", "type": "commit"}, {"oid": "f4ca634f2f3b678c3a3ceab1425b52d77c274424", "url": "https://github.com/elastic/elasticsearch/commit/f4ca634f2f3b678c3a3ceab1425b52d77c274424", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-21T06:28:07Z", "type": "commit"}, {"oid": "bf48d12fd6b1e36037e1a98d61e18d1ada85092f", "url": "https://github.com/elastic/elasticsearch/commit/bf48d12fd6b1e36037e1a98d61e18d1ada85092f", "message": "shorter diff", "committedDate": "2020-04-21T06:31:02Z", "type": "commit"}, {"oid": "eada6f28400a1062af859789eae4050a85c760de", "url": "https://github.com/elastic/elasticsearch/commit/eada6f28400a1062af859789eae4050a85c760de", "message": "shorter diff", "committedDate": "2020-04-21T06:32:24Z", "type": "commit"}, {"oid": "8440aef3c3c10e56a4290ed5abd1f30e5f10bd10", "url": "https://github.com/elastic/elasticsearch/commit/8440aef3c3c10e56a4290ed5abd1f30e5f10bd10", "message": "fix docs", "committedDate": "2020-04-21T06:34:11Z", "type": "commit"}, {"oid": "151ae507f758c434ad731158542413bef4436800", "url": "https://github.com/elastic/elasticsearch/commit/151ae507f758c434ad731158542413bef4436800", "message": "docs", "committedDate": "2020-04-21T06:40:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMzc3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r411913773", "bodyText": "String, String... is really dirty I know, but it's a massive change-set to adjust this API since we use it in so many places in tests so I figured I'd keep it this way for now.", "author": "original-brownbear", "createdAt": "2020-04-21T06:44:45Z", "path": "server/src/main/java/org/elasticsearch/client/ClusterAdminClient.java", "diffHunk": "@@ -529,7 +529,7 @@\n     /**\n      * Delete snapshot.\n      */\n-    DeleteSnapshotRequestBuilder prepareDeleteSnapshot(String repository, String snapshot);\n+    DeleteSnapshotRequestBuilder prepareDeleteSnapshot(String repository, String... snapshot);", "originalCommit": "151ae507f758c434ad731158542413bef4436800", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "8bfb7b2079dce60887cc75b8b455281aa5cdf52b", "url": "https://github.com/elastic/elasticsearch/commit/8bfb7b2079dce60887cc75b8b455281aa5cdf52b", "message": "rearrange stuff", "committedDate": "2020-04-21T06:56:01Z", "type": "commit"}, {"oid": "a12e52070e5c69db09a386192fcf93e876190b60", "url": "https://github.com/elastic/elasticsearch/commit/a12e52070e5c69db09a386192fcf93e876190b60", "message": "shorter", "committedDate": "2020-04-21T07:04:41Z", "type": "commit"}, {"oid": "2ebf708965e28045302904e1fd2f9a2880dce2f7", "url": "https://github.com/elastic/elasticsearch/commit/2ebf708965e28045302904e1fd2f9a2880dce2f7", "message": "some improvemnts", "committedDate": "2020-04-21T07:24:49Z", "type": "commit"}, {"oid": "0a392ec6366a25bb746820a87f0766b0d93a11da", "url": "https://github.com/elastic/elasticsearch/commit/0a392ec6366a25bb746820a87f0766b0d93a11da", "message": "some improvemnts", "committedDate": "2020-04-21T07:34:16Z", "type": "commit"}, {"oid": "704d984a21fc46d9163e6cab814d6e47b73542aa", "url": "https://github.com/elastic/elasticsearch/commit/704d984a21fc46d9163e6cab814d6e47b73542aa", "message": "lets keep it simple", "committedDate": "2020-04-21T08:25:30Z", "type": "commit"}, {"oid": "ebf4599efd97cead834988d6dc47a7e2e4202d0d", "url": "https://github.com/elastic/elasticsearch/commit/ebf4599efd97cead834988d6dc47a7e2e4202d0d", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-21T10:46:59Z", "type": "commit"}, {"oid": "b41bab3838ecd231ca4a17d4466118210d88ded6", "url": "https://github.com/elastic/elasticsearch/commit/b41bab3838ecd231ca4a17d4466118210d88ded6", "message": "update javadoc wording", "committedDate": "2020-04-21T10:48:23Z", "type": "commit"}, {"oid": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "url": "https://github.com/elastic/elasticsearch/commit/c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-21T14:26:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2ODkzNw==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412768937", "bodyText": "Can you make this use varargs instead?", "author": "ywelsch", "createdAt": "2020-04-22T08:13:37Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequest.java", "diffHunk": "@@ -54,8 +54,18 @@ public DeleteSnapshotRequest() {\n      * @param snapshot   snapshot name\n      */\n     public DeleteSnapshotRequest(String repository, String snapshot) {\n+        this(repository, new String[]{snapshot});\n+    }\n+\n+        /**\n+         * Constructs a new delete snapshots request with repository and snapshot name\n+         *\n+         * @param repository repository name\n+         * @param snapshots  snapshot names\n+         */\n+    public DeleteSnapshotRequest(String repository, String[] snapshots) {", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyNjg3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412826872", "bodyText": "Jup done :)", "author": "original-brownbear", "createdAt": "2020-04-22T09:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2ODkzNw=="}], "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequest.java b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequest.java\nindex 504d2d94da8..6089e7ab151 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequest.java\n\n@@ -48,22 +48,12 @@ public class DeleteSnapshotRequest extends MasterNodeRequest<DeleteSnapshotReque\n     }\n \n     /**\n-     * Constructs a new delete snapshots request with repository and snapshot name\n+     * Constructs a new delete snapshots request with repository and snapshot names\n      *\n      * @param repository repository name\n-     * @param snapshot   snapshot name\n+     * @param snapshots  snapshot names\n      */\n-    public DeleteSnapshotRequest(String repository, String snapshot) {\n-        this(repository, new String[]{snapshot});\n-    }\n-\n-        /**\n-         * Constructs a new delete snapshots request with repository and snapshot name\n-         *\n-         * @param repository repository name\n-         * @param snapshots  snapshot names\n-         */\n-    public DeleteSnapshotRequest(String repository, String[] snapshots) {\n+    public DeleteSnapshotRequest(String repository, String... snapshots) {\n         this.repository = repository;\n         this.snapshots = snapshots;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3MTIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412771219", "bodyText": "use varargs here as well in case clients are using this directly (transportt client in 7.x)", "author": "ywelsch", "createdAt": "2020-04-22T08:16:43Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequestBuilder.java", "diffHunk": "@@ -39,8 +39,8 @@ public DeleteSnapshotRequestBuilder(ElasticsearchClient client, DeleteSnapshotAc\n     /**\n      * Constructs delete snapshot request builder with specified repository and snapshot names\n      */\n-    public DeleteSnapshotRequestBuilder(ElasticsearchClient client, DeleteSnapshotAction action, String repository, String snapshot) {\n-        super(client, action, new DeleteSnapshotRequest(repository, snapshot));\n+    public DeleteSnapshotRequestBuilder(ElasticsearchClient client, DeleteSnapshotAction action, String repository, String[] snapshots) {", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyNjk0MA==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412826940", "bodyText": "done", "author": "original-brownbear", "createdAt": "2020-04-22T09:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3MTIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequestBuilder.java b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequestBuilder.java\nindex 2e9556d2dfc..ac429d85269 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequestBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/delete/DeleteSnapshotRequestBuilder.java\n\n@@ -39,7 +39,7 @@ public class DeleteSnapshotRequestBuilder extends MasterNodeOperationRequestBuil\n     /**\n      * Constructs delete snapshot request builder with specified repository and snapshot names\n      */\n-    public DeleteSnapshotRequestBuilder(ElasticsearchClient client, DeleteSnapshotAction action, String repository, String[] snapshots) {\n+    public DeleteSnapshotRequestBuilder(ElasticsearchClient client, DeleteSnapshotAction action, String repository, String... snapshots) {\n         super(client, action, new DeleteSnapshotRequest(repository, snapshots));\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3MzYyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412773620", "bodyText": "varargs", "author": "ywelsch", "createdAt": "2020-04-22T08:20:07Z", "path": "server/src/main/java/org/elasticsearch/client/Requests.java", "diffHunk": "@@ -502,14 +502,14 @@ public static RestoreSnapshotRequest restoreSnapshotRequest(String repository, S\n     }\n \n     /**\n-     * Deletes a snapshot\n+     * Deletes snapshots\n      *\n-     * @param snapshot   snapshot name\n+     * @param snapshots  snapshot names\n      * @param repository repository name\n      * @return delete snapshot request\n      */\n-    public static DeleteSnapshotRequest deleteSnapshotRequest(String repository, String snapshot) {\n-        return new DeleteSnapshotRequest(repository, snapshot);\n+    public static DeleteSnapshotRequest deleteSnapshotRequest(String repository, String[] snapshots) {", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyNjk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412826993", "bodyText": "done", "author": "original-brownbear", "createdAt": "2020-04-22T09:34:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3MzYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/client/Requests.java b/server/src/main/java/org/elasticsearch/client/Requests.java\nindex f512ad8ea35..445c1935fad 100644\n--- a/server/src/main/java/org/elasticsearch/client/Requests.java\n+++ b/server/src/main/java/org/elasticsearch/client/Requests.java\n\n@@ -508,7 +508,7 @@ public class Requests {\n      * @param repository repository name\n      * @return delete snapshot request\n      */\n-    public static DeleteSnapshotRequest deleteSnapshotRequest(String repository, String[] snapshots) {\n+    public static DeleteSnapshotRequest deleteSnapshotRequest(String repository, String... snapshots) {\n         return new DeleteSnapshotRequest(repository, snapshots);\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3NjgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412776807", "bodyText": "why did you opt for having one entry for multiple snapshots? Should we rather have one entry per snapshot that is to be deleted?\nIf we build it that way, could it allow us to queue up multiple deletes in the future?", "author": "ywelsch", "createdAt": "2020-04-22T08:24:29Z", "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotDeletionsInProgress.java", "diffHunk": "@@ -167,29 +173,35 @@ public String toString() {\n      * A class representing a snapshot deletion request entry in the cluster state.\n      */\n     public static final class Entry implements Writeable, RepositoryOperation {\n-        private final Snapshot snapshot;\n+        private final List<SnapshotId> snapshots;", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgxOTE1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412819155", "bodyText": "why did you opt for having one entry for multiple snapshots?\n\nI thought about that actually. What I didn't like about it, was that it introduced quite a bit of duplication in what is stored in the cluster state. We'd be adding a bunch of deletes with the same start time, repository and generation to then batch them up again when it comes to running the actual delete.\n\nIf we build it that way, could it allow us to queue up multiple deletes in the future?\n\nI don't think that makes things easier for queuing up deletes. My thinking is this:\nA delete will always move us from a set of snapshots to another set of snapshots and move the repository generation ahead by 1. It has a defined point in time where it starts (delete entry is processed in the cluster state) and a defined repository state from which it starts. We cannot add to the delete while it is running against the repo as that's an atomic operation also.\nSo if we were to add deletes by just adding entries, then we'll have to queue up new deletes at a generation higher than the lowest generation of existing deletes (the lowest generation is already processing in the repository so we can't add to it).\n=> I figured I'd rather be explicit about how deletes get batched together than do some implicit magic around the repository generations here.\nWith the way it is now, we can queue up deletes very nicely IMO: If there is only a single delete entry in the CS, we add a new entry because that one is already processing on the repo. If there are multiple delete entries we can add the additional snapshots we want to delete to the second one (that we know isn't processing yet).", "author": "original-brownbear", "createdAt": "2020-04-22T09:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3NjgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY1NzU4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r413657585", "bodyText": "ok, makes sense", "author": "ywelsch", "createdAt": "2020-04-23T09:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc3NjgwNw=="}], "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/SnapshotDeletionsInProgress.java b/server/src/main/java/org/elasticsearch/cluster/SnapshotDeletionsInProgress.java\nindex 49cacaea019..bb08309896b 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/SnapshotDeletionsInProgress.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/SnapshotDeletionsInProgress.java\n\n@@ -180,6 +181,7 @@ public class SnapshotDeletionsInProgress extends AbstractNamedDiffable<Custom> i\n \n         public Entry(List<SnapshotId> snapshots, String repoName, long startTime, long repositoryStateId) {\n             this.snapshots = snapshots;\n+            assert snapshots.size() == new HashSet<>(snapshots).size() : \"Duplicate snapshot ids in \" + snapshots;\n             this.repoName = repoName;\n             this.startTime = startTime;\n             this.repositoryStateId = repositoryStateId;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4ODE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412788194", "bodyText": "do we need to throw a Concurrent...Exception in case where there is SnapshotsInProgress.Entry but we did not look at aborting it?", "author": "ywelsch", "createdAt": "2020-04-22T08:40:02Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -993,8 +999,23 @@ public void deleteSnapshot(final String repositoryName, final String snapshotNam\n \n             @Override\n             public ClusterState execute(ClusterState currentState) {\n+                if (snapshotNames.size() > 1 && currentState.nodes().getMinNodeVersion().before(MULTI_DELETE_VERSION)) {\n+                    throw new IllegalArgumentException(\"Deleting multiple snapshots in a single request is only supported in version [ \"\n+                            + MULTI_DELETE_VERSION + \"] but cluster contained node of version [\" + currentState.nodes().getMinNodeVersion()\n+                            + \"]\");\n+                }\n                 final SnapshotsInProgress snapshots = currentState.custom(SnapshotsInProgress.TYPE);\n-                final SnapshotsInProgress.Entry snapshotEntry = findInProgressSnapshot(snapshots, snapshotName, repositoryName);\n+                final SnapshotsInProgress.Entry snapshotEntry;\n+                if (snapshotNames.size() == 1) {\n+                    final String snapshotName = snapshotNames.iterator().next();\n+                    if (Regex.isSimpleMatchPattern(snapshotName)) {\n+                        snapshotEntry = null;\n+                    } else {\n+                        snapshotEntry = findInProgressSnapshot(snapshots, snapshotName, repositoryName);\n+                    }\n+                } else {\n+                    snapshotEntry = null;", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgwMjczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412802739", "bodyText": "We do that check in deleteCompletedSnapshots so we don't need it here.\nTechnically we could add it here as well, but now that we cache RepositoryData it wouldn't do much to duplicate it here (we have to run it again before putting the delete entry into the CS anyway) except for saving a noop CS update task in case of a concurrent snapshot. -> I figured I'd not duplicate logic.", "author": "original-brownbear", "createdAt": "2020-04-22T08:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4ODE5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4OTQzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412789431", "bodyText": "do we need a set? Isn't there a risk that we're adding the same item multiple times if there are overlapping wildcards?", "author": "ywelsch", "createdAt": "2020-04-22T08:41:45Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1109,6 +1118,30 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n         });\n     }\n \n+    private static List<SnapshotId> matchingSnapshotIds(RepositoryData repositoryData, Collection<String> snapshotsOrPatterns,\n+                                                        String repositoryName) {\n+        final Map<String, SnapshotId> allSnapshotIds = repositoryData.getSnapshotIds().stream().collect(\n+                Collectors.toMap(SnapshotId::getName, Function.identity()));\n+        final List<SnapshotId> foundSnapshots = new ArrayList<>();\n+        for (String snapshotOrPattern : snapshotsOrPatterns) {\n+            if (Regex.isSimpleMatchPattern(snapshotOrPattern) == false) {\n+                final SnapshotId foundId = allSnapshotIds.get(snapshotOrPattern);\n+                if (foundId == null) {\n+                    throw new SnapshotMissingException(repositoryName, snapshotOrPattern);\n+                } else {\n+                    foundSnapshots.add(allSnapshotIds.get(snapshotOrPattern));\n+                }\n+            } else {\n+                for (Map.Entry<String, SnapshotId> entry : allSnapshotIds.entrySet()) {\n+                    if (Regex.simpleMatch(snapshotOrPattern, entry.getKey())) {\n+                        foundSnapshots.add(entry.getValue());", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjgyNjU3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412826570", "bodyText": "Right ... my bad fixed + added an assertion and test that would've tripped it to cover this.", "author": "original-brownbear", "createdAt": "2020-04-22T09:33:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4OTQzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\nindex 4fbf4f68778..5e00ddbd545 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\n\n@@ -1122,7 +1122,7 @@ public class SnapshotsService extends AbstractLifecycleComponent implements Clus\n                                                         String repositoryName) {\n         final Map<String, SnapshotId> allSnapshotIds = repositoryData.getSnapshotIds().stream().collect(\n                 Collectors.toMap(SnapshotId::getName, Function.identity()));\n-        final List<SnapshotId> foundSnapshots = new ArrayList<>();\n+        final Set<SnapshotId> foundSnapshots = new HashSet<>();\n         for (String snapshotOrPattern : snapshotsOrPatterns) {\n             if (Regex.isSimpleMatchPattern(snapshotOrPattern) == false) {\n                 final SnapshotId foundId = allSnapshotIds.get(snapshotOrPattern);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc5MDY4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55474#discussion_r412790685", "bodyText": "add a note that this should only be done once all nodes are on >= minVersion.", "author": "ywelsch", "createdAt": "2020-04-22T08:43:31Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java", "diffHunk": "@@ -362,6 +362,7 @@ void deleteSnapshots(Map<String, List<SnapshotInfo>> snapshotsToDelete,\n             for (SnapshotInfo info : snapshots) {\n                 final String policyId = getPolicyId(info);\n                 final long deleteStartTime = nowNanoSupplier.getAsLong();\n+                // TODO: Use snapshot multi-delete instead of this loop", "originalCommit": "c413dd983b5b316bdaf6daf0bc9cfb19714c90f1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "chunk": "diff --git a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java\nindex b8b4c644922..0e1725ed22b 100644\n--- a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java\n+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotRetentionTask.java\n\n@@ -362,7 +362,8 @@ public class SnapshotRetentionTask implements SchedulerEngine.Listener {\n             for (SnapshotInfo info : snapshots) {\n                 final String policyId = getPolicyId(info);\n                 final long deleteStartTime = nowNanoSupplier.getAsLong();\n-                // TODO: Use snapshot multi-delete instead of this loop\n+                // TODO: Use snapshot multi-delete instead of this loop if all nodes in the cluster support it\n+                //       i.e are newer or equal to SnapshotsService#MULTI_DELETE_VERSION\n                 deleteSnapshot(policyId, repo, info.snapshotId(), slmStats, ActionListener.wrap(acknowledgedResponse -> {\n                     deleted.incrementAndGet();\n                     if (acknowledgedResponse.isAcknowledged()) {\n"}}, {"oid": "d2da9bc63b3ea2e985011dc4bd173fe18c3527f1", "url": "https://github.com/elastic/elasticsearch/commit/d2da9bc63b3ea2e985011dc4bd173fe18c3527f1", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-22T08:49:15Z", "type": "commit"}, {"oid": "0efa76fadc5079cfa396290818b45f2d352ad9cb", "url": "https://github.com/elastic/elasticsearch/commit/0efa76fadc5079cfa396290818b45f2d352ad9cb", "message": "CR comments", "committedDate": "2020-04-22T09:33:02Z", "type": "commit"}, {"oid": "53bd7a7d274450360db21cca348b395e70e02d4b", "url": "https://github.com/elastic/elasticsearch/commit/53bd7a7d274450360db21cca348b395e70e02d4b", "message": "Merge remote-tracking branch 'elastic/master' into multi-delete-snapshot-v2", "committedDate": "2020-04-23T09:46:21Z", "type": "commit"}]}