{"pr_number": 54852, "pr_title": "Lazy test cluster module and plugins", "pr_createdAt": "2020-04-07T00:41:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54852", "timeline": [{"oid": "daf3d1a7ba065e358fbd9539bd53639b1bdad473", "url": "https://github.com/elastic/elasticsearch/commit/daf3d1a7ba065e358fbd9539bd53639b1bdad473", "message": "initial commit", "committedDate": "2020-04-07T00:07:40Z", "type": "commit"}, {"oid": "95cff57223b256ed01ecc4e55757c782d4f6aaaf", "url": "https://github.com/elastic/elasticsearch/commit/95cff57223b256ed01ecc4e55757c782d4f6aaaf", "message": "clean up", "committedDate": "2020-04-07T00:37:09Z", "type": "commit"}, {"oid": "b3068d11c6975222ee200c2857c0a4ab96c9b126", "url": "https://github.com/elastic/elasticsearch/commit/b3068d11c6975222ee200c2857c0a4ab96c9b126", "message": "move plugin dependency back to afterEvaluate", "committedDate": "2020-04-07T01:14:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NDY1MA==", "url": "https://github.com/elastic/elasticsearch/pull/54852#discussion_r405054650", "bodyText": "I think it could simplify some of the other code here if we just made this.modules a List<Provider<File>> and called module.getAsFile() here rather than having to do getAsFile() in a bunch of other places.", "author": "mark-vieira", "createdAt": "2020-04-07T19:21:17Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -267,13 +270,30 @@ public void plugin(URI plugin) {\n         this.plugins.add(plugin);\n     }\n \n+    @Override\n+    public void plugin(Provider<RegularFile> plugin) {\n+        this.plugin(() -> plugin.get().getAsFile().toURI());\n+    }\n+\n+    @Override\n+    public void plugin(URI plugin) {\n+        this.plugin(() -> plugin);\n+    }\n+\n     @Override\n     public void plugin(File plugin) {\n-        plugin(plugin.toURI());\n+        this.plugin(() -> plugin.toURI());\n     }\n \n     @Override\n     public void module(File module) {\n+        RegularFileProperty file = project.getObjects().fileProperty();\n+        file.fileValue(module);\n+        this.module(file);\n+    }\n+\n+    @Override\n+    public void module(Provider<RegularFile> module) {\n         this.modules.add(module);", "originalCommit": "b3068d11c6975222ee200c2857c0a4ab96c9b126", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0MzMyOA==", "url": "https://github.com/elastic/elasticsearch/pull/54852#discussion_r405643328", "bodyText": "Done.  (not exactly as stated, but the backing list is now a Provider<File> and a module.map(RegularFile::getAsFile) is used to lazily convert the type.", "author": "jakelandis", "createdAt": "2020-04-08T16:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA1NDY1MA=="}], "type": "inlineReview", "revised_code": {"commit": "73427ab3692e08fd17b78d5a5c53490f2dc7b8cc", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java\nindex c746989fbe49..e2fd8586b277 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java\n\n@@ -270,19 +271,18 @@ public class ElasticsearchNode implements TestClusterConfiguration {\n         this.plugins.add(plugin);\n     }\n \n-    @Override\n-    public void plugin(Provider<RegularFile> plugin) {\n-        this.plugin(() -> plugin.get().getAsFile().toURI());\n-    }\n-\n     @Override\n     public void plugin(URI plugin) {\n-        this.plugin(() -> plugin);\n+        Property<URI> uri = project.getObjects().property(URI.class);\n+        uri.set(plugin);\n+        this.plugin(uri);\n     }\n \n     @Override\n     public void plugin(File plugin) {\n-        this.plugin(() -> plugin.toURI());\n+        Property<URI> uri = project.getObjects().property(URI.class);\n+        uri.set(plugin.toURI());\n+        this.plugin(uri);\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTQwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54852#discussion_r405161405", "bodyText": "Why do we also need this Supplier variant? Seems inconsistent to have it for plugin but not module.", "author": "rjernst", "createdAt": "2020-04-07T22:56:53Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClusterConfiguration.java", "diffHunk": "@@ -46,8 +48,14 @@\n \n     void plugin(File plugin);\n \n+    void plugin(Supplier<URI> plugin);", "originalCommit": "b3068d11c6975222ee200c2857c0a4ab96c9b126", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NDA3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54852#discussion_r405184077", "bodyText": "Seems we do this so we can internally keep this as a List<Supplier<URI>>. I think we can ditch this and use Provider<URI> for the internal collection. Just do plugin.map(File::toURI) before adding it to the backing collection.", "author": "mark-vieira", "createdAt": "2020-04-08T00:06:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTQwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0MTk5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54852#discussion_r405641992", "bodyText": "@rjernst / @mark-vieira  thanks - I removed the Supplier variant in favor of just the Gradle Provider (I introduced the supplier because I didn't realize I could create a Provider<URI>)\nI didn't need to use the .map here, but did to implement the conversion from RegularFile to File via the other comment.", "author": "jakelandis", "createdAt": "2020-04-08T16:09:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE2MTQwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "73427ab3692e08fd17b78d5a5c53490f2dc7b8cc", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClusterConfiguration.java b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClusterConfiguration.java\nindex 02155377fb0f..c879e927dfb4 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClusterConfiguration.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/TestClusterConfiguration.java\n\n@@ -48,9 +48,7 @@ public interface TestClusterConfiguration {\n \n     void plugin(File plugin);\n \n-    void plugin(Supplier<URI> plugin);\n-\n-    void plugin(Provider<RegularFile> plugin);\n+    void plugin(Provider<URI> plugin);\n \n     void module(File module);\n \n"}}, {"oid": "73427ab3692e08fd17b78d5a5c53490f2dc7b8cc", "url": "https://github.com/elastic/elasticsearch/commit/73427ab3692e08fd17b78d5a5c53490f2dc7b8cc", "message": "review changes", "committedDate": "2020-04-08T15:54:16Z", "type": "commit"}, {"oid": "5527c98194c4b78e975791d65ca21cd977d3a44c", "url": "https://github.com/elastic/elasticsearch/commit/5527c98194c4b78e975791d65ca21cd977d3a44c", "message": "Merge branch 'master' into lazy_module_plugins", "committedDate": "2020-04-08T16:11:54Z", "type": "commit"}, {"oid": "909f0f3e5e9adf5a64b0528ac70b3d3da094cb21", "url": "https://github.com/elastic/elasticsearch/commit/909f0f3e5e9adf5a64b0528ac70b3d3da094cb21", "message": "add missing lazy File based plugin option", "committedDate": "2020-04-08T18:36:36Z", "type": "commit"}]}