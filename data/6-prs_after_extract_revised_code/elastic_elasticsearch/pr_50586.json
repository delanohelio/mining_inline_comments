{"pr_number": 50586, "pr_title": "Remove type parameter from `CreateIndexRequest.mapping(type, XContentBuilder)`", "pr_createdAt": "2020-01-03T09:30:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50586", "timeline": [{"oid": "c7a3039496fd255073ba307a7b92b88d981b71e1", "url": "https://github.com/elastic/elasticsearch/commit/c7a3039496fd255073ba307a7b92b88d981b71e1", "message": "Remove CreateIndexRequest.addMapping(type, string, xcontenttype)", "committedDate": "2019-12-19T16:16:40Z", "type": "commit"}, {"oid": "3336f14215e9ec50cc3dd6b34ba0899daa0e9533", "url": "https://github.com/elastic/elasticsearch/commit/3336f14215e9ec50cc3dd6b34ba0899daa0e9533", "message": "Remove type from CIR.mapping(xcontentbuilder)", "committedDate": "2019-12-20T12:33:07Z", "type": "commit"}, {"oid": "0f33ff7392e1bee52335b90f110cd8609767d6f0", "url": "https://github.com/elastic/elasticsearch/commit/0f33ff7392e1bee52335b90f110cd8609767d6f0", "message": "Remove type from CIR.mapping(map)", "committedDate": "2019-12-20T14:58:31Z", "type": "commit"}, {"oid": "9f999b108450a3dc74550ed942030dd2acea141d", "url": "https://github.com/elastic/elasticsearch/commit/9f999b108450a3dc74550ed942030dd2acea141d", "message": "Merge remote-tracking branch 'origin/master' into types-removal/cir/xcontentbuilder", "committedDate": "2020-01-02T13:04:37Z", "type": "commit"}, {"oid": "a46c50c6ab09435f850a923bad04ca2458650302", "url": "https://github.com/elastic/elasticsearch/commit/a46c50c6ab09435f850a923bad04ca2458650302", "message": "tests", "committedDate": "2020-01-03T09:19:00Z", "type": "commit"}, {"oid": "15152978284f2a79ef348b9ac56be865aa1b5368", "url": "https://github.com/elastic/elasticsearch/commit/15152978284f2a79ef348b9ac56be865aa1b5368", "message": "imports", "committedDate": "2020-01-03T09:54:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NTY2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363455669", "bodyText": "To double-check I understand -- we could already remove the mentions to _doc in mapping definitions, but we'll postpone that for another PR? This approach makes sense to me, as it helps keep the current PR focused.", "author": "jtibshirani", "createdAt": "2020-01-06T19:53:37Z", "path": "modules/analysis-common/src/test/java/org/elasticsearch/analysis/common/HighlighterWithAnalyzersTests.java", "diffHunk": "@@ -57,9 +57,9 @@\n \n     public void testNgramHighlightingWithBrokenPositions() throws IOException {\n         assertAcked(prepareCreate(\"test\")\n-                .addMapping(\"test\", jsonBuilder()\n+                .setMapping(jsonBuilder()\n                         .startObject()\n-                            .startObject(\"test\")\n+                            .startObject(\"_doc\")", "originalCommit": "15152978284f2a79ef348b9ac56be865aa1b5368", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc0NjY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363746671", "bodyText": "That's correct - there's also still a bit of inconsistency as to when things need to be wrapped and when not, which this PR moves us one more step towards resolving.", "author": "romseygeek", "createdAt": "2020-01-07T13:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NTY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg2OTA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363869074", "bodyText": "\ud83d\udc4d", "author": "jtibshirani", "createdAt": "2020-01-07T17:45:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ1NTY2OQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NDkwNA==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363464904", "bodyText": "For consistency with the changes in CreateIndexRequestBuilder, it would be great if we also removed the type parameter from public CreateIndexRequest mapping(String type, Map<String, ?> source), and converted as many callers as possible to use the new signature. Here's a suggestion for how to do it:\n\n    public CreateIndexRequest mapping(Map<String, ?> source) {\n        return mapping(MapperService.SINGLE_MAPPING_NAME, source);\n    }\n\n    private CreateIndexRequest mapping(String type, Map<String, ?> source) {\n        // wrap it in a type map if its not\n        if (source.size() != 1 || !source.containsKey(type)) {\n            source = Map.of(MapperService.SINGLE_MAPPING_NAME, source);\n        }\n        ...\n    }\n\nThe private method is still needed to support CreateIndexRequest#source.", "author": "jtibshirani", "createdAt": "2020-01-06T20:17:59Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java", "diffHunk": "@@ -255,11 +248,10 @@ public CreateIndexRequest cause(String cause) {\n     /**\n      * Adds mapping that will be added when the index gets created.\n      *\n-     * @param type   The mapping type\n      * @param source The mapping source\n      */\n-    public CreateIndexRequest mapping(String type, XContentBuilder source) {\n-        return mapping(type, BytesReference.bytes(source), source.contentType());\n+    public CreateIndexRequest mapping(XContentBuilder source) {", "originalCommit": "15152978284f2a79ef348b9ac56be865aa1b5368", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc0ODE5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363748197", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-01-07T13:32:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NDkwNA=="}], "type": "inlineReview", "revised_code": {"commit": "e37d0864fd856db56bb19a4638cbcf9582c95190", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\nindex 3f362e1e09f..f30fc715e42 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\n\n@@ -246,7 +246,7 @@ public class CreateIndexRequest extends AcknowledgedRequest<CreateIndexRequest>\n     }\n \n     /**\n-     * Adds mapping that will be added when the index gets created.\n+     * Set the mapping for this index\n      *\n      * @param source The mapping source\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NjQ5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363466496", "bodyText": "For context, what's the plan to remove these remaining methods that accept Object... source?", "author": "jtibshirani", "createdAt": "2020-01-06T20:22:31Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java", "diffHunk": "@@ -291,7 +283,7 @@ else if (MapperService.SINGLE_MAPPING_NAME.equals(type) == false) {\n      * (\"field1\", \"type=string,store=true\").\n      */\n     public CreateIndexRequest mapping(String type, Object... source) {\n-        mapping(type, PutMappingRequest.buildFromSimplifiedDef(type, source));\n+        mapping(PutMappingRequest.buildFromSimplifiedDef(MapperService.SINGLE_MAPPING_NAME, source));", "originalCommit": "15152978284f2a79ef348b9ac56be865aa1b5368", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc0ODA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50586#discussion_r363748097", "bodyText": "My current plan is to have a new method, mappingFromSimplifiedDef(Objects... source), and remove the existing method, to make sure that we get compilation failures rather than silently treating the type parameter as part of the source.", "author": "romseygeek", "createdAt": "2020-01-07T13:32:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ2NjQ5Ng=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cd9dff6342e99548865704f62f375340eeef7edb", "url": "https://github.com/elastic/elasticsearch/commit/cd9dff6342e99548865704f62f375340eeef7edb", "message": "Merge remote-tracking branch 'origin/master' into types-removal/cir/xcontentbuilder", "committedDate": "2020-01-07T13:26:49Z", "type": "commit"}, {"oid": "e37d0864fd856db56bb19a4638cbcf9582c95190", "url": "https://github.com/elastic/elasticsearch/commit/e37d0864fd856db56bb19a4638cbcf9582c95190", "message": "Remove type from  as well", "committedDate": "2020-01-07T13:54:23Z", "type": "commit"}]}