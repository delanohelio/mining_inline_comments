{"pr_number": 53211, "pr_title": "Resolve real (indexed) SPs from IdentityProvider", "pr_createdAt": "2020-03-06T03:27:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53211", "timeline": [{"oid": "9bb6dcd6b211734c3bda5b7be81268b95fd624c3", "url": "https://github.com/elastic/elasticsearch/commit/9bb6dcd6b211734c3bda5b7be81268b95fd624c3", "message": "Resolve real (indexed) SPs from IdentityProvider\n\nThis change hooks the SamlIdentityProvider class up to the\nSamlServiceProviderResolver so that we return real registered\nservice providers during SSO handling", "committedDate": "2020-03-06T03:22:49Z", "type": "commit"}, {"oid": "7a35fb91250ce4be498c155e9046ffd09d994ccb", "url": "https://github.com/elastic/elasticsearch/commit/7a35fb91250ce4be498c155e9046ffd09d994ccb", "message": "Fix variable name", "committedDate": "2020-03-06T03:28:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MTc3MA==", "url": "https://github.com/elastic/elasticsearch/pull/53211#discussion_r389341770", "bodyText": "is this TODO about possibly exposing sp defaults in IDP settings?", "author": "jkakavas", "createdAt": "2020-03-08T07:02:46Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/IdentityProviderPlugin.java", "diffHunk": "@@ -80,12 +84,22 @@\n         }\n \n         SamlInit.initialize();\n-        final SamlIdentityProvider idp = SamlIdentityProvider.builder().fromSettings(environment).build();\n         final SamlServiceProviderIndex index = new SamlServiceProviderIndex(client, clusterService);\n+\n+        // TODO", "originalCommit": "7a35fb91250ce4be498c155e9046ffd09d994ccb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3Mjk0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53211#discussion_r389472942", "bodyText": "Yes, these should definitely be configurable, and this isn't the place to set them, but I wanted to avoid Yak shaving here.", "author": "tvernum", "createdAt": "2020-03-09T05:50:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MTc3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MjA0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53211#discussion_r389342047", "bodyText": "Do we need a name ?", "author": "jkakavas", "createdAt": "2020-03-08T07:08:12Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/CloudServiceProvider.java", "diffHunk": "@@ -27,13 +29,16 @@\n     private final boolean signAuthnRequests;\n     private final boolean signLogoutRequests;\n \n-    public CloudServiceProvider(String entityId, URL assertionConsumerService, Set<String> allowedNameIdFormats,\n-                                ReadableDuration authnExpiry, ServiceProviderPrivileges privileges, AttributeNames attributeNames,\n+    public CloudServiceProvider(String entityId, String name, boolean enabled, URL assertionConsumerService,\n+                                Set<String> allowedNameIdFormats, ReadableDuration authnExpiry,\n+                                ServiceProviderPrivileges privileges, AttributeNames attributeNames,\n                                 Set<X509Credential> spSigningCredentials, boolean signAuthnRequests, boolean signLogoutRequests) {\n         if (Strings.isNullOrEmpty(entityId)) {\n             throw new IllegalArgumentException(\"Service Provider Entity ID cannot be null or empty\");\n         }\n         this.entityId = entityId;\n+        this.name = name;", "originalCommit": "7a35fb91250ce4be498c155e9046ffd09d994ccb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3MzQwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/53211#discussion_r389473405", "bodyText": "No, but we store it in the doc, so I bubbled it up.\nWe could rip it out entirely instead.", "author": "tvernum", "createdAt": "2020-03-09T05:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MjA0Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3MzE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/53211#discussion_r389473194", "bodyText": "However, I think this one is old, and shouldn't be here.", "author": "tvernum", "createdAt": "2020-03-09T05:52:11Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProviderBuilder.java", "diffHunk": "@@ -70,17 +71,22 @@\n         Setting.Property.NodeScope);\n     public static final Setting<String> IDP_CONTACT_EMAIL = Setting.simpleString(\"xpack.idp.contact.email\", Setting.Property.NodeScope);\n \n+    private final SamlServiceProviderResolver serviceProviderResolver;\n+\n     private String entityId;\n     private Map<String, URL> ssoEndpoints;\n     private Map<String, URL> sloEndpoints;\n     private X509Credential signingCredential;\n     private X509Credential metadataSigningCredential;\n     private SamlIdentityProvider.ContactInfo technicalContact;\n     private SamlIdentityProvider.OrganizationInfo organization;\n+    private SamlIdentityProvider.ServiceProviderDefaults serviceProviderDefaults;\n \n-    SamlIdentityProviderBuilder() {\n+    SamlIdentityProviderBuilder(SamlServiceProviderResolver serviceProviderResolver) {\n+        this.serviceProviderResolver = serviceProviderResolver;\n         this.ssoEndpoints = new HashMap<>();\n         this.sloEndpoints = new HashMap<>();\n+        // TODO", "originalCommit": "7a35fb91250ce4be498c155e9046ffd09d994ccb", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "86d69d0ca6dbbcbeb51b36cf1c1ed7c3bd0e3f1c", "chunk": "diff --git a/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProviderBuilder.java b/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProviderBuilder.java\nindex 94be0005218..840db70435b 100644\n--- a/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProviderBuilder.java\n+++ b/x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProviderBuilder.java\n\n@@ -86,7 +86,6 @@ public class SamlIdentityProviderBuilder {\n         this.serviceProviderResolver = serviceProviderResolver;\n         this.ssoEndpoints = new HashMap<>();\n         this.sloEndpoints = new HashMap<>();\n-        // TODO\n     }\n \n     public SamlIdentityProvider build() throws ValidationException {\n"}}, {"oid": "86d69d0ca6dbbcbeb51b36cf1c1ed7c3bd0e3f1c", "url": "https://github.com/elastic/elasticsearch/commit/86d69d0ca6dbbcbeb51b36cf1c1ed7c3bd0e3f1c", "message": "Minor fixes: TODO and validation", "committedDate": "2020-03-09T06:10:36Z", "type": "commit"}, {"oid": "8b9ed15a00825319de9374bfac84cd24974800a9", "url": "https://github.com/elastic/elasticsearch/commit/8b9ed15a00825319de9374bfac84cd24974800a9", "message": "Merge branch 'feature-internal-idp' into idp/real-sp\n\n# Conflicts:\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProvider.java\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderResolver.java", "committedDate": "2020-03-09T06:14:23Z", "type": "commit"}, {"oid": "89af9e346051374237244104cf1e0a982292ffaf", "url": "https://github.com/elastic/elasticsearch/commit/89af9e346051374237244104cf1e0a982292ffaf", "message": "Merge branch 'feature-internal-idp' into idp/real-sp", "committedDate": "2020-03-09T10:51:41Z", "type": "commit"}]}