{"pr_number": 64240, "pr_title": "Ignore cancellation error when search is cancelled", "pr_createdAt": "2020-10-27T19:20:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64240", "timeline": [{"oid": "88698d1537b6d7ec495f0be00d02674983a60f49", "url": "https://github.com/elastic/elasticsearch/commit/88698d1537b6d7ec495f0be00d02674983a60f49", "message": "Ignore cancellation error when search is cancelled", "committedDate": "2020-10-27T19:09:34Z", "type": "commit"}, {"oid": "bd7c4dca8a638ddcd888e9e2f470ba9516119052", "url": "https://github.com/elastic/elasticsearch/commit/bd7c4dca8a638ddcd888e9e2f470ba9516119052", "message": "Fix testSearchPhaseFailureNoCause", "committedDate": "2020-10-27T20:32:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxODg1MA==", "url": "https://github.com/elastic/elasticsearch/pull/64240#discussion_r513018850", "bodyText": "Can you update the comment above to say that we don't aggregate shard failures on search cancelled internally ?", "author": "jimczi", "createdAt": "2020-10-27T20:46:00Z", "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -438,7 +439,7 @@ protected void onShardGroupFailure(int shardIndex, SearchShardTarget shardTarget\n     @Override\n     public final void onShardFailure(final int shardIndex, @Nullable SearchShardTarget shardTarget, Exception e) {\n         // we don't aggregate shard failures on non active shards (but do keep the header counts right)\n-        if (TransportActions.isShardNotAvailableException(e) == false) {\n+        if (TransportActions.isShardNotAvailableException(e) == false && (requestCancelled.get() && isTaskCancelledException(e)) == false) {", "originalCommit": "bd7c4dca8a638ddcd888e9e2f470ba9516119052", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NTA1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64240#discussion_r513075052", "bodyText": "++, added in cd53c74", "author": "dnhatn", "createdAt": "2020-10-27T22:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxODg1MA=="}], "type": "inlineReview", "revised_code": {"commit": "cd53c74a057a1bcddfe7d7429643607f993312cf", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java b/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\nindex 1406ec28202..0653d79f31e 100644\n--- a/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\n\n@@ -438,7 +438,8 @@ abstract class AbstractSearchAsyncAction<Result extends SearchPhaseResult> exten\n      */\n     @Override\n     public final void onShardFailure(final int shardIndex, @Nullable SearchShardTarget shardTarget, Exception e) {\n-        // we don't aggregate shard failures on non active shards (but do keep the header counts right)\n+        // we don't aggregate shard failures on non active shards and failures due to the internal cancellation,\n+        // but do keep the header counts right\n         if (TransportActions.isShardNotAvailableException(e) == false && (requestCancelled.get() && isTaskCancelledException(e)) == false) {\n             AtomicArray<ShardSearchFailure> shardFailures = this.shardFailures.get();\n             // lazily create shard failures, so we can early build the empty shard failure list in most cases (no failures)\n"}}, {"oid": "cd53c74a057a1bcddfe7d7429643607f993312cf", "url": "https://github.com/elastic/elasticsearch/commit/cd53c74a057a1bcddfe7d7429643607f993312cf", "message": "add comment", "committedDate": "2020-10-27T22:39:14Z", "type": "commit"}, {"oid": "05dce74e811f2581633021465a5b0185496364c4", "url": "https://github.com/elastic/elasticsearch/commit/05dce74e811f2581633021465a5b0185496364c4", "message": "Merge branch 'master' into ignore-cancel-error", "committedDate": "2020-10-27T22:39:18Z", "type": "commit"}]}