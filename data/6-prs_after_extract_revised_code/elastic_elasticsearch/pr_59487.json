{"pr_number": 59487, "pr_title": "Separate coordinating and primary bytes in stats", "pr_createdAt": "2020-07-14T01:37:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59487", "timeline": [{"oid": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "url": "https://github.com/elastic/elasticsearch/commit/543821c4ad3d4ed052eb1798f32f5da83fe3d292", "message": "Separate coordinating and primary bytes in stats\n\nCurrently we combine coordinating and primary bytes into a single bucket\nfor indexing pressure stats. This makes sense for rejection logic.\nHowever, for metrics it would be useful to separate them.", "committedDate": "2020-07-14T01:35:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNDg1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454214853", "bodyText": "It this necessary? ReroutePhase is an AbstractRunnable so should be fine", "author": "ywelsch", "createdAt": "2020-07-14T09:09:09Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -179,7 +179,15 @@ protected TransportReplicationAction(Settings settings, String actionName, Trans\n     @Override\n     protected void doExecute(Task task, Request request, ActionListener<Response> listener) {\n         assert request.shardId() != null : \"request shardId must be set\";\n-        new ReroutePhase((ReplicationTask) task, request, listener).run();\n+        runReroutePhase(task, request, listener, true);\n+    }\n+\n+    private void runReroutePhase(Task task, Request request, ActionListener<Response> listener, boolean executedByClient) {\n+        try {\n+            new ReroutePhase((ReplicationTask) task, request, listener, executedByClient).run();\n+        } catch (Exception e) {", "originalCommit": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzNDMzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454434335", "bodyText": "Probably not? But we also do this with new AsyncPrimaryAction(request, listener, (ReplicationTask) task).run(); in handlePrimaryRequest. So I did it for consistency? I think Henning was concerned that a RuntimeException would leave unreleased bytes.", "author": "tbrooks8", "createdAt": "2020-07-14T15:15:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNDg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzNDU2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454434562", "bodyText": "I did change it to just RuntimeException.", "author": "tbrooks8", "createdAt": "2020-07-14T15:16:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNDg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzNjM4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454436386", "bodyText": "ok", "author": "ywelsch", "createdAt": "2020-07-14T15:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNDg1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "2815343f5ca11103cb1afc08265161664f51178a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex 2324c752f7a..0daafbf4ce8 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -182,10 +182,10 @@ public abstract class TransportReplicationAction<\n         runReroutePhase(task, request, listener, true);\n     }\n \n-    private void runReroutePhase(Task task, Request request, ActionListener<Response> listener, boolean executedByClient) {\n+    private void runReroutePhase(Task task, Request request, ActionListener<Response> listener, boolean initiatedByNodeClient) {\n         try {\n-            new ReroutePhase((ReplicationTask) task, request, listener, executedByClient).run();\n-        } catch (Exception e) {\n+            new ReroutePhase((ReplicationTask) task, request, listener, initiatedByNodeClient).run();\n+        } catch (RuntimeException e) {\n             listener.onFailure(e);\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNjM0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454216347", "bodyText": "add a comment here?", "author": "ywelsch", "createdAt": "2020-07-14T09:11:45Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -1103,25 +1119,29 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, l\n         private final R request;\n         // Indicates if this primary shard request originated by a reroute on this local node.\n         private final boolean sentFromLocalReroute;\n+        private final boolean localRerouteInitiatedByNodeClient;", "originalCommit": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2815343f5ca11103cb1afc08265161664f51178a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex 2324c752f7a..0daafbf4ce8 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -1119,6 +1119,8 @@ public abstract class TransportReplicationAction<\n         private final R request;\n         // Indicates if this primary shard request originated by a reroute on this local node.\n         private final boolean sentFromLocalReroute;\n+        // Indicates if this local reroute was initiated by the NodeClient executing a transport action. This\n+        // is only true if sentFromLocalReroute is true.\n         private final boolean localRerouteInitiatedByNodeClient;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzMjgyNw==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454232827", "bodyText": "I prefer the initiatedByNodeClient  naming here with a comment explaining why  we have  that boolean", "author": "ywelsch", "createdAt": "2020-07-14T09:40:22Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -658,12 +667,18 @@ private IndexShard getIndexShard(final ShardId shardId) {\n     final class ReroutePhase extends AbstractRunnable {\n         private final ActionListener<Response> listener;\n         private final Request request;\n+        private final boolean executedByClient;\n         private final ReplicationTask task;\n         private final ClusterStateObserver observer;\n         private final AtomicBoolean finished = new AtomicBoolean();\n \n         ReroutePhase(ReplicationTask task, Request request, ActionListener<Response> listener) {\n+            this(task, request, listener, false);\n+        }\n+\n+        ReroutePhase(ReplicationTask task, Request request, ActionListener<Response> listener, boolean executedByClient) {\n             this.request = request;\n+            this.executedByClient = executedByClient;", "originalCommit": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2815343f5ca11103cb1afc08265161664f51178a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex 2324c752f7a..0daafbf4ce8 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -667,7 +667,7 @@ public abstract class TransportReplicationAction<\n     final class ReroutePhase extends AbstractRunnable {\n         private final ActionListener<Response> listener;\n         private final Request request;\n-        private final boolean executedByClient;\n+        private final boolean initiatedByNodeClient;\n         private final ReplicationTask task;\n         private final ClusterStateObserver observer;\n         private final AtomicBoolean finished = new AtomicBoolean();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzNDAyOA==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454234028", "bodyText": "can we also assert (similar  to sentFromLocalReroute) that localRerouteInitiatedByNodeClient is never false when being serialized in writeTo?", "author": "ywelsch", "createdAt": "2020-07-14T09:42:26Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -1103,25 +1119,29 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, l\n         private final R request;\n         // Indicates if this primary shard request originated by a reroute on this local node.\n         private final boolean sentFromLocalReroute;\n+        private final boolean localRerouteInitiatedByNodeClient;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n             targetAllocationID = in.readString();\n             primaryTerm  = in.readVLong();\n             sentFromLocalReroute = false;\n+            localRerouteInitiatedByNodeClient = false;", "originalCommit": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2815343f5ca11103cb1afc08265161664f51178a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex 2324c752f7a..0daafbf4ce8 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -1119,6 +1119,8 @@ public abstract class TransportReplicationAction<\n         private final R request;\n         // Indicates if this primary shard request originated by a reroute on this local node.\n         private final boolean sentFromLocalReroute;\n+        // Indicates if this local reroute was initiated by the NodeClient executing a transport action. This\n+        // is only true if sentFromLocalReroute is true.\n         private final boolean localRerouteInitiatedByNodeClient;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzNDc5NA==", "url": "https://github.com/elastic/elasticsearch/pull/59487#discussion_r454234794", "bodyText": "maybe mention that this is the case during primary delegation, after the primary relocation handoff.", "author": "ywelsch", "createdAt": "2020-07-14T09:43:51Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "diffHunk": "@@ -80,17 +80,22 @@ protected TransportWriteAction(Settings settings, String actionName, TransportSe\n \n     @Override\n     protected Releasable checkOperationLimits(Request request) {\n-        return indexingPressure.markIndexingOperationStarted(primaryOperationSize(request), forceExecution);\n+        return indexingPressure.markPrimaryOperationStarted(primaryOperationSize(request), forceExecution);\n     }\n \n     @Override\n-    protected Releasable checkPrimaryLimits(Request request, boolean rerouteWasLocal) {\n-        // If this primary request was submitted by a reroute performed on this local node, we have already\n-        // accounted the bytes.\n+    protected Releasable checkPrimaryLimits(Request request, boolean rerouteWasLocal, boolean localRerouteInitiatedByNodeClient) {\n         if (rerouteWasLocal) {\n-            return () -> {};\n+            // If this primary request was received from a local reroute initiated by the node client, we\n+            // must mark a new primary operation local to the coordinating node.\n+            if (localRerouteInitiatedByNodeClient) {\n+                return indexingPressure.markPrimaryOperationLocalToCoordinatingNodeStarted(primaryOperationSize(request));\n+            } else {\n+                return () -> {};\n+            }\n         } else {\n-            return indexingPressure.markIndexingOperationStarted(primaryOperationSize(request), forceExecution);\n+            // If this primary request was received directly from the network, we must mark a new primary operation.", "originalCommit": "543821c4ad3d4ed052eb1798f32f5da83fe3d292", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2815343f5ca11103cb1afc08265161664f51178a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\nindex 51b70e5cefd..5a2820fd6de 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n\n@@ -94,7 +94,9 @@ public abstract class TransportWriteAction<\n                 return () -> {};\n             }\n         } else {\n-            // If this primary request was received directly from the network, we must mark a new primary operation.\n+            // If this primary request was received directly from the network, we must mark a new primary\n+            // operation. This happens if the write action skips the reroute step (ex: rsync) or during\n+            // primary delegation, after the primary relocation hand-off.\n             return indexingPressure.markPrimaryOperationStarted(primaryOperationSize(request), forceExecution);\n         }\n     }\n"}}, {"oid": "5e6610dba23b45334ecc9e5826cb11ab5aa4db9d", "url": "https://github.com/elastic/elasticsearch/commit/5e6610dba23b45334ecc9e5826cb11ab5aa4db9d", "message": "Merge remote-tracking branch 'upstream/master' into dedicated_coordinating_buckets", "committedDate": "2020-07-14T15:02:44Z", "type": "commit"}, {"oid": "2815343f5ca11103cb1afc08265161664f51178a", "url": "https://github.com/elastic/elasticsearch/commit/2815343f5ca11103cb1afc08265161664f51178a", "message": "Changes", "committedDate": "2020-07-14T15:12:07Z", "type": "commit"}, {"oid": "ffe752fa564fed3dda7664fb3b2f122ca8f7c004", "url": "https://github.com/elastic/elasticsearch/commit/ffe752fa564fed3dda7664fb3b2f122ca8f7c004", "message": "Rejections field name", "committedDate": "2020-07-14T16:05:23Z", "type": "commit"}, {"oid": "858306d28096cdbc64f81a525655fed7a03056b4", "url": "https://github.com/elastic/elasticsearch/commit/858306d28096cdbc64f81a525655fed7a03056b4", "message": "Merge remote-tracking branch 'upstream/master' into dedicated_coordinating_buckets", "committedDate": "2020-07-14T16:32:31Z", "type": "commit"}]}