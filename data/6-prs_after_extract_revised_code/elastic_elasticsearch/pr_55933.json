{"pr_number": 55933, "pr_title": "Histogram field type support for ValueCount and Avg aggregations", "pr_createdAt": "2020-04-29T13:14:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55933", "timeline": [{"oid": "bb755330f76de743de07a94e457e5f1fa69af91f", "url": "https://github.com/elastic/elasticsearch/commit/bb755330f76de743de07a94e457e5f1fa69af91f", "message": "Moved histogram agg tests to correct test package", "committedDate": "2020-04-29T09:22:04Z", "type": "commit"}, {"oid": "dbdb7f837ed76449abdf14035a3924fc7fd785c3", "url": "https://github.com/elastic/elasticsearch/commit/dbdb7f837ed76449abdf14035a3924fc7fd785c3", "message": "Cleaned up histo sum agg test", "committedDate": "2020-04-29T10:04:46Z", "type": "commit"}, {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e", "url": "https://github.com/elastic/elasticsearch/commit/2671d5c2a3980193bf162338cb4d5c9c9400d66e", "message": "Added histogram backed average aggregation", "committedDate": "2020-04-29T13:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTIwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417389201", "bodyText": "@not-napoleon and I've been favoring changing the ctor so you can just to (MetricAggregatorSupplier) HistoBackedSumAggregator::new. It is less \"big\".", "author": "nik9000", "createdAt": "2020-04-29T15:06:14Z", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AnalyticsAggregatorFactory.java", "diffHunk": "@@ -65,6 +68,24 @@ public static void registerPercentileRanksAggregator(ValuesSourceRegistry.Builde\n     public static void registerHistoBackedSumAggregator(ValuesSourceRegistry.Builder builder) {\n         builder.register(SumAggregationBuilder.NAME,\n             AnalyticsValuesSourceType.HISTOGRAM,\n-            (MetricAggregatorSupplier) HistoBackedSumAggregator::new);\n+            (MetricAggregatorSupplier) (name, valuesSource, format, context, parent, metadata) ->\n+                new HistoBackedSumAggregator(name, (HistogramValuesSource.Histogram) valuesSource, format, context, parent, metadata)", "originalCommit": "2671d5c2a3980193bf162338cb4d5c9c9400d66e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU1NTQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417555427", "bodyText": "(MetricAggregatorSupplier) HistoBackedSumAggregator::new is definitely better looking and I would prefer it as well.\nThe problem is that MetricAggregatorSupplier passes a ValuesSource argument\nAggregator build(String name,\n                     ValuesSource valuesSource,\n                     DocValueFormat format,\n                     SearchContext context,\n                     Aggregator parent,\n                     Map<String, Object> metadata) throws IOException;\n\nwhile HistoBackedSumAggregator constructor expects a HistogramValuesSource.Histogram\nHistoBackedSumAggregator(String name, HistogramValuesSource.Histogram valuesSource, DocValueFormat formatter, SearchContext context,\n            Aggregator parent, Map<String, Object> metadata) throws IOException \n\nSo I had 3 options:\n\nKeep the ValuesSource parameter in the HistoBackedSumAggregator constructor and do a type cast later when I would use the HistogramValuesSource.Histogram object.\nCreate a separate HistoBackedMetricAggregatorSupplier that would match the arguments of the HistoBackedSumAggregator\nDo the cast of ValuesSource to HistogramValuesSource.Histogram in the registrar method changing the admittedly prettier (MetricAggregatorSupplier) HistoBackedSumAggregator::new to the longer lambda expression.\n\nI chose the third option because it seemed cleaner to do the type cast at the registrar method where it is obvious that the VS is a histogram. On the other hand, I didn't  want to create yet another AggregatorSupplier sub-class", "author": "csoulios", "createdAt": "2020-04-29T19:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA0NjQ2NA==", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r418046464", "bodyText": "I've been favoring having generic ValuesSource in the supplier and doing the cast in the aggregator constructor instead.  Really the suppliers shouldn't care about the ValuesSource subclass, since the whole idea is to be able to add new ones in, and having to subclass a supplier to do that is a lot of boiler plate.  I know I haven't been perfectly consistent about that so far, but I'm working on cleaning it up as I can.", "author": "not-napoleon", "createdAt": "2020-04-30T14:20:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTIwMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyOTM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417429354", "bodyText": "You probably can merge master and remove this now.", "author": "nik9000", "createdAt": "2020-04-29T15:59:52Z", "path": "x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import com.tdunning.math.stats.Centroid;\n+import com.tdunning.math.stats.TDigest;\n+import org.apache.lucene.document.BinaryDocValuesField;\n+import org.apache.lucene.document.Field;\n+import org.apache.lucene.document.StringField;\n+import org.apache.lucene.index.RandomIndexWriter;\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.MatchAllDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.common.CheckedConsumer;\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.plugins.SearchPlugin;\n+import org.elasticsearch.search.aggregations.AggregationBuilder;\n+import org.elasticsearch.search.aggregations.AggregatorTestCase;\n+import org.elasticsearch.search.aggregations.metrics.AvgAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.InternalAvg;\n+import org.elasticsearch.search.aggregations.metrics.TDigestState;\n+import org.elasticsearch.search.aggregations.support.AggregationInspectionHelper;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.xpack.analytics.AnalyticsPlugin;\n+import org.elasticsearch.xpack.analytics.aggregations.support.AnalyticsValuesSourceType;\n+import org.elasticsearch.xpack.analytics.mapper.HistogramFieldMapper;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+import static java.util.Collections.singleton;\n+import static org.elasticsearch.search.aggregations.AggregationBuilders.avg;\n+\n+public class HistoBackedAvgAggregatorTests extends AggregatorTestCase {\n+\n+    private static final String FIELD_NAME = \"field\";\n+\n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")", "originalCommit": "2671d5c2a3980193bf162338cb4d5c9c9400d66e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "chunk": "diff --git a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java\nindex 8fcea7a9089..b2b2f25c782 100644\n--- a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java\n+++ b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java\n\n@@ -45,12 +45,11 @@ public class HistoBackedAvgAggregatorTests extends AggregatorTestCase {\n \n     private static final String FIELD_NAME = \"field\";\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")\n     public void testNoDocs() throws IOException {\n         testCase(new MatchAllDocsQuery(), iw -> {\n             // Intentionally not writing any docs\n         }, avg -> {\n-            assertEquals(0L, avg.getValue(), 0d);\n+            assertEquals(Double.NaN, avg.getValue(), 0d);\n             assertFalse(AggregationInspectionHelper.hasValue(avg));\n         });\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyOTk2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417429961", "bodyText": "I think this is merged, right?", "author": "nik9000", "createdAt": "2020-04-29T16:00:42Z", "path": "x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java", "diffHunk": "@@ -49,6 +45,7 @@\n \n     private static final String FIELD_NAME = \"field\";\n \n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")", "originalCommit": "2671d5c2a3980193bf162338cb4d5c9c9400d66e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "chunk": "diff --git a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java\nindex e8731adf57c..68187302656 100644\n--- a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java\n+++ b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java\n\n@@ -45,7 +45,6 @@ public class HistoBackedSumAggregatorTests extends AggregatorTestCase {\n \n     private static final String FIELD_NAME = \"field\";\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")\n     public void testNoDocs() throws IOException {\n         testCase(new MatchAllDocsQuery(), iw -> {\n             // Intentionally not writing any docs\n"}}, {"oid": "89e6d94884b7b3591ba203c5c27b709e2f4549ab", "url": "https://github.com/elastic/elasticsearch/commit/89e6d94884b7b3591ba203c5c27b709e2f4549ab", "message": "Merge branch 'master' into histo-value-count-avg", "committedDate": "2020-04-29T19:28:03Z", "type": "commit"}, {"oid": "efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "url": "https://github.com/elastic/elasticsearch/commit/efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "message": "Enabled testNoDocs() tests", "committedDate": "2020-04-29T19:42:04Z", "type": "commit"}, {"oid": "d18029e2854f8a326dcb26edf60220855e60226c", "url": "https://github.com/elastic/elasticsearch/commit/d18029e2854f8a326dcb26edf60220855e60226c", "message": "Added documentation", "committedDate": "2020-04-30T13:48:47Z", "type": "commit"}, {"oid": "4868f5383542fba9f0660ee4fa454c5d28c80089", "url": "https://github.com/elastic/elasticsearch/commit/4868f5383542fba9f0660ee4fa454c5d28c80089", "message": "Small doc changes", "committedDate": "2020-04-30T14:58:51Z", "type": "commit"}]}