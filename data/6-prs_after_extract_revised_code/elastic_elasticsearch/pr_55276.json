{"pr_number": 55276, "pr_title": "Remove Redundant CS Update on Snapshot Finalization", "pr_createdAt": "2020-04-16T05:52:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55276", "timeline": [{"oid": "66b3ffc23717eea117dea5d6df7df58556b01e18", "url": "https://github.com/elastic/elasticsearch/commit/66b3ffc23717eea117dea5d6df7df58556b01e18", "message": "Remove Redundant CS Update on Snapshot Finalization\n\nThis change folds the removal of the in-progress snapshot entry\ninto setting the safe repository generation. Outside of removing\nan unnecessary cluster state update, this also has the advantage\nof removing a somewhat inconsistent cluster state where the safe\nrepository generation points at `RepositoryData` that contains a\nfinished snapshot while it is still in-progress in the cluster\nstate, making it easier to reason about the state machine of\nupcoming concurrent snapshot operations.", "committedDate": "2020-04-16T05:45:53Z", "type": "commit"}, {"oid": "0f82c2646cd52d07db7df20c6e9ed023dac88ee3", "url": "https://github.com/elastic/elasticsearch/commit/0f82c2646cd52d07db7df20c6e9ed023dac88ee3", "message": "noisy indent", "committedDate": "2020-04-16T05:54:39Z", "type": "commit"}, {"oid": "b0e85eccad661ba7f9c5cc895c9cc0afa58042d1", "url": "https://github.com/elastic/elasticsearch/commit/b0e85eccad661ba7f9c5cc895c9cc0afa58042d1", "message": "Merge remote-tracking branch 'elastic/master' into atomic-snapshot-finalization", "committedDate": "2020-04-16T06:03:30Z", "type": "commit"}, {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "url": "https://github.com/elastic/elasticsearch/commit/6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "message": "fix test", "committedDate": "2020-04-16T07:56:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NjU3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55276#discussion_r409356570", "bodyText": "The concrete situation that this test was covering is technically gone with this change, but I think it's reasonable to keep testing the very similar situation of master fail-over during the repository side of the finalization here now.", "author": "original-brownbear", "createdAt": "2020-04-16T07:58:14Z", "path": "server/src/test/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java", "diffHunk": "@@ -189,8 +189,7 @@ public void clusterChanged(ClusterChangedEvent event) {\n                         final RepositoriesMetadata repoMeta =\n                             event.state().metadata().custom(RepositoriesMetadata.TYPE);\n                         final RepositoryMetadata metadata = repoMeta.repository(\"test-repo\");\n-                        if (metadata.generation() == metadata.pendingGeneration()\n-                            && metadata.generation() > snapshotEntry.repositoryStateId()) {\n+                        if (metadata.pendingGeneration() > snapshotEntry.repositoryStateId()) {", "originalCommit": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NzU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/55276#discussion_r411997584", "bodyText": "It's not a filter, rather a transformation function. Perhaps adapt naming?", "author": "ywelsch", "createdAt": "2020-04-21T08:50:09Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1301,10 +1304,11 @@ public boolean isReadOnly() {\n      * @param repositoryData RepositoryData to write\n      * @param expectedGen    expected repository generation at the start of the operation\n      * @param writeShardGens whether to write {@link ShardGenerations} to the new {@link RepositoryData} blob\n+     * @param stateFilter    filter for the last cluster state update executed by this method", "originalCommit": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjk5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55276#discussion_r412082999", "bodyText": "Renamed :)", "author": "original-brownbear", "createdAt": "2020-04-21T10:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NzU4NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0741cb1a0bcd20826e447b38ada3314616dc6256", "url": "https://github.com/elastic/elasticsearch/commit/0741cb1a0bcd20826e447b38ada3314616dc6256", "message": "Merge remote-tracking branch 'elastic/master' into atomic-snapshot-finalization", "committedDate": "2020-04-21T10:51:39Z", "type": "commit"}, {"oid": "df04dfe59fe4bf69bb91596dd83050e9d7487bbe", "url": "https://github.com/elastic/elasticsearch/commit/df04dfe59fe4bf69bb91596dd83050e9d7487bbe", "message": "naming", "committedDate": "2020-04-21T10:56:02Z", "type": "commit"}]}