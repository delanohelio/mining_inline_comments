{"pr_number": 54980, "pr_title": "Add support for filters to T-Test aggregation", "pr_createdAt": "2020-04-08T19:48:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54980", "timeline": [{"oid": "819e35dc5d83fd070790d83ac267251a72bd1730", "url": "https://github.com/elastic/elasticsearch/commit/819e35dc5d83fd070790d83ac267251a72bd1730", "message": "Add support for filters to T-Test aggregation\n\nAdds support for filters to T-Test aggregation. The filters can be used to\nselect populations based on some criteria and use values from the same or\ndifferent fields.\n\nCloses #53692", "committedDate": "2020-04-08T19:35:08Z", "type": "commit"}, {"oid": "77827818667df99ac5266c990977d349bc3cfd80", "url": "https://github.com/elastic/elasticsearch/commit/77827818667df99ac5266c990977d349bc3cfd80", "message": "Fix BWC tests until we can backport", "committedDate": "2020-04-08T20:14:09Z", "type": "commit"}, {"oid": "0bb9ee2f1f6ceb4040eec260ab35d6e2da4bdbea", "url": "https://github.com/elastic/elasticsearch/commit/0bb9ee2f1f6ceb4040eec260ab35d6e2da4bdbea", "message": "Merge branch 'master' into issue-53692-add-filtes-to-t-test", "committedDate": "2020-04-08T20:43:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NjAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/54980#discussion_r406256023", "bodyText": "Should we validate/throw an exception/something if people specify an unpaired type, but don't provide filters?  Not sure where to put that validation logic but it seems we should disallow folks from basically running an unpaired test on two match-all's?", "author": "polyfractal", "createdAt": "2020-04-09T14:42:57Z", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/ttest/TTestAggregatorFactory.java", "diffHunk": "@@ -63,13 +76,46 @@ protected Aggregator doCreateInternal(SearchContext searchContext,\n         }\n         switch (testType) {\n             case PAIRED:\n+                if (filterA != null || filterB != null) {\n+                    throw new IllegalArgumentException(\"Paired t-test doesn't support filters\");\n+                }\n                 return new PairedTTestAggregator(name, numericMultiVS, tails, format, searchContext, parent, metadata);\n             case HOMOSCEDASTIC:\n-                return new UnpairedTTestAggregator(name, numericMultiVS, tails, true, format, searchContext, parent, metadata);\n+                return new UnpairedTTestAggregator(name, numericMultiVS, tails, true, this::getWeights, format, searchContext, parent,", "originalCommit": "0bb9ee2f1f6ceb4040eec260ab35d6e2da4bdbea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4Njc4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54980#discussion_r406286787", "bodyText": "I was thinking about support for something like this:\n{\"before\": [1,2,3], \"after\":[6,7,8,9,10]}\n\nIt currently works for unpaired, fails on paired and doesn't require filters.", "author": "imotov", "createdAt": "2020-04-09T15:26:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NjAyMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "47836d267c8f37b95fb087eea1fffb8a5174cdba", "url": "https://github.com/elastic/elasticsearch/commit/47836d267c8f37b95fb087eea1fffb8a5174cdba", "message": "Add check for duplicate fields", "committedDate": "2020-04-09T19:27:08Z", "type": "commit"}, {"oid": "5ceebd16257ebd26de21f8302c44f22fbb67950c", "url": "https://github.com/elastic/elasticsearch/commit/5ceebd16257ebd26de21f8302c44f22fbb67950c", "message": "Merge remote-tracking branch 'elastic/master' into issue-53692-add-filtes-to-t-test", "committedDate": "2020-04-09T19:27:28Z", "type": "commit"}, {"oid": "1020091aabb6fcee49b9d3a240d98a55f2afb1ad", "url": "https://github.com/elastic/elasticsearch/commit/1020091aabb6fcee49b9d3a240d98a55f2afb1ad", "message": "Merge branch 'master' into issue-53692-add-filtes-to-t-test", "committedDate": "2020-04-10T13:38:24Z", "type": "commit"}]}