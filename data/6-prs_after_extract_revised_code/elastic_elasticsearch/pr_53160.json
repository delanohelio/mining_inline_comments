{"pr_number": 53160, "pr_title": "Make ML index aliases hidden", "pr_createdAt": "2020-03-05T10:44:01Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53160", "timeline": [{"oid": "5e1138055b2d797be03ed564a0e23a4d26273ab6", "url": "https://github.com/elastic/elasticsearch/commit/5e1138055b2d797be03ed564a0e23a4d26273ab6", "message": "Make ml index aliases hidden", "committedDate": "2020-03-05T15:00:44Z", "type": "forcePushed"}, {"oid": "f61308a9021236df326650657e05f18e1085cd49", "url": "https://github.com/elastic/elasticsearch/commit/f61308a9021236df326650657e05f18e1085cd49", "message": "Make ml index aliases hidden", "committedDate": "2020-03-05T15:04:34Z", "type": "forcePushed"}, {"oid": "c7fa5fa4f6a2e6e6891eb505882acbe36a3b9da4", "url": "https://github.com/elastic/elasticsearch/commit/c7fa5fa4f6a2e6e6891eb505882acbe36a3b9da4", "message": "Make ml index aliases hidden", "committedDate": "2020-03-05T17:17:57Z", "type": "forcePushed"}, {"oid": "583ed0f4f759f1487284dabeda16c665fce66091", "url": "https://github.com/elastic/elasticsearch/commit/583ed0f4f759f1487284dabeda16c665fce66091", "message": "Fix tests", "committedDate": "2020-03-09T09:38:47Z", "type": "forcePushed"}, {"oid": "c5c64bde8073090dd8c2e1d3f3eef4c4b874344f", "url": "https://github.com/elastic/elasticsearch/commit/c5c64bde8073090dd8c2e1d3f3eef4c4b874344f", "message": "Fix tests", "committedDate": "2020-03-11T09:15:31Z", "type": "forcePushed"}, {"oid": "598e8f22a5bf46ebd9ed72c18acc900dab0d889f", "url": "https://github.com/elastic/elasticsearch/commit/598e8f22a5bf46ebd9ed72c18acc900dab0d889f", "message": "Make ml index aliases hidden", "committedDate": "2020-03-12T10:13:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53160#discussion_r391653171", "bodyText": "If the cluster has been upgraded then this might be adding a hidden alias on a non-hidden index. Is that a problem? (Maybe not - as long as you\u2019re sure I\u2019m good to merge this.)\nFor example, suppose a user runs ML in 7.6.1 and so has a non-hidden .ml-anomalies-shared index. Then they upgrade to 7.7 and create another job that uses the shared results index.\n(This also makes me realise that before 7.last we\u2019ll need another PR that makes pre-existing indices and aliases hidden. But that\u2019s not critical for 7.7.)", "author": "droberts195", "createdAt": "2020-03-12T14:19:45Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -282,9 +282,16 @@ public void createJobResultIndex(Job job, ClusterState state, final ActionListen\n         final String indexName = tempIndexName;\n \n         ActionListener<Boolean> indexAndMappingsListener = ActionListener.wrap(success -> {\n-            final IndicesAliasesRequest request = client.admin().indices().prepareAliases()\n-                    .addAlias(indexName, readAliasName, QueryBuilders.termQuery(Job.ID.getPreferredName(), job.getId()))\n-                    .addAlias(indexName, writeAliasName).request();\n+            final IndicesAliasesRequest request =\n+                client.admin().indices().prepareAliases()\n+                    .addAliasAction(\n+                        IndicesAliasesRequest.AliasActions.add()\n+                            .index(indexName)\n+                            .alias(readAliasName)\n+                            .isHidden(true)", "originalCommit": "a6ac5bc5723121f5763746b7248130015628d9fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc2MTUxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53160#discussion_r393761519", "bodyText": "If the cluster has been upgraded then this might be adding a hidden alias on a non-hidden index. Is that a problem? (Maybe not - as long as you\u2019re sure I\u2019m good to merge this.)\n\nI've verified that in 7.7 hidden alias can point at a non-hidden index so it's not a problem.\nGordon confirmed that all four combinations ({hidden, visible} x {index, alias}) should work fine so there should not be any BWC issues while upgrading from 7.6 to 7.7.\n\nThis also makes me realise that before 7.last we\u2019ll need another PR that makes pre-existing indices and aliases hidden. But that\u2019s not critical for 7.7.\n\nI've just created tracking issue for that: #53674", "author": "przemekwitek", "createdAt": "2020-03-17T15:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MzE3MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "c6dab22354955b75013ccc69e2685dec838f0c8b", "url": "https://github.com/elastic/elasticsearch/commit/c6dab22354955b75013ccc69e2685dec838f0c8b", "message": "Uncomment assertions as /_cat/aliases API now accepts expand_wildcards parameter", "committedDate": "2020-03-16T07:59:26Z", "type": "forcePushed"}, {"oid": "70812e3ba6b47be66d886b636ebaddffa89deb01", "url": "https://github.com/elastic/elasticsearch/commit/70812e3ba6b47be66d886b636ebaddffa89deb01", "message": "Add assertions verifying that aliases are hidden", "committedDate": "2020-03-17T12:37:39Z", "type": "forcePushed"}, {"oid": "bdd75ae30c92b337be41107d6681c39dd7740681", "url": "https://github.com/elastic/elasticsearch/commit/bdd75ae30c92b337be41107d6681c39dd7740681", "message": "Add assertions verifying that aliases are hidden", "committedDate": "2020-03-17T12:45:06Z", "type": "forcePushed"}, {"oid": "e90692017b5888ac7dbe9d5b79b030267c285808", "url": "https://github.com/elastic/elasticsearch/commit/e90692017b5888ac7dbe9d5b79b030267c285808", "message": "Make ml index aliases hidden", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "709d4a76b72a59de9179fa634c098d88e5656afa", "url": "https://github.com/elastic/elasticsearch/commit/709d4a76b72a59de9179fa634c098d88e5656afa", "message": "Fix compile errors in tests", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "7eb0a099069c4cf5bf07eee9c140a8f6d4a99e4a", "url": "https://github.com/elastic/elasticsearch/commit/7eb0a099069c4cf5bf07eee9c140a8f6d4a99e4a", "message": "Get rid of unnecessary `expand_aliases` parameter", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "99f280ee8a9d8bce41fbdf464d00164dbb7ab271", "url": "https://github.com/elastic/elasticsearch/commit/99f280ee8a9d8bce41fbdf464d00164dbb7ab271", "message": "Uncomment assertions as /_cat/aliases API now accepts expand_wildcards parameter", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "b68885ced6b58c98e0a6add6ff2f8fc86a8af94a", "url": "https://github.com/elastic/elasticsearch/commit/b68885ced6b58c98e0a6add6ff2f8fc86a8af94a", "message": "Fix unit tests", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "52479521583c5233153846127e8b12ebc3d69128", "url": "https://github.com/elastic/elasticsearch/commit/52479521583c5233153846127e8b12ebc3d69128", "message": "Add assertions verifying that aliases are hidden", "committedDate": "2020-03-18T07:23:32Z", "type": "commit"}, {"oid": "52479521583c5233153846127e8b12ebc3d69128", "url": "https://github.com/elastic/elasticsearch/commit/52479521583c5233153846127e8b12ebc3d69128", "message": "Add assertions verifying that aliases are hidden", "committedDate": "2020-03-18T07:23:32Z", "type": "forcePushed"}]}