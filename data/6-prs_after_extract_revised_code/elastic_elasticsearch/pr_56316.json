{"pr_number": 56316, "pr_title": "Support handling LogoutResponse from SAML idP", "pr_createdAt": "2020-05-07T02:34:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56316", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421211429", "bodyText": "This requires Kibana to know the _ID of the logout request crafted by ES and sent to the idP. The current SamlLogoutResponse does not give this information in a way that Kibana can easily access.\nWe could either change SamlLogoutResponse to include a separate field of _ID similar to what we do with SamlPrepareAuthenticationResponse. Or we could simply skip this check?", "author": "ywangd", "createdAt": "2020-05-07T03:03:20Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(byte[] payload, Collection<String> allowedSamlRequestIds) {\n+        final Element root = parseSamlMessage(payload);\n+        if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n+            final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n+            if (logoutResponse == null) {\n+                throw samlException(\"Cannot convert element {} into LogoutResponse object\", root);\n+            }\n+            if (logoutResponse.isSigned()) {\n+                validateSignature(logoutResponse.getSignature());\n+            }\n+            checkInResponseTo(logoutResponse, allowedSamlRequestIds);", "originalCommit": "5b312653731a8e4d341bdd61dc570c7ece9aaaa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NTU2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421265563", "bodyText": "The spec (4.4.4.2) doesn't talk about validating the InResponseTo parameter, but I've seen other libraries / impementation do that. In all honesty SAML SLO is such a wild wild west, everyone does pretty much what they feel like :/\nGiven that it's not dictated by the specification and that our API has a binary response of \"The Logout Response is fine\" vs \"the Logout Response is not fine\" which cannot be abused somehow ( ie. open redirect etc) I think it would be fine to not validate but then again the implementation of doing it is already there so why not ? ( Kibana would need to make changes either way )", "author": "jkakavas", "createdAt": "2020-05-07T06:23:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMwNTUxMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421305513", "bodyText": "It's straightforward to add a new requestId field to the SamlLogoutResponse ES produces (via the /_security/saml/logout API). Given it is a change to an existing API, we may need to communicate to the Kibana team earlier on. @legrego Could you please comment on this? The requestId value is then required to be passed back to ES from Kibana to verify the LogoutResponse from the idP.", "author": "ywangd", "createdAt": "2020-05-07T07:47:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0ODUzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421348534", "bodyText": "Given it is a change to an existing API, we may need to communicate to the Kibana team earlier on\n\nIn general, adding additional fields to our responses is not considered to be a breaking change so I believe Kibana will be fine with it even if we don't sync merging support for this.\n\nThe requestId value is then required to be passed back to ES from Kibana to verify the LogoutResponse from the idP.\n\nKibana does that already for the request ID of the authentication response and send this back to ES in the _security/saml/authenticate API so I believe it would be fine to do here too.", "author": "jkakavas", "createdAt": "2020-05-07T08:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM2ODkxOA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421368918", "bodyText": "Thanks @jkakavas I'll make the change accordingly.", "author": "ywangd", "createdAt": "2020-05-07T09:30:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxNTEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421515133", "bodyText": "In general, adding additional fields to our responses is not considered to be a breaking change so I believe Kibana will be fine with it even if we don't sync merging support for this.\n\nThat's correct.\n\nKibana does that already for the request ID of the authentication response and send this back to ES in the _security/saml/authenticate API so I believe it would be fine to do here too.\n\nThe main difference here is that request ID returned from _security/saml/prepare is stored in the cookie. But during logout flow we used to clear cookie when user is redirected to IdP with LogoutRequest. Having said that, we can change that, we'll just need to carefully fix all the remaining places that still treat any cookie as a sign of authenticated user.", "author": "azasypkin", "createdAt": "2020-05-07T13:44:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3NjA2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425676062", "bodyText": "Since the specification doesn't explicitly call this out AND the outcome is in any case a no-op, I would be ok with not validating this. Especially since it sounds possible that the risk of introducing a bug on Kibana's side by changing this behavior is not minimal. On the other hand, treating \"any cookie as a sign of authenticated user.\" is something worth fixing regardless of that change so if this is an extra driver for that change, let's do it !", "author": "jkakavas", "createdAt": "2020-05-15T09:21:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxMTQyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 760c62d2d28..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421266670", "bodyText": "The response MUST be signed (4.4.4.2)  so we should fail if it is not signed.", "author": "jkakavas", "createdAt": "2020-05-07T06:26:01Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(byte[] payload, Collection<String> allowedSamlRequestIds) {\n+        final Element root = parseSamlMessage(payload);\n+        if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n+            final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n+            if (logoutResponse == null) {\n+                throw samlException(\"Cannot convert element {} into LogoutResponse object\", root);\n+            }\n+            if (logoutResponse.isSigned()) {", "originalCommit": "5b312653731a8e4d341bdd61dc570c7ece9aaaa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2OTA0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421269049", "bodyText": "The spec says \"Must authenticate itself either by signing or a binding specific mechansim\". While the HTTP-POST LogoutResponse is signed, the LogoutResponse from HTTP-Redirect binding is not. So I would prefer it to be optional.", "author": "ywangd", "createdAt": "2020-05-07T06:32:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI5NDI5NA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421294294", "bodyText": "or a binding specific mechanism\n\nthis alludes to the artifact binding that is not used/supported here\n\n. While the HTTP-POST LogoutResponse is signed, the LogoutResponse from HTTP-Redirect binding is not.\n\nWhy are you stating that as a fact ? It can very well be signed and according to the specification it MUST be.", "author": "jkakavas", "createdAt": "2020-05-07T07:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTMwMDMyMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421300323", "bodyText": "Why are you stating that as a fact ?\n\nIt's not an universal fact. I was trying to avoid explicitly mentioning a popular idP's name. Sorry about the confusion. If we mandate signature verification and Kibana starts to redirect the response to ES, the verification will fail since it does not have signature.\nIn addition, including signature in HTTP-Redirect request may risk hitting the (practical) limit of URL length. I guess this is probably the reason why it is not signed by the aforementioned idP.", "author": "ywangd", "createdAt": "2020-05-07T07:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM0NjcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421346718", "bodyText": "If we mandate signature verification and Kibana starts to redirect the response to ES, the verification will fail since it does not have signature.\n\nIt all boils down to how permissive we want to be with things that go against the specification. If a popular IDP doesn't adhere to the specification, do we happily consume what they are sending us or do we not ? And if another popular IDP comes along and doesn't adhere to the standards in a different way, do we happily accept that too? Where do we draw the line? I believe that drawing the line at what the specification says is easier to argue about than drawing the line in an arbitrary leniency we deem acceptable at some point.\n\nIn addition, including signature in HTTP-Redirect request may risk hitting the (practical) limit of URL length. I guess this is probably the reason why it is not signed by the aforementioned idP\n\nI doubt that. SAML Logout Response messages are quite small ( comparable to authentication requests that also use the HTTP Redirect binding and are signed )", "author": "jkakavas", "createdAt": "2020-05-07T08:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM2NDEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421364137", "bodyText": "I believe that drawing the line at what the specification says is easier to argue about than drawing the line in an arbitrary leniency we deem acceptable at some point.\n\nThis I agree. But the whole story is not only just with a particular idP. The leniency was already implemented by us (by dropping the LogoutResponse at Kibana side). We could choose to tighten up the behaviour and accept the fact it might break user's existing setup. I am happy to conform the standard if we are certain that is the price we would like to pay.\n\nauthentication requests that also use the HTTP Redirect binding and are signed\n\nThe auth Response from idP is signed but uses HTTP-POST (in fact we only support HTTP-POST binding for this). Our SAML AuthRequest uses redirect and it is not signed. As far as I know, Apache server has 4096 (or is it 8192) limit on URL length, it is a thing when URL gets too long.\nI have to admit that I only just started to read the spec and have many knownlege gaps. For an example, the signature part is confusing to me. It mandates a LogoutResponse to be signed, but signature for authn Response is optional. Isn't the authn Response a more sensitive/valuable information compared to LogoutResponse?", "author": "ywangd", "createdAt": "2020-05-07T09:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM3MTA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421371098", "bodyText": "The leniency was already implemented by us (by dropping the LogoutResponse at Kibana side).\n\nThis was not leniency. This was part of the specification not handled. If we do handle it, let's do it correctly.\n\nThe auth Response from idP is signed but uses HTTP-POST (in fact we only support HTTP-POST binding for this)\n\nTrue, but I said\n\nauthentication requests that also use the HTTP Redirect binding and are signed\n\nand SAML Authentication Requests are not SAML Authentication Responses :)\n\nOur SAML AuthRequest uses redirect and it is not signed.\n\nIt is when it is configured to be https://www.elastic.co/guide/en/elasticsearch/reference/master/saml-guide-authentication.html#_configuring_elasticsearch_for_signing\n\nAs far as I know, Apache server has 4096 (or is it 8192) limit on URL length, it is a thing when URL gets too long.\n\nAnd SAML with authentication requests ( using the HTTP Redirect binding) being signed has been out there for 15 years now, this is heavily supported and used, I don't think we need to worry about this.\n\nbut signature for authn Response is optional\n\nI don't think this is true.", "author": "jkakavas", "createdAt": "2020-05-07T09:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4NzUxMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421387513", "bodyText": "First of all, thanks for indulging me with the discussions. I really appreciate it. It helps me understanding the issue better \u2764\ufe0f\n\nIt is when it is configured to be\n\nThanks for pointing this out. I completely ignored this part when setting up saml locally. But isn't it actually an example that we do allow unsigned LogoutResponse (the difference being we are the sender in this case)?\n\nSAML with authentication requests ( using the HTTP Redirect binding) being signed has been out there for 15 years now, this is heavily supported and used\n\nThis is a good point as well. Given authn request can be signed and use HTTP Redirect, I agree there will be no issue for LogoutResponse.\n\nI don't think this is true.\n\nYou are right that it is not \"optional\". The word used in the spec 6.4.2 is \"SHOULD\". It is stronger than optional, but not MUST. Our implementation for this part treats it as optional:\n\n  \n    \n      elasticsearch/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java\n    \n    \n        Lines 90 to 92\n      in\n      a443e13\n    \n    \n    \n    \n\n        \n          \n           if (response.isSigned()) { \n        \n\n        \n          \n               validateSignature(response.getSignature()); \n        \n\n        \n          \n               requireSignedAssertions = false;", "author": "ywangd", "createdAt": "2020-05-07T10:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM5NzQwMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421397403", "bodyText": "But isn't it actually an example that we do allow unsigned LogoutResponse (the difference being we are the sender in this case)?\n\nI don't remember the discussions we had while implementing this , I can assume we made a decision that interoperability is more important than specification adherence at that time. We can revisit that decision too :)\n\nYou are right that it is not \"optional\". The word used in the spec 6.4.2 is \"SHOULD\".\n\nWe only support the web browser single sign on profile, so 4.1 in that spec, see 4.1.3.5\n\nOur implementation for this part treats it as optional:\n\nIt -hopefully- doesn't!!! A SAML response contains SAML assertions. What we do support is either the response or the assertion is signed :) There must be an integrity protection implemented, otherwise it would be trivial for attackers to bypass authentication", "author": "jkakavas", "createdAt": "2020-05-07T10:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQxMjA0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421412043", "bodyText": "We only support the web browser single sign on profile, so 4.1 in that spec, see 4.1.3.5\n\nYou are right. I read the wrong section \ud83e\udd26\n\nWhat we do support is either the response or the assertion is signed\n\nYes that's what I figured as well. There is no risk in this part.\nI think the only thing that bothers me is this \"popular idP\". The original issue #43264 is created with it as an example of why we consider to support HTTP-POST LogoutResponse. So it feels rather unsatifying if we fix one binding and breaks the other (the current working one).\nThe code change itself either way is trivial. The decision making part is more important. I feel we could talk about this over sync time.", "author": "ywangd", "createdAt": "2020-05-07T10:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTQ1MTY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421451686", "bodyText": "I think the only thing that bothers me is this \"popular idP\".\n\nI don't think we need to make changes that satisfy any \"popular IDP\", we should make changes that make sense for the users and are correct. What's more, I see no indication whatsoever that any IDP doesn't support signed Logout Responses so I'm not sure what we would be actually breaking with this.\nI think we should not be lenient here for no reason, but happy to discuss this more on the sync.", "author": "jkakavas", "createdAt": "2020-05-07T12:04:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwNTkyNw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r422005927", "bodyText": "Sync update: we decided to conform to the spec and perform full validation. Caller of the API can decide what to do with validation errors if any. Thanks for the discussion.", "author": "ywangd", "createdAt": "2020-05-08T08:04:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI2NjY3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 760c62d2d28..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4NzcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r421887718", "bodyText": "I don't think we need handle BWC here since this response never goes across nodes. The only consumer is Kibana (or other external system that integrates with ES).", "author": "ywangd", "createdAt": "2020-05-08T01:36:59Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponse.java", "diffHunk": "@@ -16,24 +16,32 @@\n  */\n public final class SamlLogoutResponse extends ActionResponse {\n \n-    private String redirectUrl;\n+    private final String requestId;\n+    private final String redirectUrl;\n \n     public SamlLogoutResponse(StreamInput in) throws IOException {\n         super(in);\n+        requestId = in.readString();\n         redirectUrl = in.readString();\n     }\n \n-    public SamlLogoutResponse(String redirectUrl) {\n+    public SamlLogoutResponse(String requestId, String redirectUrl) {\n+        this.requestId = requestId;", "originalCommit": "7ba8fd68acae93fb6132ca05b21bcf8171a3afa6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponse.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponse.java\nindex c6599b7db1d..dc176b61134 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponse.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponse.java\n\n@@ -16,32 +16,24 @@ import java.io.IOException;\n  */\n public final class SamlLogoutResponse extends ActionResponse {\n \n-    private final String requestId;\n-    private final String redirectUrl;\n+    private String redirectUrl;\n \n     public SamlLogoutResponse(StreamInput in) throws IOException {\n         super(in);\n-        requestId = in.readString();\n         redirectUrl = in.readString();\n     }\n \n-    public SamlLogoutResponse(String requestId, String redirectUrl) {\n-        this.requestId = requestId;\n+    public SamlLogoutResponse(String redirectUrl) {\n         this.redirectUrl = redirectUrl;\n     }\n \n-    public String getRequestId() {\n-        return requestId;\n-    }\n-\n     public String getRedirectUrl() {\n         return redirectUrl;\n     }\n \n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n-        out.writeString(requestId);\n         out.writeString(redirectUrl);\n     }\n \n-}\n+    }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3OTIxNg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425679216", "bodyText": "I think that complete_logout is a better name than verify_logout but I won't insist :)", "author": "jkakavas", "createdAt": "2020-05-15T09:27:09Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutAction.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionType;\n+\n+/**\n+ * ActionType for verifying SAML LogoutResponse\n+ */\n+public final class SamlVerifyLogoutAction extends ActionType<SamlVerifyLogoutResponse> {\n+\n+    public static final String NAME = \"cluster:admin/xpack/security/saml/verify_logout\";", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxNzI5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426317293", "bodyText": "I was not particular happy about the name verify_logout either. Changed it to complete_logout and also for names of all relevant classes.", "author": "ywangd", "createdAt": "2020-05-17T23:31:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3OTIxNg=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutAction.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseAction.java\nsimilarity index 54%\nrename from x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutAction.java\nrename to x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseAction.java\nindex e327ba12f27..8dea3ddd6f8 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutAction.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseAction.java\n\n@@ -8,14 +8,14 @@ package org.elasticsearch.xpack.core.security.action.saml;\n import org.elasticsearch.action.ActionType;\n \n /**\n- * ActionType for verifying SAML LogoutResponse\n+ * ActionType for authenticating using SAML assertions\n  */\n-public final class SamlVerifyLogoutAction extends ActionType<SamlVerifyLogoutResponse> {\n+public final class SamlLogoutResponseAction extends ActionType<SamlLogoutResponseResponse> {\n \n-    public static final String NAME = \"cluster:admin/xpack/security/saml/verify_logout\";\n-    public static final SamlVerifyLogoutAction INSTANCE = new SamlVerifyLogoutAction();\n+    public static final String NAME = \"cluster:admin/xpack/security/saml/logout_response\";\n+    public static final SamlLogoutResponseAction INSTANCE = new SamlLogoutResponseAction();\n \n-    private SamlVerifyLogoutAction() {\n-        super(NAME, SamlVerifyLogoutResponse::new);\n+    private SamlLogoutResponseAction() {\n+        super(NAME, SamlLogoutResponseResponse::new);\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3OTc3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425679777", "bodyText": "I would prefer if we have different fields for this depending on the binding", "author": "jkakavas", "createdAt": "2020-05-15T09:28:08Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * Represents a request to verify SAML LogoutResponse\n+ */\n+public final class SamlVerifyLogoutRequest extends ActionRequest {\n+\n+    private String content;", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMTM1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426321355", "bodyText": "I was intentionally trying to make it the same to handle both bindings. The current approach is to have a single POST endpoint that Kibana can call for both HTTP-Redirect and HTTP-Post bindings from the idP, i.e. Kibana acts as a multiplexer here. So what ES receives is an uniform POST message. The handler (SamlLogoutResponseHandler) is able to tell whether the paylod (content) itself is signed and proceeds as HTTP-Redirect. If it is not, it proceeds as HTTP-POST and requires the XML to be signed, which is more or less similar to what SamlAuthenticator does.\nI can be convinced to have two separate endpoints, one for HTTP-Redirect and one for HTTP-POST. If we do that, we can even have two separate Request classes as well. But if we choose to have a single endpoint, I'd prefer to also not differentiate it at the Request object level.\nWhether we should have one or two end-points also depends on what Kibana can do (@azasypkin). My thinking is that Kibana will have to prepare the requset to ES anyhow, i.e. it has to add the realm and requestId information. So Kibana might as well just act as the multiplexer and prepare an uniform message.", "author": "ywangd", "createdAt": "2020-05-18T00:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3OTc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzMzAwMg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426333002", "bodyText": "After reading your comment below. I am convinced to have separate fields at request level, queryString and content for HTTP-Redirect and HTTP-POST, respectively. The names are chosen to be consistent with RestSamlInvalidateSessionAction and RestSamlAuthenticateAction.\nThe SamlCompleteLogoutRequest will validate that the two fields cannot both be null nor both be set. It also has convenient methods, getPayload and isHttpRedirect, so the information is clear at handler level. Thanks.", "author": "ywangd", "createdAt": "2020-05-18T01:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3OTc3Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\nsimilarity index 78%\nrename from x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java\nrename to x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\nindex cdbd5c9fc5e..d8299223e6d 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\n\n@@ -14,22 +14,22 @@ import java.io.IOException;\n import java.util.List;\n \n /**\n- * Represents a request to verify SAML LogoutResponse\n+ * Represents a request to handle LogoutResponse using SAML assertions.\n  */\n-public final class SamlVerifyLogoutRequest extends ActionRequest {\n+public final class SamlLogoutResponseRequest extends ActionRequest {\n \n-    private String content;\n+    private byte[] saml;\n     private List<String> validRequestIds;\n     @Nullable\n     private String realm;\n     @Nullable\n     private String assertionConsumerServiceURL;\n \n-    public SamlVerifyLogoutRequest(StreamInput in) throws IOException {\n+    public SamlLogoutResponseRequest(StreamInput in) throws IOException {\n         super(in);\n     }\n \n-    public SamlVerifyLogoutRequest() {\n+    public SamlLogoutResponseRequest() {\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4MTQ3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425681472", "bodyText": "I don't think we need the assertionConsumerServiceURL in this case. IIUC ( @azasypkin can keep me honest ) , kibana's current versions can be made to always send the realm name in the request which is enough for us to get the realm by name", "author": "jkakavas", "createdAt": "2020-05-15T09:31:08Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+/**\n+ * Represents a request to verify SAML LogoutResponse\n+ */\n+public final class SamlVerifyLogoutRequest extends ActionRequest {\n+\n+    private String content;\n+    private List<String> validRequestIds;\n+    @Nullable\n+    private String realm;\n+    @Nullable\n+    private String assertionConsumerServiceURL;", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425710429", "bodyText": "Correct, starting from 7.7 we store realm returned from the _security/saml/authenticate in the cookie/session and we'll keep it when store Logout Request ID there as well.", "author": "azasypkin", "createdAt": "2020-05-15T10:26:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4MTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxODUxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426318519", "bodyText": "Thanks. Good to know that. Removed.", "author": "ywangd", "createdAt": "2020-05-17T23:43:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4MTQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\nsimilarity index 78%\nrename from x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java\nrename to x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\nindex cdbd5c9fc5e..d8299223e6d 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlVerifyLogoutRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlLogoutResponseRequest.java\n\n@@ -14,22 +14,22 @@ import java.io.IOException;\n import java.util.List;\n \n /**\n- * Represents a request to verify SAML LogoutResponse\n+ * Represents a request to handle LogoutResponse using SAML assertions.\n  */\n-public final class SamlVerifyLogoutRequest extends ActionRequest {\n+public final class SamlLogoutResponseRequest extends ActionRequest {\n \n-    private String content;\n+    private byte[] saml;\n     private List<String> validRequestIds;\n     @Nullable\n     private String realm;\n     @Nullable\n     private String assertionConsumerServiceURL;\n \n-    public SamlVerifyLogoutRequest(StreamInput in) throws IOException {\n+    public SamlLogoutResponseRequest(StreamInput in) throws IOException {\n         super(in);\n     }\n \n-    public SamlVerifyLogoutRequest() {\n+    public SamlLogoutResponseRequest() {\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4NjU5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425686591", "bodyText": "Leave this in a method as it was and just name it differently ? WDYT ?", "author": "jkakavas", "createdAt": "2020-05-15T09:40:35Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java", "diffHunk": "@@ -333,7 +277,13 @@ private void checkSubject(Subject assertionSubject, XMLObject parent, Collection\n         }\n         checkRecipient(confirmationData.get(0));\n         checkLifetimeRestrictions(confirmationData.get(0));\n-        checkInResponseTo(confirmationData.get(0), allowedSamlRequestIds);\n+        SubjectConfirmationData subjectConfirmationData = confirmationData.get(0);", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMxODA0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426318047", "bodyText": "Sure, named it checkSubjectInResponseTo. Let me know if you have a better name.", "author": "ywangd", "createdAt": "2020-05-17T23:39:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4NjU5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java\nindex c040467b701..de5dbde2c7e 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticator.java\n\n@@ -277,13 +333,7 @@ class SamlAuthenticator extends SamlResponseHandler {\n         }\n         checkRecipient(confirmationData.get(0));\n         checkLifetimeRestrictions(confirmationData.get(0));\n-        SubjectConfirmationData subjectConfirmationData = confirmationData.get(0);\n-        // Allow for IdP initiated SSO where InResponseTo MUST be missing\n-        if (Strings.hasText(subjectConfirmationData.getInResponseTo())\n-                && allowedSamlRequestIds.contains(subjectConfirmationData.getInResponseTo()) == false) {\n-            throw samlException(\"SAML Assertion SubjectConfirmationData is in-response-to [{}] but expected one of [{}]\",\n-                    subjectConfirmationData.getInResponseTo(), allowedSamlRequestIds);\n-        }\n+        checkInResponseTo(confirmationData.get(0), allowedSamlRequestIds);\n     }\n \n     private void checkRecipient(SubjectConfirmationData subjectConfirmationData) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5MzM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425693341", "bodyText": "I think I don't see the value in splitting up SamlObjectHandler and SamlResponseHandler. Can you elaborate ? It also doesn't help that all the objects that are responses for SAML , are passed in a request to elasticsearch and that makes naming hard but I'm equally happy with SamlResponseHandler and SamlRequestHandler", "author": "jkakavas", "createdAt": "2020-05-15T09:53:42Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandler.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlResponseHandler extends SamlObjectHandler {", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzg4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426323883", "bodyText": "This is mainly because we do have a real Request object from idP, i.e.SamlInvalidateSessionRequest. Its associated handler is SamlLogoutRequestHandler, which is a subclass of SamlObjectHandler. In another word, SamlObjectHandler is the base class for both Request and Response handlers. So I did not merge SamlResponseHandler into SamlObjectHandler.\nAlso I did a few refactoring which is likely made the changes hard to track, here is a summary:\n\nSamlObjectHandler was renamed from SamlRequestHandler (It seems to be a good idea to me since its the base for both Request and Response handlers. But I can revert it if it does not sound right to you).\nSamlResponseHandler is extracted from SamlAuthenticator since many code can be reused by the new SamlLogoutResponseHandler\n\nThe class hierarchy is as follows:\nSamlObjectHandler\n\u251c\u2500\u2500 SamlLogoutRequestHandler\n\u2514\u2500\u2500 SamlResponseHandler\n    \u251c\u2500\u2500 SamlAuthenticator\n    \u2514\u2500\u2500 SamlLogoutResponseHandler", "author": "ywangd", "createdAt": "2020-05-18T00:34:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5MzM0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandler.java\ndeleted file mode 100644\nindex 8508218368c..00000000000\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandler.java\n+++ /dev/null\n\n@@ -1,93 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.security.authc.saml;\n-\n-import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.unit.TimeValue;\n-import org.opensaml.saml.saml2.core.Status;\n-import org.opensaml.saml.saml2.core.StatusCode;\n-import org.opensaml.saml.saml2.core.StatusDetail;\n-import org.opensaml.saml.saml2.core.StatusMessage;\n-import org.opensaml.saml.saml2.core.StatusResponseType;\n-\n-import java.time.Clock;\n-import java.util.Collection;\n-\n-import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n-\n-public class SamlResponseHandler extends SamlObjectHandler {\n-    public SamlResponseHandler(Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n-        super(clock, idp, sp, maxSkew);\n-    }\n-\n-    protected void checkInResponseTo(StatusResponseType response, Collection<String> allowedSamlRequestIds) {\n-        if (Strings.hasText(response.getInResponseTo()) && allowedSamlRequestIds.contains(response.getInResponseTo()) == false) {\n-            logger.debug(\"The SAML Response with ID [{}] is unsolicited. A user might have used a stale URL or the Identity Provider \" +\n-                \"incorrectly populates the InResponseTo attribute\", response.getID());\n-            throw samlException(\"SAML content is in-response-to [{}] but expected one of {} \",\n-                response.getInResponseTo(), allowedSamlRequestIds);\n-        }\n-    }\n-\n-    protected String getStatusCodeMessage(Status status) {\n-        StatusCode firstLevel = status.getStatusCode();\n-        StatusCode subLevel = firstLevel.getStatusCode();\n-        StringBuilder sb = new StringBuilder();\n-        if (StatusCode.REQUESTER.equals(firstLevel.getValue())) {\n-            sb.append(\"The SAML IdP did not grant the request. It indicated that the Elastic Stack side sent something invalid (\");\n-        } else if (StatusCode.RESPONDER.equals(firstLevel.getValue())) {\n-            sb.append(\"The request could not be granted due to an error in the SAML IDP side (\");\n-        } else if (StatusCode.VERSION_MISMATCH.equals(firstLevel.getValue())) {\n-            sb.append(\"The request could not be granted because the SAML IDP doesn't support SAML 2.0 (\");\n-        } else {\n-            sb.append(\"The request could not be granted, the SAML IDP responded with a non-standard Status code (\");\n-        }\n-        sb.append(firstLevel.getValue()).append(\").\");\n-        if (getMessage(status) != null) {\n-            sb.append(\" Message: [\").append(getMessage(status)).append(\"]\");\n-        }\n-        if (getDetail(status) != null) {\n-            sb.append(\" Detail: [\").append(getDetail(status)).append(\"]\");\n-        }\n-        if (null != subLevel) {\n-            sb.append(\" Specific status code which might indicate what the issue is: [\").append(subLevel.getValue()).append(\"]\");\n-        }\n-        return sb.toString();\n-    }\n-\n-    protected void checkResponseDestination(StatusResponseType response, String spConfiguredUrl) {\n-        if (spConfiguredUrl.equals(response.getDestination()) == false) {\n-            if (response.isSigned() || Strings.hasText(response.getDestination())) {\n-                throw samlException(\"SAML response \" + response.getID() + \" is for destination \" + response.getDestination()\n-                    + \" but this realm uses \" + spConfiguredUrl);\n-            }\n-        }\n-    }\n-\n-    protected void checkStatus(Status status) {\n-        if (status == null || status.getStatusCode() == null) {\n-            throw samlException(\"SAML Response has no status code\");\n-        }\n-        if (isSuccess(status) == false) {\n-            throw samlException(\"SAML Response is not a 'success' response: {}\", getStatusCodeMessage(status));\n-        }\n-    }\n-\n-    protected boolean isSuccess(Status status) {\n-        return StatusCode.SUCCESS.equals(status.getStatusCode().getValue());\n-    }\n-\n-    private String getMessage(Status status) {\n-        final StatusMessage sm = status.getStatusMessage();\n-        return sm == null ? null : sm.getMessage();\n-    }\n-\n-    private String getDetail(Status status) {\n-        final StatusDetail sd = status.getStatusDetail();\n-        return sd == null ? null : SamlUtils.toString(sd.getDOM());\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NTkzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425695934", "bodyText": "I assume these are carried over as is from SamlAuthenticatorTests so I'm fine with these, let me know if you've made any significant changes somehow", "author": "jkakavas", "createdAt": "2020-05-15T09:58:27Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandlerTests.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.xml.security.Init;\n+import org.apache.xml.security.encryption.XMLCipher;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.watcher.watch.ClockMock;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.opensaml.security.credential.Credential;\n+import org.opensaml.security.x509.X509Credential;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.NodeList;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+\n+import java.io.IOException;\n+import java.io.StringReader;\n+import java.security.KeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.PrivateKey;\n+import java.security.cert.X509Certificate;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import javax.crypto.Cipher;\n+import javax.xml.crypto.dsig.CanonicalizationMethod;\n+import javax.xml.crypto.dsig.DigestMethod;\n+import javax.xml.crypto.dsig.Reference;\n+import javax.xml.crypto.dsig.SignatureMethod;\n+import javax.xml.crypto.dsig.SignedInfo;\n+import javax.xml.crypto.dsig.Transform;\n+import javax.xml.crypto.dsig.XMLSignature;\n+import javax.xml.crypto.dsig.XMLSignatureFactory;\n+import javax.xml.crypto.dsig.dom.DOMSignContext;\n+import javax.xml.crypto.dsig.keyinfo.KeyInfo;\n+import javax.xml.crypto.dsig.keyinfo.KeyInfoFactory;\n+import javax.xml.crypto.dsig.spec.C14NMethodParameterSpec;\n+import javax.xml.crypto.dsig.spec.TransformParameterSpec;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.parsers.ParserConfigurationException;\n+\n+import static java.util.Collections.singletonList;\n+import static javax.xml.crypto.dsig.CanonicalizationMethod.EXCLUSIVE;\n+import static javax.xml.crypto.dsig.Transform.ENVELOPED;\n+import static org.opensaml.saml.common.xml.SAMLConstants.SAML20_NS;\n+\n+public class SamlResponseHandlerTests extends SamlTestCase {", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNDExMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426324111", "bodyText": "You are right. They are split with the IDE refactoring tool. So nothing should be really different.", "author": "ywangd", "createdAt": "2020-05-18T00:36:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NTkzNA=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandlerTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandlerTests.java\ndeleted file mode 100644\nindex a5c31904704..00000000000\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlResponseHandlerTests.java\n+++ /dev/null\n\n@@ -1,233 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.security.authc.saml;\n-\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.xml.security.Init;\n-import org.apache.xml.security.encryption.XMLCipher;\n-import org.elasticsearch.common.collect.Tuple;\n-import org.elasticsearch.common.unit.TimeValue;\n-import org.elasticsearch.xpack.core.watcher.watch.ClockMock;\n-import org.junit.AfterClass;\n-import org.junit.BeforeClass;\n-import org.opensaml.security.credential.Credential;\n-import org.opensaml.security.x509.X509Credential;\n-import org.w3c.dom.Document;\n-import org.w3c.dom.Element;\n-import org.w3c.dom.NodeList;\n-import org.xml.sax.InputSource;\n-import org.xml.sax.SAXException;\n-\n-import java.io.IOException;\n-import java.io.StringReader;\n-import java.security.KeyException;\n-import java.security.NoSuchAlgorithmException;\n-import java.security.PrivateKey;\n-import java.security.cert.X509Certificate;\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collections;\n-import java.util.List;\n-import java.util.function.Supplier;\n-import java.util.stream.Collectors;\n-import javax.crypto.Cipher;\n-import javax.xml.crypto.dsig.CanonicalizationMethod;\n-import javax.xml.crypto.dsig.DigestMethod;\n-import javax.xml.crypto.dsig.Reference;\n-import javax.xml.crypto.dsig.SignatureMethod;\n-import javax.xml.crypto.dsig.SignedInfo;\n-import javax.xml.crypto.dsig.Transform;\n-import javax.xml.crypto.dsig.XMLSignature;\n-import javax.xml.crypto.dsig.XMLSignatureFactory;\n-import javax.xml.crypto.dsig.dom.DOMSignContext;\n-import javax.xml.crypto.dsig.keyinfo.KeyInfo;\n-import javax.xml.crypto.dsig.keyinfo.KeyInfoFactory;\n-import javax.xml.crypto.dsig.spec.C14NMethodParameterSpec;\n-import javax.xml.crypto.dsig.spec.TransformParameterSpec;\n-import javax.xml.parsers.DocumentBuilder;\n-import javax.xml.parsers.DocumentBuilderFactory;\n-import javax.xml.parsers.ParserConfigurationException;\n-\n-import static java.util.Collections.singletonList;\n-import static javax.xml.crypto.dsig.CanonicalizationMethod.EXCLUSIVE;\n-import static javax.xml.crypto.dsig.Transform.ENVELOPED;\n-import static org.opensaml.saml.common.xml.SAMLConstants.SAML20_NS;\n-\n-public class SamlResponseHandlerTests extends SamlTestCase {\n-    protected static final String SP_ENTITY_ID = \"https://sp.saml.elastic.test/\";\n-    protected static final String IDP_ENTITY_ID = \"https://idp.saml.elastic.test/\";\n-    protected static final String SP_ACS_URL = SP_ENTITY_ID + \"sso/post\";\n-    protected static final String SP_LOGOUT_URL = SP_ENTITY_ID + \"sso/logout\";\n-    protected static Tuple<X509Certificate, PrivateKey> idpSigningCertificatePair;\n-    protected static Tuple<X509Certificate, PrivateKey> spSigningCertificatePair;\n-    protected static List<Tuple<X509Certificate, PrivateKey>> spEncryptionCertificatePairs;\n-    protected static List<Integer> supportedAesKeyLengths;\n-    protected static List<String> supportedAesTransformations;\n-    protected ClockMock clock;\n-    protected String requestId;\n-    protected TimeValue maxSkew;\n-\n-    @BeforeClass\n-    public static void init() throws Exception {\n-        assumeFalse(\"Can't run in a FIPS JVM, there is no DOM XMLSignature Factory so we can't sign XML documents\", inFipsJvm());\n-        // TODO: Refactor the signing to use org.opensaml.xmlsec.signature.support.Signer so that we can run the tests\n-        SamlUtils.initialize(LogManager.getLogger(SamlAuthenticatorTests.class));\n-        // Initialise Apache XML security so that the signDoc methods work correctly.\n-        Init.init();\n-    }\n-\n-    @BeforeClass\n-    public static void calculateAesLength() throws NoSuchAlgorithmException {\n-        supportedAesKeyLengths = new ArrayList<>();\n-        supportedAesTransformations = new ArrayList<>();\n-        supportedAesKeyLengths.add(128);\n-        supportedAesTransformations.add(XMLCipher.AES_128);\n-        supportedAesTransformations.add(XMLCipher.AES_128_GCM);\n-        if (Cipher.getMaxAllowedKeyLength(\"AES\") > 128) {\n-            supportedAesKeyLengths.add(192);\n-            supportedAesKeyLengths.add(256);\n-            supportedAesTransformations.add(XMLCipher.AES_192);\n-            supportedAesTransformations.add(XMLCipher.AES_192_GCM);\n-            supportedAesTransformations.add(XMLCipher.AES_256);\n-            supportedAesTransformations.add(XMLCipher.AES_256_GCM);\n-        }\n-    }\n-\n-    /**\n-     * Generating X.509 credentials can be CPU intensive and slow, so we only want to do it once per class.\n-     */\n-    @BeforeClass\n-    public static void initCredentials() throws Exception {\n-        idpSigningCertificatePair = readRandomKeyPair(SamlResponseHandlerTests.randomSigningAlgorithm());\n-        spSigningCertificatePair = readRandomKeyPair(SamlResponseHandlerTests.randomSigningAlgorithm());\n-        spEncryptionCertificatePairs = Arrays.asList(readKeyPair(\"RSA_2048\"), readKeyPair(\"RSA_4096\"));\n-    }\n-\n-    protected static String randomSigningAlgorithm() {\n-        return randomFrom(\"RSA\", \"DSA\", \"EC\");\n-    }\n-\n-    @AfterClass\n-    public static void cleanup() {\n-        idpSigningCertificatePair = null;\n-        spSigningCertificatePair = null;\n-        spEncryptionCertificatePairs = null;\n-        supportedAesKeyLengths = null;\n-        supportedAesTransformations = null;\n-    }\n-\n-    private static KeyInfo getKeyInfo(XMLSignatureFactory factory, X509Certificate certificate) throws KeyException {\n-        KeyInfoFactory kif = factory.getKeyInfoFactory();\n-        javax.xml.crypto.dsig.keyinfo.X509Data data = kif.newX509Data(Collections.singletonList(certificate));\n-        return kif.newKeyInfo(singletonList(data));\n-    }\n-\n-    protected SpConfiguration getSpConfiguration(List<String> reqAuthnCtxClassRef) {\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(\n-            Collections.singleton(\"*\"),\n-                (X509Credential) buildOpenSamlCredential(spSigningCertificatePair).get(0));\n-        final List<X509Credential> spEncryptionCredentials = buildOpenSamlCredential(spEncryptionCertificatePairs).stream()\n-                .map((cred) -> (X509Credential) cred).collect(Collectors.<X509Credential>toList());\n-        return new SpConfiguration(SP_ENTITY_ID, SP_ACS_URL, SP_LOGOUT_URL, signingConfiguration, spEncryptionCredentials,\n-            reqAuthnCtxClassRef);\n-    }\n-\n-    protected IdpConfiguration getIdpConfiguration(Supplier<List<Credential>> credentials) {\n-        return new IdpConfiguration(IDP_ENTITY_ID, credentials);\n-    }\n-\n-    protected String randomId() {\n-        return SamlUtils.generateSecureNCName(randomIntBetween(12, 36));\n-    }\n-\n-    protected String signDoc(String xml) throws Exception {\n-        return signDoc(xml, EXCLUSIVE, SamlResponseHandlerTests.idpSigningCertificatePair);\n-    }\n-\n-    protected String signDoc(String xml, Tuple<X509Certificate, PrivateKey> keyPair) throws Exception {\n-        return signDoc(xml, EXCLUSIVE, keyPair);\n-    }\n-\n-    protected String signDoc(String xml, String c14nMethod) throws Exception {\n-        return signDoc(xml, c14nMethod, SamlResponseHandlerTests.idpSigningCertificatePair);\n-    }\n-\n-    private String signDoc(String xml, String c14nMethod, Tuple<X509Certificate, PrivateKey> keyPair) throws Exception {\n-        final Document doc = parseDocument(xml);\n-        signElement(doc.getDocumentElement(), keyPair, c14nMethod);\n-        return SamlUtils.toString(doc.getDocumentElement());\n-    }\n-\n-    protected Document parseDocument(String xml) throws ParserConfigurationException, SAXException, IOException {\n-        final DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();\n-        dbf.setNamespaceAware(true);\n-        final DocumentBuilder documentBuilder = dbf.newDocumentBuilder();\n-        return documentBuilder.parse(new InputSource(new StringReader(xml)));\n-    }\n-\n-    /**\n-     * Randomly selects digital signature algorithm URI for given private key\n-     * algorithm ({@link PrivateKey#getAlgorithm()}).\n-     *\n-     * @param key\n-     *            {@link PrivateKey}\n-     * @return algorithm URI\n-     */\n-    private String getSignatureAlgorithmURI(PrivateKey key) {\n-        String algoUri = null;\n-        switch (key.getAlgorithm()) {\n-        case \"RSA\":\n-            algoUri = randomFrom(\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\",\n-                    \"http://www.w3.org/2001/04/xmldsig-more#rsa-sha512\");\n-            break;\n-        case \"DSA\":\n-            algoUri = \"http://www.w3.org/2009/xmldsig11#dsa-sha256\";\n-            break;\n-        case \"EC\":\n-            algoUri = randomFrom(\"http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256\",\n-                    \"http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha512\");\n-            break;\n-        default:\n-            throw new IllegalArgumentException(\"Unsupported algorithm : \" + key.getAlgorithm()\n-                    + \" for signature, allowed values for private key algorithm are [RSA, DSA, EC]\");\n-        }\n-        return algoUri;\n-    }\n-\n-    protected void signElement(Element parent, Tuple<X509Certificate, PrivateKey> keyPair, String c14nMethod) throws Exception {\n-        //We need to explicitly set the Id attribute, \"ID\" is just our convention\n-        parent.setIdAttribute(\"ID\", true);\n-        final String refID = \"#\" + parent.getAttribute(\"ID\");\n-        final X509Certificate certificate = keyPair.v1();\n-        final PrivateKey privateKey = keyPair.v2();\n-        final XMLSignatureFactory fac = XMLSignatureFactory.getInstance(\"DOM\");\n-        final DigestMethod digestMethod = fac.newDigestMethod(randomFrom(DigestMethod.SHA256, DigestMethod.SHA512), null);\n-        final Transform transform = fac.newTransform(ENVELOPED, (TransformParameterSpec) null);\n-        // We don't \"have to\" set the reference explicitly since we're using enveloped signatures, but it helps with\n-        // creating the XSW test cases\n-        final Reference reference = fac.newReference(refID, digestMethod, singletonList(transform), null, null);\n-        final SignatureMethod signatureMethod = fac.newSignatureMethod(getSignatureAlgorithmURI(privateKey), null);\n-        final CanonicalizationMethod canonicalizationMethod = fac.newCanonicalizationMethod(c14nMethod, (C14NMethodParameterSpec) null);\n-\n-        final SignedInfo signedInfo = fac.newSignedInfo(canonicalizationMethod, signatureMethod, singletonList(reference));\n-\n-        final KeyInfo keyInfo = SamlResponseHandlerTests.getKeyInfo(fac, certificate);\n-\n-        final DOMSignContext dsc = new DOMSignContext(privateKey, parent);\n-        dsc.setDefaultNamespacePrefix(\"ds\");\n-        // According to the schema, the signature needs to be placed after the <Issuer> if there is one in the document\n-        // If there are more than one <Issuer> we are dealing with a <Response> so we sign the Response and add the\n-        // Signature after the Response <Issuer>\n-        NodeList issuersList = parent.getElementsByTagNameNS(SAML20_NS, \"Issuer\");\n-        if (issuersList.getLength() > 0) {\n-            dsc.setNextSibling(issuersList.item(0).getNextSibling());\n-        }\n-\n-        final XMLSignature signature = fac.newXMLSignature(signedInfo, keyInfo);\n-        signature.sign(dsc);\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMDgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425700831", "bodyText": "related to the discussion above, this is a case where we don't want to fail to parse the SAML message because we will try to parse it as if it came from the HTTP POST binding. We want to fail this because it is an unsigned request that came via the HTTP-Redirect binding and we disallow that.", "author": "jkakavas", "createdAt": "2020-05-15T10:07:59Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.set.Sets;\n+import org.joda.time.DateTime;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.opensaml.saml.saml2.core.Issuer;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n+import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n+import org.opensaml.security.x509.X509Credential;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.time.Clock;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n+\n+    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n+    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n+\n+    private Clock clock;\n+    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n+\n+    private static X509Credential credential;\n+\n+    @BeforeClass\n+    public static void setupCredential() throws Exception {\n+        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+    }\n+\n+    @AfterClass\n+    public static void clearCredential() {\n+        credential = null;\n+    }\n+\n+    @Before\n+    public void setupHandler() throws Exception {\n+        clock = Clock.systemUTC();\n+        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n+        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n+        final SpConfiguration sp = new SpConfiguration(\n+            \"https://sp.test/\",\n+            \"https://sp.test/saml/asc\",\n+            LOGOUT_URL,\n+            signingConfiguration,\n+            List.of(spCredential),\n+            Collections.emptyList());\n+        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n+    }\n+\n+    public void testHandlerWorks() throws URISyntaxException {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+        samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId));\n+    }\n+\n+    public void testHandlerFailsIfStatusIsNotSuccess() {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+\n+        final ElasticsearchSecurityException e =\n+            expectSamlException(() -> samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId)));\n+        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n+    }\n+\n+    public void testHandlerWillUseHttpPostBindingWhenUrlNotSigned() {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), null);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+        final ElasticsearchSecurityException e =\n+            expectSamlException(() -> samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId)));\n+        assertThat(e.getMessage(), containsString(\"Failed to parse SAML message\"));", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzMjU3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426332572", "bodyText": "I think I see your point here. I'll move away from auto-detect and have two separate fields at request level.", "author": "ywangd", "createdAt": "2020-05-18T01:35:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMDgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\ndeleted file mode 100644\nindex d47fb0cafe5..00000000000\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\n+++ /dev/null\n\n@@ -1,132 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.security.authc.saml;\n-\n-import org.elasticsearch.ElasticsearchSecurityException;\n-import org.elasticsearch.common.unit.TimeValue;\n-import org.elasticsearch.common.util.set.Sets;\n-import org.joda.time.DateTime;\n-import org.junit.AfterClass;\n-import org.junit.Before;\n-import org.junit.BeforeClass;\n-import org.opensaml.saml.saml2.core.Issuer;\n-import org.opensaml.saml.saml2.core.LogoutResponse;\n-import org.opensaml.saml.saml2.core.Status;\n-import org.opensaml.saml.saml2.core.StatusCode;\n-import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n-import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n-import org.opensaml.security.x509.X509Credential;\n-\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.time.Clock;\n-import java.util.Collections;\n-import java.util.List;\n-\n-import static org.hamcrest.Matchers.containsString;\n-\n-public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n-\n-    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n-    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n-\n-    private Clock clock;\n-    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n-\n-    private static X509Credential credential;\n-\n-    @BeforeClass\n-    public static void setupCredential() throws Exception {\n-        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-    }\n-\n-    @AfterClass\n-    public static void clearCredential() {\n-        credential = null;\n-    }\n-\n-    @Before\n-    public void setupHandler() throws Exception {\n-        clock = Clock.systemUTC();\n-        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n-        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n-        final SpConfiguration sp = new SpConfiguration(\n-            \"https://sp.test/\",\n-            \"https://sp.test/saml/asc\",\n-            LOGOUT_URL,\n-            signingConfiguration,\n-            List.of(spCredential),\n-            Collections.emptyList());\n-        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n-    }\n-\n-    public void testHandlerWorks() throws URISyntaxException {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId));\n-    }\n-\n-    public void testHandlerFailsIfStatusIsNotSuccess() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n-    }\n-\n-    public void testHandlerWillUseHttpPostBindingWhenUrlNotSigned() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), null);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"Failed to parse SAML message\"));\n-    }\n-\n-    private Status buildStatus(String statusCodeValue) {\n-        final Status status = new StatusBuilder().buildObject();\n-        final StatusCode statusCode = new StatusCodeBuilder().buildObject();\n-        statusCode.setValue(statusCodeValue);\n-        status.setStatusCode(statusCode);\n-        return status;\n-    }\n-\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMTE0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425701147", "bodyText": "I would very much prefer that we are explicit here and not try to deduce and imply checks. I think we need two parameters for the REST layer, one for the body of a response that comes via the HTTP-POST binding and a different one for the query string of a response that comes via the HTTP-Redirect binding. Then we can be very explicit here with regards to what we expect to have and what we need to process/check/validate", "author": "jkakavas", "createdAt": "2020-05-15T10:08:39Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(String content, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(content, \"SAMLResponse\");\n+        final Element root;\n+        if (parsed.hasSignature) {", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzMjU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426332587", "bodyText": "See above.", "author": "ywangd", "createdAt": "2020-05-18T01:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMTE0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex fa1dadfa389..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMjAzNA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r425702034", "bodyText": "Again, assuming that you didn't change much when you copied this over ( apart from introducing samlMessageParameterName ) , please do flag if otherwise ! (  diffs are not that helpful in spotting this kind of things :) )", "author": "jkakavas", "createdAt": "2020-05-15T10:10:18Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlObjectHandler.java", "diffHunk": "@@ -322,4 +331,74 @@ protected void validateNotOnOrAfter(DateTime notOnOrAfter) {\n             throw samlException(\"Rejecting SAML assertion because [{}] is on/after [{}]\", pastNow, notOnOrAfter);\n         }\n     }\n+\n+    protected ParsedQueryString parseQueryStringAndValidateSignature(String queryString, String samlMessageParameterName) {", "originalCommit": "3bd04b32eacb1bf0ae41ad85150a2bb543a34d51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyNjc4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r426326781", "bodyText": "Good spot! Indeed this is the only significant change as part of the refactoring. Next time I'll compile the list of changes before hand to save you some time. Sorry about that. Here is a list for rest of the changes (they are all very minor):\n\nmethod visibility from private to protect due to superclass extraction.\n\nThis includes: SamlResponseHandler#isSuccess, SamlResponseHandler#getStatusCodeMessage, SamlObjectHandler#decodeBase64, SamlObjectHandler#inflate, and SamlObjectHandler#parseQueryStringAndValidateSignature.\n\n\nReverse the order of String equals compare in SamlResponseHandler#isSuccess.\n\nChanged from status.getStatusCode().getValue().equals(StatusCode.SUCCESS) to StatusCode.SUCCESS.equals(status.getStatusCode().getValue()).", "author": "ywangd", "createdAt": "2020-05-18T00:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwMjAzNA=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlObjectHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlRequestHandler.java\nsimilarity index 79%\nrename from x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlObjectHandler.java\nrename to x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlRequestHandler.java\nindex 4f68d5e380a..ccd0ec22f20 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlObjectHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlRequestHandler.java\n\n@@ -331,74 +322,4 @@ public class SamlObjectHandler {\n             throw samlException(\"Rejecting SAML assertion because [{}] is on/after [{}]\", pastNow, notOnOrAfter);\n         }\n     }\n-\n-    protected ParsedQueryString parseQueryStringAndValidateSignature(String queryString, String samlMessageParameterName) {\n-        final String signatureInput = queryString.replaceAll(\"&Signature=.*$\", \"\");\n-        final Map<String, String> parameters = new HashMap<>();\n-        RestUtils.decodeQueryString(queryString, 0, parameters);\n-        final String samlMessage = parameters.get(samlMessageParameterName);\n-        if (samlMessage == null) {\n-            throw samlException(\"Could not parse {} from query string: [{}]\", samlMessageParameterName, queryString);\n-        }\n-\n-        final String relayState = parameters.get(\"RelayState\");\n-        final String signatureAlgorithm = parameters.get(\"SigAlg\");\n-        final String signature = parameters.get(\"Signature\");\n-        if (signature == null || signatureAlgorithm == null) {\n-            return new ParsedQueryString(samlMessage, false, relayState);\n-        }\n-\n-        validateSignature(signatureInput, signatureAlgorithm, signature);\n-        return new ParsedQueryString(samlMessage, true, relayState);\n-    }\n-\n-    private void validateSignature(String inputString, String signatureAlgorithm, String signature) {\n-        final byte[] sigBytes = decodeBase64(signature);\n-        final byte[] inputBytes = inputString.getBytes(StandardCharsets.US_ASCII);\n-        final String signatureText = Strings.cleanTruncate(signature, 32);\n-        checkIdpSignature(credential -> {\n-            if (XMLSigningUtil.verifyWithURI(credential, signatureAlgorithm, sigBytes, inputBytes)) {\n-                logger.debug(() -> new ParameterizedMessage(\"SAML Signature [{}] matches credentials [{}] [{}]\",\n-                        signatureText, credential.getEntityId(), credential.getPublicKey()));\n-                return true;\n-            } else {\n-                logger.debug(() -> new ParameterizedMessage(\"SAML Signature [{}] failed against credentials [{}] [{}]\",\n-                        signatureText, credential.getEntityId(), credential.getPublicKey()));\n-                return false;\n-            }\n-        }, signatureText);\n-    }\n-\n-    protected byte[] decodeBase64(String content) {\n-        try {\n-            return Base64.getDecoder().decode(content.replaceAll(\"\\\\s+\", \"\"));\n-        } catch (IllegalArgumentException e) {\n-            logger.info(\"Failed to decode base64 string [{}] - {}\", content, e.toString());\n-            throw samlException(\"SAML message cannot be Base64 decoded\", e);\n-        }\n-    }\n-\n-    protected byte[] inflate(byte[] bytes) {\n-        Inflater inflater = new Inflater(true);\n-        try (ByteArrayInputStream in = new ByteArrayInputStream(bytes);\n-             InflaterInputStream inflate = new InflaterInputStream(in, inflater);\n-             ByteArrayOutputStream out = new ByteArrayOutputStream(bytes.length * 3 / 2)) {\n-            Streams.copy(inflate, out);\n-            return out.toByteArray();\n-        } catch (IOException e) {\n-            throw samlException(\"SAML message cannot be inflated\", e);\n-        }\n-    }\n-\n-    static class ParsedQueryString {\n-        final String samlMessage;\n-        final boolean hasSignature;\n-        final String relayState;\n-\n-        ParsedQueryString(String samlMessage, boolean hasSignature, String relayState) {\n-            this.samlMessage = samlMessage;\n-            this.hasSignature = hasSignature;\n-            this.relayState = relayState;\n-        }\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2Mzg4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430163889", "bodyText": "It's not the URL that is signed, but rather the - encoded - SAML response.", "author": "jkakavas", "createdAt": "2020-05-26T05:30:42Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4OTI2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430889269", "bodyText": "You are right that it is not the entire URL that gets signed. But it is not just the encoded SAMLResponse either. It is rather a string taking the form of SAMLResponse=xxx&RelayState=xxx&SigAlg=xx. How about changing it to \"Query string is not signed, but is required for HTTP-Redirect binding\"?", "author": "ywangd", "createdAt": "2020-05-27T06:40:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2Mzg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk0MTI1MA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431941250", "bodyText": "The most important part here is for the user/administrator to realize what is wrong and why this failed. I think that \"The SAML logout response is not signed\" does that in a better way than \"the URL is not signed\" or \"The query string is not signed\" but I won't insist too much :)", "author": "jkakavas", "createdAt": "2020-05-28T15:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2Mzg4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2Mzk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430163980", "bodyText": "We can log these at DEBUG I think", "author": "jkakavas", "createdAt": "2020-05-26T05:31:03Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");\n+        } else if (httpRedirect == false && parsed.hasSignature) {\n+            throw samlException(\"URL is signed, but binding is HTTP-POST\");\n+        }\n+\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-Redirect binding\");", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2NDgzMw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430164833", "bodyText": "It reads strange that we \"parse the query string\" when payload might very well be the body of HTTP POST", "author": "jkakavas", "createdAt": "2020-05-26T05:34:14Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3NjkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430176905", "bodyText": "Reading through the tests below, it looks like there is an implicit assumption that even when HTTP POST is used, we will receive SAMLResponse=<Base64Endoded saml logout response here> from Kibana and thus we could \"parse\" this as if it was a query string. I think we should be explicit and\na) Declare that we expect kibana(or any caller) to pass the value of the SAMLResponse POST parameter\nb) Base64 decode this on the RestSamlLogoutAction\nc) Operate on the raw bytes after that\nsimilar to what we do for the SamlAuthenticateAction's parameter named content", "author": "jkakavas", "createdAt": "2020-05-26T06:14:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2NDgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4MTA0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430881043", "bodyText": "The payload/data returned from a SAML idP with HTTP-Post binding uses application/x-www-form-urlencoded encoding, which takes the form of SAMLResponse=<base64>&RelayState=xxxx.  So it can indeed be processed as if it is a query string.\nBut I think it is good point that we should keep this consistent with how SAMLReseponse is handled by SamlAuthenticationAction, for which I think Kibana performs the action of extracting the value of SAMLResponse parameter and passes it to ES so that we do not have to parse it (as query parameter) again. I will make the change and add a note in the code to clarify the expectation for Kibana.", "author": "ywangd", "createdAt": "2020-05-27T06:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2NDgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2NTgzMg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430165832", "bodyText": "this should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        root = parseSamlMessage(decodeBase64(parsed.samlMessage));\n          \n          \n            \n                        root = parseSamlMessage(decodeBase64(payload));", "author": "jkakavas", "createdAt": "2020-05-26T05:37:58Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");\n+        } else if (httpRedirect == false && parsed.hasSignature) {\n+            throw samlException(\"URL is signed, but binding is HTTP-POST\");\n+        }\n+\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n+            root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n+        } else {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-POST binding\");\n+            root = parseSamlMessage(decodeBase64(parsed.samlMessage));", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2NzU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430167583", "bodyText": "Given that I had 4 comments in 10 lines ( Woke up picky today, apologies \ud83d\ude4f )  think we could do this is a simpler way, something like\nfinal Element root;\nif (httpRedirect) {\n    logger.debug(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n    final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n    if (parsed.hasSignature == false){\n        throw samlException(\"SAML LogoutResponse messages must be signed\");    \n    }\n    root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n} else {\n    logger.info(\"Process SAML LogoutResponse with HTTP-POST binding\");\n    root = parseSamlMessage(decodeBase64(payload));\n}", "author": "jkakavas", "createdAt": "2020-05-26T05:44:32Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");\n+        } else if (httpRedirect == false && parsed.hasSignature) {\n+            throw samlException(\"URL is signed, but binding is HTTP-POST\");\n+        }\n+\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n+            root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n+        } else {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-POST binding\");\n+            root = parseSamlMessage(decodeBase64(parsed.samlMessage));\n+        }", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2ODE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430168171", "bodyText": "buildXmlObject doesn't return null so I think we can remove this \"check and throw\"", "author": "jkakavas", "createdAt": "2020-05-26T05:46:43Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");\n+        } else if (httpRedirect == false && parsed.hasSignature) {\n+            throw samlException(\"URL is signed, but binding is HTTP-POST\");\n+        }\n+\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n+            root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n+        } else {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-POST binding\");\n+            root = parseSamlMessage(decodeBase64(parsed.samlMessage));\n+        }\n+\n+        if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n+            final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n+            if (logoutResponse == null) {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMTc4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431521782", "bodyText": "Indeed buildXmlObject does not return null. I'll remove it. Just for discussion: Since Java does not have proper null safty, aggressively checking for null return value could be argued as defensive coding or invariant enforcing. I think this could be a reason that we have many assert xxx statement throughout the code base. The difference is that they do not run in production but helps to catch potential code change gaps in testing. What would be your take on this?", "author": "ywangd", "createdAt": "2020-05-28T00:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2ODE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwNzkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431607906", "bodyText": "We do have asserts throughout the code base and we do have places where we add extra null checks \"just to be safe\", but we have been inconsistent in doing so I think. I love defensive coding as the next person but I don't know where the line should be drawn so that we don't have a if (x == null) check every 5 lines. Thinking out loud, we should be able to trust the methods we write to not return null unless they explicitly document that and handle null checks in the method instead of everywhere we call that method\nTim had shared some thoughts on asserts here: #52936 (comment)", "author": "jkakavas", "createdAt": "2020-05-28T06:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2ODE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2ODg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r432268840", "bodyText": "Thanks. The difference is subtle but insightful.", "author": "ywangd", "createdAt": "2020-05-29T05:50:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2ODE3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE2OTg1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430169852", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (httpRedirect == false && logoutResponse.getSignature() == null) {\n          \n          \n            \n                        // For HTTP-Redirect, we validate the signature while parsing the object from the query string\n          \n          \n            \n                        if (httpRedirect == false && logoutResponse.getSignature() == null) {", "author": "jkakavas", "createdAt": "2020-05-26T05:52:26Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+        if (httpRedirect && parsed.hasSignature == false) {\n+            throw samlException(\"URL is not signed, but is required for HTTP-Redirect binding\");\n+        } else if (httpRedirect == false && parsed.hasSignature) {\n+            throw samlException(\"URL is signed, but binding is HTTP-POST\");\n+        }\n+\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n+            root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n+        } else {\n+            logger.info(\"Process SAML LogoutResponse with HTTP-POST binding\");\n+            root = parseSamlMessage(decodeBase64(parsed.samlMessage));\n+        }\n+\n+        if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n+            final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n+            if (logoutResponse == null) {\n+                throw samlException(\"Cannot convert element {} into LogoutResponse object\", root);\n+            }\n+            if (httpRedirect == false && logoutResponse.getSignature() == null) {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 7abccd389cc..191b5a8f224 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -6,8 +6,15 @@\n \n package org.elasticsearch.xpack.security.authc.saml;\n \n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlLogoutResponseResponse;\n import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.StatusDetail;\n+import org.opensaml.saml.saml2.core.StatusMessage;\n+import org.opensaml.saml.saml2.core.StatusResponseType;\n import org.w3c.dom.Element;\n \n import java.time.Clock;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3MjQxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430172415", "bodyText": "Apologies for the merge conflicts that the SamlAuthenticatorTests refactoring causes here", "author": "jkakavas", "createdAt": "2020-05-26T06:00:24Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticatorTests.java", "diffHunk": "@@ -108,97 +85,20 @@\n import static org.opensaml.saml.saml2.core.SubjectConfirmation.METHOD_ATTRIB_NAME;\n import static org.opensaml.saml.saml2.core.SubjectConfirmation.METHOD_BEARER;\n \n-public class SamlAuthenticatorTests extends SamlTestCase {\n+public class SamlAuthenticatorTests extends SamlResponseHandlerTests {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMjA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431522055", "bodyText": "No worries. Wasn't too bad.", "author": "ywangd", "createdAt": "2020-05-28T00:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3MjQxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticatorTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticatorTests.java\nindex 3d9c5aaa522..f18a8a74ae4 100644\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticatorTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlAuthenticatorTests.java\n\n@@ -82,23 +120,99 @@ import static org.opensaml.saml.saml2.core.AuthnContext.KERBEROS_AUTHN_CTX;\n import static org.opensaml.saml.saml2.core.AuthnContext.PASSWORD_AUTHN_CTX;\n import static org.opensaml.saml.saml2.core.AuthnContext.X509_AUTHN_CTX;\n import static org.opensaml.saml.saml2.core.NameIDType.TRANSIENT;\n-import static org.opensaml.saml.saml2.core.SubjectConfirmation.METHOD_ATTRIB_NAME;\n import static org.opensaml.saml.saml2.core.SubjectConfirmation.METHOD_BEARER;\n+import static org.opensaml.saml.saml2.core.SubjectConfirmation.METHOD_HOLDER_OF_KEY;\n+\n+public class SamlAuthenticatorTests extends SamlTestCase {\n+\n+    private static final String SP_ENTITY_ID = \"https://sp.saml.elastic.test/\";\n+    private static final String IDP_ENTITY_ID = \"https://idp.saml.elastic.test/\";\n+    private static final String SP_ACS_URL = SP_ENTITY_ID + \"sso/post\";\n+    private static final String UID_OID = \"urn:oid:0.9.2342.19200300.100.1.1\";\n+\n+    private static Tuple<X509Certificate, PrivateKey> idpSigningCertificatePair;\n+    private static Tuple<X509Certificate, PrivateKey> spSigningCertificatePair;\n+    private static List<Tuple<X509Certificate, PrivateKey>> spEncryptionCertificatePairs;\n \n-public class SamlAuthenticatorTests extends SamlResponseHandlerTests {\n+    private static List<Integer> supportedAesKeyLengths;\n+    private static List<String> supportedAesTransformations;\n \n+    private ClockMock clock;\n     private SamlAuthenticator authenticator;\n+    private String requestId;\n+    private TimeValue maxSkew;\n+\n+    @BeforeClass\n+    public static void init() throws Exception {\n+        SamlUtils.initialize(LogManager.getLogger(SamlAuthenticatorTests.class));\n+        // Initialise Apache XML security so that the signDoc methods work correctly.\n+        Init.init();\n+    }\n+\n+    @BeforeClass\n+    public static void calculateAesLength() throws NoSuchAlgorithmException {\n+        supportedAesKeyLengths = new ArrayList<>();\n+        supportedAesTransformations = new ArrayList<>();\n+        supportedAesKeyLengths.add(128);\n+        supportedAesTransformations.add(XMLCipher.AES_128);\n+        supportedAesTransformations.add(XMLCipher.AES_128_GCM);\n+        if (Cipher.getMaxAllowedKeyLength(\"AES\") > 128) {\n+            supportedAesKeyLengths.add(192);\n+            supportedAesKeyLengths.add(256);\n+            supportedAesTransformations.add(XMLCipher.AES_192);\n+            supportedAesTransformations.add(XMLCipher.AES_192_GCM);\n+            supportedAesTransformations.add(XMLCipher.AES_256);\n+            supportedAesTransformations.add(XMLCipher.AES_256_GCM);\n+        }\n+    }\n+\n+    /**\n+     * Generating X.509 credentials can be CPU intensive and slow, so we only want to do it once per class.\n+     */\n+    @BeforeClass\n+    public static void initCredentials() throws Exception {\n+        idpSigningCertificatePair = readRandomKeyPair(randomSigningAlgorithm());\n+        spSigningCertificatePair = readRandomKeyPair(randomSigningAlgorithm());\n+        spEncryptionCertificatePairs = Arrays.asList(readKeyPair(\"ENCRYPTION_RSA_2048\"), readKeyPair(\"ENCRYPTION_RSA_4096\"));\n+    }\n+\n+    private static String randomSigningAlgorithm() {\n+        return randomFrom(\"RSA\", \"DSA\", \"EC\");\n+    }\n+\n+    @AfterClass\n+    public static void cleanup() {\n+        idpSigningCertificatePair = null;\n+        spSigningCertificatePair = null;\n+        spEncryptionCertificatePairs = null;\n+        supportedAesKeyLengths = null;\n+        supportedAesTransformations = null;\n+    }\n \n     @Before\n     public void setupAuthenticator() throws Exception {\n         this.clock = new ClockMock();\n         this.maxSkew = TimeValue.timeValueMinutes(1);\n+        this.authenticator = buildAuthenticator(() -> buildOpenSamlCredential(idpSigningCertificatePair), emptyList());\n         this.requestId = randomId();\n-        this.authenticator = new SamlAuthenticator(\n+    }\n+\n+    private SamlAuthenticator buildAuthenticator(Supplier<List<Credential>> credentials, List<String> reqAuthnCtxClassRef)\n+        throws Exception {\n+        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, credentials);\n+\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"),\n+            (X509Credential) buildOpenSamlCredential(spSigningCertificatePair).get(0));\n+        final List<X509Credential> spEncryptionCredentials = buildOpenSamlCredential(spEncryptionCertificatePairs).stream()\n+            .map((cred) -> (X509Credential) cred).collect(Collectors.<X509Credential>toList());\n+        final SpConfiguration sp = new SpConfiguration(SP_ENTITY_ID, SP_ACS_URL, null, signingConfiguration, spEncryptionCredentials,\n+            reqAuthnCtxClassRef);\n+        return new SamlAuthenticator(\n             clock,\n-            getIdpConfiguration(() -> buildOpenSamlCredential(idpSigningCertificatePair)),\n-            getSpConfiguration(emptyList()),\n-            maxSkew);\n+            idp,\n+            sp,\n+            maxSkew\n+        );\n     }\n \n     public void testParseEmptyContentIsRejected() throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE3ODAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430178000", "bodyText": "use Strings.hasText() instead of null check ?", "author": "jkakavas", "createdAt": "2020-05-26T06:17:22Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+/**\n+ * Represents a request to complete SAML LogoutResponse\n+ */\n+public final class SamlCompleteLogoutRequest extends ActionRequest {\n+\n+    private String queryString;\n+    private String content;\n+    private List<String> validRequestIds;\n+    @Nullable\n+    private String realm;\n+\n+    public SamlCompleteLogoutRequest(StreamInput in) throws IOException {\n+        super(in);\n+    }\n+\n+    public SamlCompleteLogoutRequest() {\n+    }\n+\n+    @Override\n+    public ActionRequestValidationException validate() {\n+        ActionRequestValidationException validationException = null;\n+        if (queryString == null && content == null) {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\ndeleted file mode 100644\nindex b539dcc8ae7..00000000000\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\n+++ /dev/null\n\n@@ -1,79 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-package org.elasticsearch.xpack.core.security.action.saml;\n-\n-import org.elasticsearch.action.ActionRequest;\n-import org.elasticsearch.action.ActionRequestValidationException;\n-import org.elasticsearch.common.Nullable;\n-import org.elasticsearch.common.io.stream.StreamInput;\n-\n-import java.io.IOException;\n-import java.util.List;\n-\n-import static org.elasticsearch.action.ValidateActions.addValidationError;\n-\n-/**\n- * Represents a request to complete SAML LogoutResponse\n- */\n-public final class SamlCompleteLogoutRequest extends ActionRequest {\n-\n-    private String queryString;\n-    private String content;\n-    private List<String> validRequestIds;\n-    @Nullable\n-    private String realm;\n-\n-    public SamlCompleteLogoutRequest(StreamInput in) throws IOException {\n-        super(in);\n-    }\n-\n-    public SamlCompleteLogoutRequest() {\n-    }\n-\n-    @Override\n-    public ActionRequestValidationException validate() {\n-        ActionRequestValidationException validationException = null;\n-        if (queryString == null && content == null) {\n-            validationException = addValidationError(\"queryString and content may not both be null\", validationException);\n-        }\n-        if (queryString != null && content != null) {\n-            validationException = addValidationError(\"queryString and content may not both present\", validationException);\n-        }\n-        return validationException;\n-    }\n-\n-    public void setContent(String content) {\n-        this.content = content;\n-    }\n-\n-    public void setQueryString(String queryString) {\n-        this.queryString = queryString;\n-    }\n-\n-    public List<String> getValidRequestIds() {\n-        return validRequestIds;\n-    }\n-\n-    public void setValidRequestIds(List<String> validRequestIds) {\n-        this.validRequestIds = validRequestIds;\n-    }\n-\n-    public String getRealm() {\n-        return realm;\n-    }\n-\n-    public void setRealm(String realm) {\n-        this.realm = realm;\n-    }\n-\n-    public boolean isHttpRedirect() {\n-        return queryString != null;\n-    }\n-\n-    public String getPayload() {\n-        return isHttpRedirect() ? queryString : content;\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MTA0NA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430181044", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testHandlerWillFailWhenUrlNotSigned() {\n          \n          \n            \n                public void testHandlerWillFailWhenLogoutResponseNotSigned() {", "author": "jkakavas", "createdAt": "2020-05-26T06:25:33Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.set.Sets;\n+import org.joda.time.DateTime;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.opensaml.saml.saml2.core.Issuer;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n+import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n+import org.opensaml.security.x509.X509Credential;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.time.Clock;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n+\n+    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n+    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n+\n+    private Clock clock;\n+    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n+\n+    private static X509Credential credential;\n+\n+    @BeforeClass\n+    public static void setupCredential() throws Exception {\n+        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+    }\n+\n+    @AfterClass\n+    public static void clearCredential() {\n+        credential = null;\n+    }\n+\n+    @Before\n+    public void setupHandler() throws Exception {\n+        clock = Clock.systemUTC();\n+        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n+        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n+        final SpConfiguration sp = new SpConfiguration(\n+            \"https://sp.test/\",\n+            \"https://sp.test/saml/asc\",\n+            LOGOUT_URL,\n+            signingConfiguration,\n+            List.of(spCredential),\n+            Collections.emptyList());\n+        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n+    }\n+\n+    public void testHandlerWorks() throws URISyntaxException {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+        samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId));\n+    }\n+\n+    public void testHandlerFailsIfStatusIsNotSuccess() {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+\n+        final ElasticsearchSecurityException e =\n+            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n+        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n+    }\n+\n+    public void testHandlerWillFailWhenUrlNotSigned() {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\ndeleted file mode 100644\nindex 7055769e8d1..00000000000\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\n+++ /dev/null\n\n@@ -1,151 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.security.authc.saml;\n-\n-import org.elasticsearch.ElasticsearchSecurityException;\n-import org.elasticsearch.common.unit.TimeValue;\n-import org.elasticsearch.common.util.set.Sets;\n-import org.joda.time.DateTime;\n-import org.junit.AfterClass;\n-import org.junit.Before;\n-import org.junit.BeforeClass;\n-import org.opensaml.saml.saml2.core.Issuer;\n-import org.opensaml.saml.saml2.core.LogoutResponse;\n-import org.opensaml.saml.saml2.core.Status;\n-import org.opensaml.saml.saml2.core.StatusCode;\n-import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n-import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n-import org.opensaml.security.x509.X509Credential;\n-\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.time.Clock;\n-import java.util.Collections;\n-import java.util.List;\n-\n-import static org.hamcrest.Matchers.containsString;\n-\n-public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n-\n-    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n-    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n-\n-    private Clock clock;\n-    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n-\n-    private static X509Credential credential;\n-\n-    @BeforeClass\n-    public static void setupCredential() throws Exception {\n-        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-    }\n-\n-    @AfterClass\n-    public static void clearCredential() {\n-        credential = null;\n-    }\n-\n-    @Before\n-    public void setupHandler() throws Exception {\n-        clock = Clock.systemUTC();\n-        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n-        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n-        final SpConfiguration sp = new SpConfiguration(\n-            \"https://sp.test/\",\n-            \"https://sp.test/saml/asc\",\n-            LOGOUT_URL,\n-            signingConfiguration,\n-            List.of(spCredential),\n-            Collections.emptyList());\n-        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n-    }\n-\n-    public void testHandlerWorks() throws URISyntaxException {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId));\n-    }\n-\n-    public void testHandlerFailsIfStatusIsNotSuccess() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n-    }\n-\n-    public void testHandlerWillFailWhenUrlNotSigned() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), null);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"URL is not signed, but is required for HTTP-Redirect binding\"));\n-    }\n-\n-    public void testHandlerWillFailWhenUrlIsSignedButBindingIsHttpPost() throws URISyntaxException {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(false, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"URL is signed, but binding is HTTP-POST\"));\n-    }\n-\n-    private Status buildStatus(String statusCodeValue) {\n-        final Status status = new StatusBuilder().buildObject();\n-        final StatusCode statusCode = new StatusCodeBuilder().buildObject();\n-        statusCode.setValue(statusCodeValue);\n-        status.setStatusCode(statusCode);\n-        return status;\n-    }\n-\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MTMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r430181321", "bodyText": "I don't think we need this", "author": "jkakavas", "createdAt": "2020-05-26T06:26:18Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.ElasticsearchSecurityException;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.set.Sets;\n+import org.joda.time.DateTime;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.opensaml.saml.saml2.core.Issuer;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.opensaml.saml.saml2.core.Status;\n+import org.opensaml.saml.saml2.core.StatusCode;\n+import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n+import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n+import org.opensaml.security.x509.X509Credential;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.time.Clock;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.containsString;\n+\n+public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n+\n+    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n+    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n+\n+    private Clock clock;\n+    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n+\n+    private static X509Credential credential;\n+\n+    @BeforeClass\n+    public static void setupCredential() throws Exception {\n+        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+    }\n+\n+    @AfterClass\n+    public static void clearCredential() {\n+        credential = null;\n+    }\n+\n+    @Before\n+    public void setupHandler() throws Exception {\n+        clock = Clock.systemUTC();\n+        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n+        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n+        final SpConfiguration sp = new SpConfiguration(\n+            \"https://sp.test/\",\n+            \"https://sp.test/saml/asc\",\n+            LOGOUT_URL,\n+            signingConfiguration,\n+            List.of(spCredential),\n+            Collections.emptyList());\n+        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n+    }\n+\n+    public void testHandlerWorks() throws URISyntaxException {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+        samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId));\n+    }\n+\n+    public void testHandlerFailsIfStatusIsNotSuccess() {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+\n+        final ElasticsearchSecurityException e =\n+            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n+        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n+    }\n+\n+    public void testHandlerWillFailWhenUrlNotSigned() {\n+        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n+        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), null);\n+        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n+        logoutResponse.setDestination(LOGOUT_URL);\n+        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n+        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n+        logoutResponse.setInResponseTo(requestId);\n+        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n+\n+        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n+        issuer.setValue(IDP_ENTITY_ID);\n+        logoutResponse.setIssuer(issuer);\n+        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n+        final ElasticsearchSecurityException e =\n+            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n+        assertThat(e.getMessage(), containsString(\"URL is not signed, but is required for HTTP-Redirect binding\"));\n+    }\n+\n+    public void testHandlerWillFailWhenUrlIsSignedButBindingIsHttpPost() throws URISyntaxException {", "originalCommit": "e6e45da939af6b4a9b36814ff1b007972c75bc41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMTg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431521884", "bodyText": "Removed", "author": "ywangd", "createdAt": "2020-05-28T00:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MTMyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "a7187ca208b4a7815d8be38c6214cecb610e3376", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\ndeleted file mode 100644\nindex 7055769e8d1..00000000000\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandlerHttpRedirectTests.java\n+++ /dev/null\n\n@@ -1,151 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.security.authc.saml;\n-\n-import org.elasticsearch.ElasticsearchSecurityException;\n-import org.elasticsearch.common.unit.TimeValue;\n-import org.elasticsearch.common.util.set.Sets;\n-import org.joda.time.DateTime;\n-import org.junit.AfterClass;\n-import org.junit.Before;\n-import org.junit.BeforeClass;\n-import org.opensaml.saml.saml2.core.Issuer;\n-import org.opensaml.saml.saml2.core.LogoutResponse;\n-import org.opensaml.saml.saml2.core.Status;\n-import org.opensaml.saml.saml2.core.StatusCode;\n-import org.opensaml.saml.saml2.core.impl.StatusBuilder;\n-import org.opensaml.saml.saml2.core.impl.StatusCodeBuilder;\n-import org.opensaml.security.x509.X509Credential;\n-\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.time.Clock;\n-import java.util.Collections;\n-import java.util.List;\n-\n-import static org.hamcrest.Matchers.containsString;\n-\n-public class SamlLogoutResponseHandlerHttpRedirectTests extends SamlTestCase {\n-\n-    private static final String IDP_ENTITY_ID = \"https://idp.test/\";\n-    private static final String LOGOUT_URL = \"https://sp.test/saml/logout\";\n-\n-    private Clock clock;\n-    private SamlLogoutResponseHandler samlLogoutResponseHandler;\n-\n-    private static X509Credential credential;\n-\n-    @BeforeClass\n-    public static void setupCredential() throws Exception {\n-        credential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-    }\n-\n-    @AfterClass\n-    public static void clearCredential() {\n-        credential = null;\n-    }\n-\n-    @Before\n-    public void setupHandler() throws Exception {\n-        clock = Clock.systemUTC();\n-        final IdpConfiguration idp = new IdpConfiguration(IDP_ENTITY_ID, () -> Collections.singletonList(credential));\n-        final X509Credential spCredential = (X509Credential) buildOpenSamlCredential(readRandomKeyPair()).get(0);\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Collections.singleton(\"*\"), spCredential);\n-        final SpConfiguration sp = new SpConfiguration(\n-            \"https://sp.test/\",\n-            \"https://sp.test/saml/asc\",\n-            LOGOUT_URL,\n-            signingConfiguration,\n-            List.of(spCredential),\n-            Collections.emptyList());\n-        samlLogoutResponseHandler = new SamlLogoutResponseHandler(clock, idp, sp, TimeValue.timeValueSeconds(1));\n-    }\n-\n-    public void testHandlerWorks() throws URISyntaxException {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId));\n-    }\n-\n-    public void testHandlerFailsIfStatusIsNotSuccess() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"is not a 'success' response\"));\n-    }\n-\n-    public void testHandlerWillFailWhenUrlNotSigned() {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), null);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(randomFrom(StatusCode.REQUESTER, StatusCode.RESPONDER)));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(true, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"URL is not signed, but is required for HTTP-Redirect binding\"));\n-    }\n-\n-    public void testHandlerWillFailWhenUrlIsSignedButBindingIsHttpPost() throws URISyntaxException {\n-        final String requestId = SamlUtils.generateSecureNCName(randomIntBetween(8, 30));\n-        final SigningConfiguration signingConfiguration = new SigningConfiguration(Sets.newHashSet(\"*\"), credential);\n-        final LogoutResponse logoutResponse = SamlUtils.buildObject(LogoutResponse.class, LogoutResponse.DEFAULT_ELEMENT_NAME);\n-        logoutResponse.setDestination(LOGOUT_URL);\n-        logoutResponse.setIssueInstant(new DateTime(clock.millis()));\n-        logoutResponse.setID(SamlUtils.generateSecureNCName(randomIntBetween(8, 30)));\n-        logoutResponse.setInResponseTo(requestId);\n-        logoutResponse.setStatus(buildStatus(StatusCode.SUCCESS));\n-\n-        final Issuer issuer = SamlUtils.buildObject(Issuer.class, Issuer.DEFAULT_ELEMENT_NAME);\n-        issuer.setValue(IDP_ENTITY_ID);\n-        logoutResponse.setIssuer(issuer);\n-        final String url = new SamlRedirect(logoutResponse, signingConfiguration).getRedirectUrl();\n-        final ElasticsearchSecurityException e =\n-            expectSamlException(() -> samlLogoutResponseHandler.handle(false, new URI(url).getRawQuery(), List.of(requestId)));\n-        assertThat(e.getMessage(), containsString(\"URL is signed, but binding is HTTP-POST\"));\n-    }\n-\n-    private Status buildStatus(String statusCodeValue) {\n-        final Status status = new StatusBuilder().buildObject();\n-        final StatusCode statusCode = new StatusCodeBuilder().buildObject();\n-        statusCode.setValue(statusCodeValue);\n-        status.setStatusCode(statusCode);\n-        return status;\n-    }\n-\n-}\n"}}, {"oid": "a7187ca208b4a7815d8be38c6214cecb610e3376", "url": "https://github.com/elastic/elasticsearch/commit/a7187ca208b4a7815d8be38c6214cecb610e3376", "message": "Initial working version. No tests yet", "committedDate": "2020-05-27T06:53:36Z", "type": "commit"}, {"oid": "3180c86397690d742e4fff48b9bc98b0e70f8229", "url": "https://github.com/elastic/elasticsearch/commit/3180c86397690d742e4fff48b9bc98b0e70f8229", "message": "Refactor and add tests", "committedDate": "2020-05-27T12:05:08Z", "type": "commit"}, {"oid": "e6d4d5a4e5068870a86e7e8e37cccb1548c76da0", "url": "https://github.com/elastic/elasticsearch/commit/e6d4d5a4e5068870a86e7e8e37cccb1548c76da0", "message": "fix copy/paste text", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "3ef50a1329c35e0197f0b0e41601c64c3ec6af28", "url": "https://github.com/elastic/elasticsearch/commit/3ef50a1329c35e0197f0b0e41601c64c3ec6af28", "message": "Add requestId to logout response for kibana to pass it back", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "c5633e57b5839e0065a4c1a29902f31b47a344d3", "url": "https://github.com/elastic/elasticsearch/commit/c5633e57b5839e0065a4c1a29902f31b47a344d3", "message": "checkstyle", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "c1ea969b20ffe19c4c73e8ed51d3ec2cbb9209c4", "url": "https://github.com/elastic/elasticsearch/commit/c1ea969b20ffe19c4c73e8ed51d3ec2cbb9209c4", "message": "Support LogoutResponse with both HTTP-Redirect and HTTP-Post bindings", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "bcaf87da675548fef2357052f0b9baf8e413408a", "url": "https://github.com/elastic/elasticsearch/commit/bcaf87da675548fef2357052f0b9baf8e413408a", "message": "Rename and checkstyle", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "824b5608185c23acbae62374e0d060e6df500696", "url": "https://github.com/elastic/elasticsearch/commit/824b5608185c23acbae62374e0d060e6df500696", "message": "Forbidden API", "committedDate": "2020-05-27T12:05:09Z", "type": "commit"}, {"oid": "41494c4192829e70803de7c21c376d5ceb0bf958", "url": "https://github.com/elastic/elasticsearch/commit/41494c4192829e70803de7c21c376d5ceb0bf958", "message": "Address feedback", "committedDate": "2020-05-27T12:05:10Z", "type": "commit"}, {"oid": "c0e4089adb6dac6851b8e518b6b480efebf91d52", "url": "https://github.com/elastic/elasticsearch/commit/c0e4089adb6dac6851b8e518b6b480efebf91d52", "message": "Address feedback for removing auto-detect of redirect and post", "committedDate": "2020-05-27T12:05:10Z", "type": "commit"}, {"oid": "48c27d6a32b3657ce3011ca642b5ddf59c5a1089", "url": "https://github.com/elastic/elasticsearch/commit/48c27d6a32b3657ce3011ca642b5ddf59c5a1089", "message": "Fix test convention", "committedDate": "2020-05-27T12:05:10Z", "type": "commit"}, {"oid": "17903a363f26f4748f2e4b87bbc0b586f51665dc", "url": "https://github.com/elastic/elasticsearch/commit/17903a363f26f4748f2e4b87bbc0b586f51665dc", "message": "checkstyle", "committedDate": "2020-05-27T12:05:10Z", "type": "commit"}, {"oid": "e297fa5eaa84fb16904d6045e1a0b32309d7e4d3", "url": "https://github.com/elastic/elasticsearch/commit/e297fa5eaa84fb16904d6045e1a0b32309d7e4d3", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>", "committedDate": "2020-05-27T12:05:10Z", "type": "commit"}, {"oid": "c22674ddbbba0e678e305556c9a9c3c858be463d", "url": "https://github.com/elastic/elasticsearch/commit/c22674ddbbba0e678e305556c9a9c3c858be463d", "message": "Tidy up a bit due to latest change in master", "committedDate": "2020-05-27T13:33:36Z", "type": "commit"}, {"oid": "c22674ddbbba0e678e305556c9a9c3c858be463d", "url": "https://github.com/elastic/elasticsearch/commit/c22674ddbbba0e678e305556c9a9c3c858be463d", "message": "Tidy up a bit due to latest change in master", "committedDate": "2020-05-27T13:33:36Z", "type": "forcePushed"}, {"oid": "a56bbccb3693a728dfe204f30e527e1fbec959f7", "url": "https://github.com/elastic/elasticsearch/commit/a56bbccb3693a728dfe204f30e527e1fbec959f7", "message": "Fix randomize of signer", "committedDate": "2020-05-27T13:50:11Z", "type": "commit"}, {"oid": "f2ed7dfc7a45bb2a06c9ed1a0eae5382864d5ef8", "url": "https://github.com/elastic/elasticsearch/commit/f2ed7dfc7a45bb2a06c9ed1a0eae5382864d5ef8", "message": "Address feedback", "committedDate": "2020-05-28T00:54:52Z", "type": "commit"}, {"oid": "04abf77695250be9a29b4e1e5c57b17a77802ddc", "url": "https://github.com/elastic/elasticsearch/commit/04abf77695250be9a29b4e1e5c57b17a77802ddc", "message": "Merge remote-tracking branch 'origin/master' into es-43264-saml-post-logout", "committedDate": "2020-05-28T01:26:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMDM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431920373", "bodyText": "could we also validate that the realm is not an empty string here so that we fail explicitly here instead of in the Transport action's doExecute ?", "author": "jkakavas", "createdAt": "2020-05-28T15:20:25Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+/**\n+ * Represents a request to complete SAML LogoutResponse\n+ */\n+public final class SamlCompleteLogoutRequest extends ActionRequest {\n+\n+    @Nullable\n+    private String queryString;\n+    @Nullable\n+    private String content;\n+    private List<String> validRequestIds;\n+    @Nullable\n+    private String realm;\n+\n+    public SamlCompleteLogoutRequest(StreamInput in) throws IOException {\n+        super(in);\n+    }\n+\n+    public SamlCompleteLogoutRequest() {\n+    }\n+\n+    @Override\n+    public ActionRequestValidationException validate() {", "originalCommit": "04abf77695250be9a29b4e1e5c57b17a77802ddc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI2Mzg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r432263855", "bodyText": "Added. Also removed the @Nullable annotation from the realm field.", "author": "ywangd", "createdAt": "2020-05-29T05:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyMDM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "88862ab16b9fc0a928192706ef44f2e39202f97a", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\nindex 6ea37232135..714c714a104 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\n\n@@ -26,7 +26,6 @@ public final class SamlCompleteLogoutRequest extends ActionRequest {\n     @Nullable\n     private String content;\n     private List<String> validRequestIds;\n-    @Nullable\n     private String realm;\n \n     public SamlCompleteLogoutRequest(StreamInput in) throws IOException {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkyODQ4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431928485", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm for [{}]\", request));\n          \n          \n            \n                        listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm with name [{}]\", request.getRealm()));", "author": "jkakavas", "createdAt": "2020-05-28T15:31:22Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.security.action.saml;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutAction;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutRequest;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutResponse;\n+import org.elasticsearch.xpack.security.authc.Realms;\n+import org.elasticsearch.xpack.security.authc.saml.SamlLogoutResponseHandler;\n+import org.elasticsearch.xpack.security.authc.saml.SamlRealm;\n+import org.elasticsearch.xpack.security.authc.saml.SamlUtils;\n+\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlRealm.findSamlRealms;\n+\n+/**\n+ * Transport action responsible for completing SAML LogoutResponse\n+ */\n+public final class TransportSamlCompleteLogoutAction extends HandledTransportAction<SamlCompleteLogoutRequest, SamlCompleteLogoutResponse> {\n+\n+    private final Realms realms;\n+\n+    @Inject\n+    public TransportSamlCompleteLogoutAction(TransportService transportService, ActionFilters actionFilters, Realms realms) {\n+        super(SamlCompleteLogoutAction.NAME, transportService, actionFilters, SamlCompleteLogoutRequest::new);\n+        this.realms = realms;\n+    }\n+\n+    @Override\n+    protected void doExecute(Task task, SamlCompleteLogoutRequest request, ActionListener<SamlCompleteLogoutResponse> listener) {\n+        List<SamlRealm> realms = findSamlRealms(this.realms, request.getRealm(), null);\n+        if (realms.isEmpty()) {\n+            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm for [{}]\", request));", "originalCommit": "04abf77695250be9a29b4e1e5c57b17a77802ddc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b85c075176c0ac6c0709703cc857e034ec5d5dd", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\nindex 811baf044e8..63db889b79c 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n\n@@ -40,7 +40,7 @@ public final class TransportSamlCompleteLogoutAction extends HandledTransportAct\n     protected void doExecute(Task task, SamlCompleteLogoutRequest request, ActionListener<SamlCompleteLogoutResponse> listener) {\n         List<SamlRealm> realms = findSamlRealms(this.realms, request.getRealm(), null);\n         if (realms.isEmpty()) {\n-            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm for [{}]\", request));\n+            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm with name [{}]\", request.getRealm()));\n         } else if (realms.size() > 1) {\n             listener.onFailure(SamlUtils.samlException(\"Found multiple matching realms [{}] for [{}]\", realms, request));\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzMDE2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431930166", "bodyText": "Just a suggestion given that we search with a realm name only here. Traditionally we would search either with an ACS or a realm name that's why we had a more generic message here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        listener.onFailure(SamlUtils.samlException(\"Found multiple matching realms [{}] for [{}]\", realms, request));\n          \n          \n            \n                        listener.onFailure(SamlUtils.samlException(\"Found multiple matching realms [{}] with name [{}]\", realms, request.getRealm()));", "author": "jkakavas", "createdAt": "2020-05-28T15:33:37Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.security.action.saml;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.HandledTransportAction;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutAction;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutRequest;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutResponse;\n+import org.elasticsearch.xpack.security.authc.Realms;\n+import org.elasticsearch.xpack.security.authc.saml.SamlLogoutResponseHandler;\n+import org.elasticsearch.xpack.security.authc.saml.SamlRealm;\n+import org.elasticsearch.xpack.security.authc.saml.SamlUtils;\n+\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlRealm.findSamlRealms;\n+\n+/**\n+ * Transport action responsible for completing SAML LogoutResponse\n+ */\n+public final class TransportSamlCompleteLogoutAction extends HandledTransportAction<SamlCompleteLogoutRequest, SamlCompleteLogoutResponse> {\n+\n+    private final Realms realms;\n+\n+    @Inject\n+    public TransportSamlCompleteLogoutAction(TransportService transportService, ActionFilters actionFilters, Realms realms) {\n+        super(SamlCompleteLogoutAction.NAME, transportService, actionFilters, SamlCompleteLogoutRequest::new);\n+        this.realms = realms;\n+    }\n+\n+    @Override\n+    protected void doExecute(Task task, SamlCompleteLogoutRequest request, ActionListener<SamlCompleteLogoutResponse> listener) {\n+        List<SamlRealm> realms = findSamlRealms(this.realms, request.getRealm(), null);\n+        if (realms.isEmpty()) {\n+            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm for [{}]\", request));\n+        } else if (realms.size() > 1) {\n+            listener.onFailure(SamlUtils.samlException(\"Found multiple matching realms [{}] for [{}]\", realms, request));", "originalCommit": "04abf77695250be9a29b4e1e5c57b17a77802ddc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b85c075176c0ac6c0709703cc857e034ec5d5dd", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\nindex 811baf044e8..63db889b79c 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n\n@@ -40,7 +40,7 @@ public final class TransportSamlCompleteLogoutAction extends HandledTransportAct\n     protected void doExecute(Task task, SamlCompleteLogoutRequest request, ActionListener<SamlCompleteLogoutResponse> listener) {\n         List<SamlRealm> realms = findSamlRealms(this.realms, request.getRealm(), null);\n         if (realms.isEmpty()) {\n-            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm for [{}]\", request));\n+            listener.onFailure(SamlUtils.samlException(\"Cannot find any matching realm with name [{}]\", request.getRealm()));\n         } else if (realms.size() > 1) {\n             listener.onFailure(SamlUtils.samlException(\"Found multiple matching realms [{}] for [{}]\", realms, request));\n         } else {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkzNDAwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r431934009", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (httpRedirect == false && logoutResponse.getSignature() == null) {\n          \n          \n            \n                            throw samlException(\"LogoutResponse is not signed, but a signature is required for HTTP-Post binding\");\n          \n          \n            \n                        } else if (httpRedirect == false) {\n          \n          \n            \n                            validateSignature(logoutResponse.getSignature());\n          \n          \n            \n                        }\n          \n          \n            \n                        if (httpRedirect == false) {\n          \n          \n            \n                            if (logoutResponse.getSignature() == null) {\n          \n          \n            \n                                throw samlException(\"LogoutResponse is not signed, but a signature is required for HTTP-Post binding\");\n          \n          \n            \n                            }    \n          \n          \n            \n                            validateSignature(logoutResponse.getSignature());\n          \n          \n            \n                        }", "author": "jkakavas", "createdAt": "2020-05-28T15:38:59Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.authc.saml;\n+\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.opensaml.saml.saml2.core.LogoutResponse;\n+import org.w3c.dom.Element;\n+\n+import java.time.Clock;\n+import java.util.Collection;\n+\n+import static org.elasticsearch.xpack.security.authc.saml.SamlUtils.samlException;\n+\n+public class SamlLogoutResponseHandler extends SamlResponseHandler {\n+\n+    private static final String LOGOUT_RESPONSE_TAG_NAME = \"LogoutResponse\";\n+\n+    public SamlLogoutResponseHandler(\n+        Clock clock, IdpConfiguration idp, SpConfiguration sp, TimeValue maxSkew) {\n+        super(clock, idp, sp, maxSkew);\n+    }\n+\n+    public void handle(boolean httpRedirect, String payload, Collection<String> allowedSamlRequestIds) {\n+        final Element root;\n+        if (httpRedirect) {\n+            logger.debug(\"Process SAML LogoutResponse with HTTP-Redirect binding\");\n+            final ParsedQueryString parsed = parseQueryStringAndValidateSignature(payload, \"SAMLResponse\");\n+            if (parsed.hasSignature == false){\n+                throw samlException(\"Query string is not signed, but is required for HTTP-Redirect binding\");\n+            }\n+            root = parseSamlMessage(inflate(decodeBase64(parsed.samlMessage)));\n+        } else {\n+            logger.debug(\"Process SAML LogoutResponse with HTTP-POST binding\");\n+            root = parseSamlMessage(decodeBase64(payload));\n+        }\n+\n+        if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n+            final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n+            // For HTTP-Redirect, we validate the signature while parsing the object from the query string\n+            if (httpRedirect == false && logoutResponse.getSignature() == null) {\n+                throw samlException(\"LogoutResponse is not signed, but a signature is required for HTTP-Post binding\");\n+            } else if (httpRedirect == false) {\n+                validateSignature(logoutResponse.getSignature());\n+            }", "originalCommit": "04abf77695250be9a29b4e1e5c57b17a77802ddc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a9b890a255bbfb3c541788fa8cfbbc72353a6226", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\nindex 3ff02e5e52e..9f12127ea09 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\n@@ -41,9 +41,10 @@ public class SamlLogoutResponseHandler extends SamlResponseHandler {\n         if (LOGOUT_RESPONSE_TAG_NAME.equals(root.getLocalName()) && SAML_NAMESPACE.equals(root.getNamespaceURI())) {\n             final LogoutResponse logoutResponse = buildXmlObject(root, LogoutResponse.class);\n             // For HTTP-Redirect, we validate the signature while parsing the object from the query string\n-            if (httpRedirect == false && logoutResponse.getSignature() == null) {\n-                throw samlException(\"LogoutResponse is not signed, but a signature is required for HTTP-Post binding\");\n-            } else if (httpRedirect == false) {\n+            if (httpRedirect == false) {\n+                if (logoutResponse.getSignature() == null) {\n+                    throw samlException(\"LogoutResponse is not signed, but a signature is required for HTTP-Post binding\");\n+                }    \n                 validateSignature(logoutResponse.getSignature());\n             }\n             checkInResponseTo(logoutResponse, allowedSamlRequestIds);\n"}}, {"oid": "2b85c075176c0ac6c0709703cc857e034ec5d5dd", "url": "https://github.com/elastic/elasticsearch/commit/2b85c075176c0ac6c0709703cc857e034ec5d5dd", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>", "committedDate": "2020-05-29T05:24:19Z", "type": "commit"}, {"oid": "a9b890a255bbfb3c541788fa8cfbbc72353a6226", "url": "https://github.com/elastic/elasticsearch/commit/a9b890a255bbfb3c541788fa8cfbbc72353a6226", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/saml/SamlLogoutResponseHandler.java\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>", "committedDate": "2020-05-29T05:28:31Z", "type": "commit"}, {"oid": "99704d23893c98394ab19f0fe768bb2036be7431", "url": "https://github.com/elastic/elasticsearch/commit/99704d23893c98394ab19f0fe768bb2036be7431", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/saml/TransportSamlCompleteLogoutAction.java\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>", "committedDate": "2020-05-29T05:32:26Z", "type": "commit"}, {"oid": "88862ab16b9fc0a928192706ef44f2e39202f97a", "url": "https://github.com/elastic/elasticsearch/commit/88862ab16b9fc0a928192706ef44f2e39202f97a", "message": "Address feedback", "committedDate": "2020-05-29T05:33:25Z", "type": "commit"}, {"oid": "512873794161a1de417420cf43e68b3b001b9d66", "url": "https://github.com/elastic/elasticsearch/commit/512873794161a1de417420cf43e68b3b001b9d66", "message": "Add one more test for non-null realm field", "committedDate": "2020-05-29T05:35:32Z", "type": "commit"}, {"oid": "19a0afc777b4ddf22a70a1d00c4500b3989d6f31", "url": "https://github.com/elastic/elasticsearch/commit/19a0afc777b4ddf22a70a1d00c4500b3989d6f31", "message": "Merge remote-tracking branch 'origin/master' into es-43264-saml-post-logout", "committedDate": "2020-05-29T05:53:13Z", "type": "commit"}, {"oid": "c244cb6ec407a0151b97b7eece08d7a74c0e0e6a", "url": "https://github.com/elastic/elasticsearch/commit/c244cb6ec407a0151b97b7eece08d7a74c0e0e6a", "message": "Merge remote-tracking branch 'origin/master' into es-43264-saml-post-logout", "committedDate": "2020-05-29T14:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAwOTU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r433009595", "bodyText": "What is our expectation for how a WebApp should behave if it gets a LogoutResponse over a HTTP-POST binding that also has URL parameters?\nI think the rule for Kibana is:\n\nIf the http method is GET send the queryString to Elasticsearch, and ignore (or reject) any body (which is very unlikely to exist)\nif the http method is POST ignore (or reject) the query parameters, and send the body to Elasticsearch.\n\nIs that our intent?", "author": "tvernum", "createdAt": "2020-06-01T01:37:37Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.security.action.saml;\n+\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+/**\n+ * Represents a request to complete SAML LogoutResponse\n+ */\n+public final class SamlCompleteLogoutRequest extends ActionRequest {\n+\n+    @Nullable\n+    private String queryString;\n+    @Nullable\n+    private String content;\n+    private List<String> validRequestIds;\n+    private String realm;\n+\n+    public SamlCompleteLogoutRequest(StreamInput in) throws IOException {\n+        super(in);\n+    }\n+\n+    public SamlCompleteLogoutRequest() {\n+    }\n+\n+    @Override\n+    public ActionRequestValidationException validate() {\n+        ActionRequestValidationException validationException = null;\n+        if (Strings.hasText(realm) == false) {\n+            validationException = addValidationError(\"realm may not be empty\", validationException);\n+        }\n+        if (Strings.hasText(queryString) == false && Strings.hasText(content) == false) {\n+            validationException = addValidationError(\"queryString and content may not both be empty\", validationException);\n+        }\n+        if (Strings.hasText(queryString) && Strings.hasText(content)) {\n+            validationException = addValidationError(\"queryString and content may not both present\", validationException);", "originalCommit": "c244cb6ec407a0151b97b7eece08d7a74c0e0e6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwOTU3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r433209579", "bodyText": "A good question. To be honest, I haven't really considered this thoroughly. I think your suggestion makes sense because the code proceeds as HTTP-POST, e.g. base64 encode, no deflate and XML signature, when content is present. This basically says content implies POST, which in turn means queryString implies GET.\nI would personally prefer to ignore the body for GET and query string for POST since the spec does not explicitly forbid them.", "author": "ywangd", "createdAt": "2020-06-01T12:39:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAwOTU5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "75abd7b2686bd8869f4529ed248cf735c7ba6a74", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\nindex 714c714a104..cd3d8e2dec5 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlCompleteLogoutRequest.java\n\n@@ -50,14 +50,22 @@ public final class SamlCompleteLogoutRequest extends ActionRequest {\n         return validationException;\n     }\n \n-    public void setContent(String content) {\n-        this.content = content;\n+    public String getQueryString() {\n+        return queryString;\n     }\n \n     public void setQueryString(String queryString) {\n         this.queryString = queryString;\n     }\n \n+    public String getContent() {\n+        return content;\n+    }\n+\n+    public void setContent(String content) {\n+        this.content = content;\n+    }\n+\n     public List<String> getValidRequestIds() {\n         return validRequestIds;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxMTY4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r433011683", "bodyText": "Why do we have another class here, rather than just using SamlCompleteLogoutRequest ?", "author": "tvernum", "createdAt": "2020-06-01T01:50:51Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlCompleteLogoutAction.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.security.rest.action.saml;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.license.XPackLicenseState;\n+import org.elasticsearch.rest.BytesRestResponse;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.RestResponse;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.rest.action.RestBuilderListener;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutRequestBuilder;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutResponse;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static org.elasticsearch.rest.RestRequest.Method.POST;\n+\n+/**\n+ * This Rest endpoint handles SAML LogoutResponse sent from idP with either HTTP-Redirect or HTTP-Post binding.\n+ * For HTTP-Redirect binding, it expects {@link Input#queryString} be set to the query string of the redirect URI.\n+ * For HTTP-Post binding, it expects {@link Input#content} be set to the value of SAMLResponse form parameter, i.e.\n+ * caller of this API must do the work to extract the SAMLResponse value from body of the HTTP-Post request. The\n+ * value must also be URL decoded if necessary.\n+ */\n+public class RestSamlCompleteLogoutAction extends SamlBaseRestHandler{\n+\n+    private static final Logger logger = LogManager.getLogger(RestSamlCompleteLogoutAction.class);\n+\n+    static class Input {", "originalCommit": "c244cb6ec407a0151b97b7eece08d7a74c0e0e6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIxOTQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56316#discussion_r433219465", "bodyText": "Because of copy/paste ... removed it. thanks", "author": "ywangd", "createdAt": "2020-06-01T13:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxMTY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "75abd7b2686bd8869f4529ed248cf735c7ba6a74", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlCompleteLogoutAction.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlCompleteLogoutAction.java\nindex 6c73a95eb8a..dfee78471e2 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlCompleteLogoutAction.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlCompleteLogoutAction.java\n\n@@ -21,7 +21,8 @@ import org.elasticsearch.rest.RestRequest;\n import org.elasticsearch.rest.RestResponse;\n import org.elasticsearch.rest.RestStatus;\n import org.elasticsearch.rest.action.RestBuilderListener;\n-import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutRequestBuilder;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutAction;\n+import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutRequest;\n import org.elasticsearch.xpack.core.security.action.saml.SamlCompleteLogoutResponse;\n \n import java.io.IOException;\n"}}, {"oid": "75abd7b2686bd8869f4529ed248cf735c7ba6a74", "url": "https://github.com/elastic/elasticsearch/commit/75abd7b2686bd8869f4529ed248cf735c7ba6a74", "message": "Address feedback", "committedDate": "2020-06-01T12:59:25Z", "type": "commit"}, {"oid": "b82275dea7bd139ac2ffbcdea75686f0aaba0a92", "url": "https://github.com/elastic/elasticsearch/commit/b82275dea7bd139ac2ffbcdea75686f0aaba0a92", "message": "Merge remote-tracking branch 'origin/master' into es-43264-saml-post-logout", "committedDate": "2020-06-01T13:00:35Z", "type": "commit"}, {"oid": "f6b4fcb850cf0c9fc9e3cc9f36e02396b4a26233", "url": "https://github.com/elastic/elasticsearch/commit/f6b4fcb850cf0c9fc9e3cc9f36e02396b4a26233", "message": "Merge remote-tracking branch 'origin/master' into es-43264-saml-post-logout", "committedDate": "2020-06-28T23:36:34Z", "type": "commit"}]}