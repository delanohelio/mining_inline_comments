{"pr_number": 52438, "pr_title": "Deciders should not by default collect yes'es", "pr_createdAt": "2020-02-17T19:59:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52438", "timeline": [{"oid": "f5066533b2f8c10208fa6429471f8d1a7b112647", "url": "https://github.com/elastic/elasticsearch/commit/f5066533b2f8c10208fa6429471f8d1a7b112647", "message": "Deciders should not by default collect yes'es\n\nAllocationDeciders would collect Yes decisions when not asking for debug\ninfo. Changed to only include Yes decisions when debug is requested\n(explain).", "committedDate": "2020-02-17T19:55:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4ODA2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52438#discussion_r380788061", "bodyText": "perhaps add a comment explaining this condition. I had to rewrite it in my head to debugMode != ON => type != YES", "author": "ywelsch", "createdAt": "2020-02-18T16:30:45Z", "path": "server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java", "diffHunk": "@@ -247,11 +235,17 @@ public Decision canForceAllocatePrimary(ShardRouting shardRouting, RoutingNode n\n                 } else {\n                     ret.add(decision);\n                 }\n-            } else if (decision != Decision.ALWAYS\n-                        && (allocation.getDebugMode() != EXCLUDE_YES_DECISIONS || decision.type() != Decision.Type.YES)) {\n-                ret.add(decision);\n+            } else {\n+                addDebugDecision(ret, decision, allocation);\n             }\n         }\n         return ret;\n     }\n+\n+    private void addDebugDecision(Decision.Multi ret, Decision decision, RoutingAllocation allocation) {\n+        if (decision != Decision.ALWAYS\n+            && (allocation.getDebugMode() == RoutingAllocation.DebugMode.ON || decision.type() != Decision.Type.YES)) {", "originalCommit": "f5066533b2f8c10208fa6429471f8d1a7b112647", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02a31f24f6c10349139ac0dcdb3333e68b37545e", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java b/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java\nindex c7847bf12ed..3f0607df3ca 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/routing/allocation/decider/AllocationDeciders.java\n\n@@ -236,13 +236,14 @@ public class AllocationDeciders extends AllocationDecider {\n                     ret.add(decision);\n                 }\n             } else {\n-                addDebugDecision(ret, decision, allocation);\n+                addDecision(ret, decision, allocation);\n             }\n         }\n         return ret;\n     }\n \n-    private void addDebugDecision(Decision.Multi ret, Decision decision, RoutingAllocation allocation) {\n+    private void addDecision(Decision.Multi ret, Decision decision, RoutingAllocation allocation) {\n+        // We never add ALWAYS decisions and only add YES decisions when requested by debug mode (since Multi default is YES).\n         if (decision != Decision.ALWAYS\n             && (allocation.getDebugMode() == RoutingAllocation.DebugMode.ON || decision.type() != Decision.Type.YES)) {\n             ret.add(decision);\n"}}, {"oid": "02a31f24f6c10349139ac0dcdb3333e68b37545e", "url": "https://github.com/elastic/elasticsearch/commit/02a31f24f6c10349139ac0dcdb3333e68b37545e", "message": "Renamed method and added comment", "committedDate": "2020-02-18T20:26:14Z", "type": "commit"}, {"oid": "fa38272cb49d83183c6428e8da296cf431e67ece", "url": "https://github.com/elastic/elasticsearch/commit/fa38272cb49d83183c6428e8da296cf431e67ece", "message": "Merge remote-tracking branch 'origin/master' into fix_deciders_not_collect_yes_decisions", "committedDate": "2020-02-19T07:50:49Z", "type": "commit"}]}