{"pr_number": 50680, "pr_title": "[ML][Inference] Add support for models shipped as resources", "pr_createdAt": "2020-01-06T18:46:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50680", "timeline": [{"oid": "bc53c1faa30de814b75beca11a585a48e1ee2d93", "url": "https://github.com/elastic/elasticsearch/commit/bc53c1faa30de814b75beca11a585a48e1ee2d93", "message": "[ML][Inference] Add support for models shipped as resources", "committedDate": "2020-01-06T18:37:02Z", "type": "commit"}, {"oid": "876d03139c48627df3121418a72901f1e2543478", "url": "https://github.com/elastic/elasticsearch/commit/876d03139c48627df3121418a72901f1e2543478", "message": "addressing test failures", "committedDate": "2020-01-06T20:28:33Z", "type": "commit"}, {"oid": "e6973454b91555f6af06ee10f2aa9974db3e92c7", "url": "https://github.com/elastic/elasticsearch/commit/e6973454b91555f6af06ee10f2aa9974db3e92c7", "message": "fixing yaml test", "committedDate": "2020-01-06T21:17:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4NzgzMw==", "url": "https://github.com/elastic/elasticsearch/pull/50680#discussion_r363687833", "bodyText": "You can remove one of these sets. The only use of matchedResourceModels is to read its size in the next line at which point both sets are the same size", "author": "davidkyle", "createdAt": "2020-01-07T10:38:10Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -359,8 +408,9 @@ public void expandIds(String idExpression,\n             searchRequest,\n             ActionListener.<SearchResponse>wrap(\n                 response -> {\n-                    Set<String> foundResourceIds = new LinkedHashSet<>();\n-                    long totalHitCount = response.getHits().getTotalHits().value;\n+                    Set<String> matchedResourceModels = matchedResourceIds(tokens);\n+                    Set<String> foundResourceIds = new LinkedHashSet<>(matchedResourceModels);", "originalCommit": "e6973454b91555f6af06ee10f2aa9974db3e92c7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c2beb47a84174bc0dca23a65f590c58346942acc", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java\nindex b62aa788fbe..993de87b071 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java\n\n@@ -408,9 +408,8 @@ public class TrainedModelProvider {\n             searchRequest,\n             ActionListener.<SearchResponse>wrap(\n                 response -> {\n-                    Set<String> matchedResourceModels = matchedResourceIds(tokens);\n-                    Set<String> foundResourceIds = new LinkedHashSet<>(matchedResourceModels);\n-                    long totalHitCount = response.getHits().getTotalHits().value + matchedResourceModels.size();\n+                    Set<String> foundResourceIds = new LinkedHashSet<>(matchedResourceIds(tokens));\n+                    long totalHitCount = response.getHits().getTotalHits().value + foundResourceIds.size();\n                     for (SearchHit hit : response.getHits().getHits()) {\n                         Map<String, Object> docSource = hit.getSourceAsMap();\n                         if (docSource == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5NTM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/50680#discussion_r363695354", "bodyText": "nit assertThrows is a neater way of doing this and more idiomatic", "author": "davidkyle", "createdAt": "2020-01-07T10:57:42Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProviderTests.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml.inference.persistence;\n+\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.core.ml.inference.MlInferenceNamedXContentProvider;\n+import org.elasticsearch.xpack.core.ml.inference.TrainedModelConfig;\n+import org.elasticsearch.xpack.core.ml.inference.TrainedModelConfigTests;\n+import org.elasticsearch.xpack.core.ml.job.messages.Messages;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.mockito.Mockito.mock;\n+\n+public class TrainedModelProviderTests extends ESTestCase {\n+\n+    public void testDeleteModelStoredAsResource() {\n+        TrainedModelProvider trainedModelProvider = new TrainedModelProvider(mock(Client.class), xContentRegistry());\n+        PlainActionFuture<Boolean> future = new PlainActionFuture<>();\n+        // Should be OK as we don't make any client calls\n+        trainedModelProvider.deleteTrainedModel(\"lang_ident_model_1\", future);\n+        try {\n+            future.actionGet();", "originalCommit": "e6973454b91555f6af06ee10f2aa9974db3e92c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcyNDUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/50680#discussion_r363724521", "bodyText": "oh yeah, duh :D", "author": "benwtrent", "createdAt": "2020-01-07T12:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY5NTM1NA=="}], "type": "inlineReview", "revised_code": {"commit": "c2beb47a84174bc0dca23a65f590c58346942acc", "chunk": "diff --git a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProviderTests.java b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProviderTests.java\nindex 99b4ca5e408..705a8f60dd2 100644\n--- a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProviderTests.java\n+++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProviderTests.java\n\n@@ -5,6 +5,7 @@\n  */\n package org.elasticsearch.xpack.ml.inference.persistence;\n \n+import org.elasticsearch.ElasticsearchException;\n import org.elasticsearch.action.support.PlainActionFuture;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n"}}, {"oid": "c2beb47a84174bc0dca23a65f590c58346942acc", "url": "https://github.com/elastic/elasticsearch/commit/c2beb47a84174bc0dca23a65f590c58346942acc", "message": "fixing up tests", "committedDate": "2020-01-07T12:24:29Z", "type": "commit"}]}