{"pr_number": 59317, "pr_title": "Default to @timestamp in composable template datastream definition", "pr_createdAt": "2020-07-09T16:20:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59317", "timeline": [{"oid": "8f6c5da6ca763b9b2e6801a1bc0e32102044a171", "url": "https://github.com/elastic/elasticsearch/commit/8f6c5da6ca763b9b2e6801a1bc0e32102044a171", "message": "Default to @timestamp in composable template datastream definition\n\nThis makes the data_stream timestamp field specification optional when\ndefining a composable template.\nWhen there isn't one specified it will default to `@timestamp`.", "committedDate": "2020-07-09T16:18:52Z", "type": "commit"}, {"oid": "fb6b62aa87be213f226a78138b067c4ee1528ed8", "url": "https://github.com/elastic/elasticsearch/commit/fb6b62aa87be213f226a78138b067c4ee1528ed8", "message": "Fix yaml test", "committedDate": "2020-07-09T17:15:39Z", "type": "commit"}, {"oid": "65c1d5d7da1cb6bad87491fc0de3a8d359ce40e4", "url": "https://github.com/elastic/elasticsearch/commit/65c1d5d7da1cb6bad87491fc0de3a8d359ce40e4", "message": "Update index templates doc", "committedDate": "2020-07-09T17:59:05Z", "type": "commit"}, {"oid": "9646bdc670f140af6aaa979fd769ca0b40da600a", "url": "https://github.com/elastic/elasticsearch/commit/9646bdc670f140af6aaa979fd769ca0b40da600a", "message": "Mention only the empty body `data_stream`\n\nCo-authored-by: James Rodewig <james.rodewig@elastic.co>", "committedDate": "2020-07-09T17:59:55Z", "type": "commit"}, {"oid": "c920a53ba9d23954c776c324dbd8794844fdd2eb", "url": "https://github.com/elastic/elasticsearch/commit/c920a53ba9d23954c776c324dbd8794844fdd2eb", "message": "Merge branch 'master' into default-ds-timestamp-definition", "committedDate": "2020-07-09T18:00:26Z", "type": "commit"}, {"oid": "cce093db1c4c37d271c508d0f3cc4ed376d326e7", "url": "https://github.com/elastic/elasticsearch/commit/cce093db1c4c37d271c508d0f3cc4ed376d326e7", "message": "Use the empty `data_stream` definition in yaml tests", "committedDate": "2020-07-09T20:21:13Z", "type": "commit"}, {"oid": "8d1d81953f7b889b2ad0562998ab8406af156089", "url": "https://github.com/elastic/elasticsearch/commit/8d1d81953f7b889b2ad0562998ab8406af156089", "message": "Disablle more yaml tests in 7.9", "committedDate": "2020-07-10T15:24:10Z", "type": "commit"}, {"oid": "69a34f72d7c31a90b9fd346b8884cbbd779642ed", "url": "https://github.com/elastic/elasticsearch/commit/69a34f72d7c31a90b9fd346b8884cbbd779642ed", "message": "Merge branch 'master' into default-ds-timestamp-definition", "committedDate": "2020-07-13T08:47:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5ODY1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/59317#discussion_r453498659", "bodyText": "maybe remove this field from the xcontent format? So that the only valid format is an empty json object?", "author": "martijnvg", "createdAt": "2020-07-13T08:58:26Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java", "diffHunk": "@@ -250,11 +250,11 @@ public String toString() {\n \n         private static final ConstructingObjectParser<DataStreamTemplate, Void> PARSER = new ConstructingObjectParser<>(\n             \"data_stream_template\",\n-            args -> new DataStreamTemplate((String) args[0])\n+            args -> new DataStreamTemplate(args[0] != null ? (String) args[0] : FIXED_TIMESTAMP_FIELD)\n         );\n \n         static {\n-            PARSER.declareString(ConstructingObjectParser.constructorArg(), DataStream.TIMESTAMP_FIELD_FIELD);\n+            PARSER.declareString(ConstructingObjectParser.optionalConstructorArg(), DataStream.TIMESTAMP_FIELD_FIELD);", "originalCommit": "69a34f72d7c31a90b9fd346b8884cbbd779642ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzMjkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59317#discussion_r453532915", "bodyText": "Yes, good point. i'll drop the field completely in the POJO but keep the data_stream empty JSON object", "author": "andreidan", "createdAt": "2020-07-13T09:53:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ5ODY1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d55060dad39c4f663ab0da9e3a109dbe196fc22b", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java b/server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java\nindex 32e1b6c4b43..d3d428cc398 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java\n\n@@ -248,68 +249,39 @@ public class ComposableIndexTemplate extends AbstractDiffable<ComposableIndexTem\n \n     public static class DataStreamTemplate implements Writeable, ToXContentObject {\n \n-        private static final ConstructingObjectParser<DataStreamTemplate, Void> PARSER = new ConstructingObjectParser<>(\n+        private static final ObjectParser<DataStreamTemplate, Void> PARSER = new ObjectParser<>(\n             \"data_stream_template\",\n-            args -> new DataStreamTemplate(args[0] != null ? (String) args[0] : FIXED_TIMESTAMP_FIELD)\n+            DataStreamTemplate::new\n         );\n \n-        static {\n-            PARSER.declareString(ConstructingObjectParser.optionalConstructorArg(), DataStream.TIMESTAMP_FIELD_FIELD);\n-        }\n-\n-        private final String timestampField;\n-\n-        public DataStreamTemplate(String timestampField) {\n-            if (FIXED_TIMESTAMP_FIELD.equals(timestampField) == false) {\n-                throw new IllegalArgumentException(\"unexpected timestamp field [\" + timestampField + \"]\");\n-            }\n-\n-            this.timestampField = timestampField;\n-        }\n-\n         public DataStreamTemplate() {\n-            this(FIXED_TIMESTAMP_FIELD);\n         }\n \n         public String getTimestampField() {\n-            return timestampField;\n+            return FIXED_TIMESTAMP_FIELD;\n         }\n \n         DataStreamTemplate(StreamInput in) throws IOException {\n-            this(in.readString());\n+            this();\n         }\n \n         /**\n          * @return a mapping snippet for a backing index with `_timestamp` meta field mapper properly configured.\n          */\n         public Map<String, Object> getDataSteamMappingSnippet() {\n-            return Map.of(MapperService.SINGLE_MAPPING_NAME, Map.of(TimestampFieldMapper.NAME, Map.of(\"path\", timestampField)));\n+            return Map.of(MapperService.SINGLE_MAPPING_NAME, Map.of(TimestampFieldMapper.NAME, Map.of(\"path\", FIXED_TIMESTAMP_FIELD)));\n         }\n \n         @Override\n         public void writeTo(StreamOutput out) throws IOException {\n-            out.writeString(timestampField);\n         }\n \n         @Override\n         public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n             builder.startObject();\n-            builder.field(DataStream.TIMESTAMP_FIELD_FIELD.getPreferredName(), timestampField);\n+            builder.field(DataStream.TIMESTAMP_FIELD_FIELD.getPreferredName(), FIXED_TIMESTAMP_FIELD);\n             builder.endObject();\n             return builder;\n         }\n-\n-        @Override\n-        public boolean equals(Object o) {\n-            if (this == o) return true;\n-            if (o == null || getClass() != o.getClass()) return false;\n-            DataStreamTemplate that = (DataStreamTemplate) o;\n-            return timestampField.equals(that.timestampField);\n-        }\n-\n-        @Override\n-        public int hashCode() {\n-            return Objects.hash(timestampField);\n-        }\n     }\n }\n"}}, {"oid": "d55060dad39c4f663ab0da9e3a109dbe196fc22b", "url": "https://github.com/elastic/elasticsearch/commit/d55060dad39c4f663ab0da9e3a109dbe196fc22b", "message": "Remove timestamp_field from data_stream definition\n\nThis will always be @timestamp", "committedDate": "2020-07-13T13:00:08Z", "type": "commit"}, {"oid": "98b23e5f025ff744688426ea41947cd6b1af4289", "url": "https://github.com/elastic/elasticsearch/commit/98b23e5f025ff744688426ea41947cd6b1af4289", "message": "Handle equals and hashcode for empty DataStreamTemplate", "committedDate": "2020-07-13T14:02:49Z", "type": "commit"}, {"oid": "1a73aaffbd1a83aa68dc5c8fa46376fc0f7a22cf", "url": "https://github.com/elastic/elasticsearch/commit/1a73aaffbd1a83aa68dc5c8fa46376fc0f7a22cf", "message": "Update xpack templates to not specify the timestamp_field", "committedDate": "2020-07-13T14:03:07Z", "type": "commit"}, {"oid": "0bc0ae46e13b35b40a9dc0d5e99cb5d1695cbcfd", "url": "https://github.com/elastic/elasticsearch/commit/0bc0ae46e13b35b40a9dc0d5e99cb5d1695cbcfd", "message": "Merge branch 'master' into default-ds-timestamp-definition", "committedDate": "2020-07-13T14:52:32Z", "type": "commit"}, {"oid": "8a1a75d8b6c90e9b7364c1f3ad3aaf06e50cf7fd", "url": "https://github.com/elastic/elasticsearch/commit/8a1a75d8b6c90e9b7364c1f3ad3aaf06e50cf7fd", "message": "Deleting this test as it's been moved to the `data-streams` module", "committedDate": "2020-07-13T15:59:43Z", "type": "commit"}, {"oid": "0b4b0b27dade2a202b12219a0317c20735ddfc6a", "url": "https://github.com/elastic/elasticsearch/commit/0b4b0b27dade2a202b12219a0317c20735ddfc6a", "message": "Fix merge", "committedDate": "2020-07-13T16:01:35Z", "type": "commit"}, {"oid": "aaa65676b53569fc404a4393e10853cf588faa44", "url": "https://github.com/elastic/elasticsearch/commit/aaa65676b53569fc404a4393e10853cf588faa44", "message": "Drop timestamp_field from data_stream definitions", "committedDate": "2020-07-13T16:10:18Z", "type": "commit"}, {"oid": "757376088f69972513d5c5d405abb57ffde6cab0", "url": "https://github.com/elastic/elasticsearch/commit/757376088f69972513d5c5d405abb57ffde6cab0", "message": "Spotless", "committedDate": "2020-07-13T16:10:33Z", "type": "commit"}, {"oid": "6dad7fbe22c577e588fb00e5ce33bd60a89061ae", "url": "https://github.com/elastic/elasticsearch/commit/6dad7fbe22c577e588fb00e5ce33bd60a89061ae", "message": "DOCS: remove mention of the `timestamp_field` in the `data_stream` definition", "committedDate": "2020-07-13T16:15:11Z", "type": "commit"}, {"oid": "f7ac1ef18225a41eed2b55511025532586c7ae91", "url": "https://github.com/elastic/elasticsearch/commit/f7ac1ef18225a41eed2b55511025532586c7ae91", "message": "Fix post merge compilation errors", "committedDate": "2020-07-13T17:39:53Z", "type": "commit"}, {"oid": "c62f1d419d2457a5b049137bcc2fca265f7f32c8", "url": "https://github.com/elastic/elasticsearch/commit/c62f1d419d2457a5b049137bcc2fca265f7f32c8", "message": "DOCS: update ilm tutorial", "committedDate": "2020-07-13T17:47:42Z", "type": "commit"}, {"oid": "23b8cd623ba2a5120d184a047a500acaf37bc4d3", "url": "https://github.com/elastic/elasticsearch/commit/23b8cd623ba2a5120d184a047a500acaf37bc4d3", "message": "Drop the timestamp_field definition from tests", "committedDate": "2020-07-13T18:21:00Z", "type": "commit"}, {"oid": "40de34bd24802e1c34ebbadf69942c30aedb65f4", "url": "https://github.com/elastic/elasticsearch/commit/40de34bd24802e1c34ebbadf69942c30aedb65f4", "message": "Merge branch 'master' into default-ds-timestamp-definition", "committedDate": "2020-07-13T18:55:55Z", "type": "commit"}, {"oid": "b81a69f1d0278bc8ecc0ed3fc9634624916918ce", "url": "https://github.com/elastic/elasticsearch/commit/b81a69f1d0278bc8ecc0ed3fc9634624916918ce", "message": "Fix docs", "committedDate": "2020-07-13T18:56:27Z", "type": "commit"}, {"oid": "2543e17189fa83716f64b0a7cbddaa319443f672", "url": "https://github.com/elastic/elasticsearch/commit/2543e17189fa83716f64b0a7cbddaa319443f672", "message": "Disable bwc tests", "committedDate": "2020-07-13T18:58:02Z", "type": "commit"}, {"oid": "6c5d3f7e2ab0aa816cb6526494ec2722b2e82e7d", "url": "https://github.com/elastic/elasticsearch/commit/6c5d3f7e2ab0aa816cb6526494ec2722b2e82e7d", "message": "Remove more timestamp_field declarations", "committedDate": "2020-07-13T19:20:03Z", "type": "commit"}, {"oid": "c2a750b5fdecfb2374d0d4ff78ebd992e21d57c2", "url": "https://github.com/elastic/elasticsearch/commit/c2a750b5fdecfb2374d0d4ff78ebd992e21d57c2", "message": "Fix TimeSeriesDataStreamsIT", "committedDate": "2020-07-13T21:07:28Z", "type": "commit"}, {"oid": "fc191757afea898129621765f8e1d5d4e78d4927", "url": "https://github.com/elastic/elasticsearch/commit/fc191757afea898129621765f8e1d5d4e78d4927", "message": "Fix TransformRestTestCase", "committedDate": "2020-07-14T03:04:11Z", "type": "commit"}, {"oid": "3c737c2af9bcc57da073b2e50e3a78216e22ca32", "url": "https://github.com/elastic/elasticsearch/commit/3c737c2af9bcc57da073b2e50e3a78216e22ca32", "message": "Fix DataStreamsUpgradeIT", "committedDate": "2020-07-14T08:15:38Z", "type": "commit"}, {"oid": "fc7fb1eb36b4c6011ff412b305472621786d06bd", "url": "https://github.com/elastic/elasticsearch/commit/fc7fb1eb36b4c6011ff412b305472621786d06bd", "message": "Merge branch 'master' into default-ds-timestamp-definition", "committedDate": "2020-07-14T09:30:23Z", "type": "commit"}, {"oid": "d75db9e2dde441203c3c2ab703b0f5864246f0b8", "url": "https://github.com/elastic/elasticsearch/commit/d75db9e2dde441203c3c2ab703b0f5864246f0b8", "message": "Fix merge", "committedDate": "2020-07-14T09:41:03Z", "type": "commit"}]}