{"pr_number": 65641, "pr_title": "Fix bug where fvh fragments could be loaded from wrong doc", "pr_createdAt": "2020-11-30T23:35:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65641", "timeline": [{"oid": "23d2840042784b5aaeeed066679e15f63eac88f7", "url": "https://github.com/elastic/elasticsearch/commit/23d2840042784b5aaeeed066679e15f63eac88f7", "message": "Add tests demonstrating bug.", "committedDate": "2020-11-30T23:26:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r532977785", "bodyText": "This is hacky but felt like the best way to fix this right now. FragmentsBuilder is an external (Lucene) interface and there's not a good way to pass in _source to its methods like getFields.", "author": "jtibshirani", "createdAt": "2020-11-30T23:46:42Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -160,8 +160,13 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        String[] fragments;\n+        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n+        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {", "originalCommit": "1a59d1594da76b4e3a5991a8c398d237407ce841", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5OTQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r533999448", "bodyText": "Could we replace the cached FragmentsBuilder with a Function<SourceLookup, FragmentsBuilder> and then call that with the new SourceLookup for each hit?  The FragmentsBuilders themselves don't seem to do any significant processing on construction so I don't think there would be a performance penalty for rebuilding them each time.", "author": "romseygeek", "createdAt": "2020-12-02T09:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4NzQyNA==", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r534487424", "bodyText": "It seems like that should work! I'd like to check I understand the context. We have these cached entries not because fragment builders are expensive to build, but to avoid rebuilding the FieldQuery which looks more complex?", "author": "jtibshirani", "createdAt": "2020-12-02T21:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "fb7e4521708baa0004c9627fc609a3e4d2a87ea5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java b/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\nindex 5fcb2b52c66..6c98251b9d4 100644\n--- a/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\n+++ b/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\n\n@@ -160,13 +160,8 @@ public class FastVectorHighlighter implements Highlighter {\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n-        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {\n-            SourceBasedFragmentsBuilder fragmentsBuilder = ((SourceBasedFragmentsBuilder) entry.fragmentsBuilder);\n-            fragmentsBuilder.setSource(hitContext.sourceLookup());\n-        }\n-\n         String[] fragments;\n+\n         // a HACK to make highlighter do highlighting, even though its using the single frag list builder\n         int numberOfFragments = field.fieldOptions().numberOfFragments() == 0 ?\n             Integer.MAX_VALUE : field.fieldOptions().numberOfFragments();\n"}}, {"oid": "fd6311309e4044ab1fb1318463de7c2874c06e39", "url": "https://github.com/elastic/elasticsearch/commit/fd6311309e4044ab1fb1318463de7c2874c06e39", "message": "Explicitly pass document _source to the fragments builder.", "committedDate": "2020-11-30T23:47:56Z", "type": "forcePushed"}, {"oid": "a4b4af48d419de9345afde453ae51fb89df2c40f", "url": "https://github.com/elastic/elasticsearch/commit/a4b4af48d419de9345afde453ae51fb89df2c40f", "message": "Explicitly pass document _source to the fragments builder.", "committedDate": "2020-12-01T00:04:57Z", "type": "forcePushed"}, {"oid": "ab7abb6699157742f132b2c63370f9823ec9da66", "url": "https://github.com/elastic/elasticsearch/commit/ab7abb6699157742f132b2c63370f9823ec9da66", "message": "Explicitly pass document _source to the fragments builder.", "committedDate": "2020-12-01T00:46:27Z", "type": "forcePushed"}, {"oid": "f328a53e7493f91f31744d0e26585d18e0eac295", "url": "https://github.com/elastic/elasticsearch/commit/f328a53e7493f91f31744d0e26585d18e0eac295", "message": "Explicitly pass document _source to the fragments builder.", "committedDate": "2020-12-01T01:11:31Z", "type": "commit"}, {"oid": "f328a53e7493f91f31744d0e26585d18e0eac295", "url": "https://github.com/elastic/elasticsearch/commit/f328a53e7493f91f31744d0e26585d18e0eac295", "message": "Explicitly pass document _source to the fragments builder.", "committedDate": "2020-12-01T01:11:31Z", "type": "forcePushed"}, {"oid": "fb7e4521708baa0004c9627fc609a3e4d2a87ea5", "url": "https://github.com/elastic/elasticsearch/commit/fb7e4521708baa0004c9627fc609a3e4d2a87ea5", "message": "Revert \"Explicitly pass document _source to the fragments builder.\"\n\nThis reverts commit f328a53e7493f91f31744d0e26585d18e0eac295.", "committedDate": "2020-12-03T22:21:12Z", "type": "commit"}, {"oid": "8c36eba8bdfa017f6ec75da60e1cf4d10efdb302", "url": "https://github.com/elastic/elasticsearch/commit/8c36eba8bdfa017f6ec75da60e1cf4d10efdb302", "message": "Cache a supplier instead of the fragments builder itself.", "committedDate": "2020-12-03T22:46:11Z", "type": "commit"}, {"oid": "a0da417ad131a10682f46c4ac6b9270af732e098", "url": "https://github.com/elastic/elasticsearch/commit/a0da417ad131a10682f46c4ac6b9270af732e098", "message": "Merge remote-tracking branch 'upstream/master' into fvh", "committedDate": "2020-12-03T23:09:49Z", "type": "commit"}, {"oid": "e3686d0f6b5deb5772d619d8d73321d7271b70a3", "url": "https://github.com/elastic/elasticsearch/commit/e3686d0f6b5deb5772d619d8d73321d7271b70a3", "message": "Skip mixed cluster test cases for now.", "committedDate": "2020-12-03T23:31:57Z", "type": "commit"}]}