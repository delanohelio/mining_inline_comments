{"pr_number": 56398, "pr_title": "Fix test failure of file role store auto-reload ", "pr_createdAt": "2020-05-08T00:35:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56398", "timeline": [{"oid": "f3c8abbdd0b20a66ef94f85be1734622cb6d5bd7", "url": "https://github.com/elastic/elasticsearch/commit/f3c8abbdd0b20a66ef94f85be1734622cb6d5bd7", "message": "Fix file role store reload test failure", "committedDate": "2020-05-08T00:26:39Z", "type": "commit"}, {"oid": "86e6262d0809123be09b57a2c8b0b1b248a98fbd", "url": "https://github.com/elastic/elasticsearch/commit/86e6262d0809123be09b57a2c8b0b1b248a98fbd", "message": "Merge remote-tracking branch 'origin/master' into es-25955-file-role-store-test-failure", "committedDate": "2020-05-08T00:27:01Z", "type": "commit"}, {"oid": "b34e45a11562150334423782611d6309f7a8e95e", "url": "https://github.com/elastic/elasticsearch/commit/b34e45a11562150334423782611d6309f7a8e95e", "message": "checkstyle", "committedDate": "2020-05-08T00:37:03Z", "type": "commit"}, {"oid": "7445bec5306d2253c93711f5661344c43bc7b69a", "url": "https://github.com/elastic/elasticsearch/commit/7445bec5306d2253c93711f5661344c43bc7b69a", "message": "Remove forbidden API usage", "committedDate": "2020-05-08T00:49:05Z", "type": "commit"}, {"oid": "86ff9f5c50a6528106260dabdec27e17760d075a", "url": "https://github.com/elastic/elasticsearch/commit/86ff9f5c50a6528106260dabdec27e17760d075a", "message": "address feedback", "committedDate": "2020-05-12T11:37:11Z", "type": "commit"}, {"oid": "b7578138095ded5c6818f0964081895b7b1ab6ac", "url": "https://github.com/elastic/elasticsearch/commit/b7578138095ded5c6818f0964081895b7b1ab6ac", "message": "Merge remote-tracking branch 'origin/master' into es-25955-file-role-store-test-failure", "committedDate": "2020-05-12T11:55:28Z", "type": "commit"}, {"oid": "ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4", "url": "https://github.com/elastic/elasticsearch/commit/ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4", "message": "Use marker role for better semantics", "committedDate": "2020-05-12T12:45:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNDQ2OA==", "url": "https://github.com/elastic/elasticsearch/pull/56398#discussion_r424024468", "bodyText": "Not a big deal but you can maintain the modifiedFileRolesModified.addAll(roleSet); from before and assert it contains role5.", "author": "albertzaharovits", "createdAt": "2020-05-12T20:49:13Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java", "diffHunk": "@@ -394,48 +394,56 @@ public void testAutoReload() throws Exception {\n             assertThat(role.cluster().check(\"cluster:admin/foo/bar\", request, authentication), is(false));\n \n             // truncate to remove some\n-            final Set<String> truncatedFileRolesModified = new HashSet<>();\n+            // Not asserting exact content of the role change set since file truncation and subsequent are not\n+            // atomic and hence can result in different change set to be reported.\n             final CountDownLatch truncateLatch = new CountDownLatch(1);\n             store = new FileRolesStore(settings, env, watcherService, roleSet -> {\n-                truncatedFileRolesModified.addAll(roleSet);\n-                truncateLatch.countDown();\n+                if (roleSet.contains(\"dummy1\")) {\n+                    truncateLatch.countDown();\n+                }\n             }, new XPackLicenseState(Settings.EMPTY), xContentRegistry());\n \n             final Set<String> allRolesPreTruncate = store.getAllRoleNames();\n+            assertTrue(allRolesPreTruncate.contains(\"role5\"));\n+            // Use a marker role so that when the countdown latch is triggered,\n+            // we are sure it is triggered by the new file content instead of the initial truncation\n             try (BufferedWriter writer = Files.newBufferedWriter(tmp, StandardCharsets.UTF_8, StandardOpenOption.TRUNCATE_EXISTING)) {\n                 writer.append(\"role5:\").append(System.lineSeparator());\n                 writer.append(\"  cluster:\").append(System.lineSeparator());\n-                writer.append(\"    - 'MONITOR'\");\n+                writer.append(\"    - 'MONITOR'\").append(System.lineSeparator());\n+                writer.append(\"dummy1:\").append(System.lineSeparator());\n+                writer.append(\"  cluster:\").append(System.lineSeparator());\n+                writer.append(\"    - 'ALL'\");\n             }\n \n-            truncateLatch.await();\n-            assertEquals(allRolesPreTruncate.size() - 1, truncatedFileRolesModified.size());\n-            assertTrue(allRolesPreTruncate.contains(\"role5\"));\n-            assertFalse(truncatedFileRolesModified.contains(\"role5\"));\n+            assertTrue(truncateLatch.await(5, TimeUnit.SECONDS));\n             descriptors = store.roleDescriptors(Collections.singleton(\"role5\"));\n             assertThat(descriptors, notNullValue());\n             assertEquals(1, descriptors.size());\n+            assertArrayEquals(new String[]{\"MONITOR\"}, descriptors.iterator().next().getClusterPrivileges());\n \n             // modify\n-            final Set<String> modifiedFileRolesModified = new HashSet<>();\n             final CountDownLatch modifyLatch = new CountDownLatch(1);\n             store = new FileRolesStore(settings, env, watcherService, roleSet -> {\n-                modifiedFileRolesModified.addAll(roleSet);\n-                modifyLatch.countDown();\n+                if (roleSet.contains(\"dummy2\")) {\n+                    modifyLatch.countDown();", "originalCommit": "ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE0MDk3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56398#discussion_r424140975", "bodyText": "Added back.", "author": "ywangd", "createdAt": "2020-05-13T02:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNDQ2OA=="}], "type": "inlineReview", "revised_code": {"commit": "4f20dc0ac0bcd8008e61090c33b570e74001e91a", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java\nindex b847cd4299b..e59bb667e36 100644\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java\n\n@@ -423,8 +423,10 @@ public class FileRolesStoreTests extends ESTestCase {\n             assertArrayEquals(new String[]{\"MONITOR\"}, descriptors.iterator().next().getClusterPrivileges());\n \n             // modify\n+            final Set<String> modifiedFileRolesModified = new HashSet<>();\n             final CountDownLatch modifyLatch = new CountDownLatch(1);\n             store = new FileRolesStore(settings, env, watcherService, roleSet -> {\n+                modifiedFileRolesModified.addAll(roleSet);\n                 if (roleSet.contains(\"dummy2\")) {\n                     modifyLatch.countDown();\n                 }\n"}}, {"oid": "4f20dc0ac0bcd8008e61090c33b570e74001e91a", "url": "https://github.com/elastic/elasticsearch/commit/4f20dc0ac0bcd8008e61090c33b570e74001e91a", "message": "Address feedback", "committedDate": "2020-05-13T02:39:29Z", "type": "commit"}, {"oid": "ab373921d1363f71b5bac8ef059a6cbcefdd6622", "url": "https://github.com/elastic/elasticsearch/commit/ab373921d1363f71b5bac8ef059a6cbcefdd6622", "message": "Merge branch 'master' into es-25955-file-role-store-test-failure", "committedDate": "2020-05-13T02:56:05Z", "type": "commit"}]}