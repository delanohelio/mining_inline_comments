{"pr_number": 55250, "pr_title": "Convert InternalAggTestCase to AbstractNamedWriteableTestCase", "pr_createdAt": "2020-04-15T16:58:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55250", "timeline": [{"oid": "57685b070968639a208937799ee37dcb898616e9", "url": "https://github.com/elastic/elasticsearch/commit/57685b070968639a208937799ee37dcb898616e9", "message": "Convert InternalAggTestCase to AbstractNamedWriteableTestCase\n\nSome aggregations, such as the Terms* family, will use an alternate\nclass to represent unmapped shard results (while the rest of the aggs\nuse the same object but with some form of \"empty\" or \"nullish\" values\nto represent unmapped).\n\nThis was problematic with AbstractWireSerializingTestCase because it\nexpects the instanceReader to always match the original class.  Instead,\nwe need to use the NamedWriteable version so that the registry\ncan be consulted for the proper deserialization reader.", "committedDate": "2020-04-15T16:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2Njg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409066871", "bodyText": "Could this be extends AbstactNamedWriteableTestCase<InternalAggregation>?", "author": "nik9000", "createdAt": "2020-04-15T19:00:42Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -166,7 +166,7 @@\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n-public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractWireSerializingTestCase<T> {\n+public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {", "originalCommit": "57685b070968639a208937799ee37dcb898616e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3MDExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409070115", "bodyText": "Probably, i'll check!", "author": "polyfractal", "createdAt": "2020-04-15T19:06:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2Njg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA4NjM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409086340", "bodyText": "I think it needs to remain <T>... AbstractWireTestCase#mutateInstance() takes the T, so if we change it to <InternalAggregation> it forces signatures like\nprotected InternalBoxplot mutateInstance(InternalBoxplot instance) {\n\nto be\nprotected InternalAggregation mutateInstance(InternalAggregation instance) {\n\nand requires a bunch of extra casting.", "author": "polyfractal", "createdAt": "2020-04-15T19:35:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2Njg3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MjI0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409092244", "bodyText": "Got it!", "author": "nik9000", "createdAt": "2020-04-15T19:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2Njg3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "cdac45a74e77697781e22c01a53edaeaefd63f1b", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\nindex d17f2f39925..caaed1ab374 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n\n@@ -166,6 +170,12 @@ import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n+/**\n+ * Implementors of this test case should be aware that the aggregation under test needs to be registered\n+ * in the test's namedWriteableRegistry.  Core aggregations are registered already, but non-core\n+ * aggs should override {@link InternalAggregationTestCase#registerPlugin()} so that the NamedWriteables\n+ * can be extracted from the AggregatorSpecs in the plugin (as well as any other custom NamedWriteables)\n+ */\n public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {\n     /**\n      * Builds an {@link InternalAggregation.ReduceContextBuilder} that is valid but empty.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzU0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409067542", "bodyText": "I think it is worth adding a comment that subclasses need to make sure that xContentRegistry includes the agg we're going to parse. Built in aggs are included automatically but other aggs won't be.", "author": "nik9000", "createdAt": "2020-04-15T19:01:59Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -166,7 +166,7 @@\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n-public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractWireSerializingTestCase<T> {\n+public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {", "originalCommit": "57685b070968639a208937799ee37dcb898616e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTEyNjA3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409126071", "bodyText": "Buncha xpack tests needed this treatment, and it was non-trivial for tests to convert aggspecs into namedwriteables, so I did a bit of refactoring to make it easier in the general case.", "author": "polyfractal", "createdAt": "2020-04-15T20:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzU0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "cdac45a74e77697781e22c01a53edaeaefd63f1b", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\nindex d17f2f39925..caaed1ab374 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n\n@@ -166,6 +170,12 @@ import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n+/**\n+ * Implementors of this test case should be aware that the aggregation under test needs to be registered\n+ * in the test's namedWriteableRegistry.  Core aggregations are registered already, but non-core\n+ * aggs should override {@link InternalAggregationTestCase#registerPlugin()} so that the NamedWriteables\n+ * can be extracted from the AggregatorSpecs in the plugin (as well as any other custom NamedWriteables)\n+ */\n public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {\n     /**\n      * Builds an {@link InternalAggregation.ReduceContextBuilder} that is valid but empty.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzYxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409067615", "bodyText": "Could this be final?", "author": "nik9000", "createdAt": "2020-04-15T19:02:05Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -282,6 +282,16 @@ protected T createUnmappedInstance(String name, Map<String, Object> metadata) {\n         return createTestInstance(name, metadata);\n     }\n \n+    /**\n+     * The NamedWriteable class for agg tests _should_ be InternalAggregation so this is being set by default,\n+     * but implementors can change if necessary\n+     */\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    protected Class<T> categoryClass() {", "originalCommit": "57685b070968639a208937799ee37dcb898616e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA3MDk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409070944", "bodyText": "It could be.  I left it non-final in case an implementor needs to override it for some reason.  But I suppose with the generic bounds on <InternalAggregation> it's pretty definitive what the class should be...", "author": "polyfractal", "createdAt": "2020-04-15T19:08:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5MjU2MA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409092560", "bodyText": "I do think this should be final then. I guess the suppresswarnings means that the bounds on AbstractNamedWriteableTestCase are wrong.", "author": "nik9000", "createdAt": "2020-04-15T19:47:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTExMDY0OA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409110648", "bodyText": "Yeah to be honest I really have no idea what's going on with the generic... scratched my head over it for a while and just gave up :/\nI'll make final \ud83d\udc4d", "author": "polyfractal", "createdAt": "2020-04-15T20:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzYxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "cdac45a74e77697781e22c01a53edaeaefd63f1b", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\nindex d17f2f39925..caaed1ab374 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n\n@@ -282,13 +343,9 @@ public abstract class InternalAggregationTestCase<T extends InternalAggregation>\n         return createTestInstance(name, metadata);\n     }\n \n-    /**\n-     * The NamedWriteable class for agg tests _should_ be InternalAggregation so this is being set by default,\n-     * but implementors can change if necessary\n-     */\n     @Override\n-    @SuppressWarnings(\"unchecked\")\n-    protected Class<T> categoryClass() {\n+\n+    protected final Class<T> categoryClass() {\n         return (Class<T>) InternalAggregation.class;\n     }\n \n"}}, {"oid": "cdac45a74e77697781e22c01a53edaeaefd63f1b", "url": "https://github.com/elastic/elasticsearch/commit/cdac45a74e77697781e22c01a53edaeaefd63f1b", "message": "Review comments, fix xpack tests, allow tests to register namedwriteables", "committedDate": "2020-04-15T20:49:39Z", "type": "commit"}, {"oid": "ead77299bb5cd3f6568ecbc765d97d67c939f9ae", "url": "https://github.com/elastic/elasticsearch/commit/ead77299bb5cd3f6568ecbc765d97d67c939f9ae", "message": "Fix MatrixStats test", "committedDate": "2020-04-15T20:59:37Z", "type": "commit"}, {"oid": "886f1d61c32771283b00f559773c192c44b297d4", "url": "https://github.com/elastic/elasticsearch/commit/886f1d61c32771283b00f559773c192c44b297d4", "message": "Merge remote-tracking branch 'origin/master' into internal_agg_namedwriteable_test", "committedDate": "2020-04-15T21:00:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE4NjA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409186058", "bodyText": "If you pass the plugins in instead of emptyList() then I think SearchModule will do this stuff for you.", "author": "nik9000", "createdAt": "2020-04-15T23:09:22Z", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -270,6 +279,58 @@ public ReduceContext forFinalReduction() {\n         return namedXContents;\n     }\n \n+    @Override\n+    protected NamedXContentRegistry xContentRegistry() {\n+        return namedXContentRegistry;\n+    }\n+\n+    @Override\n+    protected final NamedWriteableRegistry getNamedWriteableRegistry() {\n+        return namedWriteableRegistry;\n+    }\n+\n+    /**\n+     * Implementors can override this if they want to provide a custom list of namedWriteables.  If the implementor\n+     * _just_ wants to register in namedWriteables provided by a plugin, prefer overriding\n+     * {@link InternalAggregationTestCase#registerPlugin()} instead because that route handles the automatic\n+     * conversion of AggSpecs into namedWriteables.\n+     */\n+    protected List<NamedWriteableRegistry.Entry> getNamedWriteables() {\n+        List<NamedWriteableRegistry.Entry> entries\n+            = new ArrayList<>(new SearchModule(Settings.EMPTY, emptyList()).getNamedWriteables());", "originalCommit": "886f1d61c32771283b00f559773c192c44b297d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "02324b1a00a1205960b23c4328d554118cc8382f", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\nindex 99b2a11bd36..38b262c54da 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java\n\n@@ -296,28 +296,13 @@ public abstract class InternalAggregationTestCase<T extends InternalAggregation>\n      * conversion of AggSpecs into namedWriteables.\n      */\n     protected List<NamedWriteableRegistry.Entry> getNamedWriteables() {\n-        List<NamedWriteableRegistry.Entry> entries\n-            = new ArrayList<>(new SearchModule(Settings.EMPTY, emptyList()).getNamedWriteables());\n+        SearchPlugin plugin = registerPlugin();\n+        SearchModule searchModule = new SearchModule(Settings.EMPTY, plugin == null ? emptyList() : List.of(plugin));\n+        List<NamedWriteableRegistry.Entry> entries = new ArrayList<>(searchModule.getNamedWriteables());\n \n-        Plugin plugin = registerPlugin();\n-\n-        if (plugin == null) {\n-            return entries;\n-        }\n-\n-        entries.addAll(plugin.getNamedWriteables());\n-\n-        if (plugin instanceof SearchPlugin) {\n-            for (SearchPlugin.AggregationSpec spec : ((SearchPlugin)plugin).getAggregations()) {\n-                entries.add(new NamedWriteableRegistry.Entry(AggregationBuilder.class,\n-                    spec.getName().getPreferredName(), spec.getReader()));\n-\n-                for (Map.Entry<String, Writeable.Reader<? extends InternalAggregation>> t : spec.getResultReaders().entrySet()) {\n-                    String writeableName = t.getKey();\n-                    Writeable.Reader<? extends InternalAggregation> internalReader = t.getValue();\n-                    entries.add(new NamedWriteableRegistry.Entry(InternalAggregation.class, writeableName, internalReader));\n-                }\n-            }\n+        // Modules/plugins may have extra namedwriteables that are not added by agg specs\n+        if (plugin != null) {\n+            entries.addAll(((Plugin) plugin).getNamedWriteables());\n         }\n \n         return entries;\n"}}, {"oid": "5090ef838c114c47abcc08d1c37247824c5ab19e", "url": "https://github.com/elastic/elasticsearch/commit/5090ef838c114c47abcc08d1c37247824c5ab19e", "message": "Fix parent/join module tests", "committedDate": "2020-04-16T18:50:36Z", "type": "commit"}, {"oid": "02324b1a00a1205960b23c4328d554118cc8382f", "url": "https://github.com/elastic/elasticsearch/commit/02324b1a00a1205960b23c4328d554118cc8382f", "message": "Remove code duplication", "committedDate": "2020-04-16T19:07:24Z", "type": "commit"}, {"oid": "bb1cfad12d9826e96a51710bb5f8c6e81907b0a0", "url": "https://github.com/elastic/elasticsearch/commit/bb1cfad12d9826e96a51710bb5f8c6e81907b0a0", "message": "checkstyle!", "committedDate": "2020-04-16T19:34:00Z", "type": "commit"}]}