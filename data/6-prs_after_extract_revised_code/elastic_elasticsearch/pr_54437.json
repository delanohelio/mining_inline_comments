{"pr_number": 54437, "pr_title": "Do not execute ML CRUD actions when upgrade mode is enabled", "pr_createdAt": "2020-03-30T15:27:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54437", "timeline": [{"oid": "b036f0ee62037d8fa26233b02627bb691d61ccdd", "url": "https://github.com/elastic/elasticsearch/commit/b036f0ee62037d8fa26233b02627bb691d61ccdd", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-03-31T14:18:21Z", "type": "forcePushed"}, {"oid": "2f76697a47075c5807c0509263abb5c3cb1801bc", "url": "https://github.com/elastic/elasticsearch/commit/2f76697a47075c5807c0509263abb5c3cb1801bc", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-03-31T14:19:58Z", "type": "forcePushed"}, {"oid": "3366a26dfa72fbb7e8f90207ec7f09d4acc37c23", "url": "https://github.com/elastic/elasticsearch/commit/3366a26dfa72fbb7e8f90207ec7f09d4acc37c23", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-04-06T17:37:47Z", "type": "forcePushed"}, {"oid": "1c988e7b27f0c6f7fc2478f5174cac5ebeee146c", "url": "https://github.com/elastic/elasticsearch/commit/1c988e7b27f0c6f7fc2478f5174cac5ebeee146c", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-04-07T12:27:28Z", "type": "forcePushed"}, {"oid": "fa06171652a92418ce23f0762fb7bdf44545724f", "url": "https://github.com/elastic/elasticsearch/commit/fa06171652a92418ce23f0762fb7bdf44545724f", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-04-07T17:34:13Z", "type": "forcePushed"}, {"oid": "a14d8c8e82e1fdbe0cec468fa58d58ebefc1a92c", "url": "https://github.com/elastic/elasticsearch/commit/a14d8c8e82e1fdbe0cec468fa58d58ebefc1a92c", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-04-07T17:36:59Z", "type": "forcePushed"}, {"oid": "0415142698550b51007f50ba7acbb512ec96d2f0", "url": "https://github.com/elastic/elasticsearch/commit/0415142698550b51007f50ba7acbb512ec96d2f0", "message": "Upgrade Mode Exception PoC", "committedDate": "2020-04-07T17:41:37Z", "type": "forcePushed"}, {"oid": "c1bac1ff230056cea309956effacced43d774545", "url": "https://github.com/elastic/elasticsearch/commit/c1bac1ff230056cea309956effacced43d774545", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-07T17:46:33Z", "type": "forcePushed"}, {"oid": "6ee58fc959921042db52b70ccd729db27c31ca06", "url": "https://github.com/elastic/elasticsearch/commit/6ee58fc959921042db52b70ccd729db27c31ca06", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-07T17:58:26Z", "type": "forcePushed"}, {"oid": "d6c4281e7813e5c0ebad38c784b1432fe498264c", "url": "https://github.com/elastic/elasticsearch/commit/d6c4281e7813e5c0ebad38c784b1432fe498264c", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-08T06:20:04Z", "type": "forcePushed"}, {"oid": "db31c857b7e89d278b6238897dc32b4325ae976f", "url": "https://github.com/elastic/elasticsearch/commit/db31c857b7e89d278b6238897dc32b4325ae976f", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-08T06:42:21Z", "type": "forcePushed"}, {"oid": "a9e88d7c9a723adf7a37554a057383c2b14be97f", "url": "https://github.com/elastic/elasticsearch/commit/a9e88d7c9a723adf7a37554a057383c2b14be97f", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-08T07:37:22Z", "type": "forcePushed"}, {"oid": "e112af1b4c804f37322b55b86865f8907e73fd05", "url": "https://github.com/elastic/elasticsearch/commit/e112af1b4c804f37322b55b86865f8907e73fd05", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-08T07:38:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0NTA4NA==", "url": "https://github.com/elastic/elasticsearch/pull/54437#discussion_r405345084", "bodyText": "Please add a comment here to say that the key requirement is that this filter operates after the security action filter so that an unauthorised user gets told they're unauthorised instead of finding out whether upgrade mode is enabled.\nIt's not hard to achieve this as security's order is Integer.MIN_VALUE so any number greater than that would work.  So the actual number is not that important, but the reasoning behind it is.", "author": "droberts195", "createdAt": "2020-04-08T08:24:01Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlUpgradeModeActionFilter.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.support.ActionFilter;\n+import org.elasticsearch.cluster.ClusterChangedEvent;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.rest.RestStatus;\n+import org.elasticsearch.xpack.core.ml.MlMetadata;\n+import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteCalendarAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteCalendarEventAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteDataFrameAnalyticsAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteExpiredDataAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteFilterAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteForecastAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteJobAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteModelSnapshotAction;\n+import org.elasticsearch.xpack.core.ml.action.DeleteTrainedModelAction;\n+import org.elasticsearch.xpack.core.ml.action.FinalizeJobExecutionAction;\n+import org.elasticsearch.xpack.core.ml.action.FlushJobAction;\n+import org.elasticsearch.xpack.core.ml.action.ForecastJobAction;\n+import org.elasticsearch.xpack.core.ml.action.KillProcessAction;\n+import org.elasticsearch.xpack.core.ml.action.OpenJobAction;\n+import org.elasticsearch.xpack.core.ml.action.PersistJobAction;\n+import org.elasticsearch.xpack.core.ml.action.PostCalendarEventsAction;\n+import org.elasticsearch.xpack.core.ml.action.PostDataAction;\n+import org.elasticsearch.xpack.core.ml.action.PutCalendarAction;\n+import org.elasticsearch.xpack.core.ml.action.PutDataFrameAnalyticsAction;\n+import org.elasticsearch.xpack.core.ml.action.PutDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.action.PutFilterAction;\n+import org.elasticsearch.xpack.core.ml.action.PutJobAction;\n+import org.elasticsearch.xpack.core.ml.action.PutTrainedModelAction;\n+import org.elasticsearch.xpack.core.ml.action.RevertModelSnapshotAction;\n+import org.elasticsearch.xpack.core.ml.action.StartDataFrameAnalyticsAction;\n+import org.elasticsearch.xpack.core.ml.action.StartDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.action.StopDataFrameAnalyticsAction;\n+import org.elasticsearch.xpack.core.ml.action.StopDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateCalendarJobAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateFilterAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateJobAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateModelSnapshotAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateProcessAction;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+/**\n+ * {@link MlUpgradeModeActionFilter} disallows certain actions if the cluster is currently in upgrade mode.\n+ *\n+ * Disallowed actions are the ones which can access/alter the state of ML internal indices.\n+ */\n+class MlUpgradeModeActionFilter extends ActionFilter.Simple {\n+\n+    private static final Set<String> ACTIONS_DISALLOWED_IN_UPGRADE_MODE =\n+        Collections.unmodifiableSet(new HashSet<>(Arrays.asList(\n+            PutJobAction.NAME,\n+            UpdateJobAction.NAME,\n+            DeleteJobAction.NAME,\n+            OpenJobAction.NAME,\n+            FlushJobAction.NAME,\n+            CloseJobAction.NAME,\n+            PersistJobAction.NAME,\n+\n+            FinalizeJobExecutionAction.NAME,\n+            PostDataAction.NAME,\n+\n+            RevertModelSnapshotAction.NAME,\n+            UpdateModelSnapshotAction.NAME,\n+            DeleteModelSnapshotAction.NAME,\n+\n+            PutDatafeedAction.NAME,\n+            UpdateDatafeedAction.NAME,\n+            DeleteDatafeedAction.NAME,\n+            StartDatafeedAction.NAME,\n+            StopDatafeedAction.NAME,\n+\n+            PutFilterAction.NAME,\n+            UpdateFilterAction.NAME,\n+            DeleteFilterAction.NAME,\n+\n+            PutCalendarAction.NAME,\n+            UpdateCalendarJobAction.NAME,\n+            PostCalendarEventsAction.NAME,\n+            DeleteCalendarAction.NAME,\n+            DeleteCalendarEventAction.NAME,\n+\n+            UpdateProcessAction.NAME,\n+            KillProcessAction.NAME,\n+\n+            DeleteExpiredDataAction.NAME,\n+\n+            ForecastJobAction.NAME,\n+            DeleteForecastAction.NAME,\n+\n+            PutDataFrameAnalyticsAction.NAME,\n+            DeleteDataFrameAnalyticsAction.NAME,\n+            StartDataFrameAnalyticsAction.NAME,\n+            StopDataFrameAnalyticsAction.NAME,\n+\n+            PutTrainedModelAction.NAME,\n+            DeleteTrainedModelAction.NAME\n+        )));\n+\n+    private final AtomicBoolean isUpgradeMode = new AtomicBoolean();\n+\n+    MlUpgradeModeActionFilter(ClusterService clusterService) {\n+        Objects.requireNonNull(clusterService);\n+        clusterService.addListener(this::setIsUpgradeMode);\n+    }\n+\n+    @Override\n+    protected boolean apply(String action, ActionRequest request, ActionListener<?> listener) {\n+        if (isUpgradeMode.get() && ACTIONS_DISALLOWED_IN_UPGRADE_MODE.contains(action)) {\n+            throw new ElasticsearchStatusException(\n+                \"Cannot perform {} action while upgrade mode is enabled\", RestStatus.TOO_MANY_REQUESTS, action);\n+        }\n+        return true;\n+    }\n+\n+    @Override\n+    public int order() {\n+        return 666;", "originalCommit": "e112af1b4c804f37322b55b86865f8907e73fd05", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM3NzAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/54437#discussion_r405377004", "bodyText": "Done (changed to MAX_VALUE to avoid magic numbers).\nActually the only values I've seen returned by this method are MIN_VALUE and 0 so I was not sure what is the right value for this filter. I guess it can be MAX_VALUE so that it is performed as last.", "author": "przemekwitek", "createdAt": "2020-04-08T09:13:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM0NTA4NA=="}], "type": "inlineReview", "revised_code": {"commit": "7c3fec431083256c7ce236d5341af15d4282c6d8", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlUpgradeModeActionFilter.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlUpgradeModeActionFilter.java\nindex faf82a7c69c..9466ebc1772 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlUpgradeModeActionFilter.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlUpgradeModeActionFilter.java\n\n@@ -130,9 +130,15 @@ class MlUpgradeModeActionFilter extends ActionFilter.Simple {\n         return true;\n     }\n \n+    /**\n+     * To prevent leaking information to unauthorized users, it is extremely important that this filter is executed *after* the\n+     * {@code SecurityActionFilter}.\n+     * To achieve that, the number returned by this method must be greater than the number returned by the\n+     * {@code SecurityActionFilter::order} method.\n+     */\n     @Override\n     public int order() {\n-        return 666;\n+        return Integer.MAX_VALUE;\n     }\n \n     // Visible for testing\n"}}, {"oid": "dca48de46f9def88be8f19423b0c9f781b59d20b", "url": "https://github.com/elastic/elasticsearch/commit/dca48de46f9def88be8f19423b0c9f781b59d20b", "message": "Implement MlUpgradeModeActionFilter", "committedDate": "2020-04-10T07:26:17Z", "type": "commit"}, {"oid": "32e3bc650209e170b03653c9367fb59bcdcc6f94", "url": "https://github.com/elastic/elasticsearch/commit/32e3bc650209e170b03653c9367fb59bcdcc6f94", "message": "Disable upgrade mode in test cleanup", "committedDate": "2020-04-10T07:26:17Z", "type": "commit"}, {"oid": "7c3fec431083256c7ce236d5341af15d4282c6d8", "url": "https://github.com/elastic/elasticsearch/commit/7c3fec431083256c7ce236d5341af15d4282c6d8", "message": "Add comment and unit test for MlUpgradeModeActionFilter::order method", "committedDate": "2020-04-10T07:26:18Z", "type": "commit"}, {"oid": "7c3fec431083256c7ce236d5341af15d4282c6d8", "url": "https://github.com/elastic/elasticsearch/commit/7c3fec431083256c7ce236d5341af15d4282c6d8", "message": "Add comment and unit test for MlUpgradeModeActionFilter::order method", "committedDate": "2020-04-10T07:26:18Z", "type": "forcePushed"}, {"oid": "c873423fefcf82d6a29a846102159ec6adeb7e8c", "url": "https://github.com/elastic/elasticsearch/commit/c873423fefcf82d6a29a846102159ec6adeb7e8c", "message": "Extract testJobOpenActionInUpgradeMode test case out of testEnableUpgradeMode", "committedDate": "2020-04-10T10:14:14Z", "type": "commit"}]}