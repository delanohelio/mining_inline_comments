{"pr_number": 66198, "pr_title": "Improve searchable snapshot mount time", "pr_createdAt": "2020-12-11T09:16:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66198", "timeline": [{"oid": "df3e8a010d9aa89ecbecc14453667371d7da8780", "url": "https://github.com/elastic/elasticsearch/commit/df3e8a010d9aa89ecbecc14453667371d7da8780", "message": "Improve searchable snapshot mount time\n\nReduce the range sizes we fetch during mounting to speed up mount time\nuntil shard started.\nOn resource constrained setups (rate limiter, disk or network), the time\nto mount multiple shards is proportional to the amount of data to fetch\nand for most files in a snapshot, we need to fetch only a small piece of\nthe files to start the shard.", "committedDate": "2020-12-11T09:13:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI3OTY0MA==", "url": "https://github.com/elastic/elasticsearch/pull/66198#discussion_r542279640", "bodyText": "Suggest a comment so we remember why we are doing this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final Setting<ByteSizeValue> SNAPSHOT_CACHE_RECOVERY_RANGE_SIZE_SETTING = Setting.byteSizeSetting(\n          \n          \n            \n                /**\n          \n          \n            \n                 * Starting up a shard involves reading small parts of some files from the repository, independently of the pre-warming process. If we\n          \n          \n            \n                 * expand those ranges using {@link CacheService#SNAPSHOT_CACHE_RANGE_SIZE_SETTING} then we end up reading quite a few 32MB ranges. If\n          \n          \n            \n                 * we read enough of these ranges for the restore throttling rate limiter to kick in then all the read threads will end up waiting on\n          \n          \n            \n                 * the throttle, blocking subsequent reads. By using a smaller read size during restore we avoid clogging up the rate limiter so much.\n          \n          \n            \n                 */\n          \n          \n            \n                public static final Setting<ByteSizeValue> SNAPSHOT_CACHE_RECOVERY_RANGE_SIZE_SETTING = Setting.byteSizeSetting(\n          \n      \n    \n    \n  \n\nAlso suggest a similar comment on the other setting since this came up as a question in the investigation that led to this PR.\n    /**\n     * If a search needs data from the repository then we expand it to a larger contiguous range whose size is determined by this setting,\n     * in anticipation of needing nearby data in subsequent reads. Repository reads typically have quite high latency (think ~100ms) and\n     * the default of 32MB for this setting represents the approximate point at which size starts to matter. In other words, reads of\n     * ranges smaller than 32MB don't usually happen much quicker, so we may as well expand all the way to 32MB ranges.\n     */\n    public static final Setting<ByteSizeValue> SNAPSHOT_CACHE_RANGE_SIZE_SETTING = Setting.byteSizeSetting(", "author": "DaveCTurner", "createdAt": "2020-12-14T10:35:49Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java", "diffHunk": "@@ -71,6 +71,13 @@\n         MAX_SNAPSHOT_CACHE_RANGE_SIZE,                          // max\n         Setting.Property.NodeScope\n     );\n+    public static final Setting<ByteSizeValue> SNAPSHOT_CACHE_RECOVERY_RANGE_SIZE_SETTING = Setting.byteSizeSetting(", "originalCommit": "df3e8a010d9aa89ecbecc14453667371d7da8780", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7febee9a88af5ec5b4c1d049ce326b313eaaacc6", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java\nindex 3f8f94ea1454..a72f3c46be57 100644\n--- a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java\n+++ b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java\n\n@@ -64,6 +73,13 @@ public class CacheService extends AbstractLifecycleComponent {\n \n     public static final ByteSizeValue MIN_SNAPSHOT_CACHE_RANGE_SIZE = new ByteSizeValue(4, ByteSizeUnit.KB);\n     public static final ByteSizeValue MAX_SNAPSHOT_CACHE_RANGE_SIZE = new ByteSizeValue(Integer.MAX_VALUE, ByteSizeUnit.BYTES);\n+\n+    /**\n+     * If a search needs data from the repository then we expand it to a larger contiguous range whose size is determined by this setting,\n+     * in anticipation of needing nearby data in subsequent reads. Repository reads typically have quite high latency (think ~100ms) and\n+     * the default of 32MB for this setting represents the approximate point at which size starts to matter. In other words, reads of\n+     * ranges smaller than 32MB don't usually happen much quicker, so we may as well expand all the way to 32MB ranges.\n+     */\n     public static final Setting<ByteSizeValue> SNAPSHOT_CACHE_RANGE_SIZE_SETTING = Setting.byteSizeSetting(\n         SETTINGS_PREFIX + \"range_size\",\n         new ByteSizeValue(32, ByteSizeUnit.MB),                 // default\n"}}, {"oid": "6912d35a371ff84e1eba7416164ff84955fba868", "url": "https://github.com/elastic/elasticsearch/commit/6912d35a371ff84e1eba7416164ff84955fba868", "message": "Merge remote-tracking branch 'origin/master' into enhance_searchable_snapshot_mount_time", "committedDate": "2020-12-14T16:06:10Z", "type": "commit"}, {"oid": "7febee9a88af5ec5b4c1d049ce326b313eaaacc6", "url": "https://github.com/elastic/elasticsearch/commit/7febee9a88af5ec5b4c1d049ce326b313eaaacc6", "message": "Comments", "committedDate": "2020-12-14T16:08:04Z", "type": "commit"}]}