{"pr_number": 54442, "pr_title": "EQL: endsWith function implementation", "pr_createdAt": "2020-03-30T16:27:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54442", "timeline": [{"oid": "d0752da41c0de7bbe03058240a5f794d8ea029f6", "url": "https://github.com/elastic/elasticsearch/commit/d0752da41c0de7bbe03058240a5f794d8ea029f6", "message": "endsWith function implementation", "committedDate": "2020-03-30T16:24:03Z", "type": "commit"}, {"oid": "93a3b14761609aca2573ef3632733a33952871ea", "url": "https://github.com/elastic/elasticsearch/commit/93a3b14761609aca2573ef3632733a33952871ea", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 53854_impl", "committedDate": "2020-03-30T16:24:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDM0NzE1NA==", "url": "https://github.com/elastic/elasticsearch/pull/54442#discussion_r400347154", "bodyText": "nit: the getters were used instead in the previous PR and EndsWithFunctionProcessor. maybe make it consistent.", "author": "aleksmaus", "createdAt": "2020-03-30T16:57:21Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/EndsWithFunctionPipe.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.eql.expression.function.scalar.string;\n+\n+import org.elasticsearch.xpack.ql.execution.search.QlSourceBuilder;\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class EndsWithFunctionPipe extends Pipe {\n+\n+    private final Pipe source;\n+    private final Pipe pattern;\n+\n+    public EndsWithFunctionPipe(Source source, Expression expression, Pipe src, Pipe pattern) {\n+        super(source, expression, Arrays.asList(src, pattern));\n+        this.source = src;\n+        this.pattern = pattern;\n+    }\n+\n+    @Override\n+    public final Pipe replaceChildren(List<Pipe> newChildren) {\n+        if (newChildren.size() != 2) {\n+            throw new IllegalArgumentException(\"expected [2] children but received [\" + newChildren.size() + \"]\");\n+        }\n+        return replaceChildren(newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    @Override\n+    public final Pipe resolveAttributes(AttributeResolver resolver) {\n+        Pipe newSource = source.resolveAttributes(resolver);\n+        Pipe newPattern = pattern.resolveAttributes(resolver);\n+        if (newSource == source && newPattern == pattern) {\n+            return this;\n+        }\n+        return replaceChildren(newSource, newPattern);\n+    }\n+\n+    @Override\n+    public boolean supportedByAggsOnlyQuery() {\n+        return source.supportedByAggsOnlyQuery() && pattern.supportedByAggsOnlyQuery();\n+    }\n+\n+    @Override\n+    public boolean resolved() {\n+        return source.resolved() && pattern.resolved();\n+    }\n+\n+    protected Pipe replaceChildren(Pipe newSource, Pipe newPattern) {\n+        return new EndsWithFunctionPipe(source(), expression(), newSource, newPattern);\n+    }\n+\n+    @Override\n+    public final void collectFields(QlSourceBuilder sourceBuilder) {\n+        source.collectFields(sourceBuilder);\n+        pattern.collectFields(sourceBuilder);\n+    }\n+\n+    @Override\n+    protected NodeInfo<EndsWithFunctionPipe> info() {\n+        return NodeInfo.create(this, EndsWithFunctionPipe::new, expression(), source, pattern);\n+    }\n+\n+    @Override\n+    public EndsWithFunctionProcessor asProcessor() {\n+        return new EndsWithFunctionProcessor(source.asProcessor(), pattern.asProcessor());\n+    }\n+    \n+    public Pipe src() {\n+        return source;\n+    }\n+\n+    public Pipe pattern() {\n+        return pattern;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(source, pattern);\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+\n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+\n+        EndsWithFunctionPipe other = (EndsWithFunctionPipe) obj;\n+        return Objects.equals(source, other.source)", "originalCommit": "93a3b14761609aca2573ef3632733a33952871ea", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4NTYwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54442#discussion_r400485600", "bodyText": "based off some of the conversations that have been happening, I think we're going to outsource this to something else eventually.\nI don't know if that  means we should do case-sensitivity in all PRs now, or come back to this later", "author": "rw-access", "createdAt": "2020-03-30T20:50:50Z", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/expression/function/scalar/string/EndsWithFunctionProcessor.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.eql.expression.function.scalar.string;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.ql.expression.gen.processor.Processor;\n+\n+import java.io.IOException;\n+import java.util.Locale;\n+import java.util.Objects;\n+\n+public class EndsWithFunctionProcessor implements Processor {\n+\n+    public static final String NAME = \"senw\";\n+\n+    private final Processor source;\n+    private final Processor pattern;\n+\n+    public EndsWithFunctionProcessor(Processor source, Processor pattern) {\n+        this.source = source;\n+        this.pattern = pattern;\n+    }\n+\n+    public EndsWithFunctionProcessor(StreamInput in) throws IOException {\n+        source = in.readNamedWriteable(Processor.class);\n+        pattern = in.readNamedWriteable(Processor.class);\n+    }\n+\n+    @Override\n+    public final void writeTo(StreamOutput out) throws IOException {\n+        out.writeNamedWriteable(source);\n+        out.writeNamedWriteable(pattern);\n+    }\n+\n+    @Override\n+    public Object process(Object input) {\n+        return doProcess(source.process(input), pattern.process(input));\n+    }\n+\n+    public static Object doProcess(Object source, Object pattern) {\n+        if (source == null) {\n+            return null;\n+        }\n+        if (source instanceof String == false && source instanceof Character == false) {\n+            throw new EqlIllegalArgumentException(\"A string/char is required; received [{}]\", source);\n+        }\n+        if (pattern == null) {\n+            return null;\n+        }\n+        if (pattern instanceof String == false && pattern instanceof Character == false) {\n+            throw new EqlIllegalArgumentException(\"A string/char is required; received [{}]\", pattern);\n+        }\n+\n+        return source.toString().toLowerCase(Locale.ROOT).endsWith(pattern.toString().toLowerCase(Locale.ROOT));", "originalCommit": "93a3b14761609aca2573ef3632733a33952871ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUzMTAzMA==", "url": "https://github.com/elastic/elasticsearch/pull/54442#discussion_r400531030", "bodyText": "IMHO, this covers the feature parity with the original EQL implementation, and passes test against the EQL test data/queries.\nWe can merge this as is and keep iterating and moving forward.\nAlso this gives us a chance to refactor some of the code that can be better shared/reused across all of the functions implementations better.", "author": "aleksmaus", "createdAt": "2020-03-30T22:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4NTYwMA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "a3c5b0f4d9a3729e174c081d4a0427bb67cb769c", "url": "https://github.com/elastic/elasticsearch/commit/a3c5b0f4d9a3729e174c081d4a0427bb67cb769c", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 53854_impl", "committedDate": "2020-03-31T11:42:12Z", "type": "commit"}, {"oid": "b019261324bc1460c79b6bccfc338c8f7e53b790", "url": "https://github.com/elastic/elasticsearch/commit/b019261324bc1460c79b6bccfc338c8f7e53b790", "message": "Added one more test", "committedDate": "2020-03-31T11:44:01Z", "type": "commit"}, {"oid": "34317d3dea3f299b22b5a54787003ecf48a3da3a", "url": "https://github.com/elastic/elasticsearch/commit/34317d3dea3f299b22b5a54787003ecf48a3da3a", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 53854_impl", "committedDate": "2020-03-31T12:55:33Z", "type": "commit"}, {"oid": "2b0eaba1ca9a14aa34364bca9b5a65db6ab67e10", "url": "https://github.com/elastic/elasticsearch/commit/2b0eaba1ca9a14aa34364bca9b5a65db6ab67e10", "message": "Fix merging failure", "committedDate": "2020-03-31T13:07:34Z", "type": "commit"}]}