{"pr_number": 64650, "pr_title": "Do not allow spaces within MediaType's parameters", "pr_createdAt": "2020-11-05T14:04:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64650", "timeline": [{"oid": "52b53af7c6099a41011d3de89fc6fecb4b22422d", "url": "https://github.com/elastic/elasticsearch/commit/52b53af7c6099a41011d3de89fc6fecb4b22422d", "message": "Do not allow spaces within MediaType's parameters\n\nPer https://tools.ietf.org/html/rfc7231#section-3.1.1.1 MediaType can\nhave spaces around parameters pair, but do not allow spaces within\nparameter. That means that parameter pair forbids spaces around `=`\n\nfollow up after\nhttps://github.com/elastic/elasticsearch/pull/64406#discussion_r517533475\nrelates #51816", "committedDate": "2020-11-05T14:00:10Z", "type": "commit"}, {"oid": "80b3944f52728bd739fd4ad3f82f52bb014dbffa", "url": "https://github.com/elastic/elasticsearch/commit/80b3944f52728bd739fd4ad3f82f52bb014dbffa", "message": "unnecessary if", "committedDate": "2020-11-05T14:50:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyMDE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64650#discussion_r518120149", "bodyText": "I think for keyValueParam[0] you only want to check trailing whitespace, and for keyValueParam[1] you only want to check for leading whitespace. trim() checks for both.", "author": "jakelandis", "createdAt": "2020-11-05T15:04:49Z", "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/ParsedMediaType.java", "diffHunk": "@@ -90,16 +91,14 @@ public static ParsedMediaType parseMediaType(String headerValue) {\n                     if (paramsAsString.isEmpty()) {\n                         continue;\n                     }\n-                    // intentionally allowing to have spaces around `=`\n-                    // https://tools.ietf.org/html/rfc7231#section-3.1.1.1 disallows this\n-                    String[] keyValueParam = elements[i].trim().split(\"=\");\n-                    if (keyValueParam.length == 2) {\n-                        String parameterName = keyValueParam[0].toLowerCase(Locale.ROOT).trim();\n-                        String parameterValue = keyValueParam[1].toLowerCase(Locale.ROOT).trim();\n-                        parameters.put(parameterName, parameterValue);\n-                    } else {\n+                    //spaces are allowed between parameters, but not between '=' sign\n+                    String[] keyValueParam = paramsAsString.split(\"=\");\n+                    if (keyValueParam.length != 2 || hasSpaces(keyValueParam[0]) || hasSpaces(keyValueParam[1])) {", "originalCommit": "80b3944f52728bd739fd4ad3f82f52bb014dbffa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyMTY2MA==", "url": "https://github.com/elastic/elasticsearch/pull/64650#discussion_r518121660", "bodyText": "I think you can use https://docs.oracle.com/javase/7/docs/api/java/lang/Character.html#isWhitespace(char) for the first and last characters to check them independently.", "author": "jakelandis", "createdAt": "2020-11-05T15:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyMDE0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzMzE4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64650#discussion_r518133181", "bodyText": "good idea, I was meant to refactor with trim as it was unnecessarily creating garbage", "author": "pgomulka", "createdAt": "2020-11-05T15:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyMDE0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "529869637bd02660aed4d00872078917ef248794", "chunk": "diff --git a/libs/x-content/src/main/java/org/elasticsearch/common/xcontent/ParsedMediaType.java b/libs/x-content/src/main/java/org/elasticsearch/common/xcontent/ParsedMediaType.java\nindex fe96bd847b0..d333b2899b6 100644\n--- a/libs/x-content/src/main/java/org/elasticsearch/common/xcontent/ParsedMediaType.java\n+++ b/libs/x-content/src/main/java/org/elasticsearch/common/xcontent/ParsedMediaType.java\n\n@@ -93,7 +93,7 @@ public class ParsedMediaType {\n                     }\n                     //spaces are allowed between parameters, but not between '=' sign\n                     String[] keyValueParam = paramsAsString.split(\"=\");\n-                    if (keyValueParam.length != 2 || hasSpaces(keyValueParam[0]) || hasSpaces(keyValueParam[1])) {\n+                    if (keyValueParam.length != 2 || hasTrailingSpace(keyValueParam[0]) || hasLeadingSpace(keyValueParam[1])) {\n                         throw new IllegalArgumentException(\"invalid parameters for header [\" + headerValue + \"]\");\n                     }\n                     String parameterName = keyValueParam[0].toLowerCase(Locale.ROOT).trim();\n"}}, {"oid": "529869637bd02660aed4d00872078917ef248794", "url": "https://github.com/elastic/elasticsearch/commit/529869637bd02660aed4d00872078917ef248794", "message": "remove trimp approach", "committedDate": "2020-11-05T15:36:55Z", "type": "commit"}, {"oid": "fc62ad4fead9f42bc542291380dc1a77091fef93", "url": "https://github.com/elastic/elasticsearch/commit/fc62ad4fead9f42bc542291380dc1a77091fef93", "message": "line formatting", "committedDate": "2020-11-05T15:40:38Z", "type": "commit"}, {"oid": "bdaeacd85b0e0faf71613894c125e994b53778e7", "url": "https://github.com/elastic/elasticsearch/commit/bdaeacd85b0e0faf71613894c125e994b53778e7", "message": "Merge branch 'master' into compat/allign_paramter_parsing_to_rfc", "committedDate": "2020-11-05T15:57:13Z", "type": "commit"}, {"oid": "ae3a333b3af983d4dc91cd8287332a88c6063734", "url": "https://github.com/elastic/elasticsearch/commit/ae3a333b3af983d4dc91cd8287332a88c6063734", "message": "Merge branch 'master' into compat/allign_paramter_parsing_to_rfc", "committedDate": "2020-11-06T06:52:20Z", "type": "commit"}]}