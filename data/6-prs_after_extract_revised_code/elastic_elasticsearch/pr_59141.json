{"pr_number": 59141, "pr_title": "Add Check for Metadata Existence in BlobStoreRepository", "pr_createdAt": "2020-07-07T12:35:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59141", "timeline": [{"oid": "3ce2a89248efd38371681e44b693377924a63c60", "url": "https://github.com/elastic/elasticsearch/commit/3ce2a89248efd38371681e44b693377924a63c60", "message": "Add Check for Metadata Existence in BlobStoreRepository\n\nIn order to ensure that we do not write a broken piece of `RepositoryData`\nbecause the phyiscal repository generation was moved ahead more than one step\nby erroneous concurrent writing to a repository we must check whether or not\nthe current assumed repository generation exists in the repository physically.\nWithout this check we run the risk of writing on top of stale cached repository data.\n\nRelates #56911", "committedDate": "2020-07-07T12:34:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgzNzA2MA==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r450837060", "bodyText": "This one we used to do differently in original-brownbear@4b8fd4e#diff-a6d76133025d0cd3d4c12918d42be05bL66 ... but just catching any io exception and returning false seemed broken to me so I didn't bring that back. Especially since this may now trigger marking a repository as corrupted which we don't want to happen on e.g. a network issue with HDFS.", "author": "original-brownbear", "createdAt": "2020-07-07T12:47:26Z", "path": "plugins/repository-hdfs/src/main/java/org/elasticsearch/repositories/hdfs/HdfsBlobContainer.java", "diffHunk": "@@ -63,6 +63,11 @@\n     // TODO: See if we can get precise result reporting.\n     private static final DeleteResult DELETE_RESULT = new DeleteResult(1L, 0L);\n \n+    @Override\n+    public boolean blobExists(String blobName) throws IOException {\n+        return store.execute(fileContext -> fileContext.util().exists(new Path(path, blobName)));", "originalCommit": "3ce2a89248efd38371681e44b693377924a63c60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg1MjA2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r450852063", "bodyText": "This may be a little over the top since I'm not making heavy use of the second cluster now (could achieve the same test by just moving the index-N blob by two generations or mounting a second repo to the same path) but I figured it's safer and easier to maintain to do the real thing here and we can extend this to cover more spots when we tighten the safety measures further in  #57786", "author": "original-brownbear", "createdAt": "2020-07-07T13:11:25Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.snapshots;\n+\n+import org.elasticsearch.common.network.NetworkModule;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.core.internal.io.IOUtils;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.snapshots.mockstore.MockRepository;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.test.InternalSettingsPlugin;\n+import org.elasticsearch.test.InternalTestCluster;\n+import org.elasticsearch.test.MockHttpTransport;\n+import org.elasticsearch.test.NodeConfigurationSource;\n+import org.elasticsearch.test.transport.MockTransportService;\n+import org.elasticsearch.transport.nio.MockNioTransportPlugin;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+\n+public class MultiClusterRepoAccessIT extends AbstractSnapshotIntegTestCase {\n+\n+    private InternalTestCluster secondCluster;\n+    private Path repoPath;\n+\n+    @Before\n+    public void startSecondCluster() throws IOException, InterruptedException {", "originalCommit": "3ce2a89248efd38371681e44b693377924a63c60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\nindex 15ccd34d45c..8592594efab 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n\n@@ -22,6 +22,7 @@ import org.elasticsearch.common.network.NetworkModule;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.core.internal.io.IOUtils;\n import org.elasticsearch.env.Environment;\n+import org.elasticsearch.repositories.RepositoryException;\n import org.elasticsearch.snapshots.mockstore.MockRepository;\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.test.InternalSettingsPlugin;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwOTY4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r451409683", "bodyText": "should we assert that this is never called on an URL repo?", "author": "ywelsch", "createdAt": "2020-07-08T09:29:56Z", "path": "modules/repository-url/src/main/java/org/elasticsearch/common/blobstore/url/URLBlobContainer.java", "diffHunk": "@@ -69,6 +69,14 @@ public URL url() {\n         return this.path;\n     }\n \n+    /**\n+     * This operation is not supported by URLBlobContainer\n+     */\n+    @Override\n+    public boolean blobExists(String blobName) {\n+        throw new UnsupportedOperationException(\"URL repository doesn't support this operation\");", "originalCommit": "3ce2a89248efd38371681e44b693377924a63c60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNzE4NA==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r451437184", "bodyText": "Sure makes sense :)", "author": "original-brownbear", "createdAt": "2020-07-08T10:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQwOTY4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "chunk": "diff --git a/modules/repository-url/src/main/java/org/elasticsearch/common/blobstore/url/URLBlobContainer.java b/modules/repository-url/src/main/java/org/elasticsearch/common/blobstore/url/URLBlobContainer.java\nindex 7f0f8ec210e..d7db3960e67 100644\n--- a/modules/repository-url/src/main/java/org/elasticsearch/common/blobstore/url/URLBlobContainer.java\n+++ b/modules/repository-url/src/main/java/org/elasticsearch/common/blobstore/url/URLBlobContainer.java\n\n@@ -74,6 +74,7 @@ public class URLBlobContainer extends AbstractBlobContainer {\n      */\n     @Override\n     public boolean blobExists(String blobName) {\n+        assert false : \"should never be called for a read-only url repo\";\n         throw new UnsupportedOperationException(\"URL repository doesn't support this operation\");\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNDgzNg==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r451434836", "bodyText": "startDataOnlyNode()", "author": "ywelsch", "createdAt": "2020-07-08T10:14:26Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.snapshots;\n+\n+import org.elasticsearch.common.network.NetworkModule;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.core.internal.io.IOUtils;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.snapshots.mockstore.MockRepository;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.test.InternalSettingsPlugin;\n+import org.elasticsearch.test.InternalTestCluster;\n+import org.elasticsearch.test.MockHttpTransport;\n+import org.elasticsearch.test.NodeConfigurationSource;\n+import org.elasticsearch.test.transport.MockTransportService;\n+import org.elasticsearch.transport.nio.MockNioTransportPlugin;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+\n+public class MultiClusterRepoAccessIT extends AbstractSnapshotIntegTestCase {\n+\n+    private InternalTestCluster secondCluster;\n+    private Path repoPath;\n+\n+    @Before\n+    public void startSecondCluster() throws IOException, InterruptedException {\n+        repoPath = randomRepoPath();\n+        secondCluster = new InternalTestCluster(randomLong(), createTempDir(), true, true, 0,\n+                0, \"second_cluster\", new NodeConfigurationSource() {\n+            @Override\n+            public Settings nodeSettings(int nodeOrdinal) {\n+                return Settings.builder().put(MultiClusterRepoAccessIT.this.nodeSettings(nodeOrdinal))\n+                        .put(NetworkModule.TRANSPORT_TYPE_KEY, getTestTransportType())\n+                        .put(Environment.PATH_REPO_SETTING.getKey(), repoPath).build();\n+            }\n+\n+            @Override\n+            public Path nodeConfigPath(int nodeOrdinal) {\n+                return null;\n+            }\n+        }, 0, \"leader\", Arrays.asList(ESIntegTestCase.TestSeedPlugin.class,\n+                MockHttpTransport.TestPlugin.class, MockTransportService.TestPlugin.class,\n+                MockNioTransportPlugin.class, InternalSettingsPlugin.class, MockRepository.Plugin.class), Function.identity());\n+        secondCluster.beforeTest(random());\n+    }\n+\n+    @After\n+    public void stopSecondCluster() throws IOException {\n+        IOUtils.close(secondCluster);\n+    }\n+\n+    public void testConcurrentDeleteFromOtherCluster() throws InterruptedException {\n+        internalCluster().startMasterOnlyNode();\n+        internalCluster().startDataOnlyNodes(1);", "originalCommit": "3ce2a89248efd38371681e44b693377924a63c60", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\nindex 15ccd34d45c..8592594efab 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n\n@@ -22,6 +22,7 @@ import org.elasticsearch.common.network.NetworkModule;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.core.internal.io.IOUtils;\n import org.elasticsearch.env.Environment;\n+import org.elasticsearch.repositories.RepositoryException;\n import org.elasticsearch.snapshots.mockstore.MockRepository;\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.test.InternalSettingsPlugin;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNTQ4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r451435481", "bodyText": "can we assert that the message here is something about concurrent repo access?", "author": "ywelsch", "createdAt": "2020-07-08T10:15:40Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.snapshots;\n+\n+import org.elasticsearch.common.network.NetworkModule;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.core.internal.io.IOUtils;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.snapshots.mockstore.MockRepository;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.test.InternalSettingsPlugin;\n+import org.elasticsearch.test.InternalTestCluster;\n+import org.elasticsearch.test.MockHttpTransport;\n+import org.elasticsearch.test.NodeConfigurationSource;\n+import org.elasticsearch.test.transport.MockTransportService;\n+import org.elasticsearch.transport.nio.MockNioTransportPlugin;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+\n+public class MultiClusterRepoAccessIT extends AbstractSnapshotIntegTestCase {\n+\n+    private InternalTestCluster secondCluster;\n+    private Path repoPath;\n+\n+    @Before\n+    public void startSecondCluster() throws IOException, InterruptedException {\n+        repoPath = randomRepoPath();\n+        secondCluster = new InternalTestCluster(randomLong(), createTempDir(), true, true, 0,\n+                0, \"second_cluster\", new NodeConfigurationSource() {\n+            @Override\n+            public Settings nodeSettings(int nodeOrdinal) {\n+                return Settings.builder().put(MultiClusterRepoAccessIT.this.nodeSettings(nodeOrdinal))\n+                        .put(NetworkModule.TRANSPORT_TYPE_KEY, getTestTransportType())\n+                        .put(Environment.PATH_REPO_SETTING.getKey(), repoPath).build();\n+            }\n+\n+            @Override\n+            public Path nodeConfigPath(int nodeOrdinal) {\n+                return null;\n+            }\n+        }, 0, \"leader\", Arrays.asList(ESIntegTestCase.TestSeedPlugin.class,\n+                MockHttpTransport.TestPlugin.class, MockTransportService.TestPlugin.class,\n+                MockNioTransportPlugin.class, InternalSettingsPlugin.class, MockRepository.Plugin.class), Function.identity());\n+        secondCluster.beforeTest(random());\n+    }\n+\n+    @After\n+    public void stopSecondCluster() throws IOException {\n+        IOUtils.close(secondCluster);\n+    }\n+\n+    public void testConcurrentDeleteFromOtherCluster() throws InterruptedException {\n+        internalCluster().startMasterOnlyNode();\n+        internalCluster().startDataOnlyNodes(1);\n+        final String repoNameOnFirstCluster = \"test-repo\";\n+        final String repoNameOnSecondCluster = randomBoolean() ? \"test-repo\" : \"other-repo\";\n+        createRepository(repoNameOnFirstCluster, \"fs\", repoPath);\n+\n+        secondCluster.startMasterOnlyNode();\n+        secondCluster.startDataOnlyNode();\n+        secondCluster.client().admin().cluster().preparePutRepository(repoNameOnSecondCluster).setType(\"fs\")\n+                .setSettings(Settings.builder().put(\"location\", repoPath)).get();\n+\n+        createIndexWithRandomDocs(\"test-idx-1\", randomIntBetween(1, 100));\n+        createFullSnapshot(repoNameOnFirstCluster, \"snap-1\");\n+        createIndexWithRandomDocs(\"test-idx-2\", randomIntBetween(1, 100));\n+        createFullSnapshot(repoNameOnFirstCluster, \"snap-2\");\n+        createIndexWithRandomDocs(\"test-idx-3\", randomIntBetween(1, 100));\n+        createFullSnapshot(repoNameOnFirstCluster, \"snap-3\");\n+\n+        secondCluster.client().admin().cluster().prepareDeleteSnapshot(repoNameOnSecondCluster, \"snap-1\").get();\n+        secondCluster.client().admin().cluster().prepareDeleteSnapshot(repoNameOnSecondCluster, \"snap-2\").get();\n+\n+        expectThrows(SnapshotException.class, () ->", "originalCommit": "3ce2a89248efd38371681e44b693377924a63c60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0MDM1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/59141#discussion_r451440352", "bodyText": "Sure, done :)", "author": "original-brownbear", "createdAt": "2020-07-08T10:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQzNTQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\nindex 15ccd34d45c..8592594efab 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/MultiClusterRepoAccessIT.java\n\n@@ -22,6 +22,7 @@ import org.elasticsearch.common.network.NetworkModule;\n import org.elasticsearch.common.settings.Settings;\n import org.elasticsearch.core.internal.io.IOUtils;\n import org.elasticsearch.env.Environment;\n+import org.elasticsearch.repositories.RepositoryException;\n import org.elasticsearch.snapshots.mockstore.MockRepository;\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.test.InternalSettingsPlugin;\n"}}, {"oid": "7573bf325b1c4ccbccab9e101f29663145f430ab", "url": "https://github.com/elastic/elasticsearch/commit/7573bf325b1c4ccbccab9e101f29663145f430ab", "message": "Merge remote-tracking branch 'elastic/master' into multi-cluster-corruption-safety-tests", "committedDate": "2020-07-08T10:18:00Z", "type": "commit"}, {"oid": "04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "url": "https://github.com/elastic/elasticsearch/commit/04f94913d79a65d6a8007a2c01b9b28fd8aea0dc", "message": "CR: comments", "committedDate": "2020-07-08T10:24:27Z", "type": "commit"}]}