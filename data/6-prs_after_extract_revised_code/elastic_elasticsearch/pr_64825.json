{"pr_number": 64825, "pr_title": "Complete replacing member data with decorations in the ir tree", "pr_createdAt": "2020-11-09T20:59:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64825", "timeline": [{"oid": "0a1b5ed092704a1c25d1509213b16966d263c9c1", "url": "https://github.com/elastic/elasticsearch/commit/0a1b5ed092704a1c25d1509213b16966d263c9c1", "message": "make location final in IRNode", "committedDate": "2020-09-26T16:39:29Z", "type": "commit"}, {"oid": "7d62d0752fb2a99ae998fcab291c0f709bded0f5", "url": "https://github.com/elastic/elasticsearch/commit/7d62d0752fb2a99ae998fcab291c0f709bded0f5", "message": "add scoping for script, class, and method to WriteScope", "committedDate": "2020-09-26T17:18:49Z", "type": "commit"}, {"oid": "712b0a8965bba0939acd0f8e73932796eddc7238", "url": "https://github.com/elastic/elasticsearch/commit/712b0a8965bba0939acd0f8e73932796eddc7238", "message": "update scope to include classwriter and methodwriter", "committedDate": "2020-09-26T17:36:01Z", "type": "commit"}, {"oid": "8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "url": "https://github.com/elastic/elasticsearch/commit/8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "message": "move loop labels to writescope", "committedDate": "2020-09-26T17:56:22Z", "type": "commit"}, {"oid": "65502b186dbd52a0c784a52a83b1fb659e3a6abc", "url": "https://github.com/elastic/elasticsearch/commit/65502b186dbd52a0c784a52a83b1fb659e3a6abc", "message": "move try/catch labels to WriteScope", "committedDate": "2020-09-26T18:22:52Z", "type": "commit"}, {"oid": "7231b5ebd24838d08a18b46615849ab7842667eb", "url": "https://github.com/elastic/elasticsearch/commit/7231b5ebd24838d08a18b46615849ab7842667eb", "message": "move write to an external phase", "committedDate": "2020-09-26T20:26:14Z", "type": "commit"}, {"oid": "18098089e58987981be7c35788a1a8b93e3bcbb5", "url": "https://github.com/elastic/elasticsearch/commit/18098089e58987981be7c35788a1a8b93e3bcbb5", "message": "convert expression type to ir decoration", "committedDate": "2020-09-26T21:42:15Z", "type": "commit"}, {"oid": "fab7ab346732b15568ad76fbb2ac6f70310a9dfa", "url": "https://github.com/elastic/elasticsearch/commit/fab7ab346732b15568ad76fbb2ac6f70310a9dfa", "message": "update ir decoration system", "committedDate": "2020-09-27T19:33:17Z", "type": "commit"}, {"oid": "c3dd61762299bcfb2175d8c630ee04a7ec369967", "url": "https://github.com/elastic/elasticsearch/commit/c3dd61762299bcfb2175d8c630ee04a7ec369967", "message": "all escape ir decoration added", "committedDate": "2020-09-27T20:09:27Z", "type": "commit"}, {"oid": "b0cb44623a02b1046dd1dd7922523369ed4a0dd5", "url": "https://github.com/elastic/elasticsearch/commit/b0cb44623a02b1046dd1dd7922523369ed4a0dd5", "message": "some progress on moving to ir decorations", "committedDate": "2020-09-27T22:11:26Z", "type": "commit"}, {"oid": "599403addc35379422d7a20f5b279de35d21b4cc", "url": "https://github.com/elastic/elasticsearch/commit/599403addc35379422d7a20f5b279de35d21b4cc", "message": "more progress on ir decorations", "committedDate": "2020-09-27T22:56:43Z", "type": "commit"}, {"oid": "bb4baf4e7df15a72935db985c0590184252f6c2a", "url": "https://github.com/elastic/elasticsearch/commit/bb4baf4e7df15a72935db985c0590184252f6c2a", "message": "update all ir nodes to use ir decorations", "committedDate": "2020-09-29T00:08:57Z", "type": "commit"}, {"oid": "ae8d2a1f12069641171f0013205b5887c7dfcd6a", "url": "https://github.com/elastic/elasticsearch/commit/ae8d2a1f12069641171f0013205b5887c7dfcd6a", "message": "Merge branch 'master' into proto", "committedDate": "2020-09-30T14:38:56Z", "type": "commit"}, {"oid": "760b9b940997249b18947d6da787d338f2a9dc38", "url": "https://github.com/elastic/elasticsearch/commit/760b9b940997249b18947d6da787d338f2a9dc38", "message": "Merge branch 'master' into proto", "committedDate": "2020-10-05T16:36:09Z", "type": "commit"}, {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "url": "https://github.com/elastic/elasticsearch/commit/b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "message": "Merge branch 'proto' into proto2", "committedDate": "2020-10-05T17:04:18Z", "type": "commit"}, {"oid": "527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "url": "https://github.com/elastic/elasticsearch/commit/527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "message": "Merge branch 'master' into proto", "committedDate": "2020-10-08T19:53:15Z", "type": "commit"}, {"oid": "879afcac4496aa42f0d57c3485a94d11575bfe4c", "url": "https://github.com/elastic/elasticsearch/commit/879afcac4496aa42f0d57c3485a94d11575bfe4c", "message": "Merge branch 'proto' into proto2", "committedDate": "2020-10-08T19:53:23Z", "type": "commit"}, {"oid": "49397f77f269c06949af28d6a0b33e8f5d653018", "url": "https://github.com/elastic/elasticsearch/commit/49397f77f269c06949af28d6a0b33e8f5d653018", "message": "response to pr comments", "committedDate": "2020-10-08T20:17:35Z", "type": "commit"}, {"oid": "4c8082f74654dccabbb2ee339e9089623f445fb3", "url": "https://github.com/elastic/elasticsearch/commit/4c8082f74654dccabbb2ee339e9089623f445fb3", "message": "Merge branch 'master' into proto2", "committedDate": "2020-10-08T21:21:07Z", "type": "commit"}, {"oid": "883486155e6f1c304fe53b5c8ef09ee255964141", "url": "https://github.com/elastic/elasticsearch/commit/883486155e6f1c304fe53b5c8ef09ee255964141", "message": "Merge branch 'proto2' into proto3", "committedDate": "2020-10-08T21:32:23Z", "type": "commit"}, {"oid": "e31faeae9f99ed35a64d812596604b342fbc63f1", "url": "https://github.com/elastic/elasticsearch/commit/e31faeae9f99ed35a64d812596604b342fbc63f1", "message": "Merge branch 'master' into proto2", "committedDate": "2020-10-16T19:07:24Z", "type": "commit"}, {"oid": "16031ac02038b84fd67bdc650a3f374ba9c8b927", "url": "https://github.com/elastic/elasticsearch/commit/16031ac02038b84fd67bdc650a3f374ba9c8b927", "message": "Merge branch 'proto2' into proto3", "committedDate": "2020-10-16T19:07:32Z", "type": "commit"}, {"oid": "902b2ba328e4f9e3fc0a3d5f3809e257e396d2a4", "url": "https://github.com/elastic/elasticsearch/commit/902b2ba328e4f9e3fc0a3d5f3809e257e396d2a4", "message": "response to pr comments", "committedDate": "2020-10-16T19:51:59Z", "type": "commit"}, {"oid": "c245ddd2784cc981bfa207bbb5074ae73f4b5422", "url": "https://github.com/elastic/elasticsearch/commit/c245ddd2784cc981bfa207bbb5074ae73f4b5422", "message": "Merge branch 'master' into proto3", "committedDate": "2020-10-16T20:53:25Z", "type": "commit"}, {"oid": "4bfe0db6687dfe3269ef82b771f11269c0702b57", "url": "https://github.com/elastic/elasticsearch/commit/4bfe0db6687dfe3269ef82b771f11269c0702b57", "message": "Merge branch 'master' into proto3", "committedDate": "2020-10-19T16:32:50Z", "type": "commit"}, {"oid": "e025b887a4018c746f944293b59f4276a6d43170", "url": "https://github.com/elastic/elasticsearch/commit/e025b887a4018c746f944293b59f4276a6d43170", "message": "Merge branch 'proto3' into proto4", "committedDate": "2020-10-19T16:49:40Z", "type": "commit"}, {"oid": "d09de9a0acb7fd9e7f8dcff97f62745412310fe3", "url": "https://github.com/elastic/elasticsearch/commit/d09de9a0acb7fd9e7f8dcff97f62745412310fe3", "message": "Merge branch 'master' into proto3", "committedDate": "2020-10-22T17:01:04Z", "type": "commit"}, {"oid": "b22e832b888257ab748b0191a868171928c09629", "url": "https://github.com/elastic/elasticsearch/commit/b22e832b888257ab748b0191a868171928c09629", "message": "Merge branch 'proto3' into proto4", "committedDate": "2020-10-22T17:01:14Z", "type": "commit"}, {"oid": "376eda6647a7ce28433183830d3956c7faab513f", "url": "https://github.com/elastic/elasticsearch/commit/376eda6647a7ce28433183830d3956c7faab513f", "message": "response to pr comments", "committedDate": "2020-10-22T18:09:32Z", "type": "commit"}, {"oid": "a66b3936a904f5591cb5899edf3618faa8415b47", "url": "https://github.com/elastic/elasticsearch/commit/a66b3936a904f5591cb5899edf3618faa8415b47", "message": "Merge branch 'master' into proto4", "committedDate": "2020-10-22T22:06:32Z", "type": "commit"}, {"oid": "084cfe10473577b0c093fb1ff5db6e006950ed2b", "url": "https://github.com/elastic/elasticsearch/commit/084cfe10473577b0c093fb1ff5db6e006950ed2b", "message": "Merge branch 'master' into proto4", "committedDate": "2020-10-26T15:58:17Z", "type": "commit"}, {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e", "url": "https://github.com/elastic/elasticsearch/commit/40f3e98230120f60bc2e4717dd866630a5f4ab5e", "message": "Merge branch 'proto4' into proto5", "committedDate": "2020-10-26T16:55:35Z", "type": "commit"}, {"oid": "b80b1f16c4c4d1324d0f7fa135dab422ac54f411", "url": "https://github.com/elastic/elasticsearch/commit/b80b1f16c4c4d1324d0f7fa135dab422ac54f411", "message": "Merge branch 'master' into proto4", "committedDate": "2020-10-30T15:29:52Z", "type": "commit"}, {"oid": "0959d19140ce68754367fe9235218f2bd5dc9bc3", "url": "https://github.com/elastic/elasticsearch/commit/0959d19140ce68754367fe9235218f2bd5dc9bc3", "message": "Merge branch 'proto4' into proto5", "committedDate": "2020-10-30T15:29:59Z", "type": "commit"}, {"oid": "79cb97c798506de691603b0ca899027314d815bf", "url": "https://github.com/elastic/elasticsearch/commit/79cb97c798506de691603b0ca899027314d815bf", "message": "response to pr comments", "committedDate": "2020-10-30T15:33:00Z", "type": "commit"}, {"oid": "7246f01921a4fe205123bcd24c01b9b2c13e6993", "url": "https://github.com/elastic/elasticsearch/commit/7246f01921a4fe205123bcd24c01b9b2c13e6993", "message": "Merge branch 'master' into proto5", "committedDate": "2020-11-09T19:55:20Z", "type": "commit"}, {"oid": "9fd09303030302a2545e8734d8076e8ffab4aa78", "url": "https://github.com/elastic/elasticsearch/commit/9fd09303030302a2545e8734d8076e8ffab4aa78", "message": "Merge branch 'proto5' into proto6", "committedDate": "2020-11-09T20:51:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyOTk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520729948", "bodyText": "IRDCast", "author": "stu-elastic", "createdAt": "2020-11-10T17:12:34Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/CastNode.java", "diffHunk": "@@ -20,24 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class CastNode extends UnaryNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private PainlessCast cast;\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODc4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535478787", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcyOTk0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMDM4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520730387", "bodyText": "IRDOperation", "author": "stu-elastic", "createdAt": "2020-11-10T17:13:11Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/BooleanNode.java", "diffHunk": "@@ -20,24 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.Operation;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class BooleanNode extends BinaryNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Operation operation;\n-\n-    public void setOperation(Operation operation) {\n-        this.operation = operation;\n-    }\n-\n-    public Operation getOperation() {\n-        return operation;\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODg1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535478858", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMDM4Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMDg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520730866", "bodyText": "IRCAllEscape", "author": "stu-elastic", "createdAt": "2020-11-10T17:13:50Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/BlockNode.java", "diffHunk": "@@ -39,19 +39,7 @@ public void addStatementNode(StatementNode statementNode) {\n         return statementNodes;\n     }\n \n-    /* ---- end tree structure, begin node data ---- */\n-\n-    private boolean doAllEscape;\n-\n-    public void setAllEscape(boolean doAllEscape) {\n-        this.doAllEscape = doAllEscape;\n-    }\n-\n-    public boolean doAllEscape() {\n-        return doAllEscape;\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- end tree structure, begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODk1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535478959", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMDg2Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTExMA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520731110", "bodyText": "IRDExceptionType", "author": "stu-elastic", "createdAt": "2020-11-10T17:14:10Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/CatchNode.java", "diffHunk": "@@ -26,26 +26,8 @@\n \n     /* ---- begin tree structure ---- */\n \n-    private Class<?> exceptionType;\n-    private String symbol;\n     private BlockNode blockNode;", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTAyNA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479024", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTExMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTM3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520731378", "bodyText": "newline.", "author": "stu-elastic", "createdAt": "2020-11-10T17:14:30Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java", "diffHunk": "@@ -638,7 +694,8 @@ public void visitCatch(CatchNode irCatchNode, WriteScope writeScope) {\n         MethodWriter methodWriter = writeScope.getMethodWriter();\n         methodWriter.writeStatementOffset(irCatchNode.getLocation());\n \n-        Variable variable = writeScope.defineVariable(irCatchNode.getExceptionType(), irCatchNode.getSymbol());\n+        Variable variable = writeScope.defineVariable(\n+                irCatchNode.getDecorationValue(IRDExceptionType.class), irCatchNode.getDecorationValue(IRDSymbol.class));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMxNDMxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535314311", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T15:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMTM3OA=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\nindex 496813d7c40..71c4079b8c6 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n\n@@ -694,8 +695,9 @@ public class DefaultIRTreeToASMBytesPhase implements IRTreeVisitor<WriteScope> {\n         MethodWriter methodWriter = writeScope.getMethodWriter();\n         methodWriter.writeStatementOffset(irCatchNode.getLocation());\n \n-        Variable variable = writeScope.defineVariable(\n-                irCatchNode.getDecorationValue(IRDExceptionType.class), irCatchNode.getDecorationValue(IRDSymbol.class));\n+        Class<?> exceptionType = irCatchNode.getDecorationValue(IRDExceptionType.class);\n+        String exceptionName = irCatchNode.getDecorationValue(IRDSymbol.class);\n+        Variable variable = writeScope.defineVariable(exceptionType, exceptionName);\n \n         Label jump = new Label();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMjk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520732993", "bodyText": "IRDOperation", "author": "stu-elastic", "createdAt": "2020-11-10T17:16:52Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ComparisonNode.java", "diffHunk": "@@ -20,38 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.Operation;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class ComparisonNode extends BinaryNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Operation operation;\n-    private Class<?> comparisonType;\n-\n-    public void setOperation(Operation operation) {\n-        this.operation = operation;\n-    }\n-\n-    public Operation getOperation() {\n-        return operation;\n-    }\n-\n-    public void setComparisonType(Class<?> comparisonType) {\n-        this.comparisonType = comparisonType;\n-    }\n-\n-    public Class<?> getComparisonType() {\n-        return comparisonType;\n-    }\n-\n-    public String getComparisonCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(comparisonType);\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTA5NA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479094", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMjk5Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMzQ4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520733483", "bodyText": "IRDConstant", "author": "stu-elastic", "createdAt": "2020-11-10T17:17:34Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ConstantNode.java", "diffHunk": "@@ -24,19 +24,7 @@\n \n public class ConstantNode extends ExpressionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Object constant;\n-\n-    public void setConstant(Object constant) {\n-        this.constant = constant;\n-    }\n-\n-    public Object getConstant() {\n-        return constant;\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479171", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczMzQ4Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjM0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520736341", "bodyText": "Clean this up, temp var?", "author": "stu-elastic", "createdAt": "2020-11-10T17:21:41Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java", "diffHunk": "@@ -518,58 +603,86 @@ public void visitComparison(ComparisonNode irComparisonNode, Consumer<Expression\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n-            Operation operation = irComparisonNode.getOperation();\n-            Class<?> type = irComparisonNode.getComparisonType();\n+            Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n+            Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() == (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {\n-                    irLeftConstantNode.setConstant((int)irLeftConstantNode.getConstant() == (int)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == long.class) {\n-                    irLeftConstantNode.setConstant((long)irLeftConstantNode.getConstant() == (long)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == float.class) {\n-                    irLeftConstantNode.setConstant((float)irLeftConstantNode.getConstant() == (float)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == double.class) {\n-                    irLeftConstantNode.setConstant((double)irLeftConstantNode.getConstant() == (double)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(true);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(false);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant().equals(irRightConstantNode.getConstant()));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n+                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535399799", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjM0MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\nindex 42618c7416b..be6c2e681ac 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n\n@@ -603,86 +540,61 @@ public class DefaultConstantFoldingOptimizationPhase extends IRTreeBaseVisitor<C\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n+            Object leftConstantValue = irLeftConstantNode == null ? null : irLeftConstantNode.getDecorationValue(IRDConstant.class);\n+            Object rightConstantValue = irRightConstantNode == null ? null : irRightConstantNode.getDecorationValue(IRDConstant.class);\n             Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n             Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue == (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue == (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue == (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue == (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue == (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(rightConstantValue)));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue == rightConstantValue));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue != (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue != (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue != (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue != (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue != (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.NE) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class)) == false));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(\n+                                rightConstantValue) == false));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue != rightConstantValue));\n                     }\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520736524", "bodyText": "Temp var?", "author": "stu-elastic", "createdAt": "2020-11-10T17:21:55Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java", "diffHunk": "@@ -518,58 +603,86 @@ public void visitComparison(ComparisonNode irComparisonNode, Consumer<Expression\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n-            Operation operation = irComparisonNode.getOperation();\n-            Class<?> type = irComparisonNode.getComparisonType();\n+            Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n+            Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() == (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {\n-                    irLeftConstantNode.setConstant((int)irLeftConstantNode.getConstant() == (int)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == long.class) {\n-                    irLeftConstantNode.setConstant((long)irLeftConstantNode.getConstant() == (long)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == float.class) {\n-                    irLeftConstantNode.setConstant((float)irLeftConstantNode.getConstant() == (float)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == double.class) {\n-                    irLeftConstantNode.setConstant((double)irLeftConstantNode.getConstant() == (double)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(true);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(false);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant().equals(irRightConstantNode.getConstant()));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n+                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n                     } else {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant() == irRightConstantNode.getConstant());\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                                irRightConstantNode.getDecorationValue(IRDConstant.class)));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM5OTk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535399964", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\nindex 42618c7416b..be6c2e681ac 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n\n@@ -603,86 +540,61 @@ public class DefaultConstantFoldingOptimizationPhase extends IRTreeBaseVisitor<C\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n+            Object leftConstantValue = irLeftConstantNode == null ? null : irLeftConstantNode.getDecorationValue(IRDConstant.class);\n+            Object rightConstantValue = irRightConstantNode == null ? null : irRightConstantNode.getDecorationValue(IRDConstant.class);\n             Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n             Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue == (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue == (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue == (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue == (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue == (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(rightConstantValue)));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue == rightConstantValue));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue != (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue != (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue != (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue != (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue != (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.NE) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class)) == false));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(\n+                                rightConstantValue) == false));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue != rightConstantValue));\n                     }\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjU4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520736585", "bodyText": "temp var", "author": "stu-elastic", "createdAt": "2020-11-10T17:22:02Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java", "diffHunk": "@@ -518,58 +603,86 @@ public void visitComparison(ComparisonNode irComparisonNode, Consumer<Expression\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n-            Operation operation = irComparisonNode.getOperation();\n-            Class<?> type = irComparisonNode.getComparisonType();\n+            Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n+            Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() == (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {\n-                    irLeftConstantNode.setConstant((int)irLeftConstantNode.getConstant() == (int)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == long.class) {\n-                    irLeftConstantNode.setConstant((long)irLeftConstantNode.getConstant() == (long)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == float.class) {\n-                    irLeftConstantNode.setConstant((float)irLeftConstantNode.getConstant() == (float)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == double.class) {\n-                    irLeftConstantNode.setConstant((double)irLeftConstantNode.getConstant() == (double)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(true);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(false);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant().equals(irRightConstantNode.getConstant()));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n+                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n                     } else {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant() == irRightConstantNode.getConstant());\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() != (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwMDEwNg==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535400106", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNjU4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\nindex 42618c7416b..be6c2e681ac 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n\n@@ -603,86 +540,61 @@ public class DefaultConstantFoldingOptimizationPhase extends IRTreeBaseVisitor<C\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n+            Object leftConstantValue = irLeftConstantNode == null ? null : irLeftConstantNode.getDecorationValue(IRDConstant.class);\n+            Object rightConstantValue = irRightConstantNode == null ? null : irRightConstantNode.getDecorationValue(IRDConstant.class);\n             Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n             Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue == (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue == (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue == (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue == (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue == (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(rightConstantValue)));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue == rightConstantValue));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue != (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue != (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue != (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue != (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue != (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.NE) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class)) == false));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(\n+                                rightConstantValue) == false));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue != rightConstantValue));\n                     }\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNzAwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520737009", "bodyText": "temp var.", "author": "stu-elastic", "createdAt": "2020-11-10T17:22:39Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java", "diffHunk": "@@ -518,58 +603,86 @@ public void visitComparison(ComparisonNode irComparisonNode, Consumer<Expression\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n-            Operation operation = irComparisonNode.getOperation();\n-            Class<?> type = irComparisonNode.getComparisonType();\n+            Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n+            Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() == (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {\n-                    irLeftConstantNode.setConstant((int)irLeftConstantNode.getConstant() == (int)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == long.class) {\n-                    irLeftConstantNode.setConstant((long)irLeftConstantNode.getConstant() == (long)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == float.class) {\n-                    irLeftConstantNode.setConstant((float)irLeftConstantNode.getConstant() == (float)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == double.class) {\n-                    irLeftConstantNode.setConstant((double)irLeftConstantNode.getConstant() == (double)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(true);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n-                    irLeftConstantNode.setConstant(false);\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant().equals(irRightConstantNode.getConstant()));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n+                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n                     } else {\n-                        irLeftConstantNode.setConstant(irLeftConstantNode.getConstant() == irRightConstantNode.getConstant());\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(\n+                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n+                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n                 if (type == boolean.class) {\n-                    irLeftConstantNode.setConstant((boolean)irLeftConstantNode.getConstant() != (boolean)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n+                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == int.class) {\n-                    irLeftConstantNode.setConstant((int)irLeftConstantNode.getConstant() != (int)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(\n+                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n+                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n                 } else if (type == long.class) {\n-                    irLeftConstantNode.setConstant((long)irLeftConstantNode.getConstant() != (long)irRightConstantNode.getConstant());\n+                    irLeftConstantNode.attachDecoration(new IRDConstant(", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwMDI1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535400255", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDczNzAwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\nindex 42618c7416b..be6c2e681ac 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n\n@@ -603,86 +540,61 @@ public class DefaultConstantFoldingOptimizationPhase extends IRTreeBaseVisitor<C\n                     irComparisonNode.getLeftNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getLeftNode();\n             ConstantNode irRightConstantNode =\n                     irComparisonNode.getRightNode() instanceof NullNode ? null : (ConstantNode)irComparisonNode.getRightNode();\n+            Object leftConstantValue = irLeftConstantNode == null ? null : irLeftConstantNode.getDecorationValue(IRDConstant.class);\n+            Object rightConstantValue = irRightConstantNode == null ? null : irRightConstantNode.getDecorationValue(IRDConstant.class);\n             Operation operation = irComparisonNode.getDecorationValue(IRDOperation.class);\n             Class<?> type = irComparisonNode.getDecorationValue(IRDComparisonType.class);\n \n             if (operation == Operation.EQ || operation == Operation.EQR) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue == (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue == (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue == (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue == (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue == (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.EQ) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class))));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(rightConstantValue)));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) ==\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue == rightConstantValue));\n                     }\n                 }\n \n                 irLeftConstantNode.attachDecoration(new IRDExpressionType(boolean.class));\n                 scope.accept(irLeftConstantNode);\n             } else if (operation == Operation.NE || operation == Operation.NER) {\n-                if (type == boolean.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (boolean)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (boolean)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == int.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (int)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (int)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == long.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (long)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (long)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == float.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (float)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (float)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (type == double.class) {\n-                    irLeftConstantNode.attachDecoration(new IRDConstant(\n-                            (double)irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                            (double)irRightConstantNode.getDecorationValue(IRDConstant.class)));\n-                } else if (irLeftConstantNode == null && irRightConstantNode == null) {\n+                if (irLeftConstantNode == null && irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(false));\n                 } else if (irLeftConstantNode == null || irRightConstantNode == null) {\n                     irLeftConstantNode = new ConstantNode(irComparisonNode.getLeftNode().getLocation());\n                     irLeftConstantNode.attachDecoration(new IRDConstant(true));\n+                } else if (type == boolean.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((boolean)leftConstantValue != (boolean)rightConstantValue));\n+                } else if (type == int.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((int)leftConstantValue != (int)rightConstantValue));\n+                } else if (type == long.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((long)leftConstantValue != (long)rightConstantValue));\n+                } else if (type == float.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((float)leftConstantValue != (float)rightConstantValue));\n+                } else if (type == double.class) {\n+                    irLeftConstantNode.attachDecoration(new IRDConstant((double)leftConstantValue != (double)rightConstantValue));\n                 } else {\n                     if (operation == Operation.NE) {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class).equals(\n-                                        irRightConstantNode.getDecorationValue(IRDConstant.class)) == false));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue.equals(\n+                                rightConstantValue) == false));\n                     } else {\n-                        irLeftConstantNode.attachDecoration(new IRDConstant(\n-                                irLeftConstantNode.getDecorationValue(IRDConstant.class) !=\n-                                irRightConstantNode.getDecorationValue(IRDConstant.class)));\n+                        irLeftConstantNode.attachDecoration(new IRDConstant(leftConstantValue != rightConstantValue));\n                     }\n                 }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1NzI1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520757257", "bodyText": "IRDDeclarationType", "author": "stu-elastic", "createdAt": "2020-11-10T17:53:02Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/DeclarationNode.java", "diffHunk": "@@ -37,32 +36,7 @@ public ExpressionNode getExpressionNode() {\n         return expressionNode;\n     }\n \n-    /* ---- end tree structure, begin node data ---- */\n-\n-    protected String name;\n-    protected Class<?> declarationType;\n-\n-    public void setName(String name) {\n-        this.name = name;\n-    }\n-\n-    public String getName() {\n-        return name;\n-    }\n-\n-    public void setDeclarationType(Class<?> declarationType) {\n-        this.declarationType = declarationType;\n-    }\n-\n-    public Class<?> getDeclarationType() {\n-        return declarationType;\n-    }\n-\n-    public String getDeclarationCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(declarationType);\n-    }\n-\n-    /* ---- end node data, begin visitor ---- */\n+    /* ---- end tree structure, begin visitor ---- */", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTIyMg==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479222", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1NzI1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1ODQzNg==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520758436", "bodyText": "does this replace setDefReferenceEncoding?  If so add the Def prefix in there, Encoding is too general.", "author": "stu-elastic", "createdAt": "2020-11-10T17:54:48Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/IRDecorations.java", "diffHunk": "@@ -74,15 +84,328 @@ public String toString() {\n \n     public static class IRDFlags extends IRDecoration<Integer> {\n \n-        public IRDFlags(Integer flags) {\n-            super(Objects.requireNonNull(flags));\n+        public IRDFlags(Integer value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRCAllEscape implements IRCondition {\n+\n+        private IRCAllEscape() {\n+\n+        }\n+    }\n+\n+    public static class IRDCast extends IRDecoration<PainlessCast> {\n+\n+        public IRDCast(PainlessCast value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDExceptionType extends IRDType {\n+\n+        public IRDExceptionType(Class<?> value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDSymbol extends IRDecoration<String> {\n+\n+        public IRDSymbol(String value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDComparisonType extends IRDType {\n+\n+        public IRDComparisonType(Class<?> value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDConstant extends IRDecoration<Object> {\n+\n+        public IRDConstant(Object value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDDeclarationType extends IRDType {\n+\n+        public IRDDeclarationType(Class<?> value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDName extends IRDecoration<String> {\n+\n+        public IRDName(String value) {\n+            super(value);\n+        }\n+    }\n+\n+    public static class IRDEncoding extends IRDecoration<String> {\n+\n+        public IRDEncoding(String value) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwMTY5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535401699", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1ODQzNg=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/IRDecorations.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/IRDecorations.java\nindex 76fc8157965..c50c5b94988 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/IRDecorations.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/IRDecorations.java\n\n@@ -145,9 +145,9 @@ public class IRDecorations {\n         }\n     }\n \n-    public static class IRDEncoding extends IRDecoration<String> {\n+    public static class IRDDefReferenceEncoding extends IRDecoration<String> {\n \n-        public IRDEncoding(String value) {\n+        public IRDDefReferenceEncoding(String value) {\n             super(value);\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTQyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520759421", "bodyText": "?", "author": "stu-elastic", "createdAt": "2020-11-10T17:56:20Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/DoWhileLoopNode.java", "diffHunk": "@@ -22,7 +22,7 @@\n import org.elasticsearch.painless.Location;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class DoWhileLoopNode extends LoopNode {\n+public class DoWhileLoopNode extends ConditionNode {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwMjA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535402098", "bodyText": "Removed LoopNode as it no longer contained any additional information.", "author": "jdconrad", "createdAt": "2020-12-03T16:48:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTQyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTY3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520759677", "bodyText": "IRDSize", "author": "stu-elastic", "createdAt": "2020-11-10T17:56:45Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/DupNode.java", "diffHunk": "@@ -24,28 +24,7 @@\n \n public class DupNode extends UnaryNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private int size;\n-    private int depth;\n-\n-    public void setSize(int size) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTI5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479293", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTY3Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTc3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520759771", "bodyText": "IRDDepth", "author": "stu-elastic", "createdAt": "2020-11-10T17:56:52Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/DupNode.java", "diffHunk": "@@ -24,28 +24,7 @@\n \n public class DupNode extends UnaryNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private int size;\n-    private int depth;\n-\n-    public void setSize(int size) {\n-        this.size = size;\n-    }\n-\n-    public int getSize() {\n-        return size;\n-    }\n-\n-    public void setDepth(int depth) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479339", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc1OTc3MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDEyNw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520760127", "bodyText": "What's this?  It's missing now.", "author": "stu-elastic", "createdAt": "2020-11-10T17:57:28Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -464,8 +509,7 @@ protected ExpressionNode buildLoadStore(int accessDepth, Location location, bool\n                 // this is a compound assignment and requires and additional dup to re-access the prefix\n                 DupNode dupNode = new DupNode(location);\n                 dupNode.attachDecoration(new IRDExpressionType(void.class));\n-                dupNode.setSize(accessDepth);\n-                dupNode.setDepth(0);", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwNjY2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535406665", "bodyText": "Changed to decorations.", "author": "jdconrad", "createdAt": "2020-12-03T16:52:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDEyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520760521", "bodyText": "Too long.", "author": "stu-elastic", "createdAt": "2020-11-10T17:58:03Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -861,16 +931,18 @@ public void visitAssignment(EAssignment userAssignmentNode, ScriptScope scriptSc\n                 if (userAssignmentNode.postIfRead()) {\n                     irDupNode = new DupNode(irLoadNode.getLocation());\n                     irDupNode.attachDecoration(irLoadNode.getDecoration(IRDExpressionType.class));\n-                    irDupNode.setSize(MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize());\n-                    irDupNode.setDepth(accessDepth);\n+                    irDupNode.attachDecoration(new IRDSize(\n+                            MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize()));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwODYyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535408629", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:54:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDUyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\nindex 056adb9971a..97dfdb8a1dc 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n\n@@ -929,19 +929,19 @@ public class DefaultUserTreeToIRTreePhase implements UserTreeVisitor<ScriptScope\n \n                 // the value is read from prior to assignment (post-increment)\n                 if (userAssignmentNode.postIfRead()) {\n+                    int size = MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize();\n                     irDupNode = new DupNode(irLoadNode.getLocation());\n                     irDupNode.attachDecoration(irLoadNode.getDecoration(IRDExpressionType.class));\n-                    irDupNode.attachDecoration(new IRDSize(\n-                            MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                    irDupNode.attachDecoration(new IRDSize(size));\n                     irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                     irDupNode.setChildNode(irLoadNode);\n                     irLoadNode = irDupNode;\n                 // the value is read from after the assignment (pre-increment/compound)\n                 } else {\n+                    int size = MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize();\n                     irDupNode = new DupNode(irStoreNode.getLocation());\n                     irDupNode.attachDecoration(new IRDExpressionType(irStoreNode.getDecorationValue(IRDStoreType.class)));\n-                    irDupNode.attachDecoration(new IRDSize(\n-                            MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                    irDupNode.attachDecoration(new IRDSize(size));\n                     irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                     irDupNode.setChildNode(irStoreNode.getChildNode());\n                     irStoreNode.setChildNode(irDupNode);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520760689", "bodyText": "Too long.", "author": "stu-elastic", "createdAt": "2020-11-10T17:58:19Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -861,16 +931,18 @@ public void visitAssignment(EAssignment userAssignmentNode, ScriptScope scriptSc\n                 if (userAssignmentNode.postIfRead()) {\n                     irDupNode = new DupNode(irLoadNode.getLocation());\n                     irDupNode.attachDecoration(irLoadNode.getDecoration(IRDExpressionType.class));\n-                    irDupNode.setSize(MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize());\n-                    irDupNode.setDepth(accessDepth);\n+                    irDupNode.attachDecoration(new IRDSize(\n+                            MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                    irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                     irDupNode.setChildNode(irLoadNode);\n                     irLoadNode = irDupNode;\n                 // the value is read from after the assignment (pre-increment/compound)\n                 } else {\n                     irDupNode = new DupNode(irStoreNode.getLocation());\n-                    irDupNode.attachDecoration(new IRDExpressionType(irStoreNode.getStoreType()));\n-                    irDupNode.setSize(MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize());\n-                    irDupNode.setDepth(accessDepth);\n+                    irDupNode.attachDecoration(new IRDExpressionType(irStoreNode.getDecorationValue(IRDStoreType.class)));\n+                    irDupNode.attachDecoration(new IRDSize(\n+                            MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize()));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwOTQ3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535409479", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDY4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\nindex 056adb9971a..97dfdb8a1dc 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n\n@@ -929,19 +929,19 @@ public class DefaultUserTreeToIRTreePhase implements UserTreeVisitor<ScriptScope\n \n                 // the value is read from prior to assignment (post-increment)\n                 if (userAssignmentNode.postIfRead()) {\n+                    int size = MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize();\n                     irDupNode = new DupNode(irLoadNode.getLocation());\n                     irDupNode.attachDecoration(irLoadNode.getDecoration(IRDExpressionType.class));\n-                    irDupNode.attachDecoration(new IRDSize(\n-                            MethodWriter.getType(irLoadNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                    irDupNode.attachDecoration(new IRDSize(size));\n                     irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                     irDupNode.setChildNode(irLoadNode);\n                     irLoadNode = irDupNode;\n                 // the value is read from after the assignment (pre-increment/compound)\n                 } else {\n+                    int size = MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize();\n                     irDupNode = new DupNode(irStoreNode.getLocation());\n                     irDupNode.attachDecoration(new IRDExpressionType(irStoreNode.getDecorationValue(IRDStoreType.class)));\n-                    irDupNode.attachDecoration(new IRDSize(\n-                            MethodWriter.getType(irStoreNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                    irDupNode.attachDecoration(new IRDSize(size));\n                     irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                     irDupNode.setChildNode(irStoreNode.getChildNode());\n                     irStoreNode.setChildNode(irDupNode);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520760798", "bodyText": "Too long.", "author": "stu-elastic", "createdAt": "2020-11-10T17:58:28Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -909,16 +981,17 @@ public void visitAssignment(EAssignment userAssignmentNode, ScriptScope scriptSc\n \n                 DupNode irDupNode = new DupNode(irValueNode.getLocation());\n                 irDupNode.attachDecoration(irValueNode.getDecoration(IRDExpressionType.class));\n-                irDupNode.setSize(MethodWriter.getType(irValueNode.getDecorationValue(IRDExpressionType.class)).getSize());\n-                irDupNode.setDepth(accessDepth);\n+                irDupNode.attachDecoration(new IRDSize(\n+                        MethodWriter.getType(irValueNode.getDecorationValue(IRDExpressionType.class)).getSize()));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQwOTY4NA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535409684", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T16:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MDc5OA=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\nindex 056adb9971a..97dfdb8a1dc 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java\n\n@@ -977,12 +977,12 @@ public class DefaultUserTreeToIRTreePhase implements UserTreeVisitor<ScriptScope\n \n             // the value is read from after the assignment\n             if (read) {\n+                int size = MethodWriter.getType(irValueNode.getDecorationValue(IRDExpressionType.class)).getSize();\n                 int accessDepth = scriptScope.getDecoration(userAssignmentNode.getLeftNode(), AccessDepth.class).getAccessDepth();\n \n                 DupNode irDupNode = new DupNode(irValueNode.getLocation());\n                 irDupNode.attachDecoration(irValueNode.getDecoration(IRDExpressionType.class));\n-                irDupNode.attachDecoration(new IRDSize(\n-                        MethodWriter.getType(irValueNode.getDecorationValue(IRDExpressionType.class)).getSize()));\n+                irDupNode.attachDecoration(new IRDSize(size));\n                 irDupNode.attachDecoration(new IRDDepth(accessDepth));\n                 irDupNode.setChildNode(irValueNode);\n                 irValueNode = irDupNode;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NDgyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520764825", "bodyText": "IRDModifiers", "author": "stu-elastic", "createdAt": "2020-11-10T18:04:52Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/FieldNode.java", "diffHunk": "@@ -20,46 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class FieldNode extends IRNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private int modifiers;\n-    private Class<?> fieldType;\n-    private String name;\n-\n-    public void setModifiers(int modifiers) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTM5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479399", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NDgyNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NDkwOA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520764908", "bodyText": "IRDFieldType", "author": "stu-elastic", "createdAt": "2020-11-10T18:05:00Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/FieldNode.java", "diffHunk": "@@ -20,46 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class FieldNode extends IRNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private int modifiers;\n-    private Class<?> fieldType;\n-    private String name;\n-\n-    public void setModifiers(int modifiers) {\n-        this.modifiers = modifiers;\n-    }\n-\n-    public int getModifiers() {\n-        return modifiers;\n-    }\n-\n-    public void setFieldType(Class<?> fieldType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTQ4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479487", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NDkwOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjE1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520766158", "bodyText": "IRDName", "author": "stu-elastic", "createdAt": "2020-11-10T18:07:13Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/FieldNode.java", "diffHunk": "@@ -20,46 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n public class FieldNode extends IRNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private int modifiers;\n-    private Class<?> fieldType;\n-    private String name;\n-\n-    public void setModifiers(int modifiers) {\n-        this.modifiers = modifiers;\n-    }\n-\n-    public int getModifiers() {\n-        return modifiers;\n-    }\n-\n-    public void setFieldType(Class<?> fieldType) {\n-        this.fieldType = fieldType;\n-    }\n-\n-    public Class<?> getFieldType() {\n-        return fieldType;\n-    }\n-\n-    public String getFieldCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(fieldType);\n-    }\n-\n-    public void setName(String name) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479537", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjE1OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520766339", "bodyText": "newline.", "author": "stu-elastic", "createdAt": "2020-11-10T18:07:30Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java", "diffHunk": "@@ -553,7 +608,8 @@ public void visitDeclaration(DeclarationNode irDeclarationNode, WriteScope write\n         MethodWriter methodWriter = writeScope.getMethodWriter();\n         methodWriter.writeStatementOffset(irDeclarationNode.getLocation());\n \n-        Variable variable = writeScope.defineVariable(irDeclarationNode.getDeclarationType(), irDeclarationNode.getName());\n+        Variable variable = writeScope.defineVariable(\n+                irDeclarationNode.getDecorationValue(IRDDeclarationType.class), irDeclarationNode.getDecorationValue(IRDName.class));", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyMTE5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535421193", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T17:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjMzOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\nindex 496813d7c40..71c4079b8c6 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n\n@@ -608,8 +608,9 @@ public class DefaultIRTreeToASMBytesPhase implements IRTreeVisitor<WriteScope> {\n         MethodWriter methodWriter = writeScope.getMethodWriter();\n         methodWriter.writeStatementOffset(irDeclarationNode.getLocation());\n \n-        Variable variable = writeScope.defineVariable(\n-                irDeclarationNode.getDecorationValue(IRDDeclarationType.class), irDeclarationNode.getDecorationValue(IRDName.class));\n+        Class<?> variableType = irDeclarationNode.getDecorationValue(IRDDeclarationType.class);\n+        String variableName = irDeclarationNode.getDecorationValue(IRDName.class);\n+        Variable variable = writeScope.defineVariable(variableType, variableName);\n \n         if (irDeclarationNode.getExpressionNode() == null) {\n             Class<?> sort = variable.getType();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520766581", "bodyText": "new lines.", "author": "stu-elastic", "createdAt": "2020-11-10T18:07:56Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java", "diffHunk": "@@ -1537,7 +1597,8 @@ public void visitInvokeCallDef(InvokeCallDefNode irInvokeCallDefNode, WriteScope\n                 irInvokeCallDefNode.getDecorationValue(IRDExpressionType.class)), asmParameterTypes);\n \n         boostrapArguments.add(0, defCallRecipe.toString());\n-        methodWriter.invokeDefCall(irInvokeCallDefNode.getName(), methodType, DefBootstrap.METHOD_CALL, boostrapArguments.toArray());\n+        methodWriter.invokeDefCall(\n+                irInvokeCallDefNode.getDecorationValue(IRDName.class), methodType, DefBootstrap.METHOD_CALL, boostrapArguments.toArray());", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyMTk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535421948", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T17:08:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2NjU4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\nindex 496813d7c40..71c4079b8c6 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultIRTreeToASMBytesPhase.java\n\n@@ -1593,12 +1595,12 @@ public class DefaultIRTreeToASMBytesPhase implements IRTreeVisitor<WriteScope> {\n             asmParameterTypes[index] = MethodWriter.getType(typeParameters.get(index));\n         }\n \n+        String methodName = irInvokeCallDefNode.getDecorationValue(IRDName.class);\n         Type methodType = Type.getMethodType(MethodWriter.getType(\n                 irInvokeCallDefNode.getDecorationValue(IRDExpressionType.class)), asmParameterTypes);\n \n         boostrapArguments.add(0, defCallRecipe.toString());\n-        methodWriter.invokeDefCall(\n-                irInvokeCallDefNode.getDecorationValue(IRDName.class), methodType, DefBootstrap.METHOD_CALL, boostrapArguments.toArray());\n+        methodWriter.invokeDefCall(methodName, methodType, DefBootstrap.METHOD_CALL, boostrapArguments.toArray());\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2Njg1MA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520766850", "bodyText": "IRDVariableType", "author": "stu-elastic", "createdAt": "2020-11-10T18:08:26Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTYxNA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479614", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2Njg1MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2Nzk2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520767962", "bodyText": "IRDVariableName", "author": "stu-elastic", "createdAt": "2020-11-10T18:10:16Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTY2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479667", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2Nzk2Mg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODEyOA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520768128", "bodyText": "IRDCast", "author": "stu-elastic", "createdAt": "2020-11-10T18:10:32Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTcwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479707", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODEyOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODM1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520768355", "bodyText": "newlines.", "author": "stu-elastic", "createdAt": "2020-11-10T18:10:55Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java", "diffHunk": "@@ -664,8 +809,8 @@ public void visitCast(CastNode irCastNode, Consumer<ExpressionNode> scope) {\n         if (irCastNode.getChildNode() instanceof ConstantNode &&\n                 PainlessLookupUtility.isConstantType(irCastNode.getDecorationValue(IRDExpressionType.class))) {\n             ConstantNode irConstantNode = (ConstantNode)irCastNode.getChildNode();\n-            irConstantNode.setConstant(\n-                    AnalyzerCaster.constCast(irCastNode.getLocation(), irConstantNode.getConstant(), irCastNode.getCast()));\n+            irConstantNode.attachDecoration(new IRDConstant(AnalyzerCaster.constCast(irCastNode.getLocation(),", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQyNjUzMA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535426530", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T17:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODM1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\nindex 42618c7416b..be6c2e681ac 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultConstantFoldingOptimizationPhase.java\n\n@@ -809,8 +689,9 @@ public class DefaultConstantFoldingOptimizationPhase extends IRTreeBaseVisitor<C\n         if (irCastNode.getChildNode() instanceof ConstantNode &&\n                 PainlessLookupUtility.isConstantType(irCastNode.getDecorationValue(IRDExpressionType.class))) {\n             ConstantNode irConstantNode = (ConstantNode)irCastNode.getChildNode();\n-            irConstantNode.attachDecoration(new IRDConstant(AnalyzerCaster.constCast(irCastNode.getLocation(),\n-                    irConstantNode.getDecorationValue(IRDConstant.class), irCastNode.getDecorationValue(IRDCast.class))));\n+            Object constantValue = irConstantNode.getDecorationValue(IRDConstant.class);\n+            constantValue = AnalyzerCaster.constCast(irCastNode.getLocation(), constantValue, irCastNode.getDecorationValue(IRDCast.class));\n+            irConstantNode.attachDecoration(new IRDConstant(constantValue));\n             irConstantNode.attachDecoration(irCastNode.getDecoration(IRDExpressionType.class));\n             scope.accept(irConstantNode);\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODc5MA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520768790", "bodyText": "IRDArrayType", "author": "stu-elastic", "createdAt": "2020-11-10T18:11:40Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setArrayType(Class<?> arrayType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479744", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2ODc5MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2OTE2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520769163", "bodyText": "IRDArrayName", "author": "stu-elastic", "createdAt": "2020-11-10T18:12:18Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setArrayType(Class<?> arrayType) {\n-        this.arrayType = arrayType;\n-    }\n-\n-    public Class<?> getArrayType() {\n-        return arrayType;\n-    }\n-\n-    public String getArrayCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(arrayType);\n-    }\n-\n-    public void setArrayName(String arrayName) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTgwOA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479808", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2OTE2Mw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2OTYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520769611", "bodyText": "IRDIndexType", "author": "stu-elastic", "createdAt": "2020-11-10T18:13:10Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setArrayType(Class<?> arrayType) {\n-        this.arrayType = arrayType;\n-    }\n-\n-    public Class<?> getArrayType() {\n-        return arrayType;\n-    }\n-\n-    public String getArrayCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(arrayType);\n-    }\n-\n-    public void setArrayName(String arrayName) {\n-        this.arrayName = arrayName;\n-    }\n-\n-    public String getArrayName() {\n-        return arrayName;\n-    }\n-\n-    public void setIndexType(Class<?> indexType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTg2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479866", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:27:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2OTYxMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MDA3MA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520770070", "bodyText": "IRDIndexName", "author": "stu-elastic", "createdAt": "2020-11-10T18:14:03Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setArrayType(Class<?> arrayType) {\n-        this.arrayType = arrayType;\n-    }\n-\n-    public Class<?> getArrayType() {\n-        return arrayType;\n-    }\n-\n-    public String getArrayCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(arrayType);\n-    }\n-\n-    public void setArrayName(String arrayName) {\n-        this.arrayName = arrayName;\n-    }\n-\n-    public String getArrayName() {\n-        return arrayName;\n-    }\n-\n-    public void setIndexType(Class<?> indexType) {\n-        this.indexType = indexType;\n-    }\n-\n-    public Class<?> getIndexType() {\n-        return indexType;\n-    }\n-\n-    public String getIndexCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(indexType);\n-    }\n-\n-    public void setIndexName(String indexName) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3OTkyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535479920", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MDA3MA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MDQ5NA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520770494", "bodyText": "IRDIndexedType", "author": "stu-elastic", "createdAt": "2020-11-10T18:14:43Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubArrayNode.java", "diffHunk": "@@ -20,104 +20,11 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n-public class ForEachSubArrayNode extends LoopNode {\n+public class ForEachSubArrayNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> arrayType;\n-    private String arrayName;\n-    private Class<?> indexType;\n-    private String indexName;\n-    private Class<?> indexedType;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public String getVariableCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(variableType);\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setArrayType(Class<?> arrayType) {\n-        this.arrayType = arrayType;\n-    }\n-\n-    public Class<?> getArrayType() {\n-        return arrayType;\n-    }\n-\n-    public String getArrayCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(arrayType);\n-    }\n-\n-    public void setArrayName(String arrayName) {\n-        this.arrayName = arrayName;\n-    }\n-\n-    public String getArrayName() {\n-        return arrayName;\n-    }\n-\n-    public void setIndexType(Class<?> indexType) {\n-        this.indexType = indexType;\n-    }\n-\n-    public Class<?> getIndexType() {\n-        return indexType;\n-    }\n-\n-    public String getIndexCanonicalTypeName() {\n-        return PainlessLookupUtility.typeToCanonicalTypeName(indexType);\n-    }\n-\n-    public void setIndexName(String indexName) {\n-        this.indexName = indexName;\n-    }\n-\n-    public String getIndexName() {\n-        return indexName;\n-    }\n-\n-    public void setIndexedType(Class<?> indexedType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4MDE3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535480179", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MDQ5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MTY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520771645", "bodyText": "IRDVariableType", "author": "stu-elastic", "createdAt": "2020-11-10T18:16:38Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubIterableNode.java", "diffHunk": "@@ -20,73 +20,14 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessMethod;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n /**\n  * Represents a for-each loop for iterables.\n  */\n-public class ForEachSubIterableNode extends LoopNode {\n+public class ForEachSubIterableNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> iteratorType;\n-    private String iteratorName;\n-    private PainlessMethod method;\n-\n-    public void setVariableType(Class<?> variableType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4MDIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535480233", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MTY0NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MjEzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520772133", "bodyText": "IRDVariableName", "author": "stu-elastic", "createdAt": "2020-11-10T18:17:21Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubIterableNode.java", "diffHunk": "@@ -20,73 +20,14 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessMethod;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n /**\n  * Represents a for-each loop for iterables.\n  */\n-public class ForEachSubIterableNode extends LoopNode {\n+public class ForEachSubIterableNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> iteratorType;\n-    private String iteratorName;\n-    private PainlessMethod method;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public void setVariableName(String variableName) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4MDI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535480278", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MjEzMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MjUzNA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520772534", "bodyText": "IRDCast", "author": "stu-elastic", "createdAt": "2020-11-10T18:18:03Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubIterableNode.java", "diffHunk": "@@ -20,73 +20,14 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessMethod;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n /**\n  * Represents a for-each loop for iterables.\n  */\n-public class ForEachSubIterableNode extends LoopNode {\n+public class ForEachSubIterableNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> iteratorType;\n-    private String iteratorName;\n-    private PainlessMethod method;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4MDMyMA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535480320", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3MjUzNA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3OTMxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r520779313", "bodyText": "IRDIterableType", "author": "stu-elastic", "createdAt": "2020-11-10T18:29:59Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ForEachSubIterableNode.java", "diffHunk": "@@ -20,73 +20,14 @@\n package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.lookup.PainlessCast;\n-import org.elasticsearch.painless.lookup.PainlessMethod;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n \n /**\n  * Represents a for-each loop for iterables.\n  */\n-public class ForEachSubIterableNode extends LoopNode {\n+public class ForEachSubIterableNode extends ConditionNode {\n \n-    /* ---- begin node data ---- */\n-\n-    private Class<?> variableType;\n-    private String variableName;\n-    private PainlessCast cast;\n-    private Class<?> iteratorType;\n-    private String iteratorName;\n-    private PainlessMethod method;\n-\n-    public void setVariableType(Class<?> variableType) {\n-        this.variableType = variableType;\n-    }\n-\n-    public Class<?> getVariableType() {\n-        return variableType;\n-    }\n-\n-    public void setVariableName(String variableName) {\n-        this.variableName = variableName;\n-    }\n-\n-    public String getVariableName() {\n-        return variableName;\n-    }\n-\n-    public void setCast(PainlessCast cast) {\n-        this.cast = cast;\n-    }\n-\n-    public PainlessCast getCast() {\n-        return cast;\n-    }\n-\n-    public void setIteratorType(Class<?> iteratorType) {", "originalCommit": "9fd09303030302a2545e8734d8076e8ffab4aa78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ4MDM2MA==", "url": "https://github.com/elastic/elasticsearch/pull/64825#discussion_r535480360", "bodyText": "Done.", "author": "jdconrad", "createdAt": "2020-12-03T18:28:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc3OTMxMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "36e4b7d48e008c2ac41e6584a733ac8dc1aa42ea", "url": "https://github.com/elastic/elasticsearch/commit/36e4b7d48e008c2ac41e6584a733ac8dc1aa42ea", "message": "Merge branch 'master' into proto6", "committedDate": "2020-12-03T14:50:43Z", "type": "commit"}, {"oid": "d2bb70f7d55cb53339064301283bd2ca9cef7b09", "url": "https://github.com/elastic/elasticsearch/commit/d2bb70f7d55cb53339064301283bd2ca9cef7b09", "message": "partial response to pr comments", "committedDate": "2020-12-03T17:17:40Z", "type": "commit"}, {"oid": "f2a0e4d25c04722c50892af271189912279fcd61", "url": "https://github.com/elastic/elasticsearch/commit/f2a0e4d25c04722c50892af271189912279fcd61", "message": "add brief description to each ir decoration", "committedDate": "2020-12-03T18:25:43Z", "type": "commit"}, {"oid": "f1749690f71be77eaf3a11885c3de952359d63b2", "url": "https://github.com/elastic/elasticsearch/commit/f1749690f71be77eaf3a11885c3de952359d63b2", "message": "Merge branch 'master' into proto6", "committedDate": "2020-12-03T18:53:18Z", "type": "commit"}]}