{"pr_number": 52094, "pr_title": "Support authentication without anonymous user", "pr_createdAt": "2020-02-08T09:18:58Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52094", "timeline": [{"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c", "url": "https://github.com/elastic/elasticsearch/commit/7fc191dc58e2e106b2af4ffafd8af73fabea300c", "message": "Support authentication without anonymous user\n\nThis change adds a new parameter to the authenticate methods in the\nAuthenticationService to optionally exclude support for the anonymous\nuser (if an anonymous user exists).", "committedDate": "2020-02-08T09:00:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0NjcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377346719", "bodyText": "nit: Add the javadoc line here too\n\nThis method will optionally, authenticate as the anonymous user if the service is configured to allow anonymous access.", "author": "jkakavas", "createdAt": "2020-02-10T22:09:59Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -149,7 +166,7 @@ public void authenticate(String action, TransportMessage message, User fallbackU\n      */\n     public void authenticate(String action, TransportMessage message,", "originalCommit": "7fc191dc58e2e106b2af4ffafd8af73fabea300c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\nindex ea2f7c0c3e8..c6669c67e19 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n\n@@ -166,7 +184,7 @@ public class AuthenticationService {\n      */\n     public void authenticate(String action, TransportMessage message,\n                              AuthenticationToken token, ActionListener<Authentication> listener) {\n-        new Authenticator(action, message, null, isAnonymousUserEnabled, listener).authenticateToken(token);\n+        new Authenticator(action, message, null, shouldFallbackToAnonymous(true), listener).authenticateToken(token);\n     }\n \n     public void expire(String principal) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0Njc3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377346771", "bodyText": "request for change: Can we add the check for fallbackToAnonymous in shouldFallbackToAnonymous() instead so that we call one method instead of this ?", "author": "jkakavas", "createdAt": "2020-02-10T22:10:07Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -205,18 +224,21 @@ long getNumInvalidation() {\n         private AuthenticationToken authenticationToken = null;\n         private AuthenticationResult authenticationResult = null;\n \n-        Authenticator(RestRequest request, ActionListener<Authentication> listener) {\n-            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, listener);\n+        Authenticator(RestRequest request, boolean fallbackToAnonymous, ActionListener<Authentication> listener) {\n+            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, fallbackToAnonymous, listener);\n         }\n \n-        Authenticator(String action, TransportMessage message, User fallbackUser, ActionListener<Authentication> listener) {\n-            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message\n-            ), fallbackUser, listener);\n+        Authenticator(String action, TransportMessage message, User fallbackUser, boolean fallbackToAnonymous,\n+                      ActionListener<Authentication> listener) {\n+            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message),\n+                fallbackUser, fallbackToAnonymous, listener);\n         }\n \n-        private Authenticator(AuditableRequest auditableRequest, User fallbackUser, ActionListener<Authentication> listener) {\n+        private Authenticator(AuditableRequest auditableRequest, User fallbackUser, boolean fallbackToAnonymous,\n+                              ActionListener<Authentication> listener) {\n             this.request = auditableRequest;\n             this.fallbackUser = fallbackUser;\n+            this.fallbackToAnonymous = fallbackToAnonymous && shouldFallbackToAnonymous();", "originalCommit": "7fc191dc58e2e106b2af4ffafd8af73fabea300c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjA1OA==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377392058", "bodyText": "I chose to move the whole thing up into the service, so that the Authenticator just gets 1 parameter that it can respect.\nLet me know if that seems like a problem and we can talk it through.", "author": "tvernum", "createdAt": "2020-02-11T00:14:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0Njc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzYzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377453639", "bodyText": "+1", "author": "jkakavas", "createdAt": "2020-02-11T05:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0Njc3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\nindex ea2f7c0c3e8..c6669c67e19 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n\n@@ -238,7 +281,7 @@ public class AuthenticationService {\n                               ActionListener<Authentication> listener) {\n             this.request = auditableRequest;\n             this.fallbackUser = fallbackUser;\n-            this.fallbackToAnonymous = fallbackToAnonymous && shouldFallbackToAnonymous();\n+            this.fallbackToAnonymous = fallbackToAnonymous;\n             this.defaultOrderedRealmList = realms.asList();\n             this.listener = listener;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1MDY5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377350691", "bodyText": "nit: fallback user is checked before the anonymous user so we would never end up with AnonymousUser even if we passed true here. Not sure if worth mentioning in the javadoc, I was just confused while reading the existing one. Maybe something like\n\nWe want to fallback to the SystemUser and this takes precedence, but we explicitly disallow AnonymousUser fallback in order to be future proof\n\nI don't like that much either tbh", "author": "jkakavas", "createdAt": "2020-02-10T22:18:44Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -150,9 +150,10 @@ the system itself (e.g. pings, update mappings, share relocation, etc...) and we\n          it to the action without an associated user (not via REST or transport - this is taken care of by\n          the {@link Rest} filter and the {@link ServerTransport} filter respectively), it's safe to assume a system user\n          here if a request is not associated with any other user.\n+         Because we want to fallback to the SystemUser, we don't allow anonymous (AnonymousUser) requests.", "originalCommit": "7fc191dc58e2e106b2af4ffafd8af73fabea300c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM5MjMxOA==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377392318", "bodyText": "I've split this method so you can either pass in 1, non-null fallback user, or a boolean to control anonymous access. You can no longer pass both.", "author": "tvernum", "createdAt": "2020-02-11T00:15:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1MDY5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\nindex 0cd9d7517fb..b9c298023e0 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\n\n@@ -150,10 +150,9 @@ public class SecurityActionFilter implements ActionFilter {\n          it to the action without an associated user (not via REST or transport - this is taken care of by\n          the {@link Rest} filter and the {@link ServerTransport} filter respectively), it's safe to assume a system user\n          here if a request is not associated with any other user.\n-         Because we want to fallback to the SystemUser, we don't allow anonymous (AnonymousUser) requests.\n          */\n         final String securityAction = actionMapper.action(action, request);\n-        authcService.authenticate(securityAction, request, SystemUser.INSTANCE, false,\n+        authcService.authenticate(securityAction, request, SystemUser.INSTANCE,\n                 ActionListener.wrap((authc) -> {\n                     if (authc != null) {\n                         authorizeRequest(authc, securityAction, request, listener);\n"}}, {"oid": "0d51f863cee14b1003ec5f0b01a1c31cb4c47d99", "url": "https://github.com/elastic/elasticsearch/commit/0d51f863cee14b1003ec5f0b01a1c31cb4c47d99", "message": "Merge branch 'master' into authc-service-allow-anonymous", "committedDate": "2020-02-10T23:54:49Z", "type": "commit"}, {"oid": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "url": "https://github.com/elastic/elasticsearch/commit/8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "message": "Move \"fallbackToAnonymous\" checks to authc service", "committedDate": "2020-02-11T02:57:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzQ2MA==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377453460", "bodyText": "Since fallbackToAnonymous makes no sense when fallbackUser is passed in and not null, I'm wondering if this is clearer to have a ctor and a #createAuthenticator() without the  fallbackToAnonymous parameter and Objects.notNull for the fallbackUser. It feels like it would be simpler to argue about or understand while reading the code.", "author": "jkakavas", "createdAt": "2020-02-11T05:43:29Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -208,18 +267,21 @@ long getNumInvalidation() {\n         private AuthenticationToken authenticationToken = null;\n         private AuthenticationResult authenticationResult = null;\n \n-        Authenticator(RestRequest request, ActionListener<Authentication> listener) {\n-            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, listener);\n+        Authenticator(RestRequest request, boolean fallbackToAnonymous, ActionListener<Authentication> listener) {\n+            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, fallbackToAnonymous, listener);\n         }\n \n-        Authenticator(String action, TransportMessage message, User fallbackUser, ActionListener<Authentication> listener) {\n-            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message\n-            ), fallbackUser, listener);\n+        Authenticator(String action, TransportMessage message, User fallbackUser, boolean fallbackToAnonymous,", "originalCommit": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUzOTE0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377539145", "bodyText": "The other option is to merge the two options (fallbackUser and fallbacktoAnonymous) into a single field in some way. Right now those two cases in handleNullToken are almost identical.\nThere's just enough minor differences to make it a bit tricky though.\nI could make it a Supplier<Authentication> fallback, but I don't think I'd get anything cleaner than that.", "author": "tvernum", "createdAt": "2020-02-11T10:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU0NjAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377546031", "bodyText": "@jkakavas Let me know if you'd like to see that change. I've implemented it as you suggested for now, but could do more.", "author": "tvernum", "createdAt": "2020-02-11T10:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzQ2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA1MDEyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r378050123", "bodyText": "I think this is clean enough. Maybe we can reconsider additional changes in the refactoring effort that will follow at some point", "author": "jkakavas", "createdAt": "2020-02-12T05:44:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzQ2MA=="}], "type": "inlineReview", "revised_code": {"commit": "03fbeb7d542ad98b8481b3dc1317ff75c3235341", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\nindex c6669c67e19..8a9be8b5a9c 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java\n\n@@ -271,10 +277,14 @@ public class AuthenticationService {\n             this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, fallbackToAnonymous, listener);\n         }\n \n-        Authenticator(String action, TransportMessage message, User fallbackUser, boolean fallbackToAnonymous,\n-                      ActionListener<Authentication> listener) {\n+        Authenticator(String action, TransportMessage message, boolean fallbackToAnonymous, ActionListener<Authentication> listener) {\n+            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message),\n+                null, fallbackToAnonymous, listener);\n+        }\n+\n+        Authenticator(String action, TransportMessage message, User fallbackUser, ActionListener<Authentication> listener) {\n             this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message),\n-                fallbackUser, fallbackToAnonymous, listener);\n+                Objects.requireNonNull(fallbackUser, \"Fallback user cannot be null\"), false, listener);\n         }\n \n         private Authenticator(AuditableRequest auditableRequest, User fallbackUser, boolean fallbackToAnonymous,\n"}}, {"oid": "03fbeb7d542ad98b8481b3dc1317ff75c3235341", "url": "https://github.com/elastic/elasticsearch/commit/03fbeb7d542ad98b8481b3dc1317ff75c3235341", "message": "Address feedback", "committedDate": "2020-02-11T10:19:50Z", "type": "commit"}]}