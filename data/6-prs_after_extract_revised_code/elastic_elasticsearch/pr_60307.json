{"pr_number": 60307, "pr_title": "Fix ConcurrentSnapshotsIT.testMasterFailOverWithQueuedDeletes", "pr_createdAt": "2020-07-28T14:56:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60307", "timeline": [{"oid": "5590f35df4b702f549de6dee715f9e7245b90554", "url": "https://github.com/elastic/elasticsearch/commit/5590f35df4b702f549de6dee715f9e7245b90554", "message": "Fix ConcurrentSnapshotsIT.testMasterFailOverWithQueuedDeletes\n\nThe test assumed that the master fail-over would always work out as a single step.\nThis is not guaranteed however and we can randomly see master failing over twice,\nin which case the transport listener will be failed on the node that stops being\nleader and we have to catch an exception for the deletes as well just like we do\nfor the snapshot.\n\nCloses #60262", "committedDate": "2020-07-28T14:53:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY1MDQyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60307#discussion_r461650425", "bodyText": "Most of the time these go through just fine because we retry the delete requests one node disconnect and then they get batched up with the already running deletes from the previous master and all is well.\nBut if we fail over twice then the second fail-over will resolve the listeners with exceptions (this is on purpose, we don't want to be retrying (hence the exception wrapping) in this case yet again because we then get a mix of snapshot not found exception successful execution depending on the timing).", "author": "original-brownbear", "createdAt": "2020-07-28T14:58:30Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/ConcurrentSnapshotsIT.java", "diffHunk": "@@ -468,8 +469,15 @@ public void testMasterFailOverWithQueuedDeletes() throws Exception {\n         unblockNode(repoName, dataNode);\n         unblockNode(repoName, dataNode2);\n \n-        assertAcked(firstDeleteFuture.get());", "originalCommit": "5590f35df4b702f549de6dee715f9e7245b90554", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}