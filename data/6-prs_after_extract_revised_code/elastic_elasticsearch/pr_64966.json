{"pr_number": 64966, "pr_title": "Adds realm name OIDC `_security/oidc/prepare` and `_security/oidc/authenticate` APIs responses", "pr_createdAt": "2020-11-11T20:13:24Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64966", "timeline": [{"oid": "355869eaec9a6ed42caac493cd65ff17fc8f8024", "url": "https://github.com/elastic/elasticsearch/commit/355869eaec9a6ed42caac493cd65ff17fc8f8024", "message": "This change adds realm name of the realm used to perform authentication to the responses of _security/oidc/authenticate and _security/oidc/authenticate APIs\n\nResolves #53161", "committedDate": "2020-11-11T20:10:33Z", "type": "commit"}, {"oid": "819d4f1ea4624aaf87ce2c46fe54dd0f94d60286", "url": "https://github.com/elastic/elasticsearch/commit/819d4f1ea4624aaf87ce2c46fe54dd0f94d60286", "message": "Merge branch 'master' into OIDC_realm", "committedDate": "2020-11-11T20:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3NTEwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r521775105", "bodyText": "A similar assertion for realm_name of the prepare response can also be added in method OpenIdConnectAuthIT#getRedirectedFromFacilitator.", "author": "ywangd", "createdAt": "2020-11-12T02:18:34Z", "path": "x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java", "diffHunk": "@@ -420,6 +420,7 @@ private PrepareAuthResponse getRedirectedFromFacilitator(String realmName) throw\n             logger.info(\" OpenIDConnect authentication response {}\", responseBody);\n             assertNotNull(responseBody.get(\"access_token\"));\n             assertNotNull(responseBody.get(\"refresh_token\"));\n+            assertNotNull(responseBody.get(\"realm_name\"));", "originalCommit": "819d4f1ea4624aaf87ce2c46fe54dd0f94d60286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxODg5OA==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r522418898", "bodyText": "Made realm param no nullable for PrepareAuthResponse called from OpenIdConnectAuthIT#getRedirectedFromFacilitator", "author": "BigPandaToo", "createdAt": "2020-11-12T20:52:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3NTEwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "e87b60e143b229c6333b4a2b9f0bb9f00c73c4ad", "chunk": "diff --git a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\nindex 1398fffdb79..2d437468105 100644\n--- a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n+++ b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n\n@@ -420,7 +420,7 @@ public class OpenIdConnectAuthIT extends ESRestTestCase {\n             logger.info(\" OpenIDConnect authentication response {}\", responseBody);\n             assertNotNull(responseBody.get(\"access_token\"));\n             assertNotNull(responseBody.get(\"refresh_token\"));\n-            assertNotNull(responseBody.get(\"realm_name\"));\n+            assertNotNull(responseBody.get(\"realm\"));\n             assertNotNull(responseBody.get(\"authentication\"));\n             assertEquals(\"alice\", ((Map)responseBody.get(\"authentication\")).get(\"username\"));\n             return Tuple.tuple(responseBody.get(\"access_token\").toString(), responseBody.get(\"refresh_token\").toString());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3NjY1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r521776653", "bodyText": "I think we can save this new parameter because the realm information is already available via authentication.getSourceRealm().", "author": "ywangd", "createdAt": "2020-11-12T02:24:13Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java", "diffHunk": "@@ -19,14 +19,16 @@\n     private String accessTokenString;\n     private String refreshTokenString;\n     private TimeValue expiresIn;\n+    private String realmName;\n     private Authentication authentication;\n \n     public OpenIdConnectAuthenticateResponse(Authentication authentication, String accessTokenString, String refreshTokenString,\n-                                             TimeValue expiresIn) {\n+                                             TimeValue expiresIn, String realmName) {", "originalCommit": "819d4f1ea4624aaf87ce2c46fe54dd0f94d60286", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQxOTM3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r522419375", "bodyText": "Revert the changes for OIDC authenticate, as you point out - no need for this anymore.", "author": "BigPandaToo", "createdAt": "2020-11-12T20:53:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc3NjY1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "e87b60e143b229c6333b4a2b9f0bb9f00c73c4ad", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java\nindex 1783baa66d9..ae7e1eeaf91 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java\n\n@@ -19,16 +19,14 @@ public class OpenIdConnectAuthenticateResponse extends ActionResponse {\n     private String accessTokenString;\n     private String refreshTokenString;\n     private TimeValue expiresIn;\n-    private String realmName;\n     private Authentication authentication;\n \n     public OpenIdConnectAuthenticateResponse(Authentication authentication, String accessTokenString, String refreshTokenString,\n-                                             TimeValue expiresIn, String realmName) {\n+                                             TimeValue expiresIn) {\n         this.principal = authentication.getUser().principal();;\n         this.accessTokenString = accessTokenString;\n         this.refreshTokenString = refreshTokenString;\n         this.expiresIn = expiresIn;\n-        this.realmName = realmName;\n         this.authentication = authentication;\n     }\n \n"}}, {"oid": "e87b60e143b229c6333b4a2b9f0bb9f00c73c4ad", "url": "https://github.com/elastic/elasticsearch/commit/e87b60e143b229c6333b4a2b9f0bb9f00c73c4ad", "message": "This change adds realm name of the realm used to perform authentication to the responses of _security/oidc/authenticate and _security/oidc/authenticate APIs\n\nResolves #53161", "committedDate": "2020-11-12T20:49:09Z", "type": "commit"}, {"oid": "8bacf63d735945446e854e9effb9de8817ac293b", "url": "https://github.com/elastic/elasticsearch/commit/8bacf63d735945446e854e9effb9de8817ac293b", "message": "This change adds realm name of the realm used to perform authentication to the responses of _security/oidc/authenticate and _security/oidc/authenticate APIs\n\nResolves #53161", "committedDate": "2020-11-15T17:53:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NDkxOA==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r523854918", "bodyText": "This is no longer necessary since the realm field is removed from the response (due to presence of the authentication field).", "author": "ywangd", "createdAt": "2020-11-16T01:45:10Z", "path": "x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java", "diffHunk": "@@ -420,6 +420,7 @@ private PrepareAuthResponse getRedirectedFromFacilitator(String realmName) throw\n             logger.info(\" OpenIDConnect authentication response {}\", responseBody);\n             assertNotNull(responseBody.get(\"access_token\"));\n             assertNotNull(responseBody.get(\"refresh_token\"));\n+            assertNotNull(responseBody.get(\"realm\"));", "originalCommit": "8bacf63d735945446e854e9effb9de8817ac293b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5NDkwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r524094901", "bodyText": "Ah, yes, late Sunday commits don't do dood )", "author": "BigPandaToo", "createdAt": "2020-11-16T10:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NDkxOA=="}], "type": "inlineReview", "revised_code": {"commit": "f4a2d764276f172e4fa34d0bfccd4595fb17ecc5", "chunk": "diff --git a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\nindex 2d437468105..094ba6ee5ec 100644\n--- a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n+++ b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n\n@@ -420,7 +420,6 @@ public class OpenIdConnectAuthIT extends ESRestTestCase {\n             logger.info(\" OpenIDConnect authentication response {}\", responseBody);\n             assertNotNull(responseBody.get(\"access_token\"));\n             assertNotNull(responseBody.get(\"refresh_token\"));\n-            assertNotNull(responseBody.get(\"realm\"));\n             assertNotNull(responseBody.get(\"authentication\"));\n             assertEquals(\"alice\", ((Map)responseBody.get(\"authentication\")).get(\"username\"));\n             return Tuple.tuple(responseBody.get(\"access_token\").toString(), responseBody.get(\"refresh_token\").toString());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NTAyNw==", "url": "https://github.com/elastic/elasticsearch/pull/64966#discussion_r523855027", "bodyText": "Similarly, this change can be reverted.", "author": "ywangd", "createdAt": "2020-11-16T01:45:34Z", "path": "x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java", "diffHunk": "@@ -517,11 +518,13 @@ private RestClient getClient() throws Exception {\n         private URI authUri;\n         private String state;\n         private String nonce;\n+        private String realm;\n \n-        PrepareAuthResponse(URI authUri, String state, String nonce, @Nullable String realm) {\n+        PrepareAuthResponse(URI authUri, String state, String nonce, String realm) {", "originalCommit": "8bacf63d735945446e854e9effb9de8817ac293b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f4a2d764276f172e4fa34d0bfccd4595fb17ecc5", "chunk": "diff --git a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\nindex 2d437468105..094ba6ee5ec 100644\n--- a/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n+++ b/x-pack/qa/oidc-op-tests/src/test/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthIT.java\n\n@@ -518,13 +517,11 @@ public class OpenIdConnectAuthIT extends ESRestTestCase {\n         private URI authUri;\n         private String state;\n         private String nonce;\n-        private String realm;\n \n-        PrepareAuthResponse(URI authUri, String state, String nonce, String realm) {\n+        PrepareAuthResponse(URI authUri, String state, String nonce, @Nullable String realm) {\n             this.authUri = authUri;\n             this.state = state;\n             this.nonce = nonce;\n-            this.realm = realm;\n         }\n \n         URI getAuthUri() {\n"}}, {"oid": "f4a2d764276f172e4fa34d0bfccd4595fb17ecc5", "url": "https://github.com/elastic/elasticsearch/commit/f4a2d764276f172e4fa34d0bfccd4595fb17ecc5", "message": "This change adds realm name of the realm used to perform authentication to the responses of _security/oidc/authenticate and _security/oidc/authenticate APIs\n\nResolves #53161", "committedDate": "2020-11-16T17:00:58Z", "type": "commit"}]}