{"pr_number": 54043, "pr_title": "Invert license security disabled helper method", "pr_createdAt": "2020-03-24T00:58:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54043", "timeline": [{"oid": "be1750e59da449d9fbe0fdba12796e346e4d0fc7", "url": "https://github.com/elastic/elasticsearch/commit/be1750e59da449d9fbe0fdba12796e346e4d0fc7", "message": "Invert license security disabled helper method\n\nXpack license state contains a helper method to determine whether\nsecurity is disabled due to license level defaults. Most code needs to\nknow whether security is enabled, not disabled, but this method exists\nso that the security being explicitly disabled can be distinguished from\nlicence level defaulting to disabled. However, in the case that security\nis explicitly disabled, the handlers in question are never registered,\nso security is implicitly not disabled explicitly, and thus we can share\na single method to know whether licensing is enabled.", "committedDate": "2020-03-24T00:51:32Z", "type": "commit"}, {"oid": "d09ef1f02331a8e1e1b2c534c1afb45634a2d1c2", "url": "https://github.com/elastic/elasticsearch/commit/d09ef1f02331a8e1e1b2c534c1afb45634a2d1c2", "message": "fix tests", "committedDate": "2020-03-24T03:35:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczNTA0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54043#discussion_r397735046", "bodyText": "This one looks to be backwards.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (licenseState.isSecurityEnabled()) {\n          \n          \n            \n                        if (licenseState.isSecurityEnabled() == false) {", "author": "tvernum", "createdAt": "2020-03-25T10:04:16Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -111,7 +111,7 @@ public SecurityActionFilter(AuthenticationService authcService, AuthorizationSer\n                 listener.onFailure(e);\n             }\n         } else if (SECURITY_ACTION_MATCHER.test(action)) {\n-            if (licenseState.isSecurityDisabledByLicenseDefaults()) {\n+            if (licenseState.isSecurityEnabled()) {", "originalCommit": "d09ef1f02331a8e1e1b2c534c1afb45634a2d1c2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5b27226fb24b4aa927a223d559e11749f43a9607", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\nindex 1a29166988e..3a484c28dd6 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java\n\n@@ -111,7 +111,7 @@ public class SecurityActionFilter implements ActionFilter {\n                 listener.onFailure(e);\n             }\n         } else if (SECURITY_ACTION_MATCHER.test(action)) {\n-            if (licenseState.isSecurityEnabled()) {\n+            if (licenseState.isSecurityEnabled() == false) {\n                 listener.onFailure(new ElasticsearchException(\"Security must be explicitly enabled when using a [\" +\n                         licenseState.getOperationMode().description() + \"] license. \" +\n                         \"Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file \" +\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczNzcxMg==", "url": "https://github.com/elastic/elasticsearch/pull/54043#discussion_r397737712", "bodyText": "I don't follow how this works. We don't seem to configure the value security.enabled based on explicitlyDisabled.", "author": "tvernum", "createdAt": "2020-03-25T10:08:46Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/SecurityInfoTransportActionTests.java", "diffHunk": "@@ -226,8 +227,13 @@ public void testUsage() throws Exception {\n                 // FIPS 140\n                 assertThat(source.getValue(\"fips_140.enabled\"), is(fips140Enabled));\n             } else {\n+                if (explicitlyDisabled) {", "originalCommit": "d09ef1f02331a8e1e1b2c534c1afb45634a2d1c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5Mzg1OA==", "url": "https://github.com/elastic/elasticsearch/pull/54043#discussion_r398193858", "bodyText": "Oops you're right, I need to explicitly set the settings as well since SecurityUsageTransportAction checks it as well.", "author": "rjernst", "createdAt": "2020-03-25T21:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzczNzcxMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "0e9b447780f18fb1cc3ff269efae5d904f3470c7", "url": "https://github.com/elastic/elasticsearch/commit/0e9b447780f18fb1cc3ff269efae5d904f3470c7", "message": "Merge branch 'master' into refactor_license5", "committedDate": "2020-03-25T21:41:48Z", "type": "commit"}, {"oid": "5b27226fb24b4aa927a223d559e11749f43a9607", "url": "https://github.com/elastic/elasticsearch/commit/5b27226fb24b4aa927a223d559e11749f43a9607", "message": "address feedback", "committedDate": "2020-03-25T21:54:24Z", "type": "commit"}]}