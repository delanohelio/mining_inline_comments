{"pr_number": 59254, "pr_title": "[ML] Data frame analytics max_num_threads setting", "pr_createdAt": "2020-07-08T20:45:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59254", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgyMjcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/59254#discussion_r451822726", "bodyText": "since it is being serialized as vint, a validation should be made that it is  >= 0", "author": "benwtrent", "createdAt": "2020-07-08T21:01:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigUpdate.java", "diffHunk": "@@ -33,29 +34,37 @@\n             DataFrameAnalyticsConfig.MODEL_MEMORY_LIMIT,\n             VALUE);\n         PARSER.declareBoolean(Builder::setAllowLazyStart, DataFrameAnalyticsConfig.ALLOW_LAZY_START);\n-\n+        PARSER.declareInt(Builder::setMaxNumThreads, DataFrameAnalyticsConfig.MAX_NUM_THREADS);\n     }\n \n     private final String id;\n     private final String description;\n     private final ByteSizeValue modelMemoryLimit;\n     private final Boolean allowLazyStart;\n+    private final Integer maxNumThreads;\n \n     private DataFrameAnalyticsConfigUpdate(String id,\n                                            @Nullable String description,\n                                            @Nullable ByteSizeValue modelMemoryLimit,\n-                                           @Nullable Boolean allowLazyStart) {\n+                                           @Nullable Boolean allowLazyStart,\n+                                           @Nullable Integer maxNumThreads) {\n         this.id = id;\n         this.description = description;\n         this.modelMemoryLimit = modelMemoryLimit;\n         this.allowLazyStart = allowLazyStart;\n+        this.maxNumThreads = maxNumThreads;", "originalCommit": "4491a5102121fb4b94c4b11440a3035b2143d1a7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "807a53ed393972541324b480238c324f71f0891d", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigUpdate.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigUpdate.java\nindex 18fe6b05932..449223ecdf4 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigUpdate.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigUpdate.java\n\n@@ -52,6 +53,11 @@ public class DataFrameAnalyticsConfigUpdate implements Writeable, ToXContentObje\n         this.description = description;\n         this.modelMemoryLimit = modelMemoryLimit;\n         this.allowLazyStart = allowLazyStart;\n+\n+        if (maxNumThreads != null && maxNumThreads < 1) {\n+            throw ExceptionsHelper.badRequestException(\"[{}] must be a positive integer\",\n+                DataFrameAnalyticsConfig.MAX_NUM_THREADS.getPreferredName());\n+        }\n         this.maxNumThreads = maxNumThreads;\n     }\n \n"}}, {"oid": "e715406920f992a9a2c84fc85b45ae860666fb10", "url": "https://github.com/elastic/elasticsearch/commit/e715406920f992a9a2c84fc85b45ae860666fb10", "message": "[ML] Data frame analytics max_number_threads setting\n\nThis adds a setting to data frame analytics jobs called\n`max_number_threads`. The setting expects a positive integer.\nWhen used the user specifies the max number of threads that may\nbe used by the analysis. Note that the actual number of threads\nused is limited by the number of processors on the node where\nthe job is assigned. Also, the process may use a couple more threads\nfor operational functionality that is not the analysis itself.\n\nThis setting may also be updated for a stopped job.\n\nMore threads may reduce the time it takes to complete the job at the cost\nof using more CPU.", "committedDate": "2020-07-09T12:42:20Z", "type": "commit"}, {"oid": "807a53ed393972541324b480238c324f71f0891d", "url": "https://github.com/elastic/elasticsearch/commit/807a53ed393972541324b480238c324f71f0891d", "message": "Fix YAML test and add validation on update", "committedDate": "2020-07-09T12:42:20Z", "type": "commit"}, {"oid": "ada72b853de771eb7f3b10101a39b4457342bf75", "url": "https://github.com/elastic/elasticsearch/commit/ada72b853de771eb7f3b10101a39b4457342bf75", "message": "Fix doc test", "committedDate": "2020-07-09T12:42:20Z", "type": "commit"}, {"oid": "186c86ce7cde294b7ef4a347497c5bf2004f4ec2", "url": "https://github.com/elastic/elasticsearch/commit/186c86ce7cde294b7ef4a347497c5bf2004f4ec2", "message": "Docs should have max_num_threads", "committedDate": "2020-07-09T12:42:20Z", "type": "commit"}, {"oid": "e77dae924f89f8297139564b18b26aa6878487ad", "url": "https://github.com/elastic/elasticsearch/commit/e77dae924f89f8297139564b18b26aa6878487ad", "message": "Rename client update to maxNumThreads", "committedDate": "2020-07-09T12:42:20Z", "type": "commit"}, {"oid": "9e5e9b48b6319d6ce51fc149db58b5582d165bdb", "url": "https://github.com/elastic/elasticsearch/commit/9e5e9b48b6319d6ce51fc149db58b5582d165bdb", "message": "Address more review comments plus add to YAML test", "committedDate": "2020-07-09T13:01:16Z", "type": "commit"}, {"oid": "9e5e9b48b6319d6ce51fc149db58b5582d165bdb", "url": "https://github.com/elastic/elasticsearch/commit/9e5e9b48b6319d6ce51fc149db58b5582d165bdb", "message": "Address more review comments plus add to YAML test", "committedDate": "2020-07-09T13:01:16Z", "type": "forcePushed"}]}