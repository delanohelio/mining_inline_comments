{"pr_number": 59817, "pr_title": "Track backing indices in data streams stats from cluster state", "pr_createdAt": "2020-07-17T21:36:55Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59817", "timeline": [{"oid": "d38419a00153bc9c633100361930cad7af917235", "url": "https://github.com/elastic/elasticsearch/commit/d38419a00153bc9c633100361930cad7af917235", "message": "Track backing indices from cluster state instead of shard responses", "committedDate": "2020-07-17T20:44:40Z", "type": "commit"}, {"oid": "470a2995744d528740a3936a9366b427992aba87", "url": "https://github.com/elastic/elasticsearch/commit/470a2995744d528740a3936a9366b427992aba87", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats", "committedDate": "2020-07-17T21:03:07Z", "type": "commit"}, {"oid": "4488d08e419393ac4904f1e64afbbff0e15a05a7", "url": "https://github.com/elastic/elasticsearch/commit/4488d08e419393ac4904f1e64afbbff0e15a05a7", "message": "Ensure indices are closed properly before continuing test", "committedDate": "2020-07-20T19:32:14Z", "type": "commit"}, {"oid": "ece51be3815524ad4d7f279249aeeb8ff2dd1d9c", "url": "https://github.com/elastic/elasticsearch/commit/ece51be3815524ad4d7f279249aeeb8ff2dd1d9c", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats", "committedDate": "2020-07-20T19:32:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1NzEyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59817#discussion_r457657125", "bodyText": "It's not the focus of this PR, but I do wonder if this could be replaced with IndexNameExpressionResolver::dataStreamNames since it needs to resolve only data stream names and not indices or aliases.", "author": "danhermann", "createdAt": "2020-07-20T19:58:25Z", "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java", "diffHunk": "@@ -94,18 +96,22 @@ protected ClusterBlockException checkRequestBlock(\n         return state.blocks().indicesBlockedException(ClusterBlockLevel.METADATA_READ, concreteIndices);\n     }\n \n-    @Override\n-    protected ShardsIterator shards(ClusterState clusterState, DataStreamsStatsAction.Request request, String[] concreteIndices) {\n+    private List<String> dataStreamNames(ClusterState clusterState, DataStreamsStatsAction.Request request) {\n         String[] requestIndices = request.indices();\n         if (requestIndices == null || requestIndices.length == 0) {\n             requestIndices = new String[] { \"*\" };\n         }\n-        List<String> abstractionNames = indexAbstractionResolver.resolveIndexAbstractions(\n+        return indexAbstractionResolver.resolveIndexAbstractions(", "originalCommit": "ece51be3815524ad4d7f279249aeeb8ff2dd1d9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "daacd80f09b77144fc422f5f5b886ee3f46f8ccd", "chunk": "diff --git a/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java b/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java\nindex b21ae62569e..d05c42899d8 100644\n--- a/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java\n+++ b/x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java\n\n@@ -101,12 +101,7 @@ public class DataStreamsStatsTransportAction extends TransportBroadcastByNodeAct\n         if (requestIndices == null || requestIndices.length == 0) {\n             requestIndices = new String[] { \"*\" };\n         }\n-        return indexAbstractionResolver.resolveIndexAbstractions(\n-            requestIndices,\n-            request.indicesOptions(),\n-            clusterState.getMetadata(),\n-            true // Always include data streams for data streams stats api\n-        );\n+        return indexNameExpressionResolver.dataStreamNames(clusterState, request.indicesOptions(), requestIndices);\n     }\n \n     @Override\n"}}, {"oid": "daacd80f09b77144fc422f5f5b886ee3f46f8ccd", "url": "https://github.com/elastic/elasticsearch/commit/daacd80f09b77144fc422f5f5b886ee3f46f8ccd", "message": "Use dataStreamNames instead of resolveIndexAbstractions", "committedDate": "2020-07-20T20:54:36Z", "type": "commit"}, {"oid": "2506e4c255800f0c171501b3f54d3c5bcfa419b8", "url": "https://github.com/elastic/elasticsearch/commit/2506e4c255800f0c171501b3f54d3c5bcfa419b8", "message": "Precommit", "committedDate": "2020-07-21T00:13:58Z", "type": "commit"}, {"oid": "1bfbaedcd75c99984c90eda8d65190960c36eddf", "url": "https://github.com/elastic/elasticsearch/commit/1bfbaedcd75c99984c90eda8d65190960c36eddf", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats", "committedDate": "2020-07-21T14:50:47Z", "type": "commit"}]}