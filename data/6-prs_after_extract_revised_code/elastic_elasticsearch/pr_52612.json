{"pr_number": 52612, "pr_title": "Simplify constant handling in Painless", "pr_createdAt": "2020-02-21T01:19:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52612", "timeline": [{"oid": "87583f3a6f8008994498f61927fd80b9ac03af8f", "url": "https://github.com/elastic/elasticsearch/commit/87583f3a6f8008994498f61927fd80b9ac03af8f", "message": "partially update regex nodes", "committedDate": "2020-02-20T22:31:06Z", "type": "commit"}, {"oid": "2e4a2cc436f700cdeae67d5687847fd525ec5c0e", "url": "https://github.com/elastic/elasticsearch/commit/2e4a2cc436f700cdeae67d5687847fd525ec5c0e", "message": "remove need for regex node", "committedDate": "2020-02-20T22:39:17Z", "type": "commit"}, {"oid": "37c275946688e023516714ed0f0b860bd169ae5b", "url": "https://github.com/elastic/elasticsearch/commit/37c275946688e023516714ed0f0b860bd169ae5b", "message": "remove globals", "committedDate": "2020-02-20T23:31:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyODgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383428826", "bodyText": "Why is this necessary?", "author": "stu-elastic", "createdAt": "2020-02-24T18:12:38Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java", "diffHunk": "@@ -72,6 +72,7 @@ StatementExpressionNode write(ClassNode classNode) {\n \n         statementExpressionNode.setLocation(location);\n         statementExpressionNode.setMethodEscape(methodEscape);\n+        statementExpressionNode.setNoop(false);", "originalCommit": "37c275946688e023516714ed0f0b860bd169ae5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0MTEwNA==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383541104", "bodyText": "After speaking with you (@stu-elastic) and @rjernst I've decided to change this a bit. I've removed noop in favor of doPop which will pop extraneous values off the stack when necessary such as a method call with side effects, but an ignored return value somecall();.\nI also removed the need for StatementExpressionNode to handle return values. Instead, SExpression will just directly translate to a ReturnNode if a return is required. This moves the responsibility to where is makes sense instead of having redundant returns in multiple nodes.", "author": "jdconrad", "createdAt": "2020-02-24T22:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyODgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3NzY3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383577671", "bodyText": "I continued to iterate on this after more discussion with @rjernst . I removed the doPop and will instead use an expression's type to determine if a pop is required or not (popping the void type is the same as a noop in this case).", "author": "jdconrad", "createdAt": "2020-02-24T23:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyODgyNg=="}], "type": "inlineReview", "revised_code": {"commit": "313b09ad7e94b76627ceb500fc51b1d603b4454b", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java\nindex 78a53f2ebbf..614f294cd01 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java\n\n@@ -65,16 +67,25 @@ public final class SExpression extends AStatement {\n     }\n \n     @Override\n-    StatementExpressionNode write(ClassNode classNode) {\n-        StatementExpressionNode statementExpressionNode = new StatementExpressionNode();\n+    StatementNode write(ClassNode classNode) {\n+        if (methodEscape) {\n+            ReturnNode returnNode = new ReturnNode();\n \n-        statementExpressionNode.setExpressionNode(expression.write(classNode));\n+            returnNode.setExpressionNode(expression.write(classNode));\n \n-        statementExpressionNode.setLocation(location);\n-        statementExpressionNode.setMethodEscape(methodEscape);\n-        statementExpressionNode.setNoop(false);\n+            returnNode.setLocation(location);\n \n-        return statementExpressionNode;\n+            return returnNode;\n+        } else {\n+            StatementExpressionNode statementExpressionNode = new StatementExpressionNode();\n+\n+            statementExpressionNode.setExpressionNode(expression.write(classNode));\n+\n+            statementExpressionNode.setLocation(location);\n+            statementExpressionNode.setPop(true);\n+\n+            return statementExpressionNode;\n+        }\n     }\n \n     @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MDA5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383440095", "bodyText": "There's now MemberFieldLoadNode and MemberFieldStoreNode where Store has the following new code:\n        if (isStatic == false) {\n            methodWriter.loadThis();\n        }\n\n        getChildNode().write(classWriter, methodWriter, scopeTable);\nWhy the new code?", "author": "stu-elastic", "createdAt": "2020-02-24T18:35:26Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldLoadNode.java", "diffHunk": "@@ -51,12 +50,8 @@ public boolean isStatic() {\n \n     /* ---- end node data ---- */\n \n-    public MemberFieldNode() {\n-        // do nothing\n-    }\n-\n     @Override\n-    public void write(ClassWriter classWriter, MethodWriter methodWriter, Globals globals, ScopeTable scopeTable) {\n+    public void write(ClassWriter classWriter, MethodWriter methodWriter, ScopeTable scopeTable) {", "originalCommit": "37c275946688e023516714ed0f0b860bd169ae5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0MTY1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383541659", "bodyText": "The new code is to handle putting the value on the stack that will be written to the field. So store requires an expression to generate a value to store where as load does not.", "author": "jdconrad", "createdAt": "2020-02-24T22:02:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MDA5NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MzgzMw==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383443833", "bodyText": "Where is this being written to clinit?", "author": "stu-elastic", "createdAt": "2020-02-24T18:42:44Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/ERegex.java", "diffHunk": "@@ -74,30 +81,90 @@ void analyze(ScriptRoot scriptRoot, Scope scope) {\n                     new IllegalArgumentException(\"Error compiling regex: \" + e.getDescription()));\n         }\n \n-        String name = scriptRoot.getNextSyntheticName(\"regex\");\n-        scriptRoot.getClassNode().addField(\n-                new SField(location, Modifier.FINAL | Modifier.STATIC | Modifier.PRIVATE, name, Pattern.class));\n-        constant = new Constant(location, MethodWriter.getType(Pattern.class), name, this::initializeConstant);\n+        name = scriptRoot.getNextSyntheticName(\"regex\");\n         actual = Pattern.class;\n     }\n \n     @Override\n-    RegexNode write(ClassNode classNode) {\n-        RegexNode regexNode = new RegexNode();\n-        regexNode.setLocation(location);\n+    MemberFieldLoadNode write(ClassNode classNode) {\n+        FieldNode fieldNode = new FieldNode();\n+        fieldNode.setLocation(location);\n+        fieldNode.setModifiers(Modifier.FINAL | Modifier.STATIC | Modifier.PRIVATE);\n+        fieldNode.setFieldType(Pattern.class);\n+        fieldNode.setName(name);\n \n-        regexNode.setExpressionType(actual);\n-        regexNode.setFlags(flags);\n-        regexNode.setPattern(pattern);\n-        regexNode.setConstant(constant);\n+        classNode.addFieldNode(fieldNode);\n \n-        return regexNode;\n-    }\n+        try {\n+            StatementExpressionNode statementExpressionNode = new StatementExpressionNode();\n+            statementExpressionNode.setLocation(location);\n+            statementExpressionNode.setMethodEscape(true);\n+            statementExpressionNode.setNoop(true);\n+\n+            BlockNode blockNode = classNode.getClinitNode().getBlockNode();\n+            blockNode.addStatementNode(statementExpressionNode);\n+\n+            MemberFieldStoreNode memberFieldStoreNode = new MemberFieldStoreNode();\n+            memberFieldStoreNode.setLocation(location);\n+            memberFieldStoreNode.setExpressionType(Pattern.class);\n+            memberFieldStoreNode.setName(name);\n+            memberFieldStoreNode.setStatic(true);\n+\n+            statementExpressionNode.setExpressionNode(memberFieldStoreNode);\n+\n+            CallNode callNode = new CallNode();\n+            callNode.setLocation(location);\n+            callNode.setExpressionType(Pattern.class);\n+\n+            memberFieldStoreNode.setChildNode(callNode);\n+\n+            StaticNode staticNode = new StaticNode();\n+            staticNode.setLocation(location);\n+            staticNode.setExpressionType(Pattern.class);\n+\n+            callNode.setLeftNode(staticNode);\n+\n+            CallSubNode callSubNode = new CallSubNode();\n+            callSubNode.setLocation(location);\n+            callSubNode.setExpressionType(Pattern.class);\n+            callSubNode.setBox(Pattern.class);\n+            callSubNode.setMethod(new PainlessMethod(\n+                    Pattern.class.getMethod(\"compile\", String.class, int.class),", "originalCommit": "37c275946688e023516714ed0f0b860bd169ae5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0ODY3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383448677", "bodyText": "Oh perhaps in classNode.addFieldNode(fieldNode);?", "author": "stu-elastic", "createdAt": "2020-02-24T18:52:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MzgzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0NDIxOA==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383544218", "bodyText": "classNode.addFieldNode creates a declaration for a member field.\nThese lines actually add the regex constant generation and assignment to the clinit method:\nBlockNode blockNode = classNode.getClinitNode().getBlockNode();\nblockNode.addStatementNode(statementExpressionNode);", "author": "jdconrad", "createdAt": "2020-02-24T22:09:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ0MzgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "313b09ad7e94b76627ceb500fc51b1d603b4454b", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/ERegex.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/ERegex.java\nindex 7fa912a8de7..27a69ead7d1 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/ERegex.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/node/ERegex.java\n\n@@ -98,8 +98,7 @@ public final class ERegex extends AExpression {\n         try {\n             StatementExpressionNode statementExpressionNode = new StatementExpressionNode();\n             statementExpressionNode.setLocation(location);\n-            statementExpressionNode.setMethodEscape(true);\n-            statementExpressionNode.setNoop(true);\n+            statementExpressionNode.setPop(false);\n \n             BlockNode blockNode = classNode.getClinitNode().getBlockNode();\n             blockNode.addStatementNode(statementExpressionNode);\n"}}, {"oid": "be77e74c38c8a13e8918bb537154ce7c2f6d965d", "url": "https://github.com/elastic/elasticsearch/commit/be77e74c38c8a13e8918bb537154ce7c2f6d965d", "message": "Merge branch 'master' into trees9", "committedDate": "2020-02-24T21:18:05Z", "type": "commit"}, {"oid": "313b09ad7e94b76627ceb500fc51b1d603b4454b", "url": "https://github.com/elastic/elasticsearch/commit/313b09ad7e94b76627ceb500fc51b1d603b4454b", "message": "remove noop", "committedDate": "2020-02-24T21:58:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyMjIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383422224", "bodyText": "minimal javadoc please", "author": "rjernst", "createdAt": "2020-02-24T17:59:02Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldStoreNode.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.painless.ir;\n+\n+import org.elasticsearch.painless.ClassWriter;\n+import org.elasticsearch.painless.MethodWriter;\n+import org.elasticsearch.painless.symbol.ScopeTable;\n+\n+import static org.elasticsearch.painless.WriterConstants.CLASS_TYPE;\n+\n+public class MemberFieldStoreNode extends UnaryNode {", "originalCommit": "37c275946688e023516714ed0f0b860bd169ae5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU3NzAzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383577035", "bodyText": "Added.", "author": "jdconrad", "createdAt": "2020-02-24T23:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyMjIyNA=="}], "type": "inlineReview", "revised_code": {"commit": "5dde7fcece03b49bd0ba8f68f23c82b07c328511", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldStoreNode.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldStoreNode.java\nindex afb1e44aea7..184979a2494 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldStoreNode.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/MemberFieldStoreNode.java\n\n@@ -21,15 +21,22 @@ package org.elasticsearch.painless.ir;\n \n import org.elasticsearch.painless.ClassWriter;\n import org.elasticsearch.painless.MethodWriter;\n+import org.elasticsearch.painless.lookup.PainlessLookupUtility;\n import org.elasticsearch.painless.symbol.ScopeTable;\n \n import static org.elasticsearch.painless.WriterConstants.CLASS_TYPE;\n \n+/**\n+ * Represents a member field assignment on the main class.\n+ * The value to store is generated by the child node accessed\n+ * via {@link #getChildNode()}.\n+ */\n public class MemberFieldStoreNode extends UnaryNode {\n \n     /* ---- begin node data ---- */\n \n     protected String name;\n+    protected Class<?> fieldType;\n     protected boolean isStatic;\n \n     public void setName(String name) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU2MDQ3MA==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383560470", "bodyText": "Could we add this when creating the clinit block, and have an inner block that we expose as the one that statements can be added to? This way we don't manipulate the IR tree when calling write.", "author": "rjernst", "createdAt": "2020-02-24T22:47:35Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ClassNode.java", "diffHunk": "@@ -152,34 +169,25 @@ public ScriptRoot getScriptRoot() {\n         constructor.returnValue();\n         constructor.endMethod();\n \n+        if (clinitNode.getBlockNode().getStatementsNodes().isEmpty() == false) {\n+            ReturnNode returnNode = new ReturnNode();\n+            returnNode.setLocation(new Location(\"internal$clinit$return\", 0));\n+            clinitNode.getBlockNode().addStatementNode(returnNode);", "originalCommit": "313b09ad7e94b76627ceb500fc51b1d603b4454b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5OTg2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52612#discussion_r383599862", "bodyText": "I changed this to do no modifications of the ir tree from write. I just do the method writer for clinit and the return statement in the ClassNode. I'll consider better ways to do this, but for now this makes the most sense because it's the simplest change.", "author": "jdconrad", "createdAt": "2020-02-25T00:47:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU2MDQ3MA=="}], "type": "inlineReview", "revised_code": {"commit": "cd306a75dc64cbfd28bb3c53624264c244d1743d", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ClassNode.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ClassNode.java\nindex 67f18a89c12..39530e87471 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ClassNode.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/ClassNode.java\n\n@@ -169,12 +159,13 @@ public class ClassNode extends IRNode {\n         constructor.returnValue();\n         constructor.endMethod();\n \n-        if (clinitNode.getBlockNode().getStatementsNodes().isEmpty() == false) {\n-            ReturnNode returnNode = new ReturnNode();\n-            returnNode.setLocation(new Location(\"internal$clinit$return\", 0));\n-            clinitNode.getBlockNode().addStatementNode(returnNode);\n-\n-            clinitNode.write(classWriter, null, new ScopeTable());\n+        if (clinitBlockNode.getStatementsNodes().isEmpty() == false) {\n+            MethodWriter methodWriter = classWriter.newMethodWriter(\n+                    Opcodes.ACC_PUBLIC | Opcodes.ACC_STATIC,\n+                    new Method(\"<clinit>\", Type.getType(void.class), new Type[0]));\n+            clinitBlockNode.write(classWriter, methodWriter, new ScopeTable());\n+            methodWriter.returnValue();\n+            methodWriter.endMethod();\n         }\n \n         // Write all fields:\n"}}, {"oid": "5dde7fcece03b49bd0ba8f68f23c82b07c328511", "url": "https://github.com/elastic/elasticsearch/commit/5dde7fcece03b49bd0ba8f68f23c82b07c328511", "message": "Removed the doPop boolean in favor of using the expression's type.", "committedDate": "2020-02-24T23:32:17Z", "type": "commit"}, {"oid": "40a176c90c15a07bcc99c6b3240fad8be006a97d", "url": "https://github.com/elastic/elasticsearch/commit/40a176c90c15a07bcc99c6b3240fad8be006a97d", "message": "fix not a statement with void return type", "committedDate": "2020-02-25T00:09:36Z", "type": "commit"}, {"oid": "cd306a75dc64cbfd28bb3c53624264c244d1743d", "url": "https://github.com/elastic/elasticsearch/commit/cd306a75dc64cbfd28bb3c53624264c244d1743d", "message": "remove modication of ir tree in write related to clinit", "committedDate": "2020-02-25T00:46:09Z", "type": "commit"}]}