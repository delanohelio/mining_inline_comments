{"pr_number": 63269, "pr_title": "Convert TextFieldMapper to parametrized form", "pr_createdAt": "2020-10-05T17:15:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63269", "timeline": [{"oid": "3b79036af5f936ac47d8678f704937b1f6dd23f5", "url": "https://github.com/elastic/elasticsearch/commit/3b79036af5f936ac47d8678f704937b1f6dd23f5", "message": "Convert TextFieldMapper to parametrized form", "committedDate": "2020-10-05T17:03:00Z", "type": "commit"}, {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "url": "https://github.com/elastic/elasticsearch/commit/ad4b5adc1cd1ce53ffe532d67a664192439962dc", "message": "nits", "committedDate": "2020-10-05T17:12:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MDQyMg==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499790422", "bodyText": "Could you move this below all the Parameter so I don't lose it?", "author": "nik9000", "createdAt": "2020-10-05T18:27:46Z", "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "diffHunk": "@@ -72,92 +70,94 @@\n  * This code is largely a copy of TextFieldMapper which is less than ideal -\n  * my attempts to subclass TextFieldMapper failed but we can revisit this.\n  **/\n-public class AnnotatedTextFieldMapper extends FieldMapper {\n+public class AnnotatedTextFieldMapper extends ParametrizedFieldMapper {\n \n     public static final String CONTENT_TYPE = \"annotated_text\";\n     private static final int POSITION_INCREMENT_GAP_USE_ANALYZER = -1;\n \n-    public static class Builder extends TextFieldMapper.Builder {\n+    private static Builder builder(FieldMapper in) {\n+        return ((AnnotatedTextFieldMapper)in).builder;\n+    }\n \n-        private int positionIncrementGap = POSITION_INCREMENT_GAP_USE_ANALYZER;\n+    public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        public Builder(String name) {\n-            super(name);\n-            builder = this;\n-        }\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.getValue(), true);\n+        private final Parameter<Boolean> store = Parameter.storeParam(m -> builder(m).store.getValue(), false);\n \n-        public Builder positionIncrementGap(int positionIncrementGap) {\n-            if (positionIncrementGap < 0) {\n-                throw new MapperParsingException(\"[positions_increment_gap] must be positive, got \" + positionIncrementGap);\n-            }\n-            this.positionIncrementGap = positionIncrementGap;\n-            return this;\n+        final TextParams.Analyzers analyzers;", "originalCommit": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "47409f77a214d70d245b82391dbcf1fc2776c902", "chunk": "diff --git a/plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java b/plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java\nindex 69fb1b5eab6..442cf76c5bb 100644\n--- a/plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java\n+++ b/plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java\n\n@@ -81,7 +81,6 @@ public class AnnotatedTextFieldMapper extends ParametrizedFieldMapper {\n \n     public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.getValue(), true);\n         private final Parameter<Boolean> store = Parameter.storeParam(m -> builder(m).store.getValue(), false);\n \n         final TextParams.Analyzers analyzers;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjEwMg==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499792102", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-10-05T18:30:51Z", "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "diffHunk": "@@ -191,22 +191,18 @@ public static AnnotatedText parse (String textPlusMarkup) {\n                 String value = null;\n                 for (String pair : pairs) {\n                     String[] kv = pair.split(\"=\");\n-                    try {\n-                        if(kv.length == 2){\n-                            throw new ElasticsearchParseException(\"key=value pairs are not supported in annotations\");\n-                        }\n-                        if(kv.length == 1) {\n-                            //Check \"=\" sign wasn't in the pair string\n-                            if(kv[0].length() == pair.length()) {\n-                                //untyped value\n-                                value = URLDecoder.decode(kv[0], \"UTF-8\");\n-                            }\n-                        }\n-                        if (value!=null && value.length() > 0) {\n-                            annotations.add(new AnnotationToken(startOffset, endOffset, value));\n+                    if(kv.length == 2){\n+                        throw new ElasticsearchParseException(\"key=value pairs are not supported in annotations\");\n+                    }\n+                    if(kv.length == 1) {\n+                        //Check \"=\" sign wasn't in the pair string\n+                        if(kv[0].length() == pair.length()) {\n+                            //untyped value\n+                            value = URLDecoder.decode(kv[0], StandardCharsets.UTF_8);", "originalCommit": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5Mjc2OA==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499792768", "bodyText": "I wonder if alwaysSerialize should a shortcut to this new thing - it is easier for me to read the intent of alwaysSerialize than this lambda.", "author": "nik9000", "createdAt": "2020-10-05T18:32:14Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -142,7 +142,7 @@ private static CompletionFieldMapper toType(FieldMapper in) {\n             m -> toType(m).maxInputLength, Defaults.DEFAULT_MAX_INPUT_LENGTH)\n             .addDeprecatedName(\"max_input_len\")\n             .setValidator(Builder::validateInputLength)\n-            .alwaysSerialize();\n+            .setSerializerCheck((id, ic, v) -> true);", "originalCommit": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MjM2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r500172365", "bodyText": "I added alwaysSerialize and neverSerialize as shortcuts.", "author": "romseygeek", "createdAt": "2020-10-06T10:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5Mjc2OA=="}], "type": "inlineReview", "revised_code": {"commit": "47409f77a214d70d245b82391dbcf1fc2776c902", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\nindex 7dcc3349778..5153b58b2fc 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\n\n@@ -142,7 +142,7 @@ public class CompletionFieldMapper extends ParametrizedFieldMapper {\n             m -> toType(m).maxInputLength, Defaults.DEFAULT_MAX_INPUT_LENGTH)\n             .addDeprecatedName(\"max_input_len\")\n             .setValidator(Builder::validateInputLength)\n-            .setSerializerCheck((id, ic, v) -> true);\n+            .alwaysSerialize();\n         private final Parameter<Map<String, String>> meta = Parameter.metaParam();\n \n         private final NamedAnalyzer defaultAnalyzer;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MzE2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499793161", "bodyText": "Are you thinking of removing the old getValue in a follow up?", "author": "nik9000", "createdAt": "2020-10-05T18:33:04Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -178,6 +180,11 @@ public T getValue() {\n             return isSet ? value : defaultValue.get();\n         }\n \n+        @Override", "originalCommit": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA3MTkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r500071924", "bodyText": "That's the plan, yes", "author": "romseygeek", "createdAt": "2020-10-06T07:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MzE2MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5NDA3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499794076", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-10-05T18:34:50Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -121,101 +119,230 @@\n         public static final int POSITION_INCREMENT_GAP = 100;\n     }\n \n-    public static class Builder extends FieldMapper.Builder<Builder> {\n+    private static Builder builder(FieldMapper in) {\n+        return ((TextFieldMapper) in).builder;\n+    }\n \n-        private int positionIncrementGap = POSITION_INCREMENT_GAP_USE_ANALYZER;\n-        private int minPrefixChars = -1;\n-        private int maxPrefixChars = -1;\n-        private boolean fielddata = false;\n-        private boolean indexPhrases = false;\n-        private boolean eagerGlobalOrdinals = false;\n-        private double fielddataMinFreq = Defaults.FIELDDATA_MIN_FREQUENCY;\n-        private double fielddataMaxFreq = Defaults.FIELDDATA_MAX_FREQUENCY;\n-        private int fielddataMinSegSize = Defaults.FIELDDATA_MIN_SEGMENT_SIZE;\n-        protected SimilarityProvider similarity;\n+    private static final class PrefixConfig implements ToXContent {\n+        final int minChars;\n+        final int maxChars;\n \n-        public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE);\n-            builder = this;\n+        private PrefixConfig(int minChars, int maxChars) {\n+            this.minChars = minChars;\n+            this.maxChars = maxChars;\n+            if (minChars > maxChars) {\n+                throw new IllegalArgumentException(\"min_chars [\" + minChars + \"] must be less than max_chars [\" + maxChars + \"]\");\n+            }\n+            if (minChars < 1) {\n+                throw new IllegalArgumentException(\"min_chars [\" + minChars + \"] must be greater than zero\");\n+            }\n+            if (maxChars >= 20) {\n+                throw new IllegalArgumentException(\"max_chars [\" + maxChars + \"] must be less than 20\");\n+            }\n         }\n \n-        public Builder positionIncrementGap(int positionIncrementGap) {\n-            if (positionIncrementGap < 0) {\n-                throw new MapperParsingException(\"[positions_increment_gap] must be positive, got \" + positionIncrementGap);\n-            }\n-            this.positionIncrementGap = positionIncrementGap;\n-            return this;\n+        @Override\n+        public boolean equals(Object o) {\n+            if (this == o) return true;\n+            if (o == null || getClass() != o.getClass()) return false;\n+            PrefixConfig that = (PrefixConfig) o;\n+            return minChars == that.minChars &&\n+                maxChars == that.maxChars;\n         }\n \n-        public Builder fielddata(boolean fielddata) {\n-            this.fielddata = fielddata;\n-            return builder;\n+        @Override\n+        public int hashCode() {\n+            return Objects.hash(minChars, maxChars);\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"{ min_chars=\" + minChars + \", max_chars=\" + maxChars + \" }\";\n         }\n \n-        public Builder indexPhrases(boolean indexPhrases) {\n-            this.indexPhrases = indexPhrases;\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            builder.field(\"min_chars\", minChars);\n+            builder.field(\"max_chars\", maxChars);\n+            builder.endObject();\n             return builder;\n         }\n+    }\n \n-        public void similarity(SimilarityProvider similarity) {\n-            this.similarity = similarity;\n+    private static PrefixConfig parsePrefixConfig(String propName, ParserContext parserContext, Object propNode) {\n+        if (propNode == null) {\n+            return null;\n+        }\n+        Map<?, ?> indexPrefix = (Map<?, ?>) propNode;\n+        int minChars = XContentMapValues.nodeIntegerValue(indexPrefix.remove(\"min_chars\"),\n+            Defaults.INDEX_PREFIX_MIN_CHARS);\n+        int maxChars = XContentMapValues.nodeIntegerValue(indexPrefix.remove(\"max_chars\"),\n+            Defaults.INDEX_PREFIX_MAX_CHARS);\n+        DocumentMapperParser.checkNoRemainingFields(propName, indexPrefix, parserContext.indexVersionCreated());\n+        return new PrefixConfig(minChars, maxChars);\n+    }\n+\n+    private static final class FielddataFrequencyFilter implements ToXContent {", "originalCommit": "ad4b5adc1cd1ce53ffe532d67a664192439962dc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "33dde51329a4ca0e5ce6cb93023255a27c7ce92d", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\nindex d0f240d258f..4cd8212263d 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n\n@@ -245,7 +245,6 @@ public class TextFieldMapper extends ParametrizedFieldMapper {\n         private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.getValue(), true);\n         private final Parameter<Boolean> store = Parameter.storeParam(m -> builder(m).store.getValue(), false);\n \n-        final TextParams.Analyzers analyzers;\n         final Parameter<SimilarityProvider> similarity\n             = TextParams.similarity(m -> builder(m).similarity.getValue());\n \n"}}, {"oid": "96651c5de6d146bf7019a7d8bb51acc4d91ce744", "url": "https://github.com/elastic/elasticsearch/commit/96651c5de6d146bf7019a7d8bb51acc4d91ce744", "message": "tests", "committedDate": "2020-10-06T08:56:21Z", "type": "commit"}, {"oid": "94f0689f5aedb0f33250714c4e3c5c5d92f5ac32", "url": "https://github.com/elastic/elasticsearch/commit/94f0689f5aedb0f33250714c4e3c5c5d92f5ac32", "message": "Merge remote-tracking branch 'origin/master' into mapper/textfield-params", "committedDate": "2020-10-06T08:56:24Z", "type": "commit"}, {"oid": "47409f77a214d70d245b82391dbcf1fc2776c902", "url": "https://github.com/elastic/elasticsearch/commit/47409f77a214d70d245b82391dbcf1fc2776c902", "message": "moar tests", "committedDate": "2020-10-06T10:11:37Z", "type": "commit"}, {"oid": "33dde51329a4ca0e5ce6cb93023255a27c7ce92d", "url": "https://github.com/elastic/elasticsearch/commit/33dde51329a4ca0e5ce6cb93023255a27c7ce92d", "message": "more tests - bwc/mixed still failing due to serialization changes", "committedDate": "2020-10-06T14:50:36Z", "type": "commit"}, {"oid": "33dde51329a4ca0e5ce6cb93023255a27c7ce92d", "url": "https://github.com/elastic/elasticsearch/commit/33dde51329a4ca0e5ce6cb93023255a27c7ce92d", "message": "more tests - bwc/mixed still failing due to serialization changes", "committedDate": "2020-10-06T14:50:36Z", "type": "forcePushed"}, {"oid": "7276c03ecc79a2e37b26a6a9ab928e940f03f896", "url": "https://github.com/elastic/elasticsearch/commit/7276c03ecc79a2e37b26a6a9ab928e940f03f896", "message": "well this sucks", "committedDate": "2020-10-06T16:18:00Z", "type": "commit"}, {"oid": "dcf7fcbac18764997c14658f5f98757043a96a72", "url": "https://github.com/elastic/elasticsearch/commit/dcf7fcbac18764997c14658f5f98757043a96a72", "message": "external fieldtype", "committedDate": "2020-10-06T17:15:43Z", "type": "commit"}, {"oid": "a6c49d8b6010effeef7ff513f22df1e2abe2e917", "url": "https://github.com/elastic/elasticsearch/commit/a6c49d8b6010effeef7ff513f22df1e2abe2e917", "message": "test", "committedDate": "2020-10-06T21:04:47Z", "type": "commit"}, {"oid": "12875d9137c9bc6e304af633419d0232e45c5bcb", "url": "https://github.com/elastic/elasticsearch/commit/12875d9137c9bc6e304af633419d0232e45c5bcb", "message": "tests", "committedDate": "2020-10-07T08:11:27Z", "type": "commit"}, {"oid": "e885ceaf1beb5450ad0312c3dadd7acdfc814917", "url": "https://github.com/elastic/elasticsearch/commit/e885ceaf1beb5450ad0312c3dadd7acdfc814917", "message": "Merge remote-tracking branch 'origin/master' into mapper/textfield-params", "committedDate": "2020-10-07T08:11:43Z", "type": "commit"}, {"oid": "7734125c905a2fdd0bcda780d8b928274b8ac7d8", "url": "https://github.com/elastic/elasticsearch/commit/7734125c905a2fdd0bcda780d8b928274b8ac7d8", "message": "moar test", "committedDate": "2020-10-07T08:28:08Z", "type": "commit"}, {"oid": "7734125c905a2fdd0bcda780d8b928274b8ac7d8", "url": "https://github.com/elastic/elasticsearch/commit/7734125c905a2fdd0bcda780d8b928274b8ac7d8", "message": "moar test", "committedDate": "2020-10-07T08:28:08Z", "type": "forcePushed"}]}