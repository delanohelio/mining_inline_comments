{"pr_number": 55411, "pr_title": "Add prefer_v2_templates flag and index setting", "pr_createdAt": "2020-04-17T16:35:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55411", "timeline": [{"oid": "f4c725561d9ce0425bcb56c927372e447b297f2f", "url": "https://github.com/elastic/elasticsearch/commit/f4c725561d9ce0425bcb56c927372e447b297f2f", "message": "Add prefer_v2_templates flag and index setting\n\nThis commit adds a new querystring parameter on the following APIs:\n- Index\n- Update\n- Bulk\n- Create Index\n- Rollover\n\nThese APIs now support a `?prefer_v2_templates=true|false` flag. This flag changes the preference\ncreation to use either V2 index templates or V1 templates. This flag defaults to `false` and will be\nchanged to `true` for 8.0+ in subsequent work.\n\nAdditionally, setting this flag internally sets the `index.prefer_v2_templates` index-level setting.\nThis setting is used so that actions that automatically create a new index (things like rollover\ninitiated by ILM) will inherit the preference from the original index. This setting is dynamic so\nthat a transition from v1 to v2 templates can occur for longrunning indices grouped by an alias\nperforming periodic rollover.\n\nThis also adds support for sending this parameter to the High Level Rest Client.\n\nRelates to #53101", "committedDate": "2020-04-17T16:34:34Z", "type": "commit"}, {"oid": "3d50c154f1366045a4aa43744340b997db1be8f6", "url": "https://github.com/elastic/elasticsearch/commit/3d50c154f1366045a4aa43744340b997db1be8f6", "message": "Don't replicate preference setting for CCR", "committedDate": "2020-04-17T16:54:36Z", "type": "commit"}, {"oid": "01b7d7a55fbf8d72dbdccd5594721b11e96de2a4", "url": "https://github.com/elastic/elasticsearch/commit/01b7d7a55fbf8d72dbdccd5594721b11e96de2a4", "message": "Merge branch 'master' into itv2-add-prefer-param", "committedDate": "2020-04-17T17:46:51Z", "type": "commit"}, {"oid": "0fd7a8f456ba7aefcdfd5c42c6007ea8e887ebc2", "url": "https://github.com/elastic/elasticsearch/commit/0fd7a8f456ba7aefcdfd5c42c6007ea8e887ebc2", "message": "Adjust version for tests that use the prefer_v2_templates flag\n\n(will be adjusted back down later)", "committedDate": "2020-04-17T18:05:42Z", "type": "commit"}, {"oid": "02f9cf632926fe48fa011ad9256b833621815eee", "url": "https://github.com/elastic/elasticsearch/commit/02f9cf632926fe48fa011ad9256b833621815eee", "message": "Merge remote-tracking branch 'origin/master' into itv2-add-prefer-param", "committedDate": "2020-04-20T03:02:50Z", "type": "commit"}, {"oid": "40d2965aba45215bb7949670e93225ab6f5a68c0", "url": "https://github.com/elastic/elasticsearch/commit/40d2965aba45215bb7949670e93225ab6f5a68c0", "message": "Use setting in test that doesn't get overridden by global template", "committedDate": "2020-04-20T03:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwNjUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411206500", "bodyText": "Shall we annotate this with @nullable?", "author": "andreidan", "createdAt": "2020-04-20T08:52:29Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestCreateIndexAction.java", "diffHunk": "@@ -49,10 +50,15 @@ public String getName() {\n         return \"create_index_action\";\n     }\n \n+    public static Boolean preferV2Templates(final RestRequest request) {", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestCreateIndexAction.java b/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestCreateIndexAction.java\nindex a653f1e7492..1b7b3effb08 100644\n--- a/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestCreateIndexAction.java\n+++ b/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestCreateIndexAction.java\n\n@@ -50,6 +51,7 @@ public class RestCreateIndexAction extends BaseRestHandler {\n         return \"create_index_action\";\n     }\n \n+    @Nullable\n     public static Boolean preferV2Templates(final RestRequest request) {\n         return request.paramAsBoolean(IndexMetadata.PREFER_V2_TEMPLATES_FLAG, null);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwOTM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411209346", "bodyText": "Shall we annotate the param with @nullable?", "author": "andreidan", "createdAt": "2020-04-20T08:56:43Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/indices/CreateIndexRequest.java", "diffHunk": "@@ -265,6 +267,16 @@ public CreateIndexRequest aliases(Collection<Alias> aliases) {\n         return this;\n     }\n \n+    public CreateIndexRequest preferV2Templates(Boolean preferV2Templates) {", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwOTYyNA==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411209624", "bodyText": "@nullable", "author": "andreidan", "createdAt": "2020-04-20T08:57:04Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java", "diffHunk": "@@ -94,6 +95,11 @@ public CreateIndexClusterStateUpdateRequest copySettings(final boolean copySetti\n         return this;\n     }\n \n+    public CreateIndexClusterStateUpdateRequest preferV2Templates(Boolean preferV2Templates) {", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\nindex 65a05f32c9b..5a0af6a9753 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\n\n@@ -95,7 +96,7 @@ public class CreateIndexClusterStateUpdateRequest extends ClusterStateUpdateRequ\n         return this;\n     }\n \n-    public CreateIndexClusterStateUpdateRequest preferV2Templates(Boolean preferV2Templates) {\n+    public CreateIndexClusterStateUpdateRequest preferV2Templates(@Nullable Boolean preferV2Templates) {\n         this.preferV2Templates = preferV2Templates;\n         return this;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwOTcyMA==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411209720", "bodyText": "@nullable", "author": "andreidan", "createdAt": "2020-04-20T08:57:13Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java", "diffHunk": "@@ -145,6 +151,10 @@ public boolean copySettings() {\n         return copySettings;\n     }\n \n+    public Boolean preferV2Templates() {", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\nindex 65a05f32c9b..5a0af6a9753 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexClusterStateUpdateRequest.java\n\n@@ -151,6 +152,7 @@ public class CreateIndexClusterStateUpdateRequest extends ClusterStateUpdateRequ\n         return copySettings;\n     }\n \n+    @Nullable\n     public Boolean preferV2Templates() {\n         return preferV2Templates;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwOTg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411209873", "bodyText": "@nullable param and return value", "author": "andreidan", "createdAt": "2020-04-20T08:57:29Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java", "diffHunk": "@@ -158,6 +163,15 @@ public CreateIndexRequest index(String index) {\n         return this;\n     }\n \n+    public CreateIndexRequest preferV2Templates(Boolean preferV2Templates) {\n+        this.preferV2Templates = preferV2Templates;\n+        return this;\n+    }\n+\n+    public Boolean preferV2Templates() {\n+        return this.preferV2Templates;\n+    }\n+", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\nindex 80f667ae89e..60fc8d300ec 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/create/CreateIndexRequest.java\n\n@@ -163,11 +164,12 @@ public class CreateIndexRequest extends AcknowledgedRequest<CreateIndexRequest>\n         return this;\n     }\n \n-    public CreateIndexRequest preferV2Templates(Boolean preferV2Templates) {\n+    public CreateIndexRequest preferV2Templates(@Nullable Boolean preferV2Templates) {\n         this.preferV2Templates = preferV2Templates;\n         return this;\n     }\n \n+    @Nullable\n     public Boolean preferV2Templates() {\n         return this.preferV2Templates;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDE1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411210157", "bodyText": "@nullable param and return value", "author": "andreidan", "createdAt": "2020-04-20T08:57:59Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequest.java", "diffHunk": "@@ -196,6 +201,15 @@ public BulkRequest add(DeleteRequest request) {\n         return this.requests;\n     }\n \n+    public BulkRequest preferV2Templates(Boolean preferV2Templates) {\n+        this.preferV2Templates = preferV2Templates;\n+        return this;\n+    }\n+\n+    public Boolean preferV2Templates() {\n+        return this.preferV2Templates;\n+    }\n+", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/bulk/BulkRequest.java b/server/src/main/java/org/elasticsearch/action/bulk/BulkRequest.java\nindex 6fe813dc59b..9751aee59ba 100644\n--- a/server/src/main/java/org/elasticsearch/action/bulk/BulkRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/bulk/BulkRequest.java\n\n@@ -201,11 +201,12 @@ public class BulkRequest extends ActionRequest implements CompositeIndicesReques\n         return this.requests;\n     }\n \n-    public BulkRequest preferV2Templates(Boolean preferV2Templates) {\n+    public BulkRequest preferV2Templates(@Nullable Boolean preferV2Templates) {\n         this.preferV2Templates = preferV2Templates;\n         return this;\n     }\n \n+    @Nullable\n     public Boolean preferV2Templates() {\n         return this.preferV2Templates;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDUzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411210535", "bodyText": "@nullable param and return value", "author": "andreidan", "createdAt": "2020-04-20T08:58:34Z", "path": "server/src/main/java/org/elasticsearch/action/index/IndexRequest.java", "diffHunk": "@@ -561,6 +565,15 @@ public long ifSeqNo() {\n         return ifSeqNo;\n     }\n \n+    public IndexRequest preferV2Templates(Boolean preferV2Templates) {\n+        this.preferV2Templates = preferV2Templates;\n+        return this;\n+    }\n+\n+    public Boolean preferV2Templates() {\n+        return this.preferV2Templates;\n+    }\n+", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java b/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java\nindex c38d3b682d9..7ee41fe6a1d 100644\n--- a/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java\n\n@@ -565,11 +565,12 @@ public class IndexRequest extends ReplicatedWriteRequest<IndexRequest> implement\n         return ifSeqNo;\n     }\n \n-    public IndexRequest preferV2Templates(Boolean preferV2Templates) {\n+    public IndexRequest preferV2Templates(@Nullable Boolean preferV2Templates) {\n         this.preferV2Templates = preferV2Templates;\n         return this;\n     }\n \n+    @Nullable\n     public Boolean preferV2Templates() {\n         return this.preferV2Templates;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDg1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411210856", "bodyText": "@nullable param and return value", "author": "andreidan", "createdAt": "2020-04-20T08:58:58Z", "path": "server/src/main/java/org/elasticsearch/action/update/UpdateRequest.java", "diffHunk": "@@ -800,6 +804,15 @@ public UpdateRequest scriptedUpsert(boolean scriptedUpsert) {\n         return this;\n     }\n \n+    public Boolean preferV2Templates() {\n+        return this.preferV2Templates;\n+    }\n+\n+    public UpdateRequest preferV2Templates(Boolean preferV2Templates) {\n+        this.preferV2Templates = preferV2Templates;\n+        return this;\n+    }", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/update/UpdateRequest.java b/server/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\nindex 70aeeb45fab..804f6ff819a 100644\n--- a/server/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/update/UpdateRequest.java\n\n@@ -804,11 +804,12 @@ public class UpdateRequest extends InstanceShardOperationRequest<UpdateRequest>\n         return this;\n     }\n \n+    @Nullable\n     public Boolean preferV2Templates() {\n         return this.preferV2Templates;\n     }\n \n-    public UpdateRequest preferV2Templates(Boolean preferV2Templates) {\n+    public UpdateRequest preferV2Templates(@Nullable Boolean preferV2Templates) {\n         this.preferV2Templates = preferV2Templates;\n         return this;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMTQyNw==", "url": "https://github.com/elastic/elasticsearch/pull/55411#discussion_r411211427", "bodyText": "this is pretty cool, aides readability quite a lot", "author": "andreidan", "createdAt": "2020-04-20T08:59:42Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -345,6 +350,11 @@ public ClusterState applyCreateIndexRequest(ClusterState currentState, CreateInd\n         }\n     }\n \n+    private static boolean resolvePreferV2Templates(CreateIndexClusterStateUpdateRequest request) {", "originalCommit": "40d2965aba45215bb7949670e93225ab6f5a68c0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "url": "https://github.com/elastic/elasticsearch/commit/944c50d98d6cdbd6a3f18cddda7dd1ee7d005bc5", "message": "Add @Nullable everywhere", "committedDate": "2020-04-20T14:47:53Z", "type": "commit"}, {"oid": "9e346adeac4e078c76aa5f523f3e6716a7290375", "url": "https://github.com/elastic/elasticsearch/commit/9e346adeac4e078c76aa5f523f3e6716a7290375", "message": "Merge branch 'master' into itv2-add-prefer-param", "committedDate": "2020-04-20T15:10:46Z", "type": "commit"}]}