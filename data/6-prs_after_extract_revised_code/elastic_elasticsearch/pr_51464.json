{"pr_number": 51464, "pr_title": "Use Consistent ClusterState throughout Snapshot API Calls", "pr_createdAt": "2020-01-26T21:38:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51464", "timeline": [{"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2", "url": "https://github.com/elastic/elasticsearch/commit/a691424cc4fc1657eb0438a13a540ae4381f5bb2", "message": "Use Consistent ClusterState throughout Snapshot API Calls\n\nWe shouldn't be using potentially changing versions of the cluster state\nwhen answering a snapshot status API call. Having these API behave more\ndeterministically will make it easier to use them once parallel repository operations\nare introduced.", "committedDate": "2020-01-26T21:34:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzMTM0OA==", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371031348", "bodyText": "Making the fact that we're using a potentially racy CS here, leading to some needless snapshot delete failures, obvious was the main motivation behind this change actually (a bigger change to deletes making use of this cleanup is coming in #51463).", "author": "original-brownbear", "createdAt": "2020-01-26T21:39:47Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1222,7 +1226,8 @@ public void deleteSnapshot(final String repositoryName, final String snapshotNam\n             // if nothing found by the same name, then look in the cluster state for current in progress snapshots\n             long repoGenId = repositoryData.getGenId();\n             if (matchedEntry.isPresent() == false) {\n-                Optional<SnapshotsInProgress.Entry> matchedInProgress = currentSnapshots(repositoryName, Collections.emptyList()).stream()\n+                Optional<SnapshotsInProgress.Entry> matchedInProgress = currentSnapshots(", "originalCommit": "a691424cc4fc1657eb0438a13a540ae4381f5bb2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f2efe16f149c787e75fae3fe80042c5c303ee63d", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\nindex ebc25b352697..a9f32caa9e66 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\n\n@@ -1227,7 +1229,7 @@ public class SnapshotsService extends AbstractLifecycleComponent implements Clus\n             long repoGenId = repositoryData.getGenId();\n             if (matchedEntry.isPresent() == false) {\n                 Optional<SnapshotsInProgress.Entry> matchedInProgress = currentSnapshots(\n-                    clusterService.state(), repositoryName, Collections.emptyList()).stream()\n+                    clusterService.state().custom(SnapshotsInProgress.TYPE), repositoryName, Collections.emptyList()).stream()\n                     .filter(s -> s.snapshot().getSnapshotId().getName().equals(snapshotName)).findFirst();\n                 if (matchedInProgress.isPresent()) {\n                     matchedEntry = matchedInProgress.map(s -> s.snapshot().getSnapshotId());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwNTk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371105955", "bodyText": "Should we just pass down SnapshotsInProgress? Makes it a bit clearer what the dependencies are", "author": "ywelsch", "createdAt": "2020-01-27T08:19:56Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java", "diffHunk": "@@ -103,14 +103,14 @@ protected void masterOperation(Task task, final GetSnapshotsRequest request, fin\n                                 response ->\n                                         // switch to GENERIC thread pool because it might be long running operation\n                                         threadPool.executor(ThreadPool.Names.GENERIC).execute(\n-                                                () -> getMultipleReposSnapshotInfo(response.repositories(), request.snapshots(),\n+                                                () -> getMultipleReposSnapshotInfo(state, response.repositories(), request.snapshots(),\n                                                         request.ignoreUnavailable(), request.verbose(), listener)),\n                                 listener::onFailure),\n                         GetRepositoriesResponse::new));\n     }\n \n-    private void getMultipleReposSnapshotInfo(List<RepositoryMetaData> repos, String[] snapshots, boolean ignoreUnavailable,\n-                                              boolean verbose, ActionListener<GetSnapshotsResponse> listener) {\n+    private void getMultipleReposSnapshotInfo(ClusterState state, List<RepositoryMetaData> repos, String[] snapshots,", "originalCommit": "a691424cc4fc1657eb0438a13a540ae4381f5bb2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTExOTU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371119549", "bodyText": "Sure sounds good :) => f2efe16", "author": "original-brownbear", "createdAt": "2020-01-27T08:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwNTk1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2efe16f149c787e75fae3fe80042c5c303ee63d", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\nindex f54a522e41e6..67af3f70fe1d 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\n\n@@ -96,6 +97,7 @@ public class TransportGetSnapshotsAction extends TransportMasterNodeAction<GetSn\n     protected void masterOperation(Task task, final GetSnapshotsRequest request, final ClusterState state,\n                                    final ActionListener<GetSnapshotsResponse> listener) {\n         final String[] repositories = request.repositories();\n+        final SnapshotsInProgress snapshotsInProgress = state.custom(SnapshotsInProgress.TYPE);\n         transportService.sendChildRequest(transportService.getLocalNode(), GetRepositoriesAction.NAME,\n                 new GetRepositoriesRequest(repositories), task, TransportRequestOptions.EMPTY,\n                 new ActionListenerResponseHandler<>(\n"}}, {"oid": "08dfd9bf297aed0412e3ac1960ce12450f5bc877", "url": "https://github.com/elastic/elasticsearch/commit/08dfd9bf297aed0412e3ac1960ce12450f5bc877", "message": "Merge remote-tracking branch 'elastic/master' into consistent-cs-for-snapshot-status-apis", "committedDate": "2020-01-27T08:37:58Z", "type": "commit"}, {"oid": "f2efe16f149c787e75fae3fe80042c5c303ee63d", "url": "https://github.com/elastic/elasticsearch/commit/f2efe16f149c787e75fae3fe80042c5c303ee63d", "message": "CR: pass around SnapshotsInProgress", "committedDate": "2020-01-27T08:55:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzQ2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371143469", "bodyText": "Can you add @Nullable to the methods that pass SnapshotsInProgress, or alternatively, pass an empty instance?", "author": "ywelsch", "createdAt": "2020-01-27T09:49:49Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java", "diffHunk": "@@ -133,16 +135,16 @@ private void getMultipleReposSnapshotInfo(List<RepositoryMetaData> repos, String\n                     } else {\n                         groupedListener.onFailure(e);\n                     }\n-                }), wrappedListener -> getSingleRepoSnapshotInfo(repoName, snapshots, ignoreUnavailable, verbose,\n+                }), wrappedListener -> getSingleRepoSnapshotInfo(snapshotsInProgress, repoName, snapshots, ignoreUnavailable, verbose,\n                     ActionListener.map(wrappedListener, snInfos -> GetSnapshotsResponse.Response.snapshots(repoName, snInfos)))));\n         }\n     }\n \n-    private void getSingleRepoSnapshotInfo(String repo, String[] snapshots, boolean ignoreUnavailable, boolean verbose,\n-                                           ActionListener<List<SnapshotInfo>> listener) {\n+    private void getSingleRepoSnapshotInfo(SnapshotsInProgress snapshotsInProgress, String repo, String[] snapshots,", "originalCommit": "f2efe16f149c787e75fae3fe80042c5c303ee63d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0OTYzMA==", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371149630", "bodyText": "Sure added the @Nullables in 2bfe8f5 :)", "author": "original-brownbear", "createdAt": "2020-01-27T10:02:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzQ2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2bfe8f57015164474082adbe8b00d912a65354a7", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\nindex 67af3f70fe1d..09508ace3000 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java\n\n@@ -140,7 +141,7 @@ public class TransportGetSnapshotsAction extends TransportMasterNodeAction<GetSn\n         }\n     }\n \n-    private void getSingleRepoSnapshotInfo(SnapshotsInProgress snapshotsInProgress, String repo, String[] snapshots,\n+    private void getSingleRepoSnapshotInfo(@Nullable SnapshotsInProgress snapshotsInProgress, String repo, String[] snapshots,\n                                            boolean ignoreUnavailable, boolean verbose, ActionListener<List<SnapshotInfo>> listener) {\n         final Map<String, SnapshotId> allSnapshotIds = new HashMap<>();\n         final List<SnapshotInfo> currentSnapshots = new ArrayList<>();\n"}}, {"oid": "bb2ded549f018ef8fa324a17b95063085f2f34ba", "url": "https://github.com/elastic/elasticsearch/commit/bb2ded549f018ef8fa324a17b95063085f2f34ba", "message": "Merge remote-tracking branch 'elastic/master' into consistent-cs-for-snapshot-status-apis", "committedDate": "2020-01-27T09:51:01Z", "type": "commit"}, {"oid": "2bfe8f57015164474082adbe8b00d912a65354a7", "url": "https://github.com/elastic/elasticsearch/commit/2bfe8f57015164474082adbe8b00d912a65354a7", "message": "CR: nullables", "committedDate": "2020-01-27T10:02:14Z", "type": "commit"}]}