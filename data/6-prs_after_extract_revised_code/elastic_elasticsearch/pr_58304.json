{"pr_number": 58304, "pr_title": "Validate compatible handlers have correct version", "pr_createdAt": "2020-06-18T08:21:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58304", "timeline": [{"oid": "678a7d4f8700e8afbe81cd6aa03f40d11aea8f39", "url": "https://github.com/elastic/elasticsearch/commit/678a7d4f8700e8afbe81cd6aa03f40d11aea8f39", "message": "Validate compatible handlers have correct version\n\nValidating if registered compatible rest handlers are overriding\ncompatibleWith method and specify the right compatible version", "committedDate": "2020-06-18T08:17:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM1MjY3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58304#discussion_r444352675", "bodyText": "+1 to adding validation... I would have a minor preference to have a static validateCompatibleHandlers(Collection handlers) that is located in a more central location and that assumes Version.CURRENT.major - 1 to help make this more generic.\nAlso, I think normal IllegalStateException or the like may be preferable to the assert here.", "author": "jakelandis", "createdAt": "2020-06-23T16:26:51Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/RestCompatPlugin.java", "diffHunk": "@@ -51,7 +51,7 @@\n         Supplier<DiscoveryNodes> nodesInCluster\n     ) {\n         if (Version.CURRENT.major == 8) {\n-            return List.of(\n+            return validatedList(7,", "originalCommit": "678a7d4f8700e8afbe81cd6aa03f40d11aea8f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0MTgwNw==", "url": "https://github.com/elastic/elasticsearch/pull/58304#discussion_r446941807", "bodyText": "agree - IllegalStateException fits better here.\nAlso agree that this could be moved to some more generic place once we have more compat rest handlers in other modules. For the time being I would prefer to keep this in that class (as I don't know the right place since there are no more compat handlers in other modules yet)", "author": "pgomulka", "createdAt": "2020-06-29T12:44:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM1MjY3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "12bf7d6662c30511e2f54ca8e3b520ea7376e267", "chunk": "diff --git a/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/RestCompatPlugin.java b/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/RestCompatPlugin.java\nindex 319918b75af..9b3d31e796c 100644\n--- a/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/RestCompatPlugin.java\n+++ b/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/RestCompatPlugin.java\n\n@@ -51,7 +51,7 @@ public class RestCompatPlugin extends Plugin implements ActionPlugin {\n         Supplier<DiscoveryNodes> nodesInCluster\n     ) {\n         if (Version.CURRENT.major == 8) {\n-            return validatedList(7,\n+            return validateCompatibleHandlers(7,\n                 new RestGetActionV7(),\n                 new RestIndexActionV7.CompatibleRestIndexAction(),\n                 new RestIndexActionV7.CompatibleCreateHandler(),\n"}}, {"oid": "12bf7d6662c30511e2f54ca8e3b520ea7376e267", "url": "https://github.com/elastic/elasticsearch/commit/12bf7d6662c30511e2f54ca8e3b520ea7376e267", "message": "throw exception", "committedDate": "2020-06-29T12:49:03Z", "type": "commit"}, {"oid": "0f1d9778c8bd876b0a5f7d114fd6c2783ab0c343", "url": "https://github.com/elastic/elasticsearch/commit/0f1d9778c8bd876b0a5f7d114fd6c2783ab0c343", "message": "format syntax", "committedDate": "2020-06-29T13:26:11Z", "type": "commit"}, {"oid": "22dcca73872abef4e5df630aed005f42ec5376ce", "url": "https://github.com/elastic/elasticsearch/commit/22dcca73872abef4e5df630aed005f42ec5376ce", "message": "Merge branch 'compat_rest_api' into compat/validate_handler_version", "committedDate": "2020-07-14T06:40:59Z", "type": "commit"}, {"oid": "7eacb5d7435738754cfff679557f2547518d77e2", "url": "https://github.com/elastic/elasticsearch/commit/7eacb5d7435738754cfff679557f2547518d77e2", "message": "Merge branch 'compat_rest_api' into compat/validate_handler_version", "committedDate": "2020-07-14T06:45:14Z", "type": "commit"}, {"oid": "3c45803db50ce8fb004d6b4c016c843f096bc478", "url": "https://github.com/elastic/elasticsearch/commit/3c45803db50ce8fb004d6b4c016c843f096bc478", "message": "checkstyle and package", "committedDate": "2020-07-14T07:42:22Z", "type": "commit"}, {"oid": "2fa220a30f1bee368f46d017ce80d6ddb7a40dad", "url": "https://github.com/elastic/elasticsearch/commit/2fa220a30f1bee368f46d017ce80d6ddb7a40dad", "message": "Merge branch 'compat_rest_api' into compat/validate_handler_version", "committedDate": "2020-07-14T08:09:58Z", "type": "commit"}]}