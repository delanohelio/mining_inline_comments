{"pr_number": 64235, "pr_title": "Fix error reporting for SSL resources outside of config dir", "pr_createdAt": "2020-10-27T16:48:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64235", "timeline": [{"oid": "d40c2b66dfbf367896182c1db79a5e0953a1e6ea", "url": "https://github.com/elastic/elasticsearch/commit/d40c2b66dfbf367896182c1db79a5e0953a1e6ea", "message": "Fix error reporting for SSL resources outside of config dir", "committedDate": "2020-10-27T16:31:51Z", "type": "commit"}, {"oid": "3da77187d5ce22f83241f3f3dcc7cf3a30abfa7d", "url": "https://github.com/elastic/elasticsearch/commit/3da77187d5ce22f83241f3f3dcc7cf3a30abfa7d", "message": "Revert \"Fix error reporting for SSL resources outside of config dir\"\n\nThis reverts commit d40c2b66dfbf367896182c1db79a5e0953a1e6ea.", "committedDate": "2020-10-29T00:11:45Z", "type": "commit"}, {"oid": "b56b36c59b82846ddea98af94ac5da6a8146ee22", "url": "https://github.com/elastic/elasticsearch/commit/b56b36c59b82846ddea98af94ac5da6a8146ee22", "message": "moving creation of ssl service before ssl resource watcher", "committedDate": "2020-10-29T00:16:40Z", "type": "commit"}, {"oid": "433ceb3c0db6f76546b4bf5f5cb70c3679f75a4b", "url": "https://github.com/elastic/elasticsearch/commit/433ceb3c0db6f76546b4bf5f5cb70c3679f75a4b", "message": "ensure ssl configuration files are readable", "committedDate": "2020-11-04T16:36:16Z", "type": "commit"}, {"oid": "b22c6b179e5bd55db326ddd6348ea461d4c6dc76", "url": "https://github.com/elastic/elasticsearch/commit/b22c6b179e5bd55db326ddd6348ea461d4c6dc76", "message": "Merge branch 'master' into error-reporting-for-SSL", "committedDate": "2021-05-14T04:57:12Z", "type": "commit"}, {"oid": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "url": "https://github.com/elastic/elasticsearch/commit/7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "message": "Report exceptions rather than throw them", "committedDate": "2021-05-14T06:28:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5MDU1NA==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r633190554", "bodyText": "This sentence is not finished.", "author": "ywangd", "createdAt": "2021-05-17T02:46:31Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java", "diffHunk": "@@ -503,6 +506,27 @@ public void testPEMTrustReloadException() throws Exception {\n         assertThat(sslService.sslContextHolder(config).sslContext(), sameInstance(context));\n     }\n \n+    /**\n+     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the", "originalCommit": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9c5f9dc943a1f888f80994686053debb8e1fdf76", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\nindex fd90c45652e..4431565c191 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n\n@@ -507,10 +507,11 @@ public class SSLConfigurationReloaderTests extends ESTestCase {\n     }\n \n     /**\n-     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n-     * These errors are handled correctly by the\n+     * Tests that the reloader doesn't throw an exception if a file is unreadable or configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the relevant {@link KeyConfig} and {@link TrustConfig} classes, so the reloader should\n+     * simply log and continue.\n      */\n-    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+    public void testFailureToReadFileDoesntFail() throws Exception {\n         Path tempDir = createTempDir();\n         Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n         Settings settings = baseKeystoreSettings(tempDir, null)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5NDM0OA==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r633194348", "bodyText": "I don't think it's really necessary, but corresponding error messages during SSL Context building are finer grained, e.g. different error messages are logged for different subtypes of IOException, security permission failure is explicitly called out.", "author": "ywangd", "createdAt": "2021-05-17T03:02:41Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloader.java", "diffHunk": "@@ -94,16 +96,16 @@ private static void startWatching(Environment environment, Consumer<SSLConfigura\n             }\n         }\n \n-        for (Entry<Path, List<SSLConfiguration>> entry : pathToConfigurationsMap.entrySet()) {\n-            ChangeListener changeListener = new ChangeListener(environment, List.copyOf(entry.getValue()), reloadConsumer);\n-            FileWatcher fileWatcher = new FileWatcher(entry.getKey());\n+        pathToConfigurationsMap.forEach((path, configurations) -> {\n+            ChangeListener changeListener = new ChangeListener(environment, List.copyOf(configurations), reloadConsumer);\n+            FileWatcher fileWatcher = new FileWatcher(path);\n             fileWatcher.addListener(changeListener);\n             try {\n                 resourceWatcherService.add(fileWatcher, Frequency.HIGH);\n-            } catch (IOException e) {\n-                logger.error(\"failed to start watching directory [{}] for ssl configurations [{}]\", entry.getKey(), sslConfigurations);\n+            } catch (IOException | AccessControlException e) {\n+                logger.error(\"failed to start watching directory [{}] for ssl configurations [{}] - {}\", path, configurations, e);", "originalCommit": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTM3NTYzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r645375632", "bodyText": "Yes, and those messages will still be printed.\nThe net effect of this PR is to catch+log the exception and then get out the way so that the more fine grained error handling can do its job.", "author": "tvernum", "createdAt": "2021-06-04T08:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5NDM0OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5NDk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r633194943", "bodyText": "Nit: isn't this redundant since the above constructor would have failed already if the object does not get created?", "author": "ywangd", "createdAt": "2021-05-17T03:05:23Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java", "diffHunk": "@@ -503,6 +506,27 @@ public void testPEMTrustReloadException() throws Exception {\n         assertThat(sslService.sslContextHolder(config).sslContext(), sameInstance(context));\n     }\n \n+    /**\n+     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the\n+     */\n+    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+        Path tempDir = createTempDir();\n+        Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n+        Settings settings = baseKeystoreSettings(tempDir, null)\n+            .putList(\"xpack.security.transport.ssl.certificate_authorities\", clientCertPath.toString())\n+            .put(\"path.home\", createTempDir())\n+            .build();\n+        Environment env = TestEnvironment.newEnvironment(settings);\n+        final AtomicReference<Exception> exceptionRef = new AtomicReference<>();\n+\n+        final ResourceWatcherService mockResourceWatcher = Mockito.mock(ResourceWatcherService.class);\n+        Mockito.when(mockResourceWatcher.add(Mockito.any(), Mockito.any())).thenThrow(new AccessControlException(\"access denied in test\"));\n+        final Collection<SSLConfiguration> configurations = SSLService.getSSLConfigurations(settings).values();\n+        final SSLConfigurationReloader reloader = new SSLConfigurationReloader(env, null, mockResourceWatcher, configurations);\n+        assertNotNull(reloader);", "originalCommit": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9c5f9dc943a1f888f80994686053debb8e1fdf76", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\nindex fd90c45652e..4431565c191 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n\n@@ -507,10 +507,11 @@ public class SSLConfigurationReloaderTests extends ESTestCase {\n     }\n \n     /**\n-     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n-     * These errors are handled correctly by the\n+     * Tests that the reloader doesn't throw an exception if a file is unreadable or configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the relevant {@link KeyConfig} and {@link TrustConfig} classes, so the reloader should\n+     * simply log and continue.\n      */\n-    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+    public void testFailureToReadFileDoesntFail() throws Exception {\n         Path tempDir = createTempDir();\n         Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n         Settings settings = baseKeystoreSettings(tempDir, null)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5NTM4NA==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r633195384", "bodyText": "I think these are no longer needed given the new change of reporting error instead of throwing.", "author": "ywangd", "createdAt": "2021-05-17T03:07:46Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java", "diffHunk": "@@ -503,6 +506,27 @@ public void testPEMTrustReloadException() throws Exception {\n         assertThat(sslService.sslContextHolder(config).sslContext(), sameInstance(context));\n     }\n \n+    /**\n+     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the\n+     */\n+    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+        Path tempDir = createTempDir();\n+        Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n+        Settings settings = baseKeystoreSettings(tempDir, null)\n+            .putList(\"xpack.security.transport.ssl.certificate_authorities\", clientCertPath.toString())\n+            .put(\"path.home\", createTempDir())\n+            .build();\n+        Environment env = TestEnvironment.newEnvironment(settings);\n+        final AtomicReference<Exception> exceptionRef = new AtomicReference<>();", "originalCommit": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9c5f9dc943a1f888f80994686053debb8e1fdf76", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\nindex fd90c45652e..4431565c191 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n\n@@ -507,10 +507,11 @@ public class SSLConfigurationReloaderTests extends ESTestCase {\n     }\n \n     /**\n-     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n-     * These errors are handled correctly by the\n+     * Tests that the reloader doesn't throw an exception if a file is unreadable or configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the relevant {@link KeyConfig} and {@link TrustConfig} classes, so the reloader should\n+     * simply log and continue.\n      */\n-    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+    public void testFailureToReadFileDoesntFail() throws Exception {\n         Path tempDir = createTempDir();\n         Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n         Settings settings = baseKeystoreSettings(tempDir, null)\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzE5NTkyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64235#discussion_r633195923", "bodyText": "Based on the exceptions that get caught in startWatching, do we need another method for testing IOException? I suggest we modify this method to be more generic to cover both scenarios and randomize the exception.", "author": "ywangd", "createdAt": "2021-05-17T03:10:10Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java", "diffHunk": "@@ -503,6 +506,27 @@ public void testPEMTrustReloadException() throws Exception {\n         assertThat(sslService.sslContextHolder(config).sslContext(), sameInstance(context));\n     }\n \n+    /**\n+     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the\n+     */\n+    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {", "originalCommit": "7f133580267cb0ddfdc97641da93d1f4e5e2c18c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9c5f9dc943a1f888f80994686053debb8e1fdf76", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\nindex fd90c45652e..4431565c191 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ssl/SSLConfigurationReloaderTests.java\n\n@@ -507,10 +507,11 @@ public class SSLConfigurationReloaderTests extends ESTestCase {\n     }\n \n     /**\n-     * Tests that the reloader doesn't throw an exception if a file is configured to be outside of the config/ directory.\n-     * These errors are handled correctly by the\n+     * Tests that the reloader doesn't throw an exception if a file is unreadable or configured to be outside of the config/ directory.\n+     * These errors are handled correctly by the relevant {@link KeyConfig} and {@link TrustConfig} classes, so the reloader should\n+     * simply log and continue.\n      */\n-    public void testReadingOutsideConfigDirectoryDoesntFail() throws Exception {\n+    public void testFailureToReadFileDoesntFail() throws Exception {\n         Path tempDir = createTempDir();\n         Path clientCertPath = tempDir.resolve(\"testclient.crt\");\n         Settings settings = baseKeystoreSettings(tempDir, null)\n"}}, {"oid": "650a41502f4c48dc0a2653a7fee2fd5cfb07db4a", "url": "https://github.com/elastic/elasticsearch/commit/650a41502f4c48dc0a2653a7fee2fd5cfb07db4a", "message": "Merge branch 'master' into error-reporting-for-SSL", "committedDate": "2021-06-04T08:03:28Z", "type": "commit"}, {"oid": "9c5f9dc943a1f888f80994686053debb8e1fdf76", "url": "https://github.com/elastic/elasticsearch/commit/9c5f9dc943a1f888f80994686053debb8e1fdf76", "message": "Address feedback in tests", "committedDate": "2021-06-04T08:12:59Z", "type": "commit"}]}