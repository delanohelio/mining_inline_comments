{"pr_number": 66066, "pr_title": "Remove parent-task bans on channels disconnect", "pr_createdAt": "2020-12-08T21:22:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66066", "timeline": [{"oid": "0980d128567fb5224259e6c08fed9a6f55b17baa", "url": "https://github.com/elastic/elasticsearch/commit/0980d128567fb5224259e6c08fed9a6f55b17baa", "message": "Remove parent-task bans on channels disconnect", "committedDate": "2020-12-08T21:21:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5MTI4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539291283", "bodyText": "I've been meaning to fix that typo for ages, thanks :)\nMissed one:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // computing the hash code of the parent taskId as most of the time banedParents is empty.\n          \n          \n            \n                    // computing the hash code of the parent taskId as most of the time bannedParents is empty.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:07:48Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -196,12 +202,12 @@ private void registerCancellableTask(Task task) {\n         assert oldHolder == null;\n         // Check if this task was banned before we start it. The empty check is used to avoid\n         // computing the hash code of the parent taskId as most of the time banedParents is empty.", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzOTU0NA==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539439544", "bodyText": "\ud83d\udc4d", "author": "dnhatn", "createdAt": "2020-12-09T16:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5MTI4Mw=="}], "type": "inlineReview", "revised_code": {"commit": "99bcff478f6215c9b8135311f3b092530eb9dd5a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..f1d8bee77d8 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -201,7 +201,7 @@ public class TaskManager implements ClusterStateApplier {\n         CancellableTaskHolder oldHolder = cancellableTasks.put(task.getId(), holder);\n         assert oldHolder == null;\n         // Check if this task was banned before we start it. The empty check is used to avoid\n-        // computing the hash code of the parent taskId as most of the time banedParents is empty.\n+        // computing the hash code of the parent taskId as most of the time bannedParents is empty.\n         if (task.getParentTaskId().isSet() && bannedParents.isEmpty() == false) {\n             final Ban ban = bannedParents.get(task.getParentTaskId());\n             if (ban != null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwMDU3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539300573", "bodyText": "Can we receive a ban for the same task on a different channel after checking that registeredChannels() == 0 but before removing the ban from the iterator (i.e. just before this line executes)? If so, that ban would be lost from bannedParents here.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:21:52Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -692,6 +753,18 @@ protected void doRun() {\n                 }\n             });\n         }\n+\n+        // Unregister the closing channel and remove bans whose has no registered channels\n+        final Iterator<Map.Entry<TaskId, Ban>> iterator = bannedParents.entrySet().iterator();\n+        while (iterator.hasNext()) {\n+            final Map.Entry<TaskId, Ban> entry = iterator.next();\n+            final Ban ban = entry.getValue();\n+            if (ban.perChannel) {\n+                if (ban.unregisterChannel(channel) && entry.getValue().registeredChannels() == 0) {\n+                    iterator.remove();", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzOTA0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539439042", "bodyText": "This can happen. I've tightened the synchronization in 76950a6.", "author": "dnhatn", "createdAt": "2020-12-09T16:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwMDU3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "76950a6c2acd98a70ced9f54bb0a867f3c80d6f8", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..5d1faca7345 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -755,13 +761,15 @@ public class TaskManager implements ClusterStateApplier {\n         }\n \n         // Unregister the closing channel and remove bans whose has no registered channels\n-        final Iterator<Map.Entry<TaskId, Ban>> iterator = bannedParents.entrySet().iterator();\n-        while (iterator.hasNext()) {\n-            final Map.Entry<TaskId, Ban> entry = iterator.next();\n-            final Ban ban = entry.getValue();\n-            if (ban.perChannel) {\n-                if (ban.unregisterChannel(channel) && entry.getValue().registeredChannels() == 0) {\n-                    iterator.remove();\n+        synchronized (bannedParents) {\n+            final Iterator<Map.Entry<TaskId, Ban>> iterator = bannedParents.entrySet().iterator();\n+            while (iterator.hasNext()) {\n+                final Map.Entry<TaskId, Ban> entry = iterator.next();\n+                final Ban ban = entry.getValue();\n+                if (ban.perChannel) {\n+                    if (ban.unregisterChannel(channel) && entry.getValue().registeredChannels() == 0) {\n+                        iterator.remove();\n+                    }\n                 }\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwODAxNA==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539308014", "bodyText": "Can we assert that it's a DirectResponseChannel? Other channels do exist (in tests) so let's be strict about which ones work with this mechanism.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:32:11Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -390,14 +396,27 @@ public int getBanCount() {\n      * This method is called when a parent task that has children is cancelled.\n      * @return a list of pending cancellable child tasks\n      */\n-    public List<CancellableTask> setBan(TaskId parentTaskId, String reason) {\n+    public List<CancellableTask> setBan(TaskId parentTaskId, String reason, TransportChannel channel) {\n         logger.trace(\"setting ban for the parent task {} {}\", parentTaskId, reason);\n-\n-        // Set the ban first, so the newly created tasks cannot be registered\n-        synchronized (banedParents) {\n-            if (lastDiscoveryNodes.nodeExists(parentTaskId.getNodeId())) {\n-                // Only set the ban if the node is the part of the cluster\n-                banedParents.put(parentTaskId, reason);\n+        if (channel.getVersion().onOrAfter(Version.V_8_0_0)) {\n+            final Ban ban = bannedParents.computeIfAbsent(parentTaskId, k -> new Ban(reason, true));\n+            assert ban.perChannel : \"not a ban per channel\";\n+            while (channel instanceof TaskTransportChannel) {\n+                channel = ((TaskTransportChannel) channel).getChannel();\n+            }\n+            if (channel instanceof TcpTransportChannel) {\n+                startTrackingChannel(((TcpTransportChannel) channel).getChannel(), ban::registerChannel);\n+            } else {\n+                // Local channel, register with a dummy tracker", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzODUwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539438505", "bodyText": "Good point, adjusted in 0f9fbee", "author": "dnhatn", "createdAt": "2020-12-09T16:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwODAxNA=="}], "type": "inlineReview", "revised_code": {"commit": "0f9fbeeb0e252cd0faef6428feb4f2892c8c225a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..dee6e53d161 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -407,8 +407,8 @@ public class TaskManager implements ClusterStateApplier {\n             if (channel instanceof TcpTransportChannel) {\n                 startTrackingChannel(((TcpTransportChannel) channel).getChannel(), ban::registerChannel);\n             } else {\n-                // Local channel, register with a dummy tracker\n-                ban.registerChannel(new ChannelPendingTaskTracker());\n+                assert channel.getChannelType().equals(\"direct\") : \"expect direct channel; got [\" + channel + \"]\";\n+                ban.registerChannel(DIRECT_CHANNEL_TRACKER);\n             }\n         } else {\n             synchronized (bannedParents) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwOTIyMw==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539309223", "bodyText": "Rather than making a new ChannelPendingTaskTracker for every banned local task, can we use the same instance each time? Also local channels can't be closed so there's no point in tracking their tasks at all: once we receive a ban on a local channel we know that it will definitely be explicitly removed, even if we also somehow receive the same ban on a remote channel too.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:34:00Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -390,14 +396,27 @@ public int getBanCount() {\n      * This method is called when a parent task that has children is cancelled.\n      * @return a list of pending cancellable child tasks\n      */\n-    public List<CancellableTask> setBan(TaskId parentTaskId, String reason) {\n+    public List<CancellableTask> setBan(TaskId parentTaskId, String reason, TransportChannel channel) {\n         logger.trace(\"setting ban for the parent task {} {}\", parentTaskId, reason);\n-\n-        // Set the ban first, so the newly created tasks cannot be registered\n-        synchronized (banedParents) {\n-            if (lastDiscoveryNodes.nodeExists(parentTaskId.getNodeId())) {\n-                // Only set the ban if the node is the part of the cluster\n-                banedParents.put(parentTaskId, reason);\n+        if (channel.getVersion().onOrAfter(Version.V_8_0_0)) {\n+            final Ban ban = bannedParents.computeIfAbsent(parentTaskId, k -> new Ban(reason, true));\n+            assert ban.perChannel : \"not a ban per channel\";\n+            while (channel instanceof TaskTransportChannel) {\n+                channel = ((TaskTransportChannel) channel).getChannel();\n+            }\n+            if (channel instanceof TcpTransportChannel) {\n+                startTrackingChannel(((TcpTransportChannel) channel).getChannel(), ban::registerChannel);\n+            } else {\n+                // Local channel, register with a dummy tracker\n+                ban.registerChannel(new ChannelPendingTaskTracker());", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQzOTIxMg==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539439212", "bodyText": "see 0f9fbee", "author": "dnhatn", "createdAt": "2020-12-09T16:10:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwOTIyMw=="}], "type": "inlineReview", "revised_code": {"commit": "0f9fbeeb0e252cd0faef6428feb4f2892c8c225a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..dee6e53d161 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -407,8 +407,8 @@ public class TaskManager implements ClusterStateApplier {\n             if (channel instanceof TcpTransportChannel) {\n                 startTrackingChannel(((TcpTransportChannel) channel).getChannel(), ban::registerChannel);\n             } else {\n-                // Local channel, register with a dummy tracker\n-                ban.registerChannel(new ChannelPendingTaskTracker());\n+                assert channel.getChannelType().equals(\"direct\") : \"expect direct channel; got [\" + channel + \"]\";\n+                ban.registerChannel(DIRECT_CHANNEL_TRACKER);\n             }\n         } else {\n             synchronized (bannedParents) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMjQ4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539322487", "bodyText": "The mismatch between tracking the Transport.Connection on the parent node and the individual TcpChannel on this node is tricksy. It's all fine I think, neither can remain open forever if the other one closes, I'm just noting for posterity that this isn't obvious and took a bit of thought.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:51:58Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -413,12 +432,48 @@ public int getBanCount() {\n      */\n     public void removeBan(TaskId parentTaskId) {\n         logger.trace(\"removing ban for the parent task {}\", parentTaskId);\n-        banedParents.remove(parentTaskId);\n+        bannedParents.remove(parentTaskId);\n     }\n \n     // for testing\n     public Set<TaskId> getBannedTaskIds() {\n-        return Collections.unmodifiableSet(banedParents.keySet());\n+        return Collections.unmodifiableSet(bannedParents.keySet());\n+    }\n+\n+    private static class Ban {\n+        final String reason;\n+        final boolean perChannel; // TODO: Remove this in 8.0\n+        final Set<ChannelPendingTaskTracker> channels;", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76950a6c2acd98a70ced9f54bb0a867f3c80d6f8", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..5d1faca7345 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -440,12 +440,13 @@ public class TaskManager implements ClusterStateApplier {\n         return Collections.unmodifiableSet(bannedParents.keySet());\n     }\n \n-    private static class Ban {\n+    private class Ban {\n         final String reason;\n         final boolean perChannel; // TODO: Remove this in 8.0\n         final Set<ChannelPendingTaskTracker> channels;\n \n         Ban(String reason, boolean perChannel) {\n+            assert Thread.holdsLock(bannedParents);\n             this.reason = reason;\n             this.perChannel = perChannel;\n             if (perChannel) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzIzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r539323239", "bodyText": "Can be void, I think, we don't check the return value.", "author": "DaveCTurner", "createdAt": "2020-12-09T13:52:58Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -413,12 +432,48 @@ public int getBanCount() {\n      */\n     public void removeBan(TaskId parentTaskId) {\n         logger.trace(\"removing ban for the parent task {}\", parentTaskId);\n-        banedParents.remove(parentTaskId);\n+        bannedParents.remove(parentTaskId);\n     }\n \n     // for testing\n     public Set<TaskId> getBannedTaskIds() {\n-        return Collections.unmodifiableSet(banedParents.keySet());\n+        return Collections.unmodifiableSet(bannedParents.keySet());\n+    }\n+\n+    private static class Ban {\n+        final String reason;\n+        final boolean perChannel; // TODO: Remove this in 8.0\n+        final Set<ChannelPendingTaskTracker> channels;\n+\n+        Ban(String reason, boolean perChannel) {\n+            this.reason = reason;\n+            this.perChannel = perChannel;\n+            if (perChannel) {\n+                this.channels = new HashSet<>();\n+            } else {\n+                this.channels = Set.of();\n+            }\n+        }\n+\n+        synchronized boolean registerChannel(ChannelPendingTaskTracker channel) {", "originalCommit": "0980d128567fb5224259e6c08fed9a6f55b17baa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "76950a6c2acd98a70ced9f54bb0a867f3c80d6f8", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\nindex 77c30c20696..5d1faca7345 100644\n--- a/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n+++ b/server/src/main/java/org/elasticsearch/tasks/TaskManager.java\n\n@@ -440,12 +440,13 @@ public class TaskManager implements ClusterStateApplier {\n         return Collections.unmodifiableSet(bannedParents.keySet());\n     }\n \n-    private static class Ban {\n+    private class Ban {\n         final String reason;\n         final boolean perChannel; // TODO: Remove this in 8.0\n         final Set<ChannelPendingTaskTracker> channels;\n \n         Ban(String reason, boolean perChannel) {\n+            assert Thread.holdsLock(bannedParents);\n             this.reason = reason;\n             this.perChannel = perChannel;\n             if (perChannel) {\n"}}, {"oid": "98c1be89367d418b97ff704606c7501b90f7e850", "url": "https://github.com/elastic/elasticsearch/commit/98c1be89367d418b97ff704606c7501b90f7e850", "message": "Merge branch 'master' into remove-ban-on-disconnect", "committedDate": "2020-12-09T16:05:07Z", "type": "commit"}, {"oid": "0f9fbeeb0e252cd0faef6428feb4f2892c8c225a", "url": "https://github.com/elastic/elasticsearch/commit/0f9fbeeb0e252cd0faef6428feb4f2892c8c225a", "message": "single direct channel tracker", "committedDate": "2020-12-09T16:06:46Z", "type": "commit"}, {"oid": "76950a6c2acd98a70ced9f54bb0a867f3c80d6f8", "url": "https://github.com/elastic/elasticsearch/commit/76950a6c2acd98a70ced9f54bb0a867f3c80d6f8", "message": "tighten synchronize", "committedDate": "2020-12-09T16:06:51Z", "type": "commit"}, {"oid": "4f5479b0bf7fa0f0c8cc14cc791f69ff3444549b", "url": "https://github.com/elastic/elasticsearch/commit/4f5479b0bf7fa0f0c8cc14cc791f69ff3444549b", "message": "stylecheck", "committedDate": "2020-12-09T16:07:28Z", "type": "commit"}, {"oid": "99bcff478f6215c9b8135311f3b092530eb9dd5a", "url": "https://github.com/elastic/elasticsearch/commit/99bcff478f6215c9b8135311f3b092530eb9dd5a", "message": "typo", "committedDate": "2020-12-09T16:08:09Z", "type": "commit"}, {"oid": "336a05f79b73f1877c12704277d5a8607756ca83", "url": "https://github.com/elastic/elasticsearch/commit/336a05f79b73f1877c12704277d5a8607756ca83", "message": "Merge branch 'master' into remove-ban-on-disconnect", "committedDate": "2020-12-16T14:28:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3ODU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r544478569", "bodyText": "I think we can move to drop this now and rely entirely on the channel-closing trigger. I don't think this logic ever completely worked, we could receive a task from a departing node after it had left the cluster but while it was still connected to us; moreover it might rejoin the cluster without disconnecting from us and then we'd keep on processing the task it thought it had cancelled.\n(it's still needed for BWC, it's better than nothing, but should only apply to bans that aren't tracking their own channels)", "author": "DaveCTurner", "createdAt": "2020-12-16T17:18:06Z", "path": "server/src/main/java/org/elasticsearch/tasks/TaskManager.java", "diffHunk": "@@ -444,15 +503,15 @@ public void removeBan(TaskId parentTaskId) {\n     public void applyClusterState(ClusterChangedEvent event) {\n         lastDiscoveryNodes = event.state().getNodes();\n         if (event.nodesRemoved()) {\n-            synchronized (banedParents) {\n+            synchronized (bannedParents) {\n                 lastDiscoveryNodes = event.state().getNodes();\n                 // Remove all bans that were registered by nodes that are no longer in the cluster state", "originalCommit": "336a05f79b73f1877c12704277d5a8607756ca83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMzExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r544513115", "bodyText": "Yes, this applies to bans that are not tracked by channels (see line 512 where we check ban.getValue().perChannel == false).", "author": "dnhatn", "createdAt": "2020-12-16T18:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3ODU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMzU0NA==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r544513544", "bodyText": "I will remove this on 8.0 once we backported this change to 7.x.", "author": "dnhatn", "createdAt": "2020-12-16T18:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3ODU2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUyMjU0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66066#discussion_r544522546", "bodyText": "Ah yes, you're right again.", "author": "DaveCTurner", "createdAt": "2020-12-16T18:22:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ3ODU2OQ=="}], "type": "inlineReview", "revised_code": null}]}