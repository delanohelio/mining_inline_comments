{"pr_number": 55592, "pr_title": "Make xpack.ilm.enabled setting a no-op", "pr_createdAt": "2020-04-22T13:54:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55592", "timeline": [{"oid": "48009af033dbbdbac257e877e0666730303e7cee", "url": "https://github.com/elastic/elasticsearch/commit/48009af033dbbdbac257e877e0666730303e7cee", "message": "Make xpack.ilm.enabled setting a no-op", "committedDate": "2020-04-22T13:38:27Z", "type": "commit"}, {"oid": "de89eac2ccccff9f6c1b607222ef7354c157b3d7", "url": "https://github.com/elastic/elasticsearch/commit/de89eac2ccccff9f6c1b607222ef7354c157b3d7", "message": "Merge branch 'master' into disabled-ilm-is-no-op", "committedDate": "2020-04-22T13:39:35Z", "type": "commit"}, {"oid": "715bdbb7f62218cce66c8ded68645c506fdb5386", "url": "https://github.com/elastic/elasticsearch/commit/715bdbb7f62218cce66c8ded68645c506fdb5386", "message": "Merge branch 'master' into disabled-ilm-is-no-op", "committedDate": "2020-04-22T18:59:24Z", "type": "commit"}, {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f", "url": "https://github.com/elastic/elasticsearch/commit/ad7186f1df3167f78e39054d5f9c6538c7dd328f", "message": "Add watcher setting to not use ILM", "committedDate": "2020-04-23T18:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414068909", "bodyText": "Can you explain this change, just so I can better understand?", "author": "pugnascotia", "createdAt": "2020-04-23T19:34:23Z", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java", "diffHunk": "@@ -44,7 +45,7 @@ public static void setupRepositoryPath() {\n     @Override\n     protected Settings nodeSettings() {\n         Settings.Builder settings = Settings.builder().put(super.nodeSettings());\n-        settings.put(XPackSettings.INDEX_LIFECYCLE_ENABLED.getKey(), false);\n+        settings.put(LifecycleSettings.LIFECYCLE_HISTORY_INDEX_ENABLED_SETTING.getKey(), false);", "originalCommit": "ad7186f1df3167f78e39054d5f9c6538c7dd328f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzNzQzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414137435", "bodyText": "The idea is that the lifecycle history index is irrelevant to these tests, so it's less setup and teardown.", "author": "williamrandolph", "createdAt": "2020-04-23T21:30:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0OTY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414649645", "bodyText": "The tests run fine with this setting enabled, so I'll drop this line.", "author": "williamrandolph", "createdAt": "2020-04-24T15:07:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "14f086e1d483ca51403a75abd742a0d933dc5632", "chunk": "diff --git a/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java\nindex 4c5c10f2844..d2ec43274fe 100644\n--- a/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java\n+++ b/x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java\n\n@@ -45,7 +44,6 @@ public class SnapshotLifecycleInitialisationTests extends ESSingleNodeTestCase {\n     @Override\n     protected Settings nodeSettings() {\n         Settings.Builder settings = Settings.builder().put(super.nodeSettings());\n-        settings.put(LifecycleSettings.LIFECYCLE_HISTORY_INDEX_ENABLED_SETTING.getKey(), false);\n         settings.put(XPackSettings.MACHINE_LEARNING_ENABLED.getKey(), false);\n         settings.put(XPackSettings.SECURITY_ENABLED.getKey(), false);\n         settings.put(XPackSettings.WATCHER_ENABLED.getKey(), false);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414069429", "bodyText": "Can we remove ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM and STATS_TEMPLATE_NO_ILM now?", "author": "pugnascotia", "createdAt": "2020-04-23T19:35:19Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "originalCommit": "ad7186f1df3167f78e39054d5f9c6538c7dd328f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzODQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414138478", "bodyText": "I will reach out to someone from ML to see if this change is OK, but I would guess that we will be able to remove those templates.\n\n get feedback from someone on ML for removing NO_ILM templates", "author": "williamrandolph", "createdAt": "2020-04-23T21:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0NTUyOA==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414645528", "bodyText": "@dimitris-athanasiou and @przemekwitek have confirmed that these templates can be removed.", "author": "williamrandolph", "createdAt": "2020-04-24T15:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0NzEwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414647100", "bodyText": "(Przemek from ML team): I think it is ok to remove the non-ILM versions.\nOnce only ILM versions exist, it would be good to inline the variables into the .json files but if you don't feel like doing it, I can do it as a followup PR.", "author": "przemekwitek", "createdAt": "2020-04-24T15:04:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcwMDE4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414700183", "bodyText": "@przemekwitek Do you mean like this?\n    private static IndexTemplateConfig stateTemplate() {\n        Map<String, String> variables = new HashMap<>();\n        variables.put(VERSION_ID_PATTERN, String.valueOf(Version.CURRENT.id));\n        variables.put(\"xpack.ml.index.lifecycle.name\", ML_SIZE_BASED_ILM_POLICY_NAME);\n        variables.put(\"xpack.ml.index.rollover_alias.name\", AnomalyDetectorsIndex.jobStateIndexWriteAlias());\n\n        return new IndexTemplateConfig(AnomalyDetectorsIndexFields.STATE_INDEX_PREFIX,\n            ANOMALY_DETECTION_PATH + \"state_index_template.json\",\n            Version.CURRENT.id, VERSION_PATTERN,\n            variables);\n    }\n\n\u2026with this in the template json file?\n  \"settings\" : {\n    \"index\" : {\n      \"auto_expand_replicas\" : \"0-1\",\n      \"hidden\": true\n    },\n    \"index.lifecycle.name\": \"${xpack.ml.index.lifecycle.name}\",\n    \"index.lifecycle.rollover_alias\": \"${xpack.ml.index.rollover_alias.name}\"\n  },\n\nOr should the actual values be inlined as well?", "author": "williamrandolph", "createdAt": "2020-04-24T16:20:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTA2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414731065", "bodyText": "Any of these 2 solutions work for me.\nIt's most important for me to get rid of syntax tokens (like comma \",\") which were just a hack to allow enabled/disabled duality.\nThe first one is more flexible so my preference goes there.", "author": "przemekwitek", "createdAt": "2020-04-24T17:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0Mjg3MA==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414742870", "bodyText": "I've pushed a commit with the first, more flexible strategy. Thanks for the feedback!", "author": "williamrandolph", "createdAt": "2020-04-24T17:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTgxMg==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414749812", "bodyText": "Could you make the variable name the same for both templates?\nI.e. xpack.ml.index.lifecycle.name and xpack.ml.index.lifecycle.rollover_alias for both state and stats templates?", "author": "przemekwitek", "createdAt": "2020-04-24T17:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NDY5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r415184692", "bodyText": "Good catch. This is done.", "author": "williamrandolph", "createdAt": "2020-04-26T01:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUzNjE3NA==", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r415536174", "bodyText": "Thank you!", "author": "przemekwitek", "createdAt": "2020-04-27T06:10:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "beb6555453e1d0505dc6fec0f577ed257a79867e", "url": "https://github.com/elastic/elasticsearch/commit/beb6555453e1d0505dc6fec0f577ed257a79867e", "message": "Update documentation for no-op setting", "committedDate": "2020-04-23T21:27:12Z", "type": "commit"}, {"oid": "88b4044c6d0be9751cef35c1864fb2a8f5dbbb8c", "url": "https://github.com/elastic/elasticsearch/commit/88b4044c6d0be9751cef35c1864fb2a8f5dbbb8c", "message": "Remove NO_ILM ml index templates", "committedDate": "2020-04-24T15:11:16Z", "type": "commit"}, {"oid": "14f086e1d483ca51403a75abd742a0d933dc5632", "url": "https://github.com/elastic/elasticsearch/commit/14f086e1d483ca51403a75abd742a0d933dc5632", "message": "Remove unneeded setting from test setup", "committedDate": "2020-04-24T15:11:31Z", "type": "commit"}, {"oid": "438725cd0d288121c5bbfbf382f05ea853c3d5f0", "url": "https://github.com/elastic/elasticsearch/commit/438725cd0d288121c5bbfbf382f05ea853c3d5f0", "message": "Inline variable definitions for ML templates", "committedDate": "2020-04-24T17:28:05Z", "type": "commit"}, {"oid": "e5f384ac1f55fcb2bc73353728a4090070806bd8", "url": "https://github.com/elastic/elasticsearch/commit/e5f384ac1f55fcb2bc73353728a4090070806bd8", "message": "Use identical parameter names in templates", "committedDate": "2020-04-26T01:26:40Z", "type": "commit"}, {"oid": "91eabaa09e355616de0193e842b19d19bb5b68ab", "url": "https://github.com/elastic/elasticsearch/commit/91eabaa09e355616de0193e842b19d19bb5b68ab", "message": "New ILM/watcher setting falls back to old setting", "committedDate": "2020-04-27T21:21:56Z", "type": "commit"}, {"oid": "061da3b04447c778eda43feafd9ef04e80a095b7", "url": "https://github.com/elastic/elasticsearch/commit/061da3b04447c778eda43feafd9ef04e80a095b7", "message": "Merge branch 'master' into disabled-ilm-is-no-op", "committedDate": "2020-04-28T13:35:28Z", "type": "commit"}, {"oid": "d5cce56a2ea8d6fce3af66e8dc04b19cffebda2a", "url": "https://github.com/elastic/elasticsearch/commit/d5cce56a2ea8d6fce3af66e8dc04b19cffebda2a", "message": "Add fallback unit test for watcher/ilm setting", "committedDate": "2020-04-28T14:15:29Z", "type": "commit"}]}