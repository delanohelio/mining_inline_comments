{"pr_number": 56888, "pr_title": "Ensure template exists when creating data stream", "pr_createdAt": "2020-05-18T09:46:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56888", "timeline": [{"oid": "deed8c74b109bd2aa348c38a9739ff4d1a1685cb", "url": "https://github.com/elastic/elasticsearch/commit/deed8c74b109bd2aa348c38a9739ff4d1a1685cb", "message": "Ensure template exists when creating data stream\n\nLimit the creation of data streams only for namespaces that have a composable template with a data stream definition.\nThis way we ensure that mappings/settings have been specified and will be used at data stream creation and data stream rollover.\n\nRelates to #53100", "committedDate": "2020-05-18T09:44:15Z", "type": "commit"}, {"oid": "b6bb38f16a240525fb809079b5ce6d3c0f91a600", "url": "https://github.com/elastic/elasticsearch/commit/b6bb38f16a240525fb809079b5ce6d3c0f91a600", "message": "fixed yaml issues", "committedDate": "2020-05-18T10:56:16Z", "type": "commit"}, {"oid": "e6d675cb6c13396443944a97a76abfc8b1b96d7f", "url": "https://github.com/elastic/elasticsearch/commit/e6d675cb6c13396443944a97a76abfc8b1b96d7f", "message": "fixed checkstyle violation", "committedDate": "2020-05-18T11:16:37Z", "type": "commit"}, {"oid": "04341ac5e4afe4f0da0acbddf66575ad24cf7b4e", "url": "https://github.com/elastic/elasticsearch/commit/04341ac5e4afe4f0da0acbddf66575ad24cf7b4e", "message": "fixed test", "committedDate": "2020-05-18T11:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzOTQ0OA==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r427839448", "bodyText": "Should we enforce that the timestamp field on the create data stream request is the same as the timestamp field in the data stream template? This can be different if a user provided a different timestamp field via the create data stream api.\nIf we do enforce this then I think that we should remove the timestamp field from the create data stream request and always use the timestamp field provided in the data stream template inside a itv2.", "author": "martijnvg", "createdAt": "2020-05-20T08:41:00Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,4 +147,16 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         return ClusterState.builder(currentState).metadata(builder).build();\n     }\n \n+    public static void validateTemplateForDataStream(String dataStreamName, Metadata metadata) {\n+        final String v2Template = MetadataIndexTemplateService.findV2Template(metadata, dataStreamName, false);\n+        if (v2Template == null) {\n+            throw new IllegalArgumentException(\"no matching index template found for data stream [\" + dataStreamName + \"]\");\n+        }\n+        IndexTemplateV2 indexTemplateV2 = metadata.templatesV2().get(v2Template);\n+        if (indexTemplateV2.getDataStreamTemplate() == null) {\n+            throw new IllegalArgumentException(\"matching index template [\" + v2Template + \"] for data stream [\" + dataStreamName  +\n+                \"] has no data stream template\");\n+        }", "originalCommit": "04341ac5e4afe4f0da0acbddf66575ad24cf7b4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg1MDI3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r427850271", "bodyText": "We should at least make specifying the timestamp field non-mandatory. In the future, it should only be necessary to specify if there is no matching template.\nAlso, the requirement to have the template have a valid mapping for the timestamp field makes it questionable if specifying a timestamp field on the data stream has any real value. Once/if we add the ability to also specify settings and mappings when creating data streams (i.e., create a data stream without any template requirement), it makes more sense to also be able to specify the timestamp field.\nI would opt to remove the ability to specify the timestamp field for the first iteration of data streams.", "author": "henningandersen", "createdAt": "2020-05-20T08:57:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzOTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg4Mjk3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r427882976", "bodyText": "Thanks Henning, I will remove the timestamp_field parameter from the create data stream request as part of this PR.", "author": "martijnvg", "createdAt": "2020-05-20T09:49:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgzOTQ0OA=="}], "type": "inlineReview", "revised_code": {"commit": "fb2294dd6f54d3f25dbc7f8042b5fe3337004e9d", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\nindex dc7faaac633..dec483d8853 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n\n@@ -142,12 +139,12 @@ public class MetadataCreateDataStreamService {\n         assert firstBackingIndex != null;\n \n         Metadata.Builder builder = Metadata.builder(currentState.metadata()).put(\n-            new DataStream(request.name, request.timestampFieldName, List.of(firstBackingIndex.getIndex())));\n+            new DataStream(request.name, template.getDataStreamTemplate().getTimestampField(), List.of(firstBackingIndex.getIndex())));\n         logger.info(\"adding data stream [{}]\", request.name);\n         return ClusterState.builder(currentState).metadata(builder).build();\n     }\n \n-    public static void validateTemplateForDataStream(String dataStreamName, Metadata metadata) {\n+    public static IndexTemplateV2 lookupTemplateForDataStream(String dataStreamName, Metadata metadata) {\n         final String v2Template = MetadataIndexTemplateService.findV2Template(metadata, dataStreamName, false);\n         if (v2Template == null) {\n             throw new IllegalArgumentException(\"no matching index template found for data stream [\" + dataStreamName + \"]\");\n"}}, {"oid": "f8a91d2305a605b9c6b97ef99392be60765fbfbc", "url": "https://github.com/elastic/elasticsearch/commit/f8a91d2305a605b9c6b97ef99392be60765fbfbc", "message": "Merge remote-tracking branch 'es/master' into ensure_itv2_exists", "committedDate": "2020-05-20T12:29:30Z", "type": "commit"}, {"oid": "fb2294dd6f54d3f25dbc7f8042b5fe3337004e9d", "url": "https://github.com/elastic/elasticsearch/commit/fb2294dd6f54d3f25dbc7f8042b5fe3337004e9d", "message": "Remove timestamp_field from create data stream request and\nlet the create data stream api resolve the timestamp field\nfrom the data stream template snippet inside an itv2.", "committedDate": "2020-05-20T14:54:04Z", "type": "commit"}, {"oid": "6d716508235ad2f08b787f6d63c9e18f7c63c35c", "url": "https://github.com/elastic/elasticsearch/commit/6d716508235ad2f08b787f6d63c9e18f7c63c35c", "message": "adjusted docs tests and skip data stream bwc tests until backported", "committedDate": "2020-05-20T17:04:35Z", "type": "commit"}, {"oid": "825c787af936f1399dd7180c326f6fd2e31b2d70", "url": "https://github.com/elastic/elasticsearch/commit/825c787af936f1399dd7180c326f6fd2e31b2d70", "message": "fixed docs test", "committedDate": "2020-05-20T20:37:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MzI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r430263260", "bodyText": "I think this makes settings unused? But I am also uncertain of why this change was made? Just cleanup or a necessity. If the latter, I would like to understand why.", "author": "henningandersen", "createdAt": "2020-05-26T09:03:08Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "diffHunk": "@@ -218,14 +217,14 @@ public void testDeleteIndexWhileIndexing() throws Exception {\n         }\n     }\n \n-    public void testMixedAutoCreate() {\n+    public void testMixedAutoCreate() throws Exception {\n         Settings settings = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n \n         PutIndexTemplateV2Action.Request createTemplateRequest = new PutIndexTemplateV2Action.Request(\"logs-foo\");\n         createTemplateRequest.indexTemplate(\n             new IndexTemplateV2(\n                 List.of(\"logs-foo*\"),\n-                new Template(settings, null, null),\n+                null,", "originalCommit": "825c787af936f1399dd7180c326f6fd2e31b2d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2NDcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r430364729", "bodyText": "This was just a cleanup. I will remove the settings variable.\n(copy paste from testAutoCreateV1TemplateNoDataStream() which ensures that a template applied, but that is not needed here, because if the data stream is created then the template has been applied)", "author": "martijnvg", "createdAt": "2020-05-26T12:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2MzI2MA=="}], "type": "inlineReview", "revised_code": {"commit": "491a9c545bd19739a7cde2fce32a6ff7fca0fcd9", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java b/server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java\nindex 0aed8c2aa6c..a2669ef8413 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java\n\n@@ -218,8 +218,6 @@ public class BulkIntegrationIT extends ESIntegTestCase {\n     }\n \n     public void testMixedAutoCreate() throws Exception {\n-        Settings settings = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n-\n         PutIndexTemplateV2Action.Request createTemplateRequest = new PutIndexTemplateV2Action.Request(\"logs-foo\");\n         createTemplateRequest.indexTemplate(\n             new IndexTemplateV2(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2NDkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r430264924", "bodyText": "This is fine, but I wonder if we should follow-up with generically removing all v2 templates like we do for regular templates?", "author": "henningandersen", "createdAt": "2020-05-26T09:05:54Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "diffHunk": "@@ -72,13 +77,19 @@\n \n public class DataStreamIT extends ESIntegTestCase {\n \n+    @After", "originalCommit": "825c787af936f1399dd7180c326f6fd2e31b2d70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM1NzkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r430357922", "bodyText": "Yes, I noticed that component templates were not automatically removed after each test. I don't know why. @dakrone Is there a reason why component templates are automatically removed after each test?", "author": "martijnvg", "createdAt": "2020-05-26T11:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2NDkyNA=="}], "type": "inlineReview", "revised_code": {"commit": "115c9cd08d93ec5810edeca2a7d41fa9c83b19f6", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java b/server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java\nindex deb74f3daee..728ec6293d4 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java\n\n@@ -79,8 +79,8 @@ public class DataStreamIT extends ESIntegTestCase {\n \n     @After\n     public void deleteAllComposableTemplates() {\n-        DeleteIndexTemplateV2Action.Request deleteTemplateRequest = new DeleteIndexTemplateV2Action.Request(\"*\");\n-        client().execute(DeleteIndexTemplateV2Action.INSTANCE, deleteTemplateRequest).actionGet();\n+        DeleteComposableIndexTemplateAction.Request deleteTemplateRequest = new DeleteComposableIndexTemplateAction.Request(\"*\");\n+        client().execute(DeleteComposableIndexTemplateAction.INSTANCE, deleteTemplateRequest).actionGet();\n     }\n \n     public void testBasicScenario() throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI2ODYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/56888#discussion_r430268611", "bodyText": "nit: seems like a strange secret choice of _id, maybe just use template?", "author": "henningandersen", "createdAt": "2020-05-26T09:12:06Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverServiceTests.java", "diffHunk": "@@ -515,7 +515,10 @@ public void testRolloverClusterState() throws Exception {\n \n     public void testRolloverClusterStateForDataStream() throws Exception {\n         final DataStream dataStream = DataStreamTests.randomInstance();\n+        IndexTemplateV2 template = new IndexTemplateV2(List.of(dataStream.getName() + \"*\"), null, null, null, null, null,\n+            new IndexTemplateV2.DataStreamTemplate(\"@timestamp\"));\n         Metadata.Builder builder = Metadata.builder();\n+        builder.put(\"_id\", template);", "originalCommit": "825c787af936f1399dd7180c326f6fd2e31b2d70", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "491a9c545bd19739a7cde2fce32a6ff7fca0fcd9", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverServiceTests.java b/server/src/test/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverServiceTests.java\nindex 35393f3f640..5635497902a 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverServiceTests.java\n\n@@ -518,7 +518,7 @@ public class MetadataRolloverServiceTests extends ESTestCase {\n         IndexTemplateV2 template = new IndexTemplateV2(List.of(dataStream.getName() + \"*\"), null, null, null, null, null,\n             new IndexTemplateV2.DataStreamTemplate(\"@timestamp\"));\n         Metadata.Builder builder = Metadata.builder();\n-        builder.put(\"_id\", template);\n+        builder.put(\"template\", template);\n         for (Index index : dataStream.getIndices()) {\n             builder.put(DataStreamTestHelper.getIndexMetadataBuilderForIndex(index));\n         }\n"}}, {"oid": "08739e91bd0c8ec6f31fef02728a1a71baa0af9e", "url": "https://github.com/elastic/elasticsearch/commit/08739e91bd0c8ec6f31fef02728a1a71baa0af9e", "message": "Merge remote-tracking branch 'es/master' into ensure_itv2_exists", "committedDate": "2020-05-26T11:18:15Z", "type": "commit"}, {"oid": "491a9c545bd19739a7cde2fce32a6ff7fca0fcd9", "url": "https://github.com/elastic/elasticsearch/commit/491a9c545bd19739a7cde2fce32a6ff7fca0fcd9", "message": "applied feedback comments", "committedDate": "2020-05-26T12:35:49Z", "type": "commit"}, {"oid": "f4897f4bb5c2e6c44a7040454fad6954eb2cca9c", "url": "https://github.com/elastic/elasticsearch/commit/f4897f4bb5c2e6c44a7040454fad6954eb2cca9c", "message": "Merge remote-tracking branch 'es/master' into ensure_itv2_exists", "committedDate": "2020-05-27T08:06:15Z", "type": "commit"}, {"oid": "7d30aeed7441802ca82aa19f1d8d77295e9afe9a", "url": "https://github.com/elastic/elasticsearch/commit/7d30aeed7441802ca82aa19f1d8d77295e9afe9a", "message": "added docs about data_stream definition in a composable template.", "committedDate": "2020-05-27T08:12:58Z", "type": "commit"}, {"oid": "78cf3882539da82a939d384237f62c88bcb9e2c5", "url": "https://github.com/elastic/elasticsearch/commit/78cf3882539da82a939d384237f62c88bcb9e2c5", "message": "altered snippet", "committedDate": "2020-05-27T08:18:26Z", "type": "commit"}, {"oid": "d8abd45ce9a0159c645309ae5aac372661e0ec32", "url": "https://github.com/elastic/elasticsearch/commit/d8abd45ce9a0159c645309ae5aac372661e0ec32", "message": "Merge remote-tracking branch 'es/master' into ensure_itv2_exists", "committedDate": "2020-05-28T09:00:43Z", "type": "commit"}, {"oid": "115c9cd08d93ec5810edeca2a7d41fa9c83b19f6", "url": "https://github.com/elastic/elasticsearch/commit/115c9cd08d93ec5810edeca2a7d41fa9c83b19f6", "message": "fixed compile errors after merging in master", "committedDate": "2020-05-28T09:26:52Z", "type": "commit"}]}