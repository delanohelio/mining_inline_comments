{"pr_number": 52690, "pr_title": "append index name for the source of the cluster put-mapping task", "pr_createdAt": "2020-02-24T05:20:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52690", "timeline": [{"oid": "be9c40aa09a1342ff78147002a941c8b0bac5013", "url": "https://github.com/elastic/elasticsearch/commit/be9c40aa09a1342ff78147002a941c8b0bac5013", "message": "append index name for the source of the cluster put-mapping task", "committedDate": "2020-02-24T05:17:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MDQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52690#discussion_r384480451", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    clusterService.submitStateUpdateTask(\"put-mapping \" + getRequestIndex(request),\n          \n          \n            \n                    clusterService.submitStateUpdateTask(\"put-mapping \" + Strings.arrayToCommaDelimitedString(request.indices())),\n          \n      \n    \n    \n  \n\nThis removes the need for the method below too.", "author": "henningandersen", "createdAt": "2020-02-26T13:08:51Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java", "diffHunk": "@@ -326,7 +326,7 @@ private ClusterState applyRequest(ClusterState currentState, PutMappingClusterSt\n     }\n \n     public void putMapping(final PutMappingClusterStateUpdateRequest request, final ActionListener<ClusterStateUpdateResponse> listener) {\n-        clusterService.submitStateUpdateTask(\"put-mapping\",\n+        clusterService.submitStateUpdateTask(\"put-mapping \" + getRequestIndex(request),", "originalCommit": "be9c40aa09a1342ff78147002a941c8b0bac5013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyMDcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52690#discussion_r384920723", "bodyText": "that's great", "author": "zhanghezhen", "createdAt": "2020-02-27T05:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MDQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "71c9de5c0dc05769d8c80eeee345a086e4ddf1fc", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java\nindex cfe74985a55..fe0365cc5b2 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataMappingService.java\n\n@@ -326,7 +327,7 @@ public class MetaDataMappingService {\n     }\n \n     public void putMapping(final PutMappingClusterStateUpdateRequest request, final ActionListener<ClusterStateUpdateResponse> listener) {\n-        clusterService.submitStateUpdateTask(\"put-mapping \" + getRequestIndex(request),\n+        clusterService.submitStateUpdateTask(\"put-mapping \" + Strings.arrayToCommaDelimitedString(request.indices()),\n                 request,\n                 ClusterStateTaskConfig.build(Priority.HIGH, request.masterNodeTimeout()),\n                 putMappingExecutor,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MTgzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52690#discussion_r384481831", "bodyText": "Given that we have the comma concatenating logic, I think we can omit the test here.", "author": "henningandersen", "createdAt": "2020-02-26T13:11:46Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataMappingServiceTests.java", "diffHunk": "@@ -113,4 +113,17 @@ public void testMappingVersionUnchanged() throws Exception {\n         assertThat(result.resultingState.metaData().index(\"test\").getMappingVersion(), equalTo(previousVersion));\n     }\n \n+    public void testGetRequestIndex() {", "originalCommit": "be9c40aa09a1342ff78147002a941c8b0bac5013", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyMDg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52690#discussion_r384920876", "bodyText": "Of course", "author": "zhanghezhen", "createdAt": "2020-02-27T05:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ4MTgzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "71c9de5c0dc05769d8c80eeee345a086e4ddf1fc", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataMappingServiceTests.java b/server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataMappingServiceTests.java\nindex 89ca0c3d1a7..d914e33a786 100644\n--- a/server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataMappingServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/cluster/metadata/MetaDataMappingServiceTests.java\n\n@@ -113,17 +113,4 @@ public class MetaDataMappingServiceTests extends ESSingleNodeTestCase {\n         assertThat(result.resultingState.metaData().index(\"test\").getMappingVersion(), equalTo(previousVersion));\n     }\n \n-    public void testGetRequestIndex() {\n-        String source = \"{\\\"properties\\\":{\\\"id\\\":{\\\"type\\\":\\\"long\\\"}}}\";\n-        String indexName = \"test\";\n-        final IndexService indexService = createIndex(indexName, client().admin().indices().prepareCreate(indexName));\n-        final PutMappingClusterStateUpdateRequest request = new PutMappingClusterStateUpdateRequest(source);\n-        request.indices(new Index[]{indexService.index()});\n-\n-        final MetaDataMappingService mappingService = getInstanceFromNode(MetaDataMappingService.class);\n-\n-        String requestIndex = mappingService.getRequestIndex(request);\n-        assertEquals(indexService.index().toString(), requestIndex);\n-    }\n-\n }\n"}}, {"oid": "71c9de5c0dc05769d8c80eeee345a086e4ddf1fc", "url": "https://github.com/elastic/elasticsearch/commit/71c9de5c0dc05769d8c80eeee345a086e4ddf1fc", "message": "append index name for the source of the cluster put-mapping task", "committedDate": "2020-02-27T05:55:49Z", "type": "commit"}, {"oid": "0800b33643d93bf3756126f91189e5e78ab55614", "url": "https://github.com/elastic/elasticsearch/commit/0800b33643d93bf3756126f91189e5e78ab55614", "message": "Merge branch 'master' into master", "committedDate": "2020-02-27T08:27:04Z", "type": "commit"}]}