{"pr_number": 60533, "pr_title": "Implement runtime script ips", "pr_createdAt": "2020-07-31T16:27:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60533", "timeline": [{"oid": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "url": "https://github.com/elastic/elasticsearch/commit/3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "message": "Implement runtime script ips\n\nThis implements the `ip` typed runtime fields. They share a fair bit\nwith `string` runtime fields but we represent them as a `BytesRef`\ncontaining 128 bits so that the comparisons all happen in the same way\nas Lucene's `InetAddressPoint`.", "committedDate": "2020-07-31T16:26:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464648621", "bodyText": "been thinking about these static methods that we are sharing here and there: should we have a better way to formalize the fact that runtime fields share some bits with their corresponding concrete field? e.g. should they share some base class or something along those lines? Or would it make any sense for runtime field type to extend its corresponding concrete field type? probably both are bad ideas, but probably good to look into what the alternatives are.", "author": "javanna", "createdAt": "2020-08-03T20:36:55Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -221,6 +222,26 @@ public Query termsQuery(List<?> values, QueryShardContext context) {\n         @Override\n         public Query rangeQuery(Object lowerTerm, Object upperTerm, boolean includeLower, boolean includeUpper, QueryShardContext context) {\n             failIfNotIndexed();\n+            return rangeQuery(\n+                lowerTerm,\n+                upperTerm,\n+                includeLower,\n+                includeUpper,\n+                (lower, upper) -> InetAddressPoint.newRangeQuery(name(), lower, upper)\n+            );\n+        }\n+\n+        /**\n+         * Processes query bounds into {@code long}s and delegates the\n+         * provided {@code builder} to build a range query.\n+         */\n+        public static Query rangeQuery(", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MDE3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465950171", "bodyText": "I talked with @javanna and we decided that we should keep this in mind, but we don't really have a cleaner way to do it for now. There are certainly other ways, but they aren't obviously cleaner.", "author": "nik9000", "createdAt": "2020-08-05T19:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODYyMQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODkyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464648925", "bodyText": "s/most/must ?", "author": "javanna", "createdAt": "2020-08-03T20:37:35Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields;\n+\n+import org.apache.lucene.document.InetAddressPoint;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.util.ArrayUtil;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.network.InetAddresses;\n+import org.elasticsearch.index.mapper.IpFieldMapper;\n+import org.elasticsearch.painless.spi.Whitelist;\n+import org.elasticsearch.painless.spi.WhitelistLoader;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptFactory;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+\n+import java.io.IOException;\n+import java.net.Inet4Address;\n+import java.net.Inet6Address;\n+import java.net.InetAddress;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Script producing IP addresses. Unlike the other {@linkplain AbstractScriptFieldScript}s\n+ * which deal with their native java objects this converts its values to the same format\n+ * that Lucene uses to store its fields, {@link InetAddressPoint}. There are a few compelling\n+ * reasons to do this:\n+ * <ul>\n+ * <li>{@link Inet4Address}es and {@link Inet6Address} are not comparable with one another.\n+ * That is correct in some contexts, but not for our queries. Our queries most consider the", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NTQwNw==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465955407", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-08-05T19:32:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODkyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "563bf0139d84032fabcfc7b50305ddf846e13923", "chunk": "diff --git a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java b/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java\nindex 79b4d2330fa..32ac41e6685 100644\n--- a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java\n+++ b/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/IpScriptFieldScript.java\n\n@@ -32,7 +32,7 @@ import java.util.Map;\n  * reasons to do this:\n  * <ul>\n  * <li>{@link Inet4Address}es and {@link Inet6Address} are not comparable with one another.\n- * That is correct in some contexts, but not for our queries. Our queries most consider the\n+ * That is correct in some contexts, but not for our queries. Our queries must consider the\n  * IPv4 address equal to the address that it maps to in IPv6 <a href=\"https://tools.ietf.org/html/rfc4291\">rfc4291</a>).\n  * <li>{@link InetAddress}es are not ordered, but we need to implement range queries with\n  * same same ordering as {@link IpFieldMapper}. That also uses {@link InetAddressPoint}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1MDMzOA==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r464650338", "bodyText": "double checking that this is the name you meant to use. I struggle to see what this class does", "author": "javanna", "createdAt": "2020-08-03T20:40:36Z", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptIpScriptDocValues.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.document.InetAddressPoint;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.network.InetAddresses;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.xpack.runtimefields.IpScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.net.InetAddress;\n+\n+public class ScriptIpScriptDocValues extends ScriptDocValues<String> {", "originalCommit": "3df2071517fc2aa3b2041bd9be0c37efb17c8ef7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MDUyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/60533#discussion_r465950525", "bodyText": "It is a pretty terrible name! I talked with @javanna and it will think it over some more. Or more it so it is a bit more obvious.", "author": "nik9000", "createdAt": "2020-08-05T19:22:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY1MDMzOA=="}], "type": "inlineReview", "revised_code": {"commit": "81733cd638110162883abe037f624749920ee2f4", "chunk": "diff --git a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptIpScriptDocValues.java b/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptIpScriptDocValues.java\ndeleted file mode 100644\nindex 35ff113db3e..00000000000\n--- a/x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptIpScriptDocValues.java\n+++ /dev/null\n\n@@ -1,58 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License;\n- * you may not use this file except in compliance with the Elastic License.\n- */\n-\n-package org.elasticsearch.xpack.runtimefields.fielddata;\n-\n-import org.apache.lucene.document.InetAddressPoint;\n-import org.elasticsearch.common.bytes.BytesArray;\n-import org.elasticsearch.common.bytes.BytesReference;\n-import org.elasticsearch.common.network.InetAddresses;\n-import org.elasticsearch.index.fielddata.ScriptDocValues;\n-import org.elasticsearch.xpack.runtimefields.IpScriptFieldScript;\n-\n-import java.io.IOException;\n-import java.net.InetAddress;\n-\n-public class ScriptIpScriptDocValues extends ScriptDocValues<String> {\n-    private final IpScriptFieldScript script;\n-\n-    public ScriptIpScriptDocValues(IpScriptFieldScript script) {\n-        this.script = script;\n-    }\n-\n-    @Override\n-    public void setNextDocId(int docId) throws IOException {\n-        script.runForDoc(docId);\n-    }\n-\n-    public String getValue() {\n-        if (size() == 0) {\n-            return null;\n-        }\n-        return get(0);\n-    }\n-\n-    @Override\n-    public String get(int index) {\n-        if (index >= size()) {\n-            if (size() == 0) {\n-                throw new IllegalStateException(\n-                    \"A document doesn't have a value for a field! \"\n-                        + \"Use doc[<field>].size()==0 to check if a document is missing a field!\"\n-                );\n-            }\n-            throw new ArrayIndexOutOfBoundsException(\"There are only [\" + size() + \"] values.\");\n-        }\n-        InetAddress addr = InetAddressPoint.decode(BytesReference.toBytes(new BytesArray(script.values()[index])));\n-        return InetAddresses.toAddrString(addr);\n-    }\n-\n-    @Override\n-    public int size() {\n-        return script.count();\n-    }\n-\n-}\n"}}, {"oid": "fad406b7624a60d3cbfd441bdfb223ba744b887c", "url": "https://github.com/elastic/elasticsearch/commit/fad406b7624a60d3cbfd441bdfb223ba744b887c", "message": "Merge branch 'feature/runtime_fields' into script_field_ip", "committedDate": "2020-08-05T19:29:48Z", "type": "commit"}, {"oid": "563bf0139d84032fabcfc7b50305ddf846e13923", "url": "https://github.com/elastic/elasticsearch/commit/563bf0139d84032fabcfc7b50305ddf846e13923", "message": "words are hard", "committedDate": "2020-08-05T19:32:14Z", "type": "commit"}, {"oid": "81733cd638110162883abe037f624749920ee2f4", "url": "https://github.com/elastic/elasticsearch/commit/81733cd638110162883abe037f624749920ee2f4", "message": "Update", "committedDate": "2020-08-05T19:52:08Z", "type": "commit"}, {"oid": "22bdb5cc07e2bcc19372d12d85abd237ba168025", "url": "https://github.com/elastic/elasticsearch/commit/22bdb5cc07e2bcc19372d12d85abd237ba168025", "message": "Test", "committedDate": "2020-08-05T19:54:26Z", "type": "commit"}]}