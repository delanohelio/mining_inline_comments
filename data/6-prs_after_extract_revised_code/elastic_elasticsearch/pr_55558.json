{"pr_number": 55558, "pr_title": "Emit deprecation warning if multiple v1 templates match with a new index", "pr_createdAt": "2020-04-21T21:26:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55558", "timeline": [{"oid": "28ec7708b4bf9b4e10dcaa13d2bf1513d411eb03", "url": "https://github.com/elastic/elasticsearch/commit/28ec7708b4bf9b4e10dcaa13d2bf1513d411eb03", "message": "Emit deprecation warning if multiple v1 templates match with a new index", "committedDate": "2020-04-21T21:21:32Z", "type": "commit"}, {"oid": "6743582f78099dca122f815a55c22ebba7adf174", "url": "https://github.com/elastic/elasticsearch/commit/6743582f78099dca122f815a55c22ebba7adf174", "message": "fix test", "committedDate": "2020-04-22T17:36:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxMjAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/55558#discussion_r412512000", "bodyText": "minor wording change:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"[{}], it won't be supported with index templates v2\", request.index(),\n          \n          \n            \n                                    \"[{}], and won't be supported with v2 index templates\", request.index(),", "author": "dakrone", "createdAt": "2020-04-21T21:42:53Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -345,6 +345,12 @@ public ClusterState applyCreateIndexRequest(ClusterState currentState, CreateInd\n                 final List<IndexTemplateMetadata> v1Templates = MetadataIndexTemplateService.findV1Templates(currentState.metadata(),\n                     request.index(), isHiddenFromRequest);\n \n+                if (v1Templates.size() > 1) {\n+                    deprecationLogger.deprecatedAndMaybeLog(\"index_template_multiple_match\", \"index [{}] matches multiple templates \" +\n+                        \"[{}], it won't be supported with index templates v2\", request.index(),", "originalCommit": "28ec7708b4bf9b4e10dcaa13d2bf1513d411eb03", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6743582f78099dca122f815a55c22ebba7adf174", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\nindex 7aedb18a87b..e90178150a1 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\n\n@@ -348,7 +348,7 @@ public class MetadataCreateIndexService {\n                 if (v1Templates.size() > 1) {\n                     deprecationLogger.deprecatedAndMaybeLog(\"index_template_multiple_match\", \"index [{}] matches multiple templates \" +\n                         \"[{}], it won't be supported with index templates v2\", request.index(),\n-                        v1Templates.stream().map(IndexTemplateMetadata::name).collect(Collectors.joining(\", \")));\n+                        v1Templates.stream().map(IndexTemplateMetadata::name).sorted().collect(Collectors.joining(\", \")));\n                 }\n \n                 return applyCreateIndexRequestWithV1Templates(currentState, request, silent, v1Templates, metadataTransformer);\n"}}, {"oid": "41beebce3e6d52f0f032fae1da9a7f2bdb0c4e17", "url": "https://github.com/elastic/elasticsearch/commit/41beebce3e6d52f0f032fae1da9a7f2bdb0c4e17", "message": "Update server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\n\nCo-Authored-By: Lee Hinman <dakrone@users.noreply.github.com>", "committedDate": "2020-04-22T17:51:24Z", "type": "commit"}, {"oid": "8ef900637f249e52f02ea0620ab4f83bce1861de", "url": "https://github.com/elastic/elasticsearch/commit/8ef900637f249e52f02ea0620ab4f83bce1861de", "message": "fix test", "committedDate": "2020-04-22T17:52:32Z", "type": "commit"}, {"oid": "bda8e7a976940899375c4c80cdea6ed788297adb", "url": "https://github.com/elastic/elasticsearch/commit/bda8e7a976940899375c4c80cdea6ed788297adb", "message": "run tests", "committedDate": "2020-04-27T21:41:45Z", "type": "commit"}, {"oid": "4f3ace6f1bd96f8c2397e70de632b36fa15aa4ad", "url": "https://github.com/elastic/elasticsearch/commit/4f3ace6f1bd96f8c2397e70de632b36fa15aa4ad", "message": "Merge branch 'master' into deprecate-multiple-v1-templates", "committedDate": "2020-04-27T22:05:55Z", "type": "commit"}, {"oid": "98416cf8aae829258f9e8493d0d0ff6d2c4c10b5", "url": "https://github.com/elastic/elasticsearch/commit/98416cf8aae829258f9e8493d0d0ff6d2c4c10b5", "message": "fix tests", "committedDate": "2020-04-28T15:38:15Z", "type": "commit"}, {"oid": "05219f5e53096698f4c654a3a80b01fc8df16db4", "url": "https://github.com/elastic/elasticsearch/commit/05219f5e53096698f4c654a3a80b01fc8df16db4", "message": "fix tests", "committedDate": "2020-04-28T16:08:32Z", "type": "commit"}, {"oid": "6593967b1c479f568bcccd0b0173663aa4e0e91f", "url": "https://github.com/elastic/elasticsearch/commit/6593967b1c479f568bcccd0b0173663aa4e0e91f", "message": "fix tests", "committedDate": "2020-04-28T18:58:10Z", "type": "commit"}, {"oid": "ec5b2b93c17bdf39cbfc981ec98d9b15fcf1adf0", "url": "https://github.com/elastic/elasticsearch/commit/ec5b2b93c17bdf39cbfc981ec98d9b15fcf1adf0", "message": "Merge branch 'master' into deprecate-multiple-v1-templates", "committedDate": "2020-04-28T19:23:22Z", "type": "commit"}, {"oid": "96ad012fe4dd29298405d716c1d6e706433f374a", "url": "https://github.com/elastic/elasticsearch/commit/96ad012fe4dd29298405d716c1d6e706433f374a", "message": "fix tests", "committedDate": "2020-04-28T20:47:14Z", "type": "commit"}, {"oid": "5c0379259300e5cec625342ef7be905d5ee5970e", "url": "https://github.com/elastic/elasticsearch/commit/5c0379259300e5cec625342ef7be905d5ee5970e", "message": "fix tests", "committedDate": "2020-04-29T07:38:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ1NzMzNA==", "url": "https://github.com/elastic/elasticsearch/pull/55558#discussion_r417457334", "bodyText": "I think this is a little confusing about what will not be supported and what is not going to be supported going forward, maybe it should be something like:\n\"index [foo] matches multiple v1 templates [t1, t2], v2 index templates will only match a single index template\"\nWhat do you think?", "author": "dakrone", "createdAt": "2020-04-29T16:41:57Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -345,6 +345,12 @@ public ClusterState applyCreateIndexRequest(ClusterState currentState, CreateInd\n                 final List<IndexTemplateMetadata> v1Templates = MetadataIndexTemplateService.findV1Templates(currentState.metadata(),\n                     request.index(), isHiddenFromRequest);\n \n+                if (v1Templates.size() > 1) {\n+                    deprecationLogger.deprecatedAndMaybeLog(\"index_template_multiple_match\", \"index [{}] matches multiple templates \" +\n+                        \"[{}], and won't be supported with v2 index templates\", request.index(),", "originalCommit": "5c0379259300e5cec625342ef7be905d5ee5970e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzU2Nzk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55558#discussion_r417567944", "bodyText": "This is good idea, I've changed it", "author": "probakowski", "createdAt": "2020-04-29T19:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ1NzMzNA=="}], "type": "inlineReview", "revised_code": {"commit": "e648e432d5b659581195d7e48501add544040b30", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\nindex 6990053a9f0..39e62b1a4ed 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java\n\n@@ -346,8 +346,8 @@ public class MetadataCreateIndexService {\n                     request.index(), isHiddenFromRequest);\n \n                 if (v1Templates.size() > 1) {\n-                    deprecationLogger.deprecatedAndMaybeLog(\"index_template_multiple_match\", \"index [{}] matches multiple templates \" +\n-                        \"[{}], and won't be supported with v2 index templates\", request.index(),\n+                    deprecationLogger.deprecatedAndMaybeLog(\"index_template_multiple_match\", \"index [{}] matches multiple v1 templates \" +\n+                        \"[{}], v2 index templates will only match a single index template\", request.index(),\n                         v1Templates.stream().map(IndexTemplateMetadata::name).sorted().collect(Collectors.joining(\", \")));\n                 }\n \n"}}, {"oid": "e648e432d5b659581195d7e48501add544040b30", "url": "https://github.com/elastic/elasticsearch/commit/e648e432d5b659581195d7e48501add544040b30", "message": "message change", "committedDate": "2020-04-29T19:45:21Z", "type": "commit"}, {"oid": "4613851c1b0b069763c9fa0f50fac9a252a1d00f", "url": "https://github.com/elastic/elasticsearch/commit/4613851c1b0b069763c9fa0f50fac9a252a1d00f", "message": "Merge branch 'master' into deprecate-multiple-v1-templates", "committedDate": "2020-04-29T20:10:12Z", "type": "commit"}]}