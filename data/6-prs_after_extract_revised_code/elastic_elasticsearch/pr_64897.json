{"pr_number": 64897, "pr_title": "Skip optimization if there are few docs", "pr_createdAt": "2020-11-10T22:38:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64897", "timeline": [{"oid": "480fa284f504a2c31b581489ac6dc32ff28af70b", "url": "https://github.com/elastic/elasticsearch/commit/480fa284f504a2c31b581489ac6dc32ff28af70b", "message": "Skip optimization if there are few docs\n\nIn #63643 we added an optimization to the `range` agg that uses\n`filters` if we believe it'd be faster to do. It turns out that building\nthe `ScorerSupplier` for the `filters` has a fairly high overhead. So if\nwe think the query would match only a couple thousand documents per\nfilter we avoid the optimization alltogether. This keeps aggregations\nthat complete in a couple of milliseconds from wasting 50ms juggling\nfilters.", "committedDate": "2020-11-10T22:40:09Z", "type": "commit"}, {"oid": "a4d90f95f5f0eb4508d6151891bb06f767b8e1f9", "url": "https://github.com/elastic/elasticsearch/commit/a4d90f95f5f0eb4508d6151891bb06f767b8e1f9", "message": "Explain number", "committedDate": "2020-11-10T22:50:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyMDI4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64897#discussion_r520920289", "bodyText": "I calculate this universally now so we can always show it for debugging. In this particular location we don't use it for anything other than the debug message.", "author": "nik9000", "createdAt": "2020-11-10T22:40:52Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/range/GeoDistanceRangeAggregatorFactory.java", "diffHunk": "@@ -66,13 +66,15 @@ public static void registerAggregators(ValuesSourceRegistry.Builder builder) {\n                 cardinality,\n                 metadata) -> {\n                 DistanceSource distanceSource = new DistanceSource((ValuesSource.GeoPoint) valuesSource, distanceType, origin, units);\n+                double averageDocsPerRange = ((double) context.searcher().getIndexReader().maxDoc()) / ranges.length;", "originalCommit": "480fa284f504a2c31b581489ac6dc32ff28af70b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NjI5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64897#discussion_r521386295", "bodyText": "Comment on what this is intended to test would be nice.", "author": "not-napoleon", "createdAt": "2020-11-11T14:14:43Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java", "diffHunk": "@@ -562,4 +567,59 @@ public void testNoProfile() {\n         assertThat(profileResults, notNullValue());\n         assertThat(profileResults.size(), equalTo(0));\n     }\n+\n+    public void testFilterByFilter() throws InterruptedException, IOException {", "originalCommit": "a4d90f95f5f0eb4508d6151891bb06f767b8e1f9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "60c9033982764e2be9cade4ab3240990e3b18892", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java b/server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java\nindex f8d6a90171a..8045a946141 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java\n\n@@ -568,6 +568,13 @@ public class AggregationProfilerIT extends ESIntegTestCase {\n         assertThat(profileResults.size(), equalTo(0));\n     }\n \n+    /**\n+     * Makes sure that when the conditions are right we run {@code date_histogram}\n+     * using {@code filters}. When the conditions are right, this is significantly\n+     * faster than the traditional execution mechanism. This is in this test\n+     * rather than a yaml integration test because it requires creating many many\n+     * documents and that is hard to express in yaml.\n+     */\n     public void testFilterByFilter() throws InterruptedException, IOException {\n         assertAcked(client().admin().indices().prepareCreate(\"dateidx\")\n             .setSettings(Map.of(\"number_of_shards\", 1, \"number_of_replicas\", 0))\n"}}, {"oid": "60c9033982764e2be9cade4ab3240990e3b18892", "url": "https://github.com/elastic/elasticsearch/commit/60c9033982764e2be9cade4ab3240990e3b18892", "message": "Explain", "committedDate": "2020-11-11T14:27:31Z", "type": "commit"}, {"oid": "e3f11c92ba744121467e70644dee4c0e902779ea", "url": "https://github.com/elastic/elasticsearch/commit/e3f11c92ba744121467e70644dee4c0e902779ea", "message": "Merge branch 'master' into date_histo_as_range_debug", "committedDate": "2020-11-11T15:11:15Z", "type": "commit"}]}