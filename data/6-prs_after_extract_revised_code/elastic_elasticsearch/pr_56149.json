{"pr_number": 56149, "pr_title": "Update DeprecationMap to DynamicMap", "pr_createdAt": "2020-05-04T19:00:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56149", "timeline": [{"oid": "1a6bad076073b0e8dcc9de5f44cd2994be7caa5a", "url": "https://github.com/elastic/elasticsearch/commit/1a6bad076073b0e8dcc9de5f44cd2994be7caa5a", "message": "change deprecation map to dynamic map", "committedDate": "2020-05-04T17:31:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5ODc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/56149#discussion_r419798758", "bodyText": "I might name this like PARAMS_FUNCTIONS or something like that, so it is clear they are part of params.", "author": "rjernst", "createdAt": "2020-05-05T00:08:28Z", "path": "server/src/main/java/org/elasticsearch/script/AbstractSortScript.java", "diffHunk": "@@ -29,14 +31,25 @@\n import java.io.IOException;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.function.Function;\n \n abstract class AbstractSortScript implements ScorerAware {\n \n-    private static final Map<String, String> DEPRECATIONS = Map.of(\n-            \"doc\",\n-            \"Accessing variable [doc] via [params.doc] from within a sort-script is deprecated in favor of directly accessing [doc].\",\n-            \"_doc\",\n-            \"Accessing variable [doc] via [params._doc] from within a sort-script is deprecated in favor of directly accessing [doc].\");\n+    private static final DeprecationLogger deprecationLogger =\n+            new DeprecationLogger(LogManager.getLogger(DynamicMap.class));\n+    private static final Map<String, Function<Object, Object>> FUNCTIONS = Map.of(", "originalCommit": "1a6bad076073b0e8dcc9de5f44cd2994be7caa5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIzOTMxMg==", "url": "https://github.com/elastic/elasticsearch/pull/56149#discussion_r420239312", "bodyText": "Changed.", "author": "jdconrad", "createdAt": "2020-05-05T16:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5ODc1OA=="}], "type": "inlineReview", "revised_code": {"commit": "f91cadfc80286540750da3943b476a6066d532e3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/script/AbstractSortScript.java b/server/src/main/java/org/elasticsearch/script/AbstractSortScript.java\nindex d616273bb15..0bad0f03ac8 100644\n--- a/server/src/main/java/org/elasticsearch/script/AbstractSortScript.java\n+++ b/server/src/main/java/org/elasticsearch/script/AbstractSortScript.java\n\n@@ -37,7 +37,7 @@ abstract class AbstractSortScript implements ScorerAware {\n \n     private static final DeprecationLogger deprecationLogger =\n             new DeprecationLogger(LogManager.getLogger(DynamicMap.class));\n-    private static final Map<String, Function<Object, Object>> FUNCTIONS = Map.of(\n+    private static final Map<String, Function<Object, Object>> PARAMS_FUNCTIONS = Map.of(\n             \"doc\", value -> {\n                 deprecationLogger.deprecatedAndMaybeLog(\"sort-script_doc\",\n                         \"Accessing variable [doc] via [params.doc] from within an sort-script \"\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5OTAwOA==", "url": "https://github.com/elastic/elasticsearch/pull/56149#discussion_r419799008", "bodyText": "Could you please add a brief javadoc explaining what this class is?", "author": "rjernst", "createdAt": "2020-05-05T00:09:09Z", "path": "server/src/main/java/org/elasticsearch/script/DynamicMap.java", "diffHunk": "@@ -19,28 +19,20 @@\n \n package org.elasticsearch.script;\n \n-import org.apache.logging.log4j.LogManager;\n-import org.elasticsearch.common.logging.DeprecationLogger;\n-\n import java.util.Collection;\n import java.util.Map;\n import java.util.Set;\n+import java.util.function.Function;\n \n-public final class DeprecationMap implements Map<String, Object> {\n-\n-    private static final DeprecationLogger deprecationLogger =\n-        new DeprecationLogger(LogManager.getLogger(DeprecationMap.class));\n+public final class DynamicMap implements Map<String, Object> {", "originalCommit": "1a6bad076073b0e8dcc9de5f44cd2994be7caa5a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIzNzA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/56149#discussion_r420237050", "bodyText": "Added.", "author": "jdconrad", "createdAt": "2020-05-05T16:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5OTAwOA=="}], "type": "inlineReview", "revised_code": {"commit": "f91cadfc80286540750da3943b476a6066d532e3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/script/DynamicMap.java b/server/src/main/java/org/elasticsearch/script/DynamicMap.java\nindex 523477260f5..30dc6147072 100644\n--- a/server/src/main/java/org/elasticsearch/script/DynamicMap.java\n+++ b/server/src/main/java/org/elasticsearch/script/DynamicMap.java\n\n@@ -24,6 +24,12 @@ import java.util.Map;\n import java.util.Set;\n import java.util.function.Function;\n \n+/**\n+ * DynamicMap is used to wrap a Map for a script parameter. A set of\n+ * functions is provided for the overridden values where the function\n+ * is applied to the existing value when one exists for the\n+ * corresponding key.\n+ */\n public final class DynamicMap implements Map<String, Object> {\n \n     private final Map<String, Object> delegate;\n"}}, {"oid": "f91cadfc80286540750da3943b476a6066d532e3", "url": "https://github.com/elastic/elasticsearch/commit/f91cadfc80286540750da3943b476a6066d532e3", "message": "response to pr comments", "committedDate": "2020-05-05T16:34:01Z", "type": "commit"}, {"oid": "a9b16133c94abdde86e2d20b1927b29780dec47f", "url": "https://github.com/elastic/elasticsearch/commit/a9b16133c94abdde86e2d20b1927b29780dec47f", "message": "Merge branch 'master' into dynamicmap", "committedDate": "2020-05-05T17:54:56Z", "type": "commit"}]}