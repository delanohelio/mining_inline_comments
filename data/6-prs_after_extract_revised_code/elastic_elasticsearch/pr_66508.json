{"pr_number": 66508, "pr_title": "Make the construction of alias abstractions immutable", "pr_createdAt": "2020-12-17T11:08:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66508", "timeline": [{"oid": "e4596b4b63f8a02b67476717621aac307751a0e6", "url": "https://github.com/elastic/elasticsearch/commit/e4596b4b63f8a02b67476717621aac307751a0e6", "message": "Make the construction of alias abstractions immutable\nand change validation to be an implementation detail and\npart of construction of the alias abstraction.\n\nThis change is part of series of changes to clean up the usage\nIndexAbstraction.Alias in the codebase, so that it is no longer\nneeded to cast to IndexAbstraction.Alias and just use the methods\non the IndexAbstraction interface. This should help adding data\nstream aliases, so that IndexAbstraction instances of type ALIAS\ncan also be data stream aliases.\n\nRelates to #66163", "committedDate": "2020-12-17T14:41:16Z", "type": "commit"}, {"oid": "e4596b4b63f8a02b67476717621aac307751a0e6", "url": "https://github.com/elastic/elasticsearch/commit/e4596b4b63f8a02b67476717621aac307751a0e6", "message": "Make the construction of alias abstractions immutable\nand change validation to be an implementation detail and\npart of construction of the alias abstraction.\n\nThis change is part of series of changes to clean up the usage\nIndexAbstraction.Alias in the codebase, so that it is no longer\nneeded to cast to IndexAbstraction.Alias and just use the methods\non the IndexAbstraction interface. This should help adding data\nstream aliases, so that IndexAbstraction instances of type ALIAS\ncan also be data stream aliases.\n\nRelates to #66163", "committedDate": "2020-12-17T14:41:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0MzA3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66508#discussion_r546143072", "bodyText": "I didn't follow this case where the write index is set? It seems to me like it could incorrectly match the scenario when there is a single index for the alias but the index has not been specified as the write index for the alias.", "author": "danhermann", "createdAt": "2020-12-18T23:21:53Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -178,14 +176,35 @@ public boolean isSystem() {\n \n         private final String aliasName;\n         private final List<IndexMetadata> referenceIndexMetadatas;\n-        private final SetOnce<IndexMetadata> writeIndex = new SetOnce<>();\n+        private final IndexMetadata writeIndex;\n         private final boolean isHidden;\n \n-        public Alias(AliasMetadata aliasMetadata, IndexMetadata indexMetadata) {\n+        public Alias(AliasMetadata aliasMetadata, List<IndexMetadata> indices) {\n             this.aliasName = aliasMetadata.getAlias();\n-            this.referenceIndexMetadatas = new ArrayList<>();\n-            this.referenceIndexMetadatas.add(indexMetadata);\n+            this.referenceIndexMetadatas = indices;\n+\n+            List<IndexMetadata> writeIndices = indices.stream()\n+                .filter(idxMeta -> Boolean.TRUE.equals(idxMeta.getAliases().get(aliasName).writeIndex()))\n+                .collect(Collectors.toList());\n+\n+            if (writeIndices.isEmpty() && referenceIndexMetadatas.size() == 1\n+                && referenceIndexMetadatas.get(0).getAliases().get(aliasName).writeIndex() == null) {\n+                writeIndices.add(referenceIndexMetadatas.get(0));\n+            }", "originalCommit": "e4596b4b63f8a02b67476717621aac307751a0e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE5NTk2MA==", "url": "https://github.com/elastic/elasticsearch/pull/66508#discussion_r551195960", "bodyText": "I was unaware of this logic too, but if an alias points to a single index then that index is always the write index even if it hasn't been marked as write index. I moved this logic from the computeAndValidateAliasProperties() method. I initially also wondered whether this if statement was needed, and didn't move it from the computeAndValidateAliasProperties() method, however many tests failed and after moving the if statement the build completed successfully.", "author": "martijnvg", "createdAt": "2021-01-04T09:18:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0MzA3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTMxODM2MA==", "url": "https://github.com/elastic/elasticsearch/pull/66508#discussion_r551318360", "bodyText": "Ah, good to know. In that case, everything else LGTM.", "author": "danhermann", "createdAt": "2021-01-04T13:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0MzA3Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "2b52de132d83b17f27bbad9d434ac46db572df27", "url": "https://github.com/elastic/elasticsearch/commit/2b52de132d83b17f27bbad9d434ac46db572df27", "message": "Merge branch 'master' into hide_alias_validation", "committedDate": "2021-01-05T08:59:20Z", "type": "commit"}, {"oid": "7b0e4b8f5e73dce5494e24cbc8e7647629be90bc", "url": "https://github.com/elastic/elasticsearch/commit/7b0e4b8f5e73dce5494e24cbc8e7647629be90bc", "message": "Merge branch 'master' into hide_alias_validation", "committedDate": "2021-01-05T16:12:32Z", "type": "commit"}]}