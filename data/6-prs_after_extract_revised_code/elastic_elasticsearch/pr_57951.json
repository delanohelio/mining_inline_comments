{"pr_number": 57951, "pr_title": "Correct how meta-field is defined for pre 7.8 hits", "pr_createdAt": "2020-06-10T21:23:09Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57951", "timeline": [{"oid": "8cd058b351381333fa121efa25974c73458f8491", "url": "https://github.com/elastic/elasticsearch/commit/8cd058b351381333fa121efa25974c73458f8491", "message": "Correct how meta-field is defined for pre 7.8 hits\n\nWe keep a static list of meta-fields: META_FIELDS_BEFORE_7_8\nas it was before.\nThis is done to ensure the backwards compatability with pre 7.8 nodes.\n\nCloses #57831", "committedDate": "2020-06-10T21:19:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYxNTk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438615979", "bodyText": "If I remember correctly we only use isMetadataFieldStatic in a few places now where we read from older nodes. Should we simply make the collection public and remove the static method? Or rename method to something like \"isMetaFieldBefore7dot8\" or something, just to improve readability in the locations where this it is actually used.", "author": "cbuescher", "createdAt": "2020-06-11T08:11:08Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -813,11 +818,7 @@ public void close() throws IOException {\n      */\n     @Deprecated\n     public static boolean isMetadataFieldStatic(String fieldName) {\n-        if (IndicesModule.getBuiltInMetadataFields().contains(fieldName)) {\n-            return true;\n-        }\n-        // if a node had Size Plugin installed, _size field should also be considered a meta-field\n-        return fieldName.equals(\"_size\");\n+        return META_FIELDS_BEFORE_7_8.contains(fieldName);", "originalCommit": "8cd058b351381333fa121efa25974c73458f8491", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc1MTYyNA==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438751624", "bodyText": "@cbuescher Thanks for the feedback! I have removed isMetadataFieldStatic method, and made the collection public.", "author": "mayya-sharipova", "createdAt": "2020-06-11T12:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYxNTk3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "44add125cbff5b57dd93b688f3c461b36efe9923", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\nindex 4fe9f0f2e8e0..e419abf1d643 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n\n@@ -809,18 +809,6 @@ public class MapperService extends AbstractIndexComponent implements Closeable {\n         indexAnalyzers.close();\n     }\n \n-    /**\n-     * @return Whether a field is a metadata field\n-     * Deserialization of SearchHit objects sent from pre 7.8 nodes and GetResults objects sent from pre 7.3 nodes,\n-     * uses this method to divide fields into meta and document fields.\n-     * TODO: remove in v 9.0\n-     * @deprecated  Use an instance method isMetadataField instead\n-     */\n-    @Deprecated\n-    public static boolean isMetadataFieldStatic(String fieldName) {\n-        return META_FIELDS_BEFORE_7_8.contains(fieldName);\n-    }\n-\n     /**\n      * @return Whether a field is a metadata field.\n      * this method considers all mapper plugins\n"}}, {"oid": "44add125cbff5b57dd93b688f3c461b36efe9923", "url": "https://github.com/elastic/elasticsearch/commit/44add125cbff5b57dd93b688f3c461b36efe9923", "message": "Address Chrishoph's feedback", "committedDate": "2020-06-11T12:38:12Z", "type": "commit"}, {"oid": "7eadf78be25c5952c8187ff130a75f6ed69446c6", "url": "https://github.com/elastic/elasticsearch/commit/7eadf78be25c5952c8187ff130a75f6ed69446c6", "message": "Ensure that META_FIELDS_BEFORE_7DOT8 is used to create test hit instances\n\nSearchHitsTests.testSerializationPre6_6_0 will fail\nif you use different meta-fields that were before", "committedDate": "2020-06-11T13:47:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438814226", "bodyText": "Just as a last question: why is this necessary? I though the \"old\" collection of meta field names is only used when reading from \"old\" nodes? Why can't we use all built-in fields here since we're already on master?", "author": "cbuescher", "createdAt": "2020-06-11T14:08:04Z", "path": "server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java", "diffHunk": "@@ -106,7 +106,7 @@ private static DocumentField mutateDocumentField(DocumentField documentField) {\n             Predicate<String> excludeMetaFieldFilter) {\n         if (isMetafield) {\n             String metaField = randomValueOtherThanMany(excludeMetaFieldFilter,\n-                () -> randomFrom(IndicesModule.getBuiltInMetadataFields()));\n+                () -> randomFrom(MapperService.META_FIELDS_BEFORE_7DOT8));", "originalCommit": "7eadf78be25c5952c8187ff130a75f6ed69446c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMTIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438831211", "bodyText": "@cbuescher I am struggling with BWC tests here, and I am not sure about the best approach.\nSearchHitsTests.testSerializationPre6_6_0 tests was failing if we use IndicesModule.getBuiltInMetadataFields().\nIn this test we create a test SearchHit instance in 7.x and then do wire serialization to pre6_6 node and deserialization from it, and then assert that 7.x instance is equal to the deserialized instance from 6.x.  The test was failing if we use IndicesModule.getBuiltInMetadataFields() and include _fied_names as a meta-field in the created test instance.   As now during deserialization from pre 7.8 nodes we use META_FIELDS_BEFORE_7DOT8 to decide if a field is meta-field, we put _field_names under document fields, which will not be equal to the original created test instance, where _field_names is under meta-fields.\nProbably, the best approach would be to separate how we create test instances of SearchHit between pre 7.8 nodes and after 7.8 nodes.  What do you think?", "author": "mayya-sharipova", "createdAt": "2020-06-11T14:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MjM3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438852377", "bodyText": "Are those particular tests needed on 7.x anymore? As far as I understand we'd never see a pre 6.6 node in a cluster running any 7x release at this point, 6.8 should be the last supported version? Maybe we can delete the test? I wonder if this uncovers other kinds of edge cases with the change though, so I'd prefer if we can sample \"meta\" fields from the \"true\" source (IndicesModule.getBuiltInMetadataFields()) and only fix tests where we need a specific pre-7.8 behaviour if really needed.\nMabye @javanna knows if SearchHitsTests.testSerializationPre6_6_0 can be removed since he added it way back...", "author": "cbuescher", "createdAt": "2020-06-11T15:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg5OTI3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438899278", "bodyText": "#36555 I guess the test (actually two tests) can be removed from 7.x given that 7.x nodes will never talk to pre 6.6 nodes.", "author": "javanna", "createdAt": "2020-06-11T16:00:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkxNzAxNA==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r438917014", "bodyText": "@javanna Thanks, this would simplify things", "author": "mayya-sharipova", "createdAt": "2020-06-11T16:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM5MzEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/57951#discussion_r439393132", "bodyText": "@cbuescher Thanks for your suggestions. I have removed *pre6_6_0 tests, and also brought back IndicesModule.getBuiltInMetadataFields() for defining meta-fields in test items.", "author": "mayya-sharipova", "createdAt": "2020-06-12T12:39:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgxNDIyNg=="}], "type": "inlineReview", "revised_code": {"commit": "d3c839fb353d2b3bf38b0c362248fc375d92199b", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java b/server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java\nindex 4ed38a61d82c..691f0ed9de14 100644\n--- a/server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/get/DocumentFieldTests.java\n\n@@ -106,7 +106,7 @@ public class DocumentFieldTests extends ESTestCase {\n             Predicate<String> excludeMetaFieldFilter) {\n         if (isMetafield) {\n             String metaField = randomValueOtherThanMany(excludeMetaFieldFilter,\n-                () -> randomFrom(MapperService.META_FIELDS_BEFORE_7DOT8));\n+                () -> randomFrom(IndicesModule.getBuiltInMetadataFields()));\n             DocumentField documentField;\n             if (metaField.equals(IgnoredFieldMapper.NAME)) {\n                 int numValues = randomIntBetween(1, 3);\n"}}, {"oid": "d3c839fb353d2b3bf38b0c362248fc375d92199b", "url": "https://github.com/elastic/elasticsearch/commit/d3c839fb353d2b3bf38b0c362248fc375d92199b", "message": "Remove pre 6.6 tests", "committedDate": "2020-06-12T12:31:47Z", "type": "commit"}]}