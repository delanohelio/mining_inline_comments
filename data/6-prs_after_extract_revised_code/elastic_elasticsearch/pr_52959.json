{"pr_number": 52959, "pr_title": "[ML] Fixing datafeed bwc tests", "pr_createdAt": "2020-02-28T16:11:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52959", "timeline": [{"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "url": "https://github.com/elastic/elasticsearch/commit/b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "message": "[ML] Fixing datafeed bwc tests", "committedDate": "2020-02-28T16:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385786797", "bodyText": "@nik9000 Since you wrote the original logic, thought I would ping you.\nThis allows for the same warning to be mentioned multiple times in the headers. This is required for ML since there are times when a warning appears more than once.\nThe number of times a warning appears is non-deterministic in multi-node tests.\nThis is because for ML we occasionally need to route to specific nodes (e.g. to a master node) and warnings can appear on parsing XContent and on serializing between nodes.", "author": "benwtrent", "createdAt": "2020-02-28T16:16:36Z", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -307,16 +310,20 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n                      * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n                      * mixed-version tests that used typed APIs.\n                      */\n-                } else if (expected.remove(message) == false) {\n+                } else if (expected.contains(message) == false) {", "originalCommit": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385789796", "bodyText": "Also, this PR is against 7.x. If approved and merged, I am going to forward-port this change.", "author": "benwtrent", "createdAt": "2020-02-28T16:22:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNDk2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387724962", "bodyText": "I'm weary to change this behavior, though I admit the error message that you get with duplicate warning ain't great. I think for the most part we want to assert that you get exactly the warnings that you specify back. Emitting duplicate warnings feels a little like a bug to me.", "author": "nik9000", "createdAt": "2020-03-04T15:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4NjIzNg==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387786236", "bodyText": "@nik9000 the issue is because the warning is added via different nodes. One is when the object is deserialized via XContent. The other is when it is streamed across to another node:\nWARNING: request [PUT http://[::1]:59141/_ml/datafeeds/mixed-cluster-datafeed-with-aggs?error_trace=true] returned 2 warnings:\n[299 Elasticsearch-7.4.0-22e1767283e61a198cb4db791ea66e3f11ab9910 \"[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.\"],\n[299 Elasticsearch-7.7.0-SNAPSHOT-ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e \"[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.\"]\n\nI am not sure how to prevent this as they are different thread contexts altogether.", "author": "benwtrent", "createdAt": "2020-03-04T16:32:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc4ODk5OA==", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387788998", "bodyText": "\ud83d\udc4d I filed #53123. I'll see about making an \"allowed warnings\".", "author": "nik9000", "createdAt": "2020-03-04T16:36:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b9962f8b520d2601daf28d66669ca747ff8c9e66", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java b/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java\nindex 3af11a3b37f..3227af079bd 100644\n--- a/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java\n+++ b/test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java\n\n@@ -304,26 +340,26 @@ public class DoSection implements ExecutableSection {\n                      * This warning header will come back in the vast majority of our tests that create an index when running against an\n                      * older master. Rather than rewrite our tests to assert this warning header, we assume that it is expected.\n                      */\n-                } else // noinspection StatementWithEmptyBody\n-                    if (message.startsWith(\"[types removal]\") || message.startsWith(\"[_data_frame/transforms/] is deprecated\")) {\n-                    /*\n-                     * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n-                     * mixed-version tests that used typed APIs.\n-                     */\n-                } else if (expected.contains(message) == false) {\n-                    unexpected.add(header);\n-                } else {\n-                    seen.add(message);\n+                    continue;\n+                }\n+                if (message.startsWith(\"[types removal]\")) {\n+                    // We skip warnings related to types deprecation because they are *everywhere*.\n+                    continue;\n+                }\n+                if (allowed.contains(message)) {\n+                    continue;\n                 }\n+                if (expected.remove(message)) {\n+                    continue;\n+                }\n+                unexpected.add(header);\n             } else {\n                 unmatched.add(header);\n             }\n         }\n-        if (seen.size() != expected.size()) {\n+        if (expected.isEmpty() == false) {\n             for (final String header : expected) {\n-                if (seen.contains(header) == false) {\n-                    missing.add(header);\n-                }\n+                missing.add(header);\n             }\n         }\n \n"}}, {"oid": "ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "url": "https://github.com/elastic/elasticsearch/commit/ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "message": "removing unused import", "committedDate": "2020-02-28T16:22:58Z", "type": "commit"}, {"oid": "b9962f8b520d2601daf28d66669ca747ff8c9e66", "url": "https://github.com/elastic/elasticsearch/commit/b9962f8b520d2601daf28d66669ca747ff8c9e66", "message": "reverting some changes", "committedDate": "2020-03-06T13:52:47Z", "type": "commit"}, {"oid": "8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "url": "https://github.com/elastic/elasticsearch/commit/8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "message": "Merge remote-tracking branch 'upstream/7.x' into tests/datafeed-bwc-tests", "committedDate": "2020-03-06T13:52:53Z", "type": "commit"}, {"oid": "44f43aefd468a45902bb85f9c3a0644adf68eba8", "url": "https://github.com/elastic/elasticsearch/commit/44f43aefd468a45902bb85f9c3a0644adf68eba8", "message": "using new allowed_warnings setting", "committedDate": "2020-03-06T14:00:33Z", "type": "commit"}, {"oid": "94007a5c2c2e0405cbfa4b279cd317a94c3db319", "url": "https://github.com/elastic/elasticsearch/commit/94007a5c2c2e0405cbfa4b279cd317a94c3db319", "message": "reverting needless changes", "committedDate": "2020-03-06T14:09:01Z", "type": "commit"}, {"oid": "c0bc3369b86e5e376762e714dc36447ad52d6638", "url": "https://github.com/elastic/elasticsearch/commit/c0bc3369b86e5e376762e714dc36447ad52d6638", "message": "allowing warnings in updated cluster tests", "committedDate": "2020-03-06T14:25:27Z", "type": "commit"}]}