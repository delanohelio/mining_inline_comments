{"pr_number": 57739, "pr_title": "Compatible Api warnings logging", "pr_createdAt": "2020-06-05T14:55:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57739", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436619458", "bodyText": "can't remember what we agreed. Do we throttle compatible API logs?", "author": "pgomulka", "createdAt": "2020-06-08T11:10:27Z", "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -79,12 +81,20 @@ public DeprecationLoggerBuilder deprecate(final String key, final String msg, fi\n \n     public class DeprecationLoggerBuilder {\n \n-        public DeprecationLoggerBuilder withDeprecation(String key, String msg, Object[] params) {\n+        public DeprecationLoggerBuilder withDeprecation(String key, String msg, Object... params) {\n             String opaqueId = HeaderWarning.getXOpaqueId();\n             ESLogMessage deprecationMessage = DeprecatedMessage.of(opaqueId, msg, params);\n             deprecationLogger.throttleLogAndAddWarning(key, deprecationMessage);\n             return this;\n         }\n \n+        public DeprecationLoggerBuilder compatibleApiWarning(String key, String msg, Object... params) {\n+            String opaqueId = HeaderWarning.getXOpaqueId();\n+            ESLogMessage deprecationMessage = DeprecatedMessage.compatibleDeprecationMessage(opaqueId, msg, params);\n+            compatibleLogger.throttleLogAndAddWarning(key, deprecationMessage);", "originalCommit": "5f428f7d90a7d2218da47560d6d0b35f028ed27f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcyMTM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436721340", "bodyText": "yes throttled, however, I think the they key needs to be more contextual. i.e. rather then just a \"get_with_types\" key, it needs to be the actual resolved message emitted, which should include the per request elements such as the path parameters. Which means that it will have ALOT more cache misses and may want to separate the backing cache store from the deprecation logger.", "author": "jakelandis", "createdAt": "2020-06-08T13:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwOTM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r440109388", "bodyText": "agree. We could either create a second cache (same LRU set) or just expand it to make it bigger. Not sure we could make the size of that cache configurable. This would allow users to estimate how many x-opaque-id unique users will they have (we would then multiply that number by number of compatible APIs we have).\nWhen it comes to the key itself, and if we want to use StackWalker we need to make sure this is properly abstracted so that it won't be accidentally back ported to 7.x where jdk 1.8 is still supported.\nI guess for the time being we could simply just resolve the formatted message as you suggest.", "author": "pgomulka", "createdAt": "2020-06-15T11:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI2NzIyMA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r440267220", "bodyText": "for the record. We discussed this as I was concerned that expanding path parameters into logs would make throttling not be as effective. Every log line with a key containing a different type would not throttle.\nHowever there is a plus side to this - a user might easier identify places in his codebase where he uses that type. For instance if his app has that type \"hardcoded\" somewhere.\nWe are considering if we could have a debug level log line with exact path like myIndex/myType/ and a warn level with a path being in a form of {index}/{type}\nFor the time being we will stay with the more verbose expanded version and will revisit if this becomes a problem", "author": "pgomulka", "createdAt": "2020-06-15T15:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYzNzcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r440637729", "bodyText": "I am still not sure on logs where an id will be used. For this kind of endpoints there would be far too many logs. i.e. /{index}/{type}/{id}", "author": "pgomulka", "createdAt": "2020-06-16T07:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "a5693adb252ad080734e0d0d9783ba1bb78d5fba", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\nindex 06a44564221..72491a711f6 100644\n--- a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n+++ b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n\n@@ -46,55 +61,52 @@ public class DeprecationLogger {\n      * it replaces \"org.elasticsearch\" with \"org.elasticsearch.deprecation\" to maintain\n      * the \"org.elasticsearch\" namespace.\n      */\n-    public DeprecationLogger(Logger parentLogger) {\n-        deprecationLogger = new ThrottlingAndHeaderWarningLogger(loggerName(parentLogger, \"deprecation\"));\n-        compatibleLogger = new ThrottlingAndHeaderWarningLogger(loggerName(parentLogger, \"compatible\"));\n+    public static DeprecationLogger getLogger(String name) {\n+        return new DeprecationLogger(name);\n     }\n \n-    private static Logger loggerName(Logger parentLogger, String prefix) {\n-        String name = parentLogger.getName();\n+    private DeprecationLogger(String parentLoggerName) {\n+        this.logger = LogManager.getLogger(getLoggerName(parentLoggerName,\"deprecation\"));\n+        this.compatibleLogger = LogManager.getLogger(getLoggerName(parentLoggerName,\"compatible\"));\n+    }\n+\n+    private static String getLoggerName(String name, String prefix) {\n         if (name.startsWith(\"org.elasticsearch\")) {\n-            name = name.replace(\"org.elasticsearch.\", \"org.elasticsearch.\" + prefix + \".\");\n+            name = name.replace(\"org.elasticsearch.\", \"org.elasticsearch.\"+prefix+\".\");\n         } else {\n-            name = prefix + \".\" + name;\n+            name = prefix +\".\"+ name;\n         }\n-        return LogManager.getLogger(name);\n+        return name;\n     }\n \n-    public static void setThreadContext(ThreadContext threadContext) {\n-        HeaderWarning.setThreadContext(threadContext);\n-    }\n-\n-    public static void removeThreadContext(ThreadContext threadContext) {\n-        HeaderWarning.removeThreadContext(threadContext);\n+    private static String toLoggerName(final Class<?> cls) {\n+        String canonicalName = cls.getCanonicalName();\n+        return canonicalName != null ? canonicalName : cls.getName();\n     }\n \n     /**\n-     * Logs a deprecation message, adding a formatted warning message as a response header on the thread context.\n-     * The deprecation message will be throttled to deprecation log.\n-     * method returns a builder as more methods are expected to be chained.\n+     * Logs a message at the {@link #DEPRECATION} level. The message is also sent to the header warning logger,\n+     * so that it can be returned to the client.\n      */\n     public DeprecationLoggerBuilder deprecate(final String key, final String msg, final Object... params) {\n-        return new DeprecationLoggerBuilder()\n-            .withDeprecation(key, msg, params);\n+        return new DeprecationLoggerBuilder().withDeprecation(key, msg, params);\n     }\n \n     public class DeprecationLoggerBuilder {\n \n         public DeprecationLoggerBuilder withDeprecation(String key, String msg, Object... params) {\n-            String opaqueId = HeaderWarning.getXOpaqueId();\n-            ESLogMessage deprecationMessage = DeprecatedMessage.of(opaqueId, msg, params);\n-            deprecationLogger.throttleLogAndAddWarning(key, deprecationMessage);\n+            ESLogMessage deprecationMessage = DeprecatedMessage.of(key, HeaderWarning.getXOpaqueId(), msg, params);\n+\n+            logger.log(DEPRECATION, deprecationMessage);\n+\n             return this;\n         }\n \n         public DeprecationLoggerBuilder compatibleApiWarning(String key, String msg, Object... params) {\n             String opaqueId = HeaderWarning.getXOpaqueId();\n-            ESLogMessage deprecationMessage = DeprecatedMessage.compatibleDeprecationMessage(opaqueId, msg, params);\n-            compatibleLogger.throttleLogAndAddWarning(key, deprecationMessage);\n+            ESLogMessage deprecationMessage = DeprecatedMessage.compatibleDeprecationMessage(key, opaqueId, msg, params);\n+            compatibleLogger.log(DEPRECATION, deprecationMessage);\n             return this;\n         }\n-\n-\n     }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMjE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436632169", "bodyText": "I wonder if we should allow anything like this where a deprecation logger is fetched by name\n        final Logger testLogger = LogManager.getLogger(\"deprecation.test\");\nand used without DeprecationLogger and DeprecationMessage class", "author": "pgomulka", "createdAt": "2020-06-08T11:39:28Z", "path": "qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java", "diffHunk": "@@ -172,7 +172,7 @@ public void testDeprecatedMessageWithoutXOpaqueId() throws IOException {\n         testLogger.info( DeprecatedMessage.of(\"someId\",\"deprecated message1\"));\n         testLogger.info( DeprecatedMessage.of(\"\",\"deprecated message2\"));\n         testLogger.info( DeprecatedMessage.of(null,\"deprecated message3\"));\n-        testLogger.info(\"deprecated message4\");\n+//        testLogger.info(\"deprecated message4\");", "originalCommit": "5f428f7d90a7d2218da47560d6d0b35f028ed27f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a5693adb252ad080734e0d0d9783ba1bb78d5fba", "chunk": "diff --git a/qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java b/qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java\nindex 4fae1fe4a78..6040dc3c223 100644\n--- a/qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java\n+++ b/qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java\n\n@@ -168,14 +222,17 @@ public class JsonLoggerTests extends ESTestCase {\n \n \n     public void testDeprecatedMessageWithoutXOpaqueId() throws IOException {\n-        final Logger testLogger = LogManager.getLogger(\"deprecation.test\");\n-        testLogger.info( DeprecatedMessage.of(\"someId\",\"deprecated message1\"));\n-        testLogger.info( DeprecatedMessage.of(\"\",\"deprecated message2\"));\n-        testLogger.info( DeprecatedMessage.of(null,\"deprecated message3\"));\n-//        testLogger.info(\"deprecated message4\");\n+        final DeprecationLogger testLogger = DeprecationLogger.getLogger(\"test\");\n+\n+        testLogger.deprecate(\"a key\", \"deprecated message1\");\n+\n+        // Also test that a message sent directly to the logger comes through\n+        final Logger rawLogger = LogManager.getLogger(\"deprecation.test\");\n+        rawLogger.log(DEPRECATION, \"deprecated message2\");\n \n         final Path path = PathUtils.get(System.getProperty(\"es.logs.base_path\"),\n             System.getProperty(\"es.logs.cluster_name\") + \"_deprecated.json\");\n+\n         try (Stream<Map<String, String>> stream = JsonLogsStream.mapStreamFrom(path)) {\n             List<Map<String, String>> jsonLogs = stream\n                 .collect(Collectors.toList());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxNjk2OA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436716968", "bodyText": "Can this (and all other compatible warnings) be a past tense message that explains that what compatibly did ?\nFor this one...something like:\nHTTP compatibility was applied to this request. The GET request for /<index-name>/<type-name>/<id> was mapped to /<index-name>/_doc/<id>. \n\nWhere the actual index-name, type, and id are emitted to the log.", "author": "jakelandis", "createdAt": "2020-06-08T13:48:44Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestGetActionV7.java", "diffHunk": "@@ -33,10 +33,11 @@\n import static org.elasticsearch.rest.RestRequest.Method.HEAD;\n \n public class RestGetActionV7 extends RestGetAction {\n-\n-    private static final DeprecationLogger deprecationLogger = new DeprecationLogger(LogManager.getLogger(RestGetAction.class));\n     static final String TYPES_DEPRECATION_MESSAGE = \"[types removal] Specifying types in \"\n         + \"document get requests is deprecated, use the /{index}/_doc/{id} endpoint instead.\";\n+    static final String TYPED_API_COMPATIBLE_WARNING = \"Using typed version of Get API. Use /{index}/_doc/{id} instead.\";", "originalCommit": "f267c43a64a30a8cf59044905ed8f9fcf8c1360b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a5693adb252ad080734e0d0d9783ba1bb78d5fba", "chunk": "diff --git a/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestGetActionV7.java b/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestGetActionV7.java\ndeleted file mode 100644\nindex 204a5a286a9..00000000000\n--- a/modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestGetActionV7.java\n+++ /dev/null\n\n@@ -1,64 +0,0 @@\n-/*\n- * Licensed to Elasticsearch under one or more contributor\n- * license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright\n- * ownership. Elasticsearch licenses this file to you under\n- * the Apache License, Version 2.0 (the \"License\"); you may\n- * not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.elasticsearch.rest.compat.version7;\n-\n-import org.apache.logging.log4j.LogManager;\n-import org.elasticsearch.Version;\n-import org.elasticsearch.client.node.NodeClient;\n-import org.elasticsearch.common.logging.DeprecationLogger;\n-import org.elasticsearch.rest.RestRequest;\n-import org.elasticsearch.rest.action.document.RestGetAction;\n-\n-import java.io.IOException;\n-import java.util.List;\n-\n-import static org.elasticsearch.rest.RestRequest.Method.GET;\n-import static org.elasticsearch.rest.RestRequest.Method.HEAD;\n-\n-public class RestGetActionV7 extends RestGetAction {\n-    static final String TYPES_DEPRECATION_MESSAGE = \"[types removal] Specifying types in \"\n-        + \"document get requests is deprecated, use the /{index}/_doc/{id} endpoint instead.\";\n-    static final String TYPED_API_COMPATIBLE_WARNING = \"Using typed version of Get API. Use /{index}/_doc/{id} instead.\";\n-\n-    private static final DeprecationLogger deprecationLogger = new DeprecationLogger(LogManager.getLogger(RestGetAction.class));\n-\n-    @Override\n-    public String getName() {\n-        return \"document_get_action_v7\";\n-    }\n-\n-    @Override\n-    public List<Route> routes() {\n-        return List.of(new Route(GET, \"/{index}/{type}/{id}\"), new Route(HEAD, \"/{index}/{type}/{id}\"));\n-    }\n-\n-    @Override\n-    public RestChannelConsumer prepareRequest(RestRequest request, final NodeClient client) throws IOException {\n-        deprecationLogger.deprecate(\"get_with_types\", TYPES_DEPRECATION_MESSAGE)\n-            .compatibleApiWarning(\"get_with_types\", TYPED_API_COMPATIBLE_WARNING);\n-        request.param(\"type\");\n-        return super.prepareRequest(request, client);\n-    }\n-\n-    @Override\n-    public Version compatibleWithVersion() {\n-        return Version.V_7_0_0;\n-    }\n-}\n"}}, {"oid": "a5693adb252ad080734e0d0d9783ba1bb78d5fba", "url": "https://github.com/elastic/elasticsearch/commit/a5693adb252ad080734e0d0d9783ba1bb78d5fba", "message": "working", "committedDate": "2020-09-09T09:57:20Z", "type": "forcePushed"}, {"oid": "684105c10260680250e9cd405fc2925f6824d42c", "url": "https://github.com/elastic/elasticsearch/commit/684105c10260680250e9cd405fc2925f6824d42c", "message": "draft\n\nworking\n\nremove test code", "committedDate": "2021-02-02T13:40:12Z", "type": "commit"}, {"oid": "032207a2ccc791d8e40f27b2b0c43ffca0589f63", "url": "https://github.com/elastic/elasticsearch/commit/032207a2ccc791d8e40f27b2b0c43ffca0589f63", "message": "remove the fluent builder, deprecatio ncategory", "committedDate": "2021-02-02T15:50:31Z", "type": "commit"}, {"oid": "032207a2ccc791d8e40f27b2b0c43ffca0589f63", "url": "https://github.com/elastic/elasticsearch/commit/032207a2ccc791d8e40f27b2b0c43ffca0589f63", "message": "remove the fluent builder, deprecatio ncategory", "committedDate": "2021-02-02T15:50:31Z", "type": "forcePushed"}, {"oid": "5245263ff1f8b07ad5bb32d89553331b2032d955", "url": "https://github.com/elastic/elasticsearch/commit/5245263ff1f8b07ad5bb32d89553331b2032d955", "message": "line length", "committedDate": "2021-02-03T08:09:21Z", "type": "commit"}, {"oid": "081d95d0a0b1ae2871b87e603e72d24bac868a63", "url": "https://github.com/elastic/elasticsearch/commit/081d95d0a0b1ae2871b87e603e72d24bac868a63", "message": "make data_stream.dataset not hardcoded", "committedDate": "2021-02-04T13:36:09Z", "type": "commit"}, {"oid": "eefca46fc5c1f2148db375df6ff61cbe106c59cd", "url": "https://github.com/elastic/elasticsearch/commit/eefca46fc5c1f2148db375df6ff61cbe106c59cd", "message": "remove dataset from indexing deprecation logs", "committedDate": "2021-02-04T14:50:19Z", "type": "commit"}, {"oid": "2fd2c699d2f476e4a2c3ed485511d67caa586ced", "url": "https://github.com/elastic/elasticsearch/commit/2fd2c699d2f476e4a2c3ed485511d67caa586ced", "message": "make datastream field always the same for deprecation logs", "committedDate": "2021-02-04T15:07:35Z", "type": "commit"}, {"oid": "f95a11ee663f98b034f2ba1b86c3d53e91db7cd8", "url": "https://github.com/elastic/elasticsearch/commit/f95a11ee663f98b034f2ba1b86c3d53e91db7cd8", "message": " headers", "committedDate": "2021-02-04T15:22:40Z", "type": "commit"}, {"oid": "fa4f4acba07b47276f4e9d78e77bf1c1377021a5", "url": "https://github.com/elastic/elasticsearch/commit/fa4f4acba07b47276f4e9d78e77bf1c1377021a5", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger", "committedDate": "2021-02-04T15:23:02Z", "type": "commit"}, {"oid": "b11825f44dc39ae51753fa32dba0eb79afc8d2a5", "url": "https://github.com/elastic/elasticsearch/commit/b11825f44dc39ae51753fa32dba0eb79afc8d2a5", "message": "cleanup and comment", "committedDate": "2021-02-04T15:53:06Z", "type": "commit"}, {"oid": "84f5c862782f65f8a71f37c3ef005af3b45f1e9c", "url": "https://github.com/elastic/elasticsearch/commit/84f5c862782f65f8a71f37c3ef005af3b45f1e9c", "message": "empty line remove", "committedDate": "2021-02-04T15:57:24Z", "type": "commit"}, {"oid": "6e47e3a649f2369606ca2097c4ef0ab6a54549f0", "url": "https://github.com/elastic/elasticsearch/commit/6e47e3a649f2369606ca2097c4ef0ab6a54549f0", "message": "test indexing compatible logs", "committedDate": "2021-02-04T16:52:01Z", "type": "commit"}, {"oid": "7f64a849db60a6512d5b6c3e74252d4a2ae44668", "url": "https://github.com/elastic/elasticsearch/commit/7f64a849db60a6512d5b6c3e74252d4a2ae44668", "message": "codestyle", "committedDate": "2021-02-04T17:01:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5MzI0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r570393249", "bodyText": "we always create two loggers when using deprecationLogger. But often it won't be necessary. I wonder what is the performance penalty.\nWe could create a CompatibleLogger that would inherit DeprecationLogger and would allow to create two loggers and would have two logging methods compatibleApiWarning and deprecate.\n@pugnascotia WDYT?", "author": "pgomulka", "createdAt": "2021-02-04T17:06:06Z", "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -54,16 +51,21 @@ public static DeprecationLogger getLogger(Class<?> aClass) {\n      * the \"org.elasticsearch\" namespace.\n      */\n     public static DeprecationLogger getLogger(String name) {\n-        return new DeprecationLogger(getDeprecatedLoggerForName(name));\n+        return new DeprecationLogger(name);\n+    }\n+\n+    private DeprecationLogger(String parentLoggerName) {", "originalCommit": "7f64a849db60a6512d5b6c3e74252d4a2ae44668", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDkxOTg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r570919846", "bodyText": "we could also just use a\n        this.compatibleLogger = new LazyInitializable<>(()-> LogManager.getLogger(getLoggerName(parentLoggerName, \"compatible\")));\n\n\nbut I recon we don't do any optimisations unless the performance is impacted", "author": "pgomulka", "createdAt": "2021-02-05T12:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5MzI0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "1fc80dbeafe9165eba517a260018097aad6582f4", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\nindex 948fba6dcb2..38f09ce9cdc 100644\n--- a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n+++ b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n\n@@ -56,7 +55,6 @@ public class DeprecationLogger {\n \n     private DeprecationLogger(String parentLoggerName) {\n         this.logger = LogManager.getLogger(getLoggerName(parentLoggerName, \"deprecation\"));\n-        this.compatibleLogger = LogManager.getLogger(getLoggerName(parentLoggerName, \"compatible\"));\n     }\n \n     private static String getLoggerName(String name, String prefix) {\n"}}, {"oid": "1fc80dbeafe9165eba517a260018097aad6582f4", "url": "https://github.com/elastic/elasticsearch/commit/1fc80dbeafe9165eba517a260018097aad6582f4", "message": "remove unnecessary compatible logger", "committedDate": "2021-02-05T14:43:43Z", "type": "commit"}, {"oid": "345963b22025304644675b2de32c516c00c4d781", "url": "https://github.com/elastic/elasticsearch/commit/345963b22025304644675b2de32c516c00c4d781", "message": "test rename", "committedDate": "2021-02-05T14:45:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTAzNDE3MA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r571034170", "bodyText": "Do we still need these lines?", "author": "pugnascotia", "createdAt": "2021-02-05T15:07:56Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java", "diffHunk": "@@ -78,11 +78,13 @@ public DeprecationIndexingComponent(Client client, Settings settings) {\n     protected void doStart() {\n         this.appender.start();\n         Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.deprecation\"), this.appender);\n+        Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.compatible\"), this.appender);", "originalCommit": "345963b22025304644675b2de32c516c00c4d781", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b8e93780f6e7ed37c75f79798dc2c7c5e5a2a9d9", "chunk": "diff --git a/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java b/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java\nindex 4fe59cad6df..47538e61381 100644\n--- a/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java\n+++ b/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java\n\n@@ -78,13 +78,11 @@ public class DeprecationIndexingComponent extends AbstractLifecycleComponent imp\n     protected void doStart() {\n         this.appender.start();\n         Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.deprecation\"), this.appender);\n-        Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.compatible\"), this.appender);\n     }\n \n     @Override\n     protected void doStop() {\n         Loggers.removeAppender(LogManager.getLogger(\"org.elasticsearch.deprecation\"), this.appender);\n-        Loggers.removeAppender(LogManager.getLogger(\"org.elasticsearch.compatible\"), this.appender);\n         this.appender.stop();\n     }\n \n"}}, {"oid": "b8e93780f6e7ed37c75f79798dc2c7c5e5a2a9d9", "url": "https://github.com/elastic/elasticsearch/commit/b8e93780f6e7ed37c75f79798dc2c7c5e5a2a9d9", "message": "do no add appender to non existing logger", "committedDate": "2021-02-06T09:30:43Z", "type": "commit"}, {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143", "url": "https://github.com/elastic/elasticsearch/commit/af2f2ad32b0aef6838303326dac12d3a23922143", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger", "committedDate": "2021-02-08T08:02:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzExODE5OA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573118198", "bodyText": "Is required to accept a prefix ? (won't it always be deprecation ? (and shouldn't it always be deprecation ?)", "author": "jakelandis", "createdAt": "2021-02-09T18:10:39Z", "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -54,16 +50,20 @@ public static DeprecationLogger getLogger(Class<?> aClass) {\n      * the \"org.elasticsearch\" namespace.\n      */\n     public static DeprecationLogger getLogger(String name) {\n-        return new DeprecationLogger(getDeprecatedLoggerForName(name));\n+        return new DeprecationLogger(name);\n+    }\n+\n+    private DeprecationLogger(String parentLoggerName) {\n+        this.logger = LogManager.getLogger(getLoggerName(parentLoggerName, \"deprecation\"));\n     }\n \n-    private static Logger getDeprecatedLoggerForName(String name) {\n+    private static String getLoggerName(String name, String prefix) {", "originalCommit": "af2f2ad32b0aef6838303326dac12d3a23922143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzUxODMyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573518329", "bodyText": "agree, we can remove it", "author": "pgomulka", "createdAt": "2021-02-10T08:03:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzExODE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "105fe533dad92b4a0e160dbba268a24aa11f2c07", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\nindex 38f09ce9cdc..747df1a4347 100644\n--- a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n+++ b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n\n@@ -54,14 +54,14 @@ public class DeprecationLogger {\n     }\n \n     private DeprecationLogger(String parentLoggerName) {\n-        this.logger = LogManager.getLogger(getLoggerName(parentLoggerName, \"deprecation\"));\n+        this.logger = LogManager.getLogger(getLoggerName(parentLoggerName));\n     }\n \n-    private static String getLoggerName(String name, String prefix) {\n+    private static String getLoggerName(String name) {\n         if (name.startsWith(\"org.elasticsearch\")) {\n-            name = name.replace(\"org.elasticsearch.\", \"org.elasticsearch.\" + prefix + \".\");\n+            name = name.replace(\"org.elasticsearch.\", \"org.elasticsearch.deprecation.\");\n         } else {\n-            name = prefix + \".\" + name;\n+            name = \"deprecation.\" + name;\n         }\n         return name;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573128469", "bodyText": "I wonder if we should leave this class as-is and require the user to pass the CompatibleApi category. Now that we are re-using this log and logger, it feels abit off for this to be special enough to warrant it's own method.", "author": "jakelandis", "createdAt": "2021-02-09T18:24:57Z", "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -75,23 +75,25 @@ private static String toLoggerName(final Class<?> cls) {\n      * Logs a message at the {@link #DEPRECATION} level. The message is also sent to the header warning logger,\n      * so that it can be returned to the client.\n      */\n-    public DeprecationLoggerBuilder deprecate(\n+    public DeprecationLogger deprecate(\n         final DeprecationCategory category,\n         final String key,\n         final String msg,\n         final Object... params\n     ) {\n-        return new DeprecationLoggerBuilder().withDeprecation(category, key, msg, params);\n+        ESLogMessage deprecationMessage = DeprecatedMessage.of(category, key, HeaderWarning.getXOpaqueId(), msg, params);\n+        logger.log(DEPRECATION, deprecationMessage);\n+        return this;\n     }\n \n-    public class DeprecationLoggerBuilder {\n-\n-        public DeprecationLoggerBuilder withDeprecation(DeprecationCategory category, String key, String msg, Object[] params) {\n-            ESLogMessage deprecationMessage = DeprecatedMessage.of(category, key, HeaderWarning.getXOpaqueId(), msg, params);\n-\n-            logger.log(DEPRECATION, deprecationMessage);\n-\n-            return this;\n-        }\n+    public DeprecationLogger compatibleApiWarning(", "originalCommit": "af2f2ad32b0aef6838303326dac12d3a23922143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzUyMDIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573520233", "bodyText": "I think the idea with the builder was over complicated. It was meant to allow for constructing some more complex DSLs (like emitting a compatible warning only when a deprecation warning was already called etc)\nI think we don't need this, and also I am worried that we would unnecessarily create objects.\nRegarding the separate method. I think it would be beneficial to have it. We hide from a user (a developer) that he has to remember about the Category field.", "author": "pgomulka", "createdAt": "2021-02-10T08:07:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDAwNDA5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r574004095", "bodyText": "+1 on the simplification, thanks for the explanation.\nre: separate method, I worry abit about the perception this is special in a way that it is not. It introduces a different way from everything. A dev adding a compatible warning will need to know they are adding a compatible warning, and this is mostly about which keys they need type to do that.  I would prefer to prevent differences without substance.", "author": "jakelandis", "createdAt": "2021-02-10T19:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMwMjE3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r574302178", "bodyText": "I am not sure I understand. The intention of a separate method is to hide that additional category key from a developer. Using just a category field would mean that a developer would have to remember to use it, it would be an unnecessary duplication and inconvenience.  If a developer makes a mistake with the category, it will not be possible to find that usage of compatible API.\nI might disagree with just using a deprecation log method, but I don't think it is all that relevant. There is no usage of it now and this PR was just meant to introduce an infrastructure - which is reduced to the direct use of deprecation log.\nIn fact, if the method is to be removed, there is actually no point for this PR at all.", "author": "pgomulka", "createdAt": "2021-02-11T07:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDc2NDM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r574764354", "bodyText": "OK ... my argument was that we shouldn't try to hide the additional category.  However, I am fine with the additional method.  Might want to consider adding an assert so that this method is the only way to set that category.", "author": "jakelandis", "createdAt": "2021-02-11T19:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "2ba3913fed4b1888654922c6aa35dc587ac1047a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\nindex 38f09ce9cdc..cd04c88d8ee 100644\n--- a/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n+++ b/server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java\n\n@@ -81,6 +81,8 @@ public class DeprecationLogger {\n         final String msg,\n         final Object... params\n     ) {\n+        assert category != DeprecationCategory.COMPATIBLE_API :\n+            \"DeprecationCategory.COMPATIBLE_API should be logged with compatibleApiWarning method\";\n         ESLogMessage deprecationMessage = DeprecatedMessage.of(category, key, HeaderWarning.getXOpaqueId(), msg, params);\n         logger.log(DEPRECATION, deprecationMessage);\n         return this;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEzMDM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573130346", "bodyText": "should we also test the HTTP response warning ?", "author": "jakelandis", "createdAt": "2021-02-09T18:27:38Z", "path": "x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java", "diffHunk": "@@ -320,6 +321,131 @@ public void testDeprecationMessagesCanBeIndexed() throws Exception {\n         }\n     }\n \n+    /**\n+     * Check that compatible api log messages can be recorded to an index\n+     */\n+    public void testCompatibleMessagesCanBeIndexed() throws Exception {", "originalCommit": "af2f2ad32b0aef6838303326dac12d3a23922143", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDc2NDk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r574764952", "bodyText": "nevermind on this comment ... since it is the same functionality as other deprecation logger, that is already tested.", "author": "jakelandis", "createdAt": "2021-02-11T19:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEzMDM0Ng=="}], "type": "inlineReview", "revised_code": {"commit": "105fe533dad92b4a0e160dbba268a24aa11f2c07", "chunk": "diff --git a/x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java b/x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java\nindex e9a7012c490..a2d30aff340 100644\n--- a/x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java\n+++ b/x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java\n\n@@ -345,7 +346,21 @@ public class DeprecationHttpIT extends ESRestTestCase {\n             compatibleRequest.setEntity(\n                 buildSettingsRequest(Collections.singletonList(TestDeprecationHeaderRestAction.TEST_DEPRECATED_SETTING_TRUE1), true)\n             );\n-            assertOK(client().performRequest(compatibleRequest));\n+            Response deprecatedApiResponse = client().performRequest(compatibleRequest);\n+            assertOK(deprecatedApiResponse);\n+\n+            final List<String> deprecatedWarnings = getWarningHeaders(deprecatedApiResponse.getHeaders());\n+            final List<String> actualWarningValues = deprecatedWarnings.stream()\n+                .map(s -> HeaderWarning.extractWarningValueFromWarningHeader(s, true))\n+                .collect(Collectors.toList());\n+            assertThat(\n+                actualWarningValues,\n+                containsInAnyOrder(\n+                    TestDeprecationHeaderRestAction.DEPRECATED_ENDPOINT,\n+                    TestDeprecationHeaderRestAction.DEPRECATED_USAGE,\n+                    TestDeprecationHeaderRestAction.COMPATIBLE_API_USAGE\n+                )\n+            );\n \n             assertBusy(() -> {\n                 Response response;\n"}}, {"oid": "105fe533dad92b4a0e160dbba268a24aa11f2c07", "url": "https://github.com/elastic/elasticsearch/commit/105fe533dad92b4a0e160dbba268a24aa11f2c07", "message": "logger", "committedDate": "2021-02-10T08:56:10Z", "type": "commit"}, {"oid": "e04acbffc7e0c85d629a2c32976ad1c9094e6dde", "url": "https://github.com/elastic/elasticsearch/commit/e04acbffc7e0c85d629a2c32976ad1c9094e6dde", "message": "Merge branch 'master' into compat/logger", "committedDate": "2021-02-11T19:22:06Z", "type": "commit"}, {"oid": "558ec36838420a3832df728223af22f1ded011fc", "url": "https://github.com/elastic/elasticsearch/commit/558ec36838420a3832df728223af22f1ded011fc", "message": "compile fix", "committedDate": "2021-02-15T09:30:21Z", "type": "commit"}, {"oid": "57a685b0bdc4adbb63865a1379f202917289bf5e", "url": "https://github.com/elastic/elasticsearch/commit/57a685b0bdc4adbb63865a1379f202917289bf5e", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger", "committedDate": "2021-02-15T09:30:25Z", "type": "commit"}, {"oid": "dbe2871141b72d3e90ca5e3ff6fb7989955d0015", "url": "https://github.com/elastic/elasticsearch/commit/dbe2871141b72d3e90ca5e3ff6fb7989955d0015", "message": "Merge branch 'master' into compat/logger", "committedDate": "2021-02-15T11:15:02Z", "type": "commit"}, {"oid": "bfb35643859f09a7e82906282309cf775fcb2ba8", "url": "https://github.com/elastic/elasticsearch/commit/bfb35643859f09a7e82906282309cf775fcb2ba8", "message": "Merge branch 'master' into compat/logger", "committedDate": "2021-02-15T14:48:53Z", "type": "commit"}, {"oid": "15ecd8ea6d25949869e2a25accd6ec05e5b37483", "url": "https://github.com/elastic/elasticsearch/commit/15ecd8ea6d25949869e2a25accd6ec05e5b37483", "message": "Merge remote-tracking branch 'pgomulka/compat/logger' into compat/logger", "committedDate": "2021-02-15T15:14:08Z", "type": "commit"}, {"oid": "1044b1a8b6c7458eac9e6d7bda1af33fccf34a1e", "url": "https://github.com/elastic/elasticsearch/commit/1044b1a8b6c7458eac9e6d7bda1af33fccf34a1e", "message": "precommit", "committedDate": "2021-02-15T15:46:32Z", "type": "commit"}, {"oid": "2ba3913fed4b1888654922c6aa35dc587ac1047a", "url": "https://github.com/elastic/elasticsearch/commit/2ba3913fed4b1888654922c6aa35dc587ac1047a", "message": "adding assert", "committedDate": "2021-02-15T16:43:53Z", "type": "commit"}]}