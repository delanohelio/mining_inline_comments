{"pr_number": 57605, "pr_title": "SQL: handle MIN and MAX functions on dates in Painless scripts", "pr_createdAt": "2020-06-03T14:38:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57605", "timeline": [{"oid": "35070181929065d0b4d7a5710fbdfd8678e2f9fb", "url": "https://github.com/elastic/elasticsearch/commit/35070181929065d0b4d7a5710fbdfd8678e2f9fb", "message": "Convert to date/datetime the result of numeric aggregations (min, max)\nin Painless scripts", "committedDate": "2020-06-03T14:30:41Z", "type": "commit"}, {"oid": "f6a4d6730157fdf37e48c8deadaa7b9372651c36", "url": "https://github.com/elastic/elasticsearch/commit/f6a4d6730157fdf37e48c8deadaa7b9372651c36", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 57581_fix", "committedDate": "2020-06-03T14:30:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNDMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57605#discussion_r434624321", "bodyText": "Shouldn't we remove this method as currently there is no such case that a groupingfunction (actually histogram) results into a script?", "author": "matriv", "createdAt": "2020-06-03T14:46:43Z", "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java", "diffHunk": "@@ -108,19 +109,28 @@ protected ScriptTemplate scriptWithScalar(ScalarFunction scalar) {\n     }\n     \n     protected ScriptTemplate scriptWithAggregate(AggregateFunction aggregate) {\n-        String template = \"{}\";\n+        String template = basicTemplate(aggregate);\n         return new ScriptTemplate(processScript(template),\n                 paramsBuilder().agg(aggregate).build(),\n                 dataType());\n     }\n \n     protected ScriptTemplate scriptWithGrouping(GroupingFunction grouping) {", "originalCommit": "f6a4d6730157fdf37e48c8deadaa7b9372651c36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNTUxNw==", "url": "https://github.com/elastic/elasticsearch/pull/57605#discussion_r434625517", "bodyText": "Chose to keep it there since, before the bug was introduced, the code was using asDateTime for grouping functions, as well.", "author": "astefan", "createdAt": "2020-06-03T14:48:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNDMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNzA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/57605#discussion_r434627050", "bodyText": "Would you mind adding a comment then, please, to avoid pursuing it again in the future?", "author": "matriv", "createdAt": "2020-06-03T14:50:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNDMyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "59d2a2a34c1161c8ece24009f9ab66974aa5f501", "chunk": "diff --git a/x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java b/x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java\nindex caa11104f1e..7a0157120ae 100644\n--- a/x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java\n+++ b/x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java\n\n@@ -115,6 +115,8 @@ public abstract class ScalarFunction extends Function {\n                 dataType());\n     }\n \n+    // This method isn't actually used at the moment, since there is no grouping function (ie HISTOGRAM)\n+    // that currently results in a script being generated\n     protected ScriptTemplate scriptWithGrouping(GroupingFunction grouping) {\n         String template = basicTemplate(grouping);\n         return new ScriptTemplate(processScript(template),\n"}}, {"oid": "59d2a2a34c1161c8ece24009f9ab66974aa5f501", "url": "https://github.com/elastic/elasticsearch/commit/59d2a2a34c1161c8ece24009f9ab66974aa5f501", "message": "Added method comment", "committedDate": "2020-06-05T07:47:35Z", "type": "commit"}, {"oid": "63a8727bc7fd468af6dd9a5fd4c11f66d77e330a", "url": "https://github.com/elastic/elasticsearch/commit/63a8727bc7fd468af6dd9a5fd4c11f66d77e330a", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 57581_fix", "committedDate": "2020-06-05T07:48:00Z", "type": "commit"}]}