{"pr_number": 51568, "pr_title": "SQL: Verify Full-Text Search functions not allowed in SELECT", "pr_createdAt": "2020-01-28T20:44:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51568", "timeline": [{"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "url": "https://github.com/elastic/elasticsearch/commit/c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "message": "SQL: Verify Full-Text Search functions not allowed in SELECT\n\nAdd a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\n\nFixes: #47446", "committedDate": "2020-01-28T20:46:43Z", "type": "commit"}, {"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "url": "https://github.com/elastic/elasticsearch/commit/c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "message": "SQL: Verify Full-Text Search functions not allowed in SELECT\n\nAdd a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\n\nFixes: #47446", "committedDate": "2020-01-28T20:46:43Z", "type": "forcePushed"}, {"oid": "df4c9b3ce2272d542c1ae3d74d67cf98eda96584", "url": "https://github.com/elastic/elasticsearch/commit/df4c9b3ce2272d542c1ae3d74d67cf98eda96584", "message": "Fix validation", "committedDate": "2020-01-28T22:15:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4OTE2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51568#discussion_r372089162", "bodyText": "The error message I think has several issues: why the capital letters for Full-Text, and why the plural functions?Also, if you look at our docs - https://www.elastic.co/guide/en/elasticsearch/reference/7.x/sql-functions-search.html - full-text search functions include SCORE() as well, but Score is not an instanceof FullTextPredicate so it wouldn't match this condition.\nSo, try to adjust the error message not to partially conflict with the documentation.", "author": "astefan", "createdAt": "2020-01-28T22:15:17Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -215,8 +216,16 @@ private static Failure fail(Node<?> source, String message, Object... args) {\n         // if there are no (major) unresolved failures, do more in-depth analysis\n \n         if (failures.isEmpty()) {\n+            Set<Failure> localFailures = new LinkedHashSet<>();\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n+            // Full-Text search function are not allowed in the SELECT clause\n+            plan.forEachUp(p -> p.forEachExpressionsUp(e -> {\n+                if (e instanceof FullTextPredicate) {\n+                    localFailures.add(fail(e, \"Cannot use a Full-Text search functions in the SELECT clause\"));", "originalCommit": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyMDE4MA==", "url": "https://github.com/elastic/elasticsearch/pull/51568#discussion_r372320180", "bodyText": "Thx, Rephrased the error message.\nI chose not to refer to the exact usage in the user's query because it can be a large string, given the params that would be often used, e.g.:\nQUERY('Man*', 'default_field=last_name;lenient=true', 'fuzzy_rewrite=scoring_boolean')", "author": "matriv", "createdAt": "2020-01-29T11:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4OTE2Mg=="}], "type": "inlineReview", "revised_code": {"commit": "df4c9b3ce2272d542c1ae3d74d67cf98eda96584", "chunk": "diff --git a/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\nindex ff7bef5df7ab..2ba064ad28eb 100644\n--- a/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\n+++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\n\n@@ -220,11 +220,13 @@ public final class Verifier {\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n             // Full-Text search function are not allowed in the SELECT clause\n-            plan.forEachUp(p -> p.forEachExpressionsUp(e -> {\n-                if (e instanceof FullTextPredicate) {\n-                    localFailures.add(fail(e, \"Cannot use a Full-Text search functions in the SELECT clause\"));\n+            plan.forEachUp(p -> {\n+                for (NamedExpression ne : p.projections()) {\n+                    ne.forEachUp((e) ->\n+                            localFailures.add(fail(e, \"Cannot use a Full-Text search functions in the SELECT clause\")),\n+                            FullTextPredicate.class);\n                 }\n-            }), Project.class);\n+            }, Project.class);\n \n             // collect Attribute sources\n             // only Aliases are interesting since these are the only ones that hide expressions\n"}}, {"oid": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7", "url": "https://github.com/elastic/elasticsearch/commit/18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7", "message": "Address comments", "committedDate": "2020-01-29T11:04:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NTcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/51568#discussion_r372645700", "bodyText": "Despite being a small snippet, can you please extract it into its own static method - it's easier to reason about its purpose before looking at its details?\nThanks.", "author": "costin", "createdAt": "2020-01-29T21:41:13Z", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -215,8 +216,19 @@ private static Failure fail(Node<?> source, String message, Object... args) {\n         // if there are no (major) unresolved failures, do more in-depth analysis\n \n         if (failures.isEmpty()) {\n+            Set<Failure> localFailures = new LinkedHashSet<>();\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n+            // Full-Text search function are not allowed in the SELECT clause\n+            plan.forEachUp(p -> {", "originalCommit": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "df05821451b1d08d2afdddc773ede52cd51a74ab", "chunk": "diff --git a/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\nindex 616f50457043..b2818ee21454 100644\n--- a/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\n+++ b/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java\n\n@@ -219,15 +219,7 @@ public final class Verifier {\n             Set<Failure> localFailures = new LinkedHashSet<>();\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n-            // Full-Text search function are not allowed in the SELECT clause\n-            plan.forEachUp(p -> {\n-                for (NamedExpression ne : p.projections()) {\n-                    ne.forEachUp((e) ->\n-                            localFailures.add(fail(e, \"Cannot use MATCH() or QUERY() full-text search \" +\n-                                    \"functions in the SELECT clause\")),\n-                            FullTextPredicate.class);\n-                }\n-            }, Project.class);\n+            checkFullTextSearchInSelect(plan, localFailures);\n \n             // collect Attribute sources\n             // only Aliases are interesting since these are the only ones that hide expressions\n"}}, {"oid": "df05821451b1d08d2afdddc773ede52cd51a74ab", "url": "https://github.com/elastic/elasticsearch/commit/df05821451b1d08d2afdddc773ede52cd51a74ab", "message": "extract method", "committedDate": "2020-01-30T09:48:09Z", "type": "commit"}]}