{"pr_number": 50899, "pr_title": "PutIndexTemplateRequest contains a single mapping", "pr_createdAt": "2020-01-13T09:32:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50899", "timeline": [{"oid": "86960cbea02f71fb7a9f322121ea33d9680aac25", "url": "https://github.com/elastic/elasticsearch/commit/86960cbea02f71fb7a9f322121ea33d9680aac25", "message": "PutIndexTemplateRequest contains a single mapping", "committedDate": "2020-01-13T09:00:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyODUwOA==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r366628508", "bodyText": "Small comment: this could be marked @Nullable.", "author": "jtibshirani", "createdAt": "2020-01-14T23:34:11Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequest.java", "diffHunk": "@@ -79,7 +78,7 @@\n \n     private Settings settings = EMPTY_SETTINGS;\n \n-    private Map<String, String> mappings = new HashMap<>();\n+    private String mappings;", "originalCommit": "86960cbea02f71fb7a9f322121ea33d9680aac25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzMDY0NA==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r366830644", "bodyText": "++", "author": "romseygeek", "createdAt": "2020-01-15T11:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyODUwOA=="}], "type": "inlineReview", "revised_code": {"commit": "8a298cd14217bd608a08f42bbf342da278551ea8", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequest.java\nindex e2ebffb720d..7a59f9b3650 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequest.java\n\n@@ -78,6 +79,7 @@ public class PutIndexTemplateRequest extends MasterNodeRequest<PutIndexTemplateR\n \n     private Settings settings = EMPTY_SETTINGS;\n \n+    @Nullable\n     private String mappings;\n \n     private final Set<Alias> aliases = new HashSet<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzMjkzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r366632935", "bodyText": "This test still seems relevant, since we kept the type wrapping logic in PutIndexTemplateRequest:\nif (source.size() != 1 || source.containsKey(MapperService.SINGLE_MAPPING_NAME) == false) {\n    Map.of(MapperService.SINGLE_MAPPING_NAME, source);\n}\n\nWe could wait to remove it until we stop wrapping mappings with a type name?", "author": "jtibshirani", "createdAt": "2020-01-14T23:50:23Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequestTests.java", "diffHunk": "@@ -57,67 +53,6 @@ public void testValidateErrorMessage() {\n         assertThat(noError, is(nullValue()));\n     }\n \n-    public void testMappingKeyedByType() throws IOException {", "originalCommit": "86960cbea02f71fb7a9f322121ea33d9680aac25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2ODcwNw==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r367368707", "bodyText": "Huh, github dropping my comments apparently...\nI reinstated this test to check that mappings wrapped with _doc and unwrapped mappings resolve to the same object.", "author": "romseygeek", "createdAt": "2020-01-16T11:31:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzMjkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "8a298cd14217bd608a08f42bbf342da278551ea8", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequestTests.java b/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequestTests.java\nindex 64d9fe4fb73..4f68777f9bf 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequestTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateRequestTests.java\n\n@@ -53,6 +56,67 @@ public class PutIndexTemplateRequestTests extends ESTestCase {\n         assertThat(noError, is(nullValue()));\n     }\n \n+    public void testMappingKeyedByType() throws IOException {\n+        PutIndexTemplateRequest request1 = new PutIndexTemplateRequest(\"foo\");\n+        PutIndexTemplateRequest request2 = new PutIndexTemplateRequest(\"bar\");\n+        {\n+            XContentBuilder builder = XContentFactory.contentBuilder(randomFrom(XContentType.values()));\n+            builder.startObject().startObject(\"properties\")\n+                .startObject(\"field1\")\n+                .field(\"type\", \"text\")\n+                .endObject()\n+                .startObject(\"field2\")\n+                .startObject(\"properties\")\n+                .startObject(\"field21\")\n+                .field(\"type\", \"keyword\")\n+                .endObject()\n+                .endObject()\n+                .endObject()\n+                .endObject().endObject();\n+            request1.mapping(builder);\n+            builder = XContentFactory.contentBuilder(randomFrom(XContentType.values()));\n+            builder.startObject().startObject(\"_doc\")\n+                .startObject(\"properties\")\n+                .startObject(\"field1\")\n+                .field(\"type\", \"text\")\n+                .endObject()\n+                .startObject(\"field2\")\n+                .startObject(\"properties\")\n+                .startObject(\"field21\")\n+                .field(\"type\", \"keyword\")\n+                .endObject()\n+                .endObject()\n+                .endObject()\n+                .endObject()\n+                .endObject().endObject();\n+            request2.mapping(builder);\n+            assertEquals(request1.mappings(), request2.mappings());\n+        }\n+        {\n+            request1 = new PutIndexTemplateRequest(\"foo\");\n+            request2 = new PutIndexTemplateRequest(\"bar\");\n+            String nakedMapping = \"{\\\"properties\\\": {\\\"foo\\\": {\\\"type\\\": \\\"integer\\\"}}}\";\n+            request1.mapping(nakedMapping, XContentType.JSON);\n+            request2.mapping(\"{\\\"_doc\\\": \" + nakedMapping + \"}\", XContentType.JSON);\n+            assertEquals(request1.mappings(), request2.mappings());\n+        }\n+        {\n+            request1 = new PutIndexTemplateRequest(\"foo\");\n+            request2 = new PutIndexTemplateRequest(\"bar\");\n+            Map<String, Object> nakedMapping = MapBuilder.<String, Object>newMapBuilder()\n+                .put(\"properties\", MapBuilder.<String, Object>newMapBuilder()\n+                    .put(\"bar\", MapBuilder.<String, Object>newMapBuilder()\n+                        .put(\"type\", \"scaled_float\")\n+                        .put(\"scaling_factor\", 100)\n+                        .map())\n+                    .map())\n+                .map();\n+            request1.mapping(nakedMapping);\n+            request2.mapping(Map.of(\"_doc\", nakedMapping));\n+            assertEquals(request1.mappings(), request2.mappings());\n+        }\n+    }\n+\n     public void testSourceParsing() throws IOException {\n         XContentBuilder indexPatterns = XContentFactory.jsonBuilder().startObject()\n             .array(\"index_patterns\", \"index-*\", \"other-index-*\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzNDgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r366634834", "bodyText": "This seems to both perform the refactor but also adjust the scope of the try ... catch. Is there a good reason to change this? Otherwise we could leave it as-is to minimize extra changes.", "author": "jtibshirani", "createdAt": "2020-01-14T23:57:38Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -240,19 +238,15 @@ private static void validateAndAddTemplate(final PutRequest request, IndexTempla\n             templateBuilder.patterns(request.indexPatterns);\n             templateBuilder.settings(request.settings);\n \n-            Map<String, Map<String, Object>> mappingsForValidation = new HashMap<>();\n-            for (Map.Entry<String, String> entry : request.mappings.entrySet()) {\n+            if (request.mappings != null) {\n                 try {\n-                    templateBuilder.putMapping(entry.getKey(), entry.getValue());\n-                } catch (Exception e) {\n-                    throw new MapperParsingException(\"Failed to parse mapping [{}]: {}\", e, entry.getKey(), e.getMessage());\n+                    templateBuilder.putMapping(MapperService.SINGLE_MAPPING_NAME, request.mappings);", "originalCommit": "86960cbea02f71fb7a9f322121ea33d9680aac25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3ODAxNw==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r367378017", "bodyText": "This was to make MetaDataIndexTemplateServiceTests#testBrokenMappings pass - the refactoring moved around where things were being parsed, so it didn't get the exception that it was expecting.  However, looking at things more carefully, parsing happens when the initial PutIndexTemplateRequest is constructed, so this try-catch is entirely unnecessary.  We already test for broken mappings in PutIndexTemplateRequestTests, so I've removed the try-catch and the failing test.", "author": "romseygeek", "createdAt": "2020-01-16T11:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzNDgzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY1OTkxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/50899#discussion_r367659915", "bodyText": "I'm not clear on why we need to remove the try/ catch and remove the test? I think the try/ catch is present to try to always throw a MapperParsingException, even in case the templateBuilder.putMapping call fails and throws a NotXContentException.\nI tried just restoring the original structure below, and testBrokenMappings then passes:\nif (request.mappings != null) {\n    try {\n        templateBuilder.putMapping(MapperService.SINGLE_MAPPING_NAME, request.mappings);\n    } catch (Exception e) {\n        throw new MapperParsingException(\"Failed to parse mapping [{}]: {}\", e, \"_doc\", e.getMessage());\n    }\n                \n    dummyIndexService.mapperService().merge(MapperService.SINGLE_MAPPING_NAME,\n            MapperService.parseMapping(xContentRegistry, request.mappings), MergeReason.MAPPING_UPDATE);\n}\n\nIt just seems nice to avoid making changes not related to the PR goal (and I don't have a full picture of our template validation strategy, so I'm not as confident as to whether we can remove the try/ catch and test).", "author": "jtibshirani", "createdAt": "2020-01-16T21:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYzNDgzNA=="}], "type": "inlineReview", "revised_code": {"commit": "223852e489bad66960c07d864ca90c79d8a672e0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\nindex 911d7e46b11..4a971e6a317 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n\n@@ -230,7 +230,7 @@ public class MetaDataIndexTemplateService {\n                 .build();\n \n             final IndexMetaData tmpIndexMetadata = IndexMetaData.builder(temporaryIndexName).settings(dummySettings).build();\n-            IndexService dummyIndexService = indicesService.createIndex(tmpIndexMetadata, Collections.emptyList());\n+            IndexService dummyIndexService = indicesService.createIndex(tmpIndexMetadata, Collections.emptyList(), false);\n             createdIndex = dummyIndexService.index();\n \n             templateBuilder.order(request.order);\n"}}, {"oid": "223852e489bad66960c07d864ca90c79d8a672e0", "url": "https://github.com/elastic/elasticsearch/commit/223852e489bad66960c07d864ca90c79d8a672e0", "message": "Merge remote-tracking branch 'origin/master' into types-removal/put-index-template", "committedDate": "2020-01-15T09:28:25Z", "type": "commit"}, {"oid": "8a298cd14217bd608a08f42bbf342da278551ea8", "url": "https://github.com/elastic/elasticsearch/commit/8a298cd14217bd608a08f42bbf342da278551ea8", "message": "reinstate test", "committedDate": "2020-01-15T09:42:27Z", "type": "commit"}, {"oid": "33903f3e92af1ad0e9302acfa54636ca9c764f6b", "url": "https://github.com/elastic/elasticsearch/commit/33903f3e92af1ad0e9302acfa54636ca9c764f6b", "message": "Merge branch 'master' into types-removal/put-index-template", "committedDate": "2020-01-15T11:39:09Z", "type": "commit"}, {"oid": "9624e11f503e0a83af89f0cdbe54e28c8b8f855f", "url": "https://github.com/elastic/elasticsearch/commit/9624e11f503e0a83af89f0cdbe54e28c8b8f855f", "message": "Remove unnecessary try-catch", "committedDate": "2020-01-16T11:51:42Z", "type": "commit"}, {"oid": "f84041f093eebd2aea17329a9e6b901356eb6dd1", "url": "https://github.com/elastic/elasticsearch/commit/f84041f093eebd2aea17329a9e6b901356eb6dd1", "message": "Merge remote-tracking branch 'romseygeek/types-removal/put-index-template' into types-removal/put-index-template", "committedDate": "2020-01-16T11:52:32Z", "type": "commit"}, {"oid": "02044ecf8c7c105397c43a9d2d860808f51f715b", "url": "https://github.com/elastic/elasticsearch/commit/02044ecf8c7c105397c43a9d2d860808f51f715b", "message": "Merge branch 'master' into types-removal/put-index-template", "committedDate": "2020-01-16T12:21:54Z", "type": "commit"}, {"oid": "ec856387247f583a7779349d849c6db393b366dc", "url": "https://github.com/elastic/elasticsearch/commit/ec856387247f583a7779349d849c6db393b366dc", "message": "tests", "committedDate": "2020-01-16T13:50:04Z", "type": "commit"}, {"oid": "d975d9e64fb148e4b2b5a3eba316f19ef2815050", "url": "https://github.com/elastic/elasticsearch/commit/d975d9e64fb148e4b2b5a3eba316f19ef2815050", "message": "Merge remote-tracking branch 'origin/master' into types-removal/put-index-template", "committedDate": "2020-01-17T08:48:51Z", "type": "commit"}, {"oid": "4401adb957ad1df76b133e412e964fca1b6ee35c", "url": "https://github.com/elastic/elasticsearch/commit/4401adb957ad1df76b133e412e964fca1b6ee35c", "message": "Add try-catch back", "committedDate": "2020-01-17T08:55:21Z", "type": "commit"}, {"oid": "1c866a8f8555a9cef573407f50373f741d7797a0", "url": "https://github.com/elastic/elasticsearch/commit/1c866a8f8555a9cef573407f50373f741d7797a0", "message": "Merge remote-tracking branch 'origin/master' into types-removal/put-index-template", "committedDate": "2020-01-17T14:26:54Z", "type": "commit"}, {"oid": "f10c97d1a5f463776925b493bc88a1cb5c7fe4f4", "url": "https://github.com/elastic/elasticsearch/commit/f10c97d1a5f463776925b493bc88a1cb5c7fe4f4", "message": "Merge remote-tracking branch 'origin/master' into types-removal/put-index-template", "committedDate": "2020-01-20T13:38:51Z", "type": "commit"}]}