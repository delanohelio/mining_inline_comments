{"pr_number": 61439, "pr_title": "Add base precommit task to all java projects", "pr_createdAt": "2020-08-21T18:52:24Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61439", "timeline": [{"oid": "c7bae6a2f3d647dd3486528e93f26f9f1271688f", "url": "https://github.com/elastic/elasticsearch/commit/c7bae6a2f3d647dd3486528e93f26f9f1271688f", "message": "Add base precommit task to all java projects\n\nThis commit adds java compilation to the base precommit task, and adds\nthat to the java plugin. This further reduces dependence on the build\nplugin.", "committedDate": "2020-08-21T18:50:20Z", "type": "commit"}, {"oid": "aa1aafc7d945f16a2de5e9837631eac3da952fd4", "url": "https://github.com/elastic/elasticsearch/commit/aa1aafc7d945f16a2de5e9837631eac3da952fd4", "message": "spotless", "committedDate": "2020-08-21T21:50:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475008857", "bodyText": "I'm confused why we are duplicating this logic. It seems to me that the PrecommitPlugin should be there only to create the task, the individual plugins like the java plugin, should add the java specific stuff there.", "author": "mark-vieira", "createdAt": "2020-08-21T23:25:23Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java", "diffHunk": "@@ -72,7 +72,18 @@ public void apply(Project project) {\n                     p -> project.getTasks().named(LifecycleBasePlugin.CHECK_TASK_NAME).configure(t -> t.dependsOn(precommit))\n                 );\n             project.getPluginManager()\n-                .withPlugin(\"java\", p -> project.getTasks().withType(Test.class).configureEach(t -> t.mustRunAfter(precommit)));\n+                .withPlugin(", "originalCommit": "aa1aafc7d945f16a2de5e9837631eac3da952fd4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAxMTg2MA==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475011860", "bodyText": "There isn't any task to add, these are the existing compilation tasks. In the past, we have relied on things like checkstyle to trigger compilation so that it is part of precommit. This makes it explicit, so that precommit for java plugins always triggers compilation, even if there are zero other precommit tasks. Currently if applying elasticsearch.java, no precommit task is created, since we haven't agreed on any being applicable to all java projects like tests. This change makes sure we have that task for all java plugins.", "author": "rjernst", "createdAt": "2020-08-21T23:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzI5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475697295", "bodyText": "I still don't quite understand the need for the separate PrecommitTaskPlugin. How does it differ from the PrecommitPlugin which also applies it? Couldn't we must move that logic up into the PrecommitPlugin and use that across the board?", "author": "mark-vieira", "createdAt": "2020-08-24T15:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcxMTU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475711587", "bodyText": "The PrecommitTaskPlugin already existed, and is used to ensure a precommit task exists. PrecommitPlugin is abstract and it's purpose is to make building a task that should be depended on by precommit easy. Here, though, we need to just get the precommit task added. There is no task to create, since they already exist for every java plugin.", "author": "rjernst", "createdAt": "2020-08-24T15:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475737041", "bodyText": "Oh I see, I'm getting confused by the fact that it's an inner class, also the fact that the abstract PrecommitPlugin actually does include some logic order java compilation tasks.\nI'm still not sure the java plugin logic should live in the PrecommitTaskPlugin. If it's purpose is just to create the precommit task then we should limit it there and move that logic to the ElasticsearchJavaPlugin. I'd also extract it as it's own class instead of being an inner class if we expect it to be used by other plugins. I'd probably also rename it to ElasticsearchLifecyclePlugin to comply with the similar convention used in Gradle, and we can add any other lifecycle tasks we create to it in the future.", "author": "mark-vieira", "createdAt": "2020-08-24T16:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0ODYyMg==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475748622", "bodyText": "The existing java plugin ordering is, I think, not possible outside of the current implementation. We make sure that compilation happens before the rest of the precommit tasks. We do that by adding a shoudlRunAfter when the task of each PrecommitPlugin is applied. We would have to iterate over all the dependencies of precommit, instead of applying to each task as it is added, which I'm not sure it possible?", "author": "rjernst", "createdAt": "2020-08-24T16:39:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc2MzUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475763503", "bodyText": "Yeah, the ordering stuff would be tricky to strip out, that can likely stay. The only way to do it \"properly\" would be to have all precommit tasks implement some kind of marker interface, then have the Java plugin add the ordering rule but we often create tasks that we don't own the implementation of, so that's not practically feasible.", "author": "mark-vieira", "createdAt": "2020-08-24T17:04:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgzMDM1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61439#discussion_r475830351", "bodyText": "I moved the plugin out to its own file in 06016fc", "author": "rjernst", "createdAt": "2020-08-24T19:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTAwODg1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "06016fc526cfda3db87dc6c56cc62d3643a11479", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java\nindex 455fc0d9853..8dc0a55d5cd 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitPlugin.java\n\n@@ -57,33 +54,4 @@ public abstract class PrecommitPlugin implements Plugin<Project> {\n \n     public abstract TaskProvider<? extends Task> createTask(Project project);\n \n-    public static class PrecommitTaskPlugin implements Plugin<Project> {\n-\n-        @Override\n-        public void apply(Project project) {\n-            TaskProvider<Task> precommit = project.getTasks().register(PRECOMMIT_TASK_NAME, t -> {\n-                t.setGroup(JavaBasePlugin.VERIFICATION_GROUP);\n-                t.setDescription(\"Runs all non-test checks\");\n-            });\n-\n-            project.getPluginManager()\n-                .withPlugin(\n-                    \"lifecycle-base\",\n-                    p -> project.getTasks().named(LifecycleBasePlugin.CHECK_TASK_NAME).configure(t -> t.dependsOn(precommit))\n-                );\n-            project.getPluginManager()\n-                .withPlugin(\n-                    \"java\",\n-                    p -> {\n-                        // run compilation as part of precommit\n-                        for (SourceSet sourceSet : GradleUtils.getJavaSourceSets(project)) {\n-                            precommit.configure(t -> t.dependsOn(sourceSet.getClassesTaskName()));\n-                        }\n-\n-                        // make sure tests run after all precommit tasks\n-                        project.getTasks().withType(Test.class).configureEach(t -> t.mustRunAfter(precommit));\n-                    }\n-                );\n-        }\n-    }\n }\n"}}, {"oid": "06016fc526cfda3db87dc6c56cc62d3643a11479", "url": "https://github.com/elastic/elasticsearch/commit/06016fc526cfda3db87dc6c56cc62d3643a11479", "message": "move task plugin out", "committedDate": "2020-08-24T19:00:07Z", "type": "commit"}]}