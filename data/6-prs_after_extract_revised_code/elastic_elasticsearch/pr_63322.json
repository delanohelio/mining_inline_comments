{"pr_number": 63322, "pr_title": "Add isFieldMapped method to QueryShardContext", "pr_createdAt": "2020-10-06T12:26:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63322", "timeline": [{"oid": "734d7f3c298414a63e8ff6763e157f3966e3c34a", "url": "https://github.com/elastic/elasticsearch/commit/734d7f3c298414a63e8ff6763e157f3966e3c34a", "message": "Add fieldType method to QueryShardContext\n\nAs part of #63239 we have moved some usages of `QueryShardContext#getMapperService` that were looking up a field type through the `fieldType` method, to use the existing `QueryShardContext#fieldMapper`. The latter though has additional handling for unmapped fields when the functionality is enabled, and may throw exception if the field is not mapped. This additional behaviour is not desirable and may cause issues in cases where the callers have their own specific handling for situations where the field is not mapped.\n\nTo address this we introduce an additional fieldType method to `QueryShardContext` that allows to simply look up a field type given its name.\n\nrelates to #63239", "committedDate": "2020-10-06T12:26:03Z", "type": "commit"}, {"oid": "eca9b268c77c5a40bf2355394cf8242d8a576944", "url": "https://github.com/elastic/elasticsearch/commit/eca9b268c77c5a40bf2355394cf8242d8a576944", "message": "javadocs", "committedDate": "2020-10-06T12:33:55Z", "type": "commit"}, {"oid": "09f5062d335de52cdfdbfe9d04aab6150ebd2f60", "url": "https://github.com/elastic/elasticsearch/commit/09f5062d335de52cdfdbfe9d04aab6150ebd2f60", "message": "leftover", "committedDate": "2020-10-06T12:35:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIzODIzMA==", "url": "https://github.com/elastic/elasticsearch/pull/63322#discussion_r500238230", "bodyText": "Can we put some javadocs on here, specifically around the fact that it may return null?", "author": "romseygeek", "createdAt": "2020-10-06T12:34:13Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -231,6 +231,10 @@ public MappedFieldType fieldMapper(String name) {\n         return failIfFieldMappingNotFound(name, mapperService.fieldType(name));\n     }\n \n+    public MappedFieldType fieldType(String name) {", "originalCommit": "734d7f3c298414a63e8ff6763e157f3966e3c34a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIzOTMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/63322#discussion_r500239306", "bodyText": "Too fast! Can you add a note about null?", "author": "romseygeek", "createdAt": "2020-10-06T12:35:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIzODIzMA=="}], "type": "inlineReview", "revised_code": {"commit": "09f5062d335de52cdfdbfe9d04aab6150ebd2f60", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\nindex b724844b09b..5ea20519f02 100644\n--- a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n+++ b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n\n@@ -227,10 +227,21 @@ public class QueryShardContext extends QueryRewriteContext {\n         return mapperService.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Returns the {@link MappedFieldType} for the provided field name.\n+     * If the field is not mapped, the behaviour depends on the index.query.parse.allow_unmapped_fields setting, which defaults to true.\n+     * In case unmapped fields are not allowed, either an exception is thrown or the field is automatically mapped as a text field.\n+     * @throws QueryShardException if unmapped fields are not allowed and automatically mapping unmapped fields as text is disabled.\n+     * @see QueryShardContext#setAllowUnmappedFields(boolean)\n+     * @see QueryShardContext#setMapUnmappedFieldAsString(boolean)\n+     */\n     public MappedFieldType fieldMapper(String name) {\n         return failIfFieldMappingNotFound(name, mapperService.fieldType(name));\n     }\n \n+    /**\n+     * Returns the {@link MappedFieldType} for the provided field name\n+     */\n     public MappedFieldType fieldType(String name) {\n         return mapperService.fieldType(name);\n     }\n"}}, {"oid": "957fa8b62969a96496c5c2ce16a784fceab9bcab", "url": "https://github.com/elastic/elasticsearch/commit/957fa8b62969a96496c5c2ce16a784fceab9bcab", "message": "javadocs", "committedDate": "2020-10-06T12:47:44Z", "type": "commit"}, {"oid": "d99e2cbcbc114bfae56774ad90beafeff21df8f8", "url": "https://github.com/elastic/elasticsearch/commit/d99e2cbcbc114bfae56774ad90beafeff21df8f8", "message": "javadocs", "committedDate": "2020-10-06T12:50:20Z", "type": "commit"}, {"oid": "049c0222493ee8c755827199ba0e89c18099efc2", "url": "https://github.com/elastic/elasticsearch/commit/049c0222493ee8c755827199ba0e89c18099efc2", "message": "replace fieldType with isMappedField", "committedDate": "2020-10-06T13:48:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5Njg4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63322#discussion_r500296887", "bodyText": "I moved this logic to the caller, it is now part of the lookup function that is provided.", "author": "javanna", "createdAt": "2020-10-06T13:51:14Z", "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -90,10 +90,6 @@ public Status needsField(FieldInfo fieldInfo) {\n     public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup) {\n         for (Map.Entry<String, List<Object>> entry : fields().entrySet()) {\n             MappedFieldType fieldType = fieldTypeLookup.apply(entry.getKey());\n-            if (fieldType == null) {", "originalCommit": "049c0222493ee8c755827199ba0e89c18099efc2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "92a8c731607ae49f945dc4f6993a90f6c4402cbd", "url": "https://github.com/elastic/elasticsearch/commit/92a8c731607ae49f945dc4f6993a90f6c4402cbd", "message": "true != false", "committedDate": "2020-10-06T15:02:22Z", "type": "commit"}]}