{"pr_number": 61350, "pr_title": "Scripting: Converts casting and def support", "pr_createdAt": "2020-08-19T21:25:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61350", "timeline": [{"oid": "c858a5ae9cd7eea7b24c927940fc5001f5c2ba13", "url": "https://github.com/elastic/elasticsearch/commit/c858a5ae9cd7eea7b24c927940fc5001f5c2ba13", "message": "Scripting: Converts casting and def support\n\nPainless will cast returned values to a converter\nargument type, if necessary.\n\nPainless will also look for a special `convertFromDef`\nconverter which is called to explicitly handle `def`\nconversions.\n\n`convertFromDef` must handle all valid def conversions.\n\nRefs: #59647", "committedDate": "2020-08-19T21:25:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMzNzM0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61350#discussion_r473337342", "bodyText": "TODO: test these failures", "author": "stu-elastic", "createdAt": "2020-08-19T21:25:58Z", "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ScriptClassInfo.java", "diffHunk": "@@ -92,17 +94,33 @@ public ScriptClassInfo(PainlessLookup painlessLookup, Class<?> baseClass) {\n         if (executeMethod == null) {\n             throw new IllegalStateException(\"no execute method found\");\n         }\n-        ArrayList<ConverterSignature> converterSignatures = new ArrayList<>();\n+        ArrayList<FunctionTable.LocalFunction> converters = new ArrayList<>();\n+        FunctionTable.LocalFunction defConverter = null;\n         for (java.lang.reflect.Method m : baseClass.getMethods()) {\n             if (m.getName().startsWith(\"convertFrom\") &&\n                 m.getParameterTypes().length == 1 &&\n                 m.getReturnType() == returnType &&\n                 Modifier.isStatic(m.getModifiers())) {\n \n-                converterSignatures.add(new ConverterSignature(m));\n+                if (m.getName().equals(\"convertFromDef\")) {", "originalCommit": "c858a5ae9cd7eea7b24c927940fc5001f5c2ba13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MTkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/61350#discussion_r474141905", "bodyText": "Done", "author": "stu-elastic", "createdAt": "2020-08-20T17:04:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzMzNzM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5c8801331ea592cc95290dfb4850883f32506448", "chunk": "diff --git a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ScriptClassInfo.java b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ScriptClassInfo.java\nindex 225ac145a2e..40c4d6503b2 100644\n--- a/modules/lang-painless/src/main/java/org/elasticsearch/painless/ScriptClassInfo.java\n+++ b/modules/lang-painless/src/main/java/org/elasticsearch/painless/ScriptClassInfo.java\n\n@@ -107,9 +107,6 @@ public class ScriptClassInfo {\n                         throw new IllegalStateException(\"convertFromDef must take a single Object as an argument, \" +\n                             \"not [\" + m.getParameterTypes()[0] + \"]\");\n                     }\n-                    if (defConverter != null) {\n-                        throw new IllegalStateException(\"duplicate convertFromDef converters\");\n-                    }\n                     defConverter = new FunctionTable.LocalFunction(m.getName(), m.getReturnType(), Arrays.asList(m.getParameterTypes()),\n                                                                    true, true);\n                 } else {\n"}}, {"oid": "5c8801331ea592cc95290dfb4850883f32506448", "url": "https://github.com/elastic/elasticsearch/commit/5c8801331ea592cc95290dfb4850883f32506448", "message": "Remove unreachable branch, test convertFromDef arg guard", "committedDate": "2020-08-20T17:04:42Z", "type": "commit"}, {"oid": "414cdc72da67964cb1c46bec1ead88a174256058", "url": "https://github.com/elastic/elasticsearch/commit/414cdc72da67964cb1c46bec1ead88a174256058", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into scripting/59647-def-casting", "committedDate": "2020-08-20T17:52:51Z", "type": "commit"}]}