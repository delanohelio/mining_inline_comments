{"pr_number": 51707, "pr_title": "Improve docker error message", "pr_createdAt": "2020-01-30T21:37:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51707", "timeline": [{"oid": "a6ab73c37535b9c59b47e420123bf4d4e895b83e", "url": "https://github.com/elastic/elasticsearch/commit/a6ab73c37535b9c59b47e420123bf4d4e895b83e", "message": "Improve docker error message\n\nAdds more information to docker failures, so instead of not very helpful\n```\nProcess 'command '/usr/bin/docker'' finished with non-zero exit value 1\n```\nit now prints a more actionable message such as\n```\nError occurred running command [/usr/bin/docker version --format {{.Server.Versi\non}}] stderr: [Got permission denied while trying to connect to the Docker daemo\nn socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v\n1.40/version: dial unix /var/run/docker.sock: connect: permission denied] stdout\n: []\n```", "committedDate": "2020-01-30T21:32:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI3OTg3OA==", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373279878", "bodyText": "I think it would be more readable with stderr and stdout moved to their own lines.", "author": "rjernst", "createdAt": "2020-01-31T01:30:54Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -208,14 +208,24 @@ private static Result runCommand(Project project, String... args) {\n         ByteArrayOutputStream stdout = new ByteArrayOutputStream();\n         ByteArrayOutputStream stderr = new ByteArrayOutputStream();\n \n-        final ExecResult execResult = project.exec(spec -> {\n-            // The redundant cast is to silence a compiler warning.\n-            spec.setCommandLine((Object[]) args);\n-            spec.setStandardOutput(stdout);\n-            spec.setErrorOutput(stderr);\n-        });\n-\n-        return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        try {\n+            final ExecResult execResult = project.exec(spec -> {\n+                // The redundant cast is to silence a compiler warning.\n+                spec.setCommandLine((Object[]) args);\n+                spec.setStandardOutput(stdout);\n+                spec.setErrorOutput(stderr);\n+            });\n+            return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        } catch (GradleException ex) {\n+            final String message = String.format(\n+                Locale.ROOT,\n+                \"Error occurred running command [%s] stderr: [%s] stdout: [%s]\",", "originalCommit": "a6ab73c37535b9c59b47e420123bf4d4e895b83e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "844d0f8c74987b00b90aa91faf1bb51247ba5577", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\nindex 4314b878342..8d7e3c85323 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n\n@@ -217,12 +217,14 @@ public class DockerUtils {\n             });\n             return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n         } catch (GradleException ex) {\n+            String error = stderr.toString().trim();\n+            String output = stdout.toString().trim();\n             final String message = String.format(\n                 Locale.ROOT,\n-                \"Error occurred running command [%s] stderr: [%s] stdout: [%s]\",\n+                \"Error occurred running command [%s]:%s%s\",\n                 String.join(\" \", args),\n-                stderr.toString().trim(),\n-                stdout.toString().trim()\n+                error.isEmpty() ? \"\" : \"\\n\" + error,\n+                output.isEmpty() ? \"\" : \"\\n\" + output\n             );\n             throw new GradleException(message, ex);\n         }\n"}}, {"oid": "844d0f8c74987b00b90aa91faf1bb51247ba5577", "url": "https://github.com/elastic/elasticsearch/commit/844d0f8c74987b00b90aa91faf1bb51247ba5577", "message": "Improve error format", "committedDate": "2020-01-31T16:01:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2NzA5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373567095", "bodyText": "Rather than doing this via generic exception handling let's set spec.setIgnoreExitValue(true) and throw our own exception if the result is a non-zero exit value. That way if we blow up for some other reason (bad config, Gradle issue) we aren't returning a potentially misleading exception message.", "author": "mark-vieira", "createdAt": "2020-01-31T16:26:18Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -208,14 +208,26 @@ private static Result runCommand(Project project, String... args) {\n         ByteArrayOutputStream stdout = new ByteArrayOutputStream();\n         ByteArrayOutputStream stderr = new ByteArrayOutputStream();\n \n-        final ExecResult execResult = project.exec(spec -> {\n-            // The redundant cast is to silence a compiler warning.\n-            spec.setCommandLine((Object[]) args);\n-            spec.setStandardOutput(stdout);\n-            spec.setErrorOutput(stderr);\n-        });\n-\n-        return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        try {\n+            final ExecResult execResult = project.exec(spec -> {\n+                // The redundant cast is to silence a compiler warning.\n+                spec.setCommandLine((Object[]) args);\n+                spec.setStandardOutput(stdout);\n+                spec.setErrorOutput(stderr);\n+            });\n+            return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        } catch (GradleException ex) {", "originalCommit": "844d0f8c74987b00b90aa91faf1bb51247ba5577", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "853f192ef7bce1595617f4411fbb56a64954ed67", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\nindex 8d7e3c85323..c5e51d6eef9 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n\n@@ -208,26 +206,14 @@ public class DockerUtils {\n         ByteArrayOutputStream stdout = new ByteArrayOutputStream();\n         ByteArrayOutputStream stderr = new ByteArrayOutputStream();\n \n-        try {\n-            final ExecResult execResult = project.exec(spec -> {\n-                // The redundant cast is to silence a compiler warning.\n-                spec.setCommandLine((Object[]) args);\n-                spec.setStandardOutput(stdout);\n-                spec.setErrorOutput(stderr);\n-            });\n-            return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n-        } catch (GradleException ex) {\n-            String error = stderr.toString().trim();\n-            String output = stdout.toString().trim();\n-            final String message = String.format(\n-                Locale.ROOT,\n-                \"Error occurred running command [%s]:%s%s\",\n-                String.join(\" \", args),\n-                error.isEmpty() ? \"\" : \"\\n\" + error,\n-                output.isEmpty() ? \"\" : \"\\n\" + output\n-            );\n-            throw new GradleException(message, ex);\n-        }\n+        final ExecResult execResult = project.exec(spec -> {\n+            // The redundant cast is to silence a compiler warning.\n+            spec.setCommandLine((Object[]) args);\n+            spec.setStandardOutput(stdout);\n+            spec.setErrorOutput(stderr);\n+            spec.setIgnoreExitValue(true);\n+        });\n+        return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n     }\n \n     /**\n"}}, {"oid": "853f192ef7bce1595617f4411fbb56a64954ed67", "url": "https://github.com/elastic/elasticsearch/commit/853f192ef7bce1595617f4411fbb56a64954ed67", "message": "Use error code instead of generic exception interception", "committedDate": "2020-01-31T19:27:39Z", "type": "commit"}, {"oid": "5f117cbb97bd1e29568dd8447c617ab0a8c00b74", "url": "https://github.com/elastic/elasticsearch/commit/5f117cbb97bd1e29568dd8447c617ab0a8c00b74", "message": "Merge remote-tracking branch 'elastic/master' into fix-docker-error-message", "committedDate": "2020-01-31T19:38:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4NDMxNA==", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373684314", "bodyText": "This seems unnecessary to me. This final message is meant to be a catch-all anyway so I don't think there's much benefit in trying to be any more specific in the error message.", "author": "mark-vieira", "createdAt": "2020-01-31T21:03:48Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -165,11 +155,19 @@ public static void assertDockerIsAvailable(Project project, List<String> tasks)\n             throwDockerRequiredException(message);\n         }\n \n+        final String operation;\n+        if (availability.version == null) {", "originalCommit": "5f117cbb97bd1e29568dd8447c617ab0a8c00b74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5MDkyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373690921", "bodyText": "It was helpful to me to figure out which command docker is failing on my machine, so I can run this command and see if it works or not. I am ok with removing it, since the error message was more helpful anyway.", "author": "imotov", "createdAt": "2020-01-31T21:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4NDMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5NDgyMg==", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373694822", "bodyText": "If we consider this valuable I'd prefer we wire the actual command through Result and just display that in this error rather than a simple hard-coded description.", "author": "mark-vieira", "createdAt": "2020-01-31T21:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4NDMxNA=="}], "type": "inlineReview", "revised_code": {"commit": "f394b775d03081826e7efc3ec29df9a72e1495ca", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\nindex c5e51d6eef9..784d97333d2 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java\n\n@@ -155,20 +155,13 @@ public class DockerUtils {\n             throwDockerRequiredException(message);\n         }\n \n-        final String operation;\n-        if (availability.version == null) {\n-            operation = \"getting docker version\";\n-        } else {\n-            operation = \"execute a privileged command\";\n-        }\n-\n         // Some other problem, print the error\n         final String message = String.format(\n             Locale.ROOT,\n-            \"a problem occurred while %s using Docker from [%s] yet it is required to run the following task%s: \\n%s\\n\"\n+            \"a problem occurred while using Docker from [%s]%s yet it is required to run the following task%s: \\n%s\\n\"\n                 + \"the problem is that Docker exited with exit code [%d] with standard error output:\\n%s\",\n-            operation,\n             availability.path,\n+            availability.version == null ? \"\" : \" v\" + availability.version,\n             tasks.size() > 1 ? \"s\" : \"\",\n             String.join(\"\\n\", tasks),\n             availability.lastCommand.exitCode,\n"}}, {"oid": "f394b775d03081826e7efc3ec29df9a72e1495ca", "url": "https://github.com/elastic/elasticsearch/commit/f394b775d03081826e7efc3ec29df9a72e1495ca", "message": "Remove operation from the error log message", "committedDate": "2020-02-03T15:11:48Z", "type": "commit"}, {"oid": "e6fd8cc5676cc58c908f5a4b4fb299b14107542d", "url": "https://github.com/elastic/elasticsearch/commit/e6fd8cc5676cc58c908f5a4b4fb299b14107542d", "message": "Merge remote-tracking branch 'elastic/master' into fix-docker-error-message", "committedDate": "2020-02-03T15:12:07Z", "type": "commit"}]}