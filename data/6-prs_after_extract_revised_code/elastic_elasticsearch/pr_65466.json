{"pr_number": 65466, "pr_title": "Removing double call to ValuesSourceRegistry by passing aggregator suppliers as aggregator factory constructor arguments", "pr_createdAt": "2020-11-24T20:41:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65466", "timeline": [{"oid": "24b3c07b698b43c2cc7f4ac2055852b968046814", "url": "https://github.com/elastic/elasticsearch/commit/24b3c07b698b43c2cc7f4ac2055852b968046814", "message": "Saving return value from first Aggregator Supplier call and passing it to innerBuild", "committedDate": "2020-11-24T19:39:43Z", "type": "commit"}, {"oid": "96f8f57dc4daedc766adde634989c740f8a8b0bd", "url": "https://github.com/elastic/elasticsearch/commit/96f8f57dc4daedc766adde634989c740f8a8b0bd", "message": "Making use of the aggregatorSupplier passed to the aggregation's builders through innerBuild", "committedDate": "2020-11-24T19:39:43Z", "type": "commit"}, {"oid": "96f8f57dc4daedc766adde634989c740f8a8b0bd", "url": "https://github.com/elastic/elasticsearch/commit/96f8f57dc4daedc766adde634989c740f8a8b0bd", "message": "Making use of the aggregatorSupplier passed to the aggregation's builders through innerBuild", "committedDate": "2020-11-24T19:39:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ4NzgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/65466#discussion_r533487814", "bodyText": "So, as you noted in your comments, having to use a bare Object here is a bit of a smell.  But, we don't need an interface to solve it, we already have a solution.  The way the generics are set up, we know the class we get out of the registry has to match the type on the registry key.  If you look at how the factories get the suppliers, they never have to cast it, because they know the key they're using, like this:\n  DateHistogramAggregationSupplier aggregatorSupplier = context.getValuesSourceRegistry()\t\n            .getAggregator(DateHistogramAggregationBuilder.REGISTRY_KEY, config);\n\nWe can't do that here, because we don't know which type we're expecting.  But, we can do it from within innerBuild, since at that point we'll be in a specific aggregation.  So essentially we just want to pull the supplier fetching code up from the factory's doCreateInternal method to the builder's internalBuild method, and pass it on into the factory from there.  That still meets out validation need, it'll just throw from one level deeper if the mapping is bad, and should dodge all this bare Object business.", "author": "not-napoleon", "createdAt": "2020-12-01T15:11:17Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java", "diffHunk": "@@ -347,16 +347,20 @@ public ZoneId timeZone() {\n     protected final ValuesSourceAggregatorFactory doBuild(AggregationContext context, AggregatorFactory parent,\n                                                           Builder subFactoriesBuilder) throws IOException {\n         ValuesSourceConfig config = resolveConfig(context);\n+\n+        ValuesSourceAggregatorFactory factory;\n         if (context.getValuesSourceRegistry().isRegistered(getRegistryKey())) {\n             /*\n             if the aggregation uses the values source registry, test if the resolved values source type is compatible with this aggregation.\n             This call will throw if the mapping isn't registered, which is what we want.  Note that we need to throw from here because\n             AbstractAggregationBuilder#build, which called this, will attempt to register the agg usage next, and if the usage is invalid\n             that will fail with a weird error.\n              */\n-            context.getValuesSourceRegistry().getAggregator(getRegistryKey(), config);\n+            Object aggregatorSupplier = context.getValuesSourceRegistry().getAggregator(getRegistryKey(), config);", "originalCommit": "96f8f57dc4daedc766adde634989c740f8a8b0bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "311ed3f2b4169a3418b7e6728e55ef650393ac14", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\nindex 7c69f316f31..7c35b3df574 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\n\n@@ -349,18 +351,8 @@ public abstract class ValuesSourceAggregationBuilder<AB extends ValuesSourceAggr\n         ValuesSourceConfig config = resolveConfig(context);\n \n         ValuesSourceAggregatorFactory factory;\n-        if (context.getValuesSourceRegistry().isRegistered(getRegistryKey())) {\n-            /*\n-            if the aggregation uses the values source registry, test if the resolved values source type is compatible with this aggregation.\n-            This call will throw if the mapping isn't registered, which is what we want.  Note that we need to throw from here because\n-            AbstractAggregationBuilder#build, which called this, will attempt to register the agg usage next, and if the usage is invalid\n-            that will fail with a weird error.\n-             */\n-            Object aggregatorSupplier = context.getValuesSourceRegistry().getAggregator(getRegistryKey(), config);\n-            factory = innerBuild(context, config, parent, subFactoriesBuilder, aggregatorSupplier);\n-        } else {\n-            factory = innerBuild(context, config, parent, subFactoriesBuilder, null);\n-        }\n+\n+        factory = innerBuild(context, config, parent, subFactoriesBuilder);\n         return factory;\n     }\n \n"}}, {"oid": "311ed3f2b4169a3418b7e6728e55ef650393ac14", "url": "https://github.com/elastic/elasticsearch/commit/311ed3f2b4169a3418b7e6728e55ef650393ac14", "message": "Fixing implementation based on feedback", "committedDate": "2020-12-01T17:43:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1MjU4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65466#discussion_r533652581", "bodyText": "Nit: This formatting-only change doesn't change to the correct style.", "author": "not-napoleon", "createdAt": "2020-12-01T19:04:11Z", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/analytics/StringStatsAggregationBuilder.java", "diffHunk": "@@ -103,7 +103,7 @@ public BucketCardinality bucketCardinality() {\n \n     @Override\n     protected ValuesSourceAggregatorFactory innerBuild(AggregationContext context, ValuesSourceConfig config,\n-            AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {\n+                                                       AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {", "originalCommit": "311ed3f2b4169a3418b7e6728e55ef650393ac14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY2MDY2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/65466#discussion_r533660663", "bodyText": "Will fix it with the conflicts! Sorry, completely missed it when I was reviewing the files I changed.", "author": "Thlamz", "createdAt": "2020-12-01T19:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY1MjU4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "01bf2f52732c4c51e7e81850a1ac1ee0cd91c260", "chunk": "diff --git a/client/rest-high-level/src/main/java/org/elasticsearch/client/analytics/StringStatsAggregationBuilder.java b/client/rest-high-level/src/main/java/org/elasticsearch/client/analytics/StringStatsAggregationBuilder.java\nindex bd4b3e84c4b..6929ca26c4d 100644\n--- a/client/rest-high-level/src/main/java/org/elasticsearch/client/analytics/StringStatsAggregationBuilder.java\n+++ b/client/rest-high-level/src/main/java/org/elasticsearch/client/analytics/StringStatsAggregationBuilder.java\n\n@@ -103,7 +103,7 @@ public class StringStatsAggregationBuilder extends ValuesSourceAggregationBuilde\n \n     @Override\n     protected ValuesSourceAggregatorFactory innerBuild(AggregationContext context, ValuesSourceConfig config,\n-                                                       AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {\n+        AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {\n         throw new UnsupportedOperationException();\n     }\n \n"}}, {"oid": "e48c7c0f00333a81d336fc66d5c098217bd6a9e8", "url": "https://github.com/elastic/elasticsearch/commit/e48c7c0f00333a81d336fc66d5c098217bd6a9e8", "message": "Merge remote-tracking branch 'upstream/master'\n\n# Conflicts:\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoHashGridAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/AutoDateHistogramAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/HistogramAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/VariableWidthHistogramAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/missing/MissingAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/range/AbstractRangeAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/range/BinaryRangeAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/sampler/DiversifiedAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/AvgAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/CardinalityAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/ExtendedStatsAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoCentroidAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/MaxAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/MedianAbsoluteDeviationAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/MinAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/StatsAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/SumAggregatorFactory.java\n#\tserver/src/main/java/org/elasticsearch/search/aggregations/metrics/ValueCountAggregatorFactory.java\n#\tx-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/boxplot/BoxplotAggregatorFactory.java\n#\tx-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/rate/RateAggregatorFactory.java\n#\tx-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/stringstats/StringStatsAggregatorFactory.java", "committedDate": "2020-12-02T01:25:36Z", "type": "commit"}, {"oid": "01bf2f52732c4c51e7e81850a1ac1ee0cd91c260", "url": "https://github.com/elastic/elasticsearch/commit/01bf2f52732c4c51e7e81850a1ac1ee0cd91c260", "message": "Fixing things before submitting", "committedDate": "2020-12-02T03:41:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDIxOTY2OA==", "url": "https://github.com/elastic/elasticsearch/pull/65466#discussion_r534219668", "bodyText": "Shouldn't this still have the @Override annotation?", "author": "not-napoleon", "createdAt": "2020-12-02T14:42:04Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java", "diffHunk": "@@ -81,11 +84,11 @@ public long minDocCount() {\n         return minDocCount;\n     }\n \n-    @Override\n-    protected Aggregator doCreateInternal(Aggregator parent, CardinalityUpperBound cardinality, Map<String, Object> metadata)\n-        throws IOException {\n-        DateHistogramAggregationSupplier aggregatorSupplier = context.getValuesSourceRegistry()\n-            .getAggregator(DateHistogramAggregationBuilder.REGISTRY_KEY, config);\n+    protected Aggregator doCreateInternal(", "originalCommit": "01bf2f52732c4c51e7e81850a1ac1ee0cd91c260", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88f49b034ff46002ac9575ecb89cd11ceced55a5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java\nindex d82efd03bda..a265d05a468 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java\n\n@@ -84,6 +84,7 @@ public final class DateHistogramAggregatorFactory extends ValuesSourceAggregator\n         return minDocCount;\n     }\n \n+    @Override\n     protected Aggregator doCreateInternal(\n         Aggregator parent,\n         CardinalityUpperBound cardinality,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUxNzc0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65466#discussion_r534517742", "bodyText": "I'd like to leave some version of this comment; I find it useful to note that this is our last chance to check the values source type mapping before we attempt to register usage.  Maybe something like\n/*\nThe inner builder implementation is responsible for validating the \nValuesSourceType mapping, typically by checking if an aggregation\nsupplier has been registered for that type on this aggregation, and\nthrow IllegalArgumentException if the mapping is not valid.  Note \nthat we need to throw from here because \nAbstractAggregationBuilder#build, which called this, will attempt to\nregister the agg usage next, and if the usage is invalid that will fail\nwith a weird error.\n*/", "author": "not-napoleon", "createdAt": "2020-12-02T22:14:29Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java", "diffHunk": "@@ -347,16 +349,10 @@ public ZoneId timeZone() {\n     protected final ValuesSourceAggregatorFactory doBuild(AggregationContext context, AggregatorFactory parent,\n                                                           Builder subFactoriesBuilder) throws IOException {\n         ValuesSourceConfig config = resolveConfig(context);\n-        if (context.getValuesSourceRegistry().isRegistered(getRegistryKey())) {\n-            /*\n-            if the aggregation uses the values source registry, test if the resolved values source type is compatible with this aggregation.\n-            This call will throw if the mapping isn't registered, which is what we want.  Note that we need to throw from here because\n-            AbstractAggregationBuilder#build, which called this, will attempt to register the agg usage next, and if the usage is invalid\n-            that will fail with a weird error.\n-             */", "originalCommit": "01bf2f52732c4c51e7e81850a1ac1ee0cd91c260", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88f49b034ff46002ac9575ecb89cd11ceced55a5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\nindex 7c35b3df574..0bcf83be023 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregationBuilder.java\n\n@@ -352,6 +352,16 @@ public abstract class ValuesSourceAggregationBuilder<AB extends ValuesSourceAggr\n \n         ValuesSourceAggregatorFactory factory;\n \n+        /*\n+        The inner builder implementation is responsible for validating the\n+        ValuesSourceType mapping, typically by checking if an aggregation\n+        supplier has been registered for that type on this aggregation, and\n+        throw IllegalArgumentException if the mapping is not valid.  Note\n+        that we need to throw from here because\n+        AbstractAggregationBuilder#build, which called this, will attempt to\n+        register the agg usage next, and if the usage is invalid that will fail\n+        with a weird error.\n+        */\n         factory = innerBuild(context, config, parent, subFactoriesBuilder);\n         return factory;\n     }\n"}}, {"oid": "88f49b034ff46002ac9575ecb89cd11ceced55a5", "url": "https://github.com/elastic/elasticsearch/commit/88f49b034ff46002ac9575ecb89cd11ceced55a5", "message": "Touching up based on feedback", "committedDate": "2020-12-02T22:52:56Z", "type": "commit"}, {"oid": "d2f50662c95b8b1738ca79f539eb219be30bf691", "url": "https://github.com/elastic/elasticsearch/commit/d2f50662c95b8b1738ca79f539eb219be30bf691", "message": "Merge branch 'master' into master", "committedDate": "2020-12-03T18:09:12Z", "type": "commit"}]}