{"pr_number": 55889, "pr_title": "In field retrieval API, handle non-standard source paths.", "pr_createdAt": "2020-04-28T19:36:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55889", "timeline": [{"oid": "129e0b7c2e703f7908be0471860856199f56f689", "url": "https://github.com/elastic/elasticsearch/commit/129e0b7c2e703f7908be0471860856199f56f689", "message": "Resolve field aliases and multi-fields.\n\nAlso handle values that have been copied into the field through copy_to.", "committedDate": "2020-04-28T20:38:47Z", "type": "commit"}, {"oid": "129e0b7c2e703f7908be0471860856199f56f689", "url": "https://github.com/elastic/elasticsearch/commit/129e0b7c2e703f7908be0471860856199f56f689", "message": "Resolve field aliases and multi-fields.\n\nAlso handle values that have been copied into the field through copy_to.", "committedDate": "2020-04-28T20:38:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5NjQ3OA==", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416896478", "bodyText": "I think you can set up copy_to the same field multiple times. I imagine this won't perfectly emulate that. But that is almost certainly ok.", "author": "nik9000", "createdAt": "2020-04-28T20:20:13Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -80,6 +94,17 @@ public FieldTypeLookup copyAndAddAll(Collection<FieldMapper> fieldMappers,\n             if (fieldMapper instanceof DynamicKeyFieldMapper) {\n                 dynamicKeyMappers.put(fieldName, (DynamicKeyFieldMapper) fieldMapper);\n             }\n+\n+            for (String targetField : fieldMapper.copyTo().copyToFields()) {\n+                Set<String> sourcePath = sourcePaths.get(targetField);\n+                if (sourcePath == null) {\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Set.of(targetField, fieldName));\n+                } else if (sourcePath.contains(fieldName) == false) {\n+                    Set<String> newSourcePath = new HashSet<>(sourcePath);\n+                    newSourcePath.add(fieldName);\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Collections.unmodifiableSet(newSourcePath));\n+                }", "originalCommit": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0NjQ0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417446446", "bodyText": "\ud83d\udc4d I also think it's okay not to emulate that.", "author": "jtibshirani", "createdAt": "2020-04-29T16:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5NjQ3OA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg==", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416919902", "bodyText": "I wonder if this should return something that has an extractValue(SourceLookup) method on it. I'm just thinking of types constant_keyword and the formatting stuff we talked about over video. Not that now is the time to build that, but maybe this is the place to handle it.", "author": "nik9000", "createdAt": "2020-04-28T21:01:47Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -602,6 +602,14 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Given a field name, returns its possible paths in the _source. For example,\n+     * the 'source path' for a multi-field is the path to its parent field.\n+     */\n+    public Set<String> sourcePath(String fullName) {", "originalCommit": "129e0b7c2e703f7908be0471860856199f56f689", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0Njk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417446996", "bodyText": "Will keep this in mind in the next PR where we'll handle field-specific behavior like formatting.", "author": "jtibshirani", "createdAt": "2020-04-29T16:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0ODMxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417448311", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-04-29T16:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg=="}], "type": "inlineReview", "revised_code": null}]}