{"pr_number": 63701, "pr_title": "Remove project usages in internal tasks for better configuration cache support", "pr_createdAt": "2020-10-14T18:59:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63701", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NTY2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63701#discussion_r504975661", "bodyText": "Why not use a DirectoryProperty here?", "author": "mark-vieira", "createdAt": "2020-10-14T21:13:54Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ForbiddenPatternsTask.java", "diffHunk": "@@ -164,4 +173,11 @@ public void rule(Map<String, String> props) {\n         // TODO: fail if pattern contains a newline, it won't work (currently)\n         patterns.put(name, pattern);\n     }\n+\n+    @Internal\n+    abstract ListProperty<FileTree> getSourceFolders();\n+\n+    void setRootDir(File rootDir) {", "originalCommit": "192509209029c8d70513ec03968248f2e3f68b92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fc6fb3e7d5197e47d87c8ed1ca49225f80211bd3", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ForbiddenPatternsTask.java b/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ForbiddenPatternsTask.java\nindex d3112adf376..2f5215fd8be 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ForbiddenPatternsTask.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ForbiddenPatternsTask.java\n\n@@ -177,7 +177,7 @@ public abstract class ForbiddenPatternsTask extends DefaultTask {\n     @Internal\n     abstract ListProperty<FileTree> getSourceFolders();\n \n-    void setRootDir(File rootDir) {\n-        this.rootDir = rootDir;\n-    }\n+    @InputDirectory\n+    @Optional\n+    abstract DirectoryProperty getRootDir();\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NjA4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63701#discussion_r504976089", "bodyText": "Where did we land on using method injection vs constructor injection? Should we standardize on one vs the other?", "author": "mark-vieira", "createdAt": "2020-10-14T21:14:45Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/PrecommitTask.java", "diffHunk": "@@ -31,12 +33,16 @@\n \n     @OutputFile\n     public File getSuccessMarker() {\n-        return new File(getProject().getBuildDir(), \"markers/\" + this.getName());\n+        return new File(getProjectLayout().getBuildDirectory().getAsFile().get(), \"markers/\" + this.getName());\n     }\n \n     @TaskAction\n     public void writeMarker() throws IOException {\n         Files.write(getSuccessMarker().toPath(), new byte[] {}, StandardOpenOption.CREATE);\n     }\n \n+    @Inject\n+    protected ProjectLayout getProjectLayout() {", "originalCommit": "192509209029c8d70513ec03968248f2e3f68b92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzMzMyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63701#discussion_r505333321", "bodyText": "I think by default we agreed on ctor injection. In this case I went with method injection due to keeping this local as this is an abstract task and all its descends would need to pass the injected service down here", "author": "breskeby", "createdAt": "2020-10-15T08:26:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NjA4OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "fc6fb3e7d5197e47d87c8ed1ca49225f80211bd3", "url": "https://github.com/elastic/elasticsearch/commit/fc6fb3e7d5197e47d87c8ed1ca49225f80211bd3", "message": "Apply review feedback", "committedDate": "2020-10-15T09:19:50Z", "type": "forcePushed"}, {"oid": "7b88c62272c9b5539e01f06c7a5d0dd263c7362d", "url": "https://github.com/elastic/elasticsearch/commit/7b88c62272c9b5539e01f06c7a5d0dd263c7362d", "message": "Fix imports", "committedDate": "2020-10-21T10:01:12Z", "type": "forcePushed"}, {"oid": "3a879f55ee1feb0b7176384ee4660edc577826e0", "url": "https://github.com/elastic/elasticsearch/commit/3a879f55ee1feb0b7176384ee4660edc577826e0", "message": "Fix configuration cache incompatibilities\n\n- configurations are not serializable so we ported it to FileCollection which is enough\nfor the task properties", "committedDate": "2020-11-02T13:54:51Z", "type": "forcePushed"}, {"oid": "dce0b823cccc51fa6ec091f848373a32750f40ae", "url": "https://github.com/elastic/elasticsearch/commit/dce0b823cccc51fa6ec091f848373a32750f40ae", "message": "Remove more project usages in tasks for better configuration cache support\n\n- This brings us closer to be compliant with the gradle configuration cache feature\n- All internal tasks used during precommit should now be free of invalid project references", "committedDate": "2020-11-09T21:36:36Z", "type": "commit"}, {"oid": "6d681da0a4812d90febe6440dbb5defbacdb1b0f", "url": "https://github.com/elastic/elasticsearch/commit/6d681da0a4812d90febe6440dbb5defbacdb1b0f", "message": "Apply review feedback", "committedDate": "2020-11-09T21:36:36Z", "type": "commit"}, {"oid": "8d92baac42abc18f7ca8c271a9177e7012a93967", "url": "https://github.com/elastic/elasticsearch/commit/8d92baac42abc18f7ca8c271a9177e7012a93967", "message": "Fix project reference in execution time in licenseheader plugin", "committedDate": "2020-11-09T21:36:36Z", "type": "commit"}, {"oid": "bd6ea255f2bf9cc8ad3d75149908b7611454ebdb", "url": "https://github.com/elastic/elasticsearch/commit/bd6ea255f2bf9cc8ad3d75149908b7611454ebdb", "message": "Fix Path sensitivity for forbidden pattern task", "committedDate": "2020-11-09T21:36:37Z", "type": "commit"}, {"oid": "df0442ba59b0b14a795a03506e6a5c48df4fe874", "url": "https://github.com/elastic/elasticsearch/commit/df0442ba59b0b14a795a03506e6a5c48df4fe874", "message": "Only track path to rootDir not all content", "committedDate": "2020-11-09T21:36:37Z", "type": "commit"}, {"oid": "053480071f7238d1a5014f01b24d6b0518428801", "url": "https://github.com/elastic/elasticsearch/commit/053480071f7238d1a5014f01b24d6b0518428801", "message": "Fix imports", "committedDate": "2020-11-09T21:36:37Z", "type": "commit"}, {"oid": "5ffe1881787e232bc27a26486f8cb48eae4d0162", "url": "https://github.com/elastic/elasticsearch/commit/5ffe1881787e232bc27a26486f8cb48eae4d0162", "message": "Fix configuration cache incompatibilities\n\n- configurations are not serializable so we ported it to FileCollection which is enough\nfor the task properties", "committedDate": "2020-11-09T21:36:37Z", "type": "commit"}, {"oid": "5ffe1881787e232bc27a26486f8cb48eae4d0162", "url": "https://github.com/elastic/elasticsearch/commit/5ffe1881787e232bc27a26486f8cb48eae4d0162", "message": "Fix configuration cache incompatibilities\n\n- configurations are not serializable so we ported it to FileCollection which is enough\nfor the task properties", "committedDate": "2020-11-09T21:36:37Z", "type": "forcePushed"}]}