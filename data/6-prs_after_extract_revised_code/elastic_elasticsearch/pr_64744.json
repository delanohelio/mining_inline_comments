{"pr_number": 64744, "pr_title": "Prevent some BigArray leaking", "pr_createdAt": "2020-11-06T21:15:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64744", "timeline": [{"oid": "f6c9a8281fc8dd42f58f67c8efa0577604508d6f", "url": "https://github.com/elastic/elasticsearch/commit/f6c9a8281fc8dd42f58f67c8efa0577604508d6f", "message": "Prevent some BigArray leaking\n\nIts possible for us to fail to give bytes back to the circuit breaker if\nwe fail building some objects part way. Worse, if the object allocates a\nwhole page with of memory and *then* fails then it'll keep the memory\nallocated forever.\n\nThis adds a test utility we can use to assert that it doesn't happen and\nthen applies it to a bunch of part of the aggregations framework,\ncatching a few bugs in the process.", "committedDate": "2020-11-06T21:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDU0NA==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519584544", "bodyText": "Maybe it is worthy a comment explaining that the parent class allocates a BigArray and therefore if this allocation fails, we need to make sure we release objects of the parent class?", "author": "iverase", "createdAt": "2020-11-09T06:56:58Z", "path": "server/src/main/java/org/elasticsearch/common/util/LongHash.java", "diffHunk": "@@ -41,7 +41,13 @@ public LongHash(long capacity, BigArrays bigArrays) {\n     //Constructor with configurable capacity and load factor.\n     public LongHash(long capacity, float maxLoadFactor, BigArrays bigArrays) {\n         super(capacity, maxLoadFactor, bigArrays);\n-        keys = bigArrays.newLongArray(capacity, false);\n+        try {\n+            keys = bigArrays.newLongArray(capacity, false);\n+        } finally {", "originalCommit": "f6c9a8281fc8dd42f58f67c8efa0577604508d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1MTY5OA==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519851698", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-11-09T14:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDU0NA=="}], "type": "inlineReview", "revised_code": {"commit": "06a0e250e0a7bade605712851a540ad6b500bfd3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/util/LongHash.java b/server/src/main/java/org/elasticsearch/common/util/LongHash.java\nindex 5e48b81ad73..f1894a46651 100644\n--- a/server/src/main/java/org/elasticsearch/common/util/LongHash.java\n+++ b/server/src/main/java/org/elasticsearch/common/util/LongHash.java\n\n@@ -42,6 +42,7 @@ public final class LongHash extends AbstractHash {\n     public LongHash(long capacity, float maxLoadFactor, BigArrays bigArrays) {\n         super(capacity, maxLoadFactor, bigArrays);\n         try {\n+            // `super` allocates a big array so we have to `close` if we fail here or we'll leak it.\n             keys = bigArrays.newLongArray(capacity, false);\n         } finally {\n             if (keys == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDY0NA==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519584644", "bodyText": "Same as above", "author": "iverase", "createdAt": "2020-11-09T06:57:12Z", "path": "server/src/main/java/org/elasticsearch/common/util/LongLongHash.java", "diffHunk": "@@ -48,7 +48,13 @@ public LongLongHash(long capacity, BigArrays bigArrays) {\n     //Constructor with configurable capacity and load factor.\n     public LongLongHash(long capacity, float maxLoadFactor, BigArrays bigArrays) {\n         super(capacity, maxLoadFactor, bigArrays);\n-        keys = bigArrays.newLongArray(2 * capacity, false);\n+        try {\n+            keys = bigArrays.newLongArray(2 * capacity, false);\n+        } finally {", "originalCommit": "f6c9a8281fc8dd42f58f67c8efa0577604508d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1MTc1NA==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519851754", "bodyText": "\ud83d\udc4d", "author": "nik9000", "createdAt": "2020-11-09T14:25:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NDY0NA=="}], "type": "inlineReview", "revised_code": {"commit": "06a0e250e0a7bade605712851a540ad6b500bfd3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/util/LongLongHash.java b/server/src/main/java/org/elasticsearch/common/util/LongLongHash.java\nindex 184b6f3eaca..7a2b8d32b53 100644\n--- a/server/src/main/java/org/elasticsearch/common/util/LongLongHash.java\n+++ b/server/src/main/java/org/elasticsearch/common/util/LongLongHash.java\n\n@@ -49,6 +49,7 @@ public final class LongLongHash extends AbstractHash {\n     public LongLongHash(long capacity, float maxLoadFactor, BigArrays bigArrays) {\n         super(capacity, maxLoadFactor, bigArrays);\n         try {\n+            // `super` allocates a big array so we have to `close` if we fail here or we'll leak it.\n             keys = bigArrays.newLongArray(2 * capacity, false);\n         } finally {\n             if (keys == null) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NTM3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519585373", "bodyText": "great test, I am wondering if it would be better to have a specific class to test allocations instead of a static method here? The point is that it is difficult to find out which BigArrays implementation are actually tested. It can be done in a follow up PR or I might be wrong.", "author": "iverase", "createdAt": "2020-11-09T06:59:30Z", "path": "test/framework/src/main/java/org/elasticsearch/common/util/MockBigArrays.java", "diffHunk": "@@ -37,12 +46,50 @@\n import java.util.Random;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.concurrent.ConcurrentMap;\n+import java.util.concurrent.atomic.AtomicLong;\n import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Function;\n \n import static org.elasticsearch.test.ESTestCase.assertBusy;\n import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n public class MockBigArrays extends BigArrays {\n+    private static final Logger logger = LogManager.getLogger(MockBigArrays.class);\n+\n+    /**\n+     * Assert that a function returning a {@link Releasable} runs to completion\n+     * when allocated a breaker with that breaks when it uses more than {@code max}\n+     * bytes <strong>and</strong> that the function doesn't leak any\n+     * {@linkplain BigArray}s if it is given a breaker that allows fewer bytes.\n+     */\n+    public static void assertFitsIn(ByteSizeValue max, Function<BigArrays, Releasable> run) {\n+        long maxBytes = 0;", "originalCommit": "f6c9a8281fc8dd42f58f67c8efa0577604508d6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1Njg3NA==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519856874", "bodyText": "I'm not sure! I didn't go with the superclass because I wasn't sure that every unit test where I make the method just extends ESTestCase now. They all do it right now but I was thinking \"I'm going to want this in a bunch of spots.\" so I wasn't sure if it'd be safe to keep it in a superclass. So, I guess what I'm saying is, yeah, I think its a good idea but I'd prefer to do it in a follow up after I get a little more experience using this method.", "author": "nik9000", "createdAt": "2020-11-09T14:32:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NTM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4MTQzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64744#discussion_r519881431", "bodyText": "\ud83d\udc4d", "author": "iverase", "createdAt": "2020-11-09T15:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4NTM3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "06a0e250e0a7bade605712851a540ad6b500bfd3", "url": "https://github.com/elastic/elasticsearch/commit/06a0e250e0a7bade605712851a540ad6b500bfd3", "message": "Comments", "committedDate": "2020-11-09T14:37:46Z", "type": "commit"}]}