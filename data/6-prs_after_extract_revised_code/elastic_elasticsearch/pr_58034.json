{"pr_number": 58034, "pr_title": "GeometryTestUtils should always generate valid polygons", "pr_createdAt": "2020-06-12T10:36:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58034", "timeline": [{"oid": "a19c3557aab137714970e9f641e506486386c435", "url": "https://github.com/elastic/elasticsearch/commit/a19c3557aab137714970e9f641e506486386c435", "message": "Make sure we always generate legal polygons, e.g they have area", "committedDate": "2020-06-12T10:33:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTM5MTE5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58034#discussion_r439391199", "bodyText": "We often use randomValueOtherThanMany(p -> area(p) == 0, GeoTestUtil::nextPolygon); to do this kind of thing. It isn't faster or better than what you have, but it is more common.", "author": "nik9000", "createdAt": "2020-06-12T12:35:06Z", "path": "test/framework/src/main/java/org/elasticsearch/geo/GeometryTestUtils.java", "diffHunk": "@@ -97,6 +97,9 @@ public static Point randomPoint(boolean hasAlt) {\n \n     public static Polygon randomPolygon(boolean hasAlt) {\n         org.apache.lucene.geo.Polygon lucenePolygon = GeoTestUtil.nextPolygon();\n+        while(area(lucenePolygon) == 0) {", "originalCommit": "a19c3557aab137714970e9f641e506486386c435", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a2115d753c83a2944c52859ac4edaecd04f3e2c1", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/geo/GeometryTestUtils.java b/test/framework/src/main/java/org/elasticsearch/geo/GeometryTestUtils.java\nindex 90f2fa74717..3a129a5c15f 100644\n--- a/test/framework/src/main/java/org/elasticsearch/geo/GeometryTestUtils.java\n+++ b/test/framework/src/main/java/org/elasticsearch/geo/GeometryTestUtils.java\n\n@@ -96,10 +98,7 @@ public class GeometryTestUtils {\n     }\n \n     public static Polygon randomPolygon(boolean hasAlt) {\n-        org.apache.lucene.geo.Polygon lucenePolygon = GeoTestUtil.nextPolygon();\n-        while(area(lucenePolygon) == 0) {\n-            lucenePolygon = GeoTestUtil.nextPolygon();\n-        }\n+        org.apache.lucene.geo.Polygon lucenePolygon = randomValueOtherThanMany(p -> area(p) == 0, GeoTestUtil::nextPolygon);\n         if (lucenePolygon.numHoles() > 0) {\n             org.apache.lucene.geo.Polygon[] luceneHoles = lucenePolygon.getHoles();\n             List<LinearRing> holes = new ArrayList<>();\n"}}, {"oid": "e701ba1895b16e361a2a3e7b49d975a7afabd444", "url": "https://github.com/elastic/elasticsearch/commit/e701ba1895b16e361a2a3e7b49d975a7afabd444", "message": "Merge branch 'master' into legalRandoPolygons", "committedDate": "2020-06-12T12:53:20Z", "type": "commit"}, {"oid": "a2115d753c83a2944c52859ac4edaecd04f3e2c1", "url": "https://github.com/elastic/elasticsearch/commit/a2115d753c83a2944c52859ac4edaecd04f3e2c1", "message": "use more common use structure", "committedDate": "2020-06-12T12:55:40Z", "type": "commit"}, {"oid": "8a2dedf168e54312bdb46fea6ce1d04b9a8c5bc5", "url": "https://github.com/elastic/elasticsearch/commit/8a2dedf168e54312bdb46fea6ce1d04b9a8c5bc5", "message": "Merge branch 'master' into legalRandoPolygons", "committedDate": "2020-06-12T14:05:48Z", "type": "commit"}, {"oid": "367eec4211c42596565223c7726cf9f5aada2627", "url": "https://github.com/elastic/elasticsearch/commit/367eec4211c42596565223c7726cf9f5aada2627", "message": "Merge branch 'master' into legalRandoPolygons", "committedDate": "2020-06-14T09:10:55Z", "type": "commit"}]}