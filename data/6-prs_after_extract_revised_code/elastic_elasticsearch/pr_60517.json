{"pr_number": 60517, "pr_title": "Refactor SnapshotsInProgress State Transitions", "pr_createdAt": "2020-07-31T13:51:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60517", "timeline": [{"oid": "e1495c92ca3529e164d4ed79798922279069fe62", "url": "https://github.com/elastic/elasticsearch/commit/e1495c92ca3529e164d4ed79798922279069fe62", "message": "Refactor SnapshotsInProgress State Transitions\n\nThe copy constructors previously used were hard to read and the exact state changes\nwere not obvious at all.\nRefactored those into a number of named constructors instead, added additional assertions\nand moved the snapshot abort logic into `SnapshotsInProgress`.", "committedDate": "2020-07-31T13:48:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYyNDYxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/60517#discussion_r463624611", "bodyText": "This is only used in the BwC path and kind of weird, left it logically unchanged because the BwC path goes away in master once 7.9 is out anyway and I didn't want to add any risk since we don't have full test coverage on aborts on mixed version clusters.", "author": "original-brownbear", "createdAt": "2020-07-31T13:53:21Z", "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -146,42 +159,67 @@ private static boolean assertShardsConsistent(State state, List<IndexId> indices\n             shards.keysIt().forEachRemaining(s -> indexNamesInShards.add(s.getIndexName()));\n             assert indexNames.equals(indexNamesInShards)\n                 : \"Indices in shards \" + indexNamesInShards + \" differ from expected indices \" + indexNames + \" for state [\" + state + \"]\";\n+            assert (state.completed() && completed(shards.values())) || state.completed() == false\n+                : \"Completed state must imply all shards completed but saw state [\" + state + \"] and shards \" + shards;\n             return true;\n         }\n \n-        public Entry(Snapshot snapshot, boolean includeGlobalState, boolean partial, State state, List<IndexId> indices,\n-                     long startTime, long repositoryStateId, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards,\n-                     Map<String, Object> userMetadata, Version version) {\n-            this(snapshot, includeGlobalState, partial, state, indices, Collections.emptyList(), startTime, repositoryStateId, shards,\n-                null, userMetadata, version);\n-        }\n-\n-        public Entry(Entry entry, State state, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n-            this(entry.snapshot, entry.includeGlobalState, entry.partial, state, entry.indices, entry.dataStreams, entry.startTime,\n-                entry.repositoryStateId, shards, entry.failure, entry.userMetadata, entry.version);\n-        }\n-\n-        public Entry(Entry entry, State state, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards, String failure) {\n-            this(entry.snapshot, entry.includeGlobalState, entry.partial, state, entry.indices, entry.dataStreams, entry.startTime,\n-                 entry.repositoryStateId, shards, failure, entry.userMetadata, entry.version);\n-        }\n-\n-        public Entry(Entry entry, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n-            this(entry, entry.state, shards, entry.failure);\n-        }\n-\n         public Entry withRepoGen(long newRepoGen) {\n             assert newRepoGen > repositoryStateId : \"Updated repository generation [\" + newRepoGen\n                     + \"] must be higher than current generation [\" + repositoryStateId + \"]\";\n             return new Entry(snapshot, includeGlobalState, partial, state, indices, dataStreams, startTime, newRepoGen, shards, failure,\n                     userMetadata, version);\n         }\n \n-        public Entry withShards(ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n+        public Entry abort() {\n+            final ImmutableOpenMap.Builder<ShardId, ShardSnapshotStatus> shardsBuilder = ImmutableOpenMap.builder();\n+            boolean completed = true;\n+            for (ObjectObjectCursor<ShardId, ShardSnapshotStatus> shardEntry : shards) {\n+                ShardSnapshotStatus status = shardEntry.value;\n+                if (status.state().completed() == false) {\n+                    final String nodeId = status.nodeId();\n+                    status = new ShardSnapshotStatus(nodeId, nodeId == null ? ShardState.FAILED : ShardState.ABORTED,\n+                            \"aborted by snapshot deletion\", status.generation());\n+                }\n+                completed &= status.state().completed();\n+                shardsBuilder.put(shardEntry.key, status);\n+            }\n+            return fail(shardsBuilder.build(), completed ? State.SUCCESS : State.ABORTED, \"Snapshot was aborted by deletion\");\n+        }\n+\n+        public Entry fail(ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards, State state, String failure) {", "originalCommit": "e1495c92ca3529e164d4ed79798922279069fe62", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "fa8275a46104edce5604b3ce826316bdcde25ff2", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java b/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\nindex 22dea97f82c..eecca95a83c 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\n\n@@ -159,7 +159,8 @@ public class SnapshotsInProgress extends AbstractNamedDiffable<Custom> implement\n             shards.keysIt().forEachRemaining(s -> indexNamesInShards.add(s.getIndexName()));\n             assert indexNames.equals(indexNamesInShards)\n                 : \"Indices in shards \" + indexNamesInShards + \" differ from expected indices \" + indexNames + \" for state [\" + state + \"]\";\n-            assert (state.completed() && completed(shards.values())) || state.completed() == false\n+            final boolean shardsCompleted = completed(shards.values());\n+            assert (state.completed() && shardsCompleted) || (state.completed() == false && shardsCompleted == false)\n                 : \"Completed state must imply all shards completed but saw state [\" + state + \"] and shards \" + shards;\n             return true;\n         }\n"}}, {"oid": "fa8275a46104edce5604b3ce826316bdcde25ff2", "url": "https://github.com/elastic/elasticsearch/commit/fa8275a46104edce5604b3ce826316bdcde25ff2", "message": "even stricter", "committedDate": "2020-07-31T15:31:47Z", "type": "commit"}, {"oid": "4fce147f3401d6f37d0ba4e2710a94437aef2bbb", "url": "https://github.com/elastic/elasticsearch/commit/4fce147f3401d6f37d0ba4e2710a94437aef2bbb", "message": "fix assertion", "committedDate": "2020-07-31T15:50:19Z", "type": "commit"}, {"oid": "c3eb6249ad740fbaeffa133516d9aec7e614b738", "url": "https://github.com/elastic/elasticsearch/commit/c3eb6249ad740fbaeffa133516d9aec7e614b738", "message": "Merge remote-tracking branch 'elastic/master' into nicer-snapshots-in-progress", "committedDate": "2020-07-31T15:50:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4MDc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60517#discussion_r464280766", "bodyText": "perhaps mention that the state can also be success here already?", "author": "ywelsch", "createdAt": "2020-08-03T08:54:30Z", "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -83,6 +83,18 @@ public String toString() {\n         return builder.append(\"]\").toString();\n     }\n \n+    /**\n+     * Creates the initial {@link Entry} when starting a snapshot.", "originalCommit": "c3eb6249ad740fbaeffa133516d9aec7e614b738", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6283531998fe6dbe1774cb0a53086567118ee0f1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java b/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\nindex eecca95a83c..c43b3369922 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java\n\n@@ -84,7 +84,8 @@ public class SnapshotsInProgress extends AbstractNamedDiffable<Custom> implement\n     }\n \n     /**\n-     * Creates the initial {@link Entry} when starting a snapshot.\n+     * Creates the initial {@link Entry} when starting a snapshot, if no shard-level snapshot work is to be done the resulting entry\n+     * will be in state {@link State#SUCCESS} right away otherwise it will be in state {@link State#STARTED}.\n      */\n     public static Entry startedEntry(Snapshot snapshot, boolean includeGlobalState, boolean partial, List<IndexId> indices,\n                                      List<String> dataStreams, long startTime, long repositoryStateId,\n"}}, {"oid": "2fd2c340be964800b082ca61cacf3582eed3a1f8", "url": "https://github.com/elastic/elasticsearch/commit/2fd2c340be964800b082ca61cacf3582eed3a1f8", "message": "Merge remote-tracking branch 'elastic/master' into nicer-snapshots-in-progress", "committedDate": "2020-08-03T09:12:16Z", "type": "commit"}, {"oid": "6283531998fe6dbe1774cb0a53086567118ee0f1", "url": "https://github.com/elastic/elasticsearch/commit/6283531998fe6dbe1774cb0a53086567118ee0f1", "message": "CR: better javadoc", "committedDate": "2020-08-03T09:15:58Z", "type": "commit"}]}