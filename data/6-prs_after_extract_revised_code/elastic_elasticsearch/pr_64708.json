{"pr_number": 64708, "pr_title": "Handle incorrect header values", "pr_createdAt": "2020-11-06T13:24:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64708", "timeline": [{"oid": "a6d89c2985c247acafb9fb4aaeb1a1c5bfa3a996", "url": "https://github.com/elastic/elasticsearch/commit/a6d89c2985c247acafb9fb4aaeb1a1c5bfa3a996", "message": "Handle incorrect header values\n\nWhen Accept or Content-Type header values are incorrect, a request\nshould be gracefully rejected and an exception message returned to a\nclient.\n\nrelates https://github.com/elastic/elasticsearch/issues/64689", "committedDate": "2020-11-06T13:22:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkwMDEyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64708#discussion_r518900121", "bodyText": "Is there anywhere that we can assert that the header name at fault is included in the error sent back to the user ?", "author": "jakelandis", "createdAt": "2020-11-06T17:32:20Z", "path": "server/src/test/java/org/elasticsearch/http/AbstractHttpServerTransportTests.java", "diffHunk": "@@ -173,6 +177,63 @@ public HttpStats stats() {\n         }\n     }\n \n+    public void testIncorrectHeaderHandling() {\n+\n+        final ClusterSettings clusterSettings = new ClusterSettings(Settings.EMPTY, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS);\n+        try (AbstractHttpServerTransport transport =\n+                 new AbstractHttpServerTransport(Settings.EMPTY, networkService, bigArrays, threadPool, xContentRegistry(),\n+                     new HttpServerTransport.Dispatcher() {\n+                         @Override\n+                         public void dispatchRequest(RestRequest request, RestChannel channel, ThreadContext threadContext) {\n+                             Assert.fail();\n+                         }\n+\n+                         @Override\n+                         public void dispatchBadRequest(RestChannel channel, ThreadContext threadContext, Throwable cause) {\n+                             assertThat(cause, instanceOf(RestRequest.MediaTypeHeaderException.class));", "originalCommit": "a6d89c2985c247acafb9fb4aaeb1a1c5bfa3a996", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MTkwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64708#discussion_r519641905", "bodyText": "great you noticed this. in fact the header name was not surfaced on a response.\nI refactored this to return something like\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"media_type_header_exception\",\n        \"reason\": \"Invalid media-type value on header [Accept]\"\n      }\n    ],\n    \"type\": \"media_type_header_exception\",\n    \"reason\": \"Invalid media-type value on header [Accept]\",\n    \"caused_by\": {\n      \"type\": \"illegal_argument_exception\",\n      \"reason\": \"invalid media type [texffff]\"\n    }\n  },\n  \"status\": 400\n}", "author": "pgomulka", "createdAt": "2020-11-09T08:52:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkwMDEyMQ=="}], "type": "inlineReview", "revised_code": {"commit": "12de009812a1b3d1e8c590b120fbd1e619b504e0", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/http/AbstractHttpServerTransportTests.java b/server/src/test/java/org/elasticsearch/http/AbstractHttpServerTransportTests.java\nindex 88119c23daf..16988611929 100644\n--- a/server/src/test/java/org/elasticsearch/http/AbstractHttpServerTransportTests.java\n+++ b/server/src/test/java/org/elasticsearch/http/AbstractHttpServerTransportTests.java\n\n@@ -180,39 +180,11 @@ public class AbstractHttpServerTransportTests extends ESTestCase {\n     public void testIncorrectHeaderHandling() {\n \n         final ClusterSettings clusterSettings = new ClusterSettings(Settings.EMPTY, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS);\n-        try (AbstractHttpServerTransport transport =\n-                 new AbstractHttpServerTransport(Settings.EMPTY, networkService, bigArrays, threadPool, xContentRegistry(),\n-                     new HttpServerTransport.Dispatcher() {\n-                         @Override\n-                         public void dispatchRequest(RestRequest request, RestChannel channel, ThreadContext threadContext) {\n-                             Assert.fail();\n-                         }\n-\n-                         @Override\n-                         public void dispatchBadRequest(RestChannel channel, ThreadContext threadContext, Throwable cause) {\n-                             assertThat(cause, instanceOf(RestRequest.MediaTypeHeaderException.class));\n-                         }\n-                     }, clusterSettings) {\n-                     @Override\n-                     protected HttpServerChannel bind(InetSocketAddress hostAddress) {\n-                         return null;\n-                     }\n-\n-                     @Override\n-                     protected void doStart() {\n-                     }\n-\n-                     @Override\n-                     protected void stopInternal() {\n-                     }\n+        {\n+            try (AbstractHttpServerTransport transport =\n+                     failureAssertingtHttpServerTransport(clusterSettings, \"Accept\")) {\n \n-                     @Override\n-                     public HttpStats stats() {\n-                         return null;\n-                     }\n-                 }) {\n \n-            {\n                 Map<String, List<String>> headers = new HashMap<>();\n                 headers.put(\"Accept\", Collections.singletonList(\"incorrectheader\"));\n \n"}}, {"oid": "12de009812a1b3d1e8c590b120fbd1e619b504e0", "url": "https://github.com/elastic/elasticsearch/commit/12de009812a1b3d1e8c590b120fbd1e619b504e0", "message": "surface header name value", "committedDate": "2020-11-09T09:01:49Z", "type": "commit"}, {"oid": "81e160b90060ae774fe86c2fa472ab942862415b", "url": "https://github.com/elastic/elasticsearch/commit/81e160b90060ae774fe86c2fa472ab942862415b", "message": "reformat", "committedDate": "2020-11-09T09:49:30Z", "type": "commit"}, {"oid": "a838410035a23f7d87a339553cdb067d467e7990", "url": "https://github.com/elastic/elasticsearch/commit/a838410035a23f7d87a339553cdb067d467e7990", "message": "Merge branch 'master' into compat/handle_incorrect_accept_content_type", "committedDate": "2020-11-09T13:27:46Z", "type": "commit"}, {"oid": "c12fd96ac69407cd1fc2f682c5017200042c1f21", "url": "https://github.com/elastic/elasticsearch/commit/c12fd96ac69407cd1fc2f682c5017200042c1f21", "message": "fix tests after rename", "committedDate": "2020-11-09T14:13:58Z", "type": "commit"}]}