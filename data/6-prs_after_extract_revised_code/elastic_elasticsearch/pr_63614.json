{"pr_number": 63614, "pr_title": "Maybe fix DiskThresholdDeciderIT", "pr_createdAt": "2020-10-13T14:15:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63614", "timeline": [{"oid": "38275afd76b9a61213a8e675772be163366ae670", "url": "https://github.com/elastic/elasticsearch/commit/38275afd76b9a61213a8e675772be163366ae670", "message": "Maybe fix DiskThresholdDeciderIT", "committedDate": "2020-10-13T14:08:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63614#discussion_r504546669", "bodyText": "Aren't we potentially introducing all kinds of races here when we run this concurrently and update a bunch of maps in parallel? It seems that the logic in this method doesn't really expect this to happen and it could actually have functional impact with all the various checks we do on those maps in the computations below?", "author": "original-brownbear", "createdAt": "2020-10-14T09:47:44Z", "path": "server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java", "diffHunk": "@@ -99,15 +99,23 @@ public DiskThresholdMonitor(Settings settings, Supplier<ClusterState> clusterSta\n         this.client = client;\n     }\n \n+    private boolean checkInProgress(final boolean expectedValue, final boolean newValue) {\n+        if (diskThresholdSettings.allowForcedUpdate()) {\n+            assert checkInProgress.get() == false;\n+            return true;\n+        }\n+        return checkInProgress.compareAndSet(expectedValue, newValue);\n+    }\n+\n     private void checkFinished() {\n-        final boolean checkFinished = checkInProgress.compareAndSet(true, false);\n+        final boolean checkFinished = checkInProgress(true, false);\n         assert checkFinished;\n         logger.trace(\"checkFinished\");\n     }\n \n     public void onNewInfo(ClusterInfo info) {\n \n-        if (checkInProgress.compareAndSet(false, true) == false) {\n+        if (checkInProgress(false, true) == false) {", "originalCommit": "38275afd76b9a61213a8e675772be163366ae670", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NjcyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63614#discussion_r504556721", "bodyText": "Yes, but that's the only \"simple\" way I found to ensure that DiskThresholdMonitor effectively runs the reroute after the disk space has been updated... At this point I think we should just re execute refreshDiskUsage in the assertBusy() loop until we have what we want (as initially done in #62358 (comment)).", "author": "tlrx", "createdAt": "2020-10-14T10:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU3NTk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/63614#discussion_r504575944", "bodyText": "At this point I think we should just re execute refreshDiskUsage in the assertBusy() loop until we have what we want (as initially done in #62358 (comment)).\n\nYea I tend to agree :( (begrudgingly :D ... maybe add a TODO to look into a cleaner way and do that?)", "author": "original-brownbear", "createdAt": "2020-10-14T10:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5OTIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/63614#discussion_r504599234", "bodyText": "I pushed 7cddec2", "author": "tlrx", "createdAt": "2020-10-14T11:22:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "375cde9080a23d22a51d20ccb31e641303fa9561", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java b/server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java\nindex cdf414162cf..58241bc41a9 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java\n\n@@ -99,23 +99,15 @@ public class DiskThresholdMonitor {\n         this.client = client;\n     }\n \n-    private boolean checkInProgress(final boolean expectedValue, final boolean newValue) {\n-        if (diskThresholdSettings.allowForcedUpdate()) {\n-            assert checkInProgress.get() == false;\n-            return true;\n-        }\n-        return checkInProgress.compareAndSet(expectedValue, newValue);\n-    }\n-\n     private void checkFinished() {\n-        final boolean checkFinished = checkInProgress(true, false);\n+        final boolean checkFinished = checkInProgress.compareAndSet(true, false);\n         assert checkFinished;\n         logger.trace(\"checkFinished\");\n     }\n \n     public void onNewInfo(ClusterInfo info) {\n \n-        if (checkInProgress(false, true) == false) {\n+        if (checkInProgress.compareAndSet(false, true) == false) {\n             logger.info(\"skipping monitor as a check is already in progress\");\n             return;\n         }\n"}}, {"oid": "375cde9080a23d22a51d20ccb31e641303fa9561", "url": "https://github.com/elastic/elasticsearch/commit/375cde9080a23d22a51d20ccb31e641303fa9561", "message": "Revert \"Maybe fix DiskThresholdDeciderIT\"\n\nThis reverts commit 38275afd76b9a61213a8e675772be163366ae670.", "committedDate": "2020-10-14T10:52:36Z", "type": "commit"}, {"oid": "7cddec2a83bddac8bb12b26c0543398efc0a89e5", "url": "https://github.com/elastic/elasticsearch/commit/7cddec2a83bddac8bb12b26c0543398efc0a89e5", "message": "feedback", "committedDate": "2020-10-14T11:21:43Z", "type": "commit"}, {"oid": "4dc73a94f03672cb1bb95635a909bb60f1ea1c7c", "url": "https://github.com/elastic/elasticsearch/commit/4dc73a94f03672cb1bb95635a909bb60f1ea1c7c", "message": "Merge branch 'master' into maybe-DiskThresholdDeciderIT", "committedDate": "2020-10-14T11:21:50Z", "type": "commit"}]}