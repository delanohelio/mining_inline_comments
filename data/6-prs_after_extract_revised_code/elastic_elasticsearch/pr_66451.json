{"pr_number": 66451, "pr_title": "[ML] change to only calculate model size on initial load to prevent slow cache promotions", "pr_createdAt": "2020-12-16T16:00:18Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66451", "timeline": [{"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "url": "https://github.com/elastic/elasticsearch/commit/08419573ac5eb5ff2fb636b0693c292998b8d3ca", "message": "[ML] change to only calculate model size on initial load to prevent slow cache promotions", "committedDate": "2020-12-16T15:57:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQzMzMxOA==", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544433318", "bodyText": "maybe rename to cachedRamBytesUsed and add a comment to remember why it's a good idea to cache it?", "author": "dimitris-athanasiou", "createdAt": "2020-12-16T16:19:26Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -56,6 +56,7 @@\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n+    private final long modelSize;", "originalCommit": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "578c8ea576617f3f95ce13447331d85491e1a55d", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\nindex ec30396f855..0b71ba52705 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n\n@@ -56,7 +56,7 @@ public class LocalModel implements Closeable {\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n-    private final long modelSize;\n+    private final long cachedRamBytesUsed;\n \n     LocalModel(String modelId,\n                String nodeId,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MTE1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544451157", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final long modelSize;\n          \n          \n            \n                private final long cachedRamBytesUsed;", "author": "benwtrent", "createdAt": "2020-12-16T16:42:03Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -56,6 +56,7 @@\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n+    private final long modelSize;", "originalCommit": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "578c8ea576617f3f95ce13447331d85491e1a55d", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\nindex ec30396f855..0b71ba52705 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n\n@@ -56,7 +56,7 @@ public class LocalModel implements Closeable {\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n-    private final long modelSize;\n+    private final long cachedRamBytesUsed;\n \n     LocalModel(String modelId,\n                String nodeId,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MTI1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544451257", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.modelSize = trainedModelDefinition.ramBytesUsed();\n          \n          \n            \n                    this.cachedRamBytesUsed = trainedModelDefinition.ramBytesUsed();", "author": "benwtrent", "createdAt": "2020-12-16T16:42:11Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -67,6 +68,7 @@\n                TrainedModelStatsService trainedModelStatsService,\n                CircuitBreaker trainedModelCircuitBreaker) {\n         this.trainedModelDefinition = trainedModelDefinition;\n+        this.modelSize = trainedModelDefinition.ramBytesUsed();", "originalCommit": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "578c8ea576617f3f95ce13447331d85491e1a55d", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\nindex ec30396f855..0b71ba52705 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n\n@@ -68,7 +68,7 @@ public class LocalModel implements Closeable {\n                TrainedModelStatsService trainedModelStatsService,\n                CircuitBreaker trainedModelCircuitBreaker) {\n         this.trainedModelDefinition = trainedModelDefinition;\n-        this.modelSize = trainedModelDefinition.ramBytesUsed();\n+        this.cachedRamBytesUsed = trainedModelDefinition.ramBytesUsed();\n         this.modelId = modelId;\n         this.fieldNames = new HashSet<>(input.getFieldNames());\n         // the ctor being called means a new instance was created.\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MjQzOA==", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544452438", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return modelSize;\n          \n          \n            \n                    // This should always be cached and not calculated on call. \n          \n          \n            \n                    // This is because the caching system calls this method on every promotion call that changes the LRU head\n          \n          \n            \n                    // Consequently, recalculating can cause serious throughput issues due to LRU changes in the cache\n          \n          \n            \n                    return cachedRamBytesUsed;", "author": "benwtrent", "createdAt": "2020-12-16T16:43:38Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -82,7 +84,7 @@\n     }\n \n     long ramBytesUsed() {\n-        return trainedModelDefinition.ramBytesUsed();\n+        return modelSize;", "originalCommit": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "578c8ea576617f3f95ce13447331d85491e1a55d", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\nindex ec30396f855..0b71ba52705 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java\n\n@@ -84,7 +84,10 @@ public class LocalModel implements Closeable {\n     }\n \n     long ramBytesUsed() {\n-        return modelSize;\n+        // This should always be cached and not calculated on call. \n+        // This is because the caching system calls this method on every promotion call that changes the LRU head\n+        // Consequently, recalculating can cause serious throughput issues due to LRU changes in the cache\n+        return cachedRamBytesUsed;\n     }\n \n     public String getModelId() {\n"}}, {"oid": "578c8ea576617f3f95ce13447331d85491e1a55d", "url": "https://github.com/elastic/elasticsearch/commit/578c8ea576617f3f95ce13447331d85491e1a55d", "message": "Apply suggestions from code review", "committedDate": "2020-12-16T16:44:15Z", "type": "commit"}]}