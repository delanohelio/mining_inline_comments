{"pr_number": 64428, "pr_title": "Configure Autoscaling deciders using settings", "pr_createdAt": "2020-10-30T17:03:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64428", "timeline": [{"oid": "552f5685e4810144df4651db8942a62cf4db27ed", "url": "https://github.com/elastic/elasticsearch/commit/552f5685e4810144df4651db8942a62cf4db27ed", "message": "Configure Autoscaling deciders using settings\n\nAutoscaling deciders are now configured using settings, allowing an\neasy way to add default values as well as building upon the existing\nsetting code. This makes it easier to add new deciders since there\nis no need for a separate configuration object.", "committedDate": "2020-10-30T16:45:56Z", "type": "commit"}, {"oid": "ff5c609b3ec4649d1ff14b53cad9c9b5334138b5", "url": "https://github.com/elastic/elasticsearch/commit/ff5c609b3ec4649d1ff14b53cad9c9b5334138b5", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-02T07:52:29Z", "type": "commit"}, {"oid": "656d474fcf23b3fd689d9244b7dad8bcda4df292", "url": "https://github.com/elastic/elasticsearch/commit/656d474fcf23b3fd689d9244b7dad8bcda4df292", "message": "Validate setting parse failure\n\nAlso ensure that ByteSizeValue always has the setting name in validation\nfailure message.", "committedDate": "2020-11-02T08:10:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5ODIyNw==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r515798227", "bodyText": "I left this in this PR, but can certainly split it out for greater visibility if you prefer.", "author": "henningandersen", "createdAt": "2020-11-02T08:11:07Z", "path": "server/src/main/java/org/elasticsearch/common/unit/ByteSizeValue.java", "diffHunk": "@@ -264,7 +264,7 @@ private static ByteSizeValue parse(final String initialInput, final String norma\n                          initialInput, settingName);\n                     return new ByteSizeValue((long) (doubleValue * unit.toBytes(1)));\n                 } catch (final NumberFormatException ignored) {\n-                    throw new ElasticsearchParseException(\"failed to parse [{}]\", e, initialInput);\n+                    throw new ElasticsearchParseException(\"failed to parse setting [{}] with value [{}]\", e, settingName, initialInput);", "originalCommit": "656d474fcf23b3fd689d9244b7dad8bcda4df292", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTk3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528441975", "bodyText": "Yeah, let's take this to another PR so that the core/infra team can have visibility on the change.", "author": "jasontedor", "createdAt": "2020-11-23T02:00:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5ODIyNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "11ed729eddec9b7fe137188e59cd1ac486ac7e21", "url": "https://github.com/elastic/elasticsearch/commit/11ed729eddec9b7fe137188e59cd1ac486ac7e21", "message": "Fix test failure due to better validation message", "committedDate": "2020-11-04T09:44:39Z", "type": "commit"}, {"oid": "905c877433cf5701ec6aa29d457b56ee9afc6427", "url": "https://github.com/elastic/elasticsearch/commit/905c877433cf5701ec6aa29d457b56ee9afc6427", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-04T09:44:59Z", "type": "commit"}, {"oid": "9a9e91d4b15fa583353166377b373df4b07fb4a8", "url": "https://github.com/elastic/elasticsearch/commit/9a9e91d4b15fa583353166377b373df4b07fb4a8", "message": "Merge branch 'master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-06T16:21:22Z", "type": "commit"}, {"oid": "8289167a3a80ccba893cacc10f1d67862a05b220", "url": "https://github.com/elastic/elasticsearch/commit/8289167a3a80ccba893cacc10f1d67862a05b220", "message": "spotless", "committedDate": "2020-11-06T16:35:36Z", "type": "commit"}, {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "url": "https://github.com/elastic/elasticsearch/commit/69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-11T09:16:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjIxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442213", "bodyText": "Can you add a Javadoc describing the purpose of this interface?", "author": "jasontedor", "createdAt": "2020-11-23T02:02:28Z", "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java", "diffHunk": "@@ -0,0 +1,13 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+public interface PolicyValidator {", "originalCommit": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTA4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528681086", "bodyText": "++, added in b9d87c5", "author": "henningandersen", "createdAt": "2020-11-23T12:52:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjIxMw=="}], "type": "inlineReview", "revised_code": {"commit": "b9d87c5676afe7cf730559423767849443df61db", "chunk": "diff --git a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\nindex 36e4c5cac2a7..072c08f28650 100644\n--- a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\n+++ b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\n\n@@ -8,6 +8,13 @@ package org.elasticsearch.xpack.autoscaling.action;\n \n import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n \n+/**\n+ * Validator to check autoscaling policies\n+ */\n public interface PolicyValidator {\n+    /**\n+     * Validate the given policy, e.g., check decider names, setting names and values.\n+     * @param policy the policy to validate\n+     */\n     void validate(AutoscalingPolicy policy);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjI0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442243", "bodyText": "Could you add a Javadoc for this method?", "author": "jasontedor", "createdAt": "2020-11-23T02:02:42Z", "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java", "diffHunk": "@@ -0,0 +1,13 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+public interface PolicyValidator {\n+    void validate(AutoscalingPolicy policy);", "originalCommit": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528681169", "bodyText": "++, added in b9d87c5", "author": "henningandersen", "createdAt": "2020-11-23T12:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjI0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "b9d87c5676afe7cf730559423767849443df61db", "chunk": "diff --git a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\nindex 36e4c5cac2a7..072c08f28650 100644\n--- a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\n+++ b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java\n\n@@ -8,6 +8,13 @@ package org.elasticsearch.xpack.autoscaling.action;\n \n import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n \n+/**\n+ * Validator to check autoscaling policies\n+ */\n public interface PolicyValidator {\n+    /**\n+     * Validate the given policy, e.g., check decider names, setting names and values.\n+     * @param policy the policy to validate\n+     */\n     void validate(AutoscalingPolicy policy);\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjM3NA==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442374", "bodyText": "Maybe a comment to indicate this method throws when there's an issue with the setting, and that's what we are testing for here? That is, make the purpose of this line clear?", "author": "jasontedor", "createdAt": "2020-11-23T02:03:57Z", "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java", "diffHunk": "@@ -30,14 +33,40 @@\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n \n-public class AutoscalingCalculateCapacityService {\n-    private Map<String, AutoscalingDeciderService<? extends AutoscalingDeciderConfiguration>> deciderByName;\n+public class AutoscalingCalculateCapacityService implements PolicyValidator {\n+    private final Map<String, AutoscalingDeciderService> deciderByName;\n \n-    public AutoscalingCalculateCapacityService(Set<AutoscalingDeciderService<? extends AutoscalingDeciderConfiguration>> deciders) {\n+    public AutoscalingCalculateCapacityService(Set<AutoscalingDeciderService> deciders) {\n         assert deciders.size() >= 1; // always have fixed\n         this.deciderByName = deciders.stream().collect(Collectors.toMap(AutoscalingDeciderService::name, Function.identity()));\n     }\n \n+    public void validate(AutoscalingPolicy policy) {\n+        policy.deciders().forEach(this::validate);\n+    }\n+\n+    private void validate(final String deciderName, final Settings configuration) {\n+        AutoscalingDeciderService deciderService = deciderByName.get(deciderName);\n+        if (deciderService == null) {\n+            throw new IllegalArgumentException(\"unknown decider [\" + deciderName + \"]\");\n+        }\n+\n+        Map<String, Setting<?>> deciderSettings = deciderService.deciderSettings()\n+            .stream()\n+            .collect(Collectors.toMap(s -> s.getKey(), Function.identity()));\n+\n+        configuration.keySet().forEach(key -> validateSetting(key, configuration, deciderSettings, deciderName));\n+    }\n+\n+    private void validateSetting(String key, Settings configuration, Map<String, Setting<?>> deciderSettings, String decider) {\n+        Setting<?> setting = deciderSettings.get(key);\n+        if (setting == null) {\n+            throw new IllegalArgumentException(\"unknown setting [\" + key + \"] for decider [\" + decider + \"]\");\n+        }\n+\n+        setting.get(configuration);", "originalCommit": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTI0NA==", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528681244", "bodyText": "++, added in b9d87c5", "author": "henningandersen", "createdAt": "2020-11-23T12:52:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "b9d87c5676afe7cf730559423767849443df61db", "chunk": "diff --git a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java\nindex fc750ff7322d..0bb008139a9e 100644\n--- a/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java\n+++ b/x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java\n\n@@ -64,6 +64,7 @@ public class AutoscalingCalculateCapacityService implements PolicyValidator {\n             throw new IllegalArgumentException(\"unknown setting [\" + key + \"] for decider [\" + decider + \"]\");\n         }\n \n+        // check the setting, notice that `get` throws when `configuration` contains an invalid value for `setting`\n         setting.get(configuration);\n     }\n \n"}}, {"oid": "e7d090c21d3e5bb9052be9f3814ffd46280f76e1", "url": "https://github.com/elastic/elasticsearch/commit/e7d090c21d3e5bb9052be9f3814ffd46280f76e1", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-23T10:45:03Z", "type": "commit"}, {"oid": "07632c3b34bdb40ecb9fc0eef939ec83751d2791", "url": "https://github.com/elastic/elasticsearch/commit/07632c3b34bdb40ecb9fc0eef939ec83751d2791", "message": "Update ML to use settings\n\nML now uses settings for autoscaling configuration", "committedDate": "2020-11-23T12:04:56Z", "type": "commit"}, {"oid": "c7d40eb110d68e25bfa3101c2b8da06ce667056d", "url": "https://github.com/elastic/elasticsearch/commit/c7d40eb110d68e25bfa3101c2b8da06ce667056d", "message": "Add linebreak", "committedDate": "2020-11-23T12:15:46Z", "type": "commit"}, {"oid": "b9d87c5676afe7cf730559423767849443df61db", "url": "https://github.com/elastic/elasticsearch/commit/b9d87c5676afe7cf730559423767849443df61db", "message": "Add javadoc and comment.", "committedDate": "2020-11-23T12:50:54Z", "type": "commit"}, {"oid": "49303aa2f47206f2ae9b042f8652032e9f1d7a4f", "url": "https://github.com/elastic/elasticsearch/commit/49303aa2f47206f2ae9b042f8652032e9f1d7a4f", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings", "committedDate": "2020-11-23T19:13:13Z", "type": "commit"}]}