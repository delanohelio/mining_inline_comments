{"pr_number": 66303, "pr_title": "[client] Add client metadata header on RestClient requests", "pr_createdAt": "2020-12-14T21:27:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66303", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgxOTQ3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542819476", "bodyText": "Do any of these version functions need to handle pre-release information?", "author": "sethmlarson", "createdAt": "2020-12-14T21:36:57Z", "path": "client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.client;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+\n+class RuntimeInfo {\n+\n+    /**\n+     * Returns runtime info to append to the metadata header. Currently looks up classes identifying non-Java JVM\n+     * languages and appends their major/minor version patch.\n+     */\n+    public static String getRuntimeMetadata() {\n+        StringBuilder s = new StringBuilder();\n+        String version;\n+\n+        version = HlrcKind();\n+        if (version != null) {\n+            s.append(\",hl=\").append(version);\n+        }\n+\n+        version= kotlinVersion();", "originalCommit": "ff2ad673536bfe2a5acec6d92065ecb52f94b2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwNDgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542904800", "bodyText": "Service/language/http-client versions are not stripped, and so can include pre-release information. For language runtimes we only keep major.minor as this information allows us to better understand the ecosystem and the patch version doesn't bring useful information. The patch version for these may only be of interest if we build dedicated clients for these languages, in which case their version will be reported as the language version.", "author": "swallez", "createdAt": "2020-12-14T22:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgxOTQ3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java b/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\nsimilarity index 50%\nrename from client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java\nrename to client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\nindex 580a35a1ee7..2cf7318e280 100644\n--- a/client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java\n+++ b/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\n\n@@ -22,21 +22,18 @@ package org.elasticsearch.client;\n import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n \n-class RuntimeInfo {\n+// Copied verbatim from https://github.com/elastic/jvm-languages-sniffer\n+\n+class LanguageRuntimeVersions {\n \n     /**\n-     * Returns runtime info to append to the metadata header. Currently looks up classes identifying non-Java JVM\n-     * languages and appends their major/minor version patch.\n+     * Returns runtime information by looking up classes identifying non-Java JVM\n+     * languages and appending a key with their name and their major.minor version, if available\n      */\n     public static String getRuntimeMetadata() {\n         StringBuilder s = new StringBuilder();\n         String version;\n \n-        version = HlrcKind();\n-        if (version != null) {\n-            s.append(\",hl=\").append(version);\n-        }\n-\n         version= kotlinVersion();\n         if (version != null) {\n             s.append(\",kt=\").append(version);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgxOTk3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542819971", "bodyText": "If patch numbers aren't long can we keep this info anyways?", "author": "sethmlarson", "createdAt": "2020-12-14T21:37:27Z", "path": "client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.client;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+\n+class RuntimeInfo {\n+\n+    /**\n+     * Returns runtime info to append to the metadata header. Currently looks up classes identifying non-Java JVM\n+     * languages and appends their major/minor version patch.\n+     */\n+    public static String getRuntimeMetadata() {\n+        StringBuilder s = new StringBuilder();\n+        String version;\n+\n+        version = HlrcKind();\n+        if (version != null) {\n+            s.append(\",hl=\").append(version);\n+        }\n+\n+        version= kotlinVersion();\n+        if (version != null) {\n+            s.append(\",kt=\").append(version);\n+        }\n+\n+        version = scalaVersion();\n+        if (version != null) {\n+            s.append(\",sc=\").append(version);\n+        }\n+\n+        version = clojureVersion();\n+        if (version != null) {\n+            s.append(\",clj=\").append(version);\n+        }\n+\n+        version = groovyVersion();\n+        if (version != null) {\n+            s.append(\",gy=\").append(version);\n+        }\n+\n+        return s.toString();\n+    }\n+\n+    public static String HlrcKind() {\n+        try {\n+            Class.forName(\"org.elasticsearch.client.RestHighLevelClient\");\n+        } catch (Exception t) {\n+            return null;\n+        }\n+        // 1 is the HLRC based on ES server request/response classes\n+        // 2 will be the HLRC based on code generation from API specs\n+        return \"1\";\n+    }\n+\n+    public static String kotlinVersion() {\n+        try {\n+            //KotlinVersion.CURRENT.toString()\n+            Class<?> clazz = Class.forName(\"kotlin.KotlinVersion\");\n+            Field field = clazz.getField(\"CURRENT\");\n+            String version = field.get(null).toString();\n+            return stripPatchRevision(version);\n+\n+        } catch (Exception t) {\n+            // ignore\n+        }\n+        return null;\n+    }\n+\n+    public static String scalaVersion() {\n+        try {\n+            // scala.util.Properties.versionNumberString()\n+            Class<?> clazz = Class.forName(\"scala.util.Properties\");\n+            Method m = clazz.getMethod(\"versionNumberString\");\n+            String version = (String) m.invoke(null);\n+            return stripPatchRevision(version);\n+\n+        } catch (Exception t) {\n+            // ignore\n+        }\n+        return null;\n+    }\n+\n+    public static String clojureVersion() {\n+        try {\n+            // (clojure-version) which translates to\n+            // clojure.core$clojure_version.invokeStatic()\n+            Class<?> clazz = Class.forName(\"clojure.core$clojure_version\");\n+            Method m = clazz.getMethod(\"invokeStatic\");\n+            String version = (String) m.invoke(null);\n+            return stripPatchRevision(version);\n+\n+        } catch (Exception t) {\n+            // ignore\n+        }\n+        return null;\n+    }\n+\n+    public static String groovyVersion() {\n+        try {\n+            // groovy.lang.GroovySystem.getVersion()\n+            // There's also getShortVersion(), but only since Groovy 3.0.1\n+            Class<?> clazz = Class.forName(\"groovy.lang.GroovySystem\");\n+            Method m = clazz.getMethod(\"getVersion\");\n+            String version = (String) m.invoke(null);\n+            return stripPatchRevision(version);\n+\n+        } catch (Exception t) {\n+            // ignore\n+        }\n+        return null;\n+    }\n+\n+    static String stripPatchRevision(String version) {", "originalCommit": "ff2ad673536bfe2a5acec6d92065ecb52f94b2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTIzNzc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565237748", "bodyText": "They can be long depending on the language, like 2.13.0-M5-6e0cba7 for some release of Scala. We could also compact pre-release versions but there's honestly no real value in the patch revision for this particular use case where we just want to know if a particular language is present, and in what major version (minor language versions are often not exactly minor). The patch number won't give us any actionable information unless we have a dedicated client for that language, in which case the full version will be reported in the first part of the header.", "author": "swallez", "createdAt": "2021-01-27T11:34:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgxOTk3MQ=="}], "type": "inlineReview", "revised_code": {"commit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java b/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\nsimilarity index 50%\nrename from client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java\nrename to client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\nindex 580a35a1ee7..2cf7318e280 100644\n--- a/client/rest/src/main/java/org/elasticsearch/client/RuntimeInfo.java\n+++ b/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\n\n@@ -22,21 +22,18 @@ package org.elasticsearch.client;\n import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n \n-class RuntimeInfo {\n+// Copied verbatim from https://github.com/elastic/jvm-languages-sniffer\n+\n+class LanguageRuntimeVersions {\n \n     /**\n-     * Returns runtime info to append to the metadata header. Currently looks up classes identifying non-Java JVM\n-     * languages and appends their major/minor version patch.\n+     * Returns runtime information by looking up classes identifying non-Java JVM\n+     * languages and appending a key with their name and their major.minor version, if available\n      */\n     public static String getRuntimeMetadata() {\n         StringBuilder s = new StringBuilder();\n         String version;\n \n-        version = HlrcKind();\n-        if (version != null) {\n-            s.append(\",hl=\").append(version);\n-        }\n-\n         version= kotlinVersion();\n         if (version != null) {\n             s.append(\",kt=\").append(version);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDYyMA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542820620", "bodyText": "metaHeaderEnabled to conform with the meta header noun", "author": "sethmlarson", "createdAt": "2020-12-14T21:38:11Z", "path": "client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java", "diffHunk": "@@ -56,6 +68,39 @@\n     private NodeSelector nodeSelector = NodeSelector.ANY;\n     private boolean strictDeprecationMode = false;\n     private boolean compressionEnabled = false;\n+    private boolean metadataHeaderEnabled = true;", "originalCommit": "ff2ad673536bfe2a5acec6d92065ecb52f94b2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkwOTcwMw==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542909703", "bodyText": "Done. Also renamed constants.", "author": "swallez", "createdAt": "2020-12-14T23:04:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyMDYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\nindex 13838caea7c..1d79a1432be 100644\n--- a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n+++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n\n@@ -68,38 +68,41 @@ public final class RestClientBuilder {\n     private NodeSelector nodeSelector = NodeSelector.ANY;\n     private boolean strictDeprecationMode = false;\n     private boolean compressionEnabled = false;\n-    private boolean metadataHeaderEnabled = true;\n+    private boolean metaHeaderEnabled = true;\n \n     static {\n-        String version = \"\"; // unknown values are reported as empty strings in X-Elastic-Client-Meta\n-        final CodeSource codeSource = RestClientBuilder.class.getProtectionDomain().getCodeSource();\n-        if (codeSource != null) {\n-            URL url = codeSource.getLocation();\n-            if (url != null && url.toString().endsWith(\".jar\")) {\n-                try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                    Manifest manifest = jar.getManifest();\n-                    String esVersion = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                    if (esVersion != null) {\n-                        version = esVersion;\n-                    }\n-                } catch (Exception e) {\n-                    // Keep version unknown\n-                }\n+\n+        // Never fail on unknown version, even if an environment messed up their classpath enough that we can't find it.\n+        // Better have incomplete telemetry than crashing user applications.\n+        String version = null;\n+        try (InputStream is = RestClient.class.getResourceAsStream(\"version.properties\")) {\n+            if (is != null) {\n+                Properties versions = new Properties();\n+                versions.load(is);\n+                version = versions.getProperty(\"elasticsearch-client\");\n             }\n+        } catch (IOException e) {\n+            // Keep version unknown\n         }\n \n+        if (version == null) {\n+            version = \"\"; // unknown values are reported as empty strings in X-Elastic-Client-Meta\n+        }\n+\n+        VERSION = version;\n+\n         USER_AGENT_HEADER_VALUE = String.format(Locale.ROOT, \"elasticsearch-java/%s (Java/%s)\",\n-            version.isEmpty() ? \"Unknown\" : version, System.getProperty(\"java.version\"));\n+            VERSION.isEmpty() ? \"Unknown\" : VERSION, System.getProperty(\"java.version\"));\n \n         VersionInfo httpClientVersion = VersionInfo.loadVersionInfo(\"org.apache.http.nio.client\",\n             HttpAsyncClientBuilder.class.getClassLoader());\n \n         // service, language, transport, followed by additional information\n-        METADATA_HEADER_VALUE = \"es=\" + version +\n+        META_HEADER_VALUE = \"es=\" + VERSION +\n             \",jv=\" + System.getProperty(\"java.specification.version\") +\n-            \",t=\" + version +\n+            \",t=\" + VERSION +\n             \",hc=\" + (httpClientVersion == null ? \"\" : httpClientVersion.getRelease()) +\n-            RuntimeInfo.getRuntimeMetadata();\n+            LanguageRuntimeVersions.getRuntimeMetadata();\n     }\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMDMyMA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542830320", "bodyText": "While this is better, I still think we should not be silently allowing leniency in the computation. If the header is enabled, we should have a valid value, or throw an error. My original suggestion was to lazily set the cached header value (it could and should be outside this lambda, since as you say, the enabled flag is per client, we don't need to check it on every request). This way the method computing the header value does not need all of the try/catch for failures (with one exception: we still need to handle the various possible runtimes, but we should narrow those to ClassNotFoundException).", "author": "rjernst", "createdAt": "2020-12-14T21:47:16Z", "path": "client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java", "diffHunk": "@@ -220,11 +276,20 @@ private CloseableHttpAsyncClient createHttpClient() {\n                 //default settings for connection pooling may be too constraining\n                 .setMaxConnPerRoute(DEFAULT_MAX_CONN_PER_ROUTE).setMaxConnTotal(DEFAULT_MAX_CONN_TOTAL)\n                 .setSSLContext(SSLContext.getDefault())\n+                .setUserAgent(USER_AGENT_HEADER_VALUE)\n                 .setTargetAuthenticationStrategy(new PersistentCredentialsAuthenticationStrategy());\n             if (httpClientConfigCallback != null) {\n                 httpClientBuilder = httpClientConfigCallback.customizeHttpClient(httpClientBuilder);\n             }\n \n+            // Always add metadata header last so that it's not overwritten\n+            httpClientBuilder.addInterceptorLast((HttpRequest request, HttpContext context) -> {\n+                if (metadataHeaderEnabled) {\n+                    request.setHeader(METADATA_HEADER, METADATA_HEADER_VALUE);", "originalCommit": "ff2ad673536bfe2a5acec6d92065ecb52f94b2c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5NjM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542896394", "bodyText": "The header was already computed outside the lambda. Moving it to a static initializer allows computing it only once instead of at every construction of a client.\nRegarding exceptions and leniency, this header is enabled by default and should not be something users should be concerned with, except if they want to opt out telemetry by calling RestClientBuilder.setMetadataHeaderEnabled(false). That's all. In particular we should not require users to change their build system if it strips out the manifests we read the version from.\nNo error related to this header should ever bubble up to the user, and we can accept it to contain partial information: knowing that an ES Java client is making a request even if we could not find its version is already interesting information as it contributes to aggregated statistics about the Java client. Since we know it can happen, the aggregation logic will take care of it, and so in this context partial information is still valid information.\nAnd we can then work to understand why the version was not found and fix/update the discovery code.\nRegarding runtimes, we also have to be robust against errors that go beyond the existence of the class. For example an application may have a language runtime in a older version that does have the class we're checking, but not the field/method we read the version from. We should not fail in that case.\nWe should actually return partial information in that case too (e.g. \"I found Groovy, but couldn't find its version\") which this PR currently does not do. I have updated my playground for runtime sniffing for this.\nWDYT? Does this make sense? Did I miss something?", "author": "swallez", "createdAt": "2020-12-14T22:50:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMDMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjkyNzY3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r542927672", "bodyText": "Thanks for additional explanation. I understand the desire to not cause an error for a user, since this is something internal. It's understandable for the runtime. But for the Elasticsearch version or apache version, which make available through the build of our client, it could mask a bug on our end. Of course so could the runtimes; we could have a typo in the class or method names we introspect.\nThe thing that gives me pause about all this code is there are not really tests for the actual data, only for \"was anything written in the response?\"  Without tests for each of these runtimes, we can't be sure the code actually works. And for Elasticsearch version, using a fatjar seems like something that may be common, so I think we should expect any users building such a jar to include the appropriate manifest value. However, it is certainly something we can add as a requirement later, since something is better than nothing right now.", "author": "rjernst", "createdAt": "2020-12-14T23:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMDMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3NDU1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r543274557", "bodyText": "Without tests for each of these runtimes, we can't be sure the code actually works.\n\nThat's a fair point, and is why I have this \"playground project\" to test various runtimes. I see two possible approaches here:\n\nadd all those runtimes as test dependencies of the rest client.\nhave a separate project like the one above where we can test more language runtime variants, and have the rest client's RuntimeInfo code be a direct copy of the one tested in that separate project.\n\nFirst approach keeps the ES repo self-contained, but adds some dependencies that, even if limited to tests, add some weight to the build. It also doesn't allow testing different versions of a given language runtime unless we create additional Gradle subprojects.\nSecond approach allows having a more complex build with a main project containing the RuntimeInfo code, and several subprojects for each runtime version we want to test (e.g. scala-2.12, scala-2.13, scala-3). This allows testing RuntimeInfo with many combinations.\nThe drawback of this second approach is the manual operation to copy updated RuntimeInfo from that project to the rest client's code base, unless we can somehow automate it.\n\nit is certainly something we can add as a requirement later, since something is better than nothing right now.\n\nExactly. This is why I initially hard-coded the version as a string, but the additional maintenance burden that you pointed out led me to use what is available now and consider improving things later, e.g. by having a class generated at build time.\nWe should note that httpclient uses classpath resource lookup to find its version (e.g. /org/apache/http/nio/version.properties). Although not as strong as a hardcoded string, it should survive in a fat jar, contrarily to manifest attributes. So maybe an approach we should consider for ES itself (and the client).", "author": "swallez", "createdAt": "2020-12-15T11:44:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgzMDMyMA=="}], "type": "inlineReview", "revised_code": {"commit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\nindex 13838caea7c..1d79a1432be 100644\n--- a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n+++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n\n@@ -284,10 +287,10 @@ public final class RestClientBuilder {\n \n             // Always add metadata header last so that it's not overwritten\n             httpClientBuilder.addInterceptorLast((HttpRequest request, HttpContext context) -> {\n-                if (metadataHeaderEnabled) {\n-                    request.setHeader(METADATA_HEADER, METADATA_HEADER_VALUE);\n+                if (metaHeaderEnabled) {\n+                    request.setHeader(META_HEADER_NAME, META_HEADER_VALUE);\n                 } else {\n-                    request.removeHeaders(METADATA_HEADER);\n+                    request.removeHeaders(META_HEADER_NAME);\n                 }\n             });\n             final HttpAsyncClientBuilder finalBuilder = httpClientBuilder;\n"}}, {"oid": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "url": "https://github.com/elastic/elasticsearch/commit/7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "message": "Write version to a resource file, update language runtime lookup", "committedDate": "2021-01-25T17:38:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQxNjE0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565416143", "bodyText": "Is the return null vs return \"\" difference purposeful? Isn't it the same \"can't get the version\" case?", "author": "andreidan", "createdAt": "2021-01-27T15:45:14Z", "path": "client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java", "diffHunk": "@@ -57,79 +54,74 @@ public static String getRuntimeMetadata() {\n             s.append(\",gy=\").append(version);\n         }\n \n+        version = jRubyVersion();\n+        if (version != null) {\n+            s.append(\",jrb=\").append(version);\n+        }\n+\n         return s.toString();\n     }\n \n-    public static String HlrcKind() {\n-        try {\n-            Class.forName(\"org.elasticsearch.client.RestHighLevelClient\");\n-        } catch (Exception t) {\n-            return null;\n-        }\n-        // 1 is the HLRC based on ES server request/response classes\n-        // 2 will be the HLRC based on code generation from API specs\n-        return \"1\";\n+    public static String kotlinVersion() {\n+        //KotlinVersion.CURRENT.toString()\n+        return keepMajorMinor(getStaticField(\"kotlin.KotlinVersion\", \"CURRENT\"));\n     }\n \n-    public static String kotlinVersion() {\n+    public static String scalaVersion() {\n+        // scala.util.Properties.versionNumberString()\n+        return keepMajorMinor(callStaticMethod(\"scala.util.Properties\", \"versionNumberString\"));\n+    }\n+\n+    public static String clojureVersion() {\n+        // (clojure-version) which translates to\n+        // clojure.core$clojure_version.invokeStatic()\n+        return keepMajorMinor(callStaticMethod(\"clojure.core$clojure_version\", \"invokeStatic\"));\n+    }\n+\n+    public static String groovyVersion() {\n+        // groovy.lang.GroovySystem.getVersion()\n+        // There's also getShortVersion(), but only since Groovy 3.0.1\n+        return keepMajorMinor(callStaticMethod(\"groovy.lang.GroovySystem\", \"getVersion\"));\n+    }\n+\n+    public static String jRubyVersion() {\n+        // org.jruby.runtime.Constants.VERSION\n+        return keepMajorMinor(getStaticField(\"org.jruby.runtime.Constants\", \"VERSION\"));\n+    }\n+\n+    private static String getStaticField(String className, String fieldName) {\n+        Class<?> clazz;\n         try {\n-            //KotlinVersion.CURRENT.toString()\n-            Class<?> clazz = Class.forName(\"kotlin.KotlinVersion\");\n-            Field field = clazz.getField(\"CURRENT\");\n-            String version = field.get(null).toString();\n-            return stripPatchRevision(version);\n-\n-        } catch (Exception t) {\n-            // ignore\n+            clazz = Class.forName(className);\n+        } catch (ClassNotFoundException e) {\n+            return null;\n         }\n-        return null;\n-    }\n \n-    public static String scalaVersion() {\n         try {\n-            // scala.util.Properties.versionNumberString()\n-            Class<?> clazz = Class.forName(\"scala.util.Properties\");\n-            Method m = clazz.getMethod(\"versionNumberString\");\n-            String version = (String) m.invoke(null);\n-            return stripPatchRevision(version);\n-\n-        } catch (Exception t) {\n-            // ignore\n+            Field field = clazz.getField(fieldName);\n+            return field.get(null).toString();\n+        } catch (Exception e) {\n+            return \"\"; // can't get version information\n         }\n-        return null;\n     }\n \n-    public static String clojureVersion() {\n+    private static String callStaticMethod(String className, String methodName) {\n+        Class<?> clazz;\n         try {\n-            // (clojure-version) which translates to\n-            // clojure.core$clojure_version.invokeStatic()\n-            Class<?> clazz = Class.forName(\"clojure.core$clojure_version\");\n-            Method m = clazz.getMethod(\"invokeStatic\");\n-            String version = (String) m.invoke(null);\n-            return stripPatchRevision(version);\n-\n-        } catch (Exception t) {\n-            // ignore\n+            clazz = Class.forName(className);\n+        } catch (ClassNotFoundException e) {\n+            return null;", "originalCommit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0NTQ2MA==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565445460", "bodyText": "Yes, it's slightly different: we return null when the class doesn't exist, i.e. we're sure the language runtime isn't there (or at least the class identifying it). When it exists and we can't call the method or can't get the field, this means the information to look for has changed, and we report the language as existing but without version information. That will trigger an analysis on our end to look for updates to the language runtime.", "author": "swallez", "createdAt": "2021-01-27T16:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQxNjE0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2ODUwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565468505", "bodyText": "Hm, but if org.jruby.runtime.Constants is moved to org.jruby.newpackage.Constants this invariant will not hold anymore (ie. a particular class being there or not finding for the correct class FQN are indistinguishable cases IMO). I don't have a strong opinion on this, but I'd personally go for the simpler option of \"I don't know the version or if it is even present at all\"", "author": "andreidan", "createdAt": "2021-01-27T16:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQxNjE0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "13d0eefe00fb4418232f094f60df278fd7336554", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java b/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\ndeleted file mode 100644\nindex 2cf7318e280..00000000000\n--- a/client/rest/src/main/java/org/elasticsearch/client/LanguageRuntimeVersions.java\n+++ /dev/null\n\n@@ -1,137 +0,0 @@\n-/*\n- * Licensed to Elasticsearch under one or more contributor\n- * license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright\n- * ownership. Elasticsearch licenses this file to you under\n- * the Apache License, Version 2.0 (the \"License\"); you may\n- * not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.elasticsearch.client;\n-\n-import java.lang.reflect.Field;\n-import java.lang.reflect.Method;\n-\n-// Copied verbatim from https://github.com/elastic/jvm-languages-sniffer\n-\n-class LanguageRuntimeVersions {\n-\n-    /**\n-     * Returns runtime information by looking up classes identifying non-Java JVM\n-     * languages and appending a key with their name and their major.minor version, if available\n-     */\n-    public static String getRuntimeMetadata() {\n-        StringBuilder s = new StringBuilder();\n-        String version;\n-\n-        version= kotlinVersion();\n-        if (version != null) {\n-            s.append(\",kt=\").append(version);\n-        }\n-\n-        version = scalaVersion();\n-        if (version != null) {\n-            s.append(\",sc=\").append(version);\n-        }\n-\n-        version = clojureVersion();\n-        if (version != null) {\n-            s.append(\",clj=\").append(version);\n-        }\n-\n-        version = groovyVersion();\n-        if (version != null) {\n-            s.append(\",gy=\").append(version);\n-        }\n-\n-        version = jRubyVersion();\n-        if (version != null) {\n-            s.append(\",jrb=\").append(version);\n-        }\n-\n-        return s.toString();\n-    }\n-\n-    public static String kotlinVersion() {\n-        //KotlinVersion.CURRENT.toString()\n-        return keepMajorMinor(getStaticField(\"kotlin.KotlinVersion\", \"CURRENT\"));\n-    }\n-\n-    public static String scalaVersion() {\n-        // scala.util.Properties.versionNumberString()\n-        return keepMajorMinor(callStaticMethod(\"scala.util.Properties\", \"versionNumberString\"));\n-    }\n-\n-    public static String clojureVersion() {\n-        // (clojure-version) which translates to\n-        // clojure.core$clojure_version.invokeStatic()\n-        return keepMajorMinor(callStaticMethod(\"clojure.core$clojure_version\", \"invokeStatic\"));\n-    }\n-\n-    public static String groovyVersion() {\n-        // groovy.lang.GroovySystem.getVersion()\n-        // There's also getShortVersion(), but only since Groovy 3.0.1\n-        return keepMajorMinor(callStaticMethod(\"groovy.lang.GroovySystem\", \"getVersion\"));\n-    }\n-\n-    public static String jRubyVersion() {\n-        // org.jruby.runtime.Constants.VERSION\n-        return keepMajorMinor(getStaticField(\"org.jruby.runtime.Constants\", \"VERSION\"));\n-    }\n-\n-    private static String getStaticField(String className, String fieldName) {\n-        Class<?> clazz;\n-        try {\n-            clazz = Class.forName(className);\n-        } catch (ClassNotFoundException e) {\n-            return null;\n-        }\n-\n-        try {\n-            Field field = clazz.getField(fieldName);\n-            return field.get(null).toString();\n-        } catch (Exception e) {\n-            return \"\"; // can't get version information\n-        }\n-    }\n-\n-    private static String callStaticMethod(String className, String methodName) {\n-        Class<?> clazz;\n-        try {\n-            clazz = Class.forName(className);\n-        } catch (ClassNotFoundException e) {\n-            return null;\n-        }\n-\n-        try {\n-            Method m = clazz.getMethod(methodName);\n-            return m.invoke(null).toString();\n-        } catch (Exception e) {\n-            return \"\"; // can't get version information\n-        }\n-    }\n-\n-    static String keepMajorMinor(String version) {\n-        if (version == null) {\n-            return null;\n-        }\n-\n-        int firstDot = version.indexOf('.');\n-        int secondDot = version.indexOf('.', firstDot + 1);\n-        if (secondDot < 0) {\n-            return version;\n-        } else {\n-            return version.substring(0, secondDot);\n-        }\n-    }\n-}\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMDM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565420359", "bodyText": "nit: if we initialise it here with \"\" as a default value, the below if (version == null)check is not needed anymore", "author": "andreidan", "createdAt": "2021-01-27T15:50:09Z", "path": "client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java", "diffHunk": "@@ -71,35 +71,38 @@\n     private boolean metaHeaderEnabled = true;\n \n     static {\n-        String version = \"\"; // unknown values are reported as empty strings in X-Elastic-Client-Meta\n-        final CodeSource codeSource = RestClientBuilder.class.getProtectionDomain().getCodeSource();\n-        if (codeSource != null) {\n-            URL url = codeSource.getLocation();\n-            if (url != null && url.toString().endsWith(\".jar\")) {\n-                try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                    Manifest manifest = jar.getManifest();\n-                    String esVersion = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                    if (esVersion != null) {\n-                        version = esVersion;\n-                    }\n-                } catch (Exception e) {\n-                    // Keep version unknown\n-                }\n+\n+        // Never fail on unknown version, even if an environment messed up their classpath enough that we can't find it.\n+        // Better have incomplete telemetry than crashing user applications.\n+        String version = null;", "originalCommit": "7f5bdb9b39b18ee0a9a97ad5aa2c83236a5d1c83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQzNjU5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565436597", "bodyText": "Actually it is: versions.getProperty(\"elasticsearch-client\") can return null if the property file exists but doesn't contain that property. I agree that this is unlikely to happen, but client applications are a wild environment \ud83d\ude1b\nSo I finally chose that approach so that we don't have a mix of tests for \"\" and null.", "author": "swallez", "createdAt": "2021-01-27T16:10:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMDM1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQzODY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/66303#discussion_r565438645", "bodyText": "Ah, good shout!", "author": "andreidan", "createdAt": "2021-01-27T16:12:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQyMDM1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "13d0eefe00fb4418232f094f60df278fd7336554", "chunk": "diff --git a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\nindex 1d79a1432be..4393319f8d8 100644\n--- a/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n+++ b/client/rest/src/main/java/org/elasticsearch/client/RestClientBuilder.java\n\n@@ -68,42 +61,7 @@ public final class RestClientBuilder {\n     private NodeSelector nodeSelector = NodeSelector.ANY;\n     private boolean strictDeprecationMode = false;\n     private boolean compressionEnabled = false;\n-    private boolean metaHeaderEnabled = true;\n-\n-    static {\n-\n-        // Never fail on unknown version, even if an environment messed up their classpath enough that we can't find it.\n-        // Better have incomplete telemetry than crashing user applications.\n-        String version = null;\n-        try (InputStream is = RestClient.class.getResourceAsStream(\"version.properties\")) {\n-            if (is != null) {\n-                Properties versions = new Properties();\n-                versions.load(is);\n-                version = versions.getProperty(\"elasticsearch-client\");\n-            }\n-        } catch (IOException e) {\n-            // Keep version unknown\n-        }\n-\n-        if (version == null) {\n-            version = \"\"; // unknown values are reported as empty strings in X-Elastic-Client-Meta\n-        }\n-\n-        VERSION = version;\n-\n-        USER_AGENT_HEADER_VALUE = String.format(Locale.ROOT, \"elasticsearch-java/%s (Java/%s)\",\n-            VERSION.isEmpty() ? \"Unknown\" : VERSION, System.getProperty(\"java.version\"));\n-\n-        VersionInfo httpClientVersion = VersionInfo.loadVersionInfo(\"org.apache.http.nio.client\",\n-            HttpAsyncClientBuilder.class.getClassLoader());\n-\n-        // service, language, transport, followed by additional information\n-        META_HEADER_VALUE = \"es=\" + VERSION +\n-            \",jv=\" + System.getProperty(\"java.specification.version\") +\n-            \",t=\" + VERSION +\n-            \",hc=\" + (httpClientVersion == null ? \"\" : httpClientVersion.getRelease()) +\n-            LanguageRuntimeVersions.getRuntimeMetadata();\n-    }\n+    private boolean metadataHeaderEnabled = true;\n \n     /**\n      * Creates a new builder instance and sets the hosts that the client will send requests to.\n"}}, {"oid": "13d0eefe00fb4418232f094f60df278fd7336554", "url": "https://github.com/elastic/elasticsearch/commit/13d0eefe00fb4418232f094f60df278fd7336554", "message": "[client] Add client metadata header on RestClient requests", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "712a9746aab410d29634a9860de92a80c6be94b4", "url": "https://github.com/elastic/elasticsearch/commit/712a9746aab410d29634a9860de92a80c6be94b4", "message": "Change Throwable to Exception, add test", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "7d1cd8adb30e2e3f46bc7bbde9362880b156b91d", "url": "https://github.com/elastic/elasticsearch/commit/7d1cd8adb30e2e3f46bc7bbde9362880b156b91d", "message": "Rename 'v' to 'version'", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "9179f54d740cd9d3e35be1f7f80b7d8b8a30904e", "url": "https://github.com/elastic/elasticsearch/commit/9179f54d740cd9d3e35be1f7f80b7d8b8a30904e", "message": "Read version from Manifest to avoid hardcoding the version in the client", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "219b8ea19593e5569427530247dd7bbfa8ed4223", "url": "https://github.com/elastic/elasticsearch/commit/219b8ea19593e5569427530247dd7bbfa8ed4223", "message": "Fix style issue & forbidden API", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "777242a5bfef266d8fbfc8ff5740eb211c91df8d", "url": "https://github.com/elastic/elasticsearch/commit/777242a5bfef266d8fbfc8ff5740eb211c91df8d", "message": "Compute header values in static initializer", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "201039ca96d388ad2ef821414d809b13f9cbc5fe", "url": "https://github.com/elastic/elasticsearch/commit/201039ca96d388ad2ef821414d809b13f9cbc5fe", "message": "Fix combined runtime info calculation", "committedDate": "2021-02-01T14:30:16Z", "type": "commit"}, {"oid": "f285e69fef89dda55ec5fc8a6bdcb1a90fa81954", "url": "https://github.com/elastic/elasticsearch/commit/f285e69fef89dda55ec5fc8a6bdcb1a90fa81954", "message": "Rename \"metadata header\" to \"meta header\"", "committedDate": "2021-02-01T14:30:17Z", "type": "commit"}, {"oid": "4d17a8f96e965a6ebdf56ebb49e71f2f5147ca14", "url": "https://github.com/elastic/elasticsearch/commit/4d17a8f96e965a6ebdf56ebb49e71f2f5147ca14", "message": "Write version to a resource file, update language runtime lookup", "committedDate": "2021-02-01T14:30:17Z", "type": "commit"}, {"oid": "a8d7c5ad2d9a41a3f24f49bb4ecf93e0d0e8636a", "url": "https://github.com/elastic/elasticsearch/commit/a8d7c5ad2d9a41a3f24f49bb4ecf93e0d0e8636a", "message": "Get httpclient's version in a privileged context\n\nThis is needed because of the call to getClassLoader()\n\nFixes the failure of testThatHttpExporterAddsWatches that was caused by the test\nES serverto fail while instanciating a client to setup remote monitoring.", "committedDate": "2021-02-01T14:59:35Z", "type": "commit"}, {"oid": "a8d7c5ad2d9a41a3f24f49bb4ecf93e0d0e8636a", "url": "https://github.com/elastic/elasticsearch/commit/a8d7c5ad2d9a41a3f24f49bb4ecf93e0d0e8636a", "message": "Get httpclient's version in a privileged context\n\nThis is needed because of the call to getClassLoader()\n\nFixes the failure of testThatHttpExporterAddsWatches that was caused by the test\nES serverto fail while instanciating a client to setup remote monitoring.", "committedDate": "2021-02-01T14:59:35Z", "type": "forcePushed"}, {"oid": "6be9af3376e57972723fc960aae1cb563c23f5b7", "url": "https://github.com/elastic/elasticsearch/commit/6be9af3376e57972723fc960aae1cb563c23f5b7", "message": "Remove unused import", "committedDate": "2021-02-01T15:36:55Z", "type": "commit"}, {"oid": "80c11f9facc995baaf9334ae541b772b27138cf4", "url": "https://github.com/elastic/elasticsearch/commit/80c11f9facc995baaf9334ae541b772b27138cf4", "message": "Simplify properties file generation", "committedDate": "2021-02-01T19:19:50Z", "type": "commit"}]}