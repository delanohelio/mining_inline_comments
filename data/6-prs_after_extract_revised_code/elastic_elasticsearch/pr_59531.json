{"pr_number": 59531, "pr_title": "Fix auditing of nameless API Keys", "pr_createdAt": "2020-07-14T12:53:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59531", "timeline": [{"oid": "e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "url": "https://github.com/elastic/elasticsearch/commit/e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "message": "namelless api key authn", "committedDate": "2020-07-14T12:47:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MjI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/59531#discussion_r454342260", "bodyText": "This can be just\nlogEntry.with(API_KEY_NAME_FIELD_NAME, apiKeyName);", "author": "ywangd", "createdAt": "2020-07-14T13:07:34Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -832,8 +832,11 @@ LogEntryBuilder withAuthentication(Authentication authentication) {\n             logEntry.with(PRINCIPAL_FIELD_NAME, authentication.getUser().principal());\n             logEntry.with(AUTHENTICATION_TYPE_FIELD_NAME, authentication.getAuthenticationType().toString());\n             if (Authentication.AuthenticationType.API_KEY == authentication.getAuthenticationType()) {\n-                logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY))\n-                        .with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));\n+                logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY));\n+                String apiKeyName = (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n+                if (apiKeyName != null) {\n+                    logEntry.with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));", "originalCommit": "e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3a65006a8bcb24ba869bde25fb8cbcac9a7f881a", "chunk": "diff --git a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java\nindex 851e18a72c6..210d5031510 100644\n--- a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java\n+++ b/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java\n\n@@ -835,7 +835,7 @@ public class LoggingAuditTrail implements AuditTrail, ClusterStateListener {\n                 logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY));\n                 String apiKeyName = (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n                 if (apiKeyName != null) {\n-                    logEntry.with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));\n+                    logEntry.with(API_KEY_NAME_FIELD_NAME, apiKeyName);\n                 }\n                 String creatorRealmName = (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME);\n                 if (creatorRealmName != null) {\n"}}, {"oid": "3a65006a8bcb24ba869bde25fb8cbcac9a7f881a", "url": "https://github.com/elastic/elasticsearch/commit/3a65006a8bcb24ba869bde25fb8cbcac9a7f881a", "message": "Review", "committedDate": "2020-07-14T13:21:37Z", "type": "commit"}]}