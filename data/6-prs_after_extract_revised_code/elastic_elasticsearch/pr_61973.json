{"pr_number": 61973, "pr_title": "More resilient ILM history rollover test", "pr_createdAt": "2020-09-04T10:32:33Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61973", "timeline": [{"oid": "d7455d345c51ffe34b8479bc6062c4b55aaff825", "url": "https://github.com/elastic/elasticsearch/commit/d7455d345c51ffe34b8479bc6062c4b55aaff825", "message": "More resilient ILM history rollover test", "committedDate": "2020-09-04T10:30:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYyNzAxMA==", "url": "https://github.com/elastic/elasticsearch/pull/61973#discussion_r483627010", "bodyText": "Thanks for fixing this Przemko.\nCan you add a comment on why this is needed please? it's not obvious assertBusy fails on the first non-AssertionError exception. We could also use assertHitCount maybe?\nIs it worth also increasing the timeout of assertBusy to 30 seconds?", "author": "andreidan", "createdAt": "2020-09-04T13:48:35Z", "path": "x-pack/plugin/ilm/src/internalClusterTest/java/org/elasticsearch/xpack/ilm/ILMHistoryTests.java", "diffHunk": "@@ -91,8 +91,12 @@ public void testIlmHistoryIndexCanRollover() throws Exception {\n \n         //wait for all history items to index to avoid waiting for timeout in ILMHistoryStore beforeBulk\n         assertBusy(() -> {\n-            SearchResponse search = client().prepareSearch(firstIndex).setQuery(matchQuery(\"index\", firstIndex)).setSize(0).get();\n-            assertThat(search.getHits().getTotalHits().value, is(9L));\n+            try {\n+                SearchResponse search = client().prepareSearch(firstIndex).setQuery(matchQuery(\"index\", firstIndex)).setSize(0).get();\n+                assertThat(search.getHits().getTotalHits().value, is(9L));\n+            } catch (Exception e) {\n+                fail(e.getMessage());", "originalCommit": "d7455d345c51ffe34b8479bc6062c4b55aaff825", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU3ODM1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61973#discussion_r484578359", "bodyText": "I've added a comment and switched to assertHitCount. I don't think we need to increase timeout - we should have to wait for at most 5s for all ILM history items to be index", "author": "probakowski", "createdAt": "2020-09-07T22:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYyNzAxMA=="}], "type": "inlineReview", "revised_code": {"commit": "a553a26304497d4059de832419aaa615d17008b5", "chunk": "diff --git a/x-pack/plugin/ilm/src/internalClusterTest/java/org/elasticsearch/xpack/ilm/ILMHistoryTests.java b/x-pack/plugin/ilm/src/internalClusterTest/java/org/elasticsearch/xpack/ilm/ILMHistoryTests.java\nindex eab3afb34ee..671c6ccf3bc 100644\n--- a/x-pack/plugin/ilm/src/internalClusterTest/java/org/elasticsearch/xpack/ilm/ILMHistoryTests.java\n+++ b/x-pack/plugin/ilm/src/internalClusterTest/java/org/elasticsearch/xpack/ilm/ILMHistoryTests.java\n\n@@ -95,6 +95,8 @@ public class ILMHistoryTests extends ESIntegTestCase {\n                 SearchResponse search = client().prepareSearch(firstIndex).setQuery(matchQuery(\"index\", firstIndex)).setSize(0).get();\n                 assertThat(search.getHits().getTotalHits().value, is(9L));\n             } catch (Exception e) {\n+                //assertBusy will stop on first non-assertion error and it can happen when we try to search too early\n+                //instead of failing the whole test change it to assertion error and wait some more time\n                 fail(e.getMessage());\n             }\n         });\n"}}, {"oid": "a553a26304497d4059de832419aaa615d17008b5", "url": "https://github.com/elastic/elasticsearch/commit/a553a26304497d4059de832419aaa615d17008b5", "message": "add comment", "committedDate": "2020-09-07T22:28:47Z", "type": "commit"}, {"oid": "eaef8941a28abca83c2a747b366d5e7d4b7de910", "url": "https://github.com/elastic/elasticsearch/commit/eaef8941a28abca83c2a747b366d5e7d4b7de910", "message": "use assertHitCount", "committedDate": "2020-09-07T22:30:11Z", "type": "commit"}, {"oid": "f78778058c3b60d9b324cd50823e961f2a306deb", "url": "https://github.com/elastic/elasticsearch/commit/f78778058c3b60d9b324cd50823e961f2a306deb", "message": "Merge branch 'master' into ilm-history-rollover-fix", "committedDate": "2020-09-07T22:41:46Z", "type": "commit"}]}