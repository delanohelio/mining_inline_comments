{"pr_number": 50639, "pr_title": "Use single directory for metadata", "pr_createdAt": "2020-01-06T08:53:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50639", "timeline": [{"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83", "url": "https://github.com/elastic/elasticsearch/commit/f695669393f94056f9b79b4b7152a0fd6541fe83", "message": "Use single directory for metadata", "committedDate": "2020-01-04T14:32:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNDU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r363204551", "bodyText": "while not strictly part of the logic in this PR, this fixes the testCannotJoinClusterWithDifferentUUID test that was occasionally failing without this being properly implemented.", "author": "ywelsch", "createdAt": "2020-01-06T08:55:02Z", "path": "test/framework/src/main/java/org/elasticsearch/cluster/coordination/AbstractCoordinatorTestCase.java", "diffHunk": "@@ -740,12 +742,14 @@ public void close() {\n                     if (oldState.nodeEnvironment != null) {\n                         nodeEnvironment = oldState.nodeEnvironment;\n                         final MetaData updatedMetaData = adaptGlobalMetaData.apply(oldState.getLastAcceptedState().metaData());\n-                        if (updatedMetaData != oldState.getLastAcceptedState().metaData()) {\n-                            throw new AssertionError(\"TODO adapting persistent metadata is not supported yet\");\n-                        }\n                         final long updatedTerm = adaptCurrentTerm.apply(oldState.getCurrentTerm());\n-                        if (updatedTerm != oldState.getCurrentTerm()) {\n-                            throw new AssertionError(\"TODO adapting persistent current term is not supported yet\");\n+                        if (updatedMetaData != oldState.getLastAcceptedState().metaData() || updatedTerm != oldState.getCurrentTerm()) {", "originalCommit": "f695669393f94056f9b79b4b7152a0fd6541fe83", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5ODUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r364198509", "bodyText": "\ud83d\udc4d", "author": "DaveCTurner", "createdAt": "2020-01-08T12:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNDU1MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5NzA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r364197041", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void deleteAll(Path[] dataPaths) throws IOException {\n          \n          \n            \n                /**\n          \n          \n            \n                 * Remove all persisted cluster states from the given data paths, for use in tests. Should only be called when there is no open\n          \n          \n            \n                 * {@link Writer} on these paths.\n          \n          \n            \n                 */\n          \n          \n            \n                public static void deleteAll(Path[] dataPaths) throws IOException {", "author": "DaveCTurner", "createdAt": "2020-01-08T12:00:03Z", "path": "server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java", "diffHunk": "@@ -177,6 +178,12 @@ public Writer createWriter() throws IOException {\n         return new Writer(metaDataIndexWriters, nodeId, bigArrays);\n     }\n \n+    public static void deleteAll(Path[] dataPaths) throws IOException {", "originalCommit": "f695669393f94056f9b79b4b7152a0fd6541fe83", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "94aff6968e2c31ffd26809c67055c2943a34be8c", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java b/server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java\nindex 2c3916f938f..ab7b55056d3 100644\n--- a/server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java\n+++ b/server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java\n\n@@ -178,6 +178,10 @@ public class PersistedClusterStateService {\n         return new Writer(metaDataIndexWriters, nodeId, bigArrays);\n     }\n \n+    /**\n+     * Remove all persisted cluster states from the given data paths, for use in tests. Should only be called when there is no open\n+     * {@link Writer} on these paths.\n+     */\n     public static void deleteAll(Path[] dataPaths) throws IOException {\n         for (Path dataPath : dataPaths) {\n             Lucene.cleanLuceneIndex(new SimpleFSDirectory(dataPath.resolve(METADATA_DIRECTORY_NAME)));\n"}}, {"oid": "94aff6968e2c31ffd26809c67055c2943a34be8c", "url": "https://github.com/elastic/elasticsearch/commit/94aff6968e2c31ffd26809c67055c2943a34be8c", "message": "Update server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java\r\n\r\njavadoc\n\nCo-Authored-By: David Turner <david.turner@elastic.co>", "committedDate": "2020-01-08T13:00:16Z", "type": "commit"}]}