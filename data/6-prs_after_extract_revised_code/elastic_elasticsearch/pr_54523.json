{"pr_number": 54523, "pr_title": "Unassign DFA tasks in SetUpgradeModeAction", "pr_createdAt": "2020-03-31T17:45:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54523", "timeline": [{"oid": "2a44e322dc64a167111cedfd35b1d57931c0616d", "url": "https://github.com/elastic/elasticsearch/commit/2a44e322dc64a167111cedfd35b1d57931c0616d", "message": "Unassign DFA tasks in SetUpgradeModeAction", "committedDate": "2020-04-01T06:57:31Z", "type": "forcePushed"}, {"oid": "ceba14701140d834356f1e1812ee52387cf4ff4d", "url": "https://github.com/elastic/elasticsearch/commit/ceba14701140d834356f1e1812ee52387cf4ff4d", "message": "Unassign DFA tasks in SetUpgradeModeAction", "committedDate": "2020-04-01T10:45:36Z", "type": "forcePushed"}, {"oid": "97414ca39c57a5359bad703f9bf31e2a67e56794", "url": "https://github.com/elastic/elasticsearch/commit/97414ca39c57a5359bad703f9bf31e2a67e56794", "message": "Unassign DFA tasks in SetUpgradeModeAction", "committedDate": "2020-04-01T11:23:51Z", "type": "forcePushed"}, {"oid": "b7f6ab8ace2e8dee107dae8cb981785b0a476ec5", "url": "https://github.com/elastic/elasticsearch/commit/b7f6ab8ace2e8dee107dae8cb981785b0a476ec5", "message": "Unassign DFA tasks in SetUpgradeModeAction", "committedDate": "2020-04-02T06:01:54Z", "type": "forcePushed"}, {"oid": "c020995013e13c87f1267811d61d1bdcaae49f68", "url": "https://github.com/elastic/elasticsearch/commit/c020995013e13c87f1267811d61d1bdcaae49f68", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1.", "committedDate": "2020-04-06T12:48:01Z", "type": "forcePushed"}, {"oid": "a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "url": "https://github.com/elastic/elasticsearch/commit/a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1.", "committedDate": "2020-04-10T07:26:59Z", "type": "forcePushed"}, {"oid": "81362ee57b0d20e71927190864905fa3ac7d31b7", "url": "https://github.com/elastic/elasticsearch/commit/81362ee57b0d20e71927190864905fa3ac7d31b7", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1.", "committedDate": "2020-04-10T11:42:21Z", "type": "forcePushed"}, {"oid": "34ddd74609981e493eee4463f49522757b97bef8", "url": "https://github.com/elastic/elasticsearch/commit/34ddd74609981e493eee4463f49522757b97bef8", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1.", "committedDate": "2020-04-10T11:45:22Z", "type": "forcePushed"}, {"oid": "e5d67cde5225930125b3aec339a8f49c595af3e5", "url": "https://github.com/elastic/elasticsearch/commit/e5d67cde5225930125b3aec339a8f49c595af3e5", "message": "Enable upgrade mode *after* putting a job in order to fix the test", "committedDate": "2020-04-10T12:17:45Z", "type": "forcePushed"}, {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2", "url": "https://github.com/elastic/elasticsearch/commit/fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2", "message": "Enable upgrade mode *after* putting a job in order to fix the test", "committedDate": "2020-04-10T13:12:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406751531", "bodyText": "Isn't this assertion risky? Could it not be the task has advanced state by this point?", "author": "dimitris-athanasiou", "createdAt": "2020-04-10T13:13:45Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "originalCommit": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1NTkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406755922", "bodyText": "You're right. I've removed this assertion and added waitUntilAnalyticsIsStopped instead.\nI'm wondering though what to do with an assertion in line 522. Do you think it is reasonable to expect it to be STARTING?", "author": "przemekwitek", "createdAt": "2020-04-10T13:25:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2Mzc5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406763791", "bodyText": "I thought that one made sense because the persistent task exists but it won't be assigned as upgrade mode was enabled. This the reported state should consistently be starting. Am I not reading this right?", "author": "dimitris-athanasiou", "createdAt": "2020-04-10T13:45:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2NDk4MA==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406764980", "bodyText": "I'm wondering if the state could advance between lines 513 (starting job) and 517. (pausing it with upgrade mode)", "author": "przemekwitek", "createdAt": "2020-04-10T13:48:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3MDk4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406770983", "bodyText": "Perhaps you're right. You could manually test this by running a job and setting upgrade mode while it's past the starting state.", "author": "dimitris-athanasiou", "createdAt": "2020-04-10T14:01:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc4MTkwMw==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406781903", "bodyText": "I've just removed that state assertion too. Job state is not that important to verify in this test.\nUpgrade mode should work correctly for any job state, so I think there is no need asserting there.", "author": "przemekwitek", "createdAt": "2020-04-10T14:27:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "01070e0db802764aee7fca3fd91cfd51401dfe46", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\nindex 0bd5df5b9ad..bbb586cbef8 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n\n@@ -538,17 +539,15 @@ public class ClassificationIT extends MlNativeDataFrameAnalyticsIntegTestCase {\n \n         assertThat(upgradeMode(), is(false));\n \n+        setUpgradeModeTo(true);\n+\n         DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n         registerAnalytics(config);\n         putAnalytics(config);\n \n-        setUpgradeModeTo(true);\n-\n         ElasticsearchStatusException e = expectThrows(ElasticsearchStatusException.class, () -> startAnalytics(config.getId()));\n         assertThat(e.status(), is(equalTo(RestStatus.TOO_MANY_REQUESTS)));\n-        assertThat(\n-            e.getMessage(),\n-            is(equalTo(\"Cannot perform cluster:admin/xpack/ml/data_frame/analytics/start action while upgrade mode is enabled\")));\n+        assertThat(e.getMessage(), containsString(\"persistent task cannot be assigned while upgrade mode is enabled\"));\n \n         assertThat(analyticsTaskList(), is(empty()));\n         assertThat(analyticsAssignedTaskList(), is(empty()));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2MzQxNw==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406763417", "bodyText": "I'd say we don't need this assertion at all.", "author": "dimitris-athanasiou", "createdAt": "2020-04-10T13:44:11Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,68 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(", "originalCommit": "9158f23d693f59b783c03939b073a7b5a5fd8a3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2NDIyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406764225", "bodyText": "Done.", "author": "przemekwitek", "createdAt": "2020-04-10T13:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2MzQxNw=="}], "type": "inlineReview", "revised_code": {"commit": "01070e0db802764aee7fca3fd91cfd51401dfe46", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\nindex ed8c74392d8..bbb586cbef8 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java\n\n@@ -528,16 +529,7 @@ public class ClassificationIT extends MlNativeDataFrameAnalyticsIntegTestCase {\n         assertThat(analyticsAssignedTaskList(), hasSize(1));\n \n         analyticsStats = getAnalyticsStats(jobId);\n-        assertThat(\n-            analyticsStats.getState(),\n-            is(anyOf(\n-                equalTo(DataFrameAnalyticsState.STARTING),\n-                equalTo(DataFrameAnalyticsState.STARTED),\n-                equalTo(DataFrameAnalyticsState.REINDEXING),\n-                equalTo(DataFrameAnalyticsState.ANALYZING),\n-                equalTo(DataFrameAnalyticsState.STOPPING),\n-                equalTo(DataFrameAnalyticsState.STOPPED))));\n-\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n         assertThat(analyticsStats.getAssignmentExplanation(), is(not(equalTo(AWAITING_UPGRADE.getExplanation()))));\n     }\n \n"}}, {"oid": "01070e0db802764aee7fca3fd91cfd51401dfe46", "url": "https://github.com/elastic/elasticsearch/commit/01070e0db802764aee7fca3fd91cfd51401dfe46", "message": "Unassign DFA tasks in SetUpgradeModeAction", "committedDate": "2020-04-14T06:22:51Z", "type": "commit"}, {"oid": "e7a0e802f12f0d5c20bb8e30aa1fecad952593ad", "url": "https://github.com/elastic/elasticsearch/commit/e7a0e802f12f0d5c20bb8e30aa1fecad952593ad", "message": "Wait for the job to be at least REINDEXING before attempting setting upgrade mode", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "6bed636efa003f5feab272c3b1c6dd8d09419f09", "url": "https://github.com/elastic/elasticsearch/commit/6bed636efa003f5feab272c3b1c6dd8d09419f09", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1.", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "2467797a8bdcd5764b976a160cc0e6ee5d014a01", "url": "https://github.com/elastic/elasticsearch/commit/2467797a8bdcd5764b976a160cc0e6ee5d014a01", "message": "Enable upgrade mode *after* putting a job in order to fix the test", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "8714baaa2e72948e60816ec3a55aabaf89ca1e0c", "url": "https://github.com/elastic/elasticsearch/commit/8714baaa2e72948e60816ec3a55aabaf89ca1e0c", "message": "Apply review comment", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "5f3e39452c51d662562ae4a80033b05b9f3d767b", "url": "https://github.com/elastic/elasticsearch/commit/5f3e39452c51d662562ae4a80033b05b9f3d767b", "message": "Apply review comment", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "6a2bf578dc3dca737299986f7c2254b746c7f1b0", "url": "https://github.com/elastic/elasticsearch/commit/6a2bf578dc3dca737299986f7c2254b746c7f1b0", "message": "Remove unnecessary assertion", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "f4c281b3fe916ee06769b564ac2d40cde352f775", "url": "https://github.com/elastic/elasticsearch/commit/f4c281b3fe916ee06769b564ac2d40cde352f775", "message": "Remove solved TODOs", "committedDate": "2020-04-14T06:22:52Z", "type": "commit"}, {"oid": "f4c281b3fe916ee06769b564ac2d40cde352f775", "url": "https://github.com/elastic/elasticsearch/commit/f4c281b3fe916ee06769b564ac2d40cde352f775", "message": "Remove solved TODOs", "committedDate": "2020-04-14T06:22:52Z", "type": "forcePushed"}]}