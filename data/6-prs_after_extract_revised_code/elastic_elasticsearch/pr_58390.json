{"pr_number": 58390, "pr_title": "Fix Incorrect Snapshot Shar Status for DONE Shards in Running Snapshots", "pr_createdAt": "2020-06-20T15:40:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58390", "timeline": [{"oid": "5da2282ccbdc051029ba4903c957d8598aa5f8df", "url": "https://github.com/elastic/elasticsearch/commit/5da2282ccbdc051029ba4903c957d8598aa5f8df", "message": "Fix Incorrect Snapshot Shard Level Status for Unchanged Shard Snapshots\n\nMinor bug:\nIf a shard hasn't changed at all we were reporting `0` for total size and total file count\nwhile it was ongoing.", "committedDate": "2020-06-20T15:38:29Z", "type": "commit"}, {"oid": "052b4942cef7e0d7da1000a750cbd13cc78586f1", "url": "https://github.com/elastic/elasticsearch/commit/052b4942cef7e0d7da1000a750cbd13cc78586f1", "message": "enhance tests", "committedDate": "2020-06-20T15:52:41Z", "type": "commit"}, {"oid": "3832aee3bfa354611d485f84f64e00243aec7635", "url": "https://github.com/elastic/elasticsearch/commit/3832aee3bfa354611d485f84f64e00243aec7635", "message": "fix other spot", "committedDate": "2020-06-20T17:12:51Z", "type": "commit"}, {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "url": "https://github.com/elastic/elasticsearch/commit/dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "message": "Merge remote-tracking branch 'elastic/master' into fix-total-file-counts", "committedDate": "2020-06-25T18:46:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzAzMg==", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093032", "bodyText": "why create a copy here?", "author": "ywelsch", "createdAt": "2020-06-26T10:07:32Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/status/TransportSnapshotsStatusAction.java", "diffHunk": "@@ -199,7 +204,20 @@ private void buildResponse(SnapshotsInProgress snapshotsInProgress, SnapshotsSta\n                         default:\n                             throw new IllegalArgumentException(\"Unknown snapshot state \" + shardEntry.value.state());\n                     }\n-                    SnapshotIndexShardStatus shardStatus = new SnapshotIndexShardStatus(shardEntry.key, stage);\n+                    final SnapshotIndexShardStatus shardStatus;\n+                    if (stage == SnapshotIndexShardStage.DONE) {\n+                        // Shard snapshot completed successfully so we should be able to load the exact statistics for this\n+                        // shard from the repository already.\n+                        if (indexIdLookup == null) {\n+                            indexIdLookup = entry.indices().stream().collect(Collectors.toMap(IndexId::getName, Function.identity()));\n+                        }\n+                        final ShardId shardId = shardEntry.key;\n+                        shardStatus = new SnapshotIndexShardStatus(shardId, repositoriesService.repository(entry.repository())\n+                            .getShardSnapshotStatus(entry.snapshot().getSnapshotId(), indexIdLookup.get(shardId.getIndexName()),\n+                                shardId).asCopy());", "originalCommit": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEwMzUzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446103535", "bodyText": "It's just how the constructor org.elasticsearch.action.admin.cluster.snapshots.status.SnapshotIndexShardStatus#SnapshotIndexShardStatus(org.elasticsearch.index.shard.ShardId, org.elasticsearch.index.snapshots.IndexShardSnapshotStatus.Copy) works. Copy is a different type here it's not an object clone or anything like that. We could definitely look into cleaning this up, there is no need for this complication with the way IndexShardSnapshotStatus works these days.", "author": "original-brownbear", "createdAt": "2020-06-26T10:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzAzMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzkwMA==", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093900", "bodyText": "space missing", "author": "ywelsch", "createdAt": "2020-06-26T10:09:26Z", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1796,6 +1796,10 @@ public void snapshotShard(Store store, MapperService mapperService, SnapshotId s\n                     }\n                 }\n             } else {\n+                for (BlobStoreIndexShardSnapshot.FileInfo fileInfo : filesFromSegmentInfos) {\n+                    indexTotalNumberOfFiles++;\n+                    indexTotalFileSize+= fileInfo.length();", "originalCommit": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a22ee942af41bffa1b1b63933e6d226a3f7585f9", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java b/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\nindex 10305bb4431..1698b5dddd6 100644\n--- a/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\n+++ b/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\n\n@@ -1798,7 +1798,7 @@ public abstract class BlobStoreRepository extends AbstractLifecycleComponent imp\n             } else {\n                 for (BlobStoreIndexShardSnapshot.FileInfo fileInfo : filesFromSegmentInfos) {\n                     indexTotalNumberOfFiles++;\n-                    indexTotalFileSize+= fileInfo.length();\n+                    indexTotalFileSize += fileInfo.length();\n                 }\n                 indexCommitPointFiles = filesFromSegmentInfos;\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5NjM0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446096349", "bodyText": "can you add some javadocs to this method to describe what exact situation is being tested here? There are a large number of steps in the test, and it might be easier to have a high-level  description of what's  going on  here.", "author": "ywelsch", "createdAt": "2020-06-26T10:14:45Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java", "diffHunk": "@@ -189,4 +193,102 @@ public void testGetSnapshotsWithoutIndices() {\n         assertThat(found.snapshotId(), is(snapshotInfo.snapshotId()));\n         assertThat(found.state(), is(SnapshotState.SUCCESS));\n     }\n+\n+    public void testCorrectCountsForDoneShards() throws Exception {", "originalCommit": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a22ee942af41bffa1b1b63933e6d226a3f7585f9", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java\nindex 1e99f9e8839..e80d299bd18 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java\n\n@@ -194,6 +194,15 @@ public class SnapshotStatusApisIT extends AbstractSnapshotIntegTestCase {\n         assertThat(found.state(), is(SnapshotState.SUCCESS));\n     }\n \n+    /**\n+     * Tests the following sequence of steps:\n+     * 1. Start snapshot of two shards (both located on separate data nodes).\n+     * 2. Have one of the shards snapshot completely and the other block\n+     * 3. Restart the data node that completed its shard snapshot\n+     * 4. Make sure that snapshot status APIs show correct file-counts and -sizes\n+     *\n+     * @throws Exception on failure\n+     */\n     public void testCorrectCountsForDoneShards() throws Exception {\n         final String indexOne = \"index-1\";\n         final String indexTwo = \"index-2\";\n"}}, {"oid": "445c608b99d15c2ac1eb933dc8b4a21567e40e2f", "url": "https://github.com/elastic/elasticsearch/commit/445c608b99d15c2ac1eb933dc8b4a21567e40e2f", "message": "Merge remote-tracking branch 'elastic/master' into fix-total-file-counts", "committedDate": "2020-06-26T10:28:38Z", "type": "commit"}, {"oid": "a22ee942af41bffa1b1b63933e6d226a3f7585f9", "url": "https://github.com/elastic/elasticsearch/commit/a22ee942af41bffa1b1b63933e6d226a3f7585f9", "message": "javadocs + format", "committedDate": "2020-06-26T10:35:08Z", "type": "commit"}]}