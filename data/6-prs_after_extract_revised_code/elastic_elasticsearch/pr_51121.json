{"pr_number": 51121, "pr_title": "Improve file filter for insecure repo tests", "pr_createdAt": "2020-01-16T18:48:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51121", "timeline": [{"oid": "f8cc9320c5ec880d99fa42eed15fd01ef1ccc68d", "url": "https://github.com/elastic/elasticsearch/commit/f8cc9320c5ec880d99fa42eed15fd01ef1ccc68d", "message": "Improve file filter for insecure repo tests\n\nTests in BuildPluginIT copy the workspace but exclude the build\ndirectories based on whether the directory string representation\nincludes `/build/` or not. This check is problematic if the directory\nof the project has a parent directory also named `build`. The change in\nthis commit checks to see if the path relative to the project directory\nhas any path parts equal to `build`.", "committedDate": "2020-01-16T18:43:53Z", "type": "commit"}, {"oid": "4dbdd127d5454f3a6b96c732163b1082803ba08c", "url": "https://github.com/elastic/elasticsearch/commit/4dbdd127d5454f3a6b96c732163b1082803ba08c", "message": "formatting", "committedDate": "2020-01-16T18:55:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY1MDk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/51121#discussion_r367650948", "bodyText": "Path is itself an Iterable so it might be easier to grok this if we replace it with for (Path segment : relativePath) { }.", "author": "mark-vieira", "createdAt": "2020-01-16T21:09:38Z", "path": "buildSrc/src/test/java/org/elasticsearch/gradle/BuildPluginIT.java", "diffHunk": "@@ -84,7 +85,16 @@ public void testInsecureIvyRepository() throws IOException {\n \n     private void runInsecureArtifactRepositoryTest(final String name, final String url, final List<String> lines) throws IOException {\n         final File projectDir = getProjectDir(\"elasticsearch.build\");\n-        FileUtils.copyDirectory(projectDir, tmpDir.getRoot(), pathname -> pathname.getPath().contains(\"/build/\") == false);\n+        final Path projectDirPath = projectDir.toPath();\n+        FileUtils.copyDirectory(projectDir, tmpDir.getRoot(), file -> {\n+            final Path relativePath = projectDirPath.relativize(file.toPath());\n+            for (int i = 0; i < relativePath.getNameCount(); i++) {", "originalCommit": "4dbdd127d5454f3a6b96c732163b1082803ba08c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxNjIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51121#discussion_r368016209", "bodyText": "Nice, that is a new one to me.", "author": "jaymode", "createdAt": "2020-01-17T16:12:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY1MDk0OA=="}], "type": "inlineReview", "revised_code": {"commit": "4c286a548126cdf7be374c4353e5337b9ecb7b51", "chunk": "diff --git a/buildSrc/src/test/java/org/elasticsearch/gradle/BuildPluginIT.java b/buildSrc/src/test/java/org/elasticsearch/gradle/BuildPluginIT.java\nindex b532935befe..57864326629 100644\n--- a/buildSrc/src/test/java/org/elasticsearch/gradle/BuildPluginIT.java\n+++ b/buildSrc/src/test/java/org/elasticsearch/gradle/BuildPluginIT.java\n\n@@ -88,8 +88,8 @@ public class BuildPluginIT extends GradleIntegrationTestCase {\n         final Path projectDirPath = projectDir.toPath();\n         FileUtils.copyDirectory(projectDir, tmpDir.getRoot(), file -> {\n             final Path relativePath = projectDirPath.relativize(file.toPath());\n-            for (int i = 0; i < relativePath.getNameCount(); i++) {\n-                if (relativePath.getName(i).toString().equals(\"build\")) {\n+            for (Path segment : relativePath) {\n+                if (segment.toString().equals(\"build\")) {\n                     return false;\n                 }\n             }\n"}}, {"oid": "a4ac52494b1630ba8ed4a04e2ab587f3a387f894", "url": "https://github.com/elastic/elasticsearch/commit/a4ac52494b1630ba8ed4a04e2ab587f3a387f894", "message": "Merge branch 'master' into build_plugin_it_file_filter", "committedDate": "2020-01-17T16:10:24Z", "type": "commit"}, {"oid": "4c286a548126cdf7be374c4353e5337b9ecb7b51", "url": "https://github.com/elastic/elasticsearch/commit/4c286a548126cdf7be374c4353e5337b9ecb7b51", "message": "path is iterable", "committedDate": "2020-01-17T16:12:04Z", "type": "commit"}]}