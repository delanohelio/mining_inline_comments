{"pr_number": 57802, "pr_title": "Default to zero replicas for searchable snapshots", "pr_createdAt": "2020-06-08T10:36:55Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57802", "timeline": [{"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "url": "https://github.com/elastic/elasticsearch/commit/40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "message": "Default to zero replicas for searchable snapshots\n\nToday a mounted searchable snapshot defaults to having the same replica\nconfiguration as the index that was snapshotted. This commit changes this\nbehaviour so that we default to zero replicas on these indices, but allow the\nuser to override this in the mount request.\n\nRelates #50999", "committedDate": "2020-06-08T10:35:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1NjE3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437256176", "bodyText": "Can we capture the number of replica that it randomly set and checks once the index is mounted that it corresponds?", "author": "tlrx", "createdAt": "2020-06-09T09:08:46Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -153,6 +154,9 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n                 new ByteSizeValue(randomLongBetween(10, 100_000))\n             );\n         }\n+        if (randomBoolean()) {", "originalCommit": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f07016925f559c689d2ee86141f4c83af77e7ba2", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\nindex e7d8b5e1e3f..790f97613c6 100644\n--- a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n+++ b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n\n@@ -154,8 +154,12 @@ public class SearchableSnapshotsIntegTests extends BaseSearchableSnapshotsIntegT\n                 new ByteSizeValue(randomLongBetween(10, 100_000))\n             );\n         }\n+        final int expectedReplicas;\n         if (randomBoolean()) {\n-            indexSettingsBuilder.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, between(0, internalCluster().numDataNodes() - 1));\n+            expectedReplicas = numberOfReplicas();\n+            indexSettingsBuilder.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, expectedReplicas);\n+        } else {\n+            expectedReplicas = 0;\n         }\n         final MountSearchableSnapshotRequest req = new MountSearchableSnapshotRequest(\n             restoredIndexName,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1NjYzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437256639", "bodyText": "The chunk_size can introduces many more writes and files, so maybe we can jut remove for this test?", "author": "tlrx", "createdAt": "2020-06-09T09:09:29Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -425,6 +430,156 @@ public void testMaxRestoreBytesPerSecIsUsed() throws Exception {\n         }\n     }\n \n+    public void testMountedSnapshotHasNoReplicasByDefault() throws Exception {\n+        final String fsRepoName = randomAlphaOfLength(10);\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String snapshotName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+\n+        final Path repo = randomRepoPath();\n+        assertAcked(\n+            client().admin()\n+                .cluster()\n+                .preparePutRepository(fsRepoName)\n+                .setType(\"fs\")\n+                .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))", "originalCommit": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f07016925f559c689d2ee86141f4c83af77e7ba2", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\nindex e7d8b5e1e3f..790f97613c6 100644\n--- a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n+++ b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n\n@@ -449,7 +454,7 @@ public class SearchableSnapshotsIntegTests extends BaseSearchableSnapshotsIntegT\n         final Settings.Builder originalIndexSettings = Settings.builder();\n         originalIndexSettings.put(INDEX_SOFT_DELETES_SETTING.getKey(), true);\n         if (randomBoolean()) {\n-            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, between(0, dataNodesCount - 1));\n+            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numberOfReplicas());\n         }\n         if (randomBoolean()) {\n             final int replicaLimit = between(0, dataNodesCount);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1Nzc3OA==", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437257778", "bodyText": "I think we can use minimumNumberOfReplicas / maximumNumberOfReplicas here?", "author": "tlrx", "createdAt": "2020-06-09T09:11:21Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -425,6 +430,156 @@ public void testMaxRestoreBytesPerSecIsUsed() throws Exception {\n         }\n     }\n \n+    public void testMountedSnapshotHasNoReplicasByDefault() throws Exception {\n+        final String fsRepoName = randomAlphaOfLength(10);\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String snapshotName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+\n+        final Path repo = randomRepoPath();\n+        assertAcked(\n+            client().admin()\n+                .cluster()\n+                .preparePutRepository(fsRepoName)\n+                .setType(\"fs\")\n+                .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))\n+        );\n+\n+        final int dataNodesCount = internalCluster().numDataNodes();\n+        final Settings.Builder originalIndexSettings = Settings.builder();\n+        originalIndexSettings.put(INDEX_SOFT_DELETES_SETTING.getKey(), true);\n+        if (randomBoolean()) {\n+            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, between(0, dataNodesCount - 1));", "originalCommit": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f07016925f559c689d2ee86141f4c83af77e7ba2", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\nindex e7d8b5e1e3f..790f97613c6 100644\n--- a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n+++ b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n\n@@ -449,7 +454,7 @@ public class SearchableSnapshotsIntegTests extends BaseSearchableSnapshotsIntegT\n         final Settings.Builder originalIndexSettings = Settings.builder();\n         originalIndexSettings.put(INDEX_SOFT_DELETES_SETTING.getKey(), true);\n         if (randomBoolean()) {\n-            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, between(0, dataNodesCount - 1));\n+            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, numberOfReplicas());\n         }\n         if (randomBoolean()) {\n             final int replicaLimit = between(0, dataNodesCount);\n"}}, {"oid": "35f257e4ae1f7bfbff3b7bf218b373e4e26c2913", "url": "https://github.com/elastic/elasticsearch/commit/35f257e4ae1f7bfbff3b7bf218b373e4e26c2913", "message": "Merge branch 'master' into 2020-06-08-searchable-snapshot-defaults-to-no-replicas", "committedDate": "2020-06-16T07:45:13Z", "type": "commit"}, {"oid": "f07016925f559c689d2ee86141f4c83af77e7ba2", "url": "https://github.com/elastic/elasticsearch/commit/f07016925f559c689d2ee86141f4c83af77e7ba2", "message": "Use numberOfReplicas()", "committedDate": "2020-06-16T07:52:09Z", "type": "commit"}, {"oid": "feb8604990318e64e25e7d0e3245d191dba59165", "url": "https://github.com/elastic/elasticsearch/commit/feb8604990318e64e25e7d0e3245d191dba59165", "message": "Use default chunk size", "committedDate": "2020-06-16T07:52:30Z", "type": "commit"}, {"oid": "ff7b049dd6377d990281414a8adcea9ad0d57954", "url": "https://github.com/elastic/elasticsearch/commit/ff7b049dd6377d990281414a8adcea9ad0d57954", "message": "Reformat", "committedDate": "2020-06-16T08:00:25Z", "type": "commit"}]}