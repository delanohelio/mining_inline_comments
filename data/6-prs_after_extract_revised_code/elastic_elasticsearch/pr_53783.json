{"pr_number": 53783, "pr_title": "Create an annotation when a model snapshot is stored", "pr_createdAt": "2020-03-19T08:36:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53783", "timeline": [{"oid": "0003ca40668408586a6dfef6689bae5c6303fe06", "url": "https://github.com/elastic/elasticsearch/commit/0003ca40668408586a6dfef6689bae5c6303fe06", "message": "Create annotation on model snapshot", "committedDate": "2020-03-19T08:42:31Z", "type": "forcePushed"}, {"oid": "445f405fc877c6f73b8e0688b00777b0e22f25c4", "url": "https://github.com/elastic/elasticsearch/commit/445f405fc877c6f73b8e0688b00777b0e22f25c4", "message": "Create an annotation when a model snapshot is stored", "committedDate": "2020-03-19T13:06:05Z", "type": "forcePushed"}, {"oid": "ed54e46dd7c74503ad20a7f4956f388d4b452ece", "url": "https://github.com/elastic/elasticsearch/commit/ed54e46dd7c74503ad20a7f4956f388d4b452ece", "message": "Create an annotation when a model snapshot is stored", "committedDate": "2020-03-19T15:50:00Z", "type": "forcePushed"}, {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "url": "https://github.com/elastic/elasticsearch/commit/ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "message": "Create an annotation when a model snapshot is stored", "committedDate": "2020-03-20T10:27:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r395667101", "bodyText": "This still leaves open the following bug (unsure how to fix it really).\n\nNode running the job is updated\nJob gets reallocated to a new node\nJob writes annotation for a model snapshot\nThe master node is still Old, consequently never crated the annotations index\nAnnotation persistence auto-created the index and now the UI fails to read from the index.\n\nIt seems to me that we need to verify if the index exists already and create it if necessary when we write annotations.", "author": "benwtrent", "createdAt": "2020-03-20T14:19:22Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlInitializationService.java", "diffHunk": "@@ -66,7 +66,7 @@ public void clusterChanged(ClusterChangedEvent event) {\n         // The atomic flag prevents multiple simultaneous attempts to create the\n         // index if there is a flurry of cluster state updates in quick succession\n         if (event.localNodeMaster() && isIndexCreationInProgress.compareAndSet(false, true)) {\n-            AnnotationIndex.createAnnotationsIndexIfNecessary(settings, client, event.state(), ActionListener.wrap(\n+            AnnotationIndex.createAnnotationsIndexIfNecessary(client, event.state(), ActionListener.wrap(", "originalCommit": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4OTgyNA==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399389824", "bodyText": "I think that scenario was a problem in 6.7 and 6.8 as there were 6.x indices that didn't have the annotations index - it probably explains a few bug reports we had when the annotations index was not available as expected.  But now any rolling upgrades must be starting from 6.8 at the earliest, so the old version will have the annotations index already.", "author": "droberts195", "createdAt": "2020-03-27T16:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQwMzg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399403873", "bodyText": "OK, my concern is that this will occur again whenever we update the mapping of the annotation index.\nWe can sort of 'boot' that for now I suppose. But we should definitely make sure that whomever updates the mapping of the annotations index knows that they need make this sort of change.", "author": "benwtrent", "createdAt": "2020-03-27T16:50:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAwMjE1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r400002159", "bodyText": "OK, my concern is that this will occur again whenever we update the mapping of the annotation index.\n\nMy PR does not update mappings of annotations index.\nThe new annotations I'm adding fit the existing mappings so there was no point in changing them.", "author": "przemekwitek", "createdAt": "2020-03-30T08:11:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "9290993a9cad16296ca4b974ed06399b91c78f3a", "url": "https://github.com/elastic/elasticsearch/commit/9290993a9cad16296ca4b974ed06399b91c78f3a", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T13:38:51Z", "type": "forcePushed"}, {"oid": "ef1f094b708d71143640b64b15e5d98cd16efbfb", "url": "https://github.com/elastic/elasticsearch/commit/ef1f094b708d71143640b64b15e5d98cd16efbfb", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T13:40:50Z", "type": "forcePushed"}, {"oid": "968b88e864548a82b8e2e4930b8bfca1185c2666", "url": "https://github.com/elastic/elasticsearch/commit/968b88e864548a82b8e2e4930b8bfca1185c2666", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T13:50:23Z", "type": "forcePushed"}, {"oid": "a3445e174f7c06bc457e534c094009422acdb7ae", "url": "https://github.com/elastic/elasticsearch/commit/a3445e174f7c06bc457e534c094009422acdb7ae", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T15:11:26Z", "type": "forcePushed"}, {"oid": "ea8be292f891820b3f4f655288690ebdc35a490e", "url": "https://github.com/elastic/elasticsearch/commit/ea8be292f891820b3f4f655288690ebdc35a490e", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T15:35:38Z", "type": "forcePushed"}, {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45", "url": "https://github.com/elastic/elasticsearch/commit/c9615ca698dda9f3933cb3a05d3211378afbcf45", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-27T15:36:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NjI4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399386287", "bodyText": "I think it could be confusing if the annotation spans a time range.  Is it possible to set both the start and end time to be the model snapshot's timestamp?  Or does it break the UI if the start and end timestamps are identical?", "author": "droberts195", "createdAt": "2020-03-27T16:23:54Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -310,6 +325,21 @@ void processResult(AutodetectResult result) {\n         }\n     }\n \n+    private Annotation createModelSnapshotAnnotation(ModelSnapshot modelSnapshot) {\n+        assert modelSnapshot != null;\n+        Date currentTime = new Date(clock.millis());\n+        return new Annotation(\n+            Messages.JOB_AUDIT_SNAPSHOT_STORED,\n+            currentTime,\n+            XPackUser.NAME,\n+            modelSnapshot.getTimestamp(),\n+            modelSnapshot.getLatestRecordTimeStamp(),", "originalCommit": "c9615ca698dda9f3933cb3a05d3211378afbcf45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NzUyMA==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399987520", "bodyText": "I think it could be confusing if the annotation spans a time range. Is it possible to set both the start and end time to be the model snapshot's timestamp?\n\nYes, done.\n\nOr does it break the UI if the start and end timestamps are identical?\n\nUI works fine, I've attached a screenshot which shows how does the annotation look like in single metric viewer.", "author": "przemekwitek", "createdAt": "2020-03-30T07:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NjI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "70fbc6e73994d1fdd911b60da31fe25024b01658", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\nindex f56ef11640c..49a687b264b 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n\n@@ -329,11 +329,11 @@ public class AutodetectResultProcessor {\n         assert modelSnapshot != null;\n         Date currentTime = new Date(clock.millis());\n         return new Annotation(\n-            Messages.JOB_AUDIT_SNAPSHOT_STORED,\n+            Messages.getMessage(Messages.JOB_AUDIT_SNAPSHOT_STORED, modelSnapshot.getSnapshotId()),\n             currentTime,\n             XPackUser.NAME,\n             modelSnapshot.getTimestamp(),\n-            modelSnapshot.getLatestRecordTimeStamp(),\n+            modelSnapshot.getTimestamp(),\n             jobId,\n             currentTime,\n             XPackUser.NAME,\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Nzc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399387799", "bodyText": "Can we also include the model snapshot ID, so that if somebody wants to revert to the snapshot they can get the piece of information they need in order to do this from the annotation?", "author": "droberts195", "createdAt": "2020-03-27T16:26:15Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -310,6 +325,21 @@ void processResult(AutodetectResult result) {\n         }\n     }\n \n+    private Annotation createModelSnapshotAnnotation(ModelSnapshot modelSnapshot) {\n+        assert modelSnapshot != null;\n+        Date currentTime = new Date(clock.millis());\n+        return new Annotation(\n+            Messages.JOB_AUDIT_SNAPSHOT_STORED,", "originalCommit": "c9615ca698dda9f3933cb3a05d3211378afbcf45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NzU3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399987576", "bodyText": "Done.", "author": "przemekwitek", "createdAt": "2020-03-30T07:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Nzc5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "70fbc6e73994d1fdd911b60da31fe25024b01658", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\nindex f56ef11640c..49a687b264b 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n\n@@ -329,11 +329,11 @@ public class AutodetectResultProcessor {\n         assert modelSnapshot != null;\n         Date currentTime = new Date(clock.millis());\n         return new Annotation(\n-            Messages.JOB_AUDIT_SNAPSHOT_STORED,\n+            Messages.getMessage(Messages.JOB_AUDIT_SNAPSHOT_STORED, modelSnapshot.getSnapshotId()),\n             currentTime,\n             XPackUser.NAME,\n             modelSnapshot.getTimestamp(),\n-            modelSnapshot.getLatestRecordTimeStamp(),\n+            modelSnapshot.getTimestamp(),\n             jobId,\n             currentTime,\n             XPackUser.NAME,\n"}}, {"oid": "8717e21ab767d3496ae3aa9926df96e86defb268", "url": "https://github.com/elastic/elasticsearch/commit/8717e21ab767d3496ae3aa9926df96e86defb268", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-30T06:40:06Z", "type": "forcePushed"}, {"oid": "fd85302089d47b63bd2522eda3e7d44753ca93d2", "url": "https://github.com/elastic/elasticsearch/commit/fd85302089d47b63bd2522eda3e7d44753ca93d2", "message": "Create an annotation when a model snapshot is stored", "committedDate": "2020-03-30T11:10:07Z", "type": "commit"}, {"oid": "26a0ac4bf41871b46235fc698948e586f5861ed2", "url": "https://github.com/elastic/elasticsearch/commit/26a0ac4bf41871b46235fc698948e586f5861ed2", "message": "Delete annotation when model snapshot or job is deleted", "committedDate": "2020-03-30T11:10:07Z", "type": "commit"}, {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658", "url": "https://github.com/elastic/elasticsearch/commit/70fbc6e73994d1fdd911b60da31fe25024b01658", "message": "Apply review comments", "committedDate": "2020-03-30T11:10:07Z", "type": "commit"}, {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658", "url": "https://github.com/elastic/elasticsearch/commit/70fbc6e73994d1fdd911b60da31fe25024b01658", "message": "Apply review comments", "committedDate": "2020-03-30T11:10:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MTU2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r418941565", "bodyText": "I wonder if these should have been modelSnapshot.getLatestResultTimeStamp()?\nSee #56076 (comment) for more details on this.", "author": "droberts195", "createdAt": "2020-05-02T10:25:21Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessorTests.java", "diffHunk": "@@ -367,6 +380,23 @@ public void testProcessResult_modelSnapshot() {\n         verify(persister).bulkPersisterBuilder(eq(JOB_ID), any());\n         verify(persister).persistModelSnapshot(eq(modelSnapshot), eq(WriteRequest.RefreshPolicy.IMMEDIATE), any());\n \n+        ArgumentCaptor<Annotation> annotationCaptor = ArgumentCaptor.forClass(Annotation.class);\n+        verify(annotationPersister).persistAnnotation(\n+            eq(ModelSnapshot.annotationDocumentId(modelSnapshot)), annotationCaptor.capture(), any());\n+        Annotation annotation = annotationCaptor.getValue();\n+        Annotation expectedAnnotation =\n+            new Annotation(\n+                \"Job model snapshot with id [a_snapshot_id] stored\",\n+                Date.from(CURRENT_TIME),\n+                XPackUser.NAME,\n+                modelSnapshot.getTimestamp(),\n+                modelSnapshot.getTimestamp(),", "originalCommit": "70fbc6e73994d1fdd911b60da31fe25024b01658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0MTk2NA==", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r419241964", "bodyText": "I've just raised #56093 to address that.", "author": "przemekwitek", "createdAt": "2020-05-04T06:57:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MTU2NQ=="}], "type": "inlineReview", "revised_code": null}]}