{"pr_number": 53243, "pr_title": "Save a little space on empty BitArrays", "pr_createdAt": "2020-03-06T20:31:12Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53243", "timeline": [{"oid": "c7dee699c17349bd9a2a713cac0641ae0acd4f2d", "url": "https://github.com/elastic/elasticsearch/commit/c7dee699c17349bd9a2a713cac0641ae0acd4f2d", "message": "Save a little space on empty BitArrays\n\nIt doesn't make a whole lot of sense for `BitArray#clear` to grow the\nunderlying storage array just to clear the bit. We *already* treat\nindices outside of the storage array as unset. This turns such\noperations into a noop.", "committedDate": "2020-03-06T20:28:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2NDg3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53243#discussion_r389164875", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                         * No need resize the array to just to clear bit because we'll\n          \n          \n            \n                         * No need to resize the array to just clear bit because we'll", "author": "jimczi", "createdAt": "2020-03-06T21:59:58Z", "path": "server/src/main/java/org/elasticsearch/common/util/BitArray.java", "diffHunk": "@@ -41,21 +45,31 @@ public BitArray(int initialSize, BigArrays bigArrays) {\n      * Set the {@code index}th bit.\n      */\n     public void set(int index) {\n-        fill(index, true);\n+        int wordNum = wordNum(index);\n+        bits = bigArrays.grow(bits, wordNum + 1);\n+        bits.set(wordNum, bits.get(wordNum) | bitmask(index));\n     }\n \n     /**\n      * Clear the {@code index}th bit.\n      */\n     public void clear(int index) {\n-        fill(index, false);\n+        int wordNum = wordNum(index);\n+        if (wordNum >= bits.size()) {\n+            /*\n+             * No need resize the array to just to clear bit because we'll", "originalCommit": "c7dee699c17349bd9a2a713cac0641ae0acd4f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4400cc078881e78a321de42250b2a0e92f14bff3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/util/BitArray.java b/server/src/main/java/org/elasticsearch/common/util/BitArray.java\nindex 0c11f755e0e..06844fd99ec 100644\n--- a/server/src/main/java/org/elasticsearch/common/util/BitArray.java\n+++ b/server/src/main/java/org/elasticsearch/common/util/BitArray.java\n\n@@ -57,7 +57,7 @@ public final class BitArray implements Releasable {\n         int wordNum = wordNum(index);\n         if (wordNum >= bits.size()) {\n             /*\n-             * No need resize the array to just to clear bit because we'll\n+             * No need to resize the array just to clear the bit because we'll\n              * initialize them to false when we grow the array anyway.\n              */\n             return;\n"}}, {"oid": "e032c0833ab04a99f89e84c98f47af70ec3163da", "url": "https://github.com/elastic/elasticsearch/commit/e032c0833ab04a99f89e84c98f47af70ec3163da", "message": "Merge branch 'master' into bit_array_no_grow_clear", "committedDate": "2020-03-09T17:28:25Z", "type": "commit"}, {"oid": "e032c0833ab04a99f89e84c98f47af70ec3163da", "url": "https://github.com/elastic/elasticsearch/commit/e032c0833ab04a99f89e84c98f47af70ec3163da", "message": "Merge branch 'master' into bit_array_no_grow_clear", "committedDate": "2020-03-09T17:28:25Z", "type": "forcePushed"}, {"oid": "4400cc078881e78a321de42250b2a0e92f14bff3", "url": "https://github.com/elastic/elasticsearch/commit/4400cc078881e78a321de42250b2a0e92f14bff3", "message": "Man, words are hard", "committedDate": "2020-03-09T17:29:33Z", "type": "commit"}]}