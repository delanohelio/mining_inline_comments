{"pr_number": 54816, "pr_title": "Deprecate disabling basic-license features", "pr_createdAt": "2020-04-06T15:01:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54816", "timeline": [{"oid": "eb9840cf53ccfb61f26e42fc92a65036d6d9bcb5", "url": "https://github.com/elastic/elasticsearch/commit/eb9840cf53ccfb61f26e42fc92a65036d6d9bcb5", "message": "Deprecate disabling basic-license features\n\nWe believe there's no longer a need to be able to disable basic-license\nfeatures completely using the \"xpack.*.enabled\" settings. If users don't\nwant to use those features, they simply don't need to use them. Having\nsuch features always available lets us build more complex features that\nassume basic-license features are present.\n\nThis commit deprecates settings of the form \"xpack.*.enabled\" for\nbasic-license features, excluding \"security\", which is a special case.", "committedDate": "2020-04-06T14:55:50Z", "type": "commit"}, {"oid": "af8c242729152a0e968bc3bde99d6c23db340aa8", "url": "https://github.com/elastic/elasticsearch/commit/af8c242729152a0e968bc3bde99d6c23db340aa8", "message": "Account for deprecation warnings in tests", "committedDate": "2020-04-06T14:59:00Z", "type": "commit"}, {"oid": "92e909ac88b3c6a6b917e7944bbd89eacf1a3d82", "url": "https://github.com/elastic/elasticsearch/commit/92e909ac88b3c6a6b917e7944bbd89eacf1a3d82", "message": "Remove deprecated settings from testclusters", "committedDate": "2020-04-06T18:39:05Z", "type": "commit"}, {"oid": "429b51af748253b8080d7b007a6d0c641ac4137b", "url": "https://github.com/elastic/elasticsearch/commit/429b51af748253b8080d7b007a6d0c641ac4137b", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-06T19:39:05Z", "type": "commit"}, {"oid": "14982eba33cd71fd2ad6f77fcd09e4878dc780e6", "url": "https://github.com/elastic/elasticsearch/commit/14982eba33cd71fd2ad6f77fcd09e4878dc780e6", "message": "Catch deprecation warning in enrich test", "committedDate": "2020-04-06T19:39:35Z", "type": "commit"}, {"oid": "a35b0dca7afeb16cf014eadb2abcfd65a54ecc97", "url": "https://github.com/elastic/elasticsearch/commit/a35b0dca7afeb16cf014eadb2abcfd65a54ecc97", "message": "Apply spotless formatting", "committedDate": "2020-04-06T19:45:04Z", "type": "commit"}, {"oid": "0231a20d10ef8d4cf8458426099b11b6d0923e0c", "url": "https://github.com/elastic/elasticsearch/commit/0231a20d10ef8d4cf8458426099b11b6d0923e0c", "message": "Move deprecation handling to, er, correct test", "committedDate": "2020-04-06T20:39:53Z", "type": "commit"}, {"oid": "eacfa0f16dcfcb093ccfc5d108bd73768908cc87", "url": "https://github.com/elastic/elasticsearch/commit/eacfa0f16dcfcb093ccfc5d108bd73768908cc87", "message": "Revert \"Remove deprecated settings from testclusters\"\n\nThis reverts commit 92e909ac88b3c6a6b917e7944bbd89eacf1a3d82.", "committedDate": "2020-04-06T21:08:16Z", "type": "commit"}, {"oid": "a35e26de01c0703c67e3153430770cd3bb34a62b", "url": "https://github.com/elastic/elasticsearch/commit/a35e26de01c0703c67e3153430770cd3bb34a62b", "message": "Handle setting deprecation warnings in tests", "committedDate": "2020-04-07T14:35:31Z", "type": "commit"}, {"oid": "655a8556bc5d97967cb2b854dae70219877dd11b", "url": "https://github.com/elastic/elasticsearch/commit/655a8556bc5d97967cb2b854dae70219877dd11b", "message": "Handle deprecation warnings in Watcher tests", "committedDate": "2020-04-07T17:35:39Z", "type": "commit"}, {"oid": "82e37c0e01b13b24a0d1f9ecf24ba87533b7ba00", "url": "https://github.com/elastic/elasticsearch/commit/82e37c0e01b13b24a0d1f9ecf24ba87533b7ba00", "message": "Apply spotless formatting", "committedDate": "2020-04-07T17:40:32Z", "type": "commit"}, {"oid": "47589da7a8f4b104a2b7f7a1c9838f8397b48e2a", "url": "https://github.com/elastic/elasticsearch/commit/47589da7a8f4b104a2b7f7a1c9838f8397b48e2a", "message": "Remove unused imports", "committedDate": "2020-04-07T18:05:21Z", "type": "commit"}, {"oid": "484430778e208efe2e028fa2bfa215e92441e230", "url": "https://github.com/elastic/elasticsearch/commit/484430778e208efe2e028fa2bfa215e92441e230", "message": "Handle deprecations in CCR test", "committedDate": "2020-04-07T19:02:28Z", "type": "commit"}, {"oid": "94a800a8f267124b5486357dcc003a3a3c452e23", "url": "https://github.com/elastic/elasticsearch/commit/94a800a8f267124b5486357dcc003a3a3c452e23", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-07T19:02:47Z", "type": "commit"}, {"oid": "892163983a1d12485de2089af7f74ff2bc9a1b41", "url": "https://github.com/elastic/elasticsearch/commit/892163983a1d12485de2089af7f74ff2bc9a1b41", "message": "Enable ILM in watcher tests\n\nThe Watcher REST integration tests had been running with ILM disabled.\nWith that setting's deprecation, it seems that some index creation and\ndeletion operations will throw deprecation warnings. These deprecation\nwarnings don't seem to have to do with the purposes of the tests, so we\nwill just change the settings in build.gradle in order to avoid having\nto catch them all.", "committedDate": "2020-04-07T19:42:17Z", "type": "commit"}, {"oid": "c69cc2bee526efc0275fa19cac643d04d3ef5353", "url": "https://github.com/elastic/elasticsearch/commit/c69cc2bee526efc0275fa19cac643d04d3ef5353", "message": "Restore default warning handling in watcher test suite", "committedDate": "2020-04-07T19:58:17Z", "type": "commit"}, {"oid": "4c9a427829ae0bdc2b063bb768a0892b8af9872f", "url": "https://github.com/elastic/elasticsearch/commit/4c9a427829ae0bdc2b063bb768a0892b8af9872f", "message": "Remove redundant deprecated settings from ilm tests", "committedDate": "2020-04-07T19:58:55Z", "type": "commit"}, {"oid": "ea394db13eb62a10e03896a5f52a0479e696fc85", "url": "https://github.com/elastic/elasticsearch/commit/ea394db13eb62a10e03896a5f52a0479e696fc85", "message": "Remove disable monitoring for ccr tests", "committedDate": "2020-04-07T20:15:21Z", "type": "commit"}, {"oid": "fb817135d31a8b0223fb06f96c01bd40d07c1a47", "url": "https://github.com/elastic/elasticsearch/commit/fb817135d31a8b0223fb06f96c01bd40d07c1a47", "message": "Remove redundant ilm setting from tests", "committedDate": "2020-04-07T21:21:21Z", "type": "commit"}, {"oid": "6f55b39a39881425a3cfe1d7b4b46a9c30de9b8c", "url": "https://github.com/elastic/elasticsearch/commit/6f55b39a39881425a3cfe1d7b4b46a9c30de9b8c", "message": "Handle more deprecations", "committedDate": "2020-04-07T21:39:25Z", "type": "commit"}, {"oid": "a1cd7ff546f6a2fc6352622958e5a1146d9aecf6", "url": "https://github.com/elastic/elasticsearch/commit/a1cd7ff546f6a2fc6352622958e5a1146d9aecf6", "message": "Back out change to ESRestTestCase", "committedDate": "2020-04-07T21:57:46Z", "type": "commit"}, {"oid": "e79de96dc9f4ae8371c26034c2a969b13993c69f", "url": "https://github.com/elastic/elasticsearch/commit/e79de96dc9f4ae8371c26034c2a969b13993c69f", "message": "Remove more qa disablings of ILM", "committedDate": "2020-04-08T11:19:07Z", "type": "commit"}, {"oid": "2c1e792c5a14e3c552254f5ba2800d284d92f3dc", "url": "https://github.com/elastic/elasticsearch/commit/2c1e792c5a14e3c552254f5ba2800d284d92f3dc", "message": "Handle more deprecation warnings", "committedDate": "2020-04-08T14:05:10Z", "type": "commit"}, {"oid": "a9e23fd4dafdf12d7235b728e218267d5a183084", "url": "https://github.com/elastic/elasticsearch/commit/a9e23fd4dafdf12d7235b728e218267d5a183084", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-08T14:49:28Z", "type": "commit"}, {"oid": "f9d29f247defca8fbdbc6076bb5809d51c79f1cc", "url": "https://github.com/elastic/elasticsearch/commit/f9d29f247defca8fbdbc6076bb5809d51c79f1cc", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-08T15:20:00Z", "type": "commit"}, {"oid": "538679f98c880414b74c4b5a262afc1ea499f83a", "url": "https://github.com/elastic/elasticsearch/commit/538679f98c880414b74c4b5a262afc1ea499f83a", "message": "Remove unused imports", "committedDate": "2020-04-08T15:26:56Z", "type": "commit"}, {"oid": "dab5153ee80a69f71cb02d0ab651a912b26accc1", "url": "https://github.com/elastic/elasticsearch/commit/dab5153ee80a69f71cb02d0ab651a912b26accc1", "message": "More deprecations", "committedDate": "2020-04-08T19:37:07Z", "type": "commit"}, {"oid": "af2afd1e21a6e2a5c7ae72d9a741811e7ca5fe4d", "url": "https://github.com/elastic/elasticsearch/commit/af2afd1e21a6e2a5c7ae72d9a741811e7ca5fe4d", "message": "Remove unused imports", "committedDate": "2020-04-08T20:09:06Z", "type": "commit"}, {"oid": "5b669336a0764d8350faac7ee8ce8f859161bab2", "url": "https://github.com/elastic/elasticsearch/commit/5b669336a0764d8350faac7ee8ce8f859161bab2", "message": "Enable ILM for security tests", "committedDate": "2020-04-08T20:57:07Z", "type": "commit"}, {"oid": "8bee5e19cc7d7d79a3b7d89a8daf62f21ab13db6", "url": "https://github.com/elastic/elasticsearch/commit/8bee5e19cc7d7d79a3b7d89a8daf62f21ab13db6", "message": "Remove disabling sql in testclusters", "committedDate": "2020-04-08T21:10:42Z", "type": "commit"}, {"oid": "e0adf586001eea2bedb5fbde1b2597ff5dc5ffec", "url": "https://github.com/elastic/elasticsearch/commit/e0adf586001eea2bedb5fbde1b2597ff5dc5ffec", "message": "Enable ILM for qa tests", "committedDate": "2020-04-08T22:53:47Z", "type": "commit"}, {"oid": "337693e21307a57a835a5bc19035424be65afcdd", "url": "https://github.com/elastic/elasticsearch/commit/337693e21307a57a835a5bc19035424be65afcdd", "message": "Enable ILM for qa tests part 2", "committedDate": "2020-04-09T00:21:10Z", "type": "commit"}, {"oid": "412c8d3fa46e926b44e189ab15a77e6f6aa846dc", "url": "https://github.com/elastic/elasticsearch/commit/412c8d3fa46e926b44e189ab15a77e6f6aa846dc", "message": "Enable ILM for qa tests part 3", "committedDate": "2020-04-09T06:08:34Z", "type": "commit"}, {"oid": "84ae5ca3f0be1e6c8533b287a108195c4b0b1ab8", "url": "https://github.com/elastic/elasticsearch/commit/84ae5ca3f0be1e6c8533b287a108195c4b0b1ab8", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-09T13:58:42Z", "type": "commit"}, {"oid": "2cf9bd776c734f0683e8769a970c349789c18421", "url": "https://github.com/elastic/elasticsearch/commit/2cf9bd776c734f0683e8769a970c349789c18421", "message": "Add ILM named-writeables for reading cluster state", "committedDate": "2020-04-09T17:14:07Z", "type": "commit"}, {"oid": "d42cd955130b0b1719102bea5be35c90d02c312c", "url": "https://github.com/elastic/elasticsearch/commit/d42cd955130b0b1719102bea5be35c90d02c312c", "message": "Enable Monitoring in qa test", "committedDate": "2020-04-09T17:14:24Z", "type": "commit"}, {"oid": "3acc861d3c376481786e0529031251f6a4acdc6c", "url": "https://github.com/elastic/elasticsearch/commit/3acc861d3c376481786e0529031251f6a4acdc6c", "message": "Remove unused imports", "committedDate": "2020-04-09T18:07:35Z", "type": "commit"}, {"oid": "1f1945ef0cfc743d24f83e9b5c70184f8d9561d8", "url": "https://github.com/elastic/elasticsearch/commit/1f1945ef0cfc743d24f83e9b5c70184f8d9561d8", "message": "Update docs for deprecated settings", "committedDate": "2020-04-09T21:32:10Z", "type": "commit"}, {"oid": "16b0eed7834bbc9e3effb0f05347605def8c9952", "url": "https://github.com/elastic/elasticsearch/commit/16b0eed7834bbc9e3effb0f05347605def8c9952", "message": "Adjust docs in line with PR feedback", "committedDate": "2020-04-13T14:54:01Z", "type": "commit"}, {"oid": "d57f8b657623d49a91074c12cf1c18f01a8d00d6", "url": "https://github.com/elastic/elasticsearch/commit/d57f8b657623d49a91074c12cf1c18f01a8d00d6", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-13T14:54:33Z", "type": "commit"}, {"oid": "63b616906825b8c355a055b050e3c4b2fa56d185", "url": "https://github.com/elastic/elasticsearch/commit/63b616906825b8c355a055b050e3c4b2fa56d185", "message": "Add undocument settings to migration list", "committedDate": "2020-04-16T19:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3Nzk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54816#discussion_r409777952", "bodyText": "Why is the enrich warning predicated on monitoring being allowed by the license? Shouldn't it be based on the enrich enabled setting being present?", "author": "rjernst", "createdAt": "2020-04-16T18:52:47Z", "path": "x-pack/plugin/enrich/src/test/java/org/elasticsearch/xpack/monitoring/collector/enrich/EnrichStatsCollectorTests.java", "diffHunk": "@@ -87,12 +89,16 @@ public void testShouldCollectReturnsFalseIfEnrichIsDisabled() {\n         if (isElectedMaster) {\n             verify(licenseState).isMonitoringAllowed();\n         }\n+        if (isElectedMaster && isMonitoringAllowed) {\n+            assertSettingDeprecationsAndWarnings(new Setting<?>[] { XPackSettings.ENRICH_ENABLED_SETTING });", "originalCommit": "d57f8b657623d49a91074c12cf1c18f01a8d00d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NzU5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54816#discussion_r409857593", "bodyText": "I'm looking forward to getting rid of this. In this test, xpack.enrich.enabled is always set to false. We get a deprecation warning in the case that this setting is checked during the course of the test. However, the EnrichStatsCollector#shouldCollect returns without before checking the enrich setting if the node isn't master or if monitoring is turned off.\nIn my opinion, this test is a little bit too randomized, making eight different possible cases appear to be a single test. But fortunately I'll be able to get rid of the deprecation warning in a later PR.", "author": "williamrandolph", "createdAt": "2020-04-16T21:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3Nzk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NzcyMg==", "url": "https://github.com/elastic/elasticsearch/pull/54816#discussion_r409857722", "bodyText": "I will add a comment for clarity.", "author": "williamrandolph", "createdAt": "2020-04-16T21:25:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3Nzk1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f7982ed2c383609849fa7487eb8757ed5ef857c5", "chunk": "diff --git a/x-pack/plugin/enrich/src/test/java/org/elasticsearch/xpack/monitoring/collector/enrich/EnrichStatsCollectorTests.java b/x-pack/plugin/enrich/src/test/java/org/elasticsearch/xpack/monitoring/collector/enrich/EnrichStatsCollectorTests.java\nindex 82636635b92..3e7e9935f9f 100644\n--- a/x-pack/plugin/enrich/src/test/java/org/elasticsearch/xpack/monitoring/collector/enrich/EnrichStatsCollectorTests.java\n+++ b/x-pack/plugin/enrich/src/test/java/org/elasticsearch/xpack/monitoring/collector/enrich/EnrichStatsCollectorTests.java\n\n@@ -90,6 +90,8 @@ public class EnrichStatsCollectorTests extends BaseCollectorTestCase {\n             verify(licenseState).isMonitoringAllowed();\n         }\n         if (isElectedMaster && isMonitoringAllowed) {\n+            // The enrich setting is only checked if the node is master and monitoring is allowed,\n+            // so in other cases we won't have a deprecation warning.\n             assertSettingDeprecationsAndWarnings(new Setting<?>[] { XPackSettings.ENRICH_ENABLED_SETTING });\n         }\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc3ODk2OA==", "url": "https://github.com/elastic/elasticsearch/pull/54816#discussion_r409778968", "bodyText": "nit: this seems more \"isExplicitlySet\"  (as you have in another test here) than \"enabled\", since it might actually be disabled", "author": "rjernst", "createdAt": "2020-04-16T18:54:29Z", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/SqlInfoTransportActionTests.java", "diffHunk": "@@ -66,16 +68,22 @@ public void testAvailable() {\n     public void testEnabled() {\n         boolean enabled = randomBoolean();\n         Settings.Builder settings = Settings.builder();\n+        boolean isExplicitlyEnabled = false;", "originalCommit": "d57f8b657623d49a91074c12cf1c18f01a8d00d6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f7982ed2c383609849fa7487eb8757ed5ef857c5", "chunk": "diff --git a/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/SqlInfoTransportActionTests.java b/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/SqlInfoTransportActionTests.java\nindex 068bff51e56..2419dfb188a 100644\n--- a/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/SqlInfoTransportActionTests.java\n+++ b/x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/SqlInfoTransportActionTests.java\n\n@@ -68,20 +68,20 @@ public class SqlInfoTransportActionTests extends ESTestCase {\n     public void testEnabled() {\n         boolean enabled = randomBoolean();\n         Settings.Builder settings = Settings.builder();\n-        boolean isExplicitlyEnabled = false;\n+        boolean isExplicitlySet = false;\n         if (enabled) {\n             if (randomBoolean()) {\n                 settings.put(\"xpack.sql.enabled\", enabled);\n-                isExplicitlyEnabled = true;\n+                isExplicitlySet = true;\n             }\n         } else {\n             settings.put(\"xpack.sql.enabled\", enabled);\n-            isExplicitlyEnabled = true;\n+            isExplicitlySet = true;\n         }\n         SqlInfoTransportAction featureSet = new SqlInfoTransportAction(\n             mock(TransportService.class), mock(ActionFilters.class), settings.build(), licenseState);\n         assertThat(featureSet.enabled(), is(enabled));\n-        if (isExplicitlyEnabled) {\n+        if (isExplicitlySet) {\n             assertSettingDeprecationsAndWarnings(new Setting<?>[] { XPackSettings.SQL_ENABLED } );\n         }\n     }\n"}}, {"oid": "4c12a92646a8d85008b70a0fbe52a7792aae20f0", "url": "https://github.com/elastic/elasticsearch/commit/4c12a92646a8d85008b70a0fbe52a7792aae20f0", "message": "Merge branch 'master' into deprecate-disabling-basic-features", "committedDate": "2020-04-16T21:01:57Z", "type": "commit"}, {"oid": "ce516bc4859ea39dc45e87234ca10f2d430e48f6", "url": "https://github.com/elastic/elasticsearch/commit/ce516bc4859ea39dc45e87234ca10f2d430e48f6", "message": "Remove monitoring disablement from plugin tests", "committedDate": "2020-04-16T21:07:21Z", "type": "commit"}, {"oid": "d64b45140d7c9889d989c1fe33279d9cf60147b0", "url": "https://github.com/elastic/elasticsearch/commit/d64b45140d7c9889d989c1fe33279d9cf60147b0", "message": "Remove ilm disablement from plugin tests", "committedDate": "2020-04-16T21:11:07Z", "type": "commit"}, {"oid": "f7982ed2c383609849fa7487eb8757ed5ef857c5", "url": "https://github.com/elastic/elasticsearch/commit/f7982ed2c383609849fa7487eb8757ed5ef857c5", "message": "Address PR nits", "committedDate": "2020-04-16T21:26:23Z", "type": "commit"}]}