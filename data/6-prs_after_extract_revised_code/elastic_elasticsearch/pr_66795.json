{"pr_number": 66795, "pr_title": "Bust the request cache when the mapping changes (backport of #66295)", "pr_createdAt": "2020-12-23T17:22:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/66795", "timeline": [{"oid": "a4e10a228a8963e91ce83885079dc1a56e93fbfb", "url": "https://github.com/elastic/elasticsearch/commit/a4e10a228a8963e91ce83885079dc1a56e93fbfb", "message": "Bust the request cache when the mapping changes (backport of #66295)\n\nThis makes sure that we only serve a hit from the request cache if it\nwas build using the same mapping and that the same mapping is used for\nthe entire \"query phase\" of the search.\n\nCloses #62033", "committedDate": "2020-12-23T15:16:53Z", "type": "commit"}, {"oid": "30a14587a447ce4ed915cdad5c7f0c04c7161d6b", "url": "https://github.com/elastic/elasticsearch/commit/30a14587a447ce4ed915cdad5c7f0c04c7161d6b", "message": "Fixup type query", "committedDate": "2020-12-23T16:09:24Z", "type": "commit"}, {"oid": "a89ad3c901fec1ca29f445b4828b309c32a2c548", "url": "https://github.com/elastic/elasticsearch/commit/a89ad3c901fec1ca29f445b4828b309c32a2c548", "message": "Add test", "committedDate": "2020-12-23T16:34:29Z", "type": "commit"}, {"oid": "cf788d34c558904146ec60178d5632b8e749a485", "url": "https://github.com/elastic/elasticsearch/commit/cf788d34c558904146ec60178d5632b8e749a485", "message": "Fixup", "committedDate": "2020-12-23T17:23:10Z", "type": "commit"}, {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c", "url": "https://github.com/elastic/elasticsearch/commit/f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c", "message": "Typo", "committedDate": "2020-12-23T17:24:27Z", "type": "commit"}, {"oid": "cc596c56ebb140ea79227630c1fcc32822476b94", "url": "https://github.com/elastic/elasticsearch/commit/cc596c56ebb140ea79227630c1fcc32822476b94", "message": "Merge branch '7.x' into cache_bust_take_two_7_x", "committedDate": "2020-12-23T18:26:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548128299", "bodyText": "If there is a default mapping, this call mapperService.documentMapper(type) returns a non-null mapper for the _default_ type. So this refactor may change the type query behavior slightly. This seems acceptable since default mappings were deprecated in 6.0 and the type query isn't completely clear on this behavior, but it felt worth pointing out.", "author": "jtibshirani", "createdAt": "2020-12-23T18:41:13Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "originalCommit": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDE1OA==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548130158", "bodyText": "I think it only returns something for _default_ if there isn't another mapping. Which, I think, only happens when the index is in the process of being made. Though, I can fiddle with it a bit to see if a totally empty mapping gets it.", "author": "nik9000", "createdAt": "2020-12-23T18:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MjIzMw==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548142233", "bodyText": "I played around a bit - I don't think you can have documents in the index and not have a DocumentMapper. So I think this is safe.", "author": "nik9000", "createdAt": "2020-12-23T18:58:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MjM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548142363", "bodyText": "And if it isn't then that change is quite small.", "author": "nik9000", "createdAt": "2020-12-23T18:58:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7a886b0449c2556eb20a43f741f0bd6d719cb33a", "url": "https://github.com/elastic/elasticsearch/commit/7a886b0449c2556eb20a43f741f0bd6d719cb33a", "message": "Oh sneaky test, you relied on no snapshot", "committedDate": "2020-12-23T18:53:31Z", "type": "commit"}, {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b", "url": "https://github.com/elastic/elasticsearch/commit/80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b", "message": "Update skip", "committedDate": "2020-12-23T19:18:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548167140", "bodyText": "this threw me off: how can typeExists be replaced with an equality check?", "author": "javanna", "createdAt": "2020-12-23T19:31:10Z", "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "diffHunk": "@@ -129,7 +129,7 @@ public String getWriteableName() {\n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n         deprecationLogger.deprecate(\"type_query\", TYPES_DEPRECATION_MESSAGE);\n-        if (context.typeExists(type)) {\n+        if (context.getType().equals(type)) {", "originalCommit": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3MDA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548170074", "bodyText": "Weird, right? There is only one type in an index in 7.x and either the type you are searching is it or it ain't. There was some complexity around getting the _default_ mapper, but you could only get it if the there isn't a type. Check out MapperService#documentMapper(String type) for the trick. I only changed this so we'd use the snapshot.", "author": "nik9000", "createdAt": "2020-12-23T19:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3MDk3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548170972", "bodyText": "And, to top it off, there can't not be a type and be documents in the index. So all that funny stuff around _default_ doesn't do anything in this case.", "author": "nik9000", "createdAt": "2020-12-23T19:36:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "18f97a415bcd51b89eed780e928b337ac9eea67e", "url": "https://github.com/elastic/elasticsearch/commit/18f97a415bcd51b89eed780e928b337ac9eea67e", "message": "Drop query with type", "committedDate": "2020-12-23T19:53:15Z", "type": "commit"}]}