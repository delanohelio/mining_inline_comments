{"pr_number": 65989, "pr_title": "Correctly determine defaults of settings which depend on other settings", "pr_createdAt": "2020-12-07T23:56:27Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65989", "timeline": [{"oid": "beafc566a85571ba6d1ea199d7cbc5f883df09c8", "url": "https://github.com/elastic/elasticsearch/commit/beafc566a85571ba6d1ea199d7cbc5f883df09c8", "message": "Correctly determine defaults of settings which depend on other settings\n\nThis commit adjusts the behavior when calculating the diff between two\n`AbstractScopedSettings` objects, so that the default values of settings\nwhose default values depend on the values of other settings are\ncorrectly calculated. Previously, when calculating the diff, the default\nvalue of a depended setting would be calculated based on the default\nvalue of the setting(s) it depends on, rather than the current value of\nthose settings.", "committedDate": "2020-12-07T23:43:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkzNDExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/65989#discussion_r537934115", "bodyText": "I think this might read better if the outer \"doesn't exist in source\" stays the same and then have two inner conditions for \"if (exists in defaults) X else Y\"", "author": "rjernst", "createdAt": "2020-12-08T00:17:22Z", "path": "server/src/main/java/org/elasticsearch/common/settings/Setting.java", "diffHunk": "@@ -486,7 +486,11 @@ private T get(Settings settings, boolean validate) {\n      * @param defaultSettings the default settings object to diff against\n      */\n     public void diff(Settings.Builder builder, Settings source, Settings defaultSettings) {\n-        if (exists(source) == false) {\n+        if (exists(source) == false && exists(defaultSettings) == false) {", "originalCommit": "beafc566a85571ba6d1ea199d7cbc5f883df09c8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0c6578d898a357ca2f4f6969f100359389bdb8c", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/common/settings/Setting.java b/server/src/main/java/org/elasticsearch/common/settings/Setting.java\nindex dd372c48fe7..d71f53e0f24 100644\n--- a/server/src/main/java/org/elasticsearch/common/settings/Setting.java\n+++ b/server/src/main/java/org/elasticsearch/common/settings/Setting.java\n\n@@ -486,12 +486,15 @@ public class Setting<T> implements ToXContentObject {\n      * @param defaultSettings the default settings object to diff against\n      */\n     public void diff(Settings.Builder builder, Settings source, Settings defaultSettings) {\n-        if (exists(source) == false && exists(defaultSettings) == false) {\n-            // If the setting is in neither source nor default, get the value from source as it may depend on the value of other settings\n-            builder.put(getKey(), getRaw(source));\n-        } else if (exists(source) == false && exists(defaultSettings)) {\n-            // If the setting is only in the defaults, use the value from the defaults\n-            builder.put(getKey(), getRaw(defaultSettings));\n+        if (exists(source) == false) {\n+            if (exists(defaultSettings) == false) {\n+                // If the setting is in neither `source` nor `default`, get the value\n+                // from `source` as it may depend on the value of other settings\n+                builder.put(getKey(), getRaw(source));\n+            } else {\n+                // If the setting is only in the defaults, use the value from the defaults\n+                builder.put(getKey(), getRaw(defaultSettings));\n+            }\n         }\n     }\n \n"}}, {"oid": "d0c6578d898a357ca2f4f6969f100359389bdb8c", "url": "https://github.com/elastic/elasticsearch/commit/d0c6578d898a357ca2f4f6969f100359389bdb8c", "message": "Rearrage `if` per review feedback", "committedDate": "2020-12-08T17:50:37Z", "type": "commit"}, {"oid": "30145f453e11a1077054d758c9834e02b18b90bb", "url": "https://github.com/elastic/elasticsearch/commit/30145f453e11a1077054d758c9834e02b18b90bb", "message": "Merge branch 'master' into fix-diff-of-dependent-default-settings", "committedDate": "2020-12-08T17:50:49Z", "type": "commit"}, {"oid": "a03aa53ac99d87326e9a10885ae95b6128ba020a", "url": "https://github.com/elastic/elasticsearch/commit/a03aa53ac99d87326e9a10885ae95b6128ba020a", "message": "Rearrage `if` per review feedback, actually this time", "committedDate": "2020-12-08T17:56:31Z", "type": "commit"}]}