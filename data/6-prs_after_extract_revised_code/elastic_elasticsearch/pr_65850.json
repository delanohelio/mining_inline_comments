{"pr_number": 65850, "pr_title": "Cancel proxy requests when the proxy channel closes", "pr_createdAt": "2020-12-03T19:38:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65850", "timeline": [{"oid": "fc203bfb4ee7987a649a04fa0de7eddf71ca79f0", "url": "https://github.com/elastic/elasticsearch/commit/fc203bfb4ee7987a649a04fa0de7eddf71ca79f0", "message": "Cancel proxy requests when the proxy channel closes", "committedDate": "2020-12-03T19:34:30Z", "type": "commit"}, {"oid": "5535bc301fc088a256d7f22bf0bc1ff9ea19df18", "url": "https://github.com/elastic/elasticsearch/commit/5535bc301fc088a256d7f22bf0bc1ff9ea19df18", "message": "oops", "committedDate": "2020-12-03T21:06:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzODc5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/65850#discussion_r536138791", "bodyText": "Rather than requiring every registration to record correctly whether the proxied task is cancellable or not, could we call wrapped.createTask() and decide whether to create a CancellableTask or just a regular Task based on whether the wrapped request's task was cancellable or not? At least we should assert that they match, or else we'll forget to update the argument to the proxy registration in future if we ever add cancellability  to another task.", "author": "DaveCTurner", "createdAt": "2020-12-04T14:29:28Z", "path": "server/src/main/java/org/elasticsearch/transport/TransportActionProxy.java", "diffHunk": "@@ -117,27 +122,54 @@ public void writeTo(StreamOutput out) throws IOException {\n         }\n     }\n \n+    private static class CancellableProxyRequest<T extends TransportRequest> extends ProxyRequest<T> {\n+        CancellableProxyRequest(StreamInput in, Writeable.Reader<T> reader) throws IOException {\n+            super(in, reader);\n+        }\n+\n+        @Override\n+        public Task createTask(long id, String type, String action, TaskId parentTaskId, Map<String, String> headers) {\n+            return new CancellableTask(id, type, action, \"\", parentTaskId, headers) {", "originalCommit": "5535bc301fc088a256d7f22bf0bc1ff9ea19df18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzA2NTc5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/65850#discussion_r537065792", "bodyText": "+1, I added an assertion in 0a52a5b", "author": "dnhatn", "createdAt": "2020-12-06T15:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzODc5MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "7def6448a4965f132e777a1f6e6060dd55c2b64f", "url": "https://github.com/elastic/elasticsearch/commit/7def6448a4965f132e777a1f6e6060dd55c2b64f", "message": "Merge branch 'master' into cancellable-proxy-task", "committedDate": "2020-12-05T20:23:18Z", "type": "commit"}, {"oid": "0a52a5b9f695bdee2648cb197b3aa439586a6981", "url": "https://github.com/elastic/elasticsearch/commit/0a52a5b9f695bdee2648cb197b3aa439586a6981", "message": "add assertion", "committedDate": "2020-12-05T20:32:33Z", "type": "commit"}, {"oid": "94490b4dc31eb8dcd518d3f862f2390c82602e4c", "url": "https://github.com/elastic/elasticsearch/commit/94490b4dc31eb8dcd518d3f862f2390c82602e4c", "message": "fix test", "committedDate": "2020-12-05T22:40:33Z", "type": "commit"}]}