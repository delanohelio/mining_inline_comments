{"pr_number": 51740, "pr_title": "[ML] Remove index.unassigned.node_left.delayed_timeout setting from M\u2026", "pr_createdAt": "2020-01-31T13:22:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51740", "timeline": [{"oid": "07103f539da497da1839dd79652f93aface1741c", "url": "https://github.com/elastic/elasticsearch/commit/07103f539da497da1839dd79652f93aface1741c", "message": "[ML] Remove index.unassigned.node_left.delayed_timeout setting from ML templates\n\nThis setting was introduced with the purpose of reducing the time took by\ntests that shut nodes down. Tests like `MlDistributedFailureIT` and\n`NetworkDisruptionIT`. However, it is unfortunate to have to set the value\nto an explicit value in production. In addition, and most important, the dynamically\nchoosing the value for this setting makes it impossible to adopt static index template configs\nthat we register via `IndexTemplateRegistry`, which we need to use in order to start\nregistering ILM policies for the ML indices.\n\nThis commit removes this setting from our templates. I run the tests a few times and could\nnot see execution time differing significantly.", "committedDate": "2020-01-31T13:18:03Z", "type": "commit"}, {"oid": "e5034044539d3961076b7614a9d3664e72d847a4", "url": "https://github.com/elastic/elasticsearch/commit/e5034044539d3961076b7614a9d3664e72d847a4", "message": "Set delayed timeout to relevant tests", "committedDate": "2020-01-31T14:17:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNzIyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51740#discussion_r373517225", "bodyText": "Since both classes where this has been added extend BaseMlIntegTestCase it's probably worth putting this code in a utility method in that base class.\nI also wonder if NetworkDisruptionIT might need it, depending on which random form of network disruption is chosen.  NetworkDisruptionIT.testJobRelocation() contains ensureGreen() calls.  It could be that for certain random number sequences these require a shard to reassign to attain green status.", "author": "droberts195", "createdAt": "2020-01-31T14:49:25Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java", "diffHunk": "@@ -68,6 +70,11 @@ public void testFailOverBasics() throws Exception {\n         client().execute(OpenJobAction.INSTANCE, openJobRequest).actionGet();\n         awaitJobOpenedAndAssigned(job.getId(), null);\n \n+        // always default delayed allocation to 0 to make sure we have tests are not delayed\n+        client().admin().indices().updateSettings(new UpdateSettingsRequest(\".ml-*\")\n+            .settings(Settings.builder().put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING.getKey(), 0).build()))\n+            .actionGet();", "originalCommit": "e5034044539d3961076b7614a9d3664e72d847a4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e200e22a050d655ab1811f38cb1a65a9ae98dab2", "chunk": "diff --git a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java\nindex 0299bbeb819..6fe455c386a 100644\n--- a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java\n+++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java\n\n@@ -70,10 +70,7 @@ public class BasicDistributedJobsIT extends BaseMlIntegTestCase {\n         client().execute(OpenJobAction.INSTANCE, openJobRequest).actionGet();\n         awaitJobOpenedAndAssigned(job.getId(), null);\n \n-        // always default delayed allocation to 0 to make sure we have tests are not delayed\n-        client().admin().indices().updateSettings(new UpdateSettingsRequest(\".ml-*\")\n-            .settings(Settings.builder().put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING.getKey(), 0).build()))\n-            .actionGet();\n+        setMlIndicesDelayedNodeLeftTimeoutToZero();\n \n         ensureGreen(); // replicas must be assigned, otherwise we could lose a whole index\n         internalCluster().stopRandomDataNode();\n"}}, {"oid": "e200e22a050d655ab1811f38cb1a65a9ae98dab2", "url": "https://github.com/elastic/elasticsearch/commit/e200e22a050d655ab1811f38cb1a65a9ae98dab2", "message": "Extract setting into common method and use in NetworkDisruptionIT too", "committedDate": "2020-01-31T15:15:39Z", "type": "commit"}, {"oid": "8829f11b804073596f6c89891278d42d9d08ddf6", "url": "https://github.com/elastic/elasticsearch/commit/8829f11b804073596f6c89891278d42d9d08ddf6", "message": "Remove unused imports", "committedDate": "2020-01-31T15:39:23Z", "type": "commit"}]}