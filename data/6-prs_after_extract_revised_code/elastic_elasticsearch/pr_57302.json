{"pr_number": 57302, "pr_title": "Ensure Joni warning are logged at debug", "pr_createdAt": "2020-05-28T17:15:54Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57302", "timeline": [{"oid": "2f64eb74e14b74119798a661c300f63edaa350e9", "url": "https://github.com/elastic/elasticsearch/commit/2f64eb74e14b74119798a661c300f63edaa350e9", "message": "Ensure Joni warning are logged at debug\n\nWhen Joni, the regex engine that powers grok emits a warning it does so by default to System.err. System.err logs are all bucketed together in the server log at WARN level.  When Joni emits a warning, it can be extremely verbose, logging a message for each execution again that pattern. For ingest node that means for every document that is run that Grok filter. Fortunately, Joni provides a call back hook to push these warnings to a custom location.\n\nThis commit implements Joni's callback hook to push the Joni warning to the Elasticsearch server logger (logger.org.elasticsearch.grok.Grok)\nat debug level. Generally these warning indicate a possible issue with the regular expression. Since Grok is an abstraction on top of the regex, these warning may not provide much value outside of a troubleshooting scenario.\n\nAdditionally, the documentation is updated with instructions for how to set the logger to debug level.", "committedDate": "2020-05-28T17:06:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5ODMwNg==", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r431998306", "bodyText": "^^ this line is only substantive change here. (it implements the callback so that it does not default to Std.err)", "author": "jakelandis", "createdAt": "2020-05-28T17:18:41Z", "path": "libs/grok/src/main/java/org/elasticsearch/grok/Grok.java", "diffHunk": "@@ -101,7 +106,8 @@ private Grok(Map<String, String> patternBank, String grokPattern, boolean namedC\n \n         String expression = toRegex(grokPattern);\n         byte[] expressionBytes = expression.getBytes(StandardCharsets.UTF_8);\n-        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE);\n+        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE,\n+            message -> logger.log(Level.DEBUG, message));", "originalCommit": "2f64eb74e14b74119798a661c300f63edaa350e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA1NzQ0NA==", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r432057444", "bodyText": "Thanks Jake! I'm happy that this is an easy change.", "author": "martijnvg", "createdAt": "2020-05-28T19:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5ODMwNg=="}], "type": "inlineReview", "revised_code": {"commit": "fa0493a9e29ba7a57086afec68ffe7396039612f", "chunk": "diff --git a/libs/grok/src/main/java/org/elasticsearch/grok/Grok.java b/libs/grok/src/main/java/org/elasticsearch/grok/Grok.java\nindex e050c772c2d..2792b40df5c 100644\n--- a/libs/grok/src/main/java/org/elasticsearch/grok/Grok.java\n+++ b/libs/grok/src/main/java/org/elasticsearch/grok/Grok.java\n\n@@ -106,8 +101,7 @@ public final class Grok {\n \n         String expression = toRegex(grokPattern);\n         byte[] expressionBytes = expression.getBytes(StandardCharsets.UTF_8);\n-        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE,\n-            message -> logger.log(Level.DEBUG, message));\n+        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE);\n     }\n \n     /**\n"}}, {"oid": "fa0493a9e29ba7a57086afec68ffe7396039612f", "url": "https://github.com/elastic/elasticsearch/commit/fa0493a9e29ba7a57086afec68ffe7396039612f", "message": "Revert \"Ensure Joni warning are logged at debug\"\n\nThis reverts commit 2f64eb74e14b74119798a661c300f63edaa350e9.", "committedDate": "2020-05-31T21:14:53Z", "type": "commit"}, {"oid": "4068dc49eefab95af52d786daef229c7cbad2808", "url": "https://github.com/elastic/elasticsearch/commit/4068dc49eefab95af52d786daef229c7cbad2808", "message": "use callback instead of direct log4j dependency", "committedDate": "2020-05-31T21:58:09Z", "type": "commit"}, {"oid": "56437624d2016ae1b19a0491049e076eb4f1d7e9", "url": "https://github.com/elastic/elasticsearch/commit/56437624d2016ae1b19a0491049e076eb4f1d7e9", "message": "add on construction warning", "committedDate": "2020-05-31T22:14:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5MDIxNw==", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r432990217", "bodyText": "this is kinda weird, but hopefully the comment explains why. This allows Joni warnings to be emitted at WARN level on PUT of the pipeline, but DEBUG for normal running.\nIf we put a WARN for normal running we can flood the log (and what this PR seeks to address)", "author": "jakelandis", "createdAt": "2020-05-31T22:18:16Z", "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/GrokProcessor.java", "diffHunk": "@@ -48,9 +51,12 @@\n         super(tag);\n         this.matchField = matchField;\n         this.matchPatterns = matchPatterns;\n-        this.grok = new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog);\n+        this.grok = new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog, logger::debug);\n         this.traceMatch = traceMatch;\n         this.ignoreMissing = ignoreMissing;\n+        // Joni warnings are only emitted on an attempt to match, and the warning emitted for every call to match which is too verbose\n+        // so here we emit a warning (if there is one) to the logfile at warn level on construction / processor creation.\n+        new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog, logger::warn).match(\"___nomatch___\");", "originalCommit": "56437624d2016ae1b19a0491049e076eb4f1d7e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "eea02311bbca37638816f234f4c38c6d88d7ab02", "url": "https://github.com/elastic/elasticsearch/commit/eea02311bbca37638816f234f4c38c6d88d7ab02", "message": "fix import", "committedDate": "2020-05-31T22:19:04Z", "type": "commit"}, {"oid": "2b2f269f49fe8e8c0d0f83392517f462543cb65b", "url": "https://github.com/elastic/elasticsearch/commit/2b2f269f49fe8e8c0d0f83392517f462543cb65b", "message": "remove compile dependency on log4jApi and remove license", "committedDate": "2020-06-08T17:32:28Z", "type": "commit"}, {"oid": "9e800e42cdd2659e85fad145562c9a098b2bf3fe", "url": "https://github.com/elastic/elasticsearch/commit/9e800e42cdd2659e85fad145562c9a098b2bf3fe", "message": "Merge branch 'master' into route_joni_warnings_to_debug_log", "committedDate": "2020-06-08T17:51:17Z", "type": "commit"}]}