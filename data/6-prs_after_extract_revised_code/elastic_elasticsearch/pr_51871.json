{"pr_number": 51871, "pr_title": "Percentiles aggregation validation checks for range", "pr_createdAt": "2020-02-04T15:53:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51871", "timeline": [{"oid": "8e18e662ecf265873ff5d6cc156b87b23dfbffad", "url": "https://github.com/elastic/elasticsearch/commit/8e18e662ecf265873ff5d6cc156b87b23dfbffad", "message": "disallow duplicate percentile definitions and out of range", "committedDate": "2020-02-05T20:13:39Z", "type": "commit"}, {"oid": "442fb226130c1f6f1eecc11611de2d1dfa6e237f", "url": "https://github.com/elastic/elasticsearch/commit/442fb226130c1f6f1eecc11611de2d1dfa6e237f", "message": "adapt tests to avoid duplicates for percentiles", "committedDate": "2020-02-05T20:13:39Z", "type": "commit"}, {"oid": "442fb226130c1f6f1eecc11611de2d1dfa6e237f", "url": "https://github.com/elastic/elasticsearch/commit/442fb226130c1f6f1eecc11611de2d1dfa6e237f", "message": "adapt tests to avoid duplicates for percentiles", "committedDate": "2020-02-05T20:13:39Z", "type": "forcePushed"}, {"oid": "5f0cc8fc513e43b3b8401532033097f52dd290e9", "url": "https://github.com/elastic/elasticsearch/commit/5f0cc8fc513e43b3b8401532033097f52dd290e9", "message": "fix one more wrong percentile test", "committedDate": "2020-02-06T08:15:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2MzcyOA==", "url": "https://github.com/elastic/elasticsearch/pull/51871#discussion_r375963728", "bodyText": "while uniquePercentails.size() < length?", "author": "nik9000", "createdAt": "2020-02-06T17:05:02Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/HDRPercentilesIT.java", "diffHunk": "@@ -67,21 +69,21 @@\n \n     private static double[] randomPercentiles() {\n         final int length = randomIntBetween(1, 20);\n-        final double[] percentiles = new double[length];\n-        for (int i = 0; i < percentiles.length; ++i) {\n+        final Set<Double> uniquedPercentiles = new HashSet<>();\n+        for (int i = 0; i < length; ++i) {", "originalCommit": "5f0cc8fc513e43b3b8401532033097f52dd290e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3726ea8dfc1c0cecb9522207c0fa9334fcd38b2b", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HDRPercentilesIT.java b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HDRPercentilesIT.java\nindex 5f49bbf783f..94f5ae0fb60 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HDRPercentilesIT.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HDRPercentilesIT.java\n\n@@ -70,7 +70,7 @@ public class HDRPercentilesIT extends AbstractNumericTestCase {\n     private static double[] randomPercentiles() {\n         final int length = randomIntBetween(1, 20);\n         final Set<Double> uniquedPercentiles = new HashSet<>();\n-        for (int i = 0; i < length; ++i) {\n+        while (uniquedPercentiles.size() < length) {\n             switch (randomInt(20)) {\n             case 0:\n                 uniquedPercentiles.add(0.0);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk2NDQyNg==", "url": "https://github.com/elastic/elasticsearch/pull/51871#discussion_r375964426", "bodyText": "I think this should have an extra space after if and before (.", "author": "nik9000", "createdAt": "2020-02-06T17:06:12Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregationBuilder.java", "diffHunk": "@@ -181,6 +181,18 @@ public PercentilesAggregationBuilder percentiles(double... percents) {\n         }\n         double[] sortedPercents = Arrays.copyOf(percents, percents.length);\n         Arrays.sort(sortedPercents);\n+        double previousPercent = -1.0;\n+        for (double percent : sortedPercents) {\n+            if (percent < 0.0 || percent > 100.0) {\n+                throw new IllegalArgumentException(\"percent must be in [0,100], got [\" + percent + \"]: [\" + name + \"]\");\n+            }\n+\n+            if(percent == previousPercent) {", "originalCommit": "5f0cc8fc513e43b3b8401532033097f52dd290e9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "43dcf62a4fc4a64217d5351a5cecba250c07a06d", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregationBuilder.java b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregationBuilder.java\nindex e65d9e9d5e4..29f36f117ff 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregationBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentilesAggregationBuilder.java\n\n@@ -181,16 +181,10 @@ public class PercentilesAggregationBuilder extends LeafOnly<ValuesSource, Percen\n         }\n         double[] sortedPercents = Arrays.copyOf(percents, percents.length);\n         Arrays.sort(sortedPercents);\n-        double previousPercent = -1.0;\n         for (double percent : sortedPercents) {\n             if (percent < 0.0 || percent > 100.0) {\n                 throw new IllegalArgumentException(\"percent must be in [0,100], got [\" + percent + \"]: [\" + name + \"]\");\n             }\n-\n-            if(percent == previousPercent) {\n-                throw new IllegalArgumentException(\"percent [\" + percent + \"] has been specified twice: [\" + name + \"]\");\n-            }\n-            previousPercent = percent;\n         }\n \n         this.percents = sortedPercents;\n"}}, {"oid": "43dcf62a4fc4a64217d5351a5cecba250c07a06d", "url": "https://github.com/elastic/elasticsearch/commit/43dcf62a4fc4a64217d5351a5cecba250c07a06d", "message": "remove the duplication check, tbd for a separate 8.0 only PR", "committedDate": "2020-02-07T09:49:12Z", "type": "commit"}, {"oid": "3726ea8dfc1c0cecb9522207c0fa9334fcd38b2b", "url": "https://github.com/elastic/elasticsearch/commit/3726ea8dfc1c0cecb9522207c0fa9334fcd38b2b", "message": "apply review suggestion", "committedDate": "2020-02-07T09:49:34Z", "type": "commit"}, {"oid": "b3fe9a1dfe879c654fd4e7f926b64235c0a4486b", "url": "https://github.com/elastic/elasticsearch/commit/b3fe9a1dfe879c654fd4e7f926b64235c0a4486b", "message": "remove unit test for dups", "committedDate": "2020-02-07T09:53:12Z", "type": "commit"}]}