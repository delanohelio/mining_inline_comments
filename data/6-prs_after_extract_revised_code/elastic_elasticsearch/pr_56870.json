{"pr_number": 56870, "pr_title": "Optimize complicated if-else in routing table.", "pr_createdAt": "2020-05-17T14:22:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56870", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426277099", "bodyText": "Maybe just remove this condition as it's obviously always false and keep the rest the same (maybe also inline delta like we have in the \"add\" case). Seems to me that makes the logic easiest to digest if we want to change it?", "author": "original-brownbear", "createdAt": "2020-05-17T16:02:57Z", "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "originalCommit": "6bafe90483ccabf268b56b4556a7c1e2de66d86e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNzg1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426337853", "bodyText": "@original-brownbear Thanks for checking, I think we could pre-compute the delta and seperate the add and remove operation. Please help to review the update.", "author": "howardhuanghua", "createdAt": "2020-05-18T02:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ4Mjg2OA==", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426482868", "bodyText": "I'm with @original-brownbear here, using Math.abs(expr) and then branching on the sign of expr looks weird to me. Let's avoid the use of Math#abs (and therefore the super-broad @SuppressForbidden annotation).", "author": "DaveCTurner", "createdAt": "2020-05-18T09:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ4ODQ2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426488461", "bodyText": "OK. I removed abs method. Thank you @DaveCTurner .", "author": "howardhuanghua", "createdAt": "2020-05-18T09:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "6389d4bb3274a2d3db6226fa46941e451efa594e", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java b/server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java\nindex 62d0c620306..35b19a9247e 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java\n\n@@ -474,11 +472,13 @@ public class RoutingTable implements Iterable<IndexRoutingTable>, Diffable<Routi\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n-                for (int i = 0; i < delta; i++) {\n-                    if (currentNumberOfReplicas < numberOfReplicas) {\n+                if (currentNumberOfReplicas < numberOfReplicas) {\n+                    // now, add \"empty\" ones\n+                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n                         builder.addReplica();\n-                    } else {\n+                    }\n+                } else if (currentNumberOfReplicas > numberOfReplicas) {\n+                    for (int i = 0; i < (currentNumberOfReplicas - numberOfReplicas); i++) {\n                         builder.removeReplica();\n                     }\n                 }\n"}}, {"oid": "6389d4bb3274a2d3db6226fa46941e451efa594e", "url": "https://github.com/elastic/elasticsearch/commit/6389d4bb3274a2d3db6226fa46941e451efa594e", "message": "remove abs", "committedDate": "2020-05-18T09:21:51Z", "type": "forcePushed"}, {"oid": "b4ed1bf9903bc673f23e22a96d4fd5aaf7b0764c", "url": "https://github.com/elastic/elasticsearch/commit/b4ed1bf9903bc673f23e22a96d4fd5aaf7b0764c", "message": "optimize complicated if-else in routing table", "committedDate": "2020-05-18T11:52:18Z", "type": "commit"}, {"oid": "efd2f21a7574487be3a0d703ded3b8d2661f6032", "url": "https://github.com/elastic/elasticsearch/commit/efd2f21a7574487be3a0d703ded3b8d2661f6032", "message": "precompute delta and distinguish add and remove", "committedDate": "2020-05-18T11:52:18Z", "type": "commit"}, {"oid": "2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "url": "https://github.com/elastic/elasticsearch/commit/2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "message": "remove abs", "committedDate": "2020-05-18T11:52:19Z", "type": "commit"}, {"oid": "2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "url": "https://github.com/elastic/elasticsearch/commit/2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "message": "remove abs", "committedDate": "2020-05-18T11:52:19Z", "type": "forcePushed"}]}