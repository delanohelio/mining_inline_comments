{"pr_number": 63455, "pr_title": "Fix test timeout for health on master failover", "pr_createdAt": "2020-10-08T08:01:01Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63455", "timeline": [{"oid": "1ef9d35bf2a19ba4409cd62fa02ecd303257a823", "url": "https://github.com/elastic/elasticsearch/commit/1ef9d35bf2a19ba4409cd62fa02ecd303257a823", "message": "Fix test timeout for health on master failover\n\ntestHealthOnMasterFailover could timeout on some of the health requests\nin the case where an index is added, since the recovery leads to\nextended test run time.\n\nCloses #62690", "committedDate": "2020-10-08T07:57:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzcxMjk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63455#discussion_r507712943", "bodyText": "Just for my understanding: We took more than 1 minute here to get 20 (empty) shards to recover? Isn't that indicative of some other issue?", "author": "original-brownbear", "createdAt": "2020-10-19T12:40:15Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java", "diffHunk": "@@ -308,21 +309,27 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n         }\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/62690\")\n     public void testHealthOnMasterFailover() throws Exception {\n         final String node = internalCluster().startDataOnlyNode();\n-        boolean withIndex = randomBoolean();\n+        final boolean withIndex = randomBoolean();\n         if (withIndex) {\n             // Create index with many shards to provoke the health request to wait (for green) while master is being shut down.\n             // Notice that this is set to 0 after the test completed starting a number of health requests and master restarts.\n             // This ensures that the cluster is yellow when the health request is made, making the health request wait on the observer,\n             // triggering a call to observer.onClusterServiceClose when master is shutdown.\n-            createIndex(\"test\", Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, randomIntBetween(0, 10)).build());\n+            createIndex(\"test\",\n+                Settings.builder()\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, randomIntBetween(0, 10))\n+                    // avoid full recoveries of index, just wait for replica to reappear\n+                .put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING.getKey(), \"5m\")\n+                .build());\n+            ensureGreen(\"test\");\n         }\n         final List<ActionFuture<ClusterHealthResponse>> responseFutures = new ArrayList<>();\n         // Run a few health requests concurrent to master fail-overs against a data-node to make sure master failover is handled\n         // without exceptions\n-        for (int i = 0; i < 20; ++i) {\n+        final int iterations = withIndex ? 10 : 20;\n+        for (int i = 0; i < iterations; ++i) {\n             responseFutures.add(client(node).admin().cluster().prepareHealth().setWaitForEvents(Priority.LANGUID)\n                 .setWaitForGreenStatus().setMasterNodeTimeout(TimeValue.timeValueMinutes(1)).execute());", "originalCommit": "1ef9d35bf2a19ba4409cd62fa02ecd303257a823", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc4ODQ3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63455#discussion_r507788471", "bodyText": "That time could include the 10 master restarts as well as some recovery time. The health call may not be able to respond until the settings are updated below.", "author": "henningandersen", "createdAt": "2020-10-19T14:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzcxMjk0Mw=="}], "type": "inlineReview", "revised_code": {"commit": "3233a2c1cce07478a2acf5eb21d3e02c90321cd8", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java b/server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java\nindex 9c518c0f144..c4df379b372 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java\n\n@@ -323,7 +323,6 @@ public class ClusterHealthIT extends ESIntegTestCase {\n                     // avoid full recoveries of index, just wait for replica to reappear\n                 .put(UnassignedInfo.INDEX_DELAYED_NODE_LEFT_TIMEOUT_SETTING.getKey(), \"5m\")\n                 .build());\n-            ensureGreen(\"test\");\n         }\n         final List<ActionFuture<ClusterHealthResponse>> responseFutures = new ArrayList<>();\n         // Run a few health requests concurrent to master fail-overs against a data-node to make sure master failover is handled\n"}}, {"oid": "573c20b3ad0190606442d942d7b4a62f3db2aee1", "url": "https://github.com/elastic/elasticsearch/commit/573c20b3ad0190606442d942d7b4a62f3db2aee1", "message": "Merge remote-tracking branch 'origin/master' into fix_health_on_master_failover_timeout", "committedDate": "2020-10-19T12:52:14Z", "type": "commit"}, {"oid": "3233a2c1cce07478a2acf5eb21d3e02c90321cd8", "url": "https://github.com/elastic/elasticsearch/commit/3233a2c1cce07478a2acf5eb21d3e02c90321cd8", "message": "Remove ensureGreen.", "committedDate": "2020-10-19T14:32:27Z", "type": "commit"}]}