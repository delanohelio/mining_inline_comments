{"pr_number": 52851, "pr_title": "Prevent SigTerms/SigText from running on fields they do not support", "pr_createdAt": "2020-02-26T21:48:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52851", "timeline": [{"oid": "6324d42e2fc3f81334431a5aefb7115ef86b6bb0", "url": "https://github.com/elastic/elasticsearch/commit/6324d42e2fc3f81334431a5aefb7115ef86b6bb0", "message": "Prevent SigTerms/SigText from running on fields they do not support\n\nSigTerms cannot run on fields that are not searchable, and SigText\ncannot run on fields that do not have analyzers.  Both of these\nsituations fail today with an esoteric exception, so this just formalizes\nthe constraint by throwing an IllegalArgumentException up front.\n\nIn practice, the only affected field seems to be the `binary` field,\nwhich is neither searchable or has a default analyzer (e.g. even numeric\nand keyword fields have a default analyzer despite not being tokenized)\n\nAdds supported-type tests, and makes some changes to the test itself\nto allow testing sigtext (indexing _source).\n\nAlso a few tweaks to the test to avoid bad randomization (negative\nnumbers, etc).", "committedDate": "2020-02-26T21:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNTg0MA==", "url": "https://github.com/elastic/elasticsearch/pull/52851#discussion_r384805840", "bodyText": "s/index analyzer/analyzer/? Most folks don't declare a different index and search analyzers so they'll probably be confused about this message.", "author": "nik9000", "createdAt": "2020-02-26T22:27:03Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -83,6 +83,10 @@ public SignificantTextAggregatorFactory(String name,\n         // Note that if the field is unmapped (its field type is null), we don't fail,\n         // and just use the given field name as a placeholder.\n         this.fieldType = queryShardContext.fieldMapper(fieldName);\n+        if (fieldType != null && fieldType.indexAnalyzer() == null) {\n+            throw new IllegalArgumentException(\"Field [\" + fieldType.name() + \"] has no index analyzer, but SignificantText \" +", "originalCommit": "6324d42e2fc3f81334431a5aefb7115ef86b6bb0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3MzI0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52851#discussion_r385173246", "bodyText": "Yeah that's fair.  Technically it's the index analyzer that is fetched explicitly, but I could see that causing confusion.  Will change!", "author": "polyfractal", "createdAt": "2020-02-27T15:05:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNTg0MA=="}], "type": "inlineReview", "revised_code": {"commit": "173c56462dd157a93f1026ea8a1d614eb7bb8588", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTextAggregatorFactory.java b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTextAggregatorFactory.java\nindex 299d5515bb6..950bde07690 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTextAggregatorFactory.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/SignificantTextAggregatorFactory.java\n\n@@ -84,7 +84,7 @@ public class SignificantTextAggregatorFactory extends AggregatorFactory\n         // and just use the given field name as a placeholder.\n         this.fieldType = queryShardContext.fieldMapper(fieldName);\n         if (fieldType != null && fieldType.indexAnalyzer() == null) {\n-            throw new IllegalArgumentException(\"Field [\" + fieldType.name() + \"] has no index analyzer, but SignificantText \" +\n+            throw new IllegalArgumentException(\"Field [\" + fieldType.name() + \"] has no analyzer, but SignificantText \" +\n                 \"requires an analyzed field\");\n         }\n         this.indexedFieldName = fieldType != null ? fieldType.name() : fieldName;\n"}}, {"oid": "173c56462dd157a93f1026ea8a1d614eb7bb8588", "url": "https://github.com/elastic/elasticsearch/commit/173c56462dd157a93f1026ea8a1d614eb7bb8588", "message": "Tweak exception text", "committedDate": "2020-03-02T20:06:08Z", "type": "commit"}, {"oid": "a59d9c74d16d94ae79eb913e41617a3f864ce227", "url": "https://github.com/elastic/elasticsearch/commit/a59d9c74d16d94ae79eb913e41617a3f864ce227", "message": "Merge remote-tracking branch 'origin/master' into fix_sigterm_sigtext_supported_types", "committedDate": "2020-03-02T20:41:27Z", "type": "commit"}]}