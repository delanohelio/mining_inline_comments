{"pr_number": 64382, "pr_title": "Return partial failures if search was cancelled.", "pr_createdAt": "2020-10-29T21:47:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64382", "timeline": [{"oid": "6c2f4b8da14c3682f99bfb02e3401a8e9a4b7e18", "url": "https://github.com/elastic/elasticsearch/commit/6c2f4b8da14c3682f99bfb02e3401a8e9a4b7e18", "message": "Return partial failures if search was cancelled.", "committedDate": "2020-10-29T21:32:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyODMyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64382#discussion_r514928323", "bodyText": "Drive by comment:\nI wonder if we need to check if (shardFailures.size() == total) and if so, still report all shards failed? At least it will be a little bit confusing to get the partial shards failure exception if you only search one shard.", "author": "henningandersen", "createdAt": "2020-10-30T08:07:39Z", "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -313,12 +313,15 @@ public boolean isForceExecution() {\n         });\n     }\n \n+\n     @Override\n     public final void executeNextPhase(SearchPhase currentPhase, SearchPhase nextPhase) {\n         /* This is the main search phase transition where we move to the next phase. At this point we check if there is\n          * at least one successful operation left and if so we move to the next phase. If not we immediately fail the\n-         * search phase as \"all shards failed\"*/\n-        if (successfulOps.get() == 0) { // we have 0 successful results that means we shortcut stuff and return a failure\n+         * search phase as \"all shards failed\". Note that if we cancelled the rest of the search request because of a\n+         * partial failure, we don't count this as if \"all shards failed\".\n+         */\n+        if (successfulOps.get() == 0 && requestCancelled.get() == false) {", "originalCommit": "6c2f4b8da14c3682f99bfb02e3401a8e9a4b7e18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3Mjc4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64382#discussion_r515272785", "bodyText": "This is a good point, that's a more robust check! I had assumed we wouldn't set requestCancelled unless there were multiple shards.", "author": "jtibshirani", "createdAt": "2020-10-30T17:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyODMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM3ODAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64382#discussion_r515378039", "bodyText": "I pushed an update to only check shardSearchFailures.length == getNumShards(). But I think this only makes sense with #64337 -- I'll pull that in once it's merged and check if there are still test failures.", "author": "jtibshirani", "createdAt": "2020-10-30T20:53:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyODMyMw=="}], "type": "inlineReview", "revised_code": {"commit": "09c7df1642da14f4f35f16206b4e1c4ee3af6fa0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java b/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\nindex ebad34cacd8..989efcc9f53 100644\n--- a/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java\n\n@@ -316,13 +316,13 @@ abstract class AbstractSearchAsyncAction<Result extends SearchPhaseResult> exten\n \n     @Override\n     public final void executeNextPhase(SearchPhase currentPhase, SearchPhase nextPhase) {\n-        /* This is the main search phase transition where we move to the next phase. At this point we check if there is\n-         * at least one successful operation left and if so we move to the next phase. If not we immediately fail the\n-         * search phase as \"all shards failed\". Note that if we cancelled the rest of the search request because of a\n-         * partial failure, we don't count this as if \"all shards failed\".\n+        /* This is the main search phase transition where we move to the next phase. If all shards\n+         * failed or if there was a failure and partial results are not allowed, then we immediately\n+         * fail. Otherwise we continue to the next phase.\n          */\n-        if (successfulOps.get() == 0 && requestCancelled.get() == false) {\n-            final ShardOperationFailedException[] shardSearchFailures = ExceptionsHelper.groupBy(buildShardFailures());\n+        ShardOperationFailedException[] shardSearchFailures = buildShardFailures();\n+        if (shardSearchFailures.length == getNumShards()) {\n+            shardSearchFailures = ExceptionsHelper.groupBy(shardSearchFailures);\n             Throwable cause = shardSearchFailures.length == 0 ? null :\n                 ElasticsearchException.guessRootCauses(shardSearchFailures[0].getCause())[0];\n             logger.debug(() -> new ParameterizedMessage(\"All shards failed for phase: [{}]\", getName()), cause);\n"}}, {"oid": "09c7df1642da14f4f35f16206b4e1c4ee3af6fa0", "url": "https://github.com/elastic/elasticsearch/commit/09c7df1642da14f4f35f16206b4e1c4ee3af6fa0", "message": "Improve the check for 'all shards failed'.", "committedDate": "2020-10-30T19:25:20Z", "type": "commit"}, {"oid": "fd6d8be0a7853669715f0d2a974a26ac2de75e25", "url": "https://github.com/elastic/elasticsearch/commit/fd6d8be0a7853669715f0d2a974a26ac2de75e25", "message": "Merge remote-tracking branch 'upstream/master' into search-failures", "committedDate": "2020-10-30T19:41:58Z", "type": "commit"}, {"oid": "2b76b7ac5c481b5633b2cbe11d67f4a3c26874c1", "url": "https://github.com/elastic/elasticsearch/commit/2b76b7ac5c481b5633b2cbe11d67f4a3c26874c1", "message": "Merge remote-tracking branch 'upstream/master' into search-failures", "committedDate": "2020-11-24T18:48:08Z", "type": "commit"}, {"oid": "1a341aded189988dad9f11a7f91404e2b576d5fd", "url": "https://github.com/elastic/elasticsearch/commit/1a341aded189988dad9f11a7f91404e2b576d5fd", "message": "Remove test skip.", "committedDate": "2020-11-24T19:32:49Z", "type": "commit"}]}