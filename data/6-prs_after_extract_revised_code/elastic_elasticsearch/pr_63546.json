{"pr_number": 63546, "pr_title": "Add snapshot shard size based test in DiskThresholdDeciderTests", "pr_createdAt": "2020-10-12T11:07:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63546", "timeline": [{"oid": "c41abac7b100495b8254bbf5f64e134653e7dfe9", "url": "https://github.com/elastic/elasticsearch/commit/c41abac7b100495b8254bbf5f64e134653e7dfe9", "message": "Add snapshot shard size based test in DiskThresholdDeciderTests", "committedDate": "2020-10-12T10:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5ODcxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63546#discussion_r505698711", "bodyText": "NIT: no functional impact here, but the first argument is the snapshot name and the second the UUID :)\nI always just use final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_name\", UUIDs.randomBase64UUID(random())));", "author": "original-brownbear", "createdAt": "2020-10-15T16:59:32Z", "path": "server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java", "diffHunk": "@@ -1130,6 +1144,110 @@ public void testWatermarksEnabledForSingleDataNode() {\n                 \" actual free: [20.0%]\"));\n     }\n \n+    public void testDiskThresholdWithSnapshotShardSizes() {\n+        final long shardSizeInBytes = randomBoolean() ? 10L : 50L;\n+        logger.info(\"--> using shard size [{}]\", shardSizeInBytes);\n+\n+        final Settings diskSettings = Settings.builder()\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_DISK_THRESHOLD_ENABLED_SETTING.getKey(), true)\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_LOW_DISK_WATERMARK_SETTING.getKey(), \"90%\")\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_HIGH_DISK_WATERMARK_SETTING.getKey(), \"95%\")\n+            .build();\n+\n+        final ImmutableOpenMap.Builder<String, DiskUsage> usagesBuilder = ImmutableOpenMap.builder();\n+        usagesBuilder.put(\"node1\", new DiskUsage(\"node1\", \"n1\", \"/dev/null\", 100, 21));  // 79% used\n+        usagesBuilder.put(\"node2\", new DiskUsage(\"node2\", \"n2\", \"/dev/null\", 100, 1)); // 99% used\n+        final ImmutableOpenMap<String, DiskUsage> usages = usagesBuilder.build();\n+        final ClusterInfoService clusterInfoService = () -> new DevNullClusterInfo(usages, usages, ImmutableOpenMap.of());\n+\n+        final AllocationDeciders deciders = new AllocationDeciders(\n+            new HashSet<>(Arrays.asList(\n+                new RestoreInProgressAllocationDecider(),\n+                new SameShardAllocationDecider(\n+                    Settings.EMPTY, new ClusterSettings(Settings.EMPTY, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS)\n+                ),\n+                makeDecider(diskSettings))));\n+\n+        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_uuid\", \"_snapshot_name\"));", "originalCommit": "c41abac7b100495b8254bbf5f64e134653e7dfe9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjExOTEwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63546#discussion_r506119109", "bodyText": "Good catch", "author": "tlrx", "createdAt": "2020-10-16T07:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5ODcxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEyMTExMg==", "url": "https://github.com/elastic/elasticsearch/pull/63546#discussion_r506121112", "bodyText": "Let's correct the IndexId as well \ud83e\udd26", "author": "tlrx", "createdAt": "2020-10-16T07:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5ODcxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "2b806736dd1e5ac14279833954b7d993efe57f3e", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java b/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\nindex 27a9e8e0424..ccab74674a6 100644\n--- a/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\n+++ b/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\n\n@@ -1168,16 +1168,10 @@ public class DiskThresholdDeciderTests extends ESAllocationTestCase {\n                 ),\n                 makeDecider(diskSettings))));\n \n-        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_uuid\", \"_snapshot_name\"));\n-        final IndexId indexId = new IndexId(\"_indexid_uuid\", \"_indexid_name\");\n+        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_name\", UUIDs.randomBase64UUID(random())));\n+        final IndexId indexId = new IndexId(\"_indexid_name\", UUIDs.randomBase64UUID(random()));\n         final ShardId shardId = new ShardId(new Index(\"test\", IndexMetadata.INDEX_UUID_NA_VALUE), 0);\n \n-        final AtomicReference<SnapshotShardSizeInfo> snapshotShardSizeInfoRef = new AtomicReference<>(SnapshotShardSizeInfo.EMPTY);\n-        final SnapshotsInfoService snapshotsInfoService = snapshotShardSizeInfoRef::get;\n-\n-        final AllocationService strategy = new AllocationService(deciders, new TestGatewayAllocator(),\n-            new BalancedShardsAllocator(Settings.EMPTY), clusterInfoService, snapshotsInfoService);\n-\n         final Metadata metadata = Metadata.builder()\n             .put(IndexMetadata.builder(\"test\")\n                 .settings(settings(Version.CURRENT))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwMTAwNA==", "url": "https://github.com/elastic/elasticsearch/pull/63546#discussion_r505701004", "bodyText": "NIT: I think I would have had an easier time following this test if we had moved this to where it's actually first used after the assertions on the CS we construct below to like:\n        final AtomicReference<SnapshotShardSizeInfo> snapshotShardSizeInfoRef = new AtomicReference<>(SnapshotShardSizeInfo.EMPTY);\n        final AllocationService strategy = new AllocationService(deciders, new TestGatewayAllocator(),\n                new BalancedShardsAllocator(Settings.EMPTY), clusterInfoService, snapshotShardSizeInfoRef::get);\n\n        // reroute triggers snapshot shard size fetching\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n        logShardStates(clusterState);", "author": "original-brownbear", "createdAt": "2020-10-15T17:03:08Z", "path": "server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java", "diffHunk": "@@ -1130,6 +1144,110 @@ public void testWatermarksEnabledForSingleDataNode() {\n                 \" actual free: [20.0%]\"));\n     }\n \n+    public void testDiskThresholdWithSnapshotShardSizes() {\n+        final long shardSizeInBytes = randomBoolean() ? 10L : 50L;\n+        logger.info(\"--> using shard size [{}]\", shardSizeInBytes);\n+\n+        final Settings diskSettings = Settings.builder()\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_DISK_THRESHOLD_ENABLED_SETTING.getKey(), true)\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_LOW_DISK_WATERMARK_SETTING.getKey(), \"90%\")\n+            .put(DiskThresholdSettings.CLUSTER_ROUTING_ALLOCATION_HIGH_DISK_WATERMARK_SETTING.getKey(), \"95%\")\n+            .build();\n+\n+        final ImmutableOpenMap.Builder<String, DiskUsage> usagesBuilder = ImmutableOpenMap.builder();\n+        usagesBuilder.put(\"node1\", new DiskUsage(\"node1\", \"n1\", \"/dev/null\", 100, 21));  // 79% used\n+        usagesBuilder.put(\"node2\", new DiskUsage(\"node2\", \"n2\", \"/dev/null\", 100, 1)); // 99% used\n+        final ImmutableOpenMap<String, DiskUsage> usages = usagesBuilder.build();\n+        final ClusterInfoService clusterInfoService = () -> new DevNullClusterInfo(usages, usages, ImmutableOpenMap.of());\n+\n+        final AllocationDeciders deciders = new AllocationDeciders(\n+            new HashSet<>(Arrays.asList(\n+                new RestoreInProgressAllocationDecider(),\n+                new SameShardAllocationDecider(\n+                    Settings.EMPTY, new ClusterSettings(Settings.EMPTY, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS)\n+                ),\n+                makeDecider(diskSettings))));\n+\n+        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_uuid\", \"_snapshot_name\"));\n+        final IndexId indexId = new IndexId(\"_indexid_uuid\", \"_indexid_name\");\n+        final ShardId shardId = new ShardId(new Index(\"test\", IndexMetadata.INDEX_UUID_NA_VALUE), 0);\n+\n+        final AtomicReference<SnapshotShardSizeInfo> snapshotShardSizeInfoRef = new AtomicReference<>(SnapshotShardSizeInfo.EMPTY);\n+        final SnapshotsInfoService snapshotsInfoService = snapshotShardSizeInfoRef::get;\n+\n+        final AllocationService strategy = new AllocationService(deciders, new TestGatewayAllocator(),", "originalCommit": "c41abac7b100495b8254bbf5f64e134653e7dfe9", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2b806736dd1e5ac14279833954b7d993efe57f3e", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java b/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\nindex 27a9e8e0424..ccab74674a6 100644\n--- a/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\n+++ b/server/src/test/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderTests.java\n\n@@ -1168,16 +1168,10 @@ public class DiskThresholdDeciderTests extends ESAllocationTestCase {\n                 ),\n                 makeDecider(diskSettings))));\n \n-        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_uuid\", \"_snapshot_name\"));\n-        final IndexId indexId = new IndexId(\"_indexid_uuid\", \"_indexid_name\");\n+        final Snapshot snapshot = new Snapshot(\"_repository\", new SnapshotId(\"_snapshot_name\", UUIDs.randomBase64UUID(random())));\n+        final IndexId indexId = new IndexId(\"_indexid_name\", UUIDs.randomBase64UUID(random()));\n         final ShardId shardId = new ShardId(new Index(\"test\", IndexMetadata.INDEX_UUID_NA_VALUE), 0);\n \n-        final AtomicReference<SnapshotShardSizeInfo> snapshotShardSizeInfoRef = new AtomicReference<>(SnapshotShardSizeInfo.EMPTY);\n-        final SnapshotsInfoService snapshotsInfoService = snapshotShardSizeInfoRef::get;\n-\n-        final AllocationService strategy = new AllocationService(deciders, new TestGatewayAllocator(),\n-            new BalancedShardsAllocator(Settings.EMPTY), clusterInfoService, snapshotsInfoService);\n-\n         final Metadata metadata = Metadata.builder()\n             .put(IndexMetadata.builder(\"test\")\n                 .settings(settings(Version.CURRENT))\n"}}, {"oid": "2b806736dd1e5ac14279833954b7d993efe57f3e", "url": "https://github.com/elastic/elasticsearch/commit/2b806736dd1e5ac14279833954b7d993efe57f3e", "message": "feedback", "committedDate": "2020-10-16T07:36:15Z", "type": "commit"}, {"oid": "a73eb5c310b6c252c64e9ac527ba93a09ecbbea1", "url": "https://github.com/elastic/elasticsearch/commit/a73eb5c310b6c252c64e9ac527ba93a09ecbbea1", "message": "Merge branch 'master' into add-snapshot-shard-size-test-in-diskthresholddecidertests", "committedDate": "2020-10-16T07:36:22Z", "type": "commit"}]}