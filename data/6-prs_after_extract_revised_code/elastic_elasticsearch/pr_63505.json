{"pr_number": 63505, "pr_title": "Flush translog writer before adding new operation", "pr_createdAt": "2020-10-08T17:51:12Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63505", "timeline": [{"oid": "79a560ac1667c98f51b1ca5d1772d2ff22cbaccf", "url": "https://github.com/elastic/elasticsearch/commit/79a560ac1667c98f51b1ca5d1772d2ff22cbaccf", "message": "Flush translog writer before adding new operation\n\nCurrently we flush the Translog buffer when a new operation causes the\nbuffer to breach 1MB. This introduces a scenario where an exception is\nthrown AFTER the writer has accepted the operation. To avoid this, this\ncommit flushes the Translog in an #add call before adding a new\noperation.\n\nThis fixes #63299.", "committedDate": "2020-10-08T17:48:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyMzkzNg==", "url": "https://github.com/elastic/elasticsearch/pull/63505#discussion_r501923936", "bodyText": "Would it make sense to add:\nassert bufferedBytes == buffer.size()\n\n(3 lines down).", "author": "henningandersen", "createdAt": "2020-10-08T18:21:19Z", "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -185,8 +186,12 @@ private synchronized void closeWithTragicEvent(final Exception ex) {\n      * @throws IOException if writing to the translog resulted in an I/O exception\n      */\n     public Translog.Location add(final BytesReference data, final long seqNo) throws IOException {\n+        long bufferedBytesBeforeAdd = this.bufferedBytes;\n+        if (bufferedBytesBeforeAdd >= forceWriteThreshold) {\n+            writeBufferedOps(Long.MAX_VALUE, bufferedBytesBeforeAdd >= forceWriteThreshold * 4);\n+        }\n+\n         final Translog.Location location;\n-        final long bytesBufferedAfterAdd;\n         synchronized (this) {\n             ensureOpen();\n             if (buffer == null) {", "originalCommit": "79a560ac1667c98f51b1ca5d1772d2ff22cbaccf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2a68ef55b0d2474d615108dd9ae5556f01809e13", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java b/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java\nindex 6d94168bd56a..40ad05d7ad7d 100644\n--- a/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java\n+++ b/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java\n\n@@ -197,6 +197,7 @@ public class TranslogWriter extends BaseTranslogReader implements Closeable {\n             if (buffer == null) {\n                 buffer = new ReleasableBytesStreamOutput(bigArrays);\n             }\n+            assert bufferedBytes == buffer.size();\n             final long offset = totalOffset;\n             totalOffset += data.length();\n             data.writeTo(buffer);\n"}}, {"oid": "2a68ef55b0d2474d615108dd9ae5556f01809e13", "url": "https://github.com/elastic/elasticsearch/commit/2a68ef55b0d2474d615108dd9ae5556f01809e13", "message": "Add assertion", "committedDate": "2020-10-08T18:40:29Z", "type": "commit"}]}