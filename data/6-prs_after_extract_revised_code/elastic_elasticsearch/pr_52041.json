{"pr_number": 52041, "pr_title": "[Transform] provide exponential_avg* stats for batch transforms", "pr_createdAt": "2020-02-07T13:05:10Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52041", "timeline": [{"oid": "ffe2f020f37ada1cd66fa9ec2296ce9db88233ec", "url": "https://github.com/elastic/elasticsearch/commit/ffe2f020f37ada1cd66fa9ec2296ce9db88233ec", "message": "apply spotless code formating", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "ea60c0900245bb0d788500bd1d431dba62e918c6", "url": "https://github.com/elastic/elasticsearch/commit/ea60c0900245bb0d788500bd1d431dba62e918c6", "message": "omit continuous stats for batch transforms", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "e57690aa3828fc4a6299fcbc57522c455fee7fe4", "url": "https://github.com/elastic/elasticsearch/commit/e57690aa3828fc4a6299fcbc57522c455fee7fe4", "message": "Revert \"omit continuous stats for batch transforms\"\n\nThis reverts commit 7d761362519f9e649e801cd7e8a04e56e021509b.", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "fd7cadc287580f4130196b7ff96ba69f86af2c1b", "url": "https://github.com/elastic/elasticsearch/commit/fd7cadc287580f4130196b7ff96ba69f86af2c1b", "message": "remove extra constructor and always calculate exponential averages", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "05322a82725f966452a7ea484c5330e1dd5428e6", "url": "https://github.com/elastic/elasticsearch/commit/05322a82725f966452a7ea484c5330e1dd5428e6", "message": "fix BWC test", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "f74d2c8a59fac00cdaff006e23109c1f9458108b", "url": "https://github.com/elastic/elasticsearch/commit/f74d2c8a59fac00cdaff006e23109c1f9458108b", "message": "fix more tests", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "url": "https://github.com/elastic/elasticsearch/commit/f9029b04e47690f0103b4718ccb9a298f117cd7f", "message": "apply spotless", "committedDate": "2020-02-10T11:46:23Z", "type": "commit"}, {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "url": "https://github.com/elastic/elasticsearch/commit/f9029b04e47690f0103b4718ccb9a298f117cd7f", "message": "apply spotless", "committedDate": "2020-02-10T11:46:23Z", "type": "forcePushed"}, {"oid": "8ba947d3452068d281acdb97e1d1960289c6ffa2", "url": "https://github.com/elastic/elasticsearch/commit/8ba947d3452068d281acdb97e1d1960289c6ffa2", "message": "fix placement of docstring", "committedDate": "2020-02-10T12:57:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377042194", "bodyText": "^ this is basically the main change", "author": "hendrikmuhs", "createdAt": "2020-02-10T12:48:54Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -361,9 +361,8 @@ protected void onFinish(ActionListener<Void> listener) {\n             if (progress != null && progress.getPercentComplete() != null && progress.getPercentComplete() < 100.0) {\n                 progress.incrementDocsProcessed(progress.getTotalDocs() - progress.getDocumentsProcessed());\n             }\n-            // If the last checkpoint is now greater than 1, that means that we have just processed the first\n-            // continuous checkpoint and should start recording the exponential averages\n-            if (lastCheckpoint != null && lastCheckpoint.getCheckpoint() > 1) {", "originalCommit": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MDU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378160583", "bodyText": "\ud83d\ude01  ha it took a lot of reviewing to get here and it's a one liner", "author": "davidkyle", "createdAt": "2020-02-12T10:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjE5NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjUxMA==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377042510", "bodyText": "^ removed this constructor", "author": "hendrikmuhs", "createdAt": "2020-02-10T12:49:37Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformIndexerStats.java", "diffHunk": "@@ -73,37 +85,62 @@\n     private double expAvgCheckpointDurationMs;\n     private double expAvgDocumentsIndexed;\n     private double expAvgDocumentsProcessed;\n+\n     /**\n      * Create with all stats set to zero\n      */\n     public TransformIndexerStats() {\n         super();\n     }\n \n-    public TransformIndexerStats(long numPages, long numInputDocuments, long numOutputDocuments,\n-                                          long numInvocations, long indexTime, long searchTime, long indexTotal, long searchTotal,\n-                                          long indexFailures, long searchFailures, Double expAvgCheckpointDurationMs,\n-                                          Double expAvgDocumentsIndexed, Double expAvgDocumentsProcessed ) {\n-        super(numPages, numInputDocuments, numOutputDocuments, numInvocations, indexTime, searchTime, indexTotal, searchTotal,\n-            indexFailures, searchFailures);\n+    public TransformIndexerStats(\n+        long numPages,\n+        long numInputDocuments,\n+        long numOutputDocuments,\n+        long numInvocations,\n+        long indexTime,\n+        long searchTime,\n+        long indexTotal,\n+        long searchTotal,\n+        long indexFailures,\n+        long searchFailures,\n+        Double expAvgCheckpointDurationMs,\n+        Double expAvgDocumentsIndexed,\n+        Double expAvgDocumentsProcessed\n+    ) {\n+        super(\n+            numPages,\n+            numInputDocuments,\n+            numOutputDocuments,\n+            numInvocations,\n+            indexTime,\n+            searchTime,\n+            indexTotal,\n+            searchTotal,\n+            indexFailures,\n+            searchFailures\n+        );\n         this.expAvgCheckpointDurationMs = expAvgCheckpointDurationMs == null ? 0.0 : expAvgCheckpointDurationMs;\n         this.expAvgDocumentsIndexed = expAvgDocumentsIndexed == null ? 0.0 : expAvgDocumentsIndexed;\n         this.expAvgDocumentsProcessed = expAvgDocumentsProcessed == null ? 0.0 : expAvgDocumentsProcessed;\n     }\n \n-    public TransformIndexerStats(long numPages, long numInputDocuments, long numOutputDocuments,\n-                                          long numInvocations, long indexTime, long searchTime, long indexTotal, long searchTotal,\n-                                          long indexFailures, long searchFailures) {\n-        this(numPages, numInputDocuments, numOutputDocuments, numInvocations, indexTime, searchTime, indexTotal, searchTotal,\n-            indexFailures, searchFailures, 0.0, 0.0, 0.0);\n-    }\n-", "originalCommit": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377043097", "bodyText": "do not get confused, testBwcWith73: this test BWC with 7.3 where we had no exponential averages, so its ok to construct the stats with 0.0", "author": "hendrikmuhs", "createdAt": "2020-02-10T12:50:56Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/transform/transforms/TransformStatsTests.java", "diffHunk": "@@ -69,7 +69,7 @@ public void testBwcWith73() throws IOException {\n                 STARTED,\n                 randomBoolean() ? null : randomAlphaOfLength(100),\n                 randomBoolean() ? null : NodeAttributeTests.randomNodeAttributes(),\n-                new TransformIndexerStats(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),\n+                new TransformIndexerStats(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0.0, 0.0, 0.0),", "originalCommit": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0Mzk2OA==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377043968", "bodyText": "^ a bug uncovered by this change: no telemetry for the exponential averages", "author": "hendrikmuhs", "createdAt": "2020-02-10T12:52:51Z", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/TransformInfoTransportAction.java", "diffHunk": "@@ -56,11 +55,17 @@\n         TransformIndexerStats.SEARCH_TOTAL.getPreferredName(),\n         TransformIndexerStats.INDEX_FAILURES.getPreferredName(),\n         TransformIndexerStats.SEARCH_FAILURES.getPreferredName(),\n-    };\n+        TransformIndexerStats.EXPONENTIAL_AVG_CHECKPOINT_DURATION_MS.getPreferredName(),\n+        TransformIndexerStats.EXPONENTIAL_AVG_DOCUMENTS_INDEXED.getPreferredName(),\n+        TransformIndexerStats.EXPONENTIAL_AVG_DOCUMENTS_PROCESSED.getPreferredName(), };", "originalCommit": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0NDY2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377044666", "bodyText": "^ foolish test, due to the alternative constructor, the test was incomplete", "author": "hendrikmuhs", "createdAt": "2020-02-10T12:54:21Z", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "diffHunk": "@@ -90,12 +101,16 @@ public void testParseSearchAggs() {\n             7,  // indexTotal\n             8,  // searchTotal\n             9,  // indexFailures\n-            10); // searchFailures\n+            10, // searchFailures\n+            11.0,  // exponential_avg_checkpoint_duration_ms\n+            12.0,  // exponential_avg_documents_indexed\n+            13.0   // exponential_avg_documents_processed", "originalCommit": "f9029b04e47690f0103b4718ccb9a298f117cd7f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1MTk5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378151993", "bodyText": "nit: the message should change '.. is not > 0.0'", "author": "davidkyle", "createdAt": "2020-02-12T10:08:07Z", "path": "x-pack/plugin/transform/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/transform/integration/TransformGetAndGetStatsIT.java", "diffHunk": "@@ -251,20 +253,28 @@ public void testGetStatsWithContinuous() throws Exception {\n \n         Request getRequest = createRequestWithAuth(\"GET\", getTransformEndpoint() + transformId + \"/_stats\", null);\n         Map<String, Object> stats = entityAsMap(client().performRequest(getRequest));\n-        List<Map<String, Object>> transformsStats = (List<Map<String, Object>>)XContentMapValues.extractValue(\"transforms\", stats);\n+        List<Map<String, Object>> transformsStats = (List<Map<String, Object>>) XContentMapValues.extractValue(\"transforms\", stats);\n         assertEquals(1, transformsStats.size());\n-        // No continuous checkpoints have been seen and thus all exponential averages should be 0.0\n+        // No continuous checkpoints have been seen and thus all exponential averages should be equal to the batch stats\n         for (Map<String, Object> transformStats : transformsStats) {\n-            transformStats = (Map<String, Object>)transformStats.get(\"stats\");\n-            assertThat(\"exponential_avg_checkpoint_duration_ms is not 0.0\",\n-                transformStats.get(\"exponential_avg_checkpoint_duration_ms\"),\n-                equalTo(0.0));\n-            assertThat(\"exponential_avg_documents_indexed is not 0.0\",\n-                transformStats.get(\"exponential_avg_documents_indexed\"),\n-                equalTo(0.0));\n-            assertThat(\"exponential_avg_documents_processed is not 0.0\",\n+            transformStats = (Map<String, Object>) transformStats.get(\"stats\");\n+            assertThat(transformStats.get(\"documents_processed\"), equalTo(1000));\n+            assertThat(transformStats.get(\"documents_indexed\"), equalTo(27));\n+            assertThat(\n+                \"exponential_avg_checkpoint_duration_ms is not 0.0\",", "originalCommit": "8ba947d3452068d281acdb97e1d1960289c6ffa2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NTczNA==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378165734", "bodyText": "The var is great I'm looking forward to using it. Expecting a backport problem I looked for this class in the 7.x branch and couldn't find it, instead there is TransformFeatureSetTests which looks very similar. Up to you but you might want to sync the 2 branches to make future backports easier.", "author": "davidkyle", "createdAt": "2020-02-12T10:33:03Z", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "diffHunk": "@@ -115,8 +130,16 @@ public void testUsageDisabled() throws IOException, InterruptedException, Execut\n         when(licenseState.isTransformAllowed()).thenReturn(true);\n         Settings.Builder settings = Settings.builder();\n         settings.put(\"xpack.transform.enabled\", false);\n-        var usageAction = new TransformUsageTransportAction(mock(TransportService.class), null, null,\n-            mock(ActionFilters.class), null, settings.build(), licenseState, mock(Client.class));\n+        var usageAction = new TransformUsageTransportAction(", "originalCommit": "8ba947d3452068d281acdb97e1d1960289c6ffa2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3MzM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378173354", "bodyText": "this file/class does not exist in 7.x, its based on a re-factoring that was only done on master: #43563\nI stumbled upon this several times (e.g. when renaming the feature to transform) and its indeed a troublemaker for backports. The code for 7.x is different, every time I change something here, I need to re-work the PR for 7.x. Fortunately this file doesn't change that often.", "author": "hendrikmuhs", "createdAt": "2020-02-12T10:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NTczNA=="}], "type": "inlineReview", "revised_code": null}]}