{"pr_number": 52547, "pr_title": "Implement hidden aliases", "pr_createdAt": "2020-02-20T00:53:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52547", "timeline": [{"oid": "c92b0cfa8beb7eb4c58740ef6084e5d913031bca", "url": "https://github.com/elastic/elasticsearch/commit/c92b0cfa8beb7eb4c58740ef6084e5d913031bca", "message": "Implement hidden aliases\n\nThis commit introduces hidden aliases. These are similar to hidden\nindices, in that they are not visible by default, unless explicitly\nspecified by name or by indicating that hidden indices/aliases are\ndesired.\n\nThe new alias property, `is_hidden` is implemented similarly to\n`is_write_index`, except that it must be consistent across all indices\nwith a given alias - that is, all indices with a given alias must\nspecify the alias as either hidden, or all specify it as non-hidden,\neither explicitly or by omitting the `is_hidden` property.", "committedDate": "2020-02-20T00:49:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNzQwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r382107401", "bodyText": "If I understand this correctly, this means that every place the alias is stored must have the same hidden value? Should we be more strict regarding false and null since it seems like a combination of those values would be accepted?", "author": "jaymode", "createdAt": "2020-02-20T16:20:34Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/AliasOrIndex.java", "diffHunk": "@@ -153,6 +175,24 @@ public void computeAndValidateWriteIndex() {\n                 throw new IllegalStateException(\"alias [\" + aliasName + \"] has more than one write index [\" +\n                     Strings.collectionToCommaDelimitedString(writeIndicesStrings) + \"]\");\n             }\n+\n+            // Validate hidden status\n+            final Map<Boolean, List<IndexMetaData>> groupedByHiddenStatus = referenceIndexMetaDatas.stream()", "originalCommit": "c92b0cfa8beb7eb4c58740ef6084e5d913031bca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjExNTI4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r382115289", "bodyText": "Yes, every IndexMetaData that has an alias with a particular name must have the same logical value for is_hidden for that alias.  I thought about making it more strict about false vs null, but given that the default for this value is false, it would seem odd that adding an alias that is explicitly not hidden (is_hidden: false), when the alias already exists as non-hidden by default (is_hidden omitted or null), would fail.\nI would certainly be open to being more strict about false vs null, but I'm not sure what it would gain us, and it's a little unintuitive to be strict about explicitly false vs omitted with a false default.", "author": "gwbrown", "createdAt": "2020-02-20T16:32:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNzQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1MjY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r385052652", "bodyText": "I haven't read all the code in detail but just wanted to make sure that this check won't prevent an existing alias that spans multiple indices from being made hidden.\nSuppose we have this situation in 7.6:\n\n.ml-annotations-1 and .ml-annotations-2 are indices\n.ml-annotations-read is an alias on both .ml-annotations-1 and .ml-annotations-2\n.ml-annotations-write is an alias on just .ml-annotations-2\n\nIn 7.7 we want to make all this hidden, so we:\n\nAdd the index.hidden setting to .ml-annotations-1 and .ml-annotations-2\nAdd the is_hidden property to .ml-annotations-read and .ml-annotations-write\n\nI just wanted to check that this won't fall foul of this validation because there's an instant during the updates where .ml-annotations-read is only hidden on .ml-annotations-1 but not .ml-annotations-2, even though it would be applied consistently an instant later.", "author": "droberts195", "createdAt": "2020-02-27T10:54:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNzQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0MjY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r385242649", "bodyText": "@droberts195 What you'll have to do is update the alias on all indices that have that alias simultaneously, like so:\nPOST _aliases\n{\n    \"actions\": [\n        {\n            \"add\": {\n                \"index\": \".ml-annotations-1\",\n                \"alias\": \".ml-annotations-read\",\n                \"is_hidden\": true\n            }\n        },\n        {\n            \"add\": {\n                \"index\": \".ml-annotations-2\",\n                \"alias\": \".ml-annotations-read\",\n                \"is_hidden\": true\n            }\n        }\n    ]\n}\n\nEven though the action is add, you can use it to update aliases that already exist. This is a bit inconvenient, but it's somewhat of a limitation of the alias infrastructure, and we should be able to work around it by querying for the list of indices and alias points to and generating the update aliases list from that. Let me know if this would be troublesome for you/your team.", "author": "gwbrown", "createdAt": "2020-02-27T17:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNzQwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI0ODQxMg==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r385248412", "bodyText": "Thanks @gwbrown.  I think doing the update as you've shown should be OK for us.", "author": "droberts195", "createdAt": "2020-02-27T17:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNzQwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "7cceb0c09c24b0494a1a1be8b52e6d9a5947cfcb", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasOrIndex.java b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasOrIndex.java\nindex 166df92a0a8..9d458663c2f 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasOrIndex.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasOrIndex.java\n\n@@ -184,9 +184,9 @@ public interface AliasOrIndex {\n                     .map(idx -> idx.getIndex().getName()).collect(Collectors.toList());\n                 List<String> nonHiddenOn = groupedByHiddenStatus.get(false).stream()\n                     .map(idx -> idx.getIndex().getName()).collect(Collectors.toList());\n-                throw new IllegalStateException(\"alias [\" + aliasName + \"] is hidden set as on [\" +\n-                    Strings.collectionToCommaDelimitedString(hiddenOn) + \"] but as NOT hidden on [\" +\n-                    Strings.collectionToCommaDelimitedString(nonHiddenOn) + \"]; alias must have same hidden setting \" +\n+                throw new IllegalStateException(\"alias [\" + aliasName + \"] has is_hidden set to true on indices [\" +\n+                    Strings.collectionToCommaDelimitedString(hiddenOn) + \"] but does not have is_hidden set to true on indices [\" +\n+                    Strings.collectionToCommaDelimitedString(nonHiddenOn) + \"]; alias must have the same is_hidden setting \" +\n                     \"on all indices\");\n             }\n         }\n"}}, {"oid": "ac83029f54be8e41ec25493a0534563c75c6dd75", "url": "https://github.com/elastic/elasticsearch/commit/ac83029f54be8e41ec25493a0534563c75c6dd75", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-21T23:45:26Z", "type": "commit"}, {"oid": "522bba68dcab4b657dea27eb615abc8c09862cd1", "url": "https://github.com/elastic/elasticsearch/commit/522bba68dcab4b657dea27eb615abc8c09862cd1", "message": "AliasOrIndex.isHidden -> boolean", "committedDate": "2020-02-25T00:18:31Z", "type": "commit"}, {"oid": "95e365ef165c7a67569ab5b6b252eb8a2e005d80", "url": "https://github.com/elastic/elasticsearch/commit/95e365ef165c7a67569ab5b6b252eb8a2e005d80", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-25T00:18:41Z", "type": "commit"}, {"oid": "53a0dab35054b502e2f7ac7f514b1cd5dce7001a", "url": "https://github.com/elastic/elasticsearch/commit/53a0dab35054b502e2f7ac7f514b1cd5dce7001a", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-25T21:37:44Z", "type": "commit"}, {"oid": "b36f53eeb045f427b339aa1c0d161cdf2975d9fd", "url": "https://github.com/elastic/elasticsearch/commit/b36f53eeb045f427b339aa1c0d161cdf2975d9fd", "message": "Only include isHidden in alias XContent if present", "committedDate": "2020-02-25T23:55:26Z", "type": "commit"}, {"oid": "bf118884c6ea42a72964a1c52bd624e834699ea1", "url": "https://github.com/elastic/elasticsearch/commit/bf118884c6ea42a72964a1c52bd624e834699ea1", "message": "Update alias docs", "committedDate": "2020-02-26T00:02:43Z", "type": "commit"}, {"oid": "d3985605fb6689a67a38fc3eced952b04525e8af", "url": "https://github.com/elastic/elasticsearch/commit/d3985605fb6689a67a38fc3eced952b04525e8af", "message": "Handle hidden indices in standard resolver", "committedDate": "2020-02-26T00:37:02Z", "type": "commit"}, {"oid": "7cceb0c09c24b0494a1a1be8b52e6d9a5947cfcb", "url": "https://github.com/elastic/elasticsearch/commit/7cceb0c09c24b0494a1a1be8b52e6d9a5947cfcb", "message": "Improve is_hidden consistency error message", "committedDate": "2020-02-26T00:43:21Z", "type": "commit"}, {"oid": "82aef04b12c9a53cdf1e837b013d43af858e823a", "url": "https://github.com/elastic/elasticsearch/commit/82aef04b12c9a53cdf1e837b013d43af858e823a", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-26T18:36:25Z", "type": "commit"}, {"oid": "c8c7472a3ace39bd87d0c22c412fb08f91df7e60", "url": "https://github.com/elastic/elasticsearch/commit/c8c7472a3ace39bd87d0c22c412fb08f91df7e60", "message": "Add isHidden to AliasAction + unit tests", "committedDate": "2020-02-27T17:57:47Z", "type": "commit"}, {"oid": "e7c1af77ca2f6d5954b2b6bcc2b866c7fd1b5670", "url": "https://github.com/elastic/elasticsearch/commit/e7c1af77ca2f6d5954b2b6bcc2b866c7fd1b5670", "message": "Yet more unit tests", "committedDate": "2020-02-27T18:55:05Z", "type": "commit"}, {"oid": "1e77c224a4814c0f378d84beeb4938667474d77e", "url": "https://github.com/elastic/elasticsearch/commit/1e77c224a4814c0f378d84beeb4938667474d77e", "message": "Integration tests for hidden aliases", "committedDate": "2020-02-27T22:31:56Z", "type": "commit"}, {"oid": "f02c484996eb45e6191da4da04f3baaddb6a371c", "url": "https://github.com/elastic/elasticsearch/commit/f02c484996eb45e6191da4da04f3baaddb6a371c", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-27T22:32:13Z", "type": "commit"}, {"oid": "29a6a5d9e2adb03282d43b7d5c1ce6c7d0379d1f", "url": "https://github.com/elastic/elasticsearch/commit/29a6a5d9e2adb03282d43b7d5c1ce6c7d0379d1f", "message": "More unit tests", "committedDate": "2020-02-27T22:41:13Z", "type": "commit"}, {"oid": "0dad3570319ded9a4dc39ca7402ad7accca7922a", "url": "https://github.com/elastic/elasticsearch/commit/0dad3570319ded9a4dc39ca7402ad7accca7922a", "message": "Line lengths", "committedDate": "2020-02-27T22:57:45Z", "type": "commit"}, {"oid": "2faec6314d8c74ecf513549dc2ac65cc8f8a7e4b", "url": "https://github.com/elastic/elasticsearch/commit/2faec6314d8c74ecf513549dc2ac65cc8f8a7e4b", "message": "Plumb is_hidden into Security's resolver", "committedDate": "2020-02-29T00:35:59Z", "type": "commit"}, {"oid": "c7240df7a44d3ea4d60e42a4749aeb39f622e803", "url": "https://github.com/elastic/elasticsearch/commit/c7240df7a44d3ea4d60e42a4749aeb39f622e803", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-02-29T00:38:56Z", "type": "commit"}, {"oid": "88a3d75ecab45f7c93b87b7ef65d979e16189a07", "url": "https://github.com/elastic/elasticsearch/commit/88a3d75ecab45f7c93b87b7ef65d979e16189a07", "message": "Update streaming version TODOS", "committedDate": "2020-02-29T01:10:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU2NjM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r386566346", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               @Nullable Boolean writeIndex, Boolean isHidden) {\n          \n          \n            \n                               @Nullable Boolean writeIndex, @Nullable Boolean isHidden) {", "author": "jaymode", "createdAt": "2020-03-02T18:22:52Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java", "diffHunk": "@@ -85,11 +85,13 @@ public String getIndex() {\n         @Nullable\n         private final Boolean writeIndex;\n \n+        @Nullable final Boolean isHidden;\n+\n         /**\n          * Build the operation.\n          */\n-        public Add(String index, String alias, @Nullable String filter, @Nullable String indexRouting,\n-                   @Nullable String searchRouting, @Nullable Boolean writeIndex) {\n+        public Add(String index, String alias, @Nullable String filter, @Nullable String indexRouting, @Nullable String searchRouting,\n+                   @Nullable Boolean writeIndex, Boolean isHidden) {", "originalCommit": "88a3d75ecab45f7c93b87b7ef65d979e16189a07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9285a57e55b60975da635b7f4e9089bf1197748f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\nindex ca3dfb1e537..2067589f74d 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\n\n@@ -91,7 +91,7 @@ public abstract class AliasAction {\n          * Build the operation.\n          */\n         public Add(String index, String alias, @Nullable String filter, @Nullable String indexRouting, @Nullable String searchRouting,\n-                   @Nullable Boolean writeIndex, Boolean isHidden) {\n+                   @Nullable Boolean writeIndex, @Nullable Boolean isHidden) {\n             super(index);\n             if (false == Strings.hasText(alias)) {\n                 throw new IllegalArgumentException(\"[alias] is required\");\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU2NjY2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r386566666", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Boolean isHidden() {\n          \n          \n            \n                    @Nullable\n          \n          \n            \n                    public Boolean isHidden() {", "author": "jaymode", "createdAt": "2020-03-02T18:23:31Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java", "diffHunk": "@@ -112,6 +115,10 @@ public Boolean writeIndex() {\n             return writeIndex;\n         }\n \n+        public Boolean isHidden() {", "originalCommit": "88a3d75ecab45f7c93b87b7ef65d979e16189a07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9285a57e55b60975da635b7f4e9089bf1197748f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\nindex ca3dfb1e537..2067589f74d 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasAction.java\n\n@@ -115,6 +115,7 @@ public abstract class AliasAction {\n             return writeIndex;\n         }\n \n+        @Nullable\n         public Boolean isHidden() {\n             return isHidden;\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU2Njk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r386566963", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                      Boolean isHidden) {\n          \n          \n            \n                                      @Nullable Boolean isHidden) {", "author": "jaymode", "createdAt": "2020-03-02T18:24:08Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java", "diffHunk": "@@ -59,7 +61,11 @@\n     @Nullable\n     private final Boolean writeIndex;\n \n-    private AliasMetaData(String alias, CompressedXContent filter, String indexRouting, String searchRouting, Boolean writeIndex) {\n+    @Nullable\n+    private final Boolean isHidden;\n+\n+    private AliasMetaData(String alias, CompressedXContent filter, String indexRouting, String searchRouting, Boolean writeIndex,\n+                          Boolean isHidden) {", "originalCommit": "88a3d75ecab45f7c93b87b7ef65d979e16189a07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9285a57e55b60975da635b7f4e9089bf1197748f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\nindex 93b3e95507c..f5cdbc479e6 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\n\n@@ -65,7 +65,7 @@ public class AliasMetaData extends AbstractDiffable<AliasMetaData> implements To\n     private final Boolean isHidden;\n \n     private AliasMetaData(String alias, CompressedXContent filter, String indexRouting, String searchRouting, Boolean writeIndex,\n-                          Boolean isHidden) {\n+                          @Nullable Boolean isHidden) {\n         this.alias = alias;\n         this.filter = filter;\n         this.indexRouting = indexRouting;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU2NzA4OA==", "url": "https://github.com/elastic/elasticsearch/pull/52547#discussion_r386567088", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Boolean isHidden() {\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public Boolean isHidden() {", "author": "jaymode", "createdAt": "2020-03-02T18:24:24Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java", "diffHunk": "@@ -120,6 +128,10 @@ public Boolean writeIndex() {\n         return writeIndex;\n     }\n \n+    public Boolean isHidden() {", "originalCommit": "88a3d75ecab45f7c93b87b7ef65d979e16189a07", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9285a57e55b60975da635b7f4e9089bf1197748f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\nindex 93b3e95507c..f5cdbc479e6 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/AliasMetaData.java\n\n@@ -128,6 +128,7 @@ public class AliasMetaData extends AbstractDiffable<AliasMetaData> implements To\n         return writeIndex;\n     }\n \n+    @Nullable\n     public Boolean isHidden() {\n         return isHidden;\n     }\n"}}, {"oid": "9285a57e55b60975da635b7f4e9089bf1197748f", "url": "https://github.com/elastic/elasticsearch/commit/9285a57e55b60975da635b7f4e9089bf1197748f", "message": "@Nullable consistency", "committedDate": "2020-03-03T22:18:10Z", "type": "commit"}, {"oid": "ffe440f1e2a407fab82292402b6993821865f3f5", "url": "https://github.com/elastic/elasticsearch/commit/ffe440f1e2a407fab82292402b6993821865f3f5", "message": "Merge branch 'master' into hidden/aliases", "committedDate": "2020-03-03T22:18:27Z", "type": "commit"}]}