{"pr_number": 53144, "pr_title": "Simplify SiblingPipelineAggregator", "pr_createdAt": "2020-03-05T00:18:48Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53144", "timeline": [{"oid": "fd7c725a9103ad8b65957f82708960bda5df5f5e", "url": "https://github.com/elastic/elasticsearch/commit/fd7c725a9103ad8b65957f82708960bda5df5f5e", "message": "Simplify SiblingPipelineAggregator\n\nThis removes the `instanceof`s from `SiblingPipelineAggregator` by\nadding a `rewriteBuckets` method to `InternalAggregation` that can be\ncalled to, well, rewrite the buckets. The default implementation of\n`rewriteBuckets` throws the same exception that was thrown when you\nattempted to run a `SiblingPipelineAggregator` on an aggregation without\nbuckets. It is overridden by `InternalSingleBucketAggregation` and\n`InternalMultiBucketAggregation` to correctly rewrite their buckets.", "committedDate": "2020-03-04T22:52:10Z", "type": "commit"}, {"oid": "9ae0c9d533f7c6b4969c5ef09e7f9ca137b4f8d8", "url": "https://github.com/elastic/elasticsearch/commit/9ae0c9d533f7c6b4969c5ef09e7f9ca137b4f8d8", "message": "Revert", "committedDate": "2020-03-05T00:18:57Z", "type": "commit"}, {"oid": "4cd44217a9922aa3ba2a98790c0299d08152d6a2", "url": "https://github.com/elastic/elasticsearch/commit/4cd44217a9922aa3ba2a98790c0299d08152d6a2", "message": "Ooops", "committedDate": "2020-03-05T00:24:10Z", "type": "commit"}, {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "url": "https://github.com/elastic/elasticsearch/commit/dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "message": "Merge branch 'master' into untwist_aggs", "committedDate": "2020-03-05T11:52:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3NDQzNg==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388374436", "bodyText": "I believe this only skips sibling pipeline aggs?  E.g. \"child\" pipeline aggs (those that extend PipelineAggregator directly) will be included in the internal agg list, iirc", "author": "polyfractal", "createdAt": "2020-03-05T15:37:54Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java", "diffHunk": "@@ -85,6 +85,15 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeNamedWriteableList(topLevelPipelineAggregators);\n     }\n \n+    /**\n+     * Make a mutable copy of the aggregation results.\n+     * <p>\n+     * IMPORTANT: The copy doesn't include any pipeline aggregations, if there are any.", "originalCommit": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MDIzNA==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388560234", "bodyText": "Yeah - I added this to make sure no one was surprised that pipeline aggs aren't kept. I mean, they can't be without a Builder, I think. But we throw them out now when we do the rewriting already. But we just don't talk about it. I'll update the comment, for sure.", "author": "nik9000", "createdAt": "2020-03-05T20:55:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3NDQzNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388403739", "bodyText": "Let's beef up the docs here, it took me a while to really understand what this is doing.\nE.g. an implementer of this will iterate over their internal buckets and apply the rewriter to each bucket, generating a modified/rewritten representation of their buckets which is then returned.\nAlso I think it's probably important to note that this returns a new version of the InternalAggregations... but the callee remains immutable and does not itself change.", "author": "polyfractal", "createdAt": "2020-03-05T16:19:46Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java", "diffHunk": "@@ -127,6 +127,28 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * The default implementation throws an exception because most\n+     * aggregations don't <strong>have</strong> buckets in them. It\n+     * should be overridden by aggregations that contain buckets.\n+     */\n+    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {", "originalCommit": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxODQ2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388418463", "bodyText": "Perhaps rename the method to copyAndRewriteBuckets() or similar, to help make it clear what's going on?", "author": "polyfractal", "createdAt": "2020-03-05T16:42:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1OTU1OA==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388559558", "bodyText": "++", "author": "nik9000", "createdAt": "2020-03-05T20:54:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzczOQ=="}], "type": "inlineReview", "revised_code": {"commit": "00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java b/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\nindex c87d2efcd3a..77833c98cae 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\n\n@@ -129,25 +130,26 @@ public abstract class InternalAggregation implements Aggregation, NamedWriteable\n \n     /**\n      * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * Returns a copy of this {@linkplain InternalAggregation} with the\n+     * rewritten buckets, or, if there aren't any modifications to\n+     * the buckets then this method will return this aggregation. Either\n+     * way, it doesn't modify this aggregation.\n+     * <p>\n+     * Implementers of this should call the {@code rewriter} once per bucket\n+     * with its {@linkplain InternalAggregations}. The {@code rewriter}\n+     * should return {@code null} if it doen't have any rewriting to do or\n+     * it should return a new {@linkplain InternalAggregations} to make\n+     * changs.\n+     * <p>\n      * The default implementation throws an exception because most\n      * aggregations don't <strong>have</strong> buckets in them. It\n-     * should be overridden by aggregations that contain buckets.\n+     * should be overridden by aggregations that contain buckets. Implementers\n+     * should respect the description above.\n      */\n-    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {\n+    public InternalAggregation copyWithRewritenBuckets(Function<InternalAggregations, InternalAggregations> rewriter) {\n         throw new IllegalStateException(\n                 \"Aggregation [\" + getName() + \"] must be a bucket aggregation but was [\" + getWriteableName() + \"]\");\n     }\n-    /**\n-     * Used with {@link InternalAggregation#rewriteBuckets(BucketRewriter)} to\n-     * rewrite the sub-aggregations within buckets.\n-     */\n-    public interface BucketRewriter {\n-        /**\n-         * Return a new {@linkplain InternalAggregations} to rewrite the\n-         * bucket or {@code null} if the bucket shouldn't be modified.\n-         */\n-        InternalAggregations rewrite(InternalAggregations aggregations);\n-    }\n \n     /**\n      * Creates the output from all pipeline aggs that this aggregation is associated with.  Should only\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDczNg==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388404736", "bodyText": "Does this gain us anything over just using Function<InternalAggregations, InternalAggregations>?  Shorter type signature, but it feels like it obfuscates what's going on?\nNot a strong opinion on this, just felt like extra boilerplate.", "author": "polyfractal", "createdAt": "2020-03-05T16:21:21Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java", "diffHunk": "@@ -127,6 +127,28 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * The default implementation throws an exception because most\n+     * aggregations don't <strong>have</strong> buckets in them. It\n+     * should be overridden by aggregations that contain buckets.\n+     */\n+    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {\n+        throw new IllegalStateException(\n+                \"Aggregation [\" + getName() + \"] must be a bucket aggregation but was [\" + getWriteableName() + \"]\");\n+    }\n+    /**\n+     * Used with {@link InternalAggregation#rewriteBuckets(BucketRewriter)} to\n+     * rewrite the sub-aggregations within buckets.\n+     */\n+    public interface BucketRewriter {", "originalCommit": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1OTQ4NA==", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388559484", "bodyText": "I thought it'd have other things but it turns out it doesn't. \ud83d\udc4d on the Function.", "author": "nik9000", "createdAt": "2020-03-05T20:53:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDczNg=="}], "type": "inlineReview", "revised_code": {"commit": "00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java b/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\nindex c87d2efcd3a..77833c98cae 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java\n\n@@ -129,25 +130,26 @@ public abstract class InternalAggregation implements Aggregation, NamedWriteable\n \n     /**\n      * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * Returns a copy of this {@linkplain InternalAggregation} with the\n+     * rewritten buckets, or, if there aren't any modifications to\n+     * the buckets then this method will return this aggregation. Either\n+     * way, it doesn't modify this aggregation.\n+     * <p>\n+     * Implementers of this should call the {@code rewriter} once per bucket\n+     * with its {@linkplain InternalAggregations}. The {@code rewriter}\n+     * should return {@code null} if it doen't have any rewriting to do or\n+     * it should return a new {@linkplain InternalAggregations} to make\n+     * changs.\n+     * <p>\n      * The default implementation throws an exception because most\n      * aggregations don't <strong>have</strong> buckets in them. It\n-     * should be overridden by aggregations that contain buckets.\n+     * should be overridden by aggregations that contain buckets. Implementers\n+     * should respect the description above.\n      */\n-    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {\n+    public InternalAggregation copyWithRewritenBuckets(Function<InternalAggregations, InternalAggregations> rewriter) {\n         throw new IllegalStateException(\n                 \"Aggregation [\" + getName() + \"] must be a bucket aggregation but was [\" + getWriteableName() + \"]\");\n     }\n-    /**\n-     * Used with {@link InternalAggregation#rewriteBuckets(BucketRewriter)} to\n-     * rewrite the sub-aggregations within buckets.\n-     */\n-    public interface BucketRewriter {\n-        /**\n-         * Return a new {@linkplain InternalAggregations} to rewrite the\n-         * bucket or {@code null} if the bucket shouldn't be modified.\n-         */\n-        InternalAggregations rewrite(InternalAggregations aggregations);\n-    }\n \n     /**\n      * Creates the output from all pipeline aggs that this aggregation is associated with.  Should only\n"}}, {"oid": "0dd0bca74240765b201bcc2ed7c0bf889d31d189", "url": "https://github.com/elastic/elasticsearch/commit/0dd0bca74240765b201bcc2ed7c0bf889d31d189", "message": "Merge branch 'master' into untwist_aggs", "committedDate": "2020-03-09T17:32:27Z", "type": "commit"}, {"oid": "00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "url": "https://github.com/elastic/elasticsearch/commit/00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "message": "Fixup", "committedDate": "2020-03-09T17:53:51Z", "type": "commit"}]}