{"pr_number": 61348, "pr_title": "Detect noop of update index settings", "pr_createdAt": "2020-08-19T19:19:35Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61348", "timeline": [{"oid": "0729616f6112b7b3e700fadf22771ee12bd7f0b2", "url": "https://github.com/elastic/elasticsearch/commit/0729616f6112b7b3e700fadf22771ee12bd7f0b2", "message": "Detect noop of index setting update", "committedDate": "2020-08-19T19:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0NzYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r473947637", "bodyText": "Is there a reason we do not want this to be the same? With the block already in place, this could be a no-op?", "author": "henningandersen", "createdAt": "2020-08-20T12:55:40Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java", "diffHunk": "@@ -687,4 +690,40 @@ private void runTestDefaultNumberOfReplicasTest(final boolean closeIndex) {\n         assertThat(IndexMetadata.INDEX_NUMBER_OF_REPLICAS_SETTING.get(response.getIndexToSettings().get(\"test\")), equalTo(1));\n     }\n \n+    public void testNoopUpdate() {\n+        internalCluster().ensureAtLeastNumDataNodes(2);\n+        final ClusterService clusterService = internalCluster().getMasterNodeInstance(ClusterService.class);\n+        assertAcked(client().admin().indices().prepareCreate(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 2)));\n+        client().admin().cluster().prepareHealth()\n+            .setWaitForNoInitializingShards(true)\n+            .setWaitForEvents(Priority.LANGUID)\n+            .setTimeout(TimeValue.MAX_VALUE)\n+            .get();\n+\n+        ClusterState currentState = clusterService.state();\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertNotSame(currentState, clusterService.state());\n+        currentState = clusterService.state();\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertSame(clusterService.state(), currentState);\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().putNull(IndexMetadata.SETTING_NUMBER_OF_REPLICAS)));\n+        assertSame(clusterService.state(), currentState);\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder()\n+                .put(SETTING_BLOCKS_READ, true)\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertNotSame(currentState, clusterService.state());\n+        currentState = clusterService.state();\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(SETTING_BLOCKS_READ, true)));\n+        assertNotSame(currentState, clusterService.state());", "originalCommit": "0729616f6112b7b3e700fadf22771ee12bd7f0b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MDcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r474140723", "bodyText": "Addressed in f43c2ea.", "author": "dnhatn", "createdAt": "2020-08-20T17:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0NzYzNw=="}], "type": "inlineReview", "revised_code": {"commit": "f43c2ead444482eebbd402773e847eb1a9e086b6", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java b/server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java\nindex 6012f587894..1a2d9aef290 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java\n\n@@ -694,17 +694,18 @@ public class UpdateSettingsIT extends ESIntegTestCase {\n         internalCluster().ensureAtLeastNumDataNodes(2);\n         final ClusterService clusterService = internalCluster().getMasterNodeInstance(ClusterService.class);\n         assertAcked(client().admin().indices().prepareCreate(\"test\")\n-            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 2)));\n-        client().admin().cluster().prepareHealth()\n-            .setWaitForNoInitializingShards(true)\n-            .setWaitForEvents(Priority.LANGUID)\n-            .setTimeout(TimeValue.MAX_VALUE)\n-            .get();\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)));\n \n         ClusterState currentState = clusterService.state();\n         assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n             .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n         assertNotSame(currentState, clusterService.state());\n+        client().admin().cluster().prepareHealth()\n+            .setWaitForGreenStatus()\n+            .setWaitForNoInitializingShards(true)\n+            .setWaitForEvents(Priority.LANGUID)\n+            .setTimeout(TimeValue.MAX_VALUE)\n+            .get();\n         currentState = clusterService.state();\n \n         assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0ODE0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r473948145", "bodyText": "This sets changed=true regardless of whether block was in place or not. I think we should handle that too - mainly for completeness more than necessity.", "author": "henningandersen", "createdAt": "2020-08-20T12:56:32Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java", "diffHunk": "@@ -304,8 +311,10 @@ private static void maybeUpdateClusterBlock(String[] actualIndices, ClusterBlock\n                 } else {\n                     blocks.removeIndexBlock(index, block);\n                 }\n+                changed = true;", "originalCommit": "0729616f6112b7b3e700fadf22771ee12bd7f0b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0MDYyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r474140626", "bodyText": "I was focusing on the optimization for CCR. I've adjusted this in f43c2ea.", "author": "dnhatn", "createdAt": "2020-08-20T17:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0ODE0NQ=="}], "type": "inlineReview", "revised_code": {"commit": "f43c2ead444482eebbd402773e847eb1a9e086b6", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java\nindex cc1d635af66..32bb85f3f67 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java\n\n@@ -307,11 +307,16 @@ public class MetadataUpdateSettingsService {\n             final boolean updateBlock = setting.get(openSettings);\n             for (String index : actualIndices) {\n                 if (updateBlock) {\n-                    blocks.addIndexBlock(index, block);\n+                    if (blocks.hasIndexBlock(index, block) == false) {\n+                        blocks.addIndexBlock(index, block);\n+                        changed = true;\n+                    }\n                 } else {\n-                    blocks.removeIndexBlock(index, block);\n+                    if (blocks.hasIndexBlock(index, block)) {\n+                        blocks.removeIndexBlock(index, block);\n+                        changed = true;\n+                    }\n                 }\n-                changed = true;\n             }\n         }\n         return changed;\n"}}, {"oid": "b5d5f3b6e2f3aa4b76deeadd556b1df0b1e4b65e", "url": "https://github.com/elastic/elasticsearch/commit/b5d5f3b6e2f3aa4b76deeadd556b1df0b1e4b65e", "message": "Merge branch 'master' into noop-update-index", "committedDate": "2020-08-20T15:30:36Z", "type": "commit"}, {"oid": "f43c2ead444482eebbd402773e847eb1a9e086b6", "url": "https://github.com/elastic/elasticsearch/commit/f43c2ead444482eebbd402773e847eb1a9e086b6", "message": "detect noop in blocks", "committedDate": "2020-08-20T16:50:26Z", "type": "commit"}]}