{"pr_number": 61686, "pr_title": "Cleanly Handle S3 SDK Exceptions in Request Counting", "pr_createdAt": "2020-08-30T15:09:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61686", "timeline": [{"oid": "1139614f3be858b24801166ce9650304f5e3ebe1", "url": "https://github.com/elastic/elasticsearch/commit/1139614f3be858b24801166ce9650304f5e3ebe1", "message": "Cleanly Handle S3 SDK Exceptions in Request Counting\n\nIt looks like it is possible for a request to throw an exception early\nbefore any API interaciton has happened. This can lead to the request count\nmap containing a `null` for the request count key.\nThe assertion is not correct and we should not NPE here\n(as that might also hide the original exception since we are running this code in\na `finally` block from within the S3 SDK).\n\nCloses #61670", "committedDate": "2020-08-30T15:05:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479785173", "bodyText": "This has never happened on Cloud ever and I believe the original issue reporting this is likely some error with the credentials or an S3 SDK bug (can't reproduce it) but I still think we should log it as we really only get here if there's a problem.", "author": "original-brownbear", "createdAt": "2020-08-30T15:47:27Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "originalCommit": "1139614f3be858b24801166ce9650304f5e3ebe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk1MzgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479953801", "bodyText": "Yes, that seems strange. I took a quick glance to the SDK code and it seems like AWSRequestMetrics is created before the request is executed \ud83e\udd14 as long as the collector is enabled for that request.", "author": "fcofdez", "createdAt": "2020-08-31T07:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2MDMyNg==", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479960326", "bodyText": "seems like AWSRequestMetrics is created before the request is executed thinking\n\nThe problem is that the counter is only there if an actual request was executed. Now if there is some bug (like we had before with an NPE in some URL utility method in the SDK) or legitmate exception (maybe from auth/signing) before that we never get the expected counter itself.", "author": "original-brownbear", "createdAt": "2020-08-31T07:55:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw=="}], "type": "inlineReview", "revised_code": null}]}