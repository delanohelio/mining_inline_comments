{"pr_number": 63515, "pr_title": "Add support for missing value fetchers.", "pr_createdAt": "2020-10-08T22:25:07Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63515", "timeline": [{"oid": "53b39e4f9a0376c4cb610707d54c320371846ad2", "url": "https://github.com/elastic/elasticsearch/commit/53b39e4f9a0376c4cb610707d54c320371846ad2", "message": "Fetch values for text phrase and prefix field types.", "committedDate": "2020-10-08T22:06:41Z", "type": "commit"}, {"oid": "eca67f71ee33075ce53140d5f9c3f3bd07eaaa6b", "url": "https://github.com/elastic/elasticsearch/commit/eca67f71ee33075ce53140d5f9c3f3bd07eaaa6b", "message": "Fetch values for search_as_you_type field types.", "committedDate": "2020-10-08T22:06:44Z", "type": "commit"}, {"oid": "98ebee3c0bd56ac9f334c4ae68495741536dfe26", "url": "https://github.com/elastic/elasticsearch/commit/98ebee3c0bd56ac9f334c4ae68495741536dfe26", "message": "Fetch values for token_count.", "committedDate": "2020-10-08T23:09:32Z", "type": "commit"}, {"oid": "98ebee3c0bd56ac9f334c4ae68495741536dfe26", "url": "https://github.com/elastic/elasticsearch/commit/98ebee3c0bd56ac9f334c4ae68495741536dfe26", "message": "Fetch values for token_count.", "committedDate": "2020-10-08T23:09:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5MjA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63515#discussion_r503392097", "bodyText": "I think these should be fetching the value from their parent field?  name() is going to return the subfield name here, which won't be in the source.", "author": "romseygeek", "createdAt": "2020-10-12T16:01:33Z", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -376,7 +376,7 @@ public Query prefixQuery(String value, MultiTermQuery.RewriteMethod method, bool\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n-            throw new UnsupportedOperationException();\n+            return SourceValueFetcher.toString(name(), mapperService, format);", "originalCommit": "98ebee3c0bd56ac9f334c4ae68495741536dfe26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a49ccc48c088a16cb9b3654a82a6c90fffa7b052", "chunk": "diff --git a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\nindex 0b09b4a20c8..e65445b37e2 100644\n--- a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n+++ b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n\n@@ -376,6 +376,8 @@ public class SearchAsYouTypeFieldMapper extends ParametrizedFieldMapper {\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            // Because this internal field is modelled as a multi-field, SourceValueFetcher will look up its\n+            // parent field in _source. So we don't need to use the parent field name here.\n             return SourceValueFetcher.toString(name(), mapperService, format);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5MjI5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63515#discussion_r503392291", "bodyText": "Same comment as above, I think this needs to use the parent field name?", "author": "romseygeek", "createdAt": "2020-10-12T16:01:51Z", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -480,7 +480,7 @@ void setPrefixFieldType(PrefixFieldType prefixFieldType) {\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n-            throw new UnsupportedOperationException();\n+            return SourceValueFetcher.toString(name(), mapperService, format);", "originalCommit": "98ebee3c0bd56ac9f334c4ae68495741536dfe26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a49ccc48c088a16cb9b3654a82a6c90fffa7b052", "chunk": "diff --git a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\nindex 0b09b4a20c8..e65445b37e2 100644\n--- a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n+++ b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n\n@@ -480,6 +482,8 @@ public class SearchAsYouTypeFieldMapper extends ParametrizedFieldMapper {\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            // Because this internal field is modelled as a multi-field, SourceValueFetcher will look up its\n+            // parent field in _source. So we don't need to use the parent field name here.\n             return SourceValueFetcher.toString(name(), mapperService, format);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NDAyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63515#discussion_r503394029", "bodyText": "Same question here, this will try and retrieve the subfield from the source?", "author": "romseygeek", "createdAt": "2020-10-12T16:05:00Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -466,7 +466,7 @@ public String typeName() {\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n-            throw new UnsupportedOperationException();\n+            return SourceValueFetcher.toString(name(), mapperService, format);", "originalCommit": "98ebee3c0bd56ac9f334c4ae68495741536dfe26", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a49ccc48c088a16cb9b3654a82a6c90fffa7b052", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\nindex dad2ad63a72..282a012abbe 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n\n@@ -466,6 +466,8 @@ public class TextFieldMapper extends ParametrizedFieldMapper {\n \n         @Override\n         public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            // Because this internal field is modelled as a multi-field, SourceValueFetcher will look up its\n+            // parent field in _source. So we don't need to use the parent field name here.\n             return SourceValueFetcher.toString(name(), mapperService, format);\n         }\n \n"}}, {"oid": "a49ccc48c088a16cb9b3654a82a6c90fffa7b052", "url": "https://github.com/elastic/elasticsearch/commit/a49ccc48c088a16cb9b3654a82a6c90fffa7b052", "message": "Add comment on how internal text fields are handled.", "committedDate": "2020-10-12T20:09:29Z", "type": "commit"}, {"oid": "ccdb2499d6987500e2a35ff6a36431c177691b3b", "url": "https://github.com/elastic/elasticsearch/commit/ccdb2499d6987500e2a35ff6a36431c177691b3b", "message": "Add warning that MappedFieldType#valueFetcher should never throw.", "committedDate": "2020-10-12T20:09:30Z", "type": "commit"}]}