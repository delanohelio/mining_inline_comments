{"pr_number": 54407, "pr_title": "Avoid holding onto bulk items until all completed", "pr_createdAt": "2020-03-30T12:10:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54407", "timeline": [{"oid": "aec155c8c0747d68af2cce963f0ea66c05c1c75e", "url": "https://github.com/elastic/elasticsearch/commit/aec155c8c0747d68af2cce963f0ea66c05c1c75e", "message": "free memory for unused items", "committedDate": "2020-03-30T12:01:21Z", "type": "commit"}, {"oid": "14002998aaee3c512325c2cd0792d51a21fcde88", "url": "https://github.com/elastic/elasticsearch/commit/14002998aaee3c512325c2cd0792d51a21fcde88", "message": "alt impl.", "committedDate": "2020-03-30T14:04:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyMDg2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54407#discussion_r400220867", "bodyText": "NIT: no need for this to be volatile I think, you're only ever touching it on the thread that nulls it out?", "author": "original-brownbear", "createdAt": "2020-03-30T14:08:47Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -388,7 +388,7 @@ private long buildTookInMillis(long startTimeNanos) {\n      * */\n     private final class BulkOperation extends ActionRunnable<BulkResponse> {\n         private final Task task;\n-        private final BulkRequest bulkRequest;\n+        private volatile BulkRequest bulkRequest; // set to null once all requests are sent out", "originalCommit": "14002998aaee3c512325c2cd0792d51a21fcde88", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b306001962072ac9948c231f4d163619f90774ea", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java b/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java\nindex 140f0144c3d..c19cfc04dd0 100644\n--- a/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java\n\n@@ -388,7 +388,7 @@ public class TransportBulkAction extends HandledTransportAction<BulkRequest, Bul\n      * */\n     private final class BulkOperation extends ActionRunnable<BulkResponse> {\n         private final Task task;\n-        private volatile BulkRequest bulkRequest; // set to null once all requests are sent out\n+        private BulkRequest bulkRequest; // set to null once all requests are sent out\n         private final AtomicArray<BulkItemResponse> responses;\n         private final long startTimeNanos;\n         private final ClusterStateObserver observer;\n"}}, {"oid": "b306001962072ac9948c231f4d163619f90774ea", "url": "https://github.com/elastic/elasticsearch/commit/b306001962072ac9948c231f4d163619f90774ea", "message": "no volatile for you", "committedDate": "2020-03-30T14:11:07Z", "type": "commit"}]}