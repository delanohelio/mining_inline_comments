{"pr_number": 51888, "pr_title": "[ML] allow close/stop for jobs/datafeeds with missing configs", "pr_createdAt": "2020-02-04T20:45:28Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51888", "timeline": [{"oid": "4b825a6845bff20bcb6c84e16531bb98d516a723", "url": "https://github.com/elastic/elasticsearch/commit/4b825a6845bff20bcb6c84e16531bb98d516a723", "message": "[ML] allow close/stop for jobs/datafeeds with missing configs", "committedDate": "2020-02-04T19:04:30Z", "type": "commit"}, {"oid": "51f6ccc67c5a6fdcd7bafc5118fcfe0d4931b61c", "url": "https://github.com/elastic/elasticsearch/commit/51f6ccc67c5a6fdcd7bafc5118fcfe0d4931b61c", "message": "Merge branch 'master' into feature/ml-improve-behavior-if-configs-are-missing", "committedDate": "2020-02-04T21:13:52Z", "type": "commit"}, {"oid": "11388d440057551b321e686d29172ced8fd76af3", "url": "https://github.com/elastic/elasticsearch/commit/11388d440057551b321e686d29172ced8fd76af3", "message": "Merge branch 'master' into feature/ml-improve-behavior-if-configs-are-missing", "committedDate": "2020-02-05T12:11:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMTUyNA==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375231524", "bodyText": "I found the name of this method confusing, as I wondered why we only want started datafeeds, not all datafeeds with tasks.\nAfter investigating further I found that it does mean all datafeeds with tasks, whether they're started, stopping or failed, and that the naming is copied from the poorly named pre-existing method MlTasks.startedDatafeedIds().  But I don't think it's a good idea to propagate this poor naming any further, so please can you rename this to something along the lines of matchingDatafeedIdsWithTasks.\nI think it would also be clearer to rename datafeedIds to datafeedIdPatterns or datafeedIdsToMatch.  I found myself having to look at the calling code to find what datafeedIds was expected to contain.", "author": "droberts195", "createdAt": "2020-02-05T12:39:48Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java", "diffHunk": "@@ -478,6 +491,30 @@ private QueryBuilder buildDatafeedIdQuery(String [] tokens) {\n         return boolQueryBuilder;\n     }\n \n+    static Collection<String> matchingStartedDatafeedIds(String[] datafeedIds, PersistentTasksCustomMetaData tasksMetaData) {", "originalCommit": "11388d440057551b321e686d29172ced8fd76af3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NzA1MA==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375247050", "bodyText": "Definitely! I flip-flopped on the name a couple of times.", "author": "benwtrent", "createdAt": "2020-02-05T13:15:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMTUyNA=="}], "type": "inlineReview", "revised_code": {"commit": "cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java\nindex 9ccf0cd362e..379ba822bcc 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java\n\n@@ -491,22 +491,22 @@ public class DatafeedConfigProvider {\n         return boolQueryBuilder;\n     }\n \n-    static Collection<String> matchingStartedDatafeedIds(String[] datafeedIds, PersistentTasksCustomMetaData tasksMetaData) {\n+    static Collection<String> matchingDatafeedIdsWithTasks(String[] datafeedIdPatterns, PersistentTasksCustomMetaData tasksMetaData) {\n         Set<String> startedDatafeedIds = MlTasks.startedDatafeedIds(tasksMetaData);\n         if (startedDatafeedIds.isEmpty()) {\n             return Collections.emptyList()  ;\n         }\n-        if (Strings.isAllOrWildcard(datafeedIds)) {\n+        if (Strings.isAllOrWildcard(datafeedIdPatterns)) {\n             return startedDatafeedIds;\n         }\n \n         List<String> matchingDatafeedIds = new ArrayList<>();\n-        for (String datafeedId : datafeedIds) {\n-            if (startedDatafeedIds.contains(datafeedId))  {\n-                matchingDatafeedIds.add(datafeedId);\n-            } else if (Regex.isSimpleMatchPattern(datafeedId)) {\n+        for (String datafeedIdPattern : datafeedIdPatterns) {\n+            if (startedDatafeedIds.contains(datafeedIdPattern))  {\n+                matchingDatafeedIds.add(datafeedIdPattern);\n+            } else if (Regex.isSimpleMatchPattern(datafeedIdPattern)) {\n                 for (String startedDatafeedId : startedDatafeedIds) {\n-                    if (Regex.simpleMatch(datafeedId, startedDatafeedId)) {\n+                    if (Regex.simpleMatch(datafeedIdPattern, startedDatafeedId)) {\n                         matchingDatafeedIds.add(startedDatafeedId);\n                     }\n                 }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTM5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375245399", "bodyText": "I think it would be good to add a test of getting jobs stats for all jobs in a situation where one job has a config and the another doesn't.  It would be really bad if in the future a job with a task but no config caused a stats request for all jobs to completely fail.  This would make the jobs list in the UI go blank.", "author": "droberts195", "createdAt": "2020-02-05T13:11:21Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml.integration;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.ml.MlTasks;\n+import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n+import org.elasticsearch.xpack.core.ml.action.StopDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.datafeed.DatafeedConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.DataDescription;\n+import org.elasticsearch.xpack.core.ml.job.config.Detector;\n+import org.elasticsearch.xpack.core.ml.job.config.Job;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndexFields;\n+import org.junit.After;\n+\n+import java.util.Collections;\n+\n+import static org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.createDatafeedBuilder;\n+import static org.hamcrest.CoreMatchers.equalTo;\n+\n+public class JobAndDatafeedResilienceIT extends MlNativeAutodetectIntegTestCase {", "originalCommit": "11388d440057551b321e686d29172ced8fd76af3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NzI1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375247251", "bodyText": "@droberts195 will do", "author": "benwtrent", "createdAt": "2020-02-05T13:15:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTM5OQ=="}], "type": "inlineReview", "revised_code": {"commit": "cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java\nindex 937593a560e..d6de23ec687 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java\n\n@@ -9,6 +9,8 @@ import org.elasticsearch.ElasticsearchException;\n import org.elasticsearch.common.unit.TimeValue;\n import org.elasticsearch.xpack.core.ml.MlTasks;\n import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n+import org.elasticsearch.xpack.core.ml.action.GetDatafeedsStatsAction;\n+import org.elasticsearch.xpack.core.ml.action.GetJobsStatsAction;\n import org.elasticsearch.xpack.core.ml.action.StopDatafeedAction;\n import org.elasticsearch.xpack.core.ml.datafeed.DatafeedConfig;\n import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTgyMg==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375245822", "bodyText": "This logic isn't used in TransportGetDatafeedsStats.  Is there a good reason for that?", "author": "droberts195", "createdAt": "2020-02-05T13:12:23Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportGetJobsStatsAction.java", "diffHunk": "@@ -75,7 +75,10 @@ public TransportGetJobsStatsAction(TransportService transportService, ActionFilt\n     protected void doExecute(Task task, GetJobsStatsAction.Request request, ActionListener<GetJobsStatsAction.Response> finalListener) {\n         logger.debug(\"Get stats for job [{}]\", request.getJobId());\n \n-        jobConfigProvider.expandJobsIds(request.getJobId(), request.allowNoJobs(), true, ActionListener.wrap(\n+        ClusterState state = clusterService.state();\n+        PersistentTasksCustomMetaData tasks = state.getMetaData().custom(PersistentTasksCustomMetaData.TYPE);\n+        // If there are deleted configs, but the task is still around, we probably want to return the tasks in the stats call", "originalCommit": "11388d440057551b321e686d29172ced8fd76af3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0Nzk0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375247941", "bodyText": "TransportGetDatafeedsStats effectively requires the Datafeed config to exist because it returns stats related to the job, and there is now way to know the related job unless we have the config.\nSo, I can attempt to change the _stats call for datafeeds (which probably means null timing stats for those only with tasks), or I can remove this from job stats.\nWhat do you think?", "author": "benwtrent", "createdAt": "2020-02-05T13:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMyMjIzMA==", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375322230", "bodyText": "I think often TransportGetJobsStats will return empty stats if a task exists but no config.  This is because for jobs with tasks it redirects to the node running the task to get the stats, but this node then returns empty stats if there is no AutodetectCommunicator (see AutodetectProcessManager.getStatistics()).  So for consistency we might as well report a datafeed with no stats in TransportGetDatafeedsStats.  At least then that will alert us to the orphaned task when looking at a support diag bundle.", "author": "droberts195", "createdAt": "2020-02-05T15:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTgyMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "url": "https://github.com/elastic/elasticsearch/commit/cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "message": "making datafeed stats return tasks without configs as well", "committedDate": "2020-02-05T17:31:22Z", "type": "commit"}, {"oid": "a0a022f7534e6a31862382ab98e710cb79f1e570", "url": "https://github.com/elastic/elasticsearch/commit/a0a022f7534e6a31862382ab98e710cb79f1e570", "message": "erge branch 'feature/ml-improve-behavior-if-configs-are-missing' of github.com:benwtrent/elasticsearch into feature/ml-improve-behavior-if-configs-are-missing", "committedDate": "2020-02-05T17:31:30Z", "type": "commit"}, {"oid": "ec932d24d181d76775743fc6290a3c38bdd36ae5", "url": "https://github.com/elastic/elasticsearch/commit/ec932d24d181d76775743fc6290a3c38bdd36ae5", "message": "removing extraneous logging", "committedDate": "2020-02-05T17:34:07Z", "type": "commit"}]}