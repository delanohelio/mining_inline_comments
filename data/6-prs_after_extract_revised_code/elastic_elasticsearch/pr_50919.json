{"pr_number": 50919, "pr_title": "Secure password for monitoring HTTP exporter", "pr_createdAt": "2020-01-13T14:07:25Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50919", "timeline": [{"oid": "11f3d348fa1ca74558526d98cfe58a67a4f74ed2", "url": "https://github.com/elastic/elasticsearch/commit/11f3d348fa1ca74558526d98cfe58a67a4f74ed2", "message": "Secure monitoring password", "committedDate": "2020-01-13T14:00:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNjk4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r365906989", "bodyText": "there is an assumption that all the settings here are dynamic cluster settings.", "author": "albertzaharovits", "createdAt": "2020-01-13T16:42:43Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -868,6 +892,7 @@ public void doClose() {\n     public static List<Setting.AffixSetting<?>> getSettings() {\n         return Arrays.asList(HOST_SETTING, TEMPLATE_CREATE_LEGACY_VERSIONS_SETTING, AUTH_PASSWORD_SETTING, AUTH_USERNAME_SETTING,\n                 BULK_TIMEOUT_SETTING, CONNECTION_READ_TIMEOUT_SETTING, CONNECTION_TIMEOUT_SETTING, PIPELINE_CHECK_TIMEOUT_SETTING,\n-                PROXY_BASE_PATH_SETTING, SNIFF_ENABLED_SETTING, TEMPLATE_CHECK_TIMEOUT_SETTING, SSL_SETTING, HEADERS_SETTING);\n+                PROXY_BASE_PATH_SETTING, SNIFF_ENABLED_SETTING, TEMPLATE_CHECK_TIMEOUT_SETTING, SSL_SETTING, HEADERS_SETTING,\n+                SECURE_AUTH_PASSWORD_SETTING);\n     }", "originalCommit": "11f3d348fa1ca74558526d98cfe58a67a4f74ed2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkxMjY3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r365912677", "bodyText": "Ah, that explains it. Thank you, @albertzaharovits.", "author": "danhermann", "createdAt": "2020-01-13T16:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNjk4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "322e690abe16c6c31e9c44fa75a8e20b8f58c0fb", "chunk": "diff --git a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\nindex 7f72e099233..23363159c30 100644\n--- a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n+++ b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n\n@@ -889,10 +908,19 @@ public class HttpExporter extends Exporter {\n         }\n     }\n \n-    public static List<Setting.AffixSetting<?>> getSettings() {\n+    public static List<Setting.AffixSetting<?>> getDynamicSettings() {\n         return Arrays.asList(HOST_SETTING, TEMPLATE_CREATE_LEGACY_VERSIONS_SETTING, AUTH_PASSWORD_SETTING, AUTH_USERNAME_SETTING,\n                 BULK_TIMEOUT_SETTING, CONNECTION_READ_TIMEOUT_SETTING, CONNECTION_TIMEOUT_SETTING, PIPELINE_CHECK_TIMEOUT_SETTING,\n-                PROXY_BASE_PATH_SETTING, SNIFF_ENABLED_SETTING, TEMPLATE_CHECK_TIMEOUT_SETTING, SSL_SETTING, HEADERS_SETTING,\n-                SECURE_AUTH_PASSWORD_SETTING);\n+                PROXY_BASE_PATH_SETTING, SNIFF_ENABLED_SETTING, TEMPLATE_CHECK_TIMEOUT_SETTING, SSL_SETTING, HEADERS_SETTING);\n+    }\n+\n+    public static List<Setting.AffixSetting<?>> getSecureSettings() {\n+        return List.of(SECURE_AUTH_PASSWORD_SETTING);\n+    }\n+\n+    public static List<Setting.AffixSetting<?>> getSettings() {\n+        List<Setting.AffixSetting<?>> allSettings = new ArrayList<>(getDynamicSettings());\n+        allSettings.addAll(getSecureSettings());\n+        return allSettings;\n     }\n }\n"}}, {"oid": "13a1a3e36945856d7a87ced602757df091e1a517", "url": "https://github.com/elastic/elasticsearch/commit/13a1a3e36945856d7a87ced602757df091e1a517", "message": "fix tests", "committedDate": "2020-01-14T17:00:43Z", "type": "commit"}, {"oid": "d8bd711a9199c7681c5a4ec9bfe445f3df437205", "url": "https://github.com/elastic/elasticsearch/commit/d8bd711a9199c7681c5a4ec9bfe445f3df437205", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-14T17:34:47Z", "type": "commit"}, {"oid": "79e02679d3eaaf3405cbddefcb5d5c5c57170add", "url": "https://github.com/elastic/elasticsearch/commit/79e02679d3eaaf3405cbddefcb5d5c5c57170add", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-14T17:45:59Z", "type": "commit"}, {"oid": "322e690abe16c6c31e9c44fa75a8e20b8f58c0fb", "url": "https://github.com/elastic/elasticsearch/commit/322e690abe16c6c31e9c44fa75a8e20b8f58c0fb", "message": "making setting reloadable", "committedDate": "2020-01-15T03:36:34Z", "type": "commit"}, {"oid": "ce03cd19f914819f555bebdacf84585d7dd018ce", "url": "https://github.com/elastic/elasticsearch/commit/ce03cd19f914819f555bebdacf84585d7dd018ce", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-15T12:28:49Z", "type": "commit"}, {"oid": "25f9515bdebe62e8438c1d0cf43cc62c1825c5ae", "url": "https://github.com/elastic/elasticsearch/commit/25f9515bdebe62e8438c1d0cf43cc62c1825c5ae", "message": "fix reloading and test", "committedDate": "2020-01-15T18:06:38Z", "type": "commit"}, {"oid": "da29f4e409b4dba10cb2f8d31ad000bc3adf3dab", "url": "https://github.com/elastic/elasticsearch/commit/da29f4e409b4dba10cb2f8d31ad000bc3adf3dab", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-15T18:07:09Z", "type": "commit"}, {"oid": "a0e8064a7e949e504ee7aa2f956ed76fda8976ae", "url": "https://github.com/elastic/elasticsearch/commit/a0e8064a7e949e504ee7aa2f956ed76fda8976ae", "message": "handle deprecation warnings in integration tests", "committedDate": "2020-01-15T23:22:00Z", "type": "commit"}, {"oid": "4840a0f12c916cdd7ff5a11d00894895cc4acc7e", "url": "https://github.com/elastic/elasticsearch/commit/4840a0f12c916cdd7ff5a11d00894895cc4acc7e", "message": "checkstyle", "committedDate": "2020-01-15T23:53:19Z", "type": "commit"}, {"oid": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "url": "https://github.com/elastic/elasticsearch/commit/99811a2354763be25ce85ea5c7b8bd5bb933b654", "message": "accommodate either password in validation", "committedDate": "2020-01-17T21:17:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMjU3OA==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369222578", "bodyText": "Can you use a ConcurrentHashMap instead of explicit synchronization ?  perhaps : https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html#replace-K-V- ?", "author": "jakelandis", "createdAt": "2020-01-21T20:20:10Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -689,6 +694,29 @@ private static void configureTimeouts(final RestClientBuilder builder, final Con\n         builder.setRequestConfigCallback(new TimeoutRequestConfigCallback(connectTimeout, socketTimeout));\n     }\n \n+\n+    /**\n+     * Caches secure settings for use when dynamically configuring HTTP exporters\n+     * @param settings settings used for configuring HTTP exporter\n+     * @return names of HTTP exporters whose secure settings changed, if any\n+     */\n+    public static List<String> loadSettings(Settings settings) {\n+        final List<String> changedExporters = new ArrayList<>();\n+        for (final String namespace : SECURE_AUTH_PASSWORD_SETTING.getNamespaces(settings)) {\n+            final Setting<?> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n+            final String password = s.get(settings).toString();\n+            String existingPassword;\n+            synchronized (SECURE_AUTH_PASSWORDS) {", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY5OTYyMw==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369699623", "bodyText": "I tried using ConcurrentHashMap to avoid explicit locking but ConcurrentHashMap::replace() works only if there is an existing entry for the specified key. I need the K-V entry to be set whether there was an existing entry or not.", "author": "danhermann", "createdAt": "2020-01-22T17:29:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMjU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcyMDI4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369720286", "bodyText": "Simple ConcurrentHashMap::put() should work here - it does return previous value and sets entry whether there was one before or not", "author": "probakowski", "createdAt": "2020-01-22T18:11:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMjU3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcyNTEyNA==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369725124", "bodyText": "Ah, right, that will work here.", "author": "danhermann", "createdAt": "2020-01-22T18:21:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMjU3OA=="}], "type": "inlineReview", "revised_code": {"commit": "ceb13b3af65899df728ed9cc4e7eff37ed818954", "chunk": "diff --git a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\nindex f3a96b88916..c71ac97440f 100644\n--- a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n+++ b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n\n@@ -703,14 +703,10 @@ public class HttpExporter extends Exporter {\n     public static List<String> loadSettings(Settings settings) {\n         final List<String> changedExporters = new ArrayList<>();\n         for (final String namespace : SECURE_AUTH_PASSWORD_SETTING.getNamespaces(settings)) {\n-            final Setting<?> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n-            final String password = s.get(settings).toString();\n-            String existingPassword;\n-            synchronized (SECURE_AUTH_PASSWORDS) {\n-                existingPassword = SECURE_AUTH_PASSWORDS.get(namespace);\n-                SECURE_AUTH_PASSWORDS.put(namespace, password);\n-            }\n-            if (password.equals(existingPassword) == false) {\n+            final Setting<SecureString> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n+            final SecureString securePassword = s.get(settings);\n+            final SecureString existingPassword = SECURE_AUTH_PASSWORDS.put(namespace, securePassword);\n+            if (securePassword.equals(existingPassword) == false) {\n                 changedExporters.add(namespace);\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzMDA3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369230079", "bodyText": "If you use a ConcurrentHashMap for SECURE_AUTH_PASSWORDS you should be able to use getOrDefault instead of explicit synchronization.", "author": "jakelandis", "createdAt": "2020-01-21T20:37:19Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -700,7 +728,13 @@ private static void configureTimeouts(final RestClientBuilder builder, final Con\n     @Nullable\n     private static CredentialsProvider createCredentialsProvider(final Config config) {\n         final String username = AUTH_USERNAME_SETTING.getConcreteSettingForNamespace(config.name()).get(config.settings());\n-        final String password = AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(config.name()).get(config.settings());\n+\n+        String password;\n+        synchronized (SECURE_AUTH_PASSWORDS) {", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ceb13b3af65899df728ed9cc4e7eff37ed818954", "chunk": "diff --git a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\nindex f3a96b88916..c71ac97440f 100644\n--- a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n+++ b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n\n@@ -729,12 +725,10 @@ public class HttpExporter extends Exporter {\n     private static CredentialsProvider createCredentialsProvider(final Config config) {\n         final String username = AUTH_USERNAME_SETTING.getConcreteSettingForNamespace(config.name()).get(config.settings());\n \n-        String password;\n-        synchronized (SECURE_AUTH_PASSWORDS) {\n-            password = SECURE_AUTH_PASSWORDS.containsKey(config.name())\n-                ? SECURE_AUTH_PASSWORDS.get(config.name())\n-                : AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(config.name()).get(config.settings());\n-        }\n+        final SecureString securePassword = SECURE_AUTH_PASSWORDS.get(config.name());\n+        final String password = securePassword == null\n+            ? AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(config.name()).get(config.settings())\n+            : securePassword.toString();\n \n         final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();\n         credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(username, password));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNTA3NA==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369235074", "bodyText": "Passwords as String should be avoided where possible due to help avoid leaking to heap since gc happens when ever it feel like it. I think you can use SecureString instead and then close it out to ensure it zero'd out when you are done.\nAlso since it looks like you are using this for equality, can you just hash it and store the hash in the map ?", "author": "jakelandis", "createdAt": "2020-01-21T20:48:34Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -401,6 +405,7 @@ public void validate(String password, Map<Setting<?>, Object> settings) {\n      */\n     private final AtomicBoolean clusterAlertsAllowed = new AtomicBoolean(false);\n \n+    private static final Map<String, String> SECURE_AUTH_PASSWORDS = new HashMap<>();", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwNDEyMA==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369704120", "bodyText": "I could change it to a Map<String, SecureString> but I couldn't close any of the SecureString instances because the HTTP exporter has to be recreated (so I need the full value, not just an equality check) any time any of its settings, whether secure or not, change. Unfortunately, this is unavoidable for settings that are both secure and reloadable since the keystore itself is not accessible outside of node startup and reload events. The security folks directed me to\n\n  \n    \n      elasticsearch/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/notification/NotificationService.java\n    \n    \n        Lines 167 to 225\n      in\n      c3b5f71\n    \n    \n    \n    \n\n        \n          \n                * Extracts the {@link SecureSettings}` out of the passed in {@link Settings} object. The {@code Setting} argument has to have the \n        \n\n        \n          \n                * {@code SecureSettings} open/available. Normally {@code SecureSettings} are available only under specific callstacks (eg. during node \n        \n\n        \n          \n                * initialization or during a `reload` call). The returned copy can be reused freely as it will never be closed (this is a bit of \n        \n\n        \n          \n                * cheating, but it is necessary in this specific circumstance). Only works for secure settings of type string (not file). \n        \n\n        \n          \n                *  \n        \n\n        \n          \n                * @param source \n        \n\n        \n          \n                *            A {@code Settings} object with its {@code SecureSettings} open/available. \n        \n\n        \n          \n                * @param securePluginSettings \n        \n\n        \n          \n                *            The list of settings to copy. \n        \n\n        \n          \n                * @return A copy of the {@code SecureSettings} of the passed in {@code Settings} argument. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               private static SecureSettings extractSecureSettings(Settings source, List<Setting<?>> securePluginSettings) \n        \n\n        \n          \n                       throws GeneralSecurityException { \n        \n\n        \n          \n                   // get the secure settings out \n        \n\n        \n          \n                   final SecureSettings sourceSecureSettings = Settings.builder().put(source, true).getSecureSettings(); \n        \n\n        \n          \n                   // filter and cache them... \n        \n\n        \n          \n                   final Map<String, Tuple<SecureString, byte[]>> cache = new HashMap<>(); \n        \n\n        \n          \n                   if (sourceSecureSettings != null && securePluginSettings != null) { \n        \n\n        \n          \n                       for (final String settingKey : sourceSecureSettings.getSettingNames()) { \n        \n\n        \n          \n                           for (final Setting<?> secureSetting : securePluginSettings) { \n        \n\n        \n          \n                               if (secureSetting.match(settingKey)) { \n        \n\n        \n          \n                                   cache.put(settingKey, \n        \n\n        \n          \n                                           new Tuple<>(sourceSecureSettings.getString(settingKey), sourceSecureSettings.getSHA256Digest(settingKey))); \n        \n\n        \n          \n                               } \n        \n\n        \n          \n                           } \n        \n\n        \n          \n                       } \n        \n\n        \n          \n                   } \n        \n\n        \n          \n                   return new SecureSettings() { \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public boolean isLoaded() { \n        \n\n        \n          \n                           return true; \n        \n\n        \n          \n                       } \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public SecureString getString(String setting) { \n        \n\n        \n          \n                           return cache.get(setting).v1(); \n        \n\n        \n          \n                       } \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public Set<String> getSettingNames() { \n        \n\n        \n          \n                           return cache.keySet(); \n        \n\n        \n          \n                       } \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public InputStream getFile(String setting) { \n        \n\n        \n          \n                           throw new IllegalStateException(\"A NotificationService setting cannot be File.\"); \n        \n\n        \n          \n                       } \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public byte[] getSHA256Digest(String setting) { \n        \n\n        \n          \n                           return cache.get(setting).v2(); \n        \n\n        \n          \n                       } \n        \n\n        \n          \n            \n        \n\n        \n          \n                       @Override \n        \n\n        \n          \n                       public void close() throws IOException { \n        \n\n        \n          \n                       } \n        \n\n        \n          \n                   }; \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nwhere they did essentially the same thing for the secure settings in watcher notifications.", "author": "danhermann", "createdAt": "2020-01-22T17:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzNTA3NA=="}], "type": "inlineReview", "revised_code": {"commit": "ceb13b3af65899df728ed9cc4e7eff37ed818954", "chunk": "diff --git a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\nindex f3a96b88916..c71ac97440f 100644\n--- a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n+++ b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n\n@@ -405,7 +405,7 @@ public class HttpExporter extends Exporter {\n      */\n     private final AtomicBoolean clusterAlertsAllowed = new AtomicBoolean(false);\n \n-    private static final Map<String, String> SECURE_AUTH_PASSWORDS = new HashMap<>();\n+    private static final ConcurrentHashMap<String, SecureString> SECURE_AUTH_PASSWORDS = new ConcurrentHashMap<>();\n     private final ThreadContext threadContext;\n     private final DateFormatter dateTimeFormatter;\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzODgxNA==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369238814", "bodyText": "Can you leave a quick comment here (maybe with a GH issue link?) to why you can not validate the password is set ?", "author": "jakelandis", "createdAt": "2020-01-21T20:57:14Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -232,8 +227,7 @@ public void validate(final String username, final Map<Setting<?>, Object> settin\n                                         HttpExporter.AUTH_USERNAME_SETTING.getConcreteSetting(key));\n \n                                 final List<Setting<?>> settings = List.of(", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIzODk5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369238995", "bodyText": "ditto about SecureString", "author": "jakelandis", "createdAt": "2020-01-21T20:57:37Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -689,6 +694,29 @@ private static void configureTimeouts(final RestClientBuilder builder, final Con\n         builder.setRequestConfigCallback(new TimeoutRequestConfigCallback(connectTimeout, socketTimeout));\n     }\n \n+\n+    /**\n+     * Caches secure settings for use when dynamically configuring HTTP exporters\n+     * @param settings settings used for configuring HTTP exporter\n+     * @return names of HTTP exporters whose secure settings changed, if any\n+     */\n+    public static List<String> loadSettings(Settings settings) {\n+        final List<String> changedExporters = new ArrayList<>();\n+        for (final String namespace : SECURE_AUTH_PASSWORD_SETTING.getNamespaces(settings)) {\n+            final Setting<?> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n+            final String password = s.get(settings).toString();", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ceb13b3af65899df728ed9cc4e7eff37ed818954", "chunk": "diff --git a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\nindex f3a96b88916..c71ac97440f 100644\n--- a/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n+++ b/x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java\n\n@@ -703,14 +703,10 @@ public class HttpExporter extends Exporter {\n     public static List<String> loadSettings(Settings settings) {\n         final List<String> changedExporters = new ArrayList<>();\n         for (final String namespace : SECURE_AUTH_PASSWORD_SETTING.getNamespaces(settings)) {\n-            final Setting<?> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n-            final String password = s.get(settings).toString();\n-            String existingPassword;\n-            synchronized (SECURE_AUTH_PASSWORDS) {\n-                existingPassword = SECURE_AUTH_PASSWORDS.get(namespace);\n-                SECURE_AUTH_PASSWORDS.put(namespace, password);\n-            }\n-            if (password.equals(existingPassword) == false) {\n+            final Setting<SecureString> s = SECURE_AUTH_PASSWORD_SETTING.getConcreteSettingForNamespace(namespace);\n+            final SecureString securePassword = s.get(settings);\n+            final SecureString existingPassword = SECURE_AUTH_PASSWORDS.put(namespace, securePassword);\n+            if (securePassword.equals(existingPassword) == false) {\n                 changedExporters.add(namespace);\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1NzI2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369257267", "bodyText": "Do plugins get reloaded when the secure settings change ?", "author": "jakelandis", "createdAt": "2020-01-21T21:39:59Z", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/Monitoring.java", "diffHunk": "@@ -178,4 +180,13 @@ boolean isEnabled() {\n         final String exportersKey = \"xpack.monitoring.exporters.\";\n         return List.of(exportersKey + \"*.auth.*\", exportersKey + \"*.ssl.*\");\n     }\n+\n+    @Override\n+    public void reload(Settings settings) throws Exception {", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwNjMxMw==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369706313", "bodyText": "Plugins that implement ReloadablePlugin have their reload methods called any time the reload_secure_settings endpoint is called.", "author": "danhermann", "createdAt": "2020-01-22T17:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1NzI2Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2NDA4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/50919#discussion_r369264081", "bodyText": "Could you add some unit tests for changing the secure setting and ensure it is changed (or no-op) as well as trying to set this for a non-http type setting ? See org.elasticsearch.xpack.watcher.notification.NotificationService for some examples.\nIdeally, we would also have Integration tests, but I didn't see any framework already setup to read from the keystore for a Integration tests (and an almost complete lack of Rest tests) :(", "author": "jakelandis", "createdAt": "2020-01-21T21:55:25Z", "path": "x-pack/plugin/monitoring/src/test/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporterTests.java", "diffHunk": "@@ -346,6 +349,10 @@ public void testCreateRestClient() throws IOException {\n \n         // doesn't explode\n         HttpExporter.createRestClient(config, sslService, listener).close();\n+        if (useBasicAuth) {\n+            assertWarnings(\"[xpack.monitoring.exporters._http.auth.password] setting was deprecated in Elasticsearch and will be \" +\n+                \"removed in a future release! See the breaking changes documentation for the next major version.\");\n+        }\n     }\n ", "originalCommit": "99811a2354763be25ce85ea5c7b8bd5bb933b654", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "ceb13b3af65899df728ed9cc4e7eff37ed818954", "url": "https://github.com/elastic/elasticsearch/commit/ceb13b3af65899df728ed9cc4e7eff37ed818954", "message": "switch to ConcurrentHashMap", "committedDate": "2020-01-22T19:58:01Z", "type": "commit"}, {"oid": "e158752235337d652dad740d85b5995175537917", "url": "https://github.com/elastic/elasticsearch/commit/e158752235337d652dad740d85b5995175537917", "message": "add comment about validation", "committedDate": "2020-01-22T20:23:40Z", "type": "commit"}, {"oid": "15624ab316eba7fc871e1280aa0e705512861e6e", "url": "https://github.com/elastic/elasticsearch/commit/15624ab316eba7fc871e1280aa0e705512861e6e", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-22T20:24:47Z", "type": "commit"}, {"oid": "e6be3460a30861e8fd177472308a265d1b95ae30", "url": "https://github.com/elastic/elasticsearch/commit/e6be3460a30861e8fd177472308a265d1b95ae30", "message": "remove obsolete test", "committedDate": "2020-01-23T12:33:47Z", "type": "commit"}, {"oid": "b8f8cbe75cdb3b3527b4fb85cfadb6642d0f7f71", "url": "https://github.com/elastic/elasticsearch/commit/b8f8cbe75cdb3b3527b4fb85cfadb6642d0f7f71", "message": "integration test that reloads secure password", "committedDate": "2020-01-24T23:48:10Z", "type": "commit"}, {"oid": "8f9c13c9a4ac489ba8b4eed4335903e02fea67c4", "url": "https://github.com/elastic/elasticsearch/commit/8f9c13c9a4ac489ba8b4eed4335903e02fea67c4", "message": "Merge branch 'master' into 50197_secure_password", "committedDate": "2020-01-24T23:48:38Z", "type": "commit"}, {"oid": "c6258675e4a5d3f2906c6a2d71a20219509130f3", "url": "https://github.com/elastic/elasticsearch/commit/c6258675e4a5d3f2906c6a2d71a20219509130f3", "message": "rename setting and update docs", "committedDate": "2020-01-25T00:12:05Z", "type": "commit"}, {"oid": "9e3a59164521c88474996348e227cfa89d74a55e", "url": "https://github.com/elastic/elasticsearch/commit/9e3a59164521c88474996348e227cfa89d74a55e", "message": "add new tests", "committedDate": "2020-01-27T17:04:35Z", "type": "commit"}, {"oid": "a7974e774aa4a974eaeadeadda7d65b82e5f548e", "url": "https://github.com/elastic/elasticsearch/commit/a7974e774aa4a974eaeadeadda7d65b82e5f548e", "message": "log warning if both secure password and deprecated password are supplied", "committedDate": "2020-01-28T22:30:34Z", "type": "commit"}, {"oid": "1252a8a872079f2bc0c13976cab5cb6fe0f2aabf", "url": "https://github.com/elastic/elasticsearch/commit/1252a8a872079f2bc0c13976cab5cb6fe0f2aabf", "message": "Update docs/reference/settings/monitoring-settings.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>", "committedDate": "2020-01-29T17:20:48Z", "type": "commit"}, {"oid": "9019ab5fdb289a94cf3df23652881b042ce27019", "url": "https://github.com/elastic/elasticsearch/commit/9019ab5fdb289a94cf3df23652881b042ce27019", "message": "Update docs/reference/settings/monitoring-settings.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>", "committedDate": "2020-01-29T17:23:41Z", "type": "commit"}, {"oid": "5f97171d21508dabef1b20fa58b2d2f3482ad1a7", "url": "https://github.com/elastic/elasticsearch/commit/5f97171d21508dabef1b20fa58b2d2f3482ad1a7", "message": "add link from reloadable settings page to monitoring settings page", "committedDate": "2020-01-29T17:29:46Z", "type": "commit"}, {"oid": "3ccd9e94e2454d86fc55380bbd53b7cd2c191c1c", "url": "https://github.com/elastic/elasticsearch/commit/3ccd9e94e2454d86fc55380bbd53b7cd2c191c1c", "message": "update docs", "committedDate": "2020-01-29T17:47:46Z", "type": "commit"}]}