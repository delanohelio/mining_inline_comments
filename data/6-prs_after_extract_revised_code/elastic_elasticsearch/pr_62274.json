{"pr_number": 62274, "pr_title": "Fix NPE when deleting multiple backing indices on a data stream", "pr_createdAt": "2020-09-11T15:09:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62274", "timeline": [{"oid": "80de32071ea54a5448f48bb6e7a61d16a3e2a950", "url": "https://github.com/elastic/elasticsearch/commit/80de32071ea54a5448f48bb6e7a61d16a3e2a950", "message": "Fix NPE when deleting multiple backing indices on a data stream", "committedDate": "2020-09-11T15:07:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc3OTYyNw==", "url": "https://github.com/elastic/elasticsearch/pull/62274#discussion_r487779627", "bodyText": "I think numBackingIndices needs to be changed into numBackingIndices - 1, otherwise the test tries to delete the write index which would fail.", "author": "martijnvg", "createdAt": "2020-09-14T09:36:02Z", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java", "diffHunk": "@@ -129,6 +132,29 @@ public void testDeleteBackingIndexForDataStream() {\n             DataStream.getDefaultBackingIndexName(dataStreamName, numIndexToDelete)), IsNull.nullValue());\n     }\n \n+    public void testDeleteMultipleBackingIndexForDataStream() {\n+        int numBackingIndices = randomIntBetween(3, 5);\n+        int numBackingIndicesToDelete = randomIntBetween(2, numBackingIndices - 1);\n+        String dataStreamName = randomAlphaOfLength(6).toLowerCase(Locale.ROOT);\n+        ClusterState before = DataStreamTestHelper.getClusterStateWithDataStreams(\n+            List.of(new Tuple<>(dataStreamName, numBackingIndices)), List.of());\n+\n+        List<Integer> indexNumbersToDelete =\n+            randomSubsetOf(numBackingIndicesToDelete, IntStream.rangeClosed(1, numBackingIndices).boxed().collect(Collectors.toList()));", "originalCommit": "80de32071ea54a5448f48bb6e7a61d16a3e2a950", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ffd5b070ab2a9dd5d80eee6529270ff0f63514c4", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java b/server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java\nindex 7975a8763d3..c42dfff26b0 100644\n--- a/server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/cluster/metadata/MetadataDeleteIndexServiceTests.java\n\n@@ -140,7 +140,7 @@ public class MetadataDeleteIndexServiceTests extends ESTestCase {\n             List.of(new Tuple<>(dataStreamName, numBackingIndices)), List.of());\n \n         List<Integer> indexNumbersToDelete =\n-            randomSubsetOf(numBackingIndicesToDelete, IntStream.rangeClosed(1, numBackingIndices).boxed().collect(Collectors.toList()));\n+            randomSubsetOf(numBackingIndicesToDelete, IntStream.rangeClosed(1, numBackingIndices - 1).boxed().collect(Collectors.toList()));\n \n         Set<Index> indicesToDelete = new HashSet<>();\n         for (int k : indexNumbersToDelete) {\n"}}, {"oid": "aa381fe5084ca26bd36e1304f14c16b512bdc9e6", "url": "https://github.com/elastic/elasticsearch/commit/aa381fe5084ca26bd36e1304f14c16b512bdc9e6", "message": "Merge branch 'master' into 62272_npe_when_deleting_multiple_backing_indices", "committedDate": "2020-09-14T12:23:56Z", "type": "commit"}, {"oid": "ffd5b070ab2a9dd5d80eee6529270ff0f63514c4", "url": "https://github.com/elastic/elasticsearch/commit/ffd5b070ab2a9dd5d80eee6529270ff0f63514c4", "message": "review comments", "committedDate": "2020-09-14T12:26:11Z", "type": "commit"}, {"oid": "51a140ad2d59d0ea9ac43bc74f27d9eef8948590", "url": "https://github.com/elastic/elasticsearch/commit/51a140ad2d59d0ea9ac43bc74f27d9eef8948590", "message": "fix test", "committedDate": "2020-09-14T16:28:50Z", "type": "commit"}, {"oid": "09b22e6a54c4ff51824a27d6df1d1b097f1df061", "url": "https://github.com/elastic/elasticsearch/commit/09b22e6a54c4ff51824a27d6df1d1b097f1df061", "message": "checkstyle", "committedDate": "2020-09-14T16:47:33Z", "type": "commit"}]}