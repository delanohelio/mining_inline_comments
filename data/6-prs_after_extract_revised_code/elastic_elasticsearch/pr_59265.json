{"pr_number": 59265, "pr_title": "Scripting: Move script_cache into _nodes/stats", "pr_createdAt": "2020-07-09T00:46:06Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59265", "timeline": [{"oid": "9ae6941acd66881a5c1fedbb1043d7f8c0fad38e", "url": "https://github.com/elastic/elasticsearch/commit/9ae6941acd66881a5c1fedbb1043d7f8c0fad38e", "message": "Scripting: Remove general cache settings\n\nRemoved settings:\n * `script.cache.max_size`\n * `script.cache.expire`\n * `script.max_compilations_rate`\n\nRefs: #50152", "committedDate": "2020-07-09T00:03:29Z", "type": "commit"}, {"oid": "47f04b9d528be62445baae8bf244ac6b26d6bd3e", "url": "https://github.com/elastic/elasticsearch/commit/47f04b9d528be62445baae8bf244ac6b26d6bd3e", "message": "Scripting: Move script_cache into _nodes/stats\n\nUpdated `_nodes/stats`:\n * Remove `script_cache`\n * Update `script` in `_node/stats` to include stats per context:\n\n```\n      \"script\": {\n        \"compilations\": 1,\n        \"cache_evictions\": 0,\n        \"compilation_limit_triggered\": 0,\n        \"contexts\":[\n          {\n            \"context\": \"aggregation_selector\",\n            \"compilations\": 0,\n            \"cache_evictions\": 0,\n            \"compilation_limit_triggered\": 0\n          },\n\n```\n\nRefs: #50152", "committedDate": "2020-07-09T00:34:34Z", "type": "commit"}, {"oid": "632ad72d25c456d096169be18441c04addff9993", "url": "https://github.com/elastic/elasticsearch/commit/632ad72d25c456d096169be18441c04addff9993", "message": "Add new ContextStats and StatsTests", "committedDate": "2020-07-09T00:52:43Z", "type": "commit"}, {"oid": "2257f3b1226328df271de161d2f8fe1a84efb241", "url": "https://github.com/elastic/elasticsearch/commit/2257f3b1226328df271de161d2f8fe1a84efb241", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__07__node-stats", "committedDate": "2020-07-09T12:51:28Z", "type": "commit"}, {"oid": "390332d8e2a129487785fc282f3c6b102d1a73a8", "url": "https://github.com/elastic/elasticsearch/commit/390332d8e2a129487785fc282f3c6b102d1a73a8", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__07__node-stats", "committedDate": "2020-07-09T13:18:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NjYwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/59265#discussion_r452386601", "bodyText": "deserializedScriptCacheStats -> deserializedScriptStats", "author": "stu-elastic", "createdAt": "2020-07-09T17:44:46Z", "path": "server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java", "diffHunk": "@@ -241,11 +243,35 @@ public void testSerialization() throws IOException {\n                     }\n                 }\n                 ScriptStats scriptStats = nodeStats.getScriptStats();\n+                ScriptStats deserializedScriptCacheStats = deserializedNodeStats.getScriptStats();", "originalCommit": "390332d8e2a129487785fc282f3c6b102d1a73a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec3558619a883f9bf5f295bdfa2ac8116d4d12ae", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java b/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\nindex 1efeb644188..8ca7cf3b3b7 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\n\n@@ -243,11 +243,11 @@ public class NodeStatsTests extends ESTestCase {\n                     }\n                 }\n                 ScriptStats scriptStats = nodeStats.getScriptStats();\n-                ScriptStats deserializedScriptCacheStats = deserializedNodeStats.getScriptStats();\n+                ScriptStats deserializedScriptStats = deserializedNodeStats.getScriptStats();\n                 if (scriptStats == null) {\n-                    assertNull(deserializedScriptCacheStats);\n+                    assertNull(deserializedScriptStats);\n                 } else {\n-                    List<ScriptContextStats> deserialized = deserializedScriptCacheStats.getContextStats();\n+                    List<ScriptContextStats> deserialized = deserializedScriptStats.getContextStats();\n                     long evictions = 0;\n                     long limited = 0;\n                     long compilations = 0;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4NzU5NA==", "url": "https://github.com/elastic/elasticsearch/pull/59265#discussion_r452387594", "bodyText": "Add indent back.", "author": "stu-elastic", "createdAt": "2020-07-09T17:46:34Z", "path": "server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java", "diffHunk": "@@ -514,20 +525,10 @@ public static NodeStats createNodeStats() {\n             }\n             adaptiveSelectionStats = new AdaptiveSelectionStats(nodeConnections, nodeStats);\n         }\n-        ScriptCacheStats scriptCacheStats = null;\n-        if (frequently()) {\n-            int numContents = randomIntBetween(0, 20);\n-            Map<String,ScriptStats> stats = new HashMap<>(numContents);\n-            for (int i = 0; i < numContents; i++) {\n-                String context = randomValueOtherThanMany(stats::containsKey, () -> randomAlphaOfLength(12));\n-                stats.put(context, new ScriptStats(randomLongBetween(0, 1024), randomLongBetween(0, 1024), randomLongBetween(0, 1024)));\n-            }\n-            scriptCacheStats = new ScriptCacheStats(stats);\n-        }\n         //TODO NodeIndicesStats are not tested here, way too complicated to create, also they need to be migrated to Writeable yet\n         return new NodeStats(node, randomNonNegativeLong(), null, osStats, processStats, jvmStats, threadPoolStats,\n-                fsInfo, transportStats, httpStats, allCircuitBreakerStats, scriptStats, discoveryStats,\n-                ingestStats, adaptiveSelectionStats, scriptCacheStats);\n+            fsInfo, transportStats, httpStats, allCircuitBreakerStats, scriptStats, discoveryStats,", "originalCommit": "390332d8e2a129487785fc282f3c6b102d1a73a8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "ec3558619a883f9bf5f295bdfa2ac8116d4d12ae", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java b/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\nindex 1efeb644188..8ca7cf3b3b7 100644\n--- a/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/admin/cluster/node/stats/NodeStatsTests.java\n\n@@ -527,8 +527,8 @@ public class NodeStatsTests extends ESTestCase {\n         }\n         //TODO NodeIndicesStats are not tested here, way too complicated to create, also they need to be migrated to Writeable yet\n         return new NodeStats(node, randomNonNegativeLong(), null, osStats, processStats, jvmStats, threadPoolStats,\n-            fsInfo, transportStats, httpStats, allCircuitBreakerStats, scriptStats, discoveryStats,\n-            ingestStats, adaptiveSelectionStats);\n+                fsInfo, transportStats, httpStats, allCircuitBreakerStats, scriptStats, discoveryStats,\n+                ingestStats, adaptiveSelectionStats);\n     }\n \n     private IngestStats.Stats getPipelineStats(List<IngestStats.PipelineStat> pipelineStats, String id) {\n"}}, {"oid": "0d79d707026fe6579e0f67800df61b0e19f76b24", "url": "https://github.com/elastic/elasticsearch/commit/0d79d707026fe6579e0f67800df61b0e19f76b24", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__07__node-stats", "committedDate": "2020-07-09T18:26:11Z", "type": "commit"}, {"oid": "ec3558619a883f9bf5f295bdfa2ac8116d4d12ae", "url": "https://github.com/elastic/elasticsearch/commit/ec3558619a883f9bf5f295bdfa2ac8116d4d12ae", "message": "rename deserializedScriptStats, remove dedent", "committedDate": "2020-07-09T18:35:19Z", "type": "commit"}, {"oid": "e47541b55501298a09d9760c54d7771a1b28f137", "url": "https://github.com/elastic/elasticsearch/commit/e47541b55501298a09d9760c54d7771a1b28f137", "message": "indent ScriptServiceTests", "committedDate": "2020-07-09T18:37:21Z", "type": "commit"}]}