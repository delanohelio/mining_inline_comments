{"pr_number": 63618, "pr_title": "Move geometry indexer to FieldMapper", "pr_createdAt": "2020-10-13T14:36:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63618", "timeline": [{"oid": "f1b65b016e0ae9bbffde45f750aefcf934722b37", "url": "https://github.com/elastic/elasticsearch/commit/f1b65b016e0ae9bbffde45f750aefcf934722b37", "message": "Convert WildcardFieldMapper to parametrized form", "committedDate": "2020-10-08T10:57:15Z", "type": "commit"}, {"oid": "8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "url": "https://github.com/elastic/elasticsearch/commit/8a0721199dc68b96d6c2f3ab9ff4de73717d2f13", "message": "Merge branch 'master' into mapper/wildcard", "committedDate": "2020-10-13T10:02:37Z", "type": "commit"}, {"oid": "7c2190defd42a57fd2385f6cc5a85ff5f3138506", "url": "https://github.com/elastic/elasticsearch/commit/7c2190defd42a57fd2385f6cc5a85ff5f3138506", "message": "Merge remote-tracking branch 'origin/master' into mapper/wildcard", "committedDate": "2020-10-13T12:46:00Z", "type": "commit"}, {"oid": "ec7517c10d0ed3babef383df130d3dd9293b475a", "url": "https://github.com/elastic/elasticsearch/commit/ec7517c10d0ed3babef383df130d3dd9293b475a", "message": "Merge remote-tracking branch 'romseygeek/mapper/wildcard' into mapper/wildcard", "committedDate": "2020-10-13T12:46:16Z", "type": "commit"}, {"oid": "a8e3e8ebf8e9b599d213fc69063cb0f856653550", "url": "https://github.com/elastic/elasticsearch/commit/a8e3e8ebf8e9b599d213fc69063cb0f856653550", "message": "Move indexer and parser to FieldMapper; clean up generics", "committedDate": "2020-10-13T14:10:41Z", "type": "commit"}, {"oid": "b7c9eb3bb058c19becaba7d310be6b9ccf9178df", "url": "https://github.com/elastic/elasticsearch/commit/b7c9eb3bb058c19becaba7d310be6b9ccf9178df", "message": "Merge remote-tracking branch 'origin/master' into mapper/geometries", "committedDate": "2020-10-13T14:31:16Z", "type": "commit"}, {"oid": "01a4555e3f235c2a47ed7b4382e2fb6bfd07e9c2", "url": "https://github.com/elastic/elasticsearch/commit/01a4555e3f235c2a47ed7b4382e2fb6bfd07e9c2", "message": "oops", "committedDate": "2020-10-13T15:03:53Z", "type": "commit"}, {"oid": "ef422c3fae000840f2f2a12d51d4e1a9523fd0c5", "url": "https://github.com/elastic/elasticsearch/commit/ef422c3fae000840f2f2a12d51d4e1a9523fd0c5", "message": "erk", "committedDate": "2020-10-13T15:30:47Z", "type": "commit"}, {"oid": "7ee10983c1c8fa550fefe8896957b3bbea1d1231", "url": "https://github.com/elastic/elasticsearch/commit/7ee10983c1c8fa550fefe8896957b3bbea1d1231", "message": "Merge remote-tracking branch 'origin/master' into mapper/geometries", "committedDate": "2020-10-13T16:33:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5NDY1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63618#discussion_r504494655", "bodyText": "Can we share the same parser for the type and the mapper? I think we are doing that in other places.", "author": "iverase", "createdAt": "2020-10-14T08:27:18Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java", "diffHunk": "@@ -257,11 +257,10 @@ private void setupPrefixTrees(GeoShapeFieldType ft) {\n         }\n \n         private GeoShapeFieldType buildFieldType(BuilderContext context) {\n-            GeoShapeFieldType ft = new GeoShapeFieldType(buildFullName(context), indexed, fieldType.stored(), false, meta);\n+            GeoShapeFieldType ft =\n+                new GeoShapeFieldType(buildFullName(context), indexed, fieldType.stored(), false, new LegacyGeoShapeParser(), meta);", "originalCommit": "7ee10983c1c8fa550fefe8896957b3bbea1d1231", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c68e4953cddc0bb34e4471a70881b2585afe02d3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java\nindex ec3cbe9f2b7..707b6f0f827 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java\n\n@@ -256,9 +256,9 @@ public class LegacyGeoShapeFieldMapper extends AbstractShapeGeometryFieldMapper<\n             ft.defaultPrefixTreeStrategy.setPointsOnly(ft.pointsOnly());\n         }\n \n-        private GeoShapeFieldType buildFieldType(BuilderContext context) {\n+        private GeoShapeFieldType buildFieldType(LegacyGeoShapeParser parser, BuilderContext context) {\n             GeoShapeFieldType ft =\n-                new GeoShapeFieldType(buildFullName(context), indexed, fieldType.stored(), false, new LegacyGeoShapeParser(), meta);\n+                new GeoShapeFieldType(buildFullName(context), indexed, fieldType.stored(), false, parser, meta);\n             setupFieldTypeDeprecatedParameters(ft);\n             setupPrefixTrees(ft);\n             ft.setOrientation(orientation == null ? Defaults.ORIENTATION.value() : orientation);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ5NTA1NA==", "url": "https://github.com/elastic/elasticsearch/pull/63618#discussion_r504495054", "bodyText": "Same as above, probably only used by the test.", "author": "iverase", "createdAt": "2020-10-14T08:27:54Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java", "diffHunk": "@@ -326,13 +326,14 @@ public Object format(ShapeBuilder<?, ?, ?> value, String format) {\n \n         private final LegacyGeoShapeQueryProcessor queryProcessor;\n \n-        private GeoShapeFieldType(String name, boolean indexed, boolean stored, boolean hasDocValues, Map<String, String> meta) {\n-            super(name, indexed, stored, hasDocValues, false, meta);\n+        private GeoShapeFieldType(String name, boolean indexed, boolean stored, boolean hasDocValues,\n+                                  LegacyGeoShapeParser parser, Map<String, String> meta) {\n+            super(name, indexed, stored, hasDocValues, false, parser, meta);\n             this.queryProcessor = new LegacyGeoShapeQueryProcessor(this);\n         }\n \n         public GeoShapeFieldType(String name) {\n-            this(name, true, false, true, Collections.emptyMap());\n+            this(name, true, false, true, null, Collections.emptyMap());", "originalCommit": "7ee10983c1c8fa550fefe8896957b3bbea1d1231", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwMjUwNw==", "url": "https://github.com/elastic/elasticsearch/pull/63618#discussion_r504502507", "bodyText": "Note to myself: This constructor is public because it used by a test. It should probably be private but let address it in a follow up PR.", "author": "iverase", "createdAt": "2020-10-14T08:39:10Z", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/ShapeFieldMapper.java", "diffHunk": "@@ -76,13 +76,14 @@ public Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public static final class ShapeFieldType extends AbstractShapeGeometryFieldType<Geometry, Geometry>\n+    public static final class ShapeFieldType extends AbstractShapeGeometryFieldType\n         implements ShapeQueryable {\n \n         private final ShapeQueryProcessor queryProcessor;\n \n-        public ShapeFieldType(String name, boolean indexed, boolean stored, boolean hasDocValues, Map<String, String> meta) {\n-            super(name, indexed, stored, hasDocValues, false, meta);\n+        public ShapeFieldType(String name, boolean indexed, boolean stored, boolean hasDocValues,\n+                              Parser<Geometry> parser, Map<String, String> meta) {", "originalCommit": "7ee10983c1c8fa550fefe8896957b3bbea1d1231", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "c68e4953cddc0bb34e4471a70881b2585afe02d3", "url": "https://github.com/elastic/elasticsearch/commit/c68e4953cddc0bb34e4471a70881b2585afe02d3", "message": "Share parser between mapper and fieldtype", "committedDate": "2020-10-14T08:50:53Z", "type": "commit"}, {"oid": "2f3471fec62d38f8b471b474117cb9b95aae3470", "url": "https://github.com/elastic/elasticsearch/commit/2f3471fec62d38f8b471b474117cb9b95aae3470", "message": "Merge remote-tracking branch 'origin/master' into mapper/geometries", "committedDate": "2020-10-14T08:51:24Z", "type": "commit"}]}