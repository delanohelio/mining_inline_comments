{"pr_number": 53978, "pr_title": "Reduce performance impact of ExitableDirectoryReader", "pr_createdAt": "2020-03-23T13:48:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53978", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2NjYwNA==", "url": "https://github.com/elastic/elasticsearch/pull/53978#discussion_r396466604", "bodyText": "I don't think we should throttle this. We don't have enough evidence that it's slowing down the request so I'd keep it as is for now.", "author": "jimczi", "createdAt": "2020-03-23T13:53:22Z", "path": "server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java", "diffHunk": "@@ -276,7 +276,7 @@ public void visit(int docID, byte[] packedValue) throws IOException {\n \n         @Override\n         public PointValues.Relation compare(byte[] minPackedValue, byte[] maxPackedValue) {\n-            queryCancellation.checkCancelled();\n+            checkAndThrowWithSampling();", "originalCommit": "828ca8a13796219890be46aa914061ada0a106e6", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java b/server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java\nindex 5306738f862..e6b5737480f 100644\n--- a/server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java\n+++ b/server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java\n\n@@ -276,7 +276,7 @@ class ExitableDirectoryReader extends FilterDirectoryReader {\n \n         @Override\n         public PointValues.Relation compare(byte[] minPackedValue, byte[] maxPackedValue) {\n-            checkAndThrowWithSampling();\n+            queryCancellation.checkCancelled();\n             return in.compare(minPackedValue, maxPackedValue);\n         }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2ODkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/53978#discussion_r396468924", "bodyText": "We use the cancellable  even if the low level cancellation is set to false (query timeout option and bulk scorer) so we should never set the cancellable to null ?", "author": "jimczi", "createdAt": "2020-03-23T13:56:33Z", "path": "server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java", "diffHunk": "@@ -82,18 +82,14 @@\n     private MutableQueryTimeout cancellable;\n \n     public ContextIndexSearcher(IndexReader reader, Similarity similarity,\n-                                QueryCache queryCache, QueryCachingPolicy queryCachingPolicy) throws IOException {\n-        this(reader, similarity, queryCache, queryCachingPolicy, new MutableQueryTimeout());\n+                                QueryCache queryCache, QueryCachingPolicy queryCachingPolicy,\n+                                boolean wrapWithExitableDirReader) throws IOException {\n+        this(reader, similarity, queryCache, queryCachingPolicy, wrapWithExitableDirReader ? new MutableQueryTimeout() : null);", "originalCommit": "828ca8a13796219890be46aa914061ada0a106e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3MjcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/53978#discussion_r396472723", "bodyText": "Yep, sure, I just pushed it to check some other compilation stuff. it's not ready yet, but thx!", "author": "matriv", "createdAt": "2020-03-23T14:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2ODkyNA=="}], "type": "inlineReview", "revised_code": {"commit": "8f23bc76a7cab3840bd9d9861066bb48f56054bd", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java b/server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java\nindex 70d179caa71..ed41939b1cb 100644\n--- a/server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java\n+++ b/server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java\n\n@@ -83,18 +83,19 @@ public class ContextIndexSearcher extends IndexSearcher {\n \n     public ContextIndexSearcher(IndexReader reader, Similarity similarity,\n                                 QueryCache queryCache, QueryCachingPolicy queryCachingPolicy,\n-                                boolean wrapWithExitableDirReader) throws IOException {\n-        this(reader, similarity, queryCache, queryCachingPolicy, wrapWithExitableDirReader ? new MutableQueryTimeout() : null);\n+                                boolean wrapWithExitableDirectoryReader) throws IOException {\n+        this(reader, similarity, queryCache, queryCachingPolicy, new MutableQueryTimeout(), wrapWithExitableDirectoryReader);\n     }\n \n     private ContextIndexSearcher(IndexReader reader, Similarity similarity,\n                                  QueryCache queryCache, QueryCachingPolicy queryCachingPolicy,\n-                                 MutableQueryTimeout cancellable) throws IOException {\n-        super(cancellable != null ? new ExitableDirectoryReader((DirectoryReader) reader, cancellable) : reader);\n+                                 MutableQueryTimeout cancellable,\n+                                 boolean wrapWithExitableDirectoryReader) throws IOException {\n+        super(wrapWithExitableDirectoryReader ? new ExitableDirectoryReader((DirectoryReader) reader, cancellable) : reader);\n         setSimilarity(similarity);\n         setQueryCache(queryCache);\n         setQueryCachingPolicy(queryCachingPolicy);\n-        this.cancellable = cancellable != null ? cancellable : new MutableQueryTimeout();\n+        this.cancellable = cancellable;\n     }\n \n     public void setProfiler(QueryProfiler profiler) {\n"}}, {"oid": "8f23bc76a7cab3840bd9d9861066bb48f56054bd", "url": "https://github.com/elastic/elasticsearch/commit/8f23bc76a7cab3840bd9d9861066bb48f56054bd", "message": "Reduce performance impact of ExitableDirectoryReader\n\nBenchmarking showed that the effect of the ExitableDirectoryReader\nis reduced considerably when checking every 4095 docs. Moreover,\nset the cancellable task before calling QueryPhase.preProcess()\nand make sure we don't wrap with an ExitableDirectoryReader at all\nwhen lowLevelCancellation() is set to false to avoid completely any\nperformance impact.\n\nFollows: #52822\nFollows: #53166\nFollows: #53496", "committedDate": "2020-03-23T16:35:38Z", "type": "commit"}, {"oid": "8f23bc76a7cab3840bd9d9861066bb48f56054bd", "url": "https://github.com/elastic/elasticsearch/commit/8f23bc76a7cab3840bd9d9861066bb48f56054bd", "message": "Reduce performance impact of ExitableDirectoryReader\n\nBenchmarking showed that the effect of the ExitableDirectoryReader\nis reduced considerably when checking every 4095 docs. Moreover,\nset the cancellable task before calling QueryPhase.preProcess()\nand make sure we don't wrap with an ExitableDirectoryReader at all\nwhen lowLevelCancellation() is set to false to avoid completely any\nperformance impact.\n\nFollows: #52822\nFollows: #53166\nFollows: #53496", "committedDate": "2020-03-23T16:35:38Z", "type": "forcePushed"}, {"oid": "8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea", "url": "https://github.com/elastic/elasticsearch/commit/8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea", "message": "revert throttling in compare", "committedDate": "2020-03-23T16:53:26Z", "type": "commit"}, {"oid": "f32491949d699823e784d06f0a2b1da22056d2a8", "url": "https://github.com/elastic/elasticsearch/commit/f32491949d699823e784d06f0a2b1da22056d2a8", "message": "change to 8191", "committedDate": "2020-03-23T17:05:10Z", "type": "commit"}]}