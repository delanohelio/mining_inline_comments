{"pr_number": 51267, "pr_title": "[ML][Inference] fixing ingest IT tests", "pr_createdAt": "2020-01-21T19:31:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51267", "timeline": [{"oid": "d3e51d5cb9c6fbf162f32f869ccd1d111d48cb23", "url": "https://github.com/elastic/elasticsearch/commit/d3e51d5cb9c6fbf162f32f869ccd1d111d48cb23", "message": "[ML][Inference] fixing ingest IT tests", "committedDate": "2020-01-21T19:09:26Z", "type": "commit"}, {"oid": "c4d6115e383a28488e35dd6989c1927ff282dce6", "url": "https://github.com/elastic/elasticsearch/commit/c4d6115e383a28488e35dd6989c1927ff282dce6", "message": "Merge branch 'master' into feature/ml-inference-fix-issue-51201", "committedDate": "2020-01-21T20:00:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwODEyNg==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369408126", "bodyText": "Could you add a comment explaining how does changing MlNativeAutodetectIntegTestCase to ESRestTestCase solve the issue this PR is supposed to solve?\nIf I were to write a new IT test, how would I know which base class should I use?", "author": "przemekwitek", "createdAt": "2020-01-22T07:45:37Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -5,141 +5,107 @@\n  */\n package org.elasticsearch.xpack.ml.integration;\n \n-import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n-import org.elasticsearch.action.ingest.SimulateDocumentBaseResult;\n-import org.elasticsearch.action.ingest.SimulatePipelineResponse;\n-import org.elasticsearch.action.search.SearchRequest;\n-import org.elasticsearch.common.bytes.BytesArray;\n-import org.elasticsearch.common.xcontent.DeprecationHandler;\n+import org.apache.http.util.EntityUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n import org.elasticsearch.common.xcontent.XContentHelper;\n-import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.index.query.QueryBuilders;\n-import org.elasticsearch.search.builder.SearchSourceBuilder;\n-import org.elasticsearch.xpack.core.ml.action.DeleteTrainedModelAction;\n-import org.elasticsearch.xpack.core.ml.action.PutTrainedModelAction;\n+import org.elasticsearch.test.SecuritySettingsSourceField;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n import org.elasticsearch.xpack.core.ml.inference.MlInferenceNamedXContentProvider;\n-import org.elasticsearch.xpack.core.ml.inference.TrainedModelConfig;\n+import org.elasticsearch.xpack.core.ml.integration.MlRestTestStateCleaner;\n import org.junit.After;\n import org.junit.Before;\n \n import java.io.IOException;\n-import java.nio.charset.StandardCharsets;\n import java.util.HashMap;\n-import java.util.List;\n import java.util.Map;\n \n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.Matchers.equalTo;\n-import static org.hamcrest.Matchers.is;\n \n-public class InferenceIngestIT extends MlNativeAutodetectIntegTestCase {\n+public class InferenceIngestIT extends ESRestTestCase {", "originalCommit": "c4d6115e383a28488e35dd6989c1927ff282dce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyODI2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369528266", "bodyText": "@przemekwitek there are cleanups and cluster state requirements in MlNativeAutodetectIntegTestCase which are causing problems. Something with how ingest pipeline _simulate works is disallowing cleanups to occur (has nothing to do with our code). I attempted to troubleshoot, but it started to turn into wasted time.\nSo, instead, I moved to REST cases instead.", "author": "benwtrent", "createdAt": "2020-01-22T12:21:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwODEyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNDQ5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369534493", "bodyText": "Could you add at least one sentence in class-level comment? Just in an unlikely case someone does a rewrite of this test to MlNativeAutodetectIntegTestCase in a year from now not remembering there was an issue.", "author": "przemekwitek", "createdAt": "2020-01-22T12:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwODEyNg=="}], "type": "inlineReview", "revised_code": {"commit": "17226fb257bc64b4cb151ec01f3b968a1631612c", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\nindex 33d88d77df2..db8418b5a9d 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n\n@@ -48,11 +48,6 @@ public class InferenceIngestIT extends ESRestTestCase {\n         client().performRequest(request);\n     }\n \n-    public void clearMlState() throws Exception {\n-        new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n-        ESRestTestCase.waitForPendingTasks(adminClient());\n-    }\n-\n     @Override\n     protected Settings restClientSettings() {\n         return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", BASIC_AUTH_VALUE_SUPER_USER).build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwOTQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369409451", "bodyText": "Do you plan to use this method in other places?\nIf not, you can either inline it into cleanUpData or make it private.", "author": "przemekwitek", "createdAt": "2020-01-22T07:50:13Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -5,141 +5,107 @@\n  */\n package org.elasticsearch.xpack.ml.integration;\n \n-import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n-import org.elasticsearch.action.ingest.SimulateDocumentBaseResult;\n-import org.elasticsearch.action.ingest.SimulatePipelineResponse;\n-import org.elasticsearch.action.search.SearchRequest;\n-import org.elasticsearch.common.bytes.BytesArray;\n-import org.elasticsearch.common.xcontent.DeprecationHandler;\n+import org.apache.http.util.EntityUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n import org.elasticsearch.common.xcontent.XContentHelper;\n-import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.index.query.QueryBuilders;\n-import org.elasticsearch.search.builder.SearchSourceBuilder;\n-import org.elasticsearch.xpack.core.ml.action.DeleteTrainedModelAction;\n-import org.elasticsearch.xpack.core.ml.action.PutTrainedModelAction;\n+import org.elasticsearch.test.SecuritySettingsSourceField;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n import org.elasticsearch.xpack.core.ml.inference.MlInferenceNamedXContentProvider;\n-import org.elasticsearch.xpack.core.ml.inference.TrainedModelConfig;\n+import org.elasticsearch.xpack.core.ml.integration.MlRestTestStateCleaner;\n import org.junit.After;\n import org.junit.Before;\n \n import java.io.IOException;\n-import java.nio.charset.StandardCharsets;\n import java.util.HashMap;\n-import java.util.List;\n import java.util.Map;\n \n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.Matchers.equalTo;\n-import static org.hamcrest.Matchers.is;\n \n-public class InferenceIngestIT extends MlNativeAutodetectIntegTestCase {\n+public class InferenceIngestIT extends ESRestTestCase {\n+\n+    private static final String BASIC_AUTH_VALUE_SUPER_USER =\n+        basicAuthHeaderValue(\"x_pack_rest_user\", SecuritySettingsSourceField.TEST_PASSWORD_SECURE_STRING);\n \n     @Before\n     public void createBothModels() throws Exception {\n-        client().execute(PutTrainedModelAction.INSTANCE, new PutTrainedModelAction.Request(buildClassificationModel())).actionGet();\n-        client().execute(PutTrainedModelAction.INSTANCE, new PutTrainedModelAction.Request(buildRegressionModel())).actionGet();\n+        Request request = new Request(\"PUT\", \"_ml/inference/test_classification\");\n+        request.setJsonEntity(CLASSIFICATION_CONFIG);\n+        client().performRequest(request);\n+\n+        request = new Request(\"PUT\", \"_ml/inference/test_regression\");\n+        request.setJsonEntity(REGRESSION_CONFIG);\n+        client().performRequest(request);\n+    }\n+\n+    public void clearMlState() throws Exception {", "originalCommit": "c4d6115e383a28488e35dd6989c1927ff282dce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ0MTAyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369441021", "bodyText": "I think there should be a wider rethink of the cleanup methods.\nMlNativeAutodetectIntegTestCase extends MlNativeIntegTestCase, and MlNativeIntegTestCase already has an @After method that calls the abstract method cleanUpResources() then waits for pending tasks.\nSince this clearMlState() method also waits for pending tasks that means we're waiting twice, which will slow down the cleanup.  If possible I would prefer that we only wait for pending tasks once, at the very end of all cleanup operations.\n@benwtrent please can you try to integrate your cleanup into the MlNativeIntegTestCase framework, by overriding cleanUpResources().  And if that doesn't work for some reason and multiple cleanup phases are required please add some comments explaining what the full sequence is and why a simpler sequence doesn't work.  (For example, I can imagine there might be something annoying like the ML annotations index being created part way through the cleanup, but if you found that problem and worked around it it would be good to document that this can happen so that the next maintainer can take it into account.)", "author": "droberts195", "createdAt": "2020-01-22T09:11:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwOTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzMTQ1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369531453", "bodyText": "@droberts195 I don't understand\n\nSince this clearMlState() method also waits for pending tasks that means we're waiting twice, which will slow down the cleanup.\n\nThis test class is now inheriting from ESRestTestCase which does not wait for tasks to finish.\nThis clean up code is the same we use for other ESRestTestCase classes.\nMlNativeIntegTestCase already does something similar (see: \n  \n    \n      elasticsearch/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java\n    \n    \n         Line 128\n      in\n      d2aee62\n    \n    \n    \n    \n\n        \n          \n           cleanUpResources(); \n        \n    \n  \n\n)\nAs for the issues I originally had that prompted this change to ESRestTestCase, the issue has nothing to do with any code paths that the ML team has written. It even occurred with the set processor. So, adjusting our cleanup process would do nothing.\n@przemekwitek\n\nDo you plan to use this method in other places?\n\nI could make it private", "author": "benwtrent", "createdAt": "2020-01-22T12:28:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwOTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUzNTg5NA==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369535894", "bodyText": "Sorry, I must have been colour blind when reading the diff.", "author": "droberts195", "createdAt": "2020-01-22T12:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQwOTQ1MQ=="}], "type": "inlineReview", "revised_code": {"commit": "17226fb257bc64b4cb151ec01f3b968a1631612c", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\nindex 33d88d77df2..db8418b5a9d 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n\n@@ -48,11 +48,6 @@ public class InferenceIngestIT extends ESRestTestCase {\n         client().performRequest(request);\n     }\n \n-    public void clearMlState() throws Exception {\n-        new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n-        ESRestTestCase.waitForPendingTasks(adminClient());\n-    }\n-\n     @Override\n     protected Settings restClientSettings() {\n         return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", BASIC_AUTH_VALUE_SUPER_USER).build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMDg5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369410893", "bodyText": "Before the isAcknowledged bit was being checked. Would it be possible to add an equivalent check in the new setting?", "author": "przemekwitek", "createdAt": "2020-01-22T07:54:37Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -5,141 +5,107 @@\n  */\n package org.elasticsearch.xpack.ml.integration;\n \n-import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n-import org.elasticsearch.action.ingest.SimulateDocumentBaseResult;\n-import org.elasticsearch.action.ingest.SimulatePipelineResponse;\n-import org.elasticsearch.action.search.SearchRequest;\n-import org.elasticsearch.common.bytes.BytesArray;\n-import org.elasticsearch.common.xcontent.DeprecationHandler;\n+import org.apache.http.util.EntityUtils;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n import org.elasticsearch.common.xcontent.XContentHelper;\n-import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.index.query.QueryBuilder;\n import org.elasticsearch.index.query.QueryBuilders;\n-import org.elasticsearch.search.builder.SearchSourceBuilder;\n-import org.elasticsearch.xpack.core.ml.action.DeleteTrainedModelAction;\n-import org.elasticsearch.xpack.core.ml.action.PutTrainedModelAction;\n+import org.elasticsearch.test.SecuritySettingsSourceField;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n import org.elasticsearch.xpack.core.ml.inference.MlInferenceNamedXContentProvider;\n-import org.elasticsearch.xpack.core.ml.inference.TrainedModelConfig;\n+import org.elasticsearch.xpack.core.ml.integration.MlRestTestStateCleaner;\n import org.junit.After;\n import org.junit.Before;\n \n import java.io.IOException;\n-import java.nio.charset.StandardCharsets;\n import java.util.HashMap;\n-import java.util.List;\n import java.util.Map;\n \n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n import static org.hamcrest.CoreMatchers.containsString;\n-import static org.hamcrest.Matchers.equalTo;\n-import static org.hamcrest.Matchers.is;\n \n-public class InferenceIngestIT extends MlNativeAutodetectIntegTestCase {\n+public class InferenceIngestIT extends ESRestTestCase {\n+\n+    private static final String BASIC_AUTH_VALUE_SUPER_USER =\n+        basicAuthHeaderValue(\"x_pack_rest_user\", SecuritySettingsSourceField.TEST_PASSWORD_SECURE_STRING);\n \n     @Before\n     public void createBothModels() throws Exception {\n-        client().execute(PutTrainedModelAction.INSTANCE, new PutTrainedModelAction.Request(buildClassificationModel())).actionGet();\n-        client().execute(PutTrainedModelAction.INSTANCE, new PutTrainedModelAction.Request(buildRegressionModel())).actionGet();\n+        Request request = new Request(\"PUT\", \"_ml/inference/test_classification\");\n+        request.setJsonEntity(CLASSIFICATION_CONFIG);\n+        client().performRequest(request);\n+\n+        request = new Request(\"PUT\", \"_ml/inference/test_regression\");\n+        request.setJsonEntity(REGRESSION_CONFIG);\n+        client().performRequest(request);\n+    }\n+\n+    public void clearMlState() throws Exception {\n+        new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n+        ESRestTestCase.waitForPendingTasks(adminClient());\n+    }\n+\n+    @Override\n+    protected Settings restClientSettings() {\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", BASIC_AUTH_VALUE_SUPER_USER).build();\n     }\n \n     @After\n-    public void deleteBothModels() {\n-        client().execute(DeleteTrainedModelAction.INSTANCE, new DeleteTrainedModelAction.Request(\"test_classification\")).actionGet();\n-        client().execute(DeleteTrainedModelAction.INSTANCE, new DeleteTrainedModelAction.Request(\"test_regression\")).actionGet();\n+    public void cleanUpData() throws Exception {\n+        clearMlState();\n+        client().performRequest(new Request(\"DELETE\", \"_ml/inference/test_classification\"));\n+        client().performRequest(new Request(\"DELETE\", \"_ml/inference/test_regression\"));\n     }\n \n     public void testPipelineCreationAndDeletion() throws Exception {\n \n         for (int i = 0; i < 10; i++) {\n-            assertThat(client().admin().cluster().preparePutPipeline(\"simple_classification_pipeline\",\n-                new BytesArray(CLASSIFICATION_PIPELINE.getBytes(StandardCharsets.UTF_8)),\n-                XContentType.JSON).get().isAcknowledged(), is(true));\n-\n-            client().prepareIndex(\"index_for_inference_test\")\n-                .setSource(new HashMap<>(){{\n-                    put(\"col1\", randomFrom(\"female\", \"male\"));\n-                    put(\"col2\", randomFrom(\"S\", \"M\", \"L\", \"XL\"));\n-                    put(\"col3\", randomFrom(\"true\", \"false\", \"none\", \"other\"));\n-                    put(\"col4\", randomIntBetween(0, 10));\n-                }})\n-                .setPipeline(\"simple_classification_pipeline\")\n-                .get();\n-\n-            assertThat(client().admin().cluster().prepareDeletePipeline(\"simple_classification_pipeline\").get().isAcknowledged(),\n-                is(true));\n-\n-            assertThat(client().admin().cluster().preparePutPipeline(\"simple_regression_pipeline\",\n-                new BytesArray(REGRESSION_PIPELINE.getBytes(StandardCharsets.UTF_8)),\n-                XContentType.JSON).get().isAcknowledged(), is(true));\n-\n-            client().prepareIndex(\"index_for_inference_test\")\n-                .setSource(new HashMap<>(){{\n-                    put(\"col1\", randomFrom(\"female\", \"male\"));\n-                    put(\"col2\", randomFrom(\"S\", \"M\", \"L\", \"XL\"));\n-                    put(\"col3\", randomFrom(\"true\", \"false\", \"none\", \"other\"));\n-                    put(\"col4\", randomIntBetween(0, 10));\n-                }})\n-                .setPipeline(\"simple_regression_pipeline\")\n-                .get();\n-\n-            assertThat(client().admin().cluster().prepareDeletePipeline(\"simple_regression_pipeline\").get().isAcknowledged(),\n-                is(true));\n-        }\n+            client().performRequest(putPipeline(\"simple_classification_pipeline\", CLASSIFICATION_PIPELINE));\n+            client().performRequest(indexRequest(\"index_for_inference_test\", \"simple_classification_pipeline\", generateSourceDoc()));\n+            client().performRequest(new Request(\"DELETE\", \"_ingest/pipeline/simple_classification_pipeline\"));\n \n-        assertThat(client().admin().cluster().preparePutPipeline(\"simple_classification_pipeline\",\n-            new BytesArray(CLASSIFICATION_PIPELINE.getBytes(StandardCharsets.UTF_8)),\n-            XContentType.JSON).get().isAcknowledged(), is(true));\n+            client().performRequest(putPipeline(\"simple_regression_pipeline\", REGRESSION_PIPELINE));\n+            client().performRequest(indexRequest(\"index_for_inference_test\", \"simple_regression_pipeline\", generateSourceDoc()));\n+            client().performRequest(new Request(\"DELETE\", \"_ingest/pipeline/simple_regression_pipeline\"));\n+        }\n \n-        assertThat(client().admin().cluster().preparePutPipeline(\"simple_regression_pipeline\",\n-            new BytesArray(REGRESSION_PIPELINE.getBytes(StandardCharsets.UTF_8)),\n-            XContentType.JSON).get().isAcknowledged(), is(true));\n+        client().performRequest(putPipeline(\"simple_classification_pipeline\", CLASSIFICATION_PIPELINE));\n+        client().performRequest(putPipeline(\"simple_regression_pipeline\", REGRESSION_PIPELINE));\n \n         for (int i = 0; i < 10; i++) {\n-            client().prepareIndex(\"index_for_inference_test\")\n-                .setSource(generateSourceDoc())\n-                .setPipeline(\"simple_classification_pipeline\")\n-                .get();\n-\n-            client().prepareIndex(\"index_for_inference_test\")\n-                .setSource(generateSourceDoc())\n-                .setPipeline(\"simple_regression_pipeline\")\n-                .get();\n+            client().performRequest(indexRequest(\"index_for_inference_test\", \"simple_classification_pipeline\", generateSourceDoc()));\n+            client().performRequest(indexRequest(\"index_for_inference_test\", \"simple_regression_pipeline\", generateSourceDoc()));\n         }\n \n-        assertThat(client().admin().cluster().prepareDeletePipeline(\"simple_classification_pipeline\").get().isAcknowledged(),\n-            is(true));\n-\n-        assertThat(client().admin().cluster().prepareDeletePipeline(\"simple_regression_pipeline\").get().isAcknowledged(),\n-            is(true));\n-\n-        client().admin().indices().refresh(new RefreshRequest(\"index_for_inference_test\")).get();\n-\n-        assertThat(client().search(new SearchRequest().indices(\"index_for_inference_test\")\n-                .source(new SearchSourceBuilder()\n-                    .size(0)\n-                    .trackTotalHits(true)\n-                    .query(QueryBuilders.boolQuery()\n-                        .filter(\n-                            QueryBuilders.existsQuery(\"ml.inference.regression.predicted_value\"))))).get().getHits().getTotalHits().value,\n-            equalTo(20L));\n-\n-        assertThat(client().search(new SearchRequest().indices(\"index_for_inference_test\")\n-                .source(new SearchSourceBuilder()\n-                    .size(0)\n-                    .trackTotalHits(true)\n-                    .query(QueryBuilders.boolQuery()\n-                        .filter(\n-                            QueryBuilders.existsQuery(\"ml.inference.classification.predicted_value\")))))\n-                .get()\n-                .getHits()\n-                .getTotalHits()\n-                .value,\n-            equalTo(20L));\n+        client().performRequest(new Request(\"DELETE\", \"_ingest/pipeline/simple_regression_pipeline\"));\n+        client().performRequest(new Request(\"DELETE\", \"_ingest/pipeline/simple_classification_pipeline\"));", "originalCommit": "c4d6115e383a28488e35dd6989c1927ff282dce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyODYwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369528601", "bodyText": "I could, but it is not really required as anything other than a 200 will throw.", "author": "benwtrent", "createdAt": "2020-01-22T12:21:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMDg5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "17226fb257bc64b4cb151ec01f3b968a1631612c", "chunk": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\nindex 33d88d77df2..db8418b5a9d 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java\n\n@@ -48,11 +48,6 @@ public class InferenceIngestIT extends ESRestTestCase {\n         client().performRequest(request);\n     }\n \n-    public void clearMlState() throws Exception {\n-        new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n-        ESRestTestCase.waitForPendingTasks(adminClient());\n-    }\n-\n     @Override\n     protected Settings restClientSettings() {\n         return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", BASIC_AUTH_VALUE_SUPER_USER).build();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMjQ1NA==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369412454", "bodyText": "Is this a standard practice in REST tests to grep for substrings rather than parsing the response into JSON?", "author": "przemekwitek", "createdAt": "2020-01-22T07:59:32Z", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -181,15 +147,10 @@ public void testSimulate() {\n             \"    }}]\\n\" +\n             \"}\";\n \n-        SimulatePipelineResponse response = client().admin().cluster()\n-            .prepareSimulatePipeline(new BytesArray(source.getBytes(StandardCharsets.UTF_8)),\n-                XContentType.JSON).get();\n-        SimulateDocumentBaseResult baseResult = (SimulateDocumentBaseResult)response.getResults().get(0);\n-        assertThat(baseResult.getIngestDocument().getFieldValue(\"ml.regression.predicted_value\", Double.class), equalTo(1.0));\n-        assertThat(baseResult.getIngestDocument().getFieldValue(\"ml.classification.predicted_value\", String.class),\n-            equalTo(\"second\"));\n-        assertThat(baseResult.getIngestDocument().getFieldValue(\"ml.classification.result_class_prob\", List.class).size(),\n-            equalTo(2));\n+        Response response = client().performRequest(simulateRequest(source));\n+        String responseString = EntityUtils.toString(response.getEntity());\n+        assertThat(responseString, containsString(\"\\\"predicted_value\\\":\\\"second\\\"\"));", "originalCommit": "c4d6115e383a28488e35dd6989c1927ff282dce6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTUyODg3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51267#discussion_r369528875", "bodyText": "Yes, it is. It checks what I want without having to parse an object.", "author": "benwtrent", "createdAt": "2020-01-22T12:22:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQxMjQ1NA=="}], "type": "inlineReview", "revised_code": null}, {"oid": "17226fb257bc64b4cb151ec01f3b968a1631612c", "url": "https://github.com/elastic/elasticsearch/commit/17226fb257bc64b4cb151ec01f3b968a1631612c", "message": "changing test cleanup code", "committedDate": "2020-01-22T12:30:39Z", "type": "commit"}, {"oid": "af52810cd911415435c0762c9708d55df54ab397", "url": "https://github.com/elastic/elasticsearch/commit/af52810cd911415435c0762c9708d55df54ab397", "message": "Merge branch 'feature/ml-inference-fix-issue-51201' of github.com:benwtrent/elasticsearch into feature/ml-inference-fix-issue-51201", "committedDate": "2020-01-22T12:30:48Z", "type": "commit"}, {"oid": "f5046572b51eb44284d046c3897050c7c4c50f89", "url": "https://github.com/elastic/elasticsearch/commit/f5046572b51eb44284d046c3897050c7c4c50f89", "message": "Adding comment as to why it is a rest test case", "committedDate": "2020-01-22T12:40:46Z", "type": "commit"}, {"oid": "416a8024e581784fe0b0a181b225a739f8446a54", "url": "https://github.com/elastic/elasticsearch/commit/416a8024e581784fe0b0a181b225a739f8446a54", "message": "Merge branch 'master' into feature/ml-inference-fix-issue-51201", "committedDate": "2020-01-22T13:03:03Z", "type": "commit"}]}