{"pr_number": 63937, "pr_title": "Move index analyzer management to FieldMapper/MapperService", "pr_createdAt": "2020-10-20T13:12:04Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63937", "timeline": [{"oid": "34977e4bd8617e42ecf9edd3b6765be6eef2d97c", "url": "https://github.com/elastic/elasticsearch/commit/34977e4bd8617e42ecf9edd3b6765be6eef2d97c", "message": "Centralize index analyzer management", "committedDate": "2020-10-20T13:00:59Z", "type": "commit"}, {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "url": "https://github.com/elastic/elasticsearch/commit/3d8dfc708758b9c3396a3a892f8e114d268e6389", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-20T13:03:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4OTkxNg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508489916", "bodyText": "These changes are due to position increment handling moving directly into TextParams.Analyzers, which simplifies a lot of the palaver around building analyzers for text fields.  SearchAsYouType doesn't actually expose a position increment field so doesn't get the added benefits here, but it still requires a small refactor.", "author": "romseygeek", "createdAt": "2020-10-20T13:14:23Z", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -95,18 +95,14 @@\n     public static final TypeParser PARSER\n         = new TypeParser((n, c) -> new Builder(n, () -> c.getIndexAnalyzers().getDefaultIndexAnalyzer()));\n \n-    private static SearchAsYouTypeFieldMapper toType(FieldMapper in) {\n-        return (SearchAsYouTypeFieldMapper) in;\n-    }\n-\n-    private static SearchAsYouTypeFieldType ft(FieldMapper in) {\n-        return toType(in).fieldType();\n+    private static Builder builder(FieldMapper in) {\n+        return ((SearchAsYouTypeFieldMapper)in).builder;\n     }\n \n     public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        private final Parameter<Boolean> index = Parameter.indexParam(m -> toType(m).index, true);\n-        private final Parameter<Boolean> store = Parameter.storeParam(m -> toType(m).store, false);\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.get(), true);", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\nindex 121301d0fdb..ba09983317b 100644\n--- a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n+++ b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java\n\n@@ -95,14 +95,18 @@ public class SearchAsYouTypeFieldMapper extends ParametrizedFieldMapper {\n     public static final TypeParser PARSER\n         = new TypeParser((n, c) -> new Builder(n, () -> c.getIndexAnalyzers().getDefaultIndexAnalyzer()));\n \n-    private static Builder builder(FieldMapper in) {\n-        return ((SearchAsYouTypeFieldMapper)in).builder;\n+    private static SearchAsYouTypeFieldMapper toType(FieldMapper in) {\n+        return (SearchAsYouTypeFieldMapper) in;\n     }\n \n-    public static class Builder extends ParametrizedFieldMapper.Builder {\n+    private static SearchAsYouTypeFieldType ft(FieldMapper in) {\n+        return toType(in).fieldType();\n+    }\n+\n+    public static class Builder extends FieldMapper.Builder {\n \n-        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.get(), true);\n-        private final Parameter<Boolean> store = Parameter.storeParam(m -> builder(m).store.get(), false);\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> toType(m).index, true);\n+        private final Parameter<Boolean> store = Parameter.storeParam(m -> toType(m).store, false);\n \n         // This is only here because for some reason the initial impl of this always serialized\n         // `doc_values=false`, even though it cannot be set; and so we need to continue\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5Mzg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508493884", "bodyText": "The upshot of this change is to make the analyze action work in precisely the way this comment says it doesn't... if the analyzer hasn't been built specifically for this request, then we're examining the analyzer for a specific field, and so we use the general index analyzer and pass the field name so that it delegates to the correct field analyzer.", "author": "romseygeek", "createdAt": "2020-10-20T13:19:40Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java", "diffHunk": "@@ -220,10 +220,8 @@ private static Analyzer buildCustomAnalyzer(AnalyzeAction.Request request, Analy\n         List<AnalyzeAction.AnalyzeToken> tokens = new ArrayList<>();\n         int lastPosition = -1;\n         int lastOffset = 0;\n-        // Note that we always pass \"\" as the field to the various Analyzer methods, because\n-        // the analyzers we use here are all field-specific and so ignore this parameter", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java b/server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java\nindex 4340d04fc90..ce772d9c4f7 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java\n\n@@ -220,8 +220,10 @@ public class TransportAnalyzeAction extends TransportSingleShardAction<AnalyzeAc\n         List<AnalyzeAction.AnalyzeToken> tokens = new ArrayList<>();\n         int lastPosition = -1;\n         int lastOffset = 0;\n+        // Note that we always pass \"\" as the field to the various Analyzer methods, because\n+        // the analyzers we use here are all field-specific and so ignore this parameter\n         for (String text : request.text()) {\n-            try (TokenStream stream = analyzer.tokenStream(request.field(), text)) {\n+            try (TokenStream stream = analyzer.tokenStream(\"\", text)) {\n                 stream.reset();\n                 CharTermAttribute term = stream.addAttribute(CharTermAttribute.class);\n                 PositionIncrementAttribute posIncr = stream.addAttribute(PositionIncrementAttribute.class);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NDc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508494755", "bodyText": "This is moved from the fastvector highlighter - it would be nice to actually fix this in Lucene rather than have this annoying check.", "author": "romseygeek", "createdAt": "2020-10-20T13:20:47Z", "path": "server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java", "diffHunk": "@@ -48,4 +48,20 @@ protected Analyzer getWrappedAnalyzer(String fieldName) {\n         // Fields need to be explicitly added\n         throw new IllegalArgumentException(\"Field [\" + fieldName + \"] has no associated analyzer\");\n     }\n+\n+    public boolean containsBrokenAnalysis(String field) {", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java b/server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java\nindex 955d213dbaa..dbb355ea51c 100644\n--- a/server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java\n+++ b/server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java\n\n@@ -48,20 +48,4 @@ public final class FieldNameAnalyzer extends DelegatingAnalyzerWrapper {\n         // Fields need to be explicitly added\n         throw new IllegalArgumentException(\"Field [\" + fieldName + \"] has no associated analyzer\");\n     }\n-\n-    public boolean containsBrokenAnalysis(String field) {\n-        Analyzer analyzer = getWrappedAnalyzer(field);\n-        if (analyzer instanceof NamedAnalyzer) {\n-            analyzer = ((NamedAnalyzer) analyzer).analyzer();\n-        }\n-        if (analyzer instanceof AnalyzerComponentsProvider) {\n-            final TokenFilterFactory[] tokenFilters = ((AnalyzerComponentsProvider) analyzer).getComponents().getTokenFilters();\n-            for (TokenFilterFactory tokenFilterFactory : tokenFilters) {\n-                if (tokenFilterFactory.breaksFastVectorHighlighter()) {\n-                    return true;\n-                }\n-            }\n-        }\n-        return false;\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NjY4MA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508496680", "bodyText": "This was an IDE-recommended change, we've just asserted that maxInputLength is smaller than input.length(), so Math.min will always return it.", "author": "romseygeek", "createdAt": "2020-10-20T13:22:29Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -402,7 +376,7 @@ public void parse(ParseContext context) throws IOException {\n             }\n             // truncate input\n             if (input.length() > maxInputLength) {\n-                int len = Math.min(maxInputLength, input.length());", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\nindex e3b0987133f..7a7eb887de1 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java\n\n@@ -376,7 +402,7 @@ public class CompletionFieldMapper extends ParametrizedFieldMapper {\n             }\n             // truncate input\n             if (input.length() > maxInputLength) {\n-                int len = maxInputLength;\n+                int len = Math.min(maxInputLength, input.length());\n                 if (Character.isHighSurrogate(input.charAt(len - 1))) {\n                     assert input.length() >= len + 1 && Character.isLowSurrogate(input.charAt(len));\n                     len += 1;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NzM0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508497342", "bodyText": "Nothing calls this anymore (all mappers that use analyzers have been parametrized) so it is safe to remove.", "author": "romseygeek", "createdAt": "2020-10-20T13:23:17Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -400,17 +402,6 @@ private void mergeSharedOptions(FieldMapper mergeWith, List<String> conflicts) {\n         if (fieldType.storeTermVectorPayloads() != other.storeTermVectorPayloads()) {\n             conflicts.add(\"mapper [\" + name() + \"] has different [store_term_vector_payloads] values\");\n         }\n-", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\nindex e1d0de516ac..69ec5ba5874 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n\n@@ -339,76 +209,52 @@ public abstract class FieldMapper extends Mapper implements Cloneable {\n         }\n     }\n \n-    @Override\n-    public FieldMapper merge(Mapper mergeWith) {\n-        FieldMapper merged = clone();\n-        List<String> conflicts = new ArrayList<>();\n-        if (mergeWith instanceof FieldMapper == false) {\n-            throw new IllegalArgumentException(\"mapper [\" + mappedFieldType.name() + \"] cannot be changed from type [\"\n-            + contentType() + \"] to [\" + mergeWith.getClass().getSimpleName() + \"]\");\n-        }\n-        FieldMapper toMerge = (FieldMapper) mergeWith;\n-        merged.mergeSharedOptions(toMerge, conflicts);\n-        merged.mergeOptions(toMerge, conflicts);\n-        if (conflicts.isEmpty() == false) {\n-            throw new IllegalArgumentException(\"Mapper for [\" + name() +\n-                \"] conflicts with existing mapping:\\n\" + conflicts.toString());\n-        }\n-        merged.multiFields = multiFields.merge(toMerge.multiFields);\n-        // apply changeable values\n-        merged.mappedFieldType = toMerge.mappedFieldType;\n-        merged.fieldType = toMerge.fieldType;\n-        merged.copyTo = toMerge.copyTo;\n-        return merged;\n-    }\n+    /**\n+     * Returns a {@link Builder} to be used for merging and serialization\n+     *\n+     * Implement as follows:\n+     * {@code return new MyBuilder(simpleName()).init(this); }\n+     */\n+    public abstract Builder getMergeBuilder();\n \n-    private void mergeSharedOptions(FieldMapper mergeWith, List<String> conflicts) {\n+    @Override\n+    public final FieldMapper merge(Mapper mergeWith) {\n \n-        if (Objects.equals(this.contentType(), mergeWith.contentType()) == false) {\n-            throw new IllegalArgumentException(\"mapper [\" + fieldType().name() + \"] cannot be changed from type [\" + contentType()\n-                + \"] to [\" + mergeWith.contentType() + \"]\");\n+        if (mergeWith instanceof FieldMapper == false) {\n+            throw new IllegalArgumentException(\"mapper [\" + name() + \"] cannot be changed from type [\"\n+                + contentType() + \"] to [\" + mergeWith.getClass().getSimpleName() + \"]\");\n         }\n+        checkIncomingMergeType((FieldMapper)mergeWith);\n \n-        FieldType other = mergeWith.fieldType;\n-        MappedFieldType otherm = mergeWith.mappedFieldType;\n-\n-        boolean indexed =  fieldType.indexOptions() != IndexOptions.NONE;\n-        boolean mergeWithIndexed = other.indexOptions() != IndexOptions.NONE;\n-        if (indexed != mergeWithIndexed) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [index] values\");\n-        }\n-        // TODO: should be validating if index options go \"up\" (but \"down\" is ok)\n-        if (fieldType.indexOptions() != other.indexOptions()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [index_options] values\");\n+        Builder builder = getMergeBuilder();\n+        if (builder == null) {\n+            return (FieldMapper) mergeWith;\n         }\n-        if (fieldType.stored() != other.stored()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [store] values\");\n-        }\n-        if (this.mappedFieldType.hasDocValues() != otherm.hasDocValues()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [doc_values] values\");\n-        }\n-        if (fieldType.omitNorms() && !other.omitNorms()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [norms] values, cannot change from disable to enabled\");\n-        }\n-        if (fieldType.storeTermVectors() != other.storeTermVectors()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [term_vector] values\");\n-        }\n-        if (fieldType.storeTermVectorOffsets() != other.storeTermVectorOffsets()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [store_term_vector_offsets] values\");\n+        Conflicts conflicts = new Conflicts(name());\n+        builder.merge((FieldMapper) mergeWith, conflicts);\n+        conflicts.check();\n+        return builder.build(new BuilderContext(Settings.EMPTY, parentPath(name())));\n+    }\n+\n+    private static ContentPath parentPath(String name) {\n+        int endPos = name.lastIndexOf(\".\");\n+        if (endPos == -1) {\n+            return new ContentPath(0);\n         }\n-        if (fieldType.storeTermVectorPositions() != other.storeTermVectorPositions()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [store_term_vector_positions] values\");\n+        return new ContentPath(name.substring(0, endPos));\n+    }\n+\n+    protected void checkIncomingMergeType(FieldMapper mergeWith) {\n+        if (Objects.equals(this.getClass(), mergeWith.getClass()) == false) {\n+            throw new IllegalArgumentException(\"mapper [\" + name() + \"] cannot be changed from type [\"\n+                + contentType() + \"] to [\" + mergeWith.contentType() + \"]\");\n         }\n-        if (fieldType.storeTermVectorPayloads() != other.storeTermVectorPayloads()) {\n-            conflicts.add(\"mapper [\" + name() + \"] has different [store_term_vector_payloads] values\");\n+        if (Objects.equals(contentType(), mergeWith.contentType()) == false) {\n+            throw new IllegalArgumentException(\"mapper [\" + name() + \"] cannot be changed from type [\"\n+                + contentType() + \"] to [\" + mergeWith.contentType() + \"]\");\n         }\n     }\n \n-    /**\n-     * Merge type-specific options and check for incompatible settings in mappings to be merged\n-     */\n-    protected abstract void mergeOptions(FieldMapper other, List<String> conflicts);\n-\n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n         builder.startObject(simpleName());\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NzUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508497537", "bodyText": "This is not called from anywhere so can be removed.", "author": "romseygeek", "createdAt": "2020-10-20T13:23:32Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -460,35 +451,6 @@ protected void doXContentBody(XContentBuilder builder, boolean includeDefaults,\n         }\n     }\n \n-    protected final void doXContentAnalyzers(XContentBuilder builder, boolean includeDefaults) throws IOException {", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\nindex e1d0de516ac..69ec5ba5874 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n\n@@ -430,46 +276,14 @@ public abstract class FieldMapper extends Mapper implements Cloneable {\n     }\n \n     protected void doXContentBody(XContentBuilder builder, boolean includeDefaults, Params params) throws IOException {\n-\n         builder.field(\"type\", contentType());\n-\n-        if (includeDefaults || mappedFieldType.isSearchable() != indexedByDefault()) {\n-            builder.field(\"index\", mappedFieldType.isSearchable());\n-        }\n-        if (includeDefaults || mappedFieldType.hasDocValues() != docValuesByDefault()) {\n-            builder.field(\"doc_values\", mappedFieldType.hasDocValues());\n-        }\n-        if (includeDefaults || fieldType.stored() != storedByDefault()) {\n-            builder.field(\"store\", fieldType.stored());\n-        }\n-\n+        getMergeBuilder().toXContent(builder, includeDefaults);\n         multiFields.toXContent(builder, params);\n         copyTo.toXContent(builder, params);\n-\n-        if (includeDefaults || fieldType().meta().isEmpty() == false) {\n-            builder.field(\"meta\", new TreeMap<>(fieldType().meta())); // ensure consistent order\n-        }\n-    }\n-\n-    protected static String indexOptionToString(IndexOptions indexOption) {\n-        switch (indexOption) {\n-            case DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS:\n-                return TypeParsers.INDEX_OPTIONS_OFFSETS;\n-            case DOCS_AND_FREQS:\n-                return TypeParsers.INDEX_OPTIONS_FREQS;\n-            case DOCS_AND_FREQS_AND_POSITIONS:\n-                return TypeParsers.INDEX_OPTIONS_POSITIONS;\n-            case DOCS:\n-                return TypeParsers.INDEX_OPTIONS_DOCS;\n-            default:\n-                throw new IllegalArgumentException(\"Unknown IndexOptions [\" + indexOption + \"]\");\n-        }\n     }\n \n     protected abstract String contentType();\n \n-    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);\n-\n     public static class MultiFields implements Iterable<Mapper> {\n \n         public static MultiFields empty() {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5OTA0MA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508499040", "bodyText": "We don't need the default analyzer any more because text-based field mappers now always provide an analyzer even if they're using a default.", "author": "romseygeek", "createdAt": "2020-10-20T13:25:23Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -42,14 +42,7 @@\n     private final int metadataFieldCount;\n     private final FieldNameAnalyzer indexAnalyzer;\n \n-    private static void put(Map<String, Analyzer> analyzers, String key, Analyzer value, Analyzer defaultValue) {\n-        if (value == null) {\n-            value = defaultValue;\n-        }\n-        analyzers.put(key, value);\n-    }\n-\n-    public static MappingLookup fromMapping(Mapping mapping, Analyzer defaultIndex) {\n+    public static MappingLookup fromMapping(Mapping mapping) {", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java b/server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java\nindex abf16523aff..9bff34bbd88 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java\n\n@@ -42,7 +42,14 @@ public final class MappingLookup implements Iterable<Mapper> {\n     private final int metadataFieldCount;\n     private final FieldNameAnalyzer indexAnalyzer;\n \n-    public static MappingLookup fromMapping(Mapping mapping) {\n+    private static void put(Map<String, Analyzer> analyzers, String key, Analyzer value, Analyzer defaultValue) {\n+        if (value == null) {\n+            value = defaultValue;\n+        }\n+        analyzers.put(key, value);\n+    }\n+\n+    public static MappingLookup fromMapping(Mapping mapping, Analyzer defaultIndex) {\n         List<ObjectMapper> newObjectMappers = new ArrayList<>();\n         List<FieldMapper> newFieldMappers = new ArrayList<>();\n         List<FieldAliasMapper> newFieldAliasMappers = new ArrayList<>();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMDE4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508500189", "bodyText": "We will be able to remove these entirely in a follow-up", "author": "romseygeek", "createdAt": "2020-10-20T13:26:44Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -569,8 +550,11 @@ public Query existsQuery(QueryShardContext context) {\n \n     private static final class PhraseFieldMapper extends FieldMapper {\n ", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4cccf095acf1c7fc9e1cbacf26600e144137fc66", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\nindex a80e5e0d45b..2f35f287e5e 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n\n@@ -552,9 +571,9 @@ public class TextFieldMapper extends ParametrizedFieldMapper {\n \n         final Analyzer analyzer;\n \n-        PhraseFieldMapper(FieldType fieldType, PhraseFieldType mappedFieldType, NamedAnalyzer analyzer) {\n+        PhraseFieldMapper(FieldType fieldType, PhraseFieldType mappedFieldType, PhraseWrappedAnalyzer analyzer) {\n             super(mappedFieldType.name(), fieldType, mappedFieldType, MultiFields.empty(), CopyTo.empty());\n-            this.analyzer = new PhraseWrappedAnalyzer(analyzer.analyzer());\n+            this.analyzer = analyzer;\n         }\n \n         @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMzExOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508503119", "bodyText": "These are a consequence of changing to checking for TextSearchInfo.NONE rather than an index analyzer.  Again, it is sort of accidental that they work, and it may not make any real sense, but they do...", "author": "romseygeek", "createdAt": "2020-10-20T13:30:04Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java", "diffHunk": "@@ -80,7 +78,10 @@ protected AggregationBuilder createAggBuilderForTypeTest(MappedFieldType fieldTy\n     protected List<ValuesSourceType> getSupportedValuesSourceTypes() {\n         // TODO it is likely accidental that SigText supports anything other than Bytes, and then only text fields\n         return List.of(CoreValuesSourceType.NUMERIC,", "originalCommit": "3d8dfc708758b9c3396a3a892f8e114d268e6389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d6adf804bb2a5ceb35aa35062f1ebb35f1bfd1c3", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java\nindex 6f9599e0289..eb91b8d0330 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java\n\n@@ -76,21 +77,13 @@ public class SignificantTextAggregatorTests extends AggregatorTestCase {\n \n     @Override\n     protected List<ValuesSourceType> getSupportedValuesSourceTypes() {\n-        // TODO it is likely accidental that SigText supports anything other than Bytes, and then only text fields\n-        return List.of(CoreValuesSourceType.NUMERIC,\n-            CoreValuesSourceType.BOOLEAN,\n-            CoreValuesSourceType.BYTES,\n-            CoreValuesSourceType.DATE,\n-            CoreValuesSourceType.IP,\n-            CoreValuesSourceType.RANGE,\n-            CoreValuesSourceType.GEOPOINT);\n+        return List.of(CoreValuesSourceType.BYTES);\n     }\n \n     @Override\n     protected List<String> unsupportedMappedFieldTypes() {\n         return List.of(\n-            BinaryFieldMapper.CONTENT_TYPE, // binary fields are not supported because they do not have analyzers\n-            GeoPointFieldMapper.CONTENT_TYPE // geopoint fields cannot use term queries\n+            BinaryFieldMapper.CONTENT_TYPE // binary fields are not supported because they do not have analyzers\n         );\n     }\n \n"}}, {"oid": "d098bcdace36fcc663ede0d9e34cbbef748a870d", "url": "https://github.com/elastic/elasticsearch/commit/d098bcdace36fcc663ede0d9e34cbbef748a870d", "message": "precommit", "committedDate": "2020-10-20T13:39:12Z", "type": "commit"}, {"oid": "3a8807a8c8c88783409fdf5f5ac61727f5d7765a", "url": "https://github.com/elastic/elasticsearch/commit/3a8807a8c8c88783409fdf5f5ac61727f5d7765a", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-20T14:06:32Z", "type": "commit"}, {"oid": "4cccf095acf1c7fc9e1cbacf26600e144137fc66", "url": "https://github.com/elastic/elasticsearch/commit/4cccf095acf1c7fc9e1cbacf26600e144137fc66", "message": "delegating analyzers", "committedDate": "2020-10-20T17:33:10Z", "type": "commit"}, {"oid": "c9437df65f23fa53c62c1b94748e9d1876cb1632", "url": "https://github.com/elastic/elasticsearch/commit/c9437df65f23fa53c62c1b94748e9d1876cb1632", "message": "precommit", "committedDate": "2020-10-21T08:37:41Z", "type": "commit"}, {"oid": "1885058cf535880a619480bde0a21ca73133844d", "url": "https://github.com/elastic/elasticsearch/commit/1885058cf535880a619480bde0a21ca73133844d", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-21T08:37:44Z", "type": "commit"}, {"oid": "32382ad10226da332423054c78351e3d10ad688a", "url": "https://github.com/elastic/elasticsearch/commit/32382ad10226da332423054c78351e3d10ad688a", "message": "position increments on annotations", "committedDate": "2020-10-21T10:12:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509175194", "bodyText": "don't we already expose the indexAnalyzer? In that case do we need this additional method in MapperService?", "author": "javanna", "createdAt": "2020-10-21T10:42:35Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,6 +444,10 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public boolean containsBrokenAnalysis(String field) {\n+        return this.indexAnalyzer.containsBrokenAnalysis(field);", "originalCommit": "32382ad10226da332423054c78351e3d10ad688a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MjU4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512092582", "bodyText": "It's exposed as a plain Analyzer though, and the impl itself is package-private (because it gets set on the IndexWriter immediately but needs to be configured subsequently, so it's a semi-transparent wrapper).  It is annoying though - really what needs to happen is that lucene needs to fix things so that term vectors can't contain broken offsets...", "author": "romseygeek", "createdAt": "2020-10-26T16:23:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0Mjc1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514942755", "bodyText": "I see thanks for explaining", "author": "javanna", "createdAt": "2020-10-30T08:38:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA=="}], "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\nindex 766955f0e32..c3e80c01a70 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n\n@@ -444,10 +444,6 @@ public class MapperService extends AbstractIndexComponent implements Closeable {\n         return this.indexAnalyzer;\n     }\n \n-    public boolean containsBrokenAnalysis(String field) {\n-        return this.indexAnalyzer.containsBrokenAnalysis(field);\n-    }\n-\n     @Override\n     public void close() throws IOException {\n         indexAnalyzers.close();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509184027", "bodyText": "I think this could be package private.\nCouple more thoughts:  do we need a biconsumer? it seems like every mapper could expose its own analyzers through a Map<String, Analyzer>. This would though be quite a complicated API for the regular case, where a field either registers nothing or registers one analyzer with the same name as the field. Could we simplify things for those cases? I do see that you may want the method as abstract so you don't forget to implement it, but it requires so many empty implementations that I wonder if we should simplify this.\nTo summarize, how about something like this:\n//override this if you need multiple analyzers for the same field\nMap<String, Analyzer> getAnalyzers() {\n    return Collections.singletonMap(name(), getFieldAnalyzer());\n}\n\n//most field mappers implement this one, possibly we could return a placeholder for the case where no analyzer is needed, not sure if we want to not make it abstract, I am undecided on that.\nabstract Analyzer getFieldAnalyzer();\n\nTwo methods would have the advantage that it would be immediately traceable which mappers register multiple fields, if that matters.", "author": "javanna", "createdAt": "2020-10-21T10:58:18Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -506,6 +468,8 @@ protected static String indexOptionToString(IndexOptions indexOption) {\n \n     protected abstract String contentType();\n \n+    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);", "originalCommit": "32382ad10226da332423054c78351e3d10ad688a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4OTE3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512089179", "bodyText": "Another option would be to create a FieldMapper subclass called AnalyzedFieldMapper or similar that makes this abstract, and then have a default impl on FieldMapper itself that does nothing?", "author": "romseygeek", "createdAt": "2020-10-26T16:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5OTIwNA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512499204", "bodyText": "That could also work, but I would still find it weird that we need a biconsumer as an argument", "author": "javanna", "createdAt": "2020-10-27T08:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NzQ2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514297462", "bodyText": "I've changed this to return a Map instead.", "author": "romseygeek", "createdAt": "2020-10-29T14:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}], "type": "inlineReview", "revised_code": {"commit": "f1b8095fdddd17457339486d13d1954e89ed8871", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\nindex e1d0de516ac..8c432c0974c 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java\n\n@@ -468,7 +467,9 @@ public abstract class FieldMapper extends Mapper implements Cloneable {\n \n     protected abstract String contentType();\n \n-    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);\n+    public Map<String, Analyzer> indexAnalyzers() {\n+        return Collections.emptyMap();\n+    }\n \n     public static class MultiFields implements Iterable<Mapper> {\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509185615", "bodyText": "Something that bugs me, not directly related to your change, but that we may want to address: MapperService exposes indexAnalyzer, MappingLookup too. But they are two fundamentally different things. I have issues remembering which is what. Could we name them differently. Also as I am going to need to expose them both in the QueryShardContext. I am calling the new one getFieldNameAnalyzer, but you'll have better ideas.", "author": "javanna", "createdAt": "2020-10-21T11:01:14Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -121,7 +121,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n+        this.indexAnalyzer = new MapperAnalyzerWrapper();", "originalCommit": "32382ad10226da332423054c78351e3d10ad688a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NDczNw==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512094737", "bodyText": "Yeah, I think this should be removed from MappingLookup entirely, and just live in MapperService.  I'll see if I can incorporate that here as well.", "author": "romseygeek", "createdAt": "2020-10-26T16:26:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5NzcxMA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514197710", "bodyText": "This turned out not to be straightforward, so let's leave it for a separate issue", "author": "romseygeek", "createdAt": "2020-10-29T11:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzOTc4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514939782", "bodyText": "++", "author": "javanna", "createdAt": "2020-10-30T08:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\nindex 766955f0e32..c3e80c01a70 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n\n@@ -121,7 +121,7 @@ public class MapperService extends AbstractIndexComponent implements Closeable {\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper();\n+        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n         this.mapperRegistry = mapperRegistry;\n         Function<DateFormatter, Mapper.TypeParser.ParserContext> parserContextFunction =\n             dateFormatter -> new Mapper.TypeParser.ParserContext(similarityService::getSimilarity, mapperRegistry.getMapperParsers()::get,\n"}}, {"oid": "0b963be352c40d6d22dc664f2ace18b6f851239a", "url": "https://github.com/elastic/elasticsearch/commit/0b963be352c40d6d22dc664f2ace18b6f851239a", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-26T16:21:32Z", "type": "commit"}, {"oid": "d6adf804bb2a5ceb35aa35062f1ebb35f1bfd1c3", "url": "https://github.com/elastic/elasticsearch/commit/d6adf804bb2a5ceb35aa35062f1ebb35f1bfd1c3", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-27T14:40:06Z", "type": "commit"}, {"oid": "f1b8095fdddd17457339486d13d1954e89ed8871", "url": "https://github.com/elastic/elasticsearch/commit/f1b8095fdddd17457339486d13d1954e89ed8871", "message": "Move to returning maps", "committedDate": "2020-10-27T15:29:11Z", "type": "commit"}, {"oid": "bb81e255fc362f3afb43df1666bf0bf495fdcc04", "url": "https://github.com/elastic/elasticsearch/commit/bb81e255fc362f3afb43df1666bf0bf495fdcc04", "message": "imports", "committedDate": "2020-10-27T15:48:45Z", "type": "commit"}, {"oid": "2585186afbf02d47db257c5b97c382e39eeb3c4d", "url": "https://github.com/elastic/elasticsearch/commit/2585186afbf02d47db257c5b97c382e39eeb3c4d", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-27T16:18:25Z", "type": "commit"}, {"oid": "4f3da1d43c7615e7ae2c51704a66966485a8791e", "url": "https://github.com/elastic/elasticsearch/commit/4f3da1d43c7615e7ae2c51704a66966485a8791e", "message": "Make everything a NamedAnalyzer", "committedDate": "2020-10-29T11:42:30Z", "type": "commit"}, {"oid": "be55995bc711fb6b5c35ffb1fa92a6f7b7fe2b30", "url": "https://github.com/elastic/elasticsearch/commit/be55995bc711fb6b5c35ffb1fa92a6f7b7fe2b30", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-10-29T11:54:26Z", "type": "commit"}, {"oid": "73044b58cab37ba8a4dea29e98332b8bd297eef0", "url": "https://github.com/elastic/elasticsearch/commit/73044b58cab37ba8a4dea29e98332b8bd297eef0", "message": "warnings", "committedDate": "2020-10-29T12:04:05Z", "type": "commit"}, {"oid": "25f3c0d4cc16fff576b1a6c71ad9437253f7e8f8", "url": "https://github.com/elastic/elasticsearch/commit/25f3c0d4cc16fff576b1a6c71ad9437253f7e8f8", "message": "sigtext", "committedDate": "2020-10-29T14:53:56Z", "type": "commit"}, {"oid": "c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "url": "https://github.com/elastic/elasticsearch/commit/c04c7d1bbd124b9dd74fbb9d6706edd14bc940d1", "message": "Collapse ParametrizedFieldMapper into FieldMapper", "committedDate": "2020-10-29T16:30:03Z", "type": "commit"}, {"oid": "639126e07d876bddb7008c98c2cb6617f9c9edca", "url": "https://github.com/elastic/elasticsearch/commit/639126e07d876bddb7008c98c2cb6617f9c9edca", "message": "SAYT shouldn't try to add fields if index=false and store=false", "committedDate": "2020-10-29T21:30:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0MTM2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514941363", "bodyText": "should we have an easier path for this common scenario where there is only one analyzer and it is registered with the same name as the field? the mapper in this case only needs to expose which analyzer it is? Having two paths is not optimal, but I think it would help highlighting which mappers are different in that they provide multiple analyzers.", "author": "javanna", "createdAt": "2020-10-30T08:35:52Z", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java", "diffHunk": "@@ -161,4 +161,9 @@ protected String contentType() {\n         return CONTENT_TYPE;\n     }\n \n+    @Override\n+    public Map<String, NamedAnalyzer> indexAnalyzers() {\n+        return Collections.singletonMap(name(), Lucene.KEYWORD_ANALYZER);", "originalCommit": "25f3c0d4cc16fff576b1a6c71ad9437253f7e8f8", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "88ad7e5dcd9d94f28da59d0831b2e5850211b99a", "chunk": "diff --git a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java\nindex def94b75485..69ca73043f7 100644\n--- a/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java\n+++ b/modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java\n\n@@ -161,9 +153,4 @@ public class RankFeaturesFieldMapper extends ParametrizedFieldMapper {\n         return CONTENT_TYPE;\n     }\n \n-    @Override\n-    public Map<String, NamedAnalyzer> indexAnalyzers() {\n-        return Collections.singletonMap(name(), Lucene.KEYWORD_ANALYZER);\n-    }\n-\n }\n"}}, {"oid": "feea031ef463d700c3598349cf432ff66bc71c38", "url": "https://github.com/elastic/elasticsearch/commit/feea031ef463d700c3598349cf432ff66bc71c38", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-11-02T12:13:52Z", "type": "commit"}, {"oid": "9ee7dda1d3d02ee313dd46def7d4e40651517c0c", "url": "https://github.com/elastic/elasticsearch/commit/9ee7dda1d3d02ee313dd46def7d4e40651517c0c", "message": "Merge branch 'mapper/fieldmapper' into mapper/indexanalyzer", "committedDate": "2020-11-02T12:23:36Z", "type": "commit"}, {"oid": "88ad7e5dcd9d94f28da59d0831b2e5850211b99a", "url": "https://github.com/elastic/elasticsearch/commit/88ad7e5dcd9d94f28da59d0831b2e5850211b99a", "message": "Make indexAnalyzers passed via constructor", "committedDate": "2020-11-02T15:31:22Z", "type": "commit"}, {"oid": "040ec026700af36ec70059a4b9d943cfb48a0206", "url": "https://github.com/elastic/elasticsearch/commit/040ec026700af36ec70059a4b9d943cfb48a0206", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-11-02T15:46:39Z", "type": "commit"}, {"oid": "0d2a081fe06c0ccbe67f5777a829b05bbbf193d4", "url": "https://github.com/elastic/elasticsearch/commit/0d2a081fe06c0ccbe67f5777a829b05bbbf193d4", "message": "SearchAsYouType tests", "committedDate": "2020-11-02T16:59:26Z", "type": "commit"}, {"oid": "7b28b2c5a606ea8c41620ff387d400accb642149", "url": "https://github.com/elastic/elasticsearch/commit/7b28b2c5a606ea8c41620ff387d400accb642149", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-11-03T17:42:07Z", "type": "commit"}, {"oid": "22357b772908c5a7f08ebc185cb7b7df902b5bdc", "url": "https://github.com/elastic/elasticsearch/commit/22357b772908c5a7f08ebc185cb7b7df902b5bdc", "message": "Merge branch 'master' into mapper/indexanalyzer", "committedDate": "2020-11-03T18:10:19Z", "type": "commit"}, {"oid": "479309734141b6006c49bc8268e72e042eba3e94", "url": "https://github.com/elastic/elasticsearch/commit/479309734141b6006c49bc8268e72e042eba3e94", "message": "Merge branch 'master' into mapper/indexanalyzer", "committedDate": "2020-11-04T09:14:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjM0NA==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517246344", "bodyText": "this is introducing another usage of FetchContext#mapperService() that we'd like to remove :( could we find a way around it?", "author": "javanna", "createdAt": "2020-11-04T10:32:59Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -72,6 +72,7 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         FetchSubPhase.HitContext hitContext = fieldContext.hitContext;\n         MappedFieldType fieldType = fieldContext.fieldType;\n         boolean forceSource = fieldContext.forceSource;\n+        boolean fixBrokenAnalysis = fieldContext.context.mapperService().containsBrokenAnalysis(fieldContext.fieldName);", "originalCommit": "479309734141b6006c49bc8268e72e042eba3e94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTAwMg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517279002", "bodyText": "I added a delegator method, FetchContext#containsBrokenAnalysis()", "author": "romseygeek", "createdAt": "2020-11-04T11:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjM0NA=="}], "type": "inlineReview", "revised_code": {"commit": "5099a60e7d3bcf3068f05e388fdd474b88fc7056", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java b/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\nindex 39acc491a47..fdb49d16e2c 100644\n--- a/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\n+++ b/server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java\n\n@@ -72,7 +72,7 @@ public class FastVectorHighlighter implements Highlighter {\n         FetchSubPhase.HitContext hitContext = fieldContext.hitContext;\n         MappedFieldType fieldType = fieldContext.fieldType;\n         boolean forceSource = fieldContext.forceSource;\n-        boolean fixBrokenAnalysis = fieldContext.context.mapperService().containsBrokenAnalysis(fieldContext.fieldName);\n+        boolean fixBrokenAnalysis = fieldContext.context.containsBrokenAnalysis(fieldContext.fieldName);\n \n         if (canHighlight(fieldType) == false) {\n             throw new IllegalArgumentException(\"the field [\" + fieldContext.fieldName +\n"}}, {"oid": "a9051a48d45912bc7c8054faa9404d3b260a1358", "url": "https://github.com/elastic/elasticsearch/commit/a9051a48d45912bc7c8054faa9404d3b260a1358", "message": "Merge remote-tracking branch 'origin/master' into mapper/indexanalyzer", "committedDate": "2020-11-04T11:26:31Z", "type": "commit"}, {"oid": "342525c7fcf18cfdcbd85b1afe453d5fbdc0cf70", "url": "https://github.com/elastic/elasticsearch/commit/342525c7fcf18cfdcbd85b1afe453d5fbdc0cf70", "message": "Merge remote-tracking branch 'romseygeek/mapper/indexanalyzer' into mapper/indexanalyzer", "committedDate": "2020-11-04T11:26:46Z", "type": "commit"}, {"oid": "5099a60e7d3bcf3068f05e388fdd474b88fc7056", "url": "https://github.com/elastic/elasticsearch/commit/5099a60e7d3bcf3068f05e388fdd474b88fc7056", "message": "Don't call FetchContext#mapperService", "committedDate": "2020-11-04T11:30:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDcyMg==", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517294722", "bodyText": "this also calls mapperService() :) can you add the method to QueryShardContext and call it from there?", "author": "javanna", "createdAt": "2020-11-04T12:01:44Z", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -167,6 +167,14 @@ public SearchHighlightContext highlight() {\n         return searchContext.highlight();\n     }\n \n+    /**\n+     * Does the index analyzer for this field have token filters that may produce\n+     * backwards offsets in term vectors\n+     */\n+    public boolean containsBrokenAnalysis(String field) {\n+        return mapperService().containsBrokenAnalysis(field);", "originalCommit": "5099a60e7d3bcf3068f05e388fdd474b88fc7056", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e4f78828bba7e499c234210e48d7cbdc9e24bbc3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java b/server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java\nindex d5dd3b0ed8c..0263166059d 100644\n--- a/server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java\n+++ b/server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java\n\n@@ -172,7 +172,7 @@ public class FetchContext {\n      * backwards offsets in term vectors\n      */\n     public boolean containsBrokenAnalysis(String field) {\n-        return mapperService().containsBrokenAnalysis(field);\n+        return getQueryShardContext().containsBrokenAnalysis(field);\n     }\n \n     /**\n"}}, {"oid": "e4f78828bba7e499c234210e48d7cbdc9e24bbc3", "url": "https://github.com/elastic/elasticsearch/commit/e4f78828bba7e499c234210e48d7cbdc9e24bbc3", "message": "No really, don't use mapperservice", "committedDate": "2020-11-04T12:05:30Z", "type": "commit"}]}