{"pr_number": 63767, "pr_title": "Apply boost only once for distance_feature query", "pr_createdAt": "2020-10-15T18:47:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63767", "timeline": [{"oid": "6654c687971cd11a0afa7408050ab50a77d43b03", "url": "https://github.com/elastic/elasticsearch/commit/6654c687971cd11a0afa7408050ab50a77d43b03", "message": "Apply boost only once for distance_feature query\n\nCurrently if distance_feature query contains boost,\nit incorrectly  gets applied twice: in AbstractQueryBuilder::toQuery and\nwe also pass this boost to Lucene's LongPoint.newDistanceFeatureQuery.\nAs a result we get incorrect scores.\n\nThis fixes this error to ensure that boost is applied only once.\n\nCloses #63691", "committedDate": "2020-10-15T18:42:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5MzIyMg==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505793222", "bodyText": "When we fix LongScriptFieldDistanceFeatureQuery, I think we could remove the boost parameter altogether from MappedFieldType#distanceFeatureQuery ?", "author": "jtibshirani", "createdAt": "2020-10-15T19:39:21Z", "path": "server/src/main/java/org/elasticsearch/index/query/DistanceFeatureQueryBuilder.java", "diffHunk": "@@ -112,7 +112,8 @@ protected Query doToQuery(QueryShardContext context) throws IOException {\n         if (fieldType == null) {\n             return Queries.newMatchNoDocsQuery(\"Can't run [\" + NAME + \"] query on unmapped fields!\");\n         }\n-        return fieldType.distanceFeatureQuery(origin.origin(), pivot, boost, context);\n+        // As we already apply boost in AbstractQueryBuilder::toQuery, we always passing a boost of 1.0 to distanceFeatureQuery\n+        return fieldType.distanceFeatureQuery(origin.origin(), pivot, 1.0f, context);", "originalCommit": "6654c687971cd11a0afa7408050ab50a77d43b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgwMTE0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505801145", "bodyText": "Good point, I or Nik will do that.", "author": "mayya-sharipova", "createdAt": "2020-10-15T19:53:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5MzIyMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5NDc1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505794753", "bodyText": "It would be nice to rely on unit tests like DistanceFeatureQueryBuilderTests or a REST test instead of an integration test. We try to avoid new ESIntegTestCase cases unless a full cluster is really needed.", "author": "jtibshirani", "createdAt": "2020-10-15T19:41:47Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java", "diffHunk": "@@ -1626,6 +1627,33 @@ public void testRangeQueryWithLocaleMapping() throws Exception {\n         assertHitCount(searchResponse, 2L);\n     }\n \n+    public void testDistanceFeatureQuery() {", "originalCommit": "6654c687971cd11a0afa7408050ab50a77d43b03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgwMDkxMw==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505800913", "bodyText": "@jtibshirani Thanks for the suggestion. I was trying to make this test in REST yml tests, but yml tests don't have nice comparison of float scores (you can't set up delta, and also there are errors with double -> float conversions).\nI also considered adding this test in DistanceFeatureQueryBuilderTests, but then I need to work on the Lucene level there. But what I wanted to test is how ES parses this query and what scores are returned.  I could not find a smart way to do that in that test. WDYT?", "author": "mayya-sharipova", "createdAt": "2020-10-15T19:52:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgwNjYyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505806625", "bodyText": "yml tests don't have nice comparison of float scores\n\nGot it, that's good to know.\n\nBut what I wanted to test is how ES parses this query and what scores are returned.\n\nI guess we already test in DistanceFeatureQueryBuilderTests that the query is parsed correctly, since we check LatLonPointDistanceFeatureQuery has a boost of 1.0f. I also don't see a convenient way to test query scoring in a unit test.", "author": "jtibshirani", "createdAt": "2020-10-15T20:04:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5NDc1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgzNzU0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505837542", "bodyText": "@jtibshirani\n\nI guess we already test in DistanceFeatureQueryBuilderTests that the query is parsed correctly, since we check LatLonPointDistanceFeatureQuery has a boost of 1.0f.\n\nIndeed, the tests in DistanceFeatureQueryBuilderTests should be enough for this PR. I've removed a test from SearchQueryIT.java in 7cbe160.  We can introduce this test on scores later, when we need to test the correct scores.", "author": "mayya-sharipova", "createdAt": "2020-10-15T20:50:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5NDc1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java b/server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java\nindex 967f365c253..1c2fde7adef 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java\n\n@@ -1627,33 +1626,6 @@ public class SearchQueryIT extends ESIntegTestCase {\n         assertHitCount(searchResponse, 2L);\n     }\n \n-    public void testDistanceFeatureQuery() {\n-        assertAcked(prepareCreate(\"test\").setMapping(\"date\", \"type=date\"));\n-        client().prepareIndex(\"test\").setId(\"1\").setSource(\"date\", \"2020-12-03T00:00:00Z\").get();\n-        client().prepareIndex(\"test\").setId(\"2\").setSource(\"date\", \"2020-12-02T00:00:00Z\").get();\n-        client().prepareIndex(\"test\").setId(\"3\").setSource(\"date\", \"2020-12-01T00:00:00Z\").get();\n-        refresh();\n-\n-        DistanceFeatureQueryBuilder dqb = QueryBuilders.distanceFeatureQuery(\n-            \"date\", new DistanceFeatureQueryBuilder.Origin(\"2020-12-01T00:00:00Z\"), \"1d\");\n-        SearchResponse searchResponse = client().prepareSearch(\"test\").setQuery(dqb).get();\n-        assertHitCount(searchResponse, 3L);\n-        SearchHit[] hits = searchResponse.getHits().getHits();\n-        assertEquals(1.0f, hits[0].getScore(), 0.1f);\n-        assertEquals(0.5f, hits[1].getScore(), 0.1f);\n-        assertEquals(0.33f, hits[2].getScore(), 0.1f);\n-\n-        DistanceFeatureQueryBuilder dqb2 = QueryBuilders.distanceFeatureQuery(\n-            \"date\", new DistanceFeatureQueryBuilder.Origin(\"2020-12-01T00:00:00Z\"), \"1d\");\n-        dqb2.boost(2.0f);\n-        SearchResponse searchResponse2 = client().prepareSearch(\"test\").setQuery(dqb2).get();\n-        assertHitCount(searchResponse2, 3L);\n-        SearchHit[] hits2 = searchResponse2.getHits().getHits();\n-        assertEquals(2.0f, hits2[0].getScore(), 0.1f);\n-        assertEquals(1.0f, hits2[1].getScore(), 0.1f);\n-        assertEquals(0.66f, hits2[2].getScore(),0.1f);\n-    }\n-\n     public void testSearchEmptyDoc() {\n         assertAcked(prepareCreate(\"test\").setSettings(\"{\\\"index.analysis.analyzer.default.type\\\":\\\"keyword\\\"}\", XContentType.JSON));\n         client().prepareIndex(\"test\").setId(\"1\").setSource(\"{}\", XContentType.JSON).get();\n"}}, {"oid": "7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5", "url": "https://github.com/elastic/elasticsearch/commit/7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5", "message": "Remove test", "committedDate": "2020-10-15T20:48:00Z", "type": "commit"}]}