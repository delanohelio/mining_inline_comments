{"pr_number": 65917, "pr_title": "Do not mmap() or preload files just for the footer", "pr_createdAt": "2020-12-06T10:48:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65917", "timeline": [{"oid": "1afa3382403ada1ba782d36caa2b4406c5167ce3", "url": "https://github.com/elastic/elasticsearch/commit/1afa3382403ada1ba782d36caa2b4406c5167ce3", "message": "Do not mmap() or preload files just for the footer\n\nToday during replica shard allocation we read the checksum footer for\nevery file (#56933). By default some of these files are opened using\n`mmap()` and are subject to preloading if preloading is configured. This\nis rather wasteful.\n\nThis commit switches these open-and-read-footer operations to use\n`NIOFSDirectory` avoiding the unnecessary preloading step even if it is\nconfigured. This somewhat mitigates #56933, but does not resolve it\nfully since even after this change we still open many more files than we\nreally need to.", "committedDate": "2020-12-06T10:41:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNjQ2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/65917#discussion_r537326465", "bodyText": "Nice to see this context useful :)", "author": "tlrx", "createdAt": "2020-12-07T08:47:12Z", "path": "server/src/main/java/org/elasticsearch/index/store/FsDirectoryFactory.java", "diffHunk": "@@ -149,7 +149,13 @@ public void close() throws IOException {\n             IOUtils.close(super::close, delegate);\n         }\n \n-        boolean useDelegate(String name) {\n+        boolean useDelegate(String name, IOContext ioContext) {\n+            if (ioContext == Store.READONCE_CHECKSUM) {", "originalCommit": "1afa3382403ada1ba782d36caa2b4406c5167ce3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMzNjExMQ==", "url": "https://github.com/elastic/elasticsearch/pull/65917#discussion_r537336111", "bodyText": "Yep, we had a discussion about #56933 on Slack on Friday and then my brain suddenly realised yesterday that in 7.x we already had all the machinery we need to avoid preloading here.", "author": "DaveCTurner", "createdAt": "2020-12-07T09:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNjQ2NQ=="}], "type": "inlineReview", "revised_code": null}]}