{"pr_number": 63764, "pr_title": "Make stack.templates.enabled a dynamic setting", "pr_createdAt": "2020-10-15T18:31:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63764", "timeline": [{"oid": "8e30ccbf2033b5116a67320ceac5136ae2c8af14", "url": "https://github.com/elastic/elasticsearch/commit/8e30ccbf2033b5116a67320ceac5136ae2c8af14", "message": "Make stack.templates.enabled a dynamic setting\n\nThis change allows the setting for disabling the automatically installed stack templates (the\n`logs-*-*`, `metrics-*-*`, and `synthetics-*-*` templates) to be changed dynamically.\n\nAs a byproduct, it also moves thes `IndexTemplateRegistry` to use an `initialize()` method so that\nconstructors are not tempted to use a `this` reference in the constructor (see #37861 for more\ninformation about why to avoid that).\n\nResolves #62835", "committedDate": "2020-10-15T18:27:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMDYwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506210605", "bodyText": "This and the above comment can be removed now", "author": "andreidan", "createdAt": "2020-10-16T09:19:55Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "diffHunk": "@@ -190,6 +191,7 @@ protected Clock getClock() {\n         @SuppressWarnings(\"unused\")", "originalCommit": "8e30ccbf2033b5116a67320ceac5136ae2c8af14", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b476b7f20a4e4187cfb77a6813c9b4b5ecb100b", "chunk": "diff --git a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\nindex 59a6d755711..b5ac23ec719 100644\n--- a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\n+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\n\n@@ -188,7 +187,6 @@ public class IndexLifecycle extends Plugin implements ActionPlugin {\n         components.add(indexLifecycleInitialisationService.get());\n \n         // the template registry is a cluster state listener\n-        @SuppressWarnings(\"unused\")\n         SnapshotLifecycleTemplateRegistry templateRegistry = new SnapshotLifecycleTemplateRegistry(settings, clusterService, threadPool,\n             client, xContentRegistry);\n         templateRegistry.initialize();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMDc1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506210753", "bodyText": "This and the above comment can be removed now", "author": "andreidan", "createdAt": "2020-10-16T09:20:04Z", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "diffHunk": "@@ -180,6 +180,7 @@ protected Clock getClock() {\n         @SuppressWarnings(\"unused\")", "originalCommit": "8e30ccbf2033b5116a67320ceac5136ae2c8af14", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8b476b7f20a4e4187cfb77a6813c9b4b5ecb100b", "chunk": "diff --git a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\nindex 59a6d755711..b5ac23ec719 100644\n--- a/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\n+++ b/x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java\n\n@@ -177,7 +177,6 @@ public class IndexLifecycle extends Plugin implements ActionPlugin {\n                                                Supplier<RepositoriesService> repositoriesServiceSupplier) {\n         final List<Object> components = new ArrayList<>();\n         // This registers a cluster state listener, so appears unused but is not.\n-        @SuppressWarnings(\"unused\")\n         ILMHistoryTemplateRegistry ilmTemplateRegistry =\n             new ILMHistoryTemplateRegistry(settings, clusterService, threadPool, client, xContentRegistry);\n         ilmTemplateRegistry.initialize();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMjQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506212432", "bodyText": "I think this is a bit confusing as to why this happened. Should we also mention that the setting was updated and as a result, the templates will not be installed/reinstalled anymore?", "author": "andreidan", "createdAt": "2020-10-16T09:22:26Z", "path": "x-pack/plugin/stack/src/main/java/org/elasticsearch/xpack/stack/StackTemplateRegistry.java", "diffHunk": "@@ -129,7 +142,27 @@ public StackTemplateRegistry(\n         NamedXContentRegistry xContentRegistry\n     ) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        this.stackTemplateEnabled = StackPlugin.STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+        this.clusterService = clusterService;\n+        this.stackTemplateEnabled = STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        super.initialize();\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(STACK_TEMPLATES_ENABLED, this::updateEnabledSetting);\n+    }\n+\n+    private void updateEnabledSetting(boolean newValue) {\n+        if (newValue) {\n+            this.stackTemplateEnabled = true;\n+        } else {\n+            logger.info(\n+                \"stack composable templates [{}] and component templates [{}] will not be installed or reinstalled\",", "originalCommit": "8e30ccbf2033b5116a67320ceac5136ae2c8af14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNDU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506534569", "bodyText": "the settings infrastructure already logs a message to that effect, so this looks like:\n[2020-10-16T09:16:27,285][INFO ][o.e.c.s.ClusterSettings  ] [runTask-0] updating [stack.templates.enabled] from [true] to [false]\n[2020-10-16T09:16:27,286][INFO ][o.e.x.s.StackTemplateRegistry] [runTask-0] stack composable templates [logs,metrics,synthetics] and component templates [logs-mappings,logs-settings,metrics-mappings,metrics-settings,synthetics-mappings,synthetics-settings] will not be installed or reinstalled\n\nThat's why I left out any mention that the setting was updated (it happens regardless)", "author": "dakrone", "createdAt": "2020-10-16T15:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMjQzMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "8b476b7f20a4e4187cfb77a6813c9b4b5ecb100b", "url": "https://github.com/elastic/elasticsearch/commit/8b476b7f20a4e4187cfb77a6813c9b4b5ecb100b", "message": "Remove suppressed \"unused\" warnings", "committedDate": "2020-10-16T15:17:40Z", "type": "commit"}, {"oid": "0b7e3669081f0f1a0b31d7363446df318bc1c70b", "url": "https://github.com/elastic/elasticsearch/commit/0b7e3669081f0f1a0b31d7363446df318bc1c70b", "message": "Remove comment about unused registry", "committedDate": "2020-10-16T15:20:28Z", "type": "commit"}, {"oid": "5dc9428c507a646ad0e6748345a2178124a95426", "url": "https://github.com/elastic/elasticsearch/commit/5dc9428c507a646ad0e6748345a2178124a95426", "message": "Remove extra comment", "committedDate": "2020-10-16T15:20:57Z", "type": "commit"}]}