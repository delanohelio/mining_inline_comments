{"pr_number": 63540, "pr_title": "add copy_from parameter for set ingest processor", "pr_createdAt": "2020-10-12T09:36:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63540", "timeline": [{"oid": "046d27b5e4e709aaad24870f6da3166713ad2be3", "url": "https://github.com/elastic/elasticsearch/commit/046d27b5e4e709aaad24870f6da3166713ad2be3", "message": "add copy_from parameter for set ingest processor", "committedDate": "2020-10-12T09:07:59Z", "type": "commit"}, {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472", "url": "https://github.com/elastic/elasticsearch/commit/6c5921b2c712974b2aa024c0973a0d03c4aee472", "message": "Merge branch 'master' into setprocessor", "committedDate": "2020-10-30T15:52:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NTgxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515385819", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set `copy_from` while also setting `value`\");\n          \n          \n            \n                                throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set both `copy_from` and `value` in the same processor\");", "author": "danhermann", "createdAt": "2020-10-30T21:14:00Z", "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java", "diffHunk": "@@ -96,16 +109,29 @@ public Factory(ScriptService scriptService) {\n         public SetProcessor create(Map<String, Processor.Factory> registry, String processorTag,\n                                    String description, Map<String, Object> config) throws Exception {\n             String field = ConfigurationUtils.readStringProperty(TYPE, processorTag, config, \"field\");\n-            Object value = ConfigurationUtils.readObject(TYPE, processorTag, config, \"value\");\n+            String copyFrom = ConfigurationUtils.readOptionalStringProperty(TYPE, processorTag, config, \"copy_from\");\n+            ValueSource valueSource = null;\n+            if (copyFrom == null) {\n+                Object value = ConfigurationUtils.readObject(TYPE, processorTag, config, \"value\");\n+                valueSource = ValueSource.wrap(value, scriptService);\n+            } else {\n+                Object value = config.remove(\"value\");\n+                if (value != null) {\n+                    throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set `copy_from` while also setting `value`\");", "originalCommit": "6c5921b2c712974b2aa024c0973a0d03c4aee472", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2818c809961b8457b84e1881c788ce02999cdadd", "chunk": "diff --git a/modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java b/modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java\nindex 2af312e568a..39acd9f36a2 100644\n--- a/modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java\n+++ b/modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java\n\n@@ -117,7 +117,7 @@ public final class SetProcessor extends AbstractProcessor {\n             } else {\n                 Object value = config.remove(\"value\");\n                 if (value != null) {\n-                    throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set `copy_from` while also setting `value`\");\n+                    throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set both `copy_from` and `value` in the same processor\");\n                 }\n             }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NjM3NA==", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515386374", "bodyText": "Can you make a second test method for this test case to make it clear that setting both value and copy_from is an error that should be caught by the factory at creation time?", "author": "danhermann", "createdAt": "2020-10-30T21:15:33Z", "path": "modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java", "diffHunk": "@@ -112,4 +112,21 @@ public void testInvalidMustacheTemplate() throws Exception {\n         assertThat(exception.getMetadata(\"es.processor_tag\").get(0), equalTo(processorTag));\n     }\n \n+    public void testCreateWithCopyFrom() throws Exception {\n+        Map<String, Object> config = new HashMap<>();\n+        config.put(\"field\", \"field1\");\n+        config.put(\"copy_from\", \"field2\");\n+        String processorTag = randomAlphaOfLength(10);\n+        SetProcessor setProcessor = factory.create(null, processorTag, null, config);\n+        assertThat(setProcessor.getTag(), equalTo(processorTag));\n+        assertThat(setProcessor.getField().newInstance(Collections.emptyMap()).execute(), equalTo(\"field1\"));\n+        assertThat(setProcessor.getCopyFrom(), equalTo(\"field2\"));\n+\n+        config.put(\"field\", \"field1\");\n+        config.put(\"value\", \"value1\");\n+        config.put(\"copy_from\", \"field2\");\n+        ElasticsearchException exception = expectThrows(ElasticsearchException.class,\n+            () -> factory.create(null, processorTag, null, config));\n+        assertThat(exception.getMessage(), equalTo(\"[copy_from] cannot set `copy_from` while also setting `value`\"));", "originalCommit": "6c5921b2c712974b2aa024c0973a0d03c4aee472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQ5NTI4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515495284", "bodyText": "OK, I will do that.", "author": "gaobinlong", "createdAt": "2020-10-31T13:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NjM3NA=="}], "type": "inlineReview", "revised_code": {"commit": "31e02872239aba0b9e8655e25ae7c82f8ebaa842", "chunk": "diff --git a/modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java b/modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java\nindex 4a353323f62..be42f697415 100644\n--- a/modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java\n+++ b/modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java\n\n@@ -121,12 +121,16 @@ public class SetProcessorFactoryTests extends ESTestCase {\n         assertThat(setProcessor.getTag(), equalTo(processorTag));\n         assertThat(setProcessor.getField().newInstance(Collections.emptyMap()).execute(), equalTo(\"field1\"));\n         assertThat(setProcessor.getCopyFrom(), equalTo(\"field2\"));\n+    }\n \n+    public void testCreateWithCopyFromAndValue() throws Exception {\n+        Map<String, Object> config = new HashMap<>();\n         config.put(\"field\", \"field1\");\n-        config.put(\"value\", \"value1\");\n         config.put(\"copy_from\", \"field2\");\n+        config.put(\"value\", \"value1\");\n+        String processorTag = randomAlphaOfLength(10);\n         ElasticsearchException exception = expectThrows(ElasticsearchException.class,\n             () -> factory.create(null, processorTag, null, config));\n-        assertThat(exception.getMessage(), equalTo(\"[copy_from] cannot set `copy_from` while also setting `value`\"));\n+        assertThat(exception.getMessage(), equalTo(\"[copy_from] cannot set both `copy_from` and `value` in the same processor\"));\n     }\n }\n"}}, {"oid": "81cda1b7bc1eb0d8b92fc1ee153093b3aa1bede4", "url": "https://github.com/elastic/elasticsearch/commit/81cda1b7bc1eb0d8b92fc1ee153093b3aa1bede4", "message": "Update docs/reference/ingest/processors/set.asciidoc\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>", "committedDate": "2020-10-31T12:49:51Z", "type": "commit"}, {"oid": "e6ee123347dc4a6beae2b2d932987bb5971a4b2c", "url": "https://github.com/elastic/elasticsearch/commit/e6ee123347dc4a6beae2b2d932987bb5971a4b2c", "message": "Update docs/reference/ingest/processors/set.asciidoc\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>", "committedDate": "2020-10-31T12:50:16Z", "type": "commit"}, {"oid": "2818c809961b8457b84e1881c788ce02999cdadd", "url": "https://github.com/elastic/elasticsearch/commit/2818c809961b8457b84e1881c788ce02999cdadd", "message": "Update modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>", "committedDate": "2020-10-31T12:50:33Z", "type": "commit"}, {"oid": "31e02872239aba0b9e8655e25ae7c82f8ebaa842", "url": "https://github.com/elastic/elasticsearch/commit/31e02872239aba0b9e8655e25ae7c82f8ebaa842", "message": "Split the test case", "committedDate": "2020-10-31T12:59:49Z", "type": "commit"}, {"oid": "3926d8b10af03ea871cc0e7dde97371c0169738c", "url": "https://github.com/elastic/elasticsearch/commit/3926d8b10af03ea871cc0e7dde97371c0169738c", "message": "Merge remote-tracking branch 'origin/master' into setprocessor", "committedDate": "2020-10-31T13:01:19Z", "type": "commit"}, {"oid": "87c5b022e24e0c5948a1bdc3df36e17399978a31", "url": "https://github.com/elastic/elasticsearch/commit/87c5b022e24e0c5948a1bdc3df36e17399978a31", "message": "Merge remote-tracking branch 'origin/master' into setprocessor", "committedDate": "2020-11-02T11:01:17Z", "type": "commit"}, {"oid": "4e9b9fe240df216a26fb3c764403a215131a1232", "url": "https://github.com/elastic/elasticsearch/commit/4e9b9fe240df216a26fb3c764403a215131a1232", "message": "format the code", "committedDate": "2020-11-02T13:44:39Z", "type": "commit"}, {"oid": "11c12fff6dd0b8721b76afe2e66525a36b53e7c6", "url": "https://github.com/elastic/elasticsearch/commit/11c12fff6dd0b8721b76afe2e66525a36b53e7c6", "message": "Merge remote-tracking branch 'origin/master' into setprocessor", "committedDate": "2020-11-02T13:51:16Z", "type": "commit"}, {"oid": "46d2f2faf49d738aa63e1911a67a837427692ce7", "url": "https://github.com/elastic/elasticsearch/commit/46d2f2faf49d738aa63e1911a67a837427692ce7", "message": "Merge branch 'master' into setprocessor", "committedDate": "2020-11-02T14:10:49Z", "type": "commit"}]}