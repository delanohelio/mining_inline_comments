{"pr_number": 53481, "pr_title": "Ignore isJoda flag from 7x nodes", "pr_createdAt": "2020-03-12T13:49:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53481", "timeline": [{"oid": "2b985f10553fe2af44826350da2c537dbe5507be", "url": "https://github.com/elastic/elasticsearch/commit/2b985f10553fe2af44826350da2c537dbe5507be", "message": "Ignore isJoda flag from 7x nodes\n\nwhen upgrading from 7.7+ ES will send out a flag indicating if a pattern\nis of joda style. This is only used to support joda style indices in\n7.x, in 8 we no longer support this.  All indices in 8 should use java style pattern.\nHence we can ignore this flag.", "committedDate": "2020-03-12T13:46:04Z", "type": "commit"}, {"oid": "9b3978f40f64203028c4f563ed60e6c1c3bc50cd", "url": "https://github.com/elastic/elasticsearch/commit/9b3978f40f64203028c4f563ed60e6c1c3bc50cd", "message": "Merge branch 'master' into joda/swallow_flag", "committedDate": "2020-03-12T13:48:14Z", "type": "commit"}, {"oid": "1a2109971d89e681120fadcd65f29252cfcd372c", "url": "https://github.com/elastic/elasticsearch/commit/1a2109971d89e681120fadcd65f29252cfcd372c", "message": "unmute", "committedDate": "2020-03-12T13:48:50Z", "type": "commit"}, {"oid": "88c0d1ebfe7941842e99ec128a0ddbfcb546678e", "url": "https://github.com/elastic/elasticsearch/commit/88c0d1ebfe7941842e99ec128a0ddbfcb546678e", "message": "fix version condition", "committedDate": "2020-03-12T14:20:42Z", "type": "commit"}, {"oid": "7bd055c4db5456d92f28c74f3b64dff14a543db0", "url": "https://github.com/elastic/elasticsearch/commit/7bd055c4db5456d92f28c74f3b64dff14a543db0", "message": "serialize write  method", "committedDate": "2020-03-12T15:26:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyMTAwOA==", "url": "https://github.com/elastic/elasticsearch/pull/53481#discussion_r391721008", "bodyText": "I think this should be false", "author": "jaymode", "createdAt": "2020-03-12T15:57:55Z", "path": "server/src/main/java/org/elasticsearch/search/DocValueFormat.java", "diffHunk": "@@ -213,6 +221,13 @@ public void writeTo(StreamOutput out) throws IOException {\n             out.writeString(formatter.pattern());\n             out.writeString(timeZone.getId());\n             out.writeVInt(resolution.ordinal());\n+            if (out.getVersion().onOrAfter(Version.V_7_7_0) && out.getVersion().before(Version.V_8_0_0)) {\n+                /* when serializing to 7.7+  send out a flag indicating if a pattern is of joda style\n+                   This is only used to support joda style indices in 7.x, in 8 we no longer support this.\n+                   All indices in 8 should use java style pattern. Hence this flag is always true.\n+                */\n+                out.writeBoolean(true);", "originalCommit": "7bd055c4db5456d92f28c74f3b64dff14a543db0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyMjczMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53481#discussion_r391722731", "bodyText": "yes :)", "author": "pgomulka", "createdAt": "2020-03-12T16:00:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyMTAwOA=="}], "type": "inlineReview", "revised_code": {"commit": "26ad3792fa22afaddbe414c012daa0a830128362", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/DocValueFormat.java b/server/src/main/java/org/elasticsearch/search/DocValueFormat.java\nindex 872e57583b5..7f681bfa47c 100644\n--- a/server/src/main/java/org/elasticsearch/search/DocValueFormat.java\n+++ b/server/src/main/java/org/elasticsearch/search/DocValueFormat.java\n\n@@ -224,9 +224,9 @@ public interface DocValueFormat extends NamedWriteable {\n             if (out.getVersion().onOrAfter(Version.V_7_7_0) && out.getVersion().before(Version.V_8_0_0)) {\n                 /* when serializing to 7.7+  send out a flag indicating if a pattern is of joda style\n                    This is only used to support joda style indices in 7.x, in 8 we no longer support this.\n-                   All indices in 8 should use java style pattern. Hence this flag is always true.\n+                   All indices in 8 should use java style pattern. Hence this flag is always false.\n                 */\n-                out.writeBoolean(true);\n+                out.writeBoolean(false);\n             }\n         }\n \n"}}, {"oid": "26ad3792fa22afaddbe414c012daa0a830128362", "url": "https://github.com/elastic/elasticsearch/commit/26ad3792fa22afaddbe414c012daa0a830128362", "message": "flag should always be false as it is isJoda flag", "committedDate": "2020-03-12T15:59:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTUyNw==", "url": "https://github.com/elastic/elasticsearch/pull/53481#discussion_r391759527", "bodyText": "I think the in.getVersion().onOrAfter(Version.V_7_7_0) can be removed, but I can understand keeping it for clarity and safety.", "author": "benwtrent", "createdAt": "2020-03-12T16:56:50Z", "path": "server/src/main/java/org/elasticsearch/search/DocValueFormat.java", "diffHunk": "@@ -201,6 +202,13 @@ public DateTime(StreamInput in) throws IOException {\n             String zoneId = in.readString();\n             this.timeZone = ZoneId.of(zoneId);\n             this.resolution = DateFieldMapper.Resolution.ofOrdinal(in.readVInt());\n+            if (in.getVersion().onOrAfter(Version.V_7_7_0) && in.getVersion().before(Version.V_8_0_0)) {", "originalCommit": "26ad3792fa22afaddbe414c012daa0a830128362", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc2NjA0OA==", "url": "https://github.com/elastic/elasticsearch/pull/53481#discussion_r391766048", "bodyText": "you are right, we don't expect mix cluster to work with versions before 7.7. The intention feels cleaner with it to me. I will keep it", "author": "pgomulka", "createdAt": "2020-03-12T17:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTUyNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc1OTkyNA==", "url": "https://github.com/elastic/elasticsearch/pull/53481#discussion_r391759924", "bodyText": "similar comment as before out.getVersion().onOrAfter(Version.V_7_7_0) I don't think is strictly necessary. But nothing wrong with keeping it.", "author": "benwtrent", "createdAt": "2020-03-12T16:57:26Z", "path": "server/src/main/java/org/elasticsearch/search/DocValueFormat.java", "diffHunk": "@@ -213,6 +221,13 @@ public void writeTo(StreamOutput out) throws IOException {\n             out.writeString(formatter.pattern());\n             out.writeString(timeZone.getId());\n             out.writeVInt(resolution.ordinal());\n+            if (out.getVersion().onOrAfter(Version.V_7_7_0) && out.getVersion().before(Version.V_8_0_0)) {", "originalCommit": "26ad3792fa22afaddbe414c012daa0a830128362", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}