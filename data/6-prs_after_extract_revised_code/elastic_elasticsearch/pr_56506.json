{"pr_number": 56506, "pr_title": "Deduplicate Strings in REST Bulk Request Parsing", "pr_createdAt": "2020-05-11T11:16:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56506", "timeline": [{"oid": "0056ba4107eeccd441f0c1bbc9156ddcf52ae253", "url": "https://github.com/elastic/elasticsearch/commit/0056ba4107eeccd441f0c1bbc9156ddcf52ae253", "message": "Deduplicate Strings in REST Bulk Request Parsing\n\nWe can save a little memory here since these strings might live for quite\na while on the coordinating node.", "committedDate": "2020-05-11T10:39:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4ODc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/56506#discussion_r423288757", "bodyText": "If we are going to do this, can we at least add a comment here explaining the intent? Specifically noting that this doesn't save on the actual instantiation of the duplicate strings, only on the lifetime of those duplicates (can be GC'd after parsing is complete).", "author": "rjernst", "createdAt": "2020-05-11T20:07:59Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -115,6 +118,7 @@ public void parse(\n         int line = 0;\n         int from = 0;\n         byte marker = xContent.streamSeparator();\n+        final Map<String, String> stringDeduplicator = new HashMap<>();", "originalCommit": "0056ba4107eeccd441f0c1bbc9156ddcf52ae253", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI5MTgyNA==", "url": "https://github.com/elastic/elasticsearch/pull/56506#discussion_r423291824", "bodyText": "Sure thing, done in 02e3fc4", "author": "original-brownbear", "createdAt": "2020-05-11T20:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4ODc1Nw=="}], "type": "inlineReview", "revised_code": {"commit": "02e3fc42f7b0d29424ee08b634413c6ea64eb09c", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java b/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java\nindex 9b2b43f07c7..da2689d955a 100644\n--- a/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java\n+++ b/server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java\n\n@@ -118,6 +118,9 @@ public final class BulkRequestParser {\n         int line = 0;\n         int from = 0;\n         byte marker = xContent.streamSeparator();\n+        // Bulk requests can contain a lot of repeated strings for the index, pipeline and routing parameters. This map is used to\n+        // deduplicate duplicate strings parsed for these parameters. While it does not prevent instantiating the duplicate strings, it\n+        // reduces their lifetime to the lifetime of this parse call instead of the lifetime of the full bulk request.\n         final Map<String, String> stringDeduplicator = new HashMap<>();\n         while (true) {\n             int nextMarker = findNextMarker(marker, from, data);\n"}}, {"oid": "792447351fe341955ba494d6508a255d73f56f52", "url": "https://github.com/elastic/elasticsearch/commit/792447351fe341955ba494d6508a255d73f56f52", "message": "Merge remote-tracking branch 'elastic/master' into dedup-index-name-in-parser", "committedDate": "2020-05-11T20:08:58Z", "type": "commit"}, {"oid": "02e3fc42f7b0d29424ee08b634413c6ea64eb09c", "url": "https://github.com/elastic/elasticsearch/commit/02e3fc42f7b0d29424ee08b634413c6ea64eb09c", "message": "comment", "committedDate": "2020-05-11T20:13:30Z", "type": "commit"}, {"oid": "5764f6b66e0a5c7bb0f15605f6b730cf2d54f4c7", "url": "https://github.com/elastic/elasticsearch/commit/5764f6b66e0a5c7bb0f15605f6b730cf2d54f4c7", "message": "Merge remote-tracking branch 'elastic/master' into dedup-index-name-in-parser", "committedDate": "2020-05-12T05:40:15Z", "type": "commit"}, {"oid": "7a6e9afbb6a2efc5edc7c8126e756b9e8449ddf8", "url": "https://github.com/elastic/elasticsearch/commit/7a6e9afbb6a2efc5edc7c8126e756b9e8449ddf8", "message": "CR: add test", "committedDate": "2020-05-12T05:59:20Z", "type": "commit"}]}