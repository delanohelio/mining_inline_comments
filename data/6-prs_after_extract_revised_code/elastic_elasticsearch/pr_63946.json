{"pr_number": 63946, "pr_title": "Explicitly retry failed docker pulls", "pr_createdAt": "2020-10-20T15:15:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63946", "timeline": [{"oid": "41a28542b2b7765d8fefda45d51dbce795b955a1", "url": "https://github.com/elastic/elasticsearch/commit/41a28542b2b7765d8fefda45d51dbce795b955a1", "message": "Explicitly retry failed docker pulls\n\nCloses #63869. Perform `docker pull` explicitly instead of as part of\n`docker build`, and wrap it in a retry loop. This is an attempt to make\nthe build more resilient to transient errors.", "committedDate": "2020-10-20T15:13:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY1MDczNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63946#discussion_r508650735", "bodyText": "This should probably compare to maxAttempts?", "author": "rjernst", "createdAt": "2020-10-20T16:03:33Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/docker/DockerBuildTask.java", "diffHunk": "@@ -111,26 +127,57 @@ public DockerBuildAction(ExecOperations execOperations) {\n             this.execOperations = execOperations;\n         }\n \n+        /**\n+         * Wraps `docker pull` in a retry loop, to try and provide some resilience against\n+         * transient errors\n+         * @param baseImage the image to pull.\n+         */\n+        private void pullBaseImage(String baseImage) {\n+            final int maxAttempts = 5;\n+\n+            for (int attempt = 1; attempt <= maxAttempts; attempt++) {\n+                try {\n+                    LoggedExec.exec(execOperations, spec -> {\n+                        spec.executable(\"docker\");\n+                        spec.args(\"pull\");\n+                        spec.args(baseImage);\n+                    });\n+\n+                    break;\n+                } catch (Exception e) {\n+                    LOGGER.warn(\"Attempt {}/{} to pull Docker base image {} failed\", attempt, maxAttempts, baseImage);\n+\n+                    if (attempt == 5) {", "originalCommit": "41a28542b2b7765d8fefda45d51dbce795b955a1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1103051c63e1c08b08f5c5841eeccf1e99c38259", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/docker/DockerBuildTask.java b/buildSrc/src/main/java/org/elasticsearch/gradle/docker/DockerBuildTask.java\nindex 491a72267f5..23df32dc8fc 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/docker/DockerBuildTask.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/docker/DockerBuildTask.java\n\n@@ -143,15 +143,14 @@ public class DockerBuildTask extends DefaultTask {\n                         spec.args(baseImage);\n                     });\n \n-                    break;\n+                    return;\n                 } catch (Exception e) {\n                     LOGGER.warn(\"Attempt {}/{} to pull Docker base image {} failed\", attempt, maxAttempts, baseImage);\n-\n-                    if (attempt == 5) {\n-                        throw new GradleException(\"Failed to pull Docker base image [\" + baseImage + \"], all attempts failed\");\n-                    }\n                 }\n             }\n+\n+            // If we successfully ran `docker pull` above, we would have returned before this point.\n+            throw new GradleException(\"Failed to pull Docker base image [\" + baseImage + \"], all attempts failed\");\n         }\n \n         @Override\n"}}, {"oid": "1103051c63e1c08b08f5c5841eeccf1e99c38259", "url": "https://github.com/elastic/elasticsearch/commit/1103051c63e1c08b08f5c5841eeccf1e99c38259", "message": "Tweak retry structure", "committedDate": "2020-10-21T09:24:45Z", "type": "commit"}, {"oid": "ad8ffd1ee23753a002171ca12b6268e563f47e2f", "url": "https://github.com/elastic/elasticsearch/commit/ad8ffd1ee23753a002171ca12b6268e563f47e2f", "message": "Increase docker pull retries to 10, same as Dockerfile", "committedDate": "2020-10-21T09:25:50Z", "type": "commit"}, {"oid": "d4d49b80c09d726260206d8fd38cbf19391f9634", "url": "https://github.com/elastic/elasticsearch/commit/d4d49b80c09d726260206d8fd38cbf19391f9634", "message": "Merge branch 'master' into 63869-retry-docker-pull", "committedDate": "2020-10-21T10:25:22Z", "type": "commit"}]}