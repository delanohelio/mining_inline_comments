{"pr_number": 55413, "pr_title": "Enable decompression of response within LowLevelRestClient", "pr_createdAt": "2020-04-17T17:33:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55413", "timeline": [{"oid": "7f760d580b074b330a17e4632cb2cd51d2a21754", "url": "https://github.com/elastic/elasticsearch/commit/7f760d580b074b330a17e4632cb2cd51d2a21754", "message": "Reverted initial changes for supporting decompression within the rhlc", "committedDate": "2020-04-17T17:14:09Z", "type": "commit"}, {"oid": "1fc1e4de915208cd72b34c1cf16a5f4777ac5268", "url": "https://github.com/elastic/elasticsearch/commit/1fc1e4de915208cd72b34c1cf16a5f4777ac5268", "message": "Added support for decompression at llrc and added integration test", "committedDate": "2020-04-17T17:18:22Z", "type": "commit"}, {"oid": "15d120199ac27c4510a55e7805707433d5486621", "url": "https://github.com/elastic/elasticsearch/commit/15d120199ac27c4510a55e7805707433d5486621", "message": "Merge branch 'master' into feature-enable-decompression-of-response-within-llrc", "committedDate": "2020-04-17T17:22:17Z", "type": "commit"}, {"oid": "9816d841e7c156db9a6478648c8b6d62c282e06f", "url": "https://github.com/elastic/elasticsearch/commit/9816d841e7c156db9a6478648c8b6d62c282e06f", "message": "Refactored a bit", "committedDate": "2020-04-17T22:26:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjEyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55413#discussion_r425066126", "bodyText": "shall we rename this to the existing test name testCompressesResponseIfRequested and delete the old version? (as this is more thorough as it's reading the body)", "author": "andreidan", "createdAt": "2020-05-14T11:29:30Z", "path": "qa/smoke-test-http/src/test/java/org/elasticsearch/http/HttpCompressionIT.java", "diffHunk": "@@ -57,6 +64,30 @@ public void testUncompressedResponseByDefault() throws IOException {\n         response = client().performRequest(request);\n         assertEquals(201, response.getStatusLine().getStatusCode());\n         assertNull(response.getHeader(HttpHeaders.CONTENT_ENCODING));\n+        assertThat(response.getEntity(), is(not(instanceOf(GzipDecompressingEntity.class))));\n+    }\n+\n+    public void testCompressesGetDocumentResponseIfRequested() throws IOException {", "originalCommit": "9816d841e7c156db9a6478648c8b6d62c282e06f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxMDMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55413#discussion_r425510315", "bodyText": "Sure, just fixed it", "author": "Hakky54", "createdAt": "2020-05-15T01:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjEyNg=="}], "type": "inlineReview", "revised_code": {"commit": "90242743fe7b53aec1a328112211f59c2154abfd", "chunk": "diff --git a/qa/smoke-test-http/src/test/java/org/elasticsearch/http/HttpCompressionIT.java b/qa/smoke-test-http/src/test/java/org/elasticsearch/http/HttpCompressionIT.java\nindex 4b46ddf0a84..2f1a8b004fb 100644\n--- a/qa/smoke-test-http/src/test/java/org/elasticsearch/http/HttpCompressionIT.java\n+++ b/qa/smoke-test-http/src/test/java/org/elasticsearch/http/HttpCompressionIT.java\n\n@@ -44,30 +44,6 @@ public class HttpCompressionIT extends ESRestTestCase {\n         \"}\";\n \n     public void testCompressesResponseIfRequested() throws IOException {\n-        Request request = new Request(\"GET\", \"/\");\n-        RequestOptions.Builder options = request.getOptions().toBuilder();\n-        options.addHeader(HttpHeaders.ACCEPT_ENCODING, GZIP_ENCODING);\n-        request.setOptions(options);\n-        Response response = client().performRequest(request);\n-        assertEquals(200, response.getStatusLine().getStatusCode());\n-        assertEquals(GZIP_ENCODING, response.getHeader(HttpHeaders.CONTENT_ENCODING));\n-        assertThat(response.getEntity(), instanceOf(GzipDecompressingEntity.class));\n-    }\n-\n-    public void testUncompressedResponseByDefault() throws IOException {\n-        Response response = client().performRequest(new Request(\"GET\", \"/\"));\n-        assertEquals(200, response.getStatusLine().getStatusCode());\n-        assertNull(response.getHeader(HttpHeaders.CONTENT_ENCODING));\n-\n-        Request request = new Request(\"POST\", \"/company/_doc/1\");\n-        request.setJsonEntity(SAMPLE_DOCUMENT);\n-        response = client().performRequest(request);\n-        assertEquals(201, response.getStatusLine().getStatusCode());\n-        assertNull(response.getHeader(HttpHeaders.CONTENT_ENCODING));\n-        assertThat(response.getEntity(), is(not(instanceOf(GzipDecompressingEntity.class))));\n-    }\n-\n-    public void testCompressesGetDocumentResponseIfRequested() throws IOException {\n         Request request = new Request(\"POST\", \"/company/_doc/2\");\n         request.setJsonEntity(SAMPLE_DOCUMENT);\n         Response response = client().performRequest(request);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjQ4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55413#discussion_r425066481", "bodyText": "these high level rest client decompression tests are still valid right?", "author": "andreidan", "createdAt": "2020-05-14T11:30:06Z", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/RestHighLevelClientTests.java", "diffHunk": "@@ -326,59 +322,6 @@ public void testParseEntity() throws IOException {\n         }\n     }\n \n-    public void testParseCompressedEntity() throws IOException {", "originalCommit": "9816d841e7c156db9a6478648c8b6d62c282e06f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUxNTE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/55413#discussion_r425515164", "bodyText": "Well the decompression happens within the llrc when executing request and parsing the response. When the response is given to the rhlc the compressed data is already decompressed. In any kind of scenario the rhlc will always get a decompressed http enity, so therefor I can't unit test that method within the rhlc anymore.\nWhat do you think, should we drop this unit test or do you think there is a way to validate this use case within the rhlc?", "author": "Hakky54", "createdAt": "2020-05-15T01:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjQ4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5MTcxNg==", "url": "https://github.com/elastic/elasticsearch/pull/55413#discussion_r425691716", "bodyText": "Sorry, I was a bit confused as we previously dropped the mocks in this test, but you're right, the decompression is not a parseEntity matter anymore.\nMy aim was to make sure we test the HLRC, irrespective of who in the implementation chain performs it (it is now the LLRC's responsibility but that might change).\nAfter looking at this a bit closer we are covered here by the HighLevelRestClientCompressionIT which makes sure the HLRC is tested.", "author": "andreidan", "createdAt": "2020-05-15T09:50:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA2NjQ4MQ=="}], "type": "inlineReview", "revised_code": null}, {"oid": "90242743fe7b53aec1a328112211f59c2154abfd", "url": "https://github.com/elastic/elasticsearch/commit/90242743fe7b53aec1a328112211f59c2154abfd", "message": "Applied feedback", "committedDate": "2020-05-15T01:01:35Z", "type": "commit"}, {"oid": "15b49dd17498488e06abee0b9771067cb6a3916e", "url": "https://github.com/elastic/elasticsearch/commit/15b49dd17498488e06abee0b9771067cb6a3916e", "message": "Merge branch 'master' into feature-enable-decompression-of-response-within-llrc", "committedDate": "2020-05-15T10:54:55Z", "type": "commit"}]}