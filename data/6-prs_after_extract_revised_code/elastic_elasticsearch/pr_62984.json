{"pr_number": 62984, "pr_title": "System index auto-creation should not be disabled by user settings", "pr_createdAt": "2020-09-28T21:13:00Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62984", "timeline": [{"oid": "872af2e8f7630443deba95dc3aa955186a0de688", "url": "https://github.com/elastic/elasticsearch/commit/872af2e8f7630443deba95dc3aa955186a0de688", "message": "Add System Indices check to AutoCreateIndex\n\nBy default, Elasticsearch auto-creates indices when a document is\nsubmitted to a non-existent index. There is a setting that allows users\nto disable this behavior. However, this setting should not apply to\nsystem indices, so that Elasticsearch modules and plugins are able to\nuse auto-create behavior whether or not it is exposed to users.\n\nThis commit constructs the AutoCreateIndex object with a reference to\nthe SystemIndices object so that we bypass the check for the user-facing\nautocreate setting when it's a system index that is being autocreated.\n\nWe also modify the logic in TransportBulkAction to make sure that if a\nsystem index is included in a bulk request, we don't skip the\nautocreation step.", "committedDate": "2020-09-28T20:58:50Z", "type": "commit"}, {"oid": "339124729be2d4dc919fda12c818dd1286b86285", "url": "https://github.com/elastic/elasticsearch/commit/339124729be2d4dc919fda12c818dd1286b86285", "message": "Make sure to use system indices when constructing autocreateindex", "committedDate": "2020-09-29T15:18:43Z", "type": "commit"}, {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee", "url": "https://github.com/elastic/elasticsearch/commit/7c906cfeade7063c8d115bb800d0377530edd0ee", "message": "Refactor duplicated logic", "committedDate": "2020-09-29T16:10:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDM5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496974396", "bodyText": "Nitpick: I'd recommend changing the name some something like .test-system-index, just to make it a bit more immediately obvious what's going on rather than using a generic .foo here because this is shared across tests.", "author": "gwbrown", "createdAt": "2020-09-29T19:10:24Z", "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "diffHunk": "@@ -201,8 +210,9 @@ private static ClusterState buildClusterState(String... indices) {\n     }\n \n     private AutoCreateIndex newAutoCreateIndex(Settings settings) {\n+        SystemIndices systemIndices = new SystemIndices(Map.of(\"plugin\", List.of(new SystemIndexDescriptor(\".foo\", \"\"))));", "originalCommit": "7c906cfeade7063c8d115bb800d0377530edd0ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQyODI1OA==", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r497428258", "bodyText": "Good call. I'll make it a constant too so that it's easier to find usages.", "author": "williamrandolph", "createdAt": "2020-09-30T11:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDM5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "cac0e245c666aac693ac70325c5bffc1410a75de", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java b/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\nindex 3b24a85cc5a..cb59a52a343 100644\n--- a/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\n\n@@ -210,7 +212,7 @@ public class AutoCreateIndexTests extends ESTestCase {\n     }\n \n     private AutoCreateIndex newAutoCreateIndex(Settings settings) {\n-        SystemIndices systemIndices = new SystemIndices(Map.of(\"plugin\", List.of(new SystemIndexDescriptor(\".foo\", \"\"))));\n+        SystemIndices systemIndices = new SystemIndices(Map.of(\"plugin\", List.of(new SystemIndexDescriptor(TEST_SYSTEM_INDEX_NAME, \"\"))));\n         return new AutoCreateIndex(settings, new ClusterSettings(settings,\n                 ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), new IndexNameExpressionResolver(), systemIndices);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3ODg0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496978845", "bodyText": "You've already noted in this in the PR description, but this is going to conflict with https://github.com/elastic/elasticsearch/pull/61858/files?file-filters%5B%5D=.java#diff-7c2a294c3d25c427072ee6c64983b560L227 specifically. I think this is the only place they'll meaningfully conflict, though.", "author": "gwbrown", "createdAt": "2020-09-29T19:15:35Z", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -224,7 +224,9 @@ protected void doInternalExecute(Task task, BulkRequest bulkRequest, String exec\n             return;\n         }\n \n-        if (needToCheck()) {\n+        final boolean includesSystem = includesSystem(bulkRequest, clusterService.state().metadata().getIndicesLookup(), systemIndices);\n+\n+        if (includesSystem || needToCheck()) {", "originalCommit": "7c906cfeade7063c8d115bb800d0377530edd0ee", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MjQ4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496992481", "bodyText": "Another good unit test would be a pattern specifically excluding the system index, e.g. action.auto_create_index=*,-.foo. We still want system indices to be auto-created in that case, I think, and it would be good to double check.", "author": "gwbrown", "createdAt": "2020-09-29T19:31:03Z", "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "diffHunk": "@@ -89,6 +91,12 @@ public void testAutoCreationDisabled() {\n         assertEquals(\"no such index [\" + randomIndex + \"] and [action.auto_create_index] is [false]\", e.getMessage());\n     }\n \n+    public void testSystemIndexWithAutoCreationDisabled() {", "originalCommit": "7c906cfeade7063c8d115bb800d0377530edd0ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI2ODIyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r498268221", "bodyText": "I've added this.", "author": "williamrandolph", "createdAt": "2020-10-01T14:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MjQ4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "cac0e245c666aac693ac70325c5bffc1410a75de", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java b/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\nindex 3b24a85cc5a..cb59a52a343 100644\n--- a/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java\n\n@@ -94,7 +96,7 @@ public class AutoCreateIndexTests extends ESTestCase {\n     public void testSystemIndexWithAutoCreationDisabled() {\n         Settings settings = Settings.builder().put(AutoCreateIndex.AUTO_CREATE_INDEX_SETTING.getKey(), false).build();\n         AutoCreateIndex autoCreateIndex = newAutoCreateIndex(settings);\n-        assertThat(autoCreateIndex.shouldAutoCreate(\".foo\", buildClusterState()), equalTo(true));\n+        assertThat(autoCreateIndex.shouldAutoCreate(TEST_SYSTEM_INDEX_NAME, buildClusterState()), equalTo(true));\n     }\n \n     public void testAutoCreationEnabled() {\n"}}, {"oid": "cac0e245c666aac693ac70325c5bffc1410a75de", "url": "https://github.com/elastic/elasticsearch/commit/cac0e245c666aac693ac70325c5bffc1410a75de", "message": "Rename shared test index for clarity", "committedDate": "2020-09-30T11:12:19Z", "type": "commit"}, {"oid": "288822f3234d88cc5380eb02fb6952e8c853309e", "url": "https://github.com/elastic/elasticsearch/commit/288822f3234d88cc5380eb02fb6952e8c853309e", "message": "Auto-create disable pattern shouldn't apply to system index", "committedDate": "2020-09-30T20:20:43Z", "type": "commit"}]}