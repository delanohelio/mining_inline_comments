{"pr_number": 63500, "pr_title": "Add deprecation warning for removed strict_duplicate_detection setting", "pr_createdAt": "2020-10-08T16:16:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63500", "timeline": [{"oid": "e88e5aed8be8af618e4442b4e7c27a79be4d9745", "url": "https://github.com/elastic/elasticsearch/commit/e88e5aed8be8af618e4442b4e7c27a79be4d9745", "message": "Add deprecation warning for removed setting\n\nThe setting es.xcontent.strict_duplicate_detection was removed in 7.0\n(see #34588). It was an undocumented setting, but enough users relied\non it that its absence is causing problems during upgrades. This commit\nadds a message to the deprecation log if this setting is present at\nstartup.", "committedDate": "2020-10-08T14:57:55Z", "type": "commit"}, {"oid": "bffeb3d34b4f48064257b3d966095ee7e4d86161", "url": "https://github.com/elastic/elasticsearch/commit/bffeb3d34b4f48064257b3d966095ee7e4d86161", "message": "Spotless formatting", "committedDate": "2020-10-08T17:04:32Z", "type": "commit"}, {"oid": "7f077298bcb7c2ef51e4d3d9338fbacb2acb9636", "url": "https://github.com/elastic/elasticsearch/commit/7f077298bcb7c2ef51e4d3d9338fbacb2acb9636", "message": "Avoid forbidden API", "committedDate": "2020-10-08T17:42:22Z", "type": "commit"}, {"oid": "7b85113806d611249ada3ba0e2fcc953b9e6306c", "url": "https://github.com/elastic/elasticsearch/commit/7b85113806d611249ada3ba0e2fcc953b9e6306c", "message": "Reset between custom config tests", "committedDate": "2020-10-08T21:12:13Z", "type": "commit"}, {"oid": "263dc7c01571640a85216912713629aee1fc7552", "url": "https://github.com/elastic/elasticsearch/commit/263dc7c01571640a85216912713629aee1fc7552", "message": "Spotless apply", "committedDate": "2020-10-08T21:17:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNTM0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63500#discussion_r502035347", "bodyText": "I don't think install should be in a Before. This means we would reinstall before each test, which is costly. The packaging tests are generally written to cleanup after themselves, so deleting the installation should not be necessary?", "author": "rjernst", "createdAt": "2020-10-08T21:57:00Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/ConfigurationTests.java", "diffHunk": "@@ -22,22 +22,44 @@\n import org.apache.http.client.fluent.Request;\n import org.elasticsearch.packaging.util.FileUtils;\n import org.elasticsearch.packaging.util.Platforms;\n+import org.junit.After;\n import org.junit.Before;\n \n+import java.nio.file.Files;\n+import java.util.List;\n+\n+import static java.nio.file.StandardOpenOption.APPEND;\n+import static java.nio.file.StandardOpenOption.CREATE;\n import static org.elasticsearch.packaging.util.FileUtils.append;\n import static org.elasticsearch.packaging.util.ServerUtils.makeRequest;\n+import static org.hamcrest.CoreMatchers.containsString;\n import static org.hamcrest.Matchers.equalTo;\n import static org.junit.Assume.assumeFalse;\n \n public class ConfigurationTests extends PackagingTestCase {\n \n     @Before\n-    public void filterDistros() {\n+    public void filterDistrosAndInstall() throws Exception {\n         assumeFalse(\"no docker\", distribution.isDocker());\n+        install();", "originalCommit": "263dc7c01571640a85216912713629aee1fc7552", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3MjgzNA==", "url": "https://github.com/elastic/elasticsearch/pull/63500#discussion_r503472834", "bodyText": "I'm getting errors when I don't reinstall. I'll dig on it.", "author": "williamrandolph", "createdAt": "2020-10-12T18:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNTM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkzNjYyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/63500#discussion_r503936621", "bodyText": "I found the problem. I am going to fix it in a different PR because it's unrelated to this ticket and it ought to be fixed on master as well.", "author": "williamrandolph", "createdAt": "2020-10-13T13:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNTM0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "e582ba33f23f69a6daabdc5a7bf09b4812ffe50a", "chunk": "diff --git a/qa/os/src/test/java/org/elasticsearch/packaging/test/ConfigurationTests.java b/qa/os/src/test/java/org/elasticsearch/packaging/test/ConfigurationTests.java\nindex ee9f89831a9..57b5d9c5b7e 100644\n--- a/qa/os/src/test/java/org/elasticsearch/packaging/test/ConfigurationTests.java\n+++ b/qa/os/src/test/java/org/elasticsearch/packaging/test/ConfigurationTests.java\n\n@@ -22,7 +22,6 @@ package org.elasticsearch.packaging.test;\n import org.apache.http.client.fluent.Request;\n import org.elasticsearch.packaging.util.FileUtils;\n import org.elasticsearch.packaging.util.Platforms;\n-import org.junit.After;\n import org.junit.Before;\n \n import java.nio.file.Files;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNTYyNA==", "url": "https://github.com/elastic/elasticsearch/pull/63500#discussion_r502035624", "bodyText": "Why using System.getProperty here, but BootstrapInfo above?", "author": "rjernst", "createdAt": "2020-10-08T21:57:44Z", "path": "server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java", "diffHunk": "@@ -363,6 +363,14 @@ static void init(\n                             System.getProperty(\"java.home\"));\n             DeprecationLogger.getLogger(Bootstrap.class).deprecate(\"java_version_11_required\", message);\n         }\n+        if (BootstrapInfo.getSystemProperties().get(\"es.xcontent.strict_duplicate_detection\") != null) {\n+            final String message = String.format(\n+                Locale.ROOT,\n+                \"The Java option es.xcontent.strict_duplicate_detection is set to [%s]; \" +\n+                    \"this option is deprecated and non-functional and should be removed from Java configuration.\",\n+                System.getProperty(\"es.xcontent.strict_duplicate_detection\"));", "originalCommit": "263dc7c01571640a85216912713629aee1fc7552", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ3MjU4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63500#discussion_r503472587", "bodyText": "Good catch. Initially I used System.getProperty in both places, but the Forbidden APIs check only caught the use in the conditional. I'll make it consistent.", "author": "williamrandolph", "createdAt": "2020-10-12T18:45:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzNTYyNA=="}], "type": "inlineReview", "revised_code": {"commit": "4eb31d92c75b955bd8b05aa50a11396901f085b9", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java b/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java\nindex eac29581d66..985e514ba56 100644\n--- a/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java\n+++ b/server/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java\n\n@@ -368,7 +368,7 @@ final class Bootstrap {\n                 Locale.ROOT,\n                 \"The Java option es.xcontent.strict_duplicate_detection is set to [%s]; \" +\n                     \"this option is deprecated and non-functional and should be removed from Java configuration.\",\n-                System.getProperty(\"es.xcontent.strict_duplicate_detection\"));\n+                BootstrapInfo.getSystemProperties().get(\"es.xcontent.strict_duplicate_detection\"));\n             DeprecationLogger.getLogger(Bootstrap.class).deprecate(\"strict_duplicate_detection_setting_removed\", message);\n         }\n         if (environment.pidFile() != null) {\n"}}, {"oid": "4eb31d92c75b955bd8b05aa50a11396901f085b9", "url": "https://github.com/elastic/elasticsearch/commit/4eb31d92c75b955bd8b05aa50a11396901f085b9", "message": "Access system properties consistently", "committedDate": "2020-10-13T13:10:40Z", "type": "commit"}, {"oid": "e582ba33f23f69a6daabdc5a7bf09b4812ffe50a", "url": "https://github.com/elastic/elasticsearch/commit/e582ba33f23f69a6daabdc5a7bf09b4812ffe50a", "message": "Revert changes to ConfigurationTests setup", "committedDate": "2020-10-13T16:05:54Z", "type": "commit"}, {"oid": "a5919e8bbb7f6e0e610ab96d6f14a067316efb33", "url": "https://github.com/elastic/elasticsearch/commit/a5919e8bbb7f6e0e610ab96d6f14a067316efb33", "message": "Merge branch '7.x' into duplicate-detection-deprecation", "committedDate": "2020-10-14T15:13:48Z", "type": "commit"}, {"oid": "28ef7c90baff41009184575c3fcb47a5302c8838", "url": "https://github.com/elastic/elasticsearch/commit/28ef7c90baff41009184575c3fcb47a5302c8838", "message": "Merge branch '7.x' into duplicate-detection-deprecation", "committedDate": "2020-12-18T16:21:24Z", "type": "commit"}]}