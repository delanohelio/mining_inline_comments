{"pr_number": 56034, "pr_title": "Move includeDataStream flag from IndicesOptions to IndexNameExpressionResolver.Context", "pr_createdAt": "2020-04-30T13:57:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56034", "timeline": [{"oid": "f9c0ce5c098b40bbb34159824ed4b3391b01ffab", "url": "https://github.com/elastic/elasticsearch/commit/f9c0ce5c098b40bbb34159824ed4b3391b01ffab", "message": "Move includeDataStream flag from an IndicesOptions to IndexNameExpressionResolver.Context\nas a dedicated field that callers to IndexNameExpressionResolver can set.", "committedDate": "2020-04-30T13:56:19Z", "type": "commit"}, {"oid": "2aee02623ad6707d6894b283962be5ddf9fb9c54", "url": "https://github.com/elastic/elasticsearch/commit/2aee02623ad6707d6894b283962be5ddf9fb9c54", "message": "fixed test compile errors.", "committedDate": "2020-04-30T14:19:29Z", "type": "commit"}, {"oid": "3351ebceba121b1a4b30e06612aeeb9d139e2f55", "url": "https://github.com/elastic/elasticsearch/commit/3351ebceba121b1a4b30e06612aeeb9d139e2f55", "message": "fixed tests", "committedDate": "2020-04-30T14:45:43Z", "type": "commit"}, {"oid": "e51edc22aab566c12328cd8ac9d08b9913bc686a", "url": "https://github.com/elastic/elasticsearch/commit/e51edc22aab566c12328cd8ac9d08b9913bc686a", "message": "Also alter indices stats api to support data streams.\nThe rollover api uses this api and otherwise rolling over data stream does no longer work.", "committedDate": "2020-04-30T15:04:04Z", "type": "commit"}, {"oid": "1d84e8e6f80c220d6320fd6bcd1a32bb503f2fc3", "url": "https://github.com/elastic/elasticsearch/commit/1d84e8e6f80c220d6320fd6bcd1a32bb503f2fc3", "message": "fixed tests", "committedDate": "2020-04-30T15:49:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4Mzc5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56034#discussion_r418183796", "bodyText": "Note that this PR also adjusts the indices stats api in order to support resolving data streams. This is needed because rollover uses that api and we made that api already data stream ready. The reason why before we didn't have the change the indices stats api, is because rollover api overrides the default indices option when calling the indices stats api.", "author": "martijnvg", "createdAt": "2020-04-30T17:47:50Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/stats/TransportIndicesStatsAction.java", "diffHunk": "@@ -57,6 +57,11 @@ public TransportIndicesStatsAction(ClusterService clusterService, TransportServi\n         this.indicesService = indicesService;\n     }\n \n+    @Override\n+    protected boolean shouldIncludeDataStreams() {", "originalCommit": "1d84e8e6f80c220d6320fd6bcd1a32bb503f2fc3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU3ODQ3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56034#discussion_r419578471", "bodyText": "This is fine.\nBut it made me wonder why we collect indices stats for all indices when we only use the stats for the write index?", "author": "henningandersen", "createdAt": "2020-05-04T16:50:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE4Mzc5Ng=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYwMDkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/56034#discussion_r419600914", "bodyText": "I am not sure this ignores data streams anymore? Maybe change the comment to \"test with allow no indexes\"?", "author": "henningandersen", "createdAt": "2020-05-04T17:25:48Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolverTests.java", "diffHunk": "@@ -1533,15 +1533,15 @@ public void testDataStreamResolution() {\n             // Resolve data streams:\n             SearchRequest searchRequest = new SearchRequest();\n             searchRequest.indices(\"logs-*\");\n-            searchRequest.indicesOptions(IndicesOptions.fromOptions(false, false, true, false, false, true, true, true, true, true));\n+            searchRequest.indicesOptions(IndicesOptions.fromOptions(false, false, true, false, false, true, true, true, true));\n             ResolvedIndices resolvedIndices = defaultIndicesResolver.resolveIndicesAndAliases(searchRequest, metadata, authorizedIndices);\n             assertThat(resolvedIndices.getLocal(), contains(\"logs-foobar\"));\n             assertThat(resolvedIndices.getRemote(), emptyIterable());\n \n             // Ignore data streams:", "originalCommit": "1d84e8e6f80c220d6320fd6bcd1a32bb503f2fc3", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3fafc3b688547e87a12f81015dad70b73919658d", "chunk": "diff --git a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolverTests.java b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolverTests.java\nindex 0476bed9cdb..45aff91a93e 100644\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolverTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolverTests.java\n\n@@ -1538,7 +1538,7 @@ public class IndicesAndAliasesResolverTests extends ESTestCase {\n             assertThat(resolvedIndices.getLocal(), contains(\"logs-foobar\"));\n             assertThat(resolvedIndices.getRemote(), emptyIterable());\n \n-            // Ignore data streams:\n+            // Data streams with allow no indices:\n             searchRequest = new SearchRequest();\n             searchRequest.indices(\"logs-*\");\n             searchRequest.indicesOptions(IndicesOptions.fromOptions(false, true, true, false, false, true, true, true, true));\n"}}, {"oid": "60b4279ae3143b1e948971c526eb1bb410982d06", "url": "https://github.com/elastic/elasticsearch/commit/60b4279ae3143b1e948971c526eb1bb410982d06", "message": "Merge remote-tracking branch 'es/master' into refactor_include_data_streams_flag", "committedDate": "2020-05-04T17:39:50Z", "type": "commit"}, {"oid": "3fafc3b688547e87a12f81015dad70b73919658d", "url": "https://github.com/elastic/elasticsearch/commit/3fafc3b688547e87a12f81015dad70b73919658d", "message": "iter", "committedDate": "2020-05-04T17:41:53Z", "type": "commit"}]}