{"pr_number": 58764, "pr_title": "Fix types deprecation warning for put mapping.", "pr_createdAt": "2020-06-30T17:23:11Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58764", "timeline": [{"oid": "cc33a204277fac993cf296041ca637d1644e816d", "url": "https://github.com/elastic/elasticsearch/commit/cc33a204277fac993cf296041ca637d1644e816d", "message": "Fix types deprecation warning for put mapping.", "committedDate": "2020-06-30T17:11:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4Nzc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58764#discussion_r447887766", "bodyText": "If I  set up include_type_name=true, do we still want to allow typed \"put mapping request\" ?\nFrom what it looks like now, my typed request will fail even if I set include_type_name=true.", "author": "mayya-sharipova", "createdAt": "2020-06-30T18:17:38Z", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestPutMappingAction.java", "diffHunk": "@@ -81,19 +81,19 @@ public String getName() {\n     public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n         PutMappingRequest putMappingRequest = putMappingRequest(Strings.splitStringByCommaToArray(request.param(\"index\")));\n \n-        boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER,\n-            DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n         String type = request.param(\"type\");\n         Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false,\n             request.getXContentType()).v2();\n \n-        if (includeTypeName) {\n+        if (request.hasParam(INCLUDE_TYPE_NAME_PARAMETER) == false) {\n             deprecationLogger.deprecatedAndMaybeLog(\"put_mapping_with_types\", TYPES_DEPRECATION_MESSAGE);\n         } else if (type != null || isMappingSourceTyped(MapperService.SINGLE_MAPPING_NAME, sourceAsMap)) {", "originalCommit": "cc33a204277fac993cf296041ca637d1644e816d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4ODc3NA==", "url": "https://github.com/elastic/elasticsearch/pull/58764#discussion_r447888774", "bodyText": "+1 I am fixing this logic now, it was also caught by our tests.", "author": "jtibshirani", "createdAt": "2020-06-30T18:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg4Nzc2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "478ceb9ae66381d807c9aac93032caabbae5aff6", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestPutMappingAction.java b/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestPutMappingAction.java\nindex f22baeb9495..eda9af7c2ae 100644\n--- a/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestPutMappingAction.java\n+++ b/server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestPutMappingAction.java\n\n@@ -87,13 +87,15 @@ public class RestPutMappingAction extends BaseRestHandler {\n \n         if (request.hasParam(INCLUDE_TYPE_NAME_PARAMETER) == false) {\n             deprecationLogger.deprecatedAndMaybeLog(\"put_mapping_with_types\", TYPES_DEPRECATION_MESSAGE);\n-        } else if (type != null || isMappingSourceTyped(MapperService.SINGLE_MAPPING_NAME, sourceAsMap)) {\n-            throw new IllegalArgumentException(\"Types cannot be provided in put mapping requests, unless \" +\n-                \"the include_type_name parameter is set to true.\");\n         }\n \n         boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER,\n             DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+        if (includeTypeName == false && (type != null || isMappingSourceTyped(MapperService.SINGLE_MAPPING_NAME, sourceAsMap))) {\n+            throw new IllegalArgumentException(\"Types cannot be provided in put mapping requests, unless \" +\n+                \"the include_type_name parameter is set to true.\");\n+        }\n+\n         putMappingRequest.type(includeTypeName ? type : MapperService.SINGLE_MAPPING_NAME);\n         putMappingRequest.source(sourceAsMap);\n \n"}}, {"oid": "478ceb9ae66381d807c9aac93032caabbae5aff6", "url": "https://github.com/elastic/elasticsearch/commit/478ceb9ae66381d807c9aac93032caabbae5aff6", "message": "Correct logic for checking include_type_name.", "committedDate": "2020-06-30T18:20:01Z", "type": "commit"}]}