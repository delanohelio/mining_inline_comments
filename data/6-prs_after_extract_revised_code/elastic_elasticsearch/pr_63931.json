{"pr_number": 63931, "pr_title": "make sure AggregationTest creates reduced aggregations.", "pr_createdAt": "2020-10-20T12:15:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63931", "timeline": [{"oid": "8bbdb64473aaa483d245d8f3f2afd93021531d19", "url": "https://github.com/elastic/elasticsearch/commit/8bbdb64473aaa483d245d8f3f2afd93021531d19", "message": "make sure aggregation list has at least one element", "committedDate": "2020-10-20T12:08:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508462418", "bodyText": "I don't think this is the right fix. The tests that fail are the one that always expect a reduced aggregation so they require a single element. That's why InternalAggregationTestCase#createTestInstanceForXContent was added but it's not used in AggregationsTests. See \n  \n    \n      elasticsearch/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java\n    \n    \n         Line 299\n      in\n      f20699e\n    \n    \n    \n    \n\n        \n          \n           aggs.add(testCase.createTestInstance()); \n        \n    \n  \n\n where replacing the call with createTestInstanceForXContent fixes all the failures.", "author": "jimczi", "createdAt": "2020-10-20T12:35:08Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java", "diffHunk": "@@ -91,7 +91,7 @@ protected InternalScriptedMetric createTestInstance(String name, Map<String, Obj\n     }\n \n     private List<Object> randomAggregations() {\n-        return randomList(randomBoolean() ? 1 : 5, this::randomAggregation);\n+        return randomList(1, randomBoolean() ? 1 : 5, this::randomAggregation);", "originalCommit": "8bbdb64473aaa483d245d8f3f2afd93021531d19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2OTQwMA==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508469400", "bodyText": "Yeah. I think the correct fix is in AggregationsTests.java to replace:\n            aggs.add(testCase.createTestInstance());\n\nwith:\n            aggs.add(testCase.createTestInstanceForXContent());\n\nI had long forgotten about this test!", "author": "nik9000", "createdAt": "2020-10-20T12:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ3OTk5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508479997", "bodyText": "ups, thanks @jimczi you are right. I guess we will need to make that method accessible to the test as currently is protected.", "author": "iverase", "createdAt": "2020-10-20T13:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA=="}], "type": "inlineReview", "revised_code": {"commit": "cca16eaa99c77b4f8f6e34f8da81ad3d390e2e47", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java\nindex 04d0c1ef498..5201c3646d9 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java\n\n@@ -91,7 +91,7 @@ public class InternalScriptedMetricTests extends InternalAggregationTestCase<Int\n     }\n \n     private List<Object> randomAggregations() {\n-        return randomList(1, randomBoolean() ? 1 : 5, this::randomAggregation);\n+        return randomList(randomBoolean() ? 1 : 5, this::randomAggregation);\n     }\n \n     @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n"}}, {"oid": "cca16eaa99c77b4f8f6e34f8da81ad3d390e2e47", "url": "https://github.com/elastic/elasticsearch/commit/cca16eaa99c77b4f8f6e34f8da81ad3d390e2e47", "message": "apply fix by making createTestInstanceForXContent accessible to the test", "committedDate": "2020-10-20T12:59:26Z", "type": "commit"}]}