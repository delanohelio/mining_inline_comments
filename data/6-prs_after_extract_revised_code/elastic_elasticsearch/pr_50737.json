{"pr_number": 50737, "pr_title": "Refactor GeoShape tests to GeoShape and GeoPoint", "pr_createdAt": "2020-01-08T12:12:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50737", "timeline": [{"oid": "a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "url": "https://github.com/elastic/elasticsearch/commit/a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-15T18:05:23Z", "type": "commit"}, {"oid": "478cee77cd823009bf0f7ac7a622e09ca3efc35f", "url": "https://github.com/elastic/elasticsearch/commit/478cee77cd823009bf0f7ac7a622e09ca3efc35f", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-18T17:17:59Z", "type": "commit"}, {"oid": "ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "url": "https://github.com/elastic/elasticsearch/commit/ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "message": "WIP subclassing GeoShapeQueryTests.java", "committedDate": "2019-11-19T12:34:44Z", "type": "commit"}, {"oid": "5d3c189b8cdaf9d644af94399d15e6207a19594d", "url": "https://github.com/elastic/elasticsearch/commit/5d3c189b8cdaf9d644af94399d15e6207a19594d", "message": "WIP writing GeoPointShapeQueryTests.java", "committedDate": "2019-11-19T19:58:13Z", "type": "commit"}, {"oid": "ab60f0679b0837885dde114f8870e6484ba4077d", "url": "https://github.com/elastic/elasticsearch/commit/ab60f0679b0837885dde114f8870e6484ba4077d", "message": "Added Failing Test testIndexPointsFilterRectangle\n in Class org.elasticsearch.search.geo.GeoPointShapeQueryTests", "committedDate": "2019-11-20T19:07:45Z", "type": "commit"}, {"oid": "c22308fa23135907331c969f1f16459789b0eccd", "url": "https://github.com/elastic/elasticsearch/commit/c22308fa23135907331c969f1f16459789b0eccd", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2019-11-20T19:20:10Z", "type": "commit"}, {"oid": "443441c728982862c9cf5112afc231ea6f9683e8", "url": "https://github.com/elastic/elasticsearch/commit/443441c728982862c9cf5112afc231ea6f9683e8", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point", "committedDate": "2019-11-21T20:16:16Z", "type": "commit"}, {"oid": "24b95358fca9a5b1f266651ac507fe17115a5e35", "url": "https://github.com/elastic/elasticsearch/commit/24b95358fca9a5b1f266651ac507fe17115a5e35", "message": "permit GeoShapeQueryBuilder to accept a geo_point -> class_cast_exception raised, see org.elasticsearch.index.query.QueryShardContext.toQuery", "committedDate": "2019-11-23T19:40:19Z", "type": "commit"}, {"oid": "59c1bfcd37b42af01746e17c7a55a1557142aac1", "url": "https://github.com/elastic/elasticsearch/commit/59c1bfcd37b42af01746e17c7a55a1557142aac1", "message": "added @Override protected XContentBuilder createMapping\nin GeoPointShapeQueryTests", "committedDate": "2019-12-02T18:03:56Z", "type": "commit"}, {"oid": "192ad15e5e73a57e8b909360130fb14c8ca458c4", "url": "https://github.com/elastic/elasticsearch/commit/192ad15e5e73a57e8b909360130fb14c8ca458c4", "message": "merged upstream including 418edc6 types fixes", "committedDate": "2020-01-07T08:59:26Z", "type": "commit"}, {"oid": "ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "url": "https://github.com/elastic/elasticsearch/commit/ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "message": "repeat refactor post type removal and remove remaining types from GeoShapeQueryTests.java", "committedDate": "2020-01-07T15:26:12Z", "type": "commit"}, {"oid": "0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "url": "https://github.com/elastic/elasticsearch/commit/0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "message": "tidy GeoPointShapeQueryTests.java", "committedDate": "2020-01-07T15:27:59Z", "type": "commit"}, {"oid": "6d68e7febd1033882c125def51cc604e8ecaeac1", "url": "https://github.com/elastic/elasticsearch/commit/6d68e7febd1033882c125def51cc604e8ecaeac1", "message": "interim checkin, still failing tests", "committedDate": "2020-01-08T10:06:11Z", "type": "commit"}, {"oid": "2d880c260540139a356be59d161d99436ac9070a", "url": "https://github.com/elastic/elasticsearch/commit/2d880c260540139a356be59d161d99436ac9070a", "message": "GeoShapeQueryTests.java passing tests", "committedDate": "2020-01-08T11:11:41Z", "type": "commit"}, {"oid": "e275f3eb0a771fd11aa967b4d7653f7f64276a87", "url": "https://github.com/elastic/elasticsearch/commit/e275f3eb0a771fd11aa967b4d7653f7f64276a87", "message": "GeoShapeQueryTests.java extends GeoQueryTests", "committedDate": "2020-01-08T11:21:19Z", "type": "commit"}, {"oid": "316c7b18e843fef85c668aaf3aefdb69d9909b17", "url": "https://github.com/elastic/elasticsearch/commit/316c7b18e843fef85c668aaf3aefdb69d9909b17", "message": "refactored + tests passing", "committedDate": "2020-01-08T11:35:58Z", "type": "commit"}, {"oid": "e7e5e7b86c853314445938090fc4782fbd58b45e", "url": "https://github.com/elastic/elasticsearch/commit/e7e5e7b86c853314445938090fc4782fbd58b45e", "message": "refactored + tests passing", "committedDate": "2020-01-08T11:43:10Z", "type": "commit"}, {"oid": "d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "url": "https://github.com/elastic/elasticsearch/commit/d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "message": "reset GeoShapeQueryBuilder.java for future PR", "committedDate": "2020-01-08T11:58:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY4MDM3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/50737#discussion_r364680379", "bodyText": "I think this test should be in GeoQueryTests? I guess the idea of the subclass is that all test with points should be in that class so they are called with geo_point fields and geo_shape field?", "author": "iverase", "createdAt": "2020-01-09T11:05:06Z", "path": "server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.geo;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.geo.builders.*;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.locationtech.jts.geom.Coordinate;\n+\n+import static org.elasticsearch.action.support.WriteRequest.RefreshPolicy.IMMEDIATE;\n+import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+\n+public class GeoPointShapeQueryTests extends GeoQueryTests {\n+\n+    @Override\n+    protected XContentBuilder createMapping() throws Exception {\n+        XContentBuilder xcb = XContentFactory.jsonBuilder().startObject()\n+            .startObject(\"properties\").startObject(\"location\")\n+            .field(\"type\", \"geo_point\")\n+            .endObject().endObject().endObject();\n+\n+        return xcb;\n+    }\n+", "originalCommit": "d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg5NTE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/50737#discussion_r364895140", "bodyText": "Thanks @iverase\nI've pushed all tests that may be candidates for both geo shape and geo point up to the parent class, reordered geo shape so these are more easily visible and created test stubs in geo point for the expected tests\ntests passing in both geo shape and geo point", "author": "djptek", "createdAt": "2020-01-09T18:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY4MDM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIxNjc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/50737#discussion_r366216744", "bodyText": "@djptek Thanks for reworking this butI think the is still not the idea.I would propose to leave GeoShapeQueryTest as it is and only move out the test that is indexing points. This test can be in the abstract class with will be implemented by two classes, one generating a geo_point field and the other generated a geo_shape field. Does it make sense?", "author": "iverase", "createdAt": "2020-01-14T08:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY4MDM3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM1ODk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/50737#discussion_r366358987", "bodyText": "@iverase thanks for clarifying, I've refactored leaving 2 tests in the abstract:\n\ntestNullShape() which is theoretically applicable to both\ntestIndexPointsFilterRectangle() as discussed offline which is the test of interest\n\nThe testIndexPointsFilterRectangle() method is overridden in the subclasses since:\n\ngeo shape requires a random mapping to maintain current test coverage\ngeo point lacks the concept of random mapping therefore uses the default; also this test is comment out since the field mapper has not yet been built so it will fail to build\n\nAlso refactored the mapping helping method function names as discussed\nThanks for your support and feedback", "author": "djptek", "createdAt": "2020-01-14T14:12:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY4MDM3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "e54c867b82cebac4bf144ccdf2a1c45961f509e9", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java b/server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java\nindex 0e45f998c26..51240253344 100644\n--- a/server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java\n\n@@ -20,13 +20,10 @@\n package org.elasticsearch.search.geo;\n \n import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.geo.builders.*;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentFactory;\n-import org.locationtech.jts.geom.Coordinate;\n \n-import static org.elasticsearch.action.support.WriteRequest.RefreshPolicy.IMMEDIATE;\n-import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n+import java.io.IOException;\n \n public class GeoPointShapeQueryTests extends GeoQueryTests {\n \n"}}, {"oid": "e54c867b82cebac4bf144ccdf2a1c45961f509e9", "url": "https://github.com/elastic/elasticsearch/commit/e54c867b82cebac4bf144ccdf2a1c45961f509e9", "message": "improved refactoring see: https://github.com/elastic/elasticsearch/pull/50737#pullrequestreview-340443408", "committedDate": "2020-01-09T18:29:03Z", "type": "commit"}, {"oid": "9025578d4fb3b94aefb2b37671e699abff1df3f8", "url": "https://github.com/elastic/elasticsearch/commit/9025578d4fb3b94aefb2b37671e699abff1df3f8", "message": "refactor", "committedDate": "2020-01-14T14:03:34Z", "type": "commit"}, {"oid": "13e8b00752d45d9290cb8f2d715cf8702a582f94", "url": "https://github.com/elastic/elasticsearch/commit/13e8b00752d45d9290cb8f2d715cf8702a582f94", "message": "Merge branch 'djptek-geo-shape-query-vs-geo-point'\n\nGeoShapeQueryTests refactored adding superclass and sibling to accomodate new test coverage as part of adaptation of geo_shape query to work on geo_point fields", "committedDate": "2020-01-24T13:31:26Z", "type": "commit"}, {"oid": "83504d1866b1ab048cfd8ac1967e63586f964ec5", "url": "https://github.com/elastic/elasticsearch/commit/83504d1866b1ab048cfd8ac1967e63586f964ec5", "message": "merged refactor changes to upstream", "committedDate": "2020-01-24T15:16:45Z", "type": "commit"}, {"oid": "4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "url": "https://github.com/elastic/elasticsearch/commit/4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "message": "rectified Checkstyle rule violations", "committedDate": "2020-01-24T15:58:12Z", "type": "commit"}]}