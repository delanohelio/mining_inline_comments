{"pr_number": 55404, "pr_title": "Remove ban tasks with the current thread context", "pr_createdAt": "2020-04-17T14:42:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55404", "timeline": [{"oid": "c5cce3ba48acf476a5e58ef54f16e1013f344e5c", "url": "https://github.com/elastic/elasticsearch/commit/c5cce3ba48acf476a5e58ef54f16e1013f344e5c", "message": "Remove ban tasks using the current thread context", "committedDate": "2020-04-17T14:11:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI4MTM1MA==", "url": "https://github.com/elastic/elasticsearch/pull/55404#discussion_r410281350", "bodyText": "can you add a comment saying why this is necessary?", "author": "ywelsch", "createdAt": "2020-04-17T15:00:52Z", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java", "diffHunk": "@@ -121,8 +123,10 @@ void cancelTaskAndDescendants(CancellableTask task, String reason, boolean waitF\n             StepListener<Void> banOnNodesListener = new StepListener<>();\n             setBanOnNodes(reason, waitForCompletion, task, childrenNodes, banOnNodesListener);\n             banOnNodesListener.whenComplete(groupedListener::onResponse, groupedListener::onFailure);\n+            final Runnable removeBansRunnable = transportService.getThreadPool().getThreadContext()\n+                .preserveContext(() -> removeBanOnNodes(task, childrenNodes));", "originalCommit": "c5cce3ba48acf476a5e58ef54f16e1013f344e5c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b7140c012292bfcb1e70ffa7520868e25e85763b", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java b/server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java\nindex d6115fe9983..61af76cbd01 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java\n\n@@ -123,6 +123,8 @@ public class TransportCancelTasksAction extends TransportTasksAction<Cancellable\n             StepListener<Void> banOnNodesListener = new StepListener<>();\n             setBanOnNodes(reason, waitForCompletion, task, childrenNodes, banOnNodesListener);\n             banOnNodesListener.whenComplete(groupedListener::onResponse, groupedListener::onFailure);\n+            // If we start unbanning when the last child task completed and that child task executed with a specific user, then unban\n+            // requests are denied because internal requests can't run with a user. We need to remove bans with the current thread context.\n             final Runnable removeBansRunnable = transportService.getThreadPool().getThreadContext()\n                 .preserveContext(() -> removeBanOnNodes(task, childrenNodes));\n             // We remove bans after all child tasks are completed although in theory we can do it on a per-node basis.\n"}}, {"oid": "b7140c012292bfcb1e70ffa7520868e25e85763b", "url": "https://github.com/elastic/elasticsearch/commit/b7140c012292bfcb1e70ffa7520868e25e85763b", "message": "add comment", "committedDate": "2020-04-17T15:36:56Z", "type": "commit"}]}