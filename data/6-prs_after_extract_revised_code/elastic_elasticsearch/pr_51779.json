{"pr_number": 51779, "pr_title": "Fix LoggingOutputStream to work on windows", "pr_createdAt": "2020-01-31T22:22:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51779", "timeline": [{"oid": "1f7f01696cf93540cd7079db8c9ce02d9f7cc134", "url": "https://github.com/elastic/elasticsearch/commit/1f7f01696cf93540cd7079db8c9ce02d9f7cc134", "message": "Fix LoggingOutputStream to work on windows\n\nLoggingOutputStream reads a stream and breaks on newlines. This commit\nfixes the behavior to account for windows newlines also containing `\\r`.\n\ncloses #51532", "committedDate": "2020-01-31T22:20:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNDYzOA==", "url": "https://github.com/elastic/elasticsearch/pull/51779#discussion_r373714638", "bodyText": "Wouldn't this throw a ArrayIndexOutOfBounds exception for instances where we attempt to write a line which is simply a single \\n character? I think we need to add a bounds check here.", "author": "mark-vieira", "createdAt": "2020-01-31T22:32:18Z", "path": "server/src/main/java/org/elasticsearch/common/logging/LoggingOutputStream.java", "diffHunk": "@@ -91,7 +91,12 @@ public void write(int b) throws IOException {\n     public void flush() {\n         Buffer buffer = threadLocal.get();\n         if (buffer.used == 0) return;\n-        log(new String(buffer.bytes, 0, buffer.used, StandardCharsets.UTF_8));\n+        int used = buffer.used;\n+        if (buffer.bytes[used - 1] == '\\r') {", "originalCommit": "1f7f01696cf93540cd7079db8c9ce02d9f7cc134", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNTQzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51779#discussion_r373715439", "bodyText": "used - 1 is the last character of the buffer, and we know the buffer size is at least 1 because of the check on line 93.", "author": "rjernst", "createdAt": "2020-01-31T22:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNDYzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczODMxNg==", "url": "https://github.com/elastic/elasticsearch/pull/51779#discussion_r373738316", "bodyText": "I see what's happening now. I misunderstood the \\n character itself to be part of this buffer but it's not. Nevermind.", "author": "mark-vieira", "createdAt": "2020-02-01T00:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzcxNDYzOA=="}], "type": "inlineReview", "revised_code": null}]}