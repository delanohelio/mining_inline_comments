{"pr_number": 52258, "pr_title": "Adapt searchable snapshots code to latest master changes", "pr_createdAt": "2020-02-12T09:41:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52258", "timeline": [{"oid": "dd65970d095fceaef36c1736080e3c9cc61fa2ec", "url": "https://github.com/elastic/elasticsearch/commit/dd65970d095fceaef36c1736080e3c9cc61fa2ec", "message": "Adapt after master merge", "committedDate": "2020-02-12T09:36:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1MzAxOA==", "url": "https://github.com/elastic/elasticsearch/pull/52258#discussion_r378153018", "bodyText": "Let's include data.bytes.length in the message too, just in case.", "author": "DaveCTurner", "createdAt": "2020-02-12T10:10:06Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -257,6 +258,27 @@ public String toString() {\n             '}';\n     }\n \n+    private InputStream openBlobStream(int part, long pos, long length) throws IOException {\n+        final InputStream stream;\n+        if (fileInfo.metadata().hashEqualsContents() == false) {\n+            stream = blobContainer.readBlob(fileInfo.partName(part), pos, length);\n+        } else {\n+            // extract blob content from metadata hash\n+            final BytesRef data = fileInfo.metadata().hash();\n+            if (part > 0) {\n+                assert fileInfo.numberOfParts() >= part;\n+                for (int i = 0; i < part; i++) {\n+                    pos += fileInfo.partBytes(i);\n+                }\n+            }\n+            if ((pos < 0L) || (length < 0L) || (pos + length > data.bytes.length)) {\n+                throw new IllegalArgumentException(\"Invalid arguments (pos=\" + pos + \", length=\" + length + \") for hash content\");", "originalCommit": "dd65970d095fceaef36c1736080e3c9cc61fa2ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1NTM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/52258#discussion_r378155354", "bodyText": "Sure", "author": "tlrx", "createdAt": "2020-02-12T10:14:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1MzAxOA=="}], "type": "inlineReview", "revised_code": {"commit": "7c1284cbb68890ddbac565d7a2f0d9d8e921f4b0", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java\nindex 3b25b6e3dd1..d8a540ac497 100644\n--- a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java\n+++ b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java\n\n@@ -272,7 +272,8 @@ public class SearchableSnapshotIndexInput extends BufferedIndexInput {\n                 }\n             }\n             if ((pos < 0L) || (length < 0L) || (pos + length > data.bytes.length)) {\n-                throw new IllegalArgumentException(\"Invalid arguments (pos=\" + pos + \", length=\" + length + \") for hash content\");\n+                throw new IllegalArgumentException(\"Invalid arguments (pos=\" + pos + \", length=\" + length\n+                    + \") for hash content (length=\" + data.bytes.length + ')');\n             }\n             stream = new ByteArrayInputStream(data.bytes, Math.toIntExact(pos), Math.toIntExact(length));\n         }\n"}}, {"oid": "7c1284cbb68890ddbac565d7a2f0d9d8e921f4b0", "url": "https://github.com/elastic/elasticsearch/commit/7c1284cbb68890ddbac565d7a2f0d9d8e921f4b0", "message": "apply feedback", "committedDate": "2020-02-12T10:13:48Z", "type": "commit"}]}