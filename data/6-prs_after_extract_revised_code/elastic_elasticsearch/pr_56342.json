{"pr_number": 56342, "pr_title": "Make Annotation a result type", "pr_createdAt": "2020-05-07T13:32:39Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56342", "timeline": [{"oid": "c5f70b1028cc27e0322d3ace8ab92f4096278753", "url": "https://github.com/elastic/elasticsearch/commit/c5f70b1028cc27e0322d3ace8ab92f4096278753", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-07T13:35:58Z", "type": "forcePushed"}, {"oid": "3e5e3ea7cfa161ecc0d8f02bce90f5efa94ca586", "url": "https://github.com/elastic/elasticsearch/commit/3e5e3ea7cfa161ecc0d8f02bce90f5efa94ca586", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-08T11:03:07Z", "type": "forcePushed"}, {"oid": "4cca2092bf09e293900226f9a8bca6aa0208f138", "url": "https://github.com/elastic/elasticsearch/commit/4cca2092bf09e293900226f9a8bca6aa0208f138", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-08T11:11:25Z", "type": "forcePushed"}, {"oid": "a94bd869463cf0f081f9e386995ff1fb6f816d8e", "url": "https://github.com/elastic/elasticsearch/commit/a94bd869463cf0f081f9e386995ff1fb6f816d8e", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-08T11:15:32Z", "type": "forcePushed"}, {"oid": "3e6c07e505007af22d02efd0d1c08dbbcf93f59e", "url": "https://github.com/elastic/elasticsearch/commit/3e6c07e505007af22d02efd0d1c08dbbcf93f59e", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-08T11:40:11Z", "type": "forcePushed"}, {"oid": "a0ca446fc4c23b5cd546cc41e02df577bbd7d60c", "url": "https://github.com/elastic/elasticsearch/commit/a0ca446fc4c23b5cd546cc41e02df577bbd7d60c", "message": "Add scope-related fields to Annotation", "committedDate": "2020-05-11T09:38:57Z", "type": "forcePushed"}, {"oid": "ca967283f23210796502388cae3106e1f24de54e", "url": "https://github.com/elastic/elasticsearch/commit/ca967283f23210796502388cae3106e1f24de54e", "message": "Add scope-related fields to Annotation", "committedDate": "2020-05-13T08:18:05Z", "type": "forcePushed"}, {"oid": "7857791948d7afddcc625b36ed4878d9b4319c69", "url": "https://github.com/elastic/elasticsearch/commit/7857791948d7afddcc625b36ed4878d9b4319c69", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-13T14:09:19Z", "type": "forcePushed"}, {"oid": "89475fdf69c70587e79f526867fd38343998bfdb", "url": "https://github.com/elastic/elasticsearch/commit/89475fdf69c70587e79f526867fd38343998bfdb", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-14T09:09:24Z", "type": "forcePushed"}, {"oid": "c48c0faf2b2c60db16ca0723b8a9a3270a176003", "url": "https://github.com/elastic/elasticsearch/commit/c48c0faf2b2c60db16ca0723b8a9a3270a176003", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-18T08:32:46Z", "type": "forcePushed"}, {"oid": "bebb1c766cca52a53e3326ff2b6b53f3e370f120", "url": "https://github.com/elastic/elasticsearch/commit/bebb1c766cca52a53e3326ff2b6b53f3e370f120", "message": "Introduce ModelAnnotation result type", "committedDate": "2020-05-18T08:44:59Z", "type": "forcePushed"}, {"oid": "608643a642cbd899e3299c1651fbbb75bdd3f25b", "url": "https://github.com/elastic/elasticsearch/commit/608643a642cbd899e3299c1651fbbb75bdd3f25b", "message": "Make Annotation a result type", "committedDate": "2020-05-18T11:10:31Z", "type": "forcePushed"}, {"oid": "16afb11139e6d6a2a406a3ea28b8a56717f7b1d5", "url": "https://github.com/elastic/elasticsearch/commit/16afb11139e6d6a2a406a3ea28b8a56717f7b1d5", "message": "Make Annotation a result type", "committedDate": "2020-05-18T11:18:52Z", "type": "forcePushed"}, {"oid": "892041bc0c0ba099e72520c6c8d69b7c455920bb", "url": "https://github.com/elastic/elasticsearch/commit/892041bc0c0ba099e72520c6c8d69b7c455920bb", "message": "Make Annotation a result type", "committedDate": "2020-05-18T11:23:43Z", "type": "forcePushed"}, {"oid": "ba933b437da175550a407227a07eddee8872717e", "url": "https://github.com/elastic/elasticsearch/commit/ba933b437da175550a407227a07eddee8872717e", "message": "Make Annotation a result type", "committedDate": "2020-05-18T12:16:10Z", "type": "forcePushed"}, {"oid": "128f9747eec28880a67a25fb1c8e73ff034b819b", "url": "https://github.com/elastic/elasticsearch/commit/128f9747eec28880a67a25fb1c8e73ff034b819b", "message": "Make Annotation a result type", "committedDate": "2020-05-18T12:23:32Z", "type": "forcePushed"}, {"oid": "dd27a7d8b0a0b389fc3dd0c035a0dc88e80c3180", "url": "https://github.com/elastic/elasticsearch/commit/dd27a7d8b0a0b389fc3dd0c035a0dc88e80c3180", "message": "Make Annotation a result type", "committedDate": "2020-05-18T12:41:41Z", "type": "forcePushed"}, {"oid": "81a8fe2f7103426cfe3893abee2179e4c16fac3c", "url": "https://github.com/elastic/elasticsearch/commit/81a8fe2f7103426cfe3893abee2179e4c16fac3c", "message": "Make Annotation a result type", "committedDate": "2020-05-19T07:54:28Z", "type": "forcePushed"}, {"oid": "1cc6ad83f77930bfdae90df9c02d8456d4ef199a", "url": "https://github.com/elastic/elasticsearch/commit/1cc6ad83f77930bfdae90df9c02d8456d4ef199a", "message": "Make Annotation a result type", "committedDate": "2020-05-19T07:57:28Z", "type": "forcePushed"}, {"oid": "e1251fae23ded7036ee9a98718e1bfd84e043f0f", "url": "https://github.com/elastic/elasticsearch/commit/e1251fae23ded7036ee9a98718e1bfd84e043f0f", "message": "Make Annotation a result type", "committedDate": "2020-05-21T12:52:32Z", "type": "forcePushed"}, {"oid": "e1b783bb59f96f8ce88c5ac66d34c722f490c824", "url": "https://github.com/elastic/elasticsearch/commit/e1b783bb59f96f8ce88c5ac66d34c722f490c824", "message": "Make Annotation a result type", "committedDate": "2020-05-26T07:09:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r430334095", "bodyText": "There is no batching here.  I worry that this could be really slow if there is a job with 100000 split field values and we detect periodicity in all 100000 time series at the same time.  To avoid the risk it needs to create bulk requests for these model change annotations, then execute these bulk requests when the next bucket result is seen, when the job is flushed, or when the results stream ends (basically wherever we currently call bulkResultsPersister.executeRequest()).", "author": "droberts195", "createdAt": "2020-05-26T11:10:47Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -243,6 +243,10 @@ void processResult(AutodetectResult result) {\n         if (modelPlot != null) {\n             bulkResultsPersister.persistModelPlot(modelPlot);\n         }\n+        Annotation annotation = result.getAnnotation();\n+        if (annotation != null) {\n+            annotationPersister.persistAnnotation(null, annotation);", "originalCommit": "e1b783bb59f96f8ce88c5ac66d34c722f490c824", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzOTE0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r431639146", "bodyText": "There is no batching here.\n\nGood point. Let me do it in a separate PR that I'm going to send soon.\nThen I'll merge the preparational PR (batching) before this one (model change results).\n\nAnother thing that needs doing as part of this project is to add a subtype enum field to each annotation to record what sort of annotation it is.\n\nAlready sent for review (#57144).", "author": "przemekwitek", "createdAt": "2020-05-28T07:37:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwOTI4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r432409282", "bodyText": "Update:\nbatching is now implemented in #57278", "author": "przemekwitek", "createdAt": "2020-05-29T10:57:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2NzEzNQ==", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r433667135", "bodyText": "then execute these bulk requests when the next bucket result is seen, when the job is flushed, or when the results stream ends\n\nDone.\n\n(basically wherever we currently call bulkResultsPersister.executeRequest())\n\nThere are some calls to bulkResultsPersister.executeRequest() which I think do not need accompanying calls to bulkAnnotationsPersister.executeRequest(), namely forecasts and quantiles.", "author": "przemekwitek", "createdAt": "2020-06-02T07:14:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b9d44e3d43a950329e12853f132a910723faa4b4", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\nindex e014b4fcdce..4dc81db312f 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java\n\n@@ -245,7 +245,7 @@ public class AutodetectResultProcessor {\n         }\n         Annotation annotation = result.getAnnotation();\n         if (annotation != null) {\n-            annotationPersister.persistAnnotation(null, annotation);\n+            annotationPersister.persistAnnotation(null, annotation, \"[\" + jobId + \"] failed to create annotation.\");\n         }\n         Forecast forecast = result.getForecast();\n         if (forecast != null) {\n"}}, {"oid": "b9d44e3d43a950329e12853f132a910723faa4b4", "url": "https://github.com/elastic/elasticsearch/commit/b9d44e3d43a950329e12853f132a910723faa4b4", "message": "Make Annotation a result type", "committedDate": "2020-05-28T07:30:20Z", "type": "forcePushed"}, {"oid": "eb7c2f0d8442e4764a3955af68955ba1b18eec6b", "url": "https://github.com/elastic/elasticsearch/commit/eb7c2f0d8442e4764a3955af68955ba1b18eec6b", "message": "Use bulk requests for indexing annotations", "committedDate": "2020-05-29T13:28:25Z", "type": "forcePushed"}, {"oid": "7af3fb7a5679f91494ea6e38a5e5974e14e3589f", "url": "https://github.com/elastic/elasticsearch/commit/7af3fb7a5679f91494ea6e38a5e5974e14e3589f", "message": "Fix AutodetectProcessManagerTests", "committedDate": "2020-06-01T08:13:42Z", "type": "forcePushed"}, {"oid": "0ba4205f344628896ebd105794e4d25902d93fc3", "url": "https://github.com/elastic/elasticsearch/commit/0ba4205f344628896ebd105794e4d25902d93fc3", "message": "Fix AutodetectResultProcessorTests", "committedDate": "2020-06-01T17:54:38Z", "type": "forcePushed"}, {"oid": "54a619a6aa5c5d7356e19a7b8581fc93b83dd566", "url": "https://github.com/elastic/elasticsearch/commit/54a619a6aa5c5d7356e19a7b8581fc93b83dd566", "message": "Make Annotation a result type", "committedDate": "2020-06-02T07:09:25Z", "type": "commit"}, {"oid": "ef3e07b986b4938a672b8bf5951b246c98816d59", "url": "https://github.com/elastic/elasticsearch/commit/ef3e07b986b4938a672b8bf5951b246c98816d59", "message": "Use bulk requests for indexing annotations", "committedDate": "2020-06-02T07:09:25Z", "type": "commit"}, {"oid": "f1000dae3443a3a64d170afe6f99cbd45cfc987f", "url": "https://github.com/elastic/elasticsearch/commit/f1000dae3443a3a64d170afe6f99cbd45cfc987f", "message": "Fix AutodetectProcessManagerTests", "committedDate": "2020-06-02T07:09:25Z", "type": "commit"}, {"oid": "ff8c0a6ae66de1a39cd5f7da2fa3a30ee2d5c535", "url": "https://github.com/elastic/elasticsearch/commit/ff8c0a6ae66de1a39cd5f7da2fa3a30ee2d5c535", "message": "Fix AutodetectResultProcessorTests", "committedDate": "2020-06-02T07:09:25Z", "type": "commit"}, {"oid": "9700c6a3a775aaca060c37b9e94393294e5baff7", "url": "https://github.com/elastic/elasticsearch/commit/9700c6a3a775aaca060c37b9e94393294e5baff7", "message": "Align comments", "committedDate": "2020-06-02T07:09:26Z", "type": "commit"}, {"oid": "9f1343b7ee2145324c04954ae9ef912741089cf3", "url": "https://github.com/elastic/elasticsearch/commit/9f1343b7ee2145324c04954ae9ef912741089cf3", "message": "Execute annotation persister bulk request on flush", "committedDate": "2020-06-02T07:09:26Z", "type": "commit"}, {"oid": "9f1343b7ee2145324c04954ae9ef912741089cf3", "url": "https://github.com/elastic/elasticsearch/commit/9f1343b7ee2145324c04954ae9ef912741089cf3", "message": "Execute annotation persister bulk request on flush", "committedDate": "2020-06-02T07:09:26Z", "type": "forcePushed"}]}