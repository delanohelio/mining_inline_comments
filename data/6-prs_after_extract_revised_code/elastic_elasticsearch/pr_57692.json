{"pr_number": 57692, "pr_title": "Prohibit closing the write index for a data stream", "pr_createdAt": "2020-06-04T18:23:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57692", "timeline": [{"oid": "f874b34f7842832c46839906f5d0eaaa2c0beb76", "url": "https://github.com/elastic/elasticsearch/commit/f874b34f7842832c46839906f5d0eaaa2c0beb76", "message": "Prohibit closing the write index for a data stream", "committedDate": "2020-06-04T18:22:18Z", "type": "commit"}, {"oid": "c14629fd7e1c6c31c94247cc05c1a4ec3a7003b2", "url": "https://github.com/elastic/elasticsearch/commit/c14629fd7e1c6c31c94247cc05c1a4ec3a7003b2", "message": "Merge branch 'master' into prohibit_closing_write_index", "committedDate": "2020-06-04T18:51:38Z", "type": "commit"}, {"oid": "9a17fea1bd515545ad857cfef48ce4877d0bf4fa", "url": "https://github.com/elastic/elasticsearch/commit/9a17fea1bd515545ad857cfef48ce4877d0bf4fa", "message": "Merge branch 'master' into prohibit_closing_write_index", "committedDate": "2020-06-04T19:03:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1MzI5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57692#discussion_r435753291", "bodyText": "I think we should change this to:\nia.getParentDataStream().getWriteIndex().getIndex().equals(index))\n\nThe index uuid should be the same.", "author": "martijnvg", "createdAt": "2020-06-05T07:58:48Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java", "diffHunk": "@@ -137,6 +138,19 @@ public void closeIndices(final CloseIndexClusterStateUpdateRequest request, fina\n         if (concreteIndices == null || concreteIndices.length == 0) {\n             throw new IllegalArgumentException(\"Index name is required\");\n         }\n+        List<String> writeIndices = new ArrayList<>();\n+        SortedMap<String, IndexAbstraction> lookup = clusterService.state().metadata().getIndicesLookup();\n+        for (Index index : concreteIndices) {\n+            IndexAbstraction ia = lookup.get(index.getName());\n+            if (ia != null && ia.getParentDataStream() != null &&\n+                ia.getParentDataStream().getWriteIndex().getIndex().getName().equals(index.getName())) {", "originalCommit": "9a17fea1bd515545ad857cfef48ce4877d0bf4fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b346a73647bea2d1005d7a985e938a4c610a6e1f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java\nindex 0818f857e82..cfd850c0b7b 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java\n\n@@ -142,8 +142,7 @@ public class MetadataIndexStateService {\n         SortedMap<String, IndexAbstraction> lookup = clusterService.state().metadata().getIndicesLookup();\n         for (Index index : concreteIndices) {\n             IndexAbstraction ia = lookup.get(index.getName());\n-            if (ia != null && ia.getParentDataStream() != null &&\n-                ia.getParentDataStream().getWriteIndex().getIndex().getName().equals(index.getName())) {\n+            if (ia != null && ia.getParentDataStream() != null && ia.getParentDataStream().getWriteIndex().getIndex().equals(index)) {\n                 writeIndices.add(index.getName());\n             }\n         }\n"}}, {"oid": "b346a73647bea2d1005d7a985e938a4c610a6e1f", "url": "https://github.com/elastic/elasticsearch/commit/b346a73647bea2d1005d7a985e938a4c610a6e1f", "message": "check for index equality", "committedDate": "2020-06-05T13:44:56Z", "type": "commit"}, {"oid": "0157494e0527b748299fab94b095f47c5a62487c", "url": "https://github.com/elastic/elasticsearch/commit/0157494e0527b748299fab94b095f47c5a62487c", "message": "fix unit test", "committedDate": "2020-06-05T14:16:42Z", "type": "commit"}]}