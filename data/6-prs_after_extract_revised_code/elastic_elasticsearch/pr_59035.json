{"pr_number": 59035, "pr_title": "Dry up Snapshot ITs further", "pr_createdAt": "2020-07-04T14:55:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59035", "timeline": [{"oid": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "url": "https://github.com/elastic/elasticsearch/commit/4c73955506b66b95d9ecf570d3c8a018f2c70c66", "message": "Dry up Snapshot ITs further\n\nSome more obvious cleaning up of the snapshot ITs.", "committedDate": "2020-07-04T14:53:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MDcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450040715", "bodyText": "Maybe we could lower this down?", "author": "tlrx", "createdAt": "2020-07-06T07:44:34Z", "path": "server/src/internalClusterTest/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java", "diffHunk": "@@ -298,8 +294,7 @@ private void assertSnapshotExists(String repository, String snapshot) {\n     }\n \n     private void createRandomIndex(String idxName) throws InterruptedException {\n-        assertAcked(prepareCreate(idxName, 0, Settings.builder().put(\"number_of_shards\", between(1, 20))\n-            .put(\"number_of_replicas\", 0)));\n+        assertAcked(prepareCreate(idxName, 0, indexSettingsZeroReplicas(between(1, 20))));", "originalCommit": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1NjcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450056726", "bodyText": "Yea definitely, moved it to 5 :)", "author": "original-brownbear", "createdAt": "2020-07-06T08:15:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MDcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "chunk": "diff --git a/server/src/internalClusterTest/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java b/server/src/internalClusterTest/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java\nindex d8245305792..5c76f6ebac5 100644\n--- a/server/src/internalClusterTest/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java\n+++ b/server/src/internalClusterTest/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java\n\n@@ -294,7 +277,7 @@ public class SnapshotDisruptionIT extends AbstractSnapshotIntegTestCase {\n     }\n \n     private void createRandomIndex(String idxName) throws InterruptedException {\n-        assertAcked(prepareCreate(idxName, 0, indexSettingsZeroReplicas(between(1, 20))));\n+        assertAcked(prepareCreate(idxName, 0, indexSettingsNoReplicas(between(1, 5))));\n         logger.info(\"--> indexing some data\");\n         final int numdocs = randomIntBetween(10, 100);\n         IndexRequestBuilder[] builders = new IndexRequestBuilder[numdocs];\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MTk2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450041967", "bodyText": "nit: I'd call this indexRandomDocs()", "author": "tlrx", "createdAt": "2020-07-06T07:47:01Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -322,4 +340,30 @@ protected SnapshotInfo createFullSnapshot(String repoName, String snapshotName)\n         assertThat(snapshotInfo.state(), is(SnapshotState.SUCCESS));\n         return snapshotInfo;\n     }\n+\n+    protected void createIndexWithSomeData(String indexName, int docCount) throws InterruptedException {\n+        createIndex(indexName);\n+        ensureGreen();\n+        indexSomeData(indexName, docCount);\n+    }\n+\n+    protected void indexSomeData(String index, int numdocs) throws InterruptedException {", "originalCommit": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\nindex cbc476d9370..10adeeb4915 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n\n@@ -341,13 +341,13 @@ public abstract class AbstractSnapshotIntegTestCase extends ESIntegTestCase {\n         return snapshotInfo;\n     }\n \n-    protected void createIndexWithSomeData(String indexName, int docCount) throws InterruptedException {\n+    protected void createIndexWithRandomDocs(String indexName, int docCount) throws InterruptedException {\n         createIndex(indexName);\n         ensureGreen();\n-        indexSomeData(indexName, docCount);\n+        indexRandomDocs(indexName, docCount);\n     }\n \n-    protected void indexSomeData(String index, int numdocs) throws InterruptedException {\n+    protected void indexRandomDocs(String index, int numdocs) throws InterruptedException {\n         logger.info(\"--> indexing [{}] documents into [{}]\", numdocs, index);\n         IndexRequestBuilder[] builders = new IndexRequestBuilder[numdocs];\n         for (int i = 0; i < builders.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MjE2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450042167", "bodyText": "nit: I'd call this createIndexWithRandomDocs()", "author": "tlrx", "createdAt": "2020-07-06T07:47:25Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -322,4 +340,30 @@ protected SnapshotInfo createFullSnapshot(String repoName, String snapshotName)\n         assertThat(snapshotInfo.state(), is(SnapshotState.SUCCESS));\n         return snapshotInfo;\n     }\n+\n+    protected void createIndexWithSomeData(String indexName, int docCount) throws InterruptedException {", "originalCommit": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\nindex cbc476d9370..10adeeb4915 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n\n@@ -341,13 +341,13 @@ public abstract class AbstractSnapshotIntegTestCase extends ESIntegTestCase {\n         return snapshotInfo;\n     }\n \n-    protected void createIndexWithSomeData(String indexName, int docCount) throws InterruptedException {\n+    protected void createIndexWithRandomDocs(String indexName, int docCount) throws InterruptedException {\n         createIndex(indexName);\n         ensureGreen();\n-        indexSomeData(indexName, docCount);\n+        indexRandomDocs(indexName, docCount);\n     }\n \n-    protected void indexSomeData(String index, int numdocs) throws InterruptedException {\n+    protected void indexRandomDocs(String index, int numdocs) throws InterruptedException {\n         logger.info(\"--> indexing [{}] documents into [{}]\", numdocs, index);\n         IndexRequestBuilder[] builders = new IndexRequestBuilder[numdocs];\n         for (int i = 0; i < builders.length; i++) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MjM4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450042386", "bodyText": "I'd call this indexSettingsNoReplicas()", "author": "tlrx", "createdAt": "2020-07-06T07:47:54Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -274,6 +279,19 @@ protected void createRepository(String repoName, String type, Path location) {\n         createRepository(repoName, type, Settings.builder().put(\"location\", location));\n     }\n \n+    protected void createRepository(String repoName, String type) {\n+        Settings.Builder settings = Settings.builder().put(\"location\", randomRepoPath()).put(\"compress\", randomBoolean());\n+        if (rarely()) {\n+            settings = settings.put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES);\n+        }\n+        createRepository(repoName, type, settings);\n+    }\n+\n+    protected static Settings.Builder indexSettingsZeroReplicas(int shards) {", "originalCommit": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\nindex cbc476d9370..10adeeb4915 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n\n@@ -287,7 +287,7 @@ public abstract class AbstractSnapshotIntegTestCase extends ESIntegTestCase {\n         createRepository(repoName, type, settings);\n     }\n \n-    protected static Settings.Builder indexSettingsZeroReplicas(int shards) {\n+    protected static Settings.Builder indexSettingsNoReplicas(int shards) {\n         return Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, shards)\n             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0MjQ1NA==", "url": "https://github.com/elastic/elasticsearch/pull/59035#discussion_r450042454", "bodyText": "+1", "author": "tlrx", "createdAt": "2020-07-06T07:48:02Z", "path": "server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -274,6 +279,19 @@ protected void createRepository(String repoName, String type, Path location) {\n         createRepository(repoName, type, Settings.builder().put(\"location\", location));\n     }\n \n+    protected void createRepository(String repoName, String type) {\n+        Settings.Builder settings = Settings.builder().put(\"location\", randomRepoPath()).put(\"compress\", randomBoolean());\n+        if (rarely()) {", "originalCommit": "4c73955506b66b95d9ecf570d3c8a018f2c70c66", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\nindex cbc476d9370..10adeeb4915 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java\n\n@@ -287,7 +287,7 @@ public abstract class AbstractSnapshotIntegTestCase extends ESIntegTestCase {\n         createRepository(repoName, type, settings);\n     }\n \n-    protected static Settings.Builder indexSettingsZeroReplicas(int shards) {\n+    protected static Settings.Builder indexSettingsNoReplicas(int shards) {\n         return Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, shards)\n             .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0);\n     }\n"}}, {"oid": "708c542b8788571a656ac37b322f8347e1046f9b", "url": "https://github.com/elastic/elasticsearch/commit/708c542b8788571a656ac37b322f8347e1046f9b", "message": "Merge remote-tracking branch 'elastic/master' into dry-up-snapshot-repo-test-settings", "committedDate": "2020-07-06T08:14:18Z", "type": "commit"}, {"oid": "48c4775f29fdc6a2ff6238a858aa468fec8d5649", "url": "https://github.com/elastic/elasticsearch/commit/48c4775f29fdc6a2ff6238a858aa468fec8d5649", "message": "CR: renamings", "committedDate": "2020-07-06T08:18:02Z", "type": "commit"}]}