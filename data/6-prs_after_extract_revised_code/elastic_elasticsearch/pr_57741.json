{"pr_number": 57741, "pr_title": "Enforce valid field mapping exists for timestamp_field in templates.", "pr_createdAt": "2020-06-05T15:31:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57741", "timeline": [{"oid": "b32c6df550177573c7c077ae534a84becf9b827c", "url": "https://github.com/elastic/elasticsearch/commit/b32c6df550177573c7c077ae534a84becf9b827c", "message": "Enforce valid field mapping exists for timestamp_field in templates.\n\nRelates to #53100", "committedDate": "2020-06-05T15:23:51Z", "type": "commit"}, {"oid": "1a746ec7c446b3917d976dfd0e9aaac026134514", "url": "https://github.com/elastic/elasticsearch/commit/1a746ec7c446b3917d976dfd0e9aaac026134514", "message": "removed incorrect console snippet", "committedDate": "2020-06-05T15:42:08Z", "type": "commit"}, {"oid": "cbd49ac400d5a05b08079fb418873a3927560833", "url": "https://github.com/elastic/elasticsearch/commit/cbd49ac400d5a05b08079fb418873a3927560833", "message": "skip validating if no data stream template", "committedDate": "2020-06-05T16:10:40Z", "type": "commit"}, {"oid": "bd23c0aceb3951f9d0978e46426b625ee8563869", "url": "https://github.com/elastic/elasticsearch/commit/bd23c0aceb3951f9d0978e46426b625ee8563869", "message": "fixed docs snippets", "committedDate": "2020-06-05T16:44:45Z", "type": "commit"}, {"oid": "cd68c5d3c597a72315cbe5360bbe8bc2c4e43839", "url": "https://github.com/elastic/elasticsearch/commit/cd68c5d3c597a72315cbe5360bbe8bc2c4e43839", "message": "fixed unit tests", "committedDate": "2020-06-05T17:00:42Z", "type": "commit"}, {"oid": "e0c92954eed88a236015ba5cfa0a33fe79023080", "url": "https://github.com/elastic/elasticsearch/commit/e0c92954eed88a236015ba5cfa0a33fe79023080", "message": "fixed snippet", "committedDate": "2020-06-05T17:01:21Z", "type": "commit"}, {"oid": "57104471b3804152a5aebd20277f01cf71214e0b", "url": "https://github.com/elastic/elasticsearch/commit/57104471b3804152a5aebd20277f01cf71214e0b", "message": "incase of data stream template also generate a mapping", "committedDate": "2020-06-05T18:01:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1MjM3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r437052375", "bodyText": "This validation needs to be moved to the validateCompositeTemplate method, that way, when a component template is updated we will still validate the mapping is correct.\nOtherwise a composable template could be added where the mapping is in the component template, and then the component template could be updated to remove the timestamp mapping. Once we move the validation it'll be checked for both index and component templates", "author": "dakrone", "createdAt": "2020-06-08T23:18:00Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -442,9 +444,20 @@ public ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n \n         validate(name, finalIndexTemplate);\n         logger.info(\"adding index template [{}]\", name);\n-        return ClusterState.builder(currentState)\n+        ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n             .build();\n+        if (finalIndexTemplate.getDataStreamTemplate() != null) {\n+            validateDataStreamTemplate(name, finalIndexTemplate, newState);\n+        }", "originalCommit": "57104471b3804152a5aebd20277f01cf71214e0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxMjg3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r437212877", "bodyText": "Thanks for catching this. I've placed the validation in the wrong place.", "author": "martijnvg", "createdAt": "2020-06-09T08:02:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1MjM3NQ=="}], "type": "inlineReview", "revised_code": {"commit": "24451da21e254ef6d25cc3f1033e81bd1378edae", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\nindex bf4cda19ec6..f284f1e1bb6 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n\n@@ -443,6 +474,17 @@ public class MetadataIndexTemplateService {\n         }\n \n         validate(name, finalIndexTemplate);\n+\n+        // Finally, right before adding the template, we need to ensure that the composite settings,\n+        // mappings, and aliases are valid after it's been composed with the component templates\n+        try {\n+            validateCompositeTemplate(currentState, name, finalIndexTemplate, indicesService, xContentRegistry);\n+        } catch (Exception e) {\n+            throw new IllegalArgumentException(\"composable template [\" + name +\n+                \"] template after composition \" +\n+                (finalIndexTemplate.composedOf().size() > 0 ? \"with component templates \" + finalIndexTemplate.composedOf() + \" \" : \"\") +\n+                \"is invalid\", e);\n+        }\n         logger.info(\"adding index template [{}]\", name);\n         ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1MjU0OA==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r437052548", "bodyText": "When moving the validation to the validateCompositeTemplate method we should be able to reuse the mapping generated in that method", "author": "dakrone", "createdAt": "2020-06-08T23:18:37Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -442,9 +444,20 @@ public ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n \n         validate(name, finalIndexTemplate);\n         logger.info(\"adding index template [{}]\", name);\n-        return ClusterState.builder(currentState)\n+        ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n             .build();\n+        if (finalIndexTemplate.getDataStreamTemplate() != null) {\n+            validateDataStreamTemplate(name, finalIndexTemplate, newState);\n+        }\n+        return newState;\n+    }\n+\n+    private void validateDataStreamTemplate(String name, ComposableIndexTemplate finalIndexTemplate, ClusterState state) throws Exception {\n+        String tsFieldName = finalIndexTemplate.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> finalMapping = parseV2Mappings(\"{}\", resolveMappings(state, name), xContentRegistry);", "originalCommit": "57104471b3804152a5aebd20277f01cf71214e0b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "24451da21e254ef6d25cc3f1033e81bd1378edae", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\nindex bf4cda19ec6..f284f1e1bb6 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n\n@@ -443,6 +474,17 @@ public class MetadataIndexTemplateService {\n         }\n \n         validate(name, finalIndexTemplate);\n+\n+        // Finally, right before adding the template, we need to ensure that the composite settings,\n+        // mappings, and aliases are valid after it's been composed with the component templates\n+        try {\n+            validateCompositeTemplate(currentState, name, finalIndexTemplate, indicesService, xContentRegistry);\n+        } catch (Exception e) {\n+            throw new IllegalArgumentException(\"composable template [\" + name +\n+                \"] template after composition \" +\n+                (finalIndexTemplate.composedOf().size() > 0 ? \"with component templates \" + finalIndexTemplate.composedOf() + \" \" : \"\") +\n+                \"is invalid\", e);\n+        }\n         logger.info(\"adding index template [{}]\", name);\n         ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n"}}, {"oid": "24451da21e254ef6d25cc3f1033e81bd1378edae", "url": "https://github.com/elastic/elasticsearch/commit/24451da21e254ef6d25cc3f1033e81bd1378edae", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates", "committedDate": "2020-06-09T07:41:20Z", "type": "commit"}, {"oid": "eab7e7c4db82cbb37e63a15419bd91661c68aef0", "url": "https://github.com/elastic/elasticsearch/commit/eab7e7c4db82cbb37e63a15419bd91661c68aef0", "message": "moved timestamp_field validation to the right place inside the template service", "committedDate": "2020-06-09T08:02:15Z", "type": "commit"}, {"oid": "00f5aa04ee29f75eb37b01914297bc6b75bf4d45", "url": "https://github.com/elastic/elasticsearch/commit/00f5aa04ee29f75eb37b01914297bc6b75bf4d45", "message": "fixed test", "committedDate": "2020-06-09T10:59:53Z", "type": "commit"}, {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "url": "https://github.com/elastic/elasticsearch/commit/3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "message": "fixed test", "committedDate": "2020-06-09T11:47:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3Mjg2OA==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438172868", "bodyText": "Super minor, but can you move this variable definition up to the top of the file (it's nice to have all the vars defined up top where we can see them)", "author": "dakrone", "createdAt": "2020-06-10T14:36:00Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +163,20 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n+        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));", "originalCommit": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\nindex 9c6889646ba..dfd11d834ec 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n\n@@ -163,9 +165,6 @@ public class MetadataCreateDataStreamService {\n         return composableIndexTemplate;\n     }\n \n-    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n-        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n-\n     public static void validateTimestampFieldMapping(String timestampFieldName, Map<?, ?> mapping) {\n         String timestampFieldMapperPath = \"properties.\" + timestampFieldName;\n         Map<?, ?> timestampFieldMapper = ObjectPath.eval(timestampFieldMapperPath, mapping);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NzU4OA==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438177588", "bodyText": "Unfortunately, I don't think this will work for nested fields, for example the following fails on this PR:\nPUT /_index_template/generic\n{\n  \"index_patterns\": [\"logs-*\"],\n  \"data_stream\": {\n    \"timestamp_field\": \"foo.timestamp\"\n  },\n  \"template\": {\n    \"mappings\": {\n      \"properties\": {\n        \"foo\": {\n          \"properties\": {\n            \"timestamp\": {\n              \"type\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}", "author": "dakrone", "createdAt": "2020-06-10T14:42:04Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +163,20 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n+        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n+\n+    public static void validateTimestampFieldMapping(String timestampFieldName, Map<?, ?> mapping) {\n+        String timestampFieldMapperPath = \"properties.\" + timestampFieldName;\n+        Map<?, ?> timestampFieldMapper = ObjectPath.eval(timestampFieldMapperPath, mapping);\n+        if (timestampFieldMapper == null) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"], but found no timestamp field\");\n+        }", "originalCommit": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU2MzcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438563729", "bodyText": "Let me check, I assumed that ObjectPath.eval(...) handles nested fields.", "author": "martijnvg", "createdAt": "2020-06-11T06:13:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NzU4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU3MDM2NA==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438570364", "bodyText": "\ud83e\udd26", "author": "martijnvg", "createdAt": "2020-06-11T06:32:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NzU4OA=="}], "type": "inlineReview", "revised_code": {"commit": "cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\nindex 9c6889646ba..dfd11d834ec 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n\n@@ -163,9 +165,6 @@ public class MetadataCreateDataStreamService {\n         return composableIndexTemplate;\n     }\n \n-    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n-        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n-\n     public static void validateTimestampFieldMapping(String timestampFieldName, Map<?, ?> mapping) {\n         String timestampFieldMapperPath = \"properties.\" + timestampFieldName;\n         Map<?, ?> timestampFieldMapper = ObjectPath.eval(timestampFieldMapperPath, mapping);\n"}}, {"oid": "267a21d3a1afbb910586178822fd7d7cf88dd4fb", "url": "https://github.com/elastic/elasticsearch/commit/267a21d3a1afbb910586178822fd7d7cf88dd4fb", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates", "committedDate": "2020-06-11T06:11:28Z", "type": "commit"}, {"oid": "cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "url": "https://github.com/elastic/elasticsearch/commit/cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "message": "move constants to top of file", "committedDate": "2020-06-11T06:29:45Z", "type": "commit"}, {"oid": "4b018664a30783f18c024cdf8ce1e2f42d430285", "url": "https://github.com/elastic/elasticsearch/commit/4b018664a30783f18c024cdf8ce1e2f42d430285", "message": "Use MapperService to validate the timestamp_field's field mapping instead of custom parsing logic.\n\nThis avoids introducing custom parsing logic, at the cost\nof using mapper service in tests, which imo is minimal.", "committedDate": "2020-06-11T09:07:13Z", "type": "commit"}, {"oid": "88f92d5938131899db09f983ba2782d4b1df1974", "url": "https://github.com/elastic/elasticsearch/commit/88f92d5938131899db09f983ba2782d4b1df1974", "message": "fixed tests", "committedDate": "2020-06-11T11:08:39Z", "type": "commit"}, {"oid": "0cca07a21ac47628408f0fa8196b66bf30e904f6", "url": "https://github.com/elastic/elasticsearch/commit/0cca07a21ac47628408f0fa8196b66bf30e904f6", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates", "committedDate": "2020-06-11T11:09:34Z", "type": "commit"}, {"oid": "f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f", "url": "https://github.com/elastic/elasticsearch/commit/f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f", "message": "fixed test", "committedDate": "2020-06-11T11:52:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDIyOA==", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438974228", "bodyText": "Super minor:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types [\" +\n          \n          \n            \n                            ALLOWED_TIMESTAMPFIELD_TYPES + \"], but instead found type [\" + type  + \"]\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types \" +\n          \n          \n            \n                            ALLOWED_TIMESTAMPFIELD_TYPES + \", but instead found type [\" + type  + \"]\");\n          \n      \n    \n    \n  \n\nTo avoid the [[]] double brackets", "author": "dakrone", "createdAt": "2020-06-11T18:01:43Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +165,16 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    public static void validateTimestampFieldMapping(String timestampFieldName, MapperService mapperService) {\n+        MappedFieldType timestampFieldMapper = mapperService.fieldType(timestampFieldName);\n+        if (timestampFieldMapper == null) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"], but found no timestamp field\");\n+        }\n+        String type = timestampFieldMapper.typeName();\n+        if (ALLOWED_TIMESTAMPFIELD_TYPES.contains(type) == false) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types [\" +\n+                ALLOWED_TIMESTAMPFIELD_TYPES + \"], but instead found type [\" + type  + \"]\");", "originalCommit": "f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1a37c26f1d51cdf8aefa15072eebb64998427273", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\nindex 73ff42d230b..be9e2fc2f84 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java\n\n@@ -172,8 +172,8 @@ public class MetadataCreateDataStreamService {\n         }\n         String type = timestampFieldMapper.typeName();\n         if (ALLOWED_TIMESTAMPFIELD_TYPES.contains(type) == false) {\n-            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types [\" +\n-                ALLOWED_TIMESTAMPFIELD_TYPES + \"], but instead found type [\" + type  + \"]\");\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types \" +\n+                ALLOWED_TIMESTAMPFIELD_TYPES + \", but instead found type [\" + type  + \"]\");\n         }\n     }\n \n"}}, {"oid": "1a37c26f1d51cdf8aefa15072eebb64998427273", "url": "https://github.com/elastic/elasticsearch/commit/1a37c26f1d51cdf8aefa15072eebb64998427273", "message": "adjusted error message", "committedDate": "2020-06-12T06:54:02Z", "type": "commit"}, {"oid": "d5e899ebdc2f227d4c503203bd4b76168b19fb3c", "url": "https://github.com/elastic/elasticsearch/commit/d5e899ebdc2f227d4c503203bd4b76168b19fb3c", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates", "committedDate": "2020-06-12T07:21:24Z", "type": "commit"}]}