{"pr_number": 61505, "pr_title": "[ML] write warning if configured memory limit is too low for analytics job", "pr_createdAt": "2020-08-24T20:30:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61505", "timeline": [{"oid": "0494a2fb632691aa4a9c8f25c920e13779e28181", "url": "https://github.com/elastic/elasticsearch/commit/0494a2fb632691aa4a9c8f25c920e13779e28181", "message": "[ML] write warning if configured memory limit is too low for analytics job", "committedDate": "2020-08-24T20:28:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyMzQzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/61505#discussion_r476323431", "bodyText": "Let's also update the comment here to say we're just warning when limit is lower than estimate", "author": "dimitris-athanasiou", "createdAt": "2020-08-25T09:48:47Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -218,12 +219,13 @@ private void estimateMemoryUsageAndUpdateMemoryTracker(StartContext startContext\n                 // Validate that model memory limit is sufficient to run the analysis", "originalCommit": "0494a2fb632691aa4a9c8f25c920e13779e28181", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9a0381de00f036618a4fa99415792599c249b39", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\nindex 1bcd141fa6f..75cf497cea9 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\n\n@@ -217,6 +217,7 @@ public class TransportStartDataFrameAnalyticsAction\n                 auditor.info(jobId,\n                     Messages.getMessage(Messages.DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE, expectedMemoryWithoutDisk));\n                 // Validate that model memory limit is sufficient to run the analysis\n+                // We will only warn the caller if the configured limit is too low.\n                 if (startContext.config.getModelMemoryLimit()\n                     .compareTo(expectedMemoryWithoutDisk) < 0) {\n                     String warning =  Messages.getMessage(\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyMzc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/61505#discussion_r476323740", "bodyText": "Should we change \"may not run\" to \"may fail\" ?", "author": "dimitris-athanasiou", "createdAt": "2020-08-25T09:49:20Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java", "diffHunk": "@@ -66,6 +66,9 @@\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_UPDATED_STATE_WITH_REASON =\n             \"Updated analytics task state to [{0}] with reason [{1}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE = \"Estimated memory usage for this analytics to be [{0}]\";\n+    public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE_HIGHER_THAN_CONFIGURED =\n+        \"Configured model memory limit [{0}] is lower than the expected memory usage [{1}]. \" +\n+            \"The analytics job may not run due to configured memory constraints.\";", "originalCommit": "0494a2fb632691aa4a9c8f25c920e13779e28181", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NDM4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/61505#discussion_r476374383", "bodyText": "Definitely!", "author": "benwtrent", "createdAt": "2020-08-25T11:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMyMzc0MA=="}], "type": "inlineReview", "revised_code": {"commit": "3d83b48893757f6168e6355dd4424ae7c94130db", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\nindex cfaeb402105..6a7965a01b2 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\n\n@@ -68,7 +68,7 @@ public final class Messages {\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE = \"Estimated memory usage for this analytics to be [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE_HIGHER_THAN_CONFIGURED =\n         \"Configured model memory limit [{0}] is lower than the expected memory usage [{1}]. \" +\n-            \"The analytics job may not run due to configured memory constraints.\";\n+            \"The analytics job may fail due to configured memory constraints.\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_CREATING_DEST_INDEX = \"Creating destination index [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_REUSING_DEST_INDEX = \"Using existing destination index [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_STARTED_REINDEXING = \"Started reindexing to destination index [{0}]\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NjI2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/61505#discussion_r476376262", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"The analytics job may not run due to configured memory constraints.\";\n          \n          \n            \n                        \"The analytics job may fail due to configured memory constraints.\";", "author": "benwtrent", "createdAt": "2020-08-25T11:30:57Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java", "diffHunk": "@@ -66,6 +66,9 @@\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_UPDATED_STATE_WITH_REASON =\n             \"Updated analytics task state to [{0}] with reason [{1}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE = \"Estimated memory usage for this analytics to be [{0}]\";\n+    public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE_HIGHER_THAN_CONFIGURED =\n+        \"Configured model memory limit [{0}] is lower than the expected memory usage [{1}]. \" +\n+            \"The analytics job may not run due to configured memory constraints.\";", "originalCommit": "0494a2fb632691aa4a9c8f25c920e13779e28181", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3d83b48893757f6168e6355dd4424ae7c94130db", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\nindex cfaeb402105..6a7965a01b2 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java\n\n@@ -68,7 +68,7 @@ public final class Messages {\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE = \"Estimated memory usage for this analytics to be [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE_HIGHER_THAN_CONFIGURED =\n         \"Configured model memory limit [{0}] is lower than the expected memory usage [{1}]. \" +\n-            \"The analytics job may not run due to configured memory constraints.\";\n+            \"The analytics job may fail due to configured memory constraints.\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_CREATING_DEST_INDEX = \"Creating destination index [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_REUSING_DEST_INDEX = \"Using existing destination index [{0}]\";\n     public static final String DATA_FRAME_ANALYTICS_AUDIT_STARTED_REINDEXING = \"Started reindexing to destination index [{0}]\";\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM3NjU3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/61505#discussion_r476376571", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // Validate that model memory limit is sufficient to run the analysis\n          \n          \n            \n                            // Validate that model memory limit is sufficient to run the analysis\n          \n          \n            \n                            // We will only warn the caller if the configured limit is too low.", "author": "benwtrent", "createdAt": "2020-08-25T11:31:38Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -218,12 +219,13 @@ private void estimateMemoryUsageAndUpdateMemoryTracker(StartContext startContext\n                 // Validate that model memory limit is sufficient to run the analysis", "originalCommit": "0494a2fb632691aa4a9c8f25c920e13779e28181", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d9a0381de00f036618a4fa99415792599c249b39", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\nindex 1bcd141fa6f..75cf497cea9 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java\n\n@@ -217,6 +217,7 @@ public class TransportStartDataFrameAnalyticsAction\n                 auditor.info(jobId,\n                     Messages.getMessage(Messages.DATA_FRAME_ANALYTICS_AUDIT_ESTIMATED_MEMORY_USAGE, expectedMemoryWithoutDisk));\n                 // Validate that model memory limit is sufficient to run the analysis\n+                // We will only warn the caller if the configured limit is too low.\n                 if (startContext.config.getModelMemoryLimit()\n                     .compareTo(expectedMemoryWithoutDisk) < 0) {\n                     String warning =  Messages.getMessage(\n"}}, {"oid": "d9a0381de00f036618a4fa99415792599c249b39", "url": "https://github.com/elastic/elasticsearch/commit/d9a0381de00f036618a4fa99415792599c249b39", "message": "Update x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "committedDate": "2020-08-25T11:31:56Z", "type": "commit"}, {"oid": "3d83b48893757f6168e6355dd4424ae7c94130db", "url": "https://github.com/elastic/elasticsearch/commit/3d83b48893757f6168e6355dd4424ae7c94130db", "message": "Update x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java", "committedDate": "2020-08-25T11:32:01Z", "type": "commit"}, {"oid": "683b777410dce8469018f189b6161faef021bfd2", "url": "https://github.com/elastic/elasticsearch/commit/683b777410dce8469018f189b6161faef021bfd2", "message": "fixing integration test", "committedDate": "2020-08-25T13:09:12Z", "type": "commit"}]}