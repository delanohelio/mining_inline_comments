{"pr_number": 55498, "pr_title": "Rollover for data streams", "pr_createdAt": "2020-04-20T22:11:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55498", "timeline": [{"oid": "7ef2a86b99b177e36bdd5fb1898a698ebd554cb9", "url": "https://github.com/elastic/elasticsearch/commit/7ef2a86b99b177e36bdd5fb1898a698ebd554cb9", "message": "wip", "committedDate": "2020-04-20T18:16:33Z", "type": "commit"}, {"oid": "b44eeee6350c8f3881f0a403f474f58a43e23593", "url": "https://github.com/elastic/elasticsearch/commit/b44eeee6350c8f3881f0a403f474f58a43e23593", "message": "finished cherry pick", "committedDate": "2020-04-20T18:44:38Z", "type": "commit"}, {"oid": "4c443fe85518c6d21eee457279dacde7fb94161c", "url": "https://github.com/elastic/elasticsearch/commit/4c443fe85518c6d21eee457279dacde7fb94161c", "message": "add tests and cleanup", "committedDate": "2020-04-20T22:06:47Z", "type": "commit"}, {"oid": "948b8ece2f22c1817e0e29cb6f7f3441f3e0e078", "url": "https://github.com/elastic/elasticsearch/commit/948b8ece2f22c1817e0e29cb6f7f3441f3e0e078", "message": "fix test", "committedDate": "2020-04-20T23:39:42Z", "type": "commit"}, {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "url": "https://github.com/elastic/elasticsearch/commit/064c3135cf0380dc4980aa20b48ad9c61c8a3389", "message": "Merge branch 'master' into rollover_data_streams", "committedDate": "2020-04-20T23:40:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEwNjE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412106164", "bodyText": "I think a test for this is missing?", "author": "henningandersen", "createdAt": "2020-04-21T11:34:46Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -178,6 +179,10 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n             MetadataCreateIndexService.validateIndexOrAliasName(request.name,\n                 (s1, s2) -> new IllegalArgumentException(\"data_stream [\" + s1 + \"] \" + s2));\n \n+            if (request.name.toLowerCase(Locale.ROOT).equals(request.name) == false) {", "originalCommit": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4f28175f23cecf70907c23a2b6f885787763e143", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java b/server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java\nindex f61fe09905d..108c5a909c0 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java\n\n@@ -182,6 +182,9 @@ public class CreateDataStreamAction extends ActionType<AcknowledgedResponse> {\n             if (request.name.toLowerCase(Locale.ROOT).equals(request.name) == false) {\n                 throw new IllegalArgumentException(\"data_stream [\" + request.name + \"] must be lowercase\");\n             }\n+            if (request.name.startsWith(\".\")) {\n+                throw new IllegalArgumentException(\"data_stream [\" + request.name + \"] must not start with '.'\");\n+            }\n \n             String firstBackingIndexName = DataStream.getBackingIndexName(request.name, 1);\n             CreateIndexClusterStateUpdateRequest createIndexRequest =\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExNDcxOA==", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412114718", "bodyText": "I think we should rename this to prepareDataStreamCreateIndexRequest, since the hidden setting is applied, making this method data stream specific.", "author": "henningandersen", "createdAt": "2020-04-21T11:48:43Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java", "diffHunk": "@@ -127,15 +173,28 @@ static String generateRolloverIndexName(String sourceIndexName, IndexNameExpress\n         }\n     }\n \n-    static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final String providedIndexName, final String targetIndexName,\n+    static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final String targetIndexName,", "originalCommit": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "1dabd5e52f3b8f0fd977580da54d1833eb564163", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\nindex d74efbad341..ba9c4ced7fd 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\n\n@@ -173,8 +173,8 @@ public class MetadataRolloverService {\n         }\n     }\n \n-    static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final String targetIndexName,\n-                                                                          CreateIndexRequest createIndexRequest) {\n+    static CreateIndexClusterStateUpdateRequest prepareDataStreamCreateIndexRequest(final String targetIndexName,\n+                                                                                    CreateIndexRequest createIndexRequest) {\n         Settings settings = Settings.builder().put(\"index.hidden\", true).build();\n         return prepareCreateIndexRequest(targetIndexName, targetIndexName, \"rollover_data_stream\", createIndexRequest, settings);\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEyMTgxOA==", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412121818", "bodyText": "I wonder if for data streams we should disallow applying aliases, mappings and settings to the new index? It feels odd that you cannot specify them on create data stream but can on rollover?", "author": "henningandersen", "createdAt": "2020-04-21T12:00:00Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java", "diffHunk": "@@ -75,17 +83,33 @@ private RolloverResult(String rolloverIndexName, String sourceIndexName, Cluster\n         }\n     }\n \n-    public RolloverResult rolloverClusterState(ClusterState currentState, String aliasName, String newIndexName,\n+    public RolloverResult rolloverClusterState(ClusterState currentState, String aliasOrDataStream, String newIndexName,\n                                                CreateIndexRequest createIndexRequest, List<Condition<?>> metConditions,\n                                                boolean silent) throws Exception {\n+        validate(currentState.metadata(), aliasOrDataStream, newIndexName);", "originalCommit": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "2ba5379753b629753cb03e56d69ddac24e7eb457", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\nindex d74efbad341..cefee8165c1 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java\n\n@@ -83,17 +85,17 @@ public class MetadataRolloverService {\n         }\n     }\n \n-    public RolloverResult rolloverClusterState(ClusterState currentState, String aliasOrDataStream, String newIndexName,\n+    public RolloverResult rolloverClusterState(ClusterState currentState, String rolloverTarget, String newIndexName,\n                                                CreateIndexRequest createIndexRequest, List<Condition<?>> metConditions,\n                                                boolean silent) throws Exception {\n-        validate(currentState.metadata(), aliasOrDataStream, newIndexName);\n-        final IndexAbstraction indexAbstraction = currentState.metadata().getIndicesLookup().get(aliasOrDataStream);\n+        validate(currentState.metadata(), rolloverTarget, newIndexName);\n+        final IndexAbstraction indexAbstraction = currentState.metadata().getIndicesLookup().get(rolloverTarget);\n         switch (indexAbstraction.getType()) {\n             case ALIAS:\n-                return rolloverAlias(currentState, (IndexAbstraction.Alias) indexAbstraction, aliasOrDataStream, newIndexName,\n+                return rolloverAlias(currentState, (IndexAbstraction.Alias) indexAbstraction, rolloverTarget, newIndexName,\n                     createIndexRequest, metConditions, silent);\n             case DATA_STREAM:\n-                return  rolloverDataStream(currentState, (IndexAbstraction.DataStream) indexAbstraction, aliasOrDataStream,\n+                return  rolloverDataStream(currentState, (IndexAbstraction.DataStream) indexAbstraction, rolloverTarget,\n                     createIndexRequest, metConditions, silent);\n             default:\n                 // the validate method above prevents this case\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEyNjU0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412126541", "bodyText": "I think we need to also rename this method?", "author": "henningandersen", "createdAt": "2020-04-21T12:07:42Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java", "diffHunk": "@@ -34,7 +34,7 @@ public RolloverRequestBuilder(ElasticsearchClient client, RolloverAction action)\n     }\n \n     public RolloverRequestBuilder setAlias(String alias) {", "originalCommit": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4f28175f23cecf70907c23a2b6f885787763e143", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java\nindex b93675f9cc2..173750da63b 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java\n\n@@ -33,8 +33,8 @@ public class RolloverRequestBuilder extends MasterNodeOperationRequestBuilder<Ro\n         super(client, action, new RolloverRequest());\n     }\n \n-    public RolloverRequestBuilder setAlias(String alias) {\n-        this.request.setAliasOrDataStream(alias);\n+    public RolloverRequestBuilder setRolloverTarget(String rolloverTarget) {\n+        this.request.setRolloverTarget(rolloverTarget);\n         return this;\n     }\n \n"}}, {"oid": "1dabd5e52f3b8f0fd977580da54d1833eb564163", "url": "https://github.com/elastic/elasticsearch/commit/1dabd5e52f3b8f0fd977580da54d1833eb564163", "message": "add test, rename method", "committedDate": "2020-04-21T16:00:19Z", "type": "commit"}, {"oid": "4f28175f23cecf70907c23a2b6f885787763e143", "url": "https://github.com/elastic/elasticsearch/commit/4f28175f23cecf70907c23a2b6f885787763e143", "message": "review comments", "committedDate": "2020-04-21T22:28:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc1NDgxNg==", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412754816", "bodyText": "The TransportRolloverAction#checkBlock() method should be changed.\nThe following\nIndicesOptions indicesOptions = IndicesOptions.fromOptions(true, true,\n            request.indicesOptions().expandWildcardsOpen(), request.indicesOptions().expandWildcardsClosed());\n\nshould be changed into:\nIndicesOptions indicesOptions = IndicesOptions.fromOptions(true, true,\n            request.indicesOptions().expandWildcardsOpen(), request.indicesOptions().expandWildcardsClosed(), \n            request.indicesOptions().expandWildcardsHidden(), request.indicesOptions().allowAliasesToMultipleIndices(), \n            request.indicesOptions().forbidClosedIndices(), request.indicesOptions().ignoreAliases(), \n            request.indicesOptions().ignoreThrottled(), request.indicesOptions().includeDataStreams());\n\nThis why the modified test in DataStreamIT failed.", "author": "martijnvg", "createdAt": "2020-04-22T07:52:46Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/TransportRolloverAction.java", "diffHunk": "@@ -99,14 +99,14 @@ protected void masterOperation(Task task, final RolloverRequest rolloverRequest,\n                                    final ActionListener<RolloverResponse> listener) throws Exception {\n         MetadataRolloverService.RolloverResult preResult =\n             rolloverService.rolloverClusterState(state,\n-                rolloverRequest.getAlias(), rolloverRequest.getNewIndexName(), rolloverRequest.getCreateIndexRequest(),\n+                rolloverRequest.getRolloverTarget(), rolloverRequest.getNewIndexName(), rolloverRequest.getCreateIndexRequest(),", "originalCommit": "4f28175f23cecf70907c23a2b6f885787763e143", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "2652e5f5261182145a668d787f213a605d75d6f0", "url": "https://github.com/elastic/elasticsearch/commit/2652e5f5261182145a668d787f213a605d75d6f0", "message": "fix more tests", "committedDate": "2020-04-22T12:18:55Z", "type": "commit"}, {"oid": "a5612448b1225d12b948e78df0a7e91fffc255e1", "url": "https://github.com/elastic/elasticsearch/commit/a5612448b1225d12b948e78df0a7e91fffc255e1", "message": "moar test fixes", "committedDate": "2020-04-22T13:16:28Z", "type": "commit"}, {"oid": "3f1ff0e124105576a9c6c0efad48cf6751abb287", "url": "https://github.com/elastic/elasticsearch/commit/3f1ff0e124105576a9c6c0efad48cf6751abb287", "message": "change 'alias or data stream' to 'rollover target'", "committedDate": "2020-04-22T14:36:11Z", "type": "commit"}, {"oid": "c2c73c5f3dc542f13e4e7f2ea2b0d474f18632d4", "url": "https://github.com/elastic/elasticsearch/commit/c2c73c5f3dc542f13e4e7f2ea2b0d474f18632d4", "message": "Merge branch 'master' into rollover_data_streams", "committedDate": "2020-04-22T14:36:31Z", "type": "commit"}, {"oid": "90e630abf102e7d430d7e334e91ab163db8c34ac", "url": "https://github.com/elastic/elasticsearch/commit/90e630abf102e7d430d7e334e91ab163db8c34ac", "message": "minor DRYing up", "committedDate": "2020-04-22T15:38:17Z", "type": "commit"}, {"oid": "2ba5379753b629753cb03e56d69ddac24e7eb457", "url": "https://github.com/elastic/elasticsearch/commit/2ba5379753b629753cb03e56d69ddac24e7eb457", "message": "rename variables", "committedDate": "2020-04-22T15:46:50Z", "type": "commit"}, {"oid": "fd2ac2ed795466cb78f81ad38e4f99fccb100d5f", "url": "https://github.com/elastic/elasticsearch/commit/fd2ac2ed795466cb78f81ad38e4f99fccb100d5f", "message": "disallow settings, aliases, or mappings for data streams on rollover", "committedDate": "2020-04-22T16:23:20Z", "type": "commit"}, {"oid": "61804e12a5eb13c021f56168eadf4a3f544d1bb3", "url": "https://github.com/elastic/elasticsearch/commit/61804e12a5eb13c021f56168eadf4a3f544d1bb3", "message": "Merge branch 'master' into rollover_data_streams", "committedDate": "2020-04-22T17:01:05Z", "type": "commit"}]}