{"pr_number": 55162, "pr_title": "[7.x] Add analytics plugin usage stats to _xpack/usage (#54911)", "pr_createdAt": "2020-04-14T14:42:05Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55162", "timeline": [{"oid": "9c487ad0095364886467c8126f85e8e3642b8897", "url": "https://github.com/elastic/elasticsearch/commit/9c487ad0095364886467c8126f85e8e3642b8897", "message": "Add analytics plugin usage stats to _xpack/usage (#54911)\n\nAdds analytics plugin usage stats to _xpack/usage.\n\nCloses #54847", "committedDate": "2020-04-14T14:37:26Z", "type": "commit"}, {"oid": "fa308986a3c5f0a0ec6ef619f8d0f27c511c520c", "url": "https://github.com/elastic/elasticsearch/commit/fa308986a3c5f0a0ec6ef619f8d0f27c511c520c", "message": "Fix serialization names", "committedDate": "2020-04-14T15:49:16Z", "type": "commit"}, {"oid": "a21f01195b59102dc61f3c27470820cad1cbe109", "url": "https://github.com/elastic/elasticsearch/commit/a21f01195b59102dc61f3c27470820cad1cbe109", "message": "Rename test for consistency with master", "committedDate": "2020-04-14T15:53:44Z", "type": "commit"}, {"oid": "5cdfae910db885f398d1715e7d60927bd26c90f7", "url": "https://github.com/elastic/elasticsearch/commit/5cdfae910db885f398d1715e7d60927bd26c90f7", "message": "Make index name in test more unique", "committedDate": "2020-04-14T17:46:18Z", "type": "commit"}, {"oid": "7c081089e932eba5132fe93d7ba2aa5c64ee9702", "url": "https://github.com/elastic/elasticsearch/commit/7c081089e932eba5132fe93d7ba2aa5c64ee9702", "message": "Suppress warnings", "committedDate": "2020-04-14T18:15:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwNjE1OA==", "url": "https://github.com/elastic/elasticsearch/pull/55162#discussion_r408406158", "bodyText": "Should this be a VLong not ZLong?", "author": "polyfractal", "createdAt": "2020-04-14T20:12:33Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/action/AnalyticsStatsAction.java", "diffHunk": "@@ -97,109 +110,84 @@ protected void writeNodesTo(StreamOutput out, List<NodeResponse> nodes) throws I\n             out.writeList(nodes);\n         }\n \n+        public EnumCounters<Item> getStats() {\n+            List<EnumCounters<Item>> countersPerNode = getNodes()\n+                .stream()\n+                .map(AnalyticsStatsAction.NodeResponse::getStats)\n+                .collect(Collectors.toList());\n+            return EnumCounters.merge(Item.class, countersPerNode);\n+        }\n+\n         @Override\n         public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n-            builder.startArray(\"stats\");\n-            for (NodeResponse node : getNodes()) {\n-                node.toXContent(builder, params);\n+            EnumCounters<Item> stats = getStats();\n+            builder.startObject(\"stats\");\n+            for (Item item : Item.values()) {\n+                builder.field(item.name().toLowerCase(Locale.ROOT) + \"_usage\", stats.get(item));\n             }\n-            builder.endArray();\n-\n+            builder.endObject();\n             return builder;\n         }\n     }\n \n-    public static class NodeResponse extends BaseNodeResponse implements ToXContentObject {\n-        static final ParseField BOXPLOT_USAGE = new ParseField(\"boxplot_usage\");\n-        static final ParseField CUMULATIVE_CARDINALITY_USAGE = new ParseField(\"cumulative_cardinality_usage\");\n-        static final ParseField STRING_STATS_USAGE = new ParseField(\"string_stats_usage\");\n-        static final ParseField TOP_METRICS_USAGE = new ParseField(\"top_metrics_usage\");\n-        static final ParseField T_TEST_USAGE = new ParseField(\"t_test_usage\");\n-\n-        private final long boxplotUsage;\n-        private final long cumulativeCardinalityUsage;\n-        private final long stringStatsUsage;\n-        private final long topMetricsUsage;\n-        private final long ttestUsage;\n-\n-        public NodeResponse(DiscoveryNode node, long boxplotUsage, long cumulativeCardinalityUsage, long stringStatsUsage,\n-                long topMetricsUsage, long ttestUsage) {\n+    public static class NodeResponse extends BaseNodeResponse {\n+        private final EnumCounters<Item> counters;\n+\n+        public NodeResponse(DiscoveryNode node, EnumCounters<Item> counters) {\n             super(node);\n-            this.boxplotUsage = boxplotUsage;\n-            this.cumulativeCardinalityUsage = cumulativeCardinalityUsage;\n-            this.stringStatsUsage = stringStatsUsage;\n-            this.topMetricsUsage = topMetricsUsage;\n-            this.ttestUsage = ttestUsage;\n+            this.counters = counters;\n         }\n \n         public NodeResponse(StreamInput in) throws IOException {\n             super(in);\n-            if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                boxplotUsage = in.readVLong();\n-            } else {\n-                boxplotUsage = 0;\n-            }\n-            cumulativeCardinalityUsage = in.readZLong();\n-            if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                stringStatsUsage = in.readVLong();\n-                topMetricsUsage = in.readVLong();\n-            } else {\n-                topMetricsUsage = 0;\n-                stringStatsUsage = 0;\n-            }\n             if (in.getVersion().onOrAfter(Version.V_7_8_0)) {\n-                ttestUsage = in.readVLong();\n+                counters = new EnumCounters<>(in, Item.class);\n             } else {\n-                ttestUsage = 0;\n+                counters = new EnumCounters<>(Item.class);\n+                if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n+                    counters.inc(Item.BOXPLOT, in.readVLong());\n+                }\n+                counters.inc(Item.CUMULATIVE_CARDINALITY, in.readZLong());\n+                if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n+                    counters.inc(Item.STRING_STATS, in.readVLong());\n+                    counters.inc(Item.TOP_METRICS, in.readVLong());\n+                }\n             }\n         }\n \n         @Override\n         public void writeTo(StreamOutput out) throws IOException {\n             super.writeTo(out);\n-            if (out.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                out.writeVLong(boxplotUsage);\n-            }\n-            out.writeVLong(cumulativeCardinalityUsage);\n-            if (out.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                out.writeVLong(stringStatsUsage);\n-                out.writeVLong(topMetricsUsage);\n-            }\n             if (out.getVersion().onOrAfter(Version.V_7_8_0)) {\n-                out.writeVLong(ttestUsage);\n+                counters.writeTo(out);\n+            } else {\n+                if (out.getVersion().onOrAfter(Version.V_7_7_0)) {\n+                    out.writeVLong(counters.get(Item.BOXPLOT));\n+                }\n+                out.writeZLong(counters.get(Item.CUMULATIVE_CARDINALITY));", "originalCommit": "7c081089e932eba5132fe93d7ba2aa5c64ee9702", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjU2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55162#discussion_r408422569", "bodyText": "It was ZLong in 7.6, got partially changed by mistake in 7.7. So, I am returning to back to the original serialization method and I will open a PR to fix it in 7.7. Good catch, thanks for reminding me!", "author": "imotov", "createdAt": "2020-04-14T20:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwNjE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ2MzE0MA==", "url": "https://github.com/elastic/elasticsearch/pull/55162#discussion_r408463140", "bodyText": "I opened #55183. Not sure if it will make it into 7.7.0 or not.", "author": "imotov", "createdAt": "2020-04-14T22:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwNjE1OA=="}], "type": "inlineReview", "revised_code": null}]}