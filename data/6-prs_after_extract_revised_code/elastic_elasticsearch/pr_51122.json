{"pr_number": 51122, "pr_title": "Make soft-deletes mandatory in 8.0", "pr_createdAt": "2020-01-16T18:53:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51122", "timeline": [{"oid": "42033d12c0da33401b5132d88d741d64a5496f57", "url": "https://github.com/elastic/elasticsearch/commit/42033d12c0da33401b5132d88d741d64a5496f57", "message": "Make soft-deletes mandatory in 8.0", "committedDate": "2020-01-16T18:50:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU5ODMxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367598315", "bodyText": "why remove this? We still don't want people to be able to modify this on restore, do we? Otherwise they could just set this to false on restore.", "author": "ywelsch", "createdAt": "2020-01-16T19:09:49Z", "path": "server/src/main/java/org/elasticsearch/snapshots/RestoreService.java", "diffHunk": "@@ -124,8 +123,7 @@\n             SETTING_NUMBER_OF_SHARDS,\n             SETTING_VERSION_CREATED,\n             SETTING_INDEX_UUID,\n-            SETTING_CREATION_DATE,\n-            IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey()));", "originalCommit": "42033d12c0da33401b5132d88d741d64a5496f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0ODc5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367748799", "bodyText": "fixed in 9a992a9", "author": "dnhatn", "createdAt": "2020-01-17T02:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU5ODMxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "9a992a9aff741adc98e494eed9814769e7e21dbc", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java b/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\nindex 3a14789a6815..84c08e02bf17 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/RestoreService.java\n\n@@ -123,7 +124,8 @@ public class RestoreService implements ClusterStateApplier {\n             SETTING_NUMBER_OF_SHARDS,\n             SETTING_VERSION_CREATED,\n             SETTING_INDEX_UUID,\n-            SETTING_CREATION_DATE));\n+            SETTING_CREATION_DATE,\n+            IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey()));\n \n     // It's OK to change some settings, but we shouldn't allow simply removing them\n     private static final Set<String> UNREMOVABLE_SETTINGS;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYwNjgxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367606819", "bodyText": "should we still allow IndexSettings.INDEX_SOFT_DELETES_SETTING to be set to false if SETTING_INDEX_VERSION_CREATED is before V_8_0_0. This will allow shrink/split of non-soft-deleted indices continue to work. Also, a test for this would be good", "author": "ywelsch", "createdAt": "2020-01-16T19:28:13Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java", "diffHunk": "@@ -437,10 +435,9 @@ static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClu\n          * that will be used to create this index.\n          */\n         MetaDataCreateIndexService.checkShardLimit(indexSettings, currentState);\n-        if (indexSettings.getAsBoolean(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true) == false) {\n-            DEPRECATION_LOGGER.deprecatedAndMaybeLog(\"soft_deletes_disabled\",\n-                \"Creating indices with soft-deletes disabled is deprecated and will be removed in future Elasticsearch versions. \" +\n-                \"Please do not specify value for setting [index.soft_deletes.enabled] of index [\" + request.index() + \"].\");\n+        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(indexSettings) == false) {", "originalCommit": "42033d12c0da33401b5132d88d741d64a5496f57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0ODgzNw==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367748837", "bodyText": "fixed and added a test in 0ecee87.", "author": "dnhatn", "createdAt": "2020-01-17T02:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYwNjgxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "66c507d38fbb2c456d146e8b9be7968d09f792ff", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\nindex 662f69763f2f..c5ecd1d6eebb 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n\n@@ -437,7 +437,7 @@ public class MetaDataCreateIndexService {\n         MetaDataCreateIndexService.checkShardLimit(indexSettings, currentState);\n         if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(indexSettings) == false) {\n             throw new IllegalArgumentException(\"Creating indices with soft-deletes disabled is no longer supported. \" +\n-                \"Please do not specify value for setting [index.soft_deletes.enabled].\");\n+                \"Please do not specify a value for setting [index.soft_deletes.enabled].\");\n         }\n         return indexSettings;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYwNzM0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367607346", "bodyText": "specify a value", "author": "ywelsch", "createdAt": "2020-01-16T19:29:23Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java", "diffHunk": "@@ -437,10 +435,9 @@ static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClu\n          * that will be used to create this index.\n          */\n         MetaDataCreateIndexService.checkShardLimit(indexSettings, currentState);\n-        if (indexSettings.getAsBoolean(IndexSettings.INDEX_SOFT_DELETES_SETTING.getKey(), true) == false) {\n-            DEPRECATION_LOGGER.deprecatedAndMaybeLog(\"soft_deletes_disabled\",\n-                \"Creating indices with soft-deletes disabled is deprecated and will be removed in future Elasticsearch versions. \" +\n-                \"Please do not specify value for setting [index.soft_deletes.enabled] of index [\" + request.index() + \"].\");\n+        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(indexSettings) == false) {\n+            throw new IllegalArgumentException(\"Creating indices with soft-deletes disabled is no longer supported. \" +\n+                \"Please do not specify value for setting [index.soft_deletes.enabled].\");", "originalCommit": "42033d12c0da33401b5132d88d741d64a5496f57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "66c507d38fbb2c456d146e8b9be7968d09f792ff", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\nindex 662f69763f2f..c5ecd1d6eebb 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java\n\n@@ -437,7 +437,7 @@ public class MetaDataCreateIndexService {\n         MetaDataCreateIndexService.checkShardLimit(indexSettings, currentState);\n         if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(indexSettings) == false) {\n             throw new IllegalArgumentException(\"Creating indices with soft-deletes disabled is no longer supported. \" +\n-                \"Please do not specify value for setting [index.soft_deletes.enabled].\");\n+                \"Please do not specify a value for setting [index.soft_deletes.enabled].\");\n         }\n         return indexSettings;\n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYwNzcxNA==", "url": "https://github.com/elastic/elasticsearch/pull/51122#discussion_r367607714", "bodyText": "I think we should keep this condition in place (see my other comment)", "author": "ywelsch", "createdAt": "2020-01-16T19:30:12Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java", "diffHunk": "@@ -175,9 +175,7 @@ static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final Resi\n                 throw new IllegalArgumentException(\"cannot provide index.number_of_routing_shards on resize\");\n             }\n         }\n-        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&\n-            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&\n-            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {\n+        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {", "originalCommit": "42033d12c0da33401b5132d88d741d64a5496f57", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0ecee877a4c92beef7bfac4735e68056555b48e3", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java\nindex 2d1a3964819c..f13c1096d554 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/shrink/TransportResizeAction.java\n\n@@ -175,7 +175,9 @@ public class TransportResizeAction extends TransportMasterNodeAction<ResizeReque\n                 throw new IllegalArgumentException(\"cannot provide index.number_of_routing_shards on resize\");\n             }\n         }\n-        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {\n+        if (IndexSettings.INDEX_SOFT_DELETES_SETTING.get(metaData.getSettings()) &&\n+            IndexSettings.INDEX_SOFT_DELETES_SETTING.exists(targetIndexSettings) &&\n+            IndexSettings.INDEX_SOFT_DELETES_SETTING.get(targetIndexSettings) == false) {\n             throw new IllegalArgumentException(\"Can't disable [index.soft_deletes.enabled] setting on resize\");\n         }\n         String cause = resizeRequest.getResizeType().name().toLowerCase(Locale.ROOT) + \"_index\";\n"}}, {"oid": "66c507d38fbb2c456d146e8b9be7968d09f792ff", "url": "https://github.com/elastic/elasticsearch/commit/66c507d38fbb2c456d146e8b9be7968d09f792ff", "message": "wording", "committedDate": "2020-01-16T22:05:08Z", "type": "commit"}, {"oid": "1c08c1da683f9c2d122c428b96f83f68f9a73399", "url": "https://github.com/elastic/elasticsearch/commit/1c08c1da683f9c2d122c428b96f83f68f9a73399", "message": "fix the test", "committedDate": "2020-01-16T22:22:05Z", "type": "commit"}, {"oid": "0ecee877a4c92beef7bfac4735e68056555b48e3", "url": "https://github.com/elastic/elasticsearch/commit/0ecee877a4c92beef7bfac4735e68056555b48e3", "message": "resize without soft-deletes", "committedDate": "2020-01-17T02:48:09Z", "type": "commit"}, {"oid": "9a992a9aff741adc98e494eed9814769e7e21dbc", "url": "https://github.com/elastic/elasticsearch/commit/9a992a9aff741adc98e494eed9814769e7e21dbc", "message": "snapshot/restore without soft-deletes", "committedDate": "2020-01-17T02:50:03Z", "type": "commit"}, {"oid": "014b558228d5164cd200b79207676ccc2b51b437", "url": "https://github.com/elastic/elasticsearch/commit/014b558228d5164cd200b79207676ccc2b51b437", "message": "less random settings", "committedDate": "2020-01-17T03:13:26Z", "type": "commit"}, {"oid": "a794188d69e9d96ef7ded89b156d4c396e17eaee", "url": "https://github.com/elastic/elasticsearch/commit/a794188d69e9d96ef7ded89b156d4c396e17eaee", "message": "fix settings", "committedDate": "2020-01-17T03:49:20Z", "type": "commit"}, {"oid": "babe135f76731eabf3f2a2885b19b6a2613b8fa6", "url": "https://github.com/elastic/elasticsearch/commit/babe135f76731eabf3f2a2885b19b6a2613b8fa6", "message": "Merge branch 'master' into soft-deletes-mandatory", "committedDate": "2020-01-17T03:49:40Z", "type": "commit"}, {"oid": "f1c09e7a7cc147d18cb176275bc35b5c91c01edc", "url": "https://github.com/elastic/elasticsearch/commit/f1c09e7a7cc147d18cb176275bc35b5c91c01edc", "message": "Remove translog test", "committedDate": "2020-01-17T04:34:35Z", "type": "commit"}]}