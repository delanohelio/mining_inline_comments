{"pr_number": 51472, "pr_title": "Allow Repository Plugins to Filter Metadata on Create", "pr_createdAt": "2020-01-27T12:29:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51472", "timeline": [{"oid": "edbf3f331dac5b8d54e4261f92e0a711d80fd538", "url": "https://github.com/elastic/elasticsearch/commit/edbf3f331dac5b8d54e4261f92e0a711d80fd538", "message": "Allow Repository Plugins to Filter Metadata on Create\n\nAdd a hook that allows repository plugins to filter the repository metadata\nbefore it gets written to the cluster state.", "committedDate": "2020-01-27T12:28:04Z", "type": "commit"}, {"oid": "5f4942c52815af2e4322cda8d7462f1d61cdee25", "url": "https://github.com/elastic/elasticsearch/commit/5f4942c52815af2e4322cda8d7462f1d61cdee25", "message": "fix source only delegator", "committedDate": "2020-01-27T13:52:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI1MjE0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51472#discussion_r371252147", "bodyText": "Let's mark this part as WIP, we can do a nicer thing so that in the e.g. cat repo list the type is correctly displayed for the source only repo (could just do this via an override to the getMetaData on the source only repo), I'd just like to get confirmation of the approach before doing that :)", "author": "original-brownbear", "createdAt": "2020-01-27T13:56:07Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshotRepository.java", "diffHunk": "@@ -202,8 +202,7 @@ public Repository create(RepositoryMetaData metaData, Function<String, Repositor\n                     throw new IllegalArgumentException(DELEGATE_TYPE.getKey() + \" must be set\");\n                 }\n                 Repository.Factory factory = typeLookup.apply(delegateType);\n-                return new SourceOnlySnapshotRepository(factory.create(new RepositoryMetaData(metaData.name(),\n-                    delegateType, metaData.settings()), typeLookup));\n+                return new SourceOnlySnapshotRepository(factory.create(metaData, typeLookup));", "originalCommit": "5f4942c52815af2e4322cda8d7462f1d61cdee25", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c4a0e0b5c2c3a4d791f37e30be7fc3eaacc46d0e", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshotRepository.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshotRepository.java\nindex 35b77b76ef4..5291819df46 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshotRepository.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/snapshots/SourceOnlySnapshotRepository.java\n\n@@ -202,7 +202,8 @@ public final class SourceOnlySnapshotRepository extends FilterRepository {\n                     throw new IllegalArgumentException(DELEGATE_TYPE.getKey() + \" must be set\");\n                 }\n                 Repository.Factory factory = typeLookup.apply(delegateType);\n-                return new SourceOnlySnapshotRepository(factory.create(metaData, typeLookup));\n+                return new SourceOnlySnapshotRepository(factory.create(new RepositoryMetaData(metaData.name(),\n+                    delegateType, metaData.settings()), typeLookup));\n             }\n         };\n     }\n"}}, {"oid": "fedb906b359df735f6543f3a9e9c59a9c75fd48a", "url": "https://github.com/elastic/elasticsearch/commit/fedb906b359df735f6543f3a9e9c59a9c75fd48a", "message": "add snapshot user meta as param", "committedDate": "2020-01-27T18:29:46Z", "type": "commit"}, {"oid": "c4a0e0b5c2c3a4d791f37e30be7fc3eaacc46d0e", "url": "https://github.com/elastic/elasticsearch/commit/c4a0e0b5c2c3a4d791f37e30be7fc3eaacc46d0e", "message": "pass user meta to shard snapshot", "committedDate": "2020-01-27T18:45:42Z", "type": "commit"}, {"oid": "6bc8d16376cc703ebf946088ceac53ec37d0863b", "url": "https://github.com/elastic/elasticsearch/commit/6bc8d16376cc703ebf946088ceac53ec37d0863b", "message": "test", "committedDate": "2020-01-27T21:25:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyODI3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51472#discussion_r371728271", "bodyText": "Bit of a complicated test for a simple thing like this but I didn't want to add this on top of other already complicated snapshot tests.", "author": "original-brownbear", "createdAt": "2020-01-28T10:44:11Z", "path": "server/src/test/java/org/elasticsearch/snapshots/RepositoryFilterUserMetadataIT.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.snapshots;\n+\n+import org.apache.lucene.index.IndexCommit;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.snapshots.IndexShardSnapshotStatus;\n+import org.elasticsearch.index.store.Store;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RepositoryPlugin;\n+import org.elasticsearch.repositories.IndexId;\n+import org.elasticsearch.repositories.Repository;\n+import org.elasticsearch.repositories.ShardGenerations;\n+import org.elasticsearch.repositories.fs.FsRepository;\n+import org.elasticsearch.test.ESIntegTestCase;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.is;\n+\n+public class RepositoryFilterUserMetadataIT extends ESIntegTestCase {", "originalCommit": "6bc8d16376cc703ebf946088ceac53ec37d0863b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a85a907be4fc9d1505b88dd2cd095a5970c4f6a", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/snapshots/RepositoryFilterUserMetadataIT.java b/server/src/test/java/org/elasticsearch/snapshots/RepositoryFilterUserMetadataIT.java\nindex 0c80a3f731a..05d0bf4516d 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/RepositoryFilterUserMetadataIT.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/RepositoryFilterUserMetadataIT.java\n\n@@ -102,7 +102,7 @@ public class RepositoryFilterUserMetadataIT extends ESIntegTestCase {\n                     }\n \n                     @Override\n-                    public Map<String, Object> filterUserMetadata(Map<String, Object> userMetadata) {\n+                    public Map<String, Object> adaptUserMetadata(Map<String, Object> userMetadata) {\n                         return Collections.singletonMap(MOCK_FILTERED_META, clusterService.getNodeName());\n                     }\n                 });\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgyNzkzMg==", "url": "https://github.com/elastic/elasticsearch/pull/51472#discussion_r371827932", "bodyText": "perhaps call this method adaptUserMetadata?", "author": "ywelsch", "createdAt": "2020-01-28T14:18:09Z", "path": "server/src/main/java/org/elasticsearch/repositories/Repository.java", "diffHunk": "@@ -234,4 +237,12 @@ void restoreShard(Store store, SnapshotId snapshotId, IndexId indexId, ShardId s\n      * @param state new cluster state\n      */\n     void updateState(ClusterState state);\n+\n+    /**\n+     * Hook that allows a repository to filter the user supplied snapshot metadata in {@link SnapshotsInProgress.Entry#userMetadata()}\n+     * during snapshot initialization.\n+     */\n+    default Map<String, Object> filterUserMetadata(Map<String, Object> userMetadata) {", "originalCommit": "6bc8d16376cc703ebf946088ceac53ec37d0863b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6a85a907be4fc9d1505b88dd2cd095a5970c4f6a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/repositories/Repository.java b/server/src/main/java/org/elasticsearch/repositories/Repository.java\nindex fa7f1151329..95c4da6666a 100644\n--- a/server/src/main/java/org/elasticsearch/repositories/Repository.java\n+++ b/server/src/main/java/org/elasticsearch/repositories/Repository.java\n\n@@ -242,7 +242,7 @@ public interface Repository extends LifecycleComponent {\n      * Hook that allows a repository to filter the user supplied snapshot metadata in {@link SnapshotsInProgress.Entry#userMetadata()}\n      * during snapshot initialization.\n      */\n-    default Map<String, Object> filterUserMetadata(Map<String, Object> userMetadata) {\n+    default Map<String, Object> adaptUserMetadata(Map<String, Object> userMetadata) {\n         return userMetadata;\n     }\n }\n"}}, {"oid": "1d763c1fa4baa73c5be53ba3d9f2f08b908e9285", "url": "https://github.com/elastic/elasticsearch/commit/1d763c1fa4baa73c5be53ba3d9f2f08b908e9285", "message": "Merge remote-tracking branch 'elastic/master' into snapshot-repo-metadata-filtering", "committedDate": "2020-01-28T14:29:06Z", "type": "commit"}, {"oid": "6a85a907be4fc9d1505b88dd2cd095a5970c4f6a", "url": "https://github.com/elastic/elasticsearch/commit/6a85a907be4fc9d1505b88dd2cd095a5970c4f6a", "message": "cr rename", "committedDate": "2020-01-28T14:32:48Z", "type": "commit"}]}