{"pr_number": 53880, "pr_title": "SQL: jdbc debugging enhancement", "pr_createdAt": "2020-03-20T15:40:14Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53880", "timeline": [{"oid": "7832e66f00be1243f1400bf1c1c0807a70ceeef3", "url": "https://github.com/elastic/elasticsearch/commit/7832e66f00be1243f1400bf1c1c0807a70ceeef3", "message": "* add buffered debug output option that will flush the output printer\nafter each debug message when enabled (disabled by default)\n* upon connection time and debug classes initialization, log in debug\noutput information about OS, JVM and default JVM timezone", "committedDate": "2020-03-20T15:29:06Z", "type": "commit"}, {"oid": "c3f59d306e82a0737904758849d35d11d92b990a", "url": "https://github.com/elastic/elasticsearch/commit/c3f59d306e82a0737904758849d35d11d92b990a", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into jdbc_debug_enhancement", "committedDate": "2020-03-20T15:34:48Z", "type": "commit"}, {"oid": "a3d71402d8c23fc8b5b9cf925619226661eb7775", "url": "https://github.com/elastic/elasticsearch/commit/a3d71402d8c23fc8b5b9cf925619226661eb7775", "message": "locale -> timezone", "committedDate": "2020-03-20T15:41:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAzMzg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/53880#discussion_r396033848", "bodyText": "I think debug.flushAlways or debug.noBuffer is more meaningful. I also like the consistency of the options - by default they are false and need to be turn on through true.\nThat is the default (false) is to always buffer but true would yield an immediate flush.", "author": "costin", "createdAt": "2020-03-21T22:14:58Z", "path": "x-pack/plugin/sql/jdbc/src/test/java/org/elasticsearch/xpack/sql/jdbc/JdbcConfigurationTests.java", "diffHunk": "@@ -75,6 +75,23 @@ public void testDebugOut() throws Exception {\n         assertThat(ci.debugOut(), is(\"jdbc.out\"));\n     }\n \n+    public void testDebugBuffered() throws Exception {\n+        JdbcConfiguration ci = ci(\"jdbc:es://a:1/?debug=true&debug.buffered=false\");", "originalCommit": "a3d71402d8c23fc8b5b9cf925619226661eb7775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "686f64bc2d8963d9183f8c229ae1ccc8bf0c9057", "chunk": "diff --git a/x-pack/plugin/sql/jdbc/src/test/java/org/elasticsearch/xpack/sql/jdbc/JdbcConfigurationTests.java b/x-pack/plugin/sql/jdbc/src/test/java/org/elasticsearch/xpack/sql/jdbc/JdbcConfigurationTests.java\nindex 616fd481e45..680b1eebe48 100644\n--- a/x-pack/plugin/sql/jdbc/src/test/java/org/elasticsearch/xpack/sql/jdbc/JdbcConfigurationTests.java\n+++ b/x-pack/plugin/sql/jdbc/src/test/java/org/elasticsearch/xpack/sql/jdbc/JdbcConfigurationTests.java\n\n@@ -75,21 +75,21 @@ public class JdbcConfigurationTests extends ESTestCase {\n         assertThat(ci.debugOut(), is(\"jdbc.out\"));\n     }\n \n-    public void testDebugBuffered() throws Exception {\n-        JdbcConfiguration ci = ci(\"jdbc:es://a:1/?debug=true&debug.buffered=false\");\n+    public void testDebugFlushAlways() throws Exception {\n+        JdbcConfiguration ci = ci(\"jdbc:es://a:1/?debug=true&debug.flushAlways=false\");\n         assertThat(ci.baseUri().toString(), is(\"http://a:1/\"));\n         assertThat(ci.debug(), is(true));\n-        assertThat(ci.debugBuffered(), is(false));\n+        assertThat(ci.flushAlways(), is(false));\n \n-        ci = ci(\"jdbc:es://a:1/?debug=true&debug.buffered=true\");\n+        ci = ci(\"jdbc:es://a:1/?debug=true&debug.flushAlways=true\");\n         assertThat(ci.baseUri().toString(), is(\"http://a:1/\"));\n         assertThat(ci.debug(), is(true));\n-        assertThat(ci.debugBuffered(), is(true));\n+        assertThat(ci.flushAlways(), is(true));\n \n         ci = ci(\"jdbc:es://a:1/?debug=true\");\n         assertThat(ci.baseUri().toString(), is(\"http://a:1/\"));\n         assertThat(ci.debug(), is(true));\n-        assertThat(ci.debugBuffered(), is(true));\n+        assertThat(ci.flushAlways(), is(false));\n     }\n \n     public void testTypeInParam() throws Exception {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAzMzkwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53880#discussion_r396033901", "bodyText": "No need to keep the prefix debug as this is a DebugXXX class.", "author": "costin", "createdAt": "2020-03-21T22:15:39Z", "path": "x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/DebugLog.java", "diffHunk": "@@ -17,9 +17,11 @@\n     private static final String HEADER = \"%tF/%tT.%tL - \";\n \n     final PrintWriter print;\n+    private boolean debugBuffered;", "originalCommit": "a3d71402d8c23fc8b5b9cf925619226661eb7775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "686f64bc2d8963d9183f8c229ae1ccc8bf0c9057", "chunk": "diff --git a/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/DebugLog.java b/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/DebugLog.java\nindex 95a00103378..c3f5598d162 100644\n--- a/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/DebugLog.java\n+++ b/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/DebugLog.java\n\n@@ -17,11 +17,11 @@ final class DebugLog {\n     private static final String HEADER = \"%tF/%tT.%tL - \";\n \n     final PrintWriter print;\n-    private boolean debugBuffered;\n+    private boolean flushAlways;\n \n-    DebugLog(PrintWriter print, boolean debugBuffered) {\n+    DebugLog(PrintWriter print, boolean flushAlways) {\n         this.print = print;\n-        this.debugBuffered = debugBuffered;\n+        this.flushAlways = flushAlways;\n     }\n \n     void logMethod(Method m, Object[] args) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAzNDg3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53880#discussion_r396034875", "bodyText": "The method changes make it more complicated and hard to follow - there's this log ==null being repeated which begs the question, what happens it if it initialized?\nI think the method is good as it is - it creates a logger or returns one that already exists. Either wrap this method in another one that calls logSystemInfo (rename the existing method into something like createLogger and then logger calls createLogger().logSystemInfo or wrap that at the consumer site - inside proxy.\nHowever currently the systemInfo is being called per each Connection which I think is excessive - we want the system information to be once per log, at the beginning.\nIn which case, the system info should called when a new log is created, essentially after each new DebugLog.\nTo keep things incapsulated, instead of calling the constructor, one could call a method createLog which internally calls new DebugLog and right after calls logSystemInfo.\nThis way any other initialization that would need to occur, would happen in that method regardless of the actual method taking place and only once per logger.\nIt might make sense to call flush after logging the system info.", "author": "costin", "createdAt": "2020-03-21T22:30:52Z", "path": "x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/Debug.java", "diffHunk": "@@ -113,17 +113,16 @@ private static DebugLog logger(JdbcConfiguration info, PrintWriter managedPrinte\n             synchronized (Debug.class) {\n                 log = OUTPUT_MANAGED.get(managedPrinter);\n                 if (log == null) {\n-                    log = new DebugLog(managedPrinter);\n+                    log = new DebugLog(managedPrinter, info.debugBuffered());\n                     OUTPUT_MANAGED.put(managedPrinter, log);\n                 }\n-                return log;", "originalCommit": "a3d71402d8c23fc8b5b9cf925619226661eb7775", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "686f64bc2d8963d9183f8c229ae1ccc8bf0c9057", "chunk": "diff --git a/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/Debug.java b/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/Debug.java\nindex 464a7eafb32..7f4385fe015 100644\n--- a/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/Debug.java\n+++ b/x-pack/plugin/sql/jdbc/src/main/java/org/elasticsearch/xpack/sql/jdbc/Debug.java\n\n@@ -113,7 +113,7 @@ final class Debug {\n             synchronized (Debug.class) {\n                 log = OUTPUT_MANAGED.get(managedPrinter);\n                 if (log == null) {\n-                    log = new DebugLog(managedPrinter, info.debugBuffered());\n+                    log = createLog(managedPrinter, info.flushAlways());\n                     OUTPUT_MANAGED.put(managedPrinter, log);\n                 }\n             }\n"}}, {"oid": "686f64bc2d8963d9183f8c229ae1ccc8bf0c9057", "url": "https://github.com/elastic/elasticsearch/commit/686f64bc2d8963d9183f8c229ae1ccc8bf0c9057", "message": "Address reviews", "committedDate": "2020-03-23T16:23:52Z", "type": "commit"}, {"oid": "0808286561a1f01cee8649adf6263699be6e6da3", "url": "https://github.com/elastic/elasticsearch/commit/0808286561a1f01cee8649adf6263699be6e6da3", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into jdbc_debug_enhancement", "committedDate": "2020-03-23T16:24:29Z", "type": "commit"}]}