{"pr_number": 55453, "pr_title": "Require soft deletes for searchable snapshots", "pr_createdAt": "2020-04-20T10:50:41Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55453", "timeline": [{"oid": "3ee3985904f5bce3c6a963f1c9755b5246173ec0", "url": "https://github.com/elastic/elasticsearch/commit/3ee3985904f5bce3c6a963f1c9755b5246173ec0", "message": "Require soft deletes for searchable snapshots", "committedDate": "2020-04-20T09:19:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI4MTAyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/55453#discussion_r411281025", "bodyText": "In fact this is always true in master, but not in 7.x. Setting it in both places for ease of backport.", "author": "DaveCTurner", "createdAt": "2020-04-20T10:51:15Z", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -71,13 +72,12 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n                 .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))\n         );\n \n-        createIndex(indexName);\n+        assertAcked(prepareCreate(indexName, Settings.builder().put(INDEX_SOFT_DELETES_SETTING.getKey(), true)));", "originalCommit": "3ee3985904f5bce3c6a963f1c9755b5246173ec0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f03118cb975dbc899cfd7c349935d83eb500ca20", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\nindex 4859ac18677..0ee121114d9 100644\n--- a/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n+++ b/x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java\n\n@@ -72,6 +72,8 @@ public class SearchableSnapshotsIntegTests extends BaseSearchableSnapshotsIntegT\n                 .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))\n         );\n \n+        // Peer recovery always copies .liv files but we do not permit writing to searchable snapshot directories so this doesn't work, but\n+        // we can bypass this by forcing soft deletes to be used. TODO this restriction can be lifted when #55142 is resolved.\n         assertAcked(prepareCreate(indexName, Settings.builder().put(INDEX_SOFT_DELETES_SETTING.getKey(), true)));\n         final List<IndexRequestBuilder> indexRequestBuilders = new ArrayList<>();\n         for (int i = between(10, 10_000); i >= 0; i--) {\n"}}, {"oid": "f03118cb975dbc899cfd7c349935d83eb500ca20", "url": "https://github.com/elastic/elasticsearch/commit/f03118cb975dbc899cfd7c349935d83eb500ca20", "message": "No IAE", "committedDate": "2020-04-20T11:57:52Z", "type": "commit"}]}