{"pr_number": 64996, "pr_title": "Add deprecation check for Java version", "pr_createdAt": "2020-11-12T13:11:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64996", "timeline": [{"oid": "96a25d20c812d3373052cafbc8c199e0c52b0faa", "url": "https://github.com/elastic/elasticsearch/commit/96a25d20c812d3373052cafbc8c199e0c52b0faa", "message": "Add deprecation check for Java version\n\nAdds a deprecation check for Java version, as Java 11 will be required\nin the next version of Elasticsearch.", "committedDate": "2019-04-10T21:12:04Z", "type": "commit"}, {"oid": "250da3e3e6e12e88aac8afb83a4bafd857069fc0", "url": "https://github.com/elastic/elasticsearch/commit/250da3e3e6e12e88aac8afb83a4bafd857069fc0", "message": "Merge remote-tracking branch 'upstream/7.x' into deprecation-check-java", "committedDate": "2020-11-06T13:30:39Z", "type": "commit"}, {"oid": "2b5c1a96d00ec808ca63a155f27f24dc65f187d1", "url": "https://github.com/elastic/elasticsearch/commit/2b5c1a96d00ec808ca63a155f27f24dc65f187d1", "message": "Merge remote-tracking branch 'upstream/7.x' into deprecation-check-java", "committedDate": "2020-11-12T12:51:18Z", "type": "commit"}, {"oid": "612c511a2b80f245c626c78ed697b0ec1b990cb0", "url": "https://github.com/elastic/elasticsearch/commit/612c511a2b80f245c626c78ed697b0ec1b990cb0", "message": "Test fixes across JVM versions", "committedDate": "2020-11-12T13:39:52Z", "type": "commit"}, {"oid": "8611b507a619bb88ebb3cb306ff0dfea245c36c6", "url": "https://github.com/elastic/elasticsearch/commit/8611b507a619bb88ebb3cb306ff0dfea245c36c6", "message": "More fixes", "committedDate": "2020-11-12T14:09:05Z", "type": "commit"}, {"oid": "e661070b854eddc30843867e1f1abbc794b010ae", "url": "https://github.com/elastic/elasticsearch/commit/e661070b854eddc30843867e1f1abbc794b010ae", "message": "Merge remote-tracking branch 'upstream/7.x' into deprecation-check-java", "committedDate": "2020-11-16T11:51:53Z", "type": "commit"}, {"oid": "7b10767a7a2028bd9012433d1518fe4f6f41c4d2", "url": "https://github.com/elastic/elasticsearch/commit/7b10767a7a2028bd9012433d1518fe4f6f41c4d2", "message": "Disable node deprecation length checks in REST tests\n\nSome tests check the length of the `node_settings` array that comes back\nfrom the `/_migration/deprecations` API. However, the length can now\nvary depending on the JDK being used by ES, and that can't be\nrepresented in the REST tests at the moment.", "committedDate": "2020-11-16T12:07:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNTExOA==", "url": "https://github.com/elastic/elasticsearch/pull/64996#discussion_r524515118", "bodyText": "I wonder if we should first suggest using the bundled jdk?", "author": "rjernst", "createdAt": "2020-11-16T19:21:38Z", "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -255,4 +256,15 @@ static DeprecationIssue checkRemovedSetting(final Settings settings, final Setti\n         return new DeprecationIssue(DeprecationIssue.Level.CRITICAL, message, url, details);\n     }\n \n+    static DeprecationIssue javaVersionCheck(Settings nodeSettings, PluginsAndModules plugins) {\n+        if (JavaVersion.current().compareTo(JavaVersion.parse(\"11\")) < 0) {\n+            return new DeprecationIssue(DeprecationIssue.Level.CRITICAL,\n+                \"Java 11 is required\",\n+                \"https://www.elastic.co/guide/en/elasticsearch/reference/master/breaking-changes-8.0.html#_java_11_is_required\",\n+                \"Java 11 will be required for future versions of Elasticsearch, this node is running version \"", "originalCommit": "7b10767a7a2028bd9012433d1518fe4f6f41c4d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTA2NTg4NA==", "url": "https://github.com/elastic/elasticsearch/pull/64996#discussion_r525065884", "bodyText": "Good idea. I've added a note here, and in a couple other places too. What do you think?", "author": "pugnascotia", "createdAt": "2020-11-17T10:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYyODQ3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64996#discussion_r525628473", "bodyText": "The new wording is better, but it may be confusing for some users since they may have the bundled jdk, but have JAVA_HOME set by their system, so what they need to do is unset JAVA_HOME.", "author": "rjernst", "createdAt": "2020-11-18T01:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNTExOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1OTgzNg==", "url": "https://github.com/elastic/elasticsearch/pull/64996#discussion_r525959836", "bodyText": "I've expanded the message further.", "author": "pugnascotia", "createdAt": "2020-11-18T10:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUxNTExOA=="}], "type": "inlineReview", "revised_code": {"commit": "be54f00f03e8e4e420314204221af414cb25e91c", "chunk": "diff --git a/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java b/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java\nindex 324ca617ab3..068635a3148 100644\n--- a/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java\n+++ b/x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java\n\n@@ -257,12 +257,14 @@ class NodeDeprecationChecks {\n     }\n \n     static DeprecationIssue javaVersionCheck(Settings nodeSettings, PluginsAndModules plugins) {\n-        if (JavaVersion.current().compareTo(JavaVersion.parse(\"11\")) < 0) {\n+        final JavaVersion javaVersion = JavaVersion.current();\n+\n+        if (javaVersion.compareTo(JavaVersion.parse(\"11\")) < 0) {\n             return new DeprecationIssue(DeprecationIssue.Level.CRITICAL,\n                 \"Java 11 is required\",\n-                \"https://www.elastic.co/guide/en/elasticsearch/reference/master/breaking-changes-8.0.html#_java_11_is_required\",\n-                \"Java 11 will be required for future versions of Elasticsearch, this node is running version \"\n-                    + JavaVersion.current().toString());\n+                \"https://www.elastic.co/guide/en/elasticsearch/reference/master/breaking-changes-8.0.html#breaking_80_packaging_changes\",\n+                \"Java 11 will be required for future versions of Elasticsearch, this node is running version [\"\n+                    + javaVersion.toString() + \"]. Consider switching to a distribution of Elasticsearch with a bundled JDK\");\n         }\n         return null;\n     }\n"}}, {"oid": "be54f00f03e8e4e420314204221af414cb25e91c", "url": "https://github.com/elastic/elasticsearch/commit/be54f00f03e8e4e420314204221af414cb25e91c", "message": "Reference bundled JDK in deprecation message", "committedDate": "2020-11-17T10:53:32Z", "type": "commit"}, {"oid": "c5e27d52c8706bbc258c009bcd5f3205c88f0255", "url": "https://github.com/elastic/elasticsearch/commit/c5e27d52c8706bbc258c009bcd5f3205c88f0255", "message": "Reference bundled JDK in other deprecation messages also", "committedDate": "2020-11-17T10:58:25Z", "type": "commit"}, {"oid": "df2489f6d1b3fa5e3d523c47d9e21f9828629d9d", "url": "https://github.com/elastic/elasticsearch/commit/df2489f6d1b3fa5e3d523c47d9e21f9828629d9d", "message": "Expand JDK message further", "committedDate": "2020-11-18T10:02:24Z", "type": "commit"}]}