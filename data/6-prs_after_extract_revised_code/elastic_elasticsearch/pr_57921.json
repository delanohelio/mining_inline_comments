{"pr_number": 57921, "pr_title": "Remove deprecated usage of testCompile configuration", "pr_createdAt": "2020-06-10T08:53:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57921", "timeline": [{"oid": "fba4cddb2b67ec563ccce9fdc799f1ea622c26a9", "url": "https://github.com/elastic/elasticsearch/commit/fba4cddb2b67ec563ccce9fdc799f1ea622c26a9", "message": "Remove deprecated testCompile configuration", "committedDate": "2020-06-10T08:50:42Z", "type": "commit"}, {"oid": "85ede2af28911bde902aaa0f9cd667889f96375b", "url": "https://github.com/elastic/elasticsearch/commit/85ede2af28911bde902aaa0f9cd667889f96375b", "message": "Replace testCompile in StandaloneRestTest plugin", "committedDate": "2020-06-10T09:38:51Z", "type": "commit"}, {"oid": "b0d2b646a3bdcece5d9ae74f18087884fce08811", "url": "https://github.com/elastic/elasticsearch/commit/b0d2b646a3bdcece5d9ae74f18087884fce08811", "message": "Replace testCompile usage by testImplementation\n\n- fix taskArtifact declaration\n- make testImplementation non transitive by default (as we did for testCompile", "committedDate": "2020-06-10T15:53:57Z", "type": "commit"}, {"oid": "f33705783e75697c163a1258de484a0cca708297", "url": "https://github.com/elastic/elasticsearch/commit/f33705783e75697c163a1258de484a0cca708297", "message": "Remove debugging output", "committedDate": "2020-06-10T16:09:53Z", "type": "commit"}, {"oid": "f1ddc523504d62c055edcd647c82ba2897880559", "url": "https://github.com/elastic/elasticsearch/commit/f1ddc523504d62c055edcd647c82ba2897880559", "message": "Update CONTRIBUTING about using testImplementation", "committedDate": "2020-06-11T09:18:28Z", "type": "commit"}, {"oid": "2b161b28badb7739bb59bedde24ba13ebafb7172", "url": "https://github.com/elastic/elasticsearch/commit/2b161b28badb7739bb59bedde24ba13ebafb7172", "message": "Fail on testCompile configuration usage", "committedDate": "2020-06-11T09:45:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwMzMwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/57921#discussion_r439103305", "bodyText": "Nice \ud83d\udc4d", "author": "mark-vieira", "createdAt": "2020-06-11T22:21:46Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -114,9 +114,24 @@ public void apply(Project project) {\n     public static void configureConfigurations(Project project) {\n         // we want to test compileOnly deps!\n         Configuration compileOnlyConfig = project.getConfigurations().getByName(JavaPlugin.COMPILE_ONLY_CONFIGURATION_NAME);\n-        Configuration testCompileConfig = project.getConfigurations().getByName(JavaPlugin.TEST_COMPILE_CONFIGURATION_NAME);\n-        testCompileConfig.extendsFrom(compileOnlyConfig);\n-\n+        Configuration testImplementationConfig = project.getConfigurations().getByName(JavaPlugin.TEST_IMPLEMENTATION_CONFIGURATION_NAME);\n+        testImplementationConfig.extendsFrom(compileOnlyConfig);\n+\n+        // fail on using deprecated testCompile\n+        project.getConfigurations()", "originalCommit": "2b161b28badb7739bb59bedde24ba13ebafb7172", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwMzUwMg==", "url": "https://github.com/elastic/elasticsearch/pull/57921#discussion_r439103502", "bodyText": "We can probably remove this now since we fail if you add any dependencies to this configuration.", "author": "mark-vieira", "createdAt": "2020-06-11T22:22:22Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -145,6 +160,7 @@ public static void configureConfigurations(Project project) {\n         disableTransitiveDeps.accept(JavaPlugin.TEST_COMPILE_CONFIGURATION_NAME);", "originalCommit": "2b161b28badb7739bb59bedde24ba13ebafb7172", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b4eb75ebd66884773e6af8cb97d45c4ea4863e6f", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\nindex b2ec174be9d..2fefe55af40 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\n\n@@ -157,7 +157,6 @@ public class ElasticsearchJavaPlugin implements Plugin<Project> {\n             });\n         };\n         disableTransitiveDeps.accept(JavaPlugin.COMPILE_CONFIGURATION_NAME);\n-        disableTransitiveDeps.accept(JavaPlugin.TEST_COMPILE_CONFIGURATION_NAME);\n         disableTransitiveDeps.accept(JavaPlugin.COMPILE_ONLY_CONFIGURATION_NAME);\n         disableTransitiveDeps.accept(JavaPlugin.RUNTIME_ONLY_CONFIGURATION_NAME);\n         disableTransitiveDeps.accept(JavaPlugin.TEST_IMPLEMENTATION_CONFIGURATION_NAME);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDUzNw==", "url": "https://github.com/elastic/elasticsearch/pull/57921#discussion_r439104537", "bodyText": "I assume this is to deal with standalone test projects, that don't have a \"main\" sourceset. If so, should we be using testRuntimeClasspath here? I dunno, @rjernst, what do you think? Should we even be auditing third party libraries for qa projects? I think we were discussion what all precommit checks should apply to those recently.", "author": "mark-vieira", "createdAt": "2020-06-11T22:25:29Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/ThirdPartyAuditTask.java", "diffHunk": "@@ -391,7 +391,7 @@ private String runForbiddenAPIsCli() throws IOException {\n     private Configuration getRuntimeConfiguration() {\n         Configuration runtime = getProject().getConfigurations().findByName(\"runtimeClasspath\");\n         if (runtime == null) {\n-            return getProject().getConfigurations().getByName(\"testCompile\");\n+            return getProject().getConfigurations().getByName(\"testCompileClasspath\");", "originalCommit": "2b161b28badb7739bb59bedde24ba13ebafb7172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNDM4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/57921#discussion_r439114381", "bodyText": "I don't think we need third part audit for any tests, just our production code.", "author": "rjernst", "createdAt": "2020-06-11T22:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDUzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTc0MA==", "url": "https://github.com/elastic/elasticsearch/pull/57921#discussion_r439115740", "bodyText": "Ok, let's leave this as-is for now, and we can rip this out when we refactor the standalone test plugin.", "author": "mark-vieira", "createdAt": "2020-06-11T22:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDUzNw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "b4eb75ebd66884773e6af8cb97d45c4ea4863e6f", "url": "https://github.com/elastic/elasticsearch/commit/b4eb75ebd66884773e6af8cb97d45c4ea4863e6f", "message": "Apply review feedback & cleanup", "committedDate": "2020-06-12T06:53:10Z", "type": "commit"}, {"oid": "cd80915b2beb0a571df9eaf9fa80147c9172cbad", "url": "https://github.com/elastic/elasticsearch/commit/cd80915b2beb0a571df9eaf9fa80147c9172cbad", "message": "Merge branch 'master' into remove-deprecated-testcompile-config-use", "committedDate": "2020-06-12T08:31:18Z", "type": "commit"}]}