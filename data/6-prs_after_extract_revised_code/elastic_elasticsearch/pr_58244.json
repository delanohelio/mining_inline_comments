{"pr_number": 58244, "pr_title": "Do not wrap CacheFile reentrant r/w locks with ReleasableLock", "pr_createdAt": "2020-06-17T12:01:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58244", "timeline": [{"oid": "45af1b041854a1062b021b1050fa0006d37708e0", "url": "https://github.com/elastic/elasticsearch/commit/45af1b041854a1062b021b1050fa0006d37708e0", "message": "Do not wrap CacheFile reentrant rw locks with ReleasableLock", "committedDate": "2020-06-17T11:56:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441493739", "bodyText": "Can we return fileLock::close if we make this method return Releasable instead?", "author": "DaveCTurner", "createdAt": "2020-06-17T12:05:03Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -85,7 +85,8 @@ public Path getFile() {\n \n     ReleasableLock fileLock() {\n         boolean success = false;\n-        final ReleasableLock fileLock = readLock.acquire();\n+        final ReleasableLock fileLock = new ReleasableLock(readLock);", "originalCommit": "45af1b041854a1062b021b1050fa0006d37708e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUyODA1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441528056", "bodyText": "Sure, in that case we don't need the ReleasableLock at all and can return readLock::unlock: I pushed ebae53d", "author": "tlrx", "createdAt": "2020-06-17T13:04:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzczOQ=="}], "type": "inlineReview", "revised_code": {"commit": "ebae53d76e70a2b3282273377e4c85c26f06b301", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\nindex 68dcf4fd52f..79b517ab40a 100644\n--- a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n+++ b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n\n@@ -83,10 +83,9 @@ public class CacheFile {\n         return file;\n     }\n \n-    ReleasableLock fileLock() {\n+    Releasable fileLock() {\n         boolean success = false;\n-        final ReleasableLock fileLock = new ReleasableLock(readLock);\n-        fileLock.acquire();\n+        readLock.lock();\n         try {\n             ensureOpen();\n             // check if we have a channel while holding the read lock\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTEwNA==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441495104", "bodyText": "Before this change we released evictionLock after calling refCounter.decRef(), but this change reverses the order. Can we keep the order the same?", "author": "DaveCTurner", "createdAt": "2020-06-17T12:07:41Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -122,9 +124,11 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n                     listeners = Collections.unmodifiableSet(newListeners);\n                     success = true;\n                 } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+                    evictionLock.unlock();", "originalCommit": "45af1b041854a1062b021b1050fa0006d37708e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUyODMxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441528319", "bodyText": "Good catch - I've been a bit quick on this. I pushed 2180f56", "author": "tlrx", "createdAt": "2020-06-17T13:04:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTEwNA=="}], "type": "inlineReview", "revised_code": {"commit": "2180f565b935dca6ddbbcb55d2abb26a77ba857e", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\nindex 68dcf4fd52f..8047efaff07 100644\n--- a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n+++ b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n\n@@ -113,23 +112,20 @@ public class CacheFile {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n+            evictionLock.lock();\n             try {\n-                evictionLock.lock();\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    evictionLock.unlock();\n-                }\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n             } finally {\n                 if (success == false) {\n                     refCounter.decRef();\n                 }\n+                evictionLock.unlock();\n             }\n         }\n         assert invariant();\n"}}, {"oid": "ebae53d76e70a2b3282273377e4c85c26f06b301", "url": "https://github.com/elastic/elasticsearch/commit/ebae53d76e70a2b3282273377e4c85c26f06b301", "message": "Releasable", "committedDate": "2020-06-17T12:49:41Z", "type": "commit"}, {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e", "url": "https://github.com/elastic/elasticsearch/commit/2180f565b935dca6ddbbcb55d2abb26a77ba857e", "message": "unlock", "committedDate": "2020-06-17T13:03:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441609770", "bodyText": "Looks like refCounter.decRef() can throw an UncheckedIOException so we need another finally here.", "author": "DaveCTurner", "createdAt": "2020-06-17T14:55:43Z", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -112,20 +112,20 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n-            try (ReleasableLock ignored = evictionLock.acquire()) {\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+            evictionLock.lock();\n+            try {\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n+            } finally {\n+                if (success == false) {\n+                    refCounter.decRef();\n                 }\n+                evictionLock.unlock();", "originalCommit": "2180f565b935dca6ddbbcb55d2abb26a77ba857e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxNTczMg==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441615732", "bodyText": "Good catch (bis)", "author": "tlrx", "createdAt": "2020-06-17T15:03:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxNjM2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441616365", "bodyText": "I pushed a0e6db7", "author": "tlrx", "createdAt": "2020-06-17T15:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA=="}], "type": "inlineReview", "revised_code": {"commit": "a0e6db7e6a794f38d3da6b85138785d153ebe7a2", "chunk": "diff --git a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\nindex 8047efaff07..6a68549aa78 100644\n--- a/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n+++ b/x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java\n\n@@ -122,10 +122,13 @@ public class CacheFile {\n                 listeners = Collections.unmodifiableSet(newListeners);\n                 success = true;\n             } finally {\n-                if (success == false) {\n-                    refCounter.decRef();\n+                try {\n+                    if (success == false) {\n+                        refCounter.decRef();\n+                    }\n+                } finally {\n+                    evictionLock.unlock();\n                 }\n-                evictionLock.unlock();\n             }\n         }\n         assert invariant();\n"}}, {"oid": "a0e6db7e6a794f38d3da6b85138785d153ebe7a2", "url": "https://github.com/elastic/elasticsearch/commit/a0e6db7e6a794f38d3da6b85138785d153ebe7a2", "message": "yet another finally", "committedDate": "2020-06-17T15:02:47Z", "type": "commit"}, {"oid": "a5d5c5abfc53b101dfecf2b1e0406e3f838960e2", "url": "https://github.com/elastic/elasticsearch/commit/a5d5c5abfc53b101dfecf2b1e0406e3f838960e2", "message": "Merge branch 'master' into remove-releasable", "committedDate": "2020-06-17T16:23:51Z", "type": "commit"}]}