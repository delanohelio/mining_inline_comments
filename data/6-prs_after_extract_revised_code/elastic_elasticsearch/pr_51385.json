{"pr_number": 51385, "pr_title": "Add a cluster setting to disallow expensive queries", "pr_createdAt": "2020-01-23T23:15:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51385", "timeline": [{"oid": "3b52cdf8908ec28c3b6ca7ea9c837bc7d7b23f8a", "url": "https://github.com/elastic/elasticsearch/commit/3b52cdf8908ec28c3b6ca7ea9c837bc7d7b23f8a", "message": "skip for < 7.7", "committedDate": "2020-01-24T11:53:15Z", "type": "forcePushed"}, {"oid": "3a219ca351d9468208e4286314f44a7b2211a50f", "url": "https://github.com/elastic/elasticsearch/commit/3a219ca351d9468208e4286314f44a7b2211a50f", "message": "Add a cluster setting to disallow slow queries", "committedDate": "2020-01-24T15:29:49Z", "type": "forcePushed"}, {"oid": "d9a14a6e90d1a4c65910e287c9c2984ef96ef5a2", "url": "https://github.com/elastic/elasticsearch/commit/d9a14a6e90d1a4c65910e287c9c2984ef96ef5a2", "message": "Add a cluster setting to disallow slow queries\n\nAdd a new cluster setting `search.disallow_slow_queries` which by\ndefault is `false`. If set to `true` then certain queries (prefix,\nfuzzy, regexp and wildcard) that have usually slow performance cannot\nbe executed and an exception is thrown.\n\nCloses: #29050", "committedDate": "2020-01-24T16:59:29Z", "type": "commit"}, {"oid": "d9a14a6e90d1a4c65910e287c9c2984ef96ef5a2", "url": "https://github.com/elastic/elasticsearch/commit/d9a14a6e90d1a4c65910e287c9c2984ef96ef5a2", "message": "Add a cluster setting to disallow slow queries\n\nAdd a new cluster setting `search.disallow_slow_queries` which by\ndefault is `false`. If set to `true` then certain queries (prefix,\nfuzzy, regexp and wildcard) that have usually slow performance cannot\nbe executed and an exception is thrown.\n\nCloses: #29050", "committedDate": "2020-01-24T16:59:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE3ODY0NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r371178645", "bodyText": "nit: remove change", "author": "jimczi", "createdAt": "2020-01-27T11:06:15Z", "path": "server/src/main/java/org/elasticsearch/index/IndexService.java", "diffHunk": "@@ -223,6 +226,8 @@ public IndexService(\n         this.globalCheckpointTask = new AsyncGlobalCheckpointTask(this);\n         this.retentionLeaseSyncTask = new AsyncRetentionLeaseSyncTask(this);\n         updateFsyncTaskIfNecessary();\n+\n+", "originalCommit": "d9a14a6e90d1a4c65910e287c9c2984ef96ef5a2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "181d838fa68b788c3c09d96b5e419078ff836cd4", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/IndexService.java b/server/src/main/java/org/elasticsearch/index/IndexService.java\nindex 40db224998f..43cc71f7ecd 100644\n--- a/server/src/main/java/org/elasticsearch/index/IndexService.java\n+++ b/server/src/main/java/org/elasticsearch/index/IndexService.java\n\n@@ -226,8 +226,6 @@ public class IndexService extends AbstractIndexComponent implements IndicesClust\n         this.globalCheckpointTask = new AsyncGlobalCheckpointTask(this);\n         this.retentionLeaseSyncTask = new AsyncRetentionLeaseSyncTask(this);\n         updateFsyncTaskIfNecessary();\n-\n-\n     }\n \n     static boolean needsMapperService(IndexSettings indexSettings, IndexCreationContext indexCreationContext) {\n"}}, {"oid": "181d838fa68b788c3c09d96b5e419078ff836cd4", "url": "https://github.com/elastic/elasticsearch/commit/181d838fa68b788c3c09d96b5e419078ff836cd4", "message": "address comments", "committedDate": "2020-01-27T15:27:08Z", "type": "commit"}, {"oid": "4ffc00f0947977ab00e8a47b97b70eb361876dfd", "url": "https://github.com/elastic/elasticsearch/commit/4ffc00f0947977ab00e8a47b97b70eb361876dfd", "message": "Add script and script_score queries to the disallowed ones", "committedDate": "2020-01-27T19:22:25Z", "type": "commit"}, {"oid": "55200c70cb79a9b68231da3fb744b756272ddd88", "url": "https://github.com/elastic/elasticsearch/commit/55200c70cb79a9b68231da3fb744b756272ddd88", "message": "Disallow joining queries", "committedDate": "2020-01-28T15:15:19Z", "type": "commit"}, {"oid": "16f6c8b6ab13a53d8149af53534fb4bd94ed0d01", "url": "https://github.com/elastic/elasticsearch/commit/16f6c8b6ab13a53d8149af53534fb4bd94ed0d01", "message": "Rename setting to positive semantics", "committedDate": "2020-01-28T21:42:26Z", "type": "commit"}, {"oid": "126448f189b985431a66c36da60ea5a0a5e827a6", "url": "https://github.com/elastic/elasticsearch/commit/126448f189b985431a66c36da60ea5a0a5e827a6", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-05T11:46:40Z", "type": "commit"}, {"oid": "b1ca9cb3e6dc5d4c903a2eb795c70fff664c09d7", "url": "https://github.com/elastic/elasticsearch/commit/b1ca9cb3e6dc5d4c903a2eb795c70fff664c09d7", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-05T19:57:54Z", "type": "commit"}, {"oid": "2dd5d9af57763c2a183aca1a63b95c90c519c40d", "url": "https://github.com/elastic/elasticsearch/commit/2dd5d9af57763c2a183aca1a63b95c90c519c40d", "message": "Add percolator queries to the expensive ones", "committedDate": "2020-02-05T20:26:19Z", "type": "commit"}, {"oid": "65ff23ea4e3e4fd4011af1339cb73e0172f805e4", "url": "https://github.com/elastic/elasticsearch/commit/65ff23ea4e3e4fd4011af1339cb73e0172f805e4", "message": "Add legacy geo-shape queries to the disallowed ones", "committedDate": "2020-02-05T22:49:18Z", "type": "commit"}, {"oid": "14ef948c0fb6a7edf82241fe3e6da929e84576eb", "url": "https://github.com/elastic/elasticsearch/commit/14ef948c0fb6a7edf82241fe3e6da929e84576eb", "message": "capitalize the first letter of error messages", "committedDate": "2020-02-06T13:12:36Z", "type": "commit"}, {"oid": "77a0eff17390ec5c82046754c4c00dbc3ea2b437", "url": "https://github.com/elastic/elasticsearch/commit/77a0eff17390ec5c82046754c4c00dbc3ea2b437", "message": "Add range queries on text/keyword to the expensive ones", "committedDate": "2020-02-06T13:13:07Z", "type": "commit"}, {"oid": "2b4d45a463fece5c82da90db116309cfb924bfe3", "url": "https://github.com/elastic/elasticsearch/commit/2b4d45a463fece5c82da90db116309cfb924bfe3", "message": "Add index_prefixes suggestion to the error message", "committedDate": "2020-02-06T13:20:33Z", "type": "commit"}, {"oid": "f8e24e8d74d946d3b0e1c6174eedc7d11b269f7c", "url": "https://github.com/elastic/elasticsearch/commit/f8e24e8d74d946d3b0e1c6174eedc7d11b269f7c", "message": "fix error msg", "committedDate": "2020-02-06T13:34:35Z", "type": "commit"}, {"oid": "0587709f24425d5d1115fd1c54e4f1d3fa5da3d6", "url": "https://github.com/elastic/elasticsearch/commit/0587709f24425d5d1115fd1c54e4f1d3fa5da3d6", "message": "fix assertions of error messages", "committedDate": "2020-02-06T14:03:08Z", "type": "commit"}, {"oid": "aaaf2195792a2977ba54e7c571239cb2d25ae462", "url": "https://github.com/elastic/elasticsearch/commit/aaaf2195792a2977ba54e7c571239cb2d25ae462", "message": "Enhance part of allow expensive in docs Query DSL", "committedDate": "2020-02-06T14:18:35Z", "type": "commit"}, {"oid": "b24ca0e6345266fe1332e656bb344300f216c757", "url": "https://github.com/elastic/elasticsearch/commit/b24ca0e6345266fe1332e656bb344300f216c757", "message": "fix tests", "committedDate": "2020-02-06T14:30:40Z", "type": "commit"}, {"oid": "eab1b650b64d2e9e8146fb20cc347b9e390d8e68", "url": "https://github.com/elastic/elasticsearch/commit/eab1b650b64d2e9e8146fb20cc347b9e390d8e68", "message": "improve error messages", "committedDate": "2020-02-06T15:07:43Z", "type": "commit"}, {"oid": "16a70176fa1eb1d63a50802213b8fbd1c96c31fd", "url": "https://github.com/elastic/elasticsearch/commit/16a70176fa1eb1d63a50802213b8fbd1c96c31fd", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-06T15:13:25Z", "type": "commit"}, {"oid": "51a8cdc0e6c920534e58b97b468343aa1b21ff91", "url": "https://github.com/elastic/elasticsearch/commit/51a8cdc0e6c920534e58b97b468343aa1b21ff91", "message": "fix test", "committedDate": "2020-02-06T15:31:29Z", "type": "commit"}, {"oid": "7eccee2866746a30b839d4475e2c32311bdd7772", "url": "https://github.com/elastic/elasticsearch/commit/7eccee2866746a30b839d4475e2c32311bdd7772", "message": "fix test", "committedDate": "2020-02-06T15:57:45Z", "type": "commit"}, {"oid": "907207ffabc7b5b17ef35de6e85a545dab60b5ac", "url": "https://github.com/elastic/elasticsearch/commit/907207ffabc7b5b17ef35de6e85a545dab60b5ac", "message": "fix test", "committedDate": "2020-02-06T16:03:03Z", "type": "commit"}, {"oid": "5aa1a80147e0359feffac41cf3eeac0efa388593", "url": "https://github.com/elastic/elasticsearch/commit/5aa1a80147e0359feffac41cf3eeac0efa388593", "message": "Check that allow_expensive_queries setting doesn't affect new geo-shape queries", "committedDate": "2020-02-06T16:15:19Z", "type": "commit"}, {"oid": "ff9bb5ca1547ccb02f860c08843373c75e89e8cf", "url": "https://github.com/elastic/elasticsearch/commit/ff9bb5ca1547ccb02f860c08843373c75e89e8cf", "message": "revert the legacy quad tree test to the same method", "committedDate": "2020-02-06T16:41:16Z", "type": "commit"}, {"oid": "d1c5e1c755a8696bbb601738b80cca9421161fa3", "url": "https://github.com/elastic/elasticsearch/commit/d1c5e1c755a8696bbb601738b80cca9421161fa3", "message": "remove unused import", "committedDate": "2020-02-06T18:14:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0MzYwNw==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r376543607", "bodyText": "can't we have tests call the other constructor instead and pass ()->true?", "author": "jpountz", "createdAt": "2020-02-07T18:37:35Z", "path": "server/src/main/java/org/elasticsearch/index/IndexModule.java", "diffHunk": "@@ -144,13 +145,24 @@ public IndexModule(\n             final IndexSettings indexSettings,\n             final AnalysisRegistry analysisRegistry,\n             final EngineFactory engineFactory,\n-            final Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories) {\n+            final Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories,\n+            final BooleanSupplier isAllowExpensiveQueries) {\n         this.indexSettings = indexSettings;\n         this.analysisRegistry = analysisRegistry;\n         this.engineFactory = Objects.requireNonNull(engineFactory);\n         this.searchOperationListeners.add(new SearchSlowLog(indexSettings));\n         this.indexOperationListeners.add(new IndexingSlowLog(indexSettings));\n         this.directoryFactories = Collections.unmodifiableMap(directoryFactories);\n+        this.isAllowExpensiveQueries = isAllowExpensiveQueries;\n+    }\n+\n+    // For testing\n+    IndexModule(\n+            final IndexSettings indexSettings,\n+            final AnalysisRegistry analysisRegistry,\n+            final EngineFactory engineFactory,\n+            final Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories) {\n+        this(indexSettings, analysisRegistry, engineFactory, directoryFactories, () -> true);\n     }", "originalCommit": "d1c5e1c755a8696bbb601738b80cca9421161fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwODc0OA==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r376608748", "bodyText": "Yep, that's easy to do.", "author": "matriv", "createdAt": "2020-02-07T21:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0MzYwNw=="}], "type": "inlineReview", "revised_code": {"commit": "78e3c9e813a10cd8413071435b7f66e67627b29f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/IndexModule.java b/server/src/main/java/org/elasticsearch/index/IndexModule.java\nindex ee020595dbd..e8bef9e48f4 100644\n--- a/server/src/main/java/org/elasticsearch/index/IndexModule.java\n+++ b/server/src/main/java/org/elasticsearch/index/IndexModule.java\n\n@@ -156,15 +156,6 @@ public final class IndexModule {\n         this.isAllowExpensiveQueries = isAllowExpensiveQueries;\n     }\n \n-    // For testing\n-    IndexModule(\n-            final IndexSettings indexSettings,\n-            final AnalysisRegistry analysisRegistry,\n-            final EngineFactory engineFactory,\n-            final Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories) {\n-        this(indexSettings, analysisRegistry, engineFactory, directoryFactories, () -> true);\n-    }\n-\n     /**\n      * Adds a Setting and it's consumer for this index.\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0NDEwMA==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r376544100", "bodyText": "can we avoid duplicating constructors?", "author": "jpountz", "createdAt": "2020-02-07T18:38:34Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -92,12 +93,35 @@\n \n     private final Index fullyQualifiedIndex;\n     private final Predicate<String> indexNameMatcher;\n+    private final BooleanSupplier isAllowExpensiveQueries;\n \n     private final Map<String, Query> namedQueries = new HashMap<>();\n     private boolean allowUnmappedFields;\n     private boolean mapUnmappedFieldAsString;\n     private NestedScope nestedScope;\n \n+    public QueryShardContext(int shardId,\n+                             IndexSettings indexSettings,\n+                             BigArrays bigArrays,\n+                             BitsetFilterCache bitsetFilterCache,\n+                             BiFunction<MappedFieldType, String, IndexFieldData<?>> indexFieldDataLookup,\n+                             MapperService mapperService,\n+                             SimilarityService similarityService,\n+                             ScriptService scriptService,\n+                             NamedXContentRegistry xContentRegistry,\n+                             NamedWriteableRegistry namedWriteableRegistry,\n+                             Client client,\n+                             IndexSearcher searcher,\n+                             LongSupplier nowInMillis,\n+                             String clusterAlias,\n+                             Predicate<String> indexNameMatcher,\n+                             BooleanSupplier isAllowExpensiveQueries) {\n+        this(shardId, indexSettings, bigArrays, bitsetFilterCache, indexFieldDataLookup, mapperService, similarityService,\n+                scriptService, xContentRegistry, namedWriteableRegistry, client, searcher, nowInMillis, indexNameMatcher,\n+                new Index(RemoteClusterAware.buildRemoteIndexName(clusterAlias, indexSettings.getIndex().getName()),\n+                        indexSettings.getIndex().getUUID()), isAllowExpensiveQueries);\n+    }", "originalCommit": "d1c5e1c755a8696bbb601738b80cca9421161fa3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwODk2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r376608965", "bodyText": "There are ~20 usages of this in tests, so no big deal, I can remove the constructor.", "author": "matriv", "createdAt": "2020-02-07T21:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU0NDEwMA=="}], "type": "inlineReview", "revised_code": {"commit": "78e3c9e813a10cd8413071435b7f66e67627b29f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\nindex 7f42219adb8..f886f9713d9 100644\n--- a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n+++ b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n\n@@ -122,27 +122,6 @@ public class QueryShardContext extends QueryRewriteContext {\n                         indexSettings.getIndex().getUUID()), isAllowExpensiveQueries);\n     }\n \n-    public QueryShardContext(int shardId,\n-                             IndexSettings indexSettings,\n-                             BigArrays bigArrays,\n-                             BitsetFilterCache bitsetFilterCache,\n-                             BiFunction<MappedFieldType, String, IndexFieldData<?>> indexFieldDataLookup,\n-                             MapperService mapperService,\n-                             SimilarityService similarityService,\n-                             ScriptService scriptService,\n-                             NamedXContentRegistry xContentRegistry,\n-                             NamedWriteableRegistry namedWriteableRegistry,\n-                             Client client,\n-                             IndexSearcher searcher,\n-                             LongSupplier nowInMillis,\n-                             String clusterAlias,\n-                             Predicate<String> indexNameMatcher) {\n-        this(shardId, indexSettings, bigArrays, bitsetFilterCache, indexFieldDataLookup, mapperService, similarityService,\n-            scriptService, xContentRegistry, namedWriteableRegistry, client, searcher, nowInMillis, indexNameMatcher,\n-            new Index(RemoteClusterAware.buildRemoteIndexName(clusterAlias, indexSettings.getIndex().getName()),\n-                indexSettings.getIndex().getUUID()), () -> true);\n-    }\n-\n     public QueryShardContext(QueryShardContext source) {\n         this(source.shardId, source.indexSettings, source.bigArrays, source.bitsetFilterCache, source.indexFieldDataService,\n             source.mapperService, source.similarityService, source.scriptService, source.getXContentRegistry(),\n"}}, {"oid": "78e3c9e813a10cd8413071435b7f66e67627b29f", "url": "https://github.com/elastic/elasticsearch/commit/78e3c9e813a10cd8413071435b7f66e67627b29f", "message": "Remove duplicate constructors to ease up tests", "committedDate": "2020-02-07T21:10:58Z", "type": "commit"}, {"oid": "1c645025c953aaf1cc770992e040f2354331c650", "url": "https://github.com/elastic/elasticsearch/commit/1c645025c953aaf1cc770992e040f2354331c650", "message": "fix tests", "committedDate": "2020-02-07T21:36:54Z", "type": "commit"}, {"oid": "6fdab2b9ffc0fba7a73f77bb1b01201f2380fd73", "url": "https://github.com/elastic/elasticsearch/commit/6fdab2b9ffc0fba7a73f77bb1b01201f2380fd73", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-07T21:40:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk4NDAwMA==", "url": "https://github.com/elastic/elasticsearch/pull/51385#discussion_r376984000", "bodyText": "Can this just be allowExpensiveQueries()?  Otherwise it reads very strangely.", "author": "romseygeek", "createdAt": "2020-02-10T10:39:25Z", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -192,6 +197,10 @@ public BitSetProducer bitsetFilter(Query filter) {\n         return bitsetFilterCache.getBitSetProducer(filter);\n     }\n \n+    public boolean isAllowExpensiveQueries() {\n+        return isAllowExpensiveQueries.getAsBoolean();", "originalCommit": "6fdab2b9ffc0fba7a73f77bb1b01201f2380fd73", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "623846b5a8b4be0800be0105caf7fac92d7c2186", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\nindex 4eb545664d1..611a6fbe6d5 100644\n--- a/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n+++ b/server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java\n\n@@ -197,8 +197,8 @@ public class QueryShardContext extends QueryRewriteContext {\n         return bitsetFilterCache.getBitSetProducer(filter);\n     }\n \n-    public boolean isAllowExpensiveQueries() {\n-        return isAllowExpensiveQueries.getAsBoolean();\n+    public boolean allowExpensiveQueries() {\n+        return allowExpensiveQueries.getAsBoolean();\n     }\n \n     @SuppressWarnings(\"unchecked\")\n"}}, {"oid": "623846b5a8b4be0800be0105caf7fac92d7c2186", "url": "https://github.com/elastic/elasticsearch/commit/623846b5a8b4be0800be0105caf7fac92d7c2186", "message": "Address comments", "committedDate": "2020-02-10T11:33:07Z", "type": "commit"}, {"oid": "97d2ce4c149b322e705d95851795fdb3a8ed276e", "url": "https://github.com/elastic/elasticsearch/commit/97d2ce4c149b322e705d95851795fdb3a8ed276e", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-10T11:40:53Z", "type": "commit"}, {"oid": "1759a844ae27515599730ef6f910ee5b3f8f36d4", "url": "https://github.com/elastic/elasticsearch/commit/1759a844ae27515599730ef6f910ee5b3f8f36d4", "message": "fix docs", "committedDate": "2020-02-12T16:01:47Z", "type": "commit"}, {"oid": "4774178122ea936043b58e11d295b017ec100a3d", "url": "https://github.com/elastic/elasticsearch/commit/4774178122ea936043b58e11d295b017ec100a3d", "message": "Merge remote-tracking branch 'upstream/master' into impl-29050", "committedDate": "2020-02-12T16:02:07Z", "type": "commit"}]}