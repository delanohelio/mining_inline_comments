{"pr_number": 52405, "pr_title": "Move the terms index of `_id` off-heap.", "pr_createdAt": "2020-02-17T10:33:42Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52405", "timeline": [{"oid": "5ddb043ddac765d5907fc1711f1fbddea8ac64e4", "url": "https://github.com/elastic/elasticsearch/commit/5ddb043ddac765d5907fc1711f1fbddea8ac64e4", "message": "Move the terms index of `_id` off-heap.\n\nIn #42838 we moved the terms index of all fields off-heap except the\n`_id` field because we were worried it might make indexing slower. In\ngeneral, the indexing rate is only affected if explicit IDs are used, as\notherwise Elasticsearch almost never performs lookups in the terms\ndictionary for the purpose of indexing. So it's quite wasteful to\nrequire the terms index of `_id` to be loaded on-heap for users who have\nappend-only workloads. Furthermore I've been conducting benchmarks when\nindexing with explicit ids on the http_logs dataset that suggest that\nthe slowdown is low enough that it's probably not worth forcing the terms\nindex to be kept on-heap. Here are some numbers for the median indexing\nrate in docs/s:\n\n| Run | Master  | Patch   |\n| --- | ------- | ------- |\n| 1   | 45851.2 | 46401.4 |\n| 2   | 45192.6 | 44561.0 |\n| 3   | 45635.2 | 44137.0 |\n| 4   | 46435.0 | 44692.8 |\n| 5   | 45829.0 | 44949.0 |\n\nAnd now heap usage in MB for segments:\n\n| Run | Master  | Patch    |\n| --- | ------- | -------- |\n| 1   | 41.1720 | 0.352083 |\n| 2   | 45.1545 | 0.382534 |\n| 3   | 41.7746 | 0.381285 |\n| 4   | 45.3673 | 0.412737 |\n| 5   | 45.4616 | 0.375063 |\n\nIndexing rate decreased by 1.8% on average, while memory usage decreased\nby more than 100x.\n\nThe `http_logs` dataset contains small documents and has a simple\nindexing chain. More complex indexing chains, e.g. with more fields,\ningest pipelines, etc. would see an even lower decrease of indexing rate.", "committedDate": "2020-02-17T10:15:24Z", "type": "commit"}, {"oid": "10c42d3e5c069c34537a425fe8848fdcf5d5ddd8", "url": "https://github.com/elastic/elasticsearch/commit/10c42d3e5c069c34537a425fe8848fdcf5d5ddd8", "message": "Register the setting.", "committedDate": "2020-02-17T18:25:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQzNTk0NA==", "url": "https://github.com/elastic/elasticsearch/pull/52405#discussion_r380435944", "bodyText": "nit: dictinary -> dictionary", "author": "dnhatn", "createdAt": "2020-02-18T03:12:33Z", "path": "server/src/main/java/org/elasticsearch/index/IndexSettings.java", "diffHunk": "@@ -84,6 +84,9 @@\n                         \"[true, false, checksum] but was: \" + s);\n             }\n         }, Property.IndexScope);\n+    // This setting is undocumented as it is considered as an escape hatch.\n+    public static final Setting<Boolean> ON_HEAP_ID_TERMS_INDEX =\n+            Setting.boolSetting(\"index.force_memory_id_terms_dictinary\", false, Property.IndexScope);", "originalCommit": "10c42d3e5c069c34537a425fe8848fdcf5d5ddd8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM1NjI2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52405#discussion_r381356266", "bodyText": "Thanks for catching this, you were not nit-picking!", "author": "jpountz", "createdAt": "2020-02-19T15:12:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQzNTk0NA=="}], "type": "inlineReview", "revised_code": {"commit": "9da21a406878d08c93a1936172edb2f51869c8d0", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/IndexSettings.java b/server/src/main/java/org/elasticsearch/index/IndexSettings.java\nindex 48d22fb9c19..83cbd0a2edd 100644\n--- a/server/src/main/java/org/elasticsearch/index/IndexSettings.java\n+++ b/server/src/main/java/org/elasticsearch/index/IndexSettings.java\n\n@@ -86,7 +86,7 @@ public final class IndexSettings {\n         }, Property.IndexScope);\n     // This setting is undocumented as it is considered as an escape hatch.\n     public static final Setting<Boolean> ON_HEAP_ID_TERMS_INDEX =\n-            Setting.boolSetting(\"index.force_memory_id_terms_dictinary\", false, Property.IndexScope);\n+            Setting.boolSetting(\"index.force_memory_id_terms_dictionary\", false, Property.IndexScope);\n \n     /**\n      * Index setting describing the maximum value of from + size on a query.\n"}}, {"oid": "9da21a406878d08c93a1936172edb2f51869c8d0", "url": "https://github.com/elastic/elasticsearch/commit/9da21a406878d08c93a1936172edb2f51869c8d0", "message": "typo", "committedDate": "2020-02-19T07:40:27Z", "type": "commit"}, {"oid": "8ab9764c460ef0437ec63e054ef438da40a8b486", "url": "https://github.com/elastic/elasticsearch/commit/8ab9764c460ef0437ec63e054ef438da40a8b486", "message": "Merge branch 'master' into enhancement/offheap_terms_dict", "committedDate": "2020-02-19T09:40:09Z", "type": "commit"}]}