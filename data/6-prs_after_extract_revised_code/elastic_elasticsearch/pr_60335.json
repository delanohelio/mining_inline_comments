{"pr_number": 60335, "pr_title": "[ML] always write prediction_[score|probability] for classification inference", "pr_createdAt": "2020-07-28T19:35:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60335", "timeline": [{"oid": "cb68a378a13bebaf13d43ccdf9f12230853efffb", "url": "https://github.com/elastic/elasticsearch/commit/cb68a378a13bebaf13d43ccdf9f12230853efffb", "message": "[ML] always write prediction_[score|probability] for classification inference\n\nIn order to unify model inference and analytics results we\nneed to write the same fields.\n\nprediction_probability and prediction_score are now written\nfor inference calls against classification models.", "committedDate": "2020-07-28T19:33:24Z", "type": "commit"}, {"oid": "d5b15e23969b34a1a1c39e0522576ab5eac2d64e", "url": "https://github.com/elastic/elasticsearch/commit/d5b15e23969b34a1a1c39e0522576ab5eac2d64e", "message": "Merge branch 'master' into feature/ml-inference-add-probability-score-classification", "committedDate": "2020-07-28T19:59:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MjIwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60335#discussion_r461842209", "bodyText": "V_7_10_0 surely?", "author": "davidkyle", "createdAt": "2020-07-28T20:01:01Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationInferenceResults.java", "diffHunk": "@@ -74,6 +75,11 @@ public ClassificationInferenceResults(StreamInput in) throws IOException {\n         } else {\n             this.predictionFieldType = PredictionFieldType.STRING;\n         }\n+        if (in.getVersion().onOrAfter(Version.V_7_9_0)) {", "originalCommit": "d5b15e23969b34a1a1c39e0522576ab5eac2d64e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1MTUxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60335#discussion_r461851519", "bodyText": "potentially, I am not sure if we want to backport it to 7.9 as java side inference was introduced in 7.9", "author": "benwtrent", "createdAt": "2020-07-28T20:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MjIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1Njc1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/60335#discussion_r461856752", "bodyText": "@droberts195 what do you think?", "author": "benwtrent", "createdAt": "2020-07-28T20:25:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MjIwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5NDcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60335#discussion_r461894719", "bodyText": "If it means the data in the destination index would have inconsistent fields without this fix in 7.9 when the fields were consistent in 7.8 then this is fixing a regression and should go into 7.9.", "author": "droberts195", "createdAt": "2020-07-28T21:37:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MjIwOQ=="}], "type": "inlineReview", "revised_code": {"commit": "d0a94b9157be4785402e6fc5fab1c51869add5ca", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationInferenceResults.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationInferenceResults.java\nindex 6f4864209fc..9688fa0a3a1 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationInferenceResults.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationInferenceResults.java\n\n@@ -76,9 +85,11 @@ public class ClassificationInferenceResults extends SingleValueInferenceResults\n             this.predictionFieldType = PredictionFieldType.STRING;\n         }\n         if (in.getVersion().onOrAfter(Version.V_7_9_0)) {\n-            this.numClasses = in.readVInt();\n+            this.predictionProbability = in.readOptionalDouble();\n+            this.predictionScore = in.readOptionalDouble();\n         } else {\n-            this.numClasses = this.topClasses.size();\n+            this.predictionProbability = topClasses.size() > 0 ? topClasses.get(0).getProbability() : null;\n+            this.predictionScore = topClasses.size() > 0 ? topClasses.get(0).getScore() : null;\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0NjU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/60335#discussion_r461846567", "bodyText": "Should LangIdentNeuralNetwork have the same logic?", "author": "davidkyle", "createdAt": "2020-07-28T20:09:36Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java", "diffHunk": "@@ -178,7 +178,7 @@ private InferenceResults buildResult(double[] value,\n                     classificationProbability(value),\n                     classificationLabels,\n                     null,\n-                    classificationConfig.getNumTopClasses(),\n+                    classificationConfig.getNumTopClasses() == 0 ? 1 : classificationConfig.getNumTopClasses(),", "originalCommit": "d5b15e23969b34a1a1c39e0522576ab5eac2d64e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d0a94b9157be4785402e6fc5fab1c51869add5ca", "chunk": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java\nindex 4d6e5b105b0..52c2e838ae8 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/inference/TreeInferenceModel.java\n\n@@ -174,17 +174,20 @@ public class TreeInferenceModel implements InferenceModel {\n         switch (targetType) {\n             case CLASSIFICATION:\n                 ClassificationConfig classificationConfig = (ClassificationConfig) config;\n-                Tuple<Integer, List<TopClassEntry>> topClasses = InferenceHelpers.topClasses(\n+                Tuple<InferenceHelpers.TopClassificationValue, List<TopClassEntry>> topClasses = InferenceHelpers.topClasses(\n                     classificationProbability(value),\n                     classificationLabels,\n                     null,\n-                    classificationConfig.getNumTopClasses() == 0 ? 1 : classificationConfig.getNumTopClasses(),\n+                    classificationConfig.getNumTopClasses(),\n                     classificationConfig.getPredictionFieldType());\n-                return new ClassificationInferenceResults(topClasses.v1(),\n-                    classificationLabel(topClasses.v1(), classificationLabels),\n+                final InferenceHelpers.TopClassificationValue classificationValue = topClasses.v1();\n+                return new ClassificationInferenceResults(classificationValue.getValue(),\n+                    classificationLabel(classificationValue.getValue(), classificationLabels),\n                     topClasses.v2(),\n                     InferenceHelpers.transformFeatureImportance(decodedFeatureImportance, classificationLabels),\n-                    config);\n+                    config,\n+                    classificationValue.getProbability(),\n+                    classificationValue.getScore());\n             case REGRESSION:\n                 return new RegressionInferenceResults(value[0],\n                     config,\n"}}, {"oid": "1271fab417d76c12d115036f4e86176ca2f7c489", "url": "https://github.com/elastic/elasticsearch/commit/1271fab417d76c12d115036f4e86176ca2f7c489", "message": "fixing langident", "committedDate": "2020-07-28T20:24:52Z", "type": "commit"}, {"oid": "621acb6823ed6b1148ad669a8131806c0938b333", "url": "https://github.com/elastic/elasticsearch/commit/621acb6823ed6b1148ad669a8131806c0938b333", "message": "Merge branch 'feature/ml-inference-add-probability-score-classification' of github.com:benwtrent/elasticsearch into feature/ml-inference-add-probability-score-classification", "committedDate": "2020-07-28T20:34:42Z", "type": "commit"}, {"oid": "b6a9f8e3f9669c13ff0c65b7be9771a194878a3d", "url": "https://github.com/elastic/elasticsearch/commit/b6a9f8e3f9669c13ff0c65b7be9771a194878a3d", "message": "fixing serialization code", "committedDate": "2020-07-29T11:28:41Z", "type": "commit"}, {"oid": "d0a94b9157be4785402e6fc5fab1c51869add5ca", "url": "https://github.com/elastic/elasticsearch/commit/d0a94b9157be4785402e6fc5fab1c51869add5ca", "message": "fixing serialization and object build", "committedDate": "2020-07-29T13:17:43Z", "type": "commit"}]}