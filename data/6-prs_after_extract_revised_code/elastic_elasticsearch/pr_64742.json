{"pr_number": 64742, "pr_title": "Do not wrap can_match searchers", "pr_createdAt": "2020-11-06T20:57:51Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64742", "timeline": [{"oid": "049b04221e3c70cecdfaa612809b8c40b325662f", "url": "https://github.com/elastic/elasticsearch/commit/049b04221e3c70cecdfaa612809b8c40b325662f", "message": "Do not wrap can_match searcher", "committedDate": "2020-11-06T20:48:36Z", "type": "commit"}, {"oid": "e6fed8491f74d26ce35f9ef33cfc50eeef397e85", "url": "https://github.com/elastic/elasticsearch/commit/e6fed8491f74d26ce35f9ef33cfc50eeef397e85", "message": "stylecheck", "committedDate": "2020-11-07T03:20:47Z", "type": "commit"}, {"oid": "7b14cdf4f9cc3bc7bdadeeff5a4e9e01365b9688", "url": "https://github.com/elastic/elasticsearch/commit/7b14cdf4f9cc3bc7bdadeeff5a4e9e01365b9688", "message": "simplify", "committedDate": "2020-11-07T03:47:41Z", "type": "commit"}, {"oid": "2e3130b602c0e663c9e2a185cf5155d0739b512b", "url": "https://github.com/elastic/elasticsearch/commit/2e3130b602c0e663c9e2a185cf5155d0739b512b", "message": "fix tests", "committedDate": "2020-11-07T17:16:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIwNjA5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64742#discussion_r519206093", "bodyText": "AFAICS, this does not provoke a failure without the fix, can we somehow make it call getCoreCacheHelper? Or maybe just make the wrapper throw to proof that it is not used for the can match phase?", "author": "henningandersen", "createdAt": "2020-11-07T18:47:02Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java", "diffHunk": "@@ -241,6 +273,24 @@ public void testFreezePattern() throws ExecutionException, InterruptedException\n     }\n \n     public void testCanMatch() throws ExecutionException, InterruptedException, IOException {\n+        if (randomBoolean()) {\n+            readerWrapper.set(reader -> new FilterDirectoryReader(reader, new FilterDirectoryReader.SubReaderWrapper() {", "originalCommit": "2e3130b602c0e663c9e2a185cf5155d0739b512b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIzOTIyMg==", "url": "https://github.com/elastic/elasticsearch/pull/64742#discussion_r519239222", "bodyText": "Ok, I pushed 9581a0c", "author": "dnhatn", "createdAt": "2020-11-08T00:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIwNjA5Mw=="}], "type": "inlineReview", "revised_code": {"commit": "9581a0cd43f5c7f623c3673dd9c10a749c5911cb", "chunk": "diff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java\nindex 2da911ed429..1318c807094 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java\n\n@@ -274,21 +275,8 @@ public class FrozenIndexTests extends ESSingleNodeTestCase {\n \n     public void testCanMatch() throws ExecutionException, InterruptedException, IOException {\n         if (randomBoolean()) {\n-            readerWrapper.set(reader -> new FilterDirectoryReader(reader, new FilterDirectoryReader.SubReaderWrapper() {\n-                @Override\n-                public LeafReader wrap(LeafReader reader) {\n-                    return reader;\n-                }\n-            }) {\n-                @Override\n-                protected DirectoryReader doWrapDirectoryReader(DirectoryReader in) throws IOException {\n-                    return in;\n-                }\n-\n-                @Override\n-                public CacheHelper getReaderCacheHelper() {\n-                    return in.getReaderCacheHelper();\n-                }\n+            readerWrapper.set(reader -> {\n+                throw new AssertionError(\"can_match must not wrap the reader\");\n             });\n         }\n         createIndex(\"index\");\n"}}, {"oid": "9581a0cd43f5c7f623c3673dd9c10a749c5911cb", "url": "https://github.com/elastic/elasticsearch/commit/9581a0cd43f5c7f623c3673dd9c10a749c5911cb", "message": "stricter", "committedDate": "2020-11-07T21:12:18Z", "type": "commit"}, {"oid": "d072b2fc5ad1005a4c23cd9e32b4b9a6ba171944", "url": "https://github.com/elastic/elasticsearch/commit/d072b2fc5ad1005a4c23cd9e32b4b9a6ba171944", "message": "imports", "committedDate": "2020-11-07T22:50:37Z", "type": "commit"}]}