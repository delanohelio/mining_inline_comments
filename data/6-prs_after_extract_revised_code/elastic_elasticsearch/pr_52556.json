{"pr_number": 52556, "pr_title": "Separate translog from index deletion conditions", "pr_createdAt": "2020-02-20T09:02:53Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52556", "timeline": [{"oid": "b9227e23c4acf2af097c8e1928ee75c825777634", "url": "https://github.com/elastic/elasticsearch/commit/b9227e23c4acf2af097c8e1928ee75c825777634", "message": "Separate translog deletion policy conditions", "committedDate": "2020-02-20T08:53:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3MjQ5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/52556#discussion_r381872491", "bodyText": "NIT: Maybe dry this up with the lines below via something like:\n    private long getMinReferencedGen() {\n        long minReferencedGen = Math.min(\n            deletionPolicy.getMinTranslogGenRequiredByLocks(),\n            minGenerationForSeqNo(deletionPolicy.getLocalCheckpointOfSafeCommit() + 1, current, readers));\n        assert minReferencedGen >= getMinFileGeneration() :\n            \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] but the lowest gen available is [\"\n                + getMinFileGeneration() + \"]\";\n        assert minReferencedGen <= currentFileGeneration() :\n            \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] which is higher than the current generation [\"\n                + currentFileGeneration() + \"]\";\n        return minReferencedGen;\n    }", "author": "original-brownbear", "createdAt": "2020-02-20T09:18:42Z", "path": "server/src/main/java/org/elasticsearch/index/translog/Translog.java", "diffHunk": "@@ -1646,7 +1646,24 @@ public void rollGeneration() throws IOException {\n      * required generation\n      */\n     public void trimUnreferencedReaders() throws IOException {\n-        // move most of the data to disk to reduce the time the lock is held\n+        // first check under read lock if any readers can be trimmed\n+        try (ReleasableLock ignored = readLock.acquire()) {\n+            ensureOpen();\n+            long minReferencedGen = Math.min(", "originalCommit": "b9227e23c4acf2af097c8e1928ee75c825777634", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "98bdba27bfa6502c3abc28c484f833028cfd67c2", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/translog/Translog.java b/server/src/main/java/org/elasticsearch/index/translog/Translog.java\nindex 369eb661607..f0e2b04673a 100644\n--- a/server/src/main/java/org/elasticsearch/index/translog/Translog.java\n+++ b/server/src/main/java/org/elasticsearch/index/translog/Translog.java\n\n@@ -1648,17 +1648,11 @@ public class Translog extends AbstractIndexShardComponent implements IndexShardC\n     public void trimUnreferencedReaders() throws IOException {\n         // first check under read lock if any readers can be trimmed\n         try (ReleasableLock ignored = readLock.acquire()) {\n-            ensureOpen();\n-            long minReferencedGen = Math.min(\n-                deletionPolicy.getMinTranslogGenRequiredByLocks(),\n-                minGenerationForSeqNo(deletionPolicy.getLocalCheckpointOfSafeCommit() + 1, current, readers));\n-            assert minReferencedGen >= getMinFileGeneration() :\n-                \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] but the lowest gen available is [\"\n-                    + getMinFileGeneration() + \"]\";\n-            assert minReferencedGen <= currentFileGeneration() :\n-                \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] which is higher than the current generation [\"\n-                    + currentFileGeneration() + \"]\";\n-            if (minReferencedGen == getMinFileGeneration()) {\n+            if (closed.get()) {\n+                // we're shutdown potentially on some tragic event, don't delete anything\n+                return;\n+            }\n+            if (getMinReferencedGen() == getMinFileGeneration()) {\n                 return;\n             }\n         }\n"}}, {"oid": "98bdba27bfa6502c3abc28c484f833028cfd67c2", "url": "https://github.com/elastic/elasticsearch/commit/98bdba27bfa6502c3abc28c484f833028cfd67c2", "message": "review comments", "committedDate": "2020-02-20T10:07:25Z", "type": "commit"}]}