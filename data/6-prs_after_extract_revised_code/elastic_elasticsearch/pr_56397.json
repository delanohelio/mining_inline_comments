{"pr_number": 56397, "pr_title": "Don't allow invalid template combinations", "pr_createdAt": "2020-05-07T22:14:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56397", "timeline": [{"oid": "220efe95749f09e768fe854d4e5fd69c27f95890", "url": "https://github.com/elastic/elasticsearch/commit/220efe95749f09e768fe854d4e5fd69c27f95890", "message": "Don't allow invalid template combinations\n\nThis commit removes the ability to put V2 index templates that refence missing component templates.\nIt also prevents removing component templates that are being referenced by an existing V2 index\ntemplate.\n\nRelates to #53101\nResolves #56314", "committedDate": "2020-05-07T22:11:50Z", "type": "commit"}, {"oid": "08153db27170b8da4b8901590908a6cbb4701ebc", "url": "https://github.com/elastic/elasticsearch/commit/08153db27170b8da4b8901590908a6cbb4701ebc", "message": "Merge branch 'master' into itv2-dont-break-things", "committedDate": "2020-05-08T16:28:37Z", "type": "commit"}, {"oid": "88cc81aecea36a775f3c7fd403cd003012c655b0", "url": "https://github.com/elastic/elasticsearch/commit/88cc81aecea36a775f3c7fd403cd003012c655b0", "message": "Fix docs", "committedDate": "2020-05-08T17:37:45Z", "type": "commit"}, {"oid": "b223d68cc9c3a193ac1c979d74d0df47570812db", "url": "https://github.com/elastic/elasticsearch/commit/b223d68cc9c3a193ac1c979d74d0df47570812db", "message": "Merge branch 'master' into itv2-dont-break-things", "committedDate": "2020-05-08T18:01:35Z", "type": "commit"}, {"oid": "562d085d7230772fa932ff7d7048b916755f1f79", "url": "https://github.com/elastic/elasticsearch/commit/562d085d7230772fa932ff7d7048b916755f1f79", "message": "Log error stacktrace during test failure", "committedDate": "2020-05-08T20:13:32Z", "type": "commit"}, {"oid": "6b3fdceb62dced8df39dd1e1852000627a14517f", "url": "https://github.com/elastic/elasticsearch/commit/6b3fdceb62dced8df39dd1e1852000627a14517f", "message": "Fix test", "committedDate": "2020-05-08T20:41:58Z", "type": "commit"}, {"oid": "f38f675a1b6d56b011fa292456dda48967f1e2a7", "url": "https://github.com/elastic/elasticsearch/commit/f38f675a1b6d56b011fa292456dda48967f1e2a7", "message": "Merge branch 'master' into itv2-dont-break-things", "committedDate": "2020-05-11T21:46:41Z", "type": "commit"}, {"oid": "2a07b9fd998fd07e1c736d607d2007e096c18693", "url": "https://github.com/elastic/elasticsearch/commit/2a07b9fd998fd07e1c736d607d2007e096c18693", "message": "Merge branch 'master' into itv2-dont-break-things", "committedDate": "2020-05-13T21:43:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM0MjcxMA==", "url": "https://github.com/elastic/elasticsearch/pull/56397#discussion_r425342710", "bodyText": "what do you think about renaming templateWildcard to nameOrWilldcard (or templateNameOrWildcard)", "author": "andreidan", "createdAt": "2020-05-14T18:21:49Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -291,6 +293,33 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n             });\n     }\n \n+    /**\n+     * Validates that the given component template is not used by any index\n+     * templates, throwing an error if it is still in use\n+     */\n+    static void validateNotInUse(Metadata metadata, String templateWildcard) {", "originalCommit": "2a07b9fd998fd07e1c736d607d2007e096c18693", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "961735db4df8ca7b80cdc4859a9eb6c454fa0a88", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\nindex 62e34b8f5ac..a404fc38633 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n\n@@ -297,9 +297,9 @@ public class MetadataIndexTemplateService {\n      * Validates that the given component template is not used by any index\n      * templates, throwing an error if it is still in use\n      */\n-    static void validateNotInUse(Metadata metadata, String templateWildcard) {\n+    static void validateNotInUse(Metadata metadata, String templateNameOrWildcard) {\n         final Set<String> matchingComponentTemplates = metadata.componentTemplates().keySet().stream()\n-            .filter(name -> Regex.simpleMatch(templateWildcard, name))\n+            .filter(name -> Regex.simpleMatch(templateNameOrWildcard, name))\n             .collect(Collectors.toSet());\n         final Set<String> componentsBeingUsed = new HashSet<>();\n         final List<String> templatesStillUsing = metadata.templatesV2().entrySet().stream()\n"}}, {"oid": "284715a5607a0dc9d60de0b1ef991690b2f036d6", "url": "https://github.com/elastic/elasticsearch/commit/284715a5607a0dc9d60de0b1ef991690b2f036d6", "message": "Merge remote-tracking branch 'origin/master' into itv2-dont-break-things", "committedDate": "2020-05-14T20:47:20Z", "type": "commit"}, {"oid": "961735db4df8ca7b80cdc4859a9eb6c454fa0a88", "url": "https://github.com/elastic/elasticsearch/commit/961735db4df8ca7b80cdc4859a9eb6c454fa0a88", "message": "Rename parameter templateWildcard -> templateNameOrWildcard", "committedDate": "2020-05-14T20:47:24Z", "type": "commit"}]}