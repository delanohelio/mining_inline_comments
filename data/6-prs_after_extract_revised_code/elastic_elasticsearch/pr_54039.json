{"pr_number": 54039, "pr_title": "Add REST APIs for IndexTemplateV2Metadata CRUD", "pr_createdAt": "2020-03-23T23:13:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54039", "timeline": [{"oid": "14393646efcdf6f4262fb08c8b31995694eb63a5", "url": "https://github.com/elastic/elasticsearch/commit/14393646efcdf6f4262fb08c8b31995694eb63a5", "message": "Add REST APIs for IndexTemplateV2Metadata CRUD\n\nThis commit adds the get/put/delete APIs for interacting with the now v2 versions of index\ntemplates.\n\nThese APIs are behind the existing `es.itv2_feature_flag_registered` system property feature flag.\n\nRelates to #53101", "committedDate": "2020-03-23T23:09:59Z", "type": "commit"}, {"oid": "5487f93fbdf1bd0d3518e40bb068c5e275c98e53", "url": "https://github.com/elastic/elasticsearch/commit/5487f93fbdf1bd0d3518e40bb068c5e275c98e53", "message": "Add exceptions for HLRC tests", "committedDate": "2020-03-24T14:08:45Z", "type": "commit"}, {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23", "url": "https://github.com/elastic/elasticsearch/commit/2449ae96b4f2bbceaf794e68802313fc50648c23", "message": "Merge branch 'master' into itv2-add-itv2-rest-apis", "committedDate": "2020-03-24T14:09:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2NTMyNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397965325", "bodyText": "maybe all the action names should contain index_template instead of template_v2? In this it would be indices:admin/index_template/delete. When v1 has been removed the v2 name is going to be confusing and changing that isn't fun from a bwc point of view.", "author": "martijnvg", "createdAt": "2020-03-25T15:52:12Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.indices.template.delete;\n+\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import java.io.IOException;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+public class DeleteIndexTemplateV2Action extends ActionType<AcknowledgedResponse> {\n+\n+    public static final DeleteIndexTemplateV2Action INSTANCE = new DeleteIndexTemplateV2Action();\n+    public static final String NAME = \"indices:admin/template_v2/delete\";", "originalCommit": "2449ae96b4f2bbceaf794e68802313fc50648c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAzOTgyNg==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398039826", "bodyText": "true, I originally went with template_<something> so people could do template*, but it looks like people use template/* anyway, so it wouldn't work. I'll change these to index_template", "author": "dakrone", "createdAt": "2020-03-25T17:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2NTMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "90ac607dc9a09947534fc08da758ec20536664f9", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java b/server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java\nindex ec2d2dc302c..0bad0255c2a 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java\n\n@@ -33,7 +33,7 @@ import static org.elasticsearch.action.ValidateActions.addValidationError;\n public class DeleteIndexTemplateV2Action extends ActionType<AcknowledgedResponse> {\n \n     public static final DeleteIndexTemplateV2Action INSTANCE = new DeleteIndexTemplateV2Action();\n-    public static final String NAME = \"indices:admin/template_v2/delete\";\n+    public static final String NAME = \"indices:admin/index_template/delete\";\n \n     private DeleteIndexTemplateV2Action() {\n         super(NAME, AcknowledgedResponse::new);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2Nzk1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397967952", "bodyText": "Are tests for this method going to be added later or should the tests be part of this PR?", "author": "martijnvg", "createdAt": "2020-03-25T15:55:26Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -234,6 +234,103 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n             });\n     }\n \n+    /**\n+     * Add the given component template to the cluster state. If {@code create} is true, an\n+     * exception will be thrown if the component template already exists\n+     */\n+    public void putIndexTemplateV2(final String cause, final boolean create, final String name, final TimeValue masterTimeout,\n+                                   final IndexTemplateV2 template, final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-index-template-v2 [\" + name + \"], cause [\" + cause + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    return addIndexTemplateV2(currentState, create, name, template);\n+                }\n+\n+                @Override\n+                public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {\n+                    listener.onResponse(new AcknowledgedResponse(true));\n+                }\n+            });\n+    }\n+\n+    // Package visible for testing\n+    static ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean create,", "originalCommit": "2449ae96b4f2bbceaf794e68802313fc50648c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA0MTMzMw==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398041333", "bodyText": "Planning on adding these later when template validation is added (since that will directly change and test these methods)", "author": "dakrone", "createdAt": "2020-03-25T17:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2Nzk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODA4MTgzOA==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398081838", "bodyText": "Would it make sense to do it like in component templates? Basic tests in initial PR and extending tests when validation is added?", "author": "probakowski", "createdAt": "2020-03-25T18:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2Nzk1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE2OTM3NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398169375", "bodyText": "Yes, will do that.", "author": "dakrone", "createdAt": "2020-03-25T21:06:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2Nzk1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "62370f922c90a58e0119ffc0e6ed780f918db542", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\nindex dd017426590..a0d3acd0a1b 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n\n@@ -302,26 +302,7 @@ public class MetaDataIndexTemplateService {\n \n                 @Override\n                 public ClusterState execute(ClusterState currentState) {\n-                    Set<String> templateNames = new HashSet<>();\n-                    for (String templateName : currentState.metaData().templatesV2().keySet()) {\n-                        if (Regex.simpleMatch(name, templateName)) {\n-                            templateNames.add(templateName);\n-                        }\n-                    }\n-                    if (templateNames.isEmpty()) {\n-                        // if its a match all pattern, and no templates are found (we have none), don't\n-                        // fail with index missing...\n-                        if (Regex.isMatchAllPattern(name)) {\n-                            return currentState;\n-                        }\n-                        throw new IndexTemplateMissingException(name);\n-                    }\n-                    MetaData.Builder metaData = MetaData.builder(currentState.metaData());\n-                    for (String templateName : templateNames) {\n-                        logger.info(\"removing index template [{}]\", templateName);\n-                        metaData.removeIndexTemplate(templateName);\n-                    }\n-                    return ClusterState.builder(currentState).metaData(metaData).build();\n+                    return innerRemoveIndexTemplateV2(currentState, name);\n                 }\n \n                 @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2ODI5NA==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397968294", "bodyText": "Maybe move the logic of this method also to a static method, so that it can be unit tested?", "author": "martijnvg", "createdAt": "2020-03-25T15:55:53Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -234,6 +234,103 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n             });\n     }\n \n+    /**\n+     * Add the given component template to the cluster state. If {@code create} is true, an\n+     * exception will be thrown if the component template already exists\n+     */\n+    public void putIndexTemplateV2(final String cause, final boolean create, final String name, final TimeValue masterTimeout,\n+                                   final IndexTemplateV2 template, final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-index-template-v2 [\" + name + \"], cause [\" + cause + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    return addIndexTemplateV2(currentState, create, name, template);\n+                }\n+\n+                @Override\n+                public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {\n+                    listener.onResponse(new AcknowledgedResponse(true));\n+                }\n+            });\n+    }\n+\n+    // Package visible for testing\n+    static ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean create,\n+                                           final String name, final IndexTemplateV2 template) {\n+        if (create && currentState.metaData().templatesV2().containsKey(name)) {\n+            throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n+        }\n+\n+        // TODO: validation of index template\n+        // validateAndAddTemplate(request, templateBuilder, indicesService, xContentRegistry);\n+\n+        logger.info(\"adding index template [{}]\", name);\n+        return ClusterState.builder(currentState)\n+            .metaData(MetaData.builder(currentState.metaData()).put(name, template))\n+            .build();\n+    }\n+\n+    /**\n+     * Remove the given index template from the cluster state. The index template name\n+     * supports simple regex wildcards for removing multiple index templates at a time.\n+     */\n+    public void removeIndexTemplateV2(final String name, final TimeValue masterTimeout,\n+                                      final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"remove-index-template-v2 [\" + name + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    Set<String> templateNames = new HashSet<>();", "originalCommit": "2449ae96b4f2bbceaf794e68802313fc50648c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODIyMjI3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398222274", "bodyText": "Sure, added this.", "author": "dakrone", "createdAt": "2020-03-25T23:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2ODI5NA=="}], "type": "inlineReview", "revised_code": {"commit": "62370f922c90a58e0119ffc0e6ed780f918db542", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\nindex dd017426590..a0d3acd0a1b 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java\n\n@@ -302,26 +302,7 @@ public class MetaDataIndexTemplateService {\n \n                 @Override\n                 public ClusterState execute(ClusterState currentState) {\n-                    Set<String> templateNames = new HashSet<>();\n-                    for (String templateName : currentState.metaData().templatesV2().keySet()) {\n-                        if (Regex.simpleMatch(name, templateName)) {\n-                            templateNames.add(templateName);\n-                        }\n-                    }\n-                    if (templateNames.isEmpty()) {\n-                        // if its a match all pattern, and no templates are found (we have none), don't\n-                        // fail with index missing...\n-                        if (Regex.isMatchAllPattern(name)) {\n-                            return currentState;\n-                        }\n-                        throw new IndexTemplateMissingException(name);\n-                    }\n-                    MetaData.Builder metaData = MetaData.builder(currentState.metaData());\n-                    for (String templateName : templateNames) {\n-                        logger.info(\"removing index template [{}]\", templateName);\n-                        metaData.removeIndexTemplate(templateName);\n-                    }\n-                    return ClusterState.builder(currentState).metaData(metaData).build();\n+                    return innerRemoveIndexTemplateV2(currentState, name);\n                 }\n \n                 @Override\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2OTAyMw==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397969023", "bodyText": "Maybe also add unit tests for the request classes?", "author": "martijnvg", "createdAt": "2020-03-25T15:56:41Z", "path": "server/src/test/java/org/elasticsearch/action/admin/indices/template/get/GetIndexTemplateV2ResponseTests.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.indices.template.get;\n+\n+import org.elasticsearch.cluster.metadata.IndexTemplateV2;\n+import org.elasticsearch.cluster.metadata.IndexTemplateV2Tests;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.test.AbstractWireSerializingTestCase;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class GetIndexTemplateV2ResponseTests extends AbstractWireSerializingTestCase<GetIndexTemplateV2Action.Response> {", "originalCommit": "2449ae96b4f2bbceaf794e68802313fc50648c23", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3MjI5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398172292", "bodyText": "So I'm not sure what they would test? They don't implement hashcode and equals (just like our other, existing, template requests), and they don't have toXContent, so they wouldn't really be testing much? Is it worth adding the hashcode and equals implementations so that we can add tests for the requests?", "author": "dakrone", "createdAt": "2020-03-25T21:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2OTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODM3OTI3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398379272", "bodyText": "Sorry, I should have been more specific. These tests would extend from AbstractWireSerializingTestCase and test the binary wire serialisation. The requests can then either implement equals() / hashcode() methods or in the test you can overwrite the assertEqualInstances() method.", "author": "martijnvg", "createdAt": "2020-03-26T08:04:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2OTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODczMTE1Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r398731153", "bodyText": "Okay, I've added these unit tests.", "author": "dakrone", "createdAt": "2020-03-26T16:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2OTAyMw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "05c3aaf61e04621fb891b6d75740d7b38d34746f", "url": "https://github.com/elastic/elasticsearch/commit/05c3aaf61e04621fb891b6d75740d7b38d34746f", "message": "Add skips for 7.x versions", "committedDate": "2020-03-25T21:12:25Z", "type": "commit"}, {"oid": "90ac607dc9a09947534fc08da758ec20536664f9", "url": "https://github.com/elastic/elasticsearch/commit/90ac607dc9a09947534fc08da758ec20536664f9", "message": "Use index_template instead of template_v2 in action names", "committedDate": "2020-03-25T21:12:25Z", "type": "commit"}, {"oid": "675ca827547be18568ac2da37c35f374dd16e471", "url": "https://github.com/elastic/elasticsearch/commit/675ca827547be18568ac2da37c35f374dd16e471", "message": "Add test for MetaDataIndexTemplateService.addIndexTemplateV2", "committedDate": "2020-03-25T21:12:25Z", "type": "commit"}, {"oid": "ba355e42134fbcd35faa343891c1b886d6343608", "url": "https://github.com/elastic/elasticsearch/commit/ba355e42134fbcd35faa343891c1b886d6343608", "message": "Merge branch 'master' into itv2-add-itv2-rest-apis", "committedDate": "2020-03-25T22:20:58Z", "type": "commit"}, {"oid": "62370f922c90a58e0119ffc0e6ed780f918db542", "url": "https://github.com/elastic/elasticsearch/commit/62370f922c90a58e0119ffc0e6ed780f918db542", "message": "Move removal to static method and add test", "committedDate": "2020-03-25T23:01:12Z", "type": "commit"}, {"oid": "9e54da63c2a18319da59e2961529b6fa2ab6f452", "url": "https://github.com/elastic/elasticsearch/commit/9e54da63c2a18319da59e2961529b6fa2ab6f452", "message": "Add unit tests for request classes (implement hashCode & equals)", "committedDate": "2020-03-26T16:48:38Z", "type": "commit"}]}