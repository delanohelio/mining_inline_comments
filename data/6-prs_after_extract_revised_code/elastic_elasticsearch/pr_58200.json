{"pr_number": 58200, "pr_title": "Enable TTY password OS tests, plus refactoring (#57759)", "pr_createdAt": "2020-06-16T20:51:12Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58200", "timeline": [{"oid": "fcd797f9e36167b2a431de005cb29b6e81fdfc0b", "url": "https://github.com/elastic/elasticsearch/commit/fcd797f9e36167b2a431de005cb29b6e81fdfc0b", "message": "Enable TTY password OS tests, plus refactoring (#57759)\n\nTwo keystore tests were unintentionally ignored when the\r\npassword-protected keystore work was merged. I've re\u00ebnabled those tests\r\nhere.\r\n\r\nI've also refactored the test methods a little bit to reduce the API\r\nsurface: instead of having a \"startElasticsearchTtyPassword\" method and\r\na \"startElasticsearchStandardInputPassword\" method, I've made a single\r\n\"startElasticsearch\" method with a \"useTty\" boolean argument.", "committedDate": "2020-06-16T20:40:14Z", "type": "commit"}, {"oid": "5faa81d9d754bfddbbda07f9d41abab917eb5261", "url": "https://github.com/elastic/elasticsearch/commit/5faa81d9d754bfddbbda07f9d41abab917eb5261", "message": "Merge branch '7.x' into backport/7.x/enable-tty-tests-and-refactor", "committedDate": "2020-06-17T19:05:23Z", "type": "commit"}, {"oid": "6f30abf1e08f56165b6c3067227c8e5d35e514ab", "url": "https://github.com/elastic/elasticsearch/commit/6f30abf1e08f56165b6c3067227c8e5d35e514ab", "message": "Remove -d option for tty startup\n\nCentos 6 uses a version of expect that kills the elasticsearch process\nwhen it tries to daemonize. I will fix this in future work but for now\nI'm replacing it with a todo.", "committedDate": "2020-06-18T00:56:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MDcyOA==", "url": "https://github.com/elastic/elasticsearch/pull/58200#discussion_r441970728", "bodyText": "I'm not sure we should be removing daemonize here, since the method still takes in the flag. Wouldn't this cause any tests using tty but not expecting failure to fail?", "author": "rjernst", "createdAt": "2020-06-18T05:06:57Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Archives.java", "diffHunk": "@@ -244,9 +244,10 @@ private static void verifyDefaultInstallation(Installation es, Distribution dist\n         // requires the \"expect\" utility to be installed\n         List<String> command = new ArrayList<>();\n         command.add(\"sudo -E -u %s %s -p %s\");\n-        if (daemonize) {\n-            command.add(\"-d\");", "originalCommit": "6f30abf1e08f56165b6c3067227c8e5d35e514ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI0NzM0MA==", "url": "https://github.com/elastic/elasticsearch/pull/58200#discussion_r442247340", "bodyText": "What's going on here is that I want spawn -ignore HUP  to let the process keep running in the background after the expect program ends. This is how it works on centos 7, and that's why the tests are passing after this change: it's as if a keyboard user is running without daemonization.\nOn centos 6, it seems that when expect terminates, it's terminating Elasticsearch too when the -d flag is added.\nBut I agree that the code shouldn't be merged in this state. I think I can improve it in a couple of ways, including not taking and disregarding a boolean flag in this method.", "author": "williamrandolph", "createdAt": "2020-06-18T13:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MDcyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE4NDA4NA==", "url": "https://github.com/elastic/elasticsearch/pull/58200#discussion_r445184084", "bodyText": "I've restored the \"daemonize\" block, but put a TODO/ignore on the test that would cause the problem. Hopefully the specific issue will be clear to anyone who works on the code. I'm hoping to find a different workaround after more investigation.", "author": "williamrandolph", "createdAt": "2020-06-24T21:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MDcyOA=="}], "type": "inlineReview", "revised_code": {"commit": "bb856671cc324b3adf2f3d041a4fb8844d616739", "chunk": "diff --git a/qa/os/src/test/java/org/elasticsearch/packaging/util/Archives.java b/qa/os/src/test/java/org/elasticsearch/packaging/util/Archives.java\nindex ea8e4082c5b..2cda7f7e5de 100644\n--- a/qa/os/src/test/java/org/elasticsearch/packaging/util/Archives.java\n+++ b/qa/os/src/test/java/org/elasticsearch/packaging/util/Archives.java\n\n@@ -241,12 +241,15 @@ public class Archives {\n         final Path pidFile = installation.home.resolve(\"elasticsearch.pid\");\n         final Installation.Executables bin = installation.executables();\n \n-        // requires the \"expect\" utility to be installed\n         List<String> command = new ArrayList<>();\n         command.add(\"sudo -E -u %s %s -p %s\");\n \n-        // TODO: daemonization isn't working with expect versions prior to 5.45\n-        // centos-6 has 5.45.1.15\n+        // requires the \"expect\" utility to be installed\n+        // TODO: daemonization isn't working with expect versions prior to 5.45, but centos-6 has 5.45.1.15\n+        // TODO: try using pty4j to make daemonization work\n+        if (daemonize) {\n+            command.add(\"-d\");\n+        }\n \n         String script = String.format(\n             Locale.ROOT,\n"}}, {"oid": "bb856671cc324b3adf2f3d041a4fb8844d616739", "url": "https://github.com/elastic/elasticsearch/commit/bb856671cc324b3adf2f3d041a4fb8844d616739", "message": "Test daemonization and non-daemonization case for tty", "committedDate": "2020-06-24T20:34:43Z", "type": "commit"}, {"oid": "700efba5c4758dce409808fbe548e867311a7c60", "url": "https://github.com/elastic/elasticsearch/commit/700efba5c4758dce409808fbe548e867311a7c60", "message": "Merge branch '7.x' into backport/7.x/enable-tty-tests-and-refactor", "committedDate": "2020-06-24T20:42:19Z", "type": "commit"}]}