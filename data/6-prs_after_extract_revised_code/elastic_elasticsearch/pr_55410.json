{"pr_number": 55410, "pr_title": "Identify backing indices for data streams", "pr_createdAt": "2020-04-17T16:19:20Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55410", "timeline": [{"oid": "1e74a5672cdc4acd1c2f02426428675d77d9ddc5", "url": "https://github.com/elastic/elasticsearch/commit/1e74a5672cdc4acd1c2f02426428675d77d9ddc5", "message": "identify back indices with parent data stream", "committedDate": "2020-04-17T15:34:00Z", "type": "commit"}, {"oid": "4615dd7e2e898135e679753d4c0fd6756599b680", "url": "https://github.com/elastic/elasticsearch/commit/4615dd7e2e898135e679753d4c0fd6756599b680", "message": "remove commented code", "committedDate": "2020-04-17T16:15:46Z", "type": "commit"}, {"oid": "8053209eb05e4d1b058a7b748073ffba57b1926c", "url": "https://github.com/elastic/elasticsearch/commit/8053209eb05e4d1b058a7b748073ffba57b1926c", "message": "Merge branch 'master' into identify_backing_indices", "committedDate": "2020-04-17T16:46:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEzNDAxMw==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411134013", "bodyText": "Can the return type be IndexAbstraction instead of DataStream (the data stream impl for IndexAbstraction)?\nCurrently DataStream doesn't have any methods that IndexAbstraction doesn't have and would be good to not rely on anything implementation specific.", "author": "martijnvg", "createdAt": "2020-04-20T06:49:27Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -67,6 +67,12 @@\n     @Nullable\n     IndexMetadata getWriteIndex();\n \n+    /**\n+     * @return the data stream to which this index belongs or <code>null</code> if this is not a concrete index or\n+     * if it is a concrete index that does not belong to a data stream.\n+     */\n+    @Nullable DataStream getParentDataStream();", "originalCommit": "8053209eb05e4d1b058a7b748073ffba57b1926c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMxOTc1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411319751", "bodyText": "I chose the return type of IndexAbstraction.DataStream for two reasons -- the parent data stream could never be an IndexAbstraction.Index or IndexAbstraction.Alias and when implementing data stream rollover in the next PR, I added a getDataStream method to IndexAbstraction.DataStream which is convenient to call from getParentDataStream without casting.", "author": "danhermann", "createdAt": "2020-04-20T11:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEzNDAxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMyOTI3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411329277", "bodyText": "Ok, that makes sense. I just prefer that other code isn't going to rely on data stream specific methods (like is today with the alias impl). Otherwise the abstraction is going to be leaky.", "author": "martijnvg", "createdAt": "2020-04-20T12:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEzNDAxMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411141042", "bodyText": "Can we reuse the IndexAbstraction.DataStream created here in the logic below here that adds data streams to the indices lookup? I think it would nice that if a data stream is lookup directly or via a backing index that the same instance is returned.\nI think we can do this if we add the data streams to the indicesLookup map before we add the indices to the indicesLookup map?", "author": "martijnvg", "createdAt": "2020-04-20T07:03:15Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1349,10 +1349,30 @@ public Metadata build() {\n \n         private SortedMap<String, IndexAbstraction> buildIndicesLookup() {\n             SortedMap<String, IndexAbstraction> indicesLookup = new TreeMap<>();\n+            Map<String, DataStream> indexToDataStreamLookup = new HashMap<>();\n+            DataStreamMetadata dataStreamMetadata = (DataStreamMetadata) this.customs.get(DataStreamMetadata.TYPE);\n+            if (dataStreamMetadata != null) {\n+                for (DataStream ds : dataStreamMetadata.dataStreams().values()) {\n+                    for (Index i : ds.getIndices()) {\n+                        indexToDataStreamLookup.put(i.getName(), ds);\n+                    }\n+                }\n+            }\n+\n             for (ObjectCursor<IndexMetadata> cursor : indices.values()) {\n                 IndexMetadata indexMetadata = cursor.value;\n-                IndexAbstraction existing =\n-                    indicesLookup.put(indexMetadata.getIndex().getName(), new IndexAbstraction.Index(indexMetadata));\n+\n+                IndexAbstraction.Index index;\n+                DataStream parent = indexToDataStreamLookup.get(indexMetadata.getIndex().getName());\n+                if (parent != null) {\n+                    List<IndexMetadata> backingIndices = parent.getIndices().stream()\n+                        .map(imd -> indices.get(imd.getName())).collect(Collectors.toList());\n+                    index = new IndexAbstraction.Index(indexMetadata, new IndexAbstraction.DataStream(parent, backingIndices));", "originalCommit": "8053209eb05e4d1b058a7b748073ffba57b1926c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzNDUyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411334521", "bodyText": "@martijnvg, I agree that would be nice. Adding data streams to indicesLookup before indices means that name conflicts will be reported as Index [foo] conflicts with existing data stream [foo]... rather than Data stream [foo] conflicts with existing index [foo].... If you are ok with that, I'll make the change.", "author": "danhermann", "createdAt": "2020-04-20T12:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzNzU5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411337595", "bodyText": "I think that is ok.\nMaybe rename the exception to: index [foo] and data stream [foo] have the same name\nor something like that, so the name conflict is bad regardless which one was added first.", "author": "martijnvg", "createdAt": "2020-04-20T12:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMzODc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411338744", "bodyText": "Actually, for consistency and simplicity, I should probably add data streams to the duplicate name check for aliases and indices that occurs before the call to buildIndicesLookup.", "author": "danhermann", "createdAt": "2020-04-20T12:31:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MjAxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411342019", "bodyText": "I should probably add data streams to the duplicate name check for aliases and indices that occurs before the call to buildIndicesLookup.\n\n\ud83d\udc4d", "author": "martijnvg", "createdAt": "2020-04-20T12:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4MTY3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411381679", "bodyText": "I think it is a requirement that we reuse the same instances, since equals is not overridden.", "author": "henningandersen", "createdAt": "2020-04-20T13:35:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE0MTA0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "f51f8201267d83ef64085124f617f8e690b64332", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java b/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\nindex 68f6f540a35..37ee7229a0e 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\n\n@@ -1351,10 +1383,21 @@ public class Metadata implements Iterable<IndexMetadata>, Diffable<Metadata>, To\n             SortedMap<String, IndexAbstraction> indicesLookup = new TreeMap<>();\n             Map<String, DataStream> indexToDataStreamLookup = new HashMap<>();\n             DataStreamMetadata dataStreamMetadata = (DataStreamMetadata) this.customs.get(DataStreamMetadata.TYPE);\n-            if (dataStreamMetadata != null) {\n-                for (DataStream ds : dataStreamMetadata.dataStreams().values()) {\n-                    for (Index i : ds.getIndices()) {\n-                        indexToDataStreamLookup.put(i.getName(), ds);\n+            // If there are no indices, then skip data streams. This happens only when metadata is read from disk\n+            if (dataStreamMetadata != null && indices.size() > 0) {\n+                for (DataStream dataStream : dataStreamMetadata.dataStreams().values()) {\n+                    List<IndexMetadata> backingIndices = dataStream.getIndices().stream()\n+                        .map(index -> indices.get(index.getName()))\n+                        .collect(Collectors.toList());\n+                    assert backingIndices.isEmpty() == false;\n+                    assert backingIndices.contains(null) == false;\n+\n+                    IndexAbstraction existing = indicesLookup.put(dataStream.getName(),\n+                        new IndexAbstraction.DataStream(dataStream, backingIndices));\n+                    assert existing == null : \"duplicate data stream for \" + dataStream.getName();\n+\n+                    for (Index i : dataStream.getIndices()) {\n+                        indexToDataStreamLookup.put(i.getName(), dataStream);\n                     }\n                 }\n             }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4MDE3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/55410#discussion_r411380173", "bodyText": "Can we add:\nassert parent.getIndices().contains(indexMetadata.getIndex())\n\nthat would  validate that uuid and name from data-stream indices is the same as the index we are looking at.", "author": "henningandersen", "createdAt": "2020-04-20T13:33:24Z", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1349,10 +1349,30 @@ public Metadata build() {\n \n         private SortedMap<String, IndexAbstraction> buildIndicesLookup() {\n             SortedMap<String, IndexAbstraction> indicesLookup = new TreeMap<>();\n+            Map<String, DataStream> indexToDataStreamLookup = new HashMap<>();\n+            DataStreamMetadata dataStreamMetadata = (DataStreamMetadata) this.customs.get(DataStreamMetadata.TYPE);\n+            if (dataStreamMetadata != null) {\n+                for (DataStream ds : dataStreamMetadata.dataStreams().values()) {\n+                    for (Index i : ds.getIndices()) {\n+                        indexToDataStreamLookup.put(i.getName(), ds);\n+                    }\n+                }\n+            }\n+\n             for (ObjectCursor<IndexMetadata> cursor : indices.values()) {\n                 IndexMetadata indexMetadata = cursor.value;\n-                IndexAbstraction existing =\n-                    indicesLookup.put(indexMetadata.getIndex().getName(), new IndexAbstraction.Index(indexMetadata));\n+\n+                IndexAbstraction.Index index;\n+                DataStream parent = indexToDataStreamLookup.get(indexMetadata.getIndex().getName());\n+                if (parent != null) {\n+                    List<IndexMetadata> backingIndices = parent.getIndices().stream()", "originalCommit": "8053209eb05e4d1b058a7b748073ffba57b1926c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f51f8201267d83ef64085124f617f8e690b64332", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java b/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\nindex 68f6f540a35..37ee7229a0e 100644\n--- a/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\n+++ b/server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java\n\n@@ -1351,10 +1383,21 @@ public class Metadata implements Iterable<IndexMetadata>, Diffable<Metadata>, To\n             SortedMap<String, IndexAbstraction> indicesLookup = new TreeMap<>();\n             Map<String, DataStream> indexToDataStreamLookup = new HashMap<>();\n             DataStreamMetadata dataStreamMetadata = (DataStreamMetadata) this.customs.get(DataStreamMetadata.TYPE);\n-            if (dataStreamMetadata != null) {\n-                for (DataStream ds : dataStreamMetadata.dataStreams().values()) {\n-                    for (Index i : ds.getIndices()) {\n-                        indexToDataStreamLookup.put(i.getName(), ds);\n+            // If there are no indices, then skip data streams. This happens only when metadata is read from disk\n+            if (dataStreamMetadata != null && indices.size() > 0) {\n+                for (DataStream dataStream : dataStreamMetadata.dataStreams().values()) {\n+                    List<IndexMetadata> backingIndices = dataStream.getIndices().stream()\n+                        .map(index -> indices.get(index.getName()))\n+                        .collect(Collectors.toList());\n+                    assert backingIndices.isEmpty() == false;\n+                    assert backingIndices.contains(null) == false;\n+\n+                    IndexAbstraction existing = indicesLookup.put(dataStream.getName(),\n+                        new IndexAbstraction.DataStream(dataStream, backingIndices));\n+                    assert existing == null : \"duplicate data stream for \" + dataStream.getName();\n+\n+                    for (Index i : dataStream.getIndices()) {\n+                        indexToDataStreamLookup.put(i.getName(), dataStream);\n                     }\n                 }\n             }\n"}}, {"oid": "f51f8201267d83ef64085124f617f8e690b64332", "url": "https://github.com/elastic/elasticsearch/commit/f51f8201267d83ef64085124f617f8e690b64332", "message": "review comments", "committedDate": "2020-04-20T15:21:47Z", "type": "commit"}, {"oid": "9205bba0e61dda20c9c73450169ed597b2eb230a", "url": "https://github.com/elastic/elasticsearch/commit/9205bba0e61dda20c9c73450169ed597b2eb230a", "message": "Merge branch 'master' into identify_backing_indices", "committedDate": "2020-04-20T15:50:35Z", "type": "commit"}]}