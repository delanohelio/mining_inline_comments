{"pr_number": 53669, "pr_title": "Move pipeline agg validation to coordinating node", "pr_createdAt": "2020-03-17T14:41:16Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53669", "timeline": [{"oid": "a99ec5f2ebc8a589de5b588064ec9f52dc33c366", "url": "https://github.com/elastic/elasticsearch/commit/a99ec5f2ebc8a589de5b588064ec9f52dc33c366", "message": "Move pipeline agg validation to coordinating node\n\nThis moves the pipeline aggregation validation from the data node to the\ncoordinating node so that we, eventually, can stop sending pipeline\naggregations to the data nodes entirely. In fact, it moves it into the\n\"request validation\" stage so multiple errors can be accumulated and\nsent back to the requester for the entire request. We can't always take\nadvantage of that, but it'll be nice for folks not to have to play\nwhack-a-mole with validation.\n\nThis is implemented by replacing `PipelineAggretionBuilder#validate`\nwith:\n```\nprotected abstract void validate(ValidationContext context);\n```\n\nThe `ValidationContext` handles the accumulation of validation failures,\nprovides access to the aggregation's siblings, and implements a few\nvalidation utility methods.", "committedDate": "2020-03-17T14:38:28Z", "type": "commit"}, {"oid": "3dbada82000bf6fa58a2f6496ea252a4a292dd24", "url": "https://github.com/elastic/elasticsearch/commit/3dbada82000bf6fa58a2f6496ea252a4a292dd24", "message": "Fix tests", "committedDate": "2020-03-17T15:09:21Z", "type": "commit"}, {"oid": "7aaae7a405ee7806135bd45d0817fc4328930e0f", "url": "https://github.com/elastic/elasticsearch/commit/7aaae7a405ee7806135bd45d0817fc4328930e0f", "message": "Fix test", "committedDate": "2020-03-17T15:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMDY0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395210646", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * Validate a the pipeline aggregations in this factory.\n          \n          \n            \n                     * Validate the pipeline aggregations in this factory.", "author": "polyfractal", "createdAt": "2020-03-19T17:47:07Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java", "diffHunk": "@@ -298,23 +297,59 @@ public Builder addPipelineAggregator(PipelineAggregationBuilder pipelineAggregat\n             return this;\n         }\n \n+        /**\n+         * Validate the root of the aggregation tree.\n+         */\n+        public ActionRequestValidationException validate(ActionRequestValidationException e) {\n+            PipelineAggregationBuilder.ValidationContext context =\n+                    PipelineAggregationBuilder.ValidationContext.forTreeRoot(aggregationBuilders, pipelineAggregatorBuilders, e);\n+            validatePipelines(context);\n+            return validateChildren(context.getValidationException());\n+        }\n+\n+        /**\n+         * Validate a the pipeline aggregations in this factory.", "originalCommit": "7aaae7a405ee7806135bd45d0817fc4328930e0f", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMTc1Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395211757", "bodyText": "Should we allow the validations to keep running down the tree, so we can tell the user all the problems at once?", "author": "polyfractal", "createdAt": "2020-03-19T17:48:53Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactories.java", "diffHunk": "@@ -298,23 +297,59 @@ public Builder addPipelineAggregator(PipelineAggregationBuilder pipelineAggregat\n             return this;\n         }\n \n+        /**\n+         * Validate the root of the aggregation tree.\n+         */\n+        public ActionRequestValidationException validate(ActionRequestValidationException e) {\n+            PipelineAggregationBuilder.ValidationContext context =\n+                    PipelineAggregationBuilder.ValidationContext.forTreeRoot(aggregationBuilders, pipelineAggregatorBuilders, e);\n+            validatePipelines(context);\n+            return validateChildren(context.getValidationException());\n+        }\n+\n+        /**\n+         * Validate a the pipeline aggregations in this factory.\n+         */\n+        private void validatePipelines(PipelineAggregationBuilder.ValidationContext context) {\n+            List<PipelineAggregationBuilder> orderedPipelineAggregators;\n+            try {\n+                orderedPipelineAggregators = resolvePipelineAggregatorOrder(pipelineAggregatorBuilders, aggregationBuilders);\n+            } catch (IllegalArgumentException iae) {\n+                context.addValidationError(iae.getMessage());\n+                return;", "originalCommit": "7aaae7a405ee7806135bd45d0817fc4328930e0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMyMDMxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395320311", "bodyText": "I was tempted but I think the tree is pretty borked at this point and you'll end up with duplicate error messages all about the same thing. And I figured we were just returning a single error message right now so it probably isn't worse than it was before and we could do it later if we wanted it.", "author": "nik9000", "createdAt": "2020-03-19T21:08:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMTc1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY1OTc2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r396659765", "bodyText": "Makes sense to me \ud83d\udc4d", "author": "polyfractal", "createdAt": "2020-03-23T18:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMTc1Nw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyODYwNg==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395228606", "bodyText": "Ahh yes, this thing.  Would be nice someday if we could get rid of these instanceofs with some kind of isSequential() method on the agg.\nBattle for another day :)", "author": "polyfractal", "createdAt": "2020-03-19T18:17:21Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/PipelineAggregationBuilder.java", "diffHunk": "@@ -64,11 +70,145 @@ public String getName() {\n     }\n \n     /**\n-     * Internal: Validates the state of this factory (makes sure the factory is properly\n-     * configured)\n+     * Makes sure this builder is properly configured.\n      */\n-    protected abstract void validate(AggregatorFactory parent, Collection<AggregationBuilder> aggregationBuilders,\n-            Collection<PipelineAggregationBuilder> pipelineAggregatorBuilders);\n+    protected abstract void validate(ValidationContext context);\n+    public abstract static class ValidationContext {\n+        /**\n+         * Build the context for the root of the aggregation tree.\n+         */\n+        public static ValidationContext forTreeRoot(Collection<AggregationBuilder> siblingAggregations,\n+                Collection<PipelineAggregationBuilder> siblingPipelineAggregations,\n+                ActionRequestValidationException validationFailuresSoFar) {\n+            return new ForTreeRoot(siblingAggregations, siblingPipelineAggregations, validationFailuresSoFar);\n+        }\n+\n+        /**\n+         * Build the context for a node inside the aggregation tree.\n+         */\n+        public static ValidationContext forInsideTree(AggregationBuilder parent,\n+                ActionRequestValidationException validationFailuresSoFar) {\n+            return new ForInsideTree(parent, validationFailuresSoFar);\n+        }\n+\n+\n+        private ActionRequestValidationException e;\n+\n+        private ValidationContext(ActionRequestValidationException validationFailuresSoFar) {\n+            this.e = validationFailuresSoFar;\n+        }\n+\n+        private static class ForTreeRoot extends ValidationContext {\n+            private final Collection<AggregationBuilder> siblingAggregations;\n+            private final Collection<PipelineAggregationBuilder> siblingPipelineAggregations;\n+\n+            ForTreeRoot(Collection<AggregationBuilder> siblingAggregations,\n+                    Collection<PipelineAggregationBuilder> siblingPipelineAggregations,\n+                    ActionRequestValidationException validationFailuresSoFar) {\n+                super(validationFailuresSoFar);\n+                this.siblingAggregations = Objects.requireNonNull(siblingAggregations);\n+                this.siblingPipelineAggregations = Objects.requireNonNull(siblingPipelineAggregations);\n+            }\n+\n+            @Override\n+            public Collection<AggregationBuilder> getSiblingAggregations() {\n+                return siblingAggregations;\n+            }\n+\n+            @Override\n+            public Collection<PipelineAggregationBuilder> getSiblingPipelineAggregations() {\n+                return siblingPipelineAggregations;\n+            }\n+\n+            @Override\n+            public void validateParentAggSequentiallyOrdered(String type, String name) {\n+                addValidationError(type + \" aggregation [\" + name\n+                        + \"] must have a histogram, date_histogram or auto_date_histogram as parent but doesn't have a parent\");\n+            }\n+        }\n+\n+        private static class ForInsideTree extends ValidationContext {\n+            private final AggregationBuilder parent;\n+\n+            ForInsideTree(AggregationBuilder parent, ActionRequestValidationException validationFailuresSoFar) {\n+                super(validationFailuresSoFar);\n+                this.parent = Objects.requireNonNull(parent);\n+            }\n+\n+            @Override\n+            public Collection<AggregationBuilder> getSiblingAggregations() {\n+                return parent.getSubAggregations();\n+            }\n+\n+            @Override\n+            public Collection<PipelineAggregationBuilder> getSiblingPipelineAggregations() {\n+                return parent.getPipelineAggregations();\n+            }\n+\n+            @Override\n+            public void validateParentAggSequentiallyOrdered(String type, String name) {", "originalCommit": "7aaae7a405ee7806135bd45d0817fc4328930e0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMxOTE1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395319159", "bodyText": "+++++++++++++", "author": "nik9000", "createdAt": "2020-03-19T21:05:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyODYwNg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIzMDIwNg==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395230206", "bodyText": "Optional: should we remove this else statement and just leave the context error as the last statement in the method?\nI always feel like else are trappy/unnecessary when it's just doing some kind of error or return statement.  Less rightward drift if we remove.\nTotally optional, this might just be a quirk I've picked up :)", "author": "polyfractal", "createdAt": "2020-03-19T18:20:11Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketMetricsPipelineAggregationBuilder.java", "diffHunk": "@@ -107,28 +104,27 @@ public GapPolicy gapPolicy() {\n     protected abstract PipelineAggregator createInternal(Map<String, Object> metaData);\n \n     @Override\n-    public void doValidate(AggregatorFactory parent, Collection<AggregationBuilder> aggBuilders,\n-            Collection<PipelineAggregationBuilder> pipelineAggregatorFactories) {\n+    protected void validate(ValidationContext context) {\n         if (bucketsPaths.length != 1) {\n-            throw new IllegalStateException(PipelineAggregator.Parser.BUCKETS_PATH.getPreferredName()\n-                    + \" must contain a single entry for aggregation [\" + name + \"]\");\n+            context.addBucketPathValidationError(\"must contain a single entry for aggregation [\" + name + \"]\");\n+            return;\n         }\n         // Need to find the first agg name in the buckets path to check its a\n         // multi bucket agg: aggs are split with '>' and can optionally have a\n         // metric name after them by using '.' so need to split on both to get\n         // just the agg name\n         final String firstAgg = bucketsPaths[0].split(\"[>\\\\.]\")[0];\n-        Optional<AggregationBuilder> aggBuilder = aggBuilders.stream().filter((builder) -> builder.getName().equals(firstAgg))\n+        Optional<AggregationBuilder> aggBuilder = context.getSiblingAggregations().stream()\n+                .filter(builder -> builder.getName().equals(firstAgg))\n                 .findAny();\n         if (aggBuilder.isPresent()) {\n             if ((aggBuilder.get() instanceof MultiBucketAggregationBuilder) == false) {\n-                throw new IllegalArgumentException(\"The first aggregation in \" + PipelineAggregator.Parser.BUCKETS_PATH.getPreferredName()\n+                context.addValidationError(\"The first aggregation in \" + PipelineAggregator.Parser.BUCKETS_PATH.getPreferredName()\n                         + \" must be a multi-bucket aggregation for aggregation [\" + name + \"] found :\"\n                         + aggBuilder.get().getClass().getName() + \" for buckets path: \" + bucketsPaths[0]);\n             }\n         } else {", "originalCommit": "7aaae7a405ee7806135bd45d0817fc4328930e0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIzMDk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/53669#discussion_r395230955", "bodyText": "Or, re-arrange so there's an isPresent() == false check first, and an instanceof check next, which avoids nesting.\nBut yeah, optional pending your preferences :D", "author": "polyfractal", "createdAt": "2020-03-19T18:21:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIzMDIwNg=="}], "type": "inlineReview", "revised_code": {"commit": "c686fe06db7615385a8261ae983a8d5b9e24bd46", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketMetricsPipelineAggregationBuilder.java b/server/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketMetricsPipelineAggregationBuilder.java\nindex 820b7fc3832..753f3ca3882 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketMetricsPipelineAggregationBuilder.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/pipeline/BucketMetricsPipelineAggregationBuilder.java\n\n@@ -117,14 +117,14 @@ public abstract class BucketMetricsPipelineAggregationBuilder<AF extends BucketM\n         Optional<AggregationBuilder> aggBuilder = context.getSiblingAggregations().stream()\n                 .filter(builder -> builder.getName().equals(firstAgg))\n                 .findAny();\n-        if (aggBuilder.isPresent()) {\n-            if ((aggBuilder.get() instanceof MultiBucketAggregationBuilder) == false) {\n-                context.addValidationError(\"The first aggregation in \" + PipelineAggregator.Parser.BUCKETS_PATH.getPreferredName()\n-                        + \" must be a multi-bucket aggregation for aggregation [\" + name + \"] found :\"\n-                        + aggBuilder.get().getClass().getName() + \" for buckets path: \" + bucketsPaths[0]);\n-            }\n-        } else {\n+        if (aggBuilder.isEmpty()) {\n             context.addBucketPathValidationError(\"aggregation does not exist for aggregation [\" + name + \"]: \" + bucketsPaths[0]);\n+            return;\n+        }\n+        if ((aggBuilder.get() instanceof MultiBucketAggregationBuilder) == false) {\n+            context.addValidationError(\"The first aggregation in \" + PipelineAggregator.Parser.BUCKETS_PATH.getPreferredName()\n+                    + \" must be a multi-bucket aggregation for aggregation [\" + name + \"] found :\"\n+                    + aggBuilder.get().getClass().getName() + \" for buckets path: \" + bucketsPaths[0]);\n         }\n     }\n \n"}}, {"oid": "055ed191a2a769058cafe1d98cf993e799227571", "url": "https://github.com/elastic/elasticsearch/commit/055ed191a2a769058cafe1d98cf993e799227571", "message": "Merge branch 'master' into pipeline_validate_builders", "committedDate": "2020-03-19T21:03:59Z", "type": "commit"}, {"oid": "c686fe06db7615385a8261ae983a8d5b9e24bd46", "url": "https://github.com/elastic/elasticsearch/commit/c686fe06db7615385a8261ae983a8d5b9e24bd46", "message": "Less nesting", "committedDate": "2020-03-19T21:28:14Z", "type": "commit"}, {"oid": "c686fe06db7615385a8261ae983a8d5b9e24bd46", "url": "https://github.com/elastic/elasticsearch/commit/c686fe06db7615385a8261ae983a8d5b9e24bd46", "message": "Less nesting", "committedDate": "2020-03-19T21:28:14Z", "type": "forcePushed"}]}