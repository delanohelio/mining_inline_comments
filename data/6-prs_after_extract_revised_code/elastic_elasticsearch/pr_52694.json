{"pr_number": 52694, "pr_title": "Record Force Merges in Live Commit Data", "pr_createdAt": "2020-02-24T09:21:21Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52694", "timeline": [{"oid": "42ac71ee809745256c0b93f28f3c1299b23f6bd2", "url": "https://github.com/elastic/elasticsearch/commit/42ac71ee809745256c0b93f28f3c1299b23f6bd2", "message": "Record Force Merges in live commit data\n\nPrerequesite of #52182. Record force merges in the live commit data\nso two shard states with the same sequence number that differ only in whether\nor not they have been force merged can be distinguished when creating snapshots.", "committedDate": "2020-02-24T09:17:07Z", "type": "commit"}, {"oid": "3fb159a4a22f7aeec9daa7f019770e283d08b36e", "url": "https://github.com/elastic/elasticsearch/commit/3fb159a4a22f7aeec9daa7f019770e283d08b36e", "message": "Merge remote-tracking branch 'elastic/master' into record-force-merge-id", "committedDate": "2020-02-24T14:55:34Z", "type": "commit"}, {"oid": "8ce66dcaf1ff64710ca309e6428e1e0d07ebf288", "url": "https://github.com/elastic/elasticsearch/commit/8ce66dcaf1ff64710ca309e6428e1e0d07ebf288", "message": "force merge uuid in transport request", "committedDate": "2020-02-24T17:14:46Z", "type": "commit"}, {"oid": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "url": "https://github.com/elastic/elasticsearch/commit/6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "message": "force merge uuid in transport request", "committedDate": "2020-02-24T17:18:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQyNzMwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383427305", "bodyText": "I figured it's a nice thing to just used _na_ instead of null to keep the serialization BwC simple.", "author": "original-brownbear", "createdAt": "2020-02-24T18:09:26Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java", "diffHunk": "@@ -53,20 +55,36 @@\n     private boolean onlyExpungeDeletes = Defaults.ONLY_EXPUNGE_DELETES;\n     private boolean flush = Defaults.FLUSH;\n \n+    private static final Version FORCE_MERGE_UUID_VERSION = Version.V_8_0_0;\n+\n+    public static final String FORCE_MERGE_UUID_NA_VALUE = \"_na_\";", "originalCommit": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "e8425692f0aadf0850b126a7e37fa3af543444fa", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\nindex ec79fc059da0..18f809371eea 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\n\n@@ -57,12 +58,13 @@ public class ForceMergeRequest extends BroadcastRequest<ForceMergeRequest> {\n \n     private static final Version FORCE_MERGE_UUID_VERSION = Version.V_8_0_0;\n \n-    public static final String FORCE_MERGE_UUID_NA_VALUE = \"_na_\";\n+    private static final String FORCE_MERGE_UUID_NA_VALUE = \"_na_\";\n \n     /**\n      * Force merge UUID to store in the live commit data of a shard under\n      * {@link org.elasticsearch.index.engine.Engine#FORCE_MERGE_UUID_KEY} after force merging it.\n      */\n+    @Nullable\n     private final String forceMergeUUID;\n \n     /**\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ4NzgxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383487811", "bodyText": "Can we move this method to InternalEngine?", "author": "dnhatn", "createdAt": "2020-02-24T20:09:16Z", "path": "server/src/main/java/org/elasticsearch/index/engine/Engine.java", "diffHunk": "@@ -174,6 +176,10 @@ public MergeStats getMergeStats() {\n     /** returns the history uuid for the engine */\n     public abstract String getHistoryUUID();\n \n+    /** returns the force merge uuid for the engine */\n+    @Nullable\n+    public abstract String getForceMergeUUID();", "originalCommit": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNjYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383526637", "bodyText": "Done :)", "author": "original-brownbear", "createdAt": "2020-02-24T21:31:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ4NzgxMQ=="}], "type": "inlineReview", "revised_code": {"commit": "68bf8453774c7e4714b1d4808da369385e485222", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/engine/Engine.java b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\nindex 1d07d297e93c..d139d6c5ad50 100644\n--- a/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n+++ b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n\n@@ -176,10 +175,6 @@ public abstract class Engine implements Closeable {\n     /** returns the history uuid for the engine */\n     public abstract String getHistoryUUID();\n \n-    /** returns the force merge uuid for the engine */\n-    @Nullable\n-    public abstract String getForceMergeUUID();\n-\n     /** Returns how many bytes we are currently moving from heap to disk */\n     public abstract long getWritingBytes();\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ4OTM2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383489366", "bodyText": "Since you're in on it, would you mind removing this forceMerge method.", "author": "dnhatn", "createdAt": "2020-02-24T20:12:47Z", "path": "server/src/main/java/org/elasticsearch/index/engine/Engine.java", "diffHunk": "@@ -1069,14 +1075,15 @@ public final void flush() throws EngineException {\n      * Force merges to 1 segment\n      */\n     public void forceMerge(boolean flush) throws IOException {\n-        forceMerge(flush, 1, false, false, false);\n+        forceMerge(flush, 1, false, false, false, ForceMergeRequest.FORCE_MERGE_UUID_NA_VALUE);", "originalCommit": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68bf8453774c7e4714b1d4808da369385e485222", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/engine/Engine.java b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\nindex 1d07d297e93c..d139d6c5ad50 100644\n--- a/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n+++ b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n\n@@ -1071,13 +1066,6 @@ public abstract class Engine implements Closeable {\n      */\n     public abstract void rollTranslogGeneration() throws EngineException;\n \n-    /**\n-     * Force merges to 1 segment\n-     */\n-    public void forceMerge(boolean flush) throws IOException {\n-        forceMerge(flush, 1, false, false, false, ForceMergeRequest.FORCE_MERGE_UUID_NA_VALUE);\n-    }\n-\n     /**\n      * Triggers a forced merge on this engine\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MTk1OA==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383491958", "bodyText": "Since you're in on it, would you mind removing this forceMerge method.", "author": "dnhatn", "createdAt": "2020-02-24T20:18:34Z", "path": "server/src/main/java/org/elasticsearch/index/engine/Engine.java", "diffHunk": "@@ -1069,14 +1075,15 @@ public final void flush() throws EngineException {\n      * Force merges to 1 segment\n      */\n     public void forceMerge(boolean flush) throws IOException {", "originalCommit": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUyNjU1MA==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383526550", "bodyText": "Killed it :)", "author": "original-brownbear", "createdAt": "2020-02-24T21:31:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ5MTk1OA=="}], "type": "inlineReview", "revised_code": {"commit": "68bf8453774c7e4714b1d4808da369385e485222", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/engine/Engine.java b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\nindex 1d07d297e93c..d139d6c5ad50 100644\n--- a/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n+++ b/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n\n@@ -1071,13 +1066,6 @@ public abstract class Engine implements Closeable {\n      */\n     public abstract void rollTranslogGeneration() throws EngineException;\n \n-    /**\n-     * Force merges to 1 segment\n-     */\n-    public void forceMerge(boolean flush) throws IOException {\n-        forceMerge(flush, 1, false, false, false, ForceMergeRequest.FORCE_MERGE_UUID_NA_VALUE);\n-    }\n-\n     /**\n      * Triggers a forced merge on this engine\n      */\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUxMDA4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r383510089", "bodyText": "Should we generate a new UUID instead of n/a here?", "author": "dnhatn", "createdAt": "2020-02-24T20:57:53Z", "path": "server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java", "diffHunk": "@@ -135,7 +136,7 @@ void recoverFromLocalShards(Consumer<MappingMetaData> mappingUpdateConsumer, fin\n                     // just trigger a merge to do housekeeping on the\n                     // copied segments - we will also see them in stats etc.\n                     indexShard.getEngine().forceMerge(false, -1, false,\n-                        false, false);\n+                        false, false, ForceMergeRequest.FORCE_MERGE_UUID_NA_VALUE);", "originalCommit": "6183d2ffc0bb02076be7e88fa0d5c1cb3c009b5e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "68bf8453774c7e4714b1d4808da369385e485222", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java b/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java\nindex 50da9756008f..e6301371520a 100644\n--- a/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java\n+++ b/server/src/main/java/org/elasticsearch/index/shard/StoreRecovery.java\n\n@@ -136,7 +136,7 @@ final class StoreRecovery {\n                     // just trigger a merge to do housekeeping on the\n                     // copied segments - we will also see them in stats etc.\n                     indexShard.getEngine().forceMerge(false, -1, false,\n-                        false, false, ForceMergeRequest.FORCE_MERGE_UUID_NA_VALUE);\n+                        false, false, UUIDs.randomBase64UUID());\n                     return true;\n                 } catch (IOException ex) {\n                     throw new IndexShardRecoveryException(indexShard.shardId(), \"failed to recover from local shards\", ex);\n"}}, {"oid": "68bf8453774c7e4714b1d4808da369385e485222", "url": "https://github.com/elastic/elasticsearch/commit/68bf8453774c7e4714b1d4808da369385e485222", "message": "CR: comments", "committedDate": "2020-02-24T21:31:02Z", "type": "commit"}, {"oid": "21e01a72d9ae30948b3c97dcdfde41c0ccf8de7f", "url": "https://github.com/elastic/elasticsearch/commit/21e01a72d9ae30948b3c97dcdfde41c0ccf8de7f", "message": "Merge remote-tracking branch 'elastic/master' into record-force-merge-id", "committedDate": "2020-02-24T21:31:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM1NzY1Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r390357652", "bodyText": "should we also check the NA value and not write it out in that case? Otherwise it will be up to all readers to do the right thing? I find the NA / null handling a bit confusing here, and wonder if we should just have one of these. My preference would be to have it Nullable everywhere, and not introduce another \"null\" value that is NA.", "author": "ywelsch", "createdAt": "2020-03-10T14:32:46Z", "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -2287,12 +2302,16 @@ protected void commitIndexWriter(final IndexWriter writer, final Translog transl\n                  * {@link IndexWriter#commit()} call flushes all documents, we defer computation of the maximum sequence number to the time\n                  * of invocation of the commit data iterator (which occurs after all documents have been flushed to Lucene).\n                  */\n-                final Map<String, String> commitData = new HashMap<>(6);\n+                final Map<String, String> commitData = new HashMap<>(7);\n                 commitData.put(Translog.TRANSLOG_UUID_KEY, translog.getTranslogUUID());\n                 commitData.put(SequenceNumbers.LOCAL_CHECKPOINT_KEY, Long.toString(localCheckpoint));\n                 commitData.put(SequenceNumbers.MAX_SEQ_NO, Long.toString(localCheckpointTracker.getMaxSeqNo()));\n                 commitData.put(MAX_UNSAFE_AUTO_ID_TIMESTAMP_COMMIT_ID, Long.toString(maxUnsafeAutoIdTimestamp.get()));\n                 commitData.put(HISTORY_UUID_KEY, historyUUID);\n+                final String currentForceMergeUUID = forceMergeUUID;\n+                if (currentForceMergeUUID != null) {", "originalCommit": "21e01a72d9ae30948b3c97dcdfde41c0ccf8de7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNTIzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r390405231", "bodyText": "Thanks @ywelsch, that's a good point :) => went for nullable all the way in e842569 now", "author": "original-brownbear", "createdAt": "2020-03-10T15:33:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM1NzY1Mg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "42ae9f478285ce5dec0a5a234e979f3a86c57c84", "url": "https://github.com/elastic/elasticsearch/commit/42ae9f478285ce5dec0a5a234e979f3a86c57c84", "message": "Merge remote-tracking branch 'elastic/master' into record-force-merge-id", "committedDate": "2020-03-10T15:04:26Z", "type": "commit"}, {"oid": "e8425692f0aadf0850b126a7e37fa3af543444fa", "url": "https://github.com/elastic/elasticsearch/commit/e8425692f0aadf0850b126a7e37fa3af543444fa", "message": "CR: nullable all the way", "committedDate": "2020-03-10T15:33:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNDU0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r390534546", "bodyText": "I would just use readOptionalString and writeOptionalString, no need for the extra FORCE_MERGE_UUID_NA_VALUE. It simplifies the code and no need for the extra value. Sending an extra byte on the wire does not hurt either.", "author": "ywelsch", "createdAt": "2020-03-10T18:45:21Z", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java", "diffHunk": "@@ -158,7 +167,7 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeBoolean(onlyExpungeDeletes);\n         out.writeBoolean(flush);\n         if (out.getVersion().onOrAfter(FORCE_MERGE_UUID_VERSION)) {\n-            out.writeString(forceMergeUUID);\n+            out.writeString(forceMergeUUID == null ? FORCE_MERGE_UUID_NA_VALUE : forceMergeUUID);", "originalCommit": "e8425692f0aadf0850b126a7e37fa3af543444fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d707cba418ff62332138829fe0f676bb479f146b", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java b/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\nindex 18f809371eea..bc7c782e8e86 100644\n--- a/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\n+++ b/server/src/main/java/org/elasticsearch/action/admin/indices/forcemerge/ForceMergeRequest.java\n\n@@ -167,7 +160,7 @@ public class ForceMergeRequest extends BroadcastRequest<ForceMergeRequest> {\n         out.writeBoolean(onlyExpungeDeletes);\n         out.writeBoolean(flush);\n         if (out.getVersion().onOrAfter(FORCE_MERGE_UUID_VERSION)) {\n-            out.writeString(forceMergeUUID == null ? FORCE_MERGE_UUID_NA_VALUE : forceMergeUUID);\n+            out.writeOptionalString(forceMergeUUID);\n         }\n     }\n \n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUzNTUyMw==", "url": "https://github.com/elastic/elasticsearch/pull/52694#discussion_r390535523", "bodyText": "@nullable", "author": "ywelsch", "createdAt": "2020-03-10T18:46:56Z", "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -558,6 +566,11 @@ public String getHistoryUUID() {\n         return historyUUID;\n     }\n \n+    /** returns the force merge uuid for the engine */", "originalCommit": "e8425692f0aadf0850b126a7e37fa3af543444fa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d707cba418ff62332138829fe0f676bb479f146b", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java\nindex 6f3da8bac996..a97f11af3213 100644\n--- a/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java\n+++ b/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java\n\n@@ -567,6 +567,7 @@ public class InternalEngine extends Engine {\n     }\n \n     /** returns the force merge uuid for the engine */\n+    @Nullable\n     public String getForceMergeUUID() {\n         return forceMergeUUID;\n     }\n"}}, {"oid": "7ebb39dbae7fcbac27458c9b58bc25584e577425", "url": "https://github.com/elastic/elasticsearch/commit/7ebb39dbae7fcbac27458c9b58bc25584e577425", "message": "Merge remote-tracking branch 'elastic/master' into record-force-merge-id", "committedDate": "2020-03-10T18:54:10Z", "type": "commit"}, {"oid": "d707cba418ff62332138829fe0f676bb479f146b", "url": "https://github.com/elastic/elasticsearch/commit/d707cba418ff62332138829fe0f676bb479f146b", "message": "CR: optional instead of placeholder", "committedDate": "2020-03-10T19:00:16Z", "type": "commit"}]}