{"pr_number": 57057, "pr_title": "Move common repository configuration to java plugin", "pr_createdAt": "2020-05-21T17:59:59Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57057", "timeline": [{"oid": "178fcb58e8e84bbf76fe5e7a565e78fe85d2fb27", "url": "https://github.com/elastic/elasticsearch/commit/178fcb58e8e84bbf76fe5e7a565e78fe85d2fb27", "message": "Move common repository configuration to java plugin\n\nThis commit moves the common maven repository configuration to the ES\njava plugin. All java projects need this common set of repos. Note that\nthe Elastic download and maven repos are removed, as they are not\nnecessary anymore since distribution download was split into the\nDistributionDownloadPlugin.", "committedDate": "2020-05-21T17:57:21Z", "type": "commit"}, {"oid": "be159ec6b0046b499d3b514fffa6549e0ccd023b", "url": "https://github.com/elastic/elasticsearch/commit/be159ec6b0046b499d3b514fffa6549e0ccd023b", "message": "make public temporarily, and remove dead code", "committedDate": "2020-05-21T18:06:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNzQ3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57057#discussion_r428937473", "bodyText": "I think we can now replace all of this with the following which was introduced in Gradle 6.0.\nif (repository instanceof UrlArtifactRepository) {\n    ((UrlArtifactRepository) repository).setAllowInsecureProtocol(false);\n}", "author": "mark-vieira", "createdAt": "2020-05-21T21:55:05Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -137,6 +148,73 @@ public static void configureConfigurations(Project project) {\n         disableTransitiveDeps.accept(JavaPlugin.RUNTIME_ONLY_CONFIGURATION_NAME);\n     }\n \n+    private static final Pattern LUCENE_SNAPSHOT_REGEX = Pattern.compile(\"\\\\w+-snapshot-([a-z0-9]+)\");\n+\n+    /** Adds repositories used by ES dependencies */\n+    public static void configureRepositories(Project project) {\n+        // ensure all repositories use secure urls\n+        project.getRepositories().all(repository -> {\n+            if (repository instanceof MavenArtifactRepository) {", "originalCommit": "be159ec6b0046b499d3b514fffa6549e0ccd023b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwOTYwMw==", "url": "https://github.com/elastic/elasticsearch/pull/57057#discussion_r430709603", "bodyText": "I was not able to do this because the gradle setting only controls a deprecation warning, it does not fail the build.", "author": "rjernst", "createdAt": "2020-05-26T21:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkzNzQ3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "7f0a45c8f2d87a237e1823f32b7eeae2c04068d7", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\nindex d2be84eaf9e..53b3ab9a4e1 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java\n\n@@ -154,15 +155,8 @@ public class ElasticsearchJavaPlugin implements Plugin<Project> {\n     public static void configureRepositories(Project project) {\n         // ensure all repositories use secure urls\n         project.getRepositories().all(repository -> {\n-            if (repository instanceof MavenArtifactRepository) {\n-                final MavenArtifactRepository maven = (MavenArtifactRepository) repository;\n-                assertRepositoryURIIsSecure(maven.getName(), project.getPath(), maven.getUrl());\n-                for (URI uri : maven.getArtifactUrls()) {\n-                    assertRepositoryURIIsSecure(maven.getName(), project.getPath(), uri);\n-                }\n-            } else if (repository instanceof IvyArtifactRepository) {\n-                final IvyArtifactRepository ivy = (IvyArtifactRepository) repository;\n-                assertRepositoryURIIsSecure(ivy.getName(), project.getPath(), ivy.getUrl());\n+            if (repository instanceof UrlArtifactRepository) {\n+                ((UrlArtifactRepository) repository).setAllowInsecureProtocol(false);\n             }\n         });\n         RepositoryHandler repos = project.getRepositories();\n"}}, {"oid": "7f0a45c8f2d87a237e1823f32b7eeae2c04068d7", "url": "https://github.com/elastic/elasticsearch/commit/7f0a45c8f2d87a237e1823f32b7eeae2c04068d7", "message": "use gradle secure check", "committedDate": "2020-05-21T22:05:12Z", "type": "commit"}, {"oid": "6aaaf5b08e1f6fcd2dda2ab9f0e9d85d4a1a5ce3", "url": "https://github.com/elastic/elasticsearch/commit/6aaaf5b08e1f6fcd2dda2ab9f0e9d85d4a1a5ce3", "message": "iter", "committedDate": "2020-05-21T22:26:16Z", "type": "commit"}, {"oid": "d2341681cb019955e818d65559b704789e661437", "url": "https://github.com/elastic/elasticsearch/commit/d2341681cb019955e818d65559b704789e661437", "message": "spotless", "committedDate": "2020-05-21T22:33:44Z", "type": "commit"}, {"oid": "6084a4d860b5983f333845ae24344dc85c7af48a", "url": "https://github.com/elastic/elasticsearch/commit/6084a4d860b5983f333845ae24344dc85c7af48a", "message": "Merge branch 'master' into buildsplit10", "committedDate": "2020-05-26T17:54:22Z", "type": "commit"}, {"oid": "cc839e292cf07722a5fbc7879123f0627a0ba122", "url": "https://github.com/elastic/elasticsearch/commit/cc839e292cf07722a5fbc7879123f0627a0ba122", "message": "Revert \"use gradle secure check\"\n\nThis reverts commit 7f0a45c8", "committedDate": "2020-05-26T18:31:55Z", "type": "commit"}, {"oid": "059255e4f1f761a48ac4437850ec5d7e08a2965e", "url": "https://github.com/elastic/elasticsearch/commit/059255e4f1f761a48ac4437850ec5d7e08a2965e", "message": "add TODO", "committedDate": "2020-05-26T18:32:40Z", "type": "commit"}, {"oid": "f66abdf5424bde51db73f246850c361a8af6f25c", "url": "https://github.com/elastic/elasticsearch/commit/f66abdf5424bde51db73f246850c361a8af6f25c", "message": "Merge branch 'master' into buildsplit10", "committedDate": "2020-05-26T20:05:14Z", "type": "commit"}, {"oid": "24ea8fec5b715fec69450e19ae485291a067d0a7", "url": "https://github.com/elastic/elasticsearch/commit/24ea8fec5b715fec69450e19ae485291a067d0a7", "message": "spotless", "committedDate": "2020-05-26T20:22:07Z", "type": "commit"}]}