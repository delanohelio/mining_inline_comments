{"pr_number": 63639, "pr_title": "Remove cyclic dependency between DocumentMapper and MapperService", "pr_createdAt": "2020-10-13T19:23:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63639", "timeline": [{"oid": "202382a45febc8144aeefa43e56984da46fbd1de", "url": "https://github.com/elastic/elasticsearch/commit/202382a45febc8144aeefa43e56984da46fbd1de", "message": "Remove cyclic dependency between DocumentMapper and MapperService\n\n`DocumentMapper` holds on to a reference of `MapperService` so that its `merge` method, which creates and return a new `DocumentMapper` instance, can provide it to its own constructor. On the other hand `MapperService` has a volatile reference to `DocumentMapper`, which gets updated by calling `merge`.\n\nTruth is that the callers of the `merge` method could provide an instance of `MapperService` themselves, which removes the need for holding a reference to `MapperService` in `DocumentMapper`. Also, given that only three components out of `MapperService` are needed, we can adapt the signature of the `merge` method to accepts three new arguments: `IndexSettings`, `DocumentMapperParser` and `IndexAnalyzers`.", "committedDate": "2020-10-13T19:22:00Z", "type": "commit"}, {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d", "url": "https://github.com/elastic/elasticsearch/commit/3639239e6126a1583b3a3132ecc2ccfbba8a5c1d", "message": "spotless", "committedDate": "2020-10-14T07:28:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504505003", "bodyText": "Rather than having to pass these through to merge, can't we just keep references to them instead of references to the MapperService?", "author": "romseygeek", "createdAt": "2020-10-14T08:42:57Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "originalCommit": "202382a45febc8144aeefa43e56984da46fbd1de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxMTM4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504511388", "bodyText": "I don't see the point in holding on to references of objects that callers also hold on to already? Also, looking at potential further improvements, I think not holding those references simplifies things in DocumentMapper, doesn't it? are you annoyed by the number of arguments required by calling merge?", "author": "javanna", "createdAt": "2020-10-14T08:52:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNDg4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504514886", "bodyText": "The IndexSettings, IndexAnalyzers and DocumentMapperParser always remain the same, I think? So it's annoying to have to keep passing them to merge when the DocumentMapper has already been told about them.", "author": "romseygeek", "createdAt": "2020-10-14T08:57:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyNTE4OA==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504525188", "bodyText": "yes they ought to stay the same :) I see your point. these additional arguments do clutter the API, I just find it odd that we need to keep a reference to them only because it is needed for when merge is called, which is called from a place that has all this available too. I can be convinced though. I think not holding on to MapperService is the primary goal, hence I can go back and remove those arguments from merge.", "author": "javanna", "createdAt": "2020-10-14T09:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}], "type": "inlineReview", "revised_code": {"commit": "4c5133c0280b03fc565d5557157837eb6eaa8384", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\nindex 3e417127182..aaa45d6c2ca 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\n\n@@ -264,13 +265,9 @@ public class DocumentMapper implements ToXContentFragment {\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping,\n-                                MergeReason reason,\n-                                IndexSettings indexSettings,\n-                                DocumentMapperParser documentMapperParser,\n-                                IndexAnalyzers indexAnalyzers) {\n+    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n         Mapping merged = this.mapping.merge(mapping, reason);\n-        return new DocumentMapper(indexSettings, documentMapperParser, indexAnalyzers, merged);\n+        return new DocumentMapper(this.indexSettings, this.documentMapperParser, this.indexAnalyzers, merged);\n     }\n \n     public void validate(IndexSettings settings, boolean checkLimits) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504506715", "bodyText": "I don't think we need to change this method signature? Particularly now that the DocumentMapper constructor is private, just passing the MapperService here is a much simpler API.", "author": "romseygeek", "createdAt": "2020-10-14T08:45:42Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -99,19 +99,17 @@ public Builder put(MetadataFieldMapper.Builder mapper) {\n             return this;\n         }\n \n-        public DocumentMapper build(MapperService mapperService) {\n+        public DocumentMapper build(IndexSettings indexSettings, DocumentMapperParser documentMapperParser, IndexAnalyzers indexAnalyzers) {", "originalCommit": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNDI0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504514249", "bodyText": "I think it depends on perspective. Does the lower number of arguments make it a simpler API? To me, three arguments make it clear what is needed, while MapperService means \"I may or may not need a bunch of stuff\". I think with the three arguments, it is clearer what the method actually uses and needs. MapperService is such a big object to carry around.", "author": "javanna", "createdAt": "2020-10-14T08:56:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNTgwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504515805", "bodyText": "Fair enough - I think we'll end up removing the IndexAnalyzers param soon anyway, so that drops it down to just two parameters which doesn't seem excessive.", "author": "romseygeek", "createdAt": "2020-10-14T08:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ=="}], "type": "inlineReview", "revised_code": {"commit": "4c5133c0280b03fc565d5557157837eb6eaa8384", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\nindex 3e417127182..aaa45d6c2ca 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java\n\n@@ -112,15 +112,13 @@ public class DocumentMapper implements ToXContentFragment {\n \n     private final String type;\n     private final Text typeText;\n-\n     private final CompressedXContent mappingSource;\n-\n     private final Mapping mapping;\n-\n     private final DocumentParser documentParser;\n-\n     private final MappingLookup fieldMappers;\n-\n+    private final IndexSettings indexSettings;\n+    private final IndexAnalyzers indexAnalyzers;\n+    private final DocumentMapperParser documentMapperParser;\n     private final MetadataFieldMapper[] deleteTombstoneMetadataFieldMappers;\n     private final MetadataFieldMapper[] noopTombstoneMetadataFieldMappers;\n \n"}}, {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384", "url": "https://github.com/elastic/elasticsearch/commit/4c5133c0280b03fc565d5557157837eb6eaa8384", "message": "iter", "committedDate": "2020-10-14T09:21:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NzQ2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557463", "bodyText": "I think these changes are unnecessary now?", "author": "romseygeek", "createdAt": "2020-10-14T10:05:38Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java", "diffHunk": "@@ -43,8 +43,8 @@\n public class DocumentMapperTests extends MapperServiceTestCase {\n \n     public void testAddFields() throws Exception {\n-        DocumentMapper stage1\n-            = createDocumentMapper(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n+        MapperService mapperService = createMapperService(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));", "originalCommit": "4c5133c0280b03fc565d5557157837eb6eaa8384", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2Njg3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504566871", "bodyText": "right", "author": "javanna", "createdAt": "2020-10-14T10:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NzQ2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "eb327c530f8451b529715ad2fb7d5f90cec60c60", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java b/server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java\nindex ef4280f8e8b..40597e70ddb 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java\n\n@@ -43,9 +43,7 @@ import static org.hamcrest.Matchers.nullValue;\n public class DocumentMapperTests extends MapperServiceTestCase {\n \n     public void testAddFields() throws Exception {\n-        MapperService mapperService = createMapperService(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n-        DocumentMapper stage1 = mapperService.documentMapper();\n-\n+        DocumentMapper stage1 = createDocumentMapper(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n         DocumentMapper stage2 = createDocumentMapper(mapping(b -> {\n             b.startObject(\"name\").field(\"type\", \"text\").endObject();\n             b.startObject(\"age\").field(\"type\", \"integer\").endObject();\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzk1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557955", "bodyText": "I think this can be left unchanged as well?", "author": "romseygeek", "createdAt": "2020-10-14T10:06:27Z", "path": "test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java", "diffHunk": "@@ -78,8 +78,9 @@ public static MapperService newMapperService(NamedXContentRegistry xContentRegis\n \n     public static void assertConflicts(String mapping1,\n                                        String mapping2,\n-                                       DocumentMapperParser\n-                                           parser, String... conflicts) throws IOException {\n+                                       DocumentMapperParser parser,\n+                                       MapperService mapperService,", "originalCommit": "4c5133c0280b03fc565d5557157837eb6eaa8384", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTgxMw==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504569813", "bodyText": "thanks for catching it, mapper service is unused.", "author": "javanna", "createdAt": "2020-10-14T10:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzk1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "eb327c530f8451b529715ad2fb7d5f90cec60c60", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java b/test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java\nindex 16caed70b01..3d2ab6d3fcd 100644\n--- a/test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java\n+++ b/test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java\n\n@@ -79,7 +79,6 @@ public class MapperTestUtils {\n     public static void assertConflicts(String mapping1,\n                                        String mapping2,\n                                        DocumentMapperParser parser,\n-                                       MapperService mapperService,\n                                        String... conflicts) throws IOException {\n         DocumentMapper docMapper = parser.parse(\"type\", new CompressedXContent(mapping1));\n         if (conflicts.length == 0) {\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1ODM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504558390", "bodyText": "These too", "author": "romseygeek", "createdAt": "2020-10-14T10:07:11Z", "path": "x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java", "diffHunk": "@@ -366,10 +366,9 @@ public void testDepthLimit() throws IOException {\n                 .endObject()\n             .endObject()\n         .endObject());\n-\n+        MapperService mapperService = indexService.mapperService();", "originalCommit": "4c5133c0280b03fc565d5557157837eb6eaa8384", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "8d2d67e4a8436ebf498c3b5625c0b666e90500b2", "chunk": "diff --git a/x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java b/x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java\nindex 6f00efee0a0..63283275d58 100644\n--- a/x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java\n+++ b/x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java\n\n@@ -366,7 +366,6 @@ public class FlatObjectFieldMapperTests extends FieldMapperTestCase<FlatObjectFi\n                 .endObject()\n             .endObject()\n         .endObject());\n-        MapperService mapperService = indexService.mapperService();\n         DocumentMapper newMapper = mapper.merge(\n             parser.parse(\"type\", new CompressedXContent(newMapping)).mapping(), MergeReason.MAPPING_UPDATE);\n \n"}}, {"oid": "eb327c530f8451b529715ad2fb7d5f90cec60c60", "url": "https://github.com/elastic/elasticsearch/commit/eb327c530f8451b529715ad2fb7d5f90cec60c60", "message": "iter", "committedDate": "2020-10-14T10:27:27Z", "type": "commit"}, {"oid": "39997e61cca8d38a43001e8bc3f8176a75ffadce", "url": "https://github.com/elastic/elasticsearch/commit/39997e61cca8d38a43001e8bc3f8176a75ffadce", "message": "iter", "committedDate": "2020-10-14T10:32:06Z", "type": "commit"}, {"oid": "8d2d67e4a8436ebf498c3b5625c0b666e90500b2", "url": "https://github.com/elastic/elasticsearch/commit/8d2d67e4a8436ebf498c3b5625c0b666e90500b2", "message": "iter", "committedDate": "2020-10-14T10:33:45Z", "type": "commit"}]}