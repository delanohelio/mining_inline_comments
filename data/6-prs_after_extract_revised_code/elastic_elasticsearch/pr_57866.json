{"pr_number": 57866, "pr_title": "Stop Serializing Exceptions in SnapshotInfo", "pr_createdAt": "2020-06-09T09:05:32Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57866", "timeline": [{"oid": "ac4a0150ab07d32622e9e1d1e3857fd1f53129cc", "url": "https://github.com/elastic/elasticsearch/commit/ac4a0150ab07d32622e9e1d1e3857fd1f53129cc", "message": "Stop Serializing Exceptions in SnapshotInfo\n\nIn ff9e8c622427d42a2d87b4ceb298d043ae3c4e6a we changed the format\nused when serializing snapshot failures in the cluster state and\n`SnapshotInfo`. This turned them from a short string holding all the\nnested exception messages into a multi kb stacktrace in many cases.\nThis is not great if you snapshot a large number of shards that all fail\nfor example and massively blows up the size of the GET snapshots response\nif there are snapshots with failures in there.\nThis change reverts to the format used for exceptions before the above commit.\n\nAlso, this change short circuits logging and serialization of the failure\nfor an aborted snapshot where we don't care about the specific message at all\nand aligns the message to \"aborted\" in all cases (current if we aborted before any IO,\nit would have been \"aborted\" and an exception when aborting later during IO).", "committedDate": "2020-06-09T09:05:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNTU1NA==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437405554", "bodyText": "Should this be an IndexShardSnapshotException so that it can be serialized across the wire?", "author": "ywelsch", "createdAt": "2020-06-09T13:12:44Z", "path": "server/src/main/java/org/elasticsearch/snapshots/AbortedSnapshotException.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.snapshots;\n+\n+public final class AbortedSnapshotException extends RuntimeException {", "originalCommit": "ac4a0150ab07d32622e9e1d1e3857fd1f53129cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyOTk0OA==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437429948", "bodyText": "The reason I went for this (new exception type) was to explicitly not have this hit the wire ever. It's just here for flow control (not that that's great but that's how aborts work currently and as previously discussed it's not trivial to change that) and should never bubble up.", "author": "original-brownbear", "createdAt": "2020-06-09T13:45:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNTU1NA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQwNzY3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437407673", "bodyText": "I think I would prefer just to match IndexShardSnapshotException here and the \"aborted\" message (instead of introducing new exception type) to determine what to log and what failure should be.", "author": "ywelsch", "createdAt": "2020-06-09T13:15:53Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java", "diffHunk": "@@ -272,16 +271,44 @@ public void onResponse(String newGeneration) {\n \n                         @Override\n                         public void onFailure(Exception e) {\n-                            final String failure = ExceptionsHelper.stackTrace(e);\n+                            final String failure;\n+                            if (e instanceof AbortedSnapshotException) {", "originalCommit": "ac4a0150ab07d32622e9e1d1e3857fd1f53129cc", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d052d41251ab94805bb3f0c6522673a3939acc8a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java b/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\nindex bc6aa47ad4a..859ce9a3a67 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\n\n@@ -276,7 +276,7 @@ public class SnapshotShardsService extends AbstractLifecycleComponent implements\n                                 failure = \"aborted\";\n                                 logger.debug(() -> new ParameterizedMessage(\"[{}][{}] aborted shard snapshot\", shardId, snapshot), e);\n                             } else {\n-                                failure = formatFailure(e);\n+                                failure = summarizeFailure(e);\n                                 logger.warn(() -> new ParameterizedMessage(\"[{}][{}] failed to snapshot shard\", shardId, snapshot), e);\n                             }\n                             snapshotStatus.moveToFailed(threadPool.absoluteTimeInMillis(), failure);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxMTc4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437411789", "bodyText": "maybe call this summarizeFailure", "author": "ywelsch", "createdAt": "2020-06-09T13:21:57Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java", "diffHunk": "@@ -272,16 +271,44 @@ public void onResponse(String newGeneration) {\n \n                         @Override\n                         public void onFailure(Exception e) {\n-                            final String failure = ExceptionsHelper.stackTrace(e);\n+                            final String failure;\n+                            if (e instanceof AbortedSnapshotException) {\n+                                failure = \"aborted\";\n+                                logger.debug(() -> new ParameterizedMessage(\"[{}][{}] aborted shard snapshot\", shardId, snapshot), e);\n+                            } else {\n+                                failure = formatFailure(e);\n+                                logger.warn(() -> new ParameterizedMessage(\"[{}][{}] failed to snapshot shard\", shardId, snapshot), e);\n+                            }\n                             snapshotStatus.moveToFailed(threadPool.absoluteTimeInMillis(), failure);\n-                            logger.warn(() -> new ParameterizedMessage(\"[{}][{}] failed to snapshot shard\", shardId, snapshot), e);\n                             notifyFailedSnapshotShard(snapshot, shardId, failure);\n                         }\n                     });\n             }\n         });\n     }\n \n+    private static String formatFailure(Throwable t) {", "originalCommit": "ac4a0150ab07d32622e9e1d1e3857fd1f53129cc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxMjIxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437412211", "bodyText": "can you also add unit tests for this method?", "author": "ywelsch", "createdAt": "2020-06-09T13:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxMTc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NTQ3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/57866#discussion_r437475473", "bodyText": "Sure renamed + test added", "author": "original-brownbear", "createdAt": "2020-06-09T14:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQxMTc4OQ=="}], "type": "inlineReview", "revised_code": {"commit": "d052d41251ab94805bb3f0c6522673a3939acc8a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java b/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\nindex bc6aa47ad4a..859ce9a3a67 100644\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java\n\n@@ -276,7 +276,7 @@ public class SnapshotShardsService extends AbstractLifecycleComponent implements\n                                 failure = \"aborted\";\n                                 logger.debug(() -> new ParameterizedMessage(\"[{}][{}] aborted shard snapshot\", shardId, snapshot), e);\n                             } else {\n-                                failure = formatFailure(e);\n+                                failure = summarizeFailure(e);\n                                 logger.warn(() -> new ParameterizedMessage(\"[{}][{}] failed to snapshot shard\", shardId, snapshot), e);\n                             }\n                             snapshotStatus.moveToFailed(threadPool.absoluteTimeInMillis(), failure);\n"}}, {"oid": "5d0274982756f3c27a28b12243ca95cbd5e9f816", "url": "https://github.com/elastic/elasticsearch/commit/5d0274982756f3c27a28b12243ca95cbd5e9f816", "message": "Merge remote-tracking branch 'elastic/master' into do-not-store-snapshot-error-traces", "committedDate": "2020-06-09T13:45:53Z", "type": "commit"}, {"oid": "d052d41251ab94805bb3f0c6522673a3939acc8a", "url": "https://github.com/elastic/elasticsearch/commit/d052d41251ab94805bb3f0c6522673a3939acc8a", "message": "rename + test", "committedDate": "2020-06-09T14:39:00Z", "type": "commit"}]}