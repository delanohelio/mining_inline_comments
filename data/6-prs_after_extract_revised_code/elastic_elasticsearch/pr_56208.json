{"pr_number": 56208, "pr_title": "Add list of defered aggregations to the profiler", "pr_createdAt": "2020-05-05T14:32:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56208", "timeline": [{"oid": "820f3a3f0a7d70e4b6c6aa5758d88ded205cbe11", "url": "https://github.com/elastic/elasticsearch/commit/820f3a3f0a7d70e4b6c6aa5758d88ded205cbe11", "message": "Add list of defered aggregations to the profiler\n\nThis adds a few things to the `breakdown` of the profiler:\n* `histogram` aggregations now contain `total_buckets` which is the\n  count of buckets that they collected. This could be useful when\n  debugging a histogram inside of another bucketing agg that is fairly\n  selective.\n* All bucketing aggs that can delay their sub-aggregations will now add\n  a list of delayed sub-aggregations. This is useful because we\n  sometimes have fairly involved logic around which sub-aggregations get\n  delayed and this will save you from having to guess.\n* Aggregtations wrapped in the `MultiBucketAggregatorWrapper` can't\n  accurately add anything to the breakdown. Instead they the wrapper\n  adds a marker entry `\"multi_bucket_aggregator_wrapper\": true` so we\n  can be quickly pick out such aggregations when debugging.\n\nIt also fixes a bug where `_count` breakdown entries were contributing\nto the overall `time_in_nanos`. They didn't add a large amount of time\nso it is unlikely that this caused a big problem, but I was there.\n\nTo support the arbitrary breakdown data this reworks the profiler so\nthat the `breakdown` can contain any data that is supported by\n`StreamOutput#writeGenericValue(Object)` and\n`XContentBuilder#value(Object)`.", "committedDate": "2020-05-05T14:21:48Z", "type": "commit"}, {"oid": "4df4b8c851cc08593f79ca2b7d54cb36d8e12c21", "url": "https://github.com/elastic/elasticsearch/commit/4df4b8c851cc08593f79ca2b7d54cb36d8e12c21", "message": "Fix name", "committedDate": "2020-05-05T15:01:56Z", "type": "commit"}, {"oid": "aa0e2696beaf2ba730691d94bb09f0f584308659", "url": "https://github.com/elastic/elasticsearch/commit/aa0e2696beaf2ba730691d94bb09f0f584308659", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-05T22:08:08Z", "type": "commit"}, {"oid": "7c584607c3d412db8fe427f457c3a2b1dbe78978", "url": "https://github.com/elastic/elasticsearch/commit/7c584607c3d412db8fe427f457c3a2b1dbe78978", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-05T23:44:27Z", "type": "commit"}, {"oid": "a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29", "url": "https://github.com/elastic/elasticsearch/commit/a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29", "message": "Update docs", "committedDate": "2020-05-06T00:03:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NzE3OA==", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r420767178", "bodyText": "This is the change the breaks BWC. I'm not 100% sure it is ok. I'm hunting.\nThe effects will be that versions of the high level rest client that don't have this won't be able to read breakdowns that include non-numbers. They'll blow up at:\nensureExpectedToken(XContentParser.Token.VALUE_NUMBER, parser.nextToken(), parser::getTokenLocation);", "author": "nik9000", "createdAt": "2020-05-06T12:55:28Z", "path": "server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java", "diffHunk": "@@ -49,26 +51,25 @@\n  * \"children\" queries if applicable\n  */\n public final class ProfileResult implements Writeable, ToXContentObject {\n-\n     static final ParseField TYPE = new ParseField(\"type\");\n     static final ParseField DESCRIPTION = new ParseField(\"description\");\n+    static final ParseField BREAKDOWN = new ParseField(\"breakdown\");\n     static final ParseField NODE_TIME = new ParseField(\"time\");\n     static final ParseField NODE_TIME_RAW = new ParseField(\"time_in_nanos\");\n     static final ParseField CHILDREN = new ParseField(\"children\");\n-    static final ParseField BREAKDOWN = new ParseField(\"breakdown\");\n \n     private final String type;\n     private final String description;\n-    private final Map<String, Long> timings;", "originalCommit": "a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc3MTU0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r420771543", "bodyText": "Now that I think about this I'm going to move the \"extra\" stuff into an \"extra\" field and leave the breakdown all longs. I think that preserves backwards compatibility and is less confusing.", "author": "nik9000", "createdAt": "2020-05-06T13:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NzE3OA=="}], "type": "inlineReview", "revised_code": {"commit": "5cc9a7194468da33338b2193f5bc853033d207df", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java b/server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java\nindex d9e69106bb7..56b97b0e29e 100644\n--- a/server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java\n+++ b/server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java\n\n@@ -46,7 +45,7 @@ import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optiona\n  * to a single node in the query tree.  It is built after the query has finished executing\n  * and is merely a structured representation, rather than the entity that collects the timing\n  * profile (see InternalProfiler for that)\n- *\n+ * <p>\n  * Each InternalProfileResult has a List of InternalProfileResults, which will contain\n  * \"children\" queries if applicable\n  */\n"}}, {"oid": "5cc9a7194468da33338b2193f5bc853033d207df", "url": "https://github.com/elastic/elasticsearch/commit/5cc9a7194468da33338b2193f5bc853033d207df", "message": "Don't break bwc", "committedDate": "2020-05-06T16:19:11Z", "type": "commit"}, {"oid": "98df9cfcdec1ed29ee02afd81ad8ad0718082af9", "url": "https://github.com/elastic/elasticsearch/commit/98df9cfcdec1ed29ee02afd81ad8ad0718082af9", "message": "Finish", "committedDate": "2020-05-06T17:39:11Z", "type": "commit"}, {"oid": "fcefe4de7a956218d88485d9e84047d1817b551b", "url": "https://github.com/elastic/elasticsearch/commit/fcefe4de7a956218d88485d9e84047d1817b551b", "message": "Fix test", "committedDate": "2020-05-06T17:55:08Z", "type": "commit"}, {"oid": "62171d32aace12d597f015a921fab796449e839e", "url": "https://github.com/elastic/elasticsearch/commit/62171d32aace12d597f015a921fab796449e839e", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-06T21:16:21Z", "type": "commit"}, {"oid": "572ed0e0c55e0923f7c9db666d8e9162631d6c33", "url": "https://github.com/elastic/elasticsearch/commit/572ed0e0c55e0923f7c9db666d8e9162631d6c33", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-06T21:40:00Z", "type": "commit"}, {"oid": "266f2de4ab719c7592cdbd7be98fb4333f7cfe62", "url": "https://github.com/elastic/elasticsearch/commit/266f2de4ab719c7592cdbd7be98fb4333f7cfe62", "message": "Test cleanup", "committedDate": "2020-05-06T22:04:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyMTE4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r423121182", "bodyText": "Is there not a way to fetch the names out of collectors later when we need them?", "author": "polyfractal", "createdAt": "2020-05-11T15:24:17Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java", "diffHunk": "@@ -30,10 +30,12 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n+import java.util.function.BiConsumer;\n \n public abstract class DeferableBucketAggregator extends BucketsAggregator {\n \n     private DeferringBucketCollector recordingWrapper;\n+    private List<String> deferredAggregationNames;", "originalCommit": "266f2de4ab719c7592cdbd7be98fb4333f7cfe62", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE2MDQ4MQ==", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r423160481", "bodyText": "Not without some weird casting! I'll have another look just in case.", "author": "nik9000", "createdAt": "2020-05-11T16:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyMTE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI3Njg5Mw==", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r423276893", "bodyText": "Ah ok, no worries then :)", "author": "polyfractal", "createdAt": "2020-05-11T19:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyMTE4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "5784c7d74e9b045e08aab01fc922ef772e6d3349", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java\nindex 567c19b118d..807ec17e463 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java\n\n@@ -33,7 +33,10 @@ import java.util.Map;\n import java.util.function.BiConsumer;\n \n public abstract class DeferableBucketAggregator extends BucketsAggregator {\n-\n+    /**\n+     * Wrapper that records collections. Non-null if any aggregations have\n+     * been deferred.\n+     */\n     private DeferringBucketCollector recordingWrapper;\n     private List<String> deferredAggregationNames;\n \n"}}, {"oid": "5784c7d74e9b045e08aab01fc922ef772e6d3349", "url": "https://github.com/elastic/elasticsearch/commit/5784c7d74e9b045e08aab01fc922ef772e6d3349", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-11T19:02:49Z", "type": "commit"}, {"oid": "ffc435c4fd44bf0b3c7873fcb39801ac111e06f4", "url": "https://github.com/elastic/elasticsearch/commit/ffc435c4fd44bf0b3c7873fcb39801ac111e06f4", "message": "Merge branch 'master' into agg_debug_data", "committedDate": "2020-05-11T19:51:11Z", "type": "commit"}, {"oid": "c6748e08934bd6186dd86e8d49c0b63fa5249634", "url": "https://github.com/elastic/elasticsearch/commit/c6748e08934bd6186dd86e8d49c0b63fa5249634", "message": "Fix after merge", "committedDate": "2020-05-11T20:15:01Z", "type": "commit"}, {"oid": "4b74e5c8d35a6d34ca64fa0c1f8c279fb23c9fb0", "url": "https://github.com/elastic/elasticsearch/commit/4b74e5c8d35a6d34ca64fa0c1f8c279fb23c9fb0", "message": "Fix test", "committedDate": "2020-05-11T20:27:24Z", "type": "commit"}]}