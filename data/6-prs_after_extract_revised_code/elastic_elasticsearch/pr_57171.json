{"pr_number": 57171, "pr_title": "Fix NormalizerAgg test searcher wrapping", "pr_createdAt": "2020-05-26T18:58:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57171", "timeline": [{"oid": "9f6384136812e1b5c34a5a96317b36d6b96ea70e", "url": "https://github.com/elastic/elasticsearch/commit/9f6384136812e1b5c34a5a96317b36d6b96ea70e", "message": "Fix NormalizerAgg test searcher wrapping\n\nThe searcher was randomly wrapping its reader as slow, parallel, or filtered.\nThis was causing casting issues in the normalizer tests. By removing the\nwrapping, the problem goes away.\n\nCloses #57164", "committedDate": "2020-05-26T18:56:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0MjY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/57171#discussion_r430642686", "bodyText": "@polyfractal just pointed me to AggregatorTestCase#newIndexSearcher which seems to do that job. It has even less randomization, but it looks to be what we're moving the tests to.", "author": "nik9000", "createdAt": "2020-05-26T19:07:18Z", "path": "x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/normalize/NormalizeAggregatorTests.java", "diffHunk": "@@ -160,7 +160,7 @@ private void testCase(ValuesSourceAggregationBuilder<?> aggBuilder, Consumer<Int\n             termFieldType.setHasDocValues(true);\n \n             try (IndexReader indexReader = DirectoryReader.open(directory)) {\n-                IndexSearcher indexSearcher = newSearcher(indexReader, true, true);", "originalCommit": "9f6384136812e1b5c34a5a96317b36d6b96ea70e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0OTU1MA==", "url": "https://github.com/elastic/elasticsearch/pull/57171#discussion_r430649550", "bodyText": "what is the reasoning behind maybeWrapping? and why is it unsupported in some scenarios?", "author": "talevy", "createdAt": "2020-05-26T19:19:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0MjY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY1MDAzMw==", "url": "https://github.com/elastic/elasticsearch/pull/57171#discussion_r430650033", "bodyText": "and thank you for the heads up. I've updated to use the new method", "author": "talevy", "createdAt": "2020-05-26T19:20:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY0MjY4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "545f15b670571d45df7e7d8f8630af810234ceb4", "chunk": "diff --git a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/normalize/NormalizeAggregatorTests.java b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/normalize/NormalizeAggregatorTests.java\nindex cdd6464fe0a..aebff64661b 100644\n--- a/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/normalize/NormalizeAggregatorTests.java\n+++ b/x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/normalize/NormalizeAggregatorTests.java\n\n@@ -160,7 +160,7 @@ public class NormalizeAggregatorTests extends AggregatorTestCase {\n             termFieldType.setHasDocValues(true);\n \n             try (IndexReader indexReader = DirectoryReader.open(directory)) {\n-                IndexSearcher indexSearcher = newSearcher(indexReader, false, true);\n+                IndexSearcher indexSearcher = newIndexSearcher(indexReader);\n                 InternalAggregation internalAggregation = searchAndReduce(indexSearcher, query, aggBuilder, dateFieldType,\n                     valueFieldType, termFieldType);\n                 aggAssertion.accept(internalAggregation);\n"}}, {"oid": "545f15b670571d45df7e7d8f8630af810234ceb4", "url": "https://github.com/elastic/elasticsearch/commit/545f15b670571d45df7e7d8f8630af810234ceb4", "message": "change method", "committedDate": "2020-05-26T19:20:13Z", "type": "commit"}]}