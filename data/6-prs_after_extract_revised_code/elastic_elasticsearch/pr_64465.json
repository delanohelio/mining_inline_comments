{"pr_number": 64465, "pr_title": "LinearCounting recompute size tripping assertion", "pr_createdAt": "2020-11-02T10:55:26Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64465", "timeline": [{"oid": "e97cc2c5cbff63234678d8873e24a14232e6219f", "url": "https://github.com/elastic/elasticsearch/commit/e97cc2c5cbff63234678d8873e24a14232e6219f", "message": "guard recomputeSize from out of bounds exception", "committedDate": "2020-11-02T10:40:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0Njk4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64465#discussion_r516646985", "bodyText": "Probably worth a comment about why this particular random number. If it is to trip the problem, can we somehow assert that it tripped with this number? I feel like we could easily end up in a position where the test doesn't do anything if we don't have some package private method to check to see if this thing happened somehow.", "author": "nik9000", "createdAt": "2020-11-03T12:58:24Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java", "diffHunk": "@@ -171,4 +171,16 @@ public long addWithoutBreaking(long bytes) {\n \n         assertThat(total.get(), equalTo(0L));\n     }\n+\n+    public void testRetrieveCardinality() {\n+        final int p = randomIntBetween(MIN_PRECISION, MAX_PRECISION);\n+        final HyperLogLogPlusPlus counts = new HyperLogLogPlusPlus(p, BigArrays.NON_RECYCLING_INSTANCE, 1);\n+        int bucket = randomInt(100);\n+        counts.collect(bucket, -8688952809613614893L);", "originalCommit": "e97cc2c5cbff63234678d8873e24a14232e6219f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY1NTI1NA==", "url": "https://github.com/elastic/elasticsearch/pull/64465#discussion_r516655254", "bodyText": "The only condition to trigger it is to add one value to one bucket. I change it to a random long.", "author": "iverase", "createdAt": "2020-11-03T13:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0Njk4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "199383841dc1a02865166c90e7f3e29111b4e672", "chunk": "diff --git a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java\nindex 1a500c2c879..06211a10a02 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java\n\n@@ -176,7 +176,7 @@ public class HyperLogLogPlusPlusTests extends ESTestCase {\n         final int p = randomIntBetween(MIN_PRECISION, MAX_PRECISION);\n         final HyperLogLogPlusPlus counts = new HyperLogLogPlusPlus(p, BigArrays.NON_RECYCLING_INSTANCE, 1);\n         int bucket = randomInt(100);\n-        counts.collect(bucket, -8688952809613614893L);\n+        counts.collect(bucket, randomLong());\n         for (int i = 0; i < 1000; i++) {\n             int cardinality = bucket == i ? 1 : 0;\n             assertEquals(cardinality, counts.cardinality(i));\n"}}, {"oid": "8a683e7ceed39c11e225a6c3b4051ae17c93bb47", "url": "https://github.com/elastic/elasticsearch/commit/8a683e7ceed39c11e225a6c3b4051ae17c93bb47", "message": "Merge branch 'master' into hllarraysize", "committedDate": "2020-11-03T13:13:14Z", "type": "commit"}, {"oid": "199383841dc1a02865166c90e7f3e29111b4e672", "url": "https://github.com/elastic/elasticsearch/commit/199383841dc1a02865166c90e7f3e29111b4e672", "message": "use random long", "committedDate": "2020-11-03T13:15:58Z", "type": "commit"}]}