{"pr_number": 63986, "pr_title": "Improve interface for multivalue aggregations", "pr_createdAt": "2020-10-21T11:08:43Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63986", "timeline": [{"oid": "78ca61e1997179ea25c3ba63b282a7cafa6835bc", "url": "https://github.com/elastic/elasticsearch/commit/78ca61e1997179ea25c3ba63b282a7cafa6835bc", "message": "add an interface for multi value aggs in order to retrieve\nall names and values this agg provides", "committedDate": "2020-10-21T10:46:41Z", "type": "commit"}, {"oid": "41bd6f86ba3afc5959c0e3b732db596050e92665", "url": "https://github.com/elastic/elasticsearch/commit/41bd6f86ba3afc5959c0e3b732db596050e92665", "message": "fix boxplot tests", "committedDate": "2020-10-21T11:49:39Z", "type": "commit"}, {"oid": "f05be5467337132792440dc50018c804ecc67337", "url": "https://github.com/elastic/elasticsearch/commit/f05be5467337132792440dc50018c804ecc67337", "message": "fix SQL test", "committedDate": "2020-10-21T12:25:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMjM1NA==", "url": "https://github.com/elastic/elasticsearch/pull/63986#discussion_r509332354", "bodyText": "I think it'd probably be worth adding javadoc, just because lots of folks have to implement it, even if it is obvious.", "author": "nik9000", "createdAt": "2020-10-21T14:23:48Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/NumericMetricsAggregation.java", "diffHunk": "@@ -32,5 +32,10 @@\n     }\n \n     interface MultiValue extends NumericMetricsAggregation {\n+\n+        Iterable<String> valueNames();", "originalCommit": "f05be5467337132792440dc50018c804ecc67337", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "60c71c34e797444fba75ce2085643aa57427a83a", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/NumericMetricsAggregation.java b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/NumericMetricsAggregation.java\nindex cd78fd75598..78ac1719179 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/NumericMetricsAggregation.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/NumericMetricsAggregation.java\n\n@@ -33,8 +33,22 @@ public interface NumericMetricsAggregation extends Aggregation {\n \n     interface MultiValue extends NumericMetricsAggregation {\n \n+        /**\n+         * Return an iterable over all value names this multi value aggregation provides.\n+         *\n+         * The iterable might be created on the fly, if you need to call this multiple times, please\n+         * cache the result in a variable on caller side..\n+         *\n+         * @return iterable over all value names\n+         */\n         Iterable<String> valueNames();\n \n+        /**\n+         * Return the result of 1 value by name\n+         *\n+         * @param name of the value\n+         * @return the value\n+         */\n         double value(String name);\n \n     }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMjk4NA==", "url": "https://github.com/elastic/elasticsearch/pull/63986#discussion_r509332984", "bodyText": "I think it'd be fine to rebuild the list each time rather than have to think about the thing being mutable, even though it is only mutable in this fairly limited way.", "author": "nik9000", "createdAt": "2020-10-21T14:24:32Z", "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/AbstractInternalHDRPercentiles.java", "diffHunk": "@@ -40,6 +41,8 @@\n     protected final DoubleHistogram state;\n     protected final boolean keyed;\n \n+    private List<String> keysAsStrings;", "originalCommit": "f05be5467337132792440dc50018c804ecc67337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA3Mjc4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/63986#discussion_r510072783", "bodyText": "I removed all caching and put a warning in the code docs.", "author": "hendrikmuhs", "createdAt": "2020-10-22T11:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTMzMjk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "ddab348959325d0bac3003cc5f575a80905ea70f", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/AbstractInternalHDRPercentiles.java b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/AbstractInternalHDRPercentiles.java\nindex 8f4a1440fe9..064f4d4ffba 100644\n--- a/server/src/main/java/org/elasticsearch/search/aggregations/metrics/AbstractInternalHDRPercentiles.java\n+++ b/server/src/main/java/org/elasticsearch/search/aggregations/metrics/AbstractInternalHDRPercentiles.java\n\n@@ -41,8 +41,6 @@ abstract class AbstractInternalHDRPercentiles extends InternalNumericMetricsAggr\n     protected final DoubleHistogram state;\n     protected final boolean keyed;\n \n-    private List<String> keysAsStrings;\n-\n     AbstractInternalHDRPercentiles(String name, double[] keys, DoubleHistogram state, boolean keyed, DocValueFormat format,\n             Map<String, Object> metadata) {\n         super(name, metadata);\n"}}, {"oid": "60c71c34e797444fba75ce2085643aa57427a83a", "url": "https://github.com/elastic/elasticsearch/commit/60c71c34e797444fba75ce2085643aa57427a83a", "message": "document multi value interface", "committedDate": "2020-10-22T11:00:08Z", "type": "commit"}, {"oid": "ddab348959325d0bac3003cc5f575a80905ea70f", "url": "https://github.com/elastic/elasticsearch/commit/ddab348959325d0bac3003cc5f575a80905ea70f", "message": "remove caching of value names", "committedDate": "2020-10-22T11:00:28Z", "type": "commit"}]}