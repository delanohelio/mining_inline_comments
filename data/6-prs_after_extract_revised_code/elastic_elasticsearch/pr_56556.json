{"pr_number": 56556, "pr_title": "Watcher dont add watches post index if stopped", "pr_createdAt": "2020-05-11T22:00:17Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56556", "timeline": [{"oid": "079447335ed069ee5358af10faa12ebeae21369e", "url": "https://github.com/elastic/elasticsearch/commit/079447335ed069ee5358af10faa12ebeae21369e", "message": "don't allow adding to the trigger service if stopping or stopped", "committedDate": "2020-05-11T21:53:22Z", "type": "commit"}, {"oid": "c555e3eb1b619b3dea7e05bdb31d46b9c00d29a5", "url": "https://github.com/elastic/elasticsearch/commit/c555e3eb1b619b3dea7e05bdb31d46b9c00d29a5", "message": "un-mute tests", "committedDate": "2020-05-11T21:55:16Z", "type": "commit"}, {"oid": "bbee35f76a4a690f4782ded15bc8399eef98ba34", "url": "https://github.com/elastic/elasticsearch/commit/bbee35f76a4a690f4782ded15bc8399eef98ba34", "message": "fix test compile and checkstyle", "committedDate": "2020-05-11T22:12:42Z", "type": "commit"}, {"oid": "88bb906be0ddafd21622697501af0356110aa170", "url": "https://github.com/elastic/elasticsearch/commit/88bb906be0ddafd21622697501af0356110aa170", "message": "more checkstyle", "committedDate": "2020-05-11T22:25:24Z", "type": "commit"}, {"oid": "df2246b3d404f59d1c3baa51056d7014cd6001d3", "url": "https://github.com/elastic/elasticsearch/commit/df2246b3d404f59d1c3baa51056d7014cd6001d3", "message": "another checkstyle", "committedDate": "2020-05-11T22:44:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzA5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363095", "bodyText": "Need a live view of the state, but I didn't want to expose the actual reference to avoid the ability to set the state.", "author": "jakelandis", "createdAt": "2020-05-11T22:47:41Z", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java", "diffHunk": "@@ -203,7 +204,7 @@ private boolean clearAllocationIds() {\n         return previousShardRoutings.get();\n     }\n \n-    public WatcherState getState() {\n-        return state.get();\n+    public Supplier<WatcherState> getState(){", "originalCommit": "88bb906be0ddafd21622697501af0356110aa170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzM5Mg==", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363392", "bodyText": "I manually tested that when the service is stopped, and you add a new watch, it does indeed get added (as expected) upon startup.", "author": "jakelandis", "createdAt": "2020-05-11T22:48:30Z", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java", "diffHunk": "@@ -119,8 +124,8 @@ public void postIndex(ShardId shardId, Engine.Index operation, Engine.IndexResul\n                 }\n \n                 boolean shouldBeTriggered = shardAllocationConfiguration.shouldBeTriggered(watch.id());\n-                if (shouldBeTriggered) {\n-                    if (watch.status().state().isActive()) {\n+                if (shouldBeTriggered && EnumSet.of(WatcherState.STOPPING, WatcherState.STOPPED).contains(watcherState.get()) == false) {", "originalCommit": "88bb906be0ddafd21622697501af0356110aa170", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4", "chunk": "diff --git a/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java b/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java\nindex 72eaa3ab32b..9d82cb4b5d2 100644\n--- a/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java\n+++ b/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java\n\n@@ -124,7 +124,8 @@ final class WatcherIndexingListener implements IndexingOperationListener, Cluste\n                 }\n \n                 boolean shouldBeTriggered = shardAllocationConfiguration.shouldBeTriggered(watch.id());\n-                if (shouldBeTriggered && EnumSet.of(WatcherState.STOPPING, WatcherState.STOPPED).contains(watcherState.get()) == false) {\n+                WatcherState currentState = watcherState.get();\n+                if (shouldBeTriggered && EnumSet.of(WatcherState.STOPPING, WatcherState.STOPPED).contains(currentState) == false) {\n                     if (watch.status().state().isActive() ) {\n                         logger.debug(\"adding watch [{}] to trigger service\", watch.id());\n                         triggerService.add(watch);\n"}}, {"oid": "3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4", "url": "https://github.com/elastic/elasticsearch/commit/3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4", "message": "log message and test", "committedDate": "2020-05-11T23:03:54Z", "type": "commit"}]}