{"pr_number": 64832, "pr_title": "Treat all xpack as modules", "pr_createdAt": "2020-11-09T21:35:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64832", "timeline": [{"oid": "5921aa76621cbdaecaa026753b6d0af9afcfa915", "url": "https://github.com/elastic/elasticsearch/commit/5921aa76621cbdaecaa026753b6d0af9afcfa915", "message": "Treat all xpack as modules\n\nWhen rest tests install plugins, they currently treat xpack as plugins\ninstead of modules. This was a side effect of splitting the rest test\nplugin out from PluginBuildPlugin. However, that means xpack modules are\nbeing run through the elasticsearch plugin installer, which is not\nguaranteed to work. This commit reworks rest tests to treat anything\nunder xpack as a module. A side effect of this is that QA plugins under\nxpack get treated as modules. This is ok because they are just for\ntesting, we don't need to validate them in the same way we do actual\nplugins. Additionally, this commit relaxes the expection that modules\nare only added for the integ test distribution. There is already a check\nto not overwrite an existing module, so this wasn't a useful\noptimization anyways.", "committedDate": "2020-11-09T21:31:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEzOTQ1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64832#discussion_r520139456", "bodyText": "Can we simplify this nested provider while we're here?", "author": "mark-vieira", "createdAt": "2020-11-09T21:44:01Z", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "diffHunk": "@@ -62,7 +62,7 @@ static ElasticsearchCluster createTestCluster(Project project, SourceSet sourceS\n             project.getPluginManager().withPlugin(\"elasticsearch.esplugin\", plugin -> {\n                 Zip bundle = (Zip) project.getTasks().getByName(\"bundlePlugin\");\n                 testTask.dependsOn(bundle);\n-                if (project.getPath().contains(\"modules:\")) {\n+                if (project.getPath().contains(\"modules:\") || project.getPath().startsWith(\":x-pack:plugin\")) {\n                     testTask.getClusters().forEach(c -> c.module(bundle.getArchiveFile()));\n                 } else {\n                     testTask.getClusters().forEach(c -> c.plugin(project.getObjects().fileProperty().value(bundle.getArchiveFile())));", "originalCommit": "5921aa76621cbdaecaa026753b6d0af9afcfa915", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "73d9f4dbfa11d82d13916bad183cf739867f27e4", "chunk": "diff --git a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java\nindex fa714fef09d..60ae3064958 100644\n--- a/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java\n+++ b/buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java\n\n@@ -65,7 +65,7 @@ public class RestTestUtil {\n                 if (project.getPath().contains(\"modules:\") || project.getPath().startsWith(\":x-pack:plugin\")) {\n                     testTask.getClusters().forEach(c -> c.module(bundle.getArchiveFile()));\n                 } else {\n-                    testTask.getClusters().forEach(c -> c.plugin(project.getObjects().fileProperty().value(bundle.getArchiveFile())));\n+                    testTask.getClusters().forEach(c -> c.plugin(bundle.getArchiveFile()));\n                 }\n             });\n         });\n"}}, {"oid": "73d9f4dbfa11d82d13916bad183cf739867f27e4", "url": "https://github.com/elastic/elasticsearch/commit/73d9f4dbfa11d82d13916bad183cf739867f27e4", "message": "simplify", "committedDate": "2020-11-09T23:10:53Z", "type": "commit"}]}