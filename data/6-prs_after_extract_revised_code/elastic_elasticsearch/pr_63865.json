{"pr_number": 63865, "pr_title": "[ML] Pass job config in JSON file to autodetect", "pr_createdAt": "2020-10-19T08:39:19Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63865", "timeline": [{"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "url": "https://github.com/elastic/elasticsearch/commit/36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "message": "[ML] Pass job config in JSON file to autodetect\n\nWrite job config in the form of a JSON formatted file and pass its\nlocation to autodetect as an additional command line option. This will\nultimately allow all relevant job config to be read from the JSON config\nfile and hence reduce the number of command line arguments for\nautodetect.", "committedDate": "2020-10-19T08:23:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU3OTU3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507579572", "bodyText": "nit: I think the indenting is one space off on this line", "author": "droberts195", "createdAt": "2020-10-19T08:52:04Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "diffHunk": "@@ -350,4 +357,17 @@ private void buildFieldConfig(List<String> command) throws IOException {\n             command.add(fieldConfig);\n         }\n     }\n+\n+    private void buildJobConfig(List<String> command) throws IOException {\n+        Path configFile = Files.createTempFile(env.tmpFile(), \"config\", JSON_EXTENSION);\n+        filesToDelete.add(configFile);\n+        try (OutputStreamWriter osw = new OutputStreamWriter(Files.newOutputStream(configFile),StandardCharsets.UTF_8);\n+             XContentBuilder jsonBuilder = JsonXContent.contentBuilder()) {", "originalCommit": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a4d387410a9bd4ae5737580588201e41e105513", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\nindex d9d077baa07..a8985c7c996 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\n\n@@ -362,7 +369,7 @@ public class AutodetectBuilder {\n         Path configFile = Files.createTempFile(env.tmpFile(), \"config\", JSON_EXTENSION);\n         filesToDelete.add(configFile);\n         try (OutputStreamWriter osw = new OutputStreamWriter(Files.newOutputStream(configFile),StandardCharsets.UTF_8);\n-             XContentBuilder jsonBuilder = JsonXContent.contentBuilder()) {\n+            XContentBuilder jsonBuilder = JsonXContent.contentBuilder()) {\n \n             job.toXContent(jsonBuilder, ToXContent.EMPTY_PARAMS);\n             osw.write(Strings.toString(jsonBuilder));\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507580139", "bodyText": "Is the (Class) cast really necessary here?", "author": "droberts195", "createdAt": "2020-10-19T08:52:53Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -36,11 +41,14 @@\n     private Settings settings;\n     private NativeController nativeController;\n     private ProcessPipes processPipes;\n+    private ArgumentCaptor<List<String>> commandCaptor;\n \n+    @SuppressWarnings(\"unchecked\")\n     @Before\n     public void setUpTests() {\n         logger = mock(Logger.class);\n-        filesToDelete = Collections.emptyList();\n+        filesToDelete = new ArrayList<>();\n+        commandCaptor = ArgumentCaptor.forClass((Class)List.class);", "originalCommit": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNjcyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507606729", "bodyText": "Sadly it is yes. Without it we get the compilation error\njava: incompatible types: inference variable T has incompatible equality constraints java.util.List<java.lang.String>,java.util.List\n\nAdmittedly the cast isn't nice but there is precedence in e.g. AnalyticsBuilder.java", "author": "edsavage", "createdAt": "2020-10-19T09:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxMDM5MA==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507610390", "bodyText": "OK cool, I didn't realise that", "author": "droberts195", "createdAt": "2020-10-19T09:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4NDk0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507584941", "bodyText": "Please add a comment on the buildJobConfig line to say that it's providing duplicate information as an interim measure while the C++ code is switched over from the old format to the new format.\nAlso maybe group the buildLimits, buildModelPlotConfig and buildFieldConfig lines together and add a comment to say that they will be removed once the C++ is just using the full job config.", "author": "droberts195", "createdAt": "2020-10-19T08:59:57Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "diffHunk": "@@ -172,12 +177,14 @@ public AutodetectBuilder scheduledEvents(List<ScheduledEvent> scheduledEvents) {\n     public void build() throws IOException, InterruptedException {\n \n         List<String> command = buildAutodetectCommand();\n-\n         buildLimits(command);\n         buildModelPlotConfig(command);\n \n         buildQuantiles(command);\n         buildFieldConfig(command);\n+\n+        buildJobConfig(command);", "originalCommit": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a4d387410a9bd4ae5737580588201e41e105513", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\nindex d9d077baa07..a8985c7c996 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java\n\n@@ -177,13 +177,20 @@ public class AutodetectBuilder {\n     public void build() throws IOException, InterruptedException {\n \n         List<String> command = buildAutodetectCommand();\n+\n+        // While it may appear that the JSON formatted job config file contains data that\n+        // is duplicated in the existing limits, modelPlot and field config files, over time\n+        // the C++ backend will retrieve all its required configuration data from the new\n+        // JSON config file and the old-style configuration files will be removed.\n+        buildJobConfig(command);\n+\n+        // Per the comment above, these three lines will eventually be removed once migration\n+        // to the new JSON formatted configuration file has been completed.\n         buildLimits(command);\n         buildModelPlotConfig(command);\n-\n-        buildQuantiles(command);\n         buildFieldConfig(command);\n \n-        buildJobConfig(command);\n+        buildQuantiles(command);\n \n         processPipes.addArgs(command);\n         controller.startProcess(command);\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5NDYxOA==", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507594618", "bodyText": "The current assertion is relying on the way Java chooses to print a List.  This is more precise:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String commandString = command.toString();\n          \n          \n            \n                    assertTrue(commandString.contains(\" --config=\"));\n          \n          \n            \n                    assertThat(command, hasItem(matchesPattern(\"--config=.*\\\\.json\")));\n          \n      \n    \n    \n  \n\nPlus you'll need extra imports to go with that.  IntelliJ should add them automatically but if not then add:\nimport static org.hamcrest.Matchers.hasItem;\nimport static org.hamcrest.Matchers.matchesPattern;", "author": "droberts195", "createdAt": "2020-10-19T09:15:20Z", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -126,4 +134,19 @@ public void testBuildAutodetectCommand_givenPersistModelState() {\n     private AutodetectBuilder autodetectBuilder(Job job) {\n         return new AutodetectBuilder(job, filesToDelete, logger, env, settings, nativeController, processPipes);\n     }\n+\n+    public void testBuildAutodetect() throws Exception {\n+        Job.Builder job = buildJobBuilder(\"unit-test-job\");\n+\n+        autodetectBuilder(job.build()).build();\n+\n+        assertThat(filesToDelete, hasSize(3));\n+\n+        verify(nativeController).startProcess(commandCaptor.capture());\n+        verifyNoMoreInteractions(nativeController);\n+\n+        List<String> command = commandCaptor.getValue();\n+        String commandString = command.toString();\n+        assertTrue(commandString.contains(\" --config=\"));", "originalCommit": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5a4d387410a9bd4ae5737580588201e41e105513", "chunk": "diff --git a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java\nindex bdbc29b2900..87cd751e548 100644\n--- a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java\n+++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java\n\n@@ -146,7 +148,6 @@ public class AutodetectBuilderTests extends ESTestCase {\n         verifyNoMoreInteractions(nativeController);\n \n         List<String> command = commandCaptor.getValue();\n-        String commandString = command.toString();\n-        assertTrue(commandString.contains(\" --config=\"));\n+        assertThat(command, hasItem(matchesPattern(\"--config=.*\\\\.json\")));\n     }\n }\n"}}, {"oid": "5a4d387410a9bd4ae5737580588201e41e105513", "url": "https://github.com/elastic/elasticsearch/commit/5a4d387410a9bd4ae5737580588201e41e105513", "message": "Attending to code review comments", "committedDate": "2020-10-19T09:55:47Z", "type": "commit"}]}