{"pr_number": 56669, "pr_title": "More Efficient Snapshot State Handling", "pr_createdAt": "2020-05-13T08:39:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/56669", "timeline": [{"oid": "e1c0c27f34e1cf2fc4402d72f8a908fdf957faaa", "url": "https://github.com/elastic/elasticsearch/commit/e1c0c27f34e1cf2fc4402d72f8a908fdf957faaa", "message": "More Efficient Snapshot State Handling\n\nFollow up to #56365. Instead of redundantly checking snapshots for completion\nover and over, just track the completed snapshots in the CS updates that complete\nthem instead of looping over the smae snapshot entries over and over.\nAlso, in the batched snapshot shard status updates, only check for completion\nof a snapshot entry if it isn't already finalizing.", "committedDate": "2020-05-13T08:34:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI3NjY5MA==", "url": "https://github.com/elastic/elasticsearch/pull/56669#discussion_r424276690", "bodyText": "This saves a ton of cycles. Just think about a 10k shards snapshot. Worst case that would have triggered ~10k ^ 2 checks on whether all shards have completed if the last snapshot update ...", "author": "original-brownbear", "createdAt": "2020-05-13T08:49:59Z", "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1454,7 +1446,15 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n                         try {\n                             listener.onResponse(new UpdateIndexShardSnapshotStatusResponse());\n                         } finally {\n-                            endCompletedSnapshots(newState);", "originalCommit": "e1c0c27f34e1cf2fc4402d72f8a908fdf957faaa", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}