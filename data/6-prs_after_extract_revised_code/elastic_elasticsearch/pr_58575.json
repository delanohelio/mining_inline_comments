{"pr_number": 58575, "pr_title": "Count coordinating and primary bytes as write bytes", "pr_createdAt": "2020-06-25T20:16:31Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/58575", "timeline": [{"oid": "fb1c11107a8782819e7946afade98425cfdc90f0", "url": "https://github.com/elastic/elasticsearch/commit/fb1c11107a8782819e7946afade98425cfdc90f0", "message": "Count coordinating and primary bytes as write byte\n\nThis is a follow-up to #57573. This commit combines coordinating and\nprimary bytes under the same \"write\" bucket. Double accounting is\nprevented by only accounting the bytes at either the reroute phase or\nthe primary phase. TransportBulkAction calls execute directly, so the\noperations handler is skipped and the bytes are not double accounted.", "committedDate": "2020-06-25T20:11:23Z", "type": "commit"}, {"oid": "a8e3ab7d3f66eeb3effb9d4da3501646eb504457", "url": "https://github.com/elastic/elasticsearch/commit/a8e3ab7d3f66eeb3effb9d4da3501646eb504457", "message": "Merge remote-tracking branch 'upstream/master' into remove_double_accounting", "committedDate": "2020-06-26T15:43:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTg3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r446265873", "bodyText": "Should we make this the default implementation for doExecute in TransportWriteAction when rerouteBypassed() is true? Maybe we can then also rename that method to supportsRerouteAction.", "author": "ywelsch", "createdAt": "2020-06-26T15:50:07Z", "path": "server/src/main/java/org/elasticsearch/action/resync/TransportResyncReplicationAction.java", "diffHunk": "@@ -64,6 +64,11 @@ public TransportResyncReplicationAction(Settings settings, TransportService tran\n             writeMemoryLimits);\n     }\n \n+    @Override\n+    protected void doExecute(Task parentTask, ResyncReplicationRequest request, ActionListener<ResyncReplicationResponse> listener) {\n+        assert false : \"use TransportResyncReplicationAction#sync\";", "originalCommit": "fb1c11107a8782819e7946afade98425cfdc90f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MzE2NA==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r446463164", "bodyText": "Okay. This is a little tricky because I have to expose reroute in TransportReplicationAction. But I did that and we can discuss.", "author": "tbrooks8", "createdAt": "2020-06-27T00:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTg3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ2MzgwMA==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r446463800", "bodyText": "Eh. Actually I holding off this for the moment because it gets kind of messy. We can talk more about this. I did rename the method.", "author": "tbrooks8", "createdAt": "2020-06-27T00:53:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI2NTg3Mw=="}], "type": "inlineReview", "revised_code": null}, {"oid": "ed6ec456eb2ee3e06d679bf31473ca171dce320c", "url": "https://github.com/elastic/elasticsearch/commit/ed6ec456eb2ee3e06d679bf31473ca171dce320c", "message": "Merge remote-tracking branch 'upstream/master' into remove_double_accounting", "committedDate": "2020-06-26T18:10:59Z", "type": "commit"}, {"oid": "ce0cb30956ea226b7bff627afe6706500ef3d06d", "url": "https://github.com/elastic/elasticsearch/commit/ce0cb30956ea226b7bff627afe6706500ef3d06d", "message": "Changes", "committedDate": "2020-06-26T18:35:03Z", "type": "commit"}, {"oid": "c86d2162d902f900962cc56f5191aac480d263c5", "url": "https://github.com/elastic/elasticsearch/commit/c86d2162d902f900962cc56f5191aac480d263c5", "message": "Changes", "committedDate": "2020-06-27T01:24:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NzgyMA==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r447047820", "bodyText": "One scenario which is not supported by this I think is if we have a relocating primary where the old primary has done a relocation handoff with the new primary, and is directly sending a primary action from old primary to new primary (see primaryShardReference.isRelocated() in TransportReplicationAction.AsyncPrimaryAction.runWithPrimaryShardReference).\nThe new primary would then not account for the bytes. This should only be a for a short time, nevertheless I'm wondering if we can find a solution for this.", "author": "ywelsch", "createdAt": "2020-06-29T15:13:37Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "diffHunk": "@@ -80,12 +80,25 @@ protected TransportWriteAction(Settings settings, String actionName, TransportSe\n \n     @Override\n     protected Releasable checkOperationLimits(Request request) {\n-        return writeMemoryLimits.markCoordinatingOperationStarted(primaryOperationSize(request));\n+        assert supportsRerouteAction() : \"checkOperationLimits should be be called if reroute not supported by action\";\n+        return writeMemoryLimits.markWriteOperationStarted(primaryOperationSize(request));\n     }\n \n     @Override\n     protected Releasable checkPrimaryLimits(Request request) {\n-        return writeMemoryLimits.markPrimaryOperationStarted(primaryOperationSize(request));\n+        if (supportsRerouteAction()) {\n+            return () -> {};", "originalCommit": "c86d2162d902f900962cc56f5191aac480d263c5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "695cffccb56735f4e3e07bde9e493b23cc467fe5", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\nindex cb2e9be7535..d22771eed2f 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java\n\n@@ -86,7 +86,9 @@ public abstract class TransportWriteAction<\n \n     @Override\n     protected Releasable checkPrimaryLimits(Request request) {\n-        if (supportsRerouteAction()) {\n+        // If reroute is supported, the parent task is the reroute task. If the node-id is the same, we have\n+        // already accounted the bytes.\n+        if (supportsRerouteAction() && request.getParentTask().getNodeId().equals(clusterService.localNode().getId())) {\n             return () -> {};\n         } else {\n             return writeMemoryLimits.markWriteOperationStarted(primaryOperationSize(request));\n"}}, {"oid": "695cffccb56735f4e3e07bde9e493b23cc467fe5", "url": "https://github.com/elastic/elasticsearch/commit/695cffccb56735f4e3e07bde9e493b23cc467fe5", "message": "Changes", "committedDate": "2020-06-29T22:33:18Z", "type": "commit"}, {"oid": "14dafcf32932d4fb154ecf529304502452b10943", "url": "https://github.com/elastic/elasticsearch/commit/14dafcf32932d4fb154ecf529304502452b10943", "message": "Changes", "committedDate": "2020-06-29T23:19:53Z", "type": "commit"}, {"oid": "3f64e8db8e168ba67a4ac838f2c604f978b6e5eb", "url": "https://github.com/elastic/elasticsearch/commit/3f64e8db8e168ba67a4ac838f2c604f978b6e5eb", "message": "Merge remote-tracking branch 'upstream/master' into remove_double_accounting", "committedDate": "2020-06-30T00:29:45Z", "type": "commit"}, {"oid": "f8249eee8b4cacb21a021547a75219b9d3d77308", "url": "https://github.com/elastic/elasticsearch/commit/f8249eee8b4cacb21a021547a75219b9d3d77308", "message": "Fix", "committedDate": "2020-06-30T03:59:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc2MjU2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r447762561", "bodyText": "needs to be v8.0.0", "author": "ywelsch", "createdAt": "2020-06-30T15:13:05Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -1102,19 +1102,31 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, l\n         private final String targetAllocationID;\n         private final long primaryTerm;\n         private final R request;\n+        private final boolean rerouteWasLocal;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n             targetAllocationID = in.readString();\n             primaryTerm  = in.readVLong();\n+            // TODO: Change after backport\n+            if (in.getVersion().onOrAfter(Version.CURRENT)) {", "originalCommit": "14dafcf32932d4fb154ecf529304502452b10943", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3a05ac12a8677a158d138ff08a654cfcbbef1a53", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex e443734c4d2..aebf8cdd88e 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -1108,7 +1108,7 @@ public abstract class TransportReplicationAction<\n             targetAllocationID = in.readString();\n             primaryTerm  = in.readVLong();\n             // TODO: Change after backport\n-            if (in.getVersion().onOrAfter(Version.CURRENT)) {\n+            if (in.getVersion().onOrAfter(Version.V_8_0_0)) {\n                 rerouteWasLocal = in.readBoolean();\n             } else {\n                 rerouteWasLocal = false;\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3ODE5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r447778191", "bodyText": "The confusing bit about this name is that this flag does not say whether the reroute action came from a local node, but whether the primary action was sent by a reroute phase on the local node.\nMy suggestion was to mention primaryDelegation here (which is the terminology we use when sending a primary action to a different node (otherwise, it's always local to the node where the reroute was executing). By default primaryDelegation will be false (i.e. exactly the inverse of this flag here)", "author": "ywelsch", "createdAt": "2020-06-30T15:33:39Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -1145,9 +1157,17 @@ public String getDescription() {\n         public void writeTo(StreamOutput out) throws IOException {\n             out.writeString(targetAllocationID);\n             out.writeVLong(primaryTerm);\n+            // TODO: Change after backport\n+            if (out.getVersion().onOrAfter(Version.V_8_0_0)) {\n+                out.writeBoolean(rerouteWasLocal);\n+            }\n             request.writeTo(out);\n         }\n \n+        public boolean rerouteWasLocal() {", "originalCommit": "f8249eee8b4cacb21a021547a75219b9d3d77308", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "0e452d54815c0dce366ebad08415d1a57fadab7e", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex aebf8cdd88e..6d5ae27949b 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -1155,17 +1151,17 @@ public abstract class TransportReplicationAction<\n \n         @Override\n         public void writeTo(StreamOutput out) throws IOException {\n+            // If sentFromLocalReroute is marked true, then this request should just be looped back through\n+            // the local transport. It should never be serialized to be sent over the wire. If it is sent over\n+            // the wire, then it was NOT sent from a local reroute.\n+            assert sentFromLocalReroute == false;\n             out.writeString(targetAllocationID);\n             out.writeVLong(primaryTerm);\n-            // TODO: Change after backport\n-            if (out.getVersion().onOrAfter(Version.V_8_0_0)) {\n-                out.writeBoolean(rerouteWasLocal);\n-            }\n             request.writeTo(out);\n         }\n \n-        public boolean rerouteWasLocal() {\n-            return rerouteWasLocal;\n+        public boolean sentFromLocalReroute() {\n+            return sentFromLocalReroute;\n         }\n \n         public R getRequest() {\n"}}, {"oid": "3a05ac12a8677a158d138ff08a654cfcbbef1a53", "url": "https://github.com/elastic/elasticsearch/commit/3a05ac12a8677a158d138ff08a654cfcbbef1a53", "message": "Merge remote-tracking branch 'upstream/master' into remove_double_accounting", "committedDate": "2020-06-30T16:43:21Z", "type": "commit"}, {"oid": "0e452d54815c0dce366ebad08415d1a57fadab7e", "url": "https://github.com/elastic/elasticsearch/commit/0e452d54815c0dce366ebad08415d1a57fadab7e", "message": "Naming", "committedDate": "2020-06-30T17:22:10Z", "type": "commit"}, {"oid": "8b2d3ce6585948f1d232b37b8e0b50b4cea7376e", "url": "https://github.com/elastic/elasticsearch/commit/8b2d3ce6585948f1d232b37b8e0b50b4cea7376e", "message": "Changes", "committedDate": "2020-06-30T20:44:28Z", "type": "commit"}, {"oid": "0b1738277fdc5e868496a8cca1ccbec27c4b3760", "url": "https://github.com/elastic/elasticsearch/commit/0b1738277fdc5e868496a8cca1ccbec27c4b3760", "message": "Changes", "committedDate": "2020-06-30T20:44:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODI1ODY1OA==", "url": "https://github.com/elastic/elasticsearch/pull/58575#discussion_r448258658", "bodyText": "remove this  comment?", "author": "ywelsch", "createdAt": "2020-07-01T10:06:49Z", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java", "diffHunk": "@@ -1102,19 +1101,28 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, l\n         private final String targetAllocationID;\n         private final long primaryTerm;\n         private final R request;\n+        // Indicates if this primary shard request originated by a reroute on this local node.\n+        private final boolean sentFromLocalReroute;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n+            // sendFromLocalReroute", "originalCommit": "0b1738277fdc5e868496a8cca1ccbec27c4b3760", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "a5c98a2794719b1cee71aa8ed0e0d61177c33ba7", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\nindex 6d5ae27949b..bce9517e3ef 100644\n--- a/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/support/replication/TransportReplicationAction.java\n\n@@ -1105,7 +1105,6 @@ public abstract class TransportReplicationAction<\n         private final boolean sentFromLocalReroute;\n \n         public ConcreteShardRequest(Writeable.Reader<R> requestReader, StreamInput in) throws IOException {\n-            // sendFromLocalReroute\n             targetAllocationID = in.readString();\n             primaryTerm  = in.readVLong();\n             sentFromLocalReroute = false;\n"}}, {"oid": "a5c98a2794719b1cee71aa8ed0e0d61177c33ba7", "url": "https://github.com/elastic/elasticsearch/commit/a5c98a2794719b1cee71aa8ed0e0d61177c33ba7", "message": "Remove comment", "committedDate": "2020-07-01T13:41:26Z", "type": "commit"}, {"oid": "d7cac0cbc8c8677e4df2830d794b7580b8a195da", "url": "https://github.com/elastic/elasticsearch/commit/d7cac0cbc8c8677e4df2830d794b7580b8a195da", "message": "Merge remote-tracking branch 'upstream/master' into remove_double_accounting", "committedDate": "2020-07-01T15:04:31Z", "type": "commit"}]}