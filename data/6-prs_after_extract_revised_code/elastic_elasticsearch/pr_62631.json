{"pr_number": 62631, "pr_title": "Dense vector field type minor fixes", "pr_createdAt": "2020-09-18T13:55:40Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62631", "timeline": [{"oid": "ef4187872c0907477a31695af8642f95171048f4", "url": "https://github.com/elastic/elasticsearch/commit/ef4187872c0907477a31695af8642f95171048f4", "message": "Dense vector field should set doc_values to true\n\nAs the dense vector field is aggregatable and produces fielddata through its BinaryDocValuesField, it should pass up hasDocValues set to true to its parent class in its constructor.\n\nThis may not have consequences today, but it will be important once we try to share the same exists query implementation throughout all of the mappers with #57607.\n\nAs part of the change we introduce a new test method in FieldTypeTestCase that allows to verify the consistency between hasDocValues and what isAggregatable returns.", "committedDate": "2020-09-18T13:53:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTczMA==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490971730", "bodyText": "Maybe collapse these two into a single method that takes a boolean parameter?", "author": "romseygeek", "createdAt": "2020-09-18T14:03:19Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java", "diffHunk": "@@ -40,4 +40,48 @@ static QueryShardContext createMockQueryShardContext(boolean allowExpensiveQueri\n         return queryShardContext;\n     }\n \n+    protected boolean hasConfigurableDocValues() {\n+        return true;\n+    }\n+\n+    protected abstract MappedFieldType createDefaultFieldType();\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {", "originalCommit": "ef4187872c0907477a31695af8642f95171048f4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "93e413ec3f26a9fd18450c629f3deac6b7340172", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java b/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\nindex 8f67596b356..c0078da3615 100644\n--- a/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\n\n@@ -39,49 +39,4 @@ public abstract class FieldTypeTestCase extends ESTestCase {\n         when(queryShardContext.allowExpensiveQueries()).thenReturn(allowExpensiveQueries);\n         return queryShardContext;\n     }\n-\n-    protected boolean hasConfigurableDocValues() {\n-        return true;\n-    }\n-\n-    protected abstract MappedFieldType createDefaultFieldType();\n-\n-    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    protected MappedFieldType createFieldTypeWithDocValuesDisabled() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    protected boolean isAggregatableWhenDocValuesAreDisabled() {\n-        return false;\n-    }\n-\n-    protected boolean isAggregatableWhenDocValuesAreEnabled() {\n-        return true;\n-    }\n-\n-    public final void testIsAggregatable() {\n-        if (hasConfigurableDocValues()) {\n-            MappedFieldType fieldTypeWithDocValuesEnabled = createFieldTypeWithDocValuesEnabled();\n-            assertTrue(fieldTypeWithDocValuesEnabled.hasDocValues());\n-            if (isAggregatableWhenDocValuesAreEnabled()) {\n-                assertTrue(fieldTypeWithDocValuesEnabled.isAggregatable());\n-            } else {\n-                assertFalse(fieldTypeWithDocValuesEnabled.isAggregatable());\n-            }\n-            MappedFieldType fieldTypeWithDocValuesDisabled = createFieldTypeWithDocValuesDisabled();\n-            assertFalse(fieldTypeWithDocValuesDisabled.hasDocValues());\n-            if (isAggregatableWhenDocValuesAreDisabled()) {\n-                assertTrue(fieldTypeWithDocValuesDisabled.isAggregatable());\n-            } else {\n-                assertFalse(fieldTypeWithDocValuesDisabled.isAggregatable());\n-            }\n-        }\n-        MappedFieldType defaultFieldType = createDefaultFieldType();\n-        assertEquals(\n-            (defaultFieldType.hasDocValues() && isAggregatableWhenDocValuesAreEnabled()) || isAggregatableWhenDocValuesAreDisabled(),\n-            defaultFieldType.isAggregatable());\n-    }\n }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MzkwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490973901", "bodyText": "I\"m not sure that we want to enforce this association between hasDocValues and isAggregatable.  I think they're asserting different things - hasDocValues is an implementation detail about how we build exists queries (and also how we build documents, but that will be going away once all mappers are parametrized), whereas isAggregatable says something about the capabilities of the field.  I can even see hasDocValues() being removed entirely and it just being a member field used for the exists query impl.", "author": "romseygeek", "createdAt": "2020-09-18T14:06:41Z", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java", "diffHunk": "@@ -40,4 +40,48 @@ static QueryShardContext createMockQueryShardContext(boolean allowExpensiveQueri\n         return queryShardContext;\n     }\n \n+    protected boolean hasConfigurableDocValues() {\n+        return true;\n+    }\n+\n+    protected abstract MappedFieldType createDefaultFieldType();\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesDisabled() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    protected boolean isAggregatableWhenDocValuesAreDisabled() {\n+        return false;\n+    }\n+\n+    protected boolean isAggregatableWhenDocValuesAreEnabled() {\n+        return true;\n+    }\n+", "originalCommit": "ef4187872c0907477a31695af8642f95171048f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4MDIyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490980229", "bodyText": "I can see how this association may go away, but it exists today as most of the times a field is aggregatable through doc_values, hence its exists query goes also through doc_values. The test is not so beautiful, yet it would have caught this inconsistency in the first place? I would not want to break the exists query because hasDocValue is not properly set and I thought today one way to verify that it's set correctly is by checking that a field is aggregatable, besides exceptions.", "author": "javanna", "createdAt": "2020-09-18T14:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4Mjg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490982846", "bodyText": "Right, but the test structure I outlined here would also catch that, I think, and wouldn't involve adding all these extra methods?", "author": "romseygeek", "createdAt": "2020-09-18T14:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk4MzA1NA==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490983054", "bodyText": "besides exceptions\n\nThis is the bit I worry about :)", "author": "romseygeek", "createdAt": "2020-09-18T14:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MzkwMQ=="}], "type": "inlineReview", "revised_code": {"commit": "93e413ec3f26a9fd18450c629f3deac6b7340172", "chunk": "diff --git a/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java b/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\nindex 8f67596b356..c0078da3615 100644\n--- a/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\n+++ b/test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java\n\n@@ -39,49 +39,4 @@ public abstract class FieldTypeTestCase extends ESTestCase {\n         when(queryShardContext.allowExpensiveQueries()).thenReturn(allowExpensiveQueries);\n         return queryShardContext;\n     }\n-\n-    protected boolean hasConfigurableDocValues() {\n-        return true;\n-    }\n-\n-    protected abstract MappedFieldType createDefaultFieldType();\n-\n-    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    protected MappedFieldType createFieldTypeWithDocValuesDisabled() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    protected boolean isAggregatableWhenDocValuesAreDisabled() {\n-        return false;\n-    }\n-\n-    protected boolean isAggregatableWhenDocValuesAreEnabled() {\n-        return true;\n-    }\n-\n-    public final void testIsAggregatable() {\n-        if (hasConfigurableDocValues()) {\n-            MappedFieldType fieldTypeWithDocValuesEnabled = createFieldTypeWithDocValuesEnabled();\n-            assertTrue(fieldTypeWithDocValuesEnabled.hasDocValues());\n-            if (isAggregatableWhenDocValuesAreEnabled()) {\n-                assertTrue(fieldTypeWithDocValuesEnabled.isAggregatable());\n-            } else {\n-                assertFalse(fieldTypeWithDocValuesEnabled.isAggregatable());\n-            }\n-            MappedFieldType fieldTypeWithDocValuesDisabled = createFieldTypeWithDocValuesDisabled();\n-            assertFalse(fieldTypeWithDocValuesDisabled.hasDocValues());\n-            if (isAggregatableWhenDocValuesAreDisabled()) {\n-                assertTrue(fieldTypeWithDocValuesDisabled.isAggregatable());\n-            } else {\n-                assertFalse(fieldTypeWithDocValuesDisabled.isAggregatable());\n-            }\n-        }\n-        MappedFieldType defaultFieldType = createDefaultFieldType();\n-        assertEquals(\n-            (defaultFieldType.hasDocValues() && isAggregatableWhenDocValuesAreEnabled()) || isAggregatableWhenDocValuesAreDisabled(),\n-            defaultFieldType.isAggregatable());\n-    }\n }\n"}}, {"oid": "93e413ec3f26a9fd18450c629f3deac6b7340172", "url": "https://github.com/elastic/elasticsearch/commit/93e413ec3f26a9fd18450c629f3deac6b7340172", "message": "iter", "committedDate": "2020-09-18T14:45:54Z", "type": "commit"}, {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a", "url": "https://github.com/elastic/elasticsearch/commit/247da6bc63105291204f56fb84ac99ace7a76e3a", "message": "iter", "committedDate": "2020-09-18T14:51:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzExMw==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491007113", "bodyText": "Do we still need these changes?", "author": "romseygeek", "createdAt": "2020-09-18T14:56:28Z", "path": "plugins/analysis-icu/src/test/java/org/elasticsearch/index/mapper/CollationFieldTypeTests.java", "diffHunk": "@@ -42,8 +42,12 @@\n \n     private static final Collator DEFAULT_COLLATOR = Collator.getInstance(ULocale.ROOT).freeze();", "originalCommit": "247da6bc63105291204f56fb84ac99ace7a76e3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMjM3MQ==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491012371", "bodyText": "I think these are not strictly needed but don't hurt either. Mostly I got lazy while reverting all of the other changes :)", "author": "javanna", "createdAt": "2020-09-18T15:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzExMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzI5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491007299", "bodyText": "Same here?", "author": "romseygeek", "createdAt": "2020-09-18T14:56:43Z", "path": "server/src/test/java/org/elasticsearch/index/mapper/RangeFieldTypeTests.java", "diffHunk": "@@ -54,7 +54,6 @@\n \n public class RangeFieldTypeTests extends FieldTypeTestCase {", "originalCommit": "247da6bc63105291204f56fb84ac99ace7a76e3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "8dec8daa5d27bab23c6f1aa401d49a65df78d648", "url": "https://github.com/elastic/elasticsearch/commit/8dec8daa5d27bab23c6f1aa401d49a65df78d648", "message": "correct isAggregatable and docValuesByDefault", "committedDate": "2020-09-18T18:51:47Z", "type": "commit"}, {"oid": "8a1a1bb8be568460c9624cebcc6be847a8d475bd", "url": "https://github.com/elastic/elasticsearch/commit/8a1a1bb8be568460c9624cebcc6be847a8d475bd", "message": "Merge branch 'master' into fix/dense_vector_doc_values_true", "committedDate": "2020-09-18T18:53:31Z", "type": "commit"}, {"oid": "cdb3c0400dabd089fb47e04738d523679fa1c507", "url": "https://github.com/elastic/elasticsearch/commit/cdb3c0400dabd089fb47e04738d523679fa1c507", "message": "fix testCompile", "committedDate": "2020-09-18T19:14:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3NzU4NA==", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491177584", "bodyText": "This approach makes sense to me. I wondered if we should FieldMapper#isAggregatable more robust/ general, now that there are field types that produce field data but don't support aggregations. But I think dense_vector is the only example right now, so we can avoid generalizing too early.", "author": "jtibshirani", "createdAt": "2020-09-18T20:34:29Z", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -129,6 +129,11 @@ public Query existsQuery(QueryShardContext context) {\n             return new DocValuesFieldExistsQuery(name());\n         }\n \n+        @Override\n+        public boolean isAggregatable() {", "originalCommit": "cdb3c0400dabd089fb47e04738d523679fa1c507", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}]}