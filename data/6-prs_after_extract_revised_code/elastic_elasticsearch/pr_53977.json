{"pr_number": 53977, "pr_title": "[ML] No refresh on indexing DFA stats", "pr_createdAt": "2020-03-23T13:44:44Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53977", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxMjg0OA==", "url": "https://github.com/elastic/elasticsearch/pull/53977#discussion_r396512848", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOGGER.debug(\"[{}] Refreshing indices {}\", jobId, Arrays.toString(refreshRequest.indices()));\n          \n          \n            \n                    LOGGER.debug(() -> new ParameterizedMessage(\"[{}] Refreshing indices {}\", jobId, Arrays.toString(refreshRequest.indices())));\n          \n      \n    \n    \n  \n\nI think the string is created eagerly. This is not strictly necessary unless the logging level is debug.\nThis is a minor thing as most of our logging does not take this into account.", "author": "benwtrent", "createdAt": "2020-03-23T14:55:52Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java", "diffHunk": "@@ -301,12 +303,15 @@ private void refreshDest(DataFrameAnalyticsConfig config) {\n             () -> client.execute(RefreshAction.INSTANCE, new RefreshRequest(config.getDest().getIndex())).actionGet());\n     }\n \n-    private void refreshStateIndex(String jobId) {\n-        String indexName = AnomalyDetectorsIndex.jobStateIndexPattern();\n-        LOGGER.debug(\"[{}] Refresh index {}\", jobId, indexName);\n-\n-        RefreshRequest refreshRequest = new RefreshRequest(indexName);\n+    private void refreshIndices(String jobId) {\n+        RefreshRequest refreshRequest = new RefreshRequest(\n+            AnomalyDetectorsIndex.jobStateIndexPattern(),\n+            MlStatsIndex.indexPattern()\n+        );\n         refreshRequest.indicesOptions(IndicesOptions.lenientExpandOpen());\n+\n+        LOGGER.debug(\"[{}] Refreshing indices {}\", jobId, Arrays.toString(refreshRequest.indices()));", "originalCommit": "13e601082329aa5e6166161e09e983d332e4819c", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzYzMg==", "url": "https://github.com/elastic/elasticsearch/pull/53977#discussion_r396977632", "bodyText": "Would it make sense to also refresh dest index in this method?", "author": "przemekwitek", "createdAt": "2020-03-24T08:33:20Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java", "diffHunk": "@@ -301,12 +303,15 @@ private void refreshDest(DataFrameAnalyticsConfig config) {\n             () -> client.execute(RefreshAction.INSTANCE, new RefreshRequest(config.getDest().getIndex())).actionGet());\n     }\n \n-    private void refreshStateIndex(String jobId) {\n-        String indexName = AnomalyDetectorsIndex.jobStateIndexPattern();\n-        LOGGER.debug(\"[{}] Refresh index {}\", jobId, indexName);\n-\n-        RefreshRequest refreshRequest = new RefreshRequest(indexName);\n+    private void refreshIndices(String jobId) {", "originalCommit": "13e601082329aa5e6166161e09e983d332e4819c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4OTQxMw==", "url": "https://github.com/elastic/elasticsearch/pull/53977#discussion_r396989413", "bodyText": "We need to use the config's headers to refresh the dest index which is why I kept it separate.", "author": "dimitris-athanasiou", "createdAt": "2020-03-24T08:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzYzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk5MzI5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53977#discussion_r396993297", "bodyText": "Right, thanks for explanation.", "author": "przemekwitek", "createdAt": "2020-03-24T09:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3NzYzMg=="}], "type": "inlineReview", "revised_code": null}, {"oid": "5ea3e2d003bfebe3678912b32602210900e2ec8d", "url": "https://github.com/elastic/elasticsearch/commit/5ea3e2d003bfebe3678912b32602210900e2ec8d", "message": "[ML] No refresh on indexing DFA stats\n\nWhen we index data frame analytics stats docs we do not\nneed to refresh immediately.", "committedDate": "2020-03-24T08:53:47Z", "type": "commit"}, {"oid": "5ea3e2d003bfebe3678912b32602210900e2ec8d", "url": "https://github.com/elastic/elasticsearch/commit/5ea3e2d003bfebe3678912b32602210900e2ec8d", "message": "[ML] No refresh on indexing DFA stats\n\nWhen we index data frame analytics stats docs we do not\nneed to refresh immediately.", "committedDate": "2020-03-24T08:53:47Z", "type": "forcePushed"}]}