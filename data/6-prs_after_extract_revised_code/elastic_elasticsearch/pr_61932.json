{"pr_number": 61932, "pr_title": "Improve error messages on bad [format] and [null_value] params for date mapper", "pr_createdAt": "2020-09-03T15:55:13Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/61932", "timeline": [{"oid": "da9806b65e2cecad86d48d0d6b8639228a4c37fd", "url": "https://github.com/elastic/elasticsearch/commit/da9806b65e2cecad86d48d0d6b8639228a4c37fd", "message": "Improve error messages on bad [format] and [null_value] params for date mapper", "committedDate": "2020-09-03T15:50:36Z", "type": "commit"}, {"oid": "1150090dc95b64ff34ca51116e7fa2e03cbe433d", "url": "https://github.com/elastic/elasticsearch/commit/1150090dc95b64ff34ca51116e7fa2e03cbe433d", "message": "imports", "committedDate": "2020-09-03T16:22:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNDkwNg==", "url": "https://github.com/elastic/elasticsearch/pull/61932#discussion_r483204906", "bodyText": "Small comment, maybe we should scope the try/ catch down to avoid rewrapping an IllegalArgumentException from the constructor call ? It doesn't seem like a concern for this specific constructor, but seems like good practice.", "author": "jtibshirani", "createdAt": "2020-09-03T19:25:17Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -213,21 +213,38 @@ public Builder(String name, Resolution resolution, DateFormatter dateFormatter,\n         }\n \n         protected DateFieldType setupFieldType(BuilderContext context) {\n-            DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-            return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                dateTimeFormatter, resolution, meta.getValue());\n+            try {\n+                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());", "originalCommit": "1150090dc95b64ff34ca51116e7fa2e03cbe433d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\nindex 9b1f433a028..790d5824f2c 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\n\n@@ -212,13 +212,10 @@ public final class DateFieldMapper extends ParametrizedFieldMapper {\n             }\n         }\n \n-        protected DateFieldType setupFieldType(BuilderContext context) {\n+        private DateFormatter buildFormatter() {\n             try {\n-                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-                return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                    dateTimeFormatter, resolution, meta.getValue());\n-            }\n-            catch (IllegalArgumentException e) {\n+                return DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n+            } catch (IllegalArgumentException e) {\n                 throw new IllegalArgumentException(\"Error parsing [format] on field [\" + name() + \"]: \" + e.getMessage(), e);\n             }\n         }\n"}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwODU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61932#discussion_r483208549", "bodyText": "Small comment, catch is usually on same line as previous brace.\nNot relevant for this PR, but reading this made me notice that we parse null_value dates different from ones that appear in documents. Specifically, I wonder why we don't use DateFieldType#parse here ?", "author": "jtibshirani", "createdAt": "2020-09-03T19:32:48Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -213,21 +213,38 @@ public Builder(String name, Resolution resolution, DateFormatter dateFormatter,\n         }\n \n         protected DateFieldType setupFieldType(BuilderContext context) {\n-            DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-            return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                dateTimeFormatter, resolution, meta.getValue());\n+            try {\n+                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n+                return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n+                    dateTimeFormatter, resolution, meta.getValue());\n+            }\n+            catch (IllegalArgumentException e) {\n+                throw new IllegalArgumentException(\"Error parsing [format] on field [\" + name() + \"]: \" + e.getMessage(), e);\n+            }\n         }\n \n         @Override\n         protected List<Parameter<?>> getParameters() {\n             return List.of(index, docValues, store, format, locale, nullValue, ignoreMalformed, boost, meta);\n         }\n \n+        private Long parseNullValue(DateFormatter formatter) {\n+            if (nullValue.getValue() == null) {\n+                return null;\n+            }\n+            try {\n+                return formatter.parseMillis(nullValue.getValue());\n+            }\n+            catch (Exception e) {", "originalCommit": "1150090dc95b64ff34ca51116e7fa2e03cbe433d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU0MTE2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/61932#discussion_r483541169", "bodyText": "Specifically, I wonder why we don't use DateFieldType#parse here ?\n\nThis is a bug, I'll open a separate PR to fix.", "author": "romseygeek", "createdAt": "2020-09-04T10:49:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwODU0OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\nindex 9b1f433a028..790d5824f2c 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java\n\n@@ -212,13 +212,10 @@ public final class DateFieldMapper extends ParametrizedFieldMapper {\n             }\n         }\n \n-        protected DateFieldType setupFieldType(BuilderContext context) {\n+        private DateFormatter buildFormatter() {\n             try {\n-                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-                return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                    dateTimeFormatter, resolution, meta.getValue());\n-            }\n-            catch (IllegalArgumentException e) {\n+                return DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n+            } catch (IllegalArgumentException e) {\n                 throw new IllegalArgumentException(\"Error parsing [format] on field [\" + name() + \"]: \" + e.getMessage(), e);\n             }\n         }\n"}}, {"oid": "c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "url": "https://github.com/elastic/elasticsearch/commit/c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "message": "feedback", "committedDate": "2020-09-04T10:49:09Z", "type": "commit"}, {"oid": "15b6bd5de221462719e7af0591b41f96ee15db92", "url": "https://github.com/elastic/elasticsearch/commit/15b6bd5de221462719e7af0591b41f96ee15db92", "message": "Merge branch 'master' into mapper/empty-null-value", "committedDate": "2020-09-04T11:53:25Z", "type": "commit"}]}