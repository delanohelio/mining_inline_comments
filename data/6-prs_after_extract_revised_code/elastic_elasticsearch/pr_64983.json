{"pr_number": 64983, "pr_title": "FieldTypeLookup to not implement Iterable", "pr_createdAt": "2020-11-12T10:38:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64983", "timeline": [{"oid": "3d57f48a7e78f65b15f7774667bf843f7a1f088a", "url": "https://github.com/elastic/elasticsearch/commit/3d57f48a7e78f65b15f7774667bf843f7a1f088a", "message": "FieldTypeLookup to not implement Iterable\n\nFieldTypeLookup implements Iterable which is currently only used in IndexWarmer to iterate through all field types that have eager global ordinals set to true. Implementing Iterable makes it hard to track who iterates through all the field types.\n\nThis commit exposes a new method that allows to provide a Predicate and returns an Iterable of all the field types that match the predicate.", "committedDate": "2020-11-12T10:10:47Z", "type": "commit"}, {"oid": "479695abe97c891592c4105b45aae78a56c2d891", "url": "https://github.com/elastic/elasticsearch/commit/479695abe97c891592c4105b45aae78a56c2d891", "message": "address test", "committedDate": "2020-11-12T10:36:31Z", "type": "commit"}, {"oid": "43d39faf26724279c51d9555fa8fd02beb50586c", "url": "https://github.com/elastic/elasticsearch/commit/43d39faf26724279c51d9555fa8fd02beb50586c", "message": "fix test", "committedDate": "2020-11-12T11:02:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAyMjQxNA==", "url": "https://github.com/elastic/elasticsearch/pull/64983#discussion_r522022414", "bodyText": "Given that we only use this for index warmers, maybe we should replace this with a getEagerGlobalOrdinalsFields() method that returns a set of field names, and which calls FieldTypeLookup.filter() under the hood?", "author": "romseygeek", "createdAt": "2020-11-12T11:05:13Z", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -432,8 +433,8 @@ public MappedFieldType fieldType(String fullName) {\n     /**\n      * Returns all mapped field types.\n      */\n-    public Iterable<MappedFieldType> fieldTypes() {\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes();\n+    public Iterable<MappedFieldType> fieldTypes(Predicate<MappedFieldType> predicate) {\n+        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().filter(predicate);\n     }", "originalCommit": "479695abe97c891592c4105b45aae78a56c2d891", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAyMzAxMg==", "url": "https://github.com/elastic/elasticsearch/pull/64983#discussion_r522023012", "bodyText": "yes I agree. will do that", "author": "javanna", "createdAt": "2020-11-12T11:06:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAyMjQxNA=="}], "type": "inlineReview", "revised_code": {"commit": "057aae613ae00554f8a9ecf7a51d4d522cdf2fd2", "chunk": "diff --git a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\nindex 293fcdc19bb..b02c4597f66 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/MapperService.java\n\n@@ -433,8 +432,9 @@ public class MapperService extends AbstractIndexComponent implements Closeable {\n     /**\n      * Returns all mapped field types.\n      */\n-    public Iterable<MappedFieldType> fieldTypes(Predicate<MappedFieldType> predicate) {\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().filter(predicate);\n+    public Iterable<MappedFieldType> getEagerGlobalOrdinalsFields() {\n+        return this.mapper == null ? Collections.emptySet() :\n+            this.mapper.mappers().fieldTypes().filter(MappedFieldType::eagerGlobalOrdinals);\n     }\n \n     public ObjectMapper getObjectMapper(String name) {\n"}}, {"oid": "057aae613ae00554f8a9ecf7a51d4d522cdf2fd2", "url": "https://github.com/elastic/elasticsearch/commit/057aae613ae00554f8a9ecf7a51d4d522cdf2fd2", "message": "iter", "committedDate": "2020-11-12T11:07:29Z", "type": "commit"}]}