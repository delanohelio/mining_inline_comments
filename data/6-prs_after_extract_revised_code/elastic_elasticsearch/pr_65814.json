{"pr_number": 65814, "pr_title": "[ML] Simplify reverting to snapshot while datafeed is reassigning", "pr_createdAt": "2020-12-03T13:41:22Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/65814", "timeline": [{"oid": "0f43b03e3ae5f1f8f4a916135ba6876fd62f8984", "url": "https://github.com/elastic/elasticsearch/commit/0f43b03e3ae5f1f8f4a916135ba6876fd62f8984", "message": "[ML] Simplify reverting to snapshot while datafeed is reassigning\n\nPreviously, we were trying to compare that the job had gone past\nits current model snapshot in order to determine whether we\nshould perform recovery. However, this is not necessary. We can\ninstead simply always perform recovery if the opening job\nhas a running datafeed task. This greatly simplifies the code.\n\nRelates #65630\n\nFixes #65710", "committedDate": "2020-12-03T13:39:43Z", "type": "commit"}, {"oid": "e87b968a0bac4222536eed835d82f5cebc75b2a7", "url": "https://github.com/elastic/elasticsearch/commit/e87b968a0bac4222536eed835d82f5cebc75b2a7", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning", "committedDate": "2020-12-03T15:04:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyMjU1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/65814#discussion_r535322559", "bodyText": "Can you change \"performing recovery\" to something like \"reverting to last good model snapshot [X]\"\nBut only if modelSnapshotId != ModelSnapshot.EMPTY_SNAPSHOT_ID", "author": "davidkyle", "createdAt": "2020-12-03T15:18:32Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java", "diffHunk": "@@ -200,16 +201,15 @@ private void runJob(JobTask jobTask, JobState jobState, OpenJobAction.JobParams\n             return;\n         }\n \n-        ActionListener<DatafeedContext> datafeedContextListener = ActionListener.wrap(\n-            datafeedContext -> {\n-                if (datafeedContext != null && datafeedContext.shouldRecoverFromCurrentSnapshot()) {\n-                    // This job has a datafeed attached to it and the job had advanced past the current model snapshot.\n+        ActionListener<Boolean> hasRunningDatafeedTaskListener = ActionListener.wrap(\n+            hasRunningDatafeed -> {\n+                if (hasRunningDatafeed) {\n+                    // This job has a running datafeed attached to it.\n                     // In order to prevent gaps in the model we revert to the current snapshot deleting intervening results.\n-                    ModelSnapshot modelSnapshot = datafeedContext.getModelSnapshot() == null ?\n-                        ModelSnapshot.emptySnapshot(jobTask.getJobId()) : datafeedContext.getModelSnapshot();\n-                    logger.info(\"[{}] job had advanced past its current model snapshot [{}]; performing recovery\",\n-                        jobTask.getJobId(), modelSnapshot.getSnapshotId());\n-                    revertToSnapshot(modelSnapshot, ActionListener.wrap(\n+                    String modelSnapshotId = params.getJob().getModelSnapshotId() == null ?\n+                        ModelSnapshot.EMPTY_SNAPSHOT_ID : params.getJob().getModelSnapshotId();\n+                    logger.info(\"[{}] job has running datafeed task; performing recovery\", jobTask.getJobId());", "originalCommit": "e87b968a0bac4222536eed835d82f5cebc75b2a7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM0OTM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/65814#discussion_r535349370", "bodyText": "Right after that log message, we'll get the logging from the revert action which follows up and explains the recovery. I thought that was nice. Does it make sense or you still prefer to mention we're going to revert in there?", "author": "dimitris-athanasiou", "createdAt": "2020-12-03T15:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyMjU1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0MzkwNw==", "url": "https://github.com/elastic/elasticsearch/pull/65814#discussion_r535943907", "bodyText": "OK, changed it to \"reverting to current snapshot\"", "author": "dimitris-athanasiou", "createdAt": "2020-12-04T09:07:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyMjU1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "3a376f9a13e2cb4330cd1487e14e196e448dd3d9", "chunk": "diff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java\nindex 4cb647b9730..67a54c27b32 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java\n\n@@ -206,13 +208,7 @@ public class OpenJobPersistentTasksExecutor extends AbstractJobPersistentTasksEx\n                 if (hasRunningDatafeed) {\n                     // This job has a running datafeed attached to it.\n                     // In order to prevent gaps in the model we revert to the current snapshot deleting intervening results.\n-                    String modelSnapshotId = params.getJob().getModelSnapshotId() == null ?\n-                        ModelSnapshot.EMPTY_SNAPSHOT_ID : params.getJob().getModelSnapshotId();\n-                    logger.info(\"[{}] job has running datafeed task; performing recovery\", jobTask.getJobId());\n-                    revertToSnapshot(jobTask.getJobId(), modelSnapshotId, ActionListener.wrap(\n-                        response -> openJob(jobTask),\n-                        jobTask::markAsFailed\n-                    ));\n+                    revertToCurrentSnapshot(jobTask.getJobId(), ActionListener.wrap(response -> openJob(jobTask), jobTask::markAsFailed));\n                 } else {\n                     openJob(jobTask);\n                 }\n"}}, {"oid": "09e25b6f15b8b6f2b1f6309d16fc760ed4e41f14", "url": "https://github.com/elastic/elasticsearch/commit/09e25b6f15b8b6f2b1f6309d16fc760ed4e41f14", "message": "Return when no datafeed exists", "committedDate": "2020-12-03T16:10:31Z", "type": "commit"}, {"oid": "3a376f9a13e2cb4330cd1487e14e196e448dd3d9", "url": "https://github.com/elastic/elasticsearch/commit/3a376f9a13e2cb4330cd1487e14e196e448dd3d9", "message": "Refetch job before checking its model snapshot", "committedDate": "2020-12-03T19:56:02Z", "type": "commit"}, {"oid": "4796cb243fcbfe32cbdfa4e4b8a1e4af1d70814f", "url": "https://github.com/elastic/elasticsearch/commit/4796cb243fcbfe32cbdfa4e4b8a1e4af1d70814f", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning", "committedDate": "2020-12-03T19:56:50Z", "type": "commit"}, {"oid": "c9e75a417db80a457f90649e67ffdc4fe0675fe5", "url": "https://github.com/elastic/elasticsearch/commit/c9e75a417db80a457f90649e67ffdc4fe0675fe5", "message": "Improve log message", "committedDate": "2020-12-04T09:06:45Z", "type": "commit"}, {"oid": "a1208f5996fe4a39c4651b95a896c8cd2f190d82", "url": "https://github.com/elastic/elasticsearch/commit/a1208f5996fe4a39c4651b95a896c8cd2f190d82", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning", "committedDate": "2020-12-04T09:32:23Z", "type": "commit"}]}